var xm=Object.defineProperty;var bm=(Y,T,se)=>T in Y?xm(Y,T,{enumerable:!0,configurable:!0,writable:!0,value:se}):Y[T]=se;var kn=(Y,T,se)=>(bm(Y,typeof T!="symbol"?T+"":T,se),se);import{s as ha,n as cs,c as jr,o as uc,y as Qh,d as of,z as Sl,A as Xd,B as co,r as eu,a as wm}from"../chunks/scheduler.D-x6b7vF.js";import{S as ua,i as da,e as At,c as Mt,a as ri,d as Rt,o as dt,g as fn,h as rt,t as xn,s as Ai,b as bn,f as Mi,y as wr,j as Ds,u as Ra,v as Ba,w as ja,z as ls,n as Na,l as Va,x as Ua,A as ca,B as af,k as qd,C as Cm,D as Zc,E as Kc,p as za}from"../chunks/index.D7zNCqp9.js";import{c as xl,g as lf,a as Sm}from"../chunks/_commonjsHelpers.BosuxZz1.js";import{w as Vn,d as Tm}from"../chunks/index.DZQZCYML.js";function $d(Y){return(Y==null?void 0:Y.length)!==void 0?Y:Array.from(Y)}const Em=!1,Yg=Object.freeze(Object.defineProperty({__proto__:null,ssr:Em},Symbol.toStringTag,{value:"Module"}));var cf={exports:{}};/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v4.4.0/LICENSE.txt
 */(function(Y,T){(function(se,fe){Y.exports=fe()})(xl,function(){var se={},fe={};function he(N,s,p){if(fe[N]=p,N==="index"){var C="var sharedModule = {}; ("+fe.shared+")(sharedModule); ("+fe.worker+")(sharedModule);",b={};return fe.shared(b),fe.index(se,b),typeof window<"u"&&se.setWorkerUrl(window.URL.createObjectURL(new Blob([C],{type:"text/javascript"}))),se}}he("shared",["exports"],function(N){function s(i,e,r,o){return new(r||(r=Promise))(function(u,_){function x(F){try{A(o.next(F))}catch(R){_(R)}}function S(F){try{A(o.throw(F))}catch(R){_(R)}}function A(F){var R;F.done?u(F.value):(R=F.value,R instanceof r?R:new r(function(j){j(R)})).then(x,S)}A((o=o.apply(i,e||[])).next())})}function p(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}typeof SuppressedError=="function"&&SuppressedError;var C=b;function b(i,e){this.x=i,this.y=e}b.prototype={clone:function(){return new b(this.x,this.y)},add:function(i){return this.clone()._add(i)},sub:function(i){return this.clone()._sub(i)},multByPoint:function(i){return this.clone()._multByPoint(i)},divByPoint:function(i){return this.clone()._divByPoint(i)},mult:function(i){return this.clone()._mult(i)},div:function(i){return this.clone()._div(i)},rotate:function(i){return this.clone()._rotate(i)},rotateAround:function(i,e){return this.clone()._rotateAround(i,e)},matMult:function(i){return this.clone()._matMult(i)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(i){return this.x===i.x&&this.y===i.y},dist:function(i){return Math.sqrt(this.distSqr(i))},distSqr:function(i){var e=i.x-this.x,r=i.y-this.y;return e*e+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(i){return Math.atan2(this.y-i.y,this.x-i.x)},angleWith:function(i){return this.angleWithSep(i.x,i.y)},angleWithSep:function(i,e){return Math.atan2(this.x*e-this.y*i,this.x*i+this.y*e)},_matMult:function(i){var e=i[2]*this.x+i[3]*this.y;return this.x=i[0]*this.x+i[1]*this.y,this.y=e,this},_add:function(i){return this.x+=i.x,this.y+=i.y,this},_sub:function(i){return this.x-=i.x,this.y-=i.y,this},_mult:function(i){return this.x*=i,this.y*=i,this},_div:function(i){return this.x/=i,this.y/=i,this},_multByPoint:function(i){return this.x*=i.x,this.y*=i.y,this},_divByPoint:function(i){return this.x/=i.x,this.y/=i.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var i=this.y;return this.y=this.x,this.x=-i,this},_rotate:function(i){var e=Math.cos(i),r=Math.sin(i),o=r*this.x+e*this.y;return this.x=e*this.x-r*this.y,this.y=o,this},_rotateAround:function(i,e){var r=Math.cos(i),o=Math.sin(i),u=e.y+o*(this.x-e.x)+r*(this.y-e.y);return this.x=e.x+r*(this.x-e.x)-o*(this.y-e.y),this.y=u,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},b.convert=function(i){return i instanceof b?i:Array.isArray(i)?new b(i[0],i[1]):i};var l=p(C),c=h;function h(i,e,r,o){this.cx=3*i,this.bx=3*(r-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(o-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=e,this.p2x=r,this.p2y=o}h.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,e){if(e===void 0&&(e=1e-6),i<0)return 0;if(i>1)return 1;for(var r=i,o=0;o<8;o++){var u=this.sampleCurveX(r)-i;if(Math.abs(u)<e)return r;var _=this.sampleCurveDerivativeX(r);if(Math.abs(_)<1e-6)break;r-=u/_}var x=0,S=1;for(r=i,o=0;o<20&&(u=this.sampleCurveX(r),!(Math.abs(u-i)<e));o++)i>u?x=r:S=r,r=.5*(S-x)+x;return r},solve:function(i,e){return this.sampleCurveY(this.solveCurveX(i,e))}};var m=p(c);let g,d;function w(){return g==null&&(g=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),g}function E(){if(d==null&&(d=!1,w())){const e=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(e){for(let o=0;o<5*5;o++){const u=4*o;e.fillStyle=`rgb(${u},${u+1},${u+2})`,e.fillRect(o%5,Math.floor(o/5),1,1)}const r=e.getImageData(0,0,5,5).data;for(let o=0;o<5*5*4;o++)if(o%4!=3&&r[o]!==o){d=!0;break}}}return d||!1}function O(i,e,r,o){const u=new m(i,e,r,o);return _=>u.solve(_)}const L=O(.25,.1,.25,1);function V(i,e,r){return Math.min(r,Math.max(e,i))}function $(i,e,r){const o=r-e,u=((i-e)%o+o)%o+e;return u===e?r:u}function ne(i,...e){for(const r of e)for(const o in r)i[o]=r[o];return i}let xe=1;function ze(i,e,r){const o={};for(const u in i)o[u]=e.call(this,i[u],u,i);return o}function Ke(i,e,r){const o={};for(const u in i)e.call(this,i[u],u,i)&&(o[u]=i[u]);return o}function Je(i){return Array.isArray(i)?i.map(Je):typeof i=="object"&&i?ze(i,Je):i}const tt={};function ht(i){tt[i]||(typeof console<"u"&&console.warn(i),tt[i]=!0)}function nt(i,e,r){return(r.y-i.y)*(e.x-i.x)>(e.y-i.y)*(r.x-i.x)}function _t(i){return typeof WorkerGlobalScope<"u"&&i!==void 0&&i instanceof WorkerGlobalScope}let Ot=null;function ot(i){return typeof ImageBitmap<"u"&&i instanceof ImageBitmap}const wt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function ee(i,e,r,o,u){return s(this,void 0,void 0,function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const _=new VideoFrame(i,{timestamp:0});try{const x=_==null?void 0:_.format;if(!x||!x.startsWith("BGR")&&!x.startsWith("RGB"))throw new Error(`Unrecognized format ${x}`);const S=x.startsWith("BGR"),A=new Uint8ClampedArray(o*u*4);if(yield _.copyTo(A,function(F,R,j,W,q){const Q=4*Math.max(-R,0),re=(Math.max(0,j)-j)*W*4+Q,ue=4*W,we=Math.max(0,R),Ne=Math.max(0,j);return{rect:{x:we,y:Ne,width:Math.min(F.width,R+W)-we,height:Math.min(F.height,j+q)-Ne},layout:[{offset:re,stride:ue}]}}(i,e,r,o,u)),S)for(let F=0;F<A.length;F+=4){const R=A[F];A[F]=A[F+2],A[F+2]=R}return A}finally{_.close()}})}let be,me;const ye="AbortError";function Ve(){return new Error(ye)}const ge={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function te(i){return ge.REGISTERED_PROTOCOLS[i.substring(0,i.indexOf("://"))]}const Ae="global-dispatcher";class Ue extends Error{constructor(e,r,o,u){super(`AJAXError: ${r} (${e}): ${o}`),this.status=e,this.statusText=r,this.url=o,this.body=u}}const it=()=>_t(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,Xe=function(i,e){if(/:\/\//.test(i.url)&&!/^https?:|^file:/.test(i.url)){const o=te(i.url);if(o)return o(i,e);if(_t(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:i,targetMapId:Ae},e)}if(!(/^file:/.test(r=i.url)||/^file:/.test(it())&&!/^\w+:/.test(r))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(o,u){return s(this,void 0,void 0,function*(){const _=new Request(o.url,{method:o.method||"GET",body:o.body,credentials:o.credentials,headers:o.headers,cache:o.cache,referrer:it(),signal:u.signal});o.type!=="json"||_.headers.has("Accept")||_.headers.set("Accept","application/json");const x=yield fetch(_);if(!x.ok){const F=yield x.blob();throw new Ue(x.status,x.statusText,o.url,F)}let S;S=o.type==="arrayBuffer"||o.type==="image"?x.arrayBuffer():o.type==="json"?x.json():x.text();const A=yield S;if(u.signal.aborted)throw Ve();return{data:A,cacheControl:x.headers.get("Cache-Control"),expires:x.headers.get("Expires")}})}(i,e);if(_t(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:i,mustQueue:!0,targetMapId:Ae},e)}var r;return function(o,u){return new Promise((_,x)=>{var S;const A=new XMLHttpRequest;A.open(o.method||"GET",o.url,!0),o.type!=="arrayBuffer"&&o.type!=="image"||(A.responseType="arraybuffer");for(const F in o.headers)A.setRequestHeader(F,o.headers[F]);o.type==="json"&&(A.responseType="text",!((S=o.headers)===null||S===void 0)&&S.Accept||A.setRequestHeader("Accept","application/json")),A.withCredentials=o.credentials==="include",A.onerror=()=>{x(new Error(A.statusText))},A.onload=()=>{if(!u.signal.aborted)if((A.status>=200&&A.status<300||A.status===0)&&A.response!==null){let F=A.response;if(o.type==="json")try{F=JSON.parse(A.response)}catch(R){return void x(R)}_({data:F,cacheControl:A.getResponseHeader("Cache-Control"),expires:A.getResponseHeader("Expires")})}else{const F=new Blob([A.response],{type:A.getResponseHeader("Content-Type")});x(new Ue(A.status,A.statusText,o.url,F))}},u.signal.addEventListener("abort",()=>{A.abort(),x(Ve())}),A.send(o.body)})}(i,e)};function He(i){if(!i||i.indexOf("://")<=0||i.indexOf("data:image/")===0||i.indexOf("blob:")===0)return!0;const e=new URL(i),r=window.location;return e.protocol===r.protocol&&e.host===r.host}function vt(i,e,r){r[i]&&r[i].indexOf(e)!==-1||(r[i]=r[i]||[],r[i].push(e))}function Et(i,e,r){if(r&&r[i]){const o=r[i].indexOf(e);o!==-1&&r[i].splice(o,1)}}class $e{constructor(e,r={}){ne(this,r),this.type=e}}class Oe extends $e{constructor(e,r={}){super("error",ne({error:e},r))}}class at{on(e,r){return this._listeners=this._listeners||{},vt(e,r,this._listeners),this}off(e,r){return Et(e,r,this._listeners),Et(e,r,this._oneTimeListeners),this}once(e,r){return r?(this._oneTimeListeners=this._oneTimeListeners||{},vt(e,r,this._oneTimeListeners),this):new Promise(o=>this.once(e,o))}fire(e,r){typeof e=="string"&&(e=new $e(e,r||{}));const o=e.type;if(this.listens(o)){e.target=this;const u=this._listeners&&this._listeners[o]?this._listeners[o].slice():[];for(const S of u)S.call(this,e);const _=this._oneTimeListeners&&this._oneTimeListeners[o]?this._oneTimeListeners[o].slice():[];for(const S of _)Et(o,S,this._oneTimeListeners),S.call(this,e);const x=this._eventedParent;x&&(ne(e,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),x.fire(e))}else e instanceof Oe&&console.error(e.error);return this}listens(e){return this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e)}setEventedParent(e,r){return this._eventedParent=e,this._eventedParentData=r,this}}var ae={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"enum",default:"mercator",values:{mercator:{},globe:{}}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const Ze=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function pt(i,e){const r={};for(const o in i)o!=="ref"&&(r[o]=i[o]);return Ze.forEach(o=>{o in e&&(r[o]=e[o])}),r}function ft(i,e){if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let r=0;r<i.length;r++)if(!ft(i[r],e[r]))return!1;return!0}if(typeof i=="object"&&i!==null&&e!==null){if(typeof e!="object"||Object.keys(i).length!==Object.keys(e).length)return!1;for(const r in i)if(!ft(i[r],e[r]))return!1;return!0}return i===e}function Lt(i,e){i.push(e)}function $t(i,e,r){Lt(r,{command:"addSource",args:[i,e[i]]})}function lt(i,e,r){Lt(e,{command:"removeSource",args:[i]}),r[i]=!0}function St(i,e,r,o){lt(i,r,o),$t(i,e,r)}function Xt(i,e,r){let o;for(o in i[r])if(Object.prototype.hasOwnProperty.call(i[r],o)&&o!=="data"&&!ft(i[r][o],e[r][o]))return!1;for(o in e[r])if(Object.prototype.hasOwnProperty.call(e[r],o)&&o!=="data"&&!ft(i[r][o],e[r][o]))return!1;return!0}function di(i,e,r,o,u,_){i=i||{},e=e||{};for(const x in i)Object.prototype.hasOwnProperty.call(i,x)&&(ft(i[x],e[x])||r.push({command:_,args:[o,x,e[x],u]}));for(const x in e)Object.prototype.hasOwnProperty.call(e,x)&&!Object.prototype.hasOwnProperty.call(i,x)&&(ft(i[x],e[x])||r.push({command:_,args:[o,x,e[x],u]}))}function vi(i){return i.id}function Ci(i,e){return i[e.id]=e,i}class ct{constructor(e,r,o,u){this.message=(e?`${e}: `:"")+o,u&&(this.identifier=u),r!=null&&r.__line__&&(this.line=r.__line__)}}function Ei(i,...e){for(const r of e)for(const o in r)i[o]=r[o];return i}class Fi extends Error{constructor(e,r){super(r),this.message=r,this.key=e}}class yr{constructor(e,r=[]){this.parent=e,this.bindings={};for(const[o,u]of r)this.bindings[o]=u}concat(e){return new yr(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const Zi={kind:"null"},Ct={kind:"number"},pi={kind:"string"},Qt={kind:"boolean"},qi={kind:"color"},ar={kind:"object"},si={kind:"value"},Oi={kind:"collator"},$i={kind:"formatted"},Ki={kind:"padding"},le={kind:"resolvedImage"},H={kind:"variableAnchorOffsetCollection"};function X(i,e){return{kind:"array",itemType:i,N:e}}function J(i){if(i.kind==="array"){const e=J(i.itemType);return typeof i.N=="number"?`array<${e}, ${i.N}>`:i.itemType.kind==="value"?"array":`array<${e}>`}return i.kind}const de=[Zi,Ct,pi,Qt,qi,$i,ar,X(si),Ki,le,H];function Te(i,e){if(e.kind==="error")return null;if(i.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Te(i.itemType,e.itemType))&&(typeof i.N!="number"||i.N===e.N))return null}else{if(i.kind===e.kind)return null;if(i.kind==="value"){for(const r of de)if(!Te(r,e))return null}}return`Expected ${J(i)} but found ${J(e)} instead.`}function De(i,e){return e.some(r=>r.kind===i.kind)}function Le(i,e){return e.some(r=>r==="null"?i===null:r==="array"?Array.isArray(i):r==="object"?i&&!Array.isArray(i)&&typeof i=="object":r===typeof i)}function Ce(i,e){return i.kind==="array"&&e.kind==="array"?i.itemType.kind===e.itemType.kind&&typeof i.N=="number":i.kind===e.kind}const Ge=.96422,gt=.82521,Qe=4/29,st=6/29,ti=3*st*st,ei=st*st*st,xi=Math.PI/180,mi=180/Math.PI;function Pi(i){return(i%=360)<0&&(i+=360),i}function Li([i,e,r,o]){let u,_;const x=Mr((.2225045*(i=tr(i))+.7168786*(e=tr(e))+.0606169*(r=tr(r)))/1);i===e&&e===r?u=_=x:(u=Mr((.4360747*i+.3850649*e+.1430804*r)/Ge),_=Mr((.0139322*i+.0971045*e+.7141733*r)/gt));const S=116*x-16;return[S<0?0:S,500*(u-x),200*(x-_),o]}function tr(i){return i<=.04045?i/12.92:Math.pow((i+.055)/1.055,2.4)}function Mr(i){return i>ei?Math.pow(i,1/3):i/ti+Qe}function ui([i,e,r,o]){let u=(i+16)/116,_=isNaN(e)?u:u+e/500,x=isNaN(r)?u:u-r/200;return u=1*Lr(u),_=Ge*Lr(_),x=gt*Lr(x),[dr(3.1338561*_-1.6168667*u-.4906146*x),dr(-.9787684*_+1.9161415*u+.033454*x),dr(.0719453*_-.2289914*u+1.4052427*x),o]}function dr(i){return(i=i<=.00304?12.92*i:1.055*Math.pow(i,1/2.4)-.055)<0?0:i>1?1:i}function Lr(i){return i>st?i*i*i:ti*(i-Qe)}function Qr(i){return parseInt(i.padEnd(2,i),16)/255}function en(i,e){return Fr(e?i/100:i,0,1)}function Fr(i,e,r){return Math.min(Math.max(e,i),r)}function hs(i){return!i.some(Number.isNaN)}const Tl={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};class zi{constructor(e,r,o,u=1,_=!0){this.r=e,this.g=r,this.b=o,this.a=u,_||(this.r*=u,this.g*=u,this.b*=u,u||this.overwriteGetter("rgb",[e,r,o,u]))}static parse(e){if(e instanceof zi)return e;if(typeof e!="string")return;const r=function(o){if((o=o.toLowerCase().trim())==="transparent")return[0,0,0,0];const u=Tl[o];if(u){const[x,S,A]=u;return[x/255,S/255,A/255,1]}if(o.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(o)){const x=o.length<6?1:2;let S=1;return[Qr(o.slice(S,S+=x)),Qr(o.slice(S,S+=x)),Qr(o.slice(S,S+=x)),Qr(o.slice(S,S+x)||"ff")]}if(o.startsWith("rgb")){const x=o.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(x){const[S,A,F,R,j,W,q,Q,re,ue,we,Ne]=x,Ee=[R||" ",q||" ",ue].join("");if(Ee==="  "||Ee==="  /"||Ee===",,"||Ee===",,,"){const Re=[F,W,re].join(""),et=Re==="%%%"?100:Re===""?255:0;if(et){const xt=[Fr(+A/et,0,1),Fr(+j/et,0,1),Fr(+Q/et,0,1),we?en(+we,Ne):1];if(hs(xt))return xt}}return}}const _=o.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(_){const[x,S,A,F,R,j,W,q,Q]=_,re=[A||" ",R||" ",W].join("");if(re==="  "||re==="  /"||re===",,"||re===",,,"){const ue=[+S,Fr(+F,0,100),Fr(+j,0,100),q?en(+q,Q):1];if(hs(ue))return function([we,Ne,Ee,Re]){function et(xt){const jt=(xt+we/30)%12,hi=Ne*Math.min(Ee,1-Ee);return Ee-hi*Math.max(-1,Math.min(jt-3,9-jt,1))}return we=Pi(we),Ne/=100,Ee/=100,[et(0),et(8),et(4),Re]}(ue)}}}(e);return r?new zi(...r,!1):void 0}get rgb(){const{r:e,g:r,b:o,a:u}=this,_=u||1/0;return this.overwriteGetter("rgb",[e/_,r/_,o/_,u])}get hcl(){return this.overwriteGetter("hcl",function(e){const[r,o,u,_]=Li(e),x=Math.sqrt(o*o+u*u);return[Math.round(1e4*x)?Pi(Math.atan2(u,o)*mi):NaN,x,r,_]}(this.rgb))}get lab(){return this.overwriteGetter("lab",Li(this.rgb))}overwriteGetter(e,r){return Object.defineProperty(this,e,{value:r}),r}toString(){const[e,r,o,u]=this.rgb;return`rgba(${[e,r,o].map(_=>Math.round(255*_)).join(",")},${u})`}}zi.black=new zi(0,0,0,1),zi.white=new zi(1,1,1,1),zi.transparent=new zi(0,0,0,0),zi.red=new zi(1,0,0,1);class po{constructor(e,r,o){this.sensitivity=e?r?"variant":"case":r?"accent":"base",this.locale=o,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,r){return this.collator.compare(e,r)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class mo{constructor(e,r,o,u,_){this.text=e,this.image=r,this.scale=o,this.fontStack=u,this.textColor=_}}class Wi{constructor(e){this.sections=e}static fromString(e){return new Wi([new mo(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||e.image&&e.image.name.length!==0)}static factory(e){return e instanceof Wi?e:Wi.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}}class qr{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof qr)return e;if(typeof e=="number")return new qr([e,e,e,e]);if(Array.isArray(e)&&!(e.length<1||e.length>4)){for(const r of e)if(typeof r!="number")return;switch(e.length){case 1:e=[e[0],e[0],e[0],e[0]];break;case 2:e=[e[0],e[1],e[0],e[1]];break;case 3:e=[e[0],e[1],e[2],e[1]]}return new qr(e)}}toString(){return JSON.stringify(this.values)}}const Ls=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class Cr{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof Cr)return e;if(Array.isArray(e)&&!(e.length<1)&&e.length%2==0){for(let r=0;r<e.length;r+=2){const o=e[r],u=e[r+1];if(typeof o!="string"||!Ls.has(o)||!Array.isArray(u)||u.length!==2||typeof u[0]!="number"||typeof u[1]!="number")return}return new Cr(e)}}toString(){return JSON.stringify(this.values)}}class Sr{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new Sr({name:e,available:!1}):null}}function go(i,e,r,o){return typeof i=="number"&&i>=0&&i<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof r=="number"&&r>=0&&r<=255?o===void 0||typeof o=="number"&&o>=0&&o<=1?null:`Invalid rgba value [${[i,e,r,o].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof o=="number"?[i,e,r,o]:[i,e,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function $r(i){if(i===null||typeof i=="string"||typeof i=="boolean"||typeof i=="number"||i instanceof zi||i instanceof po||i instanceof Wi||i instanceof qr||i instanceof Cr||i instanceof Sr)return!0;if(Array.isArray(i)){for(const e of i)if(!$r(e))return!1;return!0}if(typeof i=="object"){for(const e in i)if(!$r(i[e]))return!1;return!0}return!1}function ir(i){if(i===null)return Zi;if(typeof i=="string")return pi;if(typeof i=="boolean")return Qt;if(typeof i=="number")return Ct;if(i instanceof zi)return qi;if(i instanceof po)return Oi;if(i instanceof Wi)return $i;if(i instanceof qr)return Ki;if(i instanceof Cr)return H;if(i instanceof Sr)return le;if(Array.isArray(i)){const e=i.length;let r;for(const o of i){const u=ir(o);if(r){if(r===u)continue;r=si;break}r=u}return X(r||si,e)}return ar}function Fs(i){const e=typeof i;return i===null?"":e==="string"||e==="number"||e==="boolean"?String(i):i instanceof zi||i instanceof Wi||i instanceof qr||i instanceof Cr||i instanceof Sr?i.toString():JSON.stringify(i)}class ws{constructor(e,r){this.type=e,this.value=r}static parse(e,r){if(e.length!==2)return r.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!$r(e[1]))return r.error("invalid value");const o=e[1];let u=ir(o);const _=r.expectedType;return u.kind!=="array"||u.N!==0||!_||_.kind!=="array"||typeof _.N=="number"&&_.N!==0||(u=_),new ws(u,o)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}class vr{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const Cs={string:pi,number:Ct,boolean:Qt,object:ar};class wn{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");let o,u=1;const _=e[0];if(_==="array"){let S,A;if(e.length>2){const F=e[1];if(typeof F!="string"||!(F in Cs)||F==="object")return r.error('The item type argument of "array" must be one of string, number, boolean',1);S=Cs[F],u++}else S=si;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return r.error('The length argument to "array" must be a positive integer literal',2);A=e[2],u++}o=X(S,A)}else{if(!Cs[_])throw new Error(`Types doesn't contain name = ${_}`);o=Cs[_]}const x=[];for(;u<e.length;u++){const S=r.parse(e[u],u,si);if(!S)return null;x.push(S)}return new wn(o,x)}evaluate(e){for(let r=0;r<this.args.length;r++){const o=this.args[r].evaluate(e);if(!Te(this.type,ir(o)))return o;if(r===this.args.length-1)throw new vr(`Expected value to be of type ${J(this.type)}, but found ${J(ir(o))} instead.`)}throw new Error}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}const zs={"to-boolean":Qt,"to-color":qi,"to-number":Ct,"to-string":pi};class On{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const o=e[0];if(!zs[o])throw new Error(`Can't parse ${o} as it is not part of the known types`);if((o==="to-boolean"||o==="to-string")&&e.length!==2)return r.error("Expected one argument.");const u=zs[o],_=[];for(let x=1;x<e.length;x++){const S=r.parse(e[x],x,si);if(!S)return null;_.push(S)}return new On(u,_)}evaluate(e){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(e);case"color":{let r,o;for(const u of this.args){if(r=u.evaluate(e),o=null,r instanceof zi)return r;if(typeof r=="string"){const _=e.parseColor(r);if(_)return _}else if(Array.isArray(r)&&(o=r.length<3||r.length>4?`Invalid rbga value ${JSON.stringify(r)}: expected an array containing either three or four numeric values.`:go(r[0],r[1],r[2],r[3]),!o))return new zi(r[0]/255,r[1]/255,r[2]/255,r[3])}throw new vr(o||`Could not parse color from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"padding":{let r;for(const o of this.args){r=o.evaluate(e);const u=qr.parse(r);if(u)return u}throw new vr(`Could not parse padding from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"variableAnchorOffsetCollection":{let r;for(const o of this.args){r=o.evaluate(e);const u=Cr.parse(r);if(u)return u}throw new vr(`Could not parse variableAnchorOffsetCollection from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"number":{let r=null;for(const o of this.args){if(r=o.evaluate(e),r===null)return 0;const u=Number(r);if(!isNaN(u))return u}throw new vr(`Could not convert ${JSON.stringify(r)} to number.`)}case"formatted":return Wi.fromString(Fs(this.args[0].evaluate(e)));case"resolvedImage":return Sr.fromString(Fs(this.args[0].evaluate(e)));default:return Fs(this.args[0].evaluate(e))}}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}const zo=["Unknown","Point","LineString","Polygon"];class Rs{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?zo[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(e){let r=this._parseColorCache[e];return r||(r=this._parseColorCache[e]=zi.parse(e)),r}}class Bi{constructor(e,r,o=[],u,_=new yr,x=[]){this.registry=e,this.path=o,this.key=o.map(S=>`[${S}]`).join(""),this.scope=_,this.errors=x,this.expectedType=u,this._isConstant=r}parse(e,r,o,u,_={}){return r?this.concat(r,o,u)._parse(e,_):this._parse(e,_)}_parse(e,r){function o(u,_,x){return x==="assert"?new wn(_,[u]):x==="coerce"?new On(_,[u]):u}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const u=e[0];if(typeof u!="string")return this.error(`Expression name must be a string, but found ${typeof u} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const _=this.registry[u];if(_){let x=_.parse(e,this);if(!x)return null;if(this.expectedType){const S=this.expectedType,A=x.type;if(S.kind!=="string"&&S.kind!=="number"&&S.kind!=="boolean"&&S.kind!=="object"&&S.kind!=="array"||A.kind!=="value")if(S.kind!=="color"&&S.kind!=="formatted"&&S.kind!=="resolvedImage"||A.kind!=="value"&&A.kind!=="string")if(S.kind!=="padding"||A.kind!=="value"&&A.kind!=="number"&&A.kind!=="array")if(S.kind!=="variableAnchorOffsetCollection"||A.kind!=="value"&&A.kind!=="array"){if(this.checkSubtype(S,A))return null}else x=o(x,S,r.typeAnnotation||"coerce");else x=o(x,S,r.typeAnnotation||"coerce");else x=o(x,S,r.typeAnnotation||"coerce");else x=o(x,S,r.typeAnnotation||"assert")}if(!(x instanceof ws)&&x.type.kind!=="resolvedImage"&&this._isConstant(x)){const S=new Rs;try{x=new ws(x.type,x.evaluate(S))}catch(A){return this.error(A.message),null}}return x}return this.error(`Unknown expression "${u}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,r,o){const u=typeof e=="number"?this.path.concat(e):this.path,_=o?this.scope.concat(o):this.scope;return new Bi(this.registry,this._isConstant,u,r||null,_,this.errors)}error(e,...r){const o=`${this.key}${r.map(u=>`[${u}]`).join("")}`;this.errors.push(new Fi(o,e))}checkSubtype(e,r){const o=Te(e,r);return o&&this.error(o),o}}class Ro{constructor(e,r){this.type=r.type,this.bindings=[].concat(e),this.result=r}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const r of this.bindings)e(r[1]);e(this.result)}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const o=[];for(let _=1;_<e.length-1;_+=2){const x=e[_];if(typeof x!="string")return r.error(`Expected string, but found ${typeof x} instead.`,_);if(/[^a-zA-Z0-9_]/.test(x))return r.error("Variable names must contain only alphanumeric characters or '_'.",_);const S=r.parse(e[_+1],_+1);if(!S)return null;o.push([x,S])}const u=r.parse(e[e.length-1],e.length-1,r.expectedType,o);return u?new Ro(o,u):null}outputDefined(){return this.result.outputDefined()}}class Yn{constructor(e,r){this.type=r.type,this.name=e,this.boundExpression=r}static parse(e,r){if(e.length!==2||typeof e[1]!="string")return r.error("'var' expression requires exactly one string literal argument.");const o=e[1];return r.scope.has(o)?new Yn(o,r.scope.get(o)):r.error(`Unknown variable "${o}". Make sure "${o}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}}class P{constructor(e,r,o){this.type=e,this.index=r,this.input=o}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=r.parse(e[1],1,Ct),u=r.parse(e[2],2,X(r.expectedType||si));return o&&u?new P(u.type.itemType,o,u):null}evaluate(e){const r=this.index.evaluate(e),o=this.input.evaluate(e);if(r<0)throw new vr(`Array index out of bounds: ${r} < 0.`);if(r>=o.length)throw new vr(`Array index out of bounds: ${r} > ${o.length-1}.`);if(r!==Math.floor(r))throw new vr(`Array index must be an integer, but found ${r} instead.`);return o[r]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}}class z{constructor(e,r){this.type=Qt,this.needle=e,this.haystack=r}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=r.parse(e[1],1,si),u=r.parse(e[2],2,si);return o&&u?De(o.type,[Qt,pi,Ct,Zi,si])?new z(o,u):r.error(`Expected first argument to be of type boolean, string, number or null, but found ${J(o.type)} instead`):null}evaluate(e){const r=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(!o)return!1;if(!Le(r,["boolean","string","number","null"]))throw new vr(`Expected first argument to be of type boolean, string, number or null, but found ${J(ir(r))} instead.`);if(!Le(o,["string","array"]))throw new vr(`Expected second argument to be of type array or string, but found ${J(ir(o))} instead.`);return o.indexOf(r)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}}class Z{constructor(e,r,o){this.type=Ct,this.needle=e,this.haystack=r,this.fromIndex=o}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=r.parse(e[1],1,si),u=r.parse(e[2],2,si);if(!o||!u)return null;if(!De(o.type,[Qt,pi,Ct,Zi,si]))return r.error(`Expected first argument to be of type boolean, string, number or null, but found ${J(o.type)} instead`);if(e.length===4){const _=r.parse(e[3],3,Ct);return _?new Z(o,u,_):null}return new Z(o,u)}evaluate(e){const r=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(!Le(r,["boolean","string","number","null"]))throw new vr(`Expected first argument to be of type boolean, string, number or null, but found ${J(ir(r))} instead.`);if(!Le(o,["string","array"]))throw new vr(`Expected second argument to be of type array or string, but found ${J(ir(o))} instead.`);if(this.fromIndex){const u=this.fromIndex.evaluate(e);return o.indexOf(r,u)}return o.indexOf(r)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}}class _e{constructor(e,r,o,u,_,x){this.inputType=e,this.type=r,this.input=o,this.cases=u,this.outputs=_,this.otherwise=x}static parse(e,r){if(e.length<5)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return r.error("Expected an even number of arguments.");let o,u;r.expectedType&&r.expectedType.kind!=="value"&&(u=r.expectedType);const _={},x=[];for(let F=2;F<e.length-1;F+=2){let R=e[F];const j=e[F+1];Array.isArray(R)||(R=[R]);const W=r.concat(F);if(R.length===0)return W.error("Expected at least one branch label.");for(const Q of R){if(typeof Q!="number"&&typeof Q!="string")return W.error("Branch labels must be numbers or strings.");if(typeof Q=="number"&&Math.abs(Q)>Number.MAX_SAFE_INTEGER)return W.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof Q=="number"&&Math.floor(Q)!==Q)return W.error("Numeric branch labels must be integer values.");if(o){if(W.checkSubtype(o,ir(Q)))return null}else o=ir(Q);if(_[String(Q)]!==void 0)return W.error("Branch labels must be unique.");_[String(Q)]=x.length}const q=r.parse(j,F,u);if(!q)return null;u=u||q.type,x.push(q)}const S=r.parse(e[1],1,si);if(!S)return null;const A=r.parse(e[e.length-1],e.length-1,u);return A?S.type.kind!=="value"&&r.concat(1).checkSubtype(o,S.type)?null:new _e(o,u,S,_,x,A):null}evaluate(e){const r=this.input.evaluate(e);return(ir(r)===this.inputType&&this.outputs[this.cases[r]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}}class Pe{constructor(e,r,o){this.type=e,this.branches=r,this.otherwise=o}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return r.error("Expected an odd number of arguments.");let o;r.expectedType&&r.expectedType.kind!=="value"&&(o=r.expectedType);const u=[];for(let x=1;x<e.length-1;x+=2){const S=r.parse(e[x],x,Qt);if(!S)return null;const A=r.parse(e[x+1],x+1,o);if(!A)return null;u.push([S,A]),o=o||A.type}const _=r.parse(e[e.length-1],e.length-1,o);if(!_)return null;if(!o)throw new Error("Can't infer output type");return new Pe(o,u,_)}evaluate(e){for(const[r,o]of this.branches)if(r.evaluate(e))return o.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[r,o]of this.branches)e(r),e(o);e(this.otherwise)}outputDefined(){return this.branches.every(([e,r])=>r.outputDefined())&&this.otherwise.outputDefined()}}class Me{constructor(e,r,o,u){this.type=e,this.input=r,this.beginIndex=o,this.endIndex=u}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=r.parse(e[1],1,si),u=r.parse(e[2],2,Ct);if(!o||!u)return null;if(!De(o.type,[X(si),pi,si]))return r.error(`Expected first argument to be of type array or string, but found ${J(o.type)} instead`);if(e.length===4){const _=r.parse(e[3],3,Ct);return _?new Me(o.type,o,u,_):null}return new Me(o.type,o,u)}evaluate(e){const r=this.input.evaluate(e),o=this.beginIndex.evaluate(e);if(!Le(r,["string","array"]))throw new vr(`Expected first argument to be of type array or string, but found ${J(ir(r))} instead.`);if(this.endIndex){const u=this.endIndex.evaluate(e);return r.slice(o,u)}return r.slice(o)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}}function Be(i,e){const r=i.length-1;let o,u,_=0,x=r,S=0;for(;_<=x;)if(S=Math.floor((_+x)/2),o=i[S],u=i[S+1],o<=e){if(S===r||e<u)return S;_=S+1}else{if(!(o>e))throw new vr("Input is not a number.");x=S-1}return 0}class bt{constructor(e,r,o){this.type=e,this.input=r,this.labels=[],this.outputs=[];for(const[u,_]of o)this.labels.push(u),this.outputs.push(_)}static parse(e,r){if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");const o=r.parse(e[1],1,Ct);if(!o)return null;const u=[];let _=null;r.expectedType&&r.expectedType.kind!=="value"&&(_=r.expectedType);for(let x=1;x<e.length;x+=2){const S=x===1?-1/0:e[x],A=e[x+1],F=x,R=x+1;if(typeof S!="number")return r.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',F);if(u.length&&u[u.length-1][0]>=S)return r.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',F);const j=r.parse(A,R,_);if(!j)return null;_=_||j.type,u.push([S,j])}return new bt(_,o,u)}evaluate(e){const r=this.labels,o=this.outputs;if(r.length===1)return o[0].evaluate(e);const u=this.input.evaluate(e);if(u<=r[0])return o[0].evaluate(e);const _=r.length;return u>=r[_-1]?o[_-1].evaluate(e):o[Be(r,u)].evaluate(e)}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}}function It(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var Vt=Nt;function Nt(i,e,r,o){this.cx=3*i,this.bx=3*(r-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(o-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=e,this.p2x=r,this.p2y=o}Nt.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,e){if(e===void 0&&(e=1e-6),i<0)return 0;if(i>1)return 1;for(var r=i,o=0;o<8;o++){var u=this.sampleCurveX(r)-i;if(Math.abs(u)<e)return r;var _=this.sampleCurveDerivativeX(r);if(Math.abs(_)<1e-6)break;r-=u/_}var x=0,S=1;for(r=i,o=0;o<20&&(u=this.sampleCurveX(r),!(Math.abs(u-i)<e));o++)i>u?x=r:S=r,r=.5*(S-x)+x;return r},solve:function(i,e){return this.sampleCurveY(this.solveCurveX(i,e))}};var Dt=It(Vt);function _i(i,e,r){return i+r*(e-i)}function rr(i,e,r){return i.map((o,u)=>_i(o,e[u],r))}const fi={number:_i,color:function(i,e,r,o="rgb"){switch(o){case"rgb":{const[u,_,x,S]=rr(i.rgb,e.rgb,r);return new zi(u,_,x,S,!1)}case"hcl":{const[u,_,x,S]=i.hcl,[A,F,R,j]=e.hcl;let W,q;if(isNaN(u)||isNaN(A))isNaN(u)?isNaN(A)?W=NaN:(W=A,x!==1&&x!==0||(q=F)):(W=u,R!==1&&R!==0||(q=_));else{let Ne=A-u;A>u&&Ne>180?Ne-=360:A<u&&u-A>180&&(Ne+=360),W=u+r*Ne}const[Q,re,ue,we]=function([Ne,Ee,Re,et]){return Ne=isNaN(Ne)?0:Ne*xi,ui([Re,Math.cos(Ne)*Ee,Math.sin(Ne)*Ee,et])}([W,q??_i(_,F,r),_i(x,R,r),_i(S,j,r)]);return new zi(Q,re,ue,we,!1)}case"lab":{const[u,_,x,S]=ui(rr(i.lab,e.lab,r));return new zi(u,_,x,S,!1)}}},array:rr,padding:function(i,e,r){return new qr(rr(i.values,e.values,r))},variableAnchorOffsetCollection:function(i,e,r){const o=i.values,u=e.values;if(o.length!==u.length)throw new vr(`Cannot interpolate values of different length. from: ${i.toString()}, to: ${e.toString()}`);const _=[];for(let x=0;x<o.length;x+=2){if(o[x]!==u[x])throw new vr(`Cannot interpolate values containing mismatched anchors. from[${x}]: ${o[x]}, to[${x}]: ${u[x]}`);_.push(o[x]);const[S,A]=o[x+1],[F,R]=u[x+1];_.push([_i(S,F,r),_i(A,R,r)])}return new Cr(_)}};class ji{constructor(e,r,o,u,_){this.type=e,this.operator=r,this.interpolation=o,this.input=u,this.labels=[],this.outputs=[];for(const[x,S]of _)this.labels.push(x),this.outputs.push(S)}static interpolationFactor(e,r,o,u){let _=0;if(e.name==="exponential")_=yt(r,e.base,o,u);else if(e.name==="linear")_=yt(r,1,o,u);else if(e.name==="cubic-bezier"){const x=e.controlPoints;_=new Dt(x[0],x[1],x[2],x[3]).solve(yt(r,1,o,u))}return _}static parse(e,r){let[o,u,_,...x]=e;if(!Array.isArray(u)||u.length===0)return r.error("Expected an interpolation type expression.",1);if(u[0]==="linear")u={name:"linear"};else if(u[0]==="exponential"){const F=u[1];if(typeof F!="number")return r.error("Exponential interpolation requires a numeric base.",1,1);u={name:"exponential",base:F}}else{if(u[0]!=="cubic-bezier")return r.error(`Unknown interpolation type ${String(u[0])}`,1,0);{const F=u.slice(1);if(F.length!==4||F.some(R=>typeof R!="number"||R<0||R>1))return r.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);u={name:"cubic-bezier",controlPoints:F}}}if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");if(_=r.parse(_,2,Ct),!_)return null;const S=[];let A=null;o==="interpolate-hcl"||o==="interpolate-lab"?A=qi:r.expectedType&&r.expectedType.kind!=="value"&&(A=r.expectedType);for(let F=0;F<x.length;F+=2){const R=x[F],j=x[F+1],W=F+3,q=F+4;if(typeof R!="number")return r.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',W);if(S.length&&S[S.length-1][0]>=R)return r.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',W);const Q=r.parse(j,q,A);if(!Q)return null;A=A||Q.type,S.push([R,Q])}return Ce(A,Ct)||Ce(A,qi)||Ce(A,Ki)||Ce(A,H)||Ce(A,X(Ct))?new ji(A,o,u,_,S):r.error(`Type ${J(A)} is not interpolatable.`)}evaluate(e){const r=this.labels,o=this.outputs;if(r.length===1)return o[0].evaluate(e);const u=this.input.evaluate(e);if(u<=r[0])return o[0].evaluate(e);const _=r.length;if(u>=r[_-1])return o[_-1].evaluate(e);const x=Be(r,u),S=ji.interpolationFactor(this.interpolation,u,r[x],r[x+1]),A=o[x].evaluate(e),F=o[x+1].evaluate(e);switch(this.operator){case"interpolate":return fi[this.type.kind](A,F,S);case"interpolate-hcl":return fi.color(A,F,S,"hcl");case"interpolate-lab":return fi.color(A,F,S,"lab")}}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}}function yt(i,e,r,o){const u=o-r,_=i-r;return u===0?0:e===1?_/u:(Math.pow(e,_)-1)/(Math.pow(e,u)-1)}class ii{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expectected at least one argument.");let o=null;const u=r.expectedType;u&&u.kind!=="value"&&(o=u);const _=[];for(const S of e.slice(1)){const A=r.parse(S,1+_.length,o,void 0,{typeAnnotation:"omit"});if(!A)return null;o=o||A.type,_.push(A)}if(!o)throw new Error("No output type");const x=u&&_.some(S=>Te(u,S.type));return new ii(x?si:o,_)}evaluate(e){let r,o=null,u=0;for(const _ of this.args)if(u++,o=_.evaluate(e),o&&o instanceof Sr&&!o.available&&(r||(r=o.name),o=null,u===this.args.length&&(o=r)),o!==null)break;return o}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}function Hi(i,e){return i==="=="||i==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function kr(i,e,r,o){return o.compare(e,r)===0}function lr(i,e,r){const o=i!=="=="&&i!=="!=";return class hf{constructor(_,x,S){this.type=Qt,this.lhs=_,this.rhs=x,this.collator=S,this.hasUntypedArgument=_.type.kind==="value"||x.type.kind==="value"}static parse(_,x){if(_.length!==3&&_.length!==4)return x.error("Expected two or three arguments.");const S=_[0];let A=x.parse(_[1],1,si);if(!A)return null;if(!Hi(S,A.type))return x.concat(1).error(`"${S}" comparisons are not supported for type '${J(A.type)}'.`);let F=x.parse(_[2],2,si);if(!F)return null;if(!Hi(S,F.type))return x.concat(2).error(`"${S}" comparisons are not supported for type '${J(F.type)}'.`);if(A.type.kind!==F.type.kind&&A.type.kind!=="value"&&F.type.kind!=="value")return x.error(`Cannot compare types '${J(A.type)}' and '${J(F.type)}'.`);o&&(A.type.kind==="value"&&F.type.kind!=="value"?A=new wn(F.type,[A]):A.type.kind!=="value"&&F.type.kind==="value"&&(F=new wn(A.type,[F])));let R=null;if(_.length===4){if(A.type.kind!=="string"&&F.type.kind!=="string"&&A.type.kind!=="value"&&F.type.kind!=="value")return x.error("Cannot use collator to compare non-string types.");if(R=x.parse(_[3],3,Oi),!R)return null}return new hf(A,F,R)}evaluate(_){const x=this.lhs.evaluate(_),S=this.rhs.evaluate(_);if(o&&this.hasUntypedArgument){const A=ir(x),F=ir(S);if(A.kind!==F.kind||A.kind!=="string"&&A.kind!=="number")throw new vr(`Expected arguments for "${i}" to be (string, string) or (number, number), but found (${A.kind}, ${F.kind}) instead.`)}if(this.collator&&!o&&this.hasUntypedArgument){const A=ir(x),F=ir(S);if(A.kind!=="string"||F.kind!=="string")return e(_,x,S)}return this.collator?r(_,x,S,this.collator.evaluate(_)):e(_,x,S)}eachChild(_){_(this.lhs),_(this.rhs),this.collator&&_(this.collator)}outputDefined(){return!0}}}const pa=lr("==",function(i,e,r){return e===r},kr),Wa=lr("!=",function(i,e,r){return e!==r},function(i,e,r,o){return!kr(0,e,r,o)}),nr=lr("<",function(i,e,r){return e<r},function(i,e,r,o){return o.compare(e,r)<0}),Ha=lr(">",function(i,e,r){return e>r},function(i,e,r,o){return o.compare(e,r)>0}),El=lr("<=",function(i,e,r){return e<=r},function(i,e,r,o){return o.compare(e,r)<=0}),Zn=lr(">=",function(i,e,r){return e>=r},function(i,e,r,o){return o.compare(e,r)>=0});class _o{constructor(e,r,o){this.type=Oi,this.locale=o,this.caseSensitive=e,this.diacriticSensitive=r}static parse(e,r){if(e.length!==2)return r.error("Expected one argument.");const o=e[1];if(typeof o!="object"||Array.isArray(o))return r.error("Collator options argument must be an object.");const u=r.parse(o["case-sensitive"]!==void 0&&o["case-sensitive"],1,Qt);if(!u)return null;const _=r.parse(o["diacritic-sensitive"]!==void 0&&o["diacritic-sensitive"],1,Qt);if(!_)return null;let x=null;return o.locale&&(x=r.parse(o.locale,1,pi),!x)?null:new _o(u,_,x)}evaluate(e){return new po(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}}class Bo{constructor(e,r,o,u,_){this.type=pi,this.number=e,this.locale=r,this.currency=o,this.minFractionDigits=u,this.maxFractionDigits=_}static parse(e,r){if(e.length!==3)return r.error("Expected two arguments.");const o=r.parse(e[1],1,Ct);if(!o)return null;const u=e[2];if(typeof u!="object"||Array.isArray(u))return r.error("NumberFormat options argument must be an object.");let _=null;if(u.locale&&(_=r.parse(u.locale,1,pi),!_))return null;let x=null;if(u.currency&&(x=r.parse(u.currency,1,pi),!x))return null;let S=null;if(u["min-fraction-digits"]&&(S=r.parse(u["min-fraction-digits"],1,Ct),!S))return null;let A=null;return u["max-fraction-digits"]&&(A=r.parse(u["max-fraction-digits"],1,Ct),!A)?null:new Bo(o,_,x,S,A)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}}class yo{constructor(e){this.type=$i,this.sections=e}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const o=e[1];if(!Array.isArray(o)&&typeof o=="object")return r.error("First argument must be an image or text section.");const u=[];let _=!1;for(let x=1;x<=e.length-1;++x){const S=e[x];if(_&&typeof S=="object"&&!Array.isArray(S)){_=!1;let A=null;if(S["font-scale"]&&(A=r.parse(S["font-scale"],1,Ct),!A))return null;let F=null;if(S["text-font"]&&(F=r.parse(S["text-font"],1,X(pi)),!F))return null;let R=null;if(S["text-color"]&&(R=r.parse(S["text-color"],1,qi),!R))return null;const j=u[u.length-1];j.scale=A,j.font=F,j.textColor=R}else{const A=r.parse(e[x],1,si);if(!A)return null;const F=A.type.kind;if(F!=="string"&&F!=="value"&&F!=="null"&&F!=="resolvedImage")return r.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");_=!0,u.push({content:A,scale:null,font:null,textColor:null})}}return new yo(u)}evaluate(e){return new Wi(this.sections.map(r=>{const o=r.content.evaluate(e);return ir(o)===le?new mo("",o,null,null,null):new mo(Fs(o),null,r.scale?r.scale.evaluate(e):null,r.font?r.font.evaluate(e).join(","):null,r.textColor?r.textColor.evaluate(e):null)}))}eachChild(e){for(const r of this.sections)e(r.content),r.scale&&e(r.scale),r.font&&e(r.font),r.textColor&&e(r.textColor)}outputDefined(){return!1}}class vo{constructor(e){this.type=le,this.input=e}static parse(e,r){if(e.length!==2)return r.error("Expected two arguments.");const o=r.parse(e[1],1,pi);return o?new vo(o):r.error("No image name provided.")}evaluate(e){const r=this.input.evaluate(e),o=Sr.fromString(r);return o&&e.availableImages&&(o.available=e.availableImages.indexOf(r)>-1),o}eachChild(e){e(this.input)}outputDefined(){return!1}}class Bs{constructor(e){this.type=Ct,this.input=e}static parse(e,r){if(e.length!==2)return r.error(`Expected 1 argument, but found ${e.length-1} instead.`);const o=r.parse(e[1],1);return o?o.type.kind!=="array"&&o.type.kind!=="string"&&o.type.kind!=="value"?r.error(`Expected argument of type string or array, but found ${J(o.type)} instead.`):new Bs(o):null}evaluate(e){const r=this.input.evaluate(e);if(typeof r=="string"||Array.isArray(r))return r.length;throw new vr(`Expected value to be of type string or array, but found ${J(ir(r))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}}const tn=8192;function Ni(i,e){const r=(180+i[0])/360,o=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i[1]*Math.PI/360)))/360,u=Math.pow(2,e.z);return[Math.round(r*u*tn),Math.round(o*u*tn)]}function ma(i,e){const r=Math.pow(2,e.z);return[(u=(i[0]/tn+e.x)/r,360*u-180),(o=(i[1]/tn+e.y)/r,360/Math.PI*Math.atan(Math.exp((180-360*o)*Math.PI/180))-90)];var o,u}function xo(i,e){i[0]=Math.min(i[0],e[0]),i[1]=Math.min(i[1],e[1]),i[2]=Math.max(i[2],e[0]),i[3]=Math.max(i[3],e[1])}function js(i,e){return!(i[0]<=e[0]||i[2]>=e[2]||i[1]<=e[1]||i[3]>=e[3])}function Xa(i,e,r){const o=i[0]-e[0],u=i[1]-e[1],_=i[0]-r[0],x=i[1]-r[1];return o*x-_*u==0&&o*_<=0&&u*x<=0}function bo(i,e,r,o){return(u=[o[0]-r[0],o[1]-r[1]])[0]*(_=[e[0]-i[0],e[1]-i[1]])[1]-u[1]*_[0]!=0&&!(!Dn(i,e,r,o)||!Dn(r,o,i,e));var u,_}function Pl(i,e,r){for(const o of r)for(let u=0;u<o.length-1;++u)if(bo(i,e,o[u],o[u+1]))return!0;return!1}function Ns(i,e,r=!1){let o=!1;for(const S of e)for(let A=0;A<S.length-1;A++){if(Xa(i,S[A],S[A+1]))return r;(_=S[A])[1]>(u=i)[1]!=(x=S[A+1])[1]>u[1]&&u[0]<(x[0]-_[0])*(u[1]-_[1])/(x[1]-_[1])+_[0]&&(o=!o)}var u,_,x;return o}function jo(i,e){for(const r of e)if(Ns(i,r))return!0;return!1}function No(i,e){for(const r of i)if(!Ns(r,e))return!1;for(let r=0;r<i.length-1;++r)if(Pl(i[r],i[r+1],e))return!1;return!0}function qa(i,e){for(const r of e)if(No(i,r))return!0;return!1}function Dn(i,e,r,o){const u=o[0]-r[0],_=o[1]-r[1],x=(i[0]-r[0])*_-u*(i[1]-r[1]),S=(e[0]-r[0])*_-u*(e[1]-r[1]);return x>0&&S<0||x<0&&S>0}function Vo(i,e,r){const o=[];for(let u=0;u<i.length;u++){const _=[];for(let x=0;x<i[u].length;x++){const S=Ni(i[u][x],r);xo(e,S),_.push(S)}o.push(_)}return o}function ga(i,e,r){const o=[];for(let u=0;u<i.length;u++){const _=Vo(i[u],e,r);o.push(_)}return o}function $a(i,e,r,o){if(i[0]<r[0]||i[0]>r[2]){const u=.5*o;let _=i[0]-r[0]>u?-o:r[0]-i[0]>u?o:0;_===0&&(_=i[0]-r[2]>u?-o:r[2]-i[0]>u?o:0),i[0]+=_}xo(e,i)}function _a(i,e,r,o){const u=Math.pow(2,o.z)*tn,_=[o.x*tn,o.y*tn],x=[];for(const S of i)for(const A of S){const F=[A.x+_[0],A.y+_[1]];$a(F,e,r,u),x.push(F)}return x}function wo(i,e,r,o){const u=Math.pow(2,o.z)*tn,_=[o.x*tn,o.y*tn],x=[];for(const A of i){const F=[];for(const R of A){const j=[R.x+_[0],R.y+_[1]];xo(e,j),F.push(j)}x.push(F)}if(e[2]-e[0]<=u/2){(S=e)[0]=S[1]=1/0,S[2]=S[3]=-1/0;for(const A of x)for(const F of A)$a(F,e,r,u)}var S;return x}class us{constructor(e,r){this.type=Qt,this.geojson=e,this.geometries=r}static parse(e,r){if(e.length!==2)return r.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if($r(e[1])){const o=e[1];if(o.type==="FeatureCollection"){const u=[];for(const _ of o.features){const{type:x,coordinates:S}=_.geometry;x==="Polygon"&&u.push(S),x==="MultiPolygon"&&u.push(...S)}if(u.length)return new us(o,{type:"MultiPolygon",coordinates:u})}else if(o.type==="Feature"){const u=o.geometry.type;if(u==="Polygon"||u==="MultiPolygon")return new us(o,o.geometry)}else if(o.type==="Polygon"||o.type==="MultiPolygon")return new us(o,o)}return r.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(r,o){const u=[1/0,1/0,-1/0,-1/0],_=[1/0,1/0,-1/0,-1/0],x=r.canonicalID();if(o.type==="Polygon"){const S=Vo(o.coordinates,_,x),A=_a(r.geometry(),u,_,x);if(!js(u,_))return!1;for(const F of A)if(!Ns(F,S))return!1}if(o.type==="MultiPolygon"){const S=ga(o.coordinates,_,x),A=_a(r.geometry(),u,_,x);if(!js(u,_))return!1;for(const F of A)if(!jo(F,S))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(r,o){const u=[1/0,1/0,-1/0,-1/0],_=[1/0,1/0,-1/0,-1/0],x=r.canonicalID();if(o.type==="Polygon"){const S=Vo(o.coordinates,_,x),A=wo(r.geometry(),u,_,x);if(!js(u,_))return!1;for(const F of A)if(!No(F,S))return!1}if(o.type==="MultiPolygon"){const S=ga(o.coordinates,_,x),A=wo(r.geometry(),u,_,x);if(!js(u,_))return!1;for(const F of A)if(!qa(F,S))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let ya=class{constructor(i=[],e=Il){if(this.data=i,this.length=this.data.length,this.compare=e,this.length>0)for(let r=(this.length>>1)-1;r>=0;r--)this._down(r)}push(i){this.data.push(i),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const i=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),i}peek(){return this.data[0]}_up(i){const{data:e,compare:r}=this,o=e[i];for(;i>0;){const u=i-1>>1,_=e[u];if(r(o,_)>=0)break;e[i]=_,i=u}e[i]=o}_down(i){const{data:e,compare:r}=this,o=this.length>>1,u=e[i];for(;i<o;){let _=1+(i<<1),x=e[_];const S=_+1;if(S<this.length&&r(e[S],x)<0&&(_=S,x=e[S]),r(x,u)>=0)break;e[i]=x,i=_}e[i]=u}};function Il(i,e){return i<e?-1:i>e?1:0}function Ss(i,e,r,o,u){va(i,e,r,o||i.length-1,u||Al)}function va(i,e,r,o,u){for(;o>r;){if(o-r>600){var _=o-r+1,x=e-r+1,S=Math.log(_),A=.5*Math.exp(2*S/3),F=.5*Math.sqrt(S*A*(_-A)/_)*(x-_/2<0?-1:1);va(i,e,Math.max(r,Math.floor(e-x*A/_+F)),Math.min(o,Math.floor(e+(_-x)*A/_+F)),u)}var R=i[e],j=r,W=o;for(Co(i,r,e),u(i[o],R)>0&&Co(i,r,o);j<W;){for(Co(i,j,W),j++,W--;u(i[j],R)<0;)j++;for(;u(i[W],R)>0;)W--}u(i[r],R)===0?Co(i,r,W):Co(i,++W,o),W<=e&&(r=W+1),e<=W&&(o=W-1)}}function Co(i,e,r){var o=i[e];i[e]=i[r],i[r]=o}function Al(i,e){return i<e?-1:i>e?1:0}function Vs(i,e){if(i.length<=1)return[i];const r=[];let o,u;for(const _ of i){const x=xa(_);x!==0&&(_.area=Math.abs(x),u===void 0&&(u=x<0),u===x<0?(o&&r.push(o),o=[_]):o.push(_))}if(o&&r.push(o),e>1)for(let _=0;_<r.length;_++)r[_].length<=e||(Ss(r[_],e,1,r[_].length-1,So),r[_]=r[_].slice(0,e));return r}function So(i,e){return e.area-i.area}function xa(i){let e=0;for(let r,o,u=0,_=i.length,x=_-1;u<_;x=u++)r=i[u],o=i[x],e+=(o.x-r.x)*(r.y+o.y);return e}const Uo=1/298.257223563,Go=Uo*(2-Uo),Us=Math.PI/180;class ba{constructor(e){const r=6378.137*Us*1e3,o=Math.cos(e*Us),u=1/(1-Go*(1-o*o)),_=Math.sqrt(u);this.kx=r*_*o,this.ky=r*_*u*(1-Go)}distance(e,r){const o=this.wrap(e[0]-r[0])*this.kx,u=(e[1]-r[1])*this.ky;return Math.sqrt(o*o+u*u)}pointOnLine(e,r){let o,u,_,x,S=1/0;for(let A=0;A<e.length-1;A++){let F=e[A][0],R=e[A][1],j=this.wrap(e[A+1][0]-F)*this.kx,W=(e[A+1][1]-R)*this.ky,q=0;j===0&&W===0||(q=(this.wrap(r[0]-F)*this.kx*j+(r[1]-R)*this.ky*W)/(j*j+W*W),q>1?(F=e[A+1][0],R=e[A+1][1]):q>0&&(F+=j/this.kx*q,R+=W/this.ky*q)),j=this.wrap(r[0]-F)*this.kx,W=(r[1]-R)*this.ky;const Q=j*j+W*W;Q<S&&(S=Q,o=F,u=R,_=A,x=q)}return{point:[o,u],index:_,t:Math.max(0,Math.min(1,x))}}wrap(e){for(;e<-180;)e+=360;for(;e>180;)e-=360;return e}}function Ya(i,e){return e[0]-i[0]}function Gs(i){return i[1]-i[0]+1}function Kn(i,e){return i[1]>=i[0]&&i[1]<e}function wa(i,e){if(i[0]>i[1])return[null,null];const r=Gs(i);if(e){if(r===2)return[i,null];const u=Math.floor(r/2);return[[i[0],i[0]+u],[i[0]+u,i[1]]]}if(r===1)return[i,null];const o=Math.floor(r/2)-1;return[[i[0],i[0]+o],[i[0]+o+1,i[1]]]}function Wo(i,e){if(!Kn(e,i.length))return[1/0,1/0,-1/0,-1/0];const r=[1/0,1/0,-1/0,-1/0];for(let o=e[0];o<=e[1];++o)xo(r,i[o]);return r}function To(i){const e=[1/0,1/0,-1/0,-1/0];for(const r of i)for(const o of r)xo(e,o);return e}function Ji(i){return i[0]!==-1/0&&i[1]!==-1/0&&i[2]!==1/0&&i[3]!==1/0}function Ln(i,e,r){if(!Ji(i)||!Ji(e))return NaN;let o=0,u=0;return i[2]<e[0]&&(o=e[0]-i[2]),i[0]>e[2]&&(o=i[0]-e[2]),i[1]>e[3]&&(u=i[1]-e[3]),i[3]<e[1]&&(u=e[1]-i[3]),r.distance([0,0],[o,u])}function Si(i,e,r){const o=r.pointOnLine(e,i);return r.distance(i,o.point)}function ds(i,e,r,o,u){const _=Math.min(Si(i,[r,o],u),Si(e,[r,o],u)),x=Math.min(Si(r,[i,e],u),Si(o,[i,e],u));return Math.min(_,x)}function Xi(i,e,r,o,u){if(!Kn(e,i.length)||!Kn(o,r.length))return 1/0;let _=1/0;for(let x=e[0];x<e[1];++x){const S=i[x],A=i[x+1];for(let F=o[0];F<o[1];++F){const R=r[F],j=r[F+1];if(bo(S,A,R,j))return 0;_=Math.min(_,ds(S,A,R,j,u))}}return _}function cr(i,e,r,o,u){if(!Kn(e,i.length)||!Kn(o,r.length))return NaN;let _=1/0;for(let x=e[0];x<=e[1];++x)for(let S=o[0];S<=o[1];++S)if(_=Math.min(_,u.distance(i[x],r[S])),_===0)return _;return _}function Ts(i,e,r){if(Ns(i,e,!0))return 0;let o=1/0;for(const u of e){const _=u[0],x=u[u.length-1];if(_!==x&&(o=Math.min(o,Si(i,[x,_],r)),o===0))return o;const S=r.pointOnLine(u,i);if(o=Math.min(o,r.distance(i,S.point)),o===0)return o}return o}function Ws(i,e,r,o){if(!Kn(e,i.length))return NaN;for(let _=e[0];_<=e[1];++_)if(Ns(i[_],r,!0))return 0;let u=1/0;for(let _=e[0];_<e[1];++_){const x=i[_],S=i[_+1];for(const A of r)for(let F=0,R=A.length,j=R-1;F<R;j=F++){const W=A[j],q=A[F];if(bo(x,S,W,q))return 0;u=Math.min(u,ds(x,S,W,q,o))}}return u}function Ho(i,e){for(const r of i)for(const o of r)if(Ns(o,e,!0))return!0;return!1}function Za(i,e,r,o=1/0){const u=To(i),_=To(e);if(o!==1/0&&Ln(u,_,r)>=o)return o;if(js(u,_)){if(Ho(i,e))return 0}else if(Ho(e,i))return 0;let x=1/0;for(const S of i)for(let A=0,F=S.length,R=F-1;A<F;R=A++){const j=S[R],W=S[A];for(const q of e)for(let Q=0,re=q.length,ue=re-1;Q<re;ue=Q++){const we=q[ue],Ne=q[Q];if(bo(j,W,we,Ne))return 0;x=Math.min(x,ds(j,W,we,Ne,r))}}return x}function Ka(i,e,r,o,u,_){if(!_)return;const x=Ln(Wo(o,_),u,r);x<e&&i.push([x,_,[0,0]])}function Xo(i,e,r,o,u,_,x){if(!_||!x)return;const S=Ln(Wo(o,_),Wo(u,x),r);S<e&&i.push([S,_,x])}function Eo(i,e,r,o,u=1/0){let _=Math.min(o.distance(i[0],r[0][0]),u);if(_===0)return _;const x=new ya([[0,[0,i.length-1],[0,0]]],Ya),S=To(r);for(;x.length>0;){const A=x.pop();if(A[0]>=_)continue;const F=A[1],R=e?50:100;if(Gs(F)<=R){if(!Kn(F,i.length))return NaN;if(e){const j=Ws(i,F,r,o);if(isNaN(j)||j===0)return j;_=Math.min(_,j)}else for(let j=F[0];j<=F[1];++j){const W=Ts(i[j],r,o);if(_=Math.min(_,W),_===0)return 0}}else{const j=wa(F,e);Ka(x,_,o,i,S,j[0]),Ka(x,_,o,i,S,j[1])}}return _}function Hs(i,e,r,o,u,_=1/0){let x=Math.min(_,u.distance(i[0],r[0]));if(x===0)return x;const S=new ya([[0,[0,i.length-1],[0,r.length-1]]],Ya);for(;S.length>0;){const A=S.pop();if(A[0]>=x)continue;const F=A[1],R=A[2],j=e?50:100,W=o?50:100;if(Gs(F)<=j&&Gs(R)<=W){if(!Kn(F,i.length)&&Kn(R,r.length))return NaN;let q;if(e&&o)q=Xi(i,F,r,R,u),x=Math.min(x,q);else if(e&&!o){const Q=i.slice(F[0],F[1]+1);for(let re=R[0];re<=R[1];++re)if(q=Si(r[re],Q,u),x=Math.min(x,q),x===0)return x}else if(!e&&o){const Q=r.slice(R[0],R[1]+1);for(let re=F[0];re<=F[1];++re)if(q=Si(i[re],Q,u),x=Math.min(x,q),x===0)return x}else q=cr(i,F,r,R,u),x=Math.min(x,q)}else{const q=wa(F,e),Q=wa(R,o);Xo(S,x,u,i,r,q[0],Q[0]),Xo(S,x,u,i,r,q[0],Q[1]),Xo(S,x,u,i,r,q[1],Q[0]),Xo(S,x,u,i,r,q[1],Q[1])}}return x}function Es(i){return i.type==="MultiPolygon"?i.coordinates.map(e=>({type:"Polygon",coordinates:e})):i.type==="MultiLineString"?i.coordinates.map(e=>({type:"LineString",coordinates:e})):i.type==="MultiPoint"?i.coordinates.map(e=>({type:"Point",coordinates:e})):[i]}class pn{constructor(e,r){this.type=Ct,this.geojson=e,this.geometries=r}static parse(e,r){if(e.length!==2)return r.error(`'distance' expression requires exactly one argument, but found ${e.length-1} instead.`);if($r(e[1])){const o=e[1];if(o.type==="FeatureCollection")return new pn(o,o.features.map(u=>Es(u.geometry)).flat());if(o.type==="Feature")return new pn(o,Es(o.geometry));if("type"in o&&"coordinates"in o)return new pn(o,Es(o))}return r.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(r,o){const u=r.geometry(),_=u.flat().map(A=>ma([A.x,A.y],r.canonical));if(u.length===0)return NaN;const x=new ba(_[0][1]);let S=1/0;for(const A of o){switch(A.type){case"Point":S=Math.min(S,Hs(_,!1,[A.coordinates],!1,x,S));break;case"LineString":S=Math.min(S,Hs(_,!1,A.coordinates,!0,x,S));break;case"Polygon":S=Math.min(S,Eo(_,!1,A.coordinates,x,S))}if(S===0)return S}return S}(e,this.geometries);if(e.geometryType()==="LineString")return function(r,o){const u=r.geometry(),_=u.flat().map(A=>ma([A.x,A.y],r.canonical));if(u.length===0)return NaN;const x=new ba(_[0][1]);let S=1/0;for(const A of o){switch(A.type){case"Point":S=Math.min(S,Hs(_,!0,[A.coordinates],!1,x,S));break;case"LineString":S=Math.min(S,Hs(_,!0,A.coordinates,!0,x,S));break;case"Polygon":S=Math.min(S,Eo(_,!0,A.coordinates,x,S))}if(S===0)return S}return S}(e,this.geometries);if(e.geometryType()==="Polygon")return function(r,o){const u=r.geometry();if(u.length===0||u[0].length===0)return NaN;const _=Vs(u,0).map(A=>A.map(F=>F.map(R=>ma([R.x,R.y],r.canonical)))),x=new ba(_[0][0][0][1]);let S=1/0;for(const A of o)for(const F of _){switch(A.type){case"Point":S=Math.min(S,Eo([A.coordinates],!1,F,x,S));break;case"LineString":S=Math.min(S,Eo(A.coordinates,!0,F,x,S));break;case"Polygon":S=Math.min(S,Za(F,A.coordinates,x,S))}if(S===0)return S}return S}(e,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}const Ps={"==":pa,"!=":Wa,">":Ha,"<":nr,">=":Zn,"<=":El,array:wn,at:P,boolean:wn,case:Pe,coalesce:ii,collator:_o,format:yo,image:vo,in:z,"index-of":Z,interpolate:ji,"interpolate-hcl":ji,"interpolate-lab":ji,length:Bs,let:Ro,literal:ws,match:_e,number:wn,"number-format":Bo,object:wn,slice:Me,step:bt,string:wn,"to-boolean":On,"to-color":On,"to-number":On,"to-string":On,var:Yn,within:us,distance:pn};class Tr{constructor(e,r,o,u){this.name=e,this.type=r,this._evaluate=o,this.args=u}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}static parse(e,r){const o=e[0],u=Tr.definitions[o];if(!u)return r.error(`Unknown expression "${o}". If you wanted a literal array, use ["literal", [...]].`,0);const _=Array.isArray(u)?u[0]:u.type,x=Array.isArray(u)?[[u[1],u[2]]]:u.overloads,S=x.filter(([F])=>!Array.isArray(F)||F.length===e.length-1);let A=null;for(const[F,R]of S){A=new Bi(r.registry,As,r.path,null,r.scope);const j=[];let W=!1;for(let q=1;q<e.length;q++){const Q=e[q],re=Array.isArray(F)?F[q-1]:F.type,ue=A.parse(Q,1+j.length,re);if(!ue){W=!0;break}j.push(ue)}if(!W)if(Array.isArray(F)&&F.length!==j.length)A.error(`Expected ${F.length} arguments, but found ${j.length} instead.`);else{for(let q=0;q<j.length;q++){const Q=Array.isArray(F)?F[q]:F.type,re=j[q];A.concat(q+1).checkSubtype(Q,re.type)}if(A.errors.length===0)return new Tr(o,_,R,j)}}if(S.length===1)r.errors.push(...A.errors);else{const F=(S.length?S:x).map(([j])=>{return W=j,Array.isArray(W)?`(${W.map(J).join(", ")})`:`(${J(W.type)}...)`;var W}).join(" | "),R=[];for(let j=1;j<e.length;j++){const W=r.parse(e[j],1+R.length);if(!W)return null;R.push(J(W.type))}r.error(`Expected arguments of type ${F}, but found (${R.join(", ")}) instead.`)}return null}static register(e,r){Tr.definitions=r;for(const o in r)e[o]=Tr}}function Ja(i,[e,r,o,u]){e=e.evaluate(i),r=r.evaluate(i),o=o.evaluate(i);const _=u?u.evaluate(i):1,x=go(e,r,o,_);if(x)throw new vr(x);return new zi(e/255,r/255,o/255,_,!1)}function fs(i,e){return i in e}function qo(i,e){const r=e[i];return r===void 0?null:r}function Is(i){return{type:i}}function As(i){if(i instanceof Yn)return As(i.boundExpression);if(i instanceof Tr&&i.name==="error"||i instanceof _o||i instanceof us||i instanceof pn)return!1;const e=i instanceof On||i instanceof wn;let r=!0;return i.eachChild(o=>{r=e?r&&As(o):r&&o instanceof ws}),!!r&&Xs(i)&&Po(i,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function Xs(i){if(i instanceof Tr&&(i.name==="get"&&i.args.length===1||i.name==="feature-state"||i.name==="has"&&i.args.length===1||i.name==="properties"||i.name==="geometry-type"||i.name==="id"||/^filter-/.test(i.name))||i instanceof us||i instanceof pn)return!1;let e=!0;return i.eachChild(r=>{e&&!Xs(r)&&(e=!1)}),e}function qs(i){if(i instanceof Tr&&i.name==="feature-state")return!1;let e=!0;return i.eachChild(r=>{e&&!qs(r)&&(e=!1)}),e}function Po(i,e){if(i instanceof Tr&&e.indexOf(i.name)>=0)return!1;let r=!0;return i.eachChild(o=>{r&&!Po(o,e)&&(r=!1)}),r}function $o(i){return{result:"success",value:i}}function Fn(i){return{result:"error",value:i}}function Un(i){return i["property-type"]==="data-driven"||i["property-type"]==="cross-faded-data-driven"}function Qa(i){return!!i.expression&&i.expression.parameters.indexOf("zoom")>-1}function je(i){return!!i.expression&&i.expression.interpolated}function qe(i){return i instanceof Number?"number":i instanceof String?"string":i instanceof Boolean?"boolean":Array.isArray(i)?"array":i===null?"null":typeof i}function Ft(i){return typeof i=="object"&&i!==null&&!Array.isArray(i)}function ci(i){return i}function Yi(i,e){const r=e.type==="color",o=i.stops&&typeof i.stops[0][0]=="object",u=o||!(o||i.property!==void 0),_=i.type||(je(e)?"exponential":"interval");if(r||e.type==="padding"){const R=r?zi.parse:qr.parse;(i=Ei({},i)).stops&&(i.stops=i.stops.map(j=>[j[0],R(j[1])])),i.default=R(i.default?i.default:e.default)}if(i.colorSpace&&(x=i.colorSpace)!=="rgb"&&x!=="hcl"&&x!=="lab")throw new Error(`Unknown color space: "${i.colorSpace}"`);var x;let S,A,F;if(_==="exponential")S=mn;else if(_==="interval")S=Er;else if(_==="categorical"){S=fr,A=Object.create(null);for(const R of i.stops)A[R[0]]=R[1];F=typeof i.stops[0][0]}else{if(_!=="identity")throw new Error(`Unknown function type "${_}"`);S=xr}if(o){const R={},j=[];for(let Q=0;Q<i.stops.length;Q++){const re=i.stops[Q],ue=re[0].zoom;R[ue]===void 0&&(R[ue]={zoom:ue,type:i.type,property:i.property,default:i.default,stops:[]},j.push(ue)),R[ue].stops.push([re[0].value,re[1]])}const W=[];for(const Q of j)W.push([R[Q].zoom,Yi(R[Q],e)]);const q={name:"linear"};return{kind:"composite",interpolationType:q,interpolationFactor:ji.interpolationFactor.bind(void 0,q),zoomStops:W.map(Q=>Q[0]),evaluate:({zoom:Q},re)=>mn({stops:W,base:i.base},e,Q).evaluate(Q,re)}}if(u){const R=_==="exponential"?{name:"exponential",base:i.base!==void 0?i.base:1}:null;return{kind:"camera",interpolationType:R,interpolationFactor:ji.interpolationFactor.bind(void 0,R),zoomStops:i.stops.map(j=>j[0]),evaluate:({zoom:j})=>S(i,e,j,A,F)}}return{kind:"source",evaluate(R,j){const W=j&&j.properties?j.properties[i.property]:void 0;return W===void 0?ki(i.default,e.default):S(i,e,W,A,F)}}}function ki(i,e,r){return i!==void 0?i:e!==void 0?e:r!==void 0?r:void 0}function fr(i,e,r,o,u){return ki(typeof r===u?o[r]:void 0,i.default,e.default)}function Er(i,e,r){if(qe(r)!=="number")return ki(i.default,e.default);const o=i.stops.length;if(o===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[o-1][0])return i.stops[o-1][1];const u=Be(i.stops.map(_=>_[0]),r);return i.stops[u][1]}function mn(i,e,r){const o=i.base!==void 0?i.base:1;if(qe(r)!=="number")return ki(i.default,e.default);const u=i.stops.length;if(u===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[u-1][0])return i.stops[u-1][1];const _=Be(i.stops.map(R=>R[0]),r),x=function(R,j,W,q){const Q=q-W,re=R-W;return Q===0?0:j===1?re/Q:(Math.pow(j,re)-1)/(Math.pow(j,Q)-1)}(r,o,i.stops[_][0],i.stops[_+1][0]),S=i.stops[_][1],A=i.stops[_+1][1],F=fi[e.type]||ci;return typeof S.evaluate=="function"?{evaluate(...R){const j=S.evaluate.apply(void 0,R),W=A.evaluate.apply(void 0,R);if(j!==void 0&&W!==void 0)return F(j,W,x,i.colorSpace)}}:F(S,A,x,i.colorSpace)}function xr(i,e,r){switch(e.type){case"color":r=zi.parse(r);break;case"formatted":r=Wi.fromString(r.toString());break;case"resolvedImage":r=Sr.fromString(r.toString());break;case"padding":r=qr.parse(r);break;default:qe(r)===e.type||e.type==="enum"&&e.values[r]||(r=void 0)}return ki(r,i.default,e.default)}Tr.register(Ps,{error:[{kind:"error"},[pi],(i,[e])=>{throw new vr(e.evaluate(i))}],typeof:[pi,[si],(i,[e])=>J(ir(e.evaluate(i)))],"to-rgba":[X(Ct,4),[qi],(i,[e])=>{const[r,o,u,_]=e.evaluate(i).rgb;return[255*r,255*o,255*u,_]}],rgb:[qi,[Ct,Ct,Ct],Ja],rgba:[qi,[Ct,Ct,Ct,Ct],Ja],has:{type:Qt,overloads:[[[pi],(i,[e])=>fs(e.evaluate(i),i.properties())],[[pi,ar],(i,[e,r])=>fs(e.evaluate(i),r.evaluate(i))]]},get:{type:si,overloads:[[[pi],(i,[e])=>qo(e.evaluate(i),i.properties())],[[pi,ar],(i,[e,r])=>qo(e.evaluate(i),r.evaluate(i))]]},"feature-state":[si,[pi],(i,[e])=>qo(e.evaluate(i),i.featureState||{})],properties:[ar,[],i=>i.properties()],"geometry-type":[pi,[],i=>i.geometryType()],id:[si,[],i=>i.id()],zoom:[Ct,[],i=>i.globals.zoom],"heatmap-density":[Ct,[],i=>i.globals.heatmapDensity||0],"line-progress":[Ct,[],i=>i.globals.lineProgress||0],accumulated:[si,[],i=>i.globals.accumulated===void 0?null:i.globals.accumulated],"+":[Ct,Is(Ct),(i,e)=>{let r=0;for(const o of e)r+=o.evaluate(i);return r}],"*":[Ct,Is(Ct),(i,e)=>{let r=1;for(const o of e)r*=o.evaluate(i);return r}],"-":{type:Ct,overloads:[[[Ct,Ct],(i,[e,r])=>e.evaluate(i)-r.evaluate(i)],[[Ct],(i,[e])=>-e.evaluate(i)]]},"/":[Ct,[Ct,Ct],(i,[e,r])=>e.evaluate(i)/r.evaluate(i)],"%":[Ct,[Ct,Ct],(i,[e,r])=>e.evaluate(i)%r.evaluate(i)],ln2:[Ct,[],()=>Math.LN2],pi:[Ct,[],()=>Math.PI],e:[Ct,[],()=>Math.E],"^":[Ct,[Ct,Ct],(i,[e,r])=>Math.pow(e.evaluate(i),r.evaluate(i))],sqrt:[Ct,[Ct],(i,[e])=>Math.sqrt(e.evaluate(i))],log10:[Ct,[Ct],(i,[e])=>Math.log(e.evaluate(i))/Math.LN10],ln:[Ct,[Ct],(i,[e])=>Math.log(e.evaluate(i))],log2:[Ct,[Ct],(i,[e])=>Math.log(e.evaluate(i))/Math.LN2],sin:[Ct,[Ct],(i,[e])=>Math.sin(e.evaluate(i))],cos:[Ct,[Ct],(i,[e])=>Math.cos(e.evaluate(i))],tan:[Ct,[Ct],(i,[e])=>Math.tan(e.evaluate(i))],asin:[Ct,[Ct],(i,[e])=>Math.asin(e.evaluate(i))],acos:[Ct,[Ct],(i,[e])=>Math.acos(e.evaluate(i))],atan:[Ct,[Ct],(i,[e])=>Math.atan(e.evaluate(i))],min:[Ct,Is(Ct),(i,e)=>Math.min(...e.map(r=>r.evaluate(i)))],max:[Ct,Is(Ct),(i,e)=>Math.max(...e.map(r=>r.evaluate(i)))],abs:[Ct,[Ct],(i,[e])=>Math.abs(e.evaluate(i))],round:[Ct,[Ct],(i,[e])=>{const r=e.evaluate(i);return r<0?-Math.round(-r):Math.round(r)}],floor:[Ct,[Ct],(i,[e])=>Math.floor(e.evaluate(i))],ceil:[Ct,[Ct],(i,[e])=>Math.ceil(e.evaluate(i))],"filter-==":[Qt,[pi,si],(i,[e,r])=>i.properties()[e.value]===r.value],"filter-id-==":[Qt,[si],(i,[e])=>i.id()===e.value],"filter-type-==":[Qt,[pi],(i,[e])=>i.geometryType()===e.value],"filter-<":[Qt,[pi,si],(i,[e,r])=>{const o=i.properties()[e.value],u=r.value;return typeof o==typeof u&&o<u}],"filter-id-<":[Qt,[si],(i,[e])=>{const r=i.id(),o=e.value;return typeof r==typeof o&&r<o}],"filter->":[Qt,[pi,si],(i,[e,r])=>{const o=i.properties()[e.value],u=r.value;return typeof o==typeof u&&o>u}],"filter-id->":[Qt,[si],(i,[e])=>{const r=i.id(),o=e.value;return typeof r==typeof o&&r>o}],"filter-<=":[Qt,[pi,si],(i,[e,r])=>{const o=i.properties()[e.value],u=r.value;return typeof o==typeof u&&o<=u}],"filter-id-<=":[Qt,[si],(i,[e])=>{const r=i.id(),o=e.value;return typeof r==typeof o&&r<=o}],"filter->=":[Qt,[pi,si],(i,[e,r])=>{const o=i.properties()[e.value],u=r.value;return typeof o==typeof u&&o>=u}],"filter-id->=":[Qt,[si],(i,[e])=>{const r=i.id(),o=e.value;return typeof r==typeof o&&r>=o}],"filter-has":[Qt,[si],(i,[e])=>e.value in i.properties()],"filter-has-id":[Qt,[],i=>i.id()!==null&&i.id()!==void 0],"filter-type-in":[Qt,[X(pi)],(i,[e])=>e.value.indexOf(i.geometryType())>=0],"filter-id-in":[Qt,[X(si)],(i,[e])=>e.value.indexOf(i.id())>=0],"filter-in-small":[Qt,[pi,X(si)],(i,[e,r])=>r.value.indexOf(i.properties()[e.value])>=0],"filter-in-large":[Qt,[pi,X(si)],(i,[e,r])=>function(o,u,_,x){for(;_<=x;){const S=_+x>>1;if(u[S]===o)return!0;u[S]>o?x=S-1:_=S+1}return!1}(i.properties()[e.value],r.value,0,r.value.length-1)],all:{type:Qt,overloads:[[[Qt,Qt],(i,[e,r])=>e.evaluate(i)&&r.evaluate(i)],[Is(Qt),(i,e)=>{for(const r of e)if(!r.evaluate(i))return!1;return!0}]]},any:{type:Qt,overloads:[[[Qt,Qt],(i,[e,r])=>e.evaluate(i)||r.evaluate(i)],[Is(Qt),(i,e)=>{for(const r of e)if(r.evaluate(i))return!0;return!1}]]},"!":[Qt,[Qt],(i,[e])=>!e.evaluate(i)],"is-supported-script":[Qt,[pi],(i,[e])=>{const r=i.globals&&i.globals.isSupportedScript;return!r||r(e.evaluate(i))}],upcase:[pi,[pi],(i,[e])=>e.evaluate(i).toUpperCase()],downcase:[pi,[pi],(i,[e])=>e.evaluate(i).toLowerCase()],concat:[pi,Is(si),(i,e)=>e.map(r=>Fs(r.evaluate(i))).join("")],"resolved-locale":[pi,[Oi],(i,[e])=>e.evaluate(i).resolvedLocale()]});class Pr{constructor(e,r){var o;this.expression=e,this._warningHistory={},this._evaluator=new Rs,this._defaultValue=r?(o=r).type==="color"&&Ft(o.default)?new zi(0,0,0,0):o.type==="color"?zi.parse(o.default)||null:o.type==="padding"?qr.parse(o.default)||null:o.type==="variableAnchorOffsetCollection"?Cr.parse(o.default)||null:o.default===void 0?null:o.default:null,this._enumValues=r&&r.type==="enum"?r.values:null}evaluateWithoutErrorHandling(e,r,o,u,_,x){return this._evaluator.globals=e,this._evaluator.feature=r,this._evaluator.featureState=o,this._evaluator.canonical=u,this._evaluator.availableImages=_||null,this._evaluator.formattedSection=x,this.expression.evaluate(this._evaluator)}evaluate(e,r,o,u,_,x){this._evaluator.globals=e,this._evaluator.feature=r||null,this._evaluator.featureState=o||null,this._evaluator.canonical=u,this._evaluator.availableImages=_||null,this._evaluator.formattedSection=x||null;try{const S=this.expression.evaluate(this._evaluator);if(S==null||typeof S=="number"&&S!=S)return this._defaultValue;if(this._enumValues&&!(S in this._enumValues))throw new vr(`Expected value to be one of ${Object.keys(this._enumValues).map(A=>JSON.stringify(A)).join(", ")}, but found ${JSON.stringify(S)} instead.`);return S}catch(S){return this._warningHistory[S.message]||(this._warningHistory[S.message]=!0,typeof console<"u"&&console.warn(S.message)),this._defaultValue}}}function gn(i){return Array.isArray(i)&&i.length>0&&typeof i[0]=="string"&&i[0]in Ps}function Cn(i,e){const r=new Bi(Ps,As,[],e?function(u){const _={color:qi,string:pi,number:Ct,enum:pi,boolean:Qt,formatted:$i,padding:Ki,resolvedImage:le,variableAnchorOffsetCollection:H};return u.type==="array"?X(_[u.value]||si,u.length):_[u.type]}(e):void 0),o=r.parse(i,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return o?$o(new Pr(o,e)):Fn(r.errors)}class Nr{constructor(e,r){this.kind=e,this._styleExpression=r,this.isStateDependent=e!=="constant"&&!qs(r.expression)}evaluateWithoutErrorHandling(e,r,o,u,_,x){return this._styleExpression.evaluateWithoutErrorHandling(e,r,o,u,_,x)}evaluate(e,r,o,u,_,x){return this._styleExpression.evaluate(e,r,o,u,_,x)}}class zn{constructor(e,r,o,u){this.kind=e,this.zoomStops=o,this._styleExpression=r,this.isStateDependent=e!=="camera"&&!qs(r.expression),this.interpolationType=u}evaluateWithoutErrorHandling(e,r,o,u,_,x){return this._styleExpression.evaluateWithoutErrorHandling(e,r,o,u,_,x)}evaluate(e,r,o,u,_,x){return this._styleExpression.evaluate(e,r,o,u,_,x)}interpolationFactor(e,r,o){return this.interpolationType?ji.interpolationFactor(this.interpolationType,e,r,o):0}}function Gn(i,e){const r=Cn(i,e);if(r.result==="error")return r;const o=r.value.expression,u=Xs(o);if(!u&&!Un(e))return Fn([new Fi("","data expressions not supported")]);const _=Po(o,["zoom"]);if(!_&&!Qa(e))return Fn([new Fi("","zoom expressions not supported")]);const x=Ir(o);return x||_?x instanceof Fi?Fn([x]):x instanceof ji&&!je(e)?Fn([new Fi("",'"interpolate" expressions cannot be used with this property')]):$o(x?new zn(u?"camera":"composite",r.value,x.labels,x instanceof ji?x.interpolation:void 0):new Nr(u?"constant":"source",r.value)):Fn([new Fi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Wn{constructor(e,r){this._parameters=e,this._specification=r,Ei(this,Yi(this._parameters,this._specification))}static deserialize(e){return new Wn(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Ir(i){let e=null;if(i instanceof Ro)e=Ir(i.result);else if(i instanceof ii){for(const r of i.args)if(e=Ir(r),e)break}else(i instanceof bt||i instanceof ji)&&i.input instanceof Tr&&i.input.name==="zoom"&&(e=i);return e instanceof Fi||i.eachChild(r=>{const o=Ir(r);o instanceof Fi?e=o:!e&&o?e=new Fi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&o&&e!==o&&(e=new Fi("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}function Rn(i){if(i===!0||i===!1)return!0;if(!Array.isArray(i)||i.length===0)return!1;switch(i[0]){case"has":return i.length>=2&&i[1]!=="$id"&&i[1]!=="$type";case"in":return i.length>=3&&(typeof i[1]!="string"||Array.isArray(i[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return i.length!==3||Array.isArray(i[1])||Array.isArray(i[2]);case"any":case"all":for(const e of i.slice(1))if(!Rn(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}const Ca={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function Sa(i){if(i==null)return{filter:()=>!0,needGeometry:!1};Rn(i)||(i=Ri(i));const e=Cn(i,Ca);if(e.result==="error")throw new Error(e.value.map(r=>`${r.key}: ${r.message}`).join(", "));return{filter:(r,o,u)=>e.value.evaluate(r,o,{},u),needGeometry:Vi(i)}}function Ml(i,e){return i<e?-1:i>e?1:0}function Vi(i){if(!Array.isArray(i))return!1;if(i[0]==="within"||i[0]==="distance")return!0;for(let e=1;e<i.length;e++)if(Vi(i[e]))return!0;return!1}function Ri(i){if(!i)return!0;const e=i[0];return i.length<=1?e!=="any":e==="=="?ps(i[1],i[2],"=="):e==="!="?Yr(ps(i[1],i[2],"==")):e==="<"||e===">"||e==="<="||e===">="?ps(i[1],i[2],e):e==="any"?(r=i.slice(1),["any"].concat(r.map(Ri))):e==="all"?["all"].concat(i.slice(1).map(Ri)):e==="none"?["all"].concat(i.slice(1).map(Ri).map(Yr)):e==="in"?Jn(i[1],i.slice(2)):e==="!in"?Yr(Jn(i[1],i.slice(2))):e==="has"?$s(i[1]):e!=="!has"||Yr($s(i[1]));var r}function ps(i,e,r){switch(i){case"$type":return[`filter-type-${r}`,e];case"$id":return[`filter-id-${r}`,e];default:return[`filter-${r}`,i,e]}}function Jn(i,e){if(e.length===0)return!1;switch(i){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(r=>typeof r!=typeof e[0])?["filter-in-large",i,["literal",e.sort(Ml)]]:["filter-in-small",i,["literal",e]]}}function $s(i){switch(i){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",i]}}function Yr(i){return["!",i]}function Zr(i){const e=typeof i;if(e==="number"||e==="boolean"||e==="string"||i==null)return JSON.stringify(i);if(Array.isArray(i)){let u="[";for(const _ of i)u+=`${Zr(_)},`;return`${u}]`}const r=Object.keys(i).sort();let o="{";for(let u=0;u<r.length;u++)o+=`${JSON.stringify(r[u])}:${Zr(i[r[u]])},`;return`${o}}`}function ms(i){let e="";for(const r of Ze)e+=`/${Zr(i[r])}`;return e}function gs(i){const e=i.value;return e?[new ct(i.key,e,"constants have been deprecated as of v8")]:[]}function sr(i){return i instanceof Number||i instanceof String||i instanceof Boolean?i.valueOf():i}function rn(i){if(Array.isArray(i))return i.map(rn);if(i instanceof Object&&!(i instanceof Number||i instanceof String||i instanceof Boolean)){const e={};for(const r in i)e[r]=rn(i[r]);return e}return sr(i)}function zr(i){const e=i.key,r=i.value,o=i.valueSpec||{},u=i.objectElementValidators||{},_=i.style,x=i.styleSpec,S=i.validateSpec;let A=[];const F=qe(r);if(F!=="object")return[new ct(e,r,`object expected, ${F} found`)];for(const R in r){const j=R.split(".")[0],W=o[j]||o["*"];let q;if(u[j])q=u[j];else if(o[j])q=S;else if(u["*"])q=u["*"];else{if(!o["*"]){A.push(new ct(e,r[R],`unknown property "${R}"`));continue}q=S}A=A.concat(q({key:(e&&`${e}.`)+R,value:r[R],valueSpec:W,style:_,styleSpec:x,object:r,objectKey:R,validateSpec:S},r))}for(const R in o)u[R]||o[R].required&&o[R].default===void 0&&r[R]===void 0&&A.push(new ct(e,r,`missing required property "${R}"`));return A}function Io(i){const e=i.value,r=i.valueSpec,o=i.style,u=i.styleSpec,_=i.key,x=i.arrayElementValidator||i.validateSpec;if(qe(e)!=="array")return[new ct(_,e,`array expected, ${qe(e)} found`)];if(r.length&&e.length!==r.length)return[new ct(_,e,`array length ${r.length} expected, length ${e.length} found`)];if(r["min-length"]&&e.length<r["min-length"])return[new ct(_,e,`array length at least ${r["min-length"]} expected, length ${e.length} found`)];let S={type:r.value,values:r.values};u.$version<7&&(S.function=r.function),qe(r.value)==="object"&&(S=r.value);let A=[];for(let F=0;F<e.length;F++)A=A.concat(x({array:e,arrayIndex:F,value:e[F],valueSpec:S,validateSpec:i.validateSpec,style:o,styleSpec:u,key:`${_}[${F}]`}));return A}function Ys(i){const e=i.key,r=i.value,o=i.valueSpec;let u=qe(r);return u==="number"&&r!=r&&(u="NaN"),u!=="number"?[new ct(e,r,`number expected, ${u} found`)]:"minimum"in o&&r<o.minimum?[new ct(e,r,`${r} is less than the minimum value ${o.minimum}`)]:"maximum"in o&&r>o.maximum?[new ct(e,r,`${r} is greater than the maximum value ${o.maximum}`)]:[]}function Zs(i){const e=i.valueSpec,r=sr(i.value.type);let o,u,_,x={};const S=r!=="categorical"&&i.value.property===void 0,A=!S,F=qe(i.value.stops)==="array"&&qe(i.value.stops[0])==="array"&&qe(i.value.stops[0][0])==="object",R=zr({key:i.key,value:i.value,valueSpec:i.styleSpec.function,validateSpec:i.validateSpec,style:i.style,styleSpec:i.styleSpec,objectElementValidators:{stops:function(q){if(r==="identity")return[new ct(q.key,q.value,'identity function may not have a "stops" property')];let Q=[];const re=q.value;return Q=Q.concat(Io({key:q.key,value:re,valueSpec:q.valueSpec,validateSpec:q.validateSpec,style:q.style,styleSpec:q.styleSpec,arrayElementValidator:j})),qe(re)==="array"&&re.length===0&&Q.push(new ct(q.key,re,"array must have at least one stop")),Q},default:function(q){return q.validateSpec({key:q.key,value:q.value,valueSpec:e,validateSpec:q.validateSpec,style:q.style,styleSpec:q.styleSpec})}}});return r==="identity"&&S&&R.push(new ct(i.key,i.value,'missing required property "property"')),r==="identity"||i.value.stops||R.push(new ct(i.key,i.value,'missing required property "stops"')),r==="exponential"&&i.valueSpec.expression&&!je(i.valueSpec)&&R.push(new ct(i.key,i.value,"exponential functions not supported")),i.styleSpec.$version>=8&&(A&&!Un(i.valueSpec)?R.push(new ct(i.key,i.value,"property functions not supported")):S&&!Qa(i.valueSpec)&&R.push(new ct(i.key,i.value,"zoom functions not supported"))),r!=="categorical"&&!F||i.value.property!==void 0||R.push(new ct(i.key,i.value,'"property" property is required')),R;function j(q){let Q=[];const re=q.value,ue=q.key;if(qe(re)!=="array")return[new ct(ue,re,`array expected, ${qe(re)} found`)];if(re.length!==2)return[new ct(ue,re,`array length 2 expected, length ${re.length} found`)];if(F){if(qe(re[0])!=="object")return[new ct(ue,re,`object expected, ${qe(re[0])} found`)];if(re[0].zoom===void 0)return[new ct(ue,re,"object stop key must have zoom")];if(re[0].value===void 0)return[new ct(ue,re,"object stop key must have value")];if(_&&_>sr(re[0].zoom))return[new ct(ue,re[0].zoom,"stop zoom values must appear in ascending order")];sr(re[0].zoom)!==_&&(_=sr(re[0].zoom),u=void 0,x={}),Q=Q.concat(zr({key:`${ue}[0]`,value:re[0],valueSpec:{zoom:{}},validateSpec:q.validateSpec,style:q.style,styleSpec:q.styleSpec,objectElementValidators:{zoom:Ys,value:W}}))}else Q=Q.concat(W({key:`${ue}[0]`,value:re[0],valueSpec:{},validateSpec:q.validateSpec,style:q.style,styleSpec:q.styleSpec},re));return gn(rn(re[1]))?Q.concat([new ct(`${ue}[1]`,re[1],"expressions are not allowed in function stops.")]):Q.concat(q.validateSpec({key:`${ue}[1]`,value:re[1],valueSpec:e,validateSpec:q.validateSpec,style:q.style,styleSpec:q.styleSpec}))}function W(q,Q){const re=qe(q.value),ue=sr(q.value),we=q.value!==null?q.value:Q;if(o){if(re!==o)return[new ct(q.key,we,`${re} stop domain type must match previous stop domain type ${o}`)]}else o=re;if(re!=="number"&&re!=="string"&&re!=="boolean")return[new ct(q.key,we,"stop domain value must be a number, string, or boolean")];if(re!=="number"&&r!=="categorical"){let Ne=`number expected, ${re} found`;return Un(e)&&r===void 0&&(Ne+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new ct(q.key,we,Ne)]}return r!=="categorical"||re!=="number"||isFinite(ue)&&Math.floor(ue)===ue?r!=="categorical"&&re==="number"&&u!==void 0&&ue<u?[new ct(q.key,we,"stop domain values must appear in ascending order")]:(u=ue,r==="categorical"&&ue in x?[new ct(q.key,we,"stop domain values must be unique")]:(x[ue]=!0,[])):[new ct(q.key,we,`integer expected, found ${ue}`)]}}function Sn(i){const e=(i.expressionContext==="property"?Gn:Cn)(rn(i.value),i.valueSpec);if(e.result==="error")return e.value.map(o=>new ct(`${i.key}${o.key}`,i.value,o.message));const r=e.value.expression||e.value._styleExpression.expression;if(i.expressionContext==="property"&&i.propertyKey==="text-font"&&!r.outputDefined())return[new ct(i.key,i.value,`Invalid data expression for "${i.propertyKey}". Output values must be contained as literals within the expression.`)];if(i.expressionContext==="property"&&i.propertyType==="layout"&&!qs(r))return[new ct(i.key,i.value,'"feature-state" data expressions are not supported with layout properties.')];if(i.expressionContext==="filter"&&!qs(r))return[new ct(i.key,i.value,'"feature-state" data expressions are not supported with filters.')];if(i.expressionContext&&i.expressionContext.indexOf("cluster")===0){if(!Po(r,["zoom","feature-state"]))return[new ct(i.key,i.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(i.expressionContext==="cluster-initial"&&!Xs(r))return[new ct(i.key,i.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Qn(i){const e=i.key,r=i.value,o=i.valueSpec,u=[];return Array.isArray(o.values)?o.values.indexOf(sr(r))===-1&&u.push(new ct(e,r,`expected one of [${o.values.join(", ")}], ${JSON.stringify(r)} found`)):Object.keys(o.values).indexOf(sr(r))===-1&&u.push(new ct(e,r,`expected one of [${Object.keys(o.values).join(", ")}], ${JSON.stringify(r)} found`)),u}function Ao(i){return Rn(rn(i.value))?Sn(Ei({},i,{expressionContext:"filter",valueSpec:{value:"boolean"}})):Ks(i)}function Ks(i){const e=i.value,r=i.key;if(qe(e)!=="array")return[new ct(r,e,`array expected, ${qe(e)} found`)];const o=i.styleSpec;let u,_=[];if(e.length<1)return[new ct(r,e,"filter array must have at least 1 element")];switch(_=_.concat(Qn({key:`${r}[0]`,value:e[0],valueSpec:o.filter_operator,style:i.style,styleSpec:i.styleSpec})),sr(e[0])){case"<":case"<=":case">":case">=":e.length>=2&&sr(e[1])==="$type"&&_.push(new ct(r,e,`"$type" cannot be use with operator "${e[0]}"`));case"==":case"!=":e.length!==3&&_.push(new ct(r,e,`filter array for operator "${e[0]}" must have 3 elements`));case"in":case"!in":e.length>=2&&(u=qe(e[1]),u!=="string"&&_.push(new ct(`${r}[1]`,e[1],`string expected, ${u} found`)));for(let x=2;x<e.length;x++)u=qe(e[x]),sr(e[1])==="$type"?_=_.concat(Qn({key:`${r}[${x}]`,value:e[x],valueSpec:o.geometry_type,style:i.style,styleSpec:i.styleSpec})):u!=="string"&&u!=="number"&&u!=="boolean"&&_.push(new ct(`${r}[${x}]`,e[x],`string, number, or boolean expected, ${u} found`));break;case"any":case"all":case"none":for(let x=1;x<e.length;x++)_=_.concat(Ks({key:`${r}[${x}]`,value:e[x],style:i.style,styleSpec:i.styleSpec}));break;case"has":case"!has":u=qe(e[1]),e.length!==2?_.push(new ct(r,e,`filter array for "${e[0]}" operator must have 2 elements`)):u!=="string"&&_.push(new ct(`${r}[1]`,e[1],`string expected, ${u} found`))}return _}function Js(i,e){const r=i.key,o=i.validateSpec,u=i.style,_=i.styleSpec,x=i.value,S=i.objectKey,A=_[`${e}_${i.layerType}`];if(!A)return[];const F=S.match(/^(.*)-transition$/);if(e==="paint"&&F&&A[F[1]]&&A[F[1]].transition)return o({key:r,value:x,valueSpec:_.transition,style:u,styleSpec:_});const R=i.valueSpec||A[S];if(!R)return[new ct(r,x,`unknown property "${S}"`)];let j;if(qe(x)==="string"&&Un(R)&&!R.tokens&&(j=/^{([^}]+)}$/.exec(x)))return[new ct(r,x,`"${S}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(j[1])} }\`.`)];const W=[];return i.layerType==="symbol"&&(S==="text-field"&&u&&!u.glyphs&&W.push(new ct(r,x,'use of "text-field" requires a style "glyphs" property')),S==="text-font"&&Ft(rn(x))&&sr(x.type)==="identity"&&W.push(new ct(r,x,'"text-font" does not support identity functions'))),W.concat(o({key:i.key,value:x,valueSpec:R,style:u,styleSpec:_,expressionContext:"property",propertyType:e,propertyKey:S}))}function el(i){return Js(i,"paint")}function kl(i){return Js(i,"layout")}function dc(i){let e=[];const r=i.value,o=i.key,u=i.style,_=i.styleSpec;r.type||r.ref||e.push(new ct(o,r,'either "type" or "ref" is required'));let x=sr(r.type);const S=sr(r.ref);if(r.id){const A=sr(r.id);for(let F=0;F<i.arrayIndex;F++){const R=u.layers[F];sr(R.id)===A&&e.push(new ct(o,r.id,`duplicate layer id "${r.id}", previously used at line ${R.id.__line__}`))}}if("ref"in r){let A;["type","source","source-layer","filter","layout"].forEach(F=>{F in r&&e.push(new ct(o,r[F],`"${F}" is prohibited for ref layers`))}),u.layers.forEach(F=>{sr(F.id)===S&&(A=F)}),A?A.ref?e.push(new ct(o,r.ref,"ref cannot reference another ref layer")):x=sr(A.type):e.push(new ct(o,r.ref,`ref layer "${S}" not found`))}else if(x!=="background")if(r.source){const A=u.sources&&u.sources[r.source],F=A&&sr(A.type);A?F==="vector"&&x==="raster"?e.push(new ct(o,r.source,`layer "${r.id}" requires a raster source`)):F!=="raster-dem"&&x==="hillshade"?e.push(new ct(o,r.source,`layer "${r.id}" requires a raster-dem source`)):F==="raster"&&x!=="raster"?e.push(new ct(o,r.source,`layer "${r.id}" requires a vector source`)):F!=="vector"||r["source-layer"]?F==="raster-dem"&&x!=="hillshade"?e.push(new ct(o,r.source,"raster-dem source can only be used with layer type 'hillshade'.")):x!=="line"||!r.paint||!r.paint["line-gradient"]||F==="geojson"&&A.lineMetrics||e.push(new ct(o,r,`layer "${r.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):e.push(new ct(o,r,`layer "${r.id}" must specify a "source-layer"`)):e.push(new ct(o,r.source,`source "${r.source}" not found`))}else e.push(new ct(o,r,'missing required property "source"'));return e=e.concat(zr({key:o,value:r,valueSpec:_.layer,style:i.style,styleSpec:i.styleSpec,validateSpec:i.validateSpec,objectElementValidators:{"*":()=>[],type:()=>i.validateSpec({key:`${o}.type`,value:r.type,valueSpec:_.layer.type,style:i.style,styleSpec:i.styleSpec,validateSpec:i.validateSpec,object:r,objectKey:"type"}),filter:Ao,layout:A=>zr({layer:r,key:A.key,value:A.value,style:A.style,styleSpec:A.styleSpec,validateSpec:A.validateSpec,objectElementValidators:{"*":F=>kl(Ei({layerType:x},F))}}),paint:A=>zr({layer:r,key:A.key,value:A.value,style:A.style,styleSpec:A.styleSpec,validateSpec:A.validateSpec,objectElementValidators:{"*":F=>el(Ei({layerType:x},F))}})}})),e}function Qs(i){const e=i.value,r=i.key,o=qe(e);return o!=="string"?[new ct(r,e,`string expected, ${o} found`)]:[]}const fc={promoteId:function({key:i,value:e}){if(qe(e)==="string")return Qs({key:i,value:e});{const r=[];for(const o in e)r.push(...Qs({key:`${i}.${o}`,value:e[o]}));return r}}};function Ol(i){const e=i.value,r=i.key,o=i.styleSpec,u=i.style,_=i.validateSpec;if(!e.type)return[new ct(r,e,'"type" is required')];const x=sr(e.type);let S;switch(x){case"vector":case"raster":return S=zr({key:r,value:e,valueSpec:o[`source_${x.replace("-","_")}`],style:i.style,styleSpec:o,objectElementValidators:fc,validateSpec:_}),S;case"raster-dem":return S=function(A){var F;const R=(F=A.sourceName)!==null&&F!==void 0?F:"",j=A.value,W=A.styleSpec,q=W.source_raster_dem,Q=A.style;let re=[];const ue=qe(j);if(j===void 0)return re;if(ue!=="object")return re.push(new ct("source_raster_dem",j,`object expected, ${ue} found`)),re;const we=sr(j.encoding)==="custom",Ne=["redFactor","greenFactor","blueFactor","baseShift"],Ee=A.value.encoding?`"${A.value.encoding}"`:"Default";for(const Re in j)!we&&Ne.includes(Re)?re.push(new ct(Re,j[Re],`In "${R}": "${Re}" is only valid when "encoding" is set to "custom". ${Ee} encoding found`)):q[Re]?re=re.concat(A.validateSpec({key:Re,value:j[Re],valueSpec:q[Re],validateSpec:A.validateSpec,style:Q,styleSpec:W})):re.push(new ct(Re,j[Re],`unknown property "${Re}"`));return re}({sourceName:r,value:e,style:i.style,styleSpec:o,validateSpec:_}),S;case"geojson":if(S=zr({key:r,value:e,valueSpec:o.source_geojson,style:u,styleSpec:o,validateSpec:_,objectElementValidators:fc}),e.cluster)for(const A in e.clusterProperties){const[F,R]=e.clusterProperties[A],j=typeof F=="string"?[F,["accumulated"],["get",A]]:F;S.push(...Sn({key:`${r}.${A}.map`,value:R,validateSpec:_,expressionContext:"cluster-map"})),S.push(...Sn({key:`${r}.${A}.reduce`,value:j,validateSpec:_,expressionContext:"cluster-reduce"}))}return S;case"video":return zr({key:r,value:e,valueSpec:o.source_video,style:u,validateSpec:_,styleSpec:o});case"image":return zr({key:r,value:e,valueSpec:o.source_image,style:u,validateSpec:_,styleSpec:o});case"canvas":return[new ct(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Qn({key:`${r}.type`,value:e.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:u,validateSpec:_,styleSpec:o})}}function Dl(i){const e=i.value,r=i.styleSpec,o=r.light,u=i.style;let _=[];const x=qe(e);if(e===void 0)return _;if(x!=="object")return _=_.concat([new ct("light",e,`object expected, ${x} found`)]),_;for(const S in e){const A=S.match(/^(.*)-transition$/);_=_.concat(A&&o[A[1]]&&o[A[1]].transition?i.validateSpec({key:S,value:e[S],valueSpec:r.transition,validateSpec:i.validateSpec,style:u,styleSpec:r}):o[S]?i.validateSpec({key:S,value:e[S],valueSpec:o[S],validateSpec:i.validateSpec,style:u,styleSpec:r}):[new ct(S,e[S],`unknown property "${S}"`)])}return _}function Ll(i){const e=i.value,r=i.styleSpec,o=r.sky,u=i.style,_=qe(e);if(e===void 0)return[];if(_!=="object")return[new ct("sky",e,`object expected, ${_} found`)];let x=[];for(const S in e)x=x.concat(o[S]?i.validateSpec({key:S,value:e[S],valueSpec:o[S],style:u,styleSpec:r}):[new ct(S,e[S],`unknown property "${S}"`)]);return x}function pc(i){const e=i.value,r=i.styleSpec,o=r.terrain,u=i.style;let _=[];const x=qe(e);if(e===void 0)return _;if(x!=="object")return _=_.concat([new ct("terrain",e,`object expected, ${x} found`)]),_;for(const S in e)_=_.concat(o[S]?i.validateSpec({key:S,value:e[S],valueSpec:o[S],validateSpec:i.validateSpec,style:u,styleSpec:r}):[new ct(S,e[S],`unknown property "${S}"`)]);return _}function mc(i){let e=[];const r=i.value,o=i.key;if(Array.isArray(r)){const u=[],_=[];for(const x in r)r[x].id&&u.includes(r[x].id)&&e.push(new ct(o,r,`all the sprites' ids must be unique, but ${r[x].id} is duplicated`)),u.push(r[x].id),r[x].url&&_.includes(r[x].url)&&e.push(new ct(o,r,`all the sprites' URLs must be unique, but ${r[x].url} is duplicated`)),_.push(r[x].url),e=e.concat(zr({key:`${o}[${x}]`,value:r[x],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:i.validateSpec}));return e}return Qs({key:o,value:r})}const Fl={"*":()=>[],array:Io,boolean:function(i){const e=i.value,r=i.key,o=qe(e);return o!=="boolean"?[new ct(r,e,`boolean expected, ${o} found`)]:[]},number:Ys,color:function(i){const e=i.key,r=i.value,o=qe(r);return o!=="string"?[new ct(e,r,`color expected, ${o} found`)]:zi.parse(String(r))?[]:[new ct(e,r,`color expected, "${r}" found`)]},constants:gs,enum:Qn,filter:Ao,function:Zs,layer:dc,object:zr,source:Ol,light:Dl,sky:Ll,terrain:pc,projection:function(i){const e=i.value,r=i.styleSpec,o=r.projection,u=i.style,_=qe(e);if(e===void 0)return[];if(_!=="object")return[new ct("projection",e,`object expected, ${_} found`)];let x=[];for(const S in e)x=x.concat(o[S]?i.validateSpec({key:S,value:e[S],valueSpec:o[S],style:u,styleSpec:r}):[new ct(S,e[S],`unknown property "${S}"`)]);return x},string:Qs,formatted:function(i){return Qs(i).length===0?[]:Sn(i)},resolvedImage:function(i){return Qs(i).length===0?[]:Sn(i)},padding:function(i){const e=i.key,r=i.value;if(qe(r)==="array"){if(r.length<1||r.length>4)return[new ct(e,r,`padding requires 1 to 4 values; ${r.length} values found`)];const o={type:"number"};let u=[];for(let _=0;_<r.length;_++)u=u.concat(i.validateSpec({key:`${e}[${_}]`,value:r[_],validateSpec:i.validateSpec,valueSpec:o}));return u}return Ys({key:e,value:r,valueSpec:{}})},variableAnchorOffsetCollection:function(i){const e=i.key,r=i.value,o=qe(r),u=i.styleSpec;if(o!=="array"||r.length<1||r.length%2!=0)return[new ct(e,r,"variableAnchorOffsetCollection requires a non-empty array of even length")];let _=[];for(let x=0;x<r.length;x+=2)_=_.concat(Qn({key:`${e}[${x}]`,value:r[x],valueSpec:u.layout_symbol["text-anchor"]})),_=_.concat(Io({key:`${e}[${x+1}]`,value:r[x+1],valueSpec:{length:2,value:"number"},validateSpec:i.validateSpec,style:i.style,styleSpec:u}));return _},sprite:mc};function Yo(i){const e=i.value,r=i.valueSpec,o=i.styleSpec;return i.validateSpec=Yo,r.expression&&Ft(sr(e))?Zs(i):r.expression&&gn(rn(e))?Sn(i):r.type&&Fl[r.type]?Fl[r.type](i):zr(Ei({},i,{valueSpec:r.type?o[r.type]:r}))}function zl(i){const e=i.value,r=i.key,o=Qs(i);return o.length||(e.indexOf("{fontstack}")===-1&&o.push(new ct(r,e,'"glyphs" url must include a "{fontstack}" token')),e.indexOf("{range}")===-1&&o.push(new ct(r,e,'"glyphs" url must include a "{range}" token'))),o}function Hn(i,e=ae){let r=[];return r=r.concat(Yo({key:"",value:i,valueSpec:e.$root,styleSpec:e,style:i,validateSpec:Yo,objectElementValidators:{glyphs:zl,"*":()=>[]}})),i.constants&&(r=r.concat(gs({key:"constants",value:i.constants,style:i,styleSpec:e,validateSpec:Yo}))),gc(r)}function Bn(i){return function(e){return i({...e,validateSpec:Yo})}}function gc(i){return[].concat(i).sort((e,r)=>e.line-r.line)}function Xn(i){return function(...e){return gc(i.apply(this,e))}}Hn.source=Xn(Bn(Ol)),Hn.sprite=Xn(Bn(mc)),Hn.glyphs=Xn(Bn(zl)),Hn.light=Xn(Bn(Dl)),Hn.sky=Xn(Bn(Ll)),Hn.terrain=Xn(Bn(pc)),Hn.layer=Xn(Bn(dc)),Hn.filter=Xn(Bn(Ao)),Hn.paintProperty=Xn(Bn(el)),Hn.layoutProperty=Xn(Bn(kl));const Ta=Hn,nh=Ta.light,_c=Ta.paintProperty,yc=Ta.layoutProperty;function Rl(i,e){let r=!1;if(e&&e.length)for(const o of e)i.fire(new Oe(new Error(o.message))),r=!0;return r}class Ea{constructor(e,r,o){const u=this.cells=[];if(e instanceof ArrayBuffer){this.arrayBuffer=e;const x=new Int32Array(this.arrayBuffer);e=x[0],this.d=(r=x[1])+2*(o=x[2]);for(let A=0;A<this.d*this.d;A++){const F=x[3+A],R=x[3+A+1];u.push(F===R?null:x.subarray(F,R))}const S=x[3+u.length+1];this.keys=x.subarray(x[3+u.length],S),this.bboxes=x.subarray(S),this.insert=this._insertReadonly}else{this.d=r+2*o;for(let x=0;x<this.d*this.d;x++)u.push([]);this.keys=[],this.bboxes=[]}this.n=r,this.extent=e,this.padding=o,this.scale=r/e,this.uid=0;const _=o/r*e;this.min=-_,this.max=e+_}insert(e,r,o,u,_){this._forEachCell(r,o,u,_,this._insertCell,this.uid++,void 0,void 0),this.keys.push(e),this.bboxes.push(r),this.bboxes.push(o),this.bboxes.push(u),this.bboxes.push(_)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(e,r,o,u,_,x){this.cells[_].push(x)}query(e,r,o,u,_){const x=this.min,S=this.max;if(e<=x&&r<=x&&S<=o&&S<=u&&!_)return Array.prototype.slice.call(this.keys);{const A=[];return this._forEachCell(e,r,o,u,this._queryCell,A,{},_),A}}_queryCell(e,r,o,u,_,x,S,A){const F=this.cells[_];if(F!==null){const R=this.keys,j=this.bboxes;for(let W=0;W<F.length;W++){const q=F[W];if(S[q]===void 0){const Q=4*q;(A?A(j[Q+0],j[Q+1],j[Q+2],j[Q+3]):e<=j[Q+2]&&r<=j[Q+3]&&o>=j[Q+0]&&u>=j[Q+1])?(S[q]=!0,x.push(R[q])):S[q]=!1}}}}_forEachCell(e,r,o,u,_,x,S,A){const F=this._convertToCellCoord(e),R=this._convertToCellCoord(r),j=this._convertToCellCoord(o),W=this._convertToCellCoord(u);for(let q=F;q<=j;q++)for(let Q=R;Q<=W;Q++){const re=this.d*Q+q;if((!A||A(this._convertFromCellCoord(q),this._convertFromCellCoord(Q),this._convertFromCellCoord(q+1),this._convertFromCellCoord(Q+1)))&&_.call(this,e,r,o,u,re,x,S,A))return}}_convertFromCellCoord(e){return(e-this.padding)/this.scale}_convertToCellCoord(e){return Math.max(0,Math.min(this.d-1,Math.floor(e*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const e=this.cells,r=3+this.cells.length+1+1;let o=0;for(let x=0;x<this.cells.length;x++)o+=this.cells[x].length;const u=new Int32Array(r+o+this.keys.length+this.bboxes.length);u[0]=this.extent,u[1]=this.n,u[2]=this.padding;let _=r;for(let x=0;x<e.length;x++){const S=e[x];u[3+x]=_,u.set(S,_),_+=S.length}return u[3+e.length]=_,u.set(this.keys,_),_+=this.keys.length,u[3+e.length+1]=_,u.set(this.bboxes,_),_+=this.bboxes.length,u.buffer}static serialize(e,r){const o=e.toArrayBuffer();return r&&r.push(o),{buffer:o}}static deserialize(e){return new Ea(e.buffer)}}const eo={};function Zt(i,e,r={}){if(eo[i])throw new Error(`${i} is already registered.`);Object.defineProperty(e,"_classRegistryKey",{value:i,writeable:!1}),eo[i]={klass:e,omit:r.omit||[],shallow:r.shallow||[]}}Zt("Object",Object),Zt("TransferableGridIndex",Ea),Zt("Color",zi),Zt("Error",Error),Zt("AJAXError",Ue),Zt("ResolvedImage",Sr),Zt("StylePropertyFunction",Wn),Zt("StyleExpression",Pr,{omit:["_evaluator"]}),Zt("ZoomDependentExpression",zn),Zt("ZoomConstantExpression",Nr),Zt("CompoundExpression",Tr,{omit:["_evaluate"]});for(const i in Ps)Ps[i]._classRegistryKey||Zt(`Expression_${i}`,Ps[i]);function vc(i){return i&&typeof ArrayBuffer<"u"&&(i instanceof ArrayBuffer||i.constructor&&i.constructor.name==="ArrayBuffer")}function Pa(i,e){if(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||i instanceof Blob||i instanceof Error)return i;if(vc(i)||ot(i))return e&&e.push(i),i;if(ArrayBuffer.isView(i)){const r=i;return e&&e.push(r.buffer),r}if(i instanceof ImageData)return e&&e.push(i.data.buffer),i;if(Array.isArray(i)){const r=[];for(const o of i)r.push(Pa(o,e));return r}if(typeof i=="object"){const r=i.constructor,o=r._classRegistryKey;if(!o)throw new Error(`can't serialize object of unregistered class ${r.name}`);if(!eo[o])throw new Error(`${o} is not registered.`);const u=r.serialize?r.serialize(i,e):{};if(r.serialize){if(e&&u===e[e.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const _ in i){if(!i.hasOwnProperty(_)||eo[o].omit.indexOf(_)>=0)continue;const x=i[_];u[_]=eo[o].shallow.indexOf(_)>=0?x:Pa(x,e)}i instanceof Error&&(u.message=i.message)}if(u.$name)throw new Error("$name property is reserved for worker serialization logic.");return o!=="Object"&&(u.$name=o),u}throw new Error("can't serialize object of type "+typeof i)}function _s(i){if(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||i instanceof Blob||i instanceof Error||vc(i)||ot(i)||ArrayBuffer.isView(i)||i instanceof ImageData)return i;if(Array.isArray(i))return i.map(_s);if(typeof i=="object"){const e=i.$name||"Object";if(!eo[e])throw new Error(`can't deserialize unregistered class ${e}`);const{klass:r}=eo[e];if(!r)throw new Error(`can't deserialize unregistered class ${e}`);if(r.deserialize)return r.deserialize(i);const o=Object.create(r.prototype);for(const u of Object.keys(i)){if(u==="$name")continue;const _=i[u];o[u]=eo[e].shallow.indexOf(u)>=0?_:_s(_)}return o}throw new Error("can't deserialize object of type "+typeof i)}class xc{constructor(){this.first=!0}update(e,r){const o=Math.floor(e);return this.first?(this.first=!1,this.lastIntegerZoom=o,this.lastIntegerZoomTime=0,this.lastZoom=e,this.lastFloorZoom=o,!0):(this.lastFloorZoom>o?(this.lastIntegerZoom=o+1,this.lastIntegerZoomTime=r):this.lastFloorZoom<o&&(this.lastIntegerZoom=o,this.lastIntegerZoomTime=r),e!==this.lastZoom&&(this.lastZoom=e,this.lastFloorZoom=o,!0))}}const Wt={"Latin-1 Supplement":i=>i>=128&&i<=255,Arabic:i=>i>=1536&&i<=1791,"Arabic Supplement":i=>i>=1872&&i<=1919,"Arabic Extended-A":i=>i>=2208&&i<=2303,"Hangul Jamo":i=>i>=4352&&i<=4607,"Unified Canadian Aboriginal Syllabics":i=>i>=5120&&i<=5759,Khmer:i=>i>=6016&&i<=6143,"Unified Canadian Aboriginal Syllabics Extended":i=>i>=6320&&i<=6399,"General Punctuation":i=>i>=8192&&i<=8303,"Letterlike Symbols":i=>i>=8448&&i<=8527,"Number Forms":i=>i>=8528&&i<=8591,"Miscellaneous Technical":i=>i>=8960&&i<=9215,"Control Pictures":i=>i>=9216&&i<=9279,"Optical Character Recognition":i=>i>=9280&&i<=9311,"Enclosed Alphanumerics":i=>i>=9312&&i<=9471,"Geometric Shapes":i=>i>=9632&&i<=9727,"Miscellaneous Symbols":i=>i>=9728&&i<=9983,"Miscellaneous Symbols and Arrows":i=>i>=11008&&i<=11263,"CJK Radicals Supplement":i=>i>=11904&&i<=12031,"Kangxi Radicals":i=>i>=12032&&i<=12255,"Ideographic Description Characters":i=>i>=12272&&i<=12287,"CJK Symbols and Punctuation":i=>i>=12288&&i<=12351,Hiragana:i=>i>=12352&&i<=12447,Katakana:i=>i>=12448&&i<=12543,Bopomofo:i=>i>=12544&&i<=12591,"Hangul Compatibility Jamo":i=>i>=12592&&i<=12687,Kanbun:i=>i>=12688&&i<=12703,"Bopomofo Extended":i=>i>=12704&&i<=12735,"CJK Strokes":i=>i>=12736&&i<=12783,"Katakana Phonetic Extensions":i=>i>=12784&&i<=12799,"Enclosed CJK Letters and Months":i=>i>=12800&&i<=13055,"CJK Compatibility":i=>i>=13056&&i<=13311,"CJK Unified Ideographs Extension A":i=>i>=13312&&i<=19903,"Yijing Hexagram Symbols":i=>i>=19904&&i<=19967,"CJK Unified Ideographs":i=>i>=19968&&i<=40959,"Yi Syllables":i=>i>=40960&&i<=42127,"Yi Radicals":i=>i>=42128&&i<=42191,"Hangul Jamo Extended-A":i=>i>=43360&&i<=43391,"Hangul Syllables":i=>i>=44032&&i<=55215,"Hangul Jamo Extended-B":i=>i>=55216&&i<=55295,"Private Use Area":i=>i>=57344&&i<=63743,"CJK Compatibility Ideographs":i=>i>=63744&&i<=64255,"Arabic Presentation Forms-A":i=>i>=64336&&i<=65023,"Vertical Forms":i=>i>=65040&&i<=65055,"CJK Compatibility Forms":i=>i>=65072&&i<=65103,"Small Form Variants":i=>i>=65104&&i<=65135,"Arabic Presentation Forms-B":i=>i>=65136&&i<=65279,"Halfwidth and Fullwidth Forms":i=>i>=65280&&i<=65519};function Bl(i){for(const e of i)if(jl(e.charCodeAt(0)))return!0;return!1}function sh(i){for(const e of i)if(!bc(e.charCodeAt(0)))return!1;return!0}function bc(i){return!(Wt.Arabic(i)||Wt["Arabic Supplement"](i)||Wt["Arabic Extended-A"](i)||Wt["Arabic Presentation Forms-A"](i)||Wt["Arabic Presentation Forms-B"](i))}function jl(i){return!(i!==746&&i!==747&&(i<4352||!(Wt["Bopomofo Extended"](i)||Wt.Bopomofo(i)||Wt["CJK Compatibility Forms"](i)&&!(i>=65097&&i<=65103)||Wt["CJK Compatibility Ideographs"](i)||Wt["CJK Compatibility"](i)||Wt["CJK Radicals Supplement"](i)||Wt["CJK Strokes"](i)||!(!Wt["CJK Symbols and Punctuation"](i)||i>=12296&&i<=12305||i>=12308&&i<=12319||i===12336)||Wt["CJK Unified Ideographs Extension A"](i)||Wt["CJK Unified Ideographs"](i)||Wt["Enclosed CJK Letters and Months"](i)||Wt["Hangul Compatibility Jamo"](i)||Wt["Hangul Jamo Extended-A"](i)||Wt["Hangul Jamo Extended-B"](i)||Wt["Hangul Jamo"](i)||Wt["Hangul Syllables"](i)||Wt.Hiragana(i)||Wt["Ideographic Description Characters"](i)||Wt.Kanbun(i)||Wt["Kangxi Radicals"](i)||Wt["Katakana Phonetic Extensions"](i)||Wt.Katakana(i)&&i!==12540||!(!Wt["Halfwidth and Fullwidth Forms"](i)||i===65288||i===65289||i===65293||i>=65306&&i<=65310||i===65339||i===65341||i===65343||i>=65371&&i<=65503||i===65507||i>=65512&&i<=65519)||!(!Wt["Small Form Variants"](i)||i>=65112&&i<=65118||i>=65123&&i<=65126)||Wt["Unified Canadian Aboriginal Syllabics"](i)||Wt["Unified Canadian Aboriginal Syllabics Extended"](i)||Wt["Vertical Forms"](i)||Wt["Yijing Hexagram Symbols"](i)||Wt["Yi Syllables"](i)||Wt["Yi Radicals"](i))))}function wc(i){return!(jl(i)||function(e){return!!(Wt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Wt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Wt["Letterlike Symbols"](e)||Wt["Number Forms"](e)||Wt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Wt["Control Pictures"](e)&&e!==9251||Wt["Optical Character Recognition"](e)||Wt["Enclosed Alphanumerics"](e)||Wt["Geometric Shapes"](e)||Wt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Wt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Wt["CJK Symbols and Punctuation"](e)||Wt.Katakana(e)||Wt["Private Use Area"](e)||Wt["CJK Compatibility Forms"](e)||Wt["Small Form Variants"](e)||Wt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(i))}function to(i){return i>=1424&&i<=2303||Wt["Arabic Presentation Forms-A"](i)||Wt["Arabic Presentation Forms-B"](i)}function Cc(i,e){return!(!e&&to(i)||i>=2304&&i<=3583||i>=3840&&i<=4255||Wt.Khmer(i))}function Nl(i){for(const e of i)if(to(e.charCodeAt(0)))return!0;return!1}const io=new class{constructor(){this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null}setState(i){this.pluginStatus=i.pluginStatus,this.pluginURL=i.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(i){this.applyArabicShaping=i.applyArabicShaping,this.processBidirectionalText=i.processBidirectionalText,this.processStyledBidirectionalText=i.processStyledBidirectionalText}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getPluginURL(){return this.pluginURL}getRTLTextPluginStatus(){return this.pluginStatus}};class hr{constructor(e,r){this.zoom=e,r?(this.now=r.now,this.fadeDuration=r.fadeDuration,this.zoomHistory=r.zoomHistory,this.transition=r.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new xc,this.transition={})}isSupportedScript(e){return function(r,o){for(const u of r)if(!Cc(u.charCodeAt(0),o))return!1;return!0}(e,io.getRTLTextPluginStatus()==="loaded")}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const e=this.zoom,r=e-Math.floor(e),o=this.crossFadingFactor();return e>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:r+(1-r)*o}:{fromScale:.5,toScale:1,t:1-(1-o)*r}}}class tl{constructor(e,r){this.property=e,this.value=r,this.expression=function(o,u){if(Ft(o))return new Wn(o,u);if(gn(o)){const _=Gn(o,u);if(_.result==="error")throw new Error(_.value.map(x=>`${x.key}: ${x.message}`).join(", "));return _.value}{let _=o;return u.type==="color"&&typeof o=="string"?_=zi.parse(o):u.type!=="padding"||typeof o!="number"&&!Array.isArray(o)?u.type==="variableAnchorOffsetCollection"&&Array.isArray(o)&&(_=Cr.parse(o)):_=qr.parse(o),{kind:"constant",evaluate:()=>_}}}(r===void 0?e.specification.default:r,e.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,r,o){return this.property.possiblyEvaluate(this,e,r,o)}}class Zo{constructor(e){this.property=e,this.value=new tl(e,void 0)}transitioned(e,r){return new Sc(this.property,this.value,r,ne({},e.transition,this.transition),e.now)}untransitioned(){return new Sc(this.property,this.value,null,{},0)}}class Ko{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues)}getValue(e){return Je(this._values[e].value.value)}setValue(e,r){Object.prototype.hasOwnProperty.call(this._values,e)||(this._values[e]=new Zo(this._values[e].property)),this._values[e].value=new tl(this._values[e].property,r===null?void 0:Je(r))}getTransition(e){return Je(this._values[e].transition)}setTransition(e,r){Object.prototype.hasOwnProperty.call(this._values,e)||(this._values[e]=new Zo(this._values[e].property)),this._values[e].transition=Je(r)||void 0}serialize(){const e={};for(const r of Object.keys(this._values)){const o=this.getValue(r);o!==void 0&&(e[r]=o);const u=this.getTransition(r);u!==void 0&&(e[`${r}-transition`]=u)}return e}transitioned(e,r){const o=new Vl(this._properties);for(const u of Object.keys(this._values))o._values[u]=this._values[u].transitioned(e,r._values[u]);return o}untransitioned(){const e=new Vl(this._properties);for(const r of Object.keys(this._values))e._values[r]=this._values[r].untransitioned();return e}}class Sc{constructor(e,r,o,u,_){this.property=e,this.value=r,this.begin=_+u.delay||0,this.end=this.begin+u.duration||0,e.specification.transition&&(u.delay||u.duration)&&(this.prior=o)}possiblyEvaluate(e,r,o){const u=e.now||0,_=this.value.possiblyEvaluate(e,r,o),x=this.prior;if(x){if(u>this.end)return this.prior=null,_;if(this.value.isDataDriven())return this.prior=null,_;if(u<this.begin)return x.possiblyEvaluate(e,r,o);{const S=(u-this.begin)/(this.end-this.begin);return this.property.interpolate(x.possiblyEvaluate(e,r,o),_,function(A){if(A<=0)return 0;if(A>=1)return 1;const F=A*A,R=F*A;return 4*(A<.5?R:3*(A-F)+R-.75)}(S))}}return _}}class Vl{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,r,o){const u=new il(this._properties);for(const _ of Object.keys(this._values))u._values[_]=this._values[_].possiblyEvaluate(e,r,o);return u}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Ia{constructor(e){this._properties=e,this._values=Object.create(e.defaultPropertyValues)}hasValue(e){return this._values[e].value!==void 0}getValue(e){return Je(this._values[e].value)}setValue(e,r){this._values[e]=new tl(this._values[e].property,r===null?void 0:Je(r))}serialize(){const e={};for(const r of Object.keys(this._values)){const o=this.getValue(r);o!==void 0&&(e[r]=o)}return e}possiblyEvaluate(e,r,o){const u=new il(this._properties);for(const _ of Object.keys(this._values))u._values[_]=this._values[_].possiblyEvaluate(e,r,o);return u}}class ys{constructor(e,r,o){this.property=e,this.value=r,this.parameters=o}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,r,o,u){return this.property.evaluate(this.value,this.parameters,e,r,o,u)}}class il{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class ai{constructor(e){this.specification=e}possiblyEvaluate(e,r){if(e.isDataDriven())throw new Error("Value should not be data driven");return e.expression.evaluate(r)}interpolate(e,r,o){const u=fi[this.specification.type];return u?u(e,r,o):e}}class gi{constructor(e,r){this.specification=e,this.overrides=r}possiblyEvaluate(e,r,o,u){return new ys(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(r,null,{},o,u)}:e.expression,r)}interpolate(e,r,o){if(e.value.kind!=="constant"||r.value.kind!=="constant")return e;if(e.value.value===void 0||r.value.value===void 0)return new ys(this,{kind:"constant",value:void 0},e.parameters);const u=fi[this.specification.type];if(u){const _=u(e.value.value,r.value.value,o);return new ys(this,{kind:"constant",value:_},e.parameters)}return e}evaluate(e,r,o,u,_,x){return e.kind==="constant"?e.value:e.evaluate(r,o,u,_,x)}}class y extends gi{possiblyEvaluate(e,r,o,u){if(e.value===void 0)return new ys(this,{kind:"constant",value:void 0},r);if(e.expression.kind==="constant"){const _=e.expression.evaluate(r,null,{},o,u),x=e.property.specification.type==="resolvedImage"&&typeof _!="string"?_.name:_,S=this._calculate(x,x,x,r);return new ys(this,{kind:"constant",value:S},r)}if(e.expression.kind==="camera"){const _=this._calculate(e.expression.evaluate({zoom:r.zoom-1}),e.expression.evaluate({zoom:r.zoom}),e.expression.evaluate({zoom:r.zoom+1}),r);return new ys(this,{kind:"constant",value:_},r)}return new ys(this,e.expression,r)}evaluate(e,r,o,u,_,x){if(e.kind==="source"){const S=e.evaluate(r,o,u,_,x);return this._calculate(S,S,S,r)}return e.kind==="composite"?this._calculate(e.evaluate({zoom:Math.floor(r.zoom)-1},o,u),e.evaluate({zoom:Math.floor(r.zoom)},o,u),e.evaluate({zoom:Math.floor(r.zoom)+1},o,u),r):e.value}_calculate(e,r,o,u){return u.zoom>u.zoomHistory.lastIntegerZoom?{from:e,to:r}:{from:o,to:r}}interpolate(e){return e}}class t{constructor(e){this.specification=e}possiblyEvaluate(e,r,o,u){if(e.value!==void 0){if(e.expression.kind==="constant"){const _=e.expression.evaluate(r,null,{},o,u);return this._calculate(_,_,_,r)}return this._calculate(e.expression.evaluate(new hr(Math.floor(r.zoom-1),r)),e.expression.evaluate(new hr(Math.floor(r.zoom),r)),e.expression.evaluate(new hr(Math.floor(r.zoom+1),r)),r)}}_calculate(e,r,o,u){return u.zoom>u.zoomHistory.lastIntegerZoom?{from:e,to:r}:{from:o,to:r}}interpolate(e){return e}}class n{constructor(e){this.specification=e}possiblyEvaluate(e,r,o,u){return!!e.expression.evaluate(r,null,{},o,u)}interpolate(){return!1}}class a{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const r in e){const o=e[r];o.specification.overridable&&this.overridableProperties.push(r);const u=this.defaultPropertyValues[r]=new tl(o,void 0),_=this.defaultTransitionablePropertyValues[r]=new Zo(o);this.defaultTransitioningPropertyValues[r]=_.untransitioned(),this.defaultPossiblyEvaluatedValues[r]=u.possiblyEvaluate({})}}}Zt("DataDrivenProperty",gi),Zt("DataConstantProperty",ai),Zt("CrossFadedDataDrivenProperty",y),Zt("CrossFadedProperty",t),Zt("ColorRampProperty",n);const f="-transition";class v extends at{constructor(e,r){if(super(),this.id=e.id,this.type=e.type,this._featureFilter={filter:()=>!0,needGeometry:!1},e.type!=="custom"&&(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type!=="background"&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),r.layout&&(this._unevaluatedLayout=new Ia(r.layout)),r.paint)){this._transitionablePaint=new Ko(r.paint);for(const o in e.paint)this.setPaintProperty(o,e.paint[o],{validate:!1});for(const o in e.layout)this.setLayoutProperty(o,e.layout[o],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new il(r.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,r,o={}){r!=null&&this._validate(yc,`layers.${this.id}.layout.${e}`,e,r,o)||(e!=="visibility"?this._unevaluatedLayout.setValue(e,r):this.visibility=r)}getPaintProperty(e){return e.endsWith(f)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,r,o={}){if(r!=null&&this._validate(_c,`layers.${this.id}.paint.${e}`,e,r,o))return!1;if(e.endsWith(f))return this._transitionablePaint.setTransition(e.slice(0,-11),r||void 0),!1;{const u=this._transitionablePaint._values[e],_=u.property.specification["property-type"]==="cross-faded-data-driven",x=u.value.isDataDriven(),S=u.value;this._transitionablePaint.setValue(e,r),this._handleSpecialPaintPropertyUpdate(e);const A=this._transitionablePaint._values[e].value;return A.isDataDriven()||x||_||this._handleOverridablePaintPropertyUpdate(e,S,A)}}_handleSpecialPaintPropertyUpdate(e){}_handleOverridablePaintPropertyUpdate(e,r,o){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,r){e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,r)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,r)}serialize(){const e={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(e.layout=e.layout||{},e.layout.visibility=this.visibility),Ke(e,(r,o)=>!(r===void 0||o==="layout"&&!Object.keys(r).length||o==="paint"&&!Object.keys(r).length))}_validate(e,r,o,u,_={}){return(!_||_.validate!==!1)&&Rl(this,e.call(Ta,{key:r,layerType:this.type,objectKey:o,value:u,styleSpec:ae,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const e in this.paint._values){const r=this.paint.get(e);if(r instanceof ys&&Un(r.property.specification)&&(r.value.kind==="source"||r.value.kind==="composite")&&r.value.isStateDependent)return!0}return!1}}const I={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class k{constructor(e,r){this._structArray=e,this._pos1=r*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class D{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,r){return e._trim(),r&&(e.isTransferred=!0,r.push(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const r=Object.create(this.prototype);return r.arrayBuffer=e.arrayBuffer,r.length=e.length,r.capacity=e.arrayBuffer.byteLength/r.bytesPerElement,r._refreshViews(),r}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const r=this.uint8;this._refreshViews(),r&&this.uint8.set(r)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function B(i,e=1){let r=0,o=0;return{members:i.map(u=>{const _=I[u.type].BYTES_PER_ELEMENT,x=r=G(r,Math.max(e,_)),S=u.components||1;return o=Math.max(o,_),r+=_*S,{name:u.name,type:u.type,components:S,offset:x}}),size:G(r,Math.max(o,e)),alignment:e}}function G(i,e){return Math.ceil(i/e)*e}class U extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,r)}emplace(e,r,o){const u=2*e;return this.int16[u+0]=r,this.int16[u+1]=o,e}}U.prototype.bytesPerElement=4,Zt("StructArrayLayout2i4",U);class K extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o){const u=this.length;return this.resize(u+1),this.emplace(u,e,r,o)}emplace(e,r,o,u){const _=3*e;return this.int16[_+0]=r,this.int16[_+1]=o,this.int16[_+2]=u,e}}K.prototype.bytesPerElement=6,Zt("StructArrayLayout3i6",K);class ie extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,u){const _=this.length;return this.resize(_+1),this.emplace(_,e,r,o,u)}emplace(e,r,o,u,_){const x=4*e;return this.int16[x+0]=r,this.int16[x+1]=o,this.int16[x+2]=u,this.int16[x+3]=_,e}}ie.prototype.bytesPerElement=8,Zt("StructArrayLayout4i8",ie);class oe extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,u,_,x){const S=this.length;return this.resize(S+1),this.emplace(S,e,r,o,u,_,x)}emplace(e,r,o,u,_,x,S){const A=6*e;return this.int16[A+0]=r,this.int16[A+1]=o,this.int16[A+2]=u,this.int16[A+3]=_,this.int16[A+4]=x,this.int16[A+5]=S,e}}oe.prototype.bytesPerElement=12,Zt("StructArrayLayout2i4i12",oe);class ve extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,u,_,x){const S=this.length;return this.resize(S+1),this.emplace(S,e,r,o,u,_,x)}emplace(e,r,o,u,_,x,S){const A=4*e,F=8*e;return this.int16[A+0]=r,this.int16[A+1]=o,this.uint8[F+4]=u,this.uint8[F+5]=_,this.uint8[F+6]=x,this.uint8[F+7]=S,e}}ve.prototype.bytesPerElement=8,Zt("StructArrayLayout2i4ub8",ve);class ce extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,r)}emplace(e,r,o){const u=2*e;return this.float32[u+0]=r,this.float32[u+1]=o,e}}ce.prototype.bytesPerElement=8,Zt("StructArrayLayout2f8",ce);class Se extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o,u,_,x,S,A,F,R){const j=this.length;return this.resize(j+1),this.emplace(j,e,r,o,u,_,x,S,A,F,R)}emplace(e,r,o,u,_,x,S,A,F,R,j){const W=10*e;return this.uint16[W+0]=r,this.uint16[W+1]=o,this.uint16[W+2]=u,this.uint16[W+3]=_,this.uint16[W+4]=x,this.uint16[W+5]=S,this.uint16[W+6]=A,this.uint16[W+7]=F,this.uint16[W+8]=R,this.uint16[W+9]=j,e}}Se.prototype.bytesPerElement=20,Zt("StructArrayLayout10ui20",Se);class ke extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o,u,_,x,S,A,F,R,j,W){const q=this.length;return this.resize(q+1),this.emplace(q,e,r,o,u,_,x,S,A,F,R,j,W)}emplace(e,r,o,u,_,x,S,A,F,R,j,W,q){const Q=12*e;return this.int16[Q+0]=r,this.int16[Q+1]=o,this.int16[Q+2]=u,this.int16[Q+3]=_,this.uint16[Q+4]=x,this.uint16[Q+5]=S,this.uint16[Q+6]=A,this.uint16[Q+7]=F,this.int16[Q+8]=R,this.int16[Q+9]=j,this.int16[Q+10]=W,this.int16[Q+11]=q,e}}ke.prototype.bytesPerElement=24,Zt("StructArrayLayout4i4ui4i24",ke);class pe extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o){const u=this.length;return this.resize(u+1),this.emplace(u,e,r,o)}emplace(e,r,o,u){const _=3*e;return this.float32[_+0]=r,this.float32[_+1]=o,this.float32[_+2]=u,e}}pe.prototype.bytesPerElement=12,Zt("StructArrayLayout3f12",pe);class Fe extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint32[1*e+0]=r,e}}Fe.prototype.bytesPerElement=4,Zt("StructArrayLayout1ul4",Fe);class We extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o,u,_,x,S,A,F){const R=this.length;return this.resize(R+1),this.emplace(R,e,r,o,u,_,x,S,A,F)}emplace(e,r,o,u,_,x,S,A,F,R){const j=10*e,W=5*e;return this.int16[j+0]=r,this.int16[j+1]=o,this.int16[j+2]=u,this.int16[j+3]=_,this.int16[j+4]=x,this.int16[j+5]=S,this.uint32[W+3]=A,this.uint16[j+8]=F,this.uint16[j+9]=R,e}}We.prototype.bytesPerElement=20,Zt("StructArrayLayout6i1ul2ui20",We);class Ye extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,u,_,x){const S=this.length;return this.resize(S+1),this.emplace(S,e,r,o,u,_,x)}emplace(e,r,o,u,_,x,S){const A=6*e;return this.int16[A+0]=r,this.int16[A+1]=o,this.int16[A+2]=u,this.int16[A+3]=_,this.int16[A+4]=x,this.int16[A+5]=S,e}}Ye.prototype.bytesPerElement=12,Zt("StructArrayLayout2i2i2i12",Ye);class mt extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,u,_){const x=this.length;return this.resize(x+1),this.emplace(x,e,r,o,u,_)}emplace(e,r,o,u,_,x){const S=4*e,A=8*e;return this.float32[S+0]=r,this.float32[S+1]=o,this.float32[S+2]=u,this.int16[A+6]=_,this.int16[A+7]=x,e}}mt.prototype.bytesPerElement=16,Zt("StructArrayLayout2f1f2i16",mt);class Tt extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,u,_,x){const S=this.length;return this.resize(S+1),this.emplace(S,e,r,o,u,_,x)}emplace(e,r,o,u,_,x,S){const A=16*e,F=4*e,R=8*e;return this.uint8[A+0]=r,this.uint8[A+1]=o,this.float32[F+1]=u,this.float32[F+2]=_,this.int16[R+6]=x,this.int16[R+7]=S,e}}Tt.prototype.bytesPerElement=16,Zt("StructArrayLayout2ub2f2i16",Tt);class Ht extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o){const u=this.length;return this.resize(u+1),this.emplace(u,e,r,o)}emplace(e,r,o,u){const _=3*e;return this.uint16[_+0]=r,this.uint16[_+1]=o,this.uint16[_+2]=u,e}}Ht.prototype.bytesPerElement=6,Zt("StructArrayLayout3ui6",Ht);class qt extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o,u,_,x,S,A,F,R,j,W,q,Q,re,ue,we){const Ne=this.length;return this.resize(Ne+1),this.emplace(Ne,e,r,o,u,_,x,S,A,F,R,j,W,q,Q,re,ue,we)}emplace(e,r,o,u,_,x,S,A,F,R,j,W,q,Q,re,ue,we,Ne){const Ee=24*e,Re=12*e,et=48*e;return this.int16[Ee+0]=r,this.int16[Ee+1]=o,this.uint16[Ee+2]=u,this.uint16[Ee+3]=_,this.uint32[Re+2]=x,this.uint32[Re+3]=S,this.uint32[Re+4]=A,this.uint16[Ee+10]=F,this.uint16[Ee+11]=R,this.uint16[Ee+12]=j,this.float32[Re+7]=W,this.float32[Re+8]=q,this.uint8[et+36]=Q,this.uint8[et+37]=re,this.uint8[et+38]=ue,this.uint32[Re+10]=we,this.int16[Ee+22]=Ne,e}}qt.prototype.bytesPerElement=48,Zt("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",qt);class Pt extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o,u,_,x,S,A,F,R,j,W,q,Q,re,ue,we,Ne,Ee,Re,et,xt,jt,hi,Gt,Bt,oi,Kt){const Yt=this.length;return this.resize(Yt+1),this.emplace(Yt,e,r,o,u,_,x,S,A,F,R,j,W,q,Q,re,ue,we,Ne,Ee,Re,et,xt,jt,hi,Gt,Bt,oi,Kt)}emplace(e,r,o,u,_,x,S,A,F,R,j,W,q,Q,re,ue,we,Ne,Ee,Re,et,xt,jt,hi,Gt,Bt,oi,Kt,Yt){const ut=32*e,li=16*e;return this.int16[ut+0]=r,this.int16[ut+1]=o,this.int16[ut+2]=u,this.int16[ut+3]=_,this.int16[ut+4]=x,this.int16[ut+5]=S,this.int16[ut+6]=A,this.int16[ut+7]=F,this.uint16[ut+8]=R,this.uint16[ut+9]=j,this.uint16[ut+10]=W,this.uint16[ut+11]=q,this.uint16[ut+12]=Q,this.uint16[ut+13]=re,this.uint16[ut+14]=ue,this.uint16[ut+15]=we,this.uint16[ut+16]=Ne,this.uint16[ut+17]=Ee,this.uint16[ut+18]=Re,this.uint16[ut+19]=et,this.uint16[ut+20]=xt,this.uint16[ut+21]=jt,this.uint16[ut+22]=hi,this.uint32[li+12]=Gt,this.float32[li+13]=Bt,this.float32[li+14]=oi,this.uint16[ut+30]=Kt,this.uint16[ut+31]=Yt,e}}Pt.prototype.bytesPerElement=64,Zt("StructArrayLayout8i15ui1ul2f2ui64",Pt);class kt extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.float32[1*e+0]=r,e}}kt.prototype.bytesPerElement=4,Zt("StructArrayLayout1f4",kt);class Jt extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o){const u=this.length;return this.resize(u+1),this.emplace(u,e,r,o)}emplace(e,r,o,u){const _=3*e;return this.uint16[6*e+0]=r,this.float32[_+1]=o,this.float32[_+2]=u,e}}Jt.prototype.bytesPerElement=12,Zt("StructArrayLayout1ui2f12",Jt);class Ti extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o){const u=this.length;return this.resize(u+1),this.emplace(u,e,r,o)}emplace(e,r,o,u){const _=4*e;return this.uint32[2*e+0]=r,this.uint16[_+2]=o,this.uint16[_+3]=u,e}}Ti.prototype.bytesPerElement=8,Zt("StructArrayLayout1ul2ui8",Ti);class zt extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,r)}emplace(e,r,o){const u=2*e;return this.uint16[u+0]=r,this.uint16[u+1]=o,e}}zt.prototype.bytesPerElement=4,Zt("StructArrayLayout2ui4",zt);class Ut extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint16[1*e+0]=r,e}}Ut.prototype.bytesPerElement=2,Zt("StructArrayLayout1ui2",Ut);class yi extends D{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o,u){const _=this.length;return this.resize(_+1),this.emplace(_,e,r,o,u)}emplace(e,r,o,u,_){const x=4*e;return this.float32[x+0]=r,this.float32[x+1]=o,this.float32[x+2]=u,this.float32[x+3]=_,e}}yi.prototype.bytesPerElement=16,Zt("StructArrayLayout4f16",yi);class pr extends k{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new l(this.anchorPointX,this.anchorPointY)}}pr.prototype.size=20;class Ii extends We{get(e){return new pr(this,e)}}Zt("CollisionBoxArray",Ii);class Di extends k{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(e){this._structArray.uint8[this._pos1+37]=e}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(e){this._structArray.uint8[this._pos1+38]=e}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(e){this._structArray.uint32[this._pos4+10]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}Di.prototype.size=48;class mr extends qt{get(e){return new Di(this,e)}}Zt("PlacedSymbolArray",mr);class nn extends k{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(e){this._structArray.uint32[this._pos4+12]=e}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}nn.prototype.size=64;class es extends Pt{get(e){return new nn(this,e)}}Zt("SymbolInstanceArray",es);class gr extends kt{getoffsetX(e){return this.float32[1*e+0]}}Zt("GlyphOffsetArray",gr);class Tn extends K{getx(e){return this.int16[3*e+0]}gety(e){return this.int16[3*e+1]}gettileUnitDistanceFromAnchor(e){return this.int16[3*e+2]}}Zt("SymbolLineVertexArray",Tn);class _n extends k{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}_n.prototype.size=12;class sn extends Jt{get(e){return new _n(this,e)}}Zt("TextAnchorOffsetArray",sn);class on extends k{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}on.prototype.size=8;class ts extends Ti{get(e){return new on(this,e)}}Zt("FeatureIndexArray",ts);class Mo extends U{}class rl extends U{}class Jo extends U{}class ko extends oe{}class nl extends ve{}class Ul extends ce{}class Kr extends Se{}class is extends ke{}class ro extends pe{}class Qo extends Fe{}class an extends Ye{}class ln extends Tt{}class Gr extends Ht{}class br extends zt{}const ea=B([{name:"a_pos",components:2,type:"Int16"}],4),{members:Gl}=ea;class Vr{constructor(e=[]){this.segments=e}prepareSegment(e,r,o,u){let _=this.segments[this.segments.length-1];return e>Vr.MAX_VERTEX_ARRAY_LENGTH&&ht(`Max vertices per segment is ${Vr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!_||_.vertexLength+e>Vr.MAX_VERTEX_ARRAY_LENGTH||_.sortKey!==u)&&(_={vertexOffset:r.length,primitiveOffset:o.length,vertexLength:0,primitiveLength:0},u!==void 0&&(_.sortKey=u),this.segments.push(_)),_}get(){return this.segments}destroy(){for(const e of this.segments)for(const r in e.vaos)e.vaos[r].destroy()}static simpleSegment(e,r,o,u){return new Vr([{vertexOffset:e,primitiveOffset:r,vertexLength:o,primitiveLength:u,vaos:{},sortKey:0}])}}function Tc(i,e){return 256*(i=V(Math.floor(i),0,255))+V(Math.floor(e),0,255)}Vr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Zt("SegmentVector",Vr);const sl=B([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var ol={exports:{}},no={exports:{}};no.exports=function(i,e){var r,o,u,_,x,S,A,F;for(o=i.length-(r=3&i.length),u=e,x=3432918353,S=461845907,F=0;F<o;)A=255&i.charCodeAt(F)|(255&i.charCodeAt(++F))<<8|(255&i.charCodeAt(++F))<<16|(255&i.charCodeAt(++F))<<24,++F,u=27492+(65535&(_=5*(65535&(u=(u^=A=(65535&(A=(A=(65535&A)*x+(((A>>>16)*x&65535)<<16)&4294967295)<<15|A>>>17))*S+(((A>>>16)*S&65535)<<16)&4294967295)<<13|u>>>19))+((5*(u>>>16)&65535)<<16)&4294967295))+((58964+(_>>>16)&65535)<<16);switch(A=0,r){case 3:A^=(255&i.charCodeAt(F+2))<<16;case 2:A^=(255&i.charCodeAt(F+1))<<8;case 1:u^=A=(65535&(A=(A=(65535&(A^=255&i.charCodeAt(F)))*x+(((A>>>16)*x&65535)<<16)&4294967295)<<15|A>>>17))*S+(((A>>>16)*S&65535)<<16)&4294967295}return u^=i.length,u=2246822507*(65535&(u^=u>>>16))+((2246822507*(u>>>16)&65535)<<16)&4294967295,u=3266489909*(65535&(u^=u>>>13))+((3266489909*(u>>>16)&65535)<<16)&4294967295,(u^=u>>>16)>>>0};var Ec=no.exports,Wl={exports:{}};Wl.exports=function(i,e){for(var r,o=i.length,u=e^o,_=0;o>=4;)r=1540483477*(65535&(r=255&i.charCodeAt(_)|(255&i.charCodeAt(++_))<<8|(255&i.charCodeAt(++_))<<16|(255&i.charCodeAt(++_))<<24))+((1540483477*(r>>>16)&65535)<<16),u=1540483477*(65535&u)+((1540483477*(u>>>16)&65535)<<16)^(r=1540483477*(65535&(r^=r>>>24))+((1540483477*(r>>>16)&65535)<<16)),o-=4,++_;switch(o){case 3:u^=(255&i.charCodeAt(_+2))<<16;case 2:u^=(255&i.charCodeAt(_+1))<<8;case 1:u=1540483477*(65535&(u^=255&i.charCodeAt(_)))+((1540483477*(u>>>16)&65535)<<16)}return u=1540483477*(65535&(u^=u>>>13))+((1540483477*(u>>>16)&65535)<<16),(u^=u>>>15)>>>0};var Hl=Ec,Xl=Wl.exports;ol.exports=Hl,ol.exports.murmur3=Hl,ol.exports.murmur2=Xl;var al=p(ol.exports);class ta{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(e,r,o,u){this.ids.push(lu(e)),this.positions.push(r,o,u)}getPositions(e){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const r=lu(e);let o=0,u=this.ids.length-1;for(;o<u;){const x=o+u>>1;this.ids[x]>=r?u=x:o=x+1}const _=[];for(;this.ids[o]===r;)_.push({index:this.positions[3*o],start:this.positions[3*o+1],end:this.positions[3*o+2]}),o++;return _}static serialize(e,r){const o=new Float64Array(e.ids),u=new Uint32Array(e.positions);return oh(o,u,0,o.length-1),r&&r.push(o.buffer,u.buffer),{ids:o,positions:u}}static deserialize(e){const r=new ta;return r.ids=e.ids,r.positions=e.positions,r.indexed=!0,r}}function lu(i){const e=+i;return!isNaN(e)&&e<=Number.MAX_SAFE_INTEGER?e:al(String(i))}function oh(i,e,r,o){for(;r<o;){const u=i[r+o>>1];let _=r-1,x=o+1;for(;;){do _++;while(i[_]<u);do x--;while(i[x]>u);if(_>=x)break;Pc(i,_,x),Pc(e,3*_,3*x),Pc(e,3*_+1,3*x+1),Pc(e,3*_+2,3*x+2)}x-r<o-x?(oh(i,e,r,x),r=x+1):(oh(i,e,x+1,o),o=x)}}function Pc(i,e,r){const o=i[e];i[e]=i[r],i[r]=o}Zt("FeaturePositionMap",ta);class Aa{constructor(e,r){this.gl=e.gl,this.location=r}}class Ic extends Aa{constructor(e,r){super(e,r),this.current=0}set(e){this.current!==e&&(this.current=e,this.gl.uniform1f(this.location,e))}}class cu extends Aa{constructor(e,r){super(e,r),this.current=[0,0,0,0]}set(e){e[0]===this.current[0]&&e[1]===this.current[1]&&e[2]===this.current[2]&&e[3]===this.current[3]||(this.current=e,this.gl.uniform4f(this.location,e[0],e[1],e[2],e[3]))}}class hu extends Aa{constructor(e,r){super(e,r),this.current=zi.transparent}set(e){e.r===this.current.r&&e.g===this.current.g&&e.b===this.current.b&&e.a===this.current.a||(this.current=e,this.gl.uniform4f(this.location,e.r,e.g,e.b,e.a))}}const Pf=new Float32Array(16);function ah(i){return[Tc(255*i.r,255*i.g),Tc(255*i.b,255*i.a)]}class ql{constructor(e,r,o){this.value=e,this.uniformNames=r.map(u=>`u_${u}`),this.type=o}setUniform(e,r,o){e.set(o.constantOr(this.value))}getBinding(e,r,o){return this.type==="color"?new hu(e,r):new Ic(e,r)}}class ll{constructor(e,r){this.uniformNames=r.map(o=>`u_${o}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(e,r){this.pixelRatioFrom=r.pixelRatio,this.pixelRatioTo=e.pixelRatio,this.patternFrom=r.tlbr,this.patternTo=e.tlbr}setUniform(e,r,o,u){const _=u==="u_pattern_to"?this.patternTo:u==="u_pattern_from"?this.patternFrom:u==="u_pixel_ratio_to"?this.pixelRatioTo:u==="u_pixel_ratio_from"?this.pixelRatioFrom:null;_&&e.set(_)}getBinding(e,r,o){return o.substr(0,9)==="u_pattern"?new cu(e,r):new Ic(e,r)}}class Oo{constructor(e,r,o,u){this.expression=e,this.type=o,this.maxValue=0,this.paintVertexAttributes=r.map(_=>({name:`a_${_}`,type:"Float32",components:o==="color"?2:1,offset:0})),this.paintVertexArray=new u}populatePaintArray(e,r,o,u,_){const x=this.paintVertexArray.length,S=this.expression.evaluate(new hr(0),r,{},u,[],_);this.paintVertexArray.resize(e),this._setPaintValue(x,e,S)}updatePaintArray(e,r,o,u){const _=this.expression.evaluate({zoom:0},o,u);this._setPaintValue(e,r,_)}_setPaintValue(e,r,o){if(this.type==="color"){const u=ah(o);for(let _=e;_<r;_++)this.paintVertexArray.emplace(_,u[0],u[1])}else{for(let u=e;u<r;u++)this.paintVertexArray.emplace(u,o);this.maxValue=Math.max(this.maxValue,Math.abs(o))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ms{constructor(e,r,o,u,_,x){this.expression=e,this.uniformNames=r.map(S=>`u_${S}_t`),this.type=o,this.useIntegerZoom=u,this.zoom=_,this.maxValue=0,this.paintVertexAttributes=r.map(S=>({name:`a_${S}`,type:"Float32",components:o==="color"?4:2,offset:0})),this.paintVertexArray=new x}populatePaintArray(e,r,o,u,_){const x=this.expression.evaluate(new hr(this.zoom),r,{},u,[],_),S=this.expression.evaluate(new hr(this.zoom+1),r,{},u,[],_),A=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(A,e,x,S)}updatePaintArray(e,r,o,u){const _=this.expression.evaluate({zoom:this.zoom},o,u),x=this.expression.evaluate({zoom:this.zoom+1},o,u);this._setPaintValue(e,r,_,x)}_setPaintValue(e,r,o,u){if(this.type==="color"){const _=ah(o),x=ah(u);for(let S=e;S<r;S++)this.paintVertexArray.emplace(S,_[0],_[1],x[0],x[1])}else{for(let _=e;_<r;_++)this.paintVertexArray.emplace(_,o,u);this.maxValue=Math.max(this.maxValue,Math.abs(o),Math.abs(u))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,r){const o=this.useIntegerZoom?Math.floor(r.zoom):r.zoom,u=V(this.expression.interpolationFactor(o,this.zoom,this.zoom+1),0,1);e.set(u)}getBinding(e,r,o){return new Ic(e,r)}}class ia{constructor(e,r,o,u,_,x){this.expression=e,this.type=r,this.useIntegerZoom=o,this.zoom=u,this.layerId=x,this.zoomInPaintVertexArray=new _,this.zoomOutPaintVertexArray=new _}populatePaintArray(e,r,o){const u=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(e),this.zoomOutPaintVertexArray.resize(e),this._setPaintValues(u,e,r.patterns&&r.patterns[this.layerId],o)}updatePaintArray(e,r,o,u,_){this._setPaintValues(e,r,o.patterns&&o.patterns[this.layerId],_)}_setPaintValues(e,r,o,u){if(!u||!o)return;const{min:_,mid:x,max:S}=o,A=u[_],F=u[x],R=u[S];if(A&&F&&R)for(let j=e;j<r;j++)this.zoomInPaintVertexArray.emplace(j,F.tl[0],F.tl[1],F.br[0],F.br[1],A.tl[0],A.tl[1],A.br[0],A.br[1],F.pixelRatio,A.pixelRatio),this.zoomOutPaintVertexArray.emplace(j,F.tl[0],F.tl[1],F.br[0],F.br[1],R.tl[0],R.tl[1],R.br[0],R.br[1],F.pixelRatio,R.pixelRatio)}upload(e){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=e.createVertexBuffer(this.zoomInPaintVertexArray,sl.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=e.createVertexBuffer(this.zoomOutPaintVertexArray,sl.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class uu{constructor(e,r,o){this.binders={},this._buffers=[];const u=[];for(const _ in e.paint._values){if(!o(_))continue;const x=e.paint.get(_);if(!(x instanceof ys&&Un(x.property.specification)))continue;const S=If(_,e.type),A=x.value,F=x.property.specification.type,R=x.property.useIntegerZoom,j=x.property.specification["property-type"],W=j==="cross-faded"||j==="cross-faded-data-driven";if(A.kind==="constant")this.binders[_]=W?new ll(A.value,S):new ql(A.value,S,F),u.push(`/u_${_}`);else if(A.kind==="source"||W){const q=du(_,F,"source");this.binders[_]=W?new ia(A,F,R,r,q,e.id):new Oo(A,S,F,q),u.push(`/a_${_}`)}else{const q=du(_,F,"composite");this.binders[_]=new Ms(A,S,F,R,r,q),u.push(`/z_${_}`)}}this.cacheKey=u.sort().join("")}getMaxValue(e){const r=this.binders[e];return r instanceof Oo||r instanceof Ms?r.maxValue:0}populatePaintArrays(e,r,o,u,_){for(const x in this.binders){const S=this.binders[x];(S instanceof Oo||S instanceof Ms||S instanceof ia)&&S.populatePaintArray(e,r,o,u,_)}}setConstantPatternPositions(e,r){for(const o in this.binders){const u=this.binders[o];u instanceof ll&&u.setConstantPatternPositions(e,r)}}updatePaintArrays(e,r,o,u,_){let x=!1;for(const S in e){const A=r.getPositions(S);for(const F of A){const R=o.feature(F.index);for(const j in this.binders){const W=this.binders[j];if((W instanceof Oo||W instanceof Ms||W instanceof ia)&&W.expression.isStateDependent===!0){const q=u.paint.get(j);W.expression=q.value,W.updatePaintArray(F.start,F.end,R,e[S],_),x=!0}}}}return x}defines(){const e=[];for(const r in this.binders){const o=this.binders[r];(o instanceof ql||o instanceof ll)&&e.push(...o.uniformNames.map(u=>`#define HAS_UNIFORM_${u}`))}return e}getBinderAttributes(){const e=[];for(const r in this.binders){const o=this.binders[r];if(o instanceof Oo||o instanceof Ms)for(let u=0;u<o.paintVertexAttributes.length;u++)e.push(o.paintVertexAttributes[u].name);else if(o instanceof ia)for(let u=0;u<sl.members.length;u++)e.push(sl.members[u].name)}return e}getBinderUniforms(){const e=[];for(const r in this.binders){const o=this.binders[r];if(o instanceof ql||o instanceof ll||o instanceof Ms)for(const u of o.uniformNames)e.push(u)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e,r){const o=[];for(const u in this.binders){const _=this.binders[u];if(_ instanceof ql||_ instanceof ll||_ instanceof Ms){for(const x of _.uniformNames)if(r[x]){const S=_.getBinding(e,r[x],x);o.push({name:x,property:u,binding:S})}}}return o}setUniforms(e,r,o,u){for(const{name:_,property:x,binding:S}of r)this.binders[x].setUniform(S,u,o.get(x),_)}updatePaintBuffers(e){this._buffers=[];for(const r in this.binders){const o=this.binders[r];if(e&&o instanceof ia){const u=e.fromScale===2?o.zoomInPaintVertexBuffer:o.zoomOutPaintVertexBuffer;u&&this._buffers.push(u)}else(o instanceof Oo||o instanceof Ms)&&o.paintVertexBuffer&&this._buffers.push(o.paintVertexBuffer)}}upload(e){for(const r in this.binders){const o=this.binders[r];(o instanceof Oo||o instanceof Ms||o instanceof ia)&&o.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const r=this.binders[e];(r instanceof Oo||r instanceof Ms||r instanceof ia)&&r.destroy()}}}class Ma{constructor(e,r,o=()=>!0){this.programConfigurations={};for(const u of e)this.programConfigurations[u.id]=new uu(u,r,o);this.needsUpload=!1,this._featureMap=new ta,this._bufferOffset=0}populatePaintArrays(e,r,o,u,_,x){for(const S in this.programConfigurations)this.programConfigurations[S].populatePaintArrays(e,r,u,_,x);r.id!==void 0&&this._featureMap.add(r.id,o,this._bufferOffset,e),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,r,o,u){for(const _ of o)this.needsUpload=this.programConfigurations[_.id].updatePaintArrays(e,this._featureMap,r,_,u)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const r in this.programConfigurations)this.programConfigurations[r].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}function If(i,e){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[i]||[i.replace(`${e}-`,"").replace(/-/g,"_")]}function du(i,e,r){const o={color:{source:ce,composite:yi},number:{source:kt,composite:ce}},u=function(_){return{"line-pattern":{source:Kr,composite:Kr},"fill-pattern":{source:Kr,composite:Kr},"fill-extrusion-pattern":{source:Kr,composite:Kr}}[_]}(i);return u&&u[r]||o[e][r]}Zt("ConstantBinder",ql),Zt("CrossFadedConstantBinder",ll),Zt("SourceExpressionBinder",Oo),Zt("CrossFadedCompositeBinder",ia),Zt("CompositeExpressionBinder",Ms),Zt("ProgramConfiguration",uu,{omit:["_buffers"]}),Zt("ProgramConfigurationSet",Ma);const Br=8192,lh=Math.pow(2,14)-1,fu=-lh-1;function ka(i){const e=Br/i.extent,r=i.loadGeometry();for(let o=0;o<r.length;o++){const u=r[o];for(let _=0;_<u.length;_++){const x=u[_],S=Math.round(x.x*e),A=Math.round(x.y*e);x.x=V(S,fu,lh),x.y=V(A,fu,lh),(S<x.x||S>x.x+1||A<x.y||A>x.y+1)&&ht("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return r}function Oa(i,e){return{type:i.type,id:i.id,properties:i.properties,geometry:e?ka(i):[]}}function Ac(i,e,r,o,u){i.emplaceBack(2*e+(o+1)/2,2*r+(u+1)/2)}class ch{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new rl,this.indexArray=new Gr,this.segments=new Vr,this.programConfigurations=new Ma(e.layers,e.zoom),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,o){const u=this.layers[0],_=[];let x=null,S=!1;u.type==="circle"&&(x=u.layout.get("circle-sort-key"),S=!x.isConstant());for(const{feature:A,id:F,index:R,sourceLayerIndex:j}of e){const W=this.layers[0]._featureFilter.needGeometry,q=Oa(A,W);if(!this.layers[0]._featureFilter.filter(new hr(this.zoom),q,o))continue;const Q=S?x.evaluate(q,{},o):void 0,re={id:F,properties:A.properties,type:A.type,sourceLayerIndex:j,index:R,geometry:W?q.geometry:ka(A),patterns:{},sortKey:Q};_.push(re)}S&&_.sort((A,F)=>A.sortKey-F.sortKey);for(const A of _){const{geometry:F,index:R,sourceLayerIndex:j}=A,W=e[R].feature;this.addFeature(A,F,R,o),r.featureIndex.insert(W,F,R,j,this.index)}}update(e,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Gl),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,r,o,u){for(const _ of r)for(const x of _){const S=x.x,A=x.y;if(S<0||S>=Br||A<0||A>=Br)continue;const F=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),R=F.vertexLength;Ac(this.layoutVertexArray,S,A,-1,-1),Ac(this.layoutVertexArray,S,A,1,-1),Ac(this.layoutVertexArray,S,A,1,1),Ac(this.layoutVertexArray,S,A,-1,1),this.indexArray.emplaceBack(R,R+1,R+2),this.indexArray.emplaceBack(R,R+3,R+2),F.vertexLength+=4,F.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,{},u)}}function pu(i,e){for(let r=0;r<i.length;r++)if(cl(e,i[r]))return!0;for(let r=0;r<e.length;r++)if(cl(i,e[r]))return!0;return!!hh(i,e)}function Af(i,e,r){return!!cl(i,e)||!!uh(e,i,r)}function mu(i,e){if(i.length===1)return _u(e,i[0]);for(let r=0;r<e.length;r++){const o=e[r];for(let u=0;u<o.length;u++)if(cl(i,o[u]))return!0}for(let r=0;r<i.length;r++)if(_u(e,i[r]))return!0;for(let r=0;r<e.length;r++)if(hh(i,e[r]))return!0;return!1}function Mf(i,e,r){if(i.length>1){if(hh(i,e))return!0;for(let o=0;o<e.length;o++)if(uh(e[o],i,r))return!0}for(let o=0;o<i.length;o++)if(uh(i[o],e,r))return!0;return!1}function hh(i,e){if(i.length===0||e.length===0)return!1;for(let r=0;r<i.length-1;r++){const o=i[r],u=i[r+1];for(let _=0;_<e.length-1;_++)if(kf(o,u,e[_],e[_+1]))return!0}return!1}function kf(i,e,r,o){return nt(i,r,o)!==nt(e,r,o)&&nt(i,e,r)!==nt(i,e,o)}function uh(i,e,r){const o=r*r;if(e.length===1)return i.distSqr(e[0])<o;for(let u=1;u<e.length;u++)if(gu(i,e[u-1],e[u])<o)return!0;return!1}function gu(i,e,r){const o=e.distSqr(r);if(o===0)return i.distSqr(e);const u=((i.x-e.x)*(r.x-e.x)+(i.y-e.y)*(r.y-e.y))/o;return i.distSqr(u<0?e:u>1?r:r.sub(e)._mult(u)._add(e))}function _u(i,e){let r,o,u,_=!1;for(let x=0;x<i.length;x++){r=i[x];for(let S=0,A=r.length-1;S<r.length;A=S++)o=r[S],u=r[A],o.y>e.y!=u.y>e.y&&e.x<(u.x-o.x)*(e.y-o.y)/(u.y-o.y)+o.x&&(_=!_)}return _}function cl(i,e){let r=!1;for(let o=0,u=i.length-1;o<i.length;u=o++){const _=i[o],x=i[u];_.y>e.y!=x.y>e.y&&e.x<(x.x-_.x)*(e.y-_.y)/(x.y-_.y)+_.x&&(r=!r)}return r}function Of(i,e,r){const o=r[0],u=r[2];if(i.x<o.x&&e.x<o.x||i.x>u.x&&e.x>u.x||i.y<o.y&&e.y<o.y||i.y>u.y&&e.y>u.y)return!1;const _=nt(i,e,r[0]);return _!==nt(i,e,r[1])||_!==nt(i,e,r[2])||_!==nt(i,e,r[3])}function $l(i,e,r){const o=e.paint.get(i).value;return o.kind==="constant"?o.value:r.programConfigurations.get(e.id).getMaxValue(i)}function Mc(i){return Math.sqrt(i[0]*i[0]+i[1]*i[1])}function kc(i,e,r,o,u){if(!e[0]&&!e[1])return i;const _=l.convert(e)._mult(u);r==="viewport"&&_._rotate(-o);const x=[];for(let S=0;S<i.length;S++)x.push(i[S].sub(_));return x}let yu,vu;Zt("CircleBucket",ch,{omit:["layers"]});var Df={get paint(){return vu=vu||new a({"circle-radius":new gi(ae.paint_circle["circle-radius"]),"circle-color":new gi(ae.paint_circle["circle-color"]),"circle-blur":new gi(ae.paint_circle["circle-blur"]),"circle-opacity":new gi(ae.paint_circle["circle-opacity"]),"circle-translate":new ai(ae.paint_circle["circle-translate"]),"circle-translate-anchor":new ai(ae.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ai(ae.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ai(ae.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new gi(ae.paint_circle["circle-stroke-width"]),"circle-stroke-color":new gi(ae.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new gi(ae.paint_circle["circle-stroke-opacity"])})},get layout(){return yu=yu||new a({"circle-sort-key":new gi(ae.layout_circle["circle-sort-key"])})}},En=1e-6,hl=typeof Float32Array<"u"?Float32Array:Array;function dh(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function xu(i,e,r){var o=e[0],u=e[1],_=e[2],x=e[3],S=e[4],A=e[5],F=e[6],R=e[7],j=e[8],W=e[9],q=e[10],Q=e[11],re=e[12],ue=e[13],we=e[14],Ne=e[15],Ee=r[0],Re=r[1],et=r[2],xt=r[3];return i[0]=Ee*o+Re*S+et*j+xt*re,i[1]=Ee*u+Re*A+et*W+xt*ue,i[2]=Ee*_+Re*F+et*q+xt*we,i[3]=Ee*x+Re*R+et*Q+xt*Ne,i[4]=(Ee=r[4])*o+(Re=r[5])*S+(et=r[6])*j+(xt=r[7])*re,i[5]=Ee*u+Re*A+et*W+xt*ue,i[6]=Ee*_+Re*F+et*q+xt*we,i[7]=Ee*x+Re*R+et*Q+xt*Ne,i[8]=(Ee=r[8])*o+(Re=r[9])*S+(et=r[10])*j+(xt=r[11])*re,i[9]=Ee*u+Re*A+et*W+xt*ue,i[10]=Ee*_+Re*F+et*q+xt*we,i[11]=Ee*x+Re*R+et*Q+xt*Ne,i[12]=(Ee=r[12])*o+(Re=r[13])*S+(et=r[14])*j+(xt=r[15])*re,i[13]=Ee*u+Re*A+et*W+xt*ue,i[14]=Ee*_+Re*F+et*q+xt*we,i[15]=Ee*x+Re*R+et*Q+xt*Ne,i}Math.hypot||(Math.hypot=function(){for(var i=0,e=arguments.length;e--;)i+=arguments[e]*arguments[e];return Math.sqrt(i)});var Yl,Lf=xu;function Oc(i,e,r){var o=e[0],u=e[1],_=e[2],x=e[3];return i[0]=r[0]*o+r[4]*u+r[8]*_+r[12]*x,i[1]=r[1]*o+r[5]*u+r[9]*_+r[13]*x,i[2]=r[2]*o+r[6]*u+r[10]*_+r[14]*x,i[3]=r[3]*o+r[7]*u+r[11]*_+r[15]*x,i}Yl=new hl(4),hl!=Float32Array&&(Yl[0]=0,Yl[1]=0,Yl[2]=0,Yl[3]=0);class Ff extends v{constructor(e){super(e,Df)}createBucket(e){return new ch(e)}queryRadius(e){const r=e;return $l("circle-radius",this,r)+$l("circle-stroke-width",this,r)+Mc(this.paint.get("circle-translate"))}queryIntersectsFeature(e,r,o,u,_,x,S,A){const F=kc(e,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),x.angle,S),R=this.paint.get("circle-radius").evaluate(r,o)+this.paint.get("circle-stroke-width").evaluate(r,o),j=this.paint.get("circle-pitch-alignment")==="map",W=j?F:function(Q,re){return Q.map(ue=>bu(ue,re))}(F,A),q=j?R*S:R;for(const Q of u)for(const re of Q){const ue=j?re:bu(re,A);let we=q;const Ne=Oc([],[re.x,re.y,0,1],A);if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"?we*=Ne[3]/x.cameraToCenterDistance:this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"&&(we*=x.cameraToCenterDistance/Ne[3]),Af(W,ue,we))return!0}return!1}}function bu(i,e){const r=Oc([],[i.x,i.y,0,1],e);return new l(r[0]/r[3],r[1]/r[3])}class wu extends ch{}let Cu;Zt("HeatmapBucket",wu,{omit:["layers"]});var zf={get paint(){return Cu=Cu||new a({"heatmap-radius":new gi(ae.paint_heatmap["heatmap-radius"]),"heatmap-weight":new gi(ae.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ai(ae.paint_heatmap["heatmap-intensity"]),"heatmap-color":new n(ae.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ai(ae.paint_heatmap["heatmap-opacity"])})}};function fh(i,{width:e,height:r},o,u){if(u){if(u instanceof Uint8ClampedArray)u=new Uint8Array(u.buffer);else if(u.length!==e*r*o)throw new RangeError(`mismatched image size. expected: ${u.length} but got: ${e*r*o}`)}else u=new Uint8Array(e*r*o);return i.width=e,i.height=r,i.data=u,i}function Su(i,{width:e,height:r},o){if(e===i.width&&r===i.height)return;const u=fh({},{width:e,height:r},o);ph(i,u,{x:0,y:0},{x:0,y:0},{width:Math.min(i.width,e),height:Math.min(i.height,r)},o),i.width=e,i.height=r,i.data=u.data}function ph(i,e,r,o,u,_){if(u.width===0||u.height===0)return e;if(u.width>i.width||u.height>i.height||r.x>i.width-u.width||r.y>i.height-u.height)throw new RangeError("out of range source coordinates for image copy");if(u.width>e.width||u.height>e.height||o.x>e.width-u.width||o.y>e.height-u.height)throw new RangeError("out of range destination coordinates for image copy");const x=i.data,S=e.data;if(x===S)throw new Error("srcData equals dstData, so image is already copied");for(let A=0;A<u.height;A++){const F=((r.y+A)*i.width+r.x)*_,R=((o.y+A)*e.width+o.x)*_;for(let j=0;j<u.width*_;j++)S[R+j]=x[F+j]}return e}class Zl{constructor(e,r){fh(this,e,1,r)}resize(e){Su(this,e,1)}clone(){return new Zl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,o,u,_){ph(e,r,o,u,_,1)}}class rs{constructor(e,r){fh(this,e,4,r)}resize(e){Su(this,e,4)}replace(e,r){r?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new rs({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,o,u,_){ph(e,r,o,u,_,4)}}function Tu(i){const e={},r=i.resolution||256,o=i.clips?i.clips.length:1,u=i.image||new rs({width:r,height:o});if(Math.log(r)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${r}`);const _=(x,S,A)=>{e[i.evaluationKey]=A;const F=i.expression.evaluate(e);u.data[x+S+0]=Math.floor(255*F.r/F.a),u.data[x+S+1]=Math.floor(255*F.g/F.a),u.data[x+S+2]=Math.floor(255*F.b/F.a),u.data[x+S+3]=Math.floor(255*F.a)};if(i.clips)for(let x=0,S=0;x<o;++x,S+=4*r)for(let A=0,F=0;A<r;A++,F+=4){const R=A/(r-1),{start:j,end:W}=i.clips[x];_(S,F,j*(1-R)+W*R)}else for(let x=0,S=0;x<r;x++,S+=4)_(0,S,x/(r-1));return u}Zt("AlphaImage",Zl),Zt("RGBAImage",rs);class Rf extends v{createBucket(e){return new wu(e)}constructor(e){super(e,zf),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){e==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Tu({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let Eu;var Bf={get paint(){return Eu=Eu||new a({"hillshade-illumination-direction":new ai(ae.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ai(ae.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ai(ae.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ai(ae.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ai(ae.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ai(ae.paint_hillshade["hillshade-accent-color"])})}};class jf extends v{constructor(e){super(e,Bf)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}const Nf=B([{name:"a_pos",components:2,type:"Int16"}],4),{members:Vf}=Nf;var mh={exports:{}};function Dc(i,e,r){r=r||2;var o,u,_,x,S,A,F,R=e&&e.length,j=R?e[0]*r:i.length,W=Pu(i,0,j,r,!0),q=[];if(!W||W.next===W.prev)return q;if(R&&(W=function(re,ue,we,Ne){var Ee,Re,et,xt=[];for(Ee=0,Re=ue.length;Ee<Re;Ee++)(et=Pu(re,ue[Ee]*Ne,Ee<Re-1?ue[Ee+1]*Ne:re.length,Ne,!1))===et.next&&(et.steiner=!0),xt.push(Yf(et));for(xt.sort(Xf),Ee=0;Ee<xt.length;Ee++)we=qf(xt[Ee],we);return we}(i,e,W,r)),i.length>80*r){o=_=i[0],u=x=i[1];for(var Q=r;Q<j;Q+=r)(S=i[Q])<o&&(o=S),(A=i[Q+1])<u&&(u=A),S>_&&(_=S),A>x&&(x=A);F=(F=Math.max(_-o,x-u))!==0?32767/F:0}return Kl(W,q,r,o,u,F,0),q}function Pu(i,e,r,o,u){var _,x;if(u===yh(i,e,r,o)>0)for(_=e;_<r;_+=o)x=Mu(_,i[_],i[_+1],x);else for(_=r-o;_>=e;_-=o)x=Mu(_,i[_],i[_+1],x);return x&&Lc(x,x.next)&&(Ql(x),x=x.next),x}function Da(i,e){if(!i)return i;e||(e=i);var r,o=i;do if(r=!1,o.steiner||!Lc(o,o.next)&&Rr(o.prev,o,o.next)!==0)o=o.next;else{if(Ql(o),(o=e=o.prev)===o.next)break;r=!0}while(r||o!==e);return e}function Kl(i,e,r,o,u,_,x){if(i){!x&&_&&function(R,j,W,q){var Q=R;do Q.z===0&&(Q.z=gh(Q.x,Q.y,j,W,q)),Q.prevZ=Q.prev,Q.nextZ=Q.next,Q=Q.next;while(Q!==R);Q.prevZ.nextZ=null,Q.prevZ=null,function(re){var ue,we,Ne,Ee,Re,et,xt,jt,hi=1;do{for(we=re,re=null,Re=null,et=0;we;){for(et++,Ne=we,xt=0,ue=0;ue<hi&&(xt++,Ne=Ne.nextZ);ue++);for(jt=hi;xt>0||jt>0&&Ne;)xt!==0&&(jt===0||!Ne||we.z<=Ne.z)?(Ee=we,we=we.nextZ,xt--):(Ee=Ne,Ne=Ne.nextZ,jt--),Re?Re.nextZ=Ee:re=Ee,Ee.prevZ=Re,Re=Ee;we=Ne}Re.nextZ=null,hi*=2}while(et>1)}(Q)}(i,o,u,_);for(var S,A,F=i;i.prev!==i.next;)if(S=i.prev,A=i.next,_?Gf(i,o,u,_):Uf(i))e.push(S.i/r|0),e.push(i.i/r|0),e.push(A.i/r|0),Ql(i),i=A.next,F=A.next;else if((i=A)===F){x?x===1?Kl(i=Wf(Da(i),e,r),e,r,o,u,_,2):x===2&&Hf(i,e,r,o,u,_):Kl(Da(i),e,r,o,u,_,1);break}}}function Uf(i){var e=i.prev,r=i,o=i.next;if(Rr(e,r,o)>=0)return!1;for(var u=e.x,_=r.x,x=o.x,S=e.y,A=r.y,F=o.y,R=u<_?u<x?u:x:_<x?_:x,j=S<A?S<F?S:F:A<F?A:F,W=u>_?u>x?u:x:_>x?_:x,q=S>A?S>F?S:F:A>F?A:F,Q=o.next;Q!==e;){if(Q.x>=R&&Q.x<=W&&Q.y>=j&&Q.y<=q&&ul(u,S,_,A,x,F,Q.x,Q.y)&&Rr(Q.prev,Q,Q.next)>=0)return!1;Q=Q.next}return!0}function Gf(i,e,r,o){var u=i.prev,_=i,x=i.next;if(Rr(u,_,x)>=0)return!1;for(var S=u.x,A=_.x,F=x.x,R=u.y,j=_.y,W=x.y,q=S<A?S<F?S:F:A<F?A:F,Q=R<j?R<W?R:W:j<W?j:W,re=S>A?S>F?S:F:A>F?A:F,ue=R>j?R>W?R:W:j>W?j:W,we=gh(q,Q,e,r,o),Ne=gh(re,ue,e,r,o),Ee=i.prevZ,Re=i.nextZ;Ee&&Ee.z>=we&&Re&&Re.z<=Ne;){if(Ee.x>=q&&Ee.x<=re&&Ee.y>=Q&&Ee.y<=ue&&Ee!==u&&Ee!==x&&ul(S,R,A,j,F,W,Ee.x,Ee.y)&&Rr(Ee.prev,Ee,Ee.next)>=0||(Ee=Ee.prevZ,Re.x>=q&&Re.x<=re&&Re.y>=Q&&Re.y<=ue&&Re!==u&&Re!==x&&ul(S,R,A,j,F,W,Re.x,Re.y)&&Rr(Re.prev,Re,Re.next)>=0))return!1;Re=Re.nextZ}for(;Ee&&Ee.z>=we;){if(Ee.x>=q&&Ee.x<=re&&Ee.y>=Q&&Ee.y<=ue&&Ee!==u&&Ee!==x&&ul(S,R,A,j,F,W,Ee.x,Ee.y)&&Rr(Ee.prev,Ee,Ee.next)>=0)return!1;Ee=Ee.prevZ}for(;Re&&Re.z<=Ne;){if(Re.x>=q&&Re.x<=re&&Re.y>=Q&&Re.y<=ue&&Re!==u&&Re!==x&&ul(S,R,A,j,F,W,Re.x,Re.y)&&Rr(Re.prev,Re,Re.next)>=0)return!1;Re=Re.nextZ}return!0}function Wf(i,e,r){var o=i;do{var u=o.prev,_=o.next.next;!Lc(u,_)&&Iu(u,o,o.next,_)&&Jl(u,_)&&Jl(_,u)&&(e.push(u.i/r|0),e.push(o.i/r|0),e.push(_.i/r|0),Ql(o),Ql(o.next),o=i=_),o=o.next}while(o!==i);return Da(o)}function Hf(i,e,r,o,u,_){var x=i;do{for(var S=x.next.next;S!==x.prev;){if(x.i!==S.i&&Zf(x,S)){var A=Au(x,S);return x=Da(x,x.next),A=Da(A,A.next),Kl(x,e,r,o,u,_,0),void Kl(A,e,r,o,u,_,0)}S=S.next}x=x.next}while(x!==i)}function Xf(i,e){return i.x-e.x}function qf(i,e){var r=function(u,_){var x,S=_,A=u.x,F=u.y,R=-1/0;do{if(F<=S.y&&F>=S.next.y&&S.next.y!==S.y){var j=S.x+(F-S.y)*(S.next.x-S.x)/(S.next.y-S.y);if(j<=A&&j>R&&(R=j,x=S.x<S.next.x?S:S.next,j===A))return x}S=S.next}while(S!==_);if(!x)return null;var W,q=x,Q=x.x,re=x.y,ue=1/0;S=x;do A>=S.x&&S.x>=Q&&A!==S.x&&ul(F<re?A:R,F,Q,re,F<re?R:A,F,S.x,S.y)&&(W=Math.abs(F-S.y)/(A-S.x),Jl(S,u)&&(W<ue||W===ue&&(S.x>x.x||S.x===x.x&&$f(x,S)))&&(x=S,ue=W)),S=S.next;while(S!==q);return x}(i,e);if(!r)return e;var o=Au(r,i);return Da(o,o.next),Da(r,r.next)}function $f(i,e){return Rr(i.prev,i,e.prev)<0&&Rr(e.next,i,i.next)<0}function gh(i,e,r,o,u){return(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=(i-r)*u|0)|i<<8))|i<<4))|i<<2))|i<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-o)*u|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Yf(i){var e=i,r=i;do(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next;while(e!==i);return r}function ul(i,e,r,o,u,_,x,S){return(u-x)*(e-S)>=(i-x)*(_-S)&&(i-x)*(o-S)>=(r-x)*(e-S)&&(r-x)*(_-S)>=(u-x)*(o-S)}function Zf(i,e){return i.next.i!==e.i&&i.prev.i!==e.i&&!function(r,o){var u=r;do{if(u.i!==r.i&&u.next.i!==r.i&&u.i!==o.i&&u.next.i!==o.i&&Iu(u,u.next,r,o))return!0;u=u.next}while(u!==r);return!1}(i,e)&&(Jl(i,e)&&Jl(e,i)&&function(r,o){var u=r,_=!1,x=(r.x+o.x)/2,S=(r.y+o.y)/2;do u.y>S!=u.next.y>S&&u.next.y!==u.y&&x<(u.next.x-u.x)*(S-u.y)/(u.next.y-u.y)+u.x&&(_=!_),u=u.next;while(u!==r);return _}(i,e)&&(Rr(i.prev,i,e.prev)||Rr(i,e.prev,e))||Lc(i,e)&&Rr(i.prev,i,i.next)>0&&Rr(e.prev,e,e.next)>0)}function Rr(i,e,r){return(e.y-i.y)*(r.x-e.x)-(e.x-i.x)*(r.y-e.y)}function Lc(i,e){return i.x===e.x&&i.y===e.y}function Iu(i,e,r,o){var u=zc(Rr(i,e,r)),_=zc(Rr(i,e,o)),x=zc(Rr(r,o,i)),S=zc(Rr(r,o,e));return u!==_&&x!==S||!(u!==0||!Fc(i,r,e))||!(_!==0||!Fc(i,o,e))||!(x!==0||!Fc(r,i,o))||!(S!==0||!Fc(r,e,o))}function Fc(i,e,r){return e.x<=Math.max(i.x,r.x)&&e.x>=Math.min(i.x,r.x)&&e.y<=Math.max(i.y,r.y)&&e.y>=Math.min(i.y,r.y)}function zc(i){return i>0?1:i<0?-1:0}function Jl(i,e){return Rr(i.prev,i,i.next)<0?Rr(i,e,i.next)>=0&&Rr(i,i.prev,e)>=0:Rr(i,e,i.prev)<0||Rr(i,i.next,e)<0}function Au(i,e){var r=new _h(i.i,i.x,i.y),o=new _h(e.i,e.x,e.y),u=i.next,_=e.prev;return i.next=e,e.prev=i,r.next=u,u.prev=r,o.next=r,r.prev=o,_.next=o,o.prev=_,o}function Mu(i,e,r,o){var u=new _h(i,e,r);return o?(u.next=o.next,u.prev=o,o.next.prev=u,o.next=u):(u.prev=u,u.next=u),u}function Ql(i){i.next.prev=i.prev,i.prev.next=i.next,i.prevZ&&(i.prevZ.nextZ=i.nextZ),i.nextZ&&(i.nextZ.prevZ=i.prevZ)}function _h(i,e,r){this.i=i,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function yh(i,e,r,o){for(var u=0,_=e,x=r-o;_<r;_+=o)u+=(i[x]-i[_])*(i[_+1]+i[x+1]),x=_;return u}mh.exports=Dc,mh.exports.default=Dc,Dc.deviation=function(i,e,r,o){var u=e&&e.length,_=Math.abs(yh(i,0,u?e[0]*r:i.length,r));if(u)for(var x=0,S=e.length;x<S;x++)_-=Math.abs(yh(i,e[x]*r,x<S-1?e[x+1]*r:i.length,r));var A=0;for(x=0;x<o.length;x+=3){var F=o[x]*r,R=o[x+1]*r,j=o[x+2]*r;A+=Math.abs((i[F]-i[j])*(i[R+1]-i[F+1])-(i[F]-i[R])*(i[j+1]-i[F+1]))}return _===0&&A===0?0:Math.abs((A-_)/_)},Dc.flatten=function(i){for(var e=i[0][0].length,r={vertices:[],holes:[],dimensions:e},o=0,u=0;u<i.length;u++){for(var _=0;_<i[u].length;_++)for(var x=0;x<e;x++)r.vertices.push(i[u][_][x]);u>0&&r.holes.push(o+=i[u-1].length)}return r};var ku=p(mh.exports);function vh(i,e,r){const o=r.patternDependencies;let u=!1;for(const _ of e){const x=_.paint.get(`${i}-pattern`);x.isConstant()||(u=!0);const S=x.constantOr(null);S&&(u=!0,o[S.to]=!0,o[S.from]=!0)}return u}function xh(i,e,r,o,u){const _=u.patternDependencies;for(const x of e){const S=x.paint.get(`${i}-pattern`).value;if(S.kind!=="constant"){let A=S.evaluate({zoom:o-1},r,{},u.availableImages),F=S.evaluate({zoom:o},r,{},u.availableImages),R=S.evaluate({zoom:o+1},r,{},u.availableImages);A=A&&A.name?A.name:A,F=F&&F.name?F.name:F,R=R&&R.name?R.name:R,_[A]=!0,_[F]=!0,_[R]=!0,r.patterns[x.id]={min:A,mid:F,max:R}}}return r}class bh{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Jo,this.indexArray=new Gr,this.indexArray2=new br,this.programConfigurations=new Ma(e.layers,e.zoom),this.segments=new Vr,this.segments2=new Vr,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,o){this.hasPattern=vh("fill",this.layers,r);const u=this.layers[0].layout.get("fill-sort-key"),_=!u.isConstant(),x=[];for(const{feature:S,id:A,index:F,sourceLayerIndex:R}of e){const j=this.layers[0]._featureFilter.needGeometry,W=Oa(S,j);if(!this.layers[0]._featureFilter.filter(new hr(this.zoom),W,o))continue;const q=_?u.evaluate(W,{},o,r.availableImages):void 0,Q={id:A,properties:S.properties,type:S.type,sourceLayerIndex:R,index:F,geometry:j?W.geometry:ka(S),patterns:{},sortKey:q};x.push(Q)}_&&x.sort((S,A)=>S.sortKey-A.sortKey);for(const S of x){const{geometry:A,index:F,sourceLayerIndex:R}=S;if(this.hasPattern){const j=xh("fill",this.layers,S,this.zoom,r);this.patternFeatures.push(j)}else this.addFeature(S,A,F,o,{});r.featureIndex.insert(e[F].feature,A,F,R,this.index)}}update(e,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,o)}addFeatures(e,r,o){for(const u of this.patternFeatures)this.addFeature(u,u.geometry,u.index,r,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Vf),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,r,o,u,_){for(const x of Vs(r,500)){let S=0;for(const q of x)S+=q.length;const A=this.segments.prepareSegment(S,this.layoutVertexArray,this.indexArray),F=A.vertexLength,R=[],j=[];for(const q of x){if(q.length===0)continue;q!==x[0]&&j.push(R.length/2);const Q=this.segments2.prepareSegment(q.length,this.layoutVertexArray,this.indexArray2),re=Q.vertexLength;this.layoutVertexArray.emplaceBack(q[0].x,q[0].y),this.indexArray2.emplaceBack(re+q.length-1,re),R.push(q[0].x),R.push(q[0].y);for(let ue=1;ue<q.length;ue++)this.layoutVertexArray.emplaceBack(q[ue].x,q[ue].y),this.indexArray2.emplaceBack(re+ue-1,re+ue),R.push(q[ue].x),R.push(q[ue].y);Q.vertexLength+=q.length,Q.primitiveLength+=q.length}const W=ku(R,j);for(let q=0;q<W.length;q+=3)this.indexArray.emplaceBack(F+W[q],F+W[q+1],F+W[q+2]);A.vertexLength+=S,A.primitiveLength+=W.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,_,u)}}let Ou,Du;Zt("FillBucket",bh,{omit:["layers","patternFeatures"]});var Kf={get paint(){return Du=Du||new a({"fill-antialias":new ai(ae.paint_fill["fill-antialias"]),"fill-opacity":new gi(ae.paint_fill["fill-opacity"]),"fill-color":new gi(ae.paint_fill["fill-color"]),"fill-outline-color":new gi(ae.paint_fill["fill-outline-color"]),"fill-translate":new ai(ae.paint_fill["fill-translate"]),"fill-translate-anchor":new ai(ae.paint_fill["fill-translate-anchor"]),"fill-pattern":new y(ae.paint_fill["fill-pattern"])})},get layout(){return Ou=Ou||new a({"fill-sort-key":new gi(ae.layout_fill["fill-sort-key"])})}};class Jf extends v{constructor(e){super(e,Kf)}recalculate(e,r){super.recalculate(e,r);const o=this.paint._values["fill-outline-color"];o.value.kind==="constant"&&o.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(e){return new bh(e)}queryRadius(){return Mc(this.paint.get("fill-translate"))}queryIntersectsFeature(e,r,o,u,_,x,S){return mu(kc(e,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),x.angle,S),u)}isTileClipped(){return!0}}const Qf=B([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),ep=B([{name:"a_centroid",components:2,type:"Int16"}],4),{members:tp}=Qf;var ra={},ip=C,Lu=dl;function dl(i,e,r,o,u){this.properties={},this.extent=r,this.type=0,this._pbf=i,this._geometry=-1,this._keys=o,this._values=u,i.readFields(rp,this,e)}function rp(i,e,r){i==1?e.id=r.readVarint():i==2?function(o,u){for(var _=o.readVarint()+o.pos;o.pos<_;){var x=u._keys[o.readVarint()],S=u._values[o.readVarint()];u.properties[x]=S}}(r,e):i==3?e.type=r.readVarint():i==4&&(e._geometry=r.pos)}function np(i){for(var e,r,o=0,u=0,_=i.length,x=_-1;u<_;x=u++)o+=((r=i[x]).x-(e=i[u]).x)*(e.y+r.y);return o}dl.types=["Unknown","Point","LineString","Polygon"],dl.prototype.loadGeometry=function(){var i=this._pbf;i.pos=this._geometry;for(var e,r=i.readVarint()+i.pos,o=1,u=0,_=0,x=0,S=[];i.pos<r;){if(u<=0){var A=i.readVarint();o=7&A,u=A>>3}if(u--,o===1||o===2)_+=i.readSVarint(),x+=i.readSVarint(),o===1&&(e&&S.push(e),e=[]),e.push(new ip(_,x));else{if(o!==7)throw new Error("unknown command "+o);e&&e.push(e[0].clone())}}return e&&S.push(e),S},dl.prototype.bbox=function(){var i=this._pbf;i.pos=this._geometry;for(var e=i.readVarint()+i.pos,r=1,o=0,u=0,_=0,x=1/0,S=-1/0,A=1/0,F=-1/0;i.pos<e;){if(o<=0){var R=i.readVarint();r=7&R,o=R>>3}if(o--,r===1||r===2)(u+=i.readSVarint())<x&&(x=u),u>S&&(S=u),(_+=i.readSVarint())<A&&(A=_),_>F&&(F=_);else if(r!==7)throw new Error("unknown command "+r)}return[x,A,S,F]},dl.prototype.toGeoJSON=function(i,e,r){var o,u,_=this.extent*Math.pow(2,r),x=this.extent*i,S=this.extent*e,A=this.loadGeometry(),F=dl.types[this.type];function R(q){for(var Q=0;Q<q.length;Q++){var re=q[Q];q[Q]=[360*(re.x+x)/_-180,360/Math.PI*Math.atan(Math.exp((180-360*(re.y+S)/_)*Math.PI/180))-90]}}switch(this.type){case 1:var j=[];for(o=0;o<A.length;o++)j[o]=A[o][0];R(A=j);break;case 2:for(o=0;o<A.length;o++)R(A[o]);break;case 3:for(A=function(q){var Q=q.length;if(Q<=1)return[q];for(var re,ue,we=[],Ne=0;Ne<Q;Ne++){var Ee=np(q[Ne]);Ee!==0&&(ue===void 0&&(ue=Ee<0),ue===Ee<0?(re&&we.push(re),re=[q[Ne]]):re.push(q[Ne]))}return re&&we.push(re),we}(A),o=0;o<A.length;o++)for(u=0;u<A[o].length;u++)R(A[o][u])}A.length===1?A=A[0]:F="Multi"+F;var W={type:"Feature",geometry:{type:F,coordinates:A},properties:this.properties};return"id"in this&&(W.id=this.id),W};var sp=Lu,Fu=zu;function zu(i,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=i,this._keys=[],this._values=[],this._features=[],i.readFields(op,this,e),this.length=this._features.length}function op(i,e,r){i===15?e.version=r.readVarint():i===1?e.name=r.readString():i===5?e.extent=r.readVarint():i===2?e._features.push(r.pos):i===3?e._keys.push(r.readString()):i===4&&e._values.push(function(o){for(var u=null,_=o.readVarint()+o.pos;o.pos<_;){var x=o.readVarint()>>3;u=x===1?o.readString():x===2?o.readFloat():x===3?o.readDouble():x===4?o.readVarint64():x===5?o.readVarint():x===6?o.readSVarint():x===7?o.readBoolean():null}return u}(r))}zu.prototype.feature=function(i){if(i<0||i>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[i];var e=this._pbf.readVarint()+this._pbf.pos;return new sp(this._pbf,e,this.extent,this._keys,this._values)};var ap=Fu;function lp(i,e,r){if(i===3){var o=new ap(r,r.readVarint()+r.pos);o.length&&(e[o.name]=o)}}ra.VectorTile=function(i,e){this.layers=i.readFields(lp,{},e)},ra.VectorTileFeature=Lu,ra.VectorTileLayer=Fu;const cp=ra.VectorTileFeature.types,wh=Math.pow(2,13);function ec(i,e,r,o,u,_,x,S){i.emplaceBack(e,r,2*Math.floor(o*wh)+x,u*wh*2,_*wh*2,Math.round(S))}class Ch{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new ko,this.centroidVertexArray=new Mo,this.indexArray=new Gr,this.programConfigurations=new Ma(e.layers,e.zoom),this.segments=new Vr,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,o){this.features=[],this.hasPattern=vh("fill-extrusion",this.layers,r);for(const{feature:u,id:_,index:x,sourceLayerIndex:S}of e){const A=this.layers[0]._featureFilter.needGeometry,F=Oa(u,A);if(!this.layers[0]._featureFilter.filter(new hr(this.zoom),F,o))continue;const R={id:_,sourceLayerIndex:S,index:x,geometry:A?F.geometry:ka(u),properties:u.properties,type:u.type,patterns:{}};this.hasPattern?this.features.push(xh("fill-extrusion",this.layers,R,this.zoom,r)):this.addFeature(R,R.geometry,x,o,{}),r.featureIndex.insert(u,R.geometry,x,S,this.index,!0)}}addFeatures(e,r,o){for(const u of this.features){const{geometry:_}=u;this.addFeature(u,_,u.index,r,o)}}update(e,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,o)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,tp),this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,ep.members,!0),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(e,r,o,u,_){for(const x of Vs(r,500)){const S={x:0,y:0,vertexCount:0};let A=0;for(const Q of x)A+=Q.length;let F=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);for(const Q of x){if(Q.length===0||up(Q))continue;let re=0;for(let ue=0;ue<Q.length;ue++){const we=Q[ue];if(ue>=1){const Ne=Q[ue-1];if(!hp(we,Ne)){F.vertexLength+4>Vr.MAX_VERTEX_ARRAY_LENGTH&&(F=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const Ee=we.sub(Ne)._perp()._unit(),Re=Ne.dist(we);re+Re>32768&&(re=0),ec(this.layoutVertexArray,we.x,we.y,Ee.x,Ee.y,0,0,re),ec(this.layoutVertexArray,we.x,we.y,Ee.x,Ee.y,0,1,re),S.x+=2*we.x,S.y+=2*we.y,S.vertexCount+=2,re+=Re,ec(this.layoutVertexArray,Ne.x,Ne.y,Ee.x,Ee.y,0,0,re),ec(this.layoutVertexArray,Ne.x,Ne.y,Ee.x,Ee.y,0,1,re),S.x+=2*Ne.x,S.y+=2*Ne.y,S.vertexCount+=2;const et=F.vertexLength;this.indexArray.emplaceBack(et,et+2,et+1),this.indexArray.emplaceBack(et+1,et+2,et+3),F.vertexLength+=4,F.primitiveLength+=2}}}}if(F.vertexLength+A>Vr.MAX_VERTEX_ARRAY_LENGTH&&(F=this.segments.prepareSegment(A,this.layoutVertexArray,this.indexArray)),cp[e.type]!=="Polygon")continue;const R=[],j=[],W=F.vertexLength;for(const Q of x)if(Q.length!==0){Q!==x[0]&&j.push(R.length/2);for(let re=0;re<Q.length;re++){const ue=Q[re];ec(this.layoutVertexArray,ue.x,ue.y,0,0,1,1,0),S.x+=ue.x,S.y+=ue.y,S.vertexCount+=1,R.push(ue.x),R.push(ue.y)}}const q=ku(R,j);for(let Q=0;Q<q.length;Q+=3)this.indexArray.emplaceBack(W+q[Q],W+q[Q+2],W+q[Q+1]);F.primitiveLength+=q.length/3,F.vertexLength+=A;for(let Q=0;Q<S.vertexCount;Q++){const re=Math.floor(S.x/S.vertexCount),ue=Math.floor(S.y/S.vertexCount);this.centroidVertexArray.emplaceBack(re,ue)}}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,_,u)}}function hp(i,e){return i.x===e.x&&(i.x<0||i.x>Br)||i.y===e.y&&(i.y<0||i.y>Br)}function up(i){return i.every(e=>e.x<0)||i.every(e=>e.x>Br)||i.every(e=>e.y<0)||i.every(e=>e.y>Br)}let Ru;Zt("FillExtrusionBucket",Ch,{omit:["layers","features"]});var dp={get paint(){return Ru=Ru||new a({"fill-extrusion-opacity":new ai(ae["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new gi(ae["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ai(ae["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ai(ae["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new y(ae["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new gi(ae["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new gi(ae["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new ai(ae["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class fp extends v{constructor(e){super(e,dp)}createBucket(e){return new Ch(e)}queryRadius(){return Mc(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature(e,r,o,u,_,x,S,A){const F=kc(e,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),x.angle,S),R=this.paint.get("fill-extrusion-height").evaluate(r,o),j=this.paint.get("fill-extrusion-base").evaluate(r,o),W=function(Q,re,ue,we){const Ne=[];for(const Ee of Q){const Re=[Ee.x,Ee.y,0,1];Oc(Re,Re,re),Ne.push(new l(Re[0]/Re[3],Re[1]/Re[3]))}return Ne}(F,A),q=function(Q,re,ue,we){const Ne=[],Ee=[],Re=we[8]*re,et=we[9]*re,xt=we[10]*re,jt=we[11]*re,hi=we[8]*ue,Gt=we[9]*ue,Bt=we[10]*ue,oi=we[11]*ue;for(const Kt of Q){const Yt=[],ut=[];for(const li of Kt){const ni=li.x,bi=li.y,or=we[0]*ni+we[4]*bi+we[12],er=we[1]*ni+we[5]*bi+we[13],Wr=we[2]*ni+we[6]*bi+we[14],vs=we[3]*ni+we[7]*bi+we[15],hn=Wr+xt,Or=vs+jt,Pn=or+hi,In=er+Gt,An=Wr+Bt,Dr=vs+oi,Hr=new l((or+Re)/Or,(er+et)/Or);Hr.z=hn/Or,Yt.push(Hr);const yn=new l(Pn/Dr,In/Dr);yn.z=An/Dr,ut.push(yn)}Ne.push(Yt),Ee.push(ut)}return[Ne,Ee]}(u,j,R,A);return function(Q,re,ue){let we=1/0;mu(ue,re)&&(we=Bu(ue,re[0]));for(let Ne=0;Ne<re.length;Ne++){const Ee=re[Ne],Re=Q[Ne];for(let et=0;et<Ee.length-1;et++){const xt=Ee[et],jt=[xt,Ee[et+1],Re[et+1],Re[et],xt];pu(ue,jt)&&(we=Math.min(we,Bu(ue,jt)))}}return we!==1/0&&we}(q[0],q[1],W)}}function tc(i,e){return i.x*e.x+i.y*e.y}function Bu(i,e){if(i.length===1){let r=0;const o=e[r++];let u;for(;!u||o.equals(u);)if(u=e[r++],!u)return 1/0;for(;r<e.length;r++){const _=e[r],x=i[0],S=u.sub(o),A=_.sub(o),F=x.sub(o),R=tc(S,S),j=tc(S,A),W=tc(A,A),q=tc(F,S),Q=tc(F,A),re=R*W-j*j,ue=(W*q-j*Q)/re,we=(R*Q-j*q)/re,Ne=o.z*(1-ue-we)+u.z*ue+_.z*we;if(isFinite(Ne))return Ne}return 1/0}{let r=1/0;for(const o of e)r=Math.min(r,o.z);return r}}const pp=B([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:mp}=pp,gp=B([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:_p}=gp,yp=ra.VectorTileFeature.types,vp=Math.cos(Math.PI/180*37.5),ju=Math.pow(2,14)/.5;class Sh{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(r=>{this.gradients[r.id]={}}),this.layoutVertexArray=new nl,this.layoutVertexArray2=new Ul,this.indexArray=new Gr,this.programConfigurations=new Ma(e.layers,e.zoom),this.segments=new Vr,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,o){this.hasPattern=vh("line",this.layers,r);const u=this.layers[0].layout.get("line-sort-key"),_=!u.isConstant(),x=[];for(const{feature:S,id:A,index:F,sourceLayerIndex:R}of e){const j=this.layers[0]._featureFilter.needGeometry,W=Oa(S,j);if(!this.layers[0]._featureFilter.filter(new hr(this.zoom),W,o))continue;const q=_?u.evaluate(W,{},o):void 0,Q={id:A,properties:S.properties,type:S.type,sourceLayerIndex:R,index:F,geometry:j?W.geometry:ka(S),patterns:{},sortKey:q};x.push(Q)}_&&x.sort((S,A)=>S.sortKey-A.sortKey);for(const S of x){const{geometry:A,index:F,sourceLayerIndex:R}=S;if(this.hasPattern){const j=xh("line",this.layers,S,this.zoom,r);this.patternFeatures.push(j)}else this.addFeature(S,A,F,o,{});r.featureIndex.insert(e[F].feature,A,F,R,this.index)}}update(e,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,o)}addFeatures(e,r,o){for(const u of this.patternFeatures)this.addFeature(u,u.geometry,u.index,r,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,_p)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,mp),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&Object.prototype.hasOwnProperty.call(e.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(e.properties,"mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,r,o,u,_){const x=this.layers[0].layout,S=x.get("line-join").evaluate(e,{}),A=x.get("line-cap"),F=x.get("line-miter-limit"),R=x.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const j of r)this.addLine(j,e,S,A,F,R);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,_,u)}addLine(e,r,o,u,_,x){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let we=0;we<e.length-1;we++)this.totalDistance+=e[we].dist(e[we+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const S=yp[r.type]==="Polygon";let A=e.length;for(;A>=2&&e[A-1].equals(e[A-2]);)A--;let F=0;for(;F<A-1&&e[F].equals(e[F+1]);)F++;if(A<(S?3:2))return;o==="bevel"&&(_=1.05);const R=this.overscaling<=16?15*Br/(512*this.overscaling):0,j=this.segments.prepareSegment(10*A,this.layoutVertexArray,this.indexArray);let W,q,Q,re,ue;this.e1=this.e2=-1,S&&(W=e[A-2],ue=e[F].sub(W)._unit()._perp());for(let we=F;we<A;we++){if(Q=we===A-1?S?e[F+1]:void 0:e[we+1],Q&&e[we].equals(Q))continue;ue&&(re=ue),W&&(q=W),W=e[we],ue=Q?Q.sub(W)._unit()._perp():re,re=re||ue;let Ne=re.add(ue);Ne.x===0&&Ne.y===0||Ne._unit();const Ee=re.x*ue.x+re.y*ue.y,Re=Ne.x*ue.x+Ne.y*ue.y,et=Re!==0?1/Re:1/0,xt=2*Math.sqrt(2-2*Re),jt=Re<vp&&q&&Q,hi=re.x*ue.y-re.y*ue.x>0;if(jt&&we>F){const oi=W.dist(q);if(oi>2*R){const Kt=W.sub(W.sub(q)._mult(R/oi)._round());this.updateDistance(q,Kt),this.addCurrentVertex(Kt,re,0,0,j),q=Kt}}const Gt=q&&Q;let Bt=Gt?o:S?"butt":u;if(Gt&&Bt==="round"&&(et<x?Bt="miter":et<=2&&(Bt="fakeround")),Bt==="miter"&&et>_&&(Bt="bevel"),Bt==="bevel"&&(et>2&&(Bt="flipbevel"),et<_&&(Bt="miter")),q&&this.updateDistance(q,W),Bt==="miter")Ne._mult(et),this.addCurrentVertex(W,Ne,0,0,j);else if(Bt==="flipbevel"){if(et>100)Ne=ue.mult(-1);else{const oi=et*re.add(ue).mag()/re.sub(ue).mag();Ne._perp()._mult(oi*(hi?-1:1))}this.addCurrentVertex(W,Ne,0,0,j),this.addCurrentVertex(W,Ne.mult(-1),0,0,j)}else if(Bt==="bevel"||Bt==="fakeround"){const oi=-Math.sqrt(et*et-1),Kt=hi?oi:0,Yt=hi?0:oi;if(q&&this.addCurrentVertex(W,re,Kt,Yt,j),Bt==="fakeround"){const ut=Math.round(180*xt/Math.PI/20);for(let li=1;li<ut;li++){let ni=li/ut;if(ni!==.5){const or=ni-.5;ni+=ni*or*(ni-1)*((1.0904+Ee*(Ee*(3.55645-1.43519*Ee)-3.2452))*or*or+(.848013+Ee*(.215638*Ee-1.06021)))}const bi=ue.sub(re)._mult(ni)._add(re)._unit()._mult(hi?-1:1);this.addHalfVertex(W,bi.x,bi.y,!1,hi,0,j)}}Q&&this.addCurrentVertex(W,ue,-Kt,-Yt,j)}else if(Bt==="butt")this.addCurrentVertex(W,Ne,0,0,j);else if(Bt==="square"){const oi=q?1:-1;this.addCurrentVertex(W,Ne,oi,oi,j)}else Bt==="round"&&(q&&(this.addCurrentVertex(W,re,0,0,j),this.addCurrentVertex(W,re,1,1,j,!0)),Q&&(this.addCurrentVertex(W,ue,-1,-1,j,!0),this.addCurrentVertex(W,ue,0,0,j)));if(jt&&we<A-1){const oi=W.dist(Q);if(oi>2*R){const Kt=W.add(Q.sub(W)._mult(R/oi)._round());this.updateDistance(W,Kt),this.addCurrentVertex(Kt,ue,0,0,j),W=Kt}}}}addCurrentVertex(e,r,o,u,_,x=!1){const S=r.y*u-r.x,A=-r.y-r.x*u;this.addHalfVertex(e,r.x+r.y*o,r.y-r.x*o,x,!1,o,_),this.addHalfVertex(e,S,A,x,!0,-u,_),this.distance>ju/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(e,r,o,u,_,x))}addHalfVertex({x:e,y:r},o,u,_,x,S,A){const F=.5*(this.lineClips?this.scaledDistance*(ju-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((e<<1)+(_?1:0),(r<<1)+(x?1:0),Math.round(63*o)+128,Math.round(63*u)+128,1+(S===0?0:S<0?-1:1)|(63&F)<<2,F>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const R=A.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,R),A.primitiveLength++),x?this.e2=R:this.e1=R}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(e,r){this.distance+=e.dist(r),this.updateScaledDistance()}}let Nu,Vu;Zt("LineBucket",Sh,{omit:["layers","patternFeatures"]});var Uu={get paint(){return Vu=Vu||new a({"line-opacity":new gi(ae.paint_line["line-opacity"]),"line-color":new gi(ae.paint_line["line-color"]),"line-translate":new ai(ae.paint_line["line-translate"]),"line-translate-anchor":new ai(ae.paint_line["line-translate-anchor"]),"line-width":new gi(ae.paint_line["line-width"]),"line-gap-width":new gi(ae.paint_line["line-gap-width"]),"line-offset":new gi(ae.paint_line["line-offset"]),"line-blur":new gi(ae.paint_line["line-blur"]),"line-dasharray":new t(ae.paint_line["line-dasharray"]),"line-pattern":new y(ae.paint_line["line-pattern"]),"line-gradient":new n(ae.paint_line["line-gradient"])})},get layout(){return Nu=Nu||new a({"line-cap":new ai(ae.layout_line["line-cap"]),"line-join":new gi(ae.layout_line["line-join"]),"line-miter-limit":new ai(ae.layout_line["line-miter-limit"]),"line-round-limit":new ai(ae.layout_line["line-round-limit"]),"line-sort-key":new gi(ae.layout_line["line-sort-key"])})}};class xp extends gi{possiblyEvaluate(e,r){return r=new hr(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,zoomHistory:r.zoomHistory,transition:r.transition}),super.possiblyEvaluate(e,r)}evaluate(e,r,o,u){return r=ne({},r,{zoom:Math.floor(r.zoom)}),super.evaluate(e,r,o,u)}}let Rc;class bp extends v{constructor(e){super(e,Uu),this.gradientVersion=0,Rc||(Rc=new xp(Uu.paint.properties["line-width"].specification),Rc.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(e){if(e==="line-gradient"){const r=this.gradientExpression();this.stepInterpolant=!!function(o){return o._styleExpression!==void 0}(r)&&r._styleExpression.expression instanceof bt,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(e,r){super.recalculate(e,r),this.paint._values["line-floorwidth"]=Rc.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e)}createBucket(e){return new Sh(e)}queryRadius(e){const r=e,o=Gu($l("line-width",this,r),$l("line-gap-width",this,r)),u=$l("line-offset",this,r);return o/2+Math.abs(u)+Mc(this.paint.get("line-translate"))}queryIntersectsFeature(e,r,o,u,_,x,S){const A=kc(e,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),x.angle,S),F=S/2*Gu(this.paint.get("line-width").evaluate(r,o),this.paint.get("line-gap-width").evaluate(r,o)),R=this.paint.get("line-offset").evaluate(r,o);return R&&(u=function(j,W){const q=[];for(let Q=0;Q<j.length;Q++){const re=j[Q],ue=[];for(let we=0;we<re.length;we++){const Ne=re[we-1],Ee=re[we],Re=re[we+1],et=we===0?new l(0,0):Ee.sub(Ne)._unit()._perp(),xt=we===re.length-1?new l(0,0):Re.sub(Ee)._unit()._perp(),jt=et._add(xt)._unit(),hi=jt.x*xt.x+jt.y*xt.y;hi!==0&&jt._mult(1/hi),ue.push(jt._mult(W)._add(Ee))}q.push(ue)}return q}(u,R*S)),function(j,W,q){for(let Q=0;Q<W.length;Q++){const re=W[Q];if(j.length>=3){for(let ue=0;ue<re.length;ue++)if(cl(j,re[ue]))return!0}if(Mf(j,re,q))return!0}return!1}(A,u,F)}isTileClipped(){return!0}}function Gu(i,e){return e>0?e+2*i:i}const wp=B([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Cp=B([{name:"a_projected_pos",components:3,type:"Float32"}],4);B([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Sp=B([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);B([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Wu=B([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Tp=B([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function Ep(i,e,r){return i.sections.forEach(o=>{o.text=function(u,_,x){const S=_.layout.get("text-transform").evaluate(x,{});return S==="uppercase"?u=u.toLocaleUpperCase():S==="lowercase"&&(u=u.toLocaleLowerCase()),io.applyArabicShaping&&(u=io.applyArabicShaping(u)),u}(o.text,e,r)}),i}B([{name:"triangle",components:3,type:"Uint16"}]),B([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),B([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),B([{type:"Float32",name:"offsetX"}]),B([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),B([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);const ic={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};var Ur=24,Hu=Qi,Xu=function(i,e,r,o,u){var _,x,S=8*u-o-1,A=(1<<S)-1,F=A>>1,R=-7,j=r?u-1:0,W=r?-1:1,q=i[e+j];for(j+=W,_=q&(1<<-R)-1,q>>=-R,R+=S;R>0;_=256*_+i[e+j],j+=W,R-=8);for(x=_&(1<<-R)-1,_>>=-R,R+=o;R>0;x=256*x+i[e+j],j+=W,R-=8);if(_===0)_=1-F;else{if(_===A)return x?NaN:1/0*(q?-1:1);x+=Math.pow(2,o),_-=F}return(q?-1:1)*x*Math.pow(2,_-o)},qu=function(i,e,r,o,u,_){var x,S,A,F=8*_-u-1,R=(1<<F)-1,j=R>>1,W=u===23?Math.pow(2,-24)-Math.pow(2,-77):0,q=o?0:_-1,Q=o?1:-1,re=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(S=isNaN(e)?1:0,x=R):(x=Math.floor(Math.log(e)/Math.LN2),e*(A=Math.pow(2,-x))<1&&(x--,A*=2),(e+=x+j>=1?W/A:W*Math.pow(2,1-j))*A>=2&&(x++,A/=2),x+j>=R?(S=0,x=R):x+j>=1?(S=(e*A-1)*Math.pow(2,u),x+=j):(S=e*Math.pow(2,j-1)*Math.pow(2,u),x=0));u>=8;i[r+q]=255&S,q+=Q,S/=256,u-=8);for(x=x<<u|S,F+=u;F>0;i[r+q]=255&x,q+=Q,x/=256,F-=8);i[r+q-Q]|=128*re};function Qi(i){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(i)?i:new Uint8Array(i||0),this.pos=0,this.type=0,this.length=this.buf.length}Qi.Varint=0,Qi.Fixed64=1,Qi.Bytes=2,Qi.Fixed32=5;var Th=4294967296,$u=1/Th,Yu=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function Do(i){return i.type===Qi.Bytes?i.readVarint()+i.pos:i.pos+1}function fl(i,e,r){return r?4294967296*e+(i>>>0):4294967296*(e>>>0)+(i>>>0)}function Zu(i,e,r){var o=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));r.realloc(o);for(var u=r.pos-1;u>=i;u--)r.buf[u+o]=r.buf[u]}function Pp(i,e){for(var r=0;r<i.length;r++)e.writeVarint(i[r])}function Ip(i,e){for(var r=0;r<i.length;r++)e.writeSVarint(i[r])}function Ap(i,e){for(var r=0;r<i.length;r++)e.writeFloat(i[r])}function Mp(i,e){for(var r=0;r<i.length;r++)e.writeDouble(i[r])}function kp(i,e){for(var r=0;r<i.length;r++)e.writeBoolean(i[r])}function Op(i,e){for(var r=0;r<i.length;r++)e.writeFixed32(i[r])}function Dp(i,e){for(var r=0;r<i.length;r++)e.writeSFixed32(i[r])}function Lp(i,e){for(var r=0;r<i.length;r++)e.writeFixed64(i[r])}function Fp(i,e){for(var r=0;r<i.length;r++)e.writeSFixed64(i[r])}function Bc(i,e){return(i[e]|i[e+1]<<8|i[e+2]<<16)+16777216*i[e+3]}function pl(i,e,r){i[r]=e,i[r+1]=e>>>8,i[r+2]=e>>>16,i[r+3]=e>>>24}function Ku(i,e){return(i[e]|i[e+1]<<8|i[e+2]<<16)+(i[e+3]<<24)}Qi.prototype={destroy:function(){this.buf=null},readFields:function(i,e,r){for(r=r||this.length;this.pos<r;){var o=this.readVarint(),u=o>>3,_=this.pos;this.type=7&o,i(u,e,this),this.pos===_&&this.skip(o)}return e},readMessage:function(i,e){return this.readFields(i,e,this.readVarint()+this.pos)},readFixed32:function(){var i=Bc(this.buf,this.pos);return this.pos+=4,i},readSFixed32:function(){var i=Ku(this.buf,this.pos);return this.pos+=4,i},readFixed64:function(){var i=Bc(this.buf,this.pos)+Bc(this.buf,this.pos+4)*Th;return this.pos+=8,i},readSFixed64:function(){var i=Bc(this.buf,this.pos)+Ku(this.buf,this.pos+4)*Th;return this.pos+=8,i},readFloat:function(){var i=Xu(this.buf,this.pos,!0,23,4);return this.pos+=4,i},readDouble:function(){var i=Xu(this.buf,this.pos,!0,52,8);return this.pos+=8,i},readVarint:function(i){var e,r,o=this.buf;return e=127&(r=o[this.pos++]),r<128?e:(e|=(127&(r=o[this.pos++]))<<7,r<128?e:(e|=(127&(r=o[this.pos++]))<<14,r<128?e:(e|=(127&(r=o[this.pos++]))<<21,r<128?e:function(u,_,x){var S,A,F=x.buf;if(S=(112&(A=F[x.pos++]))>>4,A<128||(S|=(127&(A=F[x.pos++]))<<3,A<128)||(S|=(127&(A=F[x.pos++]))<<10,A<128)||(S|=(127&(A=F[x.pos++]))<<17,A<128)||(S|=(127&(A=F[x.pos++]))<<24,A<128)||(S|=(1&(A=F[x.pos++]))<<31,A<128))return fl(u,S,_);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(r=o[this.pos]))<<28,i,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var i=this.readVarint();return i%2==1?(i+1)/-2:i/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var i=this.readVarint()+this.pos,e=this.pos;return this.pos=i,i-e>=12&&Yu?function(r,o,u){return Yu.decode(r.subarray(o,u))}(this.buf,e,i):function(r,o,u){for(var _="",x=o;x<u;){var S,A,F,R=r[x],j=null,W=R>239?4:R>223?3:R>191?2:1;if(x+W>u)break;W===1?R<128&&(j=R):W===2?(192&(S=r[x+1]))==128&&(j=(31&R)<<6|63&S)<=127&&(j=null):W===3?(A=r[x+2],(192&(S=r[x+1]))==128&&(192&A)==128&&((j=(15&R)<<12|(63&S)<<6|63&A)<=2047||j>=55296&&j<=57343)&&(j=null)):W===4&&(A=r[x+2],F=r[x+3],(192&(S=r[x+1]))==128&&(192&A)==128&&(192&F)==128&&((j=(15&R)<<18|(63&S)<<12|(63&A)<<6|63&F)<=65535||j>=1114112)&&(j=null)),j===null?(j=65533,W=1):j>65535&&(j-=65536,_+=String.fromCharCode(j>>>10&1023|55296),j=56320|1023&j),_+=String.fromCharCode(j),x+=W}return _}(this.buf,e,i)},readBytes:function(){var i=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,i);return this.pos=i,e},readPackedVarint:function(i,e){if(this.type!==Qi.Bytes)return i.push(this.readVarint(e));var r=Do(this);for(i=i||[];this.pos<r;)i.push(this.readVarint(e));return i},readPackedSVarint:function(i){if(this.type!==Qi.Bytes)return i.push(this.readSVarint());var e=Do(this);for(i=i||[];this.pos<e;)i.push(this.readSVarint());return i},readPackedBoolean:function(i){if(this.type!==Qi.Bytes)return i.push(this.readBoolean());var e=Do(this);for(i=i||[];this.pos<e;)i.push(this.readBoolean());return i},readPackedFloat:function(i){if(this.type!==Qi.Bytes)return i.push(this.readFloat());var e=Do(this);for(i=i||[];this.pos<e;)i.push(this.readFloat());return i},readPackedDouble:function(i){if(this.type!==Qi.Bytes)return i.push(this.readDouble());var e=Do(this);for(i=i||[];this.pos<e;)i.push(this.readDouble());return i},readPackedFixed32:function(i){if(this.type!==Qi.Bytes)return i.push(this.readFixed32());var e=Do(this);for(i=i||[];this.pos<e;)i.push(this.readFixed32());return i},readPackedSFixed32:function(i){if(this.type!==Qi.Bytes)return i.push(this.readSFixed32());var e=Do(this);for(i=i||[];this.pos<e;)i.push(this.readSFixed32());return i},readPackedFixed64:function(i){if(this.type!==Qi.Bytes)return i.push(this.readFixed64());var e=Do(this);for(i=i||[];this.pos<e;)i.push(this.readFixed64());return i},readPackedSFixed64:function(i){if(this.type!==Qi.Bytes)return i.push(this.readSFixed64());var e=Do(this);for(i=i||[];this.pos<e;)i.push(this.readSFixed64());return i},skip:function(i){var e=7&i;if(e===Qi.Varint)for(;this.buf[this.pos++]>127;);else if(e===Qi.Bytes)this.pos=this.readVarint()+this.pos;else if(e===Qi.Fixed32)this.pos+=4;else{if(e!==Qi.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(i,e){this.writeVarint(i<<3|e)},realloc:function(i){for(var e=this.length||16;e<this.pos+i;)e*=2;if(e!==this.length){var r=new Uint8Array(e);r.set(this.buf),this.buf=r,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(i){this.realloc(4),pl(this.buf,i,this.pos),this.pos+=4},writeSFixed32:function(i){this.realloc(4),pl(this.buf,i,this.pos),this.pos+=4},writeFixed64:function(i){this.realloc(8),pl(this.buf,-1&i,this.pos),pl(this.buf,Math.floor(i*$u),this.pos+4),this.pos+=8},writeSFixed64:function(i){this.realloc(8),pl(this.buf,-1&i,this.pos),pl(this.buf,Math.floor(i*$u),this.pos+4),this.pos+=8},writeVarint:function(i){(i=+i||0)>268435455||i<0?function(e,r){var o,u;if(e>=0?(o=e%4294967296|0,u=e/4294967296|0):(u=~(-e/4294967296),4294967295^(o=~(-e%4294967296))?o=o+1|0:(o=0,u=u+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");r.realloc(10),function(_,x,S){S.buf[S.pos++]=127&_|128,_>>>=7,S.buf[S.pos++]=127&_|128,_>>>=7,S.buf[S.pos++]=127&_|128,_>>>=7,S.buf[S.pos++]=127&_|128,S.buf[S.pos]=127&(_>>>=7)}(o,0,r),function(_,x){var S=(7&_)<<4;x.buf[x.pos++]|=S|((_>>>=3)?128:0),_&&(x.buf[x.pos++]=127&_|((_>>>=7)?128:0),_&&(x.buf[x.pos++]=127&_|((_>>>=7)?128:0),_&&(x.buf[x.pos++]=127&_|((_>>>=7)?128:0),_&&(x.buf[x.pos++]=127&_|((_>>>=7)?128:0),_&&(x.buf[x.pos++]=127&_)))))}(u,r)}(i,this):(this.realloc(4),this.buf[this.pos++]=127&i|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=i>>>7&127))))},writeSVarint:function(i){this.writeVarint(i<0?2*-i-1:2*i)},writeBoolean:function(i){this.writeVarint(!!i)},writeString:function(i){i=String(i),this.realloc(4*i.length),this.pos++;var e=this.pos;this.pos=function(o,u,_){for(var x,S,A=0;A<u.length;A++){if((x=u.charCodeAt(A))>55295&&x<57344){if(!S){x>56319||A+1===u.length?(o[_++]=239,o[_++]=191,o[_++]=189):S=x;continue}if(x<56320){o[_++]=239,o[_++]=191,o[_++]=189,S=x;continue}x=S-55296<<10|x-56320|65536,S=null}else S&&(o[_++]=239,o[_++]=191,o[_++]=189,S=null);x<128?o[_++]=x:(x<2048?o[_++]=x>>6|192:(x<65536?o[_++]=x>>12|224:(o[_++]=x>>18|240,o[_++]=x>>12&63|128),o[_++]=x>>6&63|128),o[_++]=63&x|128)}return _}(this.buf,i,this.pos);var r=this.pos-e;r>=128&&Zu(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r},writeFloat:function(i){this.realloc(4),qu(this.buf,i,this.pos,!0,23,4),this.pos+=4},writeDouble:function(i){this.realloc(8),qu(this.buf,i,this.pos,!0,52,8),this.pos+=8},writeBytes:function(i){var e=i.length;this.writeVarint(e),this.realloc(e);for(var r=0;r<e;r++)this.buf[this.pos++]=i[r]},writeRawMessage:function(i,e){this.pos++;var r=this.pos;i(e,this);var o=this.pos-r;o>=128&&Zu(r,o,this),this.pos=r-1,this.writeVarint(o),this.pos+=o},writeMessage:function(i,e,r){this.writeTag(i,Qi.Bytes),this.writeRawMessage(e,r)},writePackedVarint:function(i,e){e.length&&this.writeMessage(i,Pp,e)},writePackedSVarint:function(i,e){e.length&&this.writeMessage(i,Ip,e)},writePackedBoolean:function(i,e){e.length&&this.writeMessage(i,kp,e)},writePackedFloat:function(i,e){e.length&&this.writeMessage(i,Ap,e)},writePackedDouble:function(i,e){e.length&&this.writeMessage(i,Mp,e)},writePackedFixed32:function(i,e){e.length&&this.writeMessage(i,Op,e)},writePackedSFixed32:function(i,e){e.length&&this.writeMessage(i,Dp,e)},writePackedFixed64:function(i,e){e.length&&this.writeMessage(i,Lp,e)},writePackedSFixed64:function(i,e){e.length&&this.writeMessage(i,Fp,e)},writeBytesField:function(i,e){this.writeTag(i,Qi.Bytes),this.writeBytes(e)},writeFixed32Field:function(i,e){this.writeTag(i,Qi.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(i,e){this.writeTag(i,Qi.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(i,e){this.writeTag(i,Qi.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(i,e){this.writeTag(i,Qi.Fixed64),this.writeSFixed64(e)},writeVarintField:function(i,e){this.writeTag(i,Qi.Varint),this.writeVarint(e)},writeSVarintField:function(i,e){this.writeTag(i,Qi.Varint),this.writeSVarint(e)},writeStringField:function(i,e){this.writeTag(i,Qi.Bytes),this.writeString(e)},writeFloatField:function(i,e){this.writeTag(i,Qi.Fixed32),this.writeFloat(e)},writeDoubleField:function(i,e){this.writeTag(i,Qi.Fixed64),this.writeDouble(e)},writeBooleanField:function(i,e){this.writeVarintField(i,!!e)}};var Eh=p(Hu);const Ph=3;function zp(i,e,r){i===1&&r.readMessage(Rp,e)}function Rp(i,e,r){if(i===3){const{id:o,bitmap:u,width:_,height:x,left:S,top:A,advance:F}=r.readMessage(Bp,{});e.push({id:o,bitmap:new Zl({width:_+2*Ph,height:x+2*Ph},u),metrics:{width:_,height:x,left:S,top:A,advance:F}})}}function Bp(i,e,r){i===1?e.id=r.readVarint():i===2?e.bitmap=r.readBytes():i===3?e.width=r.readVarint():i===4?e.height=r.readVarint():i===5?e.left=r.readSVarint():i===6?e.top=r.readSVarint():i===7&&(e.advance=r.readVarint())}const Ju=Ph;function Qu(i){let e=0,r=0;for(const x of i)e+=x.w*x.h,r=Math.max(r,x.w);i.sort((x,S)=>S.h-x.h);const o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),r),h:1/0}];let u=0,_=0;for(const x of i)for(let S=o.length-1;S>=0;S--){const A=o[S];if(!(x.w>A.w||x.h>A.h)){if(x.x=A.x,x.y=A.y,_=Math.max(_,x.y+x.h),u=Math.max(u,x.x+x.w),x.w===A.w&&x.h===A.h){const F=o.pop();S<o.length&&(o[S]=F)}else x.h===A.h?(A.x+=x.w,A.w-=x.w):x.w===A.w?(A.y+=x.h,A.h-=x.h):(o.push({x:A.x+x.w,y:A.y,w:A.w-x.w,h:x.h}),A.y+=x.h,A.h-=x.h);break}}return{w:u,h:_,fill:e/(u*_)||0}}const jn=1;class Ih{constructor(e,{pixelRatio:r,version:o,stretchX:u,stretchY:_,content:x,textFitWidth:S,textFitHeight:A}){this.paddedRect=e,this.pixelRatio=r,this.stretchX=u,this.stretchY=_,this.content=x,this.version=o,this.textFitWidth=S,this.textFitHeight=A}get tl(){return[this.paddedRect.x+jn,this.paddedRect.y+jn]}get br(){return[this.paddedRect.x+this.paddedRect.w-jn,this.paddedRect.y+this.paddedRect.h-jn]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2*jn)/this.pixelRatio,(this.paddedRect.h-2*jn)/this.pixelRatio]}}class ed{constructor(e,r){const o={},u={};this.haveRenderCallbacks=[];const _=[];this.addImages(e,o,_),this.addImages(r,u,_);const{w:x,h:S}=Qu(_),A=new rs({width:x||1,height:S||1});for(const F in e){const R=e[F],j=o[F].paddedRect;rs.copy(R.data,A,{x:0,y:0},{x:j.x+jn,y:j.y+jn},R.data)}for(const F in r){const R=r[F],j=u[F].paddedRect,W=j.x+jn,q=j.y+jn,Q=R.data.width,re=R.data.height;rs.copy(R.data,A,{x:0,y:0},{x:W,y:q},R.data),rs.copy(R.data,A,{x:0,y:re-1},{x:W,y:q-1},{width:Q,height:1}),rs.copy(R.data,A,{x:0,y:0},{x:W,y:q+re},{width:Q,height:1}),rs.copy(R.data,A,{x:Q-1,y:0},{x:W-1,y:q},{width:1,height:re}),rs.copy(R.data,A,{x:0,y:0},{x:W+Q,y:q},{width:1,height:re})}this.image=A,this.iconPositions=o,this.patternPositions=u}addImages(e,r,o){for(const u in e){const _=e[u],x={x:0,y:0,w:_.data.width+2*jn,h:_.data.height+2*jn};o.push(x),r[u]=new Ih(x,_),_.hasRenderCallback&&this.haveRenderCallbacks.push(u)}}patchUpdatedImages(e,r){e.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const o in e.updatedImages)this.patchUpdatedImage(this.iconPositions[o],e.getImage(o),r),this.patchUpdatedImage(this.patternPositions[o],e.getImage(o),r)}patchUpdatedImage(e,r,o){if(!e||!r||e.version===r.version)return;e.version=r.version;const[u,_]=e.tl;o.update(r.data,void 0,{x:u,y:_})}}var na;Zt("ImagePosition",Ih),Zt("ImageAtlas",ed),N.ah=void 0,(na=N.ah||(N.ah={}))[na.none=0]="none",na[na.horizontal=1]="horizontal",na[na.vertical=2]="vertical",na[na.horizontalOnly=3]="horizontalOnly";const rc=-17;class nc{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(e,r){const o=new nc;return o.scale=e||1,o.fontStack=r,o}static forImage(e){const r=new nc;return r.imageName=e,r}}class ml{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,r){const o=new ml;for(let u=0;u<e.sections.length;u++){const _=e.sections[u];_.image?o.addImageSection(_):o.addTextSection(_,r)}return o}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSectionIndex(e){return this.sectionIndex[e]}getCharCode(e){return this.text.charCodeAt(e)}verticalizePunctuation(){this.text=function(e){let r="";for(let o=0;o<e.length;o++){const u=e.charCodeAt(o+1)||null,_=e.charCodeAt(o-1)||null;r+=u&&wc(u)&&!ic[e[o+1]]||_&&wc(_)&&!ic[e[o-1]]||!ic[e[o]]?e[o]:ic[e[o]]}return r}(this.text)}trim(){let e=0;for(let o=0;o<this.text.length&&Nc[this.text.charCodeAt(o)];o++)e++;let r=this.text.length;for(let o=this.text.length-1;o>=0&&o>=e&&Nc[this.text.charCodeAt(o)];o--)r--;this.text=this.text.substring(e,r),this.sectionIndex=this.sectionIndex.slice(e,r)}substring(e,r){const o=new ml;return o.text=this.text.substring(e,r),o.sectionIndex=this.sectionIndex.slice(e,r),o.sections=this.sections,o}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,r)=>Math.max(e,this.sections[r].scale),0)}addTextSection(e,r){this.text+=e.text,this.sections.push(nc.forText(e.scale,e.fontStack||r));const o=this.sections.length-1;for(let u=0;u<e.text.length;++u)this.sectionIndex.push(o)}addImageSection(e){const r=e.image?e.image.name:"";if(r.length===0)return void ht("Can't add FormattedSection with an empty image.");const o=this.getNextImageSectionCharCode();o?(this.text+=String.fromCharCode(o),this.sections.push(nc.forImage(r)),this.sectionIndex.push(this.sections.length-1)):ht("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function jc(i,e,r,o,u,_,x,S,A,F,R,j,W,q,Q){const re=ml.fromFeature(i,u);let ue;j===N.ah.vertical&&re.verticalizePunctuation();const{processBidirectionalText:we,processStyledBidirectionalText:Ne}=io;if(we&&re.sections.length===1){ue=[];const et=we(re.toString(),Ah(re,F,_,e,o,q));for(const xt of et){const jt=new ml;jt.text=xt,jt.sections=re.sections;for(let hi=0;hi<xt.length;hi++)jt.sectionIndex.push(0);ue.push(jt)}}else if(Ne){ue=[];const et=Ne(re.text,re.sectionIndex,Ah(re,F,_,e,o,q));for(const xt of et){const jt=new ml;jt.text=xt[0],jt.sectionIndex=xt[1],jt.sections=re.sections,ue.push(jt)}}else ue=function(et,xt){const jt=[],hi=et.text;let Gt=0;for(const Bt of xt)jt.push(et.substring(Gt,Bt)),Gt=Bt;return Gt<hi.length&&jt.push(et.substring(Gt,hi.length)),jt}(re,Ah(re,F,_,e,o,q));const Ee=[],Re={positionedLines:Ee,text:re.toString(),top:R[1],bottom:R[1],left:R[0],right:R[0],writingMode:j,iconsInText:!1,verticalizable:!1};return function(et,xt,jt,hi,Gt,Bt,oi,Kt,Yt,ut,li,ni){let bi=0,or=rc,er=0,Wr=0;const vs=Kt==="right"?1:Kt==="left"?0:.5;let hn=0;for(const Dr of Gt){Dr.trim();const Hr=Dr.getMaxScale(),yn=(Hr-1)*Ur,un={positionedGlyphs:[],lineOffset:0};et.positionedLines[hn]=un;const Mn=un.positionedGlyphs;let dn=0;if(!Dr.length()){or+=Bt,++hn;continue}for(let Nn=0;Nn<Dr.length();Nn++){const Ui=Dr.getSection(Nn),ur=Dr.getSectionIndex(Nn),_r=Dr.getCharCode(Nn);let qn=0,Ar=null,vl=null,oo=null,ao=Ur;const xs=!(Yt===N.ah.horizontal||!li&&!jl(_r)||li&&(Nc[_r]||(Or=_r,Wt.Arabic(Or)||Wt["Arabic Supplement"](Or)||Wt["Arabic Extended-A"](Or)||Wt["Arabic Presentation Forms-A"](Or)||Wt["Arabic Presentation Forms-B"](Or))));if(Ui.imageName){const os=hi[Ui.imageName];if(!os)continue;oo=Ui.imageName,et.iconsInText=et.iconsInText||!0,vl=os.paddedRect;const Jr=os.displaySize;Ui.scale=Ui.scale*Ur/ni,Ar={width:Jr[0],height:Jr[1],left:jn,top:-Ju,advance:xs?Jr[1]:Jr[0]},qn=yn+(Ur-Jr[1]*Ui.scale),ao=Ar.advance;const Lo=xs?Jr[0]*Ui.scale-Ur*Hr:Jr[1]*Ui.scale-Ur*Hr;Lo>0&&Lo>dn&&(dn=Lo)}else{const os=jt[Ui.fontStack],Jr=os&&os[_r];if(Jr&&Jr.rect)vl=Jr.rect,Ar=Jr.metrics;else{const Lo=xt[Ui.fontStack],cc=Lo&&Lo[_r];if(!cc)continue;Ar=cc.metrics}qn=(Hr-Ui.scale)*Ur}xs?(et.verticalizable=!0,Mn.push({glyph:_r,imageName:oo,x:bi,y:or+qn,vertical:xs,scale:Ui.scale,fontStack:Ui.fontStack,sectionIndex:ur,metrics:Ar,rect:vl}),bi+=ao*Ui.scale+ut):(Mn.push({glyph:_r,imageName:oo,x:bi,y:or+qn,vertical:xs,scale:Ui.scale,fontStack:Ui.fontStack,sectionIndex:ur,metrics:Ar,rect:vl}),bi+=Ar.advance*Ui.scale+ut)}Mn.length!==0&&(er=Math.max(bi-ut,er),Up(Mn,0,Mn.length-1,vs,dn)),bi=0;const ss=Bt*Hr+dn;un.lineOffset=Math.max(dn,yn),or+=ss,Wr=Math.max(ss,Wr),++hn}var Or;const Pn=or-rc,{horizontalAlign:In,verticalAlign:An}=Mh(oi);(function(Dr,Hr,yn,un,Mn,dn,ss,Nn,Ui){const ur=(Hr-yn)*Mn;let _r=0;_r=dn!==ss?-Nn*un-rc:(-un*Ui+.5)*ss;for(const qn of Dr)for(const Ar of qn.positionedGlyphs)Ar.x+=ur,Ar.y+=_r})(et.positionedLines,vs,In,An,er,Wr,Bt,Pn,Gt.length),et.top+=-An*Pn,et.bottom=et.top+Pn,et.left+=-In*er,et.right=et.left+er}(Re,e,r,o,ue,x,S,A,j,F,W,Q),!function(et){for(const xt of et)if(xt.positionedGlyphs.length!==0)return!1;return!0}(Ee)&&Re}const Nc={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},jp={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},Np={40:!0};function td(i,e,r,o,u,_){if(e.imageName){const x=o[e.imageName];return x?x.displaySize[0]*e.scale*Ur/_+u:0}{const x=r[e.fontStack],S=x&&x[i];return S?S.metrics.advance*e.scale+u:0}}function id(i,e,r,o){const u=Math.pow(i-e,2);return o?i<e?u/2:2*u:u+Math.abs(r)*r}function Vp(i,e,r){let o=0;return i===10&&(o-=1e4),r&&(o+=150),i!==40&&i!==65288||(o+=50),e!==41&&e!==65289||(o+=50),o}function rd(i,e,r,o,u,_){let x=null,S=id(e,r,u,_);for(const A of o){const F=id(e-A.x,r,u,_)+A.badness;F<=S&&(x=A,S=F)}return{index:i,x:e,priorBreak:x,badness:S}}function nd(i){return i?nd(i.priorBreak).concat(i.index):[]}function Ah(i,e,r,o,u,_){if(!i)return[];const x=[],S=function(j,W,q,Q,re,ue){let we=0;for(let Ne=0;Ne<j.length();Ne++){const Ee=j.getSection(Ne);we+=td(j.getCharCode(Ne),Ee,Q,re,W,ue)}return we/Math.max(1,Math.ceil(we/q))}(i,e,r,o,u,_),A=i.text.indexOf("")>=0;let F=0;for(let j=0;j<i.length();j++){const W=i.getSection(j),q=i.getCharCode(j);if(Nc[q]||(F+=td(q,W,o,u,e,_)),j<i.length()-1){const Q=!((R=q)<11904||!(Wt["Bopomofo Extended"](R)||Wt.Bopomofo(R)||Wt["CJK Compatibility Forms"](R)||Wt["CJK Compatibility Ideographs"](R)||Wt["CJK Compatibility"](R)||Wt["CJK Radicals Supplement"](R)||Wt["CJK Strokes"](R)||Wt["CJK Symbols and Punctuation"](R)||Wt["CJK Unified Ideographs Extension A"](R)||Wt["CJK Unified Ideographs"](R)||Wt["Enclosed CJK Letters and Months"](R)||Wt["Halfwidth and Fullwidth Forms"](R)||Wt.Hiragana(R)||Wt["Ideographic Description Characters"](R)||Wt["Kangxi Radicals"](R)||Wt["Katakana Phonetic Extensions"](R)||Wt.Katakana(R)||Wt["Vertical Forms"](R)||Wt["Yi Radicals"](R)||Wt["Yi Syllables"](R)));(jp[q]||Q||W.imageName||j!==i.length()-2&&Np[i.getCharCode(j+1)])&&x.push(rd(j+1,F,S,x,Vp(q,i.getCharCode(j+1),Q&&A),!1))}}var R;return nd(rd(i.length(),F,S,x,0,!0))}function Mh(i){let e=.5,r=.5;switch(i){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(i){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:e,verticalAlign:r}}function Up(i,e,r,o,u){if(!o&&!u)return;const _=i[r],x=(i[r].x+_.metrics.advance*_.scale)*o;for(let S=e;S<=r;S++)i[S].x-=x,i[S].y+=u}function Gp(i,e,r){const{horizontalAlign:o,verticalAlign:u}=Mh(r),_=e[0]-i.displaySize[0]*o,x=e[1]-i.displaySize[1]*u;return{image:i,top:x,bottom:x+i.displaySize[1],left:_,right:_+i.displaySize[0]}}function sd(i){var e,r;let o=i.left,u=i.top,_=i.right-o,x=i.bottom-u;const S=(e=i.image.textFitWidth)!==null&&e!==void 0?e:"stretchOrShrink",A=(r=i.image.textFitHeight)!==null&&r!==void 0?r:"stretchOrShrink",F=(i.image.content[2]-i.image.content[0])/(i.image.content[3]-i.image.content[1]);if(A==="proportional"){if(S==="stretchOnly"&&_/x<F||S==="proportional"){const R=Math.ceil(x*F);o*=R/_,_=R}}else if(S==="proportional"&&A==="stretchOnly"&&F!==0&&_/x>F){const R=Math.ceil(_/F);u*=R/x,x=R}return{x1:o,y1:u,x2:o+_,y2:u+x}}function od(i,e,r,o,u,_){const x=i.image;let S;if(x.content){const ue=x.content,we=x.pixelRatio||1;S=[ue[0]/we,ue[1]/we,x.displaySize[0]-ue[2]/we,x.displaySize[1]-ue[3]/we]}const A=e.left*_,F=e.right*_;let R,j,W,q;r==="width"||r==="both"?(q=u[0]+A-o[3],j=u[0]+F+o[1]):(q=u[0]+(A+F-x.displaySize[0])/2,j=q+x.displaySize[0]);const Q=e.top*_,re=e.bottom*_;return r==="height"||r==="both"?(R=u[1]+Q-o[0],W=u[1]+re+o[2]):(R=u[1]+(Q+re-x.displaySize[1])/2,W=R+x.displaySize[1]),{image:x,top:R,right:j,bottom:W,left:q,collisionPadding:S}}const sc=255,so=128,sa=sc*so;function ad(i,e){const{expression:r}=e;if(r.kind==="constant")return{kind:"constant",layoutSize:r.evaluate(new hr(i+1))};if(r.kind==="source")return{kind:"source"};{const{zoomStops:o,interpolationType:u}=r;let _=0;for(;_<o.length&&o[_]<=i;)_++;_=Math.max(0,_-1);let x=_;for(;x<o.length&&o[x]<i+1;)x++;x=Math.min(o.length-1,x);const S=o[_],A=o[x];return r.kind==="composite"?{kind:"composite",minZoom:S,maxZoom:A,interpolationType:u}:{kind:"camera",minZoom:S,maxZoom:A,minSize:r.evaluate(new hr(S)),maxSize:r.evaluate(new hr(A)),interpolationType:u}}}function kh(i,e,r){let o="never";const u=i.get(e);return u?o=u:i.get(r)&&(o="always"),o}const Wp=ra.VectorTileFeature.types,Hp=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Vc(i,e,r,o,u,_,x,S,A,F,R,j,W){const q=S?Math.min(sa,Math.round(S[0])):0,Q=S?Math.min(sa,Math.round(S[1])):0;i.emplaceBack(e,r,Math.round(32*o),Math.round(32*u),_,x,(q<<1)+(A?1:0),Q,16*F,16*R,256*j,256*W)}function Oh(i,e,r){i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r)}function Xp(i){for(const e of i.sections)if(Nl(e.text))return!0;return!1}class Dh{constructor(e){this.layoutVertexArray=new is,this.indexArray=new Gr,this.programConfigurations=e,this.segments=new Vr,this.dynamicLayoutVertexArray=new ro,this.opacityVertexArray=new Qo,this.hasVisibleVertices=!1,this.placedSymbolArray=new mr}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(e,r,o,u){this.isEmpty()||(o&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,wp.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,r),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,Cp.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,Hp,!0),this.opacityVertexBuffer.itemSize=1),(o||u)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}Zt("SymbolBuffers",Dh);class Lh{constructor(e,r,o){this.layoutVertexArray=new e,this.layoutAttributes=r,this.indexArray=new o,this.segments=new Vr,this.collisionVertexArray=new ln}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,Sp.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}Zt("CollisionBuffers",Lh);class gl{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(x=>x.id),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=dh([]),this.placementViewportMatrix=dh([]);const r=this.layers[0]._unevaluatedLayout._values;this.textSizeData=ad(this.zoom,r["text-size"]),this.iconSizeData=ad(this.zoom,r["icon-size"]);const o=this.layers[0].layout,u=o.get("symbol-sort-key"),_=o.get("symbol-z-order");this.canOverlap=kh(o,"text-overlap","text-allow-overlap")!=="never"||kh(o,"icon-overlap","icon-allow-overlap")!=="never"||o.get("text-ignore-placement")||o.get("icon-ignore-placement"),this.sortFeaturesByKey=_!=="viewport-y"&&!u.isConstant(),this.sortFeaturesByY=(_==="viewport-y"||_==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,o.get("symbol-placement")==="point"&&(this.writingModes=o.get("text-writing-mode").map(x=>N.ah[x])),this.stateDependentLayerIds=this.layers.filter(x=>x.isStateDependent()).map(x=>x.id),this.sourceID=e.sourceID}createArrays(){this.text=new Dh(new Ma(this.layers,this.zoom,e=>/^text/.test(e))),this.icon=new Dh(new Ma(this.layers,this.zoom,e=>/^icon/.test(e))),this.glyphOffsetArray=new gr,this.lineVertexArray=new Tn,this.symbolInstances=new es,this.textAnchorOffsets=new sn}calculateGlyphDependencies(e,r,o,u,_){for(let x=0;x<e.length;x++)if(r[e.charCodeAt(x)]=!0,(o||u)&&_){const S=ic[e.charAt(x)];S&&(r[S.charCodeAt(0)]=!0)}}populate(e,r,o){const u=this.layers[0],_=u.layout,x=_.get("text-font"),S=_.get("text-field"),A=_.get("icon-image"),F=(S.value.kind!=="constant"||S.value.value instanceof Wi&&!S.value.value.isEmpty()||S.value.value.toString().length>0)&&(x.value.kind!=="constant"||x.value.value.length>0),R=A.value.kind!=="constant"||!!A.value.value||Object.keys(A.parameters).length>0,j=_.get("symbol-sort-key");if(this.features=[],!F&&!R)return;const W=r.iconDependencies,q=r.glyphDependencies,Q=r.availableImages,re=new hr(this.zoom);for(const{feature:ue,id:we,index:Ne,sourceLayerIndex:Ee}of e){const Re=u._featureFilter.needGeometry,et=Oa(ue,Re);if(!u._featureFilter.filter(re,et,o))continue;let xt,jt;if(Re||(et.geometry=ka(ue)),F){const Gt=u.getValueAndResolveTokens("text-field",et,o,Q),Bt=Wi.factory(Gt),oi=this.hasRTLText=this.hasRTLText||Xp(Bt);(!oi||io.getRTLTextPluginStatus()==="unavailable"||oi&&io.isParsed())&&(xt=Ep(Bt,u,et))}if(R){const Gt=u.getValueAndResolveTokens("icon-image",et,o,Q);jt=Gt instanceof Sr?Gt:Sr.fromString(Gt)}if(!xt&&!jt)continue;const hi=this.sortFeaturesByKey?j.evaluate(et,{},o):void 0;if(this.features.push({id:we,text:xt,icon:jt,index:Ne,sourceLayerIndex:Ee,geometry:et.geometry,properties:ue.properties,type:Wp[ue.type],sortKey:hi}),jt&&(W[jt.name]=!0),xt){const Gt=x.evaluate(et,{},o).join(","),Bt=_.get("text-rotation-alignment")!=="viewport"&&_.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(N.ah.vertical)>=0;for(const oi of xt.sections)if(oi.image)W[oi.image.name]=!0;else{const Kt=Bl(xt.toString()),Yt=oi.fontStack||Gt,ut=q[Yt]=q[Yt]||{};this.calculateGlyphDependencies(oi.text,ut,Bt,this.allowVerticalPlacement,Kt)}}}_.get("symbol-placement")==="line"&&(this.features=function(ue){const we={},Ne={},Ee=[];let Re=0;function et(Gt){Ee.push(ue[Gt]),Re++}function xt(Gt,Bt,oi){const Kt=Ne[Gt];return delete Ne[Gt],Ne[Bt]=Kt,Ee[Kt].geometry[0].pop(),Ee[Kt].geometry[0]=Ee[Kt].geometry[0].concat(oi[0]),Kt}function jt(Gt,Bt,oi){const Kt=we[Bt];return delete we[Bt],we[Gt]=Kt,Ee[Kt].geometry[0].shift(),Ee[Kt].geometry[0]=oi[0].concat(Ee[Kt].geometry[0]),Kt}function hi(Gt,Bt,oi){const Kt=oi?Bt[0][Bt[0].length-1]:Bt[0][0];return`${Gt}:${Kt.x}:${Kt.y}`}for(let Gt=0;Gt<ue.length;Gt++){const Bt=ue[Gt],oi=Bt.geometry,Kt=Bt.text?Bt.text.toString():null;if(!Kt){et(Gt);continue}const Yt=hi(Kt,oi),ut=hi(Kt,oi,!0);if(Yt in Ne&&ut in we&&Ne[Yt]!==we[ut]){const li=jt(Yt,ut,oi),ni=xt(Yt,ut,Ee[li].geometry);delete we[Yt],delete Ne[ut],Ne[hi(Kt,Ee[ni].geometry,!0)]=ni,Ee[li].geometry=null}else Yt in Ne?xt(Yt,ut,oi):ut in we?jt(Yt,ut,oi):(et(Gt),we[Yt]=Re-1,Ne[ut]=Re-1)}return Ee.filter(Gt=>Gt.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((ue,we)=>ue.sortKey-we.sortKey)}update(e,r,o){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(e,r,this.layers,o),this.icon.programConfigurations.updatePaintArrays(e,r,this.layers,o))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,r){const o=this.lineVertexArray.length;if(e.segment!==void 0){let u=e.dist(r[e.segment+1]),_=e.dist(r[e.segment]);const x={};for(let S=e.segment+1;S<r.length;S++)x[S]={x:r[S].x,y:r[S].y,tileUnitDistanceFromAnchor:u},S<r.length-1&&(u+=r[S+1].dist(r[S]));for(let S=e.segment||0;S>=0;S--)x[S]={x:r[S].x,y:r[S].y,tileUnitDistanceFromAnchor:_},S>0&&(_+=r[S-1].dist(r[S]));for(let S=0;S<r.length;S++){const A=x[S];this.lineVertexArray.emplaceBack(A.x,A.y,A.tileUnitDistanceFromAnchor)}}return{lineStartIndex:o,lineLength:this.lineVertexArray.length-o}}addSymbols(e,r,o,u,_,x,S,A,F,R,j,W){const q=e.indexArray,Q=e.layoutVertexArray,re=e.segments.prepareSegment(4*r.length,Q,q,this.canOverlap?x.sortKey:void 0),ue=this.glyphOffsetArray.length,we=re.vertexLength,Ne=this.allowVerticalPlacement&&S===N.ah.vertical?Math.PI/2:0,Ee=x.text&&x.text.sections;for(let Re=0;Re<r.length;Re++){const{tl:et,tr:xt,bl:jt,br:hi,tex:Gt,pixelOffsetTL:Bt,pixelOffsetBR:oi,minFontScaleX:Kt,minFontScaleY:Yt,glyphOffset:ut,isSDF:li,sectionIndex:ni}=r[Re],bi=re.vertexLength,or=ut[1];Vc(Q,A.x,A.y,et.x,or+et.y,Gt.x,Gt.y,o,li,Bt.x,Bt.y,Kt,Yt),Vc(Q,A.x,A.y,xt.x,or+xt.y,Gt.x+Gt.w,Gt.y,o,li,oi.x,Bt.y,Kt,Yt),Vc(Q,A.x,A.y,jt.x,or+jt.y,Gt.x,Gt.y+Gt.h,o,li,Bt.x,oi.y,Kt,Yt),Vc(Q,A.x,A.y,hi.x,or+hi.y,Gt.x+Gt.w,Gt.y+Gt.h,o,li,oi.x,oi.y,Kt,Yt),Oh(e.dynamicLayoutVertexArray,A,Ne),q.emplaceBack(bi,bi+1,bi+2),q.emplaceBack(bi+1,bi+2,bi+3),re.vertexLength+=4,re.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(ut[0]),Re!==r.length-1&&ni===r[Re+1].sectionIndex||e.programConfigurations.populatePaintArrays(Q.length,x,x.index,{},W,Ee&&Ee[ni])}e.placedSymbolArray.emplaceBack(A.x,A.y,ue,this.glyphOffsetArray.length-ue,we,F,R,A.segment,o?o[0]:0,o?o[1]:0,u[0],u[1],S,0,!1,0,j)}_addCollisionDebugVertex(e,r,o,u,_,x){return r.emplaceBack(0,0),e.emplaceBack(o.x,o.y,u,_,Math.round(x.x),Math.round(x.y))}addCollisionDebugVertices(e,r,o,u,_,x,S){const A=_.segments.prepareSegment(4,_.layoutVertexArray,_.indexArray),F=A.vertexLength,R=_.layoutVertexArray,j=_.collisionVertexArray,W=S.anchorX,q=S.anchorY;this._addCollisionDebugVertex(R,j,x,W,q,new l(e,r)),this._addCollisionDebugVertex(R,j,x,W,q,new l(o,r)),this._addCollisionDebugVertex(R,j,x,W,q,new l(o,u)),this._addCollisionDebugVertex(R,j,x,W,q,new l(e,u)),A.vertexLength+=4;const Q=_.indexArray;Q.emplaceBack(F,F+1),Q.emplaceBack(F+1,F+2),Q.emplaceBack(F+2,F+3),Q.emplaceBack(F+3,F),A.primitiveLength+=4}addDebugCollisionBoxes(e,r,o,u){for(let _=e;_<r;_++){const x=this.collisionBoxArray.get(_);this.addCollisionDebugVertices(x.x1,x.y1,x.x2,x.y2,u?this.textCollisionBox:this.iconCollisionBox,x.anchorPoint,o)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Lh(an,Wu.members,br),this.iconCollisionBox=new Lh(an,Wu.members,br);for(let e=0;e<this.symbolInstances.length;e++){const r=this.symbolInstances.get(e);this.addDebugCollisionBoxes(r.textBoxStartIndex,r.textBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.verticalTextBoxStartIndex,r.verticalTextBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.iconBoxStartIndex,r.iconBoxEndIndex,r,!1),this.addDebugCollisionBoxes(r.verticalIconBoxStartIndex,r.verticalIconBoxEndIndex,r,!1)}}_deserializeCollisionBoxesForSymbol(e,r,o,u,_,x,S,A,F){const R={};for(let j=r;j<o;j++){const W=e.get(j);R.textBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,anchorPointX:W.anchorPointX,anchorPointY:W.anchorPointY},R.textFeatureIndex=W.featureIndex;break}for(let j=u;j<_;j++){const W=e.get(j);R.verticalTextBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,anchorPointX:W.anchorPointX,anchorPointY:W.anchorPointY},R.verticalTextFeatureIndex=W.featureIndex;break}for(let j=x;j<S;j++){const W=e.get(j);R.iconBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,anchorPointX:W.anchorPointX,anchorPointY:W.anchorPointY},R.iconFeatureIndex=W.featureIndex;break}for(let j=A;j<F;j++){const W=e.get(j);R.verticalIconBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,anchorPointX:W.anchorPointX,anchorPointY:W.anchorPointY},R.verticalIconFeatureIndex=W.featureIndex;break}return R}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let r=0;r<this.symbolInstances.length;r++){const o=this.symbolInstances.get(r);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,o.textBoxStartIndex,o.textBoxEndIndex,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o.iconBoxStartIndex,o.iconBoxEndIndex,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(e,r){const o=e.placedSymbolArray.get(r),u=o.vertexStartIndex+4*o.numGlyphs;for(let _=o.vertexStartIndex;_<u;_+=4)e.indexArray.emplaceBack(_,_+1,_+2),e.indexArray.emplaceBack(_+1,_+2,_+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const r=Math.sin(e),o=Math.cos(e),u=[],_=[],x=[];for(let S=0;S<this.symbolInstances.length;++S){x.push(S);const A=this.symbolInstances.get(S);u.push(0|Math.round(r*A.anchorX+o*A.anchorY)),_.push(A.featureIndex)}return x.sort((S,A)=>u[S]-u[A]||_[A]-_[S]),x}addToSortKeyRanges(e,r){const o=this.sortKeyRanges[this.sortKeyRanges.length-1];o&&o.sortKey===r?o.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:r,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const r of this.symbolInstanceIndexes){const o=this.symbolInstances.get(r);this.featureSortOrder.push(o.featureIndex),[o.rightJustifiedTextSymbolIndex,o.centerJustifiedTextSymbolIndex,o.leftJustifiedTextSymbolIndex].forEach((u,_,x)=>{u>=0&&x.indexOf(u)===_&&this.addIndicesForPlacedSymbol(this.text,u)}),o.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,o.verticalPlacedTextSymbolIndex),o.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,o.placedIconSymbolIndex),o.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,o.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let ld,cd;Zt("SymbolBucket",gl,{omit:["layers","collisionBoxArray","features","compareText"]}),gl.MAX_GLYPHS=65535,gl.addDynamicAttributes=Oh;var Fh={get paint(){return cd=cd||new a({"icon-opacity":new gi(ae.paint_symbol["icon-opacity"]),"icon-color":new gi(ae.paint_symbol["icon-color"]),"icon-halo-color":new gi(ae.paint_symbol["icon-halo-color"]),"icon-halo-width":new gi(ae.paint_symbol["icon-halo-width"]),"icon-halo-blur":new gi(ae.paint_symbol["icon-halo-blur"]),"icon-translate":new ai(ae.paint_symbol["icon-translate"]),"icon-translate-anchor":new ai(ae.paint_symbol["icon-translate-anchor"]),"text-opacity":new gi(ae.paint_symbol["text-opacity"]),"text-color":new gi(ae.paint_symbol["text-color"],{runtimeType:qi,getOverride:i=>i.textColor,hasOverride:i=>!!i.textColor}),"text-halo-color":new gi(ae.paint_symbol["text-halo-color"]),"text-halo-width":new gi(ae.paint_symbol["text-halo-width"]),"text-halo-blur":new gi(ae.paint_symbol["text-halo-blur"]),"text-translate":new ai(ae.paint_symbol["text-translate"]),"text-translate-anchor":new ai(ae.paint_symbol["text-translate-anchor"])})},get layout(){return ld=ld||new a({"symbol-placement":new ai(ae.layout_symbol["symbol-placement"]),"symbol-spacing":new ai(ae.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ai(ae.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new gi(ae.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ai(ae.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new ai(ae.layout_symbol["icon-allow-overlap"]),"icon-overlap":new ai(ae.layout_symbol["icon-overlap"]),"icon-ignore-placement":new ai(ae.layout_symbol["icon-ignore-placement"]),"icon-optional":new ai(ae.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ai(ae.layout_symbol["icon-rotation-alignment"]),"icon-size":new gi(ae.layout_symbol["icon-size"]),"icon-text-fit":new ai(ae.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new ai(ae.layout_symbol["icon-text-fit-padding"]),"icon-image":new gi(ae.layout_symbol["icon-image"]),"icon-rotate":new gi(ae.layout_symbol["icon-rotate"]),"icon-padding":new gi(ae.layout_symbol["icon-padding"]),"icon-keep-upright":new ai(ae.layout_symbol["icon-keep-upright"]),"icon-offset":new gi(ae.layout_symbol["icon-offset"]),"icon-anchor":new gi(ae.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ai(ae.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ai(ae.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ai(ae.layout_symbol["text-rotation-alignment"]),"text-field":new gi(ae.layout_symbol["text-field"]),"text-font":new gi(ae.layout_symbol["text-font"]),"text-size":new gi(ae.layout_symbol["text-size"]),"text-max-width":new gi(ae.layout_symbol["text-max-width"]),"text-line-height":new ai(ae.layout_symbol["text-line-height"]),"text-letter-spacing":new gi(ae.layout_symbol["text-letter-spacing"]),"text-justify":new gi(ae.layout_symbol["text-justify"]),"text-radial-offset":new gi(ae.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ai(ae.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new gi(ae.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new gi(ae.layout_symbol["text-anchor"]),"text-max-angle":new ai(ae.layout_symbol["text-max-angle"]),"text-writing-mode":new ai(ae.layout_symbol["text-writing-mode"]),"text-rotate":new gi(ae.layout_symbol["text-rotate"]),"text-padding":new ai(ae.layout_symbol["text-padding"]),"text-keep-upright":new ai(ae.layout_symbol["text-keep-upright"]),"text-transform":new gi(ae.layout_symbol["text-transform"]),"text-offset":new gi(ae.layout_symbol["text-offset"]),"text-allow-overlap":new ai(ae.layout_symbol["text-allow-overlap"]),"text-overlap":new ai(ae.layout_symbol["text-overlap"]),"text-ignore-placement":new ai(ae.layout_symbol["text-ignore-placement"]),"text-optional":new ai(ae.layout_symbol["text-optional"])})}};class hd{constructor(e){if(e.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=e.property.overrides?e.property.overrides.runtimeType:Zi,this.defaultValue=e}evaluate(e){if(e.formattedSection){const r=this.defaultValue.property.overrides;if(r&&r.hasOverride(e.formattedSection))return r.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Zt("FormatSectionOverride",hd,{omit:["defaultValue"]});class Uc extends v{constructor(e){super(e,Fh)}recalculate(e,r){if(super.recalculate(e,r),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const o=this.layout.get("text-writing-mode");if(o){const u=[];for(const _ of o)u.indexOf(_)<0&&u.push(_);this.layout._values["text-writing-mode"]=u}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(e,r,o,u){const _=this.layout.get(e).evaluate(r,{},o,u),x=this._unevaluatedLayout._values[e];return x.isDataDriven()||gn(x.value)||!_?_:function(S,A){return A.replace(/{([^{}]+)}/g,(F,R)=>S&&R in S?String(S[R]):"")}(r.properties,_)}createBucket(e){return new gl(e)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const e of Fh.paint.overridableProperties){if(!Uc.hasPaintOverride(this.layout,e))continue;const r=this.paint.get(e),o=new hd(r),u=new Pr(o,r.property.specification);let _=null;_=r.value.kind==="constant"||r.value.kind==="source"?new Nr("source",u):new zn("composite",u,r.value.zoomStops),this.paint._values[e]=new ys(r.property,_,r.parameters)}}_handleOverridablePaintPropertyUpdate(e,r,o){return!(!this.layout||r.isDataDriven()||o.isDataDriven())&&Uc.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,r){const o=e.get("text-field"),u=Fh.paint.properties[r];let _=!1;const x=S=>{for(const A of S)if(u.overrides&&u.overrides.hasOverride(A))return void(_=!0)};if(o.value.kind==="constant"&&o.value.value instanceof Wi)x(o.value.value.sections);else if(o.value.kind==="source"){const S=F=>{_||(F instanceof ws&&ir(F.value)===$i?x(F.value.sections):F instanceof yo?x(F.sections):F.eachChild(S))},A=o.value;A._styleExpression&&S(A._styleExpression.expression)}return _}}let ud;var qp={get paint(){return ud=ud||new a({"background-color":new ai(ae.paint_background["background-color"]),"background-pattern":new t(ae.paint_background["background-pattern"]),"background-opacity":new ai(ae.paint_background["background-opacity"])})}};class $p extends v{constructor(e){super(e,qp)}}let dd;var Yp={get paint(){return dd=dd||new a({"raster-opacity":new ai(ae.paint_raster["raster-opacity"]),"raster-hue-rotate":new ai(ae.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ai(ae.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ai(ae.paint_raster["raster-brightness-max"]),"raster-saturation":new ai(ae.paint_raster["raster-saturation"]),"raster-contrast":new ai(ae.paint_raster["raster-contrast"]),"raster-resampling":new ai(ae.paint_raster["raster-resampling"]),"raster-fade-duration":new ai(ae.paint_raster["raster-fade-duration"])})}};class Zp extends v{constructor(e){super(e,Yp)}}class Kp extends v{constructor(e){super(e,{}),this.onAdd=r=>{this.implementation.onAdd&&this.implementation.onAdd(r,r.painter.context.gl)},this.onRemove=r=>{this.implementation.onRemove&&this.implementation.onRemove(r,r.painter.context.gl)},this.implementation=e}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class Jp{constructor(e){this._methodToThrottle=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._methodToThrottle()},0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const zh=63710088e-1;class oa{constructor(e,r){if(isNaN(e)||isNaN(r))throw new Error(`Invalid LngLat object: (${e}, ${r})`);if(this.lng=+e,this.lat=+r,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new oa($(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const r=Math.PI/180,o=this.lat*r,u=e.lat*r,_=Math.sin(o)*Math.sin(u)+Math.cos(o)*Math.cos(u)*Math.cos((e.lng-this.lng)*r);return zh*Math.acos(Math.min(_,1))}static convert(e){if(e instanceof oa)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new oa(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new oa(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const fd=2*Math.PI*zh;function pd(i){return fd*Math.cos(i*Math.PI/180)}function md(i){return(180+i)/360}function gd(i){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i*Math.PI/360)))/360}function _d(i,e){return i/pd(e)}function Rh(i){return 360/Math.PI*Math.atan(Math.exp((180-360*i)*Math.PI/180))-90}class Gc{constructor(e,r,o=0){this.x=+e,this.y=+r,this.z=+o}static fromLngLat(e,r=0){const o=oa.convert(e);return new Gc(md(o.lng),gd(o.lat),_d(r,o.lat))}toLngLat(){return new oa(360*this.x-180,Rh(this.y))}toAltitude(){return this.z*pd(Rh(this.y))}meterInMercatorCoordinateUnits(){return 1/fd*(e=Rh(this.y),1/Math.cos(e*Math.PI/180));var e}}function yd(i,e,r){var o=2*Math.PI*6378137/256/Math.pow(2,r);return[i*o-2*Math.PI*6378137/2,e*o-2*Math.PI*6378137/2]}class Bh{constructor(e,r,o){if(e<0||e>25||o<0||o>=Math.pow(2,e)||r<0||r>=Math.pow(2,e))throw new Error(`x=${r}, y=${o}, z=${e} outside of bounds. 0<=x<${Math.pow(2,e)}, 0<=y<${Math.pow(2,e)} 0<=z<=25 `);this.z=e,this.x=r,this.y=o,this.key=oc(0,e,e,r,o)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,r,o){const u=(x=this.y,S=this.z,A=yd(256*(_=this.x),256*(x=Math.pow(2,S)-x-1),S),F=yd(256*(_+1),256*(x+1),S),A[0]+","+A[1]+","+F[0]+","+F[1]);var _,x,S,A,F;const R=function(j,W,q){let Q,re="";for(let ue=j;ue>0;ue--)Q=1<<ue-1,re+=(W&Q?1:0)+(q&Q?2:0);return re}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(o==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,r>1?"@2x":"").replace(/{quadkey}/g,R).replace(/{bbox-epsg-3857}/g,u)}isChildOf(e){const r=this.z-e.z;return r>0&&e.x===this.x>>r&&e.y===this.y>>r}getTilePoint(e){const r=Math.pow(2,this.z);return new l((e.x*r-this.x)*Br,(e.y*r-this.y)*Br)}toString(){return`${this.z}/${this.x}/${this.y}`}}class vd{constructor(e,r){this.wrap=e,this.canonical=r,this.key=oc(e,r.z,r.z,r.x,r.y)}}class ns{constructor(e,r,o,u,_){if(e<o)throw new Error(`overscaledZ should be >= z; overscaledZ = ${e}; z = ${o}`);this.overscaledZ=e,this.wrap=r,this.canonical=new Bh(o,+u,+_),this.key=oc(r,e,o,u,_)}clone(){return new ns(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){if(e>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${e}; overscaledZ = ${this.overscaledZ}`);const r=this.canonical.z-e;return e>this.canonical.z?new ns(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new ns(e,this.wrap,e,this.canonical.x>>r,this.canonical.y>>r)}calculateScaledKey(e,r){if(e>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${e}; overscaledZ = ${this.overscaledZ}`);const o=this.canonical.z-e;return e>this.canonical.z?oc(this.wrap*+r,e,this.canonical.z,this.canonical.x,this.canonical.y):oc(this.wrap*+r,e,e,this.canonical.x>>o,this.canonical.y>>o)}isChildOf(e){if(e.wrap!==this.wrap)return!1;const r=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.x===this.canonical.x>>r&&e.canonical.y===this.canonical.y>>r}children(e){if(this.overscaledZ>=e)return[new ns(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const r=this.canonical.z+1,o=2*this.canonical.x,u=2*this.canonical.y;return[new ns(r,this.wrap,r,o,u),new ns(r,this.wrap,r,o+1,u),new ns(r,this.wrap,r,o,u+1),new ns(r,this.wrap,r,o+1,u+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new ns(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new ns(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new vd(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(e){return this.canonical.getTilePoint(new Gc(e.x-this.wrap,e.y))}}function oc(i,e,r,o,u){(i*=2)<0&&(i=-1*i-1);const _=1<<r;return(_*_*i+_*u+o).toString(36)+r.toString(36)+e.toString(36)}Zt("CanonicalTileID",Bh),Zt("OverscaledTileID",ns,{omit:["posMatrix"]});class xd{constructor(e,r,o,u=1,_=1,x=1,S=0){if(this.uid=e,r.height!==r.width)throw new RangeError("DEM tiles must be square");if(o&&!["mapbox","terrarium","custom"].includes(o))return void ht(`"${o}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=r.height;const A=this.dim=r.height-2;switch(this.data=new Uint32Array(r.data.buffer),o){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=u,this.greenFactor=_,this.blueFactor=x,this.baseShift=S;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let F=0;F<A;F++)this.data[this._idx(-1,F)]=this.data[this._idx(0,F)],this.data[this._idx(A,F)]=this.data[this._idx(A-1,F)],this.data[this._idx(F,-1)]=this.data[this._idx(F,0)],this.data[this._idx(F,A)]=this.data[this._idx(F,A-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(A,-1)]=this.data[this._idx(A-1,0)],this.data[this._idx(-1,A)]=this.data[this._idx(0,A-1)],this.data[this._idx(A,A)]=this.data[this._idx(A-1,A-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let F=0;F<A;F++)for(let R=0;R<A;R++){const j=this.get(F,R);j>this.max&&(this.max=j),j<this.min&&(this.min=j)}}get(e,r){const o=new Uint8Array(this.data.buffer),u=4*this._idx(e,r);return this.unpack(o[u],o[u+1],o[u+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(e,r){if(e<-1||e>=this.dim+1||r<-1||r>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(r+1)*this.stride+(e+1)}unpack(e,r,o){return e*this.redFactor+r*this.greenFactor+o*this.blueFactor-this.baseShift}getPixels(){return new rs({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(e,r,o){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let u=r*this.dim,_=r*this.dim+this.dim,x=o*this.dim,S=o*this.dim+this.dim;switch(r){case-1:u=_-1;break;case 1:_=u+1}switch(o){case-1:x=S-1;break;case 1:S=x+1}const A=-r*this.dim,F=-o*this.dim;for(let R=x;R<S;R++)for(let j=u;j<_;j++)this.data[this._idx(j,R)]=e.data[this._idx(j+A,R+F)]}}Zt("DEMData",xd);class bd{constructor(e){this._stringToNumber={},this._numberToString=[];for(let r=0;r<e.length;r++){const o=e[r];this._stringToNumber[o]=r,this._numberToString[r]=o}}encode(e){return this._stringToNumber[e]}decode(e){if(e>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${e} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[e]}}class wd{constructor(e,r,o,u,_){this.type="Feature",this._vectorTileFeature=e,e._z=r,e._x=o,e._y=u,this.properties=e.properties,this.id=_}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={geometry:this.geometry};for(const r in this)r!=="_geometry"&&r!=="_vectorTileFeature"&&(e[r]=this[r]);return e}}class Cd{constructor(e,r){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Ea(Br,16,0),this.grid3D=new Ea(Br,16,0),this.featureIndexArray=new ts,this.promoteId=r}insert(e,r,o,u,_,x){const S=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(o,u,_);const A=x?this.grid3D:this.grid;for(let F=0;F<r.length;F++){const R=r[F],j=[1/0,1/0,-1/0,-1/0];for(let W=0;W<R.length;W++){const q=R[W];j[0]=Math.min(j[0],q.x),j[1]=Math.min(j[1],q.y),j[2]=Math.max(j[2],q.x),j[3]=Math.max(j[3],q.y)}j[0]<Br&&j[1]<Br&&j[2]>=0&&j[3]>=0&&A.insert(S,j[0],j[1],j[2],j[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new ra.VectorTile(new Eh(this.rawTileData)).layers,this.sourceLayerCoder=new bd(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(e,r,o,u){this.loadVTLayers();const _=e.params||{},x=Br/e.tileSize/e.scale,S=Sa(_.filter),A=e.queryGeometry,F=e.queryPadding*x,R=Td(A),j=this.grid.query(R.minX-F,R.minY-F,R.maxX+F,R.maxY+F),W=Td(e.cameraQueryGeometry),q=this.grid3D.query(W.minX-F,W.minY-F,W.maxX+F,W.maxY+F,(ue,we,Ne,Ee)=>function(Re,et,xt,jt,hi){for(const Bt of Re)if(et<=Bt.x&&xt<=Bt.y&&jt>=Bt.x&&hi>=Bt.y)return!0;const Gt=[new l(et,xt),new l(et,hi),new l(jt,hi),new l(jt,xt)];if(Re.length>2){for(const Bt of Gt)if(cl(Re,Bt))return!0}for(let Bt=0;Bt<Re.length-1;Bt++)if(Of(Re[Bt],Re[Bt+1],Gt))return!0;return!1}(e.cameraQueryGeometry,ue-F,we-F,Ne+F,Ee+F));for(const ue of q)j.push(ue);j.sort(Qp);const Q={};let re;for(let ue=0;ue<j.length;ue++){const we=j[ue];if(we===re)continue;re=we;const Ne=this.featureIndexArray.get(we);let Ee=null;this.loadMatchingFeature(Q,Ne.bucketIndex,Ne.sourceLayerIndex,Ne.featureIndex,S,_.layers,_.availableImages,r,o,u,(Re,et,xt)=>(Ee||(Ee=ka(Re)),et.queryIntersectsFeature(A,Re,xt,Ee,this.z,e.transform,x,e.pixelPosMatrix)))}return Q}loadMatchingFeature(e,r,o,u,_,x,S,A,F,R,j){const W=this.bucketLayerIDs[r];if(x&&!function(ue,we){for(let Ne=0;Ne<ue.length;Ne++)if(we.indexOf(ue[Ne])>=0)return!0;return!1}(x,W))return;const q=this.sourceLayerCoder.decode(o),Q=this.vtLayers[q].feature(u);if(_.needGeometry){const ue=Oa(Q,!0);if(!_.filter(new hr(this.tileID.overscaledZ),ue,this.tileID.canonical))return}else if(!_.filter(new hr(this.tileID.overscaledZ),Q))return;const re=this.getId(Q,q);for(let ue=0;ue<W.length;ue++){const we=W[ue];if(x&&x.indexOf(we)<0)continue;const Ne=A[we];if(!Ne)continue;let Ee={};re&&R&&(Ee=R.getState(Ne.sourceLayer||"_geojsonTileLayer",re));const Re=ne({},F[we]);Re.paint=Sd(Re.paint,Ne.paint,Q,Ee,S),Re.layout=Sd(Re.layout,Ne.layout,Q,Ee,S);const et=!j||j(Q,Ne,Ee);if(!et)continue;const xt=new wd(Q,this.z,this.x,this.y,re);xt.layer=Re;let jt=e[we];jt===void 0&&(jt=e[we]=[]),jt.push({featureIndex:u,feature:xt,intersectionZ:et})}}lookupSymbolFeatures(e,r,o,u,_,x,S,A){const F={};this.loadVTLayers();const R=Sa(_);for(const j of e)this.loadMatchingFeature(F,o,u,j,R,x,S,A,r);return F}hasLayer(e){for(const r of this.bucketLayerIDs)for(const o of r)if(e===o)return!0;return!1}getId(e,r){let o=e.id;return this.promoteId&&(o=e.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[r]],typeof o=="boolean"&&(o=Number(o))),o}}function Sd(i,e,r,o,u){return ze(i,(_,x)=>{const S=e instanceof il?e.get(x):null;return S&&S.evaluate?S.evaluate(r,o,u):S})}function Td(i){let e=1/0,r=1/0,o=-1/0,u=-1/0;for(const _ of i)e=Math.min(e,_.x),r=Math.min(r,_.y),o=Math.max(o,_.x),u=Math.max(u,_.y);return{minX:e,minY:r,maxX:o,maxY:u}}function Qp(i,e){return e-i}function Ed(i,e,r,o,u){const _=[];for(let x=0;x<i.length;x++){const S=i[x];let A;for(let F=0;F<S.length-1;F++){let R=S[F],j=S[F+1];R.x<e&&j.x<e||(R.x<e?R=new l(e,R.y+(e-R.x)/(j.x-R.x)*(j.y-R.y))._round():j.x<e&&(j=new l(e,R.y+(e-R.x)/(j.x-R.x)*(j.y-R.y))._round()),R.y<r&&j.y<r||(R.y<r?R=new l(R.x+(r-R.y)/(j.y-R.y)*(j.x-R.x),r)._round():j.y<r&&(j=new l(R.x+(r-R.y)/(j.y-R.y)*(j.x-R.x),r)._round()),R.x>=o&&j.x>=o||(R.x>=o?R=new l(o,R.y+(o-R.x)/(j.x-R.x)*(j.y-R.y))._round():j.x>=o&&(j=new l(o,R.y+(o-R.x)/(j.x-R.x)*(j.y-R.y))._round()),R.y>=u&&j.y>=u||(R.y>=u?R=new l(R.x+(u-R.y)/(j.y-R.y)*(j.x-R.x),u)._round():j.y>=u&&(j=new l(R.x+(u-R.y)/(j.y-R.y)*(j.x-R.x),u)._round()),A&&R.equals(A[A.length-1])||(A=[R],_.push(A)),A.push(j)))))}}return _}Zt("FeatureIndex",Cd,{omit:["rawTileData","sourceLayerCoder"]});class aa extends l{constructor(e,r,o,u){super(e,r),this.angle=o,u!==void 0&&(this.segment=u)}clone(){return new aa(this.x,this.y,this.angle,this.segment)}}function Pd(i,e,r,o,u){if(e.segment===void 0||r===0)return!0;let _=e,x=e.segment+1,S=0;for(;S>-r/2;){if(x--,x<0)return!1;S-=i[x].dist(_),_=i[x]}S+=i[x].dist(i[x+1]),x++;const A=[];let F=0;for(;S<r/2;){const R=i[x],j=i[x+1];if(!j)return!1;let W=i[x-1].angleTo(R)-R.angleTo(j);for(W=Math.abs((W+3*Math.PI)%(2*Math.PI)-Math.PI),A.push({distance:S,angleDelta:W}),F+=W;S-A[0].distance>o;)F-=A.shift().angleDelta;if(F>u)return!1;x++,S+=R.dist(j)}return!0}function Id(i){let e=0;for(let r=0;r<i.length-1;r++)e+=i[r].dist(i[r+1]);return e}function Ad(i,e,r){return i?.6*e*r:0}function Md(i,e){return Math.max(i?i.right-i.left:0,e?e.right-e.left:0)}function em(i,e,r,o,u,_){const x=Ad(r,u,_),S=Md(r,o)*_;let A=0;const F=Id(i)/2;for(let R=0;R<i.length-1;R++){const j=i[R],W=i[R+1],q=j.dist(W);if(A+q>F){const Q=(F-A)/q,re=fi.number(j.x,W.x,Q),ue=fi.number(j.y,W.y,Q),we=new aa(re,ue,W.angleTo(j),R);return we._round(),!x||Pd(i,we,S,x,e)?we:void 0}A+=q}}function tm(i,e,r,o,u,_,x,S,A){const F=Ad(o,_,x),R=Md(o,u),j=R*x,W=i[0].x===0||i[0].x===A||i[0].y===0||i[0].y===A;return e-j<e/4&&(e=j+e/4),kd(i,W?e/2*S%e:(R/2+2*_)*x*S%e,e,F,r,j,W,!1,A)}function kd(i,e,r,o,u,_,x,S,A){const F=_/2,R=Id(i);let j=0,W=e-r,q=[];for(let Q=0;Q<i.length-1;Q++){const re=i[Q],ue=i[Q+1],we=re.dist(ue),Ne=ue.angleTo(re);for(;W+r<j+we;){W+=r;const Ee=(W-j)/we,Re=fi.number(re.x,ue.x,Ee),et=fi.number(re.y,ue.y,Ee);if(Re>=0&&Re<A&&et>=0&&et<A&&W-F>=0&&W+F<=R){const xt=new aa(Re,et,Ne,Q);xt._round(),o&&!Pd(i,xt,_,o,u)||q.push(xt)}}j+=we}return S||q.length||x||(q=kd(i,j/2,r,o,u,_,x,!0,A)),q}Zt("Anchor",aa);const _l=jn;function Od(i,e,r,o){const u=[],_=i.image,x=_.pixelRatio,S=_.paddedRect.w-2*_l,A=_.paddedRect.h-2*_l;let F={x1:i.left,y1:i.top,x2:i.right,y2:i.bottom};const R=_.stretchX||[[0,S]],j=_.stretchY||[[0,A]],W=(ut,li)=>ut+li[1]-li[0],q=R.reduce(W,0),Q=j.reduce(W,0),re=S-q,ue=A-Q;let we=0,Ne=q,Ee=0,Re=Q,et=0,xt=re,jt=0,hi=ue;if(_.content&&o){const ut=_.content,li=ut[2]-ut[0],ni=ut[3]-ut[1];(_.textFitWidth||_.textFitHeight)&&(F=sd(i)),we=Wc(R,0,ut[0]),Ee=Wc(j,0,ut[1]),Ne=Wc(R,ut[0],ut[2]),Re=Wc(j,ut[1],ut[3]),et=ut[0]-we,jt=ut[1]-Ee,xt=li-Ne,hi=ni-Re}const Gt=F.x1,Bt=F.y1,oi=F.x2-Gt,Kt=F.y2-Bt,Yt=(ut,li,ni,bi)=>{const or=Hc(ut.stretch-we,Ne,oi,Gt),er=Xc(ut.fixed-et,xt,ut.stretch,q),Wr=Hc(li.stretch-Ee,Re,Kt,Bt),vs=Xc(li.fixed-jt,hi,li.stretch,Q),hn=Hc(ni.stretch-we,Ne,oi,Gt),Or=Xc(ni.fixed-et,xt,ni.stretch,q),Pn=Hc(bi.stretch-Ee,Re,Kt,Bt),In=Xc(bi.fixed-jt,hi,bi.stretch,Q),An=new l(or,Wr),Dr=new l(hn,Wr),Hr=new l(hn,Pn),yn=new l(or,Pn),un=new l(er/x,vs/x),Mn=new l(Or/x,In/x),dn=e*Math.PI/180;if(dn){const Ui=Math.sin(dn),ur=Math.cos(dn),_r=[ur,-Ui,Ui,ur];An._matMult(_r),Dr._matMult(_r),yn._matMult(_r),Hr._matMult(_r)}const ss=ut.stretch+ut.fixed,Nn=li.stretch+li.fixed;return{tl:An,tr:Dr,bl:yn,br:Hr,tex:{x:_.paddedRect.x+_l+ss,y:_.paddedRect.y+_l+Nn,w:ni.stretch+ni.fixed-ss,h:bi.stretch+bi.fixed-Nn},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:un,pixelOffsetBR:Mn,minFontScaleX:xt/x/oi,minFontScaleY:hi/x/Kt,isSDF:r}};if(o&&(_.stretchX||_.stretchY)){const ut=Dd(R,re,q),li=Dd(j,ue,Q);for(let ni=0;ni<ut.length-1;ni++){const bi=ut[ni],or=ut[ni+1];for(let er=0;er<li.length-1;er++)u.push(Yt(bi,li[er],or,li[er+1]))}}else u.push(Yt({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:S+1},{fixed:0,stretch:A+1}));return u}function Wc(i,e,r){let o=0;for(const u of i)o+=Math.max(e,Math.min(r,u[1]))-Math.max(e,Math.min(r,u[0]));return o}function Dd(i,e,r){const o=[{fixed:-_l,stretch:0}];for(const[u,_]of i){const x=o[o.length-1];o.push({fixed:u-x.stretch,stretch:x.stretch}),o.push({fixed:u-x.stretch,stretch:x.stretch+(_-u)})}return o.push({fixed:e+_l,stretch:r}),o}function Hc(i,e,r,o){return i/e*r+o}function Xc(i,e,r,o){return i-e*r/o}class qc{constructor(e,r,o,u,_,x,S,A,F,R){var j;if(this.boxStartIndex=e.length,F){let W=x.top,q=x.bottom;const Q=x.collisionPadding;Q&&(W-=Q[1],q+=Q[3]);let re=q-W;re>0&&(re=Math.max(10,re),this.circleDiameter=re)}else{const W=!((j=x.image)===null||j===void 0)&&j.content&&(x.image.textFitWidth||x.image.textFitHeight)?sd(x):{x1:x.left,y1:x.top,x2:x.right,y2:x.bottom};W.y1=W.y1*S-A[0],W.y2=W.y2*S+A[2],W.x1=W.x1*S-A[3],W.x2=W.x2*S+A[1];const q=x.collisionPadding;if(q&&(W.x1-=q[0]*S,W.y1-=q[1]*S,W.x2+=q[2]*S,W.y2+=q[3]*S),R){const Q=new l(W.x1,W.y1),re=new l(W.x2,W.y1),ue=new l(W.x1,W.y2),we=new l(W.x2,W.y2),Ne=R*Math.PI/180;Q._rotate(Ne),re._rotate(Ne),ue._rotate(Ne),we._rotate(Ne),W.x1=Math.min(Q.x,re.x,ue.x,we.x),W.x2=Math.max(Q.x,re.x,ue.x,we.x),W.y1=Math.min(Q.y,re.y,ue.y,we.y),W.y2=Math.max(Q.y,re.y,ue.y,we.y)}e.emplaceBack(r.x,r.y,W.x1,W.y1,W.x2,W.y2,o,u,_)}this.boxEndIndex=e.length}}class im{constructor(e=[],r=rm){if(this.data=e,this.length=this.data.length,this.compare=r,this.length>0)for(let o=(this.length>>1)-1;o>=0;o--)this._down(o)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const e=this.data[0],r=this.data.pop();return this.length--,this.length>0&&(this.data[0]=r,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:r,compare:o}=this,u=r[e];for(;e>0;){const _=e-1>>1,x=r[_];if(o(u,x)>=0)break;r[e]=x,e=_}r[e]=u}_down(e){const{data:r,compare:o}=this,u=this.length>>1,_=r[e];for(;e<u;){let x=1+(e<<1),S=r[x];const A=x+1;if(A<this.length&&o(r[A],S)<0&&(x=A,S=r[A]),o(S,_)>=0)break;r[e]=S,e=x}r[e]=_}}function rm(i,e){return i<e?-1:i>e?1:0}function nm(i,e=1,r=!1){let o=1/0,u=1/0,_=-1/0,x=-1/0;const S=i[0];for(let q=0;q<S.length;q++){const Q=S[q];(!q||Q.x<o)&&(o=Q.x),(!q||Q.y<u)&&(u=Q.y),(!q||Q.x>_)&&(_=Q.x),(!q||Q.y>x)&&(x=Q.y)}const A=Math.min(_-o,x-u);let F=A/2;const R=new im([],sm);if(A===0)return new l(o,u);for(let q=o;q<_;q+=A)for(let Q=u;Q<x;Q+=A)R.push(new yl(q+F,Q+F,F,i));let j=function(q){let Q=0,re=0,ue=0;const we=q[0];for(let Ne=0,Ee=we.length,Re=Ee-1;Ne<Ee;Re=Ne++){const et=we[Ne],xt=we[Re],jt=et.x*xt.y-xt.x*et.y;re+=(et.x+xt.x)*jt,ue+=(et.y+xt.y)*jt,Q+=3*jt}return new yl(re/Q,ue/Q,0,q)}(i),W=R.length;for(;R.length;){const q=R.pop();(q.d>j.d||!j.d)&&(j=q,r&&console.log("found best %d after %d probes",Math.round(1e4*q.d)/1e4,W)),q.max-j.d<=e||(F=q.h/2,R.push(new yl(q.p.x-F,q.p.y-F,F,i)),R.push(new yl(q.p.x+F,q.p.y-F,F,i)),R.push(new yl(q.p.x-F,q.p.y+F,F,i)),R.push(new yl(q.p.x+F,q.p.y+F,F,i)),W+=4)}return r&&(console.log(`num probes: ${W}`),console.log(`best distance: ${j.d}`)),j.p}function sm(i,e){return e.max-i.max}function yl(i,e,r,o){this.p=new l(i,e),this.h=r,this.d=function(u,_){let x=!1,S=1/0;for(let A=0;A<_.length;A++){const F=_[A];for(let R=0,j=F.length,W=j-1;R<j;W=R++){const q=F[R],Q=F[W];q.y>u.y!=Q.y>u.y&&u.x<(Q.x-q.x)*(u.y-q.y)/(Q.y-q.y)+q.x&&(x=!x),S=Math.min(S,gu(u,q,Q))}}return(x?1:-1)*Math.sqrt(S)}(this.p,o),this.max=this.d+this.h*Math.SQRT2}var cn;N.aq=void 0,(cn=N.aq||(N.aq={}))[cn.center=1]="center",cn[cn.left=2]="left",cn[cn.right=3]="right",cn[cn.top=4]="top",cn[cn.bottom=5]="bottom",cn[cn["top-left"]=6]="top-left",cn[cn["top-right"]=7]="top-right",cn[cn["bottom-left"]=8]="bottom-left",cn[cn["bottom-right"]=9]="bottom-right";const la=7,jh=Number.POSITIVE_INFINITY;function Ld(i,e){return e[1]!==jh?function(r,o,u){let _=0,x=0;switch(o=Math.abs(o),u=Math.abs(u),r){case"top-right":case"top-left":case"top":x=u-la;break;case"bottom-right":case"bottom-left":case"bottom":x=-u+la}switch(r){case"top-right":case"bottom-right":case"right":_=-o;break;case"top-left":case"bottom-left":case"left":_=o}return[_,x]}(i,e[0],e[1]):function(r,o){let u=0,_=0;o<0&&(o=0);const x=o/Math.SQRT2;switch(r){case"top-right":case"top-left":_=x-la;break;case"bottom-right":case"bottom-left":_=-x+la;break;case"bottom":_=-o+la;break;case"top":_=o-la}switch(r){case"top-right":case"bottom-right":u=-x;break;case"top-left":case"bottom-left":u=x;break;case"left":u=o;break;case"right":u=-o}return[u,_]}(i,e[0])}function Fd(i,e,r){var o;const u=i.layout,_=(o=u.get("text-variable-anchor-offset"))===null||o===void 0?void 0:o.evaluate(e,{},r);if(_){const S=_.values,A=[];for(let F=0;F<S.length;F+=2){const R=A[F]=S[F],j=S[F+1].map(W=>W*Ur);R.startsWith("top")?j[1]-=la:R.startsWith("bottom")&&(j[1]+=la),A[F+1]=j}return new Cr(A)}const x=u.get("text-variable-anchor");if(x){let S;S=i._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[u.get("text-radial-offset").evaluate(e,{},r)*Ur,jh]:u.get("text-offset").evaluate(e,{},r).map(F=>F*Ur);const A=[];for(const F of x)A.push(F,Ld(F,S));return new Cr(A)}return null}function Nh(i){switch(i){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function om(i,e,r,o,u,_,x,S,A,F,R){let j=_.textMaxSize.evaluate(e,{});j===void 0&&(j=x);const W=i.layers[0].layout,q=W.get("icon-offset").evaluate(e,{},R),Q=Rd(r.horizontal),re=x/24,ue=i.tilePixelRatio*re,we=i.tilePixelRatio*j/24,Ne=i.tilePixelRatio*S,Ee=i.tilePixelRatio*W.get("symbol-spacing"),Re=W.get("text-padding")*i.tilePixelRatio,et=function(ut,li,ni,bi=1){const or=ut.get("icon-padding").evaluate(li,{},ni),er=or&&or.values;return[er[0]*bi,er[1]*bi,er[2]*bi,er[3]*bi]}(W,e,R,i.tilePixelRatio),xt=W.get("text-max-angle")/180*Math.PI,jt=W.get("text-rotation-alignment")!=="viewport"&&W.get("symbol-placement")!=="point",hi=W.get("icon-rotation-alignment")==="map"&&W.get("symbol-placement")!=="point",Gt=W.get("symbol-placement"),Bt=Ee/2,oi=W.get("icon-text-fit");let Kt;o&&oi!=="none"&&(i.allowVerticalPlacement&&r.vertical&&(Kt=od(o,r.vertical,oi,W.get("icon-text-fit-padding"),q,re)),Q&&(o=od(o,Q,oi,W.get("icon-text-fit-padding"),q,re)));const Yt=(ut,li)=>{li.x<0||li.x>=Br||li.y<0||li.y>=Br||function(ni,bi,or,er,Wr,vs,hn,Or,Pn,In,An,Dr,Hr,yn,un,Mn,dn,ss,Nn,Ui,ur,_r,qn,Ar,vl){const oo=ni.addToLineVertexArray(bi,or);let ao,xs,os,Jr,Lo=0,cc=0,Vd=0,Ud=0,$h=-1,Yh=-1;const Fo={};let Gd=al("");if(ni.allowVerticalPlacement&&er.vertical){const vn=Or.layout.get("text-rotate").evaluate(ur,{},Ar)+90;os=new qc(Pn,bi,In,An,Dr,er.vertical,Hr,yn,un,vn),hn&&(Jr=new qc(Pn,bi,In,An,Dr,hn,dn,ss,un,vn))}if(Wr){const vn=Or.layout.get("icon-rotate").evaluate(ur,{}),as=Or.layout.get("icon-text-fit")!=="none",La=Od(Wr,vn,qn,as),Os=hn?Od(hn,vn,qn,as):void 0;xs=new qc(Pn,bi,In,An,Dr,Wr,dn,ss,!1,vn),Lo=4*La.length;const Fa=ni.iconSizeData;let lo=null;Fa.kind==="source"?(lo=[so*Or.layout.get("icon-size").evaluate(ur,{})],lo[0]>sa&&ht(`${ni.layerIds[0]}: Value for "icon-size" is >= ${sc}. Reduce your "icon-size".`)):Fa.kind==="composite"&&(lo=[so*_r.compositeIconSizes[0].evaluate(ur,{},Ar),so*_r.compositeIconSizes[1].evaluate(ur,{},Ar)],(lo[0]>sa||lo[1]>sa)&&ht(`${ni.layerIds[0]}: Value for "icon-size" is >= ${sc}. Reduce your "icon-size".`)),ni.addSymbols(ni.icon,La,lo,Ui,Nn,ur,N.ah.none,bi,oo.lineStartIndex,oo.lineLength,-1,Ar),$h=ni.icon.placedSymbolArray.length-1,Os&&(cc=4*Os.length,ni.addSymbols(ni.icon,Os,lo,Ui,Nn,ur,N.ah.vertical,bi,oo.lineStartIndex,oo.lineLength,-1,Ar),Yh=ni.icon.placedSymbolArray.length-1)}const Wd=Object.keys(er.horizontal);for(const vn of Wd){const as=er.horizontal[vn];if(!ao){Gd=al(as.text);const Os=Or.layout.get("text-rotate").evaluate(ur,{},Ar);ao=new qc(Pn,bi,In,An,Dr,as,Hr,yn,un,Os)}const La=as.positionedLines.length===1;if(Vd+=zd(ni,bi,as,vs,Or,un,ur,Mn,oo,er.vertical?N.ah.horizontal:N.ah.horizontalOnly,La?Wd:[vn],Fo,$h,_r,Ar),La)break}er.vertical&&(Ud+=zd(ni,bi,er.vertical,vs,Or,un,ur,Mn,oo,N.ah.vertical,["vertical"],Fo,Yh,_r,Ar));const cm=ao?ao.boxStartIndex:ni.collisionBoxArray.length,hm=ao?ao.boxEndIndex:ni.collisionBoxArray.length,um=os?os.boxStartIndex:ni.collisionBoxArray.length,dm=os?os.boxEndIndex:ni.collisionBoxArray.length,fm=xs?xs.boxStartIndex:ni.collisionBoxArray.length,pm=xs?xs.boxEndIndex:ni.collisionBoxArray.length,mm=Jr?Jr.boxStartIndex:ni.collisionBoxArray.length,gm=Jr?Jr.boxEndIndex:ni.collisionBoxArray.length;let ks=-1;const Yc=(vn,as)=>vn&&vn.circleDiameter?Math.max(vn.circleDiameter,as):as;ks=Yc(ao,ks),ks=Yc(os,ks),ks=Yc(xs,ks),ks=Yc(Jr,ks);const Hd=ks>-1?1:0;Hd&&(ks*=vl/Ur),ni.glyphOffsetArray.length>=gl.MAX_GLYPHS&&ht("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),ur.sortKey!==void 0&&ni.addToSortKeyRanges(ni.symbolInstances.length,ur.sortKey);const _m=Fd(Or,ur,Ar),[ym,vm]=function(vn,as){const La=vn.length,Os=as==null?void 0:as.values;if((Os==null?void 0:Os.length)>0)for(let Fa=0;Fa<Os.length;Fa+=2){const lo=Os[Fa+1];vn.emplaceBack(N.aq[Os[Fa]],lo[0],lo[1])}return[La,vn.length]}(ni.textAnchorOffsets,_m);ni.symbolInstances.emplaceBack(bi.x,bi.y,Fo.right>=0?Fo.right:-1,Fo.center>=0?Fo.center:-1,Fo.left>=0?Fo.left:-1,Fo.vertical||-1,$h,Yh,Gd,cm,hm,um,dm,fm,pm,mm,gm,In,Vd,Ud,Lo,cc,Hd,0,Hr,ks,ym,vm)}(i,li,ut,r,o,u,Kt,i.layers[0],i.collisionBoxArray,e.index,e.sourceLayerIndex,i.index,ue,[Re,Re,Re,Re],jt,A,Ne,et,hi,q,e,_,F,R,x)};if(Gt==="line")for(const ut of Ed(e.geometry,0,0,Br,Br)){const li=tm(ut,Ee,xt,r.vertical||Q,o,24,we,i.overscaling,Br);for(const ni of li)Q&&am(i,Q.text,Bt,ni)||Yt(ut,ni)}else if(Gt==="line-center"){for(const ut of e.geometry)if(ut.length>1){const li=em(ut,xt,r.vertical||Q,o,24,we);li&&Yt(ut,li)}}else if(e.type==="Polygon")for(const ut of Vs(e.geometry,0)){const li=nm(ut,16);Yt(ut[0],new aa(li.x,li.y,0))}else if(e.type==="LineString")for(const ut of e.geometry)Yt(ut,new aa(ut[0].x,ut[0].y,0));else if(e.type==="Point")for(const ut of e.geometry)for(const li of ut)Yt([li],new aa(li.x,li.y,0))}function zd(i,e,r,o,u,_,x,S,A,F,R,j,W,q,Q){const re=function(Ne,Ee,Re,et,xt,jt,hi,Gt){const Bt=et.layout.get("text-rotate").evaluate(jt,{})*Math.PI/180,oi=[];for(const Kt of Ee.positionedLines)for(const Yt of Kt.positionedGlyphs){if(!Yt.rect)continue;const ut=Yt.rect||{};let li=Ju+1,ni=!0,bi=1,or=0;const er=(xt||Gt)&&Yt.vertical,Wr=Yt.metrics.advance*Yt.scale/2;if(Gt&&Ee.verticalizable&&(or=Kt.lineOffset/2-(Yt.imageName?-(Ur-Yt.metrics.width*Yt.scale)/2:(Yt.scale-1)*Ur)),Yt.imageName){const Ui=hi[Yt.imageName];ni=Ui.sdf,bi=Ui.pixelRatio,li=jn/bi}const vs=xt?[Yt.x+Wr,Yt.y]:[0,0];let hn=xt?[0,0]:[Yt.x+Wr+Re[0],Yt.y+Re[1]-or],Or=[0,0];er&&(Or=hn,hn=[0,0]);const Pn=Yt.metrics.isDoubleResolution?2:1,In=(Yt.metrics.left-li)*Yt.scale-Wr+hn[0],An=(-Yt.metrics.top-li)*Yt.scale+hn[1],Dr=In+ut.w/Pn*Yt.scale/bi,Hr=An+ut.h/Pn*Yt.scale/bi,yn=new l(In,An),un=new l(Dr,An),Mn=new l(In,Hr),dn=new l(Dr,Hr);if(er){const Ui=new l(-Wr,Wr-rc),ur=-Math.PI/2,_r=Ur/2-Wr,qn=new l(5-rc-_r,-(Yt.imageName?_r:0)),Ar=new l(...Or);yn._rotateAround(ur,Ui)._add(qn)._add(Ar),un._rotateAround(ur,Ui)._add(qn)._add(Ar),Mn._rotateAround(ur,Ui)._add(qn)._add(Ar),dn._rotateAround(ur,Ui)._add(qn)._add(Ar)}if(Bt){const Ui=Math.sin(Bt),ur=Math.cos(Bt),_r=[ur,-Ui,Ui,ur];yn._matMult(_r),un._matMult(_r),Mn._matMult(_r),dn._matMult(_r)}const ss=new l(0,0),Nn=new l(0,0);oi.push({tl:yn,tr:un,bl:Mn,br:dn,tex:ut,writingMode:Ee.writingMode,glyphOffset:vs,sectionIndex:Yt.sectionIndex,isSDF:ni,pixelOffsetTL:ss,pixelOffsetBR:Nn,minFontScaleX:0,minFontScaleY:0})}return oi}(0,r,S,u,_,x,o,i.allowVerticalPlacement),ue=i.textSizeData;let we=null;ue.kind==="source"?(we=[so*u.layout.get("text-size").evaluate(x,{})],we[0]>sa&&ht(`${i.layerIds[0]}: Value for "text-size" is >= ${sc}. Reduce your "text-size".`)):ue.kind==="composite"&&(we=[so*q.compositeTextSizes[0].evaluate(x,{},Q),so*q.compositeTextSizes[1].evaluate(x,{},Q)],(we[0]>sa||we[1]>sa)&&ht(`${i.layerIds[0]}: Value for "text-size" is >= ${sc}. Reduce your "text-size".`)),i.addSymbols(i.text,re,we,S,_,x,F,e,A.lineStartIndex,A.lineLength,W,Q);for(const Ne of R)j[Ne]=i.text.placedSymbolArray.length-1;return 4*re.length}function Rd(i){for(const e in i)return i[e];return null}function am(i,e,r,o){const u=i.compareText;if(e in u){const _=u[e];for(let x=_.length-1;x>=0;x--)if(o.dist(_[x])<r)return!0}else u[e]=[];return u[e].push(o),!1}const Bd=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Vh{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[r,o]=new Uint8Array(e,0,2);if(r!==219)throw new Error("Data does not appear to be in a KDBush format.");const u=o>>4;if(u!==1)throw new Error(`Got v${u} data when expected v1.`);const _=Bd[15&o];if(!_)throw new Error("Unrecognized array type.");const[x]=new Uint16Array(e,2,1),[S]=new Uint32Array(e,4,1);return new Vh(S,x,_,e)}constructor(e,r=64,o=Float64Array,u){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+r,2),65535),this.ArrayType=o,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const _=Bd.indexOf(this.ArrayType),x=2*e*this.ArrayType.BYTES_PER_ELEMENT,S=e*this.IndexArrayType.BYTES_PER_ELEMENT,A=(8-S%8)%8;if(_<0)throw new Error(`Unexpected typed array class: ${o}.`);u&&u instanceof ArrayBuffer?(this.data=u,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+S+A,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+x+S+A),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+S+A,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+_]),new Uint16Array(this.data,2,1)[0]=r,new Uint32Array(this.data,4,1)[0]=e)}add(e,r){const o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=e,this.coords[this._pos++]=r,o}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return Uh(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,r,o,u){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:_,coords:x,nodeSize:S}=this,A=[0,_.length-1,0],F=[];for(;A.length;){const R=A.pop()||0,j=A.pop()||0,W=A.pop()||0;if(j-W<=S){for(let ue=W;ue<=j;ue++){const we=x[2*ue],Ne=x[2*ue+1];we>=e&&we<=o&&Ne>=r&&Ne<=u&&F.push(_[ue])}continue}const q=W+j>>1,Q=x[2*q],re=x[2*q+1];Q>=e&&Q<=o&&re>=r&&re<=u&&F.push(_[q]),(R===0?e<=Q:r<=re)&&(A.push(W),A.push(q-1),A.push(1-R)),(R===0?o>=Q:u>=re)&&(A.push(q+1),A.push(j),A.push(1-R))}return F}within(e,r,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:u,coords:_,nodeSize:x}=this,S=[0,u.length-1,0],A=[],F=o*o;for(;S.length;){const R=S.pop()||0,j=S.pop()||0,W=S.pop()||0;if(j-W<=x){for(let ue=W;ue<=j;ue++)Nd(_[2*ue],_[2*ue+1],e,r)<=F&&A.push(u[ue]);continue}const q=W+j>>1,Q=_[2*q],re=_[2*q+1];Nd(Q,re,e,r)<=F&&A.push(u[q]),(R===0?e-o<=Q:r-o<=re)&&(S.push(W),S.push(q-1),S.push(1-R)),(R===0?e+o>=Q:r+o>=re)&&(S.push(q+1),S.push(j),S.push(1-R))}return A}}function Uh(i,e,r,o,u,_){if(u-o<=r)return;const x=o+u>>1;jd(i,e,x,o,u,_),Uh(i,e,r,o,x-1,1-_),Uh(i,e,r,x+1,u,1-_)}function jd(i,e,r,o,u,_){for(;u>o;){if(u-o>600){const F=u-o+1,R=r-o+1,j=Math.log(F),W=.5*Math.exp(2*j/3),q=.5*Math.sqrt(j*W*(F-W)/F)*(R-F/2<0?-1:1);jd(i,e,r,Math.max(o,Math.floor(r-R*W/F+q)),Math.min(u,Math.floor(r+(F-R)*W/F+q)),_)}const x=e[2*r+_];let S=o,A=u;for(ac(i,e,o,r),e[2*u+_]>x&&ac(i,e,o,u);S<A;){for(ac(i,e,S,A),S++,A--;e[2*S+_]<x;)S++;for(;e[2*A+_]>x;)A--}e[2*o+_]===x?ac(i,e,o,A):(A++,ac(i,e,A,u)),A<=r&&(o=A+1),r<=A&&(u=A-1)}}function ac(i,e,r,o){Gh(i,r,o),Gh(e,2*r,2*o),Gh(e,2*r+1,2*o+1)}function Gh(i,e,r){const o=i[e];i[e]=i[r],i[r]=o}function Nd(i,e,r,o){const u=i-r,_=e-o;return u*u+_*_}var Wh;N.be=void 0,(Wh=N.be||(N.be={})).create="create",Wh.load="load",Wh.fullLoad="fullLoad";let $c=null,lc=[];const Hh=1e3/60,Xh="loadTime",qh="fullLoadTime",lm={mark(i){performance.mark(i)},frame(i){const e=i;$c!=null&&lc.push(e-$c),$c=e},clearMetrics(){$c=null,lc=[],performance.clearMeasures(Xh),performance.clearMeasures(qh);for(const i in N.be)performance.clearMarks(N.be[i])},getPerformanceMetrics(){performance.measure(Xh,N.be.create,N.be.load),performance.measure(qh,N.be.create,N.be.fullLoad);const i=performance.getEntriesByName(Xh)[0].duration,e=performance.getEntriesByName(qh)[0].duration,r=lc.length,o=1/(lc.reduce((_,x)=>_+x,0)/r/1e3),u=lc.filter(_=>_>Hh).reduce((_,x)=>_+(x-Hh)/Hh,0);return{loadTime:i,fullLoadTime:e,fps:o,percentDroppedFrames:u/(r+u)*100,totalFrames:r}}};N.$=Vr,N.A=hl,N.B=function(i){if(Ot==null){const e=i.navigator?i.navigator.userAgent:null;Ot=!!i.safari||!(!e||!(/\b(iPad|iPhone|iPod)\b/.test(e)||e.match("Safari")&&!e.match("Chrome")))}return Ot},N.C=class{constructor(i,e){this.target=i,this.mapId=e,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new Jp(()=>this.process()),this.subscription=function(r,o,u,_){return r.addEventListener(o,u,!1),{unsubscribe:()=>{r.removeEventListener(o,u,!1)}}}(this.target,"message",r=>this.receive(r)),this.globalScope=_t(self)?i:window}registerMessageHandler(i,e){this.messageHandlers[i]=e}sendAsync(i,e){return new Promise((r,o)=>{const u=Math.round(1e18*Math.random()).toString(36).substring(0,10);this.resolveRejects[u]={resolve:r,reject:o},e&&e.signal.addEventListener("abort",()=>{delete this.resolveRejects[u];const S={id:u,type:"<cancel>",origin:location.origin,targetMapId:i.targetMapId,sourceMapId:this.mapId};this.target.postMessage(S)},{once:!0});const _=[],x=Object.assign(Object.assign({},i),{id:u,sourceMapId:this.mapId,origin:location.origin,data:Pa(i.data,_)});this.target.postMessage(x,{transfer:_})})}receive(i){const e=i.data,r=e.id;if(!(e.origin!=="file://"&&location.origin!=="file://"&&e.origin!==location.origin||e.targetMapId&&this.mapId!==e.targetMapId)){if(e.type==="<cancel>"){delete this.tasks[r];const o=this.abortControllers[r];return delete this.abortControllers[r],void(o&&o.abort())}if(_t(self)||e.mustQueue)return this.tasks[r]=e,this.taskQueue.push(r),void this.invoker.trigger();this.processTask(r,e)}}process(){if(this.taskQueue.length===0)return;const i=this.taskQueue.shift(),e=this.tasks[i];delete this.tasks[i],this.taskQueue.length>0&&this.invoker.trigger(),e&&this.processTask(i,e)}processTask(i,e){return s(this,void 0,void 0,function*(){if(e.type==="<response>"){const u=this.resolveRejects[i];return delete this.resolveRejects[i],u?void(e.error?u.reject(_s(e.error)):u.resolve(_s(e.data))):void 0}if(!this.messageHandlers[e.type])return void this.completeTask(i,new Error(`Could not find a registered handler for ${e.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const r=_s(e.data),o=new AbortController;this.abortControllers[i]=o;try{const u=yield this.messageHandlers[e.type](e.sourceMapId,r,o);this.completeTask(i,null,u)}catch(u){this.completeTask(i,u)}})}completeTask(i,e,r){const o=[];delete this.abortControllers[i];const u={id:i,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:e?Pa(e):null,data:Pa(r,o)};this.target.postMessage(u,{transfer:o})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},N.D=ai,N.E=at,N.F=function(){var i=new hl(16);return hl!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i},N.G=Ae,N.H=function(i,e,r){var o,u,_,x,S,A,F,R,j,W,q,Q,re=r[0],ue=r[1],we=r[2];return e===i?(i[12]=e[0]*re+e[4]*ue+e[8]*we+e[12],i[13]=e[1]*re+e[5]*ue+e[9]*we+e[13],i[14]=e[2]*re+e[6]*ue+e[10]*we+e[14],i[15]=e[3]*re+e[7]*ue+e[11]*we+e[15]):(u=e[1],_=e[2],x=e[3],S=e[4],A=e[5],F=e[6],R=e[7],j=e[8],W=e[9],q=e[10],Q=e[11],i[0]=o=e[0],i[1]=u,i[2]=_,i[3]=x,i[4]=S,i[5]=A,i[6]=F,i[7]=R,i[8]=j,i[9]=W,i[10]=q,i[11]=Q,i[12]=o*re+S*ue+j*we+e[12],i[13]=u*re+A*ue+W*we+e[13],i[14]=_*re+F*ue+q*we+e[14],i[15]=x*re+R*ue+Q*we+e[15]),i},N.I=Ih,N.J=function(i,e,r){var o=r[0],u=r[1],_=r[2];return i[0]=e[0]*o,i[1]=e[1]*o,i[2]=e[2]*o,i[3]=e[3]*o,i[4]=e[4]*u,i[5]=e[5]*u,i[6]=e[6]*u,i[7]=e[7]*u,i[8]=e[8]*_,i[9]=e[9]*_,i[10]=e[10]*_,i[11]=e[11]*_,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i},N.K=xu,N.L=function(i,e){const r={};for(let o=0;o<e.length;o++){const u=e[o];u in i&&(r[u]=i[u])}return r},N.M=oa,N.N=md,N.O=gd,N.P=l,N.Q=ns,N.R=rs,N.S=w,N.T=Ko,N.U=E,N.V=ee,N.W=Br,N.X=B,N.Y=Gc,N.Z=class extends ie{},N._=s,N.a=ge,N.a$=function(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i},N.a0=Bh,N.a1=ct,N.a2=i=>{const e=window.document.createElement("video");return e.muted=!0,new Promise(r=>{e.onloadstart=()=>{r(e)};for(const o of i){const u=window.document.createElement("source");He(o)||(e.crossOrigin="Anonymous"),u.src=o,e.appendChild(u)}})},N.a3=function(){return xe++},N.a4=Ii,N.a5=gl,N.a6=Sa,N.a7=Oa,N.a8=hr,N.a9=wd,N.aA=function(i){if(i.type==="custom")return new Kp(i);switch(i.type){case"background":return new $p(i);case"circle":return new Ff(i);case"fill":return new Jf(i);case"fill-extrusion":return new fp(i);case"heatmap":return new Rf(i);case"hillshade":return new jf(i);case"line":return new bp(i);case"raster":return new Zp(i);case"symbol":return new Uc(i)}},N.aB=Je,N.aC=function(i,e){if(!i)return[{command:"setStyle",args:[e]}];let r=[];try{if(!ft(i.version,e.version))return[{command:"setStyle",args:[e]}];ft(i.center,e.center)||r.push({command:"setCenter",args:[e.center]}),ft(i.zoom,e.zoom)||r.push({command:"setZoom",args:[e.zoom]}),ft(i.bearing,e.bearing)||r.push({command:"setBearing",args:[e.bearing]}),ft(i.pitch,e.pitch)||r.push({command:"setPitch",args:[e.pitch]}),ft(i.sprite,e.sprite)||r.push({command:"setSprite",args:[e.sprite]}),ft(i.glyphs,e.glyphs)||r.push({command:"setGlyphs",args:[e.glyphs]}),ft(i.transition,e.transition)||r.push({command:"setTransition",args:[e.transition]}),ft(i.light,e.light)||r.push({command:"setLight",args:[e.light]}),ft(i.terrain,e.terrain)||r.push({command:"setTerrain",args:[e.terrain]}),ft(i.sky,e.sky)||r.push({command:"setSky",args:[e.sky]}),ft(i.projection,e.projection)||r.push({command:"setProjection",args:[e.projection]});const o={},u=[];(function(x,S,A,F){let R;for(R in S=S||{},x=x||{})Object.prototype.hasOwnProperty.call(x,R)&&(Object.prototype.hasOwnProperty.call(S,R)||lt(R,A,F));for(R in S)Object.prototype.hasOwnProperty.call(S,R)&&(Object.prototype.hasOwnProperty.call(x,R)?ft(x[R],S[R])||(x[R].type==="geojson"&&S[R].type==="geojson"&&Xt(x,S,R)?Lt(A,{command:"setGeoJSONSourceData",args:[R,S[R].data]}):St(R,S,A,F)):$t(R,S,A))})(i.sources,e.sources,u,o);const _=[];i.layers&&i.layers.forEach(x=>{"source"in x&&o[x.source]?r.push({command:"removeLayer",args:[x.id]}):_.push(x)}),r=r.concat(u),function(x,S,A){S=S||[];const F=(x=x||[]).map(vi),R=S.map(vi),j=x.reduce(Ci,{}),W=S.reduce(Ci,{}),q=F.slice(),Q=Object.create(null);let re,ue,we,Ne,Ee;for(let Re=0,et=0;Re<F.length;Re++)re=F[Re],Object.prototype.hasOwnProperty.call(W,re)?et++:(Lt(A,{command:"removeLayer",args:[re]}),q.splice(q.indexOf(re,et),1));for(let Re=0,et=0;Re<R.length;Re++)re=R[R.length-1-Re],q[q.length-1-Re]!==re&&(Object.prototype.hasOwnProperty.call(j,re)?(Lt(A,{command:"removeLayer",args:[re]}),q.splice(q.lastIndexOf(re,q.length-et),1)):et++,Ne=q[q.length-Re],Lt(A,{command:"addLayer",args:[W[re],Ne]}),q.splice(q.length-Re,0,re),Q[re]=!0);for(let Re=0;Re<R.length;Re++)if(re=R[Re],ue=j[re],we=W[re],!Q[re]&&!ft(ue,we))if(ft(ue.source,we.source)&&ft(ue["source-layer"],we["source-layer"])&&ft(ue.type,we.type)){for(Ee in di(ue.layout,we.layout,A,re,null,"setLayoutProperty"),di(ue.paint,we.paint,A,re,null,"setPaintProperty"),ft(ue.filter,we.filter)||Lt(A,{command:"setFilter",args:[re,we.filter]}),ft(ue.minzoom,we.minzoom)&&ft(ue.maxzoom,we.maxzoom)||Lt(A,{command:"setLayerZoomRange",args:[re,we.minzoom,we.maxzoom]}),ue)Object.prototype.hasOwnProperty.call(ue,Ee)&&Ee!=="layout"&&Ee!=="paint"&&Ee!=="filter"&&Ee!=="metadata"&&Ee!=="minzoom"&&Ee!=="maxzoom"&&(Ee.indexOf("paint.")===0?di(ue[Ee],we[Ee],A,re,Ee.slice(6),"setPaintProperty"):ft(ue[Ee],we[Ee])||Lt(A,{command:"setLayerProperty",args:[re,Ee,we[Ee]]}));for(Ee in we)Object.prototype.hasOwnProperty.call(we,Ee)&&!Object.prototype.hasOwnProperty.call(ue,Ee)&&Ee!=="layout"&&Ee!=="paint"&&Ee!=="filter"&&Ee!=="metadata"&&Ee!=="minzoom"&&Ee!=="maxzoom"&&(Ee.indexOf("paint.")===0?di(ue[Ee],we[Ee],A,re,Ee.slice(6),"setPaintProperty"):ft(ue[Ee],we[Ee])||Lt(A,{command:"setLayerProperty",args:[re,Ee,we[Ee]]}))}else Lt(A,{command:"removeLayer",args:[re]}),Ne=q[q.lastIndexOf(re)+1],Lt(A,{command:"addLayer",args:[we,Ne]})}(_,e.layers,r)}catch(o){console.warn("Unable to compute style diff:",o),r=[{command:"setStyle",args:[e]}]}return r},N.aD=function(i){const e=[],r=i.id;return r===void 0&&e.push({message:`layers.${r}: missing required property "id"`}),i.render===void 0&&e.push({message:`layers.${r}: missing required method "render"`}),i.renderingMode&&i.renderingMode!=="2d"&&i.renderingMode!=="3d"&&e.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),e},N.aE=function i(e,r){if(Array.isArray(e)){if(!Array.isArray(r)||e.length!==r.length)return!1;for(let o=0;o<e.length;o++)if(!i(e[o],r[o]))return!1;return!0}if(typeof e=="object"&&e!==null&&r!==null){if(typeof r!="object"||Object.keys(e).length!==Object.keys(r).length)return!1;for(const o in e)if(!i(e[o],r[o]))return!1;return!0}return e===r},N.aF=ze,N.aG=Ke,N.aH=class extends Aa{constructor(i,e){super(i,e),this.current=0}set(i){this.current!==i&&(this.current=i,this.gl.uniform1i(this.location,i))}},N.aI=Ic,N.aJ=class extends Aa{constructor(i,e){super(i,e),this.current=Pf}set(i){if(i[12]!==this.current[12]||i[0]!==this.current[0])return this.current=i,void this.gl.uniformMatrix4fv(this.location,!1,i);for(let e=1;e<16;e++)if(i[e]!==this.current[e]){this.current=i,this.gl.uniformMatrix4fv(this.location,!1,i);break}}},N.aK=cu,N.aL=class extends Aa{constructor(i,e){super(i,e),this.current=[0,0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]&&i[2]===this.current[2]||(this.current=i,this.gl.uniform3f(this.location,i[0],i[1],i[2]))}},N.aM=class extends Aa{constructor(i,e){super(i,e),this.current=[0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]||(this.current=i,this.gl.uniform2f(this.location,i[0],i[1]))}},N.aN=hu,N.aO=function(i,e,r,o,u,_,x){var S=1/(e-r),A=1/(o-u),F=1/(_-x);return i[0]=-2*S,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*A,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*F,i[11]=0,i[12]=(e+r)*S,i[13]=(u+o)*A,i[14]=(x+_)*F,i[15]=1,i},N.aP=zi,N.aQ=Lf,N.aR=class extends mt{},N.aS=Tp,N.aT=class extends Ht{},N.aU=function(i){return i<=1?1:Math.pow(2,Math.ceil(Math.log(i)/Math.LN2))},N.aV=Tu,N.aW=Mo,N.aX=class extends Ut{},N.aY=Gr,N.aZ=function(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]&&i[3]===e[3]&&i[4]===e[4]&&i[5]===e[5]&&i[6]===e[6]&&i[7]===e[7]&&i[8]===e[8]&&i[9]===e[9]&&i[10]===e[10]&&i[11]===e[11]&&i[12]===e[12]&&i[13]===e[13]&&i[14]===e[14]&&i[15]===e[15]},N.a_=function(i,e){var r=i[0],o=i[1],u=i[2],_=i[3],x=i[4],S=i[5],A=i[6],F=i[7],R=i[8],j=i[9],W=i[10],q=i[11],Q=i[12],re=i[13],ue=i[14],we=i[15],Ne=e[0],Ee=e[1],Re=e[2],et=e[3],xt=e[4],jt=e[5],hi=e[6],Gt=e[7],Bt=e[8],oi=e[9],Kt=e[10],Yt=e[11],ut=e[12],li=e[13],ni=e[14],bi=e[15];return Math.abs(r-Ne)<=En*Math.max(1,Math.abs(r),Math.abs(Ne))&&Math.abs(o-Ee)<=En*Math.max(1,Math.abs(o),Math.abs(Ee))&&Math.abs(u-Re)<=En*Math.max(1,Math.abs(u),Math.abs(Re))&&Math.abs(_-et)<=En*Math.max(1,Math.abs(_),Math.abs(et))&&Math.abs(x-xt)<=En*Math.max(1,Math.abs(x),Math.abs(xt))&&Math.abs(S-jt)<=En*Math.max(1,Math.abs(S),Math.abs(jt))&&Math.abs(A-hi)<=En*Math.max(1,Math.abs(A),Math.abs(hi))&&Math.abs(F-Gt)<=En*Math.max(1,Math.abs(F),Math.abs(Gt))&&Math.abs(R-Bt)<=En*Math.max(1,Math.abs(R),Math.abs(Bt))&&Math.abs(j-oi)<=En*Math.max(1,Math.abs(j),Math.abs(oi))&&Math.abs(W-Kt)<=En*Math.max(1,Math.abs(W),Math.abs(Kt))&&Math.abs(q-Yt)<=En*Math.max(1,Math.abs(q),Math.abs(Yt))&&Math.abs(Q-ut)<=En*Math.max(1,Math.abs(Q),Math.abs(ut))&&Math.abs(re-li)<=En*Math.max(1,Math.abs(re),Math.abs(li))&&Math.abs(ue-ni)<=En*Math.max(1,Math.abs(ue),Math.abs(ni))&&Math.abs(we-bi)<=En*Math.max(1,Math.abs(we),Math.abs(bi))},N.aa=function(i){const e={};if(i.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,o,u,_)=>{const x=u||_;return e[o]=!x||x.toLowerCase(),""}),e["max-age"]){const r=parseInt(e["max-age"],10);isNaN(r)?delete e["max-age"]:e["max-age"]=r}return e},N.ab=function(i,e){const r=[];for(const o in i)o in e||r.push(o);return r},N.ac=V,N.ad=function(i,e,r){var o=Math.sin(r),u=Math.cos(r),_=e[0],x=e[1],S=e[2],A=e[3],F=e[4],R=e[5],j=e[6],W=e[7];return e!==i&&(i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=_*u+F*o,i[1]=x*u+R*o,i[2]=S*u+j*o,i[3]=A*u+W*o,i[4]=F*u-_*o,i[5]=R*u-x*o,i[6]=j*u-S*o,i[7]=W*u-A*o,i},N.ae=function(i){var e=new hl(16);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],e},N.af=Oc,N.ag=function(i,e){let r=0,o=0;if(i.kind==="constant")o=i.layoutSize;else if(i.kind!=="source"){const{interpolationType:u,minZoom:_,maxZoom:x}=i,S=u?V(ji.interpolationFactor(u,e,_,x),0,1):0;i.kind==="camera"?o=fi.number(i.minSize,i.maxSize,S):r=S}return{uSizeT:r,uSize:o}},N.ai=function(i,{uSize:e,uSizeT:r},{lowerSize:o,upperSize:u}){return i.kind==="source"?o/so:i.kind==="composite"?fi.number(o/so,u/so,r):e},N.aj=Oh,N.ak=function(i,e,r,o){const u=e.y-i.y,_=e.x-i.x,x=o.y-r.y,S=o.x-r.x,A=x*_-S*u;if(A===0)return null;const F=(S*(i.y-r.y)-x*(i.x-r.x))/A;return new l(i.x+F*_,i.y+F*u)},N.al=Ed,N.am=pu,N.an=dh,N.ao=function(i){let e=1/0,r=1/0,o=-1/0,u=-1/0;for(const _ of i)e=Math.min(e,_.x),r=Math.min(r,_.y),o=Math.max(o,_.x),u=Math.max(u,_.y);return[e,r,o,u]},N.ap=Ur,N.ar=kh,N.as=function(i,e){var r=e[0],o=e[1],u=e[2],_=e[3],x=e[4],S=e[5],A=e[6],F=e[7],R=e[8],j=e[9],W=e[10],q=e[11],Q=e[12],re=e[13],ue=e[14],we=e[15],Ne=r*S-o*x,Ee=r*A-u*x,Re=r*F-_*x,et=o*A-u*S,xt=o*F-_*S,jt=u*F-_*A,hi=R*re-j*Q,Gt=R*ue-W*Q,Bt=R*we-q*Q,oi=j*ue-W*re,Kt=j*we-q*re,Yt=W*we-q*ue,ut=Ne*Yt-Ee*Kt+Re*oi+et*Bt-xt*Gt+jt*hi;return ut?(i[0]=(S*Yt-A*Kt+F*oi)*(ut=1/ut),i[1]=(u*Kt-o*Yt-_*oi)*ut,i[2]=(re*jt-ue*xt+we*et)*ut,i[3]=(W*xt-j*jt-q*et)*ut,i[4]=(A*Bt-x*Yt-F*Gt)*ut,i[5]=(r*Yt-u*Bt+_*Gt)*ut,i[6]=(ue*Re-Q*jt-we*Ee)*ut,i[7]=(R*jt-W*Re+q*Ee)*ut,i[8]=(x*Kt-S*Bt+F*hi)*ut,i[9]=(o*Bt-r*Kt-_*hi)*ut,i[10]=(Q*xt-re*Re+we*Ne)*ut,i[11]=(j*Re-R*xt-q*Ne)*ut,i[12]=(S*Gt-x*oi-A*hi)*ut,i[13]=(r*oi-o*Gt+u*hi)*ut,i[14]=(re*Ee-Q*et-ue*Ne)*ut,i[15]=(R*et-j*Ee+W*Ne)*ut,i):null},N.at=Nh,N.au=Mh,N.av=Vh,N.aw=function(){const i={},e=ae.$version;for(const r in ae.$root){const o=ae.$root[r];if(o.required){let u=null;u=r==="version"?e:o.type==="array"?[]:{},u!=null&&(i[r]=u)}}return i},N.ax=xc,N.ay=it,N.az=function(i){i=i.slice();const e=Object.create(null);for(let r=0;r<i.length;r++)e[i[r].id]=i[r];for(let r=0;r<i.length;r++)"ref"in i[r]&&(i[r]=pt(i[r],e[i[r].ref]));return i},N.b=ot,N.b0=function(i,e,r){return i[0]=e[0]*r[0],i[1]=e[1]*r[1],i[2]=e[2]*r[2],i[3]=e[3]*r[3],i},N.b1=function(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]+i[3]*e[3]},N.b2=$,N.b3=vd,N.b4=_d,N.b5=function(i,e,r,o,u){var _,x=1/Math.tan(e/2);return i[0]=x/r,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=x,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,u!=null&&u!==1/0?(i[10]=(u+o)*(_=1/(o-u)),i[14]=2*u*o*_):(i[10]=-1,i[14]=-2*o),i},N.b6=function(i,e,r){var o=Math.sin(r),u=Math.cos(r),_=e[4],x=e[5],S=e[6],A=e[7],F=e[8],R=e[9],j=e[10],W=e[11];return e!==i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[4]=_*u+F*o,i[5]=x*u+R*o,i[6]=S*u+j*o,i[7]=A*u+W*o,i[8]=F*u-_*o,i[9]=R*u-x*o,i[10]=j*u-S*o,i[11]=W*u-A*o,i},N.b7=O,N.b8=L,N.b9=function(i){return i*Math.PI/180},N.bA=Cn,N.bB=io,N.ba=function(i,e){return i[0]=e[0],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e[1],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=e[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},N.bb=class extends K{},N.bc=zh,N.bd=lm,N.bf=Ue,N.bg=function(i,e){ge.REGISTERED_PROTOCOLS[i]=e},N.bh=function(i){delete ge.REGISTERED_PROTOCOLS[i]},N.bi=function(i,e){const r={};for(let u=0;u<i.length;u++){const _=e&&e[i[u].id]||ms(i[u]);e&&(e[i[u].id]=_);let x=r[_];x||(x=r[_]=[]),x.push(i[u])}const o=[];for(const u in r)o.push(r[u]);return o},N.bj=Zt,N.bk=bd,N.bl=Cd,N.bm=ed,N.bn=function(i){i.bucket.createArrays(),i.bucket.tilePixelRatio=Br/(512*i.bucket.overscaling),i.bucket.compareText={},i.bucket.iconsNeedLinear=!1;const e=i.bucket.layers[0],r=e.layout,o=e._unevaluatedLayout._values,u={layoutIconSize:o["icon-size"].possiblyEvaluate(new hr(i.bucket.zoom+1),i.canonical),layoutTextSize:o["text-size"].possiblyEvaluate(new hr(i.bucket.zoom+1),i.canonical),textMaxSize:o["text-size"].possiblyEvaluate(new hr(18))};if(i.bucket.textSizeData.kind==="composite"){const{minZoom:F,maxZoom:R}=i.bucket.textSizeData;u.compositeTextSizes=[o["text-size"].possiblyEvaluate(new hr(F),i.canonical),o["text-size"].possiblyEvaluate(new hr(R),i.canonical)]}if(i.bucket.iconSizeData.kind==="composite"){const{minZoom:F,maxZoom:R}=i.bucket.iconSizeData;u.compositeIconSizes=[o["icon-size"].possiblyEvaluate(new hr(F),i.canonical),o["icon-size"].possiblyEvaluate(new hr(R),i.canonical)]}const _=r.get("text-line-height")*Ur,x=r.get("text-rotation-alignment")!=="viewport"&&r.get("symbol-placement")!=="point",S=r.get("text-keep-upright"),A=r.get("text-size");for(const F of i.bucket.features){const R=r.get("text-font").evaluate(F,{},i.canonical).join(","),j=A.evaluate(F,{},i.canonical),W=u.layoutTextSize.evaluate(F,{},i.canonical),q=u.layoutIconSize.evaluate(F,{},i.canonical),Q={horizontal:{},vertical:void 0},re=F.text;let ue,we=[0,0];if(re){const Re=re.toString(),et=r.get("text-letter-spacing").evaluate(F,{},i.canonical)*Ur,xt=sh(Re)?et:0,jt=r.get("text-anchor").evaluate(F,{},i.canonical),hi=Fd(e,F,i.canonical);if(!hi){const Kt=r.get("text-radial-offset").evaluate(F,{},i.canonical);we=Kt?Ld(jt,[Kt*Ur,jh]):r.get("text-offset").evaluate(F,{},i.canonical).map(Yt=>Yt*Ur)}let Gt=x?"center":r.get("text-justify").evaluate(F,{},i.canonical);const Bt=r.get("symbol-placement")==="point"?r.get("text-max-width").evaluate(F,{},i.canonical)*Ur:1/0,oi=()=>{i.bucket.allowVerticalPlacement&&Bl(Re)&&(Q.vertical=jc(re,i.glyphMap,i.glyphPositions,i.imagePositions,R,Bt,_,jt,"left",xt,we,N.ah.vertical,!0,W,j))};if(!x&&hi){const Kt=new Set;if(Gt==="auto")for(let ut=0;ut<hi.values.length;ut+=2)Kt.add(Nh(hi.values[ut]));else Kt.add(Gt);let Yt=!1;for(const ut of Kt)if(!Q.horizontal[ut])if(Yt)Q.horizontal[ut]=Q.horizontal[0];else{const li=jc(re,i.glyphMap,i.glyphPositions,i.imagePositions,R,Bt,_,"center",ut,xt,we,N.ah.horizontal,!1,W,j);li&&(Q.horizontal[ut]=li,Yt=li.positionedLines.length===1)}oi()}else{Gt==="auto"&&(Gt=Nh(jt));const Kt=jc(re,i.glyphMap,i.glyphPositions,i.imagePositions,R,Bt,_,jt,Gt,xt,we,N.ah.horizontal,!1,W,j);Kt&&(Q.horizontal[Gt]=Kt),oi(),Bl(Re)&&x&&S&&(Q.vertical=jc(re,i.glyphMap,i.glyphPositions,i.imagePositions,R,Bt,_,jt,Gt,xt,we,N.ah.vertical,!1,W,j))}}let Ne=!1;if(F.icon&&F.icon.name){const Re=i.imageMap[F.icon.name];Re&&(ue=Gp(i.imagePositions[F.icon.name],r.get("icon-offset").evaluate(F,{},i.canonical),r.get("icon-anchor").evaluate(F,{},i.canonical)),Ne=!!Re.sdf,i.bucket.sdfIcons===void 0?i.bucket.sdfIcons=Ne:i.bucket.sdfIcons!==Ne&&ht("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Re.pixelRatio!==i.bucket.pixelRatio||r.get("icon-rotate").constantOr(1)!==0)&&(i.bucket.iconsNeedLinear=!0))}const Ee=Rd(Q.horizontal)||Q.vertical;i.bucket.iconsInText=!!Ee&&Ee.iconsInText,(Ee||ue)&&om(i.bucket,F,Q,ue,i.imageMap,u,W,q,we,Ne,i.canonical)}i.showCollisionBoxes&&i.bucket.generateCollisionDebugBuffers()},N.bo=Sh,N.bp=bh,N.bq=Ch,N.br=ra,N.bs=Eh,N.bt=class{constructor(i){this._marks={start:[i.url,"start"].join("#"),end:[i.url,"end"].join("#"),measure:i.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let i=performance.getEntriesByName(this._marks.measure);return i.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),i=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),i}},N.bu=function(i,e,r,o,u){return s(this,void 0,void 0,function*(){if(E())try{return yield ee(i,e,r,o,u)}catch{}return function(_,x,S,A,F){const R=_.width,j=_.height;be&&me||(be=new OffscreenCanvas(R,j),me=be.getContext("2d",{willReadFrequently:!0})),be.width=R,be.height=j,me.drawImage(_,0,0,R,j);const W=me.getImageData(x,S,A,F);return me.clearRect(0,0,R,j),W.data}(i,e,r,o,u)})},N.bv=xd,N.bw=p,N.bx=C,N.by=Hu,N.bz=function(i){return i.message===ye},N.c=Ve,N.d=i=>s(void 0,void 0,void 0,function*(){if(i.byteLength===0)return createImageBitmap(new ImageData(1,1));const e=new Blob([new Uint8Array(i)],{type:"image/png"});try{return createImageBitmap(e)}catch(r){throw new Error(`Could not load image because of ${r.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}}),N.e=ne,N.f=i=>new Promise((e,r)=>{const o=new Image;o.onload=()=>{e(o),URL.revokeObjectURL(o.src),o.onload=null,window.requestAnimationFrame(()=>{o.src=wt})},o.onerror=()=>r(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const u=new Blob([new Uint8Array(i)],{type:"image/png"});o.src=i.byteLength?URL.createObjectURL(u):wt}),N.g=te,N.h=(i,e)=>Xe(ne(i,{type:"json"}),e),N.i=_t,N.j=Oe,N.k=$e,N.l=(i,e)=>Xe(ne(i,{type:"arrayBuffer"}),e),N.m=Xe,N.n=function(i){return new Eh(i).readFields(zp,[])},N.o=Zl,N.p=Qu,N.q=a,N.r=nh,N.s=He,N.t=Rl,N.u=Wt,N.v=ae,N.w=ht,N.x=Ta,N.y=function([i,e,r]){return e+=90,e*=Math.PI/180,r*=Math.PI/180,{x:i*Math.cos(e)*Math.sin(r),y:i*Math.sin(e)*Math.sin(r),z:i*Math.cos(r)}},N.z=fi}),he("worker",["./shared"],function(N){class s{constructor(H){this.keyCache={},H&&this.replace(H)}replace(H){this._layerConfigs={},this._layers={},this.update(H,[])}update(H,X){for(const de of H){this._layerConfigs[de.id]=de;const Te=this._layers[de.id]=N.aA(de);Te._featureFilter=N.a6(Te.filter),this.keyCache[de.id]&&delete this.keyCache[de.id]}for(const de of X)delete this.keyCache[de],delete this._layerConfigs[de],delete this._layers[de];this.familiesBySource={};const J=N.bi(Object.values(this._layerConfigs),this.keyCache);for(const de of J){const Te=de.map(Qe=>this._layers[Qe.id]),De=Te[0];if(De.visibility==="none")continue;const Le=De.source||"";let Ce=this.familiesBySource[Le];Ce||(Ce=this.familiesBySource[Le]={});const Ge=De.sourceLayer||"_geojsonTileLayer";let gt=Ce[Ge];gt||(gt=Ce[Ge]=[]),gt.push(Te)}}}class p{constructor(H){const X={},J=[];for(const Le in H){const Ce=H[Le],Ge=X[Le]={};for(const gt in Ce){const Qe=Ce[+gt];if(!Qe||Qe.bitmap.width===0||Qe.bitmap.height===0)continue;const st={x:0,y:0,w:Qe.bitmap.width+2,h:Qe.bitmap.height+2};J.push(st),Ge[gt]={rect:st,metrics:Qe.metrics}}}const{w:de,h:Te}=N.p(J),De=new N.o({width:de||1,height:Te||1});for(const Le in H){const Ce=H[Le];for(const Ge in Ce){const gt=Ce[+Ge];if(!gt||gt.bitmap.width===0||gt.bitmap.height===0)continue;const Qe=X[Le][Ge].rect;N.o.copy(gt.bitmap,De,{x:0,y:0},{x:Qe.x+1,y:Qe.y+1},gt.bitmap)}}this.image=De,this.positions=X}}N.bj("GlyphAtlas",p);class C{constructor(H){this.tileID=new N.Q(H.tileID.overscaledZ,H.tileID.wrap,H.tileID.canonical.z,H.tileID.canonical.x,H.tileID.canonical.y),this.uid=H.uid,this.zoom=H.zoom,this.pixelRatio=H.pixelRatio,this.tileSize=H.tileSize,this.source=H.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=H.showCollisionBoxes,this.collectResourceTiming=!!H.collectResourceTiming,this.returnDependencies=!!H.returnDependencies,this.promoteId=H.promoteId,this.inFlightDependencies=[]}parse(H,X,J,de){return N._(this,void 0,void 0,function*(){this.status="parsing",this.data=H,this.collisionBoxArray=new N.a4;const Te=new N.bk(Object.keys(H.layers).sort()),De=new N.bl(this.tileID,this.promoteId);De.bucketLayerIDs=[];const Le={},Ce={featureIndex:De,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:J},Ge=X.familiesBySource[this.source];for(const ui in Ge){const dr=H.layers[ui];if(!dr)continue;dr.version===1&&N.w(`Vector tile source "${this.source}" layer "${ui}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Lr=Te.encode(ui),Qr=[];for(let en=0;en<dr.length;en++){const Fr=dr.feature(en),hs=De.getId(Fr,ui);Qr.push({feature:Fr,id:hs,index:en,sourceLayerIndex:Lr})}for(const en of Ge[ui]){const Fr=en[0];Fr.source!==this.source&&N.w(`layer.source = ${Fr.source} does not equal this.source = ${this.source}`),Fr.minzoom&&this.zoom<Math.floor(Fr.minzoom)||Fr.maxzoom&&this.zoom>=Fr.maxzoom||Fr.visibility!=="none"&&(b(en,this.zoom,J),(Le[Fr.id]=Fr.createBucket({index:De.bucketLayerIDs.length,layers:en,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Lr,sourceID:this.source})).populate(Qr,Ce,this.tileID.canonical),De.bucketLayerIDs.push(en.map(hs=>hs.id)))}}const gt=N.aF(Ce.glyphDependencies,ui=>Object.keys(ui).map(Number));this.inFlightDependencies.forEach(ui=>ui==null?void 0:ui.abort()),this.inFlightDependencies=[];let Qe=Promise.resolve({});if(Object.keys(gt).length){const ui=new AbortController;this.inFlightDependencies.push(ui),Qe=de.sendAsync({type:"GG",data:{stacks:gt,source:this.source,tileID:this.tileID,type:"glyphs"}},ui)}const st=Object.keys(Ce.iconDependencies);let ti=Promise.resolve({});if(st.length){const ui=new AbortController;this.inFlightDependencies.push(ui),ti=de.sendAsync({type:"GI",data:{icons:st,source:this.source,tileID:this.tileID,type:"icons"}},ui)}const ei=Object.keys(Ce.patternDependencies);let xi=Promise.resolve({});if(ei.length){const ui=new AbortController;this.inFlightDependencies.push(ui),xi=de.sendAsync({type:"GI",data:{icons:ei,source:this.source,tileID:this.tileID,type:"patterns"}},ui)}const[mi,Pi,Li]=yield Promise.all([Qe,ti,xi]),tr=new p(mi),Mr=new N.bm(Pi,Li);for(const ui in Le){const dr=Le[ui];dr instanceof N.a5?(b(dr.layers,this.zoom,J),N.bn({bucket:dr,glyphMap:mi,glyphPositions:tr.positions,imageMap:Pi,imagePositions:Mr.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical})):dr.hasPattern&&(dr instanceof N.bo||dr instanceof N.bp||dr instanceof N.bq)&&(b(dr.layers,this.zoom,J),dr.addFeatures(Ce,this.tileID.canonical,Mr.patternPositions))}return this.status="done",{buckets:Object.values(Le).filter(ui=>!ui.isEmpty()),featureIndex:De,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:tr.image,imageAtlas:Mr,glyphMap:this.returnDependencies?mi:null,iconMap:this.returnDependencies?Pi:null,glyphPositions:this.returnDependencies?tr.positions:null}})}}function b(le,H,X){const J=new N.a8(H);for(const de of le)de.recalculate(J,X)}class l{constructor(H,X,J){this.actor=H,this.layerIndex=X,this.availableImages=J,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(H,X){return N._(this,void 0,void 0,function*(){const J=yield N.l(H.request,X);try{return{vectorTile:new N.br.VectorTile(new N.bs(J.data)),rawData:J.data,cacheControl:J.cacheControl,expires:J.expires}}catch(de){const Te=new Uint8Array(J.data);let De=`Unable to parse the tile at ${H.request.url}, `;throw De+=Te[0]===31&&Te[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${de.message}`,new Error(De)}})}loadTile(H){return N._(this,void 0,void 0,function*(){const X=H.uid,J=!!(H&&H.request&&H.request.collectResourceTiming)&&new N.bt(H.request),de=new C(H);this.loading[X]=de;const Te=new AbortController;de.abort=Te;try{const De=yield this.loadVectorTile(H,Te);if(delete this.loading[X],!De)return null;const Le=De.rawData,Ce={};De.expires&&(Ce.expires=De.expires),De.cacheControl&&(Ce.cacheControl=De.cacheControl);const Ge={};if(J){const Qe=J.finish();Qe&&(Ge.resourceTiming=JSON.parse(JSON.stringify(Qe)))}de.vectorTile=De.vectorTile;const gt=de.parse(De.vectorTile,this.layerIndex,this.availableImages,this.actor);this.loaded[X]=de,this.fetching[X]={rawTileData:Le,cacheControl:Ce,resourceTiming:Ge};try{const Qe=yield gt;return N.e({rawTileData:Le.slice(0)},Qe,Ce,Ge)}finally{delete this.fetching[X]}}catch(De){throw delete this.loading[X],de.status="done",this.loaded[X]=de,De}})}reloadTile(H){return N._(this,void 0,void 0,function*(){const X=H.uid;if(!this.loaded||!this.loaded[X])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const J=this.loaded[X];if(J.showCollisionBoxes=H.showCollisionBoxes,J.status==="parsing"){const de=yield J.parse(J.vectorTile,this.layerIndex,this.availableImages,this.actor);let Te;if(this.fetching[X]){const{rawTileData:De,cacheControl:Le,resourceTiming:Ce}=this.fetching[X];delete this.fetching[X],Te=N.e({rawTileData:De.slice(0)},de,Le,Ce)}else Te=de;return Te}if(J.status==="done"&&J.vectorTile)return J.parse(J.vectorTile,this.layerIndex,this.availableImages,this.actor)})}abortTile(H){return N._(this,void 0,void 0,function*(){const X=this.loading,J=H.uid;X&&X[J]&&X[J].abort&&(X[J].abort.abort(),delete X[J])})}removeTile(H){return N._(this,void 0,void 0,function*(){this.loaded&&this.loaded[H.uid]&&delete this.loaded[H.uid]})}}class c{constructor(){this.loaded={}}loadTile(H){return N._(this,void 0,void 0,function*(){const{uid:X,encoding:J,rawImageData:de,redFactor:Te,greenFactor:De,blueFactor:Le,baseShift:Ce}=H,Ge=de.width+2,gt=de.height+2,Qe=N.b(de)?new N.R({width:Ge,height:gt},yield N.bu(de,-1,-1,Ge,gt)):de,st=new N.bv(X,Qe,J,Te,De,Le,Ce);return this.loaded=this.loaded||{},this.loaded[X]=st,st})}removeTile(H){const X=this.loaded,J=H.uid;X&&X[J]&&delete X[J]}}function h(le,H){if(le.length!==0){m(le[0],H);for(var X=1;X<le.length;X++)m(le[X],!H)}}function m(le,H){for(var X=0,J=0,de=0,Te=le.length,De=Te-1;de<Te;De=de++){var Le=(le[de][0]-le[De][0])*(le[De][1]+le[de][1]),Ce=X+Le;J+=Math.abs(X)>=Math.abs(Le)?X-Ce+Le:Le-Ce+X,X=Ce}X+J>=0!=!!H&&le.reverse()}var g=N.bw(function le(H,X){var J,de=H&&H.type;if(de==="FeatureCollection")for(J=0;J<H.features.length;J++)le(H.features[J],X);else if(de==="GeometryCollection")for(J=0;J<H.geometries.length;J++)le(H.geometries[J],X);else if(de==="Feature")le(H.geometry,X);else if(de==="Polygon")h(H.coordinates,X);else if(de==="MultiPolygon")for(J=0;J<H.coordinates.length;J++)h(H.coordinates[J],X);return H});const d=N.br.VectorTileFeature.prototype.toGeoJSON;var w={exports:{}},E=N.bx,O=N.br.VectorTileFeature,L=V;function V(le,H){this.options=H||{},this.features=le,this.length=le.length}function $(le,H){this.id=typeof le.id=="number"?le.id:void 0,this.type=le.type,this.rawGeometry=le.type===1?[le.geometry]:le.geometry,this.properties=le.tags,this.extent=H||4096}V.prototype.feature=function(le){return new $(this.features[le],this.options.extent)},$.prototype.loadGeometry=function(){var le=this.rawGeometry;this.geometry=[];for(var H=0;H<le.length;H++){for(var X=le[H],J=[],de=0;de<X.length;de++)J.push(new E(X[de][0],X[de][1]));this.geometry.push(J)}return this.geometry},$.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var le=this.geometry,H=1/0,X=-1/0,J=1/0,de=-1/0,Te=0;Te<le.length;Te++)for(var De=le[Te],Le=0;Le<De.length;Le++){var Ce=De[Le];H=Math.min(H,Ce.x),X=Math.max(X,Ce.x),J=Math.min(J,Ce.y),de=Math.max(de,Ce.y)}return[H,J,X,de]},$.prototype.toGeoJSON=O.prototype.toGeoJSON;var ne=N.by,xe=L;function ze(le){var H=new ne;return function(X,J){for(var de in X.layers)J.writeMessage(3,Ke,X.layers[de])}(le,H),H.finish()}function Ke(le,H){var X;H.writeVarintField(15,le.version||1),H.writeStringField(1,le.name||""),H.writeVarintField(5,le.extent||4096);var J={keys:[],values:[],keycache:{},valuecache:{}};for(X=0;X<le.length;X++)J.feature=le.feature(X),H.writeMessage(2,Je,J);var de=J.keys;for(X=0;X<de.length;X++)H.writeStringField(3,de[X]);var Te=J.values;for(X=0;X<Te.length;X++)H.writeMessage(4,Ot,Te[X])}function Je(le,H){var X=le.feature;X.id!==void 0&&H.writeVarintField(1,X.id),H.writeMessage(2,tt,le),H.writeVarintField(3,X.type),H.writeMessage(4,_t,X)}function tt(le,H){var X=le.feature,J=le.keys,de=le.values,Te=le.keycache,De=le.valuecache;for(var Le in X.properties){var Ce=X.properties[Le],Ge=Te[Le];if(Ce!==null){Ge===void 0&&(J.push(Le),Te[Le]=Ge=J.length-1),H.writeVarint(Ge);var gt=typeof Ce;gt!=="string"&&gt!=="boolean"&&gt!=="number"&&(Ce=JSON.stringify(Ce));var Qe=gt+":"+Ce,st=De[Qe];st===void 0&&(de.push(Ce),De[Qe]=st=de.length-1),H.writeVarint(st)}}}function ht(le,H){return(H<<3)+(7&le)}function nt(le){return le<<1^le>>31}function _t(le,H){for(var X=le.loadGeometry(),J=le.type,de=0,Te=0,De=X.length,Le=0;Le<De;Le++){var Ce=X[Le],Ge=1;J===1&&(Ge=Ce.length),H.writeVarint(ht(1,Ge));for(var gt=J===3?Ce.length-1:Ce.length,Qe=0;Qe<gt;Qe++){Qe===1&&J!==1&&H.writeVarint(ht(2,gt-1));var st=Ce[Qe].x-de,ti=Ce[Qe].y-Te;H.writeVarint(nt(st)),H.writeVarint(nt(ti)),de+=st,Te+=ti}J===3&&H.writeVarint(ht(7,1))}}function Ot(le,H){var X=typeof le;X==="string"?H.writeStringField(1,le):X==="boolean"?H.writeBooleanField(7,le):X==="number"&&(le%1!=0?H.writeDoubleField(3,le):le<0?H.writeSVarintField(6,le):H.writeVarintField(5,le))}w.exports=ze,w.exports.fromVectorTileJs=ze,w.exports.fromGeojsonVt=function(le,H){H=H||{};var X={};for(var J in le)X[J]=new xe(le[J].features,H),X[J].name=J,X[J].version=H.version,X[J].extent=H.extent;return ze({layers:X})},w.exports.GeoJSONWrapper=xe;var ot=N.bw(w.exports);const wt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:le=>le},ee=Math.fround||(be=new Float32Array(1),le=>(be[0]=+le,be[0]));var be;const me=3,ye=5,Ve=6;class ge{constructor(H){this.options=Object.assign(Object.create(wt),H),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(H){const{log:X,minZoom:J,maxZoom:de}=this.options;X&&console.time("total time");const Te=`prepare ${H.length} points`;X&&console.time(Te),this.points=H;const De=[];for(let Ce=0;Ce<H.length;Ce++){const Ge=H[Ce];if(!Ge.geometry)continue;const[gt,Qe]=Ge.geometry.coordinates,st=ee(Ue(gt)),ti=ee(it(Qe));De.push(st,ti,1/0,Ce,-1,1),this.options.reduce&&De.push(0)}let Le=this.trees[de+1]=this._createTree(De);X&&console.timeEnd(Te);for(let Ce=de;Ce>=J;Ce--){const Ge=+Date.now();Le=this.trees[Ce]=this._createTree(this._cluster(Le,Ce)),X&&console.log("z%d: %d clusters in %dms",Ce,Le.numItems,+Date.now()-Ge)}return X&&console.timeEnd("total time"),this}getClusters(H,X){let J=((H[0]+180)%360+360)%360-180;const de=Math.max(-90,Math.min(90,H[1]));let Te=H[2]===180?180:((H[2]+180)%360+360)%360-180;const De=Math.max(-90,Math.min(90,H[3]));if(H[2]-H[0]>=360)J=-180,Te=180;else if(J>Te){const Qe=this.getClusters([J,de,180,De],X),st=this.getClusters([-180,de,Te,De],X);return Qe.concat(st)}const Le=this.trees[this._limitZoom(X)],Ce=Le.range(Ue(J),it(De),Ue(Te),it(de)),Ge=Le.data,gt=[];for(const Qe of Ce){const st=this.stride*Qe;gt.push(Ge[st+ye]>1?te(Ge,st,this.clusterProps):this.points[Ge[st+me]])}return gt}getChildren(H){const X=this._getOriginId(H),J=this._getOriginZoom(H),de="No cluster with the specified id.",Te=this.trees[J];if(!Te)throw new Error(de);const De=Te.data;if(X*this.stride>=De.length)throw new Error(de);const Le=this.options.radius/(this.options.extent*Math.pow(2,J-1)),Ce=Te.within(De[X*this.stride],De[X*this.stride+1],Le),Ge=[];for(const gt of Ce){const Qe=gt*this.stride;De[Qe+4]===H&&Ge.push(De[Qe+ye]>1?te(De,Qe,this.clusterProps):this.points[De[Qe+me]])}if(Ge.length===0)throw new Error(de);return Ge}getLeaves(H,X,J){const de=[];return this._appendLeaves(de,H,X=X||10,J=J||0,0),de}getTile(H,X,J){const de=this.trees[this._limitZoom(H)],Te=Math.pow(2,H),{extent:De,radius:Le}=this.options,Ce=Le/De,Ge=(J-Ce)/Te,gt=(J+1+Ce)/Te,Qe={features:[]};return this._addTileFeatures(de.range((X-Ce)/Te,Ge,(X+1+Ce)/Te,gt),de.data,X,J,Te,Qe),X===0&&this._addTileFeatures(de.range(1-Ce/Te,Ge,1,gt),de.data,Te,J,Te,Qe),X===Te-1&&this._addTileFeatures(de.range(0,Ge,Ce/Te,gt),de.data,-1,J,Te,Qe),Qe.features.length?Qe:null}getClusterExpansionZoom(H){let X=this._getOriginZoom(H)-1;for(;X<=this.options.maxZoom;){const J=this.getChildren(H);if(X++,J.length!==1)break;H=J[0].properties.cluster_id}return X}_appendLeaves(H,X,J,de,Te){const De=this.getChildren(X);for(const Le of De){const Ce=Le.properties;if(Ce&&Ce.cluster?Te+Ce.point_count<=de?Te+=Ce.point_count:Te=this._appendLeaves(H,Ce.cluster_id,J,de,Te):Te<de?Te++:H.push(Le),H.length===J)break}return Te}_createTree(H){const X=new N.av(H.length/this.stride|0,this.options.nodeSize,Float32Array);for(let J=0;J<H.length;J+=this.stride)X.add(H[J],H[J+1]);return X.finish(),X.data=H,X}_addTileFeatures(H,X,J,de,Te,De){for(const Le of H){const Ce=Le*this.stride,Ge=X[Ce+ye]>1;let gt,Qe,st;if(Ge)gt=Ae(X,Ce,this.clusterProps),Qe=X[Ce],st=X[Ce+1];else{const xi=this.points[X[Ce+me]];gt=xi.properties;const[mi,Pi]=xi.geometry.coordinates;Qe=Ue(mi),st=it(Pi)}const ti={type:1,geometry:[[Math.round(this.options.extent*(Qe*Te-J)),Math.round(this.options.extent*(st*Te-de))]],tags:gt};let ei;ei=Ge||this.options.generateId?X[Ce+me]:this.points[X[Ce+me]].id,ei!==void 0&&(ti.id=ei),De.features.push(ti)}}_limitZoom(H){return Math.max(this.options.minZoom,Math.min(Math.floor(+H),this.options.maxZoom+1))}_cluster(H,X){const{radius:J,extent:de,reduce:Te,minPoints:De}=this.options,Le=J/(de*Math.pow(2,X)),Ce=H.data,Ge=[],gt=this.stride;for(let Qe=0;Qe<Ce.length;Qe+=gt){if(Ce[Qe+2]<=X)continue;Ce[Qe+2]=X;const st=Ce[Qe],ti=Ce[Qe+1],ei=H.within(Ce[Qe],Ce[Qe+1],Le),xi=Ce[Qe+ye];let mi=xi;for(const Pi of ei){const Li=Pi*gt;Ce[Li+2]>X&&(mi+=Ce[Li+ye])}if(mi>xi&&mi>=De){let Pi,Li=st*xi,tr=ti*xi,Mr=-1;const ui=((Qe/gt|0)<<5)+(X+1)+this.points.length;for(const dr of ei){const Lr=dr*gt;if(Ce[Lr+2]<=X)continue;Ce[Lr+2]=X;const Qr=Ce[Lr+ye];Li+=Ce[Lr]*Qr,tr+=Ce[Lr+1]*Qr,Ce[Lr+4]=ui,Te&&(Pi||(Pi=this._map(Ce,Qe,!0),Mr=this.clusterProps.length,this.clusterProps.push(Pi)),Te(Pi,this._map(Ce,Lr)))}Ce[Qe+4]=ui,Ge.push(Li/mi,tr/mi,1/0,ui,-1,mi),Te&&Ge.push(Mr)}else{for(let Pi=0;Pi<gt;Pi++)Ge.push(Ce[Qe+Pi]);if(mi>1)for(const Pi of ei){const Li=Pi*gt;if(!(Ce[Li+2]<=X)){Ce[Li+2]=X;for(let tr=0;tr<gt;tr++)Ge.push(Ce[Li+tr])}}}}return Ge}_getOriginId(H){return H-this.points.length>>5}_getOriginZoom(H){return(H-this.points.length)%32}_map(H,X,J){if(H[X+ye]>1){const De=this.clusterProps[H[X+Ve]];return J?Object.assign({},De):De}const de=this.points[H[X+me]].properties,Te=this.options.map(de);return J&&Te===de?Object.assign({},Te):Te}}function te(le,H,X){return{type:"Feature",id:le[H+me],properties:Ae(le,H,X),geometry:{type:"Point",coordinates:[(J=le[H],360*(J-.5)),Xe(le[H+1])]}};var J}function Ae(le,H,X){const J=le[H+ye],de=J>=1e4?`${Math.round(J/1e3)}k`:J>=1e3?Math.round(J/100)/10+"k":J,Te=le[H+Ve],De=Te===-1?{}:Object.assign({},X[Te]);return Object.assign(De,{cluster:!0,cluster_id:le[H+me],point_count:J,point_count_abbreviated:de})}function Ue(le){return le/360+.5}function it(le){const H=Math.sin(le*Math.PI/180),X=.5-.25*Math.log((1+H)/(1-H))/Math.PI;return X<0?0:X>1?1:X}function Xe(le){const H=(180-360*le)*Math.PI/180;return 360*Math.atan(Math.exp(H))/Math.PI-90}function He(le,H,X,J){for(var de,Te=J,De=X-H>>1,Le=X-H,Ce=le[H],Ge=le[H+1],gt=le[X],Qe=le[X+1],st=H+3;st<X;st+=3){var ti=vt(le[st],le[st+1],Ce,Ge,gt,Qe);if(ti>Te)de=st,Te=ti;else if(ti===Te){var ei=Math.abs(st-De);ei<Le&&(de=st,Le=ei)}}Te>J&&(de-H>3&&He(le,H,de,J),le[de+2]=Te,X-de>3&&He(le,de,X,J))}function vt(le,H,X,J,de,Te){var De=de-X,Le=Te-J;if(De!==0||Le!==0){var Ce=((le-X)*De+(H-J)*Le)/(De*De+Le*Le);Ce>1?(X=de,J=Te):Ce>0&&(X+=De*Ce,J+=Le*Ce)}return(De=le-X)*De+(Le=H-J)*Le}function Et(le,H,X,J){var de={id:le===void 0?null:le,type:H,geometry:X,tags:J,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(Te){var De=Te.geometry,Le=Te.type;if(Le==="Point"||Le==="MultiPoint"||Le==="LineString")$e(Te,De);else if(Le==="Polygon"||Le==="MultiLineString")for(var Ce=0;Ce<De.length;Ce++)$e(Te,De[Ce]);else if(Le==="MultiPolygon")for(Ce=0;Ce<De.length;Ce++)for(var Ge=0;Ge<De[Ce].length;Ge++)$e(Te,De[Ce][Ge])}(de),de}function $e(le,H){for(var X=0;X<H.length;X+=3)le.minX=Math.min(le.minX,H[X]),le.minY=Math.min(le.minY,H[X+1]),le.maxX=Math.max(le.maxX,H[X]),le.maxY=Math.max(le.maxY,H[X+1])}function Oe(le,H,X,J){if(H.geometry){var de=H.geometry.coordinates,Te=H.geometry.type,De=Math.pow(X.tolerance/((1<<X.maxZoom)*X.extent),2),Le=[],Ce=H.id;if(X.promoteId?Ce=H.properties[X.promoteId]:X.generateId&&(Ce=J||0),Te==="Point")at(de,Le);else if(Te==="MultiPoint")for(var Ge=0;Ge<de.length;Ge++)at(de[Ge],Le);else if(Te==="LineString")ae(de,Le,De,!1);else if(Te==="MultiLineString"){if(X.lineMetrics){for(Ge=0;Ge<de.length;Ge++)ae(de[Ge],Le=[],De,!1),le.push(Et(Ce,"LineString",Le,H.properties));return}Ze(de,Le,De,!1)}else if(Te==="Polygon")Ze(de,Le,De,!0);else{if(Te!=="MultiPolygon"){if(Te==="GeometryCollection"){for(Ge=0;Ge<H.geometry.geometries.length;Ge++)Oe(le,{id:Ce,geometry:H.geometry.geometries[Ge],properties:H.properties},X,J);return}throw new Error("Input data is not a valid GeoJSON object.")}for(Ge=0;Ge<de.length;Ge++){var gt=[];Ze(de[Ge],gt,De,!0),Le.push(gt)}}le.push(Et(Ce,Te,Le,H.properties))}}function at(le,H){H.push(pt(le[0])),H.push(ft(le[1])),H.push(0)}function ae(le,H,X,J){for(var de,Te,De=0,Le=0;Le<le.length;Le++){var Ce=pt(le[Le][0]),Ge=ft(le[Le][1]);H.push(Ce),H.push(Ge),H.push(0),Le>0&&(De+=J?(de*Ge-Ce*Te)/2:Math.sqrt(Math.pow(Ce-de,2)+Math.pow(Ge-Te,2))),de=Ce,Te=Ge}var gt=H.length-3;H[2]=1,He(H,0,gt,X),H[gt+2]=1,H.size=Math.abs(De),H.start=0,H.end=H.size}function Ze(le,H,X,J){for(var de=0;de<le.length;de++){var Te=[];ae(le[de],Te,X,J),H.push(Te)}}function pt(le){return le/360+.5}function ft(le){var H=Math.sin(le*Math.PI/180),X=.5-.25*Math.log((1+H)/(1-H))/Math.PI;return X<0?0:X>1?1:X}function Lt(le,H,X,J,de,Te,De,Le){if(J/=H,Te>=(X/=H)&&De<J)return le;if(De<X||Te>=J)return null;for(var Ce=[],Ge=0;Ge<le.length;Ge++){var gt=le[Ge],Qe=gt.geometry,st=gt.type,ti=de===0?gt.minX:gt.minY,ei=de===0?gt.maxX:gt.maxY;if(ti>=X&&ei<J)Ce.push(gt);else if(!(ei<X||ti>=J)){var xi=[];if(st==="Point"||st==="MultiPoint")$t(Qe,xi,X,J,de);else if(st==="LineString")lt(Qe,xi,X,J,de,!1,Le.lineMetrics);else if(st==="MultiLineString")Xt(Qe,xi,X,J,de,!1);else if(st==="Polygon")Xt(Qe,xi,X,J,de,!0);else if(st==="MultiPolygon")for(var mi=0;mi<Qe.length;mi++){var Pi=[];Xt(Qe[mi],Pi,X,J,de,!0),Pi.length&&xi.push(Pi)}if(xi.length){if(Le.lineMetrics&&st==="LineString"){for(mi=0;mi<xi.length;mi++)Ce.push(Et(gt.id,st,xi[mi],gt.tags));continue}st!=="LineString"&&st!=="MultiLineString"||(xi.length===1?(st="LineString",xi=xi[0]):st="MultiLineString"),st!=="Point"&&st!=="MultiPoint"||(st=xi.length===3?"Point":"MultiPoint"),Ce.push(Et(gt.id,st,xi,gt.tags))}}}return Ce.length?Ce:null}function $t(le,H,X,J,de){for(var Te=0;Te<le.length;Te+=3){var De=le[Te+de];De>=X&&De<=J&&(H.push(le[Te]),H.push(le[Te+1]),H.push(le[Te+2]))}}function lt(le,H,X,J,de,Te,De){for(var Le,Ce,Ge=St(le),gt=de===0?vi:Ci,Qe=le.start,st=0;st<le.length-3;st+=3){var ti=le[st],ei=le[st+1],xi=le[st+2],mi=le[st+3],Pi=le[st+4],Li=de===0?ti:ei,tr=de===0?mi:Pi,Mr=!1;De&&(Le=Math.sqrt(Math.pow(ti-mi,2)+Math.pow(ei-Pi,2))),Li<X?tr>X&&(Ce=gt(Ge,ti,ei,mi,Pi,X),De&&(Ge.start=Qe+Le*Ce)):Li>J?tr<J&&(Ce=gt(Ge,ti,ei,mi,Pi,J),De&&(Ge.start=Qe+Le*Ce)):di(Ge,ti,ei,xi),tr<X&&Li>=X&&(Ce=gt(Ge,ti,ei,mi,Pi,X),Mr=!0),tr>J&&Li<=J&&(Ce=gt(Ge,ti,ei,mi,Pi,J),Mr=!0),!Te&&Mr&&(De&&(Ge.end=Qe+Le*Ce),H.push(Ge),Ge=St(le)),De&&(Qe+=Le)}var ui=le.length-3;ti=le[ui],ei=le[ui+1],xi=le[ui+2],(Li=de===0?ti:ei)>=X&&Li<=J&&di(Ge,ti,ei,xi),ui=Ge.length-3,Te&&ui>=3&&(Ge[ui]!==Ge[0]||Ge[ui+1]!==Ge[1])&&di(Ge,Ge[0],Ge[1],Ge[2]),Ge.length&&H.push(Ge)}function St(le){var H=[];return H.size=le.size,H.start=le.start,H.end=le.end,H}function Xt(le,H,X,J,de,Te){for(var De=0;De<le.length;De++)lt(le[De],H,X,J,de,Te,!1)}function di(le,H,X,J){le.push(H),le.push(X),le.push(J)}function vi(le,H,X,J,de,Te){var De=(Te-H)/(J-H);return le.push(Te),le.push(X+(de-X)*De),le.push(1),De}function Ci(le,H,X,J,de,Te){var De=(Te-X)/(de-X);return le.push(H+(J-H)*De),le.push(Te),le.push(1),De}function ct(le,H){for(var X=[],J=0;J<le.length;J++){var de,Te=le[J],De=Te.type;if(De==="Point"||De==="MultiPoint"||De==="LineString")de=Ei(Te.geometry,H);else if(De==="MultiLineString"||De==="Polygon"){de=[];for(var Le=0;Le<Te.geometry.length;Le++)de.push(Ei(Te.geometry[Le],H))}else if(De==="MultiPolygon")for(de=[],Le=0;Le<Te.geometry.length;Le++){for(var Ce=[],Ge=0;Ge<Te.geometry[Le].length;Ge++)Ce.push(Ei(Te.geometry[Le][Ge],H));de.push(Ce)}X.push(Et(Te.id,De,de,Te.tags))}return X}function Ei(le,H){var X=[];X.size=le.size,le.start!==void 0&&(X.start=le.start,X.end=le.end);for(var J=0;J<le.length;J+=3)X.push(le[J]+H,le[J+1],le[J+2]);return X}function Fi(le,H){if(le.transformed)return le;var X,J,de,Te=1<<le.z,De=le.x,Le=le.y;for(X=0;X<le.features.length;X++){var Ce=le.features[X],Ge=Ce.geometry,gt=Ce.type;if(Ce.geometry=[],gt===1)for(J=0;J<Ge.length;J+=2)Ce.geometry.push(yr(Ge[J],Ge[J+1],H,Te,De,Le));else for(J=0;J<Ge.length;J++){var Qe=[];for(de=0;de<Ge[J].length;de+=2)Qe.push(yr(Ge[J][de],Ge[J][de+1],H,Te,De,Le));Ce.geometry.push(Qe)}}return le.transformed=!0,le}function yr(le,H,X,J,de,Te){return[Math.round(X*(le*J-de)),Math.round(X*(H*J-Te))]}function Zi(le,H,X,J,de){for(var Te=H===de.maxZoom?0:de.tolerance/((1<<H)*de.extent),De={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:X,y:J,z:H,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},Le=0;Le<le.length;Le++){De.numFeatures++,Ct(De,le[Le],Te,de);var Ce=le[Le].minX,Ge=le[Le].minY,gt=le[Le].maxX,Qe=le[Le].maxY;Ce<De.minX&&(De.minX=Ce),Ge<De.minY&&(De.minY=Ge),gt>De.maxX&&(De.maxX=gt),Qe>De.maxY&&(De.maxY=Qe)}return De}function Ct(le,H,X,J){var de=H.geometry,Te=H.type,De=[];if(Te==="Point"||Te==="MultiPoint")for(var Le=0;Le<de.length;Le+=3)De.push(de[Le]),De.push(de[Le+1]),le.numPoints++,le.numSimplified++;else if(Te==="LineString")pi(De,de,le,X,!1,!1);else if(Te==="MultiLineString"||Te==="Polygon")for(Le=0;Le<de.length;Le++)pi(De,de[Le],le,X,Te==="Polygon",Le===0);else if(Te==="MultiPolygon")for(var Ce=0;Ce<de.length;Ce++){var Ge=de[Ce];for(Le=0;Le<Ge.length;Le++)pi(De,Ge[Le],le,X,!0,Le===0)}if(De.length){var gt=H.tags||null;if(Te==="LineString"&&J.lineMetrics){for(var Qe in gt={},H.tags)gt[Qe]=H.tags[Qe];gt.mapbox_clip_start=de.start/de.size,gt.mapbox_clip_end=de.end/de.size}var st={geometry:De,type:Te==="Polygon"||Te==="MultiPolygon"?3:Te==="LineString"||Te==="MultiLineString"?2:1,tags:gt};H.id!==null&&(st.id=H.id),le.features.push(st)}}function pi(le,H,X,J,de,Te){var De=J*J;if(J>0&&H.size<(de?De:J))X.numPoints+=H.length/3;else{for(var Le=[],Ce=0;Ce<H.length;Ce+=3)(J===0||H[Ce+2]>De)&&(X.numSimplified++,Le.push(H[Ce]),Le.push(H[Ce+1])),X.numPoints++;de&&function(Ge,gt){for(var Qe=0,st=0,ti=Ge.length,ei=ti-2;st<ti;ei=st,st+=2)Qe+=(Ge[st]-Ge[ei])*(Ge[st+1]+Ge[ei+1]);if(Qe>0===gt)for(st=0,ti=Ge.length;st<ti/2;st+=2){var xi=Ge[st],mi=Ge[st+1];Ge[st]=Ge[ti-2-st],Ge[st+1]=Ge[ti-1-st],Ge[ti-2-st]=xi,Ge[ti-1-st]=mi}}(Le,Te),le.push(Le)}}function Qt(le,H){var X=(H=this.options=function(de,Te){for(var De in Te)de[De]=Te[De];return de}(Object.create(this.options),H)).debug;if(X&&console.time("preprocess data"),H.maxZoom<0||H.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(H.promoteId&&H.generateId)throw new Error("promoteId and generateId cannot be used together.");var J=function(de,Te){var De=[];if(de.type==="FeatureCollection")for(var Le=0;Le<de.features.length;Le++)Oe(De,de.features[Le],Te,Le);else Oe(De,de.type==="Feature"?de:{geometry:de},Te);return De}(le,H);this.tiles={},this.tileCoords=[],X&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",H.indexMaxZoom,H.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),J=function(de,Te){var De=Te.buffer/Te.extent,Le=de,Ce=Lt(de,1,-1-De,De,0,-1,2,Te),Ge=Lt(de,1,1-De,2+De,0,-1,2,Te);return(Ce||Ge)&&(Le=Lt(de,1,-De,1+De,0,-1,2,Te)||[],Ce&&(Le=ct(Ce,1).concat(Le)),Ge&&(Le=Le.concat(ct(Ge,-1)))),Le}(J,H),J.length&&this.splitTile(J,0,0,0),X&&(J.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function qi(le,H,X){return 32*((1<<le)*X+H)+le}function ar(le,H){return H?le.properties[H]:le.id}function si(le,H){if(le==null)return!0;if(le.type==="Feature")return ar(le,H)!=null;if(le.type==="FeatureCollection"){const X=new Set;for(const J of le.features){const de=ar(J,H);if(de==null||X.has(de))return!1;X.add(de)}return!0}return!1}function Oi(le,H){const X=new Map;if(le!=null)if(le.type==="Feature")X.set(ar(le,H),le);else for(const J of le.features)X.set(ar(J,H),J);return X}Qt.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},Qt.prototype.splitTile=function(le,H,X,J,de,Te,De){for(var Le=[le,H,X,J],Ce=this.options,Ge=Ce.debug;Le.length;){J=Le.pop(),X=Le.pop(),H=Le.pop(),le=Le.pop();var gt=1<<H,Qe=qi(H,X,J),st=this.tiles[Qe];if(!st&&(Ge>1&&console.time("creation"),st=this.tiles[Qe]=Zi(le,H,X,J,Ce),this.tileCoords.push({z:H,x:X,y:J}),Ge)){Ge>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",H,X,J,st.numFeatures,st.numPoints,st.numSimplified),console.timeEnd("creation"));var ti="z"+H;this.stats[ti]=(this.stats[ti]||0)+1,this.total++}if(st.source=le,de){if(H===Ce.maxZoom||H===de)continue;var ei=1<<de-H;if(X!==Math.floor(Te/ei)||J!==Math.floor(De/ei))continue}else if(H===Ce.indexMaxZoom||st.numPoints<=Ce.indexMaxPoints)continue;if(st.source=null,le.length!==0){Ge>1&&console.time("clipping");var xi,mi,Pi,Li,tr,Mr,ui=.5*Ce.buffer/Ce.extent,dr=.5-ui,Lr=.5+ui,Qr=1+ui;xi=mi=Pi=Li=null,tr=Lt(le,gt,X-ui,X+Lr,0,st.minX,st.maxX,Ce),Mr=Lt(le,gt,X+dr,X+Qr,0,st.minX,st.maxX,Ce),le=null,tr&&(xi=Lt(tr,gt,J-ui,J+Lr,1,st.minY,st.maxY,Ce),mi=Lt(tr,gt,J+dr,J+Qr,1,st.minY,st.maxY,Ce),tr=null),Mr&&(Pi=Lt(Mr,gt,J-ui,J+Lr,1,st.minY,st.maxY,Ce),Li=Lt(Mr,gt,J+dr,J+Qr,1,st.minY,st.maxY,Ce),Mr=null),Ge>1&&console.timeEnd("clipping"),Le.push(xi||[],H+1,2*X,2*J),Le.push(mi||[],H+1,2*X,2*J+1),Le.push(Pi||[],H+1,2*X+1,2*J),Le.push(Li||[],H+1,2*X+1,2*J+1)}}},Qt.prototype.getTile=function(le,H,X){var J=this.options,de=J.extent,Te=J.debug;if(le<0||le>24)return null;var De=1<<le,Le=qi(le,H=(H%De+De)%De,X);if(this.tiles[Le])return Fi(this.tiles[Le],de);Te>1&&console.log("drilling down to z%d-%d-%d",le,H,X);for(var Ce,Ge=le,gt=H,Qe=X;!Ce&&Ge>0;)Ge--,gt=Math.floor(gt/2),Qe=Math.floor(Qe/2),Ce=this.tiles[qi(Ge,gt,Qe)];return Ce&&Ce.source?(Te>1&&console.log("found parent tile z%d-%d-%d",Ge,gt,Qe),Te>1&&console.time("drilling down"),this.splitTile(Ce.source,Ge,gt,Qe,le,H,X),Te>1&&console.timeEnd("drilling down"),this.tiles[Le]?Fi(this.tiles[Le],de):null):null};class $i extends l{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(H,X){return N._(this,void 0,void 0,function*(){const J=H.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const de=this._geoJSONIndex.getTile(J.z,J.x,J.y);if(!de)return null;const Te=new class{constructor(Le){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=N.W,this.length=Le.length,this._features=Le}feature(Le){return new class{constructor(Ce){this._feature=Ce,this.extent=N.W,this.type=Ce.type,this.properties=Ce.tags,"id"in Ce&&!isNaN(Ce.id)&&(this.id=parseInt(Ce.id,10))}loadGeometry(){if(this._feature.type===1){const Ce=[];for(const Ge of this._feature.geometry)Ce.push([new N.P(Ge[0],Ge[1])]);return Ce}{const Ce=[];for(const Ge of this._feature.geometry){const gt=[];for(const Qe of Ge)gt.push(new N.P(Qe[0],Qe[1]));Ce.push(gt)}return Ce}}toGeoJSON(Ce,Ge,gt){return d.call(this,Ce,Ge,gt)}}(this._features[Le])}}(de.features);let De=ot(Te);return De.byteOffset===0&&De.byteLength===De.buffer.byteLength||(De=new Uint8Array(De)),{vectorTile:Te,rawData:De.buffer}})}loadData(H){return N._(this,void 0,void 0,function*(){var X;(X=this._pendingRequest)===null||X===void 0||X.abort();const J=!!(H&&H.request&&H.request.collectResourceTiming)&&new N.bt(H.request);this._pendingRequest=new AbortController;try{this._pendingData=this.loadAndProcessGeoJSON(H,this._pendingRequest),this._geoJSONIndex=H.cluster?new ge(function({superclusterOptions:Te,clusterProperties:De}){if(!De||!Te)return Te;const Le={},Ce={},Ge={accumulated:null,zoom:0},gt={properties:null},Qe=Object.keys(De);for(const st of Qe){const[ti,ei]=De[st],xi=N.bA(ei),mi=N.bA(typeof ti=="string"?[ti,["accumulated"],["get",st]]:ti);Le[st]=xi.value,Ce[st]=mi.value}return Te.map=st=>{gt.properties=st;const ti={};for(const ei of Qe)ti[ei]=Le[ei].evaluate(Ge,gt);return ti},Te.reduce=(st,ti)=>{gt.properties=ti;for(const ei of Qe)Ge.accumulated=st[ei],st[ei]=Ce[ei].evaluate(Ge,gt)},Te}(H)).load((yield this._pendingData).features):new Qt(yield this._pendingData,H.geojsonVtOptions),this.loaded={};const de={};if(J){const Te=J.finish();Te&&(de.resourceTiming={},de.resourceTiming[H.source]=JSON.parse(JSON.stringify(Te)))}return de}catch(de){if(delete this._pendingRequest,N.bz(de))return{abandoned:!0};throw de}})}getData(){return N._(this,void 0,void 0,function*(){return this._pendingData})}reloadTile(H){const X=this.loaded;return X&&X[H.uid]?super.reloadTile(H):this.loadTile(H)}loadAndProcessGeoJSON(H,X){return N._(this,void 0,void 0,function*(){let J=yield this.loadGeoJSON(H,X);if(delete this._pendingRequest,typeof J!="object")throw new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`);if(g(J,!0),H.filter){const de=N.bA(H.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(de.result==="error")throw new Error(de.value.map(De=>`${De.key}: ${De.message}`).join(", "));J={type:"FeatureCollection",features:J.features.filter(De=>de.value.evaluate({zoom:0},De))}}return J})}loadGeoJSON(H,X){return N._(this,void 0,void 0,function*(){const{promoteId:J}=H;if(H.request){const de=yield N.h(H.request,X);return this._dataUpdateable=si(de.data,J)?Oi(de.data,J):void 0,de.data}if(typeof H.data=="string")try{const de=JSON.parse(H.data);return this._dataUpdateable=si(de,J)?Oi(de,J):void 0,de}catch{throw new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`)}if(!H.dataDiff)throw new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${H.source}`);return function(de,Te,De){var Le,Ce,Ge,gt;if(Te.removeAll&&de.clear(),Te.remove)for(const Qe of Te.remove)de.delete(Qe);if(Te.add)for(const Qe of Te.add){const st=ar(Qe,De);st!=null&&de.set(st,Qe)}if(Te.update)for(const Qe of Te.update){let st=de.get(Qe.id);if(st==null)continue;const ti=!Qe.removeAllProperties&&(((Le=Qe.removeProperties)===null||Le===void 0?void 0:Le.length)>0||((Ce=Qe.addOrUpdateProperties)===null||Ce===void 0?void 0:Ce.length)>0);if((Qe.newGeometry||Qe.removeAllProperties||ti)&&(st=Object.assign({},st),de.set(Qe.id,st),ti&&(st.properties=Object.assign({},st.properties))),Qe.newGeometry&&(st.geometry=Qe.newGeometry),Qe.removeAllProperties)st.properties={};else if(((Ge=Qe.removeProperties)===null||Ge===void 0?void 0:Ge.length)>0)for(const ei of Qe.removeProperties)Object.prototype.hasOwnProperty.call(st.properties,ei)&&delete st.properties[ei];if(((gt=Qe.addOrUpdateProperties)===null||gt===void 0?void 0:gt.length)>0)for(const{key:ei,value:xi}of Qe.addOrUpdateProperties)st.properties[ei]=xi}}(this._dataUpdateable,H.dataDiff,J),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}})}removeSource(H){return N._(this,void 0,void 0,function*(){this._pendingRequest&&this._pendingRequest.abort()})}getClusterExpansionZoom(H){return this._geoJSONIndex.getClusterExpansionZoom(H.clusterId)}getClusterChildren(H){return this._geoJSONIndex.getChildren(H.clusterId)}getClusterLeaves(H){return this._geoJSONIndex.getLeaves(H.clusterId,H.limit,H.offset)}}class Ki{constructor(H){this.self=H,this.actor=new N.C(H),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(X,J)=>{if(this.externalWorkerSourceTypes[X])throw new Error(`Worker source with name "${X}" already registered.`);this.externalWorkerSourceTypes[X]=J},this.self.addProtocol=N.bg,this.self.removeProtocol=N.bh,this.self.registerRTLTextPlugin=X=>{if(N.bB.isParsed())throw new Error("RTL text plugin already registered.");N.bB.setMethods(X)},this.actor.registerMessageHandler("LDT",(X,J)=>this._getDEMWorkerSource(X,J.source).loadTile(J)),this.actor.registerMessageHandler("RDT",(X,J)=>N._(this,void 0,void 0,function*(){this._getDEMWorkerSource(X,J.source).removeTile(J)})),this.actor.registerMessageHandler("GCEZ",(X,J)=>N._(this,void 0,void 0,function*(){return this._getWorkerSource(X,J.type,J.source).getClusterExpansionZoom(J)})),this.actor.registerMessageHandler("GCC",(X,J)=>N._(this,void 0,void 0,function*(){return this._getWorkerSource(X,J.type,J.source).getClusterChildren(J)})),this.actor.registerMessageHandler("GCL",(X,J)=>N._(this,void 0,void 0,function*(){return this._getWorkerSource(X,J.type,J.source).getClusterLeaves(J)})),this.actor.registerMessageHandler("LD",(X,J)=>this._getWorkerSource(X,J.type,J.source).loadData(J)),this.actor.registerMessageHandler("GD",(X,J)=>this._getWorkerSource(X,J.type,J.source).getData()),this.actor.registerMessageHandler("LT",(X,J)=>this._getWorkerSource(X,J.type,J.source).loadTile(J)),this.actor.registerMessageHandler("RT",(X,J)=>this._getWorkerSource(X,J.type,J.source).reloadTile(J)),this.actor.registerMessageHandler("AT",(X,J)=>this._getWorkerSource(X,J.type,J.source).abortTile(J)),this.actor.registerMessageHandler("RMT",(X,J)=>this._getWorkerSource(X,J.type,J.source).removeTile(J)),this.actor.registerMessageHandler("RS",(X,J)=>N._(this,void 0,void 0,function*(){if(!this.workerSources[X]||!this.workerSources[X][J.type]||!this.workerSources[X][J.type][J.source])return;const de=this.workerSources[X][J.type][J.source];delete this.workerSources[X][J.type][J.source],de.removeSource!==void 0&&de.removeSource(J)})),this.actor.registerMessageHandler("RM",X=>N._(this,void 0,void 0,function*(){delete this.layerIndexes[X],delete this.availableImages[X],delete this.workerSources[X],delete this.demWorkerSources[X]})),this.actor.registerMessageHandler("SR",(X,J)=>N._(this,void 0,void 0,function*(){this.referrer=J})),this.actor.registerMessageHandler("SRPS",(X,J)=>this._syncRTLPluginState(X,J)),this.actor.registerMessageHandler("IS",(X,J)=>N._(this,void 0,void 0,function*(){this.self.importScripts(J)})),this.actor.registerMessageHandler("SI",(X,J)=>this._setImages(X,J)),this.actor.registerMessageHandler("UL",(X,J)=>N._(this,void 0,void 0,function*(){this._getLayerIndex(X).update(J.layers,J.removedIds)})),this.actor.registerMessageHandler("SL",(X,J)=>N._(this,void 0,void 0,function*(){this._getLayerIndex(X).replace(J)}))}_setImages(H,X){return N._(this,void 0,void 0,function*(){this.availableImages[H]=X;for(const J in this.workerSources[H]){const de=this.workerSources[H][J];for(const Te in de)de[Te].availableImages=X}})}_syncRTLPluginState(H,X){return N._(this,void 0,void 0,function*(){if(N.bB.isParsed())return N.bB.getState();if(X.pluginStatus!=="loading")return N.bB.setState(X),X;const J=X.pluginURL;if(this.self.importScripts(J),N.bB.isParsed()){const de={pluginStatus:"loaded",pluginURL:J};return N.bB.setState(de),de}throw N.bB.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${J}`)})}_getAvailableImages(H){let X=this.availableImages[H];return X||(X=[]),X}_getLayerIndex(H){let X=this.layerIndexes[H];return X||(X=this.layerIndexes[H]=new s),X}_getWorkerSource(H,X,J){if(this.workerSources[H]||(this.workerSources[H]={}),this.workerSources[H][X]||(this.workerSources[H][X]={}),!this.workerSources[H][X][J]){const de={sendAsync:(Te,De)=>(Te.targetMapId=H,this.actor.sendAsync(Te,De))};switch(X){case"vector":this.workerSources[H][X][J]=new l(de,this._getLayerIndex(H),this._getAvailableImages(H));break;case"geojson":this.workerSources[H][X][J]=new $i(de,this._getLayerIndex(H),this._getAvailableImages(H));break;default:this.workerSources[H][X][J]=new this.externalWorkerSourceTypes[X](de,this._getLayerIndex(H),this._getAvailableImages(H))}}return this.workerSources[H][X][J]}_getDEMWorkerSource(H,X){return this.demWorkerSources[H]||(this.demWorkerSources[H]={}),this.demWorkerSources[H][X]||(this.demWorkerSources[H][X]=new c),this.demWorkerSources[H][X]}}return N.i(self)&&(self.worker=new Ki(self)),Ki}),he("index",["exports","./shared"],function(N,s){var p="4.4.0";let C,b;const l={now:typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frameAsync:y=>new Promise((t,n)=>{const a=requestAnimationFrame(t);y.signal.addEventListener("abort",()=>{cancelAnimationFrame(a),n(s.c())})}),getImageData(y,t=0){return this.getImageCanvasContext(y).getImageData(-t,-t,y.width+2*t,y.height+2*t)},getImageCanvasContext(y){const t=window.document.createElement("canvas"),n=t.getContext("2d",{willReadFrequently:!0});if(!n)throw new Error("failed to create canvas 2d context");return t.width=y.width,t.height=y.height,n.drawImage(y,0,0,y.width,y.height),n},resolveURL:y=>(C||(C=document.createElement("a")),C.href=y,C.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(b==null&&(b=matchMedia("(prefers-reduced-motion: reduce)")),b.matches)}};class c{static testProp(t){if(!c.docStyle)return t[0];for(let n=0;n<t.length;n++)if(t[n]in c.docStyle)return t[n];return t[0]}static create(t,n,a){const f=window.document.createElement(t);return n!==void 0&&(f.className=n),a&&a.appendChild(f),f}static createNS(t,n){return window.document.createElementNS(t,n)}static disableDrag(){c.docStyle&&c.selectProp&&(c.userSelect=c.docStyle[c.selectProp],c.docStyle[c.selectProp]="none")}static enableDrag(){c.docStyle&&c.selectProp&&(c.docStyle[c.selectProp]=c.userSelect)}static setTransform(t,n){t.style[c.transformProp]=n}static addEventListener(t,n,a,f={}){t.addEventListener(n,a,"passive"in f?f:f.capture)}static removeEventListener(t,n,a,f={}){t.removeEventListener(n,a,"passive"in f?f:f.capture)}static suppressClickInternal(t){t.preventDefault(),t.stopPropagation(),window.removeEventListener("click",c.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",c.suppressClickInternal,!0),window.setTimeout(()=>{window.removeEventListener("click",c.suppressClickInternal,!0)},0)}static getScale(t){const n=t.getBoundingClientRect();return{x:n.width/t.offsetWidth||1,y:n.height/t.offsetHeight||1,boundingClientRect:n}}static getPoint(t,n,a){const f=n.boundingClientRect;return new s.P((a.clientX-f.left)/n.x-t.clientLeft,(a.clientY-f.top)/n.y-t.clientTop)}static mousePos(t,n){const a=c.getScale(t);return c.getPoint(t,a,n)}static touchPos(t,n){const a=[],f=c.getScale(t);for(let v=0;v<n.length;v++)a.push(c.getPoint(t,f,n[v]));return a}static mouseButton(t){return t.button}static remove(t){t.parentNode&&t.parentNode.removeChild(t)}}c.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,c.selectProp=c.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),c.transformProp=c.testProp(["transform","WebkitTransform"]);const h={supported:!1,testSupport:function(y){!d&&g&&(w?E(y):m=y)}};let m,g,d=!1,w=!1;function E(y){const t=y.createTexture();y.bindTexture(y.TEXTURE_2D,t);try{if(y.texImage2D(y.TEXTURE_2D,0,y.RGBA,y.RGBA,y.UNSIGNED_BYTE,g),y.isContextLost())return;h.supported=!0}catch{}y.deleteTexture(t),d=!0}var O;typeof document<"u"&&(g=document.createElement("img"),g.onload=()=>{m&&E(m),m=null,w=!0},g.onerror=()=>{d=!0,m=null},g.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(y){let t,n,a,f;y.resetRequestQueue=()=>{t=[],n=0,a=0,f={}},y.addThrottleControl=D=>{const B=a++;return f[B]=D,B},y.removeThrottleControl=D=>{delete f[D],I()},y.getImage=(D,B,G=!0)=>new Promise((U,K)=>{h.supported&&(D.headers||(D.headers={}),D.headers.accept="image/webp,*/*"),s.e(D,{type:"image"}),t.push({abortController:B,requestParameters:D,supportImageRefresh:G,state:"queued",onError:ie=>{K(ie)},onSuccess:ie=>{U(ie)}}),I()});const v=D=>s._(this,void 0,void 0,function*(){D.state="running";const{requestParameters:B,supportImageRefresh:G,onError:U,onSuccess:K,abortController:ie}=D,oe=G===!1&&!s.i(self)&&!s.g(B.url)&&(!B.headers||Object.keys(B.headers).reduce((Se,ke)=>Se&&ke==="accept",!0));n++;const ve=oe?k(B,ie):s.m(B,ie);try{const Se=yield ve;delete D.abortController,D.state="completed",Se.data instanceof HTMLImageElement||s.b(Se.data)?K(Se):Se.data&&K({data:yield(ce=Se.data,typeof createImageBitmap=="function"?s.d(ce):s.f(ce)),cacheControl:Se.cacheControl,expires:Se.expires})}catch(Se){delete D.abortController,U(Se)}finally{n--,I()}var ce}),I=()=>{const D=(()=>{for(const B of Object.keys(f))if(f[B]())return!0;return!1})()?s.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:s.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let B=n;B<D&&t.length>0;B++){const G=t.shift();G.abortController.signal.aborted?B--:v(G)}},k=(D,B)=>new Promise((G,U)=>{const K=new Image,ie=D.url,oe=D.credentials;oe&&oe==="include"?K.crossOrigin="use-credentials":(oe&&oe==="same-origin"||!s.s(ie))&&(K.crossOrigin="anonymous"),B.signal.addEventListener("abort",()=>{K.src="",U(s.c())}),K.fetchPriority="high",K.onload=()=>{K.onerror=K.onload=null,G({data:K})},K.onerror=()=>{K.onerror=K.onload=null,B.signal.aborted||U(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},K.src=ie})}(O||(O={})),O.resetRequestQueue();class L{constructor(t){this._transformRequestFn=t}transformRequest(t,n){return this._transformRequestFn&&this._transformRequestFn(t,n)||{url:t}}setTransformRequest(t){this._transformRequestFn=t}}function V(y){var t=new s.A(3);return t[0]=y[0],t[1]=y[1],t[2]=y[2],t}var $,ne=function(y,t,n){return y[0]=t[0]-n[0],y[1]=t[1]-n[1],y[2]=t[2]-n[2],y};$=new s.A(3),s.A!=Float32Array&&($[0]=0,$[1]=0,$[2]=0);var xe=function(y){var t=y[0],n=y[1];return t*t+n*n};function ze(y){const t=[];if(typeof y=="string")t.push({id:"default",url:y});else if(y&&y.length>0){const n=[];for(const{id:a,url:f}of y){const v=`${a}${f}`;n.indexOf(v)===-1&&(n.push(v),t.push({id:a,url:f}))}}return t}function Ke(y,t,n){const a=y.split("?");return a[0]+=`${t}${n}`,a.join("?")}(function(){var y=new s.A(2);s.A!=Float32Array&&(y[0]=0,y[1]=0)})();class Je{constructor(t,n,a,f){this.context=t,this.format=a,this.texture=t.gl.createTexture(),this.update(n,f)}update(t,n,a){const{width:f,height:v}=t,I=!(this.size&&this.size[0]===f&&this.size[1]===v||a),{context:k}=this,{gl:D}=k;if(this.useMipmap=!!(n&&n.useMipmap),D.bindTexture(D.TEXTURE_2D,this.texture),k.pixelStoreUnpackFlipY.set(!1),k.pixelStoreUnpack.set(1),k.pixelStoreUnpackPremultiplyAlpha.set(this.format===D.RGBA&&(!n||n.premultiply!==!1)),I)this.size=[f,v],t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||s.b(t)?D.texImage2D(D.TEXTURE_2D,0,this.format,this.format,D.UNSIGNED_BYTE,t):D.texImage2D(D.TEXTURE_2D,0,this.format,f,v,0,this.format,D.UNSIGNED_BYTE,t.data);else{const{x:B,y:G}=a||{x:0,y:0};t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||s.b(t)?D.texSubImage2D(D.TEXTURE_2D,0,B,G,D.RGBA,D.UNSIGNED_BYTE,t):D.texSubImage2D(D.TEXTURE_2D,0,B,G,f,v,D.RGBA,D.UNSIGNED_BYTE,t.data)}this.useMipmap&&this.isSizePowerOfTwo()&&D.generateMipmap(D.TEXTURE_2D)}bind(t,n,a){const{context:f}=this,{gl:v}=f;v.bindTexture(v.TEXTURE_2D,this.texture),a!==v.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(a=v.LINEAR),t!==this.filter&&(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MAG_FILTER,t),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,a||t),this.filter=t),n!==this.wrap&&(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,n),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,n),this.wrap=n)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}function tt(y){const{userImage:t}=y;return!!(t&&t.render&&t.render())&&(y.data.replace(new Uint8Array(t.data.buffer)),!0)}class ht extends s.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new s.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(t){if(this.loaded!==t&&(this.loaded=t,t)){for(const{ids:n,promiseResolve:a}of this.requestors)a(this._getImagesForIds(n));this.requestors=[]}}getImage(t){const n=this.images[t];if(n&&!n.data&&n.spriteData){const a=n.spriteData;n.data=new s.R({width:a.width,height:a.height},a.context.getImageData(a.x,a.y,a.width,a.height).data),n.spriteData=null}return n}addImage(t,n){if(this.images[t])throw new Error(`Image id ${t} already exist, use updateImage instead`);this._validate(t,n)&&(this.images[t]=n)}_validate(t,n){let a=!0;const f=n.data||n.spriteData;return this._validateStretch(n.stretchX,f&&f.width)||(this.fire(new s.j(new Error(`Image "${t}" has invalid "stretchX" value`))),a=!1),this._validateStretch(n.stretchY,f&&f.height)||(this.fire(new s.j(new Error(`Image "${t}" has invalid "stretchY" value`))),a=!1),this._validateContent(n.content,n)||(this.fire(new s.j(new Error(`Image "${t}" has invalid "content" value`))),a=!1),a}_validateStretch(t,n){if(!t)return!0;let a=0;for(const f of t){if(f[0]<a||f[1]<f[0]||n<f[1])return!1;a=f[1]}return!0}_validateContent(t,n){if(!t)return!0;if(t.length!==4)return!1;const a=n.spriteData,f=a&&a.width||n.data.width,v=a&&a.height||n.data.height;return!(t[0]<0||f<t[0]||t[1]<0||v<t[1]||t[2]<0||f<t[2]||t[3]<0||v<t[3]||t[2]<t[0]||t[3]<t[1])}updateImage(t,n,a=!0){const f=this.getImage(t);if(a&&(f.data.width!==n.data.width||f.data.height!==n.data.height))throw new Error(`size mismatch between old image (${f.data.width}x${f.data.height}) and new image (${n.data.width}x${n.data.height}).`);n.version=f.version+1,this.images[t]=n,this.updatedImages[t]=!0}removeImage(t){const n=this.images[t];delete this.images[t],delete this.patterns[t],n.userImage&&n.userImage.onRemove&&n.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(t){return new Promise((n,a)=>{let f=!0;if(!this.isLoaded())for(const v of t)this.images[v]||(f=!1);this.isLoaded()||f?n(this._getImagesForIds(t)):this.requestors.push({ids:t,promiseResolve:n})})}_getImagesForIds(t){const n={};for(const a of t){let f=this.getImage(a);f||(this.fire(new s.k("styleimagemissing",{id:a})),f=this.getImage(a)),f?n[a]={data:f.data.clone(),pixelRatio:f.pixelRatio,sdf:f.sdf,version:f.version,stretchX:f.stretchX,stretchY:f.stretchY,content:f.content,textFitWidth:f.textFitWidth,textFitHeight:f.textFitHeight,hasRenderCallback:!!(f.userImage&&f.userImage.render)}:s.w(`Image "${a}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return n}getPixelSize(){const{width:t,height:n}=this.atlasImage;return{width:t,height:n}}getPattern(t){const n=this.patterns[t],a=this.getImage(t);if(!a)return null;if(n&&n.position.version===a.version)return n.position;if(n)n.position.version=a.version;else{const f={w:a.data.width+2,h:a.data.height+2,x:0,y:0},v=new s.I(f,a);this.patterns[t]={bin:f,position:v}}return this._updatePatternAtlas(),this.patterns[t].position}bind(t){const n=t.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new Je(t,this.atlasImage,n.RGBA),this.atlasTexture.bind(n.LINEAR,n.CLAMP_TO_EDGE)}_updatePatternAtlas(){const t=[];for(const v in this.patterns)t.push(this.patterns[v].bin);const{w:n,h:a}=s.p(t),f=this.atlasImage;f.resize({width:n||1,height:a||1});for(const v in this.patterns){const{bin:I}=this.patterns[v],k=I.x+1,D=I.y+1,B=this.getImage(v).data,G=B.width,U=B.height;s.R.copy(B,f,{x:0,y:0},{x:k,y:D},{width:G,height:U}),s.R.copy(B,f,{x:0,y:U-1},{x:k,y:D-1},{width:G,height:1}),s.R.copy(B,f,{x:0,y:0},{x:k,y:D+U},{width:G,height:1}),s.R.copy(B,f,{x:G-1,y:0},{x:k-1,y:D},{width:1,height:U}),s.R.copy(B,f,{x:0,y:0},{x:k+G,y:D},{width:1,height:U})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(t){for(const n of t){if(this.callbackDispatchedThisFrame[n])continue;this.callbackDispatchedThisFrame[n]=!0;const a=this.getImage(n);a||s.w(`Image with ID: "${n}" was not found`),tt(a)&&this.updateImage(n,a)}}}const nt=1e20;function _t(y,t,n,a,f,v,I,k,D){for(let B=t;B<t+a;B++)Ot(y,n*v+B,v,f,I,k,D);for(let B=n;B<n+f;B++)Ot(y,B*v+t,1,a,I,k,D)}function Ot(y,t,n,a,f,v,I){v[0]=0,I[0]=-nt,I[1]=nt,f[0]=y[t];for(let k=1,D=0,B=0;k<a;k++){f[k]=y[t+k*n];const G=k*k;do{const U=v[D];B=(f[k]-f[U]+G-U*U)/(k-U)/2}while(B<=I[D]&&--D>-1);D++,v[D]=k,I[D]=B,I[D+1]=nt}for(let k=0,D=0;k<a;k++){for(;I[D+1]<k;)D++;const B=v[D],G=k-B;y[t+k*n]=f[B]+G*G}}class ot{constructor(t,n){this.requestManager=t,this.localIdeographFontFamily=n,this.entries={}}setURL(t){this.url=t}getGlyphs(t){return s._(this,void 0,void 0,function*(){const n=[];for(const v in t)for(const I of t[v])n.push(this._getAndCacheGlyphsPromise(v,I));const a=yield Promise.all(n),f={};for(const{stack:v,id:I,glyph:k}of a)f[v]||(f[v]={}),f[v][I]=k&&{id:k.id,bitmap:k.bitmap.clone(),metrics:k.metrics};return f})}_getAndCacheGlyphsPromise(t,n){return s._(this,void 0,void 0,function*(){let a=this.entries[t];a||(a=this.entries[t]={glyphs:{},requests:{},ranges:{}});let f=a.glyphs[n];if(f!==void 0)return{stack:t,id:n,glyph:f};if(f=this._tinySDF(a,t,n),f)return a.glyphs[n]=f,{stack:t,id:n,glyph:f};const v=Math.floor(n/256);if(256*v>65535)throw new Error("glyphs > 65535 not supported");if(a.ranges[v])return{stack:t,id:n,glyph:f};if(!this.url)throw new Error("glyphsUrl is not set");if(!a.requests[v]){const k=ot.loadGlyphRange(t,v,this.url,this.requestManager);a.requests[v]=k}const I=yield a.requests[v];for(const k in I)this._doesCharSupportLocalGlyph(+k)||(a.glyphs[+k]=I[+k]);return a.ranges[v]=!0,{stack:t,id:n,glyph:I[n]||null}})}_doesCharSupportLocalGlyph(t){return!!this.localIdeographFontFamily&&(s.u["CJK Unified Ideographs"](t)||s.u["Hangul Syllables"](t)||s.u.Hiragana(t)||s.u.Katakana(t))}_tinySDF(t,n,a){const f=this.localIdeographFontFamily;if(!f||!this._doesCharSupportLocalGlyph(a))return;let v=t.tinySDF;if(!v){let k="400";/bold/i.test(n)?k="900":/medium/i.test(n)?k="500":/light/i.test(n)&&(k="200"),v=t.tinySDF=new ot.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:f,fontWeight:k})}const I=v.draw(String.fromCharCode(a));return{id:a,bitmap:new s.o({width:I.width||60,height:I.height||60},I.data),metrics:{width:I.glyphWidth/2||24,height:I.glyphHeight/2||24,left:I.glyphLeft/2+.5||0,top:I.glyphTop/2-27.5||-8,advance:I.glyphAdvance/2||24,isDoubleResolution:!0}}}}ot.loadGlyphRange=function(y,t,n,a){return s._(this,void 0,void 0,function*(){const f=256*t,v=f+255,I=a.transformRequest(n.replace("{fontstack}",y).replace("{range}",`${f}-${v}`),"Glyphs"),k=yield s.l(I,new AbortController);if(!k||!k.data)throw new Error(`Could not load glyph range. range: ${t}, ${f}-${v}`);const D={};for(const B of s.n(k.data))D[B.id]=B;return D})},ot.TinySDF=class{constructor({fontSize:y=24,buffer:t=3,radius:n=8,cutoff:a=.25,fontFamily:f="sans-serif",fontWeight:v="normal",fontStyle:I="normal"}={}){this.buffer=t,this.cutoff=a,this.radius=n;const k=this.size=y+4*t,D=this._createCanvas(k),B=this.ctx=D.getContext("2d",{willReadFrequently:!0});B.font=`${I} ${v} ${y}px ${f}`,B.textBaseline="alphabetic",B.textAlign="left",B.fillStyle="black",this.gridOuter=new Float64Array(k*k),this.gridInner=new Float64Array(k*k),this.f=new Float64Array(k),this.z=new Float64Array(k+1),this.v=new Uint16Array(k)}_createCanvas(y){const t=document.createElement("canvas");return t.width=t.height=y,t}draw(y){const{width:t,actualBoundingBoxAscent:n,actualBoundingBoxDescent:a,actualBoundingBoxLeft:f,actualBoundingBoxRight:v}=this.ctx.measureText(y),I=Math.ceil(n),k=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(v-f))),D=Math.min(this.size-this.buffer,I+Math.ceil(a)),B=k+2*this.buffer,G=D+2*this.buffer,U=Math.max(B*G,0),K=new Uint8ClampedArray(U),ie={data:K,width:B,height:G,glyphWidth:k,glyphHeight:D,glyphTop:I,glyphLeft:0,glyphAdvance:t};if(k===0||D===0)return ie;const{ctx:oe,buffer:ve,gridInner:ce,gridOuter:Se}=this;oe.clearRect(ve,ve,k,D),oe.fillText(y,ve,ve+I);const ke=oe.getImageData(ve,ve,k,D);Se.fill(nt,0,U),ce.fill(0,0,U);for(let pe=0;pe<D;pe++)for(let Fe=0;Fe<k;Fe++){const We=ke.data[4*(pe*k+Fe)+3]/255;if(We===0)continue;const Ye=(pe+ve)*B+Fe+ve;if(We===1)Se[Ye]=0,ce[Ye]=nt;else{const mt=.5-We;Se[Ye]=mt>0?mt*mt:0,ce[Ye]=mt<0?mt*mt:0}}_t(Se,0,0,B,G,B,this.f,this.v,this.z),_t(ce,ve,ve,k,D,B,this.f,this.v,this.z);for(let pe=0;pe<U;pe++){const Fe=Math.sqrt(Se[pe])-Math.sqrt(ce[pe]);K[pe]=Math.round(255-255*(Fe/this.radius+this.cutoff))}return ie}};class wt{constructor(){this.specification=s.v.light.position}possiblyEvaluate(t,n){return s.y(t.expression.evaluate(n))}interpolate(t,n,a){return{x:s.z.number(t.x,n.x,a),y:s.z.number(t.y,n.y,a),z:s.z.number(t.z,n.z,a)}}}let ee;class be extends s.E{constructor(t){super(),ee=ee||new s.q({anchor:new s.D(s.v.light.anchor),position:new wt,color:new s.D(s.v.light.color),intensity:new s.D(s.v.light.intensity)}),this._transitionable=new s.T(ee),this.setLight(t),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,n={}){if(!this._validate(s.r,t,n))for(const a in t){const f=t[a];a.endsWith("-transition")?this._transitionable.setTransition(a.slice(0,-11),f):this._transitionable.setValue(a,f)}}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,a){return(!a||a.validate!==!1)&&s.t(this,t.call(s.x,{value:n,style:{glyphs:!0,sprite:!0},styleSpec:s.v}))}}class me{constructor(t,n){this.width=t,this.height=n,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(t,n){const a=t.join(",")+String(n);return this.dashEntry[a]||(this.dashEntry[a]=this.addDash(t,n)),this.dashEntry[a]}getDashRanges(t,n,a){const f=[];let v=t.length%2==1?-t[t.length-1]*a:0,I=t[0]*a,k=!0;f.push({left:v,right:I,isDash:k,zeroLength:t[0]===0});let D=t[0];for(let B=1;B<t.length;B++){k=!k;const G=t[B];v=D*a,D+=G,I=D*a,f.push({left:v,right:I,isDash:k,zeroLength:G===0})}return f}addRoundDash(t,n,a){const f=n/2;for(let v=-a;v<=a;v++){const I=this.width*(this.nextRow+a+v);let k=0,D=t[k];for(let B=0;B<this.width;B++){B/D.right>1&&(D=t[++k]);const G=Math.abs(B-D.left),U=Math.abs(B-D.right),K=Math.min(G,U);let ie;const oe=v/a*(f+1);if(D.isDash){const ve=f-Math.abs(oe);ie=Math.sqrt(K*K+ve*ve)}else ie=f-Math.sqrt(K*K+oe*oe);this.data[I+B]=Math.max(0,Math.min(255,ie+128))}}}addRegularDash(t){for(let k=t.length-1;k>=0;--k){const D=t[k],B=t[k+1];D.zeroLength?t.splice(k,1):B&&B.isDash===D.isDash&&(B.left=D.left,t.splice(k,1))}const n=t[0],a=t[t.length-1];n.isDash===a.isDash&&(n.left=a.left-this.width,a.right=n.right+this.width);const f=this.width*this.nextRow;let v=0,I=t[v];for(let k=0;k<this.width;k++){k/I.right>1&&(I=t[++v]);const D=Math.abs(k-I.left),B=Math.abs(k-I.right),G=Math.min(D,B);this.data[f+k]=Math.max(0,Math.min(255,(I.isDash?G:-G)+128))}}addDash(t,n){const a=n?7:0,f=2*a+1;if(this.nextRow+f>this.height)return s.w("LineAtlas out of space"),null;let v=0;for(let k=0;k<t.length;k++)v+=t[k];if(v!==0){const k=this.width/v,D=this.getDashRanges(t,this.width,k);n?this.addRoundDash(D,k,a):this.addRegularDash(D)}const I={y:(this.nextRow+a+.5)/this.height,height:2*a/this.height,width:v};return this.nextRow+=f,this.dirty=!0,I}bind(t){const n=t.gl;this.texture?(n.bindTexture(n.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,n.texSubImage2D(n.TEXTURE_2D,0,0,0,this.width,this.height,n.ALPHA,n.UNSIGNED_BYTE,this.data))):(this.texture=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this.texture),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texImage2D(n.TEXTURE_2D,0,n.ALPHA,this.width,this.height,0,n.ALPHA,n.UNSIGNED_BYTE,this.data))}}const ye="maplibre_preloaded_worker_pool";class Ve{constructor(){this.active={}}acquire(t){if(!this.workers)for(this.workers=[];this.workers.length<Ve.workerCount;)this.workers.push(new Worker(s.a.WORKER_URL));return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],this.numActive()===0&&(this.workers.forEach(n=>{n.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[ye]}numActive(){return Object.keys(this.active).length}}const ge=Math.floor(l.hardwareConcurrency/2);let te,Ae;function Ue(){return te||(te=new Ve),te}Ve.workerCount=s.B(globalThis)?Math.max(Math.min(ge,3),1):1;class it{constructor(t,n){this.workerPool=t,this.actors=[],this.currentActor=0,this.id=n;const a=this.workerPool.acquire(n);for(let f=0;f<a.length;f++){const v=new s.C(a[f],n);v.name=`Worker ${f}`,this.actors.push(v)}if(!this.actors.length)throw new Error("No actors found")}broadcast(t,n){const a=[];for(const f of this.actors)a.push(f.sendAsync({type:t,data:n}));return Promise.all(a)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(t=!0){this.actors.forEach(n=>{n.remove()}),this.actors=[],t&&this.workerPool.release(this.id)}registerMessageHandler(t,n){for(const a of this.actors)a.registerMessageHandler(t,n)}}function Xe(){return Ae||(Ae=new it(Ue(),s.G),Ae.registerMessageHandler("GR",(y,t,n)=>s.m(t,n))),Ae}function He(y,t){const n=s.F();return s.H(n,n,[1,1,0]),s.J(n,n,[.5*y.width,.5*y.height,1]),s.K(n,n,y.calculatePosMatrix(t.toUnwrapped()))}function vt(y,t,n,a,f,v){const I=function(U,K,ie){if(U)for(const oe of U){const ve=K[oe];if(ve&&ve.source===ie&&ve.type==="fill-extrusion")return!0}else for(const oe in K){const ve=K[oe];if(ve.source===ie&&ve.type==="fill-extrusion")return!0}return!1}(f&&f.layers,t,y.id),k=v.maxPitchScaleFactor(),D=y.tilesIn(a,k,I);D.sort(Et);const B=[];for(const U of D)B.push({wrappedTileID:U.tileID.wrapped().key,queryResults:U.tile.queryRenderedFeatures(t,n,y._state,U.queryGeometry,U.cameraQueryGeometry,U.scale,f,v,k,He(y.transform,U.tileID))});const G=function(U){const K={},ie={};for(const oe of U){const ve=oe.queryResults,ce=oe.wrappedTileID,Se=ie[ce]=ie[ce]||{};for(const ke in ve){const pe=ve[ke],Fe=Se[ke]=Se[ke]||{},We=K[ke]=K[ke]||[];for(const Ye of pe)Fe[Ye.featureIndex]||(Fe[Ye.featureIndex]=!0,We.push(Ye))}}return K}(B);for(const U in G)G[U].forEach(K=>{const ie=K.feature,oe=y.getFeatureState(ie.layer["source-layer"],ie.id);ie.source=ie.layer.source,ie.layer["source-layer"]&&(ie.sourceLayer=ie.layer["source-layer"]),ie.state=oe});return G}function Et(y,t){const n=y.tileID,a=t.tileID;return n.overscaledZ-a.overscaledZ||n.canonical.y-a.canonical.y||n.wrap-a.wrap||n.canonical.x-a.canonical.x}function $e(y,t,n){return s._(this,void 0,void 0,function*(){let a=y;if(y.url?a=(yield s.h(t.transformRequest(y.url,"Source"),n)).data:yield l.frameAsync(n),!a)return null;const f=s.L(s.e(a,y),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in a&&a.vector_layers&&(f.vectorLayerIds=a.vector_layers.map(v=>v.id)),f})}class Oe{constructor(t,n){t&&(n?this.setSouthWest(t).setNorthEast(n):Array.isArray(t)&&(t.length===4?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1])))}setNorthEast(t){return this._ne=t instanceof s.M?new s.M(t.lng,t.lat):s.M.convert(t),this}setSouthWest(t){return this._sw=t instanceof s.M?new s.M(t.lng,t.lat):s.M.convert(t),this}extend(t){const n=this._sw,a=this._ne;let f,v;if(t instanceof s.M)f=t,v=t;else{if(!(t instanceof Oe))return Array.isArray(t)?t.length===4||t.every(Array.isArray)?this.extend(Oe.convert(t)):this.extend(s.M.convert(t)):t&&("lng"in t||"lon"in t)&&"lat"in t?this.extend(s.M.convert(t)):this;if(f=t._sw,v=t._ne,!f||!v)return this}return n||a?(n.lng=Math.min(f.lng,n.lng),n.lat=Math.min(f.lat,n.lat),a.lng=Math.max(v.lng,a.lng),a.lat=Math.max(v.lat,a.lat)):(this._sw=new s.M(f.lng,f.lat),this._ne=new s.M(v.lng,v.lat)),this}getCenter(){return new s.M((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new s.M(this.getWest(),this.getNorth())}getSouthEast(){return new s.M(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:n,lat:a}=s.M.convert(t);let f=this._sw.lng<=n&&n<=this._ne.lng;return this._sw.lng>this._ne.lng&&(f=this._sw.lng>=n&&n>=this._ne.lng),this._sw.lat<=a&&a<=this._ne.lat&&f}static convert(t){return t instanceof Oe?t:t&&new Oe(t)}static fromLngLat(t,n=0){const a=360*n/40075017,f=a/Math.cos(Math.PI/180*t.lat);return new Oe(new s.M(t.lng-f,t.lat-a),new s.M(t.lng+f,t.lat+a))}}class at{constructor(t,n,a){this.bounds=Oe.convert(this.validateBounds(t)),this.minzoom=n||0,this.maxzoom=a||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(t){const n=Math.pow(2,t.z),a=Math.floor(s.N(this.bounds.getWest())*n),f=Math.floor(s.O(this.bounds.getNorth())*n),v=Math.ceil(s.N(this.bounds.getEast())*n),I=Math.ceil(s.O(this.bounds.getSouth())*n);return t.x>=a&&t.x<v&&t.y>=f&&t.y<I}}class ae extends s.E{constructor(t,n,a,f){if(super(),this.id=t,this.dispatcher=a,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,s.e(this,s.L(n,["url","scheme","tileSize","promoteId"])),this._options=s.e({type:"vector"},n),this._collectResourceTiming=n.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(f)}load(){return s._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new s.k("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const t=yield $e(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),t&&(s.e(this,t),t.bounds&&(this.tileBounds=new at(t.bounds,this.minzoom,this.maxzoom)),this.fire(new s.k("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.k("data",{dataType:"source",sourceDataType:"content"})))}catch(t){this._tileJSONRequest=null,this.fire(new s.j(t))}})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}setSourceProperty(t){this._tileJSONRequest&&this._tileJSONRequest.abort(),t(),this.load()}setTiles(t){return this.setSourceProperty(()=>{this._options.tiles=t}),this}setUrl(t){return this.setSourceProperty(()=>{this.url=t,this._options.url=t}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return s.e({},this._options)}loadTile(t){return s._(this,void 0,void 0,function*(){const n=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),a={request:this.map._requestManager.transformRequest(n,"Tile"),uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};a.request.collectResourceTiming=this._collectResourceTiming;let f="RT";if(t.actor&&t.state!=="expired"){if(t.state==="loading")return new Promise((v,I)=>{t.reloadPromise={resolve:v,reject:I}})}else t.actor=this.dispatcher.getActor(),f="LT";t.abortController=new AbortController;try{const v=yield t.actor.sendAsync({type:f,data:a},t.abortController);if(delete t.abortController,t.aborted)return;this._afterTileLoadWorkerResponse(t,v)}catch(v){if(delete t.abortController,t.aborted)return;if(v&&v.status!==404)throw v;this._afterTileLoadWorkerResponse(t,null)}})}_afterTileLoadWorkerResponse(t,n){if(n&&n.resourceTiming&&(t.resourceTiming=n.resourceTiming),n&&this.map._refreshExpiredTiles&&t.setExpiryData(n),t.loadVectorData(n,this.map.painter),t.reloadPromise){const a=t.reloadPromise;t.reloadPromise=null,this.loadTile(t).then(a.resolve).catch(a.reject)}}abortTile(t){return s._(this,void 0,void 0,function*(){t.abortController&&(t.abortController.abort(),delete t.abortController),t.actor&&(yield t.actor.sendAsync({type:"AT",data:{uid:t.uid,type:this.type,source:this.id}}))})}unloadTile(t){return s._(this,void 0,void 0,function*(){t.unloadVectorData(),t.actor&&(yield t.actor.sendAsync({type:"RMT",data:{uid:t.uid,type:this.type,source:this.id}}))})}hasTransition(){return!1}}class Ze extends s.E{constructor(t,n,a,f){super(),this.id=t,this.dispatcher=a,this.setEventedParent(f),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=s.e({type:"raster"},n),s.e(this,s.L(n,["url","scheme","tileSize"]))}load(){return s._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new s.k("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const t=yield $e(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,t&&(s.e(this,t),t.bounds&&(this.tileBounds=new at(t.bounds,this.minzoom,this.maxzoom)),this.fire(new s.k("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.k("data",{dataType:"source",sourceDataType:"content"})))}catch(t){this._tileJSONRequest=null,this.fire(new s.j(t))}})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(t){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),t(),this.load()}setTiles(t){return this.setSourceProperty(()=>{this._options.tiles=t}),this}setUrl(t){return this.setSourceProperty(()=>{this.url=t,this._options.url=t}),this}serialize(){return s.e({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t){return s._(this,void 0,void 0,function*(){const n=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);t.abortController=new AbortController;try{const a=yield O.getImage(this.map._requestManager.transformRequest(n,"Tile"),t.abortController,this.map._refreshExpiredTiles);if(delete t.abortController,t.aborted)return void(t.state="unloaded");if(a&&a.data){this.map._refreshExpiredTiles&&a.cacheControl&&a.expires&&t.setExpiryData({cacheControl:a.cacheControl,expires:a.expires});const f=this.map.painter.context,v=f.gl,I=a.data;t.texture=this.map.painter.getTileTexture(I.width),t.texture?t.texture.update(I,{useMipmap:!0}):(t.texture=new Je(f,I,v.RGBA,{useMipmap:!0}),t.texture.bind(v.LINEAR,v.CLAMP_TO_EDGE,v.LINEAR_MIPMAP_NEAREST),f.extTextureFilterAnisotropic&&v.texParameterf(v.TEXTURE_2D,f.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,f.extTextureFilterAnisotropicMax)),t.state="loaded"}}catch(a){if(delete t.abortController,t.aborted)t.state="unloaded";else if(a)throw t.state="errored",a}})}abortTile(t){return s._(this,void 0,void 0,function*(){t.abortController&&(t.abortController.abort(),delete t.abortController)})}unloadTile(t){return s._(this,void 0,void 0,function*(){t.texture&&this.map.painter.saveTileTexture(t.texture)})}hasTransition(){return!1}}class pt extends Ze{constructor(t,n,a,f){super(t,n,a,f),this.type="raster-dem",this.maxzoom=22,this._options=s.e({type:"raster-dem"},n),this.encoding=n.encoding||"mapbox",this.redFactor=n.redFactor,this.greenFactor=n.greenFactor,this.blueFactor=n.blueFactor,this.baseShift=n.baseShift}loadTile(t){return s._(this,void 0,void 0,function*(){const n=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),a=this.map._requestManager.transformRequest(n,"Tile");t.neighboringTiles=this._getNeighboringTiles(t.tileID),t.abortController=new AbortController;try{const f=yield O.getImage(a,t.abortController,this.map._refreshExpiredTiles);if(delete t.abortController,t.aborted)return void(t.state="unloaded");if(f&&f.data){const v=f.data;this.map._refreshExpiredTiles&&f.cacheControl&&f.expires&&t.setExpiryData({cacheControl:f.cacheControl,expires:f.expires});const I=s.b(v)&&s.S()?v:yield this.readImageNow(v),k={type:this.type,uid:t.uid,source:this.id,rawImageData:I,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!t.actor||t.state==="expired"){t.actor=this.dispatcher.getActor();const D=yield t.actor.sendAsync({type:"LDT",data:k});t.dem=D,t.needsHillshadePrepare=!0,t.needsTerrainPrepare=!0,t.state="loaded"}}}catch(f){if(delete t.abortController,t.aborted)t.state="unloaded";else if(f)throw t.state="errored",f}})}readImageNow(t){return s._(this,void 0,void 0,function*(){if(typeof VideoFrame<"u"&&s.U()){const n=t.width+2,a=t.height+2;try{return new s.R({width:n,height:a},yield s.V(t,-1,-1,n,a))}catch{}}return l.getImageData(t,1)})}_getNeighboringTiles(t){const n=t.canonical,a=Math.pow(2,n.z),f=(n.x-1+a)%a,v=n.x===0?t.wrap-1:t.wrap,I=(n.x+1+a)%a,k=n.x+1===a?t.wrap+1:t.wrap,D={};return D[new s.Q(t.overscaledZ,v,n.z,f,n.y).key]={backfilled:!1},D[new s.Q(t.overscaledZ,k,n.z,I,n.y).key]={backfilled:!1},n.y>0&&(D[new s.Q(t.overscaledZ,v,n.z,f,n.y-1).key]={backfilled:!1},D[new s.Q(t.overscaledZ,t.wrap,n.z,n.x,n.y-1).key]={backfilled:!1},D[new s.Q(t.overscaledZ,k,n.z,I,n.y-1).key]={backfilled:!1}),n.y+1<a&&(D[new s.Q(t.overscaledZ,v,n.z,f,n.y+1).key]={backfilled:!1},D[new s.Q(t.overscaledZ,t.wrap,n.z,n.x,n.y+1).key]={backfilled:!1},D[new s.Q(t.overscaledZ,k,n.z,I,n.y+1).key]={backfilled:!1}),D}unloadTile(t){return s._(this,void 0,void 0,function*(){t.demTexture&&this.map.painter.saveTileTexture(t.demTexture),t.fbo&&(t.fbo.destroy(),delete t.fbo),t.dem&&delete t.dem,delete t.neighboringTiles,t.state="unloaded",t.actor&&(yield t.actor.sendAsync({type:"RDT",data:{type:this.type,uid:t.uid,source:this.id}}))})}}class ft extends s.E{constructor(t,n,a,f){super(),this.id=t,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=a.getActor(),this.setEventedParent(f),this._data=n.data,this._options=s.e({},n),this._collectResourceTiming=n.collectResourceTiming,n.maxzoom!==void 0&&(this.maxzoom=n.maxzoom),n.type&&(this.type=n.type),n.attribution&&(this.attribution=n.attribution),this.promoteId=n.promoteId;const v=s.W/this.tileSize;this.workerOptions=s.e({source:this.id,cluster:n.cluster||!1,geojsonVtOptions:{buffer:(n.buffer!==void 0?n.buffer:128)*v,tolerance:(n.tolerance!==void 0?n.tolerance:.375)*v,extent:s.W,maxZoom:this.maxzoom,lineMetrics:n.lineMetrics||!1,generateId:n.generateId||!1},superclusterOptions:{maxZoom:n.clusterMaxZoom!==void 0?n.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,n.clusterMinPoints||2),extent:s.W,radius:(n.clusterRadius||50)*v,log:!1,generateId:n.generateId||!1},clusterProperties:n.clusterProperties,filter:n.filter},n.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}load(){return s._(this,void 0,void 0,function*(){yield this._updateWorkerData()})}onAdd(t){this.map=t,this.load()}setData(t){return this._data=t,this._updateWorkerData(),this}updateData(t){return this._updateWorkerData(t),this}getData(){return s._(this,void 0,void 0,function*(){const t=s.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:t})})}setClusterOptions(t){return this.workerOptions.cluster=t.cluster,t&&(t.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=t.clusterRadius),t.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=t.clusterMaxZoom)),this._updateWorkerData(),this}getClusterExpansionZoom(t){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:t,source:this.id}})}getClusterChildren(t){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:t,source:this.id}})}getClusterLeaves(t,n,a){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:t,limit:n,offset:a}})}_updateWorkerData(t){return s._(this,void 0,void 0,function*(){const n=s.e({type:this.type},this.workerOptions);t?n.dataDiff=t:typeof this._data=="string"?(n.request=this.map._requestManager.transformRequest(l.resolveURL(this._data),"Source"),n.request.collectResourceTiming=this._collectResourceTiming):n.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new s.k("dataloading",{dataType:"source"}));try{const a=yield this.actor.sendAsync({type:"LD",data:n});if(this._pendingLoads--,this._removed||a.abandoned)return void this.fire(new s.k("dataabort",{dataType:"source"}));let f=null;a.resourceTiming&&a.resourceTiming[this.id]&&(f=a.resourceTiming[this.id].slice(0));const v={dataType:"source"};this._collectResourceTiming&&f&&f.length>0&&s.e(v,{resourceTiming:f}),this.fire(new s.k("data",Object.assign(Object.assign({},v),{sourceDataType:"metadata"}))),this.fire(new s.k("data",Object.assign(Object.assign({},v),{sourceDataType:"content"})))}catch(a){if(this._pendingLoads--,this._removed)return void this.fire(new s.k("dataabort",{dataType:"source"}));this.fire(new s.j(a))}})}loaded(){return this._pendingLoads===0}loadTile(t){return s._(this,void 0,void 0,function*(){const n=t.actor?"RT":"LT";t.actor=this.actor;const a={type:this.type,uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};t.abortController=new AbortController;const f=yield this.actor.sendAsync({type:n,data:a},t.abortController);delete t.abortController,t.unloadVectorData(),t.aborted||t.loadVectorData(f,this.map.painter,n==="RT")})}abortTile(t){return s._(this,void 0,void 0,function*(){t.abortController&&(t.abortController.abort(),delete t.abortController),t.aborted=!0})}unloadTile(t){return s._(this,void 0,void 0,function*(){t.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:t.uid,type:this.type,source:this.id}})})}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return s.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}var Lt=s.X([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class $t extends s.E{constructor(t,n,a,f){super(),this.id=t,this.dispatcher=a,this.coordinates=n.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(f),this.options=n}load(t){return s._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new s.k("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const n=yield O.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,n&&n.data&&(this.image=n.data,t&&(this.coordinates=t),this._finishLoading())}catch(n){this._request=null,this._loaded=!0,this.fire(new s.j(n))}})}loaded(){return this._loaded}updateImage(t){return t.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=t.url,this.load(t.coordinates).finally(()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new s.k("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(t){this.coordinates=t;const n=t.map(s.Y.fromLngLat);this.tileID=function(f){let v=1/0,I=1/0,k=-1/0,D=-1/0;for(const K of f)v=Math.min(v,K.x),I=Math.min(I,K.y),k=Math.max(k,K.x),D=Math.max(D,K.y);const B=Math.max(k-v,D-I),G=Math.max(0,Math.floor(-Math.log(B)/Math.LN2)),U=Math.pow(2,G);return new s.a0(G,Math.floor((v+k)/2*U),Math.floor((I+D)/2*U))}(n),this.minzoom=this.maxzoom=this.tileID.z;const a=n.map(f=>this.tileID.getTilePoint(f)._round());return this._boundsArray=new s.Z,this._boundsArray.emplaceBack(a[0].x,a[0].y,0,0),this._boundsArray.emplaceBack(a[1].x,a[1].y,s.W,0),this._boundsArray.emplaceBack(a[3].x,a[3].y,0,s.W),this._boundsArray.emplaceBack(a[2].x,a[2].y,s.W,s.W),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this.fire(new s.k("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const t=this.map.painter.context,n=t.gl;this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,Lt.members)),this.boundsSegments||(this.boundsSegments=s.$.simpleSegment(0,0,4,2)),this.texture||(this.texture=new Je(t,this.image,n.RGBA),this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE));let a=!1;for(const f in this.tiles){const v=this.tiles[f];v.state!=="loaded"&&(v.state="loaded",v.texture=this.texture,a=!0)}a&&this.fire(new s.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(t){return s._(this,void 0,void 0,function*(){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={}):t.state="errored"})}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class lt extends $t{constructor(t,n,a,f){super(t,n,a,f),this.roundZoom=!0,this.type="video",this.options=n}load(){return s._(this,void 0,void 0,function*(){this._loaded=!1;const t=this.options;this.urls=[];for(const n of t.urls)this.urls.push(this.map._requestManager.transformRequest(n,"Source").url);try{const n=yield s.a2(this.urls);if(this._loaded=!0,!n)return;this.video=n,this.video.loop=!0,this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading()}catch(n){this.fire(new s.j(n))}})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(t){if(this.video){const n=this.video.seekable;t<n.start(0)||t>n.end(0)?this.fire(new s.j(new s.a1(`sources.${this.id}`,null,`Playback for this video can be set only between the ${n.start(0)} and ${n.end(0)}-second mark.`))):this.video.currentTime=t}}getVideo(){return this.video}onAdd(t){this.map||(this.map=t,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const t=this.map.painter.context,n=t.gl;this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,Lt.members)),this.boundsSegments||(this.boundsSegments=s.$.simpleSegment(0,0,4,2)),this.texture?this.video.paused||(this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE),n.texSubImage2D(n.TEXTURE_2D,0,0,0,n.RGBA,n.UNSIGNED_BYTE,this.video)):(this.texture=new Je(t,this.video,n.RGBA),this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE));let a=!1;for(const f in this.tiles){const v=this.tiles[f];v.state!=="loaded"&&(v.state="loaded",v.texture=this.texture,a=!0)}a&&this.fire(new s.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class St extends $t{constructor(t,n,a,f){super(t,n,a,f),n.coordinates?Array.isArray(n.coordinates)&&n.coordinates.length===4&&!n.coordinates.some(v=>!Array.isArray(v)||v.length!==2||v.some(I=>typeof I!="number"))||this.fire(new s.j(new s.a1(`sources.${t}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.j(new s.a1(`sources.${t}`,null,'missing required property "coordinates"'))),n.animate&&typeof n.animate!="boolean"&&this.fire(new s.j(new s.a1(`sources.${t}`,null,'optional "animate" property must be a boolean value'))),n.canvas?typeof n.canvas=="string"||n.canvas instanceof HTMLCanvasElement||this.fire(new s.j(new s.a1(`sources.${t}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.j(new s.a1(`sources.${t}`,null,'missing required property "canvas"'))),this.options=n,this.animate=n.animate===void 0||n.animate}load(){return s._(this,void 0,void 0,function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.j(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())})}getCanvas(){return this.canvas}onAdd(t){this.map=t,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let t=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,t=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,t=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const n=this.map.painter.context,a=n.gl;this.boundsBuffer||(this.boundsBuffer=n.createVertexBuffer(this._boundsArray,Lt.members)),this.boundsSegments||(this.boundsSegments=s.$.simpleSegment(0,0,4,2)),this.texture?(t||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new Je(n,this.canvas,a.RGBA,{premultiply:!0});let f=!1;for(const v in this.tiles){const I=this.tiles[v];I.state!=="loaded"&&(I.state="loaded",I.texture=this.texture,f=!0)}f&&this.fire(new s.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const t of[this.canvas.width,this.canvas.height])if(isNaN(t)||t<=0)return!0;return!1}}const Xt={},di=y=>{switch(y){case"geojson":return ft;case"image":return $t;case"raster":return Ze;case"raster-dem":return pt;case"vector":return ae;case"video":return lt;case"canvas":return St}return Xt[y]},vi="RTLPluginLoaded";class Ci extends s.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=Xe()}_syncState(t){return this.status=t,this.dispatcher.broadcast("SRPS",{pluginStatus:t,pluginURL:this.url}).catch(n=>{throw this.status="error",n})}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(t){return s._(this,arguments,void 0,function*(n,a=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=l.resolveURL(n),!this.url)throw new Error(`requested url ${n} is invalid`);if(this.status==="unavailable"){if(!a)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()})}_requestImport(){return s._(this,void 0,void 0,function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new s.k(vi))})}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let ct=null;function Ei(){return ct||(ct=new Ci),ct}class Fi{constructor(t,n){this.timeAdded=0,this.fadeEndTime=0,this.tileID=t,this.uid=s.a3(),this.uses=0,this.tileSize=n,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(t){const n=t+this.timeAdded;n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(t){this.demTexture&&t.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(t,n,a){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(f,v){const I={};if(!v)return I;for(const k of f){const D=k.layerIds.map(B=>v.getLayer(B)).filter(Boolean);if(D.length!==0){k.layers=D,k.stateDependentLayerIds&&(k.stateDependentLayers=k.stateDependentLayerIds.map(B=>D.filter(G=>G.id===B)[0]));for(const B of D)I[B.id]=k}}return I}(t.buckets,n.style),this.hasSymbolBuckets=!1;for(const f in this.buckets){const v=this.buckets[f];if(v instanceof s.a5){if(this.hasSymbolBuckets=!0,!a)break;v.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const f in this.buckets){const v=this.buckets[f];if(v instanceof s.a5&&v.hasRTLText){this.hasRTLText=!0,Ei().lazyLoad();break}}this.queryPadding=0;for(const f in this.buckets){const v=this.buckets[f];this.queryPadding=Math.max(this.queryPadding,n.style.getLayer(f).queryRadius(v))}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage)}else this.collisionBoxArray=new s.a4}unloadVectorData(){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(t){return this.buckets[t.id]}upload(t){for(const a in this.buckets){const f=this.buckets[a];f.uploadPending()&&f.upload(t)}const n=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new Je(t,this.imageAtlas.image,n.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new Je(t,this.glyphAtlasImage,n.ALPHA),this.glyphAtlasImage=null)}prepare(t){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture)}queryRenderedFeatures(t,n,a,f,v,I,k,D,B,G){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:f,cameraQueryGeometry:v,scale:I,tileSize:this.tileSize,pixelPosMatrix:G,transform:D,params:k,queryPadding:this.queryPadding*B},t,n,a):{}}querySourceFeatures(t,n){const a=this.latestFeatureIndex;if(!a||!a.rawTileData)return;const f=a.loadVTLayers(),v=n&&n.sourceLayer?n.sourceLayer:"",I=f._geojsonTileLayer||f[v];if(!I)return;const k=s.a6(n&&n.filter),{z:D,x:B,y:G}=this.tileID.canonical,U={z:D,x:B,y:G};for(let K=0;K<I.length;K++){const ie=I.feature(K);if(k.needGeometry){const ce=s.a7(ie,!0);if(!k.filter(new s.a8(this.tileID.overscaledZ),ce,this.tileID.canonical))continue}else if(!k.filter(new s.a8(this.tileID.overscaledZ),ie))continue;const oe=a.getId(ie,v),ve=new s.a9(ie,D,B,G,oe);ve.tile=U,t.push(ve)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const n=this.expirationTime;if(t.cacheControl){const a=s.aa(t.cacheControl);a["max-age"]&&(this.expirationTime=Date.now()+1e3*a["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const a=Date.now();let f=!1;if(this.expirationTime>a)f=!1;else if(n)if(this.expirationTime<n)f=!0;else{const v=this.expirationTime-n;v?this.expirationTime=a+Math.max(v,3e4):f=!0}else f=!0;f?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(t,n){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(t).length===0)return;const a=this.latestFeatureIndex.loadVTLayers();for(const f in this.buckets){if(!n.style.hasLayer(f))continue;const v=this.buckets[f],I=v.layers[0].sourceLayer||"_geojsonTileLayer",k=a[I],D=t[I];if(!k||!D||Object.keys(D).length===0)continue;v.update(D,k,this.imageAtlas&&this.imageAtlas.patternPositions||{});const B=n&&n.style&&n.style.getLayer(f);B&&(this.queryPadding=Math.max(this.queryPadding,B.queryRadius(v)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<l.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=l.now()+t}setDependencies(t,n){const a={};for(const f of n)a[f]=!0;this.dependencies[t]=a}hasDependency(t,n){for(const a of t){const f=this.dependencies[a];if(f){for(const v of n)if(f[v])return!0}}return!1}}class yr{constructor(t,n){this.max=t,this.onRemove=n,this.reset()}reset(){for(const t in this.data)for(const n of this.data[t])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(t,n,a){const f=t.wrapped().key;this.data[f]===void 0&&(this.data[f]=[]);const v={value:n,timeout:void 0};if(a!==void 0&&(v.timeout=setTimeout(()=>{this.remove(t,v)},a)),this.data[f].push(v),this.order.push(f),this.order.length>this.max){const I=this._getAndRemoveByKey(this.order[0]);I&&this.onRemove(I)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const n=this.data[t].shift();return n.timeout&&clearTimeout(n.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),n.value}getByKey(t){const n=this.data[t];return n?n[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,n){if(!this.has(t))return this;const a=t.wrapped().key,f=n===void 0?0:this.data[a].indexOf(n),v=this.data[a][f];return this.data[a].splice(f,1),v.timeout&&clearTimeout(v.timeout),this.data[a].length===0&&delete this.data[a],this.onRemove(v.value),this.order.splice(this.order.indexOf(a),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(t){const n=[];for(const a in this.data)for(const f of this.data[a])t(f.value)||n.push(f);for(const a of n)this.remove(a.value.tileID,a)}}class Zi{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,n,a){const f=String(n);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][f]=this.stateChanges[t][f]||{},s.e(this.stateChanges[t][f],a),this.deletedStates[t]===null){this.deletedStates[t]={};for(const v in this.state[t])v!==f&&(this.deletedStates[t][v]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][f]===null){this.deletedStates[t][f]={};for(const v in this.state[t][f])a[v]||(this.deletedStates[t][f][v]=null)}else for(const v in a)this.deletedStates[t]&&this.deletedStates[t][f]&&this.deletedStates[t][f][v]===null&&delete this.deletedStates[t][f][v]}removeFeatureState(t,n,a){if(this.deletedStates[t]===null)return;const f=String(n);if(this.deletedStates[t]=this.deletedStates[t]||{},a&&n!==void 0)this.deletedStates[t][f]!==null&&(this.deletedStates[t][f]=this.deletedStates[t][f]||{},this.deletedStates[t][f][a]=null);else if(n!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][f])for(a in this.deletedStates[t][f]={},this.stateChanges[t][f])this.deletedStates[t][f][a]=null;else this.deletedStates[t][f]=null;else this.deletedStates[t]=null}getState(t,n){const a=String(n),f=s.e({},(this.state[t]||{})[a],(this.stateChanges[t]||{})[a]);if(this.deletedStates[t]===null)return{};if(this.deletedStates[t]){const v=this.deletedStates[t][n];if(v===null)return{};for(const I in v)delete f[I]}return f}initializeTileState(t,n){t.setFeatureState(this.state,n)}coalesceChanges(t,n){const a={};for(const f in this.stateChanges){this.state[f]=this.state[f]||{};const v={};for(const I in this.stateChanges[f])this.state[f][I]||(this.state[f][I]={}),s.e(this.state[f][I],this.stateChanges[f][I]),v[I]=this.state[f][I];a[f]=v}for(const f in this.deletedStates){this.state[f]=this.state[f]||{};const v={};if(this.deletedStates[f]===null)for(const I in this.state[f])v[I]={},this.state[f][I]={};else for(const I in this.deletedStates[f]){if(this.deletedStates[f][I]===null)this.state[f][I]={};else for(const k of Object.keys(this.deletedStates[f][I]))delete this.state[f][I][k];v[I]=this.state[f][I]}a[f]=a[f]||{},s.e(a[f],v)}if(this.stateChanges={},this.deletedStates={},Object.keys(a).length!==0)for(const f in t)t[f].setFeatureState(a,n)}}class Ct extends s.E{constructor(t,n,a){super(),this.id=t,this.dispatcher=a,this.on("data",f=>this._dataHandler(f)),this.on("dataloading",()=>{this._sourceErrored=!1}),this.on("error",()=>{this._sourceErrored=this._source.loaded()}),this._source=((f,v,I,k)=>{const D=new(di(v.type))(f,v,I,k);if(D.id!==f)throw new Error(`Expected Source id to be ${f} instead of ${D.id}`);return D})(t,n,a,this),this._tiles={},this._cache=new yr(0,f=>this._unloadTile(f)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new Zi,this._didEmitContent=!1,this._updated=!1}onAdd(t){this.map=t,this._maxTileCacheSize=t?t._maxTileCacheSize:null,this._maxTileCacheZoomLevels=t?t._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(t)}onRemove(t){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(t)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const t in this._tiles){const n=this._tiles[t];if(n.state!=="loaded"&&n.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(t,n,a){return s._(this,void 0,void 0,function*(){try{yield this._source.loadTile(t),this._tileLoaded(t,n,a)}catch(f){t.state="errored",f.status!==404?this._source.fire(new s.j(f,{tile:t})):this.update(this.transform,this.terrain)}})}_unloadTile(t){this._source.unloadTile&&this._source.unloadTile(t)}_abortTile(t){this._source.abortTile&&this._source.abortTile(t),this._source.fire(new s.k("dataabort",{tile:t,coord:t.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const a=this._tiles[n];a.upload(t),a.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(pi).map(t=>t.key)}getRenderableIds(t){const n=[];for(const a in this._tiles)this._isIdRenderable(a,t)&&n.push(this._tiles[a]);return t?n.sort((a,f)=>{const v=a.tileID,I=f.tileID,k=new s.P(v.canonical.x,v.canonical.y)._rotate(this.transform.angle),D=new s.P(I.canonical.x,I.canonical.y)._rotate(this.transform.angle);return v.overscaledZ-I.overscaledZ||D.y-k.y||D.x-k.x}).map(a=>a.tileID.key):n.map(a=>a.tileID).sort(pi).map(a=>a.key)}hasRenderableParent(t){const n=this.findLoadedParent(t,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(t,n){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(n||!this._tiles[t].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(t,"reloading")}}_reloadTile(t,n){return s._(this,void 0,void 0,function*(){const a=this._tiles[t];a&&(a.state!=="loading"&&(a.state=n),yield this._loadTile(a,t,n))})}_tileLoaded(t,n,a){t.timeAdded=l.now(),a==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(n,t),this.getSource().type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),t.aborted||this._source.fire(new s.k("data",{dataType:"source",tile:t,coord:t.tileID}))}_backfillDEM(t){const n=this.getRenderableIds();for(let f=0;f<n.length;f++){const v=n[f];if(t.neighboringTiles&&t.neighboringTiles[v]){const I=this.getTileByID(v);a(t,I),a(I,t)}}function a(f,v){f.needsHillshadePrepare=!0,f.needsTerrainPrepare=!0;let I=v.tileID.canonical.x-f.tileID.canonical.x;const k=v.tileID.canonical.y-f.tileID.canonical.y,D=Math.pow(2,f.tileID.canonical.z),B=v.tileID.key;I===0&&k===0||Math.abs(k)>1||(Math.abs(I)>1&&(Math.abs(I+D)===1?I+=D:Math.abs(I-D)===1&&(I-=D)),v.dem&&f.dem&&(f.dem.backfillBorder(v.dem,I,k),f.neighboringTiles&&f.neighboringTiles[B]&&(f.neighboringTiles[B].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,n,a,f){for(const v in this._tiles){let I=this._tiles[v];if(f[v]||!I.hasData()||I.tileID.overscaledZ<=n||I.tileID.overscaledZ>a)continue;let k=I.tileID;for(;I&&I.tileID.overscaledZ>n+1;){const B=I.tileID.scaledTo(I.tileID.overscaledZ-1);I=this._tiles[B.key],I&&I.hasData()&&(k=B)}let D=k;for(;D.overscaledZ>n;)if(D=D.scaledTo(D.overscaledZ-1),t[D.key]){f[k.key]=k;break}}}findLoadedParent(t,n){if(t.key in this._loadedParentTiles){const a=this._loadedParentTiles[t.key];return a&&a.tileID.overscaledZ>=n?a:null}for(let a=t.overscaledZ-1;a>=n;a--){const f=t.scaledTo(a),v=this._getLoadedTile(f);if(v)return v}}findLoadedSibling(t){return this._getLoadedTile(t)}_getLoadedTile(t){const n=this._tiles[t.key];return n&&n.hasData()?n:this._cache.getByKey(t.wrapped().key)}updateCacheSize(t){const n=Math.ceil(t.width/this._source.tileSize)+1,a=Math.ceil(t.height/this._source.tileSize)+1,f=Math.floor(n*a*(this._maxTileCacheZoomLevels===null?s.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),v=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,f):f;this._cache.setMaxSize(v)}handleWrapJump(t){const n=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,n){const a={};for(const f in this._tiles){const v=this._tiles[f];v.tileID=v.tileID.unwrapTo(v.tileID.wrap+n),a[v.tileID.key]=v}this._tiles=a;for(const f in this._timers)clearTimeout(this._timers[f]),delete this._timers[f];for(const f in this._tiles)this._setTileReloadTimer(f,this._tiles[f])}}_updateCoveredAndRetainedTiles(t,n,a,f,v,I){const k={},D={},B=Object.keys(t),G=l.now();for(const U of B){const K=t[U],ie=this._tiles[U];if(!ie||ie.fadeEndTime!==0&&ie.fadeEndTime<=G)continue;const oe=this.findLoadedParent(K,n),ve=this.findLoadedSibling(K),ce=oe||ve||null;ce&&(this._addTile(ce.tileID),k[ce.tileID.key]=ce.tileID),D[U]=K}this._retainLoadedChildren(D,f,a,t);for(const U in k)t[U]||(this._coveredTiles[U]=!0,t[U]=k[U]);if(I){const U={},K={};for(const ie of v)this._tiles[ie.key].hasData()?U[ie.key]=ie:K[ie.key]=ie;for(const ie in K){const oe=K[ie].children(this._source.maxzoom);this._tiles[oe[0].key]&&this._tiles[oe[1].key]&&this._tiles[oe[2].key]&&this._tiles[oe[3].key]&&(U[oe[0].key]=t[oe[0].key]=oe[0],U[oe[1].key]=t[oe[1].key]=oe[1],U[oe[2].key]=t[oe[2].key]=oe[2],U[oe[3].key]=t[oe[3].key]=oe[3],delete K[ie])}for(const ie in K){const oe=K[ie],ve=this.findLoadedParent(oe,this._source.minzoom),ce=this.findLoadedSibling(oe),Se=ve||ce||null;if(Se){U[Se.tileID.key]=t[Se.tileID.key]=Se.tileID;for(const ke in U)U[ke].isChildOf(Se.tileID)&&delete U[ke]}}for(const ie in this._tiles)U[ie]||(this._coveredTiles[ie]=!0)}}update(t,n){if(!this._sourceLoaded||this._paused)return;let a;this.transform=t,this.terrain=n,this.updateCacheSize(t),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?a=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(G=>new s.Q(G.canonical.z,G.wrap,G.canonical.z,G.canonical.x,G.canonical.y)):(a=t.coveringTiles({tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:n}),this._source.hasTile&&(a=a.filter(G=>this._source.hasTile(G)))):a=[];const f=t.coveringZoomLevel(this._source),v=Math.max(f-Ct.maxOverzooming,this._source.minzoom),I=Math.max(f+Ct.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const G={};for(const U of a)if(U.canonical.z>this._source.minzoom){const K=U.scaledTo(U.canonical.z-1);G[K.key]=K;const ie=U.scaledTo(Math.max(this._source.minzoom,Math.min(U.canonical.z,5)));G[ie.key]=ie}a=a.concat(Object.values(G))}const k=a.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,k&&this.fire(new s.k("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const D=this._updateRetainedTiles(a,f);Qt(this._source.type)&&this._updateCoveredAndRetainedTiles(D,v,I,f,a,n);for(const G in D)this._tiles[G].clearFadeHold();const B=s.ab(this._tiles,D);for(const G of B){const U=this._tiles[G];U.hasSymbolBuckets&&!U.holdingForFade()?U.setHoldDuration(this.map._fadeDuration):U.hasSymbolBuckets&&!U.symbolFadeFinished()||this._removeTile(G)}this._updateLoadedParentTileCache(),this._updateLoadedSiblingTileCache()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(t)}_updateRetainedTiles(t,n){var a;const f={},v={},I=Math.max(n-Ct.maxOverzooming,this._source.minzoom),k=Math.max(n+Ct.maxUnderzooming,this._source.minzoom),D={};for(const B of t){const G=this._addTile(B);f[B.key]=B,G.hasData()||n<this._source.maxzoom&&(D[B.key]=B)}this._retainLoadedChildren(D,n,k,f);for(const B of t){let G=this._tiles[B.key];if(G.hasData())continue;if(n+1>this._source.maxzoom){const K=B.children(this._source.maxzoom)[0],ie=this.getTile(K);if(ie&&ie.hasData()){f[K.key]=K;continue}}else{const K=B.children(this._source.maxzoom);if(f[K[0].key]&&f[K[1].key]&&f[K[2].key]&&f[K[3].key])continue}let U=G.wasRequested();for(let K=B.overscaledZ-1;K>=I;--K){const ie=B.scaledTo(K);if(v[ie.key])break;if(v[ie.key]=!0,G=this.getTile(ie),!G&&U&&(G=this._addTile(ie)),G){const oe=G.hasData();if((oe||!(!((a=this.map)===null||a===void 0)&&a.cancelPendingTileRequestsWhileZooming)||U)&&(f[ie.key]=ie),U=G.wasRequested(),oe)break}}}return f}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const n=[];let a,f=this._tiles[t].tileID;for(;f.overscaledZ>0;){if(f.key in this._loadedParentTiles){a=this._loadedParentTiles[f.key];break}n.push(f.key);const v=f.scaledTo(f.overscaledZ-1);if(a=this._getLoadedTile(v),a)break;f=v}for(const v of n)this._loadedParentTiles[v]=a}}_updateLoadedSiblingTileCache(){this._loadedSiblingTiles={};for(const t in this._tiles){const n=this._tiles[t].tileID,a=this._getLoadedTile(n);this._loadedSiblingTiles[n.key]=a}}_addTile(t){let n=this._tiles[t.key];if(n)return n;n=this._cache.getAndRemove(t),n&&(this._setTileReloadTimer(t.key,n),n.tileID=t,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,n)));const a=n;return n||(n=new Fi(t,this._source.tileSize*t.overscaleFactor()),this._loadTile(n,t.key,n.state)),n.uses++,this._tiles[t.key]=n,a||this._source.fire(new s.k("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n}_setTileReloadTimer(t,n){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const a=n.getExpiryTimeout();a&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},a))}_removeTile(t){const n=this._tiles[t];n&&(n.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),n.uses>0||(n.hasData()&&n.state!=="reloading"?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}_dataHandler(t){const n=t.sourceDataType;t.dataType==="source"&&n==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&t.dataType==="source"&&n==="content"&&(this.reload(),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(t);this._cache.reset()}tilesIn(t,n,a){const f=[],v=this.transform;if(!v)return f;const I=a?v.getCameraQueryGeometry(t):t,k=t.map(oe=>v.pointCoordinate(oe,this.terrain)),D=I.map(oe=>v.pointCoordinate(oe,this.terrain)),B=this.getIds();let G=1/0,U=1/0,K=-1/0,ie=-1/0;for(const oe of D)G=Math.min(G,oe.x),U=Math.min(U,oe.y),K=Math.max(K,oe.x),ie=Math.max(ie,oe.y);for(let oe=0;oe<B.length;oe++){const ve=this._tiles[B[oe]];if(ve.holdingForFade())continue;const ce=ve.tileID,Se=Math.pow(2,v.zoom-ve.tileID.overscaledZ),ke=n*ve.queryPadding*s.W/ve.tileSize/Se,pe=[ce.getTilePoint(new s.Y(G,U)),ce.getTilePoint(new s.Y(K,ie))];if(pe[0].x-ke<s.W&&pe[0].y-ke<s.W&&pe[1].x+ke>=0&&pe[1].y+ke>=0){const Fe=k.map(Ye=>ce.getTilePoint(Ye)),We=D.map(Ye=>ce.getTilePoint(Ye));f.push({tile:ve,tileID:ce,queryGeometry:Fe,cameraQueryGeometry:We,scale:Se})}}return f}getVisibleCoordinates(t){const n=this.getRenderableIds(t).map(a=>this._tiles[a].tileID);for(const a of n)a.posMatrix=this.transform.calculatePosMatrix(a.toUnwrapped());return n}hasTransition(){if(this._source.hasTransition())return!0;if(Qt(this._source.type)){const t=l.now();for(const n in this._tiles)if(this._tiles[n].fadeEndTime>=t)return!0}return!1}setFeatureState(t,n,a){this._state.updateState(t=t||"_geojsonTileLayer",n,a)}removeFeatureState(t,n,a){this._state.removeFeatureState(t=t||"_geojsonTileLayer",n,a)}getFeatureState(t,n){return this._state.getState(t=t||"_geojsonTileLayer",n)}setDependencies(t,n,a){const f=this._tiles[t];f&&f.setDependencies(n,a)}reloadTilesForDependencies(t,n){for(const a in this._tiles)this._tiles[a].hasDependency(t,n)&&this._reloadTile(a,"reloading");this._cache.filter(a=>!a.hasDependency(t,n))}}function pi(y,t){const n=Math.abs(2*y.wrap)-+(y.wrap<0),a=Math.abs(2*t.wrap)-+(t.wrap<0);return y.overscaledZ-t.overscaledZ||a-n||t.canonical.y-y.canonical.y||t.canonical.x-y.canonical.x}function Qt(y){return y==="raster"||y==="image"||y==="video"}Ct.maxOverzooming=10,Ct.maxUnderzooming=3;class qi{constructor(t,n){this.reset(t,n)}reset(t,n){this.points=t||[],this._distances=[0];for(let a=1;a<this.points.length;a++)this._distances[a]=this._distances[a-1]+this.points[a].dist(this.points[a-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(n||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=s.ac(t,0,1);let n=1,a=this._distances[n];const f=t*this.paddedLength+this.padding;for(;a<f&&n<this._distances.length;)a=this._distances[++n];const v=n-1,I=this._distances[v],k=a-I,D=k>0?(f-I)/k:0;return this.points[v].mult(1-D).add(this.points[n].mult(D))}}function ar(y,t){let n=!0;return y==="always"||y!=="never"&&t!=="never"||(n=!1),n}class si{constructor(t,n,a){const f=this.boxCells=[],v=this.circleCells=[];this.xCellCount=Math.ceil(t/a),this.yCellCount=Math.ceil(n/a);for(let I=0;I<this.xCellCount*this.yCellCount;I++)f.push([]),v.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=n,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/n,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,n,a,f,v){this._forEachCell(n,a,f,v,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(n),this.bboxes.push(a),this.bboxes.push(f),this.bboxes.push(v)}insertCircle(t,n,a,f){this._forEachCell(n-f,a-f,n+f,a+f,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(n),this.circles.push(a),this.circles.push(f)}_insertBoxCell(t,n,a,f,v,I){this.boxCells[v].push(I)}_insertCircleCell(t,n,a,f,v,I){this.circleCells[v].push(I)}_query(t,n,a,f,v,I,k){if(a<0||t>this.width||f<0||n>this.height)return[];const D=[];if(t<=0&&n<=0&&this.width<=a&&this.height<=f){if(v)return[{key:null,x1:t,y1:n,x2:a,y2:f}];for(let B=0;B<this.boxKeys.length;B++)D.push({key:this.boxKeys[B],x1:this.bboxes[4*B],y1:this.bboxes[4*B+1],x2:this.bboxes[4*B+2],y2:this.bboxes[4*B+3]});for(let B=0;B<this.circleKeys.length;B++){const G=this.circles[3*B],U=this.circles[3*B+1],K=this.circles[3*B+2];D.push({key:this.circleKeys[B],x1:G-K,y1:U-K,x2:G+K,y2:U+K})}}else this._forEachCell(t,n,a,f,this._queryCell,D,{hitTest:v,overlapMode:I,seenUids:{box:{},circle:{}}},k);return D}query(t,n,a,f){return this._query(t,n,a,f,!1,null)}hitTest(t,n,a,f,v,I){return this._query(t,n,a,f,!0,v,I).length>0}hitTestCircle(t,n,a,f,v){const I=t-a,k=t+a,D=n-a,B=n+a;if(k<0||I>this.width||B<0||D>this.height)return!1;const G=[];return this._forEachCell(I,D,k,B,this._queryCellCircle,G,{hitTest:!0,overlapMode:f,circle:{x:t,y:n,radius:a},seenUids:{box:{},circle:{}}},v),G.length>0}_queryCell(t,n,a,f,v,I,k,D){const{seenUids:B,hitTest:G,overlapMode:U}=k,K=this.boxCells[v];if(K!==null){const oe=this.bboxes;for(const ve of K)if(!B.box[ve]){B.box[ve]=!0;const ce=4*ve,Se=this.boxKeys[ve];if(t<=oe[ce+2]&&n<=oe[ce+3]&&a>=oe[ce+0]&&f>=oe[ce+1]&&(!D||D(Se))&&(!G||!ar(U,Se.overlapMode))&&(I.push({key:Se,x1:oe[ce],y1:oe[ce+1],x2:oe[ce+2],y2:oe[ce+3]}),G))return!0}}const ie=this.circleCells[v];if(ie!==null){const oe=this.circles;for(const ve of ie)if(!B.circle[ve]){B.circle[ve]=!0;const ce=3*ve,Se=this.circleKeys[ve];if(this._circleAndRectCollide(oe[ce],oe[ce+1],oe[ce+2],t,n,a,f)&&(!D||D(Se))&&(!G||!ar(U,Se.overlapMode))){const ke=oe[ce],pe=oe[ce+1],Fe=oe[ce+2];if(I.push({key:Se,x1:ke-Fe,y1:pe-Fe,x2:ke+Fe,y2:pe+Fe}),G)return!0}}}return!1}_queryCellCircle(t,n,a,f,v,I,k,D){const{circle:B,seenUids:G,overlapMode:U}=k,K=this.boxCells[v];if(K!==null){const oe=this.bboxes;for(const ve of K)if(!G.box[ve]){G.box[ve]=!0;const ce=4*ve,Se=this.boxKeys[ve];if(this._circleAndRectCollide(B.x,B.y,B.radius,oe[ce+0],oe[ce+1],oe[ce+2],oe[ce+3])&&(!D||D(Se))&&!ar(U,Se.overlapMode))return I.push(!0),!0}}const ie=this.circleCells[v];if(ie!==null){const oe=this.circles;for(const ve of ie)if(!G.circle[ve]){G.circle[ve]=!0;const ce=3*ve,Se=this.circleKeys[ve];if(this._circlesCollide(oe[ce],oe[ce+1],oe[ce+2],B.x,B.y,B.radius)&&(!D||D(Se))&&!ar(U,Se.overlapMode))return I.push(!0),!0}}}_forEachCell(t,n,a,f,v,I,k,D){const B=this._convertToXCellCoord(t),G=this._convertToYCellCoord(n),U=this._convertToXCellCoord(a),K=this._convertToYCellCoord(f);for(let ie=B;ie<=U;ie++)for(let oe=G;oe<=K;oe++)if(v.call(this,t,n,a,f,this.xCellCount*oe+ie,I,k,D))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,n,a,f,v,I){const k=f-t,D=v-n,B=a+I;return B*B>k*k+D*D}_circleAndRectCollide(t,n,a,f,v,I,k){const D=(I-f)/2,B=Math.abs(t-(f+D));if(B>D+a)return!1;const G=(k-v)/2,U=Math.abs(n-(v+G));if(U>G+a)return!1;if(B<=D||U<=G)return!0;const K=B-D,ie=U-G;return K*K+ie*ie<=a*a}}function Oi(y,t,n,a,f){const v=s.F();return t?(s.J(v,v,[1/f,1/f,1]),n||s.ad(v,v,a.angle)):s.K(v,a.labelPlaneMatrix,y),v}function $i(y,t,n,a,f){if(t){const v=s.ae(y);return s.J(v,v,[f,f,1]),n||s.ad(v,v,-a.angle),v}return a.glCoordMatrix}function Ki(y,t,n){let a;n?(a=[y.x,y.y,n(y.x,y.y),1],s.af(a,a,t)):(a=[y.x,y.y,0,1],function(v,I,k){const D=I[0],B=I[1];v[0]=k[0]*D+k[4]*B+k[12],v[1]=k[1]*D+k[5]*B+k[13],v[3]=k[3]*D+k[7]*B+k[15]}(a,a,t));const f=a[3];return{point:new s.P(a[0]/f,a[1]/f),signedDistanceFromCamera:f,isOccluded:!1}}function le(y,t){return .5+y/t*.5}function H(y,t){return y.x>=-t[0]&&y.x<=t[0]&&y.y>=-t[1]&&y.y<=t[1]}function X(y,t,n,a,f,v,I,k,D,B,G,U,K,ie,oe){const ve=a?y.textSizeData:y.iconSizeData,ce=s.ag(ve,n.transform.zoom),Se=[256/n.width*2+1,256/n.height*2+1],ke=a?y.text.dynamicLayoutVertexArray:y.icon.dynamicLayoutVertexArray;ke.clear();const pe=y.lineVertexArray,Fe=a?y.text.placedSymbolArray:y.icon.placedSymbolArray,We=n.transform.width/n.transform.height;let Ye=!1;for(let mt=0;mt<Fe.length;mt++){const Tt=Fe.get(mt);if(Tt.hidden||Tt.writingMode===s.ah.vertical&&!Ye){ti(Tt.numGlyphs,ke);continue}Ye=!1;const Ht=Ki(new s.P(Tt.anchorX,Tt.anchorY),t,oe);if(!H(Ht.point,Se)){ti(Tt.numGlyphs,ke);continue}const qt=le(n.transform.cameraToCenterDistance,Ht.signedDistanceFromCamera),Pt=s.ai(ve,ce,Tt),kt=I?Pt/qt:Pt*qt,Jt={getElevation:oe,labelPlaneMatrix:f,lineVertexArray:pe,pitchWithMap:I,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},projection:B,tileAnchorPoint:new s.P(Tt.anchorX,Tt.anchorY),unwrappedTileID:G,width:U,height:K,translation:ie},Ti=Te(Jt,Tt,kt,!1,k,t,v,y.glyphOffsetArray,ke,We,D);Ye=Ti.useVertical,(Ti.notEnoughRoom||Ye||Ti.needsFlipping&&Te(Jt,Tt,kt,!0,k,t,v,y.glyphOffsetArray,ke,We,D).notEnoughRoom)&&ti(Tt.numGlyphs,ke)}a?y.text.dynamicLayoutVertexBuffer.updateData(ke):y.icon.dynamicLayoutVertexBuffer.updateData(ke)}function J(y,t,n,a,f,v,I,k){const D=v.glyphStartIndex+v.numGlyphs,B=v.lineStartIndex,G=v.lineStartIndex+v.lineLength,U=t.getoffsetX(v.glyphStartIndex),K=t.getoffsetX(D-1),ie=Qe(y*U,n,a,f,v.segment,B,G,k,I);if(!ie)return null;const oe=Qe(y*K,n,a,f,v.segment,B,G,k,I);return oe?k.projectionCache.anyProjectionOccluded?null:{first:ie,last:oe}:null}function de(y,t,n,a){return y===s.ah.horizontal&&Math.abs(n.y-t.y)>Math.abs(n.x-t.x)*a?{useVertical:!0}:(y===s.ah.vertical?t.y<n.y:t.x>n.x)?{needsFlipping:!0}:null}function Te(y,t,n,a,f,v,I,k,D,B,G){const U=n/24,K=t.lineOffsetX*U,ie=t.lineOffsetY*U;let oe;if(t.numGlyphs>1){const ve=t.glyphStartIndex+t.numGlyphs,ce=t.lineStartIndex,Se=t.lineStartIndex+t.lineLength,ke=J(U,k,K,ie,a,t,G,y);if(!ke)return{notEnoughRoom:!0};const pe=Ki(ke.first.point,I,y.getElevation).point,Fe=Ki(ke.last.point,I,y.getElevation).point;if(f&&!a){const We=de(t.writingMode,pe,Fe,B);if(We)return We}oe=[ke.first];for(let We=t.glyphStartIndex+1;We<ve-1;We++)oe.push(Qe(U*k.getoffsetX(We),K,ie,a,t.segment,ce,Se,y,G));oe.push(ke.last)}else{if(f&&!a){const ce=Ki(y.tileAnchorPoint,v,y.getElevation).point,Se=t.lineStartIndex+t.segment+1,ke=new s.P(y.lineVertexArray.getx(Se),y.lineVertexArray.gety(Se)),pe=Ki(ke,v,y.getElevation),Fe=pe.signedDistanceFromCamera>0?pe.point:function(Ye,mt,Tt,Ht,qt,Pt){return De(Ye,mt,Tt,1,qt,Pt)}(y.tileAnchorPoint,ke,ce,0,v,y),We=de(t.writingMode,ce,Fe,B);if(We)return We}const ve=Qe(U*k.getoffsetX(t.glyphStartIndex),K,ie,a,t.segment,t.lineStartIndex,t.lineStartIndex+t.lineLength,y,G);if(!ve||y.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};oe=[ve]}for(const ve of oe)s.aj(D,ve.point,ve.angle);return{}}function De(y,t,n,a,f,v){const I=y.add(y.sub(t)._unit()),k=f!==void 0?Ki(I,f,v.getElevation).point:Ce(I.x,I.y,v).point,D=n.sub(k);return n.add(D._mult(a/D.mag()))}function Le(y,t,n){const a=t.projectionCache;if(a.projections[y])return a.projections[y];const f=new s.P(t.lineVertexArray.getx(y),t.lineVertexArray.gety(y)),v=Ce(f.x,f.y,t);if(v.signedDistanceFromCamera>0)return a.projections[y]=v.point,a.anyProjectionOccluded=a.anyProjectionOccluded||v.isOccluded,v.point;const I=y-n.direction;return function(k,D,B,G,U){return De(k,D,B,G,void 0,U)}(n.distanceFromAnchor===0?t.tileAnchorPoint:new s.P(t.lineVertexArray.getx(I),t.lineVertexArray.gety(I)),f,n.previousVertex,n.absOffsetX-n.distanceFromAnchor+1,t)}function Ce(y,t,n){const a=y+n.translation[0],f=t+n.translation[1];let v;return!n.pitchWithMap&&n.projection.useSpecialProjectionForSymbols?(v=n.projection.projectTileCoordinates(a,f,n.unwrappedTileID,n.getElevation),v.point.x=(.5*v.point.x+.5)*n.width,v.point.y=(.5*-v.point.y+.5)*n.height):(v=Ki(new s.P(a,f),n.labelPlaneMatrix,n.getElevation),v.isOccluded=!1),v}function Ge(y,t,n){return y._unit()._perp()._mult(t*n)}function gt(y,t,n,a,f,v,I,k,D){if(k.projectionCache.offsets[y])return k.projectionCache.offsets[y];const B=n.add(t);if(y+D.direction<a||y+D.direction>=f)return k.projectionCache.offsets[y]=B,B;const G=Le(y+D.direction,k,D),U=Ge(G.sub(n),I,D.direction),K=n.add(U),ie=G.add(U);return k.projectionCache.offsets[y]=s.ak(v,B,K,ie)||B,k.projectionCache.offsets[y]}function Qe(y,t,n,a,f,v,I,k,D){const B=a?y-t:y+t;let G=B>0?1:-1,U=0;a&&(G*=-1,U=Math.PI),G<0&&(U+=Math.PI);let K,ie=G>0?v+f:v+f+1;k.projectionCache.cachedAnchorPoint?K=k.projectionCache.cachedAnchorPoint:(K=Ce(k.tileAnchorPoint.x,k.tileAnchorPoint.y,k).point,k.projectionCache.cachedAnchorPoint=K);let oe,ve,ce=K,Se=K,ke=0,pe=0;const Fe=Math.abs(B),We=[];let Ye;for(;ke+pe<=Fe;){if(ie+=G,ie<v||ie>=I)return null;ke+=pe,Se=ce,ve=oe;const Ht={absOffsetX:Fe,direction:G,distanceFromAnchor:ke,previousVertex:Se};if(ce=Le(ie,k,Ht),n===0)We.push(Se),Ye=ce.sub(Se);else{let qt;const Pt=ce.sub(Se);qt=Pt.mag()===0?Ge(Le(ie+G,k,Ht).sub(ce),n,G):Ge(Pt,n,G),ve||(ve=Se.add(qt)),oe=gt(ie,qt,ce,v,I,ve,n,k,Ht),We.push(ve),Ye=oe.sub(ve)}pe=Ye.mag()}const mt=Ye._mult((Fe-ke)/pe)._add(ve||Se),Tt=U+Math.atan2(ce.y-Se.y,ce.x-Se.x);return We.push(mt),{point:mt,angle:D?Tt:0,path:We}}const st=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function ti(y,t){for(let n=0;n<y;n++){const a=t.length;t.resize(a+4),t.float32.set(st,3*a)}}const ei=100;class xi{constructor(t,n,a=new si(t.width+200,t.height+200,25),f=new si(t.width+200,t.height+200,25)){this.transform=t,this.mapProjection=n,this.grid=a,this.ignoredGrid=f,this.pitchFactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+ei,this.screenBottomBoundary=t.height+ei,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(t,n,a,f,v,I,k,D,B,G,U){const K=t.anchorPointX+D[0],ie=t.anchorPointY+D[1],oe=this.projectAndGetPerspectiveRatio(f,K,ie,v,G),ve=this._projectCollisionBox(t,a,f,v,I,k,D,oe,G,U),[ce,Se,ke,pe]=ve.box;return this.mapProjection.useSpecialProjectionForSymbols&&(I?ve.allPointsOccluded:this.mapProjection.isOccluded(K,ie,v))||oe.perspectiveRatio<this.perspectiveRatioCutoff||!this.isInsideGrid(ce,Se,ke,pe)||n!=="always"&&this.grid.hitTest(ce,Se,ke,pe,n,B)?{box:[ce,Se,ke,pe],placeable:!1,offscreen:!1}:{box:[ce,Se,ke,pe],placeable:!0,offscreen:this.isOffscreen(ce,Se,ke,pe)}}placeCollisionCircles(t,n,a,f,v,I,k,D,B,G,U,K,ie,oe,ve,ce){const Se=[],ke=new s.P(n.anchorX,n.anchorY),pe=this.getPerspectiveRatio(I,ke.x,ke.y,k,ce),Fe=(U?v/pe:v*pe)/s.ap,We={getElevation:ce,labelPlaneMatrix:D,lineVertexArray:a,pitchWithMap:U,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},projection:this.mapProjection,tileAnchorPoint:ke,unwrappedTileID:k,width:this.transform.width,height:this.transform.height,translation:ve},Ye=J(Fe,f,n.lineOffsetX*Fe,n.lineOffsetY*Fe,!1,n,!1,We);let mt=!1,Tt=!1,Ht=!0;if(Ye){const qt=.5*ie*pe+oe,Pt=new s.P(-100,-100),kt=new s.P(this.screenRightBoundary,this.screenBottomBoundary),Jt=new qi,Ti=Ye.first,zt=Ye.last;let Ut=[];for(let Ii=Ti.path.length-1;Ii>=1;Ii--)Ut.push(Ti.path[Ii]);for(let Ii=1;Ii<zt.path.length;Ii++)Ut.push(zt.path[Ii]);const yi=2.5*qt;if(B){const Ii=this.projectPathToScreenSpace(Ut,We,B);Ut=Ii.some(Di=>Di.signedDistanceFromCamera<=0)?[]:Ii.map(Di=>Di.point)}let pr=[];if(Ut.length>0){const Ii=Ut[0].clone(),Di=Ut[0].clone();for(let mr=1;mr<Ut.length;mr++)Ii.x=Math.min(Ii.x,Ut[mr].x),Ii.y=Math.min(Ii.y,Ut[mr].y),Di.x=Math.max(Di.x,Ut[mr].x),Di.y=Math.max(Di.y,Ut[mr].y);pr=Ii.x>=Pt.x&&Di.x<=kt.x&&Ii.y>=Pt.y&&Di.y<=kt.y?[Ut]:Di.x<Pt.x||Ii.x>kt.x||Di.y<Pt.y||Ii.y>kt.y?[]:s.al([Ut],Pt.x,Pt.y,kt.x,kt.y)}for(const Ii of pr){Jt.reset(Ii,.25*qt);let Di=0;Di=Jt.length<=.5*qt?1:Math.ceil(Jt.paddedLength/yi)+1;for(let mr=0;mr<Di;mr++){const nn=mr/Math.max(Di-1,1),es=Jt.lerp(nn),gr=es.x+ei,Tn=es.y+ei;Se.push(gr,Tn,qt,0);const _n=gr-qt,sn=Tn-qt,on=gr+qt,ts=Tn+qt;if(Ht=Ht&&this.isOffscreen(_n,sn,on,ts),Tt=Tt||this.isInsideGrid(_n,sn,on,ts),t!=="always"&&this.grid.hitTestCircle(gr,Tn,qt,t,K)&&(mt=!0,!G))return{circles:[],offscreen:!1,collisionDetected:mt}}}}return{circles:!G&&mt||!Tt||pe<this.perspectiveRatioCutoff?[]:Se,offscreen:Ht,collisionDetected:mt}}projectPathToScreenSpace(t,n,a){return t.map(f=>Ki(f,a,n.getElevation))}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const n=[];let a=1/0,f=1/0,v=-1/0,I=-1/0;for(const G of t){const U=new s.P(G.x+ei,G.y+ei);a=Math.min(a,U.x),f=Math.min(f,U.y),v=Math.max(v,U.x),I=Math.max(I,U.y),n.push(U)}const k=this.grid.query(a,f,v,I).concat(this.ignoredGrid.query(a,f,v,I)),D={},B={};for(const G of k){const U=G.key;if(D[U.bucketInstanceId]===void 0&&(D[U.bucketInstanceId]={}),D[U.bucketInstanceId][U.featureIndex])continue;const K=[new s.P(G.x1,G.y1),new s.P(G.x2,G.y1),new s.P(G.x2,G.y2),new s.P(G.x1,G.y2)];s.am(n,K)&&(D[U.bucketInstanceId][U.featureIndex]=!0,B[U.bucketInstanceId]===void 0&&(B[U.bucketInstanceId]=[]),B[U.bucketInstanceId].push(U.featureIndex))}return B}insertCollisionBox(t,n,a,f,v,I){(a?this.ignoredGrid:this.grid).insert({bucketInstanceId:f,featureIndex:v,collisionGroupID:I,overlapMode:n},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,n,a,f,v,I){const k=a?this.ignoredGrid:this.grid,D={bucketInstanceId:f,featureIndex:v,collisionGroupID:I,overlapMode:n};for(let B=0;B<t.length;B+=4)k.insertCircle(D,t[B],t[B+1],t[B+2])}projectAndGetPerspectiveRatio(t,n,a,f,v){const I=this.mapProjection.useSpecialProjectionForSymbols?this.mapProjection.projectTileCoordinates(n,a,f,v):Ki(new s.P(n,a),t,v);return{point:new s.P((I.point.x+1)/2*this.transform.width+ei,(1-I.point.y)/2*this.transform.height+ei),perspectiveRatio:.5+this.transform.cameraToCenterDistance/I.signedDistanceFromCamera*.5,isOccluded:I.isOccluded,signedDistanceFromCamera:I.signedDistanceFromCamera}}getPerspectiveRatio(t,n,a,f,v){const I=this.mapProjection.useSpecialProjectionForSymbols?this.mapProjection.projectTileCoordinates(n,a,f,v):Ki(new s.P(n,a),t,v);return .5+this.transform.cameraToCenterDistance/I.signedDistanceFromCamera*.5}isOffscreen(t,n,a,f){return a<ei||t>=this.screenRightBoundary||f<ei||n>this.screenBottomBoundary}isInsideGrid(t,n,a,f){return a>=0&&t<this.gridRightBoundary&&f>=0&&n<this.gridBottomBoundary}getViewportMatrix(){const t=s.an([]);return s.H(t,t,[-100,-100,0]),t}_projectCollisionBox(t,n,a,f,v,I,k,D,B,G){const U=n*D.perspectiveRatio;let K=new s.P(1,0),ie=new s.P(0,1);const oe=new s.P(t.anchorPointX+k[0],t.anchorPointY+k[1]);if(I&&!v){const qt=this.projectAndGetPerspectiveRatio(a,oe.x+1,oe.y,f,B).point.sub(D.point).unit(),Pt=Math.atan(qt.y/qt.x)+(qt.x<0?Math.PI:0),kt=Math.sin(Pt),Jt=Math.cos(Pt);K=new s.P(Jt,kt),ie=new s.P(-kt,Jt)}else if(!I&&v){const qt=-this.transform.angle,Pt=Math.sin(qt),kt=Math.cos(qt);K=new s.P(kt,Pt),ie=new s.P(-Pt,kt)}let ve=D.point,ce=U;if(v){ve=oe;const qt=this.transform.zoom-Math.floor(this.transform.zoom);ce=Math.pow(2,-qt),ce*=this.mapProjection.getPitchedTextCorrection(this.transform,oe,f),G||(ce*=s.ac(.5+D.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))}G&&(ve=ve.add(K.mult(G.x*ce)).add(ie.mult(G.y*ce)));const Se=t.x1*ce,ke=t.x2*ce,pe=(Se+ke)/2,Fe=t.y1*ce,We=t.y2*ce,Ye=(Fe+We)/2,mt=[{offsetX:Se,offsetY:Fe},{offsetX:pe,offsetY:Fe},{offsetX:ke,offsetY:Fe},{offsetX:ke,offsetY:Ye},{offsetX:ke,offsetY:We},{offsetX:pe,offsetY:We},{offsetX:Se,offsetY:We},{offsetX:Se,offsetY:Ye}];let Tt=[];for(const{offsetX:qt,offsetY:Pt}of mt)Tt.push(new s.P(ve.x+K.x*qt+ie.x*Pt,ve.y+K.y*qt+ie.y*Pt));let Ht=!1;if(v){const qt=Tt.map(Pt=>this.projectAndGetPerspectiveRatio(a,Pt.x,Pt.y,f,B));Ht=qt.some(Pt=>!Pt.isOccluded),Tt=qt.map(Pt=>Pt.point)}else Ht=!0;return{box:s.ao(Tt),allPointsOccluded:!Ht}}}function mi(y,t,n){return t*(s.W/(y.tileSize*Math.pow(2,n-y.tileID.overscaledZ)))}class Pi{constructor(t,n,a,f){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?n:-n))):f&&a?1:0,this.placed=a}isHidden(){return this.opacity===0&&!this.placed}}class Li{constructor(t,n,a,f,v){this.text=new Pi(t?t.text:null,n,a,v),this.icon=new Pi(t?t.icon:null,n,f,v)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class tr{constructor(t,n,a){this.text=t,this.icon=n,this.skipFade=a}}class Mr{constructor(){this.invProjMatrix=s.F(),this.viewportMatrix=s.F(),this.circles=[]}}class ui{constructor(t,n,a,f,v){this.bucketInstanceId=t,this.featureIndex=n,this.sourceLayerIndex=a,this.bucketIndex=f,this.tileID=v}}class dr{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const n=++this.maxGroupID;this.collisionGroups[t]={ID:n,predicate:a=>a.collisionGroupID===n}}return this.collisionGroups[t]}}function Lr(y,t,n,a,f){const{horizontalAlign:v,verticalAlign:I}=s.au(y);return new s.P(-(v-.5)*t+a[0]*f,-(I-.5)*n+a[1]*f)}class Qr{constructor(t,n,a,f,v,I){this.transform=t.clone(),this.terrain=a,this.collisionIndex=new xi(this.transform,n),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=f,this.retainedQueryData={},this.collisionGroups=new dr(v),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=I,I&&(I.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(t){const n=this.terrain;return n?(a,f)=>n.getElevation(t,a,f):null}getBucketParts(t,n,a,f){const v=a.getBucket(n),I=a.latestFeatureIndex;if(!v||!I||n.id!==v.layerIds[0])return;const k=a.collisionBoxArray,D=v.layers[0].layout,B=v.layers[0].paint,G=Math.pow(2,this.transform.zoom-a.tileID.overscaledZ),U=a.tileSize/s.W,K=a.tileID.toUnwrapped(),ie=this.transform.calculatePosMatrix(K),oe=D.get("text-pitch-alignment")==="map",ve=D.get("text-rotation-alignment")==="map",ce=mi(a,1,this.transform.zoom),Se=this.collisionIndex.mapProjection.translatePosition(this.transform,a,B.get("text-translate"),B.get("text-translate-anchor")),ke=this.collisionIndex.mapProjection.translatePosition(this.transform,a,B.get("icon-translate"),B.get("icon-translate-anchor")),pe=Oi(ie,oe,ve,this.transform,ce);let Fe=null;if(oe){const Ye=$i(ie,oe,ve,this.transform,ce);Fe=s.K([],this.transform.labelPlaneMatrix,Ye)}this.retainedQueryData[v.bucketInstanceId]=new ui(v.bucketInstanceId,I,v.sourceLayerIndex,v.index,a.tileID);const We={bucket:v,layout:D,translationText:Se,translationIcon:ke,posMatrix:ie,unwrappedTileID:K,textLabelPlaneMatrix:pe,labelToScreenMatrix:Fe,scale:G,textPixelRatio:U,holdingForFade:a.holdingForFade(),collisionBoxArray:k,partiallyEvaluatedTextSize:s.ag(v.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(v.sourceID)};if(f)for(const Ye of v.sortKeyRanges){const{sortKey:mt,symbolInstanceStart:Tt,symbolInstanceEnd:Ht}=Ye;t.push({sortKey:mt,symbolInstanceStart:Tt,symbolInstanceEnd:Ht,parameters:We})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:v.symbolInstances.length,parameters:We})}attemptAnchorPlacement(t,n,a,f,v,I,k,D,B,G,U,K,ie,oe,ve,ce,Se,ke,pe){const Fe=s.aq[t.textAnchor],We=[t.textOffset0,t.textOffset1],Ye=Lr(Fe,a,f,We,v),mt=this.collisionIndex.placeCollisionBox(n,K,D,B,G,k,I,ce,U.predicate,pe,Ye);if((!ke||this.collisionIndex.placeCollisionBox(ke,K,D,B,G,k,I,Se,U.predicate,pe,Ye).placeable)&&mt.placeable){let Tt;if(this.prevPlacement&&this.prevPlacement.variableOffsets[ie.crossTileID]&&this.prevPlacement.placements[ie.crossTileID]&&this.prevPlacement.placements[ie.crossTileID].text&&(Tt=this.prevPlacement.variableOffsets[ie.crossTileID].anchor),ie.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[ie.crossTileID]={textOffset:We,width:a,height:f,anchor:Fe,textBoxScale:v,prevAnchor:Tt},this.markUsedJustification(oe,Fe,ie,ve),oe.allowVerticalPlacement&&(this.markUsedOrientation(oe,ve,ie),this.placedOrientations[ie.crossTileID]=ve),{shift:Ye,placedGlyphBoxes:mt}}}placeLayerBucketPart(t,n,a){const{bucket:f,layout:v,translationText:I,translationIcon:k,posMatrix:D,unwrappedTileID:B,textLabelPlaneMatrix:G,labelToScreenMatrix:U,textPixelRatio:K,holdingForFade:ie,collisionBoxArray:oe,partiallyEvaluatedTextSize:ve,collisionGroup:ce}=t.parameters,Se=v.get("text-optional"),ke=v.get("icon-optional"),pe=s.ar(v,"text-overlap","text-allow-overlap"),Fe=pe==="always",We=s.ar(v,"icon-overlap","icon-allow-overlap"),Ye=We==="always",mt=v.get("text-rotation-alignment")==="map",Tt=v.get("text-pitch-alignment")==="map",Ht=v.get("icon-text-fit")!=="none",qt=v.get("symbol-z-order")==="viewport-y",Pt=Fe&&(Ye||!f.hasIconData()||ke),kt=Ye&&(Fe||!f.hasTextData()||Se);!f.collisionArrays&&oe&&f.deserializeCollisionBoxes(oe);const Jt=this._getTerrainElevationFunc(this.retainedQueryData[f.bucketInstanceId].tileID),Ti=(zt,Ut,yi)=>{var pr,Ii;if(n[zt.crossTileID])return;if(ie)return void(this.placements[zt.crossTileID]=new tr(!1,!1,!1));let Di=!1,mr=!1,nn=!0,es=null,gr={box:null,placeable:!1,offscreen:null},Tn={box:null,placeable:!1,offscreen:null},_n=null,sn=null,on=null,ts=0,Mo=0,rl=0;Ut.textFeatureIndex?ts=Ut.textFeatureIndex:zt.useRuntimeCollisionCircles&&(ts=zt.featureIndex),Ut.verticalTextFeatureIndex&&(Mo=Ut.verticalTextFeatureIndex);const Jo=Ut.textBox;if(Jo){const Kr=an=>{let ln=s.ah.horizontal;if(f.allowVerticalPlacement&&!an&&this.prevPlacement){const Gr=this.prevPlacement.placedOrientations[zt.crossTileID];Gr&&(this.placedOrientations[zt.crossTileID]=Gr,ln=Gr,this.markUsedOrientation(f,ln,zt))}return ln},is=(an,ln)=>{if(f.allowVerticalPlacement&&zt.numVerticalGlyphVertices>0&&Ut.verticalTextBox){for(const Gr of f.writingModes)if(Gr===s.ah.vertical?(gr=ln(),Tn=gr):gr=an(),gr&&gr.placeable)break}else gr=an()},ro=zt.textAnchorOffsetStartIndex,Qo=zt.textAnchorOffsetEndIndex;if(Qo===ro){const an=(ln,Gr)=>{const br=this.collisionIndex.placeCollisionBox(ln,pe,K,D,B,Tt,mt,I,ce.predicate,Jt);return br&&br.placeable&&(this.markUsedOrientation(f,Gr,zt),this.placedOrientations[zt.crossTileID]=Gr),br};is(()=>an(Jo,s.ah.horizontal),()=>{const ln=Ut.verticalTextBox;return f.allowVerticalPlacement&&zt.numVerticalGlyphVertices>0&&ln?an(ln,s.ah.vertical):{box:null,offscreen:null}}),Kr(gr&&gr.placeable)}else{let an=s.aq[(Ii=(pr=this.prevPlacement)===null||pr===void 0?void 0:pr.variableOffsets[zt.crossTileID])===null||Ii===void 0?void 0:Ii.anchor];const ln=(br,ea,Gl)=>{const Vr=br.x2-br.x1,Tc=br.y2-br.y1,sl=zt.textBoxScale,ol=Ht&&We==="never"?ea:null;let no=null,Ec=pe==="never"?1:2,Wl="never";an&&Ec++;for(let Hl=0;Hl<Ec;Hl++){for(let Xl=ro;Xl<Qo;Xl++){const al=f.textAnchorOffsets.get(Xl);if(an&&al.textAnchor!==an)continue;const ta=this.attemptAnchorPlacement(al,br,Vr,Tc,sl,mt,Tt,K,D,B,ce,Wl,zt,f,Gl,I,k,ol,Jt);if(ta&&(no=ta.placedGlyphBoxes,no&&no.placeable))return Di=!0,es=ta.shift,no}an?an=null:Wl=pe}return a&&!no&&(no={box:this.collisionIndex.placeCollisionBox(Jo,"always",K,D,B,Tt,mt,I,ce.predicate,Jt,new s.P(0,0)).box,offscreen:!1,placeable:!1}),no};is(()=>ln(Jo,Ut.iconBox,s.ah.horizontal),()=>{const br=Ut.verticalTextBox;return f.allowVerticalPlacement&&(!gr||!gr.placeable)&&zt.numVerticalGlyphVertices>0&&br?ln(br,Ut.verticalIconBox,s.ah.vertical):{box:null,occluded:!0,offscreen:null}}),gr&&(Di=gr.placeable,nn=gr.offscreen);const Gr=Kr(gr&&gr.placeable);if(!Di&&this.prevPlacement){const br=this.prevPlacement.variableOffsets[zt.crossTileID];br&&(this.variableOffsets[zt.crossTileID]=br,this.markUsedJustification(f,br.anchor,zt,Gr))}}}if(_n=gr,Di=_n&&_n.placeable,nn=_n&&_n.offscreen,zt.useRuntimeCollisionCircles){const Kr=f.text.placedSymbolArray.get(zt.centerJustifiedTextSymbolIndex),is=s.ai(f.textSizeData,ve,Kr),ro=v.get("text-padding");sn=this.collisionIndex.placeCollisionCircles(pe,Kr,f.lineVertexArray,f.glyphOffsetArray,is,D,B,G,U,a,Tt,ce.predicate,zt.collisionCircleDiameter,ro,I,Jt),sn.circles.length&&sn.collisionDetected&&!a&&s.w("Collisions detected, but collision boxes are not shown"),Di=Fe||sn.circles.length>0&&!sn.collisionDetected,nn=nn&&sn.offscreen}if(Ut.iconFeatureIndex&&(rl=Ut.iconFeatureIndex),Ut.iconBox){const Kr=is=>this.collisionIndex.placeCollisionBox(is,We,K,D,B,Tt,mt,k,ce.predicate,Jt,Ht&&es?es:void 0);Tn&&Tn.placeable&&Ut.verticalIconBox?(on=Kr(Ut.verticalIconBox),mr=on.placeable):(on=Kr(Ut.iconBox),mr=on.placeable),nn=nn&&on.offscreen}const ko=Se||zt.numHorizontalGlyphVertices===0&&zt.numVerticalGlyphVertices===0,nl=ke||zt.numIconVertices===0;ko||nl?nl?ko||(mr=mr&&Di):Di=mr&&Di:mr=Di=mr&&Di;const Ul=mr&&on.placeable;if(Di&&_n.placeable&&this.collisionIndex.insertCollisionBox(_n.box,pe,v.get("text-ignore-placement"),f.bucketInstanceId,Tn&&Tn.placeable&&Mo?Mo:ts,ce.ID),Ul&&this.collisionIndex.insertCollisionBox(on.box,We,v.get("icon-ignore-placement"),f.bucketInstanceId,rl,ce.ID),sn&&Di&&this.collisionIndex.insertCollisionCircles(sn.circles,pe,v.get("text-ignore-placement"),f.bucketInstanceId,ts,ce.ID),a&&this.storeCollisionData(f.bucketInstanceId,yi,Ut,_n,on,sn),zt.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(f.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[zt.crossTileID]=new tr(Di||Pt,mr||kt,nn||f.justReloaded),n[zt.crossTileID]=!0};if(qt){if(t.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const zt=f.getSortedSymbolIndexes(this.transform.angle);for(let Ut=zt.length-1;Ut>=0;--Ut){const yi=zt[Ut];Ti(f.symbolInstances.get(yi),f.collisionArrays[yi],yi)}}else for(let zt=t.symbolInstanceStart;zt<t.symbolInstanceEnd;zt++)Ti(f.symbolInstances.get(zt),f.collisionArrays[zt],zt);if(a&&f.bucketInstanceId in this.collisionCircleArrays){const zt=this.collisionCircleArrays[f.bucketInstanceId];s.as(zt.invProjMatrix,D),zt.viewportMatrix=this.collisionIndex.getViewportMatrix()}f.justReloaded=!1}storeCollisionData(t,n,a,f,v,I){if(a.textBox||a.iconBox){let k,D;this.collisionBoxArrays.has(t)?k=this.collisionBoxArrays.get(t):(k=new Map,this.collisionBoxArrays.set(t,k)),k.has(n)?D=k.get(n):(D={text:null,icon:null},k.set(n,D)),a.textBox&&(D.text=f.box),a.iconBox&&(D.icon=v.box)}if(I){let k=this.collisionCircleArrays[t];k===void 0&&(k=this.collisionCircleArrays[t]=new Mr);for(let D=0;D<I.circles.length;D+=4)k.circles.push(I.circles[D+0]),k.circles.push(I.circles[D+1]),k.circles.push(I.circles[D+2]),k.circles.push(I.collisionDetected?1:0)}}markUsedJustification(t,n,a,f){let v;v=f===s.ah.vertical?a.verticalPlacedTextSymbolIndex:{left:a.leftJustifiedTextSymbolIndex,center:a.centerJustifiedTextSymbolIndex,right:a.rightJustifiedTextSymbolIndex}[s.at(n)];const I=[a.leftJustifiedTextSymbolIndex,a.centerJustifiedTextSymbolIndex,a.rightJustifiedTextSymbolIndex,a.verticalPlacedTextSymbolIndex];for(const k of I)k>=0&&(t.text.placedSymbolArray.get(k).crossTileID=v>=0&&k!==v?0:a.crossTileID)}markUsedOrientation(t,n,a){const f=n===s.ah.horizontal||n===s.ah.horizontalOnly?n:0,v=n===s.ah.vertical?n:0,I=[a.leftJustifiedTextSymbolIndex,a.centerJustifiedTextSymbolIndex,a.rightJustifiedTextSymbolIndex];for(const k of I)t.text.placedSymbolArray.get(k).placedOrientation=f;a.verticalPlacedTextSymbolIndex&&(t.text.placedSymbolArray.get(a.verticalPlacedTextSymbolIndex).placedOrientation=v)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const n=this.prevPlacement;let a=!1;this.prevZoomAdjustment=n?n.zoomAdjustment(this.transform.zoom):0;const f=n?n.symbolFadeChange(t):1,v=n?n.opacities:{},I=n?n.variableOffsets:{},k=n?n.placedOrientations:{};for(const D in this.placements){const B=this.placements[D],G=v[D];G?(this.opacities[D]=new Li(G,f,B.text,B.icon),a=a||B.text!==G.text.placed||B.icon!==G.icon.placed):(this.opacities[D]=new Li(null,f,B.text,B.icon,B.skipFade),a=a||B.text||B.icon)}for(const D in v){const B=v[D];if(!this.opacities[D]){const G=new Li(B,f,!1,!1);G.isHidden()||(this.opacities[D]=G,a=a||B.text.placed||B.icon.placed)}}for(const D in I)this.variableOffsets[D]||!this.opacities[D]||this.opacities[D].isHidden()||(this.variableOffsets[D]=I[D]);for(const D in k)this.placedOrientations[D]||!this.opacities[D]||this.opacities[D].isHidden()||(this.placedOrientations[D]=k[D]);if(n&&n.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");a?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=n?n.lastPlacementChangeTime:t)}updateLayerOpacities(t,n){const a={};for(const f of n){const v=f.getBucket(t);v&&f.latestFeatureIndex&&t.id===v.layerIds[0]&&this.updateBucketOpacities(v,f.tileID,a,f.collisionBoxArray)}}updateBucketOpacities(t,n,a,f){t.hasTextData()&&(t.text.opacityVertexArray.clear(),t.text.hasVisibleVertices=!1),t.hasIconData()&&(t.icon.opacityVertexArray.clear(),t.icon.hasVisibleVertices=!1),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const v=t.layers[0],I=v.layout,k=new Li(null,0,!1,!1,!0),D=I.get("text-allow-overlap"),B=I.get("icon-allow-overlap"),G=v._unevaluatedLayout.hasValue("text-variable-anchor")||v._unevaluatedLayout.hasValue("text-variable-anchor-offset"),U=I.get("text-rotation-alignment")==="map",K=I.get("text-pitch-alignment")==="map",ie=I.get("icon-text-fit")!=="none",oe=new Li(null,0,D&&(B||!t.hasIconData()||I.get("icon-optional")),B&&(D||!t.hasTextData()||I.get("text-optional")),!0);!t.collisionArrays&&f&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(f);const ve=(Se,ke,pe)=>{for(let Fe=0;Fe<ke/4;Fe++)Se.opacityVertexArray.emplaceBack(pe);Se.hasVisibleVertices=Se.hasVisibleVertices||pe!==Ls},ce=this.collisionBoxArrays.get(t.bucketInstanceId);for(let Se=0;Se<t.symbolInstances.length;Se++){const ke=t.symbolInstances.get(Se),{numHorizontalGlyphVertices:pe,numVerticalGlyphVertices:Fe,crossTileID:We}=ke;let Ye=this.opacities[We];a[We]?Ye=k:Ye||(Ye=oe,this.opacities[We]=Ye),a[We]=!0;const mt=ke.numIconVertices>0,Tt=this.placedOrientations[ke.crossTileID],Ht=Tt===s.ah.vertical,qt=Tt===s.ah.horizontal||Tt===s.ah.horizontalOnly;if(pe>0||Fe>0){const kt=qr(Ye.text);ve(t.text,pe,Ht?Ls:kt),ve(t.text,Fe,qt?Ls:kt);const Jt=Ye.text.isHidden();[ke.rightJustifiedTextSymbolIndex,ke.centerJustifiedTextSymbolIndex,ke.leftJustifiedTextSymbolIndex].forEach(Ut=>{Ut>=0&&(t.text.placedSymbolArray.get(Ut).hidden=Jt||Ht?1:0)}),ke.verticalPlacedTextSymbolIndex>=0&&(t.text.placedSymbolArray.get(ke.verticalPlacedTextSymbolIndex).hidden=Jt||qt?1:0);const Ti=this.variableOffsets[ke.crossTileID];Ti&&this.markUsedJustification(t,Ti.anchor,ke,Tt);const zt=this.placedOrientations[ke.crossTileID];zt&&(this.markUsedJustification(t,"left",ke,zt),this.markUsedOrientation(t,zt,ke))}if(mt){const kt=qr(Ye.icon),Jt=!(ie&&ke.verticalPlacedIconSymbolIndex&&Ht);ke.placedIconSymbolIndex>=0&&(ve(t.icon,ke.numIconVertices,Jt?kt:Ls),t.icon.placedSymbolArray.get(ke.placedIconSymbolIndex).hidden=Ye.icon.isHidden()),ke.verticalPlacedIconSymbolIndex>=0&&(ve(t.icon,ke.numVerticalIconVertices,Jt?Ls:kt),t.icon.placedSymbolArray.get(ke.verticalPlacedIconSymbolIndex).hidden=Ye.icon.isHidden())}const Pt=ce&&ce.has(Se)?ce.get(Se):{text:null,icon:null};if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const kt=t.collisionArrays[Se];if(kt){let Jt=new s.P(0,0);if(kt.textBox||kt.verticalTextBox){let Ti=!0;if(G){const zt=this.variableOffsets[We];zt?(Jt=Lr(zt.anchor,zt.width,zt.height,zt.textOffset,zt.textBoxScale),U&&Jt._rotate(K?this.transform.angle:-this.transform.angle)):Ti=!1}if(kt.textBox||kt.verticalTextBox){let zt;kt.textBox&&(zt=Ht),kt.verticalTextBox&&(zt=qt),en(t.textCollisionBox.collisionVertexArray,Ye.text.placed,!Ti||zt,Pt.text,Jt.x,Jt.y)}}if(kt.iconBox||kt.verticalIconBox){const Ti=!!(!qt&&kt.verticalIconBox);let zt;kt.iconBox&&(zt=Ti),kt.verticalIconBox&&(zt=!Ti),en(t.iconCollisionBox.collisionVertexArray,Ye.icon.placed,zt,Pt.icon,ie?Jt.x:0,ie?Jt.y:0)}}}}if(t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.text.opacityVertexArray.length!==t.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${t.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${t.text.layoutVertexArray.length}) / 4`);if(t.icon.opacityVertexArray.length!==t.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${t.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${t.icon.layoutVertexArray.length}) / 4`);if(t.bucketInstanceId in this.collisionCircleArrays){const Se=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=Se.invProjMatrix,t.placementViewportMatrix=Se.viewportMatrix,t.collisionCircleArray=Se.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,n){const a=this.zoomAtLastRecencyCheck===n?1-this.zoomAdjustment(n):1;return this.zoomAtLastRecencyCheck=n,this.commitTime+this.fadeDuration*a>t}setStale(){this.stale=!0}}function en(y,t,n,a,f,v){a&&a.length!==0||(a=[0,0,0,0]);const I=a[0]-ei,k=a[1]-ei,D=a[2]-ei,B=a[3]-ei;y.emplaceBack(t?1:0,n?1:0,f||0,v||0,I,k),y.emplaceBack(t?1:0,n?1:0,f||0,v||0,D,k),y.emplaceBack(t?1:0,n?1:0,f||0,v||0,D,B),y.emplaceBack(t?1:0,n?1:0,f||0,v||0,I,B)}const Fr=Math.pow(2,25),hs=Math.pow(2,24),Tl=Math.pow(2,17),zi=Math.pow(2,16),po=Math.pow(2,9),mo=Math.pow(2,8),Wi=Math.pow(2,1);function qr(y){if(y.opacity===0&&!y.placed)return 0;if(y.opacity===1&&y.placed)return 4294967295;const t=y.placed?1:0,n=Math.floor(127*y.opacity);return n*Fr+t*hs+n*Tl+t*zi+n*po+t*mo+n*Wi+t}const Ls=0;function Cr(){return{isOccluded:(y,t,n)=>!1,getPitchedTextCorrection:(y,t,n)=>1,get useSpecialProjectionForSymbols(){return!1},projectTileCoordinates(y,t,n,a){throw new Error("Not implemented.")},translatePosition:(y,t,n,a)=>function(f,v,I,k,D=!1){if(!I[0]&&!I[1])return[0,0];const B=D?k==="map"?f.angle:0:k==="viewport"?-f.angle:0;if(B){const G=Math.sin(B),U=Math.cos(B);I=[I[0]*U-I[1]*G,I[0]*G+I[1]*U]}return[D?I[0]:mi(v,I[0],f.zoom),D?I[1]:mi(v,I[1],f.zoom)]}(y,t,n,a),getCircleRadiusCorrection:y=>1}}class Sr{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&!t.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(t,n,a,f,v){const I=this._bucketParts;for(;this._currentTileIndex<t.length;)if(n.getBucketParts(I,f,t[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,v())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,I.sort((k,D)=>k.sortKey-D.sortKey));this._currentPartIndex<I.length;)if(n.placeLayerBucketPart(I[this._currentPartIndex],this._seenCrossTileIDs,a),this._currentPartIndex++,v())return!0;return!1}}class go{constructor(t,n,a,f,v,I,k,D){this.placement=new Qr(t,Cr(),n,I,k,D),this._currentPlacementIndex=a.length-1,this._forceFullPlacement=f,this._showCollisionBoxes=v,this._done=!1}isDone(){return this._done}continuePlacement(t,n,a){const f=l.now(),v=()=>!this._forceFullPlacement&&l.now()-f>2;for(;this._currentPlacementIndex>=0;){const I=n[t[this._currentPlacementIndex]],k=this.placement.collisionIndex.transform.zoom;if(I.type==="symbol"&&(!I.minzoom||I.minzoom<=k)&&(!I.maxzoom||I.maxzoom>k)){if(this._inProgressLayer||(this._inProgressLayer=new Sr(I)),this._inProgressLayer.continuePlacement(a[I.source],this.placement,this._showCollisionBoxes,I,v))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const $r=512/s.W/2;class ir{constructor(t,n,a){this.tileID=t,this.bucketInstanceId=a,this._symbolsByKey={};const f=new Map;for(let v=0;v<n.length;v++){const I=n.get(v),k=I.key,D=f.get(k);D?D.push(I):f.set(k,[I])}for(const[v,I]of f){const k={positions:I.map(D=>({x:Math.floor(D.anchorX*$r),y:Math.floor(D.anchorY*$r)})),crossTileIDs:I.map(D=>D.crossTileID)};if(k.positions.length>128){const D=new s.av(k.positions.length,16,Uint16Array);for(const{x:B,y:G}of k.positions)D.add(B,G);D.finish(),delete k.positions,k.index=D}this._symbolsByKey[v]=k}}getScaledCoordinates(t,n){const{x:a,y:f,z:v}=this.tileID.canonical,{x:I,y:k,z:D}=n.canonical,B=$r/Math.pow(2,D-v),G=(k*s.W+t.anchorY)*B,U=f*s.W*$r;return{x:Math.floor((I*s.W+t.anchorX)*B-a*s.W*$r),y:Math.floor(G-U)}}findMatches(t,n,a){const f=this.tileID.canonical.z<n.canonical.z?1:Math.pow(2,this.tileID.canonical.z-n.canonical.z);for(let v=0;v<t.length;v++){const I=t.get(v);if(I.crossTileID)continue;const k=this._symbolsByKey[I.key];if(!k)continue;const D=this.getScaledCoordinates(I,n);if(k.index){const B=k.index.range(D.x-f,D.y-f,D.x+f,D.y+f).sort();for(const G of B){const U=k.crossTileIDs[G];if(!a[U]){a[U]=!0,I.crossTileID=U;break}}}else if(k.positions)for(let B=0;B<k.positions.length;B++){const G=k.positions[B],U=k.crossTileIDs[B];if(Math.abs(G.x-D.x)<=f&&Math.abs(G.y-D.y)<=f&&!a[U]){a[U]=!0,I.crossTileID=U;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map(({crossTileIDs:t})=>t)}}class Fs{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class ws{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const n=Math.round((t-this.lng)/360);if(n!==0)for(const a in this.indexes){const f=this.indexes[a],v={};for(const I in f){const k=f[I];k.tileID=k.tileID.unwrapTo(k.tileID.wrap+n),v[k.tileID.key]=k}this.indexes[a]=v}this.lng=t}addBucket(t,n,a){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===n.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let v=0;v<n.symbolInstances.length;v++)n.symbolInstances.get(v).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]={});const f=this.usedCrossTileIDs[t.overscaledZ];for(const v in this.indexes){const I=this.indexes[v];if(Number(v)>t.overscaledZ)for(const k in I){const D=I[k];D.tileID.isChildOf(t)&&D.findMatches(n.symbolInstances,t,f)}else{const k=I[t.scaledTo(Number(v)).key];k&&k.findMatches(n.symbolInstances,t,f)}}for(let v=0;v<n.symbolInstances.length;v++){const I=n.symbolInstances.get(v);I.crossTileID||(I.crossTileID=a.generate(),f[I.crossTileID]=!0)}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new ir(t,n.symbolInstances,n.bucketInstanceId),!0}removeBucketCrossTileIDs(t,n){for(const a of n.getCrossTileIDsLists())for(const f of a)delete this.usedCrossTileIDs[t][f]}removeStaleBuckets(t){let n=!1;for(const a in this.indexes){const f=this.indexes[a];for(const v in f)t[f[v].bucketInstanceId]||(this.removeBucketCrossTileIDs(a,f[v]),delete f[v],n=!0)}return n}}class vr{constructor(){this.layerIndexes={},this.crossTileIDs=new Fs,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,n,a){let f=this.layerIndexes[t.id];f===void 0&&(f=this.layerIndexes[t.id]=new ws);let v=!1;const I={};f.handleWrapJump(a);for(const k of n){const D=k.getBucket(t);D&&t.id===D.layerIds[0]&&(D.bucketInstanceId||(D.bucketInstanceId=++this.maxBucketInstanceId),f.addBucket(k.tileID,D,this.crossTileIDs)&&(v=!0),I[D.bucketInstanceId]=!0)}return f.removeStaleBuckets(I)&&(v=!0),v}pruneUnusedLayers(t){const n={};t.forEach(a=>{n[a]=!0});for(const a in this.layerIndexes)n[a]||delete this.layerIndexes[a]}}const Cs=(y,t)=>s.t(y,t&&t.filter(n=>n.identifier!=="source.canvas")),wn=s.aw();class zs extends s.E{constructor(t,n={}){super(),this._rtlPluginLoaded=()=>{for(const a in this.sourceCaches){const f=this.sourceCaches[a].getSource().type;f!=="vector"&&f!=="geojson"||this.sourceCaches[a].reload()}},this.map=t,this.dispatcher=new it(Ue(),t._getMapId()),this.dispatcher.registerMessageHandler("GG",(a,f)=>this.getGlyphs(a,f)),this.dispatcher.registerMessageHandler("GI",(a,f)=>this.getImages(a,f)),this.imageManager=new ht,this.imageManager.setEventedParent(this),this.glyphManager=new ot(t._requestManager,n.localIdeographFontFamily),this.lineAtlas=new me(256,512),this.crossTileSymbolIndex=new vr,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new s.ax,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("SR",s.ay()),Ei().on(vi,this._rtlPluginLoaded),this.on("data",a=>{if(a.dataType!=="source"||a.sourceDataType!=="metadata")return;const f=this.sourceCaches[a.sourceId];if(!f)return;const v=f.getSource();if(v&&v.vectorLayerIds)for(const I in this._layers){const k=this._layers[I];k.source===v.id&&this._validateLayer(k)}})}loadURL(t,n={},a){this.fire(new s.k("dataloading",{dataType:"style"})),n.validate=typeof n.validate!="boolean"||n.validate;const f=this.map._requestManager.transformRequest(t,"Style");this._loadStyleRequest=new AbortController,s.h(f,this._loadStyleRequest).then(v=>{this._loadStyleRequest=null,this._load(v.data,n,a)}).catch(v=>{this._loadStyleRequest=null,v&&this.fire(new s.j(v))})}loadJSON(t,n={},a){this.fire(new s.k("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,l.frameAsync(this._frameRequest).then(()=>{this._frameRequest=null,n.validate=n.validate!==!1,this._load(t,n,a)}).catch(()=>{})}loadEmpty(){this.fire(new s.k("dataloading",{dataType:"style"})),this._load(wn,{validate:!1})}_load(t,n,a){var f;const v=n.transformStyle?n.transformStyle(a,t):t;if(!n.validate||!Cs(this,s.x(v))){this._loaded=!0,this.stylesheet=v;for(const I in v.sources)this.addSource(I,v.sources[I],{validate:!1});v.sprite?this._loadSprite(v.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(v.glyphs),this._createLayers(),this.light=new be(this.stylesheet.light),this.map.setTerrain((f=this.stylesheet.terrain)!==null&&f!==void 0?f:null),this.fire(new s.k("data",{dataType:"style"})),this.fire(new s.k("style.load"))}}_createLayers(){const t=s.az(this.stylesheet.layers);this.dispatcher.broadcast("SL",t),this._order=t.map(n=>n.id),this._layers={},this._serializedLayers=null;for(const n of t){const a=s.aA(n);a.setEventedParent(this,{layer:{id:n.id}}),this._layers[n.id]=a}}_loadSprite(t,n=!1,a=void 0){let f;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,function(v,I,k,D){return s._(this,void 0,void 0,function*(){const B=ze(v),G=k>1?"@2x":"",U={},K={};for(const{id:ie,url:oe}of B){const ve=I.transformRequest(Ke(oe,G,".json"),"SpriteJSON");U[ie]=s.h(ve,D);const ce=I.transformRequest(Ke(oe,G,".png"),"SpriteImage");K[ie]=O.getImage(ce,D)}return yield Promise.all([...Object.values(U),...Object.values(K)]),function(ie,oe){return s._(this,void 0,void 0,function*(){const ve={};for(const ce in ie){ve[ce]={};const Se=l.getImageCanvasContext((yield oe[ce]).data),ke=(yield ie[ce]).data;for(const pe in ke){const{width:Fe,height:We,x:Ye,y:mt,sdf:Tt,pixelRatio:Ht,stretchX:qt,stretchY:Pt,content:kt,textFitWidth:Jt,textFitHeight:Ti}=ke[pe];ve[ce][pe]={data:null,pixelRatio:Ht,sdf:Tt,stretchX:qt,stretchY:Pt,content:kt,textFitWidth:Jt,textFitHeight:Ti,spriteData:{width:Fe,height:We,x:Ye,y:mt,context:Se}}}}return ve})}(U,K)})}(t,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then(v=>{if(this._spriteRequest=null,v)for(const I in v){this._spritesImagesIds[I]=[];const k=this._spritesImagesIds[I]?this._spritesImagesIds[I].filter(D=>!(D in v)):[];for(const D of k)this.imageManager.removeImage(D),this._changedImages[D]=!0;for(const D in v[I]){const B=I==="default"?D:`${I}:${D}`;this._spritesImagesIds[I].push(B),B in this.imageManager.images?this.imageManager.updateImage(B,v[I][D],!1):this.imageManager.addImage(B,v[I][D]),n&&(this._changedImages[B]=!0)}}}).catch(v=>{this._spriteRequest=null,f=v,this.fire(new s.j(f))}).finally(()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),n&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.k("data",{dataType:"style"})),a&&a(f)})}_unloadSprite(){for(const t of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(t),this._changedImages[t]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.k("data",{dataType:"style"}))}_validateLayer(t){const n=this.sourceCaches[t.source];if(!n)return;const a=t.sourceLayer;if(!a)return;const f=n.getSource();(f.type==="geojson"||f.vectorLayerIds&&f.vectorLayerIds.indexOf(a)===-1)&&this.fire(new s.j(new Error(`Source layer "${a}" does not exist on source "${f.id}" as specified by style layer "${t.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const t in this.sourceCaches)if(!this.sourceCaches[t].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(t){const n=this._serializedAllLayers();if(!t||t.length===0)return Object.values(n);const a=[];for(const f of t)n[f]&&a.push(n[f]);return a}_serializedAllLayers(){let t=this._serializedLayers;if(t)return t;t=this._serializedLayers={};const n=Object.keys(this._layers);for(const a of n){const f=this._layers[a];f.type!=="custom"&&(t[a]=f.serialize())}return t}hasTransitions(){if(this.light&&this.light.hasTransition())return!0;for(const t in this.sourceCaches)if(this.sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(t){if(!this._loaded)return;const n=this._changed;if(n){const f=Object.keys(this._updatedLayers),v=Object.keys(this._removedLayers);(f.length||v.length)&&this._updateWorkerLayers(f,v);for(const I in this._updatedSources){const k=this._updatedSources[I];if(k==="reload")this._reloadSource(I);else{if(k!=="clear")throw new Error(`Invalid action ${k}`);this._clearSource(I)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const I in this._updatedPaintProps)this._layers[I].updateTransitions(t);this.light.updateTransitions(t),this._resetUpdates()}const a={};for(const f in this.sourceCaches){const v=this.sourceCaches[f];a[f]=v.used,v.used=!1}for(const f of this._order){const v=this._layers[f];v.recalculate(t,this._availableImages),!v.isHidden(t.zoom)&&v.source&&(this.sourceCaches[v.source].used=!0)}for(const f in a){const v=this.sourceCaches[f];!!a[f]!=!!v.used&&v.fire(new s.k("data",{sourceDataType:"visibility",dataType:"source",sourceId:f}))}this.light.recalculate(t),this.z=t.zoom,n&&this.fire(new s.k("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=Object.keys(this._changedImages);if(t.length){for(const n in this.sourceCaches)this.sourceCaches[n].reloadTilesForDependencies(["icons","patterns"],t);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const t in this.sourceCaches)this.sourceCaches[t].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(t,n){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(t),removedIds:n})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(t,n={}){var a;this._checkLoaded();const f=this.serialize();if(t=n.transformStyle?n.transformStyle(f,t):t,((a=n.validate)===null||a===void 0||a)&&Cs(this,s.x(t)))return!1;(t=s.aB(t)).layers=s.az(t.layers);const v=s.aC(f,t),I=this._getOperationsToPerform(v);if(I.unimplemented.length>0)throw new Error(`Unimplemented: ${I.unimplemented.join(", ")}.`);if(I.operations.length===0)return!1;for(const k of I.operations)k();return this.stylesheet=t,this._serializedLayers=null,!0}_getOperationsToPerform(t){const n=[],a=[];for(const f of t)switch(f.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":continue;case"addLayer":n.push(()=>this.addLayer.apply(this,f.args));break;case"removeLayer":n.push(()=>this.removeLayer.apply(this,f.args));break;case"setPaintProperty":n.push(()=>this.setPaintProperty.apply(this,f.args));break;case"setLayoutProperty":n.push(()=>this.setLayoutProperty.apply(this,f.args));break;case"setFilter":n.push(()=>this.setFilter.apply(this,f.args));break;case"addSource":n.push(()=>this.addSource.apply(this,f.args));break;case"removeSource":n.push(()=>this.removeSource.apply(this,f.args));break;case"setLayerZoomRange":n.push(()=>this.setLayerZoomRange.apply(this,f.args));break;case"setLight":n.push(()=>this.setLight.apply(this,f.args));break;case"setGeoJSONSourceData":n.push(()=>this.setGeoJSONSourceData.apply(this,f.args));break;case"setGlyphs":n.push(()=>this.setGlyphs.apply(this,f.args));break;case"setSprite":n.push(()=>this.setSprite.apply(this,f.args));break;case"setTerrain":n.push(()=>this.map.setTerrain.apply(this,f.args));break;case"setTransition":n.push(()=>{});break;default:a.push(f.command)}return{operations:n,unimplemented:a}}addImage(t,n){if(this.getImage(t))return this.fire(new s.j(new Error(`An image named "${t}" already exists.`)));this.imageManager.addImage(t,n),this._afterImageUpdated(t)}updateImage(t,n){this.imageManager.updateImage(t,n)}getImage(t){return this.imageManager.getImage(t)}removeImage(t){if(!this.getImage(t))return this.fire(new s.j(new Error(`An image named "${t}" does not exist.`)));this.imageManager.removeImage(t),this._afterImageUpdated(t)}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(),this._changedImages[t]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.k("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(t,n,a={}){if(this._checkLoaded(),this.sourceCaches[t]!==void 0)throw new Error(`Source "${t}" already exists.`);if(!n.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(n).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(n.type)>=0&&this._validate(s.x.source,`sources.${t}`,n,null,a))return;this.map&&this.map._collectResourceTiming&&(n.collectResourceTiming=!0);const f=this.sourceCaches[t]=new Ct(t,n,this.dispatcher);f.style=this,f.setEventedParent(this,()=>({isSourceLoaded:f.loaded(),source:f.serialize(),sourceId:t})),f.onAdd(this.map),this._changed=!0}removeSource(t){if(this._checkLoaded(),this.sourceCaches[t]===void 0)throw new Error("There is no source with this ID");for(const a in this._layers)if(this._layers[a].source===t)return this.fire(new s.j(new Error(`Source "${t}" cannot be removed while layer "${a}" is using it.`)));const n=this.sourceCaches[t];delete this.sourceCaches[t],delete this._updatedSources[t],n.fire(new s.k("data",{sourceDataType:"metadata",dataType:"source",sourceId:t})),n.setEventedParent(null),n.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(t,n){if(this._checkLoaded(),this.sourceCaches[t]===void 0)throw new Error(`There is no source with this ID=${t}`);const a=this.sourceCaches[t].getSource();if(a.type!=="geojson")throw new Error(`geojsonSource.type is ${a.type}, which is !== 'geojson`);a.setData(n),this._changed=!0}getSource(t){return this.sourceCaches[t]&&this.sourceCaches[t].getSource()}addLayer(t,n,a={}){this._checkLoaded();const f=t.id;if(this.getLayer(f))return void this.fire(new s.j(new Error(`Layer "${f}" already exists on this map.`)));let v;if(t.type==="custom"){if(Cs(this,s.aD(t)))return;v=s.aA(t)}else{if("source"in t&&typeof t.source=="object"&&(this.addSource(f,t.source),t=s.aB(t),t=s.e(t,{source:f})),this._validate(s.x.layer,`layers.${f}`,t,{arrayIndex:-1},a))return;v=s.aA(t),this._validateLayer(v),v.setEventedParent(this,{layer:{id:f}})}const I=n?this._order.indexOf(n):this._order.length;if(n&&I===-1)this.fire(new s.j(new Error(`Cannot add layer "${f}" before non-existing layer "${n}".`)));else{if(this._order.splice(I,0,f),this._layerOrderChanged=!0,this._layers[f]=v,this._removedLayers[f]&&v.source&&v.type!=="custom"){const k=this._removedLayers[f];delete this._removedLayers[f],k.type!==v.type?this._updatedSources[v.source]="clear":(this._updatedSources[v.source]="reload",this.sourceCaches[v.source].pause())}this._updateLayer(v),v.onAdd&&v.onAdd(this.map)}}moveLayer(t,n){if(this._checkLoaded(),this._changed=!0,!this._layers[t])return void this.fire(new s.j(new Error(`The layer '${t}' does not exist in the map's style and cannot be moved.`)));if(t===n)return;const a=this._order.indexOf(t);this._order.splice(a,1);const f=n?this._order.indexOf(n):this._order.length;n&&f===-1?this.fire(new s.j(new Error(`Cannot move layer "${t}" before non-existing layer "${n}".`))):(this._order.splice(f,0,t),this._layerOrderChanged=!0)}removeLayer(t){this._checkLoaded();const n=this._layers[t];if(!n)return void this.fire(new s.j(new Error(`Cannot remove non-existing layer "${t}".`)));n.setEventedParent(null);const a=this._order.indexOf(t);this._order.splice(a,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[t]=n,delete this._layers[t],this._serializedLayers&&delete this._serializedLayers[t],delete this._updatedLayers[t],delete this._updatedPaintProps[t],n.onRemove&&n.onRemove(this.map)}getLayer(t){return this._layers[t]}getLayersOrder(){return[...this._order]}hasLayer(t){return t in this._layers}setLayerZoomRange(t,n,a){this._checkLoaded();const f=this.getLayer(t);f?f.minzoom===n&&f.maxzoom===a||(n!=null&&(f.minzoom=n),a!=null&&(f.maxzoom=a),this._updateLayer(f)):this.fire(new s.j(new Error(`Cannot set the zoom range of non-existing layer "${t}".`)))}setFilter(t,n,a={}){this._checkLoaded();const f=this.getLayer(t);if(f){if(!s.aE(f.filter,n))return n==null?(f.filter=void 0,void this._updateLayer(f)):void(this._validate(s.x.filter,`layers.${f.id}.filter`,n,null,a)||(f.filter=s.aB(n),this._updateLayer(f)))}else this.fire(new s.j(new Error(`Cannot filter non-existing layer "${t}".`)))}getFilter(t){return s.aB(this.getLayer(t).filter)}setLayoutProperty(t,n,a,f={}){this._checkLoaded();const v=this.getLayer(t);v?s.aE(v.getLayoutProperty(n),a)||(v.setLayoutProperty(n,a,f),this._updateLayer(v)):this.fire(new s.j(new Error(`Cannot style non-existing layer "${t}".`)))}getLayoutProperty(t,n){const a=this.getLayer(t);if(a)return a.getLayoutProperty(n);this.fire(new s.j(new Error(`Cannot get style of non-existing layer "${t}".`)))}setPaintProperty(t,n,a,f={}){this._checkLoaded();const v=this.getLayer(t);v?s.aE(v.getPaintProperty(n),a)||(v.setPaintProperty(n,a,f)&&this._updateLayer(v),this._changed=!0,this._updatedPaintProps[t]=!0,this._serializedLayers=null):this.fire(new s.j(new Error(`Cannot style non-existing layer "${t}".`)))}getPaintProperty(t,n){return this.getLayer(t).getPaintProperty(n)}setFeatureState(t,n){this._checkLoaded();const a=t.source,f=t.sourceLayer,v=this.sourceCaches[a];if(v===void 0)return void this.fire(new s.j(new Error(`The source '${a}' does not exist in the map's style.`)));const I=v.getSource().type;I==="geojson"&&f?this.fire(new s.j(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):I!=="vector"||f?(t.id===void 0&&this.fire(new s.j(new Error("The feature id parameter must be provided."))),v.setFeatureState(f,t.id,n)):this.fire(new s.j(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(t,n){this._checkLoaded();const a=t.source,f=this.sourceCaches[a];if(f===void 0)return void this.fire(new s.j(new Error(`The source '${a}' does not exist in the map's style.`)));const v=f.getSource().type,I=v==="vector"?t.sourceLayer:void 0;v!=="vector"||I?n&&typeof t.id!="string"&&typeof t.id!="number"?this.fire(new s.j(new Error("A feature id is required to remove its specific state property."))):f.removeFeatureState(I,t.id,n):this.fire(new s.j(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(t){this._checkLoaded();const n=t.source,a=t.sourceLayer,f=this.sourceCaches[n];if(f!==void 0)return f.getSource().type!=="vector"||a?(t.id===void 0&&this.fire(new s.j(new Error("The feature id parameter must be provided."))),f.getFeatureState(a,t.id)):void this.fire(new s.j(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new s.j(new Error(`The source '${n}' does not exist in the map's style.`)))}getTransition(){return s.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const t=s.aF(this.sourceCaches,v=>v.serialize()),n=this._serializeByIds(this._order),a=this.map.getTerrain()||void 0,f=this.stylesheet;return s.aG({version:f.version,name:f.name,metadata:f.metadata,light:f.light,center:f.center,zoom:f.zoom,bearing:f.bearing,pitch:f.pitch,sprite:f.sprite,glyphs:f.glyphs,transition:f.transition,sources:t,layers:n,terrain:a},v=>v!==void 0)}_updateLayer(t){this._updatedLayers[t.id]=!0,t.source&&!this._updatedSources[t.source]&&this.sourceCaches[t.source].getSource().type!=="raster"&&(this._updatedSources[t.source]="reload",this.sourceCaches[t.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(t){const n=I=>this._layers[I].type==="fill-extrusion",a={},f=[];for(let I=this._order.length-1;I>=0;I--){const k=this._order[I];if(n(k)){a[k]=I;for(const D of t){const B=D[k];if(B)for(const G of B)f.push(G)}}}f.sort((I,k)=>k.intersectionZ-I.intersectionZ);const v=[];for(let I=this._order.length-1;I>=0;I--){const k=this._order[I];if(n(k))for(let D=f.length-1;D>=0;D--){const B=f[D].feature;if(a[B.layer.id]<I)break;v.push(B),f.pop()}else for(const D of t){const B=D[k];if(B)for(const G of B)v.push(G.feature)}}return v}queryRenderedFeatures(t,n,a){n&&n.filter&&this._validate(s.x.filter,"queryRenderedFeatures.filter",n.filter,null,n);const f={};if(n&&n.layers){if(!Array.isArray(n.layers))return this.fire(new s.j(new Error("parameters.layers must be an Array."))),[];for(const k of n.layers){const D=this._layers[k];if(!D)return this.fire(new s.j(new Error(`The layer '${k}' does not exist in the map's style and cannot be queried for features.`))),[];f[D.source]=!0}}const v=[];n.availableImages=this._availableImages;const I=this._serializedAllLayers();for(const k in this.sourceCaches)n.layers&&!f[k]||v.push(vt(this.sourceCaches[k],this._layers,I,t,n,a));return this.placement&&v.push(function(k,D,B,G,U,K,ie){const oe={},ve=K.queryRenderedSymbols(G),ce=[];for(const Se of Object.keys(ve).map(Number))ce.push(ie[Se]);ce.sort(Et);for(const Se of ce){const ke=Se.featureIndex.lookupSymbolFeatures(ve[Se.bucketInstanceId],D,Se.bucketIndex,Se.sourceLayerIndex,U.filter,U.layers,U.availableImages,k);for(const pe in ke){const Fe=oe[pe]=oe[pe]||[],We=ke[pe];We.sort((Ye,mt)=>{const Tt=Se.featureSortOrder;if(Tt){const Ht=Tt.indexOf(Ye.featureIndex);return Tt.indexOf(mt.featureIndex)-Ht}return mt.featureIndex-Ye.featureIndex});for(const Ye of We)Fe.push(Ye)}}for(const Se in oe)oe[Se].forEach(ke=>{const pe=ke.feature,Fe=B[k[Se].source].getFeatureState(pe.layer["source-layer"],pe.id);pe.source=pe.layer.source,pe.layer["source-layer"]&&(pe.sourceLayer=pe.layer["source-layer"]),pe.state=Fe});return oe}(this._layers,I,this.sourceCaches,t,n,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(v)}querySourceFeatures(t,n){n&&n.filter&&this._validate(s.x.filter,"querySourceFeatures.filter",n.filter,null,n);const a=this.sourceCaches[t];return a?function(f,v){const I=f.getRenderableIds().map(B=>f.getTileByID(B)),k=[],D={};for(let B=0;B<I.length;B++){const G=I[B],U=G.tileID.canonical.key;D[U]||(D[U]=!0,G.querySourceFeatures(k,v))}return k}(a,n):[]}getLight(){return this.light.getLight()}setLight(t,n={}){this._checkLoaded();const a=this.light.getLight();let f=!1;for(const I in t)if(!s.aE(t[I],a[I])){f=!0;break}if(!f)return;const v={now:l.now(),transition:s.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(t,n),this.light.updateTransitions(v)}_validate(t,n,a,f,v={}){return(!v||v.validate!==!1)&&Cs(this,t.call(s.x,s.e({key:n,style:this.serialize(),value:a,styleSpec:s.v},f)))}_remove(t=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),Ei().off(vi,this._rtlPluginLoaded);for(const n in this._layers)this._layers[n].setEventedParent(null);for(const n in this.sourceCaches){const a=this.sourceCaches[n];a.setEventedParent(null),a.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),t&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(t)}_clearSource(t){this.sourceCaches[t].clearTiles()}_reloadSource(t){this.sourceCaches[t].resume(),this.sourceCaches[t].reload()}_updateSources(t){for(const n in this.sourceCaches)this.sourceCaches[n].update(t,this.map.terrain)}_generateCollisionBoxes(){for(const t in this.sourceCaches)this._reloadSource(t)}_updatePlacement(t,n,a,f,v=!1){let I=!1,k=!1;const D={};for(const B of this._order){const G=this._layers[B];if(G.type!=="symbol")continue;if(!D[G.source]){const K=this.sourceCaches[G.source];D[G.source]=K.getRenderableIds(!0).map(ie=>K.getTileByID(ie)).sort((ie,oe)=>oe.tileID.overscaledZ-ie.tileID.overscaledZ||(ie.tileID.isLessThan(oe.tileID)?-1:1))}const U=this.crossTileSymbolIndex.addLayer(G,D[G.source],t.center.lng);I=I||U}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((v=v||this._layerOrderChanged||a===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(l.now(),t.zoom))&&(this.pauseablePlacement=new go(t,this.map.terrain,this._order,v,n,a,f,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,D),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(l.now()),k=!0),I&&this.pauseablePlacement.placement.setStale()),k||I)for(const B of this._order){const G=this._layers[B];G.type==="symbol"&&this.placement.updateLayerOpacities(G,D[G.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(l.now())}_releaseSymbolFadeTiles(){for(const t in this.sourceCaches)this.sourceCaches[t].releaseSymbolFadeTiles()}getImages(t,n){return s._(this,void 0,void 0,function*(){const a=yield this.imageManager.getImages(n.icons);this._updateTilesForChangedImages();const f=this.sourceCaches[n.source];return f&&f.setDependencies(n.tileID.key,n.type,n.icons),a})}getGlyphs(t,n){return s._(this,void 0,void 0,function*(){const a=yield this.glyphManager.getGlyphs(n.stacks),f=this.sourceCaches[n.source];return f&&f.setDependencies(n.tileID.key,n.type,[""]),a})}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(t,n={}){this._checkLoaded(),t&&this._validate(s.x.glyphs,"glyphs",t,null,n)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=t,this.glyphManager.entries={},this.glyphManager.setURL(t))}addSprite(t,n,a={},f){this._checkLoaded();const v=[{id:t,url:n}],I=[...ze(this.stylesheet.sprite),...v];this._validate(s.x.sprite,"sprite",I,null,a)||(this.stylesheet.sprite=I,this._loadSprite(v,!0,f))}removeSprite(t){this._checkLoaded();const n=ze(this.stylesheet.sprite);if(n.find(a=>a.id===t)){if(this._spritesImagesIds[t])for(const a of this._spritesImagesIds[t])this.imageManager.removeImage(a),this._changedImages[a]=!0;n.splice(n.findIndex(a=>a.id===t),1),this.stylesheet.sprite=n.length>0?n:void 0,delete this._spritesImagesIds[t],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.k("data",{dataType:"style"}))}else this.fire(new s.j(new Error(`Sprite "${t}" doesn't exists on this map.`)))}getSprite(){return ze(this.stylesheet.sprite)}setSprite(t,n={},a){this._checkLoaded(),t&&this._validate(s.x.sprite,"sprite",t,null,n)||(this.stylesheet.sprite=t,t?this._loadSprite(t,!0,a):(this._unloadSprite(),a&&a(null)))}}var On=s.X([{name:"a_pos",type:"Int16",components:2}]),zo="attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform float u_ele_delta;varying vec2 v_texture_pos;varying float v_depth;void main() {float extent=8192.0;float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/extent;gl_Position=u_matrix*vec4(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta,1.0);v_depth=gl_Position.z/gl_Position.w;}";const Rs={prelude:Bi(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture2D(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture2D(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}`),background:Bi(`uniform vec4 u_color;uniform float u_opacity;void main() {gl_FragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),backgroundPattern:Bi(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:Bi(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));gl_FragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);float ele=get_elevation(circle_center);v_visibility=calculate_visibility(u_matrix*vec4(circle_center,ele,1.0));if (u_pitch_with_map) {vec2 corner_position=circle_center;if (u_scale_with_map) {corner_position+=extrude*(radius+stroke_width)*u_extrude_scale;} else {vec4 projected_center=u_matrix*vec4(circle_center,0,1);corner_position+=extrude*(radius+stroke_width)*u_extrude_scale*(projected_center.w/u_camera_to_center_distance);}gl_Position=u_matrix*vec4(corner_position,ele,1);} else {gl_Position=u_matrix*vec4(circle_center,ele,1);if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:Bi("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Bi(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec4 pos=vec4(floor(a_pos*0.5)+extrude,0,1);gl_Position=u_matrix*pos;}`),heatmapTexture:Bi(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:Bi("varying float v_placed;varying float v_notUsed;void main() {float alpha=0.5;gl_FragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {gl_FragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {gl_FragColor*=.1;}}","attribute vec2 a_anchor_pos;attribute vec2 a_placed;attribute vec2 a_box_real;uniform mat4 u_matrix;uniform vec2 u_pixel_extrude_scale;varying float v_placed;varying float v_notUsed;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Bi("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Bi("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,get_elevation(a_pos),1);}"),fill:Bi(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_FragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);}`),fillOutline:Bi(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=outline_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillOutlinePattern:Bi(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillPattern:Bi(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:Bi(`varying vec4 v_color;void main() {gl_FragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t > 0.0 ? height : base,1);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:Bi(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);gl_FragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float z=t > 0.0 ? height : base;gl_Position=u_matrix*vec4(a_pos,z,1);vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:Bi(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Bi(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;
#define PI 3.141592653589793
void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;}"),line:Bi(`uniform lowp float u_device_pixel_ratio;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp float v_linesofar;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:Bi(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture2D(u_image,v_uv);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_uv_x;attribute float a_split_index;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:Bi(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);gl_FragColor=color*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:Bi(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture2D(u_image,v_tex_a).a;float sdfdist_b=texture2D(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}`),raster:Bi(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);gl_FragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos0=(((a_texture_pos/8192.0)-0.5)/u_buffer_scale )+0.5;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}"),symbolIcon:Bi(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;varying vec2 v_tex;varying float v_fade_opacity;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:Bi(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;varying vec2 v_data0;varying vec3 v_data1;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:Bi(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;varying vec4 v_data0;varying vec4 v_data1;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:Bi("uniform sampler2D u_texture;varying vec2 v_texture_pos;void main() {gl_FragColor=texture2D(u_texture,v_texture_pos);}",zo),terrainDepth:Bi("varying float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {gl_FragColor=pack(v_depth);}",zo),terrainCoords:Bi("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;varying vec2 v_texture_pos;void main() {vec4 rgba=texture2D(u_texture,v_texture_pos);gl_FragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}",zo)};function Bi(y,t){const n=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,a=t.match(/attribute ([\w]+) ([\w]+)/g),f=y.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),v=t.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),I=v?v.concat(f):f,k={};return{fragmentSource:y=y.replace(n,(D,B,G,U,K)=>(k[K]=!0,B==="define"?`
#ifndef HAS_UNIFORM_u_${K}
varying ${G} ${U} ${K};
#else
uniform ${G} ${U} u_${K};
#endif
`:`
#ifdef HAS_UNIFORM_u_${K}
    ${G} ${U} ${K} = u_${K};
#endif
`)),vertexSource:t=t.replace(n,(D,B,G,U,K)=>{const ie=U==="float"?"vec2":"vec4",oe=K.match(/color/)?"color":ie;return k[K]?B==="define"?`
#ifndef HAS_UNIFORM_u_${K}
uniform lowp float u_${K}_t;
attribute ${G} ${ie} a_${K};
varying ${G} ${U} ${K};
#else
uniform ${G} ${U} u_${K};
#endif
`:oe==="vec4"?`
#ifndef HAS_UNIFORM_u_${K}
    ${K} = a_${K};
#else
    ${G} ${U} ${K} = u_${K};
#endif
`:`
#ifndef HAS_UNIFORM_u_${K}
    ${K} = unpack_mix_${oe}(a_${K}, u_${K}_t);
#else
    ${G} ${U} ${K} = u_${K};
#endif
`:B==="define"?`
#ifndef HAS_UNIFORM_u_${K}
uniform lowp float u_${K}_t;
attribute ${G} ${ie} a_${K};
#else
uniform ${G} ${U} u_${K};
#endif
`:oe==="vec4"?`
#ifndef HAS_UNIFORM_u_${K}
    ${G} ${U} ${K} = a_${K};
#else
    ${G} ${U} ${K} = u_${K};
#endif
`:`
#ifndef HAS_UNIFORM_u_${K}
    ${G} ${U} ${K} = unpack_mix_${oe}(a_${K}, u_${K}_t);
#else
    ${G} ${U} ${K} = u_${K};
#endif
`}),staticAttributes:a,staticUniforms:I}}class Ro{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(t,n,a,f,v,I,k,D,B){this.context=t;let G=this.boundPaintVertexBuffers.length!==f.length;for(let U=0;!G&&U<f.length;U++)this.boundPaintVertexBuffers[U]!==f[U]&&(G=!0);!this.vao||this.boundProgram!==n||this.boundLayoutVertexBuffer!==a||G||this.boundIndexBuffer!==v||this.boundVertexOffset!==I||this.boundDynamicVertexBuffer!==k||this.boundDynamicVertexBuffer2!==D||this.boundDynamicVertexBuffer3!==B?this.freshBind(n,a,f,v,I,k,D,B):(t.bindVertexArray.set(this.vao),k&&k.bind(),v&&v.dynamicDraw&&v.bind(),D&&D.bind(),B&&B.bind())}freshBind(t,n,a,f,v,I,k,D){const B=t.numAttributes,G=this.context,U=G.gl;this.vao&&this.destroy(),this.vao=G.createVertexArray(),G.bindVertexArray.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=n,this.boundPaintVertexBuffers=a,this.boundIndexBuffer=f,this.boundVertexOffset=v,this.boundDynamicVertexBuffer=I,this.boundDynamicVertexBuffer2=k,this.boundDynamicVertexBuffer3=D,n.enableAttributes(U,t);for(const K of a)K.enableAttributes(U,t);I&&I.enableAttributes(U,t),k&&k.enableAttributes(U,t),D&&D.enableAttributes(U,t),n.bind(),n.setVertexAttribPointers(U,t,v);for(const K of a)K.bind(),K.setVertexAttribPointers(U,t,v);I&&(I.bind(),I.setVertexAttribPointers(U,t,v)),f&&f.bind(),k&&(k.bind(),k.setVertexAttribPointers(U,t,v)),D&&(D.bind(),D.setVertexAttribPointers(U,t,v)),G.currentNumAttributes=B}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}function Yn(y){const t=[];for(let n=0;n<y.length;n++){if(y[n]===null)continue;const a=y[n].split(" ");t.push(a.pop())}return t}class P{constructor(t,n,a,f,v,I){const k=t.gl;this.program=k.createProgram();const D=Yn(n.staticAttributes),B=a?a.getBinderAttributes():[],G=D.concat(B),U=Rs.prelude.staticUniforms?Yn(Rs.prelude.staticUniforms):[],K=n.staticUniforms?Yn(n.staticUniforms):[],ie=a?a.getBinderUniforms():[],oe=U.concat(K).concat(ie),ve=[];for(const Ye of oe)ve.indexOf(Ye)<0&&ve.push(Ye);const ce=a?a.defines():[];v&&ce.push("#define OVERDRAW_INSPECTOR;"),I&&ce.push("#define TERRAIN3D;");const Se=ce.concat(Rs.prelude.fragmentSource,n.fragmentSource).join(`
`),ke=ce.concat(Rs.prelude.vertexSource,n.vertexSource).join(`
`),pe=k.createShader(k.FRAGMENT_SHADER);if(k.isContextLost())return void(this.failedToCreate=!0);if(k.shaderSource(pe,Se),k.compileShader(pe),!k.getShaderParameter(pe,k.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${k.getShaderInfoLog(pe)}`);k.attachShader(this.program,pe);const Fe=k.createShader(k.VERTEX_SHADER);if(k.isContextLost())return void(this.failedToCreate=!0);if(k.shaderSource(Fe,ke),k.compileShader(Fe),!k.getShaderParameter(Fe,k.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${k.getShaderInfoLog(Fe)}`);k.attachShader(this.program,Fe),this.attributes={};const We={};this.numAttributes=G.length;for(let Ye=0;Ye<this.numAttributes;Ye++)G[Ye]&&(k.bindAttribLocation(this.program,Ye,G[Ye]),this.attributes[G[Ye]]=Ye);if(k.linkProgram(this.program),!k.getProgramParameter(this.program,k.LINK_STATUS))throw new Error(`Program failed to link: ${k.getProgramInfoLog(this.program)}`);k.deleteShader(Fe),k.deleteShader(pe);for(let Ye=0;Ye<ve.length;Ye++){const mt=ve[Ye];if(mt&&!We[mt]){const Tt=k.getUniformLocation(this.program,mt);Tt&&(We[mt]=Tt)}}this.fixedUniforms=f(t,We),this.terrainUniforms=((Ye,mt)=>({u_depth:new s.aH(Ye,mt.u_depth),u_terrain:new s.aH(Ye,mt.u_terrain),u_terrain_dim:new s.aI(Ye,mt.u_terrain_dim),u_terrain_matrix:new s.aJ(Ye,mt.u_terrain_matrix),u_terrain_unpack:new s.aK(Ye,mt.u_terrain_unpack),u_terrain_exaggeration:new s.aI(Ye,mt.u_terrain_exaggeration)}))(t,We),this.binderUniforms=a?a.getUniforms(t,We):[]}draw(t,n,a,f,v,I,k,D,B,G,U,K,ie,oe,ve,ce,Se,ke){const pe=t.gl;if(this.failedToCreate)return;if(t.program.set(this.program),t.setDepthMode(a),t.setStencilMode(f),t.setColorMode(v),t.setCullFace(I),D){t.activeTexture.set(pe.TEXTURE2),pe.bindTexture(pe.TEXTURE_2D,D.depthTexture),t.activeTexture.set(pe.TEXTURE3),pe.bindTexture(pe.TEXTURE_2D,D.texture);for(const We in this.terrainUniforms)this.terrainUniforms[We].set(D[We])}for(const We in this.fixedUniforms)this.fixedUniforms[We].set(k[We]);ve&&ve.setUniforms(t,this.binderUniforms,ie,{zoom:oe});let Fe=0;switch(n){case pe.LINES:Fe=2;break;case pe.TRIANGLES:Fe=3;break;case pe.LINE_STRIP:Fe=1}for(const We of K.get()){const Ye=We.vaos||(We.vaos={});(Ye[B]||(Ye[B]=new Ro)).bind(t,this,G,ve?ve.getPaintVertexBuffers():[],U,We.vertexOffset,ce,Se,ke),pe.drawElements(n,We.primitiveLength*Fe,pe.UNSIGNED_SHORT,We.primitiveOffset*Fe*2)}}}function z(y,t,n){const a=1/mi(n,1,t.transform.tileZoom),f=Math.pow(2,n.tileID.overscaledZ),v=n.tileSize*Math.pow(2,t.transform.tileZoom)/f,I=v*(n.tileID.canonical.x+n.tileID.wrap*f),k=v*n.tileID.canonical.y;return{u_image:0,u_texsize:n.imageAtlasTexture.size,u_scale:[a,y.fromScale,y.toScale],u_fade:y.t,u_pixel_coord_upper:[I>>16,k>>16],u_pixel_coord_lower:[65535&I,65535&k]}}const Z=(y,t,n,a)=>{const f=t.style.light,v=f.properties.get("position"),I=[v.x,v.y,v.z],k=function(){var B=new s.A(9);return s.A!=Float32Array&&(B[1]=0,B[2]=0,B[3]=0,B[5]=0,B[6]=0,B[7]=0),B[0]=1,B[4]=1,B[8]=1,B}();f.properties.get("anchor")==="viewport"&&function(B,G){var U=Math.sin(G),K=Math.cos(G);B[0]=K,B[1]=U,B[2]=0,B[3]=-U,B[4]=K,B[5]=0,B[6]=0,B[7]=0,B[8]=1}(k,-t.transform.angle),function(B,G,U){var K=G[0],ie=G[1],oe=G[2];B[0]=K*U[0]+ie*U[3]+oe*U[6],B[1]=K*U[1]+ie*U[4]+oe*U[7],B[2]=K*U[2]+ie*U[5]+oe*U[8]}(I,I,k);const D=f.properties.get("color");return{u_matrix:y,u_lightpos:I,u_lightintensity:f.properties.get("intensity"),u_lightcolor:[D.r,D.g,D.b],u_vertical_gradient:+n,u_opacity:a}},_e=(y,t,n,a,f,v,I)=>s.e(Z(y,t,n,a),z(v,t,I),{u_height_factor:-Math.pow(2,f.overscaledZ)/I.tileSize/8}),Pe=y=>({u_matrix:y}),Me=(y,t,n,a)=>s.e(Pe(y),z(n,t,a)),Be=(y,t)=>({u_matrix:y,u_world:t}),bt=(y,t,n,a,f)=>s.e(Me(y,t,n,a),{u_world:f}),It=(y,t,n,a)=>{const f=y.transform;let v,I;if(a.paint.get("circle-pitch-alignment")==="map"){const k=mi(n,1,f.zoom);v=!0,I=[k,k]}else v=!1,I=f.pixelsToGLUnits;return{u_camera_to_center_distance:f.cameraToCenterDistance,u_scale_with_map:+(a.paint.get("circle-pitch-scale")==="map"),u_matrix:y.translatePosMatrix(t.posMatrix,n,a.paint.get("circle-translate"),a.paint.get("circle-translate-anchor")),u_pitch_with_map:+v,u_device_pixel_ratio:y.pixelRatio,u_extrude_scale:I}},Vt=(y,t,n)=>({u_matrix:y,u_inv_matrix:t,u_camera_to_center_distance:n.cameraToCenterDistance,u_viewport_size:[n.width,n.height]}),Nt=(y,t,n=1)=>({u_matrix:y,u_color:t,u_overlay:0,u_overlay_scale:n}),Dt=y=>({u_matrix:y}),_i=(y,t,n,a)=>({u_matrix:y,u_extrude_scale:mi(t,1,n),u_intensity:a});function rr(y,t){const n=Math.pow(2,t.canonical.z),a=t.canonical.y;return[new s.Y(0,a/n).toLngLat().lat,new s.Y(0,(a+1)/n).toLngLat().lat]}const fi=(y,t,n,a)=>{const f=y.transform;return{u_matrix:kr(y,t,n,a),u_ratio:1/mi(t,1,f.zoom),u_device_pixel_ratio:y.pixelRatio,u_units_to_pixels:[1/f.pixelsToGLUnits[0],1/f.pixelsToGLUnits[1]]}},ji=(y,t,n,a,f)=>s.e(fi(y,t,n,f),{u_image:0,u_image_height:a}),yt=(y,t,n,a,f)=>{const v=y.transform,I=Hi(t,v);return{u_matrix:kr(y,t,n,f),u_texsize:t.imageAtlasTexture.size,u_ratio:1/mi(t,1,v.zoom),u_device_pixel_ratio:y.pixelRatio,u_image:0,u_scale:[I,a.fromScale,a.toScale],u_fade:a.t,u_units_to_pixels:[1/v.pixelsToGLUnits[0],1/v.pixelsToGLUnits[1]]}},ii=(y,t,n,a,f,v)=>{const I=y.lineAtlas,k=Hi(t,y.transform),D=n.layout.get("line-cap")==="round",B=I.getDash(a.from,D),G=I.getDash(a.to,D),U=B.width*f.fromScale,K=G.width*f.toScale;return s.e(fi(y,t,n,v),{u_patternscale_a:[k/U,-B.height/2],u_patternscale_b:[k/K,-G.height/2],u_sdfgamma:I.width/(256*Math.min(U,K)*y.pixelRatio)/2,u_image:0,u_tex_y_a:B.y,u_tex_y_b:G.y,u_mix:f.t})};function Hi(y,t){return 1/mi(y,1,t.tileZoom)}function kr(y,t,n,a){return y.translatePosMatrix(a?a.posMatrix:t.tileID.posMatrix,t,n.paint.get("line-translate"),n.paint.get("line-translate-anchor"))}const lr=(y,t,n,a,f)=>{return{u_matrix:y,u_tl_parent:t,u_scale_parent:n,u_buffer_scale:1,u_fade_t:a.mix,u_opacity:a.opacity*f.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:f.paint.get("raster-brightness-min"),u_brightness_high:f.paint.get("raster-brightness-max"),u_saturation_factor:(I=f.paint.get("raster-saturation"),I>0?1-1/(1.001-I):-I),u_contrast_factor:(v=f.paint.get("raster-contrast"),v>0?1/(1-v):1+v),u_spin_weights:pa(f.paint.get("raster-hue-rotate"))};var v,I};function pa(y){y*=Math.PI/180;const t=Math.sin(y),n=Math.cos(y);return[(2*n+1)/3,(-Math.sqrt(3)*t-n+1)/3,(Math.sqrt(3)*t-n+1)/3]}const Wa=(y,t,n,a,f,v,I,k,D,B,G,U,K,ie)=>{const oe=I.transform;return{u_is_size_zoom_constant:+(y==="constant"||y==="source"),u_is_size_feature_constant:+(y==="constant"||y==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:oe.cameraToCenterDistance,u_pitch:oe.pitch/360*2*Math.PI,u_rotate_symbol:+n,u_aspect_ratio:oe.width/oe.height,u_fade_change:I.options.fadeDuration?I.symbolFadeChange:1,u_matrix:k,u_label_plane_matrix:D,u_coord_matrix:B,u_is_text:+U,u_pitch_with_map:+a,u_is_along_line:f,u_is_variable_anchor:v,u_texsize:K,u_texture:0,u_translation:G,u_pitched_scale:ie}},nr=(y,t,n,a,f,v,I,k,D,B,G,U,K,ie,oe)=>{const ve=I.transform;return s.e(Wa(y,t,n,a,f,v,I,k,D,B,G,U,K,oe),{u_gamma_scale:a?Math.cos(ve._pitch)*ve.cameraToCenterDistance:1,u_device_pixel_ratio:I.pixelRatio,u_is_halo:+ie})},Ha=(y,t,n,a,f,v,I,k,D,B,G,U,K,ie)=>s.e(nr(y,t,n,a,f,v,I,k,D,B,G,!0,U,!0,ie),{u_texsize_icon:K,u_texture_icon:1}),El=(y,t,n)=>({u_matrix:y,u_opacity:t,u_color:n}),Zn=(y,t,n,a,f,v)=>s.e(function(I,k,D,B){const G=D.imageManager.getPattern(I.from.toString()),U=D.imageManager.getPattern(I.to.toString()),{width:K,height:ie}=D.imageManager.getPixelSize(),oe=Math.pow(2,B.tileID.overscaledZ),ve=B.tileSize*Math.pow(2,D.transform.tileZoom)/oe,ce=ve*(B.tileID.canonical.x+B.tileID.wrap*oe),Se=ve*B.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:G.tl,u_pattern_br_a:G.br,u_pattern_tl_b:U.tl,u_pattern_br_b:U.br,u_texsize:[K,ie],u_mix:k.t,u_pattern_size_a:G.displaySize,u_pattern_size_b:U.displaySize,u_scale_a:k.fromScale,u_scale_b:k.toScale,u_tile_units_to_pixels:1/mi(B,1,D.transform.tileZoom),u_pixel_coord_upper:[ce>>16,Se>>16],u_pixel_coord_lower:[65535&ce,65535&Se]}}(a,v,n,f),{u_matrix:y,u_opacity:t}),_o={fillExtrusion:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_lightpos:new s.aL(y,t.u_lightpos),u_lightintensity:new s.aI(y,t.u_lightintensity),u_lightcolor:new s.aL(y,t.u_lightcolor),u_vertical_gradient:new s.aI(y,t.u_vertical_gradient),u_opacity:new s.aI(y,t.u_opacity)}),fillExtrusionPattern:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_lightpos:new s.aL(y,t.u_lightpos),u_lightintensity:new s.aI(y,t.u_lightintensity),u_lightcolor:new s.aL(y,t.u_lightcolor),u_vertical_gradient:new s.aI(y,t.u_vertical_gradient),u_height_factor:new s.aI(y,t.u_height_factor),u_image:new s.aH(y,t.u_image),u_texsize:new s.aM(y,t.u_texsize),u_pixel_coord_upper:new s.aM(y,t.u_pixel_coord_upper),u_pixel_coord_lower:new s.aM(y,t.u_pixel_coord_lower),u_scale:new s.aL(y,t.u_scale),u_fade:new s.aI(y,t.u_fade),u_opacity:new s.aI(y,t.u_opacity)}),fill:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix)}),fillPattern:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_image:new s.aH(y,t.u_image),u_texsize:new s.aM(y,t.u_texsize),u_pixel_coord_upper:new s.aM(y,t.u_pixel_coord_upper),u_pixel_coord_lower:new s.aM(y,t.u_pixel_coord_lower),u_scale:new s.aL(y,t.u_scale),u_fade:new s.aI(y,t.u_fade)}),fillOutline:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_world:new s.aM(y,t.u_world)}),fillOutlinePattern:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_world:new s.aM(y,t.u_world),u_image:new s.aH(y,t.u_image),u_texsize:new s.aM(y,t.u_texsize),u_pixel_coord_upper:new s.aM(y,t.u_pixel_coord_upper),u_pixel_coord_lower:new s.aM(y,t.u_pixel_coord_lower),u_scale:new s.aL(y,t.u_scale),u_fade:new s.aI(y,t.u_fade)}),circle:(y,t)=>({u_camera_to_center_distance:new s.aI(y,t.u_camera_to_center_distance),u_scale_with_map:new s.aH(y,t.u_scale_with_map),u_pitch_with_map:new s.aH(y,t.u_pitch_with_map),u_extrude_scale:new s.aM(y,t.u_extrude_scale),u_device_pixel_ratio:new s.aI(y,t.u_device_pixel_ratio),u_matrix:new s.aJ(y,t.u_matrix)}),collisionBox:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_pixel_extrude_scale:new s.aM(y,t.u_pixel_extrude_scale)}),collisionCircle:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_inv_matrix:new s.aJ(y,t.u_inv_matrix),u_camera_to_center_distance:new s.aI(y,t.u_camera_to_center_distance),u_viewport_size:new s.aM(y,t.u_viewport_size)}),debug:(y,t)=>({u_color:new s.aN(y,t.u_color),u_matrix:new s.aJ(y,t.u_matrix),u_overlay:new s.aH(y,t.u_overlay),u_overlay_scale:new s.aI(y,t.u_overlay_scale)}),clippingMask:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix)}),heatmap:(y,t)=>({u_extrude_scale:new s.aI(y,t.u_extrude_scale),u_intensity:new s.aI(y,t.u_intensity),u_matrix:new s.aJ(y,t.u_matrix)}),heatmapTexture:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_world:new s.aM(y,t.u_world),u_image:new s.aH(y,t.u_image),u_color_ramp:new s.aH(y,t.u_color_ramp),u_opacity:new s.aI(y,t.u_opacity)}),hillshade:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_image:new s.aH(y,t.u_image),u_latrange:new s.aM(y,t.u_latrange),u_light:new s.aM(y,t.u_light),u_shadow:new s.aN(y,t.u_shadow),u_highlight:new s.aN(y,t.u_highlight),u_accent:new s.aN(y,t.u_accent)}),hillshadePrepare:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_image:new s.aH(y,t.u_image),u_dimension:new s.aM(y,t.u_dimension),u_zoom:new s.aI(y,t.u_zoom),u_unpack:new s.aK(y,t.u_unpack)}),line:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_ratio:new s.aI(y,t.u_ratio),u_device_pixel_ratio:new s.aI(y,t.u_device_pixel_ratio),u_units_to_pixels:new s.aM(y,t.u_units_to_pixels)}),lineGradient:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_ratio:new s.aI(y,t.u_ratio),u_device_pixel_ratio:new s.aI(y,t.u_device_pixel_ratio),u_units_to_pixels:new s.aM(y,t.u_units_to_pixels),u_image:new s.aH(y,t.u_image),u_image_height:new s.aI(y,t.u_image_height)}),linePattern:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_texsize:new s.aM(y,t.u_texsize),u_ratio:new s.aI(y,t.u_ratio),u_device_pixel_ratio:new s.aI(y,t.u_device_pixel_ratio),u_image:new s.aH(y,t.u_image),u_units_to_pixels:new s.aM(y,t.u_units_to_pixels),u_scale:new s.aL(y,t.u_scale),u_fade:new s.aI(y,t.u_fade)}),lineSDF:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_ratio:new s.aI(y,t.u_ratio),u_device_pixel_ratio:new s.aI(y,t.u_device_pixel_ratio),u_units_to_pixels:new s.aM(y,t.u_units_to_pixels),u_patternscale_a:new s.aM(y,t.u_patternscale_a),u_patternscale_b:new s.aM(y,t.u_patternscale_b),u_sdfgamma:new s.aI(y,t.u_sdfgamma),u_image:new s.aH(y,t.u_image),u_tex_y_a:new s.aI(y,t.u_tex_y_a),u_tex_y_b:new s.aI(y,t.u_tex_y_b),u_mix:new s.aI(y,t.u_mix)}),raster:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_tl_parent:new s.aM(y,t.u_tl_parent),u_scale_parent:new s.aI(y,t.u_scale_parent),u_buffer_scale:new s.aI(y,t.u_buffer_scale),u_fade_t:new s.aI(y,t.u_fade_t),u_opacity:new s.aI(y,t.u_opacity),u_image0:new s.aH(y,t.u_image0),u_image1:new s.aH(y,t.u_image1),u_brightness_low:new s.aI(y,t.u_brightness_low),u_brightness_high:new s.aI(y,t.u_brightness_high),u_saturation_factor:new s.aI(y,t.u_saturation_factor),u_contrast_factor:new s.aI(y,t.u_contrast_factor),u_spin_weights:new s.aL(y,t.u_spin_weights)}),symbolIcon:(y,t)=>({u_is_size_zoom_constant:new s.aH(y,t.u_is_size_zoom_constant),u_is_size_feature_constant:new s.aH(y,t.u_is_size_feature_constant),u_size_t:new s.aI(y,t.u_size_t),u_size:new s.aI(y,t.u_size),u_camera_to_center_distance:new s.aI(y,t.u_camera_to_center_distance),u_pitch:new s.aI(y,t.u_pitch),u_rotate_symbol:new s.aH(y,t.u_rotate_symbol),u_aspect_ratio:new s.aI(y,t.u_aspect_ratio),u_fade_change:new s.aI(y,t.u_fade_change),u_matrix:new s.aJ(y,t.u_matrix),u_label_plane_matrix:new s.aJ(y,t.u_label_plane_matrix),u_coord_matrix:new s.aJ(y,t.u_coord_matrix),u_is_text:new s.aH(y,t.u_is_text),u_pitch_with_map:new s.aH(y,t.u_pitch_with_map),u_is_along_line:new s.aH(y,t.u_is_along_line),u_is_variable_anchor:new s.aH(y,t.u_is_variable_anchor),u_texsize:new s.aM(y,t.u_texsize),u_texture:new s.aH(y,t.u_texture),u_translation:new s.aM(y,t.u_translation),u_pitched_scale:new s.aI(y,t.u_pitched_scale)}),symbolSDF:(y,t)=>({u_is_size_zoom_constant:new s.aH(y,t.u_is_size_zoom_constant),u_is_size_feature_constant:new s.aH(y,t.u_is_size_feature_constant),u_size_t:new s.aI(y,t.u_size_t),u_size:new s.aI(y,t.u_size),u_camera_to_center_distance:new s.aI(y,t.u_camera_to_center_distance),u_pitch:new s.aI(y,t.u_pitch),u_rotate_symbol:new s.aH(y,t.u_rotate_symbol),u_aspect_ratio:new s.aI(y,t.u_aspect_ratio),u_fade_change:new s.aI(y,t.u_fade_change),u_matrix:new s.aJ(y,t.u_matrix),u_label_plane_matrix:new s.aJ(y,t.u_label_plane_matrix),u_coord_matrix:new s.aJ(y,t.u_coord_matrix),u_is_text:new s.aH(y,t.u_is_text),u_pitch_with_map:new s.aH(y,t.u_pitch_with_map),u_is_along_line:new s.aH(y,t.u_is_along_line),u_is_variable_anchor:new s.aH(y,t.u_is_variable_anchor),u_texsize:new s.aM(y,t.u_texsize),u_texture:new s.aH(y,t.u_texture),u_gamma_scale:new s.aI(y,t.u_gamma_scale),u_device_pixel_ratio:new s.aI(y,t.u_device_pixel_ratio),u_is_halo:new s.aH(y,t.u_is_halo),u_translation:new s.aM(y,t.u_translation),u_pitched_scale:new s.aI(y,t.u_pitched_scale)}),symbolTextAndIcon:(y,t)=>({u_is_size_zoom_constant:new s.aH(y,t.u_is_size_zoom_constant),u_is_size_feature_constant:new s.aH(y,t.u_is_size_feature_constant),u_size_t:new s.aI(y,t.u_size_t),u_size:new s.aI(y,t.u_size),u_camera_to_center_distance:new s.aI(y,t.u_camera_to_center_distance),u_pitch:new s.aI(y,t.u_pitch),u_rotate_symbol:new s.aH(y,t.u_rotate_symbol),u_aspect_ratio:new s.aI(y,t.u_aspect_ratio),u_fade_change:new s.aI(y,t.u_fade_change),u_matrix:new s.aJ(y,t.u_matrix),u_label_plane_matrix:new s.aJ(y,t.u_label_plane_matrix),u_coord_matrix:new s.aJ(y,t.u_coord_matrix),u_is_text:new s.aH(y,t.u_is_text),u_pitch_with_map:new s.aH(y,t.u_pitch_with_map),u_is_along_line:new s.aH(y,t.u_is_along_line),u_is_variable_anchor:new s.aH(y,t.u_is_variable_anchor),u_texsize:new s.aM(y,t.u_texsize),u_texsize_icon:new s.aM(y,t.u_texsize_icon),u_texture:new s.aH(y,t.u_texture),u_texture_icon:new s.aH(y,t.u_texture_icon),u_gamma_scale:new s.aI(y,t.u_gamma_scale),u_device_pixel_ratio:new s.aI(y,t.u_device_pixel_ratio),u_is_halo:new s.aH(y,t.u_is_halo),u_translation:new s.aM(y,t.u_translation),u_pitched_scale:new s.aI(y,t.u_pitched_scale)}),background:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_opacity:new s.aI(y,t.u_opacity),u_color:new s.aN(y,t.u_color)}),backgroundPattern:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_opacity:new s.aI(y,t.u_opacity),u_image:new s.aH(y,t.u_image),u_pattern_tl_a:new s.aM(y,t.u_pattern_tl_a),u_pattern_br_a:new s.aM(y,t.u_pattern_br_a),u_pattern_tl_b:new s.aM(y,t.u_pattern_tl_b),u_pattern_br_b:new s.aM(y,t.u_pattern_br_b),u_texsize:new s.aM(y,t.u_texsize),u_mix:new s.aI(y,t.u_mix),u_pattern_size_a:new s.aM(y,t.u_pattern_size_a),u_pattern_size_b:new s.aM(y,t.u_pattern_size_b),u_scale_a:new s.aI(y,t.u_scale_a),u_scale_b:new s.aI(y,t.u_scale_b),u_pixel_coord_upper:new s.aM(y,t.u_pixel_coord_upper),u_pixel_coord_lower:new s.aM(y,t.u_pixel_coord_lower),u_tile_units_to_pixels:new s.aI(y,t.u_tile_units_to_pixels)}),terrain:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_texture:new s.aH(y,t.u_texture),u_ele_delta:new s.aI(y,t.u_ele_delta)}),terrainDepth:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_ele_delta:new s.aI(y,t.u_ele_delta)}),terrainCoords:(y,t)=>({u_matrix:new s.aJ(y,t.u_matrix),u_texture:new s.aH(y,t.u_texture),u_terrain_coords_id:new s.aI(y,t.u_terrain_coords_id),u_ele_delta:new s.aI(y,t.u_ele_delta)})};class Bo{constructor(t,n,a){this.context=t;const f=t.gl;this.buffer=f.createBuffer(),this.dynamicDraw=!!a,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),f.bufferData(f.ELEMENT_ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?f.DYNAMIC_DRAW:f.STATIC_DRAW),this.dynamicDraw||delete n.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){const n=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const yo={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class vo{constructor(t,n,a,f){this.length=n.length,this.attributes=a,this.itemSize=n.bytesPerElement,this.dynamicDraw=f,this.context=t;const v=t.gl;this.buffer=v.createBuffer(),t.bindVertexBuffer.set(this.buffer),v.bufferData(v.ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?v.DYNAMIC_DRAW:v.STATIC_DRAW),this.dynamicDraw||delete n.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){if(t.length!==this.length)throw new Error(`Length of new data is ${t.length}, which doesn't match current length of ${this.length}`);const n=this.context.gl;this.bind(),n.bufferSubData(n.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,n){for(let a=0;a<this.attributes.length;a++){const f=n.attributes[this.attributes[a].name];f!==void 0&&t.enableVertexAttribArray(f)}}setVertexAttribPointers(t,n,a){for(let f=0;f<this.attributes.length;f++){const v=this.attributes[f],I=n.attributes[v.name];I!==void 0&&t.vertexAttribPointer(I,v.components,t[yo[v.type]],!1,this.itemSize,v.offset+this.itemSize*(a||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Bs=new WeakMap;function tn(y){var t;if(Bs.has(y))return Bs.get(y);{const n=(t=y.getParameter(y.VERSION))===null||t===void 0?void 0:t.startsWith("WebGL 2.0");return Bs.set(y,n),n}}class Ni{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class ma extends Ni{getDefault(){return s.aP.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class xo extends Ni{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class js extends Ni{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Xa extends Ni{getDefault(){return[!0,!0,!0,!0]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class bo extends Ni{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Pl extends Ni{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class Ns extends Ni{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const n=this.current;(t.func!==n.func||t.ref!==n.ref||t.mask!==n.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class jo extends Ni{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class No extends Ni{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.current=t,this.dirty=!1}}class qa extends Ni{getDefault(){return[0,1]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class Dn extends Ni{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.current=t,this.dirty=!1}}class Vo extends Ni{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class ga extends Ni{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.BLEND):n.disable(n.BLEND),this.current=t,this.dirty=!1}}class $a extends Ni{getDefault(){const t=this.gl;return[t.ONE,t.ZERO]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.blendFunc(t[0],t[1]),this.current=t,this.dirty=!1)}}class _a extends Ni{getDefault(){return s.aP.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class wo extends Ni{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquation(t),this.current=t,this.dirty=!1)}}class us extends Ni{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this.current=t,this.dirty=!1}}class ya extends Ni{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Il extends Ni{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}class Ss extends Ni{getDefault(){return null}set(t){(t!==this.current||this.dirty)&&(this.gl.useProgram(t),this.current=t,this.dirty=!1)}}class va extends Ni{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class Co extends Ni{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Al extends Ni{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Vs extends Ni{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class So extends Ni{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindTexture(n.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class xa extends Ni{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Uo extends Ni{getDefault(){return null}set(t){const n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Go extends Ni{getDefault(){return null}set(t){var n;if(t===this.current&&!this.dirty)return;const a=this.gl;tn(a)?a.bindVertexArray(t):(n=a.getExtension("OES_vertex_array_object"))===null||n===void 0||n.bindVertexArrayOES(t),this.current=t,this.dirty=!1}}class Us extends Ni{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class ba extends Ni{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class Ya extends Ni{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Gs extends Ni{constructor(t,n){super(t),this.context=t,this.parent=n}getDefault(){return null}}class Kn extends Gs{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class wa extends Gs{set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Wo extends Gs{set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class To{constructor(t,n,a,f,v){this.context=t,this.width=n,this.height=a;const I=t.gl,k=this.framebuffer=I.createFramebuffer();if(this.colorAttachment=new Kn(t,k),f)this.depthAttachment=v?new Wo(t,k):new wa(t,k);else if(v)throw new Error("Stencil cannot be set without depth");if(I.checkFramebufferStatus(I.FRAMEBUFFER)!==I.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer is not complete")}destroy(){const t=this.context.gl,n=this.colorAttachment.get();if(n&&t.deleteTexture(n),this.depthAttachment){const a=this.depthAttachment.get();a&&t.deleteRenderbuffer(a)}t.deleteFramebuffer(this.framebuffer)}}class Ji{constructor(t,n,a){this.blendFunction=t,this.blendColor=n,this.mask=a}}Ji.Replace=[1,0],Ji.disabled=new Ji(Ji.Replace,s.aP.transparent,[!1,!1,!1,!1]),Ji.unblended=new Ji(Ji.Replace,s.aP.transparent,[!0,!0,!0,!0]),Ji.alphaBlended=new Ji([1,771],s.aP.transparent,[!0,!0,!0,!0]);class Ln{constructor(t){var n,a;if(this.gl=t,this.clearColor=new ma(this),this.clearDepth=new xo(this),this.clearStencil=new js(this),this.colorMask=new Xa(this),this.depthMask=new bo(this),this.stencilMask=new Pl(this),this.stencilFunc=new Ns(this),this.stencilOp=new jo(this),this.stencilTest=new No(this),this.depthRange=new qa(this),this.depthTest=new Dn(this),this.depthFunc=new Vo(this),this.blend=new ga(this),this.blendFunc=new $a(this),this.blendColor=new _a(this),this.blendEquation=new wo(this),this.cullFace=new us(this),this.cullFaceSide=new ya(this),this.frontFace=new Il(this),this.program=new Ss(this),this.activeTexture=new va(this),this.viewport=new Co(this),this.bindFramebuffer=new Al(this),this.bindRenderbuffer=new Vs(this),this.bindTexture=new So(this),this.bindVertexBuffer=new xa(this),this.bindElementBuffer=new Uo(this),this.bindVertexArray=new Go(this),this.pixelStoreUnpack=new Us(this),this.pixelStoreUnpackPremultiplyAlpha=new ba(this),this.pixelStoreUnpackFlipY=new Ya(this),this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),tn(t)){this.HALF_FLOAT=t.HALF_FLOAT;const f=t.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(n=t.RGBA16F)!==null&&n!==void 0?n:f==null?void 0:f.RGBA16F_EXT,this.RGB16F=(a=t.RGB16F)!==null&&a!==void 0?a:f==null?void 0:f.RGB16F_EXT,t.getExtension("EXT_color_buffer_float")}else{t.getExtension("EXT_color_buffer_half_float"),t.getExtension("OES_texture_half_float_linear");const f=t.getExtension("OES_texture_half_float");this.HALF_FLOAT=f==null?void 0:f.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,n){return new Bo(this,t,n)}createVertexBuffer(t,n,a){return new vo(this,t,n,a)}createRenderbuffer(t,n,a){const f=this.gl,v=f.createRenderbuffer();return this.bindRenderbuffer.set(v),f.renderbufferStorage(f.RENDERBUFFER,t,n,a),this.bindRenderbuffer.set(null),v}createFramebuffer(t,n,a,f){return new To(this,t,n,a,f)}clear({color:t,depth:n,stencil:a}){const f=this.gl;let v=0;t&&(v|=f.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set([!0,!0,!0,!0])),n!==void 0&&(v|=f.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(n),this.depthMask.set(!0)),a!==void 0&&(v|=f.STENCIL_BUFFER_BIT,this.clearStencil.set(a),this.stencilMask.set(255)),f.clear(v)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){s.aE(t.blendFunction,Ji.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor)),this.colorMask.set(t.mask)}createVertexArray(){var t;return tn(this.gl)?this.gl.createVertexArray():(t=this.gl.getExtension("OES_vertex_array_object"))===null||t===void 0?void 0:t.createVertexArrayOES()}deleteVertexArray(t){var n;return tn(this.gl)?this.gl.deleteVertexArray(t):(n=this.gl.getExtension("OES_vertex_array_object"))===null||n===void 0?void 0:n.deleteVertexArrayOES(t)}unbindVAO(){this.bindVertexArray.set(null)}}class Si{constructor(t,n,a){this.func=t,this.mask=n,this.range=a}}Si.ReadOnly=!1,Si.ReadWrite=!0,Si.disabled=new Si(519,Si.ReadOnly,[0,1]);const ds=7680;class Xi{constructor(t,n,a,f,v,I){this.test=t,this.ref=n,this.mask=a,this.fail=f,this.depthFail=v,this.pass=I}}Xi.disabled=new Xi({func:519,mask:0},0,0,ds,ds,ds);class cr{constructor(t,n,a){this.enable=t,this.mode=n,this.frontFace=a}}let Ts;function Ws(y,t,n,a,f){const v=y.context,I=v.gl,k=y.useProgram("collisionBox"),D=[];let B=0,G=0;for(let Se=0;Se<a.length;Se++){const ke=a[Se],pe=t.getTile(ke).getBucket(n);if(!pe)continue;const Fe=f?pe.textCollisionBox:pe.iconCollisionBox,We=pe.collisionCircleArray;if(We.length>0){const Ye=s.F();s.aQ(Ye,pe.placementInvProjMatrix,y.transform.glCoordMatrix),s.aQ(Ye,Ye,pe.placementViewportMatrix),D.push({circleArray:We,circleOffset:G,transform:ke.posMatrix,invTransform:Ye,coord:ke}),B+=We.length/4,G=B}Fe&&k.draw(v,I.LINES,Si.disabled,Xi.disabled,y.colorModeForRenderPass(),cr.disabled,{u_matrix:ke.posMatrix,u_pixel_extrude_scale:[1/(U=y.transform).width,1/U.height]},y.style.map.terrain&&y.style.map.terrain.getTerrainData(ke),n.id,Fe.layoutVertexBuffer,Fe.indexBuffer,Fe.segments,null,y.transform.zoom,null,null,Fe.collisionVertexBuffer)}var U;if(!f||!D.length)return;const K=y.useProgram("collisionCircle"),ie=new s.aR;ie.resize(4*B),ie._trim();let oe=0;for(const Se of D)for(let ke=0;ke<Se.circleArray.length/4;ke++){const pe=4*ke,Fe=Se.circleArray[pe+0],We=Se.circleArray[pe+1],Ye=Se.circleArray[pe+2],mt=Se.circleArray[pe+3];ie.emplace(oe++,Fe,We,Ye,mt,0),ie.emplace(oe++,Fe,We,Ye,mt,1),ie.emplace(oe++,Fe,We,Ye,mt,2),ie.emplace(oe++,Fe,We,Ye,mt,3)}(!Ts||Ts.length<2*B)&&(Ts=function(Se){const ke=2*Se,pe=new s.aT;pe.resize(ke),pe._trim();for(let Fe=0;Fe<ke;Fe++){const We=6*Fe;pe.uint16[We+0]=4*Fe+0,pe.uint16[We+1]=4*Fe+1,pe.uint16[We+2]=4*Fe+2,pe.uint16[We+3]=4*Fe+2,pe.uint16[We+4]=4*Fe+3,pe.uint16[We+5]=4*Fe+0}return pe}(B));const ve=v.createIndexBuffer(Ts,!0),ce=v.createVertexBuffer(ie,s.aS.members,!0);for(const Se of D){const ke=Vt(Se.transform,Se.invTransform,y.transform);K.draw(v,I.TRIANGLES,Si.disabled,Xi.disabled,y.colorModeForRenderPass(),cr.disabled,ke,y.style.map.terrain&&y.style.map.terrain.getTerrainData(Se.coord),n.id,ce,ve,s.$.simpleSegment(0,2*Se.circleOffset,Se.circleArray.length,Se.circleArray.length/2),null,y.transform.zoom,null,null,null)}ce.destroy(),ve.destroy()}cr.disabled=new cr(!1,1029,2305),cr.backCCW=new cr(!0,1029,2305);const Ho=s.an(new Float32Array(16));function Za(y,t,n,a,f,v){const{horizontalAlign:I,verticalAlign:k}=s.au(y);return new s.P((-(I-.5)*t/f+a[0])*v,(-(k-.5)*n/f+a[1])*v)}function Ka(y,t,n,a,f,v){const I=t.tileAnchorPoint.add(new s.P(t.translation[0],t.translation[1]));if(t.pitchWithMap){let k=a.mult(v);return n||(k=k.rotate(-f)),Ki(I.add(k),t.labelPlaneMatrix,t.getElevation).point}if(n){const k=Ce(t.tileAnchorPoint.x+1,t.tileAnchorPoint.y,t).point.sub(y),D=Math.atan(k.y/k.x)+(k.x<0?Math.PI:0);return y.add(a.rotate(D))}return y.add(a)}function Xo(y,t,n,a,f,v,I,k,D,B,G,U,K,ie){const oe=y.text.placedSymbolArray,ve=y.text.dynamicLayoutVertexArray,ce=y.icon.dynamicLayoutVertexArray,Se={};ve.clear();for(let ke=0;ke<oe.length;ke++){const pe=oe.get(ke),Fe=pe.hidden||!pe.crossTileID||y.allowVerticalPlacement&&!pe.placedOrientation?null:a[pe.crossTileID];if(Fe){const We=new s.P(pe.anchorX,pe.anchorY),Ye={getElevation:ie,width:f.width,height:f.height,labelPlaneMatrix:v,lineVertexArray:null,pitchWithMap:n,projection:G,projectionCache:null,tileAnchorPoint:We,translation:U,unwrappedTileID:K},mt=n?Ki(We,I,ie):Ce(We.x,We.y,Ye),Tt=le(f.cameraToCenterDistance,mt.signedDistanceFromCamera);let Ht=s.ai(y.textSizeData,D,pe)*Tt/s.ap;n&&(Ht*=y.tilePixelRatio/k);const{width:qt,height:Pt,anchor:kt,textOffset:Jt,textBoxScale:Ti}=Fe,zt=Za(kt,qt,Pt,Jt,Ti,Ht),Ut=G.getPitchedTextCorrection(f,We.add(new s.P(U[0],U[1])),K),yi=Ka(mt.point,Ye,t,zt,f.angle,Ut),pr=y.allowVerticalPlacement&&pe.placedOrientation===s.ah.vertical?Math.PI/2:0;for(let Ii=0;Ii<pe.numGlyphs;Ii++)s.aj(ve,yi,pr);B&&pe.associatedIconIndex>=0&&(Se[pe.associatedIconIndex]={shiftedAnchor:yi,angle:pr})}else ti(pe.numGlyphs,ve)}if(B){ce.clear();const ke=y.icon.placedSymbolArray;for(let pe=0;pe<ke.length;pe++){const Fe=ke.get(pe);if(Fe.hidden)ti(Fe.numGlyphs,ce);else{const We=Se[pe];if(We)for(let Ye=0;Ye<Fe.numGlyphs;Ye++)s.aj(ce,We.shiftedAnchor,We.angle);else ti(Fe.numGlyphs,ce)}}y.icon.dynamicLayoutVertexBuffer.updateData(ce)}y.text.dynamicLayoutVertexBuffer.updateData(ve)}function Eo(y,t,n){return n.iconsInText&&t?"symbolTextAndIcon":y?"symbolSDF":"symbolIcon"}function Hs(y,t,n,a,f,v,I,k,D,B,G,U){const K=y.context,ie=K.gl,oe=y.transform,ve=Cr(),ce=k==="map",Se=D==="map",ke=k!=="viewport"&&n.layout.get("symbol-placement")!=="point",pe=ce&&!Se&&!ke,Fe=!Se&&ke,We=!n.layout.get("symbol-sort-key").isConstant();let Ye=!1;const mt=y.depthModeForSublayer(0,Si.ReadOnly),Tt=n._unevaluatedLayout.hasValue("text-variable-anchor")||n._unevaluatedLayout.hasValue("text-variable-anchor-offset"),Ht=[],qt=ve.getCircleRadiusCorrection(oe);for(const Pt of a){const kt=t.getTile(Pt),Jt=kt.getBucket(n);if(!Jt)continue;const Ti=f?Jt.text:Jt.icon;if(!Ti||!Ti.segments.get().length||!Ti.hasVisibleVertices)continue;const zt=Ti.programConfigurations.get(n.id),Ut=f||Jt.sdfIcons,yi=f?Jt.textSizeData:Jt.iconSizeData,pr=Se||oe.pitch!==0,Ii=y.useProgram(Eo(Ut,f,Jt),zt),Di=s.ag(yi,oe.zoom),mr=y.style.map.terrain&&y.style.map.terrain.getTerrainData(Pt);let nn,es,gr,Tn,_n=[0,0],sn=null;if(f)es=kt.glyphAtlasTexture,gr=ie.LINEAR,nn=kt.glyphAtlasTexture.size,Jt.iconsInText&&(_n=kt.imageAtlasTexture.size,sn=kt.imageAtlasTexture,Tn=pr||y.options.rotating||y.options.zooming||yi.kind==="composite"||yi.kind==="camera"?ie.LINEAR:ie.NEAREST);else{const br=n.layout.get("icon-size").constantOr(0)!==1||Jt.iconsNeedLinear;es=kt.imageAtlasTexture,gr=Ut||y.options.rotating||y.options.zooming||br||pr?ie.LINEAR:ie.NEAREST,nn=kt.imageAtlasTexture.size}const on=mi(kt,1,y.transform.zoom),ts=Fe?Pt.posMatrix:Ho,Mo=Oi(ts,Se,ce,y.transform,on),rl=$i(ts,Se,ce,y.transform,on),Jo=$i(Pt.posMatrix,Se,ce,y.transform,on),ko=ve.translatePosition(y.transform,kt,v,I),nl=Tt&&Jt.hasTextData(),Ul=n.layout.get("icon-text-fit")!=="none"&&nl&&Jt.hasIconData();if(ke){const br=y.style.map.terrain?(Gl,Vr)=>y.style.map.terrain.getElevation(Pt,Gl,Vr):null,ea=n.layout.get("text-rotation-alignment")==="map";X(Jt,Pt.posMatrix,y,f,Mo,Jo,Se,B,ea,ve,Pt.toUnwrapped(),oe.width,oe.height,ko,br)}const Kr=Pt.posMatrix,is=f&&Tt||Ul,ro=ke||is?Ho:Mo,Qo=rl,an=Ut&&n.paint.get(f?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let ln;ln=Ut?Jt.iconsInText?Ha(yi.kind,Di,pe,Se,ke,is,y,Kr,ro,Qo,ko,nn,_n,qt):nr(yi.kind,Di,pe,Se,ke,is,y,Kr,ro,Qo,ko,f,nn,!0,qt):Wa(yi.kind,Di,pe,Se,ke,is,y,Kr,ro,Qo,ko,f,nn,qt);const Gr={program:Ii,buffers:Ti,uniformValues:ln,atlasTexture:es,atlasTextureIcon:sn,atlasInterpolation:gr,atlasInterpolationIcon:Tn,isSDF:Ut,hasHalo:an};if(We&&Jt.canOverlap){Ye=!0;const br=Ti.segments.get();for(const ea of br)Ht.push({segments:new s.$([ea]),sortKey:ea.sortKey,state:Gr,terrainData:mr})}else Ht.push({segments:Ti.segments,sortKey:0,state:Gr,terrainData:mr})}Ye&&Ht.sort((Pt,kt)=>Pt.sortKey-kt.sortKey);for(const Pt of Ht){const kt=Pt.state;if(K.activeTexture.set(ie.TEXTURE0),kt.atlasTexture.bind(kt.atlasInterpolation,ie.CLAMP_TO_EDGE),kt.atlasTextureIcon&&(K.activeTexture.set(ie.TEXTURE1),kt.atlasTextureIcon&&kt.atlasTextureIcon.bind(kt.atlasInterpolationIcon,ie.CLAMP_TO_EDGE)),kt.isSDF){const Jt=kt.uniformValues;kt.hasHalo&&(Jt.u_is_halo=1,Es(kt.buffers,Pt.segments,n,y,kt.program,mt,G,U,Jt,Pt.terrainData)),Jt.u_is_halo=0}Es(kt.buffers,Pt.segments,n,y,kt.program,mt,G,U,kt.uniformValues,Pt.terrainData)}}function Es(y,t,n,a,f,v,I,k,D,B){const G=a.context;f.draw(G,G.gl.TRIANGLES,v,I,k,cr.disabled,D,B,n.id,y.layoutVertexBuffer,y.indexBuffer,t,n.paint,a.transform.zoom,y.programConfigurations.get(n.id),y.dynamicLayoutVertexBuffer,y.opacityVertexBuffer)}function pn(y,t,n,a,f){if(!n||!a||!a.imageAtlas)return;const v=a.imageAtlas.patternPositions;let I=v[n.to.toString()],k=v[n.from.toString()];if(!I&&k&&(I=k),!k&&I&&(k=I),!I||!k){const D=f.getPaintProperty(t);I=v[D],k=v[D]}I&&k&&y.setConstantPatternPositions(I,k)}function Ps(y,t,n,a,f,v,I){const k=y.context.gl,D="fill-pattern",B=n.paint.get(D),G=B&&B.constantOr(1),U=n.getCrossfadeParameters();let K,ie,oe,ve,ce;I?(ie=G&&!n.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",K=k.LINES):(ie=G?"fillPattern":"fill",K=k.TRIANGLES);const Se=B.constantOr(null);for(const ke of a){const pe=t.getTile(ke);if(G&&!pe.patternsLoaded())continue;const Fe=pe.getBucket(n);if(!Fe)continue;const We=Fe.programConfigurations.get(n.id),Ye=y.useProgram(ie,We),mt=y.style.map.terrain&&y.style.map.terrain.getTerrainData(ke);G&&(y.context.activeTexture.set(k.TEXTURE0),pe.imageAtlasTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE),We.updatePaintBuffers(U)),pn(We,D,Se,pe,n);const Tt=mt?ke:null,Ht=y.translatePosMatrix(Tt?Tt.posMatrix:ke.posMatrix,pe,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor"));if(I){ve=Fe.indexBuffer2,ce=Fe.segments2;const qt=[k.drawingBufferWidth,k.drawingBufferHeight];oe=ie==="fillOutlinePattern"&&G?bt(Ht,y,U,pe,qt):Be(Ht,qt)}else ve=Fe.indexBuffer,ce=Fe.segments,oe=G?Me(Ht,y,U,pe):Pe(Ht);Ye.draw(y.context,K,f,y.stencilModeForClipping(ke),v,cr.disabled,oe,mt,n.id,Fe.layoutVertexBuffer,ve,ce,n.paint,y.transform.zoom,We)}}function Tr(y,t,n,a,f,v,I){const k=y.context,D=k.gl,B="fill-extrusion-pattern",G=n.paint.get(B),U=G.constantOr(1),K=n.getCrossfadeParameters(),ie=n.paint.get("fill-extrusion-opacity"),oe=G.constantOr(null);for(const ve of a){const ce=t.getTile(ve),Se=ce.getBucket(n);if(!Se)continue;const ke=y.style.map.terrain&&y.style.map.terrain.getTerrainData(ve),pe=Se.programConfigurations.get(n.id),Fe=y.useProgram(U?"fillExtrusionPattern":"fillExtrusion",pe);U&&(y.context.activeTexture.set(D.TEXTURE0),ce.imageAtlasTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),pe.updatePaintBuffers(K)),pn(pe,B,oe,ce,n);const We=y.translatePosMatrix(ve.posMatrix,ce,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),Ye=n.paint.get("fill-extrusion-vertical-gradient"),mt=U?_e(We,y,Ye,ie,ve,K,ce):Z(We,y,Ye,ie);Fe.draw(k,k.gl.TRIANGLES,f,v,I,cr.backCCW,mt,ke,n.id,Se.layoutVertexBuffer,Se.indexBuffer,Se.segments,n.paint,y.transform.zoom,pe,y.style.map.terrain&&Se.centroidVertexBuffer)}}function Ja(y,t,n,a,f,v,I){const k=y.context,D=k.gl,B=n.fbo;if(!B)return;const G=y.useProgram("hillshade"),U=y.style.map.terrain&&y.style.map.terrain.getTerrainData(t);k.activeTexture.set(D.TEXTURE0),D.bindTexture(D.TEXTURE_2D,B.colorAttachment.get()),G.draw(k,D.TRIANGLES,f,v,I,cr.disabled,((K,ie,oe,ve)=>{const ce=oe.paint.get("hillshade-shadow-color"),Se=oe.paint.get("hillshade-highlight-color"),ke=oe.paint.get("hillshade-accent-color");let pe=oe.paint.get("hillshade-illumination-direction")*(Math.PI/180);oe.paint.get("hillshade-illumination-anchor")==="viewport"&&(pe-=K.transform.angle);const Fe=!K.options.moving;return{u_matrix:ve?ve.posMatrix:K.transform.calculatePosMatrix(ie.tileID.toUnwrapped(),Fe),u_image:0,u_latrange:rr(0,ie.tileID),u_light:[oe.paint.get("hillshade-exaggeration"),pe],u_shadow:ce,u_highlight:Se,u_accent:ke}})(y,n,a,U?t:null),U,a.id,y.rasterBoundsBuffer,y.quadTriangleIndexBuffer,y.rasterBoundsSegments)}function fs(y,t,n,a,f,v){const I=y.context,k=I.gl,D=t.dem;if(D&&D.data){const B=D.dim,G=D.stride,U=D.getPixels();if(I.activeTexture.set(k.TEXTURE1),I.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||y.getTileTexture(G),t.demTexture){const ie=t.demTexture;ie.update(U,{premultiply:!1}),ie.bind(k.NEAREST,k.CLAMP_TO_EDGE)}else t.demTexture=new Je(I,U,k.RGBA,{premultiply:!1}),t.demTexture.bind(k.NEAREST,k.CLAMP_TO_EDGE);I.activeTexture.set(k.TEXTURE0);let K=t.fbo;if(!K){const ie=new Je(I,{width:B,height:B,data:null},k.RGBA);ie.bind(k.LINEAR,k.CLAMP_TO_EDGE),K=t.fbo=I.createFramebuffer(B,B,!0,!1),K.colorAttachment.set(ie.texture)}I.bindFramebuffer.set(K.framebuffer),I.viewport.set([0,0,B,B]),y.useProgram("hillshadePrepare").draw(I,k.TRIANGLES,a,f,v,cr.disabled,((ie,oe)=>{const ve=oe.stride,ce=s.F();return s.aO(ce,0,s.W,-s.W,0,0,1),s.H(ce,ce,[0,-s.W,0]),{u_matrix:ce,u_image:1,u_dimension:[ve,ve],u_zoom:ie.overscaledZ,u_unpack:oe.getUnpackVector()}})(t.tileID,D),null,n.id,y.rasterBoundsBuffer,y.quadTriangleIndexBuffer,y.rasterBoundsSegments),t.needsHillshadePrepare=!1}}function qo(y,t,n,a,f,v){const I=a.paint.get("raster-fade-duration");if(!v&&I>0){const k=l.now(),D=(k-y.timeAdded)/I,B=t?(k-t.timeAdded)/I:-1,G=n.getSource(),U=f.coveringZoomLevel({tileSize:G.tileSize,roundZoom:G.roundZoom}),K=!t||Math.abs(t.tileID.overscaledZ-U)>Math.abs(y.tileID.overscaledZ-U),ie=K&&y.refreshedUponExpiration?1:s.ac(K?D:1-B,0,1);return y.refreshedUponExpiration&&D>=1&&(y.refreshedUponExpiration=!1),t?{opacity:1,mix:1-ie}:{opacity:ie,mix:0}}return{opacity:1,mix:0}}const Is=new s.aP(1,0,0,1),As=new s.aP(0,1,0,1),Xs=new s.aP(0,0,1,1),qs=new s.aP(1,0,1,1),Po=new s.aP(0,1,1,1);function $o(y,t,n,a){Un(y,0,t+n/2,y.transform.width,n,a)}function Fn(y,t,n,a){Un(y,t-n/2,0,n,y.transform.height,a)}function Un(y,t,n,a,f,v){const I=y.context,k=I.gl;k.enable(k.SCISSOR_TEST),k.scissor(t*y.pixelRatio,n*y.pixelRatio,a*y.pixelRatio,f*y.pixelRatio),I.clear({color:v}),k.disable(k.SCISSOR_TEST)}function Qa(y,t,n){const a=y.context,f=a.gl,v=n.posMatrix,I=y.useProgram("debug"),k=Si.disabled,D=Xi.disabled,B=y.colorModeForRenderPass(),G="$debug",U=y.style.map.terrain&&y.style.map.terrain.getTerrainData(n);a.activeTexture.set(f.TEXTURE0);const K=t.getTileByID(n.key).latestRawTileData,ie=Math.floor((K&&K.byteLength||0)/1024),oe=t.getTile(n).tileSize,ve=512/Math.min(oe,512)*(n.overscaledZ/y.transform.zoom)*.5;let ce=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(ce+=` => ${n.overscaledZ}`),function(Se,ke){Se.initDebugOverlayCanvas();const pe=Se.debugOverlayCanvas,Fe=Se.context.gl,We=Se.debugOverlayCanvas.getContext("2d");We.clearRect(0,0,pe.width,pe.height),We.shadowColor="white",We.shadowBlur=2,We.lineWidth=1.5,We.strokeStyle="white",We.textBaseline="top",We.font="bold 36px Open Sans, sans-serif",We.fillText(ke,5,5),We.strokeText(ke,5,5),Se.debugOverlayTexture.update(pe),Se.debugOverlayTexture.bind(Fe.LINEAR,Fe.CLAMP_TO_EDGE)}(y,`${ce} ${ie}kB`),I.draw(a,f.TRIANGLES,k,D,Ji.alphaBlended,cr.disabled,Nt(v,s.aP.transparent,ve),null,G,y.debugBuffer,y.quadTriangleIndexBuffer,y.debugSegments),I.draw(a,f.LINE_STRIP,k,D,B,cr.disabled,Nt(v,s.aP.red),U,G,y.debugBuffer,y.tileBorderIndexBuffer,y.debugSegments)}function je(y,t,n){const a=y.context,f=a.gl,v=y.colorModeForRenderPass(),I=new Si(f.LEQUAL,Si.ReadWrite,y.depthRangeFor3D),k=y.useProgram("terrain"),D=t.getTerrainMesh();a.bindFramebuffer.set(null),a.viewport.set([0,0,y.width,y.height]);for(const B of n){const G=y.renderToTexture.getTexture(B),U=t.getTerrainData(B.tileID);a.activeTexture.set(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,G.texture);const K={u_matrix:y.transform.calculatePosMatrix(B.tileID.toUnwrapped()),u_texture:0,u_ele_delta:t.getMeshFrameDelta(y.transform.zoom)};k.draw(a,f.TRIANGLES,I,Xi.disabled,v,cr.backCCW,K,U,"terrain",D.vertexBuffer,D.indexBuffer,D.segments)}}class qe{constructor(t,n){this.context=new Ln(t),this.transform=n,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:s.an(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=Ct.maxUnderzooming+Ct.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new vr}resize(t,n,a){if(this.width=Math.floor(t*a),this.height=Math.floor(n*a),this.pixelRatio=a,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const f of this.style._order)this.style._layers[f].resize()}setup(){const t=this.context,n=new s.aW;n.emplaceBack(0,0),n.emplaceBack(s.W,0),n.emplaceBack(0,s.W),n.emplaceBack(s.W,s.W),this.tileExtentBuffer=t.createVertexBuffer(n,On.members),this.tileExtentSegments=s.$.simpleSegment(0,0,4,2);const a=new s.aW;a.emplaceBack(0,0),a.emplaceBack(s.W,0),a.emplaceBack(0,s.W),a.emplaceBack(s.W,s.W),this.debugBuffer=t.createVertexBuffer(a,On.members),this.debugSegments=s.$.simpleSegment(0,0,4,5);const f=new s.Z;f.emplaceBack(0,0,0,0),f.emplaceBack(s.W,0,s.W,0),f.emplaceBack(0,s.W,0,s.W),f.emplaceBack(s.W,s.W,s.W,s.W),this.rasterBoundsBuffer=t.createVertexBuffer(f,Lt.members),this.rasterBoundsSegments=s.$.simpleSegment(0,0,4,2);const v=new s.aW;v.emplaceBack(0,0),v.emplaceBack(1,0),v.emplaceBack(0,1),v.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(v,On.members),this.viewportSegments=s.$.simpleSegment(0,0,4,2);const I=new s.aX;I.emplaceBack(0),I.emplaceBack(1),I.emplaceBack(3),I.emplaceBack(2),I.emplaceBack(0),this.tileBorderIndexBuffer=t.createIndexBuffer(I);const k=new s.aY;k.emplaceBack(0,1,2),k.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(k);const D=this.context.gl;this.stencilClearMode=new Xi({func:D.ALWAYS,mask:0},0,255,D.ZERO,D.ZERO,D.ZERO)}clearStencil(){const t=this.context,n=t.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const a=s.F();s.aO(a,0,this.width,this.height,0,0,1),s.J(a,a,[n.drawingBufferWidth,n.drawingBufferHeight,0]),this.useProgram("clippingMask").draw(t,n.TRIANGLES,Si.disabled,this.stencilClearMode,Ji.disabled,cr.disabled,Dt(a),null,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(t,n){if(this.currentStencilSource===t.source||!t.isTileClipped()||!n||!n.length)return;this.currentStencilSource=t.source;const a=this.context,f=a.gl;this.nextStencilID+n.length>256&&this.clearStencil(),a.setColorMode(Ji.disabled),a.setDepthMode(Si.disabled);const v=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const I of n){const k=this._tileClippingMaskIDs[I.key]=this.nextStencilID++,D=this.style.map.terrain&&this.style.map.terrain.getTerrainData(I);v.draw(a,f.TRIANGLES,Si.disabled,new Xi({func:f.ALWAYS,mask:0},k,255,f.KEEP,f.KEEP,f.REPLACE),Ji.disabled,cr.disabled,Dt(I.posMatrix),D,"$clipping",this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,n=this.context.gl;return new Xi({func:n.NOTEQUAL,mask:255},t,255,n.KEEP,n.KEEP,n.REPLACE)}stencilModeForClipping(t){const n=this.context.gl;return new Xi({func:n.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,n.KEEP,n.KEEP,n.REPLACE)}stencilConfigForOverlap(t){const n=this.context.gl,a=t.sort((I,k)=>k.overscaledZ-I.overscaledZ),f=a[a.length-1].overscaledZ,v=a[0].overscaledZ-f+1;if(v>1){this.currentStencilSource=void 0,this.nextStencilID+v>256&&this.clearStencil();const I={};for(let k=0;k<v;k++)I[k+f]=new Xi({func:n.GEQUAL,mask:255},k+this.nextStencilID,255,n.KEEP,n.KEEP,n.REPLACE);return this.nextStencilID+=v,[I,a]}return[{[f]:Xi.disabled},a]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new Ji([t.CONSTANT_COLOR,t.ONE],new s.aP(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Ji.unblended:Ji.alphaBlended}depthModeForSublayer(t,n,a){if(!this.opaquePassEnabledForLayer())return Si.disabled;const f=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new Si(a||this.context.gl.LEQUAL,n,[f,f])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(t,n){this.style=t,this.options=n,this.lineAtlas=t.lineAtlas,this.imageManager=t.imageManager,this.glyphManager=t.glyphManager,this.symbolFadeChange=t.placement.symbolFadeChange(l.now()),this.imageManager.beginFrame();const a=this.style._order,f=this.style.sourceCaches,v={},I={},k={};for(const D in f){const B=f[D];B.used&&B.prepare(this.context),v[D]=B.getVisibleCoordinates(),I[D]=v[D].slice().reverse(),k[D]=B.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let D=0;D<a.length;D++)if(this.style._layers[a[D]].is3D()){this.opaquePassCutoff=D;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const D of a){const B=this.style._layers[D];if(!B.hasOffscreenPass()||B.isHidden(this.transform.zoom))continue;const G=I[B.source];(B.type==="custom"||G.length)&&this.renderLayer(this,f[B.source],B,G)}if(this.context.bindFramebuffer.set(null),this.context.clear({color:n.showOverdrawInspector?s.aP.black:s.aP.transparent,depth:1}),this.clearStencil(),this._showOverdrawInspector=n.showOverdrawInspector,this.depthRangeFor3D=[0,1-(t._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=a.length-1;this.currentLayer>=0;this.currentLayer--){const D=this.style._layers[a[this.currentLayer]],B=f[D.source],G=v[D.source];this._renderTileClippingMasks(D,G),this.renderLayer(this,B,D,G)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<a.length;this.currentLayer++){const D=this.style._layers[a[this.currentLayer]],B=f[D.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(D))continue;const G=(D.type==="symbol"?k:I)[D.source];this._renderTileClippingMasks(D,v[D.source]),this.renderLayer(this,B,D,G)}if(this.options.showTileBoundaries){const D=function(B,G){let U=null;const K=Object.values(B._layers).flatMap(ce=>ce.source&&!ce.isHidden(G)?[B.sourceCaches[ce.source]]:[]),ie=K.filter(ce=>ce.getSource().type==="vector"),oe=K.filter(ce=>ce.getSource().type!=="vector"),ve=ce=>{(!U||U.getSource().maxzoom<ce.getSource().maxzoom)&&(U=ce)};return ie.forEach(ce=>ve(ce)),U||oe.forEach(ce=>ve(ce)),U}(this.style,this.transform.zoom);D&&function(B,G,U){for(let K=0;K<U.length;K++)Qa(B,G,U[K])}(this,D,D.getVisibleCoordinates())}this.options.showPadding&&function(D){const B=D.transform.padding;$o(D,D.transform.height-(B.top||0),3,Is),$o(D,B.bottom||0,3,As),Fn(D,B.left||0,3,Xs),Fn(D,D.transform.width-(B.right||0),3,qs);const G=D.transform.centerPoint;(function(U,K,ie,oe){Un(U,K-1,ie-10,2,20,oe),Un(U,K-10,ie-1,20,2,oe)})(D,G.x,D.transform.height-G.y,Po)}(this),this.context.setDefault()}maybeDrawDepthAndCoords(t){if(!this.style||!this.style.map||!this.style.map.terrain)return;const n=this.terrainFacilitator.matrix,a=this.transform.modelViewProjectionMatrix;let f=this.terrainFacilitator.dirty;f||(f=t?!s.aZ(n,a):!s.a_(n,a)),f||(f=this.style.map.terrain.sourceCache.tilesAfterTime(this.terrainFacilitator.renderTime).length>0),f&&(s.a$(n,a),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(v,I){const k=v.context,D=k.gl,B=Ji.unblended,G=new Si(D.LEQUAL,Si.ReadWrite,[0,1]),U=I.getTerrainMesh(),K=I.sourceCache.getRenderableTiles(),ie=v.useProgram("terrainDepth");k.bindFramebuffer.set(I.getFramebuffer("depth").framebuffer),k.viewport.set([0,0,v.width/devicePixelRatio,v.height/devicePixelRatio]),k.clear({color:s.aP.transparent,depth:1});for(const oe of K){const ve=I.getTerrainData(oe.tileID),ce={u_matrix:v.transform.calculatePosMatrix(oe.tileID.toUnwrapped()),u_ele_delta:I.getMeshFrameDelta(v.transform.zoom)};ie.draw(k,D.TRIANGLES,G,Xi.disabled,B,cr.backCCW,ce,ve,"terrain",U.vertexBuffer,U.indexBuffer,U.segments)}k.bindFramebuffer.set(null),k.viewport.set([0,0,v.width,v.height])}(this,this.style.map.terrain),function(v,I){const k=v.context,D=k.gl,B=Ji.unblended,G=new Si(D.LEQUAL,Si.ReadWrite,[0,1]),U=I.getTerrainMesh(),K=I.getCoordsTexture(),ie=I.sourceCache.getRenderableTiles(),oe=v.useProgram("terrainCoords");k.bindFramebuffer.set(I.getFramebuffer("coords").framebuffer),k.viewport.set([0,0,v.width/devicePixelRatio,v.height/devicePixelRatio]),k.clear({color:s.aP.transparent,depth:1}),I.coordsIndex=[];for(const ve of ie){const ce=I.getTerrainData(ve.tileID);k.activeTexture.set(D.TEXTURE0),D.bindTexture(D.TEXTURE_2D,K.texture);const Se={u_matrix:v.transform.calculatePosMatrix(ve.tileID.toUnwrapped()),u_terrain_coords_id:(255-I.coordsIndex.length)/255,u_texture:0,u_ele_delta:I.getMeshFrameDelta(v.transform.zoom)};oe.draw(k,D.TRIANGLES,G,Xi.disabled,B,cr.backCCW,Se,ce,"terrain",U.vertexBuffer,U.indexBuffer,U.segments),I.coordsIndex.push(ve.tileID.key)}k.bindFramebuffer.set(null),k.viewport.set([0,0,v.width,v.height])}(this,this.style.map.terrain))}renderLayer(t,n,a,f){if(!a.isHidden(this.transform.zoom)&&(a.type==="background"||a.type==="custom"||(f||[]).length))switch(this.id=a.id,a.type){case"symbol":(function(v,I,k,D,B){if(v.renderPass!=="translucent")return;const G=Xi.disabled,U=v.colorModeForRenderPass();(k._unevaluatedLayout.hasValue("text-variable-anchor")||k._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(K,ie,oe,ve,ce,Se,ke,pe,Fe){const We=ie.transform,Ye=Cr(),mt=ce==="map",Tt=Se==="map";for(const Ht of K){const qt=ve.getTile(Ht),Pt=qt.getBucket(oe);if(!Pt||!Pt.text||!Pt.text.segments.get().length)continue;const kt=s.ag(Pt.textSizeData,We.zoom),Jt=mi(qt,1,ie.transform.zoom),Ti=Oi(Ht.posMatrix,Tt,mt,ie.transform,Jt),zt=oe.layout.get("icon-text-fit")!=="none"&&Pt.hasIconData();if(kt){const Ut=Math.pow(2,We.zoom-qt.tileID.overscaledZ),yi=ie.style.map.terrain?(Ii,Di)=>ie.style.map.terrain.getElevation(Ht,Ii,Di):null,pr=Ye.translatePosition(We,qt,ke,pe);Xo(Pt,mt,Tt,Fe,We,Ti,Ht.posMatrix,Ut,kt,zt,Ye,pr,Ht.toUnwrapped(),yi)}}}(D,v,k,I,k.layout.get("text-rotation-alignment"),k.layout.get("text-pitch-alignment"),k.paint.get("text-translate"),k.paint.get("text-translate-anchor"),B),k.paint.get("icon-opacity").constantOr(1)!==0&&Hs(v,I,k,D,!1,k.paint.get("icon-translate"),k.paint.get("icon-translate-anchor"),k.layout.get("icon-rotation-alignment"),k.layout.get("icon-pitch-alignment"),k.layout.get("icon-keep-upright"),G,U),k.paint.get("text-opacity").constantOr(1)!==0&&Hs(v,I,k,D,!0,k.paint.get("text-translate"),k.paint.get("text-translate-anchor"),k.layout.get("text-rotation-alignment"),k.layout.get("text-pitch-alignment"),k.layout.get("text-keep-upright"),G,U),I.map.showCollisionBoxes&&(Ws(v,I,k,D,!0),Ws(v,I,k,D,!1))})(t,n,a,f,this.style.placement.variableOffsets);break;case"circle":(function(v,I,k,D){if(v.renderPass!=="translucent")return;const B=k.paint.get("circle-opacity"),G=k.paint.get("circle-stroke-width"),U=k.paint.get("circle-stroke-opacity"),K=!k.layout.get("circle-sort-key").isConstant();if(B.constantOr(1)===0&&(G.constantOr(1)===0||U.constantOr(1)===0))return;const ie=v.context,oe=ie.gl,ve=v.depthModeForSublayer(0,Si.ReadOnly),ce=Xi.disabled,Se=v.colorModeForRenderPass(),ke=[];for(let pe=0;pe<D.length;pe++){const Fe=D[pe],We=I.getTile(Fe),Ye=We.getBucket(k);if(!Ye)continue;const mt=Ye.programConfigurations.get(k.id),Tt=v.useProgram("circle",mt),Ht=Ye.layoutVertexBuffer,qt=Ye.indexBuffer,Pt=v.style.map.terrain&&v.style.map.terrain.getTerrainData(Fe),kt={programConfiguration:mt,program:Tt,layoutVertexBuffer:Ht,indexBuffer:qt,uniformValues:It(v,Fe,We,k),terrainData:Pt};if(K){const Jt=Ye.segments.get();for(const Ti of Jt)ke.push({segments:new s.$([Ti]),sortKey:Ti.sortKey,state:kt})}else ke.push({segments:Ye.segments,sortKey:0,state:kt})}K&&ke.sort((pe,Fe)=>pe.sortKey-Fe.sortKey);for(const pe of ke){const{programConfiguration:Fe,program:We,layoutVertexBuffer:Ye,indexBuffer:mt,uniformValues:Tt,terrainData:Ht}=pe.state;We.draw(ie,oe.TRIANGLES,ve,ce,Se,cr.disabled,Tt,Ht,k.id,Ye,mt,pe.segments,k.paint,v.transform.zoom,Fe)}})(t,n,a,f);break;case"heatmap":(function(v,I,k,D){if(k.paint.get("heatmap-opacity")!==0)if(v.renderPass==="offscreen"){const B=v.context,G=B.gl,U=Xi.disabled,K=new Ji([G.ONE,G.ONE],s.aP.transparent,[!0,!0,!0,!0]);(function(ie,oe,ve){const ce=ie.gl;ie.activeTexture.set(ce.TEXTURE1),ie.viewport.set([0,0,oe.width/4,oe.height/4]);let Se=ve.heatmapFbo;if(Se)ce.bindTexture(ce.TEXTURE_2D,Se.colorAttachment.get()),ie.bindFramebuffer.set(Se.framebuffer);else{const ke=ce.createTexture();ce.bindTexture(ce.TEXTURE_2D,ke),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_WRAP_S,ce.CLAMP_TO_EDGE),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_WRAP_T,ce.CLAMP_TO_EDGE),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_MIN_FILTER,ce.LINEAR),ce.texParameteri(ce.TEXTURE_2D,ce.TEXTURE_MAG_FILTER,ce.LINEAR),Se=ve.heatmapFbo=ie.createFramebuffer(oe.width/4,oe.height/4,!1,!1),function(pe,Fe,We,Ye){var mt,Tt;const Ht=pe.gl,qt=(mt=pe.HALF_FLOAT)!==null&&mt!==void 0?mt:Ht.UNSIGNED_BYTE,Pt=(Tt=pe.RGBA16F)!==null&&Tt!==void 0?Tt:Ht.RGBA;Ht.texImage2D(Ht.TEXTURE_2D,0,Pt,Fe.width/4,Fe.height/4,0,Ht.RGBA,qt,null),Ye.colorAttachment.set(We)}(ie,oe,ke,Se)}})(B,v,k),B.clear({color:s.aP.transparent});for(let ie=0;ie<D.length;ie++){const oe=D[ie];if(I.hasRenderableParent(oe))continue;const ve=I.getTile(oe),ce=ve.getBucket(k);if(!ce)continue;const Se=ce.programConfigurations.get(k.id),ke=v.useProgram("heatmap",Se),{zoom:pe}=v.transform;ke.draw(B,G.TRIANGLES,Si.disabled,U,K,cr.disabled,_i(oe.posMatrix,ve,pe,k.paint.get("heatmap-intensity")),null,k.id,ce.layoutVertexBuffer,ce.indexBuffer,ce.segments,k.paint,v.transform.zoom,Se)}B.viewport.set([0,0,v.width,v.height])}else v.renderPass==="translucent"&&(v.context.setColorMode(v.colorModeForRenderPass()),function(B,G){const U=B.context,K=U.gl,ie=G.heatmapFbo;if(!ie)return;U.activeTexture.set(K.TEXTURE0),K.bindTexture(K.TEXTURE_2D,ie.colorAttachment.get()),U.activeTexture.set(K.TEXTURE1);let oe=G.colorRampTexture;oe||(oe=G.colorRampTexture=new Je(U,G.colorRamp,K.RGBA)),oe.bind(K.LINEAR,K.CLAMP_TO_EDGE),B.useProgram("heatmapTexture").draw(U,K.TRIANGLES,Si.disabled,Xi.disabled,B.colorModeForRenderPass(),cr.disabled,((ve,ce,Se,ke)=>{const pe=s.F();s.aO(pe,0,ve.width,ve.height,0,0,1);const Fe=ve.context.gl;return{u_matrix:pe,u_world:[Fe.drawingBufferWidth,Fe.drawingBufferHeight],u_image:0,u_color_ramp:1,u_opacity:ce.paint.get("heatmap-opacity")}})(B,G),null,G.id,B.viewportBuffer,B.quadTriangleIndexBuffer,B.viewportSegments,G.paint,B.transform.zoom)}(v,k))})(t,n,a,f);break;case"line":(function(v,I,k,D){if(v.renderPass!=="translucent")return;const B=k.paint.get("line-opacity"),G=k.paint.get("line-width");if(B.constantOr(1)===0||G.constantOr(1)===0)return;const U=v.depthModeForSublayer(0,Si.ReadOnly),K=v.colorModeForRenderPass(),ie=k.paint.get("line-dasharray"),oe=k.paint.get("line-pattern"),ve=oe.constantOr(1),ce=k.paint.get("line-gradient"),Se=k.getCrossfadeParameters(),ke=ve?"linePattern":ie?"lineSDF":ce?"lineGradient":"line",pe=v.context,Fe=pe.gl;let We=!0;for(const Ye of D){const mt=I.getTile(Ye);if(ve&&!mt.patternsLoaded())continue;const Tt=mt.getBucket(k);if(!Tt)continue;const Ht=Tt.programConfigurations.get(k.id),qt=v.context.program.get(),Pt=v.useProgram(ke,Ht),kt=We||Pt.program!==qt,Jt=v.style.map.terrain&&v.style.map.terrain.getTerrainData(Ye),Ti=oe.constantOr(null);if(Ti&&mt.imageAtlas){const yi=mt.imageAtlas,pr=yi.patternPositions[Ti.to.toString()],Ii=yi.patternPositions[Ti.from.toString()];pr&&Ii&&Ht.setConstantPatternPositions(pr,Ii)}const zt=Jt?Ye:null,Ut=ve?yt(v,mt,k,Se,zt):ie?ii(v,mt,k,ie,Se,zt):ce?ji(v,mt,k,Tt.lineClipsArray.length,zt):fi(v,mt,k,zt);if(ve)pe.activeTexture.set(Fe.TEXTURE0),mt.imageAtlasTexture.bind(Fe.LINEAR,Fe.CLAMP_TO_EDGE),Ht.updatePaintBuffers(Se);else if(ie&&(kt||v.lineAtlas.dirty))pe.activeTexture.set(Fe.TEXTURE0),v.lineAtlas.bind(pe);else if(ce){const yi=Tt.gradients[k.id];let pr=yi.texture;if(k.gradientVersion!==yi.version){let Ii=256;if(k.stepInterpolant){const Di=I.getSource().maxzoom,mr=Ye.canonical.z===Di?Math.ceil(1<<v.transform.maxZoom-Ye.canonical.z):1;Ii=s.ac(s.aU(Tt.maxLineLength/s.W*1024*mr),256,pe.maxTextureSize)}yi.gradient=s.aV({expression:k.gradientExpression(),evaluationKey:"lineProgress",resolution:Ii,image:yi.gradient||void 0,clips:Tt.lineClipsArray}),yi.texture?yi.texture.update(yi.gradient):yi.texture=new Je(pe,yi.gradient,Fe.RGBA),yi.version=k.gradientVersion,pr=yi.texture}pe.activeTexture.set(Fe.TEXTURE0),pr.bind(k.stepInterpolant?Fe.NEAREST:Fe.LINEAR,Fe.CLAMP_TO_EDGE)}Pt.draw(pe,Fe.TRIANGLES,U,v.stencilModeForClipping(Ye),K,cr.disabled,Ut,Jt,k.id,Tt.layoutVertexBuffer,Tt.indexBuffer,Tt.segments,k.paint,v.transform.zoom,Ht,Tt.layoutVertexBuffer2),We=!1}})(t,n,a,f);break;case"fill":(function(v,I,k,D){const B=k.paint.get("fill-color"),G=k.paint.get("fill-opacity");if(G.constantOr(1)===0)return;const U=v.colorModeForRenderPass(),K=k.paint.get("fill-pattern"),ie=v.opaquePassEnabledForLayer()&&!K.constantOr(1)&&B.constantOr(s.aP.transparent).a===1&&G.constantOr(0)===1?"opaque":"translucent";if(v.renderPass===ie){const oe=v.depthModeForSublayer(1,v.renderPass==="opaque"?Si.ReadWrite:Si.ReadOnly);Ps(v,I,k,D,oe,U,!1)}if(v.renderPass==="translucent"&&k.paint.get("fill-antialias")){const oe=v.depthModeForSublayer(k.getPaintProperty("fill-outline-color")?2:0,Si.ReadOnly);Ps(v,I,k,D,oe,U,!0)}})(t,n,a,f);break;case"fill-extrusion":(function(v,I,k,D){const B=k.paint.get("fill-extrusion-opacity");if(B!==0&&v.renderPass==="translucent"){const G=new Si(v.context.gl.LEQUAL,Si.ReadWrite,v.depthRangeFor3D);if(B!==1||k.paint.get("fill-extrusion-pattern").constantOr(1))Tr(v,I,k,D,G,Xi.disabled,Ji.disabled),Tr(v,I,k,D,G,v.stencilModeFor3D(),v.colorModeForRenderPass());else{const U=v.colorModeForRenderPass();Tr(v,I,k,D,G,Xi.disabled,U)}}})(t,n,a,f);break;case"hillshade":(function(v,I,k,D){if(v.renderPass!=="offscreen"&&v.renderPass!=="translucent")return;const B=v.context,G=v.depthModeForSublayer(0,Si.ReadOnly),U=v.colorModeForRenderPass(),[K,ie]=v.renderPass==="translucent"?v.stencilConfigForOverlap(D):[{},D];for(const oe of ie){const ve=I.getTile(oe);ve.needsHillshadePrepare!==void 0&&ve.needsHillshadePrepare&&v.renderPass==="offscreen"?fs(v,ve,k,G,Xi.disabled,U):v.renderPass==="translucent"&&Ja(v,oe,ve,k,G,K[oe.overscaledZ],U)}B.viewport.set([0,0,v.width,v.height])})(t,n,a,f);break;case"raster":(function(v,I,k,D){if(v.renderPass!=="translucent"||k.paint.get("raster-opacity")===0||!D.length)return;const B=v.context,G=B.gl,U=I.getSource(),K=v.useProgram("raster"),ie=v.colorModeForRenderPass(),[oe,ve]=U instanceof $t?[{},D]:v.stencilConfigForOverlap(D),ce=ve[ve.length-1].overscaledZ,Se=!v.options.moving;for(const ke of ve){const pe=v.depthModeForSublayer(ke.overscaledZ-ce,k.paint.get("raster-opacity")===1?Si.ReadWrite:Si.ReadOnly,G.LESS),Fe=I.getTile(ke);Fe.registerFadeDuration(k.paint.get("raster-fade-duration"));const We=I.findLoadedParent(ke,0),Ye=I.findLoadedSibling(ke),mt=qo(Fe,We||Ye||null,I,k,v.transform,v.style.map.terrain);let Tt,Ht;const qt=k.paint.get("raster-resampling")==="nearest"?G.NEAREST:G.LINEAR;B.activeTexture.set(G.TEXTURE0),Fe.texture.bind(qt,G.CLAMP_TO_EDGE,G.LINEAR_MIPMAP_NEAREST),B.activeTexture.set(G.TEXTURE1),We?(We.texture.bind(qt,G.CLAMP_TO_EDGE,G.LINEAR_MIPMAP_NEAREST),Tt=Math.pow(2,We.tileID.overscaledZ-Fe.tileID.overscaledZ),Ht=[Fe.tileID.canonical.x*Tt%1,Fe.tileID.canonical.y*Tt%1]):Fe.texture.bind(qt,G.CLAMP_TO_EDGE,G.LINEAR_MIPMAP_NEAREST);const Pt=v.style.map.terrain&&v.style.map.terrain.getTerrainData(ke),kt=Pt?ke:null,Jt=kt?kt.posMatrix:v.transform.calculatePosMatrix(ke.toUnwrapped(),Se),Ti=lr(Jt,Ht||[0,0],Tt||1,mt,k);U instanceof $t?K.draw(B,G.TRIANGLES,pe,Xi.disabled,ie,cr.disabled,Ti,Pt,k.id,U.boundsBuffer,v.quadTriangleIndexBuffer,U.boundsSegments):K.draw(B,G.TRIANGLES,pe,oe[ke.overscaledZ],ie,cr.disabled,Ti,Pt,k.id,v.rasterBoundsBuffer,v.quadTriangleIndexBuffer,v.rasterBoundsSegments)}})(t,n,a,f);break;case"background":(function(v,I,k,D){const B=k.paint.get("background-color"),G=k.paint.get("background-opacity");if(G===0)return;const U=v.context,K=U.gl,ie=v.transform,oe=ie.tileSize,ve=k.paint.get("background-pattern");if(v.isPatternMissing(ve))return;const ce=!ve&&B.a===1&&G===1&&v.opaquePassEnabledForLayer()?"opaque":"translucent";if(v.renderPass!==ce)return;const Se=Xi.disabled,ke=v.depthModeForSublayer(0,ce==="opaque"?Si.ReadWrite:Si.ReadOnly),pe=v.colorModeForRenderPass(),Fe=v.useProgram(ve?"backgroundPattern":"background"),We=D||ie.coveringTiles({tileSize:oe,terrain:v.style.map.terrain});ve&&(U.activeTexture.set(K.TEXTURE0),v.imageManager.bind(v.context));const Ye=k.getCrossfadeParameters();for(const mt of We){const Tt=D?mt.posMatrix:v.transform.calculatePosMatrix(mt.toUnwrapped()),Ht=ve?Zn(Tt,G,v,ve,{tileID:mt,tileSize:oe},Ye):El(Tt,G,B),qt=v.style.map.terrain&&v.style.map.terrain.getTerrainData(mt);Fe.draw(U,K.TRIANGLES,ke,Se,pe,cr.disabled,Ht,qt,k.id,v.tileExtentBuffer,v.quadTriangleIndexBuffer,v.tileExtentSegments)}})(t,0,a,f);break;case"custom":(function(v,I,k){const D=v.context,B=k.implementation;if(v.renderPass==="offscreen"){const G=B.prerender;G&&(v.setCustomLayerDefaults(),D.setColorMode(v.colorModeForRenderPass()),G.call(B,D.gl,v.transform.customLayerMatrix()),D.setDirty(),v.setBaseState())}else if(v.renderPass==="translucent"){v.setCustomLayerDefaults(),D.setColorMode(v.colorModeForRenderPass()),D.setStencilMode(Xi.disabled);const G=B.renderingMode==="3d"?new Si(v.context.gl.LEQUAL,Si.ReadWrite,v.depthRangeFor3D):v.depthModeForSublayer(0,Si.ReadOnly);D.setDepthMode(G),B.render(D.gl,v.transform.customLayerMatrix()),D.setDirty(),v.setBaseState(),D.bindFramebuffer.set(null)}})(t,0,a)}}translatePosMatrix(t,n,a,f,v){if(!a[0]&&!a[1])return t;const I=v?f==="map"?this.transform.angle:0:f==="viewport"?-this.transform.angle:0;if(I){const B=Math.sin(I),G=Math.cos(I);a=[a[0]*G-a[1]*B,a[0]*B+a[1]*G]}const k=[v?a[0]:mi(n,a[0],this.transform.zoom),v?a[1]:mi(n,a[1],this.transform.zoom),0],D=new Float32Array(16);return s.H(D,t,k),D}saveTileTexture(t){const n=this._tileTextures[t.size[0]];n?n.push(t):this._tileTextures[t.size[0]]=[t]}getTileTexture(t){const n=this._tileTextures[t];return n&&n.length>0?n.pop():null}isPatternMissing(t){if(!t)return!1;if(!t.from||!t.to)return!0;const n=this.imageManager.getPattern(t.from.toString()),a=this.imageManager.getPattern(t.to.toString());return!n||!a}useProgram(t,n){this.cache=this.cache||{};const a=t+(n?n.cacheKey:"")+(this._showOverdrawInspector?"/overdraw":"")+(this.style.map.terrain?"/terrain":"");return this.cache[a]||(this.cache[a]=new P(this.context,Rs[t],n,_o[t],this._showOverdrawInspector,this.style.map.terrain)),this.cache[a]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new Je(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){const{drawingBufferWidth:t,drawingBufferHeight:n}=this.context.gl;return this.width!==t||this.height!==n}}class Ft{constructor(t,n){this.points=t,this.planes=n}static fromInvProjectionMatrix(t,n,a){const f=Math.pow(2,a),v=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(k=>{const D=1/(k=s.af([],k,t))[3]/n*f;return s.b0(k,k,[D,D,1/k[3],D])}),I=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(k=>{const D=function(K,ie){var oe=ie[0],ve=ie[1],ce=ie[2],Se=oe*oe+ve*ve+ce*ce;return Se>0&&(Se=1/Math.sqrt(Se)),K[0]=ie[0]*Se,K[1]=ie[1]*Se,K[2]=ie[2]*Se,K}([],function(K,ie,oe){var ve=ie[0],ce=ie[1],Se=ie[2],ke=oe[0],pe=oe[1],Fe=oe[2];return K[0]=ce*Fe-Se*pe,K[1]=Se*ke-ve*Fe,K[2]=ve*pe-ce*ke,K}([],ne([],v[k[0]],v[k[1]]),ne([],v[k[2]],v[k[1]]))),B=-((G=D)[0]*(U=v[k[1]])[0]+G[1]*U[1]+G[2]*U[2]);var G,U;return D.concat(B)});return new Ft(v,I)}}class ci{constructor(t,n){this.min=t,this.max=n,this.center=function(a,f,v){return a[0]=.5*f[0],a[1]=.5*f[1],a[2]=.5*f[2],a}([],function(a,f,v){return a[0]=f[0]+v[0],a[1]=f[1]+v[1],a[2]=f[2]+v[2],a}([],this.min,this.max))}quadrant(t){const n=[t%2==0,t<2],a=V(this.min),f=V(this.max);for(let v=0;v<n.length;v++)a[v]=n[v]?this.min[v]:this.center[v],f[v]=n[v]?this.center[v]:this.max[v];return f[2]=this.max[2],new ci(a,f)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}intersects(t){const n=[[this.min[0],this.min[1],this.min[2],1],[this.max[0],this.min[1],this.min[2],1],[this.max[0],this.max[1],this.min[2],1],[this.min[0],this.max[1],this.min[2],1],[this.min[0],this.min[1],this.max[2],1],[this.max[0],this.min[1],this.max[2],1],[this.max[0],this.max[1],this.max[2],1],[this.min[0],this.max[1],this.max[2],1]];let a=!0;for(let f=0;f<t.planes.length;f++){const v=t.planes[f];let I=0;for(let k=0;k<n.length;k++)s.b1(v,n[k])>=0&&I++;if(I===0)return 0;I!==n.length&&(a=!1)}if(a)return 2;for(let f=0;f<3;f++){let v=Number.MAX_VALUE,I=-Number.MAX_VALUE;for(let k=0;k<t.points.length;k++){const D=t.points[k][f]-this.min[f];v=Math.min(v,D),I=Math.max(I,D)}if(I<0||v>this.max[f]-this.min[f])return 0}return 1}}class Yi{constructor(t=0,n=0,a=0,f=0){if(isNaN(t)||t<0||isNaN(n)||n<0||isNaN(a)||a<0||isNaN(f)||f<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=n,this.left=a,this.right=f}interpolate(t,n,a){return n.top!=null&&t.top!=null&&(this.top=s.z.number(t.top,n.top,a)),n.bottom!=null&&t.bottom!=null&&(this.bottom=s.z.number(t.bottom,n.bottom,a)),n.left!=null&&t.left!=null&&(this.left=s.z.number(t.left,n.left,a)),n.right!=null&&t.right!=null&&(this.right=s.z.number(t.right,n.right,a)),this}getCenter(t,n){const a=s.ac((this.left+t-this.right)/2,0,t),f=s.ac((this.top+n-this.bottom)/2,0,n);return new s.P(a,f)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Yi(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const ki=85.051129;class fr{constructor(t,n,a,f,v){this.tileSize=512,this._renderWorldCopies=v===void 0||!!v,this._minZoom=t||0,this._maxZoom=n||22,this._minPitch=a??0,this._maxPitch=f??60,this.setMaxBounds(),this.width=0,this.height=0,this._center=new s.M(0,0),this._elevation=0,this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._unmodified=!0,this._edgeInsets=new Yi,this._posMatrixCache={},this._alignedPosMatrixCache={},this.minElevationForCurrentTile=0}clone(){const t=new fr(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return t.apply(this),t}apply(t){this.tileSize=t.tileSize,this.latRange=t.latRange,this.width=t.width,this.height=t.height,this._center=t._center,this._elevation=t._elevation,this.minElevationForCurrentTile=t.minElevationForCurrentTile,this.zoom=t.zoom,this.angle=t.angle,this._fov=t._fov,this._pitch=t._pitch,this._unmodified=t._unmodified,this._edgeInsets=t._edgeInsets.clone(),this._calcMatrices()}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this.width,this.height)}get bearing(){return-this.angle/Math.PI*180}set bearing(t){const n=-s.b2(t,-180,180)*Math.PI/180;this.angle!==n&&(this._unmodified=!1,this.angle=n,this._calcMatrices(),this.rotationMatrix=function(){var a=new s.A(4);return s.A!=Float32Array&&(a[1]=0,a[2]=0),a[0]=1,a[3]=1,a}(),function(a,f,v){var I=f[0],k=f[1],D=f[2],B=f[3],G=Math.sin(v),U=Math.cos(v);a[0]=I*U+D*G,a[1]=k*U+B*G,a[2]=I*-G+D*U,a[3]=k*-G+B*U}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const n=s.ac(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==n&&(this._unmodified=!1,this._pitch=n,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=t/180*Math.PI,this._calcMatrices())}get zoom(){return this._zoom}set zoom(t){const n=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==n&&(this._unmodified=!1,this._zoom=n,this.tileZoom=Math.max(0,Math.floor(n)),this.scale=this.zoomScale(n),this._constrain(),this._calcMatrices())}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}set elevation(t){t!==this._elevation&&(this._elevation=t,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,n,a){this._unmodified=!1,this._edgeInsets.interpolate(t,n,a),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const n=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,n)}getVisibleUnwrappedCoordinates(t){const n=[new s.b3(0,t)];if(this._renderWorldCopies){const a=this.pointCoordinate(new s.P(0,0)),f=this.pointCoordinate(new s.P(this.width,0)),v=this.pointCoordinate(new s.P(this.width,this.height)),I=this.pointCoordinate(new s.P(0,this.height)),k=Math.floor(Math.min(a.x,f.x,v.x,I.x)),D=Math.floor(Math.max(a.x,f.x,v.x,I.x)),B=1;for(let G=k-B;G<=D+B;G++)G!==0&&n.push(new s.b3(G,t))}return n}coveringTiles(t){var n,a;let f=this.coveringZoomLevel(t);const v=f;if(t.minzoom!==void 0&&f<t.minzoom)return[];t.maxzoom!==void 0&&f>t.maxzoom&&(f=t.maxzoom);const I=this.pointCoordinate(this.getCameraPoint()),k=s.Y.fromLngLat(this.center),D=Math.pow(2,f),B=[D*I.x,D*I.y,0],G=[D*k.x,D*k.y,0],U=Ft.fromInvProjectionMatrix(this.invModelViewProjectionMatrix,this.worldSize,f);let K=t.minzoom||0;!t.terrain&&this.pitch<=60&&this._edgeInsets.top<.1&&(K=f);const ie=t.terrain?2/Math.min(this.tileSize,t.tileSize)*this.tileSize:3,oe=pe=>({aabb:new ci([pe*D,0,0],[(pe+1)*D,D,0]),zoom:0,x:0,y:0,wrap:pe,fullyVisible:!1}),ve=[],ce=[],Se=f,ke=t.reparseOverscaled?v:f;if(this._renderWorldCopies)for(let pe=1;pe<=3;pe++)ve.push(oe(-pe)),ve.push(oe(pe));for(ve.push(oe(0));ve.length>0;){const pe=ve.pop(),Fe=pe.x,We=pe.y;let Ye=pe.fullyVisible;if(!Ye){const Pt=pe.aabb.intersects(U);if(Pt===0)continue;Ye=Pt===2}const mt=t.terrain?B:G,Tt=pe.aabb.distanceX(mt),Ht=pe.aabb.distanceY(mt),qt=Math.max(Math.abs(Tt),Math.abs(Ht));if(pe.zoom===Se||qt>ie+(1<<Se-pe.zoom)-2&&pe.zoom>=K){const Pt=Se-pe.zoom,kt=B[0]-.5-(Fe<<Pt),Jt=B[1]-.5-(We<<Pt);ce.push({tileID:new s.Q(pe.zoom===Se?ke:pe.zoom,pe.wrap,pe.zoom,Fe,We),distanceSq:xe([G[0]-.5-Fe,G[1]-.5-We]),tileDistanceToCamera:Math.sqrt(kt*kt+Jt*Jt)})}else for(let Pt=0;Pt<4;Pt++){const kt=(Fe<<1)+Pt%2,Jt=(We<<1)+(Pt>>1),Ti=pe.zoom+1;let zt=pe.aabb.quadrant(Pt);if(t.terrain){const Ut=new s.Q(Ti,pe.wrap,Ti,kt,Jt),yi=t.terrain.getMinMaxElevation(Ut),pr=(n=yi.minElevation)!==null&&n!==void 0?n:this.elevation,Ii=(a=yi.maxElevation)!==null&&a!==void 0?a:this.elevation;zt=new ci([zt.min[0],zt.min[1],pr],[zt.max[0],zt.max[1],Ii])}ve.push({aabb:zt,zoom:Ti,x:kt,y:Jt,wrap:pe.wrap,fullyVisible:Ye})}}return ce.sort((pe,Fe)=>pe.distanceSq-Fe.distanceSq).map(pe=>pe.tileID)}resize(t,n){this.width=t,this.height=n,this.pixelsToGLUnits=[2/t,-2/n],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const n=s.ac(t.lat,-85.051129,ki);return new s.P(s.N(t.lng)*this.worldSize,s.O(n)*this.worldSize)}unproject(t){return new s.Y(t.x/this.worldSize,t.y/this.worldSize).toLngLat()}get point(){return this.project(this.center)}getCameraPosition(){return{lngLat:this.pointLocation(this.getCameraPoint()),altitude:Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter+this.elevation}}recalculateZoom(t){const n=this.elevation,a=Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter,f=this.pointLocation(this.centerPoint,t),v=t.getElevationForLngLatZoom(f,this.tileZoom);if(!(this.elevation-v))return;const I=a+n-v,k=Math.cos(this._pitch)*this.cameraToCenterDistance/I/s.b4(1,f.lat),D=this.scaleZoom(k/this.tileSize);this._elevation=v,this._center=f,this.zoom=D}setLocationAtPoint(t,n){const a=this.pointCoordinate(n),f=this.pointCoordinate(this.centerPoint),v=this.locationCoordinate(t),I=new s.Y(v.x-(a.x-f.x),v.y-(a.y-f.y));this.center=this.coordinateLocation(I),this._renderWorldCopies&&(this.center=this.center.wrap())}locationPoint(t,n){return n?this.coordinatePoint(this.locationCoordinate(t),n.getElevationForLngLatZoom(t,this.tileZoom),this.pixelMatrix3D):this.coordinatePoint(this.locationCoordinate(t))}pointLocation(t,n){return this.coordinateLocation(this.pointCoordinate(t,n))}locationCoordinate(t){return s.Y.fromLngLat(t)}coordinateLocation(t){return t&&t.toLngLat()}pointCoordinate(t,n){if(n){const K=n.pointCoordinate(t);if(K!=null)return K}const a=[t.x,t.y,0,1],f=[t.x,t.y,1,1];s.af(a,a,this.pixelMatrixInverse),s.af(f,f,this.pixelMatrixInverse);const v=a[3],I=f[3],k=a[1]/v,D=f[1]/I,B=a[2]/v,G=f[2]/I,U=B===G?0:(0-B)/(G-B);return new s.Y(s.z.number(a[0]/v,f[0]/I,U)/this.worldSize,s.z.number(k,D,U)/this.worldSize)}coordinatePoint(t,n=0,a=this.pixelMatrix){const f=[t.x*this.worldSize,t.y*this.worldSize,n,1];return s.af(f,f,a),new s.P(f[0]/f[3],f[1]/f[3])}getBounds(){const t=Math.max(0,this.height/2-this.getHorizon());return new Oe().extend(this.pointLocation(new s.P(0,t))).extend(this.pointLocation(new s.P(this.width,t))).extend(this.pointLocation(new s.P(this.width,this.height))).extend(this.pointLocation(new s.P(0,this.height)))}getMaxBounds(){return this.latRange&&this.latRange.length===2&&this.lngRange&&this.lngRange.length===2?new Oe([this.lngRange[0],this.latRange[0]],[this.lngRange[1],this.latRange[1]]):null}getHorizon(){return Math.tan(Math.PI/2-this._pitch)*this.cameraToCenterDistance*.85}setMaxBounds(t){t?(this.lngRange=[t.getWest(),t.getEast()],this.latRange=[t.getSouth(),t.getNorth()],this._constrain()):(this.lngRange=null,this.latRange=[-85.051129,ki])}calculatePosMatrix(t,n=!1){const a=t.key,f=n?this._alignedPosMatrixCache:this._posMatrixCache;if(f[a])return f[a];const v=t.canonical,I=this.worldSize/this.zoomScale(v.z),k=v.x+Math.pow(2,v.z)*t.wrap,D=s.an(new Float64Array(16));return s.H(D,D,[k*I,v.y*I,0]),s.J(D,D,[I/s.W,I/s.W,1]),s.K(D,n?this.alignedModelViewProjectionMatrix:this.modelViewProjectionMatrix,D),f[a]=new Float32Array(D),f[a]}customLayerMatrix(){return this.mercatorMatrix.slice()}getConstrained(t,n){n=s.ac(+n,this.minZoom,this.maxZoom);const a={center:new s.M(t.lng,t.lat),zoom:n};let f=this.lngRange;if(!this._renderWorldCopies&&f===null){const pe=179.9999999999;f=[-pe,pe]}const v=this.tileSize*this.zoomScale(a.zoom);let I=0,k=v,D=0,B=v,G=0,U=0;const{x:K,y:ie}=this.size;if(this.latRange){const pe=this.latRange;I=s.O(pe[1])*v,k=s.O(pe[0])*v,k-I<ie&&(G=ie/(k-I))}f&&(D=s.b2(s.N(f[0])*v,0,v),B=s.b2(s.N(f[1])*v,0,v),B<D&&(B+=v),B-D<K&&(U=K/(B-D)));const{x:oe,y:ve}=this.project.call({worldSize:v},t);let ce,Se;const ke=Math.max(U||0,G||0);if(ke){const pe=new s.P(U?(B+D)/2:oe,G?(k+I)/2:ve);return a.center=this.unproject.call({worldSize:v},pe).wrap(),a.zoom+=this.scaleZoom(ke),a}if(this.latRange){const pe=ie/2;ve-pe<I&&(Se=I+pe),ve+pe>k&&(Se=k-pe)}if(f){const pe=(D+B)/2;let Fe=oe;this._renderWorldCopies&&(Fe=s.b2(oe,pe-v/2,pe+v/2));const We=K/2;Fe-We<D&&(ce=D+We),Fe+We>B&&(ce=B-We)}if(ce!==void 0||Se!==void 0){const pe=new s.P(ce??oe,Se??ve);a.center=this.unproject.call({worldSize:v},pe).wrap()}return a}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this._unmodified,{center:n,zoom:a}=this.getConstrained(this.center,this.zoom);this.center=n,this.zoom=a,this._unmodified=t,this._constraining=!1}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,n=this.point.x,a=this.point.y;this.cameraToCenterDistance=.5/Math.tan(this._fov/2)*this.height,this._pixelPerMeter=s.b4(1,this.center.lat)*this.worldSize;let f=s.an(new Float64Array(16));s.J(f,f,[this.width/2,-this.height/2,1]),s.H(f,f,[1,-1,0]),this.labelPlaneMatrix=f,f=s.an(new Float64Array(16)),s.J(f,f,[1,-1,1]),s.H(f,f,[-1,-1,0]),s.J(f,f,[2/this.width,2/this.height,1]),this.glCoordMatrix=f;const v=this.cameraToCenterDistance+this._elevation*this._pixelPerMeter/Math.cos(this._pitch),I=Math.min(this.elevation,this.minElevationForCurrentTile),k=v-I*this._pixelPerMeter/Math.cos(this._pitch),D=I<0?k:v,B=Math.PI/2+this._pitch,G=this._fov*(.5+t.y/this.height),U=Math.sin(G)*D/Math.sin(s.ac(Math.PI-B-G,.01,Math.PI-.01)),K=this.getHorizon(),ie=2*Math.atan(K/this.cameraToCenterDistance)*(.5+t.y/(2*K)),oe=Math.sin(ie)*D/Math.sin(s.ac(Math.PI-B-ie,.01,Math.PI-.01)),ve=Math.min(U,oe),ce=1.01*(Math.cos(Math.PI/2-this._pitch)*ve+D),Se=this.height/50;f=new Float64Array(16),s.b5(f,this._fov,this.width/this.height,Se,ce),f[8]=2*-t.x/this.width,f[9]=2*t.y/this.height,s.J(f,f,[1,-1,1]),s.H(f,f,[0,0,-this.cameraToCenterDistance]),s.b6(f,f,this._pitch),s.ad(f,f,this.angle),s.H(f,f,[-n,-a,0]),this.mercatorMatrix=s.J([],f,[this.worldSize,this.worldSize,this.worldSize]),s.J(f,f,[1,1,this._pixelPerMeter]),this.pixelMatrix=s.K(new Float64Array(16),this.labelPlaneMatrix,f),s.H(f,f,[0,0,-this.elevation]),this.modelViewProjectionMatrix=f,this.invModelViewProjectionMatrix=s.as([],f),this.pixelMatrix3D=s.K(new Float64Array(16),this.labelPlaneMatrix,f);const ke=this.width%2/2,pe=this.height%2/2,Fe=Math.cos(this.angle),We=Math.sin(this.angle),Ye=n-Math.round(n)+Fe*ke+We*pe,mt=a-Math.round(a)+Fe*pe+We*ke,Tt=new Float64Array(f);if(s.H(Tt,Tt,[Ye>.5?Ye-1:Ye,mt>.5?mt-1:mt,0]),this.alignedModelViewProjectionMatrix=Tt,f=s.as(new Float64Array(16),this.pixelMatrix),!f)throw new Error("failed to invert matrix");this.pixelMatrixInverse=f,this._posMatrixCache={},this._alignedPosMatrixCache={}}maxPitchScaleFactor(){if(!this.pixelMatrixInverse)return 1;const t=this.pointCoordinate(new s.P(0,0)),n=[t.x*this.worldSize,t.y*this.worldSize,0,1];return s.af(n,n,this.pixelMatrix)[3]/this.cameraToCenterDistance}getCameraPoint(){const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(0,t))}getCameraQueryGeometry(t){const n=this.getCameraPoint();if(t.length===1)return[t[0],n];{let a=n.x,f=n.y,v=n.x,I=n.y;for(const k of t)a=Math.min(a,k.x),f=Math.min(f,k.y),v=Math.max(v,k.x),I=Math.max(I,k.y);return[new s.P(a,f),new s.P(v,f),new s.P(v,I),new s.P(a,I),new s.P(a,f)]}}lngLatToCameraDepth(t,n){const a=this.locationCoordinate(t),f=[a.x*this.worldSize,a.y*this.worldSize,n,1];return s.af(f,f,this.modelViewProjectionMatrix),f[2]/f[3]}}function Er(y,t){let n,a=!1,f=null,v=null;const I=()=>{f=null,a&&(y.apply(v,n),f=setTimeout(I,t),a=!1)};return(...k)=>(a=!0,v=this,n=k,f||I(),f)}class mn{constructor(t){this._getCurrentHash=()=>{const n=window.location.hash.replace("#","");if(this._hashName){let a;return n.split("&").map(f=>f.split("=")).forEach(f=>{f[0]===this._hashName&&(a=f)}),(a&&a[1]||"").split("/")}return n.split("/")},this._onHashChange=()=>{const n=this._getCurrentHash();if(n.length>=3&&!n.some(a=>isNaN(a))){const a=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(n[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+n[2],+n[1]],zoom:+n[0],bearing:a,pitch:+(n[4]||0)}),!0}return!1},this._updateHashUnthrottled=()=>{const n=window.location.href.replace(/(#.+)?$/,this.getHashString());try{window.history.replaceState(window.history.state,null,n)}catch{}},this._updateHash=Er(this._updateHashUnthrottled,300),this._hashName=t&&encodeURIComponent(t)}addTo(t){return this._map=t,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),delete this._map,this}getHashString(t){const n=this._map.getCenter(),a=Math.round(100*this._map.getZoom())/100,f=Math.ceil((a*Math.LN2+Math.log(512/360/.5))/Math.LN10),v=Math.pow(10,f),I=Math.round(n.lng*v)/v,k=Math.round(n.lat*v)/v,D=this._map.getBearing(),B=this._map.getPitch();let G="";if(G+=t?`/${I}/${k}/${a}`:`${a}/${k}/${I}`,(D||B)&&(G+="/"+Math.round(10*D)/10),B&&(G+=`/${Math.round(B)}`),this._hashName){const U=this._hashName;let K=!1;const ie=window.location.hash.slice(1).split("&").map(oe=>{const ve=oe.split("=")[0];return ve===U?(K=!0,`${ve}=${G}`):oe}).filter(oe=>oe);return K||ie.push(`${U}=${G}`),`#${ie.join("&")}`}return`#${G}`}}const xr={linearity:.3,easing:s.b7(0,0,.3,1)},Pr=s.e({deceleration:2500,maxSpeed:1400},xr),gn=s.e({deceleration:20,maxSpeed:1400},xr),Cn=s.e({deceleration:1e3,maxSpeed:360},xr),Nr=s.e({deceleration:1e3,maxSpeed:90},xr);class zn{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:l.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,n=l.now();for(;t.length>0&&n-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const n={zoom:0,bearing:0,pitch:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:v}of this._inertiaBuffer)n.zoom+=v.zoomDelta||0,n.bearing+=v.bearingDelta||0,n.pitch+=v.pitchDelta||0,v.panDelta&&n.pan._add(v.panDelta),v.around&&(n.around=v.around),v.pinchAround&&(n.pinchAround=v.pinchAround);const a=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,f={};if(n.pan.mag()){const v=Wn(n.pan.mag(),a,s.e({},Pr,t||{}));f.offset=n.pan.mult(v.amount/n.pan.mag()),f.center=this._map.transform.center,Gn(f,v)}if(n.zoom){const v=Wn(n.zoom,a,gn);f.zoom=this._map.transform.zoom+v.amount,Gn(f,v)}if(n.bearing){const v=Wn(n.bearing,a,Cn);f.bearing=this._map.transform.bearing+s.ac(v.amount,-179,179),Gn(f,v)}if(n.pitch){const v=Wn(n.pitch,a,Nr);f.pitch=this._map.transform.pitch+v.amount,Gn(f,v)}if(f.zoom||f.bearing){const v=n.pinchAround===void 0?n.around:n.pinchAround;f.around=v?this._map.unproject(v):this._map.getCenter()}return this.clear(),s.e(f,{noMoveStart:!0})}}function Gn(y,t){(!y.duration||y.duration<t.duration)&&(y.duration=t.duration,y.easing=t.easing)}function Wn(y,t,n){const{maxSpeed:a,linearity:f,deceleration:v}=n,I=s.ac(y*f/(t/1e3),-a,a),k=Math.abs(I)/(v*f);return{easing:n.easing,duration:1e3*k,amount:I*(k/2)}}class Ir extends s.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,a,f={}){const v=c.mousePos(n.getCanvas(),a),I=n.unproject(v);super(t,s.e({point:v,lngLat:I,originalEvent:a},f)),this._defaultPrevented=!1,this.target=n}}class Rn extends s.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,a){const f=t==="touchend"?a.changedTouches:a.touches,v=c.touchPos(n.getCanvasContainer(),f),I=v.map(D=>n.unproject(D)),k=v.reduce((D,B,G,U)=>D.add(B.div(U.length)),new s.P(0,0));super(t,{points:v,point:k,lngLats:I,lngLat:n.unproject(k),originalEvent:a}),this._defaultPrevented=!1}}class Ca extends s.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,a){super(t,{originalEvent:a}),this._defaultPrevented=!1}}class Sa{constructor(t,n){this._map=t,this._clickTolerance=n.clickTolerance}reset(){delete this._mousedownPos}wheel(t){return this._firePreventable(new Ca(t.type,this._map,t))}mousedown(t,n){return this._mousedownPos=n,this._firePreventable(new Ir(t.type,this._map,t))}mouseup(t){this._map.fire(new Ir(t.type,this._map,t))}click(t,n){this._mousedownPos&&this._mousedownPos.dist(n)>=this._clickTolerance||this._map.fire(new Ir(t.type,this._map,t))}dblclick(t){return this._firePreventable(new Ir(t.type,this._map,t))}mouseover(t){this._map.fire(new Ir(t.type,this._map,t))}mouseout(t){this._map.fire(new Ir(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Rn(t.type,this._map,t))}touchmove(t){this._map.fire(new Rn(t.type,this._map,t))}touchend(t){this._map.fire(new Rn(t.type,this._map,t))}touchcancel(t){this._map.fire(new Rn(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ml{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(t){this._map.fire(new Ir(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Ir("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._ignoreContextMenu||this._map.fire(new Ir(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Vi{constructor(t){this._map=t}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(t){return this.transform.pointLocation(s.P.convert(t),this._map.terrain)}}class Ri{constructor(t,n){this._map=t,this._tr=new Vi(t),this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=n.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,n){this.isEnabled()&&t.shiftKey&&t.button===0&&(c.disableDrag(),this._startPos=this._lastPos=n,this._active=!0)}mousemoveWindow(t,n){if(!this._active)return;const a=n;if(this._lastPos.equals(a)||!this._box&&a.dist(this._startPos)<this._clickTolerance)return;const f=this._startPos;this._lastPos=a,this._box||(this._box=c.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",t));const v=Math.min(f.x,a.x),I=Math.max(f.x,a.x),k=Math.min(f.y,a.y),D=Math.max(f.y,a.y);c.setTransform(this._box,`translate(${v}px,${k}px)`),this._box.style.width=I-v+"px",this._box.style.height=D-k+"px"}mouseupWindow(t,n){if(!this._active||t.button!==0)return;const a=this._startPos,f=n;if(this.reset(),c.suppressClick(),a.x!==f.x||a.y!==f.y)return this._map.fire(new s.k("boxzoomend",{originalEvent:t})),{cameraAnimation:v=>v.fitScreenCoordinates(a,f,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",t)}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(c.remove(this._box),this._box=null),c.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(t,n){return this._map.fire(new s.k(t,{originalEvent:n}))}}function ps(y,t){if(y.length!==t.length)throw new Error(`The number of touches and points are not equal - touches ${y.length}, points ${t.length}`);const n={};for(let a=0;a<y.length;a++)n[y[a].identifier]=t[a];return n}class Jn{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(t,n,a){(this.centroid||a.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=t.timeStamp),a.length===this.numTouches&&(this.centroid=function(f){const v=new s.P(0,0);for(const I of f)v._add(I);return v.div(f.length)}(n),this.touches=ps(a,n)))}touchmove(t,n,a){if(this.aborted||!this.centroid)return;const f=ps(a,n);for(const v in this.touches){const I=f[v];(!I||I.dist(this.touches[v])>30)&&(this.aborted=!0)}}touchend(t,n,a){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),a.length===0){const f=!this.aborted&&this.centroid;if(this.reset(),f)return f}}}class $s{constructor(t){this.singleTap=new Jn(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(t,n,a){this.singleTap.touchstart(t,n,a)}touchmove(t,n,a){this.singleTap.touchmove(t,n,a)}touchend(t,n,a){const f=this.singleTap.touchend(t,n,a);if(f){const v=t.timeStamp-this.lastTime<500,I=!this.lastTap||this.lastTap.dist(f)<30;if(v&&I||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=f,this.count===this.numTaps)return this.reset(),f}}}class Yr{constructor(t){this._tr=new Vi(t),this._zoomIn=new $s({numTouches:1,numTaps:2}),this._zoomOut=new $s({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,n,a){this._zoomIn.touchstart(t,n,a),this._zoomOut.touchstart(t,n,a)}touchmove(t,n,a){this._zoomIn.touchmove(t,n,a),this._zoomOut.touchmove(t,n,a)}touchend(t,n,a){const f=this._zoomIn.touchend(t,n,a),v=this._zoomOut.touchend(t,n,a),I=this._tr;return f?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:k=>k.easeTo({duration:300,zoom:I.zoom+1,around:I.unproject(f)},{originalEvent:t})}):v?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:k=>k.easeTo({duration:300,zoom:I.zoom-1,around:I.unproject(v)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Zr{constructor(t){this._enabled=!!t.enable,this._moveStateManager=t.moveStateManager,this._clickTolerance=t.clickTolerance||1,this._moveFunction=t.move,this._activateOnStart=!!t.activateOnStart,t.assignEvents(this),this.reset()}reset(t){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(t)}_move(...t){const n=this._moveFunction(...t);if(n.bearingDelta||n.pitchDelta||n.around||n.panDelta)return this._active=!0,n}dragStart(t,n){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(t)&&(this._moveStateManager.startMove(t),this._lastPoint=n.length?n[0]:n,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(t,n){if(!this.isEnabled())return;const a=this._lastPoint;if(!a)return;if(t.preventDefault(),!this._moveStateManager.isValidMoveEvent(t))return void this.reset(t);const f=n.length?n[0]:n;return!this._moved&&f.dist(a)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=f,this._move(a,f))}dragEnd(t){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(t)&&(this._moved&&c.suppressClick(),this.reset(t))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const ms={0:1,2:2};class gs{constructor(t){this._correctEvent=t.checkCorrectEvent}startMove(t){const n=c.mouseButton(t);this._eventButton=n}endMove(t){delete this._eventButton}isValidStartEvent(t){return this._correctEvent(t)}isValidMoveEvent(t){return!function(n,a){const f=ms[a];return n.buttons===void 0||(n.buttons&f)!==f}(t,this._eventButton)}isValidEndEvent(t){return c.mouseButton(t)===this._eventButton}}class sr{constructor(){this._firstTouch=void 0}_isOneFingerTouch(t){return t.targetTouches.length===1}_isSameTouchEvent(t){return t.targetTouches[0].identifier===this._firstTouch}startMove(t){this._firstTouch=t.targetTouches[0].identifier}endMove(t){delete this._firstTouch}isValidStartEvent(t){return this._isOneFingerTouch(t)}isValidMoveEvent(t){return this._isOneFingerTouch(t)&&this._isSameTouchEvent(t)}isValidEndEvent(t){return this._isOneFingerTouch(t)&&this._isSameTouchEvent(t)}}const rn=y=>{y.mousedown=y.dragStart,y.mousemoveWindow=y.dragMove,y.mouseup=y.dragEnd,y.contextmenu=t=>{t.preventDefault()}},zr=({enable:y,clickTolerance:t,bearingDegreesPerPixelMoved:n=.8})=>{const a=new gs({checkCorrectEvent:f=>c.mouseButton(f)===0&&f.ctrlKey||c.mouseButton(f)===2});return new Zr({clickTolerance:t,move:(f,v)=>({bearingDelta:(v.x-f.x)*n}),moveStateManager:a,enable:y,assignEvents:rn})},Io=({enable:y,clickTolerance:t,pitchDegreesPerPixelMoved:n=-.5})=>{const a=new gs({checkCorrectEvent:f=>c.mouseButton(f)===0&&f.ctrlKey||c.mouseButton(f)===2});return new Zr({clickTolerance:t,move:(f,v)=>({pitchDelta:(v.y-f.y)*n}),moveStateManager:a,enable:y,assignEvents:rn})};class Ys{constructor(t,n){this._clickTolerance=t.clickTolerance||1,this._map=n,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}minTouchs(){return this._map.cooperativeGestures.isEnabled()?2:1}touchstart(t,n,a){return this._calculateTransform(t,n,a)}touchmove(t,n,a){if(this._active&&!(a.length<this.minTouchs()))return t.preventDefault(),this._calculateTransform(t,n,a)}touchend(t,n,a){this._calculateTransform(t,n,a),this._active&&a.length<this.minTouchs()&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,n,a){a.length>0&&(this._active=!0);const f=ps(a,n),v=new s.P(0,0),I=new s.P(0,0);let k=0;for(const B in f){const G=f[B],U=this._touches[B];U&&(v._add(G),I._add(G.sub(U)),k++,f[B]=G)}if(this._touches=f,k<this.minTouchs()||!I.mag())return;const D=I.div(k);return this._sum._add(D),this._sum.mag()<this._clickTolerance?void 0:{around:v.div(k),panDelta:D}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Zs{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(t,n,a){this._firstTwoTouches||a.length<2||(this._firstTwoTouches=[a[0].identifier,a[1].identifier],this._start([n[0],n[1]]))}touchmove(t,n,a){if(!this._firstTwoTouches)return;t.preventDefault();const[f,v]=this._firstTwoTouches,I=Sn(a,n,f),k=Sn(a,n,v);if(!I||!k)return;const D=this._aroundCenter?null:I.add(k).div(2);return this._move([I,k],D,t)}touchend(t,n,a){if(!this._firstTwoTouches)return;const[f,v]=this._firstTwoTouches,I=Sn(a,n,f),k=Sn(a,n,v);I&&k||(this._active&&c.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function Sn(y,t,n){for(let a=0;a<y.length;a++)if(y[a].identifier===n)return t[a]}function Qn(y,t){return Math.log(y/t)/Math.LN2}class Ao extends Zs{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,n){const a=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(Qn(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Qn(this._distance,a),pinchAround:n}}}function Ks(y,t){return 180*y.angleWith(t)/Math.PI}class Js extends Zs{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,n,a){const f=this._vector;if(this._vector=t[0].sub(t[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:Ks(this._vector,f),pinchAround:n}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const n=25/(Math.PI*this._minDiameter)*360,a=Ks(t,this._startVector);return Math.abs(a)<n}}function el(y){return Math.abs(y.y)>Math.abs(y.x)}class kl extends Zs{constructor(t){super(),this._currentTouchCount=0,this._map=t}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(t,n,a){super.touchstart(t,n,a),this._currentTouchCount=a.length}_start(t){this._lastPoints=t,el(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,n,a){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const f=t[0].sub(this._lastPoints[0]),v=t[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(f,v,a.timeStamp),this._valid?(this._lastPoints=t,this._active=!0,{pitchDelta:(f.y+v.y)/2*-.5}):void 0}gestureBeginsVertically(t,n,a){if(this._valid!==void 0)return this._valid;const f=t.mag()>=2,v=n.mag()>=2;if(!f&&!v)return;if(!f||!v)return this._firstMove===void 0&&(this._firstMove=a),a-this._firstMove<100&&void 0;const I=t.y>0==n.y>0;return el(t)&&el(n)&&I}}const dc={panStep:100,bearingStep:15,pitchStep:10};class Qs{constructor(t){this._tr=new Vi(t);const n=dc;this._panStep=n.panStep,this._bearingStep=n.bearingStep,this._pitchStep=n.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let n=0,a=0,f=0,v=0,I=0;switch(t.keyCode){case 61:case 107:case 171:case 187:n=1;break;case 189:case 109:case 173:n=-1;break;case 37:t.shiftKey?a=-1:(t.preventDefault(),v=-1);break;case 39:t.shiftKey?a=1:(t.preventDefault(),v=1);break;case 38:t.shiftKey?f=1:(t.preventDefault(),I=-1);break;case 40:t.shiftKey?f=-1:(t.preventDefault(),I=1);break;default:return}return this._rotationDisabled&&(a=0,f=0),{cameraAnimation:k=>{const D=this._tr;k.easeTo({duration:300,easeId:"keyboardHandler",easing:fc,zoom:n?Math.round(D.zoom)+n*(t.shiftKey?2:1):D.zoom,bearing:D.bearing+a*this._bearingStep,pitch:D.pitch+f*this._pitchStep,offset:[-v*this._panStep,-I*this._panStep],center:D.center},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function fc(y){return y*(2-y)}const Ol=4.000244140625;class Dl{constructor(t,n){this._onTimeout=a=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(a)},this._map=t,this._tr=new Vi(t),this._triggerRenderFrame=n,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}wheel(t){if(!this.isEnabled()||this._map.cooperativeGestures.isEnabled()&&!t[this._map.cooperativeGestures._bypassKey])return;let n=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const a=l.now(),f=a-(this._lastWheelEventTime||0);this._lastWheelEventTime=a,n!==0&&n%Ol==0?this._type="wheel":n!==0&&Math.abs(n)<4?this._type="trackpad":f>400?(this._type=null,this._lastValue=n,this._timeout=setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(f*n)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,n+=this._lastValue)),t.shiftKey&&n&&(n/=4),this._type&&(this._lastWheelEvent=t,this._delta-=n,this._active||this._start(t)),t.preventDefault()}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const n=c.mousePos(this._map.getCanvas(),t),a=this._tr;this._around=n.y>a.transform.height/2-a.transform.getHorizon()?s.M.convert(this._aroundCenter?a.center:a.unproject(n)):s.M.convert(a.center),this._aroundPoint=a.transform.locationPoint(this._around),this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._tr.transform;if(this._delta!==0){const k=this._type==="wheel"&&Math.abs(this._delta)>Ol?this._wheelZoomRate:this._defaultZoomRate;let D=2/(1+Math.exp(-Math.abs(this._delta*k)));this._delta<0&&D!==0&&(D=1/D);const B=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):t.scale;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(B*D))),this._type==="wheel"&&(this._startZoom=t.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const n=typeof this._targetZoom=="number"?this._targetZoom:t.zoom,a=this._startZoom,f=this._easing;let v,I=!1;if(this._type==="wheel"&&a&&f){const k=Math.min((l.now()-this._lastWheelEventTime)/200,1),D=f(k);v=s.z.number(a,n,D),k<1?this._frameId||(this._frameId=!0):I=!0}else v=n,I=!0;return this._active=!0,I&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!I,zoomDelta:v-t.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let n=s.b8;if(this._prevEase){const a=this._prevEase,f=(l.now()-a.start)/a.duration,v=a.easing(f+.01)-a.easing(f),I=.27/Math.sqrt(v*v+1e-4)*.01,k=Math.sqrt(.0729-I*I);n=s.b7(I,k,.25,1)}return this._prevEase={start:l.now(),duration:t,easing:n},n}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class Ll{constructor(t,n){this._clickZoom=t,this._tapZoom=n}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class pc{constructor(t){this._tr=new Vi(t),this.reset()}reset(){this._active=!1}dblclick(t,n){return t.preventDefault(),{cameraAnimation:a=>{a.easeTo({duration:300,zoom:this._tr.zoom+(t.shiftKey?-1:1),around:this._tr.unproject(n)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class mc{constructor(){this._tap=new $s({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(t,n,a){if(!this._swipePoint)if(this._tapTime){const f=n[0],v=t.timeStamp-this._tapTime<500,I=this._tapPoint.dist(f)<30;v&&I?a.length>0&&(this._swipePoint=f,this._swipeTouch=a[0].identifier):this.reset()}else this._tap.touchstart(t,n,a)}touchmove(t,n,a){if(this._tapTime){if(this._swipePoint){if(a[0].identifier!==this._swipeTouch)return;const f=n[0],v=f.y-this._swipePoint.y;return this._swipePoint=f,t.preventDefault(),this._active=!0,{zoomDelta:v/128}}}else this._tap.touchmove(t,n,a)}touchend(t,n,a){if(this._tapTime)this._swipePoint&&a.length===0&&this.reset();else{const f=this._tap.touchend(t,n,a);f&&(this._tapTime=t.timeStamp,this._tapPoint=f)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Fl{constructor(t,n,a){this._el=t,this._mousePan=n,this._touchPan=a}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Yo{constructor(t,n,a){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=n,this._mousePitch=a}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class zl{constructor(t,n,a,f){this._el=t,this._touchZoom=n,this._touchRotate=a,this._tapDragZoom=f,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class Hn{constructor(t,n){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=t,this._options=n,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const t=this._map.getCanvasContainer();t.classList.add("maplibregl-cooperative-gestures"),this._container=c.create("div","maplibregl-cooperative-gesture-screen",t);let n=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(n=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const a=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),f=document.createElement("div");f.className="maplibregl-desktop-message",f.textContent=n,this._container.appendChild(f);const v=document.createElement("div");v.className="maplibregl-mobile-message",v.textContent=a,this._container.appendChild(v),this._container.setAttribute("aria-hidden","true")}_destoryUI(){this._container&&(c.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destoryUI()}isEnabled(){return this._enabled}touchmove(t){this._onCooperativeGesture(t.touches.length===1)}wheel(t){this._map.scrollZoom.isEnabled()&&this._onCooperativeGesture(!t[this._bypassKey])}_onCooperativeGesture(t){this._enabled&&t&&(this._container.classList.add("maplibregl-show"),setTimeout(()=>{this._container.classList.remove("maplibregl-show")},100))}}const Bn=y=>y.zoom||y.drag||y.pitch||y.rotate;class gc extends s.k{}function Xn(y){return y.panDelta&&y.panDelta.mag()||y.zoomDelta||y.bearingDelta||y.pitchDelta}class Ta{constructor(t,n){this.handleWindowEvent=f=>{this.handleEvent(f,`${f.type}Window`)},this.handleEvent=(f,v)=>{if(f.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const I=f.type==="renderFrame"?void 0:f,k={needsRenderFrame:!1},D={},B={},G=f.touches,U=G?this._getMapTouches(G):void 0,K=U?c.touchPos(this._map.getCanvas(),U):c.mousePos(this._map.getCanvas(),f);for(const{handlerName:ve,handler:ce,allowed:Se}of this._handlers){if(!ce.isEnabled())continue;let ke;this._blockedByActive(B,Se,ve)?ce.reset():ce[v||f.type]&&(ke=ce[v||f.type](f,K,U),this.mergeHandlerResult(k,D,ke,ve,I),ke&&ke.needsRenderFrame&&this._triggerRenderFrame()),(ke||ce.isActive())&&(B[ve]=ce)}const ie={};for(const ve in this._previousActiveHandlers)B[ve]||(ie[ve]=I);this._previousActiveHandlers=B,(Object.keys(ie).length||Xn(k))&&(this._changes.push([k,D,ie]),this._triggerRenderFrame()),(Object.keys(B).length||Xn(k))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:oe}=k;oe&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],oe(this._map))},this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new zn(t),this._bearingSnap=n.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(n);const a=this._el;this._listeners=[[a,"touchstart",{passive:!0}],[a,"touchmove",{passive:!1}],[a,"touchend",void 0],[a,"touchcancel",void 0],[a,"mousedown",void 0],[a,"mousemove",void 0],[a,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[a,"mouseover",void 0],[a,"mouseout",void 0],[a,"dblclick",void 0],[a,"click",void 0],[a,"keydown",{capture:!1}],[a,"keyup",void 0],[a,"wheel",{passive:!1}],[a,"contextmenu",void 0],[window,"blur",void 0]];for(const[f,v,I]of this._listeners)c.addEventListener(f,v,f===document?this.handleWindowEvent:this.handleEvent,I)}destroy(){for(const[t,n,a]of this._listeners)c.removeEventListener(t,n,t===document?this.handleWindowEvent:this.handleEvent,a)}_addDefaultHandlers(t){const n=this._map,a=n.getCanvasContainer();this._add("mapEvent",new Sa(n,t));const f=n.boxZoom=new Ri(n,t);this._add("boxZoom",f),t.interactive&&t.boxZoom&&f.enable();const v=n.cooperativeGestures=new Hn(n,t.cooperativeGestures);this._add("cooperativeGestures",v),t.cooperativeGestures&&v.enable();const I=new Yr(n),k=new pc(n);n.doubleClickZoom=new Ll(k,I),this._add("tapZoom",I),this._add("clickZoom",k),t.interactive&&t.doubleClickZoom&&n.doubleClickZoom.enable();const D=new mc;this._add("tapDragZoom",D);const B=n.touchPitch=new kl(n);this._add("touchPitch",B),t.interactive&&t.touchPitch&&n.touchPitch.enable(t.touchPitch);const G=zr(t),U=Io(t);n.dragRotate=new Yo(t,G,U),this._add("mouseRotate",G,["mousePitch"]),this._add("mousePitch",U,["mouseRotate"]),t.interactive&&t.dragRotate&&n.dragRotate.enable();const K=(({enable:ke,clickTolerance:pe})=>{const Fe=new gs({checkCorrectEvent:We=>c.mouseButton(We)===0&&!We.ctrlKey});return new Zr({clickTolerance:pe,move:(We,Ye)=>({around:Ye,panDelta:Ye.sub(We)}),activateOnStart:!0,moveStateManager:Fe,enable:ke,assignEvents:rn})})(t),ie=new Ys(t,n);n.dragPan=new Fl(a,K,ie),this._add("mousePan",K),this._add("touchPan",ie,["touchZoom","touchRotate"]),t.interactive&&t.dragPan&&n.dragPan.enable(t.dragPan);const oe=new Js,ve=new Ao;n.touchZoomRotate=new zl(a,ve,oe,D),this._add("touchRotate",oe,["touchPan","touchZoom"]),this._add("touchZoom",ve,["touchPan","touchRotate"]),t.interactive&&t.touchZoomRotate&&n.touchZoomRotate.enable(t.touchZoomRotate);const ce=n.scrollZoom=new Dl(n,()=>this._triggerRenderFrame());this._add("scrollZoom",ce,["mousePan"]),t.interactive&&t.scrollZoom&&n.scrollZoom.enable(t.scrollZoom);const Se=n.keyboard=new Qs(n);this._add("keyboard",Se),t.interactive&&t.keyboard&&n.keyboard.enable(),this._add("blockableMapEvent",new Ml(n))}_add(t,n,a){this._handlers.push({handlerName:t,handler:n,allowed:a}),this._handlersById[t]=n}stop(t){if(!this._updatingCamera){for(const{handler:n}of this._handlers)n.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[]}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Bn(this._eventsInProgress)||this.isZooming()}_blockedByActive(t,n,a){for(const f in t)if(f!==a&&(!n||n.indexOf(f)<0))return!0;return!1}_getMapTouches(t){const n=[];for(const a of t)this._el.contains(a.target)&&n.push(a);return n}mergeHandlerResult(t,n,a,f,v){if(!a)return;s.e(t,a);const I={handlerName:f,originalEvent:a.originalEvent||v};a.zoomDelta!==void 0&&(n.zoom=I),a.panDelta!==void 0&&(n.drag=I),a.pitchDelta!==void 0&&(n.pitch=I),a.bearingDelta!==void 0&&(n.rotate=I)}_applyChanges(){const t={},n={},a={};for(const[f,v,I]of this._changes)f.panDelta&&(t.panDelta=(t.panDelta||new s.P(0,0))._add(f.panDelta)),f.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+f.zoomDelta),f.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+f.bearingDelta),f.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+f.pitchDelta),f.around!==void 0&&(t.around=f.around),f.pinchAround!==void 0&&(t.pinchAround=f.pinchAround),f.noInertia&&(t.noInertia=f.noInertia),s.e(n,v),s.e(a,I);this._updateMapTransform(t,n,a),this._changes=[]}_updateMapTransform(t,n,a){const f=this._map,v=f._getTransformForUpdate(),I=f.terrain;if(!(Xn(t)||I&&this._terrainMovement))return this._fireEvents(n,a,!0);let{panDelta:k,zoomDelta:D,bearingDelta:B,pitchDelta:G,around:U,pinchAround:K}=t;K!==void 0&&(U=K),f._stop(!0),U=U||f.transform.centerPoint;const ie=v.pointLocation(k?U.sub(k):U);B&&(v.bearing+=B),G&&(v.pitch+=G),D&&(v.zoom+=D),I?this._terrainMovement||!n.drag&&!n.zoom?n.drag&&this._terrainMovement?v.center=v.pointLocation(v.centerPoint.sub(k)):v.setLocationAtPoint(ie,U):(this._terrainMovement=!0,this._map._elevationFreeze=!0,v.setLocationAtPoint(ie,U)):v.setLocationAtPoint(ie,U),f._applyUpdatedTransform(v),this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(n,a,!0)}_fireEvents(t,n,a){const f=Bn(this._eventsInProgress),v=Bn(t),I={};for(const U in t){const{originalEvent:K}=t[U];this._eventsInProgress[U]||(I[`${U}start`]=K),this._eventsInProgress[U]=t[U]}!f&&v&&this._fireEvent("movestart",v.originalEvent);for(const U in I)this._fireEvent(U,I[U]);v&&this._fireEvent("move",v.originalEvent);for(const U in t){const{originalEvent:K}=t[U];this._fireEvent(U,K)}const k={};let D;for(const U in this._eventsInProgress){const{handlerName:K,originalEvent:ie}=this._eventsInProgress[U];this._handlersById[K].isActive()||(delete this._eventsInProgress[U],D=n[K]||ie,k[`${U}end`]=D)}for(const U in k)this._fireEvent(U,k[U]);const B=Bn(this._eventsInProgress),G=(f||v)&&!B;if(G&&this._terrainMovement&&(this._map._elevationFreeze=!1,this._terrainMovement=!1,this._map.transform.recalculateZoom(this._map.terrain)),a&&G){this._updatingCamera=!0;const U=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),K=ie=>ie!==0&&-this._bearingSnap<ie&&ie<this._bearingSnap;!U||!U.essential&&l.prefersReducedMotion?(this._map.fire(new s.k("moveend",{originalEvent:D})),K(this._map.getBearing())&&this._map.resetNorth()):(K(U.bearing||this._map.getBearing())&&(U.bearing=0),U.freezeElevation=!0,this._map.easeTo(U,{originalEvent:D})),this._updatingCamera=!1}}_fireEvent(t,n){this._map.fire(new s.k(t,n?{originalEvent:n}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{delete this._frameId,this.handleEvent(new gc("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class nh extends s.E{constructor(t,n){super(),this._renderFrameCallback=()=>{const a=Math.min((l.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(a)),a<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=n.bearingSnap,this.on("moveend",()=>{delete this._requestedCameraState})}getCenter(){return new s.M(this.transform.center.lng,this.transform.center.lat)}setCenter(t,n){return this.jumpTo({center:t},n)}panBy(t,n,a){return t=s.P.convert(t).mult(-1),this.panTo(this.transform.center,s.e({offset:t},n),a)}panTo(t,n,a){return this.easeTo(s.e({center:t},n),a)}getZoom(){return this.transform.zoom}setZoom(t,n){return this.jumpTo({zoom:t},n),this}zoomTo(t,n,a){return this.easeTo(s.e({zoom:t},n),a)}zoomIn(t,n){return this.zoomTo(this.getZoom()+1,t,n),this}zoomOut(t,n){return this.zoomTo(this.getZoom()-1,t,n),this}getBearing(){return this.transform.bearing}setBearing(t,n){return this.jumpTo({bearing:t},n),this}getPadding(){return this.transform.padding}setPadding(t,n){return this.jumpTo({padding:t},n),this}rotateTo(t,n,a){return this.easeTo(s.e({bearing:t},n),a)}resetNorth(t,n){return this.rotateTo(0,s.e({duration:1e3},t),n),this}resetNorthPitch(t,n){return this.easeTo(s.e({bearing:0,pitch:0,duration:1e3},t),n),this}snapToNorth(t,n){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,n):this}getPitch(){return this.transform.pitch}setPitch(t,n){return this.jumpTo({pitch:t},n),this}cameraForBounds(t,n){t=Oe.convert(t);const a=n&&n.bearing||0;return this._cameraForBoxAndBearing(t.getNorthWest(),t.getSouthEast(),a,n)}_cameraForBoxAndBearing(t,n,a,f){const v={top:0,bottom:0,right:0,left:0};if(typeof(f=s.e({padding:v,offset:[0,0],maxZoom:this.transform.maxZoom},f)).padding=="number"){const Pt=f.padding;f.padding={top:Pt,bottom:Pt,right:Pt,left:Pt}}f.padding=s.e(v,f.padding);const I=this.transform,k=I.padding,D=new Oe(t,n),B=I.project(D.getNorthWest()),G=I.project(D.getNorthEast()),U=I.project(D.getSouthEast()),K=I.project(D.getSouthWest()),ie=s.b9(-a),oe=B.rotate(ie),ve=G.rotate(ie),ce=U.rotate(ie),Se=K.rotate(ie),ke=new s.P(Math.max(oe.x,ve.x,Se.x,ce.x),Math.max(oe.y,ve.y,Se.y,ce.y)),pe=new s.P(Math.min(oe.x,ve.x,Se.x,ce.x),Math.min(oe.y,ve.y,Se.y,ce.y)),Fe=ke.sub(pe),We=(I.width-(k.left+k.right+f.padding.left+f.padding.right))/Fe.x,Ye=(I.height-(k.top+k.bottom+f.padding.top+f.padding.bottom))/Fe.y;if(Ye<0||We<0)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const mt=Math.min(I.scaleZoom(I.scale*Math.min(We,Ye)),f.maxZoom),Tt=s.P.convert(f.offset),Ht=new s.P((f.padding.left-f.padding.right)/2,(f.padding.top-f.padding.bottom)/2).rotate(s.b9(a)),qt=Tt.add(Ht).mult(I.scale/I.zoomScale(mt));return{center:I.unproject(B.add(U).div(2).sub(qt)),zoom:mt,bearing:a}}fitBounds(t,n,a){return this._fitInternal(this.cameraForBounds(t,n),n,a)}fitScreenCoordinates(t,n,a,f,v){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.pointLocation(s.P.convert(t)),this.transform.pointLocation(s.P.convert(n)),a,f),f,v)}_fitInternal(t,n,a){return t?(delete(n=s.e(t,n)).padding,n.linear?this.easeTo(n,a):this.flyTo(n,a)):this}jumpTo(t,n){this.stop();const a=this._getTransformForUpdate();let f=!1,v=!1,I=!1;return"zoom"in t&&a.zoom!==+t.zoom&&(f=!0,a.zoom=+t.zoom),t.center!==void 0&&(a.center=s.M.convert(t.center)),"bearing"in t&&a.bearing!==+t.bearing&&(v=!0,a.bearing=+t.bearing),"pitch"in t&&a.pitch!==+t.pitch&&(I=!0,a.pitch=+t.pitch),t.padding==null||a.isPaddingEqual(t.padding)||(a.padding=t.padding),this._applyUpdatedTransform(a),this.fire(new s.k("movestart",n)).fire(new s.k("move",n)),f&&this.fire(new s.k("zoomstart",n)).fire(new s.k("zoom",n)).fire(new s.k("zoomend",n)),v&&this.fire(new s.k("rotatestart",n)).fire(new s.k("rotate",n)).fire(new s.k("rotateend",n)),I&&this.fire(new s.k("pitchstart",n)).fire(new s.k("pitch",n)).fire(new s.k("pitchend",n)),this.fire(new s.k("moveend",n))}calculateCameraOptionsFromTo(t,n,a,f=0){const v=s.Y.fromLngLat(t,n),I=s.Y.fromLngLat(a,f),k=I.x-v.x,D=I.y-v.y,B=I.z-v.z,G=Math.hypot(k,D,B);if(G===0)throw new Error("Can't calculate camera options with same From and To");const U=Math.hypot(k,D),K=this.transform.scaleZoom(this.transform.cameraToCenterDistance/G/this.transform.tileSize),ie=180*Math.atan2(k,-D)/Math.PI;let oe=180*Math.acos(U/G)/Math.PI;return oe=B<0?90-oe:90+oe,{center:I.toLngLat(),zoom:K,pitch:oe,bearing:ie}}easeTo(t,n){var a;this._stop(!1,t.easeId),((t=s.e({offset:[0,0],duration:500,easing:s.b8},t)).animate===!1||!t.essential&&l.prefersReducedMotion)&&(t.duration=0);const f=this._getTransformForUpdate(),v=this.getZoom(),I=this.getBearing(),k=this.getPitch(),D=this.getPadding(),B="bearing"in t?this._normalizeBearing(t.bearing,I):I,G="pitch"in t?+t.pitch:k,U="padding"in t?t.padding:f.padding,K=s.P.convert(t.offset);let ie=f.centerPoint.add(K);const oe=f.pointLocation(ie),{center:ve,zoom:ce}=f.getConstrained(s.M.convert(t.center||oe),(a=t.zoom)!==null&&a!==void 0?a:v);this._normalizeCenter(ve);const Se=f.project(oe),ke=f.project(ve).sub(Se),pe=f.zoomScale(ce-v);let Fe,We;t.around&&(Fe=s.M.convert(t.around),We=f.locationPoint(Fe));const Ye={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=this._zooming||ce!==v,this._rotating=this._rotating||I!==B,this._pitching=this._pitching||G!==k,this._padding=!f.isPaddingEqual(U),this._easeId=t.easeId,this._prepareEase(n,t.noMoveStart,Ye),this.terrain&&this._prepareElevation(ve),this._ease(mt=>{if(this._zooming&&(f.zoom=s.z.number(v,ce,mt)),this._rotating&&(f.bearing=s.z.number(I,B,mt)),this._pitching&&(f.pitch=s.z.number(k,G,mt)),this._padding&&(f.interpolatePadding(D,U,mt),ie=f.centerPoint.add(K)),this.terrain&&!t.freezeElevation&&this._updateElevation(mt),Fe)f.setLocationAtPoint(Fe,We);else{const Tt=f.zoomScale(f.zoom-v),Ht=ce>v?Math.min(2,pe):Math.max(.5,pe),qt=Math.pow(Ht,1-mt),Pt=f.unproject(Se.add(ke.mult(mt*qt)).mult(Tt));f.setLocationAtPoint(f.renderWorldCopies?Pt.wrap():Pt,ie)}this._applyUpdatedTransform(f),this._fireMoveEvents(n)},mt=>{this.terrain&&t.freezeElevation&&this._finalizeElevation(),this._afterEase(n,mt)},t),this}_prepareEase(t,n,a={}){this._moving=!0,n||a.moving||this.fire(new s.k("movestart",t)),this._zooming&&!a.zooming&&this.fire(new s.k("zoomstart",t)),this._rotating&&!a.rotating&&this.fire(new s.k("rotatestart",t)),this._pitching&&!a.pitching&&this.fire(new s.k("pitchstart",t))}_prepareElevation(t){this._elevationCenter=t,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(t,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(t){this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);const n=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(t<1&&n!==this._elevationTarget){const a=this._elevationTarget-this._elevationStart;this._elevationStart+=t*(a-(n-(a*t+this._elevationStart))/(1-t)),this._elevationTarget=n}this.transform.elevation=s.z.number(this._elevationStart,this._elevationTarget,t)}_finalizeElevation(){this._elevationFreeze=!1,this.transform.recalculateZoom(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_applyUpdatedTransform(t){if(!this.transformCameraUpdate)return;const n=t.clone(),{center:a,zoom:f,pitch:v,bearing:I,elevation:k}=this.transformCameraUpdate(n);a&&(n.center=a),f!==void 0&&(n.zoom=f),v!==void 0&&(n.pitch=v),I!==void 0&&(n.bearing=I),k!==void 0&&(n.elevation=k),this.transform.apply(n)}_fireMoveEvents(t){this.fire(new s.k("move",t)),this._zooming&&this.fire(new s.k("zoom",t)),this._rotating&&this.fire(new s.k("rotate",t)),this._pitching&&this.fire(new s.k("pitch",t))}_afterEase(t,n){if(this._easeId&&n&&this._easeId===n)return;delete this._easeId;const a=this._zooming,f=this._rotating,v=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,a&&this.fire(new s.k("zoomend",t)),f&&this.fire(new s.k("rotateend",t)),v&&this.fire(new s.k("pitchend",t)),this.fire(new s.k("moveend",t))}flyTo(t,n){var a;if(!t.essential&&l.prefersReducedMotion){const Ut=s.L(t,["center","zoom","bearing","pitch","around"]);return this.jumpTo(Ut,n)}this.stop(),t=s.e({offset:[0,0],speed:1.2,curve:1.42,easing:s.b8},t);const f=this._getTransformForUpdate(),v=this.getZoom(),I=this.getBearing(),k=this.getPitch(),D=this.getPadding(),B="bearing"in t?this._normalizeBearing(t.bearing,I):I,G="pitch"in t?+t.pitch:k,U="padding"in t?t.padding:f.padding,K=s.P.convert(t.offset);let ie=f.centerPoint.add(K);const oe=f.pointLocation(ie),{center:ve,zoom:ce}=f.getConstrained(s.M.convert(t.center||oe),(a=t.zoom)!==null&&a!==void 0?a:v);this._normalizeCenter(ve);const Se=f.zoomScale(ce-v),ke=f.project(oe),pe=f.project(ve).sub(ke);let Fe=t.curve;const We=Math.max(f.width,f.height),Ye=We/Se,mt=pe.mag();if("minZoom"in t){const Ut=s.ac(Math.min(t.minZoom,v,ce),f.minZoom,f.maxZoom),yi=We/f.zoomScale(Ut-v);Fe=Math.sqrt(yi/mt*2)}const Tt=Fe*Fe;function Ht(Ut){const yi=(Ye*Ye-We*We+(Ut?-1:1)*Tt*Tt*mt*mt)/(2*(Ut?Ye:We)*Tt*mt);return Math.log(Math.sqrt(yi*yi+1)-yi)}function qt(Ut){return(Math.exp(Ut)-Math.exp(-Ut))/2}function Pt(Ut){return(Math.exp(Ut)+Math.exp(-Ut))/2}const kt=Ht(!1);let Jt=function(Ut){return Pt(kt)/Pt(kt+Fe*Ut)},Ti=function(Ut){return We*((Pt(kt)*(qt(yi=kt+Fe*Ut)/Pt(yi))-qt(kt))/Tt)/mt;var yi},zt=(Ht(!0)-kt)/Fe;if(Math.abs(mt)<1e-6||!isFinite(zt)){if(Math.abs(We-Ye)<1e-6)return this.easeTo(t,n);const Ut=Ye<We?-1:1;zt=Math.abs(Math.log(Ye/We))/Fe,Ti=()=>0,Jt=yi=>Math.exp(Ut*Fe*yi)}return t.duration="duration"in t?+t.duration:1e3*zt/("screenSpeed"in t?+t.screenSpeed/Fe:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0),this._zooming=!0,this._rotating=I!==B,this._pitching=G!==k,this._padding=!f.isPaddingEqual(U),this._prepareEase(n,!1),this.terrain&&this._prepareElevation(ve),this._ease(Ut=>{const yi=Ut*zt,pr=1/Jt(yi);f.zoom=Ut===1?ce:v+f.scaleZoom(pr),this._rotating&&(f.bearing=s.z.number(I,B,Ut)),this._pitching&&(f.pitch=s.z.number(k,G,Ut)),this._padding&&(f.interpolatePadding(D,U,Ut),ie=f.centerPoint.add(K)),this.terrain&&!t.freezeElevation&&this._updateElevation(Ut);const Ii=Ut===1?ve:f.unproject(ke.add(pe.mult(Ti(yi))).mult(pr));f.setLocationAtPoint(f.renderWorldCopies?Ii.wrap():Ii,ie),this._applyUpdatedTransform(f),this._fireMoveEvents(n)},()=>{this.terrain&&t.freezeElevation&&this._finalizeElevation(),this._afterEase(n)},t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(t,n){var a;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const f=this._onEaseEnd;delete this._onEaseEnd,f.call(this,n)}return t||(a=this.handlers)===null||a===void 0||a.stop(!1),this}_ease(t,n,a){a.animate===!1||a.duration===0?(t(1),n()):(this._easeStart=l.now(),this._easeOptions=a,this._onEaseFrame=t,this._onEaseEnd=n,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(t,n){t=s.b2(t,-180,180);const a=Math.abs(t-n);return Math.abs(t-360-n)<a&&(t-=360),Math.abs(t+360-n)<a&&(t+=360),t}_normalizeCenter(t){const n=this.transform;if(!n.renderWorldCopies||n.lngRange)return;const a=t.lng-n.center.lng;t.lng+=a>180?-360:a<-180?360:0}queryTerrainElevation(t){return this.terrain?this.terrain.getElevationForLngLatZoom(s.M.convert(t),this.transform.tileZoom)-this.transform.elevation:null}}const _c={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class yc{constructor(t=_c){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=n=>{!n||n.sourceDataType!=="metadata"&&n.sourceDataType!=="visibility"&&n.dataType!=="style"&&n.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=t}getDefaultPosition(){return"bottom-right"}onAdd(t){return this._map=t,this._compact=this.options.compact,this._container=c.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=c.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=c.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){c.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(t,n){const a=this._map._getUIString(`AttributionControl.${n}`);t.title=a,t.setAttribute("aria-label",a)}_updateAttributions(){if(!this._map.style)return;let t=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=t.concat(this.options.customAttribution.map(f=>typeof f!="string"?"":f)):typeof this.options.customAttribution=="string"&&t.push(this.options.customAttribution)),this._map.style.stylesheet){const f=this._map.style.stylesheet;this.styleOwner=f.owner,this.styleId=f.id}const n=this._map.style.sourceCaches;for(const f in n){const v=n[f];if(v.used||v.usedForTerrain){const I=v.getSource();I.attribution&&t.indexOf(I.attribution)<0&&t.push(I.attribution)}}t=t.filter(f=>String(f).trim()),t.sort((f,v)=>f.length-v.length),t=t.filter((f,v)=>{for(let I=v+1;I<t.length;I++)if(t[I].indexOf(f)>=0)return!1;return!0});const a=t.join(" | ");a!==this._attribHTML&&(this._attribHTML=a,t.length?(this._innerContainer.innerHTML=a,this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class Rl{constructor(t={}){this._updateCompact=()=>{const n=this._container.children;if(n.length){const a=n[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&a.classList.add("maplibregl-compact"):a.classList.remove("maplibregl-compact")}},this.options=t}getDefaultPosition(){return"bottom-left"}onAdd(t){this._map=t,this._compact=this.options&&this.options.compact,this._container=c.create("div","maplibregl-ctrl");const n=c.create("a","maplibregl-ctrl-logo");return n.target="_blank",n.rel="noopener nofollow",n.href="https://maplibre.org/",n.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),n.setAttribute("rel","noopener nofollow"),this._container.appendChild(n),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){c.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class Ea{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const n=++this._id;return this._queue.push({callback:t,id:n,cancelled:!1}),n}remove(t){const n=this._currentlyRunning,a=n?this._queue.concat(n):this._queue;for(const f of a)if(f.id===t)return void(f.cancelled=!0)}run(t=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const n=this._currentlyRunning=this._queue;this._queue=[];for(const a of n)if(!a.cancelled&&(a.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var eo=s.X([{name:"a_pos3d",type:"Int16",components:3}]);class Zt extends s.E{constructor(t){super(),this.sourceCache=t,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.deltaZoom=1,t.usedForTerrain=!0,t.tileSize=this.tileSize*2**this.deltaZoom}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(t,n){this.sourceCache.update(t,n),this._renderableTilesKeys=[];const a={};for(const f of t.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:n}))a[f.key]=!0,this._renderableTilesKeys.push(f.key),this._tiles[f.key]||(f.posMatrix=new Float64Array(16),s.aO(f.posMatrix,0,s.W,0,s.W,0,1),this._tiles[f.key]=new Fi(f,this.tileSize));for(const f in this._tiles)a[f]||delete this._tiles[f]}freeRtt(t){for(const n in this._tiles){const a=this._tiles[n];(!t||a.tileID.equals(t)||a.tileID.isChildOf(t)||t.isChildOf(a.tileID))&&(a.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map(t=>this.getTileByID(t))}getTileByID(t){return this._tiles[t]}getTerrainCoords(t){const n={};for(const a of this._renderableTilesKeys){const f=this._tiles[a].tileID;if(f.canonical.equals(t.canonical)){const v=t.clone();v.posMatrix=new Float64Array(16),s.aO(v.posMatrix,0,s.W,0,s.W,0,1),n[a]=v}else if(f.canonical.isChildOf(t.canonical)){const v=t.clone();v.posMatrix=new Float64Array(16);const I=f.canonical.z-t.canonical.z,k=f.canonical.x-(f.canonical.x>>I<<I),D=f.canonical.y-(f.canonical.y>>I<<I),B=s.W>>I;s.aO(v.posMatrix,0,B,0,B,0,1),s.H(v.posMatrix,v.posMatrix,[-k*B,-D*B,0]),n[a]=v}else if(t.canonical.isChildOf(f.canonical)){const v=t.clone();v.posMatrix=new Float64Array(16);const I=t.canonical.z-f.canonical.z,k=t.canonical.x-(t.canonical.x>>I<<I),D=t.canonical.y-(t.canonical.y>>I<<I),B=s.W>>I;s.aO(v.posMatrix,0,s.W,0,s.W,0,1),s.H(v.posMatrix,v.posMatrix,[k*B,D*B,0]),s.J(v.posMatrix,v.posMatrix,[1/2**I,1/2**I,0]),n[a]=v}}return n}getSourceTile(t,n){const a=this.sourceCache._source;let f=t.overscaledZ-this.deltaZoom;if(f>a.maxzoom&&(f=a.maxzoom),f<a.minzoom)return null;this._sourceTileCache[t.key]||(this._sourceTileCache[t.key]=t.scaledTo(f).key);let v=this.sourceCache.getTileByID(this._sourceTileCache[t.key]);if((!v||!v.dem)&&n)for(;f>=a.minzoom&&(!v||!v.dem);)v=this.sourceCache.getTileByID(t.scaledTo(f--).key);return v}tilesAfterTime(t=Date.now()){return Object.values(this._tiles).filter(n=>n.timeAdded>=t)}}class vc{constructor(t,n,a){this.painter=t,this.sourceCache=new Zt(n),this.options=a,this.exaggeration=typeof a.exaggeration=="number"?a.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(t,n,a,f=s.W){var v;if(!(n>=0&&n<f&&a>=0&&a<f))return 0;const I=this.getTerrainData(t),k=(v=I.tile)===null||v===void 0?void 0:v.dem;if(!k)return 0;const D=function(oe,ve,ce){var Se=ve[0],ke=ve[1];return oe[0]=ce[0]*Se+ce[4]*ke+ce[12],oe[1]=ce[1]*Se+ce[5]*ke+ce[13],oe}([],[n/f*s.W,a/f*s.W],I.u_terrain_matrix),B=[D[0]*k.dim,D[1]*k.dim],G=Math.floor(B[0]),U=Math.floor(B[1]),K=B[0]-G,ie=B[1]-U;return k.get(G,U)*(1-K)*(1-ie)+k.get(G+1,U)*K*(1-ie)+k.get(G,U+1)*(1-K)*ie+k.get(G+1,U+1)*K*ie}getElevationForLngLatZoom(t,n){const{tileID:a,mercatorX:f,mercatorY:v}=this._getOverscaledTileIDFromLngLatZoom(t,n);return this.getElevation(a,f%s.W,v%s.W,s.W)}getElevation(t,n,a,f=s.W){return this.getDEMElevation(t,n,a,f)*this.exaggeration}getTerrainData(t){if(!this._emptyDemTexture){const f=this.painter.context,v=new s.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new Je(f,v,f.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new Je(f,new s.R({width:1,height:1}),f.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(f.gl.NEAREST,f.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=s.an([])}const n=this.sourceCache.getSourceTile(t,!0);if(n&&n.dem&&(!n.demTexture||n.needsTerrainPrepare)){const f=this.painter.context;n.demTexture=this.painter.getTileTexture(n.dem.stride),n.demTexture?n.demTexture.update(n.dem.getPixels(),{premultiply:!1}):n.demTexture=new Je(f,n.dem.getPixels(),f.gl.RGBA,{premultiply:!1}),n.demTexture.bind(f.gl.NEAREST,f.gl.CLAMP_TO_EDGE),n.needsTerrainPrepare=!1}const a=n&&n+n.tileID.key+t.key;if(a&&!this._demMatrixCache[a]){const f=this.sourceCache.sourceCache._source.maxzoom;let v=t.canonical.z-n.tileID.canonical.z;t.overscaledZ>t.canonical.z&&(t.canonical.z>=f?v=t.canonical.z-f:s.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const I=t.canonical.x-(t.canonical.x>>v<<v),k=t.canonical.y-(t.canonical.y>>v<<v),D=s.ba(new Float64Array(16),[1/(s.W<<v),1/(s.W<<v),0]);s.H(D,D,[I*s.W,k*s.W,0]),this._demMatrixCache[t.key]={matrix:D,coord:t}}return{u_depth:2,u_terrain:3,u_terrain_dim:n&&n.dem&&n.dem.dim||1,u_terrain_matrix:a?this._demMatrixCache[t.key].matrix:this._emptyDemMatrix,u_terrain_unpack:n&&n.dem&&n.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(n&&n.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:n}}getFramebuffer(t){const n=this.painter,a=n.width/devicePixelRatio,f=n.height/devicePixelRatio;return!this._fbo||this._fbo.width===a&&this._fbo.height===f||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new Je(n.context,{width:a,height:f,data:null},n.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(n.context.gl.NEAREST,n.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new Je(n.context,{width:a,height:f,data:null},n.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(n.context.gl.NEAREST,n.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=n.context.createFramebuffer(a,f,!0,!1),this._fbo.depthAttachment.set(n.context.createRenderbuffer(n.context.gl.DEPTH_COMPONENT16,a,f))),this._fbo.colorAttachment.set(t==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const t=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const n=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let v=0,I=0;v<this._coordsTextureSize;v++)for(let k=0;k<this._coordsTextureSize;k++,I+=4)n[I+0]=255&k,n[I+1]=255&v,n[I+2]=k>>8<<4|v>>8,n[I+3]=0;const a=new s.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(n.buffer)),f=new Je(t,a,t.gl.RGBA,{premultiply:!1});return f.bind(t.gl.NEAREST,t.gl.CLAMP_TO_EDGE),this._coordsTexture=f,f}pointCoordinate(t){this.painter.maybeDrawDepthAndCoords(!0);const n=new Uint8Array(4),a=this.painter.context,f=a.gl,v=Math.round(t.x*this.painter.pixelRatio/devicePixelRatio),I=Math.round(t.y*this.painter.pixelRatio/devicePixelRatio),k=Math.round(this.painter.height/devicePixelRatio);a.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),f.readPixels(v,k-I-1,1,1,f.RGBA,f.UNSIGNED_BYTE,n),a.bindFramebuffer.set(null);const D=n[0]+(n[2]>>4<<8),B=n[1]+((15&n[2])<<8),G=this.coordsIndex[255-n[3]],U=G&&this.sourceCache.getTileByID(G);if(!U)return null;const K=this._coordsTextureSize,ie=(1<<U.tileID.canonical.z)*K;return new s.Y((U.tileID.canonical.x*K+D)/ie+U.tileID.wrap,(U.tileID.canonical.y*K+B)/ie,this.getElevation(U.tileID,D,B,K))}depthAtPoint(t){const n=new Uint8Array(4),a=this.painter.context,f=a.gl;return a.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),f.readPixels(t.x,this.painter.height/devicePixelRatio-t.y-1,1,1,f.RGBA,f.UNSIGNED_BYTE,n),a.bindFramebuffer.set(null),(n[0]/16777216+n[1]/65536+n[2]/256+n[3])/256}getTerrainMesh(){if(this._mesh)return this._mesh;const t=this.painter.context,n=new s.bb,a=new s.aY,f=this.meshSize,v=s.W/f,I=f*f;for(let U=0;U<=f;U++)for(let K=0;K<=f;K++)n.emplaceBack(K*v,U*v,0);for(let U=0;U<I;U+=f+1)for(let K=0;K<f;K++)a.emplaceBack(K+U,f+K+U+1,f+K+U+2),a.emplaceBack(K+U,f+K+U+2,K+U+1);const k=n.length,D=k+2*(f+1);for(const U of[0,1])for(let K=0;K<=f;K++)for(const ie of[0,1])n.emplaceBack(K*v,U*s.W,ie);for(let U=0;U<2*f;U+=2)a.emplaceBack(D+U,D+U+1,D+U+3),a.emplaceBack(D+U,D+U+3,D+U+2),a.emplaceBack(k+U,k+U+3,k+U+1),a.emplaceBack(k+U,k+U+2,k+U+3);const B=n.length,G=B+2*(f+1);for(const U of[0,1])for(let K=0;K<=f;K++)for(const ie of[0,1])n.emplaceBack(U*s.W,K*v,ie);for(let U=0;U<2*f;U+=2)a.emplaceBack(B+U,B+U+1,B+U+3),a.emplaceBack(B+U,B+U+3,B+U+2),a.emplaceBack(G+U,G+U+3,G+U+1),a.emplaceBack(G+U,G+U+2,G+U+3);return this._mesh={indexBuffer:t.createIndexBuffer(a),vertexBuffer:t.createVertexBuffer(n,eo.members),segments:s.$.simpleSegment(0,0,n.length,a.length)},this._mesh}getMeshFrameDelta(t){return 2*Math.PI*s.bc/Math.pow(2,t)/5}getMinTileElevationForLngLatZoom(t,n){var a;const{tileID:f}=this._getOverscaledTileIDFromLngLatZoom(t,n);return(a=this.getMinMaxElevation(f).minElevation)!==null&&a!==void 0?a:0}getMinMaxElevation(t){const n=this.getTerrainData(t).tile,a={minElevation:null,maxElevation:null};return n&&n.dem&&(a.minElevation=n.dem.min*this.exaggeration,a.maxElevation=n.dem.max*this.exaggeration),a}_getOverscaledTileIDFromLngLatZoom(t,n){const a=s.Y.fromLngLat(t.wrap()),f=(1<<n)*s.W,v=a.x*f,I=a.y*f,k=Math.floor(v/s.W),D=Math.floor(I/s.W);return{tileID:new s.Q(n,0,n,k,D),mercatorX:v,mercatorY:I}}}class Pa{constructor(t,n,a){this._context=t,this._size=n,this._tileSize=a,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const t of this._objects)t.texture.destroy(),t.fbo.destroy()}_createObject(t){const n=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),a=new Je(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return a.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),n.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),n.colorAttachment.set(a.texture),{id:t,fbo:n,texture:a,stamp:-1,inUse:!1}}getObjectForId(t){return this._objects[t]}useObject(t){t.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter(n=>t.id!==n),this._recentlyUsed.push(t.id)}stampObject(t){t.stamp=++this._stamp}getOrCreateFreeObject(){for(const n of this._recentlyUsed)if(!this._objects[n].inUse)return this._objects[n];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const t=this._createObject(this._objects.length);return this._objects.push(t),t}freeObject(t){t.inUse=!1}freeAllObjects(){for(const t of this._objects)this.freeObject(t)}isFull(){return!(this._objects.length<this._size)&&this._objects.some(t=>!t.inUse)===!1}}const _s={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0};class xc{constructor(t,n){this.painter=t,this.terrain=n,this.pool=new Pa(t.context,30,n.sourceCache.tileSize*n.qualityFactor)}destruct(){this.pool.destruct()}getTexture(t){return this.pool.getObjectForId(t.rtt[this._stacks.length-1].id).texture}prepareForRender(t,n){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=t._order.filter(a=>!t._layers[a].isHidden(n)),this._coordsDescendingInv={};for(const a in t.sourceCaches){this._coordsDescendingInv[a]={};const f=t.sourceCaches[a].getVisibleCoordinates();for(const v of f){const I=this.terrain.sourceCache.getTerrainCoords(v);for(const k in I)this._coordsDescendingInv[a][k]||(this._coordsDescendingInv[a][k]=[]),this._coordsDescendingInv[a][k].push(I[k])}}this._coordsDescendingInvStr={};for(const a of t._order){const f=t._layers[a],v=f.source;if(_s[f.type]&&!this._coordsDescendingInvStr[v]){this._coordsDescendingInvStr[v]={};for(const I in this._coordsDescendingInv[v])this._coordsDescendingInvStr[v][I]=this._coordsDescendingInv[v][I].map(k=>k.key).sort().join()}}for(const a of this._renderableTiles)for(const f in this._coordsDescendingInvStr){const v=this._coordsDescendingInvStr[f][a.tileID.key];v&&v!==a.rttCoords[f]&&(a.rtt=[])}}renderLayer(t){if(t.isHidden(this.painter.transform.zoom))return!1;const n=t.type,a=this.painter,f=this._renderableLayerIds[this._renderableLayerIds.length-1]===t.id;if(_s[n]&&(this._prevType&&_s[this._prevType]||this._stacks.push([]),this._prevType=n,this._stacks[this._stacks.length-1].push(t.id),!f))return!0;if(_s[this._prevType]||_s[n]&&f){this._prevType=n;const v=this._stacks.length-1,I=this._stacks[v]||[];for(const k of this._renderableTiles){if(this.pool.isFull()&&(je(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(k),k.rtt[v]){const B=this.pool.getObjectForId(k.rtt[v].id);if(B.stamp===k.rtt[v].stamp){this.pool.useObject(B);continue}}const D=this.pool.getOrCreateFreeObject();this.pool.useObject(D),this.pool.stampObject(D),k.rtt[v]={id:D.id,stamp:D.stamp},a.context.bindFramebuffer.set(D.fbo.framebuffer),a.context.clear({color:s.aP.transparent,stencil:0}),a.currentStencilSource=void 0;for(let B=0;B<I.length;B++){const G=a.style._layers[I[B]],U=G.source?this._coordsDescendingInv[G.source][k.tileID.key]:[k.tileID];a.context.viewport.set([0,0,D.fbo.width,D.fbo.height]),a._renderTileClippingMasks(G,U),a.renderLayer(a,a.style.sourceCaches[G.source],G,U),G.source&&(k.rttCoords[G.source]=this._coordsDescendingInvStr[G.source][k.tileID.key])}}return je(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects(),_s[n]}return!1}}const Wt={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use  + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},Bl=p,sh={hash:!1,interactive:!0,bearingSnap:7,attributionControl:_c,maplibreLogo:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,refreshExpiredTiles:!0,scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],zoom:0,bearing:0,pitch:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:s.a.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0},bc=y=>{y.touchstart=y.dragStart,y.touchmoveWindow=y.dragMove,y.touchend=y.dragEnd},jl={showCompass:!0,showZoom:!0,visualizePitch:!1};class wc{constructor(t,n,a=!1){this.mousedown=I=>{this.startMouse(s.e({},I,{ctrlKey:!0,preventDefault:()=>I.preventDefault()}),c.mousePos(this.element,I)),c.addEventListener(window,"mousemove",this.mousemove),c.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=I=>{this.moveMouse(I,c.mousePos(this.element,I))},this.mouseup=I=>{this.mouseRotate.dragEnd(I),this.mousePitch&&this.mousePitch.dragEnd(I),this.offTemp()},this.touchstart=I=>{I.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=c.touchPos(this.element,I.targetTouches)[0],this.startTouch(I,this._startPos),c.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),c.addEventListener(window,"touchend",this.touchend))},this.touchmove=I=>{I.targetTouches.length!==1?this.reset():(this._lastPos=c.touchPos(this.element,I.targetTouches)[0],this.moveTouch(I,this._lastPos))},this.touchend=I=>{I.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),this.touchRotate.reset(),this.touchPitch&&this.touchPitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10;const f=t.dragRotate._mouseRotate.getClickTolerance(),v=t.dragRotate._mousePitch.getClickTolerance();this.element=n,this.mouseRotate=zr({clickTolerance:f,enable:!0}),this.touchRotate=(({enable:I,clickTolerance:k,bearingDegreesPerPixelMoved:D=.8})=>{const B=new sr;return new Zr({clickTolerance:k,move:(G,U)=>({bearingDelta:(U.x-G.x)*D}),moveStateManager:B,enable:I,assignEvents:bc})})({clickTolerance:f,enable:!0}),this.map=t,a&&(this.mousePitch=Io({clickTolerance:v,enable:!0}),this.touchPitch=(({enable:I,clickTolerance:k,pitchDegreesPerPixelMoved:D=-.5})=>{const B=new sr;return new Zr({clickTolerance:k,move:(G,U)=>({pitchDelta:(U.y-G.y)*D}),moveStateManager:B,enable:I,assignEvents:bc})})({clickTolerance:v,enable:!0})),c.addEventListener(n,"mousedown",this.mousedown),c.addEventListener(n,"touchstart",this.touchstart,{passive:!1}),c.addEventListener(n,"touchcancel",this.reset)}startMouse(t,n){this.mouseRotate.dragStart(t,n),this.mousePitch&&this.mousePitch.dragStart(t,n),c.disableDrag()}startTouch(t,n){this.touchRotate.dragStart(t,n),this.touchPitch&&this.touchPitch.dragStart(t,n),c.disableDrag()}moveMouse(t,n){const a=this.map,{bearingDelta:f}=this.mouseRotate.dragMove(t,n)||{};if(f&&a.setBearing(a.getBearing()+f),this.mousePitch){const{pitchDelta:v}=this.mousePitch.dragMove(t,n)||{};v&&a.setPitch(a.getPitch()+v)}}moveTouch(t,n){const a=this.map,{bearingDelta:f}=this.touchRotate.dragMove(t,n)||{};if(f&&a.setBearing(a.getBearing()+f),this.touchPitch){const{pitchDelta:v}=this.touchPitch.dragMove(t,n)||{};v&&a.setPitch(a.getPitch()+v)}}off(){const t=this.element;c.removeEventListener(t,"mousedown",this.mousedown),c.removeEventListener(t,"touchstart",this.touchstart,{passive:!1}),c.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),c.removeEventListener(window,"touchend",this.touchend),c.removeEventListener(t,"touchcancel",this.reset),this.offTemp()}offTemp(){c.enableDrag(),c.removeEventListener(window,"mousemove",this.mousemove),c.removeEventListener(window,"mouseup",this.mouseup),c.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),c.removeEventListener(window,"touchend",this.touchend)}}let to;function Cc(y,t,n){const a=new s.M(y.lng,y.lat);if(y=new s.M(y.lng,y.lat),t){const f=new s.M(y.lng-360,y.lat),v=new s.M(y.lng+360,y.lat),I=n.locationPoint(y).distSqr(t);n.locationPoint(f).distSqr(t)<I?y=f:n.locationPoint(v).distSqr(t)<I&&(y=v)}for(;Math.abs(y.lng-n.center.lng)>180;){const f=n.locationPoint(y);if(f.x>=0&&f.y>=0&&f.x<=n.width&&f.y<=n.height)break;y.lng>n.center.lng?y.lng-=360:y.lng+=360}return y.lng!==a.lng&&n.locationPoint(y).y>n.height/2-n.getHorizon()?y:a}const Nl={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function io(y,t,n){const a=y.classList;for(const f in Nl)a.remove(`maplibregl-${n}-anchor-${f}`);a.add(`maplibregl-${n}-anchor-${t}`)}class hr extends s.E{constructor(t){if(super(),this._onKeyPress=n=>{const a=n.code,f=n.charCode||n.keyCode;a!=="Space"&&a!=="Enter"&&f!==32&&f!==13||this.togglePopup()},this._onMapClick=n=>{const a=n.originalEvent.target,f=this._element;this._popup&&(a===f||f.contains(a))&&this.togglePopup()},this._update=n=>{var a;if(!this._map)return;const f=this._map.loaded()&&!this._map.isMoving();((n==null?void 0:n.type)==="terrain"||(n==null?void 0:n.type)==="render"&&!f)&&this._map.once("render",this._update),this._lngLat=this._map.transform.renderWorldCopies?Cc(this._lngLat,this._flatPos,this._map.transform):(a=this._lngLat)===null||a===void 0?void 0:a.wrap(),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationPoint(this._lngLat)._add(this._offset));let v="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?v=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(v=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let I="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?I="rotateX(0deg)":this._pitchAlignment==="map"&&(I=`rotateX(${this._map.getPitch()}deg)`),n&&n.type!=="moveend"||(this._pos=this._pos.round()),c.setTransform(this._element,`${Nl[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${I} ${v}`),l.frameAsync(new AbortController).then(()=>{this._updateOpacity(n&&n.type==="moveend")}).catch(()=>{})},this._onMove=n=>{if(!this._isDragging){const a=this._clickTolerance||this._map._clickTolerance;this._isDragging=n.point.dist(this._pointerdownPos)>=a}this._isDragging&&(this._pos=n.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.k("dragstart"))),this.fire(new s.k("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new s.k("dragend")),this._state="inactive"},this._addDragHandler=n=>{this._element.contains(n.originalEvent.target)&&(n.preventDefault(),this._positionDelta=n.point.sub(this._pos).add(this._offset),this._pointerdownPos=n.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&t.pitchAlignment!=="auto"?t.pitchAlignment:this._rotationAlignment,this.setOpacity(),this.setOpacity(t==null?void 0:t.opacity,t==null?void 0:t.opacityWhenCovered),t&&t.element)this._element=t.element,this._offset=s.P.convert(t&&t.offset||[0,0]);else{this._defaultMarker=!0,this._element=c.create("div");const n=c.createNS("http://www.w3.org/2000/svg","svg"),a=41,f=27;n.setAttributeNS(null,"display","block"),n.setAttributeNS(null,"height",`${a}px`),n.setAttributeNS(null,"width",`${f}px`),n.setAttributeNS(null,"viewBox",`0 0 ${f} ${a}`);const v=c.createNS("http://www.w3.org/2000/svg","g");v.setAttributeNS(null,"stroke","none"),v.setAttributeNS(null,"stroke-width","1"),v.setAttributeNS(null,"fill","none"),v.setAttributeNS(null,"fill-rule","evenodd");const I=c.createNS("http://www.w3.org/2000/svg","g");I.setAttributeNS(null,"fill-rule","nonzero");const k=c.createNS("http://www.w3.org/2000/svg","g");k.setAttributeNS(null,"transform","translate(3.0, 29.0)"),k.setAttributeNS(null,"fill","#000000");const D=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const Se of D){const ke=c.createNS("http://www.w3.org/2000/svg","ellipse");ke.setAttributeNS(null,"opacity","0.04"),ke.setAttributeNS(null,"cx","10.5"),ke.setAttributeNS(null,"cy","5.80029008"),ke.setAttributeNS(null,"rx",Se.rx),ke.setAttributeNS(null,"ry",Se.ry),k.appendChild(ke)}const B=c.createNS("http://www.w3.org/2000/svg","g");B.setAttributeNS(null,"fill",this._color);const G=c.createNS("http://www.w3.org/2000/svg","path");G.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),B.appendChild(G);const U=c.createNS("http://www.w3.org/2000/svg","g");U.setAttributeNS(null,"opacity","0.25"),U.setAttributeNS(null,"fill","#000000");const K=c.createNS("http://www.w3.org/2000/svg","path");K.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),U.appendChild(K);const ie=c.createNS("http://www.w3.org/2000/svg","g");ie.setAttributeNS(null,"transform","translate(6.0, 7.0)"),ie.setAttributeNS(null,"fill","#FFFFFF");const oe=c.createNS("http://www.w3.org/2000/svg","g");oe.setAttributeNS(null,"transform","translate(8.0, 8.0)");const ve=c.createNS("http://www.w3.org/2000/svg","circle");ve.setAttributeNS(null,"fill","#000000"),ve.setAttributeNS(null,"opacity","0.25"),ve.setAttributeNS(null,"cx","5.5"),ve.setAttributeNS(null,"cy","5.5"),ve.setAttributeNS(null,"r","5.4999962");const ce=c.createNS("http://www.w3.org/2000/svg","circle");ce.setAttributeNS(null,"fill","#FFFFFF"),ce.setAttributeNS(null,"cx","5.5"),ce.setAttributeNS(null,"cy","5.5"),ce.setAttributeNS(null,"r","5.4999962"),oe.appendChild(ve),oe.appendChild(ce),I.appendChild(k),I.appendChild(B),I.appendChild(U),I.appendChild(ie),I.appendChild(oe),n.appendChild(I),n.setAttributeNS(null,"height",a*this._scale+"px"),n.setAttributeNS(null,"width",f*this._scale+"px"),this._element.appendChild(n),this._offset=s.P.convert(t&&t.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",n=>{n.preventDefault()}),this._element.addEventListener("mousedown",n=>{n.preventDefault()}),io(this._element,this._anchor,"marker"),t&&t.className)for(const n of t.className.split(" "))this._element.classList.add(n);this._popup=null}addTo(t){return this.remove(),this._map=t,this._element.setAttribute("aria-label",t._getUIString("Marker.Title")),t.getCanvasContainer().appendChild(this._element),t.on("move",this._update),t.on("moveend",this._update),t.on("terrain",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),c.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=s.M.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const f=Math.abs(13.5)/Math.SQRT2;t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[f,-1*(38.1-13.5+f)],"bottom-right":[-f,-1*(38.1-13.5+f)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}getPopup(){return this._popup}togglePopup(){const t=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:t?(t.isOpen()?t.remove():(t.setLngLat(this._lngLat),t.addTo(this._map)),this):this}_updateOpacity(t=!1){var n,a;if(!(!((n=this._map)===null||n===void 0)&&n.terrain))return void(this._element.style.opacity!==this._opacity&&(this._element.style.opacity=this._opacity));if(t)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout(()=>{this._opacityTimeout=null},100)}const f=this._map,v=f.terrain.depthAtPoint(this._pos),I=f.terrain.getElevationForLngLatZoom(this._lngLat,f.transform.tileZoom);if(f.transform.lngLatToCameraDepth(this._lngLat,I)-v<.006)return void(this._element.style.opacity=this._opacity);const k=-this._offset.y/f.transform._pixelPerMeter,D=Math.sin(f.getPitch()*Math.PI/180)*k,B=f.terrain.depthAtPoint(new s.P(this._pos.x,this._pos.y-this._offset.y)),G=f.transform.lngLatToCameraDepth(this._lngLat,I+D)-B>.006;!((a=this._popup)===null||a===void 0)&&a.isOpen()&&G&&this._popup.remove(),this._element.style.opacity=G?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(t){return this._offset=s.P.convert(t),this._update(),this}addClassName(t){this._element.classList.add(t)}removeClassName(t){this._element.classList.remove(t)}toggleClassName(t){return this._element.classList.toggle(t)}setDraggable(t){return this._draggable=!!t,this._map&&(t?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t&&t!=="auto"?t:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(t,n){return t===void 0&&n===void 0&&(this._opacity="1",this._opacityWhenCovered="0.2"),t!==void 0&&(this._opacity=t),n!==void 0&&(this._opacityWhenCovered=n),this._map&&this._updateOpacity(!0),this}}const tl={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let Zo=0,Ko=!1;const Sc={maxWidth:100,unit:"metric"};function Vl(y,t,n){const a=n&&n.maxWidth||100,f=y._container.clientHeight/2,v=y.unproject([0,f]),I=y.unproject([a,f]),k=v.distanceTo(I);if(n&&n.unit==="imperial"){const D=3.2808*k;D>5280?Ia(t,a,D/5280,y._getUIString("ScaleControl.Miles")):Ia(t,a,D,y._getUIString("ScaleControl.Feet"))}else n&&n.unit==="nautical"?Ia(t,a,k/1852,y._getUIString("ScaleControl.NauticalMiles")):k>=1e3?Ia(t,a,k/1e3,y._getUIString("ScaleControl.Kilometers")):Ia(t,a,k,y._getUIString("ScaleControl.Meters"))}function Ia(y,t,n,a){const f=function(v){const I=Math.pow(10,`${Math.floor(v)}`.length-1);let k=v/I;return k=k>=10?10:k>=5?5:k>=3?3:k>=2?2:k>=1?1:function(D){const B=Math.pow(10,Math.ceil(-Math.log(D)/Math.LN10));return Math.round(D*B)/B}(k),I*k}(n);y.style.width=t*(f/n)+"px",y.innerHTML=`${f}&nbsp;${a}`}const ys={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1},il=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function ai(y){if(y){if(typeof y=="number"){const t=Math.round(Math.abs(y)/Math.SQRT2);return{center:new s.P(0,0),top:new s.P(0,y),"top-left":new s.P(t,t),"top-right":new s.P(-t,t),bottom:new s.P(0,-y),"bottom-left":new s.P(t,-t),"bottom-right":new s.P(-t,-t),left:new s.P(y,0),right:new s.P(-y,0)}}if(y instanceof s.P||Array.isArray(y)){const t=s.P.convert(y);return{center:t,top:t,"top-left":t,"top-right":t,bottom:t,"bottom-left":t,"bottom-right":t,left:t,right:t}}return{center:s.P.convert(y.center||[0,0]),top:s.P.convert(y.top||[0,0]),"top-left":s.P.convert(y["top-left"]||[0,0]),"top-right":s.P.convert(y["top-right"]||[0,0]),bottom:s.P.convert(y.bottom||[0,0]),"bottom-left":s.P.convert(y["bottom-left"]||[0,0]),"bottom-right":s.P.convert(y["bottom-right"]||[0,0]),left:s.P.convert(y.left||[0,0]),right:s.P.convert(y.right||[0,0])}}return ai(new s.P(0,0))}const gi=p;N.AJAXError=s.bf,N.Evented=s.E,N.LngLat=s.M,N.MercatorCoordinate=s.Y,N.Point=s.P,N.addProtocol=s.bg,N.config=s.a,N.removeProtocol=s.bh,N.AttributionControl=yc,N.BoxZoomHandler=Ri,N.CanvasSource=St,N.CooperativeGesturesHandler=Hn,N.DoubleClickZoomHandler=Ll,N.DragPanHandler=Fl,N.DragRotateHandler=Yo,N.EdgeInsets=Yi,N.FullscreenControl=class extends s.E{constructor(y={}){super(),this._onFullscreenChange=()=>{var t;let n=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((t=n==null?void 0:n.shadowRoot)===null||t===void 0)&&t.fullscreenElement;)n=n.shadowRoot.fullscreenElement;n===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,y&&y.container&&(y.container instanceof HTMLElement?this._container=y.container:s.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(y){return this._map=y,this._container||(this._container=this._map.getContainer()),this._controlContainer=c.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){c.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const y=this._fullscreenButton=c.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);c.create("span","maplibregl-ctrl-icon",y).setAttribute("aria-hidden","true"),y.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const y=this._getTitle();this._fullscreenButton.setAttribute("aria-label",y),this._fullscreenButton.title=y}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new s.k("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new s.k("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},N.GeoJSONSource=ft,N.GeolocateControl=class extends s.E{constructor(y){super(),this._onSuccess=t=>{if(this._map){if(this._isOutOfMapMaxBounds(t))return this._setErrorState(),this.fire(new s.k("outofmaxbounds",t)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=t,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(t),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(t),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new s.k("geolocate",t)),this._finish()}},this._updateCamera=t=>{const n=new s.M(t.coords.longitude,t.coords.latitude),a=t.coords.accuracy,f=this._map.getBearing(),v=s.e({bearing:f},this.options.fitBoundsOptions),I=Oe.fromLngLat(n,a);this._map.fitBounds(I,v,{geolocateSource:!0})},this._updateMarker=t=>{if(t){const n=new s.M(t.coords.longitude,t.coords.latitude);this._accuracyCircleMarker.setLngLat(n).addTo(this._map),this._userLocationDotMarker.setLngLat(n).addTo(this._map),this._accuracy=t.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=t=>{if(this._map){if(this.options.trackUserLocation)if(t.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const n=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=n,this._geolocateButton.setAttribute("aria-label",n),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(t.code===3&&Ko)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new s.k("error",t)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=t=>{if(this._map){if(this._container.addEventListener("contextmenu",n=>n.preventDefault()),this._geolocateButton=c.create("button","maplibregl-ctrl-geolocate",this._container),c.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",t===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const n=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=n,this._geolocateButton.setAttribute("aria-label",n)}else{const n=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.title=n,this._geolocateButton.setAttribute("aria-label",n)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=c.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new hr({element:this._dotElement}),this._circleElement=c.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new hr({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",()=>this.trigger()),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",n=>{n.geolocateSource||this._watchState!=="ACTIVE_LOCK"||n.originalEvent&&n.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new s.k("trackuserlocationend")),this.fire(new s.k("userlocationlostfocus")))})}},this.options=s.e({},tl,y)}onAdd(y){return this._map=y,this._container=c.create("div","maplibregl-ctrl maplibregl-ctrl-group"),function(){return s._(this,arguments,void 0,function*(t=!1){if(to!==void 0&&!t)return to;if(window.navigator.permissions===void 0)return to=!!window.navigator.geolocation,to;try{to=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{to=!!window.navigator.geolocation}return to})}().then(t=>this._setupUI(t)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),c.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,Zo=0,Ko=!1}_isOutOfMapMaxBounds(y){const t=this._map.getMaxBounds(),n=y.coords;return t&&(n.longitude<t.getWest()||n.longitude>t.getEast()||n.latitude<t.getSouth()||n.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const y=this._map.getBounds(),t=y.getSouthEast(),n=y.getNorthEast(),a=t.distanceTo(n),f=Math.ceil(this._accuracy/(a/this._map._container.clientHeight)*2);this._circleElement.style.width=`${f}px`,this._circleElement.style.height=`${f}px`}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.k("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Zo--,Ko=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new s.k("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.k("trackuserlocationstart")),this.fire(new s.k("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let y;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Zo++,Zo>1?(y={maximumAge:6e5,timeout:0},Ko=!0):(y=this.options.positionOptions,Ko=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,y)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},N.Hash=mn,N.ImageSource=$t,N.KeyboardHandler=Qs,N.LngLatBounds=Oe,N.LogoControl=Rl,N.Map=class extends nh{constructor(y){s.bd.mark(s.be.create);const t=Object.assign(Object.assign({},sh),y);if(t.minZoom!=null&&t.maxZoom!=null&&t.minZoom>t.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(t.minPitch!=null&&t.maxPitch!=null&&t.minPitch>t.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(t.minPitch!=null&&t.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(t.maxPitch!=null&&t.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(super(new fr(t.minZoom,t.maxZoom,t.minPitch,t.maxPitch,t.renderWorldCopies),{bearingSnap:t.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new Ea,this._controls=[],this._mapId=s.a3(),this._contextLost=n=>{n.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new s.k("webglcontextlost",{originalEvent:n}))},this._contextRestored=n=>{this._setupPainter(),this.resize(),this._update(),this.fire(new s.k("webglcontextrestored",{originalEvent:n}))},this._onMapScroll=n=>{if(n.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=t.interactive,this._maxTileCacheSize=t.maxTileCacheSize,this._maxTileCacheZoomLevels=t.maxTileCacheZoomLevels,this._failIfMajorPerformanceCaveat=t.failIfMajorPerformanceCaveat===!0,this._preserveDrawingBuffer=t.preserveDrawingBuffer===!0,this._antialias=t.antialias===!0,this._trackResize=t.trackResize===!0,this._bearingSnap=t.bearingSnap,this._refreshExpiredTiles=t.refreshExpiredTiles===!0,this._fadeDuration=t.fadeDuration,this._crossSourceCollisions=t.crossSourceCollisions===!0,this._collectResourceTiming=t.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},Wt),t.locale),this._clickTolerance=t.clickTolerance,this._overridePixelRatio=t.pixelRatio,this._maxCanvasSize=t.maxCanvasSize,this.transformCameraUpdate=t.transformCameraUpdate,this.cancelPendingTileRequestsWhileZooming=t.cancelPendingTileRequestsWhileZooming===!0,this._imageQueueHandle=O.addThrottleControl(()=>this.isMoving()),this._requestManager=new L(t.transformRequest),typeof t.container=="string"){if(this._container=document.getElementById(t.container),!this._container)throw new Error(`Container '${t.container}' not found.`)}else{if(!(t.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=t.container}if(t.maxBounds&&this.setMaxBounds(t.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",()=>this._update(!1)).on("moveend",()=>this._update(!1)).on("zoom",()=>this._update(!0)).on("terrain",()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)}).once("idle",()=>{this._idleTriggered=!0}),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let n=!1;const a=Er(f=>{this._trackResize&&!this._removed&&this.resize(f)._update()},50);this._resizeObserver=new ResizeObserver(f=>{n?a(f):n=!0}),this._resizeObserver.observe(this._container)}this.handlers=new Ta(this,t),this._hash=t.hash&&new mn(typeof t.hash=="string"&&t.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:t.center,zoom:t.zoom,bearing:t.bearing,pitch:t.pitch}),t.bounds&&(this.resize(),this.fitBounds(t.bounds,s.e({},t.fitBoundsOptions,{duration:0})))),this.resize(),this._localIdeographFontFamily=t.localIdeographFontFamily,this._validateStyle=t.validateStyle,t.style&&this.setStyle(t.style,{localIdeographFontFamily:t.localIdeographFontFamily}),t.attributionControl&&this.addControl(new yc(typeof t.attributionControl=="boolean"?void 0:t.attributionControl)),t.maplibreLogo&&this.addControl(new Rl,t.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",n=>{this._update(n.dataType==="style"),this.fire(new s.k(`${n.dataType}data`,n))}),this.on("dataloading",n=>{this.fire(new s.k(`${n.dataType}dataloading`,n))}),this.on("dataabort",n=>{this.fire(new s.k("sourcedataabort",n))})}_getMapId(){return this._mapId}addControl(y,t){if(t===void 0&&(t=y.getDefaultPosition?y.getDefaultPosition():"top-right"),!y||!y.onAdd)return this.fire(new s.j(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=y.onAdd(this);this._controls.push(y);const a=this._controlPositions[t];return t.indexOf("bottom")!==-1?a.insertBefore(n,a.firstChild):a.appendChild(n),this}removeControl(y){if(!y||!y.onRemove)return this.fire(new s.j(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(y);return t>-1&&this._controls.splice(t,1),y.onRemove(this),this}hasControl(y){return this._controls.indexOf(y)>-1}calculateCameraOptionsFromTo(y,t,n,a){return a==null&&this.terrain&&(a=this.terrain.getElevationForLngLatZoom(n,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(y,t,n,a)}resize(y){var t;const n=this._containerDimensions(),a=n[0],f=n[1],v=this._getClampedPixelRatio(a,f);if(this._resizeCanvas(a,f,v),this.painter.resize(a,f,v),this.painter.overLimit()){const k=this.painter.context.gl;this._maxCanvasSize=[k.drawingBufferWidth,k.drawingBufferHeight];const D=this._getClampedPixelRatio(a,f);this._resizeCanvas(a,f,D),this.painter.resize(a,f,D)}this.transform.resize(a,f),(t=this._requestedCameraState)===null||t===void 0||t.resize(a,f);const I=!this._moving;return I&&(this.stop(),this.fire(new s.k("movestart",y)).fire(new s.k("move",y))),this.fire(new s.k("resize",y)),I&&this.fire(new s.k("moveend",y)),this}_getClampedPixelRatio(y,t){const{0:n,1:a}=this._maxCanvasSize,f=this.getPixelRatio(),v=y*f,I=t*f;return Math.min(v>n?n/v:1,I>a?a/I:1)*f}getPixelRatio(){var y;return(y=this._overridePixelRatio)!==null&&y!==void 0?y:devicePixelRatio}setPixelRatio(y){this._overridePixelRatio=y,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(y){return this.transform.setMaxBounds(Oe.convert(y)),this._update()}setMinZoom(y){if((y=y??-2)>=-2&&y<=this.transform.maxZoom)return this.transform.minZoom=y,this._update(),this.getZoom()<y&&this.setZoom(y),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(y){if((y=y??22)>=this.transform.minZoom)return this.transform.maxZoom=y,this._update(),this.getZoom()>y&&this.setZoom(y),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(y){if((y=y??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(y>=0&&y<=this.transform.maxPitch)return this.transform.minPitch=y,this._update(),this.getPitch()<y&&this.setPitch(y),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(y){if((y=y??60)>85)throw new Error("maxPitch must be less than or equal to 85");if(y>=this.transform.minPitch)return this.transform.maxPitch=y,this._update(),this.getPitch()>y&&this.setPitch(y),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(y){return this.transform.renderWorldCopies=y,this._update()}project(y){return this.transform.locationPoint(s.M.convert(y),this.style&&this.terrain)}unproject(y){return this.transform.pointLocation(s.P.convert(y),this.terrain)}isMoving(){var y;return this._moving||((y=this.handlers)===null||y===void 0?void 0:y.isMoving())}isZooming(){var y;return this._zooming||((y=this.handlers)===null||y===void 0?void 0:y.isZooming())}isRotating(){var y;return this._rotating||((y=this.handlers)===null||y===void 0?void 0:y.isRotating())}_createDelegatedListener(y,t,n){if(y==="mouseenter"||y==="mouseover"){let a=!1;return{layer:t,listener:n,delegates:{mousemove:v=>{const I=this.getLayer(t)?this.queryRenderedFeatures(v.point,{layers:[t]}):[];I.length?a||(a=!0,n.call(this,new Ir(y,this,v.originalEvent,{features:I}))):a=!1},mouseout:()=>{a=!1}}}}if(y==="mouseleave"||y==="mouseout"){let a=!1;return{layer:t,listener:n,delegates:{mousemove:I=>{(this.getLayer(t)?this.queryRenderedFeatures(I.point,{layers:[t]}):[]).length?a=!0:a&&(a=!1,n.call(this,new Ir(y,this,I.originalEvent)))},mouseout:I=>{a&&(a=!1,n.call(this,new Ir(y,this,I.originalEvent)))}}}}{const a=f=>{const v=this.getLayer(t)?this.queryRenderedFeatures(f.point,{layers:[t]}):[];v.length&&(f.features=v,n.call(this,f),delete f.features)};return{layer:t,listener:n,delegates:{[y]:a}}}}on(y,t,n){if(n===void 0)return super.on(y,t);const a=this._createDelegatedListener(y,t,n);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[y]=this._delegatedListeners[y]||[],this._delegatedListeners[y].push(a);for(const f in a.delegates)this.on(f,a.delegates[f]);return this}once(y,t,n){if(n===void 0)return super.once(y,t);const a=this._createDelegatedListener(y,t,n);for(const f in a.delegates)this.once(f,a.delegates[f]);return this}off(y,t,n){return n===void 0?super.off(y,t):(this._delegatedListeners&&this._delegatedListeners[y]&&(a=>{const f=this._delegatedListeners[y];for(let v=0;v<f.length;v++){const I=f[v];if(I.layer===t&&I.listener===n){for(const k in I.delegates)this.off(k,I.delegates[k]);return f.splice(v,1),this}}})(),this)}queryRenderedFeatures(y,t){if(!this.style)return[];let n;const a=y instanceof s.P||Array.isArray(y),f=a?y:[[0,0],[this.transform.width,this.transform.height]];if(t=t||(a?{}:y)||{},f instanceof s.P||typeof f[0]=="number")n=[s.P.convert(f)];else{const v=s.P.convert(f[0]),I=s.P.convert(f[1]);n=[v,new s.P(I.x,v.y),I,new s.P(v.x,I.y),v]}return this.style.queryRenderedFeatures(n,t,this.transform)}querySourceFeatures(y,t){return this.style.querySourceFeatures(y,t)}setStyle(y,t){return(t=s.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},t)).diff!==!1&&t.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&y?(this._diffStyle(y,t),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._updateStyle(y,t))}setTransformRequest(y){return this._requestManager.setTransformRequest(y),this}_getUIString(y){const t=this._locale[y];if(t==null)throw new Error(`Missing UI string '${y}'`);return t}_updateStyle(y,t){if(t.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",()=>this._updateStyle(y,t));const n=this.style&&t.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!y)),y?(this.style=new zs(this,t||{}),this.style.setEventedParent(this,{style:this.style}),typeof y=="string"?this.style.loadURL(y,t,n):this.style.loadJSON(y,t,n),this):(delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new zs(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(y,t){if(typeof y=="string"){const n=this._requestManager.transformRequest(y,"Style");s.h(n,new AbortController).then(a=>{this._updateDiff(a.data,t)}).catch(a=>{a&&this.fire(new s.j(a))})}else typeof y=="object"&&this._updateDiff(y,t)}_updateDiff(y,t){try{this.style.setState(y,t)&&this._update(!0)}catch(n){s.w(`Unable to perform style diff: ${n.message||n.error||n}.  Rebuilding the style from scratch.`),this._updateStyle(y,t)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():s.w("There is no style added to the map.")}addSource(y,t){return this._lazyInitEmptyStyle(),this.style.addSource(y,t),this._update(!0)}isSourceLoaded(y){const t=this.style&&this.style.sourceCaches[y];if(t!==void 0)return t.loaded();this.fire(new s.j(new Error(`There is no source with ID '${y}'`)))}setTerrain(y){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),y){const t=this.style.sourceCaches[y.source];if(!t)throw new Error(`cannot load terrain, because there exists no source with ID: ${y.source}`);this.terrain===null&&t.reload();for(const n in this.style._layers){const a=this.style._layers[n];a.type==="hillshade"&&a.source===y.source&&s.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new vc(this.painter,t,y),this.painter.renderToTexture=new xc(this.painter,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._terrainDataCallback=n=>{n.dataType==="style"?this.terrain.sourceCache.freeRtt():n.dataType==="source"&&n.tile&&(n.sourceId!==y.source||this._elevationFreeze||(this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.terrain.sourceCache.freeRtt(n.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.minElevationForCurrentTile=0,this.transform.elevation=0;return this.fire(new s.k("terrain",{terrain:y})),this}getTerrain(){var y,t;return(t=(y=this.terrain)===null||y===void 0?void 0:y.options)!==null&&t!==void 0?t:null}areTilesLoaded(){const y=this.style&&this.style.sourceCaches;for(const t in y){const n=y[t]._tiles;for(const a in n){const f=n[a];if(f.state!=="loaded"&&f.state!=="errored")return!1}}return!0}removeSource(y){return this.style.removeSource(y),this._update(!0)}getSource(y){return this.style.getSource(y)}addImage(y,t,n={}){const{pixelRatio:a=1,sdf:f=!1,stretchX:v,stretchY:I,content:k,textFitWidth:D,textFitHeight:B}=n;if(this._lazyInitEmptyStyle(),!(t instanceof HTMLImageElement||s.b(t))){if(t.width===void 0||t.height===void 0)return this.fire(new s.j(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:G,height:U,data:K}=t,ie=t;return this.style.addImage(y,{data:new s.R({width:G,height:U},new Uint8Array(K)),pixelRatio:a,stretchX:v,stretchY:I,content:k,textFitWidth:D,textFitHeight:B,sdf:f,version:0,userImage:ie}),ie.onAdd&&ie.onAdd(this,y),this}}{const{width:G,height:U,data:K}=l.getImageData(t);this.style.addImage(y,{data:new s.R({width:G,height:U},K),pixelRatio:a,stretchX:v,stretchY:I,content:k,textFitWidth:D,textFitHeight:B,sdf:f,version:0})}}updateImage(y,t){const n=this.style.getImage(y);if(!n)return this.fire(new s.j(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const a=t instanceof HTMLImageElement||s.b(t)?l.getImageData(t):t,{width:f,height:v,data:I}=a;if(f===void 0||v===void 0)return this.fire(new s.j(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(f!==n.data.width||v!==n.data.height)return this.fire(new s.j(new Error("The width and height of the updated image must be that same as the previous version of the image")));const k=!(t instanceof HTMLImageElement||s.b(t));return n.data.replace(I,k),this.style.updateImage(y,n),this}getImage(y){return this.style.getImage(y)}hasImage(y){return y?!!this.style.getImage(y):(this.fire(new s.j(new Error("Missing required image id"))),!1)}removeImage(y){this.style.removeImage(y)}loadImage(y){return O.getImage(this._requestManager.transformRequest(y,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(y,t){return this._lazyInitEmptyStyle(),this.style.addLayer(y,t),this._update(!0)}moveLayer(y,t){return this.style.moveLayer(y,t),this._update(!0)}removeLayer(y){return this.style.removeLayer(y),this._update(!0)}getLayer(y){return this.style.getLayer(y)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(y,t,n){return this.style.setLayerZoomRange(y,t,n),this._update(!0)}setFilter(y,t,n={}){return this.style.setFilter(y,t,n),this._update(!0)}getFilter(y){return this.style.getFilter(y)}setPaintProperty(y,t,n,a={}){return this.style.setPaintProperty(y,t,n,a),this._update(!0)}getPaintProperty(y,t){return this.style.getPaintProperty(y,t)}setLayoutProperty(y,t,n,a={}){return this.style.setLayoutProperty(y,t,n,a),this._update(!0)}getLayoutProperty(y,t){return this.style.getLayoutProperty(y,t)}setGlyphs(y,t={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(y,t),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(y,t,n={}){return this._lazyInitEmptyStyle(),this.style.addSprite(y,t,n,a=>{a||this._update(!0)}),this}removeSprite(y){return this._lazyInitEmptyStyle(),this.style.removeSprite(y),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(y,t={}){return this._lazyInitEmptyStyle(),this.style.setSprite(y,t,n=>{n||this._update(!0)}),this}setLight(y,t={}){return this._lazyInitEmptyStyle(),this.style.setLight(y,t),this._update(!0)}getLight(){return this.style.getLight()}setFeatureState(y,t){return this.style.setFeatureState(y,t),this._update()}removeFeatureState(y,t){return this.style.removeFeatureState(y,t),this._update()}getFeatureState(y){return this.style.getFeatureState(y)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let y=0,t=0;return this._container&&(y=this._container.clientWidth||400,t=this._container.clientHeight||300),[y,t]}_setupContainer(){const y=this._container;y.classList.add("maplibregl-map");const t=this._canvasContainer=c.create("div","maplibregl-canvas-container",y);this._interactive&&t.classList.add("maplibregl-interactive"),this._canvas=c.create("canvas","maplibregl-canvas",t),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const n=this._containerDimensions(),a=this._getClampedPixelRatio(n[0],n[1]);this._resizeCanvas(n[0],n[1],a);const f=this._controlContainer=c.create("div","maplibregl-control-container",y),v=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(I=>{v[I]=c.create("div",`maplibregl-ctrl-${I} `,f)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(y,t,n){this._canvas.width=Math.floor(n*y),this._canvas.height=Math.floor(n*t),this._canvas.style.width=`${y}px`,this._canvas.style.height=`${t}px`}_setupPainter(){const y={alpha:!0,stencil:!0,depth:!0,failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1};let t=null;this._canvas.addEventListener("webglcontextcreationerror",a=>{t={requestedAttributes:y},a&&(t.statusMessage=a.statusMessage,t.type=a.type)},{once:!0});const n=this._canvas.getContext("webgl2",y)||this._canvas.getContext("webgl",y);if(!n){const a="Failed to initialize WebGL";throw t?(t.message=a,new Error(JSON.stringify(t))):new Error(a)}this.painter=new qe(n,this.transform),h.testSupport(n)}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(y){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||y,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(y){return this._update(),this._renderTaskQueue.add(y)}_cancelRenderFrame(y){this._renderTaskQueue.remove(y)}_render(y){const t=this._idleTriggered?this._fadeDuration:0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(y),this._removed)return;let n=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const f=this.transform.zoom,v=l.now();this.style.zoomHistory.update(f,v);const I=new s.a8(f,{now:v,fadeDuration:t,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),k=I.crossFadingFactor();k===1&&k===this._crossFadingFactor||(n=!0,this._crossFadingFactor=k),this.style.update(I)}this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._elevationFreeze||(this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.minElevationForCurrentTile=0,this.transform.elevation=0),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,t,this._crossSourceCollisions),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:t,showPadding:this.showPadding}),this.fire(new s.k("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,s.bd.mark(s.be.load),this.fire(new s.k("load"))),this.style&&(this.style.hasTransitions()||n)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const a=this._sourcesDirty||this._styleDirty||this._placementDirty;return a||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new s.k("idle")),!this._loaded||this._fullyLoaded||a||(this._fullyLoaded=!0,s.bd.mark(s.be.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var y;this._hash&&this._hash.remove();for(const n of this._controls)n.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),O.removeThrottleControl(this._imageQueueHandle),(y=this._resizeObserver)===null||y===void 0||y.disconnect();const t=this.painter.context.gl.getExtension("WEBGL_lose_context");t!=null&&t.loseContext&&t.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),c.remove(this._canvasContainer),c.remove(this._controlContainer),this._container.classList.remove("maplibregl-map"),s.bd.clearMetrics(),this._removed=!0,this.fire(new s.k("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,l.frameAsync(this._frameRequest).then(y=>{s.bd.frame(y),this._frameRequest=null,this._render(y)}).catch(()=>{}))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(y){this._showTileBoundaries!==y&&(this._showTileBoundaries=y,this._update())}get showPadding(){return!!this._showPadding}set showPadding(y){this._showPadding!==y&&(this._showPadding=y,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(y){this._showCollisionBoxes!==y&&(this._showCollisionBoxes=y,y?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(y){this._showOverdrawInspector!==y&&(this._showOverdrawInspector=y,this._update())}get repaint(){return!!this._repaint}set repaint(y){this._repaint!==y&&(this._repaint=y,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(y){this._vertices=y,this._update()}get version(){return Bl}getCameraTargetElevation(){return this.transform.elevation}},N.MapMouseEvent=Ir,N.MapTouchEvent=Rn,N.MapWheelEvent=Ca,N.Marker=hr,N.NavigationControl=class{constructor(y){this._updateZoomButtons=()=>{const t=this._map.getZoom(),n=t===this._map.getMaxZoom(),a=t===this._map.getMinZoom();this._zoomInButton.disabled=n,this._zoomOutButton.disabled=a,this._zoomInButton.setAttribute("aria-disabled",n.toString()),this._zoomOutButton.setAttribute("aria-disabled",a.toString())},this._rotateCompassArrow=()=>{const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._compassIcon.style.transform=t},this._setButtonTitle=(t,n)=>{const a=this._map._getUIString(`NavigationControl.${n}`);t.title=a,t.setAttribute("aria-label",a)},this.options=s.e({},jl,y),this._container=c.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",t=>this._map.zoomIn({},{originalEvent:t})),c.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",t=>this._map.zoomOut({},{originalEvent:t})),c.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",t=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:t}):this._map.resetNorth({},{originalEvent:t})}),this._compassIcon=c.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(y){return this._map=y,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new wc(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){c.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(y,t){const n=c.create("button",y,this._container);return n.type="button",n.addEventListener("click",t),n}},N.Popup=class extends s.E{constructor(y){super(),this.remove=()=>(this._content&&c.remove(this._content),this._container&&(c.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new s.k("close"))),this),this._onMouseUp=t=>{this._update(t.point)},this._onMouseMove=t=>{this._update(t.point)},this._onDrag=t=>{this._update(t.point)},this._update=t=>{var n;if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=c.create("div","maplibregl-popup",this._map.getContainer()),this._tip=c.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const k of this.options.className.split(" "))this._container.classList.add(k);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=this._map.transform.renderWorldCopies&&!this._trackPointer?Cc(this._lngLat,this._flatPos,this._map.transform):(n=this._lngLat)===null||n===void 0?void 0:n.wrap(),this._trackPointer&&!t)return;const a=this._flatPos=this._pos=this._trackPointer&&t?t:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&t?t:this._map.transform.locationPoint(this._lngLat));let f=this.options.anchor;const v=ai(this.options.offset);if(!f){const k=this._container.offsetWidth,D=this._container.offsetHeight;let B;B=a.y+v.bottom.y<D?["top"]:a.y>this._map.transform.height-D?["bottom"]:[],a.x<k/2?B.push("left"):a.x>this._map.transform.width-k/2&&B.push("right"),f=B.length===0?"bottom":B.join("-")}let I=a.add(v[f]);this.options.subpixelPositioning||(I=I.round()),c.setTransform(this._container,`${Nl[f]} translate(${I.x}px,${I.y}px)`),io(this._container,f,"popup")},this._onClose=()=>{this.remove()},this.options=s.e(Object.create(ys),y)}addTo(y){return this._map&&this.remove(),this._map=y,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new s.k("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(y){return this._lngLat=s.M.convert(y),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(y){return this.setDOMContent(document.createTextNode(y))}setHTML(y){const t=document.createDocumentFragment(),n=document.createElement("body");let a;for(n.innerHTML=y;a=n.firstChild,a;)t.appendChild(a);return this.setDOMContent(t)}getMaxWidth(){var y;return(y=this._container)===null||y===void 0?void 0:y.style.maxWidth}setMaxWidth(y){return this.options.maxWidth=y,this._update(),this}setDOMContent(y){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=c.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(y),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(y){return this._container&&this._container.classList.add(y),this}removeClassName(y){return this._container&&this._container.classList.remove(y),this}setOffset(y){return this.options.offset=y,this._update(),this}toggleClassName(y){if(this._container)return this._container.classList.toggle(y)}setSubpixelPositioning(y){this.options.subpixelPositioning=y}_createCloseButton(){this.options.closeButton&&(this._closeButton=c.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const y=this._container.querySelector(il);y&&y.focus()}},N.RasterDEMTileSource=pt,N.RasterTileSource=Ze,N.ScaleControl=class{constructor(y){this._onMove=()=>{Vl(this._map,this._container,this.options)},this.setUnit=t=>{this.options.unit=t,Vl(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},Sc),y)}getDefaultPosition(){return"bottom-left"}onAdd(y){return this._map=y,this._container=c.create("div","maplibregl-ctrl maplibregl-ctrl-scale",y.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){c.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},N.ScrollZoomHandler=Dl,N.Style=zs,N.TerrainControl=class{constructor(y){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=y}onAdd(y){return this._map=y,this._container=c.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=c.create("button","maplibregl-ctrl-terrain",this._container),c.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){c.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},N.TwoFingersTouchPitchHandler=kl,N.TwoFingersTouchRotateHandler=Js,N.TwoFingersTouchZoomHandler=Ao,N.TwoFingersTouchZoomRotateHandler=zl,N.VectorTileSource=ae,N.VideoSource=lt,N.addSourceType=(y,t)=>s._(void 0,void 0,void 0,function*(){if(di(y))throw new Error(`A source type called "${y}" already exists.`);((n,a)=>{Xt[n]=a})(y,t)}),N.clearPrewarmedResources=function(){const y=te;y&&(y.isPreloaded()&&y.numActive()===1?(y.release(ye),te=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},N.getMaxParallelImageRequests=function(){return s.a.MAX_PARALLEL_IMAGE_REQUESTS},N.getRTLTextPluginStatus=function(){return Ei().getRTLTextPluginStatus()},N.getVersion=function(){return gi},N.getWorkerCount=function(){return Ve.workerCount},N.getWorkerUrl=function(){return s.a.WORKER_URL},N.importScriptInWorkers=function(y){return Xe().broadcast("IS",y)},N.prewarm=function(){Ue().acquire(ye)},N.setMaxParallelImageRequests=function(y){s.a.MAX_PARALLEL_IMAGE_REQUESTS=y},N.setRTLTextPlugin=function(y,t){return Ei().setRTLTextPlugin(y,t)},N.setWorkerCount=function(y){Ve.workerCount=y},N.setWorkerUrl=function(y){s.a.WORKER_URL=y}});var Ie=se;return Ie})})(cf);var uf=cf.exports;const Yd=lf(uf);var df={exports:{}};(function(Y,T){(function(se,fe){Y.exports=fe()})(xl,function(){var se=function(P,z){var Z={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},_e={on:function(Me,Be,bt){if(Z[Me]===void 0)throw new Error("Invalid event type: "+Me);Z[Me].push({selector:Be,fn:bt})},render:function(Me){z.store.featureChanged(Me)}},Pe=function(Me,Be){for(var bt=Z[Me],It=bt.length;It--;){var Vt=bt[It];if(Vt.selector(Be)){Vt.fn.call(_e,Be)||z.store.render(),z.ui.updateMapClasses();break}}};return P.start.call(_e),{render:P.render,stop:function(){P.stop&&P.stop()},trash:function(){P.trash&&(P.trash(),z.store.render())},combineFeatures:function(){P.combineFeatures&&P.combineFeatures()},uncombineFeatures:function(){P.uncombineFeatures&&P.uncombineFeatures()},drag:function(Me){Pe("drag",Me)},click:function(Me){Pe("click",Me)},mousemove:function(Me){Pe("mousemove",Me)},mousedown:function(Me){Pe("mousedown",Me)},mouseup:function(Me){Pe("mouseup",Me)},mouseout:function(Me){Pe("mouseout",Me)},keydown:function(Me){Pe("keydown",Me)},keyup:function(Me){Pe("keyup",Me)},touchstart:function(Me){Pe("touchstart",Me)},touchmove:function(Me){Pe("touchmove",Me)},touchend:function(Me){Pe("touchend",Me)},tap:function(Me){Pe("tap",Me)}}};function fe(P){return P&&P.__esModule&&Object.prototype.hasOwnProperty.call(P,"default")?P.default:P}function he(P){if(P.__esModule)return P;var z=P.default;if(typeof z=="function"){var Z=function _e(){if(this instanceof _e){var Pe=[null];Pe.push.apply(Pe,arguments);var Me=Function.bind.apply(z,Pe);return new Me}return z.apply(this,arguments)};Z.prototype=z.prototype}else Z={};return Object.defineProperty(Z,"__esModule",{value:!0}),Object.keys(P).forEach(function(_e){var Pe=Object.getOwnPropertyDescriptor(P,_e);Object.defineProperty(Z,_e,Pe.get?Pe:{enumerable:!0,get:function(){return P[_e]}})}),Z}var Ie={},N={RADIUS:6378137,FLATTENING:1/298.257223563,POLAR_RADIUS:63567523142e-4},s=N;function p(P){var z=0;if(P&&P.length>0){z+=Math.abs(C(P[0]));for(var Z=1;Z<P.length;Z++)z-=Math.abs(C(P[Z]))}return z}function C(P){var z,Z,_e,Pe,Me,Be,bt=0,It=P.length;if(It>2){for(Be=0;Be<It;Be++)Be===It-2?(_e=It-2,Pe=It-1,Me=0):Be===It-1?(_e=It-1,Pe=0,Me=1):(_e=Be,Pe=Be+1,Me=Be+2),z=P[_e],Z=P[Pe],bt+=(b(P[Me][0])-b(z[0]))*Math.sin(b(Z[1]));bt=bt*s.RADIUS*s.RADIUS/2}return bt}function b(P){return P*Math.PI/180}Ie.geometry=function P(z){var Z,_e=0;switch(z.type){case"Polygon":return p(z.coordinates);case"MultiPolygon":for(Z=0;Z<z.coordinates.length;Z++)_e+=p(z.coordinates[Z]);return _e;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(Z=0;Z<z.geometries.length;Z++)_e+=P(z.geometries[Z]);return _e}},Ie.ring=C;var l={CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},c={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},h={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},m={POLYGON:"polygon",LINE:"line_string",POINT:"point"},g={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},d={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select",STATIC:"static"},w={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},E={MOVE:"move",CHANGE_COORDINATES:"change_coordinates"},O={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},L={ACTIVE:"true",INACTIVE:"false"},V=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],$=-85,ne=Object.freeze({__proto__:null,classes:l,sources:c,cursors:h,types:m,geojsonTypes:g,modes:d,events:w,updateActions:E,meta:O,activeStates:L,interactions:V,LAT_MIN:-90,LAT_RENDERED_MIN:$,LAT_MAX:90,LAT_RENDERED_MAX:85,LNG_MIN:-270,LNG_MAX:270}),xe={Point:0,LineString:1,MultiLineString:1,Polygon:2};function ze(P,z){var Z=xe[P.geometry.type]-xe[z.geometry.type];return Z===0&&P.geometry.type===g.POLYGON?P.area-z.area:Z}function Ke(P){return P.map(function(z){return z.geometry.type===g.POLYGON&&(z.area=Ie.geometry({type:g.FEATURE,property:{},geometry:z.geometry})),z}).sort(ze).map(function(z){return delete z.area,z})}function Je(P,z){return z===void 0&&(z=0),[[P.point.x-z,P.point.y-z],[P.point.x+z,P.point.y+z]]}function tt(P){if(this._items={},this._nums={},this._length=P?P.length:0,P)for(var z=0,Z=P.length;z<Z;z++)this.add(P[z]),P[z]!==void 0&&(typeof P[z]=="string"?this._items[P[z]]=z:this._nums[P[z]]=z)}tt.prototype.add=function(P){return this.has(P)||(this._length++,typeof P=="string"?this._items[P]=this._length:this._nums[P]=this._length),this},tt.prototype.delete=function(P){return this.has(P)===!1||(this._length--,delete this._items[P],delete this._nums[P]),this},tt.prototype.has=function(P){return(typeof P=="string"||typeof P=="number")&&(this._items[P]!==void 0||this._nums[P]!==void 0)},tt.prototype.values=function(){var P=this,z=[];return Object.keys(this._items).forEach(function(Z){z.push({k:Z,v:P._items[Z]})}),Object.keys(this._nums).forEach(function(Z){z.push({k:JSON.parse(Z),v:P._nums[Z]})}),z.sort(function(Z,_e){return Z.v-_e.v}).map(function(Z){return Z.k})},tt.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};var ht=[O.FEATURE,O.MIDPOINT,O.VERTEX],nt={click:function(P,z,Z){return _t(P,z,Z,Z.options.clickBuffer)},touch:function(P,z,Z){return _t(P,z,Z,Z.options.touchBuffer)}};function _t(P,z,Z,_e){if(Z.map===null)return[];var Pe=P?Je(P,_e):z,Me={};Z.options.styles&&(Me.layers=Z.options.styles.map(function(Vt){return Vt.id}).filter(function(Vt){return Z.map.getLayer(Vt)!=null}));var Be=Z.map.queryRenderedFeatures(Pe,Me).filter(function(Vt){return ht.indexOf(Vt.properties.meta)!==-1}),bt=new tt,It=[];return Be.forEach(function(Vt){var Nt=Vt.properties.id;bt.has(Nt)||(bt.add(Nt),It.push(Vt))}),Ke(It)}function Ot(P,z){var Z=nt.click(P,null,z),_e={mouse:h.NONE};return Z[0]&&(_e.mouse=Z[0].properties.active===L.ACTIVE?h.MOVE:h.POINTER,_e.feature=Z[0].properties.meta),z.events.currentModeName().indexOf("draw")!==-1&&(_e.mouse=h.ADD),z.ui.queueMapClasses(_e),z.ui.updateMapClasses(),Z[0]}function ot(P,z){var Z=P.x-z.x,_e=P.y-z.y;return Math.sqrt(Z*Z+_e*_e)}function wt(P,z,Z){Z===void 0&&(Z={});var _e=Z.fineTolerance!=null?Z.fineTolerance:4,Pe=Z.grossTolerance!=null?Z.grossTolerance:12,Me=Z.interval!=null?Z.interval:500;P.point=P.point||z.point,P.time=P.time||z.time;var Be=ot(P.point,z.point);return Be<_e||Be<Pe&&z.time-P.time<Me}function ee(P,z,Z){Z===void 0&&(Z={});var _e=Z.tolerance!=null?Z.tolerance:25,Pe=Z.interval!=null?Z.interval:250;return P.point=P.point||z.point,P.time=P.time||z.time,ot(P.point,z.point)<_e&&z.time-P.time<Pe}var be={exports:{}},me=be.exports=function(P,z){if(z||(z=16),P===void 0&&(P=128),P<=0)return"0";for(var Z=Math.log(Math.pow(2,P))/Math.log(z),_e=2;Z===1/0;_e*=2)Z=Math.log(Math.pow(2,P/_e))/Math.log(z)*_e;var Pe=Z-Math.floor(Z),Me="";for(_e=0;_e<Math.floor(Z);_e++)Me=Math.floor(Math.random()*z).toString(z)+Me;if(Pe){var Be=Math.pow(z,Pe);Me=Math.floor(Math.random()*Be).toString(z)+Me}var bt=parseInt(Me,z);return bt!==1/0&&bt>=Math.pow(2,P)?me(P,z):Me};me.rack=function(P,z,Z){var _e=function(Me){var Be=0;do{if(Be++>10){if(!Z)throw new Error("too many ID collisions, use more bits");P+=Z}var bt=me(P,z)}while(Object.hasOwnProperty.call(Pe,bt));return Pe[bt]=Me,bt},Pe=_e.hats={};return _e.get=function(Me){return _e.hats[Me]},_e.set=function(Me,Be){return _e.hats[Me]=Be,_e},_e.bits=P||128,_e.base=z||16,_e};var ye=fe(be.exports),Ve=function(P,z){this.ctx=P,this.properties=z.properties||{},this.coordinates=z.geometry.coordinates,this.id=z.id||ye(),this.type=z.geometry.type};Ve.prototype.changed=function(){this.ctx.store.featureChanged(this.id)},Ve.prototype.incomingCoords=function(P){this.setCoordinates(P)},Ve.prototype.setCoordinates=function(P){this.coordinates=P,this.changed()},Ve.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))},Ve.prototype.setProperty=function(P,z){this.properties[P]=z},Ve.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:g.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))},Ve.prototype.internal=function(P){var z={id:this.id,meta:O.FEATURE,"meta:type":this.type,active:L.INACTIVE,mode:P};if(this.ctx.options.userProperties)for(var Z in this.properties)z["user_"+Z]=this.properties[Z];return{type:g.FEATURE,properties:z,geometry:{coordinates:this.getCoordinates(),type:this.type}}};var ge=function(P,z){Ve.call(this,P,z)};(ge.prototype=Object.create(Ve.prototype)).isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"},ge.prototype.updateCoordinate=function(P,z,Z){this.coordinates=arguments.length===3?[z,Z]:[P,z],this.changed()},ge.prototype.getCoordinate=function(){return this.getCoordinates()};var te=function(P,z){Ve.call(this,P,z)};(te.prototype=Object.create(Ve.prototype)).isValid=function(){return this.coordinates.length>1},te.prototype.addCoordinate=function(P,z,Z){this.changed();var _e=parseInt(P,10);this.coordinates.splice(_e,0,[z,Z])},te.prototype.getCoordinate=function(P){var z=parseInt(P,10);return JSON.parse(JSON.stringify(this.coordinates[z]))},te.prototype.removeCoordinate=function(P){this.changed(),this.coordinates.splice(parseInt(P,10),1)},te.prototype.updateCoordinate=function(P,z,Z){var _e=parseInt(P,10);this.coordinates[_e]=[z,Z],this.changed()};var Ae=function(P,z){Ve.call(this,P,z),this.coordinates=this.coordinates.map(function(Z){return Z.slice(0,-1)})};(Ae.prototype=Object.create(Ve.prototype)).isValid=function(){return this.coordinates.length!==0&&this.coordinates.every(function(P){return P.length>2})},Ae.prototype.incomingCoords=function(P){this.coordinates=P.map(function(z){return z.slice(0,-1)}),this.changed()},Ae.prototype.setCoordinates=function(P){this.coordinates=P,this.changed()},Ae.prototype.addCoordinate=function(P,z,Z){this.changed();var _e=P.split(".").map(function(Pe){return parseInt(Pe,10)});this.coordinates[_e[0]].splice(_e[1],0,[z,Z])},Ae.prototype.removeCoordinate=function(P){this.changed();var z=P.split(".").map(function(_e){return parseInt(_e,10)}),Z=this.coordinates[z[0]];Z&&(Z.splice(z[1],1),Z.length<3&&this.coordinates.splice(z[0],1))},Ae.prototype.getCoordinate=function(P){var z=P.split(".").map(function(_e){return parseInt(_e,10)}),Z=this.coordinates[z[0]];return JSON.parse(JSON.stringify(Z[z[1]]))},Ae.prototype.getCoordinates=function(){return this.coordinates.map(function(P){return P.concat([P[0]])})},Ae.prototype.updateCoordinate=function(P,z,Z){this.changed();var _e=P.split("."),Pe=parseInt(_e[0],10),Me=parseInt(_e[1],10);this.coordinates[Pe]===void 0&&(this.coordinates[Pe]=[]),this.coordinates[Pe][Me]=[z,Z]};var Ue={MultiPoint:ge,MultiLineString:te,MultiPolygon:Ae},it=function(P,z,Z,_e,Pe){var Me=Z.split("."),Be=parseInt(Me[0],10),bt=Me[1]?Me.slice(1).join("."):null;return P[Be][z](bt,_e,Pe)},Xe=function(P,z){if(Ve.call(this,P,z),delete this.coordinates,this.model=Ue[z.geometry.type],this.model===void 0)throw new TypeError(z.geometry.type+" is not a valid type");this.features=this._coordinatesToFeatures(z.geometry.coordinates)};function He(P){this.map=P.map,this.drawConfig=JSON.parse(JSON.stringify(P.options||{})),this._ctx=P}(Xe.prototype=Object.create(Ve.prototype))._coordinatesToFeatures=function(P){var z=this,Z=this.model.bind(this);return P.map(function(_e){return new Z(z.ctx,{id:ye(),type:g.FEATURE,properties:{},geometry:{coordinates:_e,type:z.type.replace("Multi","")}})})},Xe.prototype.isValid=function(){return this.features.every(function(P){return P.isValid()})},Xe.prototype.setCoordinates=function(P){this.features=this._coordinatesToFeatures(P),this.changed()},Xe.prototype.getCoordinate=function(P){return it(this.features,"getCoordinate",P)},Xe.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(function(P){return P.type===g.POLYGON?P.getCoordinates():P.coordinates})))},Xe.prototype.updateCoordinate=function(P,z,Z){it(this.features,"updateCoordinate",P,z,Z),this.changed()},Xe.prototype.addCoordinate=function(P,z,Z){it(this.features,"addCoordinate",P,z,Z),this.changed()},Xe.prototype.removeCoordinate=function(P){it(this.features,"removeCoordinate",P),this.changed()},Xe.prototype.getFeatures=function(){return this.features},He.prototype.setSelected=function(P){return this._ctx.store.setSelected(P)},He.prototype.setSelectedCoordinates=function(P){var z=this;this._ctx.store.setSelectedCoordinates(P),P.reduce(function(Z,_e){return Z[_e.feature_id]===void 0&&(Z[_e.feature_id]=!0,z._ctx.store.get(_e.feature_id).changed()),Z},{})},He.prototype.getSelected=function(){return this._ctx.store.getSelected()},He.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()},He.prototype.isSelected=function(P){return this._ctx.store.isSelected(P)},He.prototype.getFeature=function(P){return this._ctx.store.get(P)},He.prototype.select=function(P){return this._ctx.store.select(P)},He.prototype.deselect=function(P){return this._ctx.store.deselect(P)},He.prototype.deleteFeature=function(P,z){return z===void 0&&(z={}),this._ctx.store.delete(P,z)},He.prototype.addFeature=function(P){return this._ctx.store.add(P)},He.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()},He.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()},He.prototype.setActionableState=function(P){P===void 0&&(P={});var z={trash:P.trash||!1,combineFeatures:P.combineFeatures||!1,uncombineFeatures:P.uncombineFeatures||!1};return this._ctx.events.actionable(z)},He.prototype.changeMode=function(P,z,Z){return z===void 0&&(z={}),Z===void 0&&(Z={}),this._ctx.events.changeMode(P,z,Z)},He.prototype.updateUIClasses=function(P){return this._ctx.ui.queueMapClasses(P)},He.prototype.activateUIButton=function(P){return this._ctx.ui.setActiveButton(P)},He.prototype.featuresAt=function(P,z,Z){if(Z===void 0&&(Z="click"),Z!=="click"&&Z!=="touch")throw new Error("invalid buffer type");return nt[Z](P,z,this._ctx)},He.prototype.newFeature=function(P){var z=P.geometry.type;return z===g.POINT?new ge(this._ctx,P):z===g.LINE_STRING?new te(this._ctx,P):z===g.POLYGON?new Ae(this._ctx,P):new Xe(this._ctx,P)},He.prototype.isInstanceOf=function(P,z){if(P===g.POINT)return z instanceof ge;if(P===g.LINE_STRING)return z instanceof te;if(P===g.POLYGON)return z instanceof Ae;if(P==="MultiFeature")return z instanceof Xe;throw new Error("Unknown feature class: "+P)},He.prototype.doRender=function(P){return this._ctx.store.featureChanged(P)},He.prototype.onSetup=function(){},He.prototype.onDrag=function(){},He.prototype.onClick=function(){},He.prototype.onMouseMove=function(){},He.prototype.onMouseDown=function(){},He.prototype.onMouseUp=function(){},He.prototype.onMouseOut=function(){},He.prototype.onKeyUp=function(){},He.prototype.onKeyDown=function(){},He.prototype.onTouchStart=function(){},He.prototype.onTouchMove=function(){},He.prototype.onTouchEnd=function(){},He.prototype.onTap=function(){},He.prototype.onStop=function(){},He.prototype.onTrash=function(){},He.prototype.onCombineFeature=function(){},He.prototype.onUncombineFeature=function(){},He.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};var vt={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},Et=Object.keys(vt);function $e(P){var z=Object.keys(P);return function(Z,_e){_e===void 0&&(_e={});var Pe={},Me=z.reduce(function(Be,bt){return Be[bt]=P[bt],Be},new He(Z));return{start:function(){var Be=this;Pe=Me.onSetup(_e),Et.forEach(function(bt){var It,Vt=vt[bt],Nt=function(){return!1};P[Vt]&&(Nt=function(){return!0}),Be.on(bt,Nt,(It=Vt,function(Dt){return Me[It](Pe,Dt)}))})},stop:function(){Me.onStop(Pe)},trash:function(){Me.onTrash(Pe)},combineFeatures:function(){Me.onCombineFeatures(Pe)},uncombineFeatures:function(){Me.onUncombineFeatures(Pe)},render:function(Be,bt){Me.toDisplayFeatures(Pe,Be,bt)}}}}function Oe(P){return[].concat(P).filter(function(z){return z!==void 0})}function at(){var P=this;if(!(P.ctx.map&&P.ctx.map.getSource(c.HOT)!==void 0))return It();var z=P.ctx.events.currentModeName();P.ctx.ui.queueMapClasses({mode:z});var Z=[],_e=[];P.isDirty?_e=P.getAllIds():(Z=P.getChangedIds().filter(function(Vt){return P.get(Vt)!==void 0}),_e=P.sources.hot.filter(function(Vt){return Vt.properties.id&&Z.indexOf(Vt.properties.id)===-1&&P.get(Vt.properties.id)!==void 0}).map(function(Vt){return Vt.properties.id})),P.sources.hot=[];var Pe=P.sources.cold.length;P.sources.cold=P.isDirty?[]:P.sources.cold.filter(function(Vt){var Nt=Vt.properties.id||Vt.properties.parent;return Z.indexOf(Nt)===-1});var Me=Pe!==P.sources.cold.length||_e.length>0;function Be(Vt,Nt){var Dt=P.get(Vt).internal(z);P.ctx.events.currentModeRender(Dt,function(_i){P.sources[Nt].push(_i)})}if(Z.forEach(function(Vt){return Be(Vt,"hot")}),_e.forEach(function(Vt){return Be(Vt,"cold")}),Me&&P.ctx.map.getSource(c.COLD).setData({type:g.FEATURE_COLLECTION,features:P.sources.cold}),P.ctx.map.getSource(c.HOT).setData({type:g.FEATURE_COLLECTION,features:P.sources.hot}),P._emitSelectionChange&&(P.ctx.map.fire(w.SELECTION_CHANGE,{features:P.getSelected().map(function(Vt){return Vt.toGeoJSON()}),points:P.getSelectedCoordinates().map(function(Vt){return{type:g.FEATURE,properties:{},geometry:{type:g.POINT,coordinates:Vt.coordinates}}})}),P._emitSelectionChange=!1),P._deletedFeaturesToEmit.length){var bt=P._deletedFeaturesToEmit.map(function(Vt){return Vt.toGeoJSON()});P._deletedFeaturesToEmit=[],P.ctx.map.fire(w.DELETE,{features:bt})}function It(){P.isDirty=!1,P.clearChangedIds()}It(),P.ctx.map.fire(w.RENDER,{})}function ae(P){var z,Z=this;this._features={},this._featureIds=new tt,this._selectedFeatureIds=new tt,this._selectedCoordinates=[],this._changedFeatureIds=new tt,this._deletedFeaturesToEmit=[],this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=P,this.sources={hot:[],cold:[]},this.render=function(){z||(z=requestAnimationFrame(function(){z=null,at.call(Z)}))},this.isDirty=!1}function Ze(P,z){var Z=P._selectedCoordinates.filter(function(_e){return P._selectedFeatureIds.has(_e.feature_id)});P._selectedCoordinates.length===Z.length||z.silent||(P._emitSelectionChange=!0),P._selectedCoordinates=Z}ae.prototype.createRenderBatch=function(){var P=this,z=this.render,Z=0;return this.render=function(){Z++},function(){P.render=z,Z>0&&P.render()}},ae.prototype.setDirty=function(){return this.isDirty=!0,this},ae.prototype.featureChanged=function(P){return this._changedFeatureIds.add(P),this},ae.prototype.getChangedIds=function(){return this._changedFeatureIds.values()},ae.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this},ae.prototype.getAllIds=function(){return this._featureIds.values()},ae.prototype.add=function(P){return this.featureChanged(P.id),this._features[P.id]=P,this._featureIds.add(P.id),this},ae.prototype.delete=function(P,z){var Z=this;return z===void 0&&(z={}),Oe(P).forEach(function(_e){Z._featureIds.has(_e)&&(Z._featureIds.delete(_e),Z._selectedFeatureIds.delete(_e),z.silent||Z._deletedFeaturesToEmit.indexOf(Z._features[_e])===-1&&Z._deletedFeaturesToEmit.push(Z._features[_e]),delete Z._features[_e],Z.isDirty=!0)}),Ze(this,z),this},ae.prototype.get=function(P){return this._features[P]},ae.prototype.getAll=function(){var P=this;return Object.keys(this._features).map(function(z){return P._features[z]})},ae.prototype.select=function(P,z){var Z=this;return z===void 0&&(z={}),Oe(P).forEach(function(_e){Z._selectedFeatureIds.has(_e)||(Z._selectedFeatureIds.add(_e),Z._changedFeatureIds.add(_e),z.silent||(Z._emitSelectionChange=!0))}),this},ae.prototype.deselect=function(P,z){var Z=this;return z===void 0&&(z={}),Oe(P).forEach(function(_e){Z._selectedFeatureIds.has(_e)&&(Z._selectedFeatureIds.delete(_e),Z._changedFeatureIds.add(_e),z.silent||(Z._emitSelectionChange=!0))}),Ze(this,z),this},ae.prototype.clearSelected=function(P){return P===void 0&&(P={}),this.deselect(this._selectedFeatureIds.values(),{silent:P.silent}),this},ae.prototype.setSelected=function(P,z){var Z=this;return z===void 0&&(z={}),P=Oe(P),this.deselect(this._selectedFeatureIds.values().filter(function(_e){return P.indexOf(_e)===-1}),{silent:z.silent}),this.select(P.filter(function(_e){return!Z._selectedFeatureIds.has(_e)}),{silent:z.silent}),this},ae.prototype.setSelectedCoordinates=function(P){return this._selectedCoordinates=P,this._emitSelectionChange=!0,this},ae.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this},ae.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()},ae.prototype.getSelected=function(){var P=this;return this._selectedFeatureIds.values().map(function(z){return P.get(z)})},ae.prototype.getSelectedCoordinates=function(){var P=this;return this._selectedCoordinates.map(function(z){return{coordinates:P.get(z.feature_id).getCoordinate(z.coord_path)}})},ae.prototype.isSelected=function(P){return this._selectedFeatureIds.has(P)},ae.prototype.setFeatureProperty=function(P,z,Z){this.get(P).setProperty(z,Z),this.featureChanged(P)},ae.prototype.storeMapConfig=function(){var P=this;V.forEach(function(z){P.ctx.map[z]&&(P._mapInitialConfig[z]=P.ctx.map[z].isEnabled())})},ae.prototype.restoreMapConfig=function(){var P=this;Object.keys(this._mapInitialConfig).forEach(function(z){P._mapInitialConfig[z]?P.ctx.map[z].enable():P.ctx.map[z].disable()})},ae.prototype.getInitialConfigValue=function(P){return this._mapInitialConfig[P]===void 0||this._mapInitialConfig[P]};var pt=function(){for(var P=arguments,z={},Z=0;Z<arguments.length;Z++){var _e=P[Z];for(var Pe in _e)ft.call(_e,Pe)&&(z[Pe]=_e[Pe])}return z},ft=Object.prototype.hasOwnProperty,Lt=fe(pt),$t=["mode","feature","mouse"];function lt(P){var z=null,Z=null,_e={onRemove:function(){return P.map.off("load",_e.connect),clearInterval(Z),_e.removeLayers(),P.store.restoreMapConfig(),P.ui.removeButtons(),P.events.removeEventListeners(),P.ui.clearMapClasses(),P.boxZoomInitial&&P.map.boxZoom.enable(),P.map=null,P.container=null,P.store=null,z&&z.parentNode&&z.parentNode.removeChild(z),z=null,this},connect:function(){P.map.off("load",_e.connect),clearInterval(Z),_e.addLayers(),P.store.storeMapConfig(),P.events.addEventListeners()},onAdd:function(Pe){var Me=Pe.fire;return Pe.fire=function(Be,bt){var It=arguments;return Me.length===1&&arguments.length!==1&&(It=[Lt({},{type:Be},bt)]),Me.apply(Pe,It)},P.map=Pe,P.events=function(Be){var bt=Object.keys(Be.options.modes).reduce(function(yt,ii){return yt[ii]=$e(Be.options.modes[ii]),yt},{}),It={},Vt={},Nt={},Dt=null,_i=null;Nt.drag=function(yt,ii){ii({point:yt.point,time:new Date().getTime()})?(Be.ui.queueMapClasses({mouse:h.DRAG}),_i.drag(yt)):yt.originalEvent.stopPropagation()},Nt.mousedrag=function(yt){Nt.drag(yt,function(ii){return!wt(It,ii)})},Nt.touchdrag=function(yt){Nt.drag(yt,function(ii){return!ee(Vt,ii)})},Nt.mousemove=function(yt){if((yt.originalEvent.buttons!==void 0?yt.originalEvent.buttons:yt.originalEvent.which)===1)return Nt.mousedrag(yt);var ii=Ot(yt,Be);yt.featureTarget=ii,_i.mousemove(yt)},Nt.mousedown=function(yt){It={time:new Date().getTime(),point:yt.point};var ii=Ot(yt,Be);yt.featureTarget=ii,_i.mousedown(yt)},Nt.mouseup=function(yt){var ii=Ot(yt,Be);yt.featureTarget=ii,wt(It,{point:yt.point,time:new Date().getTime()})?_i.click(yt):_i.mouseup(yt)},Nt.mouseout=function(yt){_i.mouseout(yt)},Nt.touchstart=function(yt){if(Be.options.touchEnabled){Vt={time:new Date().getTime(),point:yt.point};var ii=nt.touch(yt,null,Be)[0];yt.featureTarget=ii,_i.touchstart(yt)}},Nt.touchmove=function(yt){if(Be.options.touchEnabled)return _i.touchmove(yt),Nt.touchdrag(yt)},Nt.touchend=function(yt){if(yt.originalEvent.preventDefault(),Be.options.touchEnabled){var ii=nt.touch(yt,null,Be)[0];yt.featureTarget=ii,ee(Vt,{time:new Date().getTime(),point:yt.point})?_i.tap(yt):_i.touchend(yt)}};var rr=function(yt){return!(yt===8||yt===46||yt>=48&&yt<=57)};function fi(yt,ii,Hi){Hi===void 0&&(Hi={}),_i.stop();var kr=bt[yt];if(kr===void 0)throw new Error(yt+" is not valid");Dt=yt;var lr=kr(Be,ii);_i=se(lr,Be),Hi.silent||Be.map.fire(w.MODE_CHANGE,{mode:yt}),Be.store.setDirty(),Be.store.render()}Nt.keydown=function(yt){(yt.srcElement||yt.target).classList.contains("mapboxgl-canvas")&&(yt.keyCode!==8&&yt.keyCode!==46||!Be.options.controls.trash?rr(yt.keyCode)?_i.keydown(yt):yt.keyCode===49&&Be.options.controls.point?fi(d.DRAW_POINT):yt.keyCode===50&&Be.options.controls.line_string?fi(d.DRAW_LINE_STRING):yt.keyCode===51&&Be.options.controls.polygon&&fi(d.DRAW_POLYGON):(yt.preventDefault(),_i.trash()))},Nt.keyup=function(yt){rr(yt.keyCode)&&_i.keyup(yt)},Nt.zoomend=function(){Be.store.changeZoom()},Nt.data=function(yt){if(yt.dataType==="style"){var ii=Be.setup,Hi=Be.map,kr=Be.options,lr=Be.store;kr.styles.some(function(pa){return Hi.getLayer(pa.id)})||(ii.addLayers(),lr.setDirty(),lr.render())}};var ji={trash:!1,combineFeatures:!1,uncombineFeatures:!1};return{start:function(){Dt=Be.options.defaultMode,_i=se(bt[Dt](Be),Be)},changeMode:fi,actionable:function(yt){var ii=!1;Object.keys(yt).forEach(function(Hi){if(ji[Hi]===void 0)throw new Error("Invalid action type");ji[Hi]!==yt[Hi]&&(ii=!0),ji[Hi]=yt[Hi]}),ii&&Be.map.fire(w.ACTIONABLE,{actions:ji})},currentModeName:function(){return Dt},currentModeRender:function(yt,ii){return _i.render(yt,ii)},fire:function(yt,ii){Nt[yt]&&Nt[yt](ii)},addEventListeners:function(){Be.map.on("mousemove",Nt.mousemove),Be.map.on("mousedown",Nt.mousedown),Be.map.on("mouseup",Nt.mouseup),Be.map.on("data",Nt.data),Be.map.on("touchmove",Nt.touchmove),Be.map.on("touchstart",Nt.touchstart),Be.map.on("touchend",Nt.touchend),Be.container.addEventListener("mouseout",Nt.mouseout),Be.options.keybindings&&(Be.container.addEventListener("keydown",Nt.keydown),Be.container.addEventListener("keyup",Nt.keyup))},removeEventListeners:function(){Be.map.off("mousemove",Nt.mousemove),Be.map.off("mousedown",Nt.mousedown),Be.map.off("mouseup",Nt.mouseup),Be.map.off("data",Nt.data),Be.map.off("touchmove",Nt.touchmove),Be.map.off("touchstart",Nt.touchstart),Be.map.off("touchend",Nt.touchend),Be.container.removeEventListener("mouseout",Nt.mouseout),Be.options.keybindings&&(Be.container.removeEventListener("keydown",Nt.keydown),Be.container.removeEventListener("keyup",Nt.keyup))},trash:function(yt){_i.trash(yt)},combineFeatures:function(){_i.combineFeatures()},uncombineFeatures:function(){_i.uncombineFeatures()},getMode:function(){return Dt}}}(P),P.ui=function(Be){var bt={},It=null,Vt={mode:null,feature:null,mouse:null},Nt={mode:null,feature:null,mouse:null};function Dt(yt){Nt=Lt(Nt,yt)}function _i(){var yt,ii;if(Be.container){var Hi=[],kr=[];$t.forEach(function(lr){Nt[lr]!==Vt[lr]&&(Hi.push(lr+"-"+Vt[lr]),Nt[lr]!==null&&kr.push(lr+"-"+Nt[lr]))}),Hi.length>0&&(yt=Be.container.classList).remove.apply(yt,Hi),kr.length>0&&(ii=Be.container.classList).add.apply(ii,kr),Vt=Lt(Vt,Nt)}}function rr(yt,ii){ii===void 0&&(ii={});var Hi=document.createElement("button");return Hi.className=l.CONTROL_BUTTON+" "+ii.className,Hi.setAttribute("title",ii.title),ii.container.appendChild(Hi),Hi.addEventListener("click",function(kr){if(kr.preventDefault(),kr.stopPropagation(),kr.target===It)return fi(),void ii.onDeactivate();ji(yt),ii.onActivate()},!0),Hi}function fi(){It&&(It.classList.remove(l.ACTIVE_BUTTON),It=null)}function ji(yt){fi();var ii=bt[yt];ii&&ii&&yt!=="trash"&&(ii.classList.add(l.ACTIVE_BUTTON),It=ii)}return{setActiveButton:ji,queueMapClasses:Dt,updateMapClasses:_i,clearMapClasses:function(){Dt({mode:null,feature:null,mouse:null}),_i()},addButtons:function(){var yt=Be.options.controls,ii=document.createElement("div");return ii.className=l.CONTROL_GROUP+" "+l.CONTROL_BASE,yt&&(yt[m.LINE]&&(bt[m.LINE]=rr(m.LINE,{container:ii,className:l.CONTROL_BUTTON_LINE,title:"LineString tool "+(Be.options.keybindings?"(l)":""),onActivate:function(){return Be.events.changeMode(d.DRAW_LINE_STRING)},onDeactivate:function(){return Be.events.trash()}})),yt[m.POLYGON]&&(bt[m.POLYGON]=rr(m.POLYGON,{container:ii,className:l.CONTROL_BUTTON_POLYGON,title:"Polygon tool "+(Be.options.keybindings?"(p)":""),onActivate:function(){return Be.events.changeMode(d.DRAW_POLYGON)},onDeactivate:function(){return Be.events.trash()}})),yt[m.POINT]&&(bt[m.POINT]=rr(m.POINT,{container:ii,className:l.CONTROL_BUTTON_POINT,title:"Marker tool "+(Be.options.keybindings?"(m)":""),onActivate:function(){return Be.events.changeMode(d.DRAW_POINT)},onDeactivate:function(){return Be.events.trash()}})),yt.trash&&(bt.trash=rr("trash",{container:ii,className:l.CONTROL_BUTTON_TRASH,title:"Delete",onActivate:function(){Be.events.trash()}})),yt.combine_features&&(bt.combine_features=rr("combineFeatures",{container:ii,className:l.CONTROL_BUTTON_COMBINE_FEATURES,title:"Combine",onActivate:function(){Be.events.combineFeatures()}})),yt.uncombine_features&&(bt.uncombine_features=rr("uncombineFeatures",{container:ii,className:l.CONTROL_BUTTON_UNCOMBINE_FEATURES,title:"Uncombine",onActivate:function(){Be.events.uncombineFeatures()}}))),ii},removeButtons:function(){Object.keys(bt).forEach(function(yt){var ii=bt[yt];ii.parentNode&&ii.parentNode.removeChild(ii),delete bt[yt]})}}}(P),P.container=Pe.getContainer(),P.store=new ae(P),z=P.ui.addButtons(),P.options.boxSelect&&(P.boxZoomInitial=Pe.boxZoom.isEnabled(),Pe.boxZoom.disable(),Pe.dragPan.disable(),Pe.dragPan.enable()),Pe.loaded()?_e.connect():(Pe.on("load",_e.connect),Z=setInterval(function(){Pe.loaded()&&_e.connect()},16)),P.events.start(),z},addLayers:function(){P.map.addSource(c.COLD,{data:{type:g.FEATURE_COLLECTION,features:[]},type:"geojson"}),P.map.addSource(c.HOT,{data:{type:g.FEATURE_COLLECTION,features:[]},type:"geojson"}),P.options.styles.forEach(function(Pe){P.map.addLayer(Pe)}),P.store.setDirty(!0),P.store.render()},removeLayers:function(){P.options.styles.forEach(function(Pe){P.map.getLayer(Pe.id)&&P.map.removeLayer(Pe.id)}),P.map.getSource(c.COLD)&&P.map.removeSource(c.COLD),P.map.getSource(c.HOT)&&P.map.removeSource(c.HOT)}};return P.setup=_e,_e}var St=[{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":"#3bb2d0","fill-outline-color":"#3bb2d0","fill-opacity":.1}},{id:"gl-draw-polygon-fill-active",type:"fill",filter:["all",["==","active","true"],["==","$type","Polygon"]],paint:{"fill-color":"#fbb03b","fill-outline-color":"#fbb03b","fill-opacity":.1}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","active","true"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-line-active",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-stroke-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-color":"#fff"}},{id:"gl-draw-polygon-and-line-vertex-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-point-point-stroke-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-opacity":1,"circle-color":"#fff"}},{id:"gl-draw-point-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#3bb2d0"}},{id:"gl-draw-point-stroke-active",type:"circle",filter:["all",["==","$type","Point"],["==","active","true"],["!=","meta","midpoint"]],paint:{"circle-radius":7,"circle-color":"#fff"}},{id:"gl-draw-point-active",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","true"]],paint:{"circle-radius":5,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-fill-static",type:"fill",filter:["all",["==","mode","static"],["==","$type","Polygon"]],paint:{"fill-color":"#404040","fill-outline-color":"#404040","fill-opacity":.1}},{id:"gl-draw-polygon-stroke-static",type:"line",filter:["all",["==","mode","static"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-line-static",type:"line",filter:["all",["==","mode","static"],["==","$type","LineString"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-point-static",type:"circle",filter:["all",["==","mode","static"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"#404040"}}];function Xt(P){return function(z){var Z=z.featureTarget;return!!Z&&!!Z.properties&&Z.properties.meta===P}}function di(P){return!!P.originalEvent&&!!P.originalEvent.shiftKey&&P.originalEvent.button===0}function vi(P){return!!P.featureTarget&&!!P.featureTarget.properties&&P.featureTarget.properties.active===L.ACTIVE&&P.featureTarget.properties.meta===O.FEATURE}function Ci(P){return!!P.featureTarget&&!!P.featureTarget.properties&&P.featureTarget.properties.active===L.INACTIVE&&P.featureTarget.properties.meta===O.FEATURE}function ct(P){return P.featureTarget===void 0}function Ei(P){return!!P.featureTarget&&!!P.featureTarget.properties&&P.featureTarget.properties.meta===O.FEATURE}function Fi(P){var z=P.featureTarget;return!!z&&!!z.properties&&z.properties.meta===O.VERTEX}function yr(P){return!!P.originalEvent&&P.originalEvent.shiftKey===!0}function Zi(P){return P.keyCode===27}function Ct(P){return P.keyCode===13}var pi=Object.freeze({__proto__:null,isOfMetaType:Xt,isShiftMousedown:di,isActiveFeature:vi,isInactiveFeature:Ci,noTarget:ct,isFeature:Ei,isVertex:Fi,isShiftDown:yr,isEscapeKey:Zi,isEnterKey:Ct,isTrue:function(){return!0}}),Qt=qi;function qi(P,z){this.x=P,this.y=z}qi.prototype={clone:function(){return new qi(this.x,this.y)},add:function(P){return this.clone()._add(P)},sub:function(P){return this.clone()._sub(P)},multByPoint:function(P){return this.clone()._multByPoint(P)},divByPoint:function(P){return this.clone()._divByPoint(P)},mult:function(P){return this.clone()._mult(P)},div:function(P){return this.clone()._div(P)},rotate:function(P){return this.clone()._rotate(P)},rotateAround:function(P,z){return this.clone()._rotateAround(P,z)},matMult:function(P){return this.clone()._matMult(P)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(P){return this.x===P.x&&this.y===P.y},dist:function(P){return Math.sqrt(this.distSqr(P))},distSqr:function(P){var z=P.x-this.x,Z=P.y-this.y;return z*z+Z*Z},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(P){return Math.atan2(this.y-P.y,this.x-P.x)},angleWith:function(P){return this.angleWithSep(P.x,P.y)},angleWithSep:function(P,z){return Math.atan2(this.x*z-this.y*P,this.x*P+this.y*z)},_matMult:function(P){var z=P[0]*this.x+P[1]*this.y,Z=P[2]*this.x+P[3]*this.y;return this.x=z,this.y=Z,this},_add:function(P){return this.x+=P.x,this.y+=P.y,this},_sub:function(P){return this.x-=P.x,this.y-=P.y,this},_mult:function(P){return this.x*=P,this.y*=P,this},_div:function(P){return this.x/=P,this.y/=P,this},_multByPoint:function(P){return this.x*=P.x,this.y*=P.y,this},_divByPoint:function(P){return this.x/=P.x,this.y/=P.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var P=this.y;return this.y=this.x,this.x=-P,this},_rotate:function(P){var z=Math.cos(P),Z=Math.sin(P),_e=z*this.x-Z*this.y,Pe=Z*this.x+z*this.y;return this.x=_e,this.y=Pe,this},_rotateAround:function(P,z){var Z=Math.cos(P),_e=Math.sin(P),Pe=z.x+Z*(this.x-z.x)-_e*(this.y-z.y),Me=z.y+_e*(this.x-z.x)+Z*(this.y-z.y);return this.x=Pe,this.y=Me,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},qi.convert=function(P){return P instanceof qi?P:Array.isArray(P)?new qi(P[0],P[1]):P};var ar=fe(Qt);function si(P,z){var Z=z.getBoundingClientRect();return new ar(P.clientX-Z.left-(z.clientLeft||0),P.clientY-Z.top-(z.clientTop||0))}function Oi(P,z,Z,_e){return{type:g.FEATURE,properties:{meta:O.VERTEX,parent:P,coord_path:Z,active:_e?L.ACTIVE:L.INACTIVE},geometry:{type:g.POINT,coordinates:z}}}function $i(P,z,Z){var _e=z.geometry.coordinates,Pe=Z.geometry.coordinates;if(_e[1]>85||_e[1]<$||Pe[1]>85||Pe[1]<$)return null;var Me={lng:(_e[0]+Pe[0])/2,lat:(_e[1]+Pe[1])/2};return{type:g.FEATURE,properties:{meta:O.MIDPOINT,parent:P,lng:Me.lng,lat:Me.lat,coord_path:Z.properties.coord_path},geometry:{type:g.POINT,coordinates:[Me.lng,Me.lat]}}}function Ki(P,z,Z){z===void 0&&(z={}),Z===void 0&&(Z=null);var _e,Pe=P.geometry,Me=Pe.type,Be=Pe.coordinates,bt=P.properties&&P.properties.id,It=[];function Vt(Dt,_i){var rr="",fi=null;Dt.forEach(function(ji,yt){var ii=_i!=null?_i+"."+yt:String(yt),Hi=Oi(bt,ji,ii,Nt(ii));if(z.midpoints&&fi){var kr=$i(bt,fi,Hi);kr&&It.push(kr)}fi=Hi;var lr=JSON.stringify(ji);rr!==lr&&It.push(Hi),yt===0&&(rr=lr)})}function Nt(Dt){return!!z.selectedPaths&&z.selectedPaths.indexOf(Dt)!==-1}return Me===g.POINT?It.push(Oi(bt,Be,Z,Nt(Z))):Me===g.POLYGON?Be.forEach(function(Dt,_i){Vt(Dt,Z!==null?Z+"."+_i:String(_i))}):Me===g.LINE_STRING?Vt(Be,Z):Me.indexOf(g.MULTI_PREFIX)===0&&(_e=Me.replace(g.MULTI_PREFIX,""),Be.forEach(function(Dt,_i){var rr={type:g.FEATURE,properties:P.properties,geometry:{type:_e,coordinates:Dt}};It=It.concat(Ki(rr,z,_i))})),It}var le={enable:function(P){setTimeout(function(){P.map&&P.map.doubleClickZoom&&P._ctx&&P._ctx.store&&P._ctx.store.getInitialConfigValue&&P._ctx.store.getInitialConfigValue("doubleClickZoom")&&P.map.doubleClickZoom.enable()},0)},disable:function(P){setTimeout(function(){P.map&&P.map.doubleClickZoom&&P.map.doubleClickZoom.disable()},0)}},H={exports:{}},X=function(P){if(!P||!P.type)return null;var z=J[P.type];if(!z)return null;if(z==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:P}]};if(z==="feature")return{type:"FeatureCollection",features:[P]};if(z==="featurecollection")return P},J={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"},de=fe(X),Te=Object.freeze({__proto__:null,default:function P(z){switch(z&&z.type||null){case"FeatureCollection":return z.features=z.features.reduce(function(Z,_e){return Z.concat(P(_e))},[]),z;case"Feature":return z.geometry?P(z.geometry).map(function(Z){var _e={type:"Feature",properties:JSON.parse(JSON.stringify(z.properties)),geometry:Z};return z.id!==void 0&&(_e.id=z.id),_e}):[z];case"MultiPoint":return z.coordinates.map(function(Z){return{type:"Point",coordinates:Z}});case"MultiPolygon":return z.coordinates.map(function(Z){return{type:"Polygon",coordinates:Z}});case"MultiLineString":return z.coordinates.map(function(Z){return{type:"LineString",coordinates:Z}});case"GeometryCollection":return z.geometries.map(P).reduce(function(Z,_e){return Z.concat(_e)},[]);case"Point":case"Polygon":case"LineString":return[z]}}}),De=X,Le=he(Te),Ce=function(P){return function z(Z){return Array.isArray(Z)&&Z.length&&typeof Z[0]=="number"?[Z]:Z.reduce(function(_e,Pe){return Array.isArray(Pe)&&Array.isArray(Pe[0])?_e.concat(z(Pe)):(_e.push(Pe),_e)},[])}(P)};Le instanceof Function||(Le=Le.default);var Ge={exports:{}},gt=Ge.exports=function(P){return new Qe(P)};function Qe(P){this.value=P}function st(P,z,Z){var _e=[],Pe=[],Me=!0;return function Be(bt){var It=Z?ti(bt):bt,Vt={},Nt=!0,Dt={node:It,node_:bt,path:[].concat(_e),parent:Pe[Pe.length-1],parents:Pe,key:_e.slice(-1)[0],isRoot:_e.length===0,level:_e.length,circular:null,update:function(fi,ji){Dt.isRoot||(Dt.parent.node[Dt.key]=fi),Dt.node=fi,ji&&(Nt=!1)},delete:function(fi){delete Dt.parent.node[Dt.key],fi&&(Nt=!1)},remove:function(fi){mi(Dt.parent.node)?Dt.parent.node.splice(Dt.key,1):delete Dt.parent.node[Dt.key],fi&&(Nt=!1)},keys:null,before:function(fi){Vt.before=fi},after:function(fi){Vt.after=fi},pre:function(fi){Vt.pre=fi},post:function(fi){Vt.post=fi},stop:function(){Me=!1},block:function(){Nt=!1}};if(!Me)return Dt;function _i(){if(typeof Dt.node=="object"&&Dt.node!==null){Dt.keys&&Dt.node_===Dt.node||(Dt.keys=ei(Dt.node)),Dt.isLeaf=Dt.keys.length==0;for(var fi=0;fi<Pe.length;fi++)if(Pe[fi].node_===bt){Dt.circular=Pe[fi];break}}else Dt.isLeaf=!0,Dt.keys=null;Dt.notLeaf=!Dt.isLeaf,Dt.notRoot=!Dt.isRoot}_i();var rr=z.call(Dt,Dt.node);return rr!==void 0&&Dt.update&&Dt.update(rr),Vt.before&&Vt.before.call(Dt,Dt.node),Nt&&(typeof Dt.node!="object"||Dt.node===null||Dt.circular||(Pe.push(Dt),_i(),Pi(Dt.keys,function(fi,ji){_e.push(fi),Vt.pre&&Vt.pre.call(Dt,Dt.node[fi],fi);var yt=Be(Dt.node[fi]);Z&&Li.call(Dt.node,fi)&&(Dt.node[fi]=yt.node),yt.isLast=ji==Dt.keys.length-1,yt.isFirst=ji==0,Vt.post&&Vt.post.call(Dt,yt),_e.pop()}),Pe.pop()),Vt.after&&Vt.after.call(Dt,Dt.node)),Dt}(P).node}function ti(P){if(typeof P=="object"&&P!==null){var z;if(mi(P))z=[];else if(xi(P)==="[object Date]")z=new Date(P.getTime?P.getTime():P);else if(function(Pe){return xi(Pe)==="[object RegExp]"}(P))z=new RegExp(P);else if(function(Pe){return xi(Pe)==="[object Error]"}(P))z={message:P.message};else if(function(Pe){return xi(Pe)==="[object Boolean]"}(P))z=new Boolean(P);else if(function(Pe){return xi(Pe)==="[object Number]"}(P))z=new Number(P);else if(function(Pe){return xi(Pe)==="[object String]"}(P))z=new String(P);else if(Object.create&&Object.getPrototypeOf)z=Object.create(Object.getPrototypeOf(P));else if(P.constructor===Object)z={};else{var Z=P.constructor&&P.constructor.prototype||P.__proto__||{},_e=function(){};_e.prototype=Z,z=new _e}return Pi(ei(P),function(Pe){z[Pe]=P[Pe]}),z}return P}Qe.prototype.get=function(P){for(var z=this.value,Z=0;Z<P.length;Z++){var _e=P[Z];if(!z||!Li.call(z,_e)){z=void 0;break}z=z[_e]}return z},Qe.prototype.has=function(P){for(var z=this.value,Z=0;Z<P.length;Z++){var _e=P[Z];if(!z||!Li.call(z,_e))return!1;z=z[_e]}return!0},Qe.prototype.set=function(P,z){for(var Z=this.value,_e=0;_e<P.length-1;_e++){var Pe=P[_e];Li.call(Z,Pe)||(Z[Pe]={}),Z=Z[Pe]}return Z[P[_e]]=z,z},Qe.prototype.map=function(P){return st(this.value,P,!0)},Qe.prototype.forEach=function(P){return this.value=st(this.value,P,!1),this.value},Qe.prototype.reduce=function(P,z){var Z=arguments.length===1,_e=Z?this.value:z;return this.forEach(function(Pe){this.isRoot&&Z||(_e=P.call(this,_e,Pe))}),_e},Qe.prototype.paths=function(){var P=[];return this.forEach(function(z){P.push(this.path)}),P},Qe.prototype.nodes=function(){var P=[];return this.forEach(function(z){P.push(this.node)}),P},Qe.prototype.clone=function(){var P=[],z=[];return function Z(_e){for(var Pe=0;Pe<P.length;Pe++)if(P[Pe]===_e)return z[Pe];if(typeof _e=="object"&&_e!==null){var Me=ti(_e);return P.push(_e),z.push(Me),Pi(ei(_e),function(Be){Me[Be]=Z(_e[Be])}),P.pop(),z.pop(),Me}return _e}(this.value)};var ei=Object.keys||function(P){var z=[];for(var Z in P)z.push(Z);return z};function xi(P){return Object.prototype.toString.call(P)}var mi=Array.isArray||function(P){return Object.prototype.toString.call(P)==="[object Array]"},Pi=function(P,z){if(P.forEach)return P.forEach(z);for(var Z=0;Z<P.length;Z++)z(P[Z],Z,P)};Pi(ei(Qe.prototype),function(P){gt[P]=function(z){var Z=[].slice.call(arguments,1),_e=new Qe(z);return _e[P].apply(_e,Z)}});var Li=Object.hasOwnProperty||function(P,z){return z in P},tr=Ge.exports,Mr=ui;function ui(P){if(!(this instanceof ui))return new ui(P);this._bbox=P||[1/0,1/0,-1/0,-1/0],this._valid=!!P}ui.prototype.include=function(P){return this._valid=!0,this._bbox[0]=Math.min(this._bbox[0],P[0]),this._bbox[1]=Math.min(this._bbox[1],P[1]),this._bbox[2]=Math.max(this._bbox[2],P[0]),this._bbox[3]=Math.max(this._bbox[3],P[1]),this},ui.prototype.equals=function(P){var z;return z=P instanceof ui?P.bbox():P,this._bbox[0]==z[0]&&this._bbox[1]==z[1]&&this._bbox[2]==z[2]&&this._bbox[3]==z[3]},ui.prototype.center=function(P){return this._valid?[(this._bbox[0]+this._bbox[2])/2,(this._bbox[1]+this._bbox[3])/2]:null},ui.prototype.union=function(P){var z;return this._valid=!0,z=P instanceof ui?P.bbox():P,this._bbox[0]=Math.min(this._bbox[0],z[0]),this._bbox[1]=Math.min(this._bbox[1],z[1]),this._bbox[2]=Math.max(this._bbox[2],z[2]),this._bbox[3]=Math.max(this._bbox[3],z[3]),this},ui.prototype.bbox=function(){return this._valid?this._bbox:null},ui.prototype.contains=function(P){if(!P)return this._fastContains();if(!this._valid)return null;var z=P[0],Z=P[1];return this._bbox[0]<=z&&this._bbox[1]<=Z&&this._bbox[2]>=z&&this._bbox[3]>=Z},ui.prototype.intersect=function(P){return this._valid?(z=P instanceof ui?P.bbox():P,!(this._bbox[0]>z[2]||this._bbox[2]<z[0]||this._bbox[3]<z[1]||this._bbox[1]>z[3])):null;var z},ui.prototype._fastContains=function(){if(!this._valid)return new Function("return null;");var P="return "+this._bbox[0]+"<= ll[0] &&"+this._bbox[1]+"<= ll[1] &&"+this._bbox[2]+">= ll[0] &&"+this._bbox[3]+">= ll[1]";return new Function("ll",P)},ui.prototype.polygon=function(){return this._valid?{type:"Polygon",coordinates:[[[this._bbox[0],this._bbox[1]],[this._bbox[2],this._bbox[1]],[this._bbox[2],this._bbox[3]],[this._bbox[0],this._bbox[3]],[this._bbox[0],this._bbox[1]]]]}:null};var dr=function(P){if(!P)return[];var z=Le(De(P)),Z=[];return z.features.forEach(function(_e){_e.geometry&&(Z=Z.concat(Ce(_e.geometry.coordinates)))}),Z},Lr=tr,Qr=Mr,en={features:["FeatureCollection"],coordinates:["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],geometry:["Feature"],geometries:["GeometryCollection"]},Fr=Object.keys(en);function hs(P){for(var z=Qr(),Z=dr(P),_e=0;_e<Z.length;_e++)z.include(Z[_e]);return z}H.exports=function(P){return hs(P).bbox()},H.exports.polygon=function(P){return hs(P).polygon()},H.exports.bboxify=function(P){return Lr(P).map(function(z){z&&Fr.some(function(Z){return!!z[Z]&&en[Z].indexOf(z.type)!==-1})&&(z.bbox=hs(z).bbox(),this.update(z))})};var Tl=fe(H.exports),zi=-90;function po(P,z){var Z=zi,_e=90,Pe=zi,Me=90,Be=270,bt=-270;P.forEach(function(Vt){var Nt=Tl(Vt),Dt=Nt[1],_i=Nt[3],rr=Nt[0],fi=Nt[2];Dt>Z&&(Z=Dt),_i<_e&&(_e=_i),_i>Pe&&(Pe=_i),Dt<Me&&(Me=Dt),rr<Be&&(Be=rr),fi>bt&&(bt=fi)});var It=z;return Z+It.lat>85&&(It.lat=85-Z),Pe+It.lat>90&&(It.lat=90-Pe),_e+It.lat<-85&&(It.lat=-85-_e),Me+It.lat<zi&&(It.lat=zi-Me),Be+It.lng<=-270&&(It.lng+=360*Math.ceil(Math.abs(It.lng)/360)),bt+It.lng>=270&&(It.lng-=360*Math.ceil(Math.abs(It.lng)/360)),It}function mo(P,z){var Z=po(P.map(function(_e){return _e.toGeoJSON()}),z);P.forEach(function(_e){var Pe,Me=_e.getCoordinates(),Be=function(It){var Vt={lng:It[0]+Z.lng,lat:It[1]+Z.lat};return[Vt.lng,Vt.lat]},bt=function(It){return It.map(function(Vt){return Be(Vt)})};_e.type===g.POINT?Pe=Be(Me):_e.type===g.LINE_STRING||_e.type===g.MULTI_POINT?Pe=Me.map(Be):_e.type===g.POLYGON||_e.type===g.MULTI_LINE_STRING?Pe=Me.map(bt):_e.type===g.MULTI_POLYGON&&(Pe=Me.map(function(It){return It.map(function(Vt){return bt(Vt)})})),_e.incomingCoords(Pe)})}var Wi={onSetup:function(P){var z=this,Z={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initiallySelectedFeatureIds:P.featureIds||[]};return this.setSelected(Z.initiallySelectedFeatureIds.filter(function(_e){return z.getFeature(_e)!==void 0})),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),Z},fireUpdate:function(){this.map.fire(w.UPDATE,{action:E.MOVE,features:this.getSelected().map(function(P){return P.toGeoJSON()})})},fireActionable:function(){var P=this,z=this.getSelected(),Z=z.filter(function(bt){return P.isInstanceOf("MultiFeature",bt)}),_e=!1;if(z.length>1){_e=!0;var Pe=z[0].type.replace("Multi","");z.forEach(function(bt){bt.type.replace("Multi","")!==Pe&&(_e=!1)})}var Me=Z.length>0,Be=z.length>0;this.setActionableState({combineFeatures:_e,uncombineFeatures:Me,trash:Be})},getUniqueIds:function(P){return P.length?P.map(function(z){return z.properties.id}).filter(function(z){return z!==void 0}).reduce(function(z,Z){return z.add(Z),z},new tt).values():[]},stopExtendedInteractions:function(P){P.boxSelectElement&&(P.boxSelectElement.parentNode&&P.boxSelectElement.parentNode.removeChild(P.boxSelectElement),P.boxSelectElement=null),this.map.dragPan.enable(),P.boxSelecting=!1,P.canBoxSelect=!1,P.dragMoving=!1,P.canDragMove=!1},onStop:function(){le.enable(this)},onMouseMove:function(P,z){return Ei(z)&&P.dragMoving&&this.fireUpdate(),this.stopExtendedInteractions(P),!0},onMouseOut:function(P){return!P.dragMoving||this.fireUpdate()}};Wi.onTap=Wi.onClick=function(P,z){return ct(z)?this.clickAnywhere(P,z):Xt(O.VERTEX)(z)?this.clickOnVertex(P,z):Ei(z)?this.clickOnFeature(P,z):void 0},Wi.clickAnywhere=function(P){var z=this,Z=this.getSelectedIds();Z.length&&(this.clearSelectedFeatures(),Z.forEach(function(_e){return z.doRender(_e)})),le.enable(this),this.stopExtendedInteractions(P)},Wi.clickOnVertex=function(P,z){this.changeMode(d.DIRECT_SELECT,{featureId:z.featureTarget.properties.parent,coordPath:z.featureTarget.properties.coord_path,startPos:z.lngLat}),this.updateUIClasses({mouse:h.MOVE})},Wi.startOnActiveFeature=function(P,z){this.stopExtendedInteractions(P),this.map.dragPan.disable(),this.doRender(z.featureTarget.properties.id),P.canDragMove=!0,P.dragMoveLocation=z.lngLat},Wi.clickOnFeature=function(P,z){var Z=this;le.disable(this),this.stopExtendedInteractions(P);var _e=yr(z),Pe=this.getSelectedIds(),Me=z.featureTarget.properties.id,Be=this.isSelected(Me);if(!_e&&Be&&this.getFeature(Me).type!==g.POINT)return this.changeMode(d.DIRECT_SELECT,{featureId:Me});Be&&_e?(this.deselect(Me),this.updateUIClasses({mouse:h.POINTER}),Pe.length===1&&le.enable(this)):!Be&&_e?(this.select(Me),this.updateUIClasses({mouse:h.MOVE})):Be||_e||(Pe.forEach(function(bt){return Z.doRender(bt)}),this.setSelected(Me),this.updateUIClasses({mouse:h.MOVE})),this.doRender(Me)},Wi.onMouseDown=function(P,z){return vi(z)?this.startOnActiveFeature(P,z):this.drawConfig.boxSelect&&di(z)?this.startBoxSelect(P,z):void 0},Wi.startBoxSelect=function(P,z){this.stopExtendedInteractions(P),this.map.dragPan.disable(),P.boxSelectStartLocation=si(z.originalEvent,this.map.getContainer()),P.canBoxSelect=!0},Wi.onTouchStart=function(P,z){if(vi(z))return this.startOnActiveFeature(P,z)},Wi.onDrag=function(P,z){return P.canDragMove?this.dragMove(P,z):this.drawConfig.boxSelect&&P.canBoxSelect?this.whileBoxSelect(P,z):void 0},Wi.whileBoxSelect=function(P,z){P.boxSelecting=!0,this.updateUIClasses({mouse:h.ADD}),P.boxSelectElement||(P.boxSelectElement=document.createElement("div"),P.boxSelectElement.classList.add(l.BOX_SELECT),this.map.getContainer().appendChild(P.boxSelectElement));var Z=si(z.originalEvent,this.map.getContainer()),_e=Math.min(P.boxSelectStartLocation.x,Z.x),Pe=Math.max(P.boxSelectStartLocation.x,Z.x),Me=Math.min(P.boxSelectStartLocation.y,Z.y),Be=Math.max(P.boxSelectStartLocation.y,Z.y),bt="translate("+_e+"px, "+Me+"px)";P.boxSelectElement.style.transform=bt,P.boxSelectElement.style.WebkitTransform=bt,P.boxSelectElement.style.width=Pe-_e+"px",P.boxSelectElement.style.height=Be-Me+"px"},Wi.dragMove=function(P,z){P.dragMoving=!0,z.originalEvent.stopPropagation();var Z={lng:z.lngLat.lng-P.dragMoveLocation.lng,lat:z.lngLat.lat-P.dragMoveLocation.lat};mo(this.getSelected(),Z),P.dragMoveLocation=z.lngLat},Wi.onTouchEnd=Wi.onMouseUp=function(P,z){var Z=this;if(P.dragMoving)this.fireUpdate();else if(P.boxSelecting){var _e=[P.boxSelectStartLocation,si(z.originalEvent,this.map.getContainer())],Pe=this.featuresAt(null,_e,"click"),Me=this.getUniqueIds(Pe).filter(function(Be){return!Z.isSelected(Be)});Me.length&&(this.select(Me),Me.forEach(function(Be){return Z.doRender(Be)}),this.updateUIClasses({mouse:h.MOVE}))}this.stopExtendedInteractions(P)},Wi.toDisplayFeatures=function(P,z,Z){z.properties.active=this.isSelected(z.properties.id)?L.ACTIVE:L.INACTIVE,Z(z),this.fireActionable(),z.properties.active===L.ACTIVE&&z.geometry.type!==g.POINT&&Ki(z).forEach(Z)},Wi.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()},Wi.onCombineFeatures=function(){var P=this.getSelected();if(!(P.length===0||P.length<2)){for(var z=[],Z=[],_e=P[0].type.replace("Multi",""),Pe=0;Pe<P.length;Pe++){var Me=P[Pe];if(Me.type.replace("Multi","")!==_e)return;Me.type.includes("Multi")?Me.getCoordinates().forEach(function(bt){z.push(bt)}):z.push(Me.getCoordinates()),Z.push(Me.toGeoJSON())}if(Z.length>1){var Be=this.newFeature({type:g.FEATURE,properties:Z[0].properties,geometry:{type:"Multi"+_e,coordinates:z}});this.addFeature(Be),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([Be.id]),this.map.fire(w.COMBINE_FEATURES,{createdFeatures:[Be.toGeoJSON()],deletedFeatures:Z})}this.fireActionable()}},Wi.onUncombineFeatures=function(){var P=this,z=this.getSelected();if(z.length!==0){for(var Z=[],_e=[],Pe=function(Be){var bt=z[Be];P.isInstanceOf("MultiFeature",bt)&&(bt.getFeatures().forEach(function(It){P.addFeature(It),It.properties=bt.properties,Z.push(It.toGeoJSON()),P.select([It.id])}),P.deleteFeature(bt.id,{silent:!0}),_e.push(bt.toGeoJSON()))},Me=0;Me<z.length;Me++)Pe(Me);Z.length>1&&this.map.fire(w.UNCOMBINE_FEATURES,{createdFeatures:Z,deletedFeatures:_e}),this.fireActionable()}};var qr=Xt(O.VERTEX),Ls=Xt(O.MIDPOINT),Cr={fireUpdate:function(){this.map.fire(w.UPDATE,{action:E.CHANGE_COORDINATES,features:this.getSelected().map(function(P){return P.toGeoJSON()})})},fireActionable:function(P){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:P.selectedCoordPaths.length>0})},startDragging:function(P,z){this.map.dragPan.disable(),P.canDragMove=!0,P.dragMoveLocation=z.lngLat},stopDragging:function(P){this.map.dragPan.enable(),P.dragMoving=!1,P.canDragMove=!1,P.dragMoveLocation=null},onVertex:function(P,z){this.startDragging(P,z);var Z=z.featureTarget.properties,_e=P.selectedCoordPaths.indexOf(Z.coord_path);yr(z)||_e!==-1?yr(z)&&_e===-1&&P.selectedCoordPaths.push(Z.coord_path):P.selectedCoordPaths=[Z.coord_path];var Pe=this.pathsToCoordinates(P.featureId,P.selectedCoordPaths);this.setSelectedCoordinates(Pe)},onMidpoint:function(P,z){this.startDragging(P,z);var Z=z.featureTarget.properties;P.feature.addCoordinate(Z.coord_path,Z.lng,Z.lat),this.fireUpdate(),P.selectedCoordPaths=[Z.coord_path]},pathsToCoordinates:function(P,z){return z.map(function(Z){return{feature_id:P,coord_path:Z}})},onFeature:function(P,z){P.selectedCoordPaths.length===0?this.startDragging(P,z):this.stopDragging(P)},dragFeature:function(P,z,Z){mo(this.getSelected(),Z),P.dragMoveLocation=z.lngLat},dragVertex:function(P,z,Z){for(var _e=P.selectedCoordPaths.map(function(bt){return P.feature.getCoordinate(bt)}),Pe=po(_e.map(function(bt){return{type:g.FEATURE,properties:{},geometry:{type:g.POINT,coordinates:bt}}}),Z),Me=0;Me<_e.length;Me++){var Be=_e[Me];P.feature.updateCoordinate(P.selectedCoordPaths[Me],Be[0]+Pe.lng,Be[1]+Pe.lat)}},clickNoTarget:function(){this.changeMode(d.SIMPLE_SELECT)},clickInactive:function(){this.changeMode(d.SIMPLE_SELECT)},clickActiveFeature:function(P){P.selectedCoordPaths=[],this.clearSelectedCoordinates(),P.feature.changed()},onSetup:function(P){var z=P.featureId,Z=this.getFeature(z);if(!Z)throw new Error("You must provide a featureId to enter direct_select mode");if(Z.type===g.POINT)throw new TypeError("direct_select mode doesn't handle point features");var _e={featureId:z,feature:Z,dragMoveLocation:P.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:P.coordPath?[P.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(z,_e.selectedCoordPaths)),this.setSelected(z),le.disable(this),this.setActionableState({trash:!0}),_e},onStop:function(){le.enable(this),this.clearSelectedCoordinates()},toDisplayFeatures:function(P,z,Z){P.featureId===z.properties.id?(z.properties.active=L.ACTIVE,Z(z),Ki(z,{map:this.map,midpoints:!0,selectedPaths:P.selectedCoordPaths}).forEach(Z)):(z.properties.active=L.INACTIVE,Z(z)),this.fireActionable(P)},onTrash:function(P){P.selectedCoordPaths.sort(function(z,Z){return Z.localeCompare(z,"en",{numeric:!0})}).forEach(function(z){return P.feature.removeCoordinate(z)}),this.fireUpdate(),P.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(P),P.feature.isValid()===!1&&(this.deleteFeature([P.featureId]),this.changeMode(d.SIMPLE_SELECT,{}))},onMouseMove:function(P,z){var Z=vi(z),_e=qr(z),Pe=Ls(z),Me=P.selectedCoordPaths.length===0;return Z&&Me||_e&&!Me?this.updateUIClasses({mouse:h.MOVE}):this.updateUIClasses({mouse:h.NONE}),(_e||Z||Pe)&&P.dragMoving&&this.fireUpdate(),this.stopDragging(P),!0},onMouseOut:function(P){return P.dragMoving&&this.fireUpdate(),!0}};Cr.onTouchStart=Cr.onMouseDown=function(P,z){return qr(z)?this.onVertex(P,z):vi(z)?this.onFeature(P,z):Ls(z)?this.onMidpoint(P,z):void 0},Cr.onDrag=function(P,z){if(P.canDragMove===!0){P.dragMoving=!0,z.originalEvent.stopPropagation();var Z={lng:z.lngLat.lng-P.dragMoveLocation.lng,lat:z.lngLat.lat-P.dragMoveLocation.lat};P.selectedCoordPaths.length>0?this.dragVertex(P,z,Z):this.dragFeature(P,z,Z),P.dragMoveLocation=z.lngLat}},Cr.onClick=function(P,z){return ct(z)?this.clickNoTarget(P,z):vi(z)?this.clickActiveFeature(P,z):Ci(z)?this.clickInactive(P,z):void this.stopDragging(P)},Cr.onTap=function(P,z){return ct(z)?this.clickNoTarget(P,z):vi(z)?this.clickActiveFeature(P,z):Ci(z)?this.clickInactive(P,z):void 0},Cr.onTouchEnd=Cr.onMouseUp=function(P){P.dragMoving&&this.fireUpdate(),this.stopDragging(P)};var Sr={};function go(P,z){return!!P.lngLat&&P.lngLat.lng===z[0]&&P.lngLat.lat===z[1]}Sr.onSetup=function(){var P=this.newFeature({type:g.FEATURE,properties:{},geometry:{type:g.POINT,coordinates:[]}});return this.addFeature(P),this.clearSelectedFeatures(),this.updateUIClasses({mouse:h.ADD}),this.activateUIButton(m.POINT),this.setActionableState({trash:!0}),{point:P}},Sr.stopDrawingAndRemove=function(P){this.deleteFeature([P.point.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT)},Sr.onTap=Sr.onClick=function(P,z){this.updateUIClasses({mouse:h.MOVE}),P.point.updateCoordinate("",z.lngLat.lng,z.lngLat.lat),this.map.fire(w.CREATE,{features:[P.point.toGeoJSON()]}),this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.point.id]})},Sr.onStop=function(P){this.activateUIButton(),P.point.getCoordinate().length||this.deleteFeature([P.point.id],{silent:!0})},Sr.toDisplayFeatures=function(P,z,Z){var _e=z.properties.id===P.point.id;if(z.properties.active=_e?L.ACTIVE:L.INACTIVE,!_e)return Z(z)},Sr.onTrash=Sr.stopDrawingAndRemove,Sr.onKeyUp=function(P,z){if(Zi(z)||Ct(z))return this.stopDrawingAndRemove(P,z)};var $r={onSetup:function(){var P=this.newFeature({type:g.FEATURE,properties:{},geometry:{type:g.POLYGON,coordinates:[[]]}});return this.addFeature(P),this.clearSelectedFeatures(),le.disable(this),this.updateUIClasses({mouse:h.ADD}),this.activateUIButton(m.POLYGON),this.setActionableState({trash:!0}),{polygon:P,currentVertexPosition:0}},clickAnywhere:function(P,z){if(P.currentVertexPosition>0&&go(z,P.polygon.coordinates[0][P.currentVertexPosition-1]))return this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.polygon.id]});this.updateUIClasses({mouse:h.ADD}),P.polygon.updateCoordinate("0."+P.currentVertexPosition,z.lngLat.lng,z.lngLat.lat),P.currentVertexPosition++,P.polygon.updateCoordinate("0."+P.currentVertexPosition,z.lngLat.lng,z.lngLat.lat)},clickOnVertex:function(P){return this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.polygon.id]})},onMouseMove:function(P,z){P.polygon.updateCoordinate("0."+P.currentVertexPosition,z.lngLat.lng,z.lngLat.lat),Fi(z)&&this.updateUIClasses({mouse:h.POINTER})}};$r.onTap=$r.onClick=function(P,z){return Fi(z)?this.clickOnVertex(P,z):this.clickAnywhere(P,z)},$r.onKeyUp=function(P,z){Zi(z)?(this.deleteFeature([P.polygon.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT)):Ct(z)&&this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.polygon.id]})},$r.onStop=function(P){this.updateUIClasses({mouse:h.NONE}),le.enable(this),this.activateUIButton(),this.getFeature(P.polygon.id)!==void 0&&(P.polygon.removeCoordinate("0."+P.currentVertexPosition),P.polygon.isValid()?this.map.fire(w.CREATE,{features:[P.polygon.toGeoJSON()]}):(this.deleteFeature([P.polygon.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT,{},{silent:!0})))},$r.toDisplayFeatures=function(P,z,Z){var _e=z.properties.id===P.polygon.id;if(z.properties.active=_e?L.ACTIVE:L.INACTIVE,!_e)return Z(z);if(z.geometry.coordinates.length!==0){var Pe=z.geometry.coordinates[0].length;if(!(Pe<3)){if(z.properties.meta=O.FEATURE,Z(Oi(P.polygon.id,z.geometry.coordinates[0][0],"0.0",!1)),Pe>3){var Me=z.geometry.coordinates[0].length-3;Z(Oi(P.polygon.id,z.geometry.coordinates[0][Me],"0."+Me,!1))}if(Pe<=4){var Be=[[z.geometry.coordinates[0][0][0],z.geometry.coordinates[0][0][1]],[z.geometry.coordinates[0][1][0],z.geometry.coordinates[0][1][1]]];if(Z({type:g.FEATURE,properties:z.properties,geometry:{coordinates:Be,type:g.LINE_STRING}}),Pe===3)return}return Z(z)}}},$r.onTrash=function(P){this.deleteFeature([P.polygon.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT)};var ir={onSetup:function(P){var z,Z,_e=(P=P||{}).featureId,Pe="forward";if(_e){if(!(z=this.getFeature(_e)))throw new Error("Could not find a feature with the provided featureId");var Me=P.from;if(Me&&Me.type==="Feature"&&Me.geometry&&Me.geometry.type==="Point"&&(Me=Me.geometry),Me&&Me.type==="Point"&&Me.coordinates&&Me.coordinates.length===2&&(Me=Me.coordinates),!Me||!Array.isArray(Me))throw new Error("Please use the `from` property to indicate which point to continue the line from");var Be=z.coordinates.length-1;if(z.coordinates[Be][0]===Me[0]&&z.coordinates[Be][1]===Me[1])Z=Be+1,z.addCoordinate.apply(z,[Z].concat(z.coordinates[Be]));else{if(z.coordinates[0][0]!==Me[0]||z.coordinates[0][1]!==Me[1])throw new Error("`from` should match the point at either the start or the end of the provided LineString");Pe="backwards",Z=0,z.addCoordinate.apply(z,[Z].concat(z.coordinates[0]))}}else z=this.newFeature({type:g.FEATURE,properties:{},geometry:{type:g.LINE_STRING,coordinates:[]}}),Z=0,this.addFeature(z);return this.clearSelectedFeatures(),le.disable(this),this.updateUIClasses({mouse:h.ADD}),this.activateUIButton(m.LINE),this.setActionableState({trash:!0}),{line:z,currentVertexPosition:Z,direction:Pe}},clickAnywhere:function(P,z){if(P.currentVertexPosition>0&&go(z,P.line.coordinates[P.currentVertexPosition-1])||P.direction==="backwards"&&go(z,P.line.coordinates[P.currentVertexPosition+1]))return this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.line.id]});this.updateUIClasses({mouse:h.ADD}),P.line.updateCoordinate(P.currentVertexPosition,z.lngLat.lng,z.lngLat.lat),P.direction==="forward"?(P.currentVertexPosition++,P.line.updateCoordinate(P.currentVertexPosition,z.lngLat.lng,z.lngLat.lat)):P.line.addCoordinate(0,z.lngLat.lng,z.lngLat.lat)},clickOnVertex:function(P){return this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.line.id]})},onMouseMove:function(P,z){P.line.updateCoordinate(P.currentVertexPosition,z.lngLat.lng,z.lngLat.lat),Fi(z)&&this.updateUIClasses({mouse:h.POINTER})}};ir.onTap=ir.onClick=function(P,z){if(Fi(z))return this.clickOnVertex(P,z);this.clickAnywhere(P,z)},ir.onKeyUp=function(P,z){Ct(z)?this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.line.id]}):Zi(z)&&(this.deleteFeature([P.line.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT))},ir.onStop=function(P){le.enable(this),this.activateUIButton(),this.getFeature(P.line.id)!==void 0&&(P.line.removeCoordinate(""+P.currentVertexPosition),P.line.isValid()?this.map.fire(w.CREATE,{features:[P.line.toGeoJSON()]}):(this.deleteFeature([P.line.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT,{},{silent:!0})))},ir.onTrash=function(P){this.deleteFeature([P.line.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT)},ir.toDisplayFeatures=function(P,z,Z){var _e=z.properties.id===P.line.id;if(z.properties.active=_e?L.ACTIVE:L.INACTIVE,!_e)return Z(z);z.geometry.coordinates.length<2||(z.properties.meta=O.FEATURE,Z(Oi(P.line.id,z.geometry.coordinates[P.direction==="forward"?z.geometry.coordinates.length-2:1],""+(P.direction==="forward"?z.geometry.coordinates.length-2:1),!1)),Z(z))};var Fs={simple_select:Wi,direct_select:Cr,draw_point:Sr,draw_polygon:$r,draw_line_string:ir},ws={defaultMode:d.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:St,modes:Fs,controls:{},userProperties:!1},vr={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},Cs={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function wn(P,z){return P.map(function(Z){return Z.source?Z:Lt(Z,{id:Z.id+"."+z,source:z==="hot"?c.HOT:c.COLD})})}var zs={exports:{}};(function(P,z){var Z="__lodash_hash_undefined__",_e=9007199254740991,Pe="[object Arguments]",Me="[object Array]",Be="[object Boolean]",bt="[object Date]",It="[object Error]",Vt="[object Function]",Nt="[object Map]",Dt="[object Number]",_i="[object Object]",rr="[object Promise]",fi="[object RegExp]",ji="[object Set]",yt="[object String]",ii="[object Symbol]",Hi="[object WeakMap]",kr="[object ArrayBuffer]",lr="[object DataView]",pa=/^\[object .+?Constructor\]$/,Wa=/^(?:0|[1-9]\d*)$/,nr={};nr["[object Float32Array]"]=nr["[object Float64Array]"]=nr["[object Int8Array]"]=nr["[object Int16Array]"]=nr["[object Int32Array]"]=nr["[object Uint8Array]"]=nr["[object Uint8ClampedArray]"]=nr["[object Uint16Array]"]=nr["[object Uint32Array]"]=!0,nr[Pe]=nr[Me]=nr[kr]=nr[Be]=nr[lr]=nr[bt]=nr[It]=nr[Vt]=nr[Nt]=nr[Dt]=nr[_i]=nr[fi]=nr[ji]=nr[yt]=nr[Hi]=!1;var Ha=typeof xl=="object"&&xl&&xl.Object===Object&&xl,El=typeof self=="object"&&self&&self.Object===Object&&self,Zn=Ha||El||Function("return this")(),_o=z&&!z.nodeType&&z,Bo=_o&&P&&!P.nodeType&&P,yo=Bo&&Bo.exports===_o,vo=yo&&Ha.process,Bs=function(){try{return vo&&vo.binding&&vo.binding("util")}catch{}}(),tn=Bs&&Bs.isTypedArray;function Ni(je,qe){for(var Ft=-1,ci=je==null?0:je.length;++Ft<ci;)if(qe(je[Ft],Ft,je))return!0;return!1}function ma(je){var qe=-1,Ft=Array(je.size);return je.forEach(function(ci,Yi){Ft[++qe]=[Yi,ci]}),Ft}function xo(je){var qe=-1,Ft=Array(je.size);return je.forEach(function(ci){Ft[++qe]=ci}),Ft}var js,Xa,bo,Pl=Array.prototype,Ns=Function.prototype,jo=Object.prototype,No=Zn["__core-js_shared__"],qa=Ns.toString,Dn=jo.hasOwnProperty,Vo=(js=/[^.]+$/.exec(No&&No.keys&&No.keys.IE_PROTO||""))?"Symbol(src)_1."+js:"",ga=jo.toString,$a=RegExp("^"+qa.call(Dn).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),_a=yo?Zn.Buffer:void 0,wo=Zn.Symbol,us=Zn.Uint8Array,ya=jo.propertyIsEnumerable,Il=Pl.splice,Ss=wo?wo.toStringTag:void 0,va=Object.getOwnPropertySymbols,Co=_a?_a.isBuffer:void 0,Al=(Xa=Object.keys,bo=Object,function(je){return Xa(bo(je))}),Vs=pn(Zn,"DataView"),So=pn(Zn,"Map"),xa=pn(Zn,"Promise"),Uo=pn(Zn,"Set"),Go=pn(Zn,"WeakMap"),Us=pn(Object,"create"),ba=fs(Vs),Ya=fs(So),Gs=fs(xa),Kn=fs(Uo),wa=fs(Go),Wo=wo?wo.prototype:void 0,To=Wo?Wo.valueOf:void 0;function Ji(je){var qe=-1,Ft=je==null?0:je.length;for(this.clear();++qe<Ft;){var ci=je[qe];this.set(ci[0],ci[1])}}function Ln(je){var qe=-1,Ft=je==null?0:je.length;for(this.clear();++qe<Ft;){var ci=je[qe];this.set(ci[0],ci[1])}}function Si(je){var qe=-1,Ft=je==null?0:je.length;for(this.clear();++qe<Ft;){var ci=je[qe];this.set(ci[0],ci[1])}}function ds(je){var qe=-1,Ft=je==null?0:je.length;for(this.__data__=new Si;++qe<Ft;)this.add(je[qe])}function Xi(je){var qe=this.__data__=new Ln(je);this.size=qe.size}function cr(je,qe){var Ft=As(je),ci=!Ft&&Is(je),Yi=!Ft&&!ci&&Xs(je),ki=!Ft&&!ci&&!Yi&&Un(je),fr=Ft||ci||Yi||ki,Er=fr?function(Pr,gn){for(var Cn=-1,Nr=Array(Pr);++Cn<Pr;)Nr[Cn]=gn(Cn);return Nr}(je.length,String):[],mn=Er.length;for(var xr in je)!qe&&!Dn.call(je,xr)||fr&&(xr=="length"||Yi&&(xr=="offset"||xr=="parent")||ki&&(xr=="buffer"||xr=="byteLength"||xr=="byteOffset")||Ja(xr,mn))||Er.push(xr);return Er}function Ts(je,qe){for(var Ft=je.length;Ft--;)if(qo(je[Ft][0],qe))return Ft;return-1}function Ws(je){return je==null?je===void 0?"[object Undefined]":"[object Null]":Ss&&Ss in Object(je)?function(qe){var Ft=Dn.call(qe,Ss),ci=qe[Ss];try{qe[Ss]=void 0;var Yi=!0}catch{}var ki=ga.call(qe);return Yi&&(Ft?qe[Ss]=ci:delete qe[Ss]),ki}(je):function(qe){return ga.call(qe)}(je)}function Ho(je){return Fn(je)&&Ws(je)==Pe}function Za(je,qe,Ft,ci,Yi){return je===qe||(je==null||qe==null||!Fn(je)&&!Fn(qe)?je!=je&&qe!=qe:function(ki,fr,Er,mn,xr,Pr){var gn=As(ki),Cn=As(fr),Nr=gn?Me:Tr(ki),zn=Cn?Me:Tr(fr),Gn=(Nr=Nr==Pe?_i:Nr)==_i,Wn=(zn=zn==Pe?_i:zn)==_i,Ir=Nr==zn;if(Ir&&Xs(ki)){if(!Xs(fr))return!1;gn=!0,Gn=!1}if(Ir&&!Gn)return Pr||(Pr=new Xi),gn||Un(ki)?Eo(ki,fr,Er,mn,xr,Pr):function(Vi,Ri,ps,Jn,$s,Yr,Zr){switch(ps){case lr:if(Vi.byteLength!=Ri.byteLength||Vi.byteOffset!=Ri.byteOffset)return!1;Vi=Vi.buffer,Ri=Ri.buffer;case kr:return!(Vi.byteLength!=Ri.byteLength||!Yr(new us(Vi),new us(Ri)));case Be:case bt:case Dt:return qo(+Vi,+Ri);case It:return Vi.name==Ri.name&&Vi.message==Ri.message;case fi:case yt:return Vi==Ri+"";case Nt:var ms=ma;case ji:var gs=1&Jn;if(ms||(ms=xo),Vi.size!=Ri.size&&!gs)return!1;var sr=Zr.get(Vi);if(sr)return sr==Ri;Jn|=2,Zr.set(Vi,Ri);var rn=Eo(ms(Vi),ms(Ri),Jn,$s,Yr,Zr);return Zr.delete(Vi),rn;case ii:if(To)return To.call(Vi)==To.call(Ri)}return!1}(ki,fr,Nr,Er,mn,xr,Pr);if(!(1&Er)){var Rn=Gn&&Dn.call(ki,"__wrapped__"),Ca=Wn&&Dn.call(fr,"__wrapped__");if(Rn||Ca){var Sa=Rn?ki.value():ki,Ml=Ca?fr.value():fr;return Pr||(Pr=new Xi),xr(Sa,Ml,Er,mn,Pr)}}return Ir?(Pr||(Pr=new Xi),function(Vi,Ri,ps,Jn,$s,Yr){var Zr=1&ps,ms=Hs(Vi),gs=ms.length,sr=Hs(Ri).length;if(gs!=sr&&!Zr)return!1;for(var rn=gs;rn--;){var zr=ms[rn];if(!(Zr?zr in Ri:Dn.call(Ri,zr)))return!1}var Io=Yr.get(Vi);if(Io&&Yr.get(Ri))return Io==Ri;var Ys=!0;Yr.set(Vi,Ri),Yr.set(Ri,Vi);for(var Zs=Zr;++rn<gs;){var Sn=Vi[zr=ms[rn]],Qn=Ri[zr];if(Jn)var Ao=Zr?Jn(Qn,Sn,zr,Ri,Vi,Yr):Jn(Sn,Qn,zr,Vi,Ri,Yr);if(!(Ao===void 0?Sn===Qn||$s(Sn,Qn,ps,Jn,Yr):Ao)){Ys=!1;break}Zs||(Zs=zr=="constructor")}if(Ys&&!Zs){var Ks=Vi.constructor,Js=Ri.constructor;Ks==Js||!("constructor"in Vi)||!("constructor"in Ri)||typeof Ks=="function"&&Ks instanceof Ks&&typeof Js=="function"&&Js instanceof Js||(Ys=!1)}return Yr.delete(Vi),Yr.delete(Ri),Ys}(ki,fr,Er,mn,xr,Pr)):!1}(je,qe,Ft,ci,Za,Yi))}function Ka(je){return!(!$o(je)||function(qe){return!!Vo&&Vo in qe}(je))&&(qs(je)?$a:pa).test(fs(je))}function Xo(je){if(Ft=(qe=je)&&qe.constructor,ci=typeof Ft=="function"&&Ft.prototype||jo,qe!==ci)return Al(je);var qe,Ft,ci,Yi=[];for(var ki in Object(je))Dn.call(je,ki)&&ki!="constructor"&&Yi.push(ki);return Yi}function Eo(je,qe,Ft,ci,Yi,ki){var fr=1&Ft,Er=je.length,mn=qe.length;if(Er!=mn&&!(fr&&mn>Er))return!1;var xr=ki.get(je);if(xr&&ki.get(qe))return xr==qe;var Pr=-1,gn=!0,Cn=2&Ft?new ds:void 0;for(ki.set(je,qe),ki.set(qe,je);++Pr<Er;){var Nr=je[Pr],zn=qe[Pr];if(ci)var Gn=fr?ci(zn,Nr,Pr,qe,je,ki):ci(Nr,zn,Pr,je,qe,ki);if(Gn!==void 0){if(Gn)continue;gn=!1;break}if(Cn){if(!Ni(qe,function(Wn,Ir){if(Rn=Ir,!Cn.has(Rn)&&(Nr===Wn||Yi(Nr,Wn,Ft,ci,ki)))return Cn.push(Ir);var Rn})){gn=!1;break}}else if(Nr!==zn&&!Yi(Nr,zn,Ft,ci,ki)){gn=!1;break}}return ki.delete(je),ki.delete(qe),gn}function Hs(je){return function(qe,Ft,ci){var Yi=Ft(qe);return As(qe)?Yi:function(ki,fr){for(var Er=-1,mn=fr.length,xr=ki.length;++Er<mn;)ki[xr+Er]=fr[Er];return ki}(Yi,ci(qe))}(je,Qa,Ps)}function Es(je,qe){var Ft,ci,Yi=je.__data__;return((ci=typeof(Ft=qe))=="string"||ci=="number"||ci=="symbol"||ci=="boolean"?Ft!=="__proto__":Ft===null)?Yi[typeof qe=="string"?"string":"hash"]:Yi.map}function pn(je,qe){var Ft=function(ci,Yi){return ci==null?void 0:ci[Yi]}(je,qe);return Ka(Ft)?Ft:void 0}Ji.prototype.clear=function(){this.__data__=Us?Us(null):{},this.size=0},Ji.prototype.delete=function(je){var qe=this.has(je)&&delete this.__data__[je];return this.size-=qe?1:0,qe},Ji.prototype.get=function(je){var qe=this.__data__;if(Us){var Ft=qe[je];return Ft===Z?void 0:Ft}return Dn.call(qe,je)?qe[je]:void 0},Ji.prototype.has=function(je){var qe=this.__data__;return Us?qe[je]!==void 0:Dn.call(qe,je)},Ji.prototype.set=function(je,qe){var Ft=this.__data__;return this.size+=this.has(je)?0:1,Ft[je]=Us&&qe===void 0?Z:qe,this},Ln.prototype.clear=function(){this.__data__=[],this.size=0},Ln.prototype.delete=function(je){var qe=this.__data__,Ft=Ts(qe,je);return!(Ft<0)&&(Ft==qe.length-1?qe.pop():Il.call(qe,Ft,1),--this.size,!0)},Ln.prototype.get=function(je){var qe=this.__data__,Ft=Ts(qe,je);return Ft<0?void 0:qe[Ft][1]},Ln.prototype.has=function(je){return Ts(this.__data__,je)>-1},Ln.prototype.set=function(je,qe){var Ft=this.__data__,ci=Ts(Ft,je);return ci<0?(++this.size,Ft.push([je,qe])):Ft[ci][1]=qe,this},Si.prototype.clear=function(){this.size=0,this.__data__={hash:new Ji,map:new(So||Ln),string:new Ji}},Si.prototype.delete=function(je){var qe=Es(this,je).delete(je);return this.size-=qe?1:0,qe},Si.prototype.get=function(je){return Es(this,je).get(je)},Si.prototype.has=function(je){return Es(this,je).has(je)},Si.prototype.set=function(je,qe){var Ft=Es(this,je),ci=Ft.size;return Ft.set(je,qe),this.size+=Ft.size==ci?0:1,this},ds.prototype.add=ds.prototype.push=function(je){return this.__data__.set(je,Z),this},ds.prototype.has=function(je){return this.__data__.has(je)},Xi.prototype.clear=function(){this.__data__=new Ln,this.size=0},Xi.prototype.delete=function(je){var qe=this.__data__,Ft=qe.delete(je);return this.size=qe.size,Ft},Xi.prototype.get=function(je){return this.__data__.get(je)},Xi.prototype.has=function(je){return this.__data__.has(je)},Xi.prototype.set=function(je,qe){var Ft=this.__data__;if(Ft instanceof Ln){var ci=Ft.__data__;if(!So||ci.length<199)return ci.push([je,qe]),this.size=++Ft.size,this;Ft=this.__data__=new Si(ci)}return Ft.set(je,qe),this.size=Ft.size,this};var Ps=va?function(je){return je==null?[]:(je=Object(je),function(qe,Ft){for(var ci=-1,Yi=qe==null?0:qe.length,ki=0,fr=[];++ci<Yi;){var Er=qe[ci];Ft(Er,ci,qe)&&(fr[ki++]=Er)}return fr}(va(je),function(qe){return ya.call(je,qe)}))}:function(){return[]},Tr=Ws;function Ja(je,qe){return!!(qe=qe??_e)&&(typeof je=="number"||Wa.test(je))&&je>-1&&je%1==0&&je<qe}function fs(je){if(je!=null){try{return qa.call(je)}catch{}try{return je+""}catch{}}return""}function qo(je,qe){return je===qe||je!=je&&qe!=qe}(Vs&&Tr(new Vs(new ArrayBuffer(1)))!=lr||So&&Tr(new So)!=Nt||xa&&Tr(xa.resolve())!=rr||Uo&&Tr(new Uo)!=ji||Go&&Tr(new Go)!=Hi)&&(Tr=function(je){var qe=Ws(je),Ft=qe==_i?je.constructor:void 0,ci=Ft?fs(Ft):"";if(ci)switch(ci){case ba:return lr;case Ya:return Nt;case Gs:return rr;case Kn:return ji;case wa:return Hi}return qe});var Is=Ho(function(){return arguments}())?Ho:function(je){return Fn(je)&&Dn.call(je,"callee")&&!ya.call(je,"callee")},As=Array.isArray,Xs=Co||function(){return!1};function qs(je){if(!$o(je))return!1;var qe=Ws(je);return qe==Vt||qe=="[object GeneratorFunction]"||qe=="[object AsyncFunction]"||qe=="[object Proxy]"}function Po(je){return typeof je=="number"&&je>-1&&je%1==0&&je<=_e}function $o(je){var qe=typeof je;return je!=null&&(qe=="object"||qe=="function")}function Fn(je){return je!=null&&typeof je=="object"}var Un=tn?function(je){return function(qe){return je(qe)}}(tn):function(je){return Fn(je)&&Po(je.length)&&!!nr[Ws(je)]};function Qa(je){return(qe=je)!=null&&Po(qe.length)&&!qs(qe)?cr(je):Xo(je);var qe}P.exports=function(je,qe){return Za(je,qe)}})(zs,zs.exports);var On=fe(zs.exports);function zo(P,z){return P.length===z.length&&JSON.stringify(P.map(function(Z){return Z}).sort())===JSON.stringify(z.map(function(Z){return Z}).sort())}var Rs={Polygon:Ae,LineString:te,Point:ge,MultiPolygon:Xe,MultiLineString:Xe,MultiPoint:Xe},Bi=Object.freeze({__proto__:null,CommonSelectors:pi,constrainFeatureMovement:po,createMidPoint:$i,createSupplementaryPoints:Ki,createVertex:Oi,doubleClickZoom:le,euclideanDistance:ot,featuresAt:nt,getFeatureAtAndSetCursors:Ot,isClick:wt,isEventAtCoordinates:go,isTap:ee,mapEventToBoundingBox:Je,ModeHandler:se,moveFeatures:mo,sortFeatures:Ke,stringSetsAreEqual:zo,StringSet:tt,theme:St,toDenseArray:Oe}),Ro=function(P,z){var Z={options:P=function(Pe){Pe===void 0&&(Pe={});var Me=Lt(Pe);return Pe.controls||(Me.controls={}),Pe.displayControlsDefault===!1?Me.controls=Lt(Cs,Pe.controls):Me.controls=Lt(vr,Pe.controls),(Me=Lt(ws,Me)).styles=wn(Me.styles,"cold").concat(wn(Me.styles,"hot")),Me}(P)};z=function(Pe,Me){return Me.modes=d,Me.getFeatureIdsAt=function(Be){return nt.click({point:Be},null,Pe).map(function(bt){return bt.properties.id})},Me.getSelectedIds=function(){return Pe.store.getSelectedIds()},Me.getSelected=function(){return{type:g.FEATURE_COLLECTION,features:Pe.store.getSelectedIds().map(function(Be){return Pe.store.get(Be)}).map(function(Be){return Be.toGeoJSON()})}},Me.getSelectedPoints=function(){return{type:g.FEATURE_COLLECTION,features:Pe.store.getSelectedCoordinates().map(function(Be){return{type:g.FEATURE,properties:{},geometry:{type:g.POINT,coordinates:Be.coordinates}}})}},Me.set=function(Be){if(Be.type===void 0||Be.type!==g.FEATURE_COLLECTION||!Array.isArray(Be.features))throw new Error("Invalid FeatureCollection");var bt=Pe.store.createRenderBatch(),It=Pe.store.getAllIds().slice(),Vt=Me.add(Be),Nt=new tt(Vt);return(It=It.filter(function(Dt){return!Nt.has(Dt)})).length&&Me.delete(It),bt(),Vt},Me.add=function(Be){var bt=JSON.parse(JSON.stringify(de(Be))).features.map(function(It){if(It.id=It.id||ye(),It.geometry===null)throw new Error("Invalid geometry: null");if(Pe.store.get(It.id)===void 0||Pe.store.get(It.id).type!==It.geometry.type){var Vt=Rs[It.geometry.type];if(Vt===void 0)throw new Error("Invalid geometry type: "+It.geometry.type+".");var Nt=new Vt(Pe,It);Pe.store.add(Nt)}else{var Dt=Pe.store.get(It.id);Dt.properties=It.properties,On(Dt.properties,It.properties)||Pe.store.featureChanged(Dt.id),On(Dt.getCoordinates(),It.geometry.coordinates)||Dt.incomingCoords(It.geometry.coordinates)}return It.id});return Pe.store.render(),bt},Me.get=function(Be){var bt=Pe.store.get(Be);if(bt)return bt.toGeoJSON()},Me.getAll=function(){return{type:g.FEATURE_COLLECTION,features:Pe.store.getAll().map(function(Be){return Be.toGeoJSON()})}},Me.delete=function(Be){return Pe.store.delete(Be,{silent:!0}),Me.getMode()!==d.DIRECT_SELECT||Pe.store.getSelectedIds().length?Pe.store.render():Pe.events.changeMode(d.SIMPLE_SELECT,void 0,{silent:!0}),Me},Me.deleteAll=function(){return Pe.store.delete(Pe.store.getAllIds(),{silent:!0}),Me.getMode()===d.DIRECT_SELECT?Pe.events.changeMode(d.SIMPLE_SELECT,void 0,{silent:!0}):Pe.store.render(),Me},Me.changeMode=function(Be,bt){return bt===void 0&&(bt={}),Be===d.SIMPLE_SELECT&&Me.getMode()===d.SIMPLE_SELECT?(zo(bt.featureIds||[],Pe.store.getSelectedIds())||(Pe.store.setSelected(bt.featureIds,{silent:!0}),Pe.store.render()),Me):(Be===d.DIRECT_SELECT&&Me.getMode()===d.DIRECT_SELECT&&bt.featureId===Pe.store.getSelectedIds()[0]||Pe.events.changeMode(Be,bt,{silent:!0}),Me)},Me.getMode=function(){return Pe.events.getMode()},Me.trash=function(){return Pe.events.trash({silent:!0}),Me},Me.combineFeatures=function(){return Pe.events.combineFeatures({silent:!0}),Me},Me.uncombineFeatures=function(){return Pe.events.uncombineFeatures({silent:!0}),Me},Me.setFeatureProperty=function(Be,bt,It){return Pe.store.setFeatureProperty(Be,bt,It),Me},Me}(Z,z),Z.api=z;var _e=lt(Z);return z.onAdd=_e.onAdd,z.onRemove=_e.onRemove,z.types=m,z.options=P,z};function Yn(P){Ro(P,this)}return Yn.modes=Fs,Yn.constants=ne,Yn.lib=Bi,Yn})})(df);var Pm=df.exports;const Kh=lf(Pm),hc="rgb(127, 127, 127)",Im=[{id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","true"]],paint:{"fill-color":["case",["==",["get","user_color_rgb_str"],null],hc,["get","user_color_rgb_str"]],"fill-outline-color":"rgb(0, 0, 0)","fill-opacity":.5}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","$type","Polygon"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(178, 204, 255)","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-halo-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-polygon-and-line-vertex-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"]],paint:{"circle-radius":3,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","$type","LineString"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-width":3}},{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","false"]],paint:{"fill-color":["case",["==",["get","user_color_rgb_str"],null],hc,["get","user_color_rgb_str"]],"fill-outline-color":"rgb(0, 0, 0)","fill-opacity":.25}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","$type","Polygon"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-width":3}}];function Am(Y,T){return Y.lngLat?Y.lngLat.lng===T[0]&&Y.lngLat.lat===T[1]:!1}const tu=Kh.modes.draw_polygon;tu.maxVertices=4;tu.clickAnywhere=function(Y,T){if(Y.currentVertexPosition>0&&Am(T,Y.polygon.coordinates[0][Y.currentVertexPosition-1]))return this.changeMode("simple_select",{featureIds:[Y.polygon.id]});if(this.updateUIClasses({mouse:"add"}),Y.polygon.updateCoordinate(`0.${Y.currentVertexPosition}`,T.lngLat.lng,T.lngLat.lat),Y.currentVertexPosition++,Y.polygon.updateCoordinate(`0.${Y.currentVertexPosition}`,T.lngLat.lng,T.lngLat.lat),Y.currentVertexPosition>this.maxVertices-1)return this.updateUIClasses({mouse:"none"}),this.changeMode("simple_select",{featuresId:Y.polygon.id})};var Mm={exports:{}};(function(Y){(function(T){T.version="0.5.0",T.defaults={doThrows:{invalidGeometry:!1}};function se(){var g=1<=arguments.length?[].slice.call(arguments,0):[],d=g.shift(),w=g.shift();Error.apply(this,g),this.message=this.message||"Invalid Geometry: item: "+JSON.stringify(d)+", params: "+JSON.stringify(w)}se.prototype=Error,T.errors={InvalidGeometryError:se},T.isGeometryValid=function(g){return!g||!Object.keys(g).length?!1:!!g.type&&!!g.coordinates&&Array.isArray(g.coordinates)&&!!g.coordinates.length},T.parse=function(g,d,w){var E,O=Ie(d,this.defaults),L;if(he.length=0,p(O),L=h(O),Array.isArray(g)?(E={type:"FeatureCollection",features:[]},g.forEach(function(V){E.features.push(b({item:V,params:O,propFunc:L}))}),N(E,O)):(E=b({item:g,params:O,propFunc:L}),N(E,O)),w&&typeof w=="function")w(E);else return E};var fe=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","GeoJSON"],he=[];function Ie(g,d){var w=g||{};for(var E in d)d.hasOwnProperty(E)&&!w[E]&&(w[E]=d[E]);return w}function N(g,d){if(d.crs&&s(d.crs)&&(d.isPostgres?g.geometry.crs=d.crs:g.crs=d.crs),d.bbox&&(g.bbox=d.bbox),d.extraGlobal){g.properties={};for(var w in d.extraGlobal)g.properties[w]=d.extraGlobal[w]}}function s(g){if(g.type==="name"){if(g.properties&&g.properties.name)return!0;throw new Error('Invalid CRS. Properties must contain "name" key')}else if(g.type==="link"){if(g.properties&&g.properties.href&&g.properties.type)return!0;throw new Error('Invalid CRS. Properties must contain "href" and "type" key')}else throw new Error('Invald CRS. Type attribute must be "name" or "link"')}function p(g){g.geom={};for(var d in g)g.hasOwnProperty(d)&&fe.indexOf(d)!==-1&&(g.geom[d]=g[d],delete g[d]);C(g.geom)}function C(g){for(var d in g)g.hasOwnProperty(d)&&(typeof g[d]=="string"?he.push(g[d]):typeof g[d]=="object"&&(he.push(g[d][0]),he.push(g[d][1])));if(he.length===0)throw new Error("No geometry attributes specified")}function b(g){var d=g.item,w=g.params,E=g.propFunc,O={type:"Feature"};return O.geometry=c(d,w),O.properties=E.call(d),O}function l(g){return/^.+\..+$/.test(g)}function c(g,d){var w={};for(var E in d.geom){var O=d.geom[E];if(typeof O=="string"&&g.hasOwnProperty(O))E==="GeoJSON"?w=g[O]:(w.type=E,w.coordinates=g[O]);else if(typeof O=="object"&&!Array.isArray(O)){var L=Object.keys(O).map(function(Ke){var Je=O[Ke],tt=g[Ke];return c(tt,{geom:{Point:Je}})});w.type=E,w.coordinates=[].concat(L.map(function(Ke){return Ke.coordinates}))}else if(Array.isArray(O)&&g.hasOwnProperty(O[0])&&g.hasOwnProperty(O[1]))w.type=E,w.coordinates=[Number(g[O[1]]),Number(g[O[0]])];else if(Array.isArray(O)&&l(O[0])&&l(O[1])){for(var V=[],$=0;$<O.length;$++){for(var ne=O[$].split("."),xe=g,ze=0;ze<ne.length;ze++){if(!xe.hasOwnProperty(ne[ze]))return!1;xe=xe[ne[ze]]}V[$]=xe}w.type=E,w.coordinates=[Number(V[1]),Number(V[0])]}}if(d.doThrows&&d.doThrows.invalidGeometry&&!T.isGeometryValid(w))throw new se(g,d);return w}function h(g){var d;return!g.exclude&&!g.include?d=function(w){for(var E in this)this.hasOwnProperty(E)&&he.indexOf(E)===-1&&(w[E]=this[E])}:g.include?d=function(w){g.include.forEach(function(E){w[E]=this[E]},this)}:g.exclude&&(d=function(w){for(var E in this)this.hasOwnProperty(E)&&he.indexOf(E)===-1&&g.exclude.indexOf(E)===-1&&(w[E]=this[E])}),function(){var w={};return d.call(this,w),g.extra&&m(w,g.extra),w}}function m(g,d){for(var w in d)d.hasOwnProperty(w)&&(g[w]=d[w]);return g}})(Y.exports)})(Mm);const ff={name:"delete_zone",onSetup:function(){return{}},onClick:function(Y,T){var se;if(T.featureTarget){const fe=T.featureTarget,he=(se=fe==null?void 0:fe.properties)==null?void 0:se.id;if(!he)return;this.deleteFeature(he),this.changeMode("simple_select")}},toDisplayFeatures:function(Y,T,se){se(T)}},Jh=Vn(),iu=Vn(new Kh({userProperties:!0,displayControlsDefault:!1,controls:{polygon:!1,trash:!1},modes:Object.assign({draw_restricted_polygon:tu,delete_zone:ff},Kh.modes),styles:Im}));var Gi=(Y=>(Y[Y.AddingZoneCanvas=1]="AddingZoneCanvas",Y[Y.AddingZoneMap=2]="AddingZoneMap",Y[Y.Waiting=3]="Waiting",Y[Y.EditingZone=4]="EditingZone",Y[Y.DeletingZoneCanvas=5]="DeletingZoneCanvas",Y[Y.DeletingZoneMap=6]="DeletingZoneMap",Y[Y.PickPolygon=7]="PickPolygon",Y))(Gi||{}),Qc=(Y=>(Y.Init="init",Y.ReInit="re-init",Y))(Qc||{});const eh=Vn(),Xr=Vn(Gi.Waiting),wl=Vn(!1),bl=Vn(!1),km="http",Om="localhost",Dm=42001,Lm=window.location.href,ru=new URL(Lm),nu=ru.protocol.replace(/:/g,"")||km,pf=ru.hostname||Om,mf=parseInt(ru.port)||(nu==="https:"?443:80)||Dm;class Fm{constructor(T=Vn(nu),se=Vn(pf),fe=Vn(mf)){this.schema=T,this.host=se,this.port=fe}get apiURL(){return Tm([this.schema,this.host,this.port],([T,se,fe])=>`${T}://${se}:${fe}`)}}const th=new Fm,su=Vn(`${nu}://${pf}:${mf}`);class zm{constructor(T=Vn("https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL"),se=Vn("https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL")){this.uri=T,this.accepted_uri=se}}const ih=new zm;Vn(ih.accepted_uri);const uo=Vn(new Map);function Rm(Y){uo.update(T=>{const se=new Map(T),fe={type:Y.type,id:Y.id,properties:{road_lane_direction:Y.properties.road_lane_direction,road_lane_num:Y.properties.road_lane_num,coordinates:Y.properties.coordinates,color_rgb:Y.properties.color_rgb,virtual_line:Y.properties.virtual_line,ds_id:Y.id,spatial_object_id:`spatial-${Y.id}`,color_rgb_str:`rgb(${Y.properties.color_rgb[0]},${Y.properties.color_rgb[1]},${Y.properties.color_rgb[2]})`},geometry:{type:Y.geometry.type,coordinates:Y.geometry.coordinates}};return se.set(Y.id,fe),se})}function Ga(Y,T){uo.update(se=>{const fe=new Map(se);return fe.set(Y,T),fe})}function Bm(Y){uo.update(T=>{const se=new Map(T);return se.delete(Y),se})}function jm(){uo.update(Y=>{const T=new Map(Y);return T.clear(),T})}const Nm=(Y,T,se)=>{const fe=Y.get(se);if(!fe)return;if(!fe.properties.spatial_object_id){console.error(`ID '${fe.id}' should have 'spatial_object_id' in properties, but it has not`);return}const he=T.get(fe.properties.spatial_object_id);he&&(T.add(he),T.setFeatureProperty(he.id,"color_rgb_str",hc))},gf=(Y,T)=>{const se=Y.get(T);se&&(se.properties.spatial_object_id=void 0,se.properties.road_lane_direction=-1,se.properties.road_lane_num=-1,se.geometry.coordinates=[[],[],[],[],[]],Ga(T,se))};function Vm(Y){let T,se,fe;return{c(){T=At("div"),se=At("div"),this.h()},l(he){T=Mt(he,"DIV",{class:!0});var Ie=ri(T);se=Mt(Ie,"DIV",{class:!0,id:!0}),ri(se).forEach(Rt),Ie.forEach(Rt),this.h()},h(){dt(se,"class","map"),dt(se,"id","map"),dt(T,"class",fe="map-wrap "+Y[0])},m(he,Ie){fn(he,T,Ie),rt(T,se),Y[5](se)},p(he,[Ie]){Ie&1&&fe!==(fe="map-wrap "+he[0])&&dt(T,"class",fe)},i:cs,o:cs,d(he){he&&Rt(T),Y[5](null)}}}function Um(Y){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(Y)}`}function Gm(Y,T,se){let fe,he,Ie,N;jr(Y,iu,w=>se(7,fe=w)),jr(Y,uo,w=>se(8,he=w)),jr(Y,Jh,w=>se(9,Ie=w));let{klass:s=""}=T,p;const{accepted_uri:C}=ih;jr(Y,C,w=>se(10,N=w));let b=N;const l=w=>`<svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="${w}"><path d="M480.276-96Q401-96 331-126q-70-30-122.5-82.5T126-330.958q-30-69.959-30-149.5Q96-560 126-629.5t82.5-122Q261-804 330.958-834q69.959-30 149.5-30Q560-864 629.5-834t122 82.5Q804-699 834-629.276q30 69.725 30 149Q864-401 834-331q-30 70-82.5 122.5T629.276-126q-69.725 30-149 30ZM480-168q130 0 221-91t91-221q0-130-91-221t-221-91q-130 0-221 91t-91 221q0 130 91 221t221 91Zm0 0q-130 0-221-91t-91-221q0-130 91-221t221-91q130 0 221 91t91 221q0 130-91 221t-221 91Z"/></svg>`,c=C.subscribe(w=>{b!==w&&(Ie.setStyle(w),b=N)});uc(()=>{console.log("Mounted map component");const w={lng:0,lat:0,zoom:5};Jh.set(new uf.Map({container:p,style:b,center:[w.lng,w.lat],zoom:w.zoom})),Ie.on("load",()=>{Ie.resize()}),Ie.on("click","gl-draw-polygon-fill-inactive.cold",function(E){var ze,Ke,Je,tt;const O=fe.get((ze=E.features)==null?void 0:ze[0].properties.id);if(!O)return;const L=Array.from(he.values()).map((ht,nt)=>{const _t=ht.properties.color_rgb_str;return`<option value="${ht.id}" data-icon="${Um(l(_t))}">${ht.id}</option>`}),V=(Ke=[...he].find(ht=>ht[1].properties.spatial_object_id===O.id))==null?void 0:Ke[1],$=`
                <div id="custom-popup">
                    <div class="row">
                        <div class="input-field col s12">
                            <select id="select-canvas">
                                <option value="" disabled selected>Pick up polygon</option>
                                ${L.join(`
`)}
                            </select>
                            <label>Attach canvas polygons</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input value="${V?(Je=V.properties)==null?void 0:Je.road_lane_direction:-1}" id="lane-direction" type="number" class="validate">
                            <label class="active" for="lane-direction">Direction value</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input value="${V?(tt=V.properties)==null?void 0:tt.road_lane_num:-1}" id="lane-number" type="number" class="validate">
                            <label class="active" for="lane-number">Lane</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12">
                            <button id="attach-canvas-btn" class="btn-small waves-effect waves-light" type="submit" name="action" onclick>Save
                                <i class="material-icons right">save</i>
                            </button>
                        </div>
                    </div>
                </div>
            `;new Yd.Popup({className:"custom-popup"}).setLngLat(E.lngLat).setHTML($).addTo(Ie);const ne=document.getElementById("select-canvas");if(!ne)return;Array.from(he.values()).some(ht=>{if(ht.properties.spatial_object_id===O.id)return ne.value=ht.id??"No canvas ID",!0}),M.FormSelect.init(ne,{});const xe=document.getElementById("attach-canvas-btn");if(!xe){console.error("No container 'attach-canvas-btn'");return}xe.addEventListener("click",ht=>{const nt=document.getElementById("lane-direction"),_t=document.getElementById("lane-number");g(O,ne.value,{road_lane_direction:nt?parseInt(nt.value):-1,road_lane_num:_t?parseInt(_t.value):-1})})})}),Qh(()=>{c(),Ie.remove()});function h(w){Ie.addControl(w)}const m=(w,E)=>{if(E.forEach(V=>{const $={...V,properties:{color_rgb_str:V.properties.color_rgb_str},id:V.properties.spatial_object_id};w.add($)}),E.size===0)return;const O=Array.from(E.values())[0].geometry.coordinates;let L=new Yd.LngLatBounds(O[0]);for(const V of O)L.extend(V);Ie.fitBounds(L,{maxZoom:18,padding:100})},g=(w,E,O={road_lane_direction:-1,road_lane_num:-1})=>{var ze;if(E===""||E===null||E===void 0||!w.properties||!w.id)return;const L=he.get(E);if(!L){console.error(`ID '${E}' not found in datastorage`);return}const V=w.id,$=L.properties.spatial_object_id;if($){const Ke=fe.get($);Ke&&(fe.add(Ke),fe.setFeatureProperty($,"color_rgb_str",hc))}const ne=(ze=[...he].find(Ke=>Ke[1].id!==E&&Ke[1].properties.spatial_object_id===V))==null?void 0:ze[1];ne&&gf(he,ne.id),L.properties.spatial_object_id=V,L.properties.road_lane_direction=O.road_lane_direction,L.properties.road_lane_num=O.road_lane_num;const xe=w.geometry;L.geometry.coordinates=xe.coordinates,Ga(E,L),fe.add(w),fe.setFeatureProperty(V,"color_rgb_str",L.properties.color_rgb_str)};function d(w){of[w?"unshift":"push"](()=>{p=w,se(1,p)})}return Y.$$set=w=>{"klass"in w&&se(0,s=w.klass)},[s,p,C,h,m,d]}class Wm extends ua{constructor(T){super(),da(this,T,Gm,Vm,ha,{klass:0,attachDraw:3,drawGeoPolygons:4})}get attachDraw(){return this.$$.ctx[3]}get drawGeoPolygons(){return this.$$.ctx[4]}}function Hm(Y){let T,se,fe,he,Ie=".",N,s,p=".",C,b,l=".";return{c(){T=At("div"),se=xn(Y[0]),fe=Ai(),he=At("span"),he.textContent=Ie,N=Ai(),s=At("span"),s.textContent=p,C=Ai(),b=At("span"),b.textContent=l,this.h()},l(c){T=Mt(c,"DIV",{class:!0});var h=ri(T);se=bn(h,Y[0]),fe=Mi(h),he=Mt(h,"SPAN",{class:!0,"data-svelte-h":!0}),wr(he)!=="svelte-980x4v"&&(he.textContent=Ie),N=Mi(h),s=Mt(h,"SPAN",{class:!0,"data-svelte-h":!0}),wr(s)!=="svelte-1xw9n6t"&&(s.textContent=p),C=Mi(h),b=Mt(h,"SPAN",{class:!0,"data-svelte-h":!0}),wr(b)!=="svelte-17zz11c"&&(b.textContent=l),h.forEach(Rt),this.h()},h(){dt(he,"class","first-dot svelte-4rj70q"),dt(s,"class","second-dot svelte-4rj70q"),dt(b,"class","third-dot svelte-4rj70q"),dt(T,"class","three-dot-loader")},m(c,h){fn(c,T,h),rt(T,se),rt(T,fe),rt(T,he),rt(T,N),rt(T,s),rt(T,C),rt(T,b)},p(c,[h]){h&1&&Ds(se,c[0])},i:cs,o:cs,d(c){c&&Rt(T)}}}function Xm(Y,T,se){let{msgText:fe="Loading"}=T;return Y.$$set=he=>{"msgText"in he&&se(0,fe=he.msgText)},[fe]}class qm extends ua{constructor(T){super(),da(this,T,Xm,Hm,ha,{msgText:0})}}var wi={};const $m={},Ym=Object.freeze(Object.defineProperty({__proto__:null,default:$m},Symbol.toStringTag,{value:"Module"})),Zh=Sm(Ym);(function(Y){/*! Fabric.js Copyright 2008-2015, Printio (Juriy Zaytsev, Maxim Chernyak) */var T=T||{version:"5.3.0"};if(Y.fabric=T,typeof document<"u"&&typeof window<"u")document instanceof(typeof HTMLDocument<"u"?HTMLDocument:Document)?T.document=document:T.document=document.implementation.createHTMLDocument(""),T.window=window;else{var se=Zh,fe=new se.JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;T.document=fe.document,T.jsdomImplForWrapper=Zh.implForWrapper,T.nodeCanvas=Zh.Canvas,T.window=fe,DOMParser=T.window.DOMParser}T.isTouchSupported="ontouchstart"in T.window||"ontouchstart"in T.document||T.window&&T.window.navigator&&T.window.navigator.maxTouchPoints>0,T.isLikelyNode=typeof Buffer<"u"&&typeof window>"u",T.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],T.DPI=96,T.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",T.commaWsp="(?:\\s+,?\\s*|,\\s*)",T.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/ig,T.reNonWord=/[ \n\.,;!\?\-]/,T.fontPaths={},T.iMatrix=[1,0,0,1,0,0],T.svgNS="http://www.w3.org/2000/svg",T.perfLimitSizeTotal=2097152,T.maxCacheSideLimit=4096,T.minCacheSideLimit=256,T.charWidthsCache={},T.textureSize=2048,T.disableStyleCopyPaste=!1,T.enableGLFiltering=!0,T.devicePixelRatio=T.window.devicePixelRatio||T.window.webkitDevicePixelRatio||T.window.mozDevicePixelRatio||1,T.browserShadowBlurConstant=1,T.arcToSegmentsCache={},T.boundsOfCurveCache={},T.cachesBoundsOfCurve=!0,T.forceGLPutImageData=!1,T.initFilterBackend=function(){if(T.enableGLFiltering&&T.isWebglSupported&&T.isWebglSupported(T.textureSize))return console.log("max texture size: "+T.maxTextureSize),new T.WebglFilterBackend({tileSize:T.textureSize});if(T.Canvas2dFilterBackend)return new T.Canvas2dFilterBackend},typeof document<"u"&&typeof window<"u"&&(window.fabric=T),function(){function s(h,m){if(this.__eventListeners[h]){var g=this.__eventListeners[h];m?g[g.indexOf(m)]=!1:T.util.array.fill(g,!1)}}function p(h,m){if(this.__eventListeners||(this.__eventListeners={}),arguments.length===1)for(var g in h)this.on(g,h[g]);else this.__eventListeners[h]||(this.__eventListeners[h]=[]),this.__eventListeners[h].push(m);return this}function C(h,m){var g=(function(){m.apply(this,arguments),this.off(h,g)}).bind(this);this.on(h,g)}function b(h,m){if(arguments.length===1)for(var g in h)C.call(this,g,h[g]);else C.call(this,h,m);return this}function l(h,m){if(!this.__eventListeners)return this;if(arguments.length===0)for(h in this.__eventListeners)s.call(this,h);else if(arguments.length===1&&typeof arguments[0]=="object")for(var g in h)s.call(this,g,h[g]);else s.call(this,h,m);return this}function c(h,m){if(!this.__eventListeners)return this;var g=this.__eventListeners[h];if(!g)return this;for(var d=0,w=g.length;d<w;d++)g[d]&&g[d].call(this,m||{});return this.__eventListeners[h]=g.filter(function(E){return E!==!1}),this}T.Observable={fire:c,on:p,once:b,off:l}}(),T.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var s=0,p=arguments.length;s<p;s++)this._onObjectAdded(arguments[s]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(s,p,C){var b=this._objects;return C?b[p]=s:b.splice(p,0,s),this._onObjectAdded&&this._onObjectAdded(s),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var s=this._objects,p,C=!1,b=0,l=arguments.length;b<l;b++)p=s.indexOf(arguments[b]),p!==-1&&(C=!0,s.splice(p,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[b]));return this.renderOnAddRemove&&C&&this.requestRenderAll(),this},forEachObject:function(s,p){for(var C=this.getObjects(),b=0,l=C.length;b<l;b++)s.call(p,C[b],b,C);return this},getObjects:function(s){return typeof s>"u"?this._objects.concat():this._objects.filter(function(p){return p.type===s})},item:function(s){return this._objects[s]},isEmpty:function(){return this._objects.length===0},size:function(){return this._objects.length},contains:function(s,p){return this._objects.indexOf(s)>-1?!0:p?this._objects.some(function(C){return typeof C.contains=="function"&&C.contains(s,!0)}):!1},complexity:function(){return this._objects.reduce(function(s,p){return s+=p.complexity?p.complexity():0,s},0)}},T.CommonMethods={_setOptions:function(s){for(var p in s)this.set(p,s[p])},_initGradient:function(s,p){s&&s.colorStops&&!(s instanceof T.Gradient)&&this.set(p,new T.Gradient(s))},_initPattern:function(s,p,C){s&&s.source&&!(s instanceof T.Pattern)?this.set(p,new T.Pattern(s,C)):C&&C()},_setObject:function(s){for(var p in s)this._set(p,s[p])},set:function(s,p){return typeof s=="object"?this._setObject(s):this._set(s,p),this},_set:function(s,p){this[s]=p},toggle:function(s){var p=this.get(s);return typeof p=="boolean"&&this.set(s,!p),this},get:function(s){return this[s]}},function(s){var p=Math.sqrt,C=Math.atan2,b=Math.pow,l=Math.PI/180,c=Math.PI/2;T.util={cos:function(h){if(h===0)return 1;h<0&&(h=-h);var m=h/c;switch(m){case 1:case 3:return 0;case 2:return-1}return Math.cos(h)},sin:function(h){if(h===0)return 0;var m=h/c,g=1;switch(h<0&&(g=-1),m){case 1:return g;case 2:return 0;case 3:return-g}return Math.sin(h)},removeFromArray:function(h,m){var g=h.indexOf(m);return g!==-1&&h.splice(g,1),h},getRandomInt:function(h,m){return Math.floor(Math.random()*(m-h+1))+h},degreesToRadians:function(h){return h*l},radiansToDegrees:function(h){return h/l},rotatePoint:function(h,m,g){var d=new T.Point(h.x-m.x,h.y-m.y),w=T.util.rotateVector(d,g);return new T.Point(w.x,w.y).addEquals(m)},rotateVector:function(h,m){var g=T.util.sin(m),d=T.util.cos(m),w=h.x*d-h.y*g,E=h.x*g+h.y*d;return{x:w,y:E}},createVector:function(h,m){return new T.Point(m.x-h.x,m.y-h.y)},calcAngleBetweenVectors:function(h,m){return Math.acos((h.x*m.x+h.y*m.y)/(Math.hypot(h.x,h.y)*Math.hypot(m.x,m.y)))},getHatVector:function(h){return new T.Point(h.x,h.y).multiply(1/Math.hypot(h.x,h.y))},getBisector:function(h,m,g){var d=T.util.createVector(h,m),w=T.util.createVector(h,g),E=T.util.calcAngleBetweenVectors(d,w),O=T.util.calcAngleBetweenVectors(T.util.rotateVector(d,E),w),L=E*(O===0?1:-1)/2;return{vector:T.util.getHatVector(T.util.rotateVector(d,L)),angle:E}},projectStrokeOnPoints:function(h,m,g){var d=[],w=m.strokeWidth/2,E=m.strokeUniform?new T.Point(1/m.scaleX,1/m.scaleY):new T.Point(1,1),O=function(L){var V=w/Math.hypot(L.x,L.y);return new T.Point(L.x*V*E.x,L.y*V*E.y)};return h.length<=1||h.forEach(function(L,V){var $=new T.Point(L.x,L.y),ne,xe;V===0?(xe=h[V+1],ne=g?O(T.util.createVector(xe,$)).addEquals($):h[h.length-1]):V===h.length-1?(ne=h[V-1],xe=g?O(T.util.createVector(ne,$)).addEquals($):h[0]):(ne=h[V-1],xe=h[V+1]);var ze=T.util.getBisector($,ne,xe),Ke=ze.vector,Je=ze.angle,tt,ht;if(m.strokeLineJoin==="miter"&&(tt=-w/Math.sin(Je/2),ht=new T.Point(Ke.x*tt*E.x,Ke.y*tt*E.y),Math.hypot(ht.x,ht.y)/w<=m.strokeMiterLimit)){d.push($.add(ht)),d.push($.subtract(ht));return}tt=-w*Math.SQRT2,ht=new T.Point(Ke.x*tt*E.x,Ke.y*tt*E.y),d.push($.add(ht)),d.push($.subtract(ht))}),d},transformPoint:function(h,m,g){return g?new T.Point(m[0]*h.x+m[2]*h.y,m[1]*h.x+m[3]*h.y):new T.Point(m[0]*h.x+m[2]*h.y+m[4],m[1]*h.x+m[3]*h.y+m[5])},makeBoundingBoxFromPoints:function(h,m){if(m)for(var g=0;g<h.length;g++)h[g]=T.util.transformPoint(h[g],m);var d=[h[0].x,h[1].x,h[2].x,h[3].x],w=T.util.array.min(d),E=T.util.array.max(d),O=E-w,L=[h[0].y,h[1].y,h[2].y,h[3].y],V=T.util.array.min(L),$=T.util.array.max(L),ne=$-V;return{left:w,top:V,width:O,height:ne}},invertTransform:function(h){var m=1/(h[0]*h[3]-h[1]*h[2]),g=[m*h[3],-m*h[1],-m*h[2],m*h[0]],d=T.util.transformPoint({x:h[4],y:h[5]},g,!0);return g[4]=-d.x,g[5]=-d.y,g},toFixed:function(h,m){return parseFloat(Number(h).toFixed(m))},parseUnit:function(h,m){var g=/\D{0,2}$/.exec(h),d=parseFloat(h);switch(m||(m=T.Text.DEFAULT_SVG_FONT_SIZE),g[0]){case"mm":return d*T.DPI/25.4;case"cm":return d*T.DPI/2.54;case"in":return d*T.DPI;case"pt":return d*T.DPI/72;case"pc":return d*T.DPI/72*12;case"em":return d*m;default:return d}},falseFunction:function(){return!1},getKlass:function(h,m){return h=T.util.string.camelize(h.charAt(0).toUpperCase()+h.slice(1)),T.util.resolveNamespace(m)[h]},getSvgAttributes:function(h){var m=["instantiated_by_use","style","id","class"];switch(h){case"linearGradient":m=m.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":m=m.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":m=m.concat(["offset","stop-color","stop-opacity"]);break}return m},resolveNamespace:function(h){if(!h)return T;var m=h.split("."),g=m.length,d,w=s||T.window;for(d=0;d<g;++d)w=w[m[d]];return w},loadImage:function(h,m,g,d){if(!h){m&&m.call(g,h);return}var w=T.util.createImage(),E=function(){m&&m.call(g,w,!1),w=w.onload=w.onerror=null};w.onload=E,w.onerror=function(){T.log("Error loading "+w.src),m&&m.call(g,null,!0),w=w.onload=w.onerror=null},h.indexOf("data")!==0&&d!==void 0&&d!==null&&(w.crossOrigin=d),h.substring(0,14)==="data:image/svg"&&(w.onload=null,T.util.loadImageInDom(w,E)),w.src=h},loadImageInDom:function(h,m){var g=T.document.createElement("div");g.style.width=g.style.height="1px",g.style.left=g.style.top="-100%",g.style.position="absolute",g.appendChild(h),T.document.querySelector("body").appendChild(g),h.onload=function(){m(),g.parentNode.removeChild(g),g=null}},enlivenObjects:function(h,m,g,d){h=h||[];var w=[],E=0,O=h.length;function L(){++E===O&&m&&m(w.filter(function(V){return V}))}if(!O){m&&m(w);return}h.forEach(function(V,$){if(!V||!V.type){L();return}var ne=T.util.getKlass(V.type,g);ne.fromObject(V,function(xe,ze){ze||(w[$]=xe),d&&d(V,xe,ze),L()})})},enlivenObjectEnlivables:function(h,m,g){var d=T.Object.ENLIVEN_PROPS.filter(function(w){return!!h[w]});T.util.enlivenObjects(d.map(function(w){return h[w]}),function(w){var E={};d.forEach(function(O,L){E[O]=w[L],m&&(m[O]=w[L])}),g&&g(E)})},enlivenPatterns:function(h,m){h=h||[];function g(){++w===E&&m&&m(d)}var d=[],w=0,E=h.length;if(!E){m&&m(d);return}h.forEach(function(O,L){O&&O.source?new T.Pattern(O,function(V){d[L]=V,g()}):(d[L]=O,g())})},groupSVGElements:function(h,m,g){var d;return h&&h.length===1?(typeof g<"u"&&(h[0].sourcePath=g),h[0]):(m&&(m.width&&m.height?m.centerPoint={x:m.width/2,y:m.height/2}:(delete m.width,delete m.height)),d=new T.Group(h,m),typeof g<"u"&&(d.sourcePath=g),d)},populateWithProperties:function(h,m,g){if(g&&Array.isArray(g))for(var d=0,w=g.length;d<w;d++)g[d]in h&&(m[g[d]]=h[g[d]])},createCanvasElement:function(){return T.document.createElement("canvas")},copyCanvasElement:function(h){var m=T.util.createCanvasElement();return m.width=h.width,m.height=h.height,m.getContext("2d").drawImage(h,0,0),m},toDataURL:function(h,m,g){return h.toDataURL("image/"+m,g)},createImage:function(){return T.document.createElement("img")},multiplyTransformMatrices:function(h,m,g){return[h[0]*m[0]+h[2]*m[1],h[1]*m[0]+h[3]*m[1],h[0]*m[2]+h[2]*m[3],h[1]*m[2]+h[3]*m[3],g?0:h[0]*m[4]+h[2]*m[5]+h[4],g?0:h[1]*m[4]+h[3]*m[5]+h[5]]},qrDecompose:function(h){var m=C(h[1],h[0]),g=b(h[0],2)+b(h[1],2),d=p(g),w=(h[0]*h[3]-h[2]*h[1])/d,E=C(h[0]*h[2]+h[1]*h[3],g);return{angle:m/l,scaleX:d,scaleY:w,skewX:E/l,skewY:0,translateX:h[4],translateY:h[5]}},calcRotateMatrix:function(h){if(!h.angle)return T.iMatrix.concat();var m=T.util.degreesToRadians(h.angle),g=T.util.cos(m),d=T.util.sin(m);return[g,d,-d,g,0,0]},calcDimensionsMatrix:function(h){var m=typeof h.scaleX>"u"?1:h.scaleX,g=typeof h.scaleY>"u"?1:h.scaleY,d=[h.flipX?-m:m,0,0,h.flipY?-g:g,0,0],w=T.util.multiplyTransformMatrices,E=T.util.degreesToRadians;return h.skewX&&(d=w(d,[1,0,Math.tan(E(h.skewX)),1],!0)),h.skewY&&(d=w(d,[1,Math.tan(E(h.skewY)),0,1],!0)),d},composeMatrix:function(h){var m=[1,0,0,1,h.translateX||0,h.translateY||0],g=T.util.multiplyTransformMatrices;return h.angle&&(m=g(m,T.util.calcRotateMatrix(h))),(h.scaleX!==1||h.scaleY!==1||h.skewX||h.skewY||h.flipX||h.flipY)&&(m=g(m,T.util.calcDimensionsMatrix(h))),m},resetObjectTransform:function(h){h.scaleX=1,h.scaleY=1,h.skewX=0,h.skewY=0,h.flipX=!1,h.flipY=!1,h.rotate(0)},saveObjectTransform:function(h){return{scaleX:h.scaleX,scaleY:h.scaleY,skewX:h.skewX,skewY:h.skewY,angle:h.angle,left:h.left,flipX:h.flipX,flipY:h.flipY,top:h.top}},isTransparent:function(h,m,g,d){d>0&&(m>d?m-=d:m=0,g>d?g-=d:g=0);var w=!0,E,O,L=h.getImageData(m,g,d*2||1,d*2||1),V=L.data.length;for(E=3;E<V&&(O=L.data[E],w=O<=0,w!==!1);E+=4);return L=null,w},parsePreserveAspectRatioAttribute:function(h){var m="meet",g="Mid",d="Mid",w=h.split(" "),E;return w&&w.length&&(m=w.pop(),m!=="meet"&&m!=="slice"?(E=m,m="meet"):w.length&&(E=w.pop())),g=E!=="none"?E.slice(1,4):"none",d=E!=="none"?E.slice(5,8):"none",{meetOrSlice:m,alignX:g,alignY:d}},clearFabricFontCache:function(h){h=(h||"").toLowerCase(),h?T.charWidthsCache[h]&&delete T.charWidthsCache[h]:T.charWidthsCache={}},limitDimsByArea:function(h,m){var g=Math.sqrt(m*h),d=Math.floor(m/g);return{x:Math.floor(g),y:d}},capValue:function(h,m,g){return Math.max(h,Math.min(m,g))},findScaleToFit:function(h,m){return Math.min(m.width/h.width,m.height/h.height)},findScaleToCover:function(h,m){return Math.max(m.width/h.width,m.height/h.height)},matrixToSVG:function(h){return"matrix("+h.map(function(m){return T.util.toFixed(m,T.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(h,m){var g=T.util.invertTransform(m),d=T.util.multiplyTransformMatrices(g,h.calcOwnMatrix());T.util.applyTransformToObject(h,d)},addTransformToObject:function(h,m){T.util.applyTransformToObject(h,T.util.multiplyTransformMatrices(m,h.calcOwnMatrix()))},applyTransformToObject:function(h,m){var g=T.util.qrDecompose(m),d=new T.Point(g.translateX,g.translateY);h.flipX=!1,h.flipY=!1,h.set("scaleX",g.scaleX),h.set("scaleY",g.scaleY),h.skewX=g.skewX,h.skewY=g.skewY,h.angle=g.angle,h.setPositionByOrigin(d,"center","center")},sizeAfterTransform:function(h,m,g){var d=h/2,w=m/2,E=[{x:-d,y:-w},{x:d,y:-w},{x:-d,y:w},{x:d,y:w}],O=T.util.calcDimensionsMatrix(g),L=T.util.makeBoundingBoxFromPoints(E,O);return{x:L.width,y:L.height}},mergeClipPaths:function(h,m){var g=h,d=m;g.inverted&&!d.inverted&&(g=m,d=h),T.util.applyTransformToObject(d,T.util.multiplyTransformMatrices(T.util.invertTransform(g.calcTransformMatrix()),d.calcTransformMatrix()));var w=g.inverted&&d.inverted;return w&&(g.inverted=d.inverted=!1),new T.Group([g],{clipPath:d,inverted:w})},hasStyleChanged:function(h,m,g){return g=g||!1,h.fill!==m.fill||h.stroke!==m.stroke||h.strokeWidth!==m.strokeWidth||h.fontSize!==m.fontSize||h.fontFamily!==m.fontFamily||h.fontWeight!==m.fontWeight||h.fontStyle!==m.fontStyle||h.textBackgroundColor!==m.textBackgroundColor||h.deltaY!==m.deltaY||g&&(h.overline!==m.overline||h.underline!==m.underline||h.linethrough!==m.linethrough)},stylesToArray:function(g,m){for(var g=T.util.object.clone(g,!0),d=m.split(`
`),w=-1,E={},O=[],L=0;L<d.length;L++){if(!g[L]){w+=d[L].length;continue}for(var V=0;V<d[L].length;V++){w++;var $=g[L][V];if($&&Object.keys($).length>0){var ne=T.util.hasStyleChanged(E,$,!0);ne?O.push({start:w,end:w+1,style:$}):O[O.length-1].end++}E=$||{}}}return O},stylesFromArray:function(h,m){if(!Array.isArray(h))return h;for(var g=m.split(`
`),d=-1,w=0,E={},O=0;O<g.length;O++)for(var L=0;L<g[O].length;L++)d++,h[w]&&h[w].start<=d&&d<h[w].end&&(E[O]=E[O]||{},E[O][L]=Object.assign({},h[w].style),d===h[w].end-1&&w++);return E}}}(Y),function(){var s=Array.prototype.join,p={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},C={m:"l",M:"L"};function b(ee,be,me,ye,Ve,ge,te,Ae,Ue,it,Xe){var He=T.util.cos(ee),vt=T.util.sin(ee),Et=T.util.cos(be),$e=T.util.sin(be),Oe=me*Ve*Et-ye*ge*$e+te,at=ye*Ve*Et+me*ge*$e+Ae,ae=it+Ue*(-me*Ve*vt-ye*ge*He),Ze=Xe+Ue*(-ye*Ve*vt+me*ge*He),pt=Oe+Ue*(me*Ve*$e+ye*ge*Et),ft=at+Ue*(ye*Ve*$e-me*ge*Et);return["C",ae,Ze,pt,ft,Oe,at]}function l(ee,be,me,ye,Ve,ge,te){var Ae=Math.PI,Ue=te*Ae/180,it=T.util.sin(Ue),Xe=T.util.cos(Ue),He=0,vt=0;me=Math.abs(me),ye=Math.abs(ye);var Et=-Xe*ee*.5-it*be*.5,$e=-Xe*be*.5+it*ee*.5,Oe=me*me,at=ye*ye,ae=$e*$e,Ze=Et*Et,pt=Oe*at-Oe*ae-at*Ze,ft=0;if(pt<0){var Lt=Math.sqrt(1-pt/(Oe*at));me*=Lt,ye*=Lt}else ft=(Ve===ge?-1:1)*Math.sqrt(pt/(Oe*ae+at*Ze));var $t=ft*me*$e/ye,lt=-ft*ye*Et/me,St=Xe*$t-it*lt+ee*.5,Xt=it*$t+Xe*lt+be*.5,di=c(1,0,(Et-$t)/me,($e-lt)/ye),vi=c((Et-$t)/me,($e-lt)/ye,(-Et-$t)/me,(-$e-lt)/ye);ge===0&&vi>0?vi-=2*Ae:ge===1&&vi<0&&(vi+=2*Ae);for(var Ci=Math.ceil(Math.abs(vi/Ae*2)),ct=[],Ei=vi/Ci,Fi=8/3*Math.sin(Ei/4)*Math.sin(Ei/4)/Math.sin(Ei/2),yr=di+Ei,Zi=0;Zi<Ci;Zi++)ct[Zi]=b(di,yr,Xe,it,me,ye,St,Xt,Fi,He,vt),He=ct[Zi][5],vt=ct[Zi][6],di=yr,yr+=Ei;return ct}function c(ee,be,me,ye){var Ve=Math.atan2(be,ee),ge=Math.atan2(ye,me);return ge>=Ve?ge-Ve:2*Math.PI-(Ve-ge)}function h(ee,be,me,ye,Ve,ge,te,Ae){var Ue;if(T.cachesBoundsOfCurve&&(Ue=s.call(arguments),T.boundsOfCurveCache[Ue]))return T.boundsOfCurveCache[Ue];var it=Math.sqrt,Xe=Math.min,He=Math.max,vt=Math.abs,Et=[],$e=[[],[]],Oe,at,ae,Ze,pt,ft,Lt,$t;at=6*ee-12*me+6*Ve,Oe=-3*ee+9*me-9*Ve+3*te,ae=3*me-3*ee;for(var lt=0;lt<2;++lt){if(lt>0&&(at=6*be-12*ye+6*ge,Oe=-3*be+9*ye-9*ge+3*Ae,ae=3*ye-3*be),vt(Oe)<1e-12){if(vt(at)<1e-12)continue;Ze=-ae/at,0<Ze&&Ze<1&&Et.push(Ze);continue}Lt=at*at-4*ae*Oe,!(Lt<0)&&($t=it(Lt),pt=(-at+$t)/(2*Oe),0<pt&&pt<1&&Et.push(pt),ft=(-at-$t)/(2*Oe),0<ft&&ft<1&&Et.push(ft))}for(var St,Xt,di=Et.length,vi=di,Ci;di--;)Ze=Et[di],Ci=1-Ze,St=Ci*Ci*Ci*ee+3*Ci*Ci*Ze*me+3*Ci*Ze*Ze*Ve+Ze*Ze*Ze*te,$e[0][di]=St,Xt=Ci*Ci*Ci*be+3*Ci*Ci*Ze*ye+3*Ci*Ze*Ze*ge+Ze*Ze*Ze*Ae,$e[1][di]=Xt;$e[0][vi]=ee,$e[1][vi]=be,$e[0][vi+1]=te,$e[1][vi+1]=Ae;var ct=[{x:Xe.apply(null,$e[0]),y:Xe.apply(null,$e[1])},{x:He.apply(null,$e[0]),y:He.apply(null,$e[1])}];return T.cachesBoundsOfCurve&&(T.boundsOfCurveCache[Ue]=ct),ct}function m(ee,be,me){for(var ye=me[1],Ve=me[2],ge=me[3],te=me[4],Ae=me[5],Ue=me[6],it=me[7],Xe=l(Ue-ee,it-be,ye,Ve,te,Ae,ge),He=0,vt=Xe.length;He<vt;He++)Xe[He][1]+=ee,Xe[He][2]+=be,Xe[He][3]+=ee,Xe[He][4]+=be,Xe[He][5]+=ee,Xe[He][6]+=be;return Xe}function g(ee){var be=0,me=0,ye=ee.length,Ve=0,ge=0,te,Ae,Ue,it=[],Xe,He,vt;for(Ae=0;Ae<ye;++Ae){switch(Ue=!1,te=ee[Ae].slice(0),te[0]){case"l":te[0]="L",te[1]+=be,te[2]+=me;case"L":be=te[1],me=te[2];break;case"h":te[1]+=be;case"H":te[0]="L",te[2]=me,be=te[1];break;case"v":te[1]+=me;case"V":te[0]="L",me=te[1],te[1]=be,te[2]=me;break;case"m":te[0]="M",te[1]+=be,te[2]+=me;case"M":be=te[1],me=te[2],Ve=te[1],ge=te[2];break;case"c":te[0]="C",te[1]+=be,te[2]+=me,te[3]+=be,te[4]+=me,te[5]+=be,te[6]+=me;case"C":He=te[3],vt=te[4],be=te[5],me=te[6];break;case"s":te[0]="S",te[1]+=be,te[2]+=me,te[3]+=be,te[4]+=me;case"S":Xe==="C"?(He=2*be-He,vt=2*me-vt):(He=be,vt=me),be=te[3],me=te[4],te[0]="C",te[5]=te[3],te[6]=te[4],te[3]=te[1],te[4]=te[2],te[1]=He,te[2]=vt,He=te[3],vt=te[4];break;case"q":te[0]="Q",te[1]+=be,te[2]+=me,te[3]+=be,te[4]+=me;case"Q":He=te[1],vt=te[2],be=te[3],me=te[4];break;case"t":te[0]="T",te[1]+=be,te[2]+=me;case"T":Xe==="Q"?(He=2*be-He,vt=2*me-vt):(He=be,vt=me),te[0]="Q",be=te[1],me=te[2],te[1]=He,te[2]=vt,te[3]=be,te[4]=me;break;case"a":te[0]="A",te[6]+=be,te[7]+=me;case"A":Ue=!0,it=it.concat(m(be,me,te)),be=te[6],me=te[7];break;case"z":case"Z":be=Ve,me=ge;break}Ue||it.push(te),Xe=te[0]}return it}function d(ee,be,me,ye){return Math.sqrt((me-ee)*(me-ee)+(ye-be)*(ye-be))}function w(ee){return ee*ee*ee}function E(ee){return 3*ee*ee*(1-ee)}function O(ee){return 3*ee*(1-ee)*(1-ee)}function L(ee){return(1-ee)*(1-ee)*(1-ee)}function V(ee,be,me,ye,Ve,ge,te,Ae){return function(Ue){var it=w(Ue),Xe=E(Ue),He=O(Ue),vt=L(Ue);return{x:te*it+Ve*Xe+me*He+ee*vt,y:Ae*it+ge*Xe+ye*He+be*vt}}}function $(ee,be,me,ye,Ve,ge,te,Ae){return function(Ue){var it=1-Ue,Xe=3*it*it*(me-ee)+6*it*Ue*(Ve-me)+3*Ue*Ue*(te-Ve),He=3*it*it*(ye-be)+6*it*Ue*(ge-ye)+3*Ue*Ue*(Ae-ge);return Math.atan2(He,Xe)}}function ne(ee){return ee*ee}function xe(ee){return 2*ee*(1-ee)}function ze(ee){return(1-ee)*(1-ee)}function Ke(ee,be,me,ye,Ve,ge){return function(te){var Ae=ne(te),Ue=xe(te),it=ze(te);return{x:Ve*Ae+me*Ue+ee*it,y:ge*Ae+ye*Ue+be*it}}}function Je(ee,be,me,ye,Ve,ge){return function(te){var Ae=1-te,Ue=2*Ae*(me-ee)+2*te*(Ve-me),it=2*Ae*(ye-be)+2*te*(ge-ye);return Math.atan2(it,Ue)}}function tt(ee,be,me){var ye={x:be,y:me},Ve,ge=0,te;for(te=1;te<=100;te+=1)Ve=ee(te/100),ge+=d(ye.x,ye.y,Ve.x,Ve.y),ye=Ve;return ge}function ht(ee,be){for(var me=0,ye=0,Ve=ee.iterator,ge={x:ee.x,y:ee.y},te,Ae,Ue=.01,it=ee.angleFinder,Xe;ye<be&&Ue>1e-4;)te=Ve(me),Xe=me,Ae=d(ge.x,ge.y,te.x,te.y),Ae+ye>be?(me-=Ue,Ue/=2):(ge=te,me+=Ue,ye+=Ae);return te.angle=it(Xe),te}function nt(ee){for(var be=0,me=ee.length,ye,Ve=0,ge=0,te=0,Ae=0,Ue=[],it,Xe,He,vt=0;vt<me;vt++){switch(ye=ee[vt],Xe={x:Ve,y:ge,command:ye[0]},ye[0]){case"M":Xe.length=0,te=Ve=ye[1],Ae=ge=ye[2];break;case"L":Xe.length=d(Ve,ge,ye[1],ye[2]),Ve=ye[1],ge=ye[2];break;case"C":it=V(Ve,ge,ye[1],ye[2],ye[3],ye[4],ye[5],ye[6]),He=$(Ve,ge,ye[1],ye[2],ye[3],ye[4],ye[5],ye[6]),Xe.iterator=it,Xe.angleFinder=He,Xe.length=tt(it,Ve,ge),Ve=ye[5],ge=ye[6];break;case"Q":it=Ke(Ve,ge,ye[1],ye[2],ye[3],ye[4]),He=Je(Ve,ge,ye[1],ye[2],ye[3],ye[4]),Xe.iterator=it,Xe.angleFinder=He,Xe.length=tt(it,Ve,ge),Ve=ye[3],ge=ye[4];break;case"Z":case"z":Xe.destX=te,Xe.destY=Ae,Xe.length=d(Ve,ge,te,Ae),Ve=te,ge=Ae;break}be+=Xe.length,Ue.push(Xe)}return Ue.push({length:be,x:Ve,y:ge}),Ue}function _t(ee,be,me){me||(me=nt(ee));for(var ye=0;be-me[ye].length>0&&ye<me.length-2;)be-=me[ye].length,ye++;var Ve=me[ye],ge=be/Ve.length,te=Ve.command,Ae=ee[ye],Ue;switch(te){case"M":return{x:Ve.x,y:Ve.y,angle:0};case"Z":case"z":return Ue=new T.Point(Ve.x,Ve.y).lerp(new T.Point(Ve.destX,Ve.destY),ge),Ue.angle=Math.atan2(Ve.destY-Ve.y,Ve.destX-Ve.x),Ue;case"L":return Ue=new T.Point(Ve.x,Ve.y).lerp(new T.Point(Ae[1],Ae[2]),ge),Ue.angle=Math.atan2(Ae[2]-Ve.y,Ae[1]-Ve.x),Ue;case"C":return ht(Ve,be);case"Q":return ht(Ve,be)}}function Ot(ee){var be=[],me=[],ye,Ve,ge=T.rePathCommand,te="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",Ae="("+te+")"+T.commaWsp,Ue="([01])"+T.commaWsp+"?",it=Ae+"?"+Ae+"?"+Ae+Ue+Ue+Ae+"?("+te+")",Xe=new RegExp(it,"g"),He,vt,Et;if(!ee||!ee.match)return be;Et=ee.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi);for(var $e=0,Oe,at=Et.length;$e<at;$e++){ye=Et[$e],vt=ye.slice(1).trim(),me.length=0;var ae=ye.charAt(0);if(Oe=[ae],ae.toLowerCase()==="a")for(var Ze;Ze=Xe.exec(vt);)for(var pt=1;pt<Ze.length;pt++)me.push(Ze[pt]);else for(;He=ge.exec(vt);)me.push(He[0]);for(var pt=0,ft=me.length;pt<ft;pt++)Ve=parseFloat(me[pt]),isNaN(Ve)||Oe.push(Ve);var Lt=p[ae.toLowerCase()],$t=C[ae]||ae;if(Oe.length-1>Lt)for(var lt=1,St=Oe.length;lt<St;lt+=Lt)be.push([ae].concat(Oe.slice(lt,lt+Lt))),ae=$t;else be.push(Oe)}return be}function ot(ee,be){var me=[],ye,Ve=new T.Point(ee[0].x,ee[0].y),ge=new T.Point(ee[1].x,ee[1].y),te=ee.length,Ae=1,Ue=0,it=te>2;for(be=be||0,it&&(Ae=ee[2].x<ge.x?-1:ee[2].x===ge.x?0:1,Ue=ee[2].y<ge.y?-1:ee[2].y===ge.y?0:1),me.push(["M",Ve.x-Ae*be,Ve.y-Ue*be]),ye=1;ye<te;ye++){if(!Ve.eq(ge)){var Xe=Ve.midPointFrom(ge);me.push(["Q",Ve.x,Ve.y,Xe.x,Xe.y])}Ve=ee[ye],ye+1<ee.length&&(ge=ee[ye+1])}return it&&(Ae=Ve.x>ee[ye-2].x?1:Ve.x===ee[ye-2].x?0:-1,Ue=Ve.y>ee[ye-2].y?1:Ve.y===ee[ye-2].y?0:-1),me.push(["L",Ve.x+Ae*be,Ve.y+Ue*be]),me}function wt(ee,be,me){return me&&(be=T.util.multiplyTransformMatrices(be,[1,0,0,1,-me.x,-me.y])),ee.map(function(ye){for(var Ve=ye.slice(0),ge={},te=1;te<ye.length-1;te+=2)ge.x=ye[te],ge.y=ye[te+1],ge=T.util.transformPoint(ge,be),Ve[te]=ge.x,Ve[te+1]=ge.y;return Ve})}T.util.joinPath=function(ee){return ee.map(function(be){return be.join(" ")}).join(" ")},T.util.parsePath=Ot,T.util.makePathSimpler=g,T.util.getSmoothPathFromPoints=ot,T.util.getPathSegmentsInfo=nt,T.util.getBoundsOfCurve=h,T.util.getPointOnPath=_t,T.util.transformPath=wt}(),function(){var s=Array.prototype.slice;function p(h,m){for(var g=s.call(arguments,2),d=[],w=0,E=h.length;w<E;w++)d[w]=g.length?h[w][m].apply(h[w],g):h[w][m].call(h[w]);return d}function C(h,m){return c(h,m,function(g,d){return g>=d})}function b(h,m){return c(h,m,function(g,d){return g<d})}function l(h,m){for(var g=h.length;g--;)h[g]=m;return h}function c(h,m,g){if(!(!h||h.length===0)){var d=h.length-1,w=m?h[d][m]:h[d];if(m)for(;d--;)g(h[d][m],w)&&(w=h[d][m]);else for(;d--;)g(h[d],w)&&(w=h[d]);return w}}T.util.array={fill:l,invoke:p,min:b,max:C}}(),function(){function s(C,b,l){if(l)if(!T.isLikelyNode&&b instanceof Element)C=b;else if(b instanceof Array){C=[];for(var c=0,h=b.length;c<h;c++)C[c]=s({},b[c],l)}else if(b&&typeof b=="object")for(var m in b)m==="canvas"||m==="group"?C[m]=null:b.hasOwnProperty(m)&&(C[m]=s({},b[m],l));else C=b;else for(var m in b)C[m]=b[m];return C}function p(C,b){return s({},C,b)}T.util.object={extend:s,clone:p},T.util.object.extend(T.util,T.Observable)}(),function(){function s(c){return c.replace(/-+(.)?/g,function(h,m){return m?m.toUpperCase():""})}function p(c,h){return c.charAt(0).toUpperCase()+(h?c.slice(1):c.slice(1).toLowerCase())}function C(c){return c.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function b(c){var h=0,m,g=[];for(h=0,m;h<c.length;h++)(m=l(c,h))!==!1&&g.push(m);return g}function l(c,h){var m=c.charCodeAt(h);if(isNaN(m))return"";if(m<55296||m>57343)return c.charAt(h);if(55296<=m&&m<=56319){if(c.length<=h+1)throw"High surrogate without following low surrogate";var g=c.charCodeAt(h+1);if(56320>g||g>57343)throw"High surrogate without following low surrogate";return c.charAt(h)+c.charAt(h+1)}if(h===0)throw"Low surrogate without preceding high surrogate";var d=c.charCodeAt(h-1);if(55296>d||d>56319)throw"Low surrogate without preceding high surrogate";return!1}T.util.string={camelize:s,capitalize:p,escapeXml:C,graphemeSplit:b}}(),function(){var s=Array.prototype.slice,p=function(){},C=function(){for(var m in{toString:1})if(m==="toString")return!1;return!0}(),b=function(m,g,d){for(var w in g)w in m.prototype&&typeof m.prototype[w]=="function"&&(g[w]+"").indexOf("callSuper")>-1?m.prototype[w]=function(E){return function(){var O=this.constructor.superclass;this.constructor.superclass=d;var L=g[E].apply(this,arguments);if(this.constructor.superclass=O,E!=="initialize")return L}}(w):m.prototype[w]=g[w],C&&(g.toString!==Object.prototype.toString&&(m.prototype.toString=g.toString),g.valueOf!==Object.prototype.valueOf&&(m.prototype.valueOf=g.valueOf))};function l(){}function c(m){for(var g=null,d=this;d.constructor.superclass;){var w=d.constructor.superclass.prototype[m];if(d[m]!==w){g=w;break}d=d.constructor.superclass.prototype}return g?arguments.length>1?g.apply(this,s.call(arguments,1)):g.call(this):console.log("tried to callSuper "+m+", method not found in prototype chain",this)}function h(){var m=null,g=s.call(arguments,0);typeof g[0]=="function"&&(m=g.shift());function d(){this.initialize.apply(this,arguments)}d.superclass=m,d.subclasses=[],m&&(l.prototype=m.prototype,d.prototype=new l,m.subclasses.push(d));for(var w=0,E=g.length;w<E;w++)b(d,g[w],m);return d.prototype.initialize||(d.prototype.initialize=p),d.prototype.constructor=d,d.prototype.callSuper=c,d}T.util.createClass=h}(),function(){var s=!!T.document.createElement("div").attachEvent,p=["touchstart","touchmove","touchend"];T.util.addListener=function(b,l,c,h){b&&b.addEventListener(l,c,s?!1:h)},T.util.removeListener=function(b,l,c,h){b&&b.removeEventListener(l,c,s?!1:h)};function C(b){var l=b.changedTouches;return l&&l[0]?l[0]:b}T.util.getPointer=function(b){var l=b.target,c=T.util.getScrollLeftTop(l),h=C(b);return{x:h.clientX+c.left,y:h.clientY+c.top}},T.util.isTouchEvent=function(b){return p.indexOf(b.type)>-1||b.pointerType==="touch"}}(),function(){function s(h,m){var g=h.style;if(!g)return h;if(typeof m=="string")return h.style.cssText+=";"+m,m.indexOf("opacity")>-1?c(h,m.match(/opacity:\s*(\d?\.?\d*)/)[1]):h;for(var d in m)if(d==="opacity")c(h,m[d]);else{var w=d==="float"||d==="cssFloat"?typeof g.styleFloat>"u"?"cssFloat":"styleFloat":d;g.setProperty(w,m[d])}return h}var p=T.document.createElement("div"),C=typeof p.style.opacity=="string",b=typeof p.style.filter=="string",l=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,c=function(h){return h};C?c=function(h,m){return h.style.opacity=m,h}:b&&(c=function(h,m){var g=h.style;return h.currentStyle&&!h.currentStyle.hasLayout&&(g.zoom=1),l.test(g.filter)?(m=m>=.9999?"":"alpha(opacity="+m*100+")",g.filter=g.filter.replace(l,m)):g.filter+=" alpha(opacity="+m*100+")",h}),T.util.setStyle=s}(),function(){var s=Array.prototype.slice;function p(L){return typeof L=="string"?T.document.getElementById(L):L}var C,b=function(L){return s.call(L,0)};try{C=b(T.document.childNodes)instanceof Array}catch{}C||(b=function(L){for(var V=new Array(L.length),$=L.length;$--;)V[$]=L[$];return V});function l(L,V){var $=T.document.createElement(L);for(var ne in V)ne==="class"?$.className=V[ne]:ne==="for"?$.htmlFor=V[ne]:$.setAttribute(ne,V[ne]);return $}function c(L,V){L&&(" "+L.className+" ").indexOf(" "+V+" ")===-1&&(L.className+=(L.className?" ":"")+V)}function h(L,V,$){return typeof V=="string"&&(V=l(V,$)),L.parentNode&&L.parentNode.replaceChild(V,L),V.appendChild(L),V}function m(L){for(var V=0,$=0,ne=T.document.documentElement,xe=T.document.body||{scrollLeft:0,scrollTop:0};L&&(L.parentNode||L.host)&&(L=L.parentNode||L.host,L===T.document?(V=xe.scrollLeft||ne.scrollLeft||0,$=xe.scrollTop||ne.scrollTop||0):(V+=L.scrollLeft||0,$+=L.scrollTop||0),!(L.nodeType===1&&L.style.position==="fixed")););return{left:V,top:$}}function g(L){var V,$=L&&L.ownerDocument,ne={left:0,top:0},xe={left:0,top:0},ze,Ke={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!$)return xe;for(var Je in Ke)xe[Ke[Je]]+=parseInt(d(L,Je),10)||0;return V=$.documentElement,typeof L.getBoundingClientRect<"u"&&(ne=L.getBoundingClientRect()),ze=m(L),{left:ne.left+ze.left-(V.clientLeft||0)+xe.left,top:ne.top+ze.top-(V.clientTop||0)+xe.top}}var d;T.document.defaultView&&T.document.defaultView.getComputedStyle?d=function(L,V){var $=T.document.defaultView.getComputedStyle(L,null);return $?$[V]:void 0}:d=function(L,V){var $=L.style[V];return!$&&L.currentStyle&&($=L.currentStyle[V]),$},function(){var L=T.document.documentElement.style,V="userSelect"in L?"userSelect":"MozUserSelect"in L?"MozUserSelect":"WebkitUserSelect"in L?"WebkitUserSelect":"KhtmlUserSelect"in L?"KhtmlUserSelect":"";function $(xe){return typeof xe.onselectstart<"u"&&(xe.onselectstart=T.util.falseFunction),V?xe.style[V]="none":typeof xe.unselectable=="string"&&(xe.unselectable="on"),xe}function ne(xe){return typeof xe.onselectstart<"u"&&(xe.onselectstart=null),V?xe.style[V]="":typeof xe.unselectable=="string"&&(xe.unselectable=""),xe}T.util.makeElementUnselectable=$,T.util.makeElementSelectable=ne}();function w(L){var V=T.jsdomImplForWrapper(L);return V._canvas||V._image}function E(L){if(T.isLikelyNode){var V=T.jsdomImplForWrapper(L);V&&(V._image=null,V._canvas=null,V._currentSrc=null,V._attributes=null,V._classList=null)}}function O(L,V){L.imageSmoothingEnabled=L.imageSmoothingEnabled||L.webkitImageSmoothingEnabled||L.mozImageSmoothingEnabled||L.msImageSmoothingEnabled||L.oImageSmoothingEnabled,L.imageSmoothingEnabled=V}T.util.setImageSmoothing=O,T.util.getById=p,T.util.toArray=b,T.util.addClass=c,T.util.makeElement=l,T.util.wrapElement=h,T.util.getScrollLeftTop=m,T.util.getElementOffset=g,T.util.getNodeCanvas=w,T.util.cleanUpJsdomNode=E}(),function(){function s(b,l){return b+(/\?/.test(b)?"&":"?")+l}function p(){}function C(b,l){l||(l={});var c=l.method?l.method.toUpperCase():"GET",h=l.onComplete||function(){},m=new T.window.XMLHttpRequest,g=l.body||l.parameters;return m.onreadystatechange=function(){m.readyState===4&&(h(m),m.onreadystatechange=p)},c==="GET"&&(g=null,typeof l.parameters=="string"&&(b=s(b,l.parameters))),m.open(c,b,!0),(c==="POST"||c==="PUT")&&m.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),m.send(g),m}T.util.request=C}(),T.log=console.log,T.warn=console.warn,function(){var s=T.util.object.extend,p=T.util.object.clone,C=[];T.util.object.extend(C,{cancelAll:function(){var w=this.splice(0);return w.forEach(function(E){E.cancel()}),w},cancelByCanvas:function(w){if(!w)return[];var E=this.filter(function(O){return typeof O.target=="object"&&O.target.canvas===w});return E.forEach(function(O){O.cancel()}),E},cancelByTarget:function(w){var E=this.findAnimationsByTarget(w);return E.forEach(function(O){O.cancel()}),E},findAnimationIndex:function(w){return this.indexOf(this.findAnimation(w))},findAnimation:function(w){return this.find(function(E){return E.cancel===w})},findAnimationsByTarget:function(w){return w?this.filter(function(E){return E.target===w}):[]}});function b(){return!1}function l(w,E,O,L){return-O*Math.cos(w/L*(Math.PI/2))+O+E}function c(w){w||(w={});var E=!1,O,L=function(){var V=T.runningAnimations.indexOf(O);return V>-1&&T.runningAnimations.splice(V,1)[0]};return O=s(p(w),{cancel:function(){return E=!0,L()},currentValue:"startValue"in w?w.startValue:0,completionRate:0,durationRate:0}),T.runningAnimations.push(O),g(function(V){var $=V||+new Date,ne=w.duration||500,xe=$+ne,ze,Ke=w.onChange||b,Je=w.abort||b,tt=w.onComplete||b,ht=w.easing||l,nt="startValue"in w?w.startValue.length>0:!1,_t="startValue"in w?w.startValue:0,Ot="endValue"in w?w.endValue:100,ot=w.byValue||(nt?_t.map(function(wt,ee){return Ot[ee]-_t[ee]}):Ot-_t);w.onStart&&w.onStart(),function wt(ee){ze=ee||+new Date;var be=ze>xe?ne:ze-$,me=be/ne,ye=nt?_t.map(function(ge,te){return ht(be,_t[te],ot[te],ne)}):ht(be,_t,ot,ne),Ve=Math.abs(nt?(ye[0]-_t[0])/ot[0]:(ye-_t)/ot);if(O.currentValue=nt?ye.slice():ye,O.completionRate=Ve,O.durationRate=me,!E){if(Je(ye,Ve,me)){L();return}if(ze>xe){O.currentValue=nt?Ot.slice():Ot,O.completionRate=1,O.durationRate=1,Ke(nt?Ot.slice():Ot,1,1),tt(Ot,1,1),L();return}else Ke(ye,Ve,me),g(wt)}}($)}),O.cancel}var h=T.window.requestAnimationFrame||T.window.webkitRequestAnimationFrame||T.window.mozRequestAnimationFrame||T.window.oRequestAnimationFrame||T.window.msRequestAnimationFrame||function(w){return T.window.setTimeout(w,1e3/60)},m=T.window.cancelAnimationFrame||T.window.clearTimeout;function g(){return h.apply(T.window,arguments)}function d(){return m.apply(T.window,arguments)}T.util.animate=c,T.util.requestAnimFrame=g,T.util.cancelAnimFrame=d,T.runningAnimations=C}(),function(){function s(C,b,l){var c="rgba("+parseInt(C[0]+l*(b[0]-C[0]),10)+","+parseInt(C[1]+l*(b[1]-C[1]),10)+","+parseInt(C[2]+l*(b[2]-C[2]),10);return c+=","+(C&&b?parseFloat(C[3]+l*(b[3]-C[3])):1),c+=")",c}function p(C,b,l,c){var h=new T.Color(C).getSource(),m=new T.Color(b).getSource(),g=c.onComplete,d=c.onChange;return c=c||{},T.util.animate(T.util.object.extend(c,{duration:l||500,startValue:h,endValue:m,byValue:m,easing:function(w,E,O,L){var V=c.colorEasing?c.colorEasing(w,L):1-Math.cos(w/L*(Math.PI/2));return s(E,O,V)},onComplete:function(w,E,O){if(g)return g(s(m,m,0),E,O)},onChange:function(w,E,O){if(d){if(Array.isArray(w))return d(s(w,w,0),E,O);d(w,E,O)}}}))}T.util.animateColor=p}(),function(){function s(ee,be,me,ye){return ee<Math.abs(be)?(ee=be,ye=me/4):be===0&&ee===0?ye=me/(2*Math.PI)*Math.asin(1):ye=me/(2*Math.PI)*Math.asin(be/ee),{a:ee,c:be,p:me,s:ye}}function p(ee,be,me){return ee.a*Math.pow(2,10*(be-=1))*Math.sin((be*me-ee.s)*(2*Math.PI)/ee.p)}function C(ee,be,me,ye){return me*((ee=ee/ye-1)*ee*ee+1)+be}function b(ee,be,me,ye){return ee/=ye/2,ee<1?me/2*ee*ee*ee+be:me/2*((ee-=2)*ee*ee+2)+be}function l(ee,be,me,ye){return me*(ee/=ye)*ee*ee*ee+be}function c(ee,be,me,ye){return-me*((ee=ee/ye-1)*ee*ee*ee-1)+be}function h(ee,be,me,ye){return ee/=ye/2,ee<1?me/2*ee*ee*ee*ee+be:-me/2*((ee-=2)*ee*ee*ee-2)+be}function m(ee,be,me,ye){return me*(ee/=ye)*ee*ee*ee*ee+be}function g(ee,be,me,ye){return me*((ee=ee/ye-1)*ee*ee*ee*ee+1)+be}function d(ee,be,me,ye){return ee/=ye/2,ee<1?me/2*ee*ee*ee*ee*ee+be:me/2*((ee-=2)*ee*ee*ee*ee+2)+be}function w(ee,be,me,ye){return-me*Math.cos(ee/ye*(Math.PI/2))+me+be}function E(ee,be,me,ye){return me*Math.sin(ee/ye*(Math.PI/2))+be}function O(ee,be,me,ye){return-me/2*(Math.cos(Math.PI*ee/ye)-1)+be}function L(ee,be,me,ye){return ee===0?be:me*Math.pow(2,10*(ee/ye-1))+be}function V(ee,be,me,ye){return ee===ye?be+me:me*(-Math.pow(2,-10*ee/ye)+1)+be}function $(ee,be,me,ye){return ee===0?be:ee===ye?be+me:(ee/=ye/2,ee<1?me/2*Math.pow(2,10*(ee-1))+be:me/2*(-Math.pow(2,-10*--ee)+2)+be)}function ne(ee,be,me,ye){return-me*(Math.sqrt(1-(ee/=ye)*ee)-1)+be}function xe(ee,be,me,ye){return me*Math.sqrt(1-(ee=ee/ye-1)*ee)+be}function ze(ee,be,me,ye){return ee/=ye/2,ee<1?-me/2*(Math.sqrt(1-ee*ee)-1)+be:me/2*(Math.sqrt(1-(ee-=2)*ee)+1)+be}function Ke(ee,be,me,ye){var Ve=1.70158,ge=0,te=me;if(ee===0)return be;if(ee/=ye,ee===1)return be+me;ge||(ge=ye*.3);var Ae=s(te,me,ge,Ve);return-p(Ae,ee,ye)+be}function Je(ee,be,me,ye){var Ve=1.70158,ge=0,te=me;if(ee===0)return be;if(ee/=ye,ee===1)return be+me;ge||(ge=ye*.3);var Ae=s(te,me,ge,Ve);return Ae.a*Math.pow(2,-10*ee)*Math.sin((ee*ye-Ae.s)*(2*Math.PI)/Ae.p)+Ae.c+be}function tt(ee,be,me,ye){var Ve=1.70158,ge=0,te=me;if(ee===0)return be;if(ee/=ye/2,ee===2)return be+me;ge||(ge=ye*(.3*1.5));var Ae=s(te,me,ge,Ve);return ee<1?-.5*p(Ae,ee,ye)+be:Ae.a*Math.pow(2,-10*(ee-=1))*Math.sin((ee*ye-Ae.s)*(2*Math.PI)/Ae.p)*.5+Ae.c+be}function ht(ee,be,me,ye,Ve){return Ve===void 0&&(Ve=1.70158),me*(ee/=ye)*ee*((Ve+1)*ee-Ve)+be}function nt(ee,be,me,ye,Ve){return Ve===void 0&&(Ve=1.70158),me*((ee=ee/ye-1)*ee*((Ve+1)*ee+Ve)+1)+be}function _t(ee,be,me,ye,Ve){return Ve===void 0&&(Ve=1.70158),ee/=ye/2,ee<1?me/2*(ee*ee*(((Ve*=1.525)+1)*ee-Ve))+be:me/2*((ee-=2)*ee*(((Ve*=1.525)+1)*ee+Ve)+2)+be}function Ot(ee,be,me,ye){return me-ot(ye-ee,0,me,ye)+be}function ot(ee,be,me,ye){return(ee/=ye)<1/2.75?me*(7.5625*ee*ee)+be:ee<2/2.75?me*(7.5625*(ee-=1.5/2.75)*ee+.75)+be:ee<2.5/2.75?me*(7.5625*(ee-=2.25/2.75)*ee+.9375)+be:me*(7.5625*(ee-=2.625/2.75)*ee+.984375)+be}function wt(ee,be,me,ye){return ee<ye/2?Ot(ee*2,0,me,ye)*.5+be:ot(ee*2-ye,0,me,ye)*.5+me*.5+be}T.util.ease={easeInQuad:function(ee,be,me,ye){return me*(ee/=ye)*ee+be},easeOutQuad:function(ee,be,me,ye){return-me*(ee/=ye)*(ee-2)+be},easeInOutQuad:function(ee,be,me,ye){return ee/=ye/2,ee<1?me/2*ee*ee+be:-me/2*(--ee*(ee-2)-1)+be},easeInCubic:function(ee,be,me,ye){return me*(ee/=ye)*ee*ee+be},easeOutCubic:C,easeInOutCubic:b,easeInQuart:l,easeOutQuart:c,easeInOutQuart:h,easeInQuint:m,easeOutQuint:g,easeInOutQuint:d,easeInSine:w,easeOutSine:E,easeInOutSine:O,easeInExpo:L,easeOutExpo:V,easeInOutExpo:$,easeInCirc:ne,easeOutCirc:xe,easeInOutCirc:ze,easeInElastic:Ke,easeOutElastic:Je,easeInOutElastic:tt,easeInBack:ht,easeOutBack:nt,easeInOutBack:_t,easeInBounce:Ot,easeOutBounce:ot,easeInOutBounce:wt}}(),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.util.object.clone,l=p.util.toFixed,c=p.util.parseUnit,h=p.util.multiplyTransformMatrices,m=["path","circle","polygon","polyline","ellipse","rect","line","image","text"],g=["symbol","image","marker","pattern","view","svg"],d=["pattern","defs","symbol","metadata","clipPath","mask","desc"],w=["symbol","g","a","svg","clipPath","defs"],E={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},O={stroke:"strokeOpacity",fill:"fillOpacity"},L="font-size",V="clip-path";p.svgValidTagNamesRegEx=xe(m),p.svgViewBoxElementsRegEx=xe(g),p.svgInvalidAncestorsRegEx=xe(d),p.svgValidParentsRegEx=xe(w),p.cssRules={},p.gradientDefs={},p.clipPaths={};function $(ge){return ge in E?E[ge]:ge}function ne(ge,te,Ae,Ue){var it=Array.isArray(te),Xe;if((ge==="fill"||ge==="stroke")&&te==="none")te="";else{if(ge==="strokeUniform")return te==="non-scaling-stroke";if(ge==="strokeDashArray")te==="none"?te=null:te=te.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(ge==="transformMatrix")Ae&&Ae.transformMatrix?te=h(Ae.transformMatrix,p.parseTransformAttribute(te)):te=p.parseTransformAttribute(te);else if(ge==="visible")te=te!=="none"&&te!=="hidden",Ae&&Ae.visible===!1&&(te=!1);else if(ge==="opacity")te=parseFloat(te),Ae&&typeof Ae.opacity<"u"&&(te*=Ae.opacity);else if(ge==="textAnchor")te=te==="start"?"left":te==="end"?"right":"center";else if(ge==="charSpacing")Xe=c(te,Ue)/Ue*1e3;else if(ge==="paintFirst"){var He=te.indexOf("fill"),vt=te.indexOf("stroke"),te="fill";(He>-1&&vt>-1&&vt<He||He===-1&&vt>-1)&&(te="stroke")}else{if(ge==="href"||ge==="xlink:href"||ge==="font")return te;if(ge==="imageSmoothing")return te==="optimizeQuality";Xe=it?te.map(c):c(te,Ue)}}return!it&&isNaN(Xe)?te:Xe}function xe(ge){return new RegExp("^("+ge.join("|")+")\\b","i")}function ze(ge){for(var te in O)if(!(typeof ge[O[te]]>"u"||ge[te]==="")){if(typeof ge[te]>"u"){if(!p.Object.prototype[te])continue;ge[te]=p.Object.prototype[te]}if(ge[te].indexOf("url(")!==0){var Ae=new p.Color(ge[te]);ge[te]=Ae.setAlpha(l(Ae.getAlpha()*ge[O[te]],2)).toRgba()}}return ge}function Ke(ge,te){var Ae,Ue=[],it,Xe,He;for(Xe=0,He=te.length;Xe<He;Xe++)Ae=te[Xe],it=ge.getElementsByTagName(Ae),Ue=Ue.concat(Array.prototype.slice.call(it));return Ue}p.parseTransformAttribute=function(){function ge(lt,St){var Xt=p.util.cos(St[0]),di=p.util.sin(St[0]),vi=0,Ci=0;St.length===3&&(vi=St[1],Ci=St[2]),lt[0]=Xt,lt[1]=di,lt[2]=-di,lt[3]=Xt,lt[4]=vi-(Xt*vi-di*Ci),lt[5]=Ci-(di*vi+Xt*Ci)}function te(lt,St){var Xt=St[0],di=St.length===2?St[1]:St[0];lt[0]=Xt,lt[3]=di}function Ae(lt,St,Xt){lt[Xt]=Math.tan(p.util.degreesToRadians(St[0]))}function Ue(lt,St){lt[4]=St[0],St.length===2&&(lt[5]=St[1])}var it=p.iMatrix,Xe=p.reNum,He=p.commaWsp,vt="(?:(skewX)\\s*\\(\\s*("+Xe+")\\s*\\))",Et="(?:(skewY)\\s*\\(\\s*("+Xe+")\\s*\\))",$e="(?:(rotate)\\s*\\(\\s*("+Xe+")(?:"+He+"("+Xe+")"+He+"("+Xe+"))?\\s*\\))",Oe="(?:(scale)\\s*\\(\\s*("+Xe+")(?:"+He+"("+Xe+"))?\\s*\\))",at="(?:(translate)\\s*\\(\\s*("+Xe+")(?:"+He+"("+Xe+"))?\\s*\\))",ae="(?:(matrix)\\s*\\(\\s*("+Xe+")"+He+"("+Xe+")"+He+"("+Xe+")"+He+"("+Xe+")"+He+"("+Xe+")"+He+"("+Xe+")\\s*\\))",Ze="(?:"+ae+"|"+at+"|"+Oe+"|"+$e+"|"+vt+"|"+Et+")",pt="(?:"+Ze+"(?:"+He+"*"+Ze+")*)",ft="^\\s*(?:"+pt+"?)\\s*$",Lt=new RegExp(ft),$t=new RegExp(Ze,"g");return function(lt){var St=it.concat(),Xt=[];if(!lt||lt&&!Lt.test(lt))return St;lt.replace($t,function(vi){var Ci=new RegExp(Ze).exec(vi).filter(function(Fi){return!!Fi}),ct=Ci[1],Ei=Ci.slice(2).map(parseFloat);switch(ct){case"translate":Ue(St,Ei);break;case"rotate":Ei[0]=p.util.degreesToRadians(Ei[0]),ge(St,Ei);break;case"scale":te(St,Ei);break;case"skewX":Ae(St,Ei,2);break;case"skewY":Ae(St,Ei,1);break;case"matrix":St=Ei;break}Xt.push(St.concat()),St=it.concat()});for(var di=Xt[0];Xt.length>1;)Xt.shift(),di=p.util.multiplyTransformMatrices(di,Xt[0]);return di}}();function Je(ge,te){var Ae,Ue;ge.replace(/;\s*$/,"").split(";").forEach(function(it){var Xe=it.split(":");Ae=Xe[0].trim().toLowerCase(),Ue=Xe[1].trim(),te[Ae]=Ue})}function tt(ge,te){var Ae,Ue;for(var it in ge)typeof ge[it]>"u"||(Ae=it.toLowerCase(),Ue=ge[it],te[Ae]=Ue)}function ht(ge,te){var Ae={};for(var Ue in p.cssRules[te])if(nt(ge,Ue.split(" ")))for(var it in p.cssRules[te][Ue])Ae[it]=p.cssRules[te][Ue][it];return Ae}function nt(ge,te){var Ae,Ue=!0;return Ae=Ot(ge,te.pop()),Ae&&te.length&&(Ue=_t(ge,te)),Ae&&Ue&&te.length===0}function _t(ge,te){for(var Ae,Ue=!0;ge.parentNode&&ge.parentNode.nodeType===1&&te.length;)Ue&&(Ae=te.pop()),ge=ge.parentNode,Ue=Ot(ge,Ae);return te.length===0}function Ot(ge,te){var Ae=ge.nodeName,Ue=ge.getAttribute("class"),it=ge.getAttribute("id"),Xe,He;if(Xe=new RegExp("^"+Ae,"i"),te=te.replace(Xe,""),it&&te.length&&(Xe=new RegExp("#"+it+"(?![a-zA-Z\\-]+)","i"),te=te.replace(Xe,"")),Ue&&te.length)for(Ue=Ue.split(" "),He=Ue.length;He--;)Xe=new RegExp("\\."+Ue[He]+"(?![a-zA-Z\\-]+)","i"),te=te.replace(Xe,"");return te.length===0}function ot(ge,te){var Ae;if(ge.getElementById&&(Ae=ge.getElementById(te)),Ae)return Ae;var Ue,it,Xe,He=ge.getElementsByTagName("*");for(it=0,Xe=He.length;it<Xe;it++)if(Ue=He[it],te===Ue.getAttribute("id"))return Ue}function wt(ge){for(var te=Ke(ge,["use","svg:use"]),Ae=0;te.length&&Ae<te.length;){var Ue=te[Ae],it=Ue.getAttribute("xlink:href")||Ue.getAttribute("href");if(it===null)return;var Xe=it.slice(1),He=Ue.getAttribute("x")||0,vt=Ue.getAttribute("y")||0,Et=ot(ge,Xe).cloneNode(!0),$e=(Et.getAttribute("transform")||"")+" translate("+He+", "+vt+")",Oe,at=te.length,ae,Ze,pt,ft,Lt=p.svgNS;if(be(Et),/^svg$/i.test(Et.nodeName)){var $t=Et.ownerDocument.createElementNS(Lt,"g");for(Ze=0,pt=Et.attributes,ft=pt.length;Ze<ft;Ze++)ae=pt.item(Ze),$t.setAttributeNS(Lt,ae.nodeName,ae.nodeValue);for(;Et.firstChild;)$t.appendChild(Et.firstChild);Et=$t}for(Ze=0,pt=Ue.attributes,ft=pt.length;Ze<ft;Ze++)ae=pt.item(Ze),!(ae.nodeName==="x"||ae.nodeName==="y"||ae.nodeName==="xlink:href"||ae.nodeName==="href")&&(ae.nodeName==="transform"?$e=ae.nodeValue+" "+$e:Et.setAttribute(ae.nodeName,ae.nodeValue));Et.setAttribute("transform",$e),Et.setAttribute("instantiated_by_use","1"),Et.removeAttribute("id"),Oe=Ue.parentNode,Oe.replaceChild(Et,Ue),te.length===at&&Ae++}}var ee=new RegExp("^\\s*("+p.reNum+"+)\\s*,?\\s*("+p.reNum+"+)\\s*,?\\s*("+p.reNum+"+)\\s*,?\\s*("+p.reNum+"+)\\s*$");function be(ge){if(!p.svgViewBoxElementsRegEx.test(ge.nodeName))return{};var te=ge.getAttribute("viewBox"),Ae=1,Ue=1,it=0,Xe=0,He,vt,Et,$e,Oe=ge.getAttribute("width"),at=ge.getAttribute("height"),ae=ge.getAttribute("x")||0,Ze=ge.getAttribute("y")||0,pt=ge.getAttribute("preserveAspectRatio")||"",ft=!te||!(te=te.match(ee)),Lt=!Oe||!at||Oe==="100%"||at==="100%",$t=ft&&Lt,lt={},St="",Xt=0,di=0;if(lt.width=0,lt.height=0,lt.toBeParsed=$t,ft&&(ae||Ze)&&ge.parentNode&&ge.parentNode.nodeName!=="#document"&&(St=" translate("+c(ae)+" "+c(Ze)+") ",Et=(ge.getAttribute("transform")||"")+St,ge.setAttribute("transform",Et),ge.removeAttribute("x"),ge.removeAttribute("y")),$t)return lt;if(ft)return lt.width=c(Oe),lt.height=c(at),lt;if(it=-parseFloat(te[1]),Xe=-parseFloat(te[2]),He=parseFloat(te[3]),vt=parseFloat(te[4]),lt.minX=it,lt.minY=Xe,lt.viewBoxWidth=He,lt.viewBoxHeight=vt,Lt?(lt.width=He,lt.height=vt):(lt.width=c(Oe),lt.height=c(at),Ae=lt.width/He,Ue=lt.height/vt),pt=p.util.parsePreserveAspectRatioAttribute(pt),pt.alignX!=="none"&&(pt.meetOrSlice==="meet"&&(Ue=Ae=Ae>Ue?Ue:Ae),pt.meetOrSlice==="slice"&&(Ue=Ae=Ae>Ue?Ae:Ue),Xt=lt.width-He*Ae,di=lt.height-vt*Ae,pt.alignX==="Mid"&&(Xt/=2),pt.alignY==="Mid"&&(di/=2),pt.alignX==="Min"&&(Xt=0),pt.alignY==="Min"&&(di=0)),Ae===1&&Ue===1&&it===0&&Xe===0&&ae===0&&Ze===0)return lt;if((ae||Ze)&&ge.parentNode.nodeName!=="#document"&&(St=" translate("+c(ae)+" "+c(Ze)+") "),Et=St+" matrix("+Ae+" 0 0 "+Ue+" "+(it*Ae+Xt)+" "+(Xe*Ue+di)+") ",ge.nodeName==="svg"){for($e=ge.ownerDocument.createElementNS(p.svgNS,"g");ge.firstChild;)$e.appendChild(ge.firstChild);ge.appendChild($e)}else $e=ge,$e.removeAttribute("x"),$e.removeAttribute("y"),Et=$e.getAttribute("transform")+Et;return $e.setAttribute("transform",Et),lt}function me(ge,te){for(;ge&&(ge=ge.parentNode);)if(ge.nodeName&&te.test(ge.nodeName.replace("svg:",""))&&!ge.getAttribute("instantiated_by_use"))return!0;return!1}p.parseSVGDocument=function(ge,te,Ae,Ue){if(ge){wt(ge);var it=p.Object.__uid++,Xe,He,vt=be(ge),Et=p.util.toArray(ge.getElementsByTagName("*"));if(vt.crossOrigin=Ue&&Ue.crossOrigin,vt.svgUid=it,Et.length===0&&p.isLikelyNode){Et=ge.selectNodes('//*[name(.)!="svg"]');var $e=[];for(Xe=0,He=Et.length;Xe<He;Xe++)$e[Xe]=Et[Xe];Et=$e}var Oe=Et.filter(function(ae){return be(ae),p.svgValidTagNamesRegEx.test(ae.nodeName.replace("svg:",""))&&!me(ae,p.svgInvalidAncestorsRegEx)});if(!Oe||Oe&&!Oe.length){te&&te([],{});return}var at={};Et.filter(function(ae){return ae.nodeName.replace("svg:","")==="clipPath"}).forEach(function(ae){var Ze=ae.getAttribute("id");at[Ze]=p.util.toArray(ae.getElementsByTagName("*")).filter(function(pt){return p.svgValidTagNamesRegEx.test(pt.nodeName.replace("svg:",""))})}),p.gradientDefs[it]=p.getGradientDefs(ge),p.cssRules[it]=p.getCSSRules(ge),p.clipPaths[it]=at,p.parseElements(Oe,function(ae,Ze){te&&(te(ae,vt,Ze,Et),delete p.gradientDefs[it],delete p.cssRules[it],delete p.clipPaths[it])},b(vt),Ae,Ue)}};function ye(ge,te){var Ae=["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"],Ue="xlink:href",it=te.getAttribute(Ue).slice(1),Xe=ot(ge,it);if(Xe&&Xe.getAttribute(Ue)&&ye(ge,Xe),Ae.forEach(function(vt){Xe&&!te.hasAttribute(vt)&&Xe.hasAttribute(vt)&&te.setAttribute(vt,Xe.getAttribute(vt))}),!te.children.length)for(var He=Xe.cloneNode(!0);He.firstChild;)te.appendChild(He.firstChild);te.removeAttribute(Ue)}var Ve=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+p.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+p.reNum+"))?\\s+(.*)");C(p,{parseFontDeclaration:function(ge,te){var Ae=ge.match(Ve);if(Ae){var Ue=Ae[1],it=Ae[3],Xe=Ae[4],He=Ae[5],vt=Ae[6];Ue&&(te.fontStyle=Ue),it&&(te.fontWeight=isNaN(parseFloat(it))?it:parseFloat(it)),Xe&&(te.fontSize=c(Xe)),vt&&(te.fontFamily=vt),He&&(te.lineHeight=He==="normal"?1:He)}},getGradientDefs:function(ge){var te=["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"],Ae=Ke(ge,te),Ue,it=0,Xe={};for(it=Ae.length;it--;)Ue=Ae[it],Ue.getAttribute("xlink:href")&&ye(ge,Ue),Xe[Ue.getAttribute("id")]=Ue;return Xe},parseAttributes:function(ge,te,Ae){if(ge){var Ue,it={},Xe,He;typeof Ae>"u"&&(Ae=ge.getAttribute("svgUid")),ge.parentNode&&p.svgValidParentsRegEx.test(ge.parentNode.nodeName)&&(it=p.parseAttributes(ge.parentNode,te,Ae));var vt=te.reduce(function(pt,ft){return Ue=ge.getAttribute(ft),Ue&&(pt[ft]=Ue),pt},{}),Et=C(ht(ge,Ae),p.parseStyleAttribute(ge));vt=C(vt,Et),Et[V]&&ge.setAttribute(V,Et[V]),Xe=He=it.fontSize||p.Text.DEFAULT_SVG_FONT_SIZE,vt[L]&&(vt[L]=Xe=c(vt[L],He));var $e,Oe,at={};for(var ae in vt)$e=$(ae),Oe=ne($e,vt[ae],it,Xe),at[$e]=Oe;at&&at.font&&p.parseFontDeclaration(at.font,at);var Ze=C(it,at);return p.svgValidParentsRegEx.test(ge.nodeName)?Ze:ze(Ze)}},parseElements:function(ge,te,Ae,Ue,it){new p.ElementsParser(ge,te,Ae,Ue,it).parse()},parseStyleAttribute:function(ge){var te={},Ae=ge.getAttribute("style");return Ae&&(typeof Ae=="string"?Je(Ae,te):tt(Ae,te)),te},parsePointsAttribute:function(ge){if(!ge)return null;ge=ge.replace(/,/g," ").trim(),ge=ge.split(/\s+/);var te=[],Ae,Ue;for(Ae=0,Ue=ge.length;Ae<Ue;Ae+=2)te.push({x:parseFloat(ge[Ae]),y:parseFloat(ge[Ae+1])});return te},getCSSRules:function(ge){var te=ge.getElementsByTagName("style"),Ae,Ue,it={},Xe;for(Ae=0,Ue=te.length;Ae<Ue;Ae++){var He=te[Ae].textContent;He=He.replace(/\/\*[\s\S]*?\*\//g,""),He.trim()!==""&&(Xe=He.split("}"),Xe=Xe.filter(function(vt){return vt.trim()}),Xe.forEach(function(vt){var Et=vt.split("{"),$e={},Oe=Et[1].trim(),at=Oe.split(";").filter(function(ft){return ft.trim()});for(Ae=0,Ue=at.length;Ae<Ue;Ae++){var ae=at[Ae].split(":"),Ze=ae[0].trim(),pt=ae[1].trim();$e[Ze]=pt}vt=Et[0].trim(),vt.split(",").forEach(function(ft){ft=ft.replace(/^svg/i,"").trim(),ft!==""&&(it[ft]?p.util.object.extend(it[ft],$e):it[ft]=p.util.object.clone($e))})}))}return it},loadSVGFromURL:function(ge,te,Ae,Ue){ge=ge.replace(/^\n\s*/,"").trim(),new p.util.request(ge,{method:"get",onComplete:it});function it(Xe){var He=Xe.responseXML;if(!He||!He.documentElement)return te&&te(null),!1;p.parseSVGDocument(He.documentElement,function(vt,Et,$e,Oe){te&&te(vt,Et,$e,Oe)},Ae,Ue)}},loadSVGFromString:function(ge,te,Ae,Ue){var it=new p.window.DOMParser,Xe=it.parseFromString(ge.trim(),"text/xml");p.parseSVGDocument(Xe.documentElement,function(He,vt,Et,$e){te(He,vt,Et,$e)},Ae,Ue)}})}(Y),T.ElementsParser=function(s,p,C,b,l,c){this.elements=s,this.callback=p,this.options=C,this.reviver=b,this.svgUid=C&&C.svgUid||0,this.parsingOptions=l,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=c},function(s){s.parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},s.createObjects=function(){var p=this;this.elements.forEach(function(C,b){C.setAttribute("svgUid",p.svgUid),p.createObject(C,b)})},s.findTag=function(p){return T[T.util.string.capitalize(p.tagName.replace("svg:",""))]},s.createObject=function(p,C){var b=this.findTag(p);if(b&&b.fromElement)try{b.fromElement(p,this.createCallback(C,p),this.options)}catch(l){T.log(l)}else this.checkIfDone()},s.createCallback=function(p,C){var b=this;return function(l){var c;b.resolveGradient(l,C,"fill"),b.resolveGradient(l,C,"stroke"),l instanceof T.Image&&l._originalElement&&(c=l.parsePreserveAspectRatioAttribute(C)),l._removeTransformMatrix(c),b.resolveClipPath(l,C),b.reviver&&b.reviver(C,l),b.instances[p]=l,b.checkIfDone()}},s.extractPropertyDefinition=function(p,C,b){var l=p[C],c=this.regexUrl;if(c.test(l)){c.lastIndex=0;var h=c.exec(l)[1];return c.lastIndex=0,T[b][this.svgUid][h]}},s.resolveGradient=function(p,C,b){var l=this.extractPropertyDefinition(p,b,"gradientDefs");if(l){var c=C.getAttribute(b+"-opacity"),h=T.Gradient.fromElement(l,p,c,this.options);p.set(b,h)}},s.createClipPathCallback=function(p,C){return function(b){b._removeTransformMatrix(),b.fillRule=b.clipRule,C.push(b)}},s.resolveClipPath=function(p,C){var b=this.extractPropertyDefinition(p,"clipPath","clipPaths"),l,c,h,m,g,d;if(b){m=[],h=T.util.invertTransform(p.calcTransformMatrix());for(var w=b[0].parentNode,E=C;E.parentNode&&E.getAttribute("clip-path")!==p.clipPath;)E=E.parentNode;E.parentNode.appendChild(w);for(var O=0;O<b.length;O++)l=b[O],c=this.findTag(l),c.fromElement(l,this.createClipPathCallback(p,m),this.options);m.length===1?b=m[0]:b=new T.Group(m),g=T.util.multiplyTransformMatrices(h,b.calcTransformMatrix()),b.clipPath&&this.resolveClipPath(b,E);var d=T.util.qrDecompose(g);b.flipX=!1,b.flipY=!1,b.set("scaleX",d.scaleX),b.set("scaleY",d.scaleY),b.angle=d.angle,b.skewX=d.skewX,b.skewY=0,b.setPositionByOrigin({x:d.translateX,y:d.translateY},"center","center"),p.clipPath=b}else delete p.clipPath},s.checkIfDone=function(){--this.numElements===0&&(this.instances=this.instances.filter(function(p){return p!=null}),this.callback(this.instances,this.elements))}}(T.ElementsParser.prototype),function(s){var p=s.fabric||(s.fabric={});if(p.Point){p.warn("fabric.Point is already defined");return}p.Point=C;function C(b,l){this.x=b,this.y=l}C.prototype={type:"point",constructor:C,add:function(b){return new C(this.x+b.x,this.y+b.y)},addEquals:function(b){return this.x+=b.x,this.y+=b.y,this},scalarAdd:function(b){return new C(this.x+b,this.y+b)},scalarAddEquals:function(b){return this.x+=b,this.y+=b,this},subtract:function(b){return new C(this.x-b.x,this.y-b.y)},subtractEquals:function(b){return this.x-=b.x,this.y-=b.y,this},scalarSubtract:function(b){return new C(this.x-b,this.y-b)},scalarSubtractEquals:function(b){return this.x-=b,this.y-=b,this},multiply:function(b){return new C(this.x*b,this.y*b)},multiplyEquals:function(b){return this.x*=b,this.y*=b,this},divide:function(b){return new C(this.x/b,this.y/b)},divideEquals:function(b){return this.x/=b,this.y/=b,this},eq:function(b){return this.x===b.x&&this.y===b.y},lt:function(b){return this.x<b.x&&this.y<b.y},lte:function(b){return this.x<=b.x&&this.y<=b.y},gt:function(b){return this.x>b.x&&this.y>b.y},gte:function(b){return this.x>=b.x&&this.y>=b.y},lerp:function(b,l){return typeof l>"u"&&(l=.5),l=Math.max(Math.min(1,l),0),new C(this.x+(b.x-this.x)*l,this.y+(b.y-this.y)*l)},distanceFrom:function(b){var l=this.x-b.x,c=this.y-b.y;return Math.sqrt(l*l+c*c)},midPointFrom:function(b){return this.lerp(b)},min:function(b){return new C(Math.min(this.x,b.x),Math.min(this.y,b.y))},max:function(b){return new C(Math.max(this.x,b.x),Math.max(this.y,b.y))},toString:function(){return this.x+","+this.y},setXY:function(b,l){return this.x=b,this.y=l,this},setX:function(b){return this.x=b,this},setY:function(b){return this.y=b,this},setFromPoint:function(b){return this.x=b.x,this.y=b.y,this},swap:function(b){var l=this.x,c=this.y;this.x=b.x,this.y=b.y,b.x=l,b.y=c},clone:function(){return new C(this.x,this.y)}}}(Y),function(s){var p=s.fabric||(s.fabric={});if(p.Intersection){p.warn("fabric.Intersection is already defined");return}function C(b){this.status=b,this.points=[]}p.Intersection=C,p.Intersection.prototype={constructor:C,appendPoint:function(b){return this.points.push(b),this},appendPoints:function(b){return this.points=this.points.concat(b),this}},p.Intersection.intersectLineLine=function(b,l,c,h){var m,g=(h.x-c.x)*(b.y-c.y)-(h.y-c.y)*(b.x-c.x),d=(l.x-b.x)*(b.y-c.y)-(l.y-b.y)*(b.x-c.x),w=(h.y-c.y)*(l.x-b.x)-(h.x-c.x)*(l.y-b.y);if(w!==0){var E=g/w,O=d/w;0<=E&&E<=1&&0<=O&&O<=1?(m=new C("Intersection"),m.appendPoint(new p.Point(b.x+E*(l.x-b.x),b.y+E*(l.y-b.y)))):m=new C}else g===0||d===0?m=new C("Coincident"):m=new C("Parallel");return m},p.Intersection.intersectLinePolygon=function(b,l,c){var h=new C,m=c.length,g,d,w,E;for(E=0;E<m;E++)g=c[E],d=c[(E+1)%m],w=C.intersectLineLine(b,l,g,d),h.appendPoints(w.points);return h.points.length>0&&(h.status="Intersection"),h},p.Intersection.intersectPolygonPolygon=function(b,l){var c=new C,h=b.length,m;for(m=0;m<h;m++){var g=b[m],d=b[(m+1)%h],w=C.intersectLinePolygon(g,d,l);c.appendPoints(w.points)}return c.points.length>0&&(c.status="Intersection"),c},p.Intersection.intersectPolygonRectangle=function(b,l,c){var h=l.min(c),m=l.max(c),g=new p.Point(m.x,h.y),d=new p.Point(h.x,m.y),w=C.intersectLinePolygon(h,g,b),E=C.intersectLinePolygon(g,m,b),O=C.intersectLinePolygon(m,d,b),L=C.intersectLinePolygon(d,h,b),V=new C;return V.appendPoints(w.points),V.appendPoints(E.points),V.appendPoints(O.points),V.appendPoints(L.points),V.points.length>0&&(V.status="Intersection"),V}}(Y),function(s){var p=s.fabric||(s.fabric={});if(p.Color){p.warn("fabric.Color is already defined.");return}function C(l){l?this._tryParsingColor(l):this.setSource([0,0,0,1])}p.Color=C,p.Color.prototype={_tryParsingColor:function(l){var c;l in C.colorNameMap&&(l=C.colorNameMap[l]),l==="transparent"&&(c=[255,255,255,0]),c||(c=C.sourceFromHex(l)),c||(c=C.sourceFromRgb(l)),c||(c=C.sourceFromHsl(l)),c||(c=[0,0,0,1]),c&&this.setSource(c)},_rgbToHsl:function(l,c,h){l/=255,c/=255,h/=255;var m,g,d,w=p.util.array.max([l,c,h]),E=p.util.array.min([l,c,h]);if(d=(w+E)/2,w===E)m=g=0;else{var O=w-E;switch(g=d>.5?O/(2-w-E):O/(w+E),w){case l:m=(c-h)/O+(c<h?6:0);break;case c:m=(h-l)/O+2;break;case h:m=(l-c)/O+4;break}m/=6}return[Math.round(m*360),Math.round(g*100),Math.round(d*100)]},getSource:function(){return this._source},setSource:function(l){this._source=l},toRgb:function(){var l=this.getSource();return"rgb("+l[0]+","+l[1]+","+l[2]+")"},toRgba:function(){var l=this.getSource();return"rgba("+l[0]+","+l[1]+","+l[2]+","+l[3]+")"},toHsl:function(){var l=this.getSource(),c=this._rgbToHsl(l[0],l[1],l[2]);return"hsl("+c[0]+","+c[1]+"%,"+c[2]+"%)"},toHsla:function(){var l=this.getSource(),c=this._rgbToHsl(l[0],l[1],l[2]);return"hsla("+c[0]+","+c[1]+"%,"+c[2]+"%,"+l[3]+")"},toHex:function(){var l=this.getSource(),c,h,m;return c=l[0].toString(16),c=c.length===1?"0"+c:c,h=l[1].toString(16),h=h.length===1?"0"+h:h,m=l[2].toString(16),m=m.length===1?"0"+m:m,c.toUpperCase()+h.toUpperCase()+m.toUpperCase()},toHexa:function(){var l=this.getSource(),c;return c=Math.round(l[3]*255),c=c.toString(16),c=c.length===1?"0"+c:c,this.toHex()+c.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(l){var c=this.getSource();return c[3]=l,this.setSource(c),this},toGrayscale:function(){var l=this.getSource(),c=parseInt((l[0]*.3+l[1]*.59+l[2]*.11).toFixed(0),10),h=l[3];return this.setSource([c,c,c,h]),this},toBlackWhite:function(l){var c=this.getSource(),h=(c[0]*.3+c[1]*.59+c[2]*.11).toFixed(0),m=c[3];return l=l||127,h=Number(h)<Number(l)?0:255,this.setSource([h,h,h,m]),this},overlayWith:function(l){l instanceof C||(l=new C(l));var c=[],h=this.getAlpha(),m=.5,g=this.getSource(),d=l.getSource(),w;for(w=0;w<3;w++)c.push(Math.round(g[w]*(1-m)+d[w]*m));return c[3]=h,this.setSource(c),this}},p.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,p.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,p.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,p.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"};function b(l,c,h){return h<0&&(h+=1),h>1&&(h-=1),h<1/6?l+(c-l)*6*h:h<1/2?c:h<2/3?l+(c-l)*(2/3-h)*6:l}p.Color.fromRgb=function(l){return C.fromSource(C.sourceFromRgb(l))},p.Color.sourceFromRgb=function(l){var c=l.match(C.reRGBa);if(c){var h=parseInt(c[1],10)/(/%$/.test(c[1])?100:1)*(/%$/.test(c[1])?255:1),m=parseInt(c[2],10)/(/%$/.test(c[2])?100:1)*(/%$/.test(c[2])?255:1),g=parseInt(c[3],10)/(/%$/.test(c[3])?100:1)*(/%$/.test(c[3])?255:1);return[parseInt(h,10),parseInt(m,10),parseInt(g,10),c[4]?parseFloat(c[4]):1]}},p.Color.fromRgba=C.fromRgb,p.Color.fromHsl=function(l){return C.fromSource(C.sourceFromHsl(l))},p.Color.sourceFromHsl=function(l){var c=l.match(C.reHSLa);if(c){var h=(parseFloat(c[1])%360+360)%360/360,m=parseFloat(c[2])/(/%$/.test(c[2])?100:1),g=parseFloat(c[3])/(/%$/.test(c[3])?100:1),d,w,E;if(m===0)d=w=E=g;else{var O=g<=.5?g*(m+1):g+m-g*m,L=g*2-O;d=b(L,O,h+1/3),w=b(L,O,h),E=b(L,O,h-1/3)}return[Math.round(d*255),Math.round(w*255),Math.round(E*255),c[4]?parseFloat(c[4]):1]}},p.Color.fromHsla=C.fromHsl,p.Color.fromHex=function(l){return C.fromSource(C.sourceFromHex(l))},p.Color.sourceFromHex=function(l){if(l.match(C.reHex)){var c=l.slice(l.indexOf("#")+1),h=c.length===3||c.length===4,m=c.length===8||c.length===4,g=h?c.charAt(0)+c.charAt(0):c.substring(0,2),d=h?c.charAt(1)+c.charAt(1):c.substring(2,4),w=h?c.charAt(2)+c.charAt(2):c.substring(4,6),E=m?h?c.charAt(3)+c.charAt(3):c.substring(6,8):"FF";return[parseInt(g,16),parseInt(d,16),parseInt(w,16),parseFloat((parseInt(E,16)/255).toFixed(2))]}},p.Color.fromSource=function(l){var c=new C;return c.setSource(l),c}}(Y),function(s){var p=s.fabric||(s.fabric={}),C=["e","se","s","sw","w","nw","n","ne","e"],b=["ns","nesw","ew","nwse"],l={},c="left",h="top",m="right",g="bottom",d="center",w={top:g,bottom:h,left:m,right:c,center:d},E=p.util.radiansToDegrees,O=Math.sign||function($e){return($e>0)-($e<0)||+$e};function L($e,Oe){var at=$e.angle+E(Math.atan2(Oe.y,Oe.x))+360;return Math.round(at%360/45)}function V($e,Oe){var at=Oe.transform.target,ae=at.canvas,Ze=p.util.object.clone(Oe);Ze.target=at,ae&&ae.fire("object:"+$e,Ze),at.fire($e,Oe)}function $($e,Oe){var at=Oe.canvas,ae=at.uniScaleKey,Ze=$e[ae];return at.uniformScaling&&!Ze||!at.uniformScaling&&Ze}function ne($e){return $e.originX===d&&$e.originY===d}function xe($e,Oe,at){var ae=$e.lockScalingX,Ze=$e.lockScalingY;return!!(ae&&Ze||!Oe&&(ae||Ze)&&at||ae&&Oe==="x"||Ze&&Oe==="y")}function ze($e,Oe,at){var ae="not-allowed",Ze=$($e,at),pt="";if(Oe.x!==0&&Oe.y===0?pt="x":Oe.x===0&&Oe.y!==0&&(pt="y"),xe(at,pt,Ze))return ae;var ft=L(at,Oe);return C[ft]+"-resize"}function Ke($e,Oe,at){var ae="not-allowed";if(Oe.x!==0&&at.lockSkewingY||Oe.y!==0&&at.lockSkewingX)return ae;var Ze=L(at,Oe)%4;return b[Ze]+"-resize"}function Je($e,Oe,at){return $e[at.canvas.altActionKey]?l.skewCursorStyleHandler($e,Oe,at):l.scaleCursorStyleHandler($e,Oe,at)}function tt($e,Oe,at){var ae=$e[at.canvas.altActionKey];if(Oe.x===0)return ae?"skewX":"scaleY";if(Oe.y===0)return ae?"skewY":"scaleX"}function ht($e,Oe,at){return at.lockRotation?"not-allowed":Oe.cursorStyle}function nt($e,Oe,at,ae){return{e:$e,transform:Oe,pointer:{x:at,y:ae}}}function _t($e){return function(Oe,at,ae,Ze){var pt=at.target,ft=pt.getCenterPoint(),Lt=pt.translateToOriginPoint(ft,at.originX,at.originY),$t=$e(Oe,at,ae,Ze);return pt.setPositionByOrigin(Lt,at.originX,at.originY),$t}}function Ot($e,Oe){return function(at,ae,Ze,pt){var ft=Oe(at,ae,Ze,pt);return ft&&V($e,nt(at,ae,Ze,pt)),ft}}function ot($e,Oe,at,ae,Ze){var pt=$e.target,ft=pt.controls[$e.corner],Lt=pt.canvas.getZoom(),$t=pt.padding/Lt,lt=pt.toLocalPoint(new p.Point(ae,Ze),Oe,at);return lt.x>=$t&&(lt.x-=$t),lt.x<=-$t&&(lt.x+=$t),lt.y>=$t&&(lt.y-=$t),lt.y<=$t&&(lt.y+=$t),lt.x-=ft.offsetX,lt.y-=ft.offsetY,lt}function wt($e){return $e.flipX!==$e.flipY}function ee($e,Oe,at,ae,Ze){if($e[Oe]!==0){var pt=$e._getTransformedDimensions()[ae],ft=Ze/pt*$e[at];$e.set(at,ft)}}function be($e,Oe,at,ae){var Ze=Oe.target,pt=Ze._getTransformedDimensions(0,Ze.skewY),ft=ot(Oe,Oe.originX,Oe.originY,at,ae),Lt=Math.abs(ft.x*2)-pt.x,$t=Ze.skewX,lt;Lt<2?lt=0:(lt=E(Math.atan2(Lt/Ze.scaleX,pt.y/Ze.scaleY)),Oe.originX===c&&Oe.originY===g&&(lt=-lt),Oe.originX===m&&Oe.originY===h&&(lt=-lt),wt(Ze)&&(lt=-lt));var St=$t!==lt;if(St){var Xt=Ze._getTransformedDimensions().y;Ze.set("skewX",lt),ee(Ze,"skewY","scaleY","y",Xt)}return St}function me($e,Oe,at,ae){var Ze=Oe.target,pt=Ze._getTransformedDimensions(Ze.skewX,0),ft=ot(Oe,Oe.originX,Oe.originY,at,ae),Lt=Math.abs(ft.y*2)-pt.y,$t=Ze.skewY,lt;Lt<2?lt=0:(lt=E(Math.atan2(Lt/Ze.scaleY,pt.x/Ze.scaleX)),Oe.originX===c&&Oe.originY===g&&(lt=-lt),Oe.originX===m&&Oe.originY===h&&(lt=-lt),wt(Ze)&&(lt=-lt));var St=$t!==lt;if(St){var Xt=Ze._getTransformedDimensions().x;Ze.set("skewY",lt),ee(Ze,"skewX","scaleX","x",Xt)}return St}function ye($e,Oe,at,ae){var Ze=Oe.target,pt=Ze.skewX,ft,Lt=Oe.originY;if(Ze.lockSkewingX)return!1;if(pt===0){var $t=ot(Oe,d,d,at,ae);$t.x>0?ft=c:ft=m}else pt>0&&(ft=Lt===h?c:m),pt<0&&(ft=Lt===h?m:c),wt(Ze)&&(ft=ft===c?m:c);Oe.originX=ft;var lt=Ot("skewing",_t(be));return lt($e,Oe,at,ae)}function Ve($e,Oe,at,ae){var Ze=Oe.target,pt=Ze.skewY,ft,Lt=Oe.originX;if(Ze.lockSkewingY)return!1;if(pt===0){var $t=ot(Oe,d,d,at,ae);$t.y>0?ft=h:ft=g}else pt>0&&(ft=Lt===c?h:g),pt<0&&(ft=Lt===c?g:h),wt(Ze)&&(ft=ft===h?g:h);Oe.originY=ft;var lt=Ot("skewing",_t(me));return lt($e,Oe,at,ae)}function ge($e,Oe,at,ae){var Ze=Oe,pt=Ze.target,ft=pt.translateToOriginPoint(pt.getCenterPoint(),Ze.originX,Ze.originY);if(pt.lockRotation)return!1;var Lt=Math.atan2(Ze.ey-ft.y,Ze.ex-ft.x),$t=Math.atan2(ae-ft.y,at-ft.x),lt=E($t-Lt+Ze.theta),St=!0;if(pt.snapAngle>0){var Xt=pt.snapAngle,di=pt.snapThreshold||Xt,vi=Math.ceil(lt/Xt)*Xt,Ci=Math.floor(lt/Xt)*Xt;Math.abs(lt-Ci)<di?lt=Ci:Math.abs(lt-vi)<di&&(lt=vi)}return lt<0&&(lt=360+lt),lt%=360,St=pt.angle!==lt,pt.angle=lt,St}function te($e,Oe,at,ae,Ze){Ze=Ze||{};var pt=Oe.target,ft=pt.lockScalingX,Lt=pt.lockScalingY,$t=Ze.by,lt,St,Xt,di,vi=$($e,pt),Ci=xe(pt,$t,vi),ct,Ei,Fi=Oe.gestureScale;if(Ci)return!1;if(Fi)St=Oe.scaleX*Fi,Xt=Oe.scaleY*Fi;else{if(lt=ot(Oe,Oe.originX,Oe.originY,at,ae),ct=$t!=="y"?O(lt.x):1,Ei=$t!=="x"?O(lt.y):1,Oe.signX||(Oe.signX=ct),Oe.signY||(Oe.signY=Ei),pt.lockScalingFlip&&(Oe.signX!==ct||Oe.signY!==Ei))return!1;if(di=pt._getTransformedDimensions(),vi&&!$t){var yr=Math.abs(lt.x)+Math.abs(lt.y),Zi=Oe.original,Ct=Math.abs(di.x*Zi.scaleX/pt.scaleX)+Math.abs(di.y*Zi.scaleY/pt.scaleY),pi=yr/Ct;St=Zi.scaleX*pi,Xt=Zi.scaleY*pi}else St=Math.abs(lt.x*pt.scaleX/di.x),Xt=Math.abs(lt.y*pt.scaleY/di.y);ne(Oe)&&(St*=2,Xt*=2),Oe.signX!==ct&&$t!=="y"&&(Oe.originX=w[Oe.originX],St*=-1,Oe.signX=ct),Oe.signY!==Ei&&$t!=="x"&&(Oe.originY=w[Oe.originY],Xt*=-1,Oe.signY=Ei)}var Qt=pt.scaleX,qi=pt.scaleY;return $t?($t==="x"&&pt.set("scaleX",St),$t==="y"&&pt.set("scaleY",Xt)):(!ft&&pt.set("scaleX",St),!Lt&&pt.set("scaleY",Xt)),Qt!==pt.scaleX||qi!==pt.scaleY}function Ae($e,Oe,at,ae){return te($e,Oe,at,ae)}function Ue($e,Oe,at,ae){return te($e,Oe,at,ae,{by:"x"})}function it($e,Oe,at,ae){return te($e,Oe,at,ae,{by:"y"})}function Xe($e,Oe,at,ae){return $e[Oe.target.canvas.altActionKey]?l.skewHandlerX($e,Oe,at,ae):l.scalingY($e,Oe,at,ae)}function He($e,Oe,at,ae){return $e[Oe.target.canvas.altActionKey]?l.skewHandlerY($e,Oe,at,ae):l.scalingX($e,Oe,at,ae)}function vt($e,Oe,at,ae){var Ze=Oe.target,pt=ot(Oe,Oe.originX,Oe.originY,at,ae),ft=Ze.strokeWidth/(Ze.strokeUniform?Ze.scaleX:1),Lt=ne(Oe)?2:1,$t=Ze.width,lt=Math.abs(pt.x*Lt/Ze.scaleX)-ft;return Ze.set("width",Math.max(lt,0)),$t!==lt}function Et($e,Oe,at,ae){var Ze=Oe.target,pt=at-Oe.offsetX,ft=ae-Oe.offsetY,Lt=!Ze.get("lockMovementX")&&Ze.left!==pt,$t=!Ze.get("lockMovementY")&&Ze.top!==ft;return Lt&&Ze.set("left",pt),$t&&Ze.set("top",ft),(Lt||$t)&&V("moving",nt($e,Oe,at,ae)),Lt||$t}l.scaleCursorStyleHandler=ze,l.skewCursorStyleHandler=Ke,l.scaleSkewCursorStyleHandler=Je,l.rotationWithSnapping=Ot("rotating",_t(ge)),l.scalingEqually=Ot("scaling",_t(Ae)),l.scalingX=Ot("scaling",_t(Ue)),l.scalingY=Ot("scaling",_t(it)),l.scalingYOrSkewingX=Xe,l.scalingXOrSkewingY=He,l.changeWidth=Ot("resizing",_t(vt)),l.skewHandlerX=ye,l.skewHandlerY=Ve,l.dragHandler=Et,l.scaleOrSkewActionName=tt,l.rotationStyleHandler=ht,l.fireEvent=V,l.wrapWithFixedAnchor=_t,l.wrapWithFireEvent=Ot,l.getLocalPoint=ot,p.controlsUtils=l}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.util.degreesToRadians,b=p.controlsUtils;function l(h,m,g,d,w){d=d||{};var E=this.sizeX||d.cornerSize||w.cornerSize,O=this.sizeY||d.cornerSize||w.cornerSize,L=typeof d.transparentCorners<"u"?d.transparentCorners:w.transparentCorners,V=L?"stroke":"fill",$=!L&&(d.cornerStrokeColor||w.cornerStrokeColor),ne=m,xe=g,ze;h.save(),h.fillStyle=d.cornerColor||w.cornerColor,h.strokeStyle=d.cornerStrokeColor||w.cornerStrokeColor,E>O?(ze=E,h.scale(1,O/E),xe=g*E/O):O>E?(ze=O,h.scale(E/O,1),ne=m*O/E):ze=E,h.lineWidth=1,h.beginPath(),h.arc(ne,xe,ze/2,0,2*Math.PI,!1),h[V](),$&&h.stroke(),h.restore()}function c(h,m,g,d,w){d=d||{};var E=this.sizeX||d.cornerSize||w.cornerSize,O=this.sizeY||d.cornerSize||w.cornerSize,L=typeof d.transparentCorners<"u"?d.transparentCorners:w.transparentCorners,V=L?"stroke":"fill",$=!L&&(d.cornerStrokeColor||w.cornerStrokeColor),ne=E/2,xe=O/2;h.save(),h.fillStyle=d.cornerColor||w.cornerColor,h.strokeStyle=d.cornerStrokeColor||w.cornerStrokeColor,h.lineWidth=1,h.translate(m,g),h.rotate(C(w.angle)),h[V+"Rect"](-ne,-xe,E,O),$&&h.strokeRect(-ne,-xe,E,O),h.restore()}b.renderCircleControl=l,b.renderSquareControl=c}(Y),function(s){var p=s.fabric||(s.fabric={});function C(b){for(var l in b)this[l]=b[l]}p.Control=C,p.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(b,l){return l.cursorStyle},getActionName:function(b,l){return l.actionName},getVisibility:function(b,l){var c=b._controlsVisibility;return c&&typeof c[l]<"u"?c[l]:this.visible},setVisibility:function(b){this.visible=b},positionHandler:function(b,l){var c=p.util.transformPoint({x:this.x*b.x+this.offsetX,y:this.y*b.y+this.offsetY},l);return c},calcCornerCoords:function(b,l,c,h,m){var g,d,w,E,O=m?this.touchSizeX:this.sizeX,L=m?this.touchSizeY:this.sizeY;if(O&&L&&O!==L){var V=Math.atan2(L,O),$=Math.sqrt(O*O+L*L)/2,ne=V-p.util.degreesToRadians(b),xe=Math.PI/2-V-p.util.degreesToRadians(b);g=$*p.util.cos(ne),d=$*p.util.sin(ne),w=$*p.util.cos(xe),E=$*p.util.sin(xe)}else{var ze=O&&L?O:l;$=ze*.7071067812;var ne=p.util.degreesToRadians(45-b);g=w=$*p.util.cos(ne),d=E=$*p.util.sin(ne)}return{tl:{x:c-E,y:h-w},tr:{x:c+g,y:h-d},bl:{x:c-g,y:h+d},br:{x:c+E,y:h+w}}},render:function(b,l,c,h,m){switch(h=h||{},h.cornerStyle||m.cornerStyle){case"circle":p.controlsUtils.renderCircleControl.call(this,b,l,c,h,m);break;default:p.controlsUtils.renderSquareControl.call(this,b,l,c,h,m)}}}}(Y),function(){function s(c,h){var m=c.getAttribute("style"),g=c.getAttribute("offset")||0,d,w,E,O;if(g=parseFloat(g)/(/%$/.test(g)?100:1),g=g<0?0:g>1?1:g,m){var L=m.split(/\s*;\s*/);for(L[L.length-1]===""&&L.pop(),O=L.length;O--;){var V=L[O].split(/\s*:\s*/),$=V[0].trim(),ne=V[1].trim();$==="stop-color"?d=ne:$==="stop-opacity"&&(E=ne)}}return d||(d=c.getAttribute("stop-color")||"rgb(0,0,0)"),E||(E=c.getAttribute("stop-opacity")),d=new T.Color(d),w=d.getAlpha(),E=isNaN(parseFloat(E))?1:parseFloat(E),E*=w*h,{offset:g,color:d.toRgb(),opacity:E}}function p(c){return{x1:c.getAttribute("x1")||0,y1:c.getAttribute("y1")||0,x2:c.getAttribute("x2")||"100%",y2:c.getAttribute("y2")||0}}function C(c){return{x1:c.getAttribute("fx")||c.getAttribute("cx")||"50%",y1:c.getAttribute("fy")||c.getAttribute("cy")||"50%",r1:0,x2:c.getAttribute("cx")||"50%",y2:c.getAttribute("cy")||"50%",r2:c.getAttribute("r")||"50%"}}var b=T.util.object.clone;T.Gradient=T.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(c){c||(c={}),c.coords||(c.coords={});var h,m=this;Object.keys(c).forEach(function(g){m[g]=c[g]}),this.id?this.id+="_"+T.Object.__uid++:this.id=T.Object.__uid++,h={x1:c.coords.x1||0,y1:c.coords.y1||0,x2:c.coords.x2||0,y2:c.coords.y2||0},this.type==="radial"&&(h.r1=c.coords.r1||0,h.r2=c.coords.r2||0),this.coords=h,this.colorStops=c.colorStops.slice()},addColorStop:function(c){for(var h in c){var m=new T.Color(c[h]);this.colorStops.push({offset:parseFloat(h),color:m.toRgb(),opacity:m.getAlpha()})}return this},toObject:function(c){var h={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return T.util.populateWithProperties(this,h,c),h},toSVG:function(c,w){var m=b(this.coords,!0),g,d,w=w||{},E,O,L=b(this.colorStops,!0),V=m.r1>m.r2,$=this.gradientTransform?this.gradientTransform.concat():T.iMatrix.concat(),ne=-this.offsetX,xe=-this.offsetY,ze=!!w.additionalTransform,Ke=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox";if(L.sort(function(_t,Ot){return _t.offset-Ot.offset}),Ke==="objectBoundingBox"?(ne/=c.width,xe/=c.height):(ne+=c.width/2,xe+=c.height/2),c.type==="path"&&this.gradientUnits!=="percentage"&&(ne-=c.pathOffset.x,xe-=c.pathOffset.y),$[4]-=ne,$[5]-=xe,O='id="SVGID_'+this.id+'" gradientUnits="'+Ke+'"',O+=' gradientTransform="'+(ze?w.additionalTransform+" ":"")+T.util.matrixToSVG($)+'" ',this.type==="linear"?E=["<linearGradient ",O,' x1="',m.x1,'" y1="',m.y1,'" x2="',m.x2,'" y2="',m.y2,`">
`]:this.type==="radial"&&(E=["<radialGradient ",O,' cx="',V?m.x1:m.x2,'" cy="',V?m.y1:m.y2,'" r="',V?m.r1:m.r2,'" fx="',V?m.x2:m.x1,'" fy="',V?m.y2:m.y1,`">
`]),this.type==="radial"){if(V)for(L=L.concat(),L.reverse(),g=0,d=L.length;g<d;g++)L[g].offset=1-L[g].offset;var Je=Math.min(m.r1,m.r2);if(Je>0){var tt=Math.max(m.r1,m.r2),ht=Je/tt;for(g=0,d=L.length;g<d;g++)L[g].offset+=ht*(1-L[g].offset)}}for(g=0,d=L.length;g<d;g++){var nt=L[g];E.push("<stop ",'offset="',nt.offset*100+"%",'" style="stop-color:',nt.color,typeof nt.opacity<"u"?";stop-opacity: "+nt.opacity:";",`"/>
`)}return E.push(this.type==="linear"?`</linearGradient>
`:`</radialGradient>
`),E.join("")},toLive:function(c){var h,m=T.util.object.clone(this.coords),g,d;if(this.type){for(this.type==="linear"?h=c.createLinearGradient(m.x1,m.y1,m.x2,m.y2):this.type==="radial"&&(h=c.createRadialGradient(m.x1,m.y1,m.r1,m.x2,m.y2,m.r2)),g=0,d=this.colorStops.length;g<d;g++){var w=this.colorStops[g].color,E=this.colorStops[g].opacity,O=this.colorStops[g].offset;typeof E<"u"&&(w=new T.Color(w).setAlpha(E).toRgba()),h.addColorStop(O,w)}return h}}}),T.util.object.extend(T.Gradient,{fromElement:function(c,h,m,g){var d=parseFloat(m)/(/%$/.test(m)?100:1);d=d<0?0:d>1?1:d,isNaN(d)&&(d=1);var w=c.getElementsByTagName("stop"),E,O=c.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage",L=c.getAttribute("gradientTransform")||"",V=[],$,ne,xe=0,ze=0,Ke;for(c.nodeName==="linearGradient"||c.nodeName==="LINEARGRADIENT"?(E="linear",$=p(c)):(E="radial",$=C(c)),ne=w.length;ne--;)V.push(s(w[ne],d));Ke=T.parseTransformAttribute(L),l(h,$,g,O),O==="pixels"&&(xe=-h.left,ze=-h.top);var Je=new T.Gradient({id:c.getAttribute("id"),type:E,coords:$,colorStops:V,gradientUnits:O,gradientTransform:Ke,offsetX:xe,offsetY:ze});return Je}});function l(c,h,m,g){var d,w;Object.keys(h).forEach(function(E){d=h[E],d==="Infinity"?w=1:d==="-Infinity"?w=0:(w=parseFloat(h[E],10),typeof d=="string"&&/^(\d+\.\d+)%|(\d+)%$/.test(d)&&(w*=.01,g==="pixels"&&((E==="x1"||E==="x2"||E==="r2")&&(w*=m.viewBoxWidth||m.width),(E==="y1"||E==="y2")&&(w*=m.viewBoxHeight||m.height)))),h[E]=w})}}(),function(){var s=T.util.toFixed;T.Pattern=T.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(p,C){if(p||(p={}),this.id=T.Object.__uid++,this.setOptions(p),!p.source||p.source&&typeof p.source!="string"){C&&C(this);return}else{var b=this;this.source=T.util.createImage(),T.util.loadImage(p.source,function(l,c){b.source=l,C&&C(b,c)},null,this.crossOrigin)}},toObject:function(p){var C=T.Object.NUM_FRACTION_DIGITS,b,l;return typeof this.source.src=="string"?b=this.source.src:typeof this.source=="object"&&this.source.toDataURL&&(b=this.source.toDataURL()),l={type:"pattern",source:b,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:s(this.offsetX,C),offsetY:s(this.offsetY,C),patternTransform:this.patternTransform?this.patternTransform.concat():null},T.util.populateWithProperties(this,l,p),l},toSVG:function(p){var C=typeof this.source=="function"?this.source():this.source,b=C.width/p.width,l=C.height/p.height,c=this.offsetX/p.width,h=this.offsetY/p.height,m="";return(this.repeat==="repeat-x"||this.repeat==="no-repeat")&&(l=1,h&&(l+=Math.abs(h))),(this.repeat==="repeat-y"||this.repeat==="no-repeat")&&(b=1,c&&(b+=Math.abs(c))),C.src?m=C.src:C.toDataURL&&(m=C.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+c+'" y="'+h+'" width="'+b+'" height="'+l+`">
<image x="0" y="0" width="`+C.width+'" height="'+C.height+'" xlink:href="'+m+`"></image>
</pattern>
`},setOptions:function(p){for(var C in p)this[C]=p[C]},toLive:function(p){var C=this.source;return!C||typeof C.src<"u"&&(!C.complete||C.naturalWidth===0||C.naturalHeight===0)?"":p.createPattern(C,this.repeat)}})}(),function(s){var p=s.fabric||(s.fabric={}),C=p.util.toFixed;if(p.Shadow){p.warn("fabric.Shadow is already defined.");return}p.Shadow=p.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(b){typeof b=="string"&&(b=this._parseShadow(b));for(var l in b)this[l]=b[l];this.id=p.Object.__uid++},_parseShadow:function(b){var l=b.trim(),c=p.Shadow.reOffsetsAndBlur.exec(l)||[],h=l.replace(p.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)";return{color:h.trim(),offsetX:parseFloat(c[1],10)||0,offsetY:parseFloat(c[2],10)||0,blur:parseFloat(c[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(b){var l=40,c=40,h=p.Object.NUM_FRACTION_DIGITS,m=p.util.rotateVector({x:this.offsetX,y:this.offsetY},p.util.degreesToRadians(-b.angle)),g=20,d=new p.Color(this.color);return b.width&&b.height&&(l=C((Math.abs(m.x)+this.blur)/b.width,h)*100+g,c=C((Math.abs(m.y)+this.blur)/b.height,h)*100+g),b.flipX&&(m.x*=-1),b.flipY&&(m.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+c+'%" height="'+(100+2*c)+'%" x="-'+l+'%" width="'+(100+2*l)+`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`+C(this.blur?this.blur/2:0,h)+`"></feGaussianBlur>
	<feOffset dx="`+C(m.x,h)+'" dy="'+C(m.y,h)+`" result="oBlur" ></feOffset>
	<feFlood flood-color="`+d.toRgb()+'" flood-opacity="'+d.getAlpha()+`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var b={},l=p.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(c){this[c]!==l[c]&&(b[c]=this[c])},this),b}}),p.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/}(Y),function(){if(T.StaticCanvas){T.warn("fabric.StaticCanvas is already defined.");return}var s=T.util.object.extend,p=T.util.getElementOffset,C=T.util.removeFromArray,b=T.util.toFixed,l=T.util.transformPoint,c=T.util.invertTransform,h=T.util.getNodeCanvas,m=T.util.createCanvasElement,g=new Error("Could not initialize `canvas` element");T.StaticCanvas=T.util.createClass(T.CommonMethods,{initialize:function(d,w){w||(w={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(d,w)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:T.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(d,w){var E=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(d),this._initOptions(w),this.interactive||this._initRetinaScaling(),w.overlayImage&&this.setOverlayImage(w.overlayImage,E),w.backgroundImage&&this.setBackgroundImage(w.backgroundImage,E),w.backgroundColor&&this.setBackgroundColor(w.backgroundColor,E),w.overlayColor&&this.setOverlayColor(w.overlayColor,E),this.calcOffset()},_isRetinaScaling:function(){return T.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,T.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var d=T.devicePixelRatio;this.__initRetinaScaling(d,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(d,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(d,w,E){w.setAttribute("width",this.width*d),w.setAttribute("height",this.height*d),E.scale(d,d)},calcOffset:function(){return this._offset=p(this.lowerCanvasEl),this},setOverlayImage:function(d,w,E){return this.__setBgOverlayImage("overlayImage",d,w,E)},setBackgroundImage:function(d,w,E){return this.__setBgOverlayImage("backgroundImage",d,w,E)},setOverlayColor:function(d,w){return this.__setBgOverlayColor("overlayColor",d,w)},setBackgroundColor:function(d,w){return this.__setBgOverlayColor("backgroundColor",d,w)},__setBgOverlayImage:function(d,w,E,O){return typeof w=="string"?T.util.loadImage(w,function(L,V){if(L){var $=new T.Image(L,O);this[d]=$,$.canvas=this}E&&E(L,V)},this,O&&O.crossOrigin):(O&&w.setOptions(O),this[d]=w,w&&(w.canvas=this),E&&E(w,!1)),this},__setBgOverlayColor:function(d,w,E){return this[d]=w,this._initGradient(w,d),this._initPattern(w,d,E),this},_createCanvasElement:function(){var d=m();if(!d||(d.style||(d.style={}),typeof d.getContext>"u"))throw g;return d},_initOptions:function(d){var w=this.lowerCanvasEl;this._setOptions(d),this.width=this.width||parseInt(w.width,10)||0,this.height=this.height||parseInt(w.height,10)||0,this.lowerCanvasEl.style&&(w.width=this.width,w.height=this.height,w.style.width=this.width+"px",w.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(d){d&&d.getContext?this.lowerCanvasEl=d:this.lowerCanvasEl=T.util.getById(d)||this._createCanvasElement(),T.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(d,w){return this.setDimensions({width:d},w)},setHeight:function(d,w){return this.setDimensions({height:d},w)},setDimensions:function(d,w){var E;w=w||{};for(var O in d)E=d[O],w.cssOnly||(this._setBackstoreDimension(O,d[O]),E+="px",this.hasLostContext=!0),w.backstoreOnly||this._setCssDimension(O,E);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),w.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(d,w){return this.lowerCanvasEl[d]=w,this.upperCanvasEl&&(this.upperCanvasEl[d]=w),this.cacheCanvasEl&&(this.cacheCanvasEl[d]=w),this[d]=w,this},_setCssDimension:function(d,w){return this.lowerCanvasEl.style[d]=w,this.upperCanvasEl&&(this.upperCanvasEl.style[d]=w),this.wrapperEl&&(this.wrapperEl.style[d]=w),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(d){var w=this._activeObject,E=this.backgroundImage,O=this.overlayImage,L,V,$;for(this.viewportTransform=d,V=0,$=this._objects.length;V<$;V++)L=this._objects[V],L.group||L.setCoords(!0);return w&&w.setCoords(),E&&E.setCoords(!0),O&&O.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(d,w){var E=d,O=this.viewportTransform.slice(0);d=l(d,c(this.viewportTransform)),O[0]=w,O[3]=w;var L=l(d,O);return O[4]+=E.x-L.x,O[5]+=E.y-L.y,this.setViewportTransform(O)},setZoom:function(d){return this.zoomToPoint(new T.Point(0,0),d),this},absolutePan:function(d){var w=this.viewportTransform.slice(0);return w[4]=-d.x,w[5]=-d.y,this.setViewportTransform(w)},relativePan:function(d){return this.absolutePan(new T.Point(-d.x-this.viewportTransform[4],-d.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(d){this.stateful&&d.setupState(),d._set("canvas",this),d.setCoords(),this.fire("object:added",{target:d}),d.fire("added")},_onObjectRemoved:function(d){this.fire("object:removed",{target:d}),d.fire("removed"),delete d.canvas},clearContext:function(d){return d.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var d=this.contextContainer;return this.renderCanvas(d,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=T.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var d={},w=this.width,E=this.height,O=c(this.viewportTransform);return d.tl=l({x:0,y:0},O),d.br=l({x:w,y:E},O),d.tr=new T.Point(d.br.x,d.tl.y),d.bl=new T.Point(d.tl.x,d.br.y),this.vptCoords=d,d},cancelRequestedRender:function(){this.isRendering&&(T.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(d,w){var E=this.viewportTransform,O=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(d),T.util.setImageSmoothing(d,this.imageSmoothingEnabled),this.fire("before:render",{ctx:d}),this._renderBackground(d),d.save(),d.transform(E[0],E[1],E[2],E[3],E[4],E[5]),this._renderObjects(d,w),d.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(d),O&&(O.canvas=this,O.shouldCache(),O._transformDone=!0,O.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(d)),this._renderOverlay(d),this.controlsAboveOverlay&&this.interactive&&this.drawControls(d),this.fire("after:render",{ctx:d})},drawClipPathOnCanvas:function(d){var w=this.viewportTransform,E=this.clipPath;d.save(),d.transform(w[0],w[1],w[2],w[3],w[4],w[5]),d.globalCompositeOperation="destination-in",E.transform(d),d.scale(1/E.zoomX,1/E.zoomY),d.drawImage(E._cacheCanvas,-E.cacheTranslationX,-E.cacheTranslationY),d.restore()},_renderObjects:function(d,w){var E,O;for(E=0,O=w.length;E<O;++E)w[E]&&w[E].render(d)},_renderBackgroundOrOverlay:function(d,w){var E=this[w+"Color"],O=this[w+"Image"],L=this.viewportTransform,V=this[w+"Vpt"];if(!(!E&&!O)){if(E){d.save(),d.beginPath(),d.moveTo(0,0),d.lineTo(this.width,0),d.lineTo(this.width,this.height),d.lineTo(0,this.height),d.closePath(),d.fillStyle=E.toLive?E.toLive(d,this):E,V&&d.transform(L[0],L[1],L[2],L[3],L[4],L[5]),d.transform(1,0,0,1,E.offsetX||0,E.offsetY||0);var $=E.gradientTransform||E.patternTransform;$&&d.transform($[0],$[1],$[2],$[3],$[4],$[5]),d.fill(),d.restore()}O&&(d.save(),V&&d.transform(L[0],L[1],L[2],L[3],L[4],L[5]),O.render(d),d.restore())}},_renderBackground:function(d){this._renderBackgroundOrOverlay(d,"background")},_renderOverlay:function(d){this._renderBackgroundOrOverlay(d,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new T.Point(this.width/2,this.height/2)},centerObjectH:function(d){return this._centerObject(d,new T.Point(this.getCenterPoint().x,d.getCenterPoint().y))},centerObjectV:function(d){return this._centerObject(d,new T.Point(d.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(d){var w=this.getCenterPoint();return this._centerObject(d,w)},viewportCenterObject:function(d){var w=this.getVpCenter();return this._centerObject(d,w)},viewportCenterObjectH:function(d){var w=this.getVpCenter();return this._centerObject(d,new T.Point(w.x,d.getCenterPoint().y)),this},viewportCenterObjectV:function(d){var w=this.getVpCenter();return this._centerObject(d,new T.Point(d.getCenterPoint().x,w.y))},getVpCenter:function(){var d=this.getCenterPoint(),w=c(this.viewportTransform);return l(d,w)},_centerObject:function(d,w){return d.setPositionByOrigin(w,"center","center"),d.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(d){return this.toDatalessObject(d)},toObject:function(d){return this._toObjectMethod("toObject",d)},toDatalessObject:function(d){return this._toObjectMethod("toDatalessObject",d)},_toObjectMethod:function(d,w){var E=this.clipPath,O={version:T.version,objects:this._toObjects(d,w)};return E&&!E.excludeFromExport&&(O.clipPath=this._toObject(this.clipPath,d,w)),s(O,this.__serializeBgOverlay(d,w)),T.util.populateWithProperties(this,O,w),O},_toObjects:function(d,w){return this._objects.filter(function(E){return!E.excludeFromExport}).map(function(E){return this._toObject(E,d,w)},this)},_toObject:function(d,w,E){var O;this.includeDefaultValues||(O=d.includeDefaultValues,d.includeDefaultValues=!1);var L=d[w](E);return this.includeDefaultValues||(d.includeDefaultValues=O),L},__serializeBgOverlay:function(d,w){var E={},O=this.backgroundImage,L=this.overlayImage,V=this.backgroundColor,$=this.overlayColor;return V&&V.toObject?V.excludeFromExport||(E.background=V.toObject(w)):V&&(E.background=V),$&&$.toObject?$.excludeFromExport||(E.overlay=$.toObject(w)):$&&(E.overlay=$),O&&!O.excludeFromExport&&(E.backgroundImage=this._toObject(O,d,w)),L&&!L.excludeFromExport&&(E.overlayImage=this._toObject(L,d,w)),E},svgViewportTransformation:!0,toSVG:function(d,w){d||(d={}),d.reviver=w;var E=[];return this._setSVGPreamble(E,d),this._setSVGHeader(E,d),this.clipPath&&E.push('<g clip-path="url(#'+this.clipPath.clipPathId+`)" >
`),this._setSVGBgOverlayColor(E,"background"),this._setSVGBgOverlayImage(E,"backgroundImage",w),this._setSVGObjects(E,w),this.clipPath&&E.push(`</g>
`),this._setSVGBgOverlayColor(E,"overlay"),this._setSVGBgOverlayImage(E,"overlayImage",w),E.push("</svg>"),E.join("")},_setSVGPreamble:function(d,w){w.suppressPreamble||d.push('<?xml version="1.0" encoding="',w.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)},_setSVGHeader:function(d,w){var E=w.width||this.width,O=w.height||this.height,L,V='viewBox="0 0 '+this.width+" "+this.height+'" ',$=T.Object.NUM_FRACTION_DIGITS;w.viewBox?V='viewBox="'+w.viewBox.x+" "+w.viewBox.y+" "+w.viewBox.width+" "+w.viewBox.height+'" ':this.svgViewportTransformation&&(L=this.viewportTransform,V='viewBox="'+b(-L[4]/L[0],$)+" "+b(-L[5]/L[3],$)+" "+b(this.width/L[0],$)+" "+b(this.height/L[3],$)+'" '),d.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',E,'" ','height="',O,'" ',V,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",T.version,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(w),`</defs>
`)},createSVGClipPathMarkup:function(d){var w=this.clipPath;return w?(w.clipPathId="CLIPPATH_"+T.Object.__uid++,'<clipPath id="'+w.clipPathId+`" >
`+this.clipPath.toClipPathSVG(d.reviver)+`</clipPath>
`):""},createSVGRefElementsMarkup:function(){var d=this,w=["background","overlay"].map(function(E){var O=d[E+"Color"];if(O&&O.toLive){var L=d[E+"Vpt"],V=d.viewportTransform,$={width:d.width/(L?V[0]:1),height:d.height/(L?V[3]:1)};return O.toSVG($,{additionalTransform:L?T.util.matrixToSVG(V):""})}});return w.join("")},createSVGFontFacesMarkup:function(){var d="",w={},E,O,L,V,$,ne,xe,ze,Ke,Je=T.fontPaths,tt=[];for(this._objects.forEach(function nt(_t){tt.push(_t),_t._objects&&_t._objects.forEach(nt)}),ze=0,Ke=tt.length;ze<Ke;ze++)if(E=tt[ze],O=E.fontFamily,!(E.type.indexOf("text")===-1||w[O]||!Je[O])&&(w[O]=!0,!!E.styles)){L=E.styles;for($ in L){V=L[$];for(xe in V)ne=V[xe],O=ne.fontFamily,!w[O]&&Je[O]&&(w[O]=!0)}}for(var ht in w)d+=[`		@font-face {
`,"			font-family: '",ht,`';
`,"			src: url('",Je[ht],`');
`,`		}
`].join("");return d&&(d=['	<style type="text/css">',`<![CDATA[
`,d,"]]>",`</style>
`].join("")),d},_setSVGObjects:function(d,w){var E,O,L,V=this._objects;for(O=0,L=V.length;O<L;O++)E=V[O],!E.excludeFromExport&&this._setSVGObject(d,E,w)},_setSVGObject:function(d,w,E){d.push(w.toSVG(E))},_setSVGBgOverlayImage:function(d,w,E){this[w]&&!this[w].excludeFromExport&&this[w].toSVG&&d.push(this[w].toSVG(E))},_setSVGBgOverlayColor:function(d,w){var E=this[w+"Color"],O=this.viewportTransform,L=this.width,V=this.height;if(E)if(E.toLive){var $=E.repeat,ne=T.util.invertTransform(O),xe=this[w+"Vpt"],ze=xe?T.util.matrixToSVG(ne):"";d.push('<rect transform="'+ze+" translate(",L/2,",",V/2,')"',' x="',E.offsetX-L/2,'" y="',E.offsetY-V/2,'" ','width="',$==="repeat-y"||$==="no-repeat"?E.source.width:L,'" height="',$==="repeat-x"||$==="no-repeat"?E.source.height:V,'" fill="url(#SVGID_'+E.id+')"',`></rect>
`)}else d.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',E,'"',`></rect>
`)},sendToBack:function(d){if(!d)return this;var w=this._activeObject,E,O,L;if(d===w&&d.type==="activeSelection")for(L=w._objects,E=L.length;E--;)O=L[E],C(this._objects,O),this._objects.unshift(O);else C(this._objects,d),this._objects.unshift(d);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(d){if(!d)return this;var w=this._activeObject,E,O,L;if(d===w&&d.type==="activeSelection")for(L=w._objects,E=0;E<L.length;E++)O=L[E],C(this._objects,O),this._objects.push(O);else C(this._objects,d),this._objects.push(d);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(d,w){if(!d)return this;var E=this._activeObject,O,L,V,$,ne,xe=0;if(d===E&&d.type==="activeSelection")for(ne=E._objects,O=0;O<ne.length;O++)L=ne[O],V=this._objects.indexOf(L),V>0+xe&&($=V-1,C(this._objects,L),this._objects.splice($,0,L)),xe++;else V=this._objects.indexOf(d),V!==0&&($=this._findNewLowerIndex(d,V,w),C(this._objects,d),this._objects.splice($,0,d));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(d,w,E){var O,L;if(E)for(O=w,L=w-1;L>=0;--L){var V=d.intersectsWithObject(this._objects[L])||d.isContainedWithinObject(this._objects[L])||this._objects[L].isContainedWithinObject(d);if(V){O=L;break}}else O=w-1;return O},bringForward:function(d,w){if(!d)return this;var E=this._activeObject,O,L,V,$,ne,xe=0;if(d===E&&d.type==="activeSelection")for(ne=E._objects,O=ne.length;O--;)L=ne[O],V=this._objects.indexOf(L),V<this._objects.length-1-xe&&($=V+1,C(this._objects,L),this._objects.splice($,0,L)),xe++;else V=this._objects.indexOf(d),V!==this._objects.length-1&&($=this._findNewUpperIndex(d,V,w),C(this._objects,d),this._objects.splice($,0,d));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(d,w,E){var O,L,V;if(E)for(O=w,L=w+1,V=this._objects.length;L<V;++L){var $=d.intersectsWithObject(this._objects[L])||d.isContainedWithinObject(this._objects[L])||this._objects[L].isContainedWithinObject(d);if($){O=L;break}}else O=w+1;return O},moveTo:function(d,w){return C(this._objects,d),this._objects.splice(w,0,d),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(T.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(d){d.dispose&&d.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),T.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),T.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),s(T.StaticCanvas.prototype,T.Observable),s(T.StaticCanvas.prototype,T.Collection),s(T.StaticCanvas.prototype,T.DataURLExporter),s(T.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(d){var w=m();if(!w||!w.getContext)return null;var E=w.getContext("2d");if(!E)return null;switch(d){case"setLineDash":return typeof E.setLineDash<"u";default:return null}}}),T.StaticCanvas.prototype.toJSON=T.StaticCanvas.prototype.toObject,T.isLikelyNode&&(T.StaticCanvas.prototype.createPNGStream=function(){var d=h(this.lowerCanvasEl);return d&&d.createPNGStream()},T.StaticCanvas.prototype.createJPEGStream=function(d){var w=h(this.lowerCanvasEl);return w&&w.createJPEGStream(d)})}(),T.BaseBrush=T.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(s){s.strokeStyle=this.color,s.lineWidth=this.width,s.lineCap=this.strokeLineCap,s.miterLimit=this.strokeMiterLimit,s.lineJoin=this.strokeLineJoin,s.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(s){var p=this.canvas.viewportTransform;s.save(),s.transform(p[0],p[1],p[2],p[3],p[4],p[5])},_setShadow:function(){if(this.shadow){var s=this.canvas,p=this.shadow,C=s.contextTop,b=s.getZoom();s&&s._isRetinaScaling()&&(b*=T.devicePixelRatio),C.shadowColor=p.color,C.shadowBlur=p.blur*b,C.shadowOffsetX=p.offsetX*b,C.shadowOffsetY=p.offsetY*b}},needsFullRender:function(){var s=new T.Color(this.color);return s.getAlpha()<1||!!this.shadow},_resetShadow:function(){var s=this.canvas.contextTop;s.shadowColor="",s.shadowBlur=s.shadowOffsetX=s.shadowOffsetY=0},_isOutSideCanvas:function(s){return s.x<0||s.x>this.canvas.getWidth()||s.y<0||s.y>this.canvas.getHeight()}}),function(){T.PencilBrush=T.util.createClass(T.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(s){this.canvas=s,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(s,p,C){var b=p.midPointFrom(C);return s.quadraticCurveTo(p.x,p.y,b.x,b.y),b},onMouseDown:function(s,p){this.canvas._isMainEvent(p.e)&&(this.drawStraightLine=p.e[this.straightLineKey],this._prepareForDrawing(s),this._captureDrawingPath(s),this._render())},onMouseMove:function(s,p){if(this.canvas._isMainEvent(p.e)&&(this.drawStraightLine=p.e[this.straightLineKey],!(this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s))&&this._captureDrawingPath(s)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var C=this._points,b=C.length,l=this.canvas.contextTop;this._saveAndTransform(l),this.oldEnd&&(l.beginPath(),l.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(l,C[b-2],C[b-1],!0),l.stroke(),l.restore()}},onMouseUp:function(s){return this.canvas._isMainEvent(s.e)?(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1):!0},_prepareForDrawing:function(s){var p=new T.Point(s.x,s.y);this._reset(),this._addPoint(p),this.canvas.contextTop.moveTo(p.x,p.y)},_addPoint:function(s){return this._points.length>1&&s.eq(this._points[this._points.length-1])?!1:(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(s),!0)},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(s){var p=new T.Point(s.x,s.y);return this._addPoint(p)},_render:function(s){var p,C,b=this._points[0],l=this._points[1];if(s=s||this.canvas.contextTop,this._saveAndTransform(s),s.beginPath(),this._points.length===2&&b.x===l.x&&b.y===l.y){var c=this.width/1e3;b=new T.Point(b.x,b.y),l=new T.Point(l.x,l.y),b.x-=c,l.x+=c}for(s.moveTo(b.x,b.y),p=1,C=this._points.length;p<C;p++)this._drawSegment(s,b,l),b=this._points[p],l=this._points[p+1];s.lineTo(b.x,b.y),s.stroke(),s.restore()},convertPointsToSVGPath:function(s){var p=this.width/1e3;return T.util.getSmoothPathFromPoints(s,p)},_isEmptySVGPath:function(s){var p=T.util.joinPath(s);return p==="M 0 0 Q 0 0 0 0 L 0 0"},createPath:function(s){var p=new T.Path(s,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,p.shadow=new T.Shadow(this.shadow)),p},decimatePoints:function(s,p){if(s.length<=2)return s;var C=this.canvas.getZoom(),b=Math.pow(p/C,2),l,c=s.length-1,h=s[0],m=[h],g;for(l=1;l<c-1;l++)g=Math.pow(h.x-s[l].x,2)+Math.pow(h.y-s[l].y,2),g>=b&&(h=s[l],m.push(h));return m.push(s[c]),m},_finalizeAndAddPath:function(){var s=this.canvas.contextTop;s.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var p=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(p)){this.canvas.requestRenderAll();return}var C=this.createPath(p);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:C}),this.canvas.add(C),this.canvas.requestRenderAll(),C.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:C})}})}(),T.CircleBrush=T.util.createClass(T.BaseBrush,{width:10,initialize:function(s){this.canvas=s,this.points=[]},drawDot:function(s){var p=this.addPoint(s),C=this.canvas.contextTop;this._saveAndTransform(C),this.dot(C,p),C.restore()},dot:function(s,p){s.fillStyle=p.fill,s.beginPath(),s.arc(p.x,p.y,p.radius,0,Math.PI*2,!1),s.closePath(),s.fill()},onMouseDown:function(s){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(s)},_render:function(){var s=this.canvas.contextTop,p,C,b=this.points;for(this._saveAndTransform(s),p=0,C=b.length;p<C;p++)this.dot(s,b[p]);s.restore()},onMouseMove:function(s){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(s),this._render()):this.drawDot(s))},onMouseUp:function(){var s=this.canvas.renderOnAddRemove,p,C;this.canvas.renderOnAddRemove=!1;var b=[];for(p=0,C=this.points.length;p<C;p++){var l=this.points[p],c=new T.Circle({radius:l.radius,left:l.x,top:l.y,originX:"center",originY:"center",fill:l.fill});this.shadow&&(c.shadow=new T.Shadow(this.shadow)),b.push(c)}var h=new T.Group(b);h.canvas=this.canvas,this.canvas.fire("before:path:created",{path:h}),this.canvas.add(h),this.canvas.fire("path:created",{path:h}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=s,this.canvas.requestRenderAll()},addPoint:function(s){var p=new T.Point(s.x,s.y),C=T.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,b=new T.Color(this.color).setAlpha(T.util.getRandomInt(0,100)/100).toRgba();return p.radius=C,p.fill=b,this.points.push(p),p}}),T.SprayBrush=T.util.createClass(T.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(s){this.canvas=s,this.sprayChunks=[]},onMouseDown:function(s){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(s),this.render(this.sprayChunkPoints)},onMouseMove:function(s){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s)||(this.addSprayChunk(s),this.render(this.sprayChunkPoints))},onMouseUp:function(){var s=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var p=[],C=0,b=this.sprayChunks.length;C<b;C++)for(var l=this.sprayChunks[C],c=0,h=l.length;c<h;c++){var m=new T.Rect({width:l[c].width,height:l[c].width,left:l[c].x+1,top:l[c].y+1,originX:"center",originY:"center",fill:this.color});p.push(m)}this.optimizeOverlapping&&(p=this._getOptimizedRects(p));var g=new T.Group(p);this.shadow&&g.set("shadow",new T.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:g}),this.canvas.add(g),this.canvas.fire("path:created",{path:g}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=s,this.canvas.requestRenderAll()},_getOptimizedRects:function(s){var p={},C,b,l;for(b=0,l=s.length;b<l;b++)C=s[b].left+""+s[b].top,p[C]||(p[C]=s[b]);var c=[];for(C in p)c.push(p[C]);return c},render:function(s){var p=this.canvas.contextTop,C,b;for(p.fillStyle=this.color,this._saveAndTransform(p),C=0,b=s.length;C<b;C++){var l=s[C];typeof l.opacity<"u"&&(p.globalAlpha=l.opacity),p.fillRect(l.x,l.y,l.width,l.width)}p.restore()},_render:function(){var s=this.canvas.contextTop,p,C;for(s.fillStyle=this.color,this._saveAndTransform(s),p=0,C=this.sprayChunks.length;p<C;p++)this.render(this.sprayChunks[p]);s.restore()},addSprayChunk:function(s){this.sprayChunkPoints=[];var p,C,b,l=this.width/2,c;for(c=0;c<this.density;c++){p=T.util.getRandomInt(s.x-l,s.x+l),C=T.util.getRandomInt(s.y-l,s.y+l),this.dotWidthVariance?b=T.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):b=this.dotWidth;var h=new T.Point(p,C);h.width=b,this.randomOpacity&&(h.opacity=T.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(h)}this.sprayChunks.push(this.sprayChunkPoints)}}),T.PatternBrush=T.util.createClass(T.PencilBrush,{getPatternSrc:function(){var s=20,p=5,C=T.util.createCanvasElement(),b=C.getContext("2d");return C.width=C.height=s+p,b.fillStyle=this.color,b.beginPath(),b.arc(s/2,s/2,s/2,0,Math.PI*2,!1),b.closePath(),b.fill(),C},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(s){return s.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(s){this.callSuper("_setBrushStyles",s),s.strokeStyle=this.getPattern(s)},createPath:function(s){var p=this.callSuper("createPath",s),C=p._getLeftTopCoords().scalarAdd(p.strokeWidth/2);return p.stroke=new T.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-C.x,offsetY:-C.y}),p}}),function(){var s=T.util.getPointer,p=T.util.degreesToRadians,C=T.util.isTouchEvent;T.Canvas=T.util.createClass(T.StaticCanvas,{initialize:function(l,c){c||(c={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(l,c),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=T.PencilBrush&&new T.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var l=this.getActiveObjects(),c,h,m;if(l.length>0&&!this.preserveObjectStacking){h=[],m=[];for(var g=0,d=this._objects.length;g<d;g++)c=this._objects[g],l.indexOf(c)===-1?h.push(c):m.push(c);l.length>1&&(this._activeObject._objects=m),h.push.apply(h,m)}else h=this._objects;return h},renderAll:function(){this.contextTopDirty&&!this._groupSelector&&!this.isDrawingMode&&(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var l=this.contextContainer;return this.renderCanvas(l,this._chooseObjectsToRender()),this},renderTopLayer:function(l){l.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(l),this.contextTopDirty=!0),l.restore()},renderTop:function(){var l=this.contextTop;return this.clearContext(l),this.renderTopLayer(l),this.fire("after:render"),this},_normalizePointer:function(l,c){var h=l.calcTransformMatrix(),m=T.util.invertTransform(h),g=this.restorePointerVpt(c);return T.util.transformPoint(g,m)},isTargetTransparent:function(l,c,h){if(l.shouldCache()&&l._cacheCanvas&&l!==this._activeObject){var m=this._normalizePointer(l,{x:c,y:h}),g=Math.max(l.cacheTranslationX+m.x*l.zoomX,0),d=Math.max(l.cacheTranslationY+m.y*l.zoomY,0),L=T.util.isTransparent(l._cacheContext,Math.round(g),Math.round(d),this.targetFindTolerance);return L}var w=this.contextCache,E=l.selectionBackgroundColor,O=this.viewportTransform;l.selectionBackgroundColor="",this.clearContext(w),w.save(),w.transform(O[0],O[1],O[2],O[3],O[4],O[5]),l.render(w),w.restore(),l.selectionBackgroundColor=E;var L=T.util.isTransparent(w,c,h,this.targetFindTolerance);return L},_isSelectionKeyPressed:function(l){var c=!1;return Array.isArray(this.selectionKey)?c=!!this.selectionKey.find(function(h){return l[h]===!0}):c=l[this.selectionKey],c},_shouldClearSelection:function(l,c){var h=this.getActiveObjects(),m=this._activeObject;return!c||c&&m&&h.length>1&&h.indexOf(c)===-1&&m!==c&&!this._isSelectionKeyPressed(l)||c&&!c.evented||c&&!c.selectable&&m&&m!==c},_shouldCenterTransform:function(l,c,h){if(l){var m;return c==="scale"||c==="scaleX"||c==="scaleY"||c==="resizing"?m=this.centeredScaling||l.centeredScaling:c==="rotate"&&(m=this.centeredRotation||l.centeredRotation),m?!h:h}},_getOriginFromCorner:function(l,c){var h={x:l.originX,y:l.originY};return c==="ml"||c==="tl"||c==="bl"?h.x="right":(c==="mr"||c==="tr"||c==="br")&&(h.x="left"),c==="tl"||c==="mt"||c==="tr"?h.y="bottom":(c==="bl"||c==="mb"||c==="br")&&(h.y="top"),h},_getActionFromCorner:function(l,c,h,m){if(!c||!l)return"drag";var g=m.controls[c];return g.getActionName(h,g,m)},_setupCurrentTransform:function(l,c,h){if(c){var m=this.getPointer(l),g=c.__corner,d=c.controls[g],w=h&&g?d.getActionHandler(l,c,d):T.controlsUtils.dragHandler,E=this._getActionFromCorner(h,g,l,c),O=this._getOriginFromCorner(c,g),L=l[this.centeredKey],V={target:c,action:E,actionHandler:w,corner:g,scaleX:c.scaleX,scaleY:c.scaleY,skewX:c.skewX,skewY:c.skewY,offsetX:m.x-c.left,offsetY:m.y-c.top,originX:O.x,originY:O.y,ex:m.x,ey:m.y,lastX:m.x,lastY:m.y,theta:p(c.angle),width:c.width*c.scaleX,shiftKey:l.shiftKey,altKey:L,original:T.util.saveObjectTransform(c)};this._shouldCenterTransform(c,E,L)&&(V.originX="center",V.originY="center"),V.original.originX=O.x,V.original.originY=O.y,this._currentTransform=V,this._beforeTransform(l)}},setCursor:function(l){this.upperCanvasEl.style.cursor=l},_drawSelection:function(l){var c=this._groupSelector,h=new T.Point(c.ex,c.ey),m=T.util.transformPoint(h,this.viewportTransform),g=new T.Point(c.ex+c.left,c.ey+c.top),d=T.util.transformPoint(g,this.viewportTransform),w=Math.min(m.x,d.x),E=Math.min(m.y,d.y),O=Math.max(m.x,d.x),L=Math.max(m.y,d.y),V=this.selectionLineWidth/2;this.selectionColor&&(l.fillStyle=this.selectionColor,l.fillRect(w,E,O-w,L-E)),!(!this.selectionLineWidth||!this.selectionBorderColor)&&(l.lineWidth=this.selectionLineWidth,l.strokeStyle=this.selectionBorderColor,w+=V,E+=V,O-=V,L-=V,T.Object.prototype._setLineDash.call(this,l,this.selectionDashArray),l.strokeRect(w,E,O-w,L-E))},findTarget:function(l,c){if(!this.skipTargetFind){var h=!0,m=this.getPointer(l,h),g=this._activeObject,d=this.getActiveObjects(),w,E,O=C(l),L=d.length>1&&!c||d.length===1;if(this.targets=[],L&&g._findTargetCorner(m,O)||d.length>1&&!c&&g===this._searchPossibleTargets([g],m))return g;if(d.length===1&&g===this._searchPossibleTargets([g],m))if(this.preserveObjectStacking)w=g,E=this.targets,this.targets=[];else return g;var V=this._searchPossibleTargets(this._objects,m);return l[this.altSelectionKey]&&V&&w&&V!==w&&(V=w,this.targets=E),V}},_checkTarget:function(l,c,h){if(c&&c.visible&&c.evented&&c.containsPoint(l))if((this.perPixelTargetFind||c.perPixelTargetFind)&&!c.isEditing){var m=this.isTargetTransparent(c,h.x,h.y);if(!m)return!0}else return!0},_searchPossibleTargets:function(l,c){for(var h,m=l.length,g;m--;){var d=l[m],w=d.group?this._normalizePointer(d.group,c):c;if(this._checkTarget(w,d,c)){h=l[m],h.subTargetCheck&&h instanceof T.Group&&(g=this._searchPossibleTargets(h._objects,c),g&&this.targets.push(g));break}}return h},restorePointerVpt:function(l){return T.util.transformPoint(l,T.util.invertTransform(this.viewportTransform))},getPointer:function(l,c){if(this._absolutePointer&&!c)return this._absolutePointer;if(this._pointer&&c)return this._pointer;var h=s(l),m=this.upperCanvasEl,g=m.getBoundingClientRect(),d=g.width||0,w=g.height||0,E;(!d||!w)&&("top"in g&&"bottom"in g&&(w=Math.abs(g.top-g.bottom)),"right"in g&&"left"in g&&(d=Math.abs(g.right-g.left))),this.calcOffset(),h.x=h.x-this._offset.left,h.y=h.y-this._offset.top,c||(h=this.restorePointerVpt(h));var O=this.getRetinaScaling();return O!==1&&(h.x/=O,h.y/=O),d===0||w===0?E={width:1,height:1}:E={width:m.width/d,height:m.height/w},{x:h.x*E.width,y:h.y*E.height}},_createUpperCanvas:function(){var l=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),c=this.lowerCanvasEl,h=this.upperCanvasEl;h?h.className="":(h=this._createCanvasElement(),this.upperCanvasEl=h),T.util.addClass(h,"upper-canvas "+l),this.wrapperEl.appendChild(h),this._copyCanvasStyle(c,h),this._applyCanvasStyle(h),this.contextTop=h.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=T.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),T.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),T.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(l){var c=this.width||l.width,h=this.height||l.height;T.util.setStyle(l,{position:"absolute",width:c+"px",height:h+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),l.width=c,l.height=h,T.util.makeElementUnselectable(l)},_copyCanvasStyle:function(l,c){c.style.cssText=l.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var l=this._activeObject;return l?l.type==="activeSelection"&&l._objects?l._objects.slice(0):[l]:[]},_onObjectRemoved:function(l){l===this._activeObject&&(this.fire("before:selection:cleared",{target:l}),this._discardActiveObject(),this.fire("selection:cleared",{target:l}),l.fire("deselected")),l===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",l)},_fireSelectionEvents:function(l,c){var h=!1,m=this.getActiveObjects(),g=[],d=[];l.forEach(function(w){m.indexOf(w)===-1&&(h=!0,w.fire("deselected",{e:c,target:w}),d.push(w))}),m.forEach(function(w){l.indexOf(w)===-1&&(h=!0,w.fire("selected",{e:c,target:w}),g.push(w))}),l.length>0&&m.length>0?h&&this.fire("selection:updated",{e:c,selected:g,deselected:d}):m.length>0?this.fire("selection:created",{e:c,selected:g}):l.length>0&&this.fire("selection:cleared",{e:c,deselected:d})},setActiveObject:function(l,c){var h=this.getActiveObjects();return this._setActiveObject(l,c),this._fireSelectionEvents(h,c),this},_setActiveObject:function(l,c){return this._activeObject===l||!this._discardActiveObject(c,l)||l.onSelect({e:c})?!1:(this._activeObject=l,!0)},_discardActiveObject:function(l,c){var h=this._activeObject;if(h){if(h.onDeselect({e:l,object:c}))return!1;this._activeObject=null}return!0},discardActiveObject:function(l){var c=this.getActiveObjects(),h=this.getActiveObject();return c.length&&this.fire("before:selection:cleared",{target:h,e:l}),this._discardActiveObject(l),this._fireSelectionEvents(c,l),this},dispose:function(){var l=this.wrapperEl;return this.removeListeners(),l.removeChild(this.upperCanvasEl),l.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach((function(c){T.util.cleanUpJsdomNode(this[c]),this[c]=void 0}).bind(this)),l.parentNode&&l.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,T.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(l){var c=this._activeObject;c&&c._renderControls(l)},_toObject:function(l,c,h){var m=this._realizeGroupTransformOnObject(l),g=this.callSuper("_toObject",l,c,h);return this._unwindGroupTransformOnObject(l,m),g},_realizeGroupTransformOnObject:function(l){if(l.group&&l.group.type==="activeSelection"&&this._activeObject===l.group){var c=["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"],h={};return c.forEach(function(m){h[m]=l[m]}),T.util.addTransformToObject(l,this._activeObject.calcOwnMatrix()),h}else return null},_unwindGroupTransformOnObject:function(l,c){c&&l.set(c)},_setSVGObject:function(l,c,h){var m=this._realizeGroupTransformOnObject(c);this.callSuper("_setSVGObject",l,c,h),this._unwindGroupTransformOnObject(c,m)},setViewportTransform:function(l){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),T.StaticCanvas.prototype.setViewportTransform.call(this,l)}});for(var b in T.StaticCanvas)b!=="prototype"&&(T.Canvas[b]=T.StaticCanvas[b])}(),function(){var s=T.util.addListener,p=T.util.removeListener,C=3,b=2,l=1,c={passive:!1};function h(m,g){return m.button&&m.button===g-1}T.util.object.extend(T.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(s,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(m,g){var d=this.upperCanvasEl,w=this._getEventPrefix();m(T.window,"resize",this._onResize),m(d,w+"down",this._onMouseDown),m(d,w+"move",this._onMouseMove,c),m(d,w+"out",this._onMouseOut),m(d,w+"enter",this._onMouseEnter),m(d,"wheel",this._onMouseWheel),m(d,"contextmenu",this._onContextMenu),m(d,"dblclick",this._onDoubleClick),m(d,"dragover",this._onDragOver),m(d,"dragenter",this._onDragEnter),m(d,"dragleave",this._onDragLeave),m(d,"drop",this._onDrop),this.enablePointerEvents||m(d,"touchstart",this._onTouchStart,c),typeof eventjs<"u"&&g in eventjs&&(eventjs[g](d,"gesture",this._onGesture),eventjs[g](d,"drag",this._onDrag),eventjs[g](d,"orientation",this._onOrientationChange),eventjs[g](d,"shake",this._onShake),eventjs[g](d,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(p,"remove");var m=this._getEventPrefix();p(T.document,m+"up",this._onMouseUp),p(T.document,"touchend",this._onTouchEnd,c),p(T.document,m+"move",this._onMouseMove,c),p(T.document,"touchmove",this._onMouseMove,c)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(m,g){this.__onTransformGesture&&this.__onTransformGesture(m,g)},_onDrag:function(m,g){this.__onDrag&&this.__onDrag(m,g)},_onMouseWheel:function(m){this.__onMouseWheel(m)},_onMouseOut:function(m){var g=this._hoveredTarget;this.fire("mouse:out",{target:g,e:m}),this._hoveredTarget=null,g&&g.fire("mouseout",{e:m});var d=this;this._hoveredTargets.forEach(function(w){d.fire("mouse:out",{target:g,e:m}),w&&g.fire("mouseout",{e:m})}),this._hoveredTargets=[]},_onMouseEnter:function(m){!this._currentTransform&&!this.findTarget(m)&&(this.fire("mouse:over",{target:null,e:m}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(m,g){this.__onOrientationChange&&this.__onOrientationChange(m,g)},_onShake:function(m,g){this.__onShake&&this.__onShake(m,g)},_onLongPress:function(m,g){this.__onLongPress&&this.__onLongPress(m,g)},_onDragOver:function(m){m.preventDefault();var g=this._simpleEventHandler("dragover",m);this._fireEnterLeaveEvents(g,m)},_onDrop:function(m){return this._simpleEventHandler("drop:before",m),this._simpleEventHandler("drop",m)},_onContextMenu:function(m){return this.stopContextMenu&&(m.stopPropagation(),m.preventDefault()),!1},_onDoubleClick:function(m){this._cacheTransformEventData(m),this._handleEvent(m,"dblclick"),this._resetTransformEventData(m)},getPointerId:function(m){var g=m.changedTouches;return g?g[0]&&g[0].identifier:this.enablePointerEvents?m.pointerId:-1},_isMainEvent:function(m){return m.isPrimary===!0?!0:m.isPrimary===!1?!1:m.type==="touchend"&&m.touches.length===0?!0:m.changedTouches?m.changedTouches[0].identifier===this.mainTouchId:!0},_onTouchStart:function(m){m.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(m)),this.__onMouseDown(m),this._resetTransformEventData();var g=this.upperCanvasEl,d=this._getEventPrefix();s(T.document,"touchend",this._onTouchEnd,c),s(T.document,"touchmove",this._onMouseMove,c),p(g,d+"down",this._onMouseDown)},_onMouseDown:function(m){this.__onMouseDown(m),this._resetTransformEventData();var g=this.upperCanvasEl,d=this._getEventPrefix();p(g,d+"move",this._onMouseMove,c),s(T.document,d+"up",this._onMouseUp),s(T.document,d+"move",this._onMouseMove,c)},_onTouchEnd:function(m){if(!(m.touches.length>0)){this.__onMouseUp(m),this._resetTransformEventData(),this.mainTouchId=null;var g=this._getEventPrefix();p(T.document,"touchend",this._onTouchEnd,c),p(T.document,"touchmove",this._onMouseMove,c);var d=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){s(d.upperCanvasEl,g+"down",d._onMouseDown),d._willAddMouseDown=0},400)}},_onMouseUp:function(m){this.__onMouseUp(m),this._resetTransformEventData();var g=this.upperCanvasEl,d=this._getEventPrefix();this._isMainEvent(m)&&(p(T.document,d+"up",this._onMouseUp),p(T.document,d+"move",this._onMouseMove,c),s(g,d+"move",this._onMouseMove,c))},_onMouseMove:function(m){!this.allowTouchScrolling&&m.preventDefault&&m.preventDefault(),this.__onMouseMove(m)},_onResize:function(){this.calcOffset()},_shouldRender:function(m){var g=this._activeObject;return!!g!=!!m||g&&m&&g!==m?!0:(g&&g.isEditing,!1)},__onMouseUp:function(m){var g,d=this._currentTransform,w=this._groupSelector,E=!1,O=!w||w.left===0&&w.top===0;if(this._cacheTransformEventData(m),g=this._target,this._handleEvent(m,"up:before"),h(m,C)){this.fireRightClick&&this._handleEvent(m,"up",C,O);return}if(h(m,b)){this.fireMiddleClick&&this._handleEvent(m,"up",b,O),this._resetTransformEventData();return}if(this.isDrawingMode&&this._isCurrentlyDrawing){this._onMouseUpInDrawingMode(m);return}if(this._isMainEvent(m)){if(d&&(this._finalizeCurrentTransform(m),E=d.actionPerformed),!O){var L=g===this._activeObject;this._maybeGroupObjects(m),E||(E=this._shouldRender(g)||!L&&g===this._activeObject)}var V,$;if(g){if(V=g._findTargetCorner(this.getPointer(m,!0),T.util.isTouchEvent(m)),g.selectable&&g!==this._activeObject&&g.activeOn==="up")this.setActiveObject(g,m),E=!0;else{var ne=g.controls[V],xe=ne&&ne.getMouseUpHandler(m,g,ne);xe&&($=this.getPointer(m),xe(m,d,$.x,$.y))}g.isMoving=!1}if(d&&(d.target!==g||d.corner!==V)){var ze=d.target&&d.target.controls[d.corner],Ke=ze&&ze.getMouseUpHandler(m,g,ne);$=$||this.getPointer(m),Ke&&Ke(m,d,$.x,$.y)}this._setCursorFromEvent(m,g),this._handleEvent(m,"up",l,O),this._groupSelector=null,this._currentTransform=null,g&&(g.__corner=0),E?this.requestRenderAll():O||this.renderTop()}},_simpleEventHandler:function(m,g){var d=this.findTarget(g),w=this.targets,E={e:g,target:d,subTargets:w};if(this.fire(m,E),d&&d.fire(m,E),!w)return d;for(var O=0;O<w.length;O++)w[O].fire(m,E);return d},_handleEvent:function(m,g,d,w){var E=this._target,O=this.targets||[],L={e:m,target:E,subTargets:O,button:d||l,isClick:w||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};g==="up"&&(L.currentTarget=this.findTarget(m),L.currentSubTargets=this.targets),this.fire("mouse:"+g,L),E&&E.fire("mouse"+g,L);for(var V=0;V<O.length;V++)O[V].fire("mouse"+g,L)},_finalizeCurrentTransform:function(m){var g=this._currentTransform,d=g.target,w={e:m,target:d,transform:g,action:g.action};d._scaling&&(d._scaling=!1),d.setCoords(),(g.actionPerformed||this.stateful&&d.hasStateChanged())&&this._fire("modified",w)},_onMouseDownInDrawingMode:function(m){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(m).requestRenderAll();var g=this.getPointer(m);this.freeDrawingBrush.onMouseDown(g,{e:m,pointer:g}),this._handleEvent(m,"down")},_onMouseMoveInDrawingMode:function(m){if(this._isCurrentlyDrawing){var g=this.getPointer(m);this.freeDrawingBrush.onMouseMove(g,{e:m,pointer:g})}this.setCursor(this.freeDrawingCursor),this._handleEvent(m,"move")},_onMouseUpInDrawingMode:function(m){var g=this.getPointer(m);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:m,pointer:g}),this._handleEvent(m,"up")},__onMouseDown:function(m){this._cacheTransformEventData(m),this._handleEvent(m,"down:before");var g=this._target;if(h(m,C)){this.fireRightClick&&this._handleEvent(m,"down",C);return}if(h(m,b)){this.fireMiddleClick&&this._handleEvent(m,"down",b);return}if(this.isDrawingMode){this._onMouseDownInDrawingMode(m);return}if(this._isMainEvent(m)&&!this._currentTransform){var d=this._pointer;this._previousPointer=d;var w=this._shouldRender(g),E=this._shouldGroup(m,g);if(this._shouldClearSelection(m,g)?this.discardActiveObject(m):E&&(this._handleGrouping(m,g),g=this._activeObject),this.selection&&(!g||!g.selectable&&!g.isEditing&&g!==this._activeObject)&&(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),g){var O=g===this._activeObject;g.selectable&&g.activeOn==="down"&&this.setActiveObject(g,m);var L=g._findTargetCorner(this.getPointer(m,!0),T.util.isTouchEvent(m));if(g.__corner=L,g===this._activeObject&&(L||!E)){this._setupCurrentTransform(m,g,O);var V=g.controls[L],d=this.getPointer(m),$=V&&V.getMouseDownHandler(m,g,V);$&&$(m,this._currentTransform,d.x,d.y)}}this._handleEvent(m,"down"),(w||E)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(m){this._resetTransformEventData(),this._pointer=this.getPointer(m,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(m)||null},_beforeTransform:function(m){var g=this._currentTransform;this.stateful&&g.target.saveState(),this.fire("before:transform",{e:m,transform:g})},__onMouseMove:function(m){this._handleEvent(m,"move:before"),this._cacheTransformEventData(m);var g,d;if(this.isDrawingMode){this._onMouseMoveInDrawingMode(m);return}if(this._isMainEvent(m)){var w=this._groupSelector;w?(d=this._absolutePointer,w.left=d.x-w.ex,w.top=d.y-w.ey,this.renderTop()):this._currentTransform?this._transformObject(m):(g=this.findTarget(m)||null,this._setCursorFromEvent(m,g),this._fireOverOutEvents(g,m)),this._handleEvent(m,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(m,g){var d=this._hoveredTarget,w=this._hoveredTargets,E=this.targets,O=Math.max(w.length,E.length);this.fireSyntheticInOutEvents(m,g,{oldTarget:d,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var L=0;L<O;L++)this.fireSyntheticInOutEvents(E[L],g,{oldTarget:w[L],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=m,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(m,g){var d=this._draggedoverTarget,w=this._hoveredTargets,E=this.targets,O=Math.max(w.length,E.length);this.fireSyntheticInOutEvents(m,g,{oldTarget:d,evtOut:"dragleave",evtIn:"dragenter"});for(var L=0;L<O;L++)this.fireSyntheticInOutEvents(E[L],g,{oldTarget:w[L],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=m},fireSyntheticInOutEvents:function(m,g,d){var w,E,O=d.oldTarget,L,V,$=O!==m,ne=d.canvasEvtIn,xe=d.canvasEvtOut;$&&(w={e:g,target:m,previousTarget:O},E={e:g,target:O,nextTarget:m}),V=m&&$,L=O&&$,L&&(xe&&this.fire(xe,E),O.fire(d.evtOut,E)),V&&(ne&&this.fire(ne,w),m.fire(d.evtIn,w))},__onMouseWheel:function(m){this._cacheTransformEventData(m),this._handleEvent(m,"wheel"),this._resetTransformEventData()},_transformObject:function(m){var g=this.getPointer(m),d=this._currentTransform;d.reset=!1,d.shiftKey=m.shiftKey,d.altKey=m[this.centeredKey],this._performTransformAction(m,d,g),d.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(m,g,d){var w=d.x,E=d.y,O=g.action,L=!1,V=g.actionHandler;V&&(L=V(m,g,w,E)),O==="drag"&&L&&(g.target.isMoving=!0,this.setCursor(g.target.moveCursor||this.moveCursor)),g.actionPerformed=g.actionPerformed||L},_fire:T.controlsUtils.fireEvent,_setCursorFromEvent:function(m,g){if(!g)return this.setCursor(this.defaultCursor),!1;var d=g.hoverCursor||this.hoverCursor,w=this._activeObject&&this._activeObject.type==="activeSelection"?this._activeObject:null,E=(!w||!w.contains(g))&&g._findTargetCorner(this.getPointer(m,!0));E?this.setCursor(this.getCornerCursor(E,g,m)):(g.subTargetCheck&&this.targets.concat().reverse().map(function(O){d=O.hoverCursor||d}),this.setCursor(d))},getCornerCursor:function(m,g,d){var w=g.controls[m];return w.cursorStyleHandler(d,w,g)}})}(),function(){var s=Math.min,p=Math.max;T.util.object.extend(T.Canvas.prototype,{_shouldGroup:function(C,b){var l=this._activeObject;return l&&this._isSelectionKeyPressed(C)&&b&&b.selectable&&this.selection&&(l!==b||l.type==="activeSelection")&&!b.onSelect({e:C})},_handleGrouping:function(C,b){var l=this._activeObject;l.__corner||b===l&&(b=this.findTarget(C,!0),!b||!b.selectable)||(l&&l.type==="activeSelection"?this._updateActiveSelection(b,C):this._createActiveSelection(b,C))},_updateActiveSelection:function(C,b){var l=this._activeObject,c=l._objects.slice(0);l.contains(C)?(l.removeWithUpdate(C),this._hoveredTarget=C,this._hoveredTargets=this.targets.concat(),l.size()===1&&this._setActiveObject(l.item(0),b)):(l.addWithUpdate(C),this._hoveredTarget=l,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(c,b)},_createActiveSelection:function(C,b){var l=this.getActiveObjects(),c=this._createGroup(C);this._hoveredTarget=c,this._setActiveObject(c,b),this._fireSelectionEvents(l,b)},_createGroup:function(C){var b=this._objects,l=b.indexOf(this._activeObject)<b.indexOf(C),c=l?[this._activeObject,C]:[C,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new T.ActiveSelection(c,{canvas:this})},_groupSelectedObjects:function(C){var b=this._collectObjects(C),l;b.length===1?this.setActiveObject(b[0],C):b.length>1&&(l=new T.ActiveSelection(b.reverse(),{canvas:this}),this.setActiveObject(l,C))},_collectObjects:function(C){for(var b=[],l,c=this._groupSelector.ex,h=this._groupSelector.ey,m=c+this._groupSelector.left,g=h+this._groupSelector.top,d=new T.Point(s(c,m),s(h,g)),w=new T.Point(p(c,m),p(h,g)),E=!this.selectionFullyContained,O=c===m&&h===g,L=this._objects.length;L--&&(l=this._objects[L],!(!(!l||!l.selectable||!l.visible)&&(E&&l.intersectsWithRect(d,w,!0)||l.isContainedWithinRect(d,w,!0)||E&&l.containsPoint(d,null,!0)||E&&l.containsPoint(w,null,!0))&&(b.push(l),O))););return b.length>1&&(b=b.filter(function(V){return!V.onSelect({e:C})})),b},_maybeGroupObjects:function(C){this.selection&&this._groupSelector&&this._groupSelectedObjects(C),this.setCursor(this.defaultCursor),this._groupSelector=null}})}(),function(){T.util.object.extend(T.StaticCanvas.prototype,{toDataURL:function(s){s||(s={});var p=s.format||"png",C=s.quality||1,b=(s.multiplier||1)*(s.enableRetinaScaling?this.getRetinaScaling():1),l=this.toCanvasElement(b,s);return T.util.toDataURL(l,p,C)},toCanvasElement:function(s,p){s=s||1,p=p||{};var C=(p.width||this.width)*s,b=(p.height||this.height)*s,l=this.getZoom(),c=this.width,h=this.height,m=l*s,g=this.viewportTransform,d=(g[4]-(p.left||0))*s,w=(g[5]-(p.top||0))*s,E=this.interactive,O=[m,0,0,m,d,w],L=this.enableRetinaScaling,V=T.util.createCanvasElement(),$=this.contextTop;return V.width=C,V.height=b,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=O,this.width=C,this.height=b,this.calcViewportBoundaries(),this.renderCanvas(V.getContext("2d"),this._objects),this.viewportTransform=g,this.width=c,this.height=h,this.calcViewportBoundaries(),this.interactive=E,this.enableRetinaScaling=L,this.contextTop=$,V}})}(),T.util.object.extend(T.StaticCanvas.prototype,{loadFromJSON:function(s,p,C){if(s){var b=typeof s=="string"?JSON.parse(s):T.util.object.clone(s),l=this,c=b.clipPath,h=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete b.clipPath,this._enlivenObjects(b.objects,function(m){l.clear(),l._setBgOverlay(b,function(){c?l._enlivenObjects([c],function(g){l.clipPath=g[0],l.__setupCanvas.call(l,b,m,h,p)}):l.__setupCanvas.call(l,b,m,h,p)})},C),this}},__setupCanvas:function(s,p,C,b){var l=this;p.forEach(function(c,h){l.insertAt(c,h)}),this.renderOnAddRemove=C,delete s.objects,delete s.backgroundImage,delete s.overlayImage,delete s.background,delete s.overlay,this._setOptions(s),this.renderAll(),b&&b()},_setBgOverlay:function(s,p){var C={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(!s.backgroundImage&&!s.overlayImage&&!s.background&&!s.overlay){p&&p();return}var b=function(){C.backgroundImage&&C.overlayImage&&C.backgroundColor&&C.overlayColor&&p&&p()};this.__setBgOverlay("backgroundImage",s.backgroundImage,C,b),this.__setBgOverlay("overlayImage",s.overlayImage,C,b),this.__setBgOverlay("backgroundColor",s.background,C,b),this.__setBgOverlay("overlayColor",s.overlay,C,b)},__setBgOverlay:function(s,p,C,b){var l=this;if(!p){C[s]=!0,b&&b();return}s==="backgroundImage"||s==="overlayImage"?T.util.enlivenObjects([p],function(c){l[s]=c[0],C[s]=!0,b&&b()}):this["set"+T.util.string.capitalize(s,!0)](p,function(){C[s]=!0,b&&b()})},_enlivenObjects:function(s,p,C){if(!s||s.length===0){p&&p([]);return}T.util.enlivenObjects(s,function(b){p&&p(b)},null,C)},_toDataURL:function(s,p){this.clone(function(C){p(C.toDataURL(s))})},_toDataURLWithMultiplier:function(s,p,C){this.clone(function(b){C(b.toDataURLWithMultiplier(s,p))})},clone:function(s,p){var C=JSON.stringify(this.toJSON(p));this.cloneWithoutData(function(b){b.loadFromJSON(C,function(){s&&s(b)})})},cloneWithoutData:function(s){var p=T.util.createCanvasElement();p.width=this.width,p.height=this.height;var C=new T.Canvas(p);this.backgroundImage?(C.setBackgroundImage(this.backgroundImage.src,function(){C.renderAll(),s&&s(C)}),C.backgroundImageOpacity=this.backgroundImageOpacity,C.backgroundImageStretch=this.backgroundImageStretch):s&&s(C)}}),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.util.object.clone,l=p.util.toFixed,c=p.util.string.capitalize,h=p.util.degreesToRadians,m=!p.isLikelyNode,g=2;p.Object||(p.Object=p.util.createClass(p.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:m,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(d){d&&this.setOptions(d)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=p.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(d){var w=p.perfLimitSizeTotal,E=d.width,O=d.height,L=p.maxCacheSideLimit,V=p.minCacheSideLimit;if(E<=L&&O<=L&&E*O<=w)return E<V&&(d.width=V),O<V&&(d.height=V),d;var $=E/O,ne=p.util.limitDimsByArea($,w),xe=p.util.capValue,ze=xe(V,ne.x,L),Ke=xe(V,ne.y,L);return E>ze&&(d.zoomX/=E/ze,d.width=ze,d.capped=!0),O>Ke&&(d.zoomY/=O/Ke,d.height=Ke,d.capped=!0),d},_getCacheCanvasDimensions:function(){var d=this.getTotalObjectScaling(),w=this._getTransformedDimensions(0,0),E=w.x*d.scaleX/this.scaleX,O=w.y*d.scaleY/this.scaleY;return{width:E+g,height:O+g,zoomX:d.scaleX,zoomY:d.scaleY,x:E,y:O}},_updateCacheCanvas:function(){var d=this.canvas;if(this.noScaleCache&&d&&d._currentTransform){var w=d._currentTransform.target,E=d._currentTransform.action;if(this===w&&E.slice&&E.slice(0,5)==="scale")return!1}var O=this._cacheCanvas,L=this._limitCacheSize(this._getCacheCanvasDimensions()),V=p.minCacheSideLimit,$=L.width,ne=L.height,xe,ze,Ke=L.zoomX,Je=L.zoomY,tt=$!==this.cacheWidth||ne!==this.cacheHeight,ht=this.zoomX!==Ke||this.zoomY!==Je,nt=tt||ht,_t=0,Ot=0,ot=!1;if(tt){var wt=this._cacheCanvas.width,ee=this._cacheCanvas.height,be=$>wt||ne>ee,me=($<wt*.9||ne<ee*.9)&&wt>V&&ee>V;ot=be||me,be&&!L.capped&&($>V||ne>V)&&(_t=$*.1,Ot=ne*.1)}return this instanceof p.Text&&this.path&&(nt=!0,ot=!0,_t+=this.getHeightOfLine(0)*this.zoomX,Ot+=this.getHeightOfLine(0)*this.zoomY),nt?(ot?(O.width=Math.ceil($+_t),O.height=Math.ceil(ne+Ot)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,O.width,O.height)),xe=L.x/2,ze=L.y/2,this.cacheTranslationX=Math.round(O.width/2-xe)+xe,this.cacheTranslationY=Math.round(O.height/2-ze)+ze,this.cacheWidth=$,this.cacheHeight=ne,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(Ke,Je),this.zoomX=Ke,this.zoomY=Je,!0):!1},setOptions:function(d){this._setOptions(d),this._initGradient(d.fill,"fill"),this._initGradient(d.stroke,"stroke"),this._initPattern(d.fill,"fill"),this._initPattern(d.stroke,"stroke")},transform:function(d){var w=this.group&&!this.group._transformDone||this.group&&this.canvas&&d===this.canvas.contextTop,E=this.calcTransformMatrix(!w);d.transform(E[0],E[1],E[2],E[3],E[4],E[5])},toObject:function(d){var w=p.Object.NUM_FRACTION_DIGITS,E={type:this.type,version:p.version,originX:this.originX,originY:this.originY,left:l(this.left,w),top:l(this.top,w),width:l(this.width,w),height:l(this.height,w),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:l(this.strokeWidth,w),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:l(this.strokeMiterLimit,w),scaleX:l(this.scaleX,w),scaleY:l(this.scaleY,w),angle:l(this.angle,w),flipX:this.flipX,flipY:this.flipY,opacity:l(this.opacity,w),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:l(this.skewX,w),skewY:l(this.skewY,w)};return this.clipPath&&!this.clipPath.excludeFromExport&&(E.clipPath=this.clipPath.toObject(d),E.clipPath.inverted=this.clipPath.inverted,E.clipPath.absolutePositioned=this.clipPath.absolutePositioned),p.util.populateWithProperties(this,E,d),this.includeDefaultValues||(E=this._removeDefaultValues(E)),E},toDatalessObject:function(d){return this.toObject(d)},_removeDefaultValues:function(d){var w=p.util.getKlass(d.type).prototype,E=w.stateProperties;return E.forEach(function(O){O==="left"||O==="top"||(d[O]===w[O]&&delete d[O],Array.isArray(d[O])&&Array.isArray(w[O])&&d[O].length===0&&w[O].length===0&&delete d[O])}),d},toString:function(){return"#<fabric."+c(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var d=p.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(d.scaleX),scaleY:Math.abs(d.scaleY)}},getTotalObjectScaling:function(){var d=this.getObjectScaling(),w=d.scaleX,E=d.scaleY;if(this.canvas){var O=this.canvas.getZoom(),L=this.canvas.getRetinaScaling();w*=O*L,E*=O*L}return{scaleX:w,scaleY:E}},getObjectOpacity:function(){var d=this.opacity;return this.group&&(d*=this.group.getObjectOpacity()),d},_set:function(d,w){var E=d==="scaleX"||d==="scaleY",O=this[d]!==w,L=!1;return E&&(w=this._constrainScale(w)),d==="scaleX"&&w<0?(this.flipX=!this.flipX,w*=-1):d==="scaleY"&&w<0?(this.flipY=!this.flipY,w*=-1):d==="shadow"&&w&&!(w instanceof p.Shadow)?w=new p.Shadow(w):d==="dirty"&&this.group&&this.group.set("dirty",w),this[d]=w,O&&(L=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(d)>-1?(this.dirty=!0,L&&this.group.set("dirty",!0)):L&&this.stateProperties.indexOf(d)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:p.iMatrix.concat()},isNotVisible:function(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible},render:function(d){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(d.save(),this._setupCompositeOperation(d),this.drawSelectionBackground(d),this.transform(d),this._setOpacity(d),this._setShadow(d,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(d)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(d),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),d.restore())},renderCache:function(d){d=d||{},(!this._cacheCanvas||!this._cacheContext)&&this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,d.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0},hasFill:function(){return this.fill&&this.fill!=="transparent"},needsItsOwnCache:function(){return!!(this.paintFirst==="stroke"&&this.hasFill()&&this.hasStroke()&&typeof this.shadow=="object"||this.clipPath)},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)},drawClipPathOnCache:function(d,w){if(d.save(),w.inverted?d.globalCompositeOperation="destination-out":d.globalCompositeOperation="destination-in",w.absolutePositioned){var E=p.util.invertTransform(this.calcTransformMatrix());d.transform(E[0],E[1],E[2],E[3],E[4],E[5])}w.transform(d),d.scale(1/w.zoomX,1/w.zoomY),d.drawImage(w._cacheCanvas,-w.cacheTranslationX,-w.cacheTranslationY),d.restore()},drawObject:function(d,w){var E=this.fill,O=this.stroke;w?(this.fill="black",this.stroke="",this._setClippingProperties(d)):this._renderBackground(d),this._render(d),this._drawClipPath(d,this.clipPath),this.fill=E,this.stroke=O},_drawClipPath:function(d,w){w&&(w.canvas=this.canvas,w.shouldCache(),w._transformDone=!0,w.renderCache({forClipping:!0}),this.drawClipPathOnCache(d,w))},drawCacheOnCanvas:function(d){d.scale(1/this.zoomX,1/this.zoomY),d.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(d){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!d&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!d){var w=this.cacheWidth/this.zoomX,E=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-w/2,-E/2,w,E)}return!0}return!1},_renderBackground:function(d){if(this.backgroundColor){var w=this._getNonTransformedDimensions();d.fillStyle=this.backgroundColor,d.fillRect(-w.x/2,-w.y/2,w.x,w.y),this._removeShadow(d)}},_setOpacity:function(d){this.group&&!this.group._transformDone?d.globalAlpha=this.getObjectOpacity():d.globalAlpha*=this.opacity},_setStrokeStyles:function(d,w){var E=w.stroke;E&&(d.lineWidth=w.strokeWidth,d.lineCap=w.strokeLineCap,d.lineDashOffset=w.strokeDashOffset,d.lineJoin=w.strokeLineJoin,d.miterLimit=w.strokeMiterLimit,E.toLive?E.gradientUnits==="percentage"||E.gradientTransform||E.patternTransform?this._applyPatternForTransformedGradient(d,E):(d.strokeStyle=E.toLive(d,this),this._applyPatternGradientTransform(d,E)):d.strokeStyle=w.stroke)},_setFillStyles:function(d,w){var E=w.fill;E&&(E.toLive?(d.fillStyle=E.toLive(d,this),this._applyPatternGradientTransform(d,w.fill)):d.fillStyle=E)},_setClippingProperties:function(d){d.globalAlpha=1,d.strokeStyle="transparent",d.fillStyle="#000000"},_setLineDash:function(d,w){!w||w.length===0||(1&w.length&&w.push.apply(w,w),d.setLineDash(w))},_renderControls:function(d,w){var E=this.getViewportTransform(),O=this.calcTransformMatrix(),L,V,$;w=w||{},V=typeof w.hasBorders<"u"?w.hasBorders:this.hasBorders,$=typeof w.hasControls<"u"?w.hasControls:this.hasControls,O=p.util.multiplyTransformMatrices(E,O),L=p.util.qrDecompose(O),d.save(),d.translate(L.translateX,L.translateY),d.lineWidth=1*this.borderScaleFactor,this.group||(d.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(L.angle-=180),d.rotate(h(this.group?L.angle:this.angle)),w.forActiveSelection||this.group?V&&this.drawBordersInGroup(d,L,w):V&&this.drawBorders(d,w),$&&this.drawControls(d,w),d.restore()},_setShadow:function(d){if(this.shadow){var w=this.shadow,E=this.canvas,O,L=E&&E.viewportTransform[0]||1,V=E&&E.viewportTransform[3]||1;w.nonScaling?O={scaleX:1,scaleY:1}:O=this.getObjectScaling(),E&&E._isRetinaScaling()&&(L*=p.devicePixelRatio,V*=p.devicePixelRatio),d.shadowColor=w.color,d.shadowBlur=w.blur*p.browserShadowBlurConstant*(L+V)*(O.scaleX+O.scaleY)/4,d.shadowOffsetX=w.offsetX*L*O.scaleX,d.shadowOffsetY=w.offsetY*V*O.scaleY}},_removeShadow:function(d){this.shadow&&(d.shadowColor="",d.shadowBlur=d.shadowOffsetX=d.shadowOffsetY=0)},_applyPatternGradientTransform:function(d,w){if(!w||!w.toLive)return{offsetX:0,offsetY:0};var E=w.gradientTransform||w.patternTransform,O=-this.width/2+w.offsetX||0,L=-this.height/2+w.offsetY||0;return w.gradientUnits==="percentage"?d.transform(this.width,0,0,this.height,O,L):d.transform(1,0,0,1,O,L),E&&d.transform(E[0],E[1],E[2],E[3],E[4],E[5]),{offsetX:O,offsetY:L}},_renderPaintInOrder:function(d){this.paintFirst==="stroke"?(this._renderStroke(d),this._renderFill(d)):(this._renderFill(d),this._renderStroke(d))},_render:function(){},_renderFill:function(d){this.fill&&(d.save(),this._setFillStyles(d,this),this.fillRule==="evenodd"?d.fill("evenodd"):d.fill(),d.restore())},_renderStroke:function(d){if(!(!this.stroke||this.strokeWidth===0)){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(d),d.save(),this.strokeUniform&&this.group){var w=this.getObjectScaling();d.scale(1/w.scaleX,1/w.scaleY)}else this.strokeUniform&&d.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(d,this.strokeDashArray),this._setStrokeStyles(d,this),d.stroke(),d.restore()}},_applyPatternForTransformedGradient:function(d,w){var E=this._limitCacheSize(this._getCacheCanvasDimensions()),O=p.util.createCanvasElement(),L,V=this.canvas.getRetinaScaling(),$=E.x/this.scaleX/V,ne=E.y/this.scaleY/V;O.width=$,O.height=ne,L=O.getContext("2d"),L.beginPath(),L.moveTo(0,0),L.lineTo($,0),L.lineTo($,ne),L.lineTo(0,ne),L.closePath(),L.translate($/2,ne/2),L.scale(E.zoomX/this.scaleX/V,E.zoomY/this.scaleY/V),this._applyPatternGradientTransform(L,w),L.fillStyle=w.toLive(d),L.fill(),d.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),d.scale(V*this.scaleX/E.zoomX,V*this.scaleY/E.zoomY),d.strokeStyle=L.createPattern(O,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var d=p.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",d.scaleX),this.set("scaleY",d.scaleY),this.angle=d.angle,this.skewX=d.skewX,this.skewY=0}},_removeTransformMatrix:function(d){var w=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),w=p.util.transformPoint(w,this.transformMatrix)),this.transformMatrix=null,d&&(this.scaleX*=d.scaleX,this.scaleY*=d.scaleY,this.cropX=d.cropX,this.cropY=d.cropY,w.x+=d.offsetLeft,w.y+=d.offsetTop,this.width=d.width,this.height=d.height),this.setPositionByOrigin(w,"center","center")},clone:function(d,w){var E=this.toObject(w);this.constructor.fromObject?this.constructor.fromObject(E,d):p.Object._fromObject("Object",E,d)},cloneAsImage:function(d,w){var E=this.toCanvasElement(w);return d&&d(new p.Image(E)),this},toCanvasElement:function(d){d||(d={});var w=p.util,E=w.saveObjectTransform(this),O=this.group,L=this.shadow,V=Math.abs,$=(d.multiplier||1)*(d.enableRetinaScaling?p.devicePixelRatio:1);delete this.group,d.withoutTransform&&w.resetObjectTransform(this),d.withoutShadow&&(this.shadow=null);var ne=p.util.createCanvasElement(),xe=this.getBoundingRect(!0,!0),ze=this.shadow,Ke,Je={x:0,y:0},tt,ht,nt;ze&&(tt=ze.blur,ze.nonScaling?Ke={scaleX:1,scaleY:1}:Ke=this.getObjectScaling(),Je.x=2*Math.round(V(ze.offsetX)+tt)*V(Ke.scaleX),Je.y=2*Math.round(V(ze.offsetY)+tt)*V(Ke.scaleY)),ht=xe.width+Je.x,nt=xe.height+Je.y,ne.width=Math.ceil(ht),ne.height=Math.ceil(nt);var _t=new p.StaticCanvas(ne,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});d.format==="jpeg"&&(_t.backgroundColor="#fff"),this.setPositionByOrigin(new p.Point(_t.width/2,_t.height/2),"center","center");var Ot=this.canvas;_t.add(this);var ot=_t.toCanvasElement($||1,d);return this.shadow=L,this.set("canvas",Ot),O&&(this.group=O),this.set(E).setCoords(),_t._objects=[],_t.dispose(),_t=null,ot},toDataURL:function(d){return d||(d={}),p.util.toDataURL(this.toCanvasElement(d),d.format||"png",d.quality||1)},isType:function(d){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===d},complexity:function(){return 1},toJSON:function(d){return this.toObject(d)},rotate:function(d){var w=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;return w&&this._setOriginToCenter(),this.set("angle",d),w&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(d,w){w=w||this.canvas.getPointer(d);var E=new p.Point(w.x,w.y),O=this._getLeftTopCoords();return this.angle&&(E=p.util.rotatePoint(E,O,h(-this.angle))),{x:E.x-O.x,y:E.y-O.y}},_setupCompositeOperation:function(d){this.globalCompositeOperation&&(d.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){p.runningAnimations&&p.runningAnimations.cancelByTarget(this)}}),p.util.createAccessors&&p.util.createAccessors(p.Object),C(p.Object.prototype,p.Observable),p.Object.NUM_FRACTION_DIGITS=2,p.Object.ENLIVEN_PROPS=["clipPath"],p.Object._fromObject=function(d,w,E,O){var L=p[d];w=b(w,!0),p.util.enlivenPatterns([w.fill,w.stroke],function(V){typeof V[0]<"u"&&(w.fill=V[0]),typeof V[1]<"u"&&(w.stroke=V[1]),p.util.enlivenObjectEnlivables(w,w,function(){var $=O?new L(w[O],w):new L(w);E&&E($)})})},p.Object.__uid=0)}(Y),function(){var s=T.util.degreesToRadians,p={left:-.5,center:0,right:.5},C={top:-.5,center:0,bottom:.5};T.util.object.extend(T.Object.prototype,{translateToGivenOrigin:function(b,l,c,h,m){var g=b.x,d=b.y,w,E,O;return typeof l=="string"?l=p[l]:l-=.5,typeof h=="string"?h=p[h]:h-=.5,w=h-l,typeof c=="string"?c=C[c]:c-=.5,typeof m=="string"?m=C[m]:m-=.5,E=m-c,(w||E)&&(O=this._getTransformedDimensions(),g=b.x+w*O.x,d=b.y+E*O.y),new T.Point(g,d)},translateToCenterPoint:function(b,l,c){var h=this.translateToGivenOrigin(b,l,c,"center","center");return this.angle?T.util.rotatePoint(h,b,s(this.angle)):h},translateToOriginPoint:function(b,l,c){var h=this.translateToGivenOrigin(b,"center","center",l,c);return this.angle?T.util.rotatePoint(h,b,s(this.angle)):h},getCenterPoint:function(){var b=new T.Point(this.left,this.top);return this.translateToCenterPoint(b,this.originX,this.originY)},getPointByOrigin:function(b,l){var c=this.getCenterPoint();return this.translateToOriginPoint(c,b,l)},toLocalPoint:function(b,l,c){var h=this.getCenterPoint(),m,g;return typeof l<"u"&&typeof c<"u"?m=this.translateToGivenOrigin(h,"center","center",l,c):m=new T.Point(this.left,this.top),g=new T.Point(b.x,b.y),this.angle&&(g=T.util.rotatePoint(g,h,-s(this.angle))),g.subtractEquals(m)},setPositionByOrigin:function(b,l,c){var h=this.translateToCenterPoint(b,l,c),m=this.translateToOriginPoint(h,this.originX,this.originY);this.set("left",m.x),this.set("top",m.y)},adjustPosition:function(b){var l=s(this.angle),c=this.getScaledWidth(),h=T.util.cos(l)*c,m=T.util.sin(l)*c,g,d;typeof this.originX=="string"?g=p[this.originX]:g=this.originX-.5,typeof b=="string"?d=p[b]:d=b-.5,this.left+=h*(d-g),this.top+=m*(d-g),this.setCoords(),this.originX=b},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var b=this.getCenterPoint();this.originX="center",this.originY="center",this.left=b.x,this.top=b.y},_resetOrigin:function(){var b=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=b.x,this.top=b.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}})}(),function(){function s(c){return[new T.Point(c.tl.x,c.tl.y),new T.Point(c.tr.x,c.tr.y),new T.Point(c.br.x,c.br.y),new T.Point(c.bl.x,c.bl.y)]}var p=T.util,C=p.degreesToRadians,b=p.multiplyTransformMatrices,l=p.transformPoint;p.object.extend(T.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(c,h){return h?c?this.calcACoords():this.calcLineCoords():((!this.aCoords||!this.lineCoords)&&this.setCoords(!0),c?this.aCoords:this.lineCoords)},getCoords:function(c,h){return s(this._getCoords(c,h))},intersectsWithRect:function(c,h,m,g){var d=this.getCoords(m,g),w=T.Intersection.intersectPolygonRectangle(d,c,h);return w.status==="Intersection"},intersectsWithObject:function(c,h,m){var g=T.Intersection.intersectPolygonPolygon(this.getCoords(h,m),c.getCoords(h,m));return g.status==="Intersection"||c.isContainedWithinObject(this,h,m)||this.isContainedWithinObject(c,h,m)},isContainedWithinObject:function(c,h,m){for(var g=this.getCoords(h,m),d=h?c.aCoords:c.lineCoords,w=0,E=c._getImageLines(d);w<4;w++)if(!c.containsPoint(g[w],E))return!1;return!0},isContainedWithinRect:function(c,h,m,g){var d=this.getBoundingRect(m,g);return d.left>=c.x&&d.left+d.width<=h.x&&d.top>=c.y&&d.top+d.height<=h.y},containsPoint:function(c,w,m,g){var d=this._getCoords(m,g),w=w||this._getImageLines(d),E=this._findCrossPoints(c,w);return E!==0&&E%2===1},isOnScreen:function(c){if(!this.canvas)return!1;var h=this.canvas.vptCoords.tl,m=this.canvas.vptCoords.br,g=this.getCoords(!0,c);return g.some(function(d){return d.x<=m.x&&d.x>=h.x&&d.y<=m.y&&d.y>=h.y})||this.intersectsWithRect(h,m,!0,c)?!0:this._containsCenterOfCanvas(h,m,c)},_containsCenterOfCanvas:function(c,h,m){var g={x:(c.x+h.x)/2,y:(c.y+h.y)/2};return!!this.containsPoint(g,null,!0,m)},isPartiallyOnScreen:function(c){if(!this.canvas)return!1;var h=this.canvas.vptCoords.tl,m=this.canvas.vptCoords.br;if(this.intersectsWithRect(h,m,!0,c))return!0;var g=this.getCoords(!0,c).every(function(d){return(d.x>=m.x||d.x<=h.x)&&(d.y>=m.y||d.y<=h.y)});return g&&this._containsCenterOfCanvas(h,m,c)},_getImageLines:function(c){var h={topline:{o:c.tl,d:c.tr},rightline:{o:c.tr,d:c.br},bottomline:{o:c.br,d:c.bl},leftline:{o:c.bl,d:c.tl}};return h},_findCrossPoints:function(c,h){var m,g,d,w,E,O=0,L;for(var V in h)if(L=h[V],!(L.o.y<c.y&&L.d.y<c.y)&&!(L.o.y>=c.y&&L.d.y>=c.y)&&(L.o.x===L.d.x&&L.o.x>=c.x?E=L.o.x:(m=0,g=(L.d.y-L.o.y)/(L.d.x-L.o.x),d=c.y-m*c.x,w=L.o.y-g*L.o.x,E=-(d-w)/(m-g)),E>=c.x&&(O+=1),O===2))break;return O},getBoundingRect:function(c,h){var m=this.getCoords(c,h);return p.makeBoundingBoxFromPoints(m)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(c){return Math.abs(c)<this.minScaleLimit?c<0?-this.minScaleLimit:this.minScaleLimit:c===0?1e-4:c},scale:function(c){return this._set("scaleX",c),this._set("scaleY",c),this.setCoords()},scaleToWidth:function(c,h){var m=this.getBoundingRect(h).width/this.getScaledWidth();return this.scale(c/this.width/m)},scaleToHeight:function(c,h){var m=this.getBoundingRect(h).height/this.getScaledHeight();return this.scale(c/this.height/m)},calcLineCoords:function(){var c=this.getViewportTransform(),h=this.padding,m=C(this.angle),g=p.cos(m),d=p.sin(m),w=g*h,E=d*h,O=w+E,L=w-E,V=this.calcACoords(),$={tl:l(V.tl,c),tr:l(V.tr,c),bl:l(V.bl,c),br:l(V.br,c)};return h&&($.tl.x-=L,$.tl.y-=O,$.tr.x+=O,$.tr.y-=L,$.bl.x-=O,$.bl.y+=L,$.br.x+=L,$.br.y+=O),$},calcOCoords:function(){var c=this._calcRotateMatrix(),h=this._calcTranslateMatrix(),m=this.getViewportTransform(),g=b(m,h),d=b(g,c),d=b(d,[1/m[0],0,0,1/m[3],0,0]),w=this._calculateCurrentDimensions(),E={};return this.forEachControl(function(O,L,V){E[L]=O.positionHandler(w,d,V)}),E},calcACoords:function(){var c=this._calcRotateMatrix(),h=this._calcTranslateMatrix(),m=b(h,c),g=this._getTransformedDimensions(),d=g.x/2,w=g.y/2;return{tl:l({x:-d,y:-w},m),tr:l({x:d,y:-w},m),bl:l({x:-d,y:w},m),br:l({x:d,y:w},m)}},setCoords:function(c){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),c?this:(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords(),this)},_calcRotateMatrix:function(){return p.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var c=this.getCenterPoint();return[1,0,0,1,c.x,c.y]},transformMatrixKey:function(c){var h="_",m="";return!c&&this.group&&(m=this.group.transformMatrixKey(c)+h),m+this.top+h+this.left+h+this.scaleX+h+this.scaleY+h+this.skewX+h+this.skewY+h+this.angle+h+this.originX+h+this.originY+h+this.width+h+this.height+h+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(c){var h=this.calcOwnMatrix();if(c||!this.group)return h;var m=this.transformMatrixKey(c),g=this.matrixCache||(this.matrixCache={});return g.key===m?g.value:(this.group&&(h=b(this.group.calcTransformMatrix(!1),h)),g.key=m,g.value=h,h)},calcOwnMatrix:function(){var c=this.transformMatrixKey(!0),h=this.ownMatrixCache||(this.ownMatrixCache={});if(h.key===c)return h.value;var m=this._calcTranslateMatrix(),g={angle:this.angle,translateX:m[4],translateY:m[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return h.key=c,h.value=p.composeMatrix(g),h.value},_getNonTransformedDimensions:function(){var c=this.strokeWidth,h=this.width+c,m=this.height+c;return{x:h,y:m}},_getTransformedDimensions:function(c,h){typeof c>"u"&&(c=this.skewX),typeof h>"u"&&(h=this.skewY);var m,g,d,w=c===0&&h===0;if(this.strokeUniform?(g=this.width,d=this.height):(m=this._getNonTransformedDimensions(),g=m.x,d=m.y),w)return this._finalizeDimensions(g*this.scaleX,d*this.scaleY);var E=p.sizeAfterTransform(g,d,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:c,skewY:h});return this._finalizeDimensions(E.x,E.y)},_finalizeDimensions:function(c,h){return this.strokeUniform?{x:c+this.strokeWidth,y:h+this.strokeWidth}:{x:c,y:h}},_calculateCurrentDimensions:function(){var c=this.getViewportTransform(),h=this._getTransformedDimensions(),m=l(h,c,!0);return m.scalarAdd(2*this.padding)}})}(),T.util.object.extend(T.Object.prototype,{sendToBack:function(){return this.group?T.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?T.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(s){return this.group?T.StaticCanvas.prototype.sendBackwards.call(this.group,this,s):this.canvas&&this.canvas.sendBackwards(this,s),this},bringForward:function(s){return this.group?T.StaticCanvas.prototype.bringForward.call(this.group,this,s):this.canvas&&this.canvas.bringForward(this,s),this},moveTo:function(s){return this.group&&this.group.type!=="activeSelection"?T.StaticCanvas.prototype.moveTo.call(this.group,this,s):this.canvas&&this.canvas.moveTo(this,s),this}}),function(){function s(C,b){if(b){if(b.toLive)return C+": url(#SVGID_"+b.id+"); ";var l=new T.Color(b),c=C+": "+l.toRgb()+"; ",h=l.getAlpha();return h!==1&&(c+=C+"-opacity: "+h.toString()+"; "),c}else return C+": none; "}var p=T.util.toFixed;T.util.object.extend(T.Object.prototype,{getSvgStyles:function(C){var b=this.fillRule?this.fillRule:"nonzero",l=this.strokeWidth?this.strokeWidth:"0",c=this.strokeDashArray?this.strokeDashArray.join(" "):"none",h=this.strokeDashOffset?this.strokeDashOffset:"0",m=this.strokeLineCap?this.strokeLineCap:"butt",g=this.strokeLineJoin?this.strokeLineJoin:"miter",d=this.strokeMiterLimit?this.strokeMiterLimit:"4",w=typeof this.opacity<"u"?this.opacity:"1",E=this.visible?"":" visibility: hidden;",O=C?"":this.getSvgFilter(),L=s("fill",this.fill),V=s("stroke",this.stroke);return[V,"stroke-width: ",l,"; ","stroke-dasharray: ",c,"; ","stroke-linecap: ",m,"; ","stroke-dashoffset: ",h,"; ","stroke-linejoin: ",g,"; ","stroke-miterlimit: ",d,"; ",L,"fill-rule: ",b,"; ","opacity: ",w,";",O,E].join("")},getSvgSpanStyles:function(C,b){var l="; ",h=C.fontFamily?"font-family: "+(C.fontFamily.indexOf("'")===-1&&C.fontFamily.indexOf('"')===-1?"'"+C.fontFamily+"'":C.fontFamily)+l:"",c=C.strokeWidth?"stroke-width: "+C.strokeWidth+l:"",h=h,m=C.fontSize?"font-size: "+C.fontSize+"px"+l:"",g=C.fontStyle?"font-style: "+C.fontStyle+l:"",d=C.fontWeight?"font-weight: "+C.fontWeight+l:"",w=C.fill?s("fill",C.fill):"",E=C.stroke?s("stroke",C.stroke):"",O=this.getSvgTextDecoration(C),L=C.deltaY?"baseline-shift: "+-C.deltaY+"; ":"";return O&&(O="text-decoration: "+O+l),[E,c,h,m,g,d,O,w,L,b?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(C){return["overline","underline","line-through"].filter(function(b){return C[b.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(C,b){var l=C?this.calcTransformMatrix():this.calcOwnMatrix(),c='transform="'+T.util.matrixToSVG(l);return c+(b||"")+'" '},_setSVGBg:function(C){if(this.backgroundColor){var b=T.Object.NUM_FRACTION_DIGITS;C.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',p(-this.width/2,b),'" y="',p(-this.height/2,b),'" width="',p(this.width,b),'" height="',p(this.height,b),`"></rect>
`)}},toSVG:function(C){return this._createBaseSVGMarkup(this._toSVG(C),{reviver:C})},toClipPathSVG:function(C){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(C),{reviver:C})},_createBaseClipPathSVGMarkup:function(C,b){b=b||{};var l=b.reviver,c=b.additionalTransform||"",h=[this.getSvgTransform(!0,c),this.getSvgCommons()].join(""),m=C.indexOf("COMMON_PARTS");return C[m]=h,l?l(C.join("")):C.join("")},_createBaseSVGMarkup:function(C,b){b=b||{};var l=b.noStyle,c=b.reviver,h=l?"":'style="'+this.getSvgStyles()+'" ',m=b.withShadow?'style="'+this.getSvgFilter()+'" ':"",g=this.clipPath,d=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",w=g&&g.absolutePositioned,E=this.stroke,O=this.fill,L=this.shadow,V,$=[],ne,xe=C.indexOf("COMMON_PARTS"),ze=b.additionalTransform;return g&&(g.clipPathId="CLIPPATH_"+T.Object.__uid++,ne='<clipPath id="'+g.clipPathId+`" >
`+g.toClipPathSVG(c)+`</clipPath>
`),w&&$.push("<g ",m,this.getSvgCommons(),` >
`),$.push("<g ",this.getSvgTransform(!1),w?"":m+this.getSvgCommons(),` >
`),V=[h,d,l?"":this.addPaintOrder()," ",ze?'transform="'+ze+'" ':""].join(""),C[xe]=V,O&&O.toLive&&$.push(O.toSVG(this)),E&&E.toLive&&$.push(E.toSVG(this)),L&&$.push(L.toSVG(this)),g&&$.push(ne),$.push(C.join("")),$.push(`</g>
`),w&&$.push(`</g>
`),c?c($.join("")):$.join("")},addPaintOrder:function(){return this.paintFirst!=="fill"?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var s=T.util.object.extend,p="stateProperties";function C(l,c,h){var m={},g=!0;h.forEach(function(d){m[d]=l[d]}),s(l[c],m,g)}function b(l,c,h){if(l===c)return!0;if(Array.isArray(l)){if(!Array.isArray(c)||l.length!==c.length)return!1;for(var m=0,g=l.length;m<g;m++)if(!b(l[m],c[m]))return!1;return!0}else if(l&&typeof l=="object"){var d=Object.keys(l),w;if(!c||typeof c!="object"||!h&&d.length!==Object.keys(c).length)return!1;for(var m=0,g=d.length;m<g;m++)if(w=d[m],!(w==="canvas"||w==="group")&&!b(l[w],c[w]))return!1;return!0}}T.util.object.extend(T.Object.prototype,{hasStateChanged:function(l){l=l||p;var c="_"+l;return Object.keys(this[c]).length<this[l].length?!0:!b(this[c],this,!0)},saveState:function(l){var c=l&&l.propertySet||p,h="_"+c;return this[h]?(C(this,h,this[c]),l&&l.stateProperties&&C(this,h,l.stateProperties),this):this.setupState(l)},setupState:function(l){l=l||{};var c=l.propertySet||p;return l.propertySet=c,this["_"+c]={},this.saveState(l),this}})}(),function(){var s=T.util.degreesToRadians;T.util.object.extend(T.Object.prototype,{_findTargetCorner:function(p,C){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var b=p.x,l=p.y,c,h,m=Object.keys(this.oCoords),g=m.length-1,d;for(this.__corner=0;g>=0;g--)if(d=m[g],!!this.isControlVisible(d)&&(h=this._getImageLines(C?this.oCoords[d].touchCorner:this.oCoords[d].corner),c=this._findCrossPoints({x:b,y:l},h),c!==0&&c%2===1))return this.__corner=d,d;return!1},forEachControl:function(p){for(var C in this.controls)p(this.controls[C],C,this)},_setCornerCoords:function(){var p=this.oCoords;for(var C in p){var b=this.controls[C];p[C].corner=b.calcCornerCoords(this.angle,this.cornerSize,p[C].x,p[C].y,!1),p[C].touchCorner=b.calcCornerCoords(this.angle,this.touchCornerSize,p[C].x,p[C].y,!0)}},drawSelectionBackground:function(p){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;p.save();var C=this.getCenterPoint(),b=this._calculateCurrentDimensions(),l=this.canvas.viewportTransform;return p.translate(C.x,C.y),p.scale(1/l[0],1/l[3]),p.rotate(s(this.angle)),p.fillStyle=this.selectionBackgroundColor,p.fillRect(-b.x/2,-b.y/2,b.x,b.y),p.restore(),this},drawBorders:function(p,C){C=C||{};var b=this._calculateCurrentDimensions(),l=this.borderScaleFactor,c=b.x+l,h=b.y+l,m=typeof C.hasControls<"u"?C.hasControls:this.hasControls,g=!1;return p.save(),p.strokeStyle=C.borderColor||this.borderColor,this._setLineDash(p,C.borderDashArray||this.borderDashArray),p.strokeRect(-c/2,-h/2,c,h),m&&(p.beginPath(),this.forEachControl(function(d,w,E){d.withConnection&&d.getVisibility(E,w)&&(g=!0,p.moveTo(d.x*c,d.y*h),p.lineTo(d.x*c+d.offsetX,d.y*h+d.offsetY))}),g&&p.stroke()),p.restore(),this},drawBordersInGroup:function(p,C,b){b=b||{};var l=T.util.sizeAfterTransform(this.width,this.height,C),c=this.strokeWidth,h=this.strokeUniform,m=this.borderScaleFactor,g=l.x+c*(h?this.canvas.getZoom():C.scaleX)+m,d=l.y+c*(h?this.canvas.getZoom():C.scaleY)+m;return p.save(),this._setLineDash(p,b.borderDashArray||this.borderDashArray),p.strokeStyle=b.borderColor||this.borderColor,p.strokeRect(-g/2,-d/2,g,d),p.restore(),this},drawControls:function(p,C){C=C||{},p.save();var b=this.canvas.getRetinaScaling(),l,c;return p.setTransform(b,0,0,b,0,0),p.strokeStyle=p.fillStyle=C.cornerColor||this.cornerColor,this.transparentCorners||(p.strokeStyle=C.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(p,C.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(l=this.group.calcTransformMatrix()),this.forEachControl(function(h,m,g){c=g.oCoords[m],h.getVisibility(g,m)&&(l&&(c=T.util.transformPoint(c,l)),h.render(p,c.x,c.y,C,g))}),p.restore(),this},isControlVisible:function(p){return this.controls[p]&&this.controls[p].getVisibility(this,p)},setControlVisible:function(p,C){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[p]=C,this},setControlsVisibility:function(p){p||(p={});for(var C in p)this.setControlVisible(C,p[C]);return this},onDeselect:function(){},onSelect:function(){}})}(),T.util.object.extend(T.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(s,p){p=p||{};var C=function(){},b=p.onComplete||C,l=p.onChange||C,c=this;return T.util.animate({target:this,startValue:s.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(h){s.set("left",h),c.requestRenderAll(),l()},onComplete:function(){s.setCoords(),b()}})},fxCenterObjectV:function(s,p){p=p||{};var C=function(){},b=p.onComplete||C,l=p.onChange||C,c=this;return T.util.animate({target:this,startValue:s.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(h){s.set("top",h),c.requestRenderAll(),l()},onComplete:function(){s.setCoords(),b()}})},fxRemove:function(s,p){p=p||{};var C=function(){},b=p.onComplete||C,l=p.onChange||C,c=this;return T.util.animate({target:this,startValue:s.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(h){s.set("opacity",h),c.requestRenderAll(),l()},onComplete:function(){c.remove(s),b()}})}}),T.util.object.extend(T.Object.prototype,{animate:function(){if(arguments[0]&&typeof arguments[0]=="object"){var s=[],p,C,b=[];for(p in arguments[0])s.push(p);for(var l=0,c=s.length;l<c;l++)p=s[l],C=l!==c-1,b.push(this._animate(p,arguments[0][p],arguments[1],C));return b}else return this._animate.apply(this,arguments)},_animate:function(s,p,C,b){var l=this,c;p=p.toString(),C?C=T.util.object.clone(C):C={},~s.indexOf(".")&&(c=s.split("."));var h=l.colorProperties.indexOf(s)>-1||c&&l.colorProperties.indexOf(c[1])>-1,m=c?this.get(c[0])[c[1]]:this.get(s);"from"in C||(C.from=m),h||(~p.indexOf("=")?p=m+parseFloat(p.replace("=","")):p=parseFloat(p));var g={target:this,startValue:C.from,endValue:p,byValue:C.by,easing:C.easing,duration:C.duration,abort:C.abort&&function(d,w,E){return C.abort.call(l,d,w,E)},onChange:function(d,w,E){c?l[c[0]][c[1]]=d:l.set(s,d),!b&&C.onChange&&C.onChange(d,w,E)},onComplete:function(d,w,E){b||(l.setCoords(),C.onComplete&&C.onComplete(d,w,E))}};return h?T.util.animateColor(g.startValue,g.endValue,g.duration,g):T.util.animate(g)}}),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.util.object.clone,l={x1:1,x2:1,y1:1,y2:1};if(p.Line){p.warn("fabric.Line is already defined");return}p.Line=p.util.createClass(p.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:p.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(h,m){h||(h=[0,0,0,0]),this.callSuper("initialize",m),this.set("x1",h[0]),this.set("y1",h[1]),this.set("x2",h[2]),this.set("y2",h[3]),this._setWidthHeight(m)},_setWidthHeight:function(h){h||(h={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in h?h.left:this._getLeftToOriginX(),this.top="top"in h?h.top:this._getTopToOriginY()},_set:function(h,m){return this.callSuper("_set",h,m),typeof l[h]<"u"&&this._setWidthHeight(),this},_getLeftToOriginX:c({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:c({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(h){h.beginPath();var m=this.calcLinePoints();h.moveTo(m.x1,m.y1),h.lineTo(m.x2,m.y2),h.lineWidth=this.strokeWidth;var g=h.strokeStyle;h.strokeStyle=this.stroke||h.fillStyle,this.stroke&&this._renderStroke(h),h.strokeStyle=g},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(h){return C(this.callSuper("toObject",h),this.calcLinePoints())},_getNonTransformedDimensions:function(){var h=this.callSuper("_getNonTransformedDimensions");return this.strokeLineCap==="butt"&&(this.width===0&&(h.y-=this.strokeWidth),this.height===0&&(h.x-=this.strokeWidth)),h},calcLinePoints:function(){var h=this.x1<=this.x2?-1:1,m=this.y1<=this.y2?-1:1,g=h*this.width*.5,d=m*this.height*.5,w=h*this.width*-.5,E=m*this.height*-.5;return{x1:g,x2:w,y1:d,y2:E}},_toSVG:function(){var h=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',h.x1,'" y1="',h.y1,'" x2="',h.x2,'" y2="',h.y2,`" />
`]}}),p.Line.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),p.Line.fromElement=function(h,m,g){g=g||{};var d=p.parseAttributes(h,p.Line.ATTRIBUTE_NAMES),w=[d.x1||0,d.y1||0,d.x2||0,d.y2||0];m(new p.Line(w,C(d,g)))},p.Line.fromObject=function(h,m){function g(w){delete w.points,m&&m(w)}var d=b(h,!0);d.points=[h.x1,h.y1,h.x2,h.y2],p.Object._fromObject("Line",d,g,"points")};function c(h,m){var g=h.origin,d=h.axis1,w=h.axis2,E=h.dimension,O=m.nearest,L=m.center,V=m.farthest;return function(){switch(this.get(g)){case O:return Math.min(this.get(d),this.get(w));case L:return Math.min(this.get(d),this.get(w))+.5*this.get(E);case V:return Math.max(this.get(d),this.get(w))}}}}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.util.degreesToRadians;if(p.Circle){p.warn("fabric.Circle is already defined.");return}p.Circle=p.util.createClass(p.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:p.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(l,c){return this.callSuper("_set",l,c),l==="radius"&&this.setRadius(c),this},toObject:function(l){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(l))},_toSVG:function(){var l,c=0,h=0,m=(this.endAngle-this.startAngle)%360;if(m===0)l=["<circle ","COMMON_PARTS",'cx="'+c+'" cy="'+h+'" ','r="',this.radius,`" />
`];else{var g=C(this.startAngle),d=C(this.endAngle),w=this.radius,E=p.util.cos(g)*w,O=p.util.sin(g)*w,L=p.util.cos(d)*w,V=p.util.sin(d)*w,$=m>180?"1":"0";l=['<path d="M '+E+" "+O," A "+w+" "+w," 0 ",+$+" 1"," "+L+" "+V,'" ',"COMMON_PARTS",` />
`]}return l},_render:function(l){l.beginPath(),l.arc(0,0,this.radius,C(this.startAngle),C(this.endAngle),!1),this._renderPaintInOrder(l)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(l){return this.radius=l,this.set("width",l*2).set("height",l*2)}}),p.Circle.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),p.Circle.fromElement=function(l,c){var h=p.parseAttributes(l,p.Circle.ATTRIBUTE_NAMES);if(!b(h))throw new Error("value of `r` attribute is required and can not be negative");h.left=(h.left||0)-h.radius,h.top=(h.top||0)-h.radius,c(new p.Circle(h))};function b(l){return"radius"in l&&l.radius>=0}p.Circle.fromObject=function(l,c){p.Object._fromObject("Circle",l,c)}}(Y),function(s){var p=s.fabric||(s.fabric={});if(p.Triangle){p.warn("fabric.Triangle is already defined");return}p.Triangle=p.util.createClass(p.Object,{type:"triangle",width:100,height:100,_render:function(C){var b=this.width/2,l=this.height/2;C.beginPath(),C.moveTo(-b,l),C.lineTo(0,-l),C.lineTo(b,l),C.closePath(),this._renderPaintInOrder(C)},_toSVG:function(){var C=this.width/2,b=this.height/2,l=[-C+" "+b,"0 "+-b,C+" "+b].join(",");return["<polygon ","COMMON_PARTS",'points="',l,'" />']}}),p.Triangle.fromObject=function(C,b){return p.Object._fromObject("Triangle",C,b)}}(Y),function(s){var p=s.fabric||(s.fabric={}),C=Math.PI*2;if(p.Ellipse){p.warn("fabric.Ellipse is already defined.");return}p.Ellipse=p.util.createClass(p.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:p.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(b){this.callSuper("initialize",b),this.set("rx",b&&b.rx||0),this.set("ry",b&&b.ry||0)},_set:function(b,l){switch(this.callSuper("_set",b,l),b){case"rx":this.rx=l,this.set("width",l*2);break;case"ry":this.ry=l,this.set("height",l*2);break}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(b){return this.callSuper("toObject",["rx","ry"].concat(b))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,`" />
`]},_render:function(b){b.beginPath(),b.save(),b.transform(1,0,0,this.ry/this.rx,0,0),b.arc(0,0,this.rx,0,C,!1),b.restore(),this._renderPaintInOrder(b)}}),p.Ellipse.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),p.Ellipse.fromElement=function(b,l){var c=p.parseAttributes(b,p.Ellipse.ATTRIBUTE_NAMES);c.left=(c.left||0)-c.rx,c.top=(c.top||0)-c.ry,l(new p.Ellipse(c))},p.Ellipse.fromObject=function(b,l){p.Object._fromObject("Ellipse",b,l)}}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend;if(p.Rect){p.warn("fabric.Rect is already defined");return}p.Rect=p.util.createClass(p.Object,{stateProperties:p.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:p.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(b){this.callSuper("initialize",b),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(b){var l=this.rx?Math.min(this.rx,this.width/2):0,c=this.ry?Math.min(this.ry,this.height/2):0,h=this.width,m=this.height,g=-this.width/2,d=-this.height/2,w=l!==0||c!==0,E=1-.5522847498;b.beginPath(),b.moveTo(g+l,d),b.lineTo(g+h-l,d),w&&b.bezierCurveTo(g+h-E*l,d,g+h,d+E*c,g+h,d+c),b.lineTo(g+h,d+m-c),w&&b.bezierCurveTo(g+h,d+m-E*c,g+h-E*l,d+m,g+h-l,d+m),b.lineTo(g+l,d+m),w&&b.bezierCurveTo(g+E*l,d+m,g,d+m-E*c,g,d+m-c),b.lineTo(g,d+c),w&&b.bezierCurveTo(g,d+E*c,g+E*l,d,g+l,d),b.closePath(),this._renderPaintInOrder(b)},toObject:function(b){return this.callSuper("toObject",["rx","ry"].concat(b))},_toSVG:function(){var b=-this.width/2,l=-this.height/2;return["<rect ","COMMON_PARTS",'x="',b,'" y="',l,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,`" />
`]}}),p.Rect.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),p.Rect.fromElement=function(b,l,c){if(!b)return l(null);c=c||{};var h=p.parseAttributes(b,p.Rect.ATTRIBUTE_NAMES);h.left=h.left||0,h.top=h.top||0,h.height=h.height||0,h.width=h.width||0;var m=new p.Rect(C(c?p.util.object.clone(c):{},h));m.visible=m.visible&&m.width>0&&m.height>0,l(m)},p.Rect.fromObject=function(b,l){return p.Object._fromObject("Rect",b,l)}}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.util.array.min,l=p.util.array.max,c=p.util.toFixed,h=p.util.projectStrokeOnPoints;if(p.Polyline){p.warn("fabric.Polyline is already defined");return}p.Polyline=p.util.createClass(p.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:p.Object.prototype.cacheProperties.concat("points"),initialize:function(m,g){g=g||{},this.points=m||[],this.callSuper("initialize",g),this._setPositionDimensions(g)},_projectStrokeOnPoints:function(){return h(this.points,this,!0)},_setPositionDimensions:function(m){var g=this._calcDimensions(m),d,w=this.exactBoundingBox?this.strokeWidth:0;this.width=g.width-w,this.height=g.height-w,m.fromSVG||(d=this.translateToGivenOrigin({x:g.left-this.strokeWidth/2+w/2,y:g.top-this.strokeWidth/2+w/2},"left","top",this.originX,this.originY)),typeof m.left>"u"&&(this.left=m.fromSVG?g.left:d.x),typeof m.top>"u"&&(this.top=m.fromSVG?g.top:d.y),this.pathOffset={x:g.left+this.width/2+w/2,y:g.top+this.height/2+w/2}},_calcDimensions:function(){var m=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,g=b(m,"x")||0,d=b(m,"y")||0,w=l(m,"x")||0,E=l(m,"y")||0,O=w-g,L=E-d;return{left:g,top:d,width:O,height:L}},toObject:function(m){return C(this.callSuper("toObject",m),{points:this.points.concat()})},_toSVG:function(){for(var m=[],g=this.pathOffset.x,d=this.pathOffset.y,w=p.Object.NUM_FRACTION_DIGITS,E=0,O=this.points.length;E<O;E++)m.push(c(this.points[E].x-g,w),",",c(this.points[E].y-d,w)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',m.join(""),`" />
`]},commonRender:function(m){var g,d=this.points.length,w=this.pathOffset.x,E=this.pathOffset.y;if(!d||isNaN(this.points[d-1].y))return!1;m.beginPath(),m.moveTo(this.points[0].x-w,this.points[0].y-E);for(var O=0;O<d;O++)g=this.points[O],m.lineTo(g.x-w,g.y-E);return!0},_render:function(m){this.commonRender(m)&&this._renderPaintInOrder(m)},complexity:function(){return this.get("points").length}}),p.Polyline.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat(),p.Polyline.fromElementGenerator=function(m){return function(g,d,w){if(!g)return d(null);w||(w={});var E=p.parsePointsAttribute(g.getAttribute("points")),O=p.parseAttributes(g,p[m].ATTRIBUTE_NAMES);O.fromSVG=!0,d(new p[m](E,C(O,w)))}},p.Polyline.fromElement=p.Polyline.fromElementGenerator("Polyline"),p.Polyline.fromObject=function(m,g){return p.Object._fromObject("Polyline",m,g,"points")}}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.util.projectStrokeOnPoints;if(p.Polygon){p.warn("fabric.Polygon is already defined");return}p.Polygon=p.util.createClass(p.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return C(this.points,this)},_render:function(b){this.commonRender(b)&&(b.closePath(),this._renderPaintInOrder(b))}}),p.Polygon.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat(),p.Polygon.fromElement=p.Polyline.fromElementGenerator("Polygon"),p.Polygon.fromObject=function(b,l){p.Object._fromObject("Polygon",b,l,"points")}}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.util.array.min,b=p.util.array.max,l=p.util.object.extend,c=p.util.object.clone,h=p.util.toFixed;if(p.Path){p.warn("fabric.Path is already defined");return}p.Path=p.util.createClass(p.Object,{type:"path",path:null,cacheProperties:p.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:p.Object.prototype.stateProperties.concat("path"),initialize:function(m,g){g=c(g||{}),delete g.path,this.callSuper("initialize",g),this._setPath(m||[],g)},_setPath:function(m,g){this.path=p.util.makePathSimpler(Array.isArray(m)?m:p.util.parsePath(m)),p.Polyline.prototype._setPositionDimensions.call(this,g||{})},_renderPathCommands:function(m){var g,d=0,w=0,E=0,O=0,L=0,V=0,$=-this.pathOffset.x,ne=-this.pathOffset.y;m.beginPath();for(var xe=0,ze=this.path.length;xe<ze;++xe)switch(g=this.path[xe],g[0]){case"L":E=g[1],O=g[2],m.lineTo(E+$,O+ne);break;case"M":E=g[1],O=g[2],d=E,w=O,m.moveTo(E+$,O+ne);break;case"C":E=g[5],O=g[6],L=g[3],V=g[4],m.bezierCurveTo(g[1]+$,g[2]+ne,L+$,V+ne,E+$,O+ne);break;case"Q":m.quadraticCurveTo(g[1]+$,g[2]+ne,g[3]+$,g[4]+ne),E=g[3],O=g[4],L=g[1],V=g[2];break;case"z":case"Z":E=d,O=w,m.closePath();break}},_render:function(m){this._renderPathCommands(m),this._renderPaintInOrder(m)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(m){return l(this.callSuper("toObject",m),{path:this.path.map(function(g){return g.slice()})})},toDatalessObject:function(m){var g=this.toObject(["sourcePath"].concat(m));return g.sourcePath&&delete g.path,g},_toSVG:function(){var m=p.util.joinPath(this.path);return["<path ","COMMON_PARTS",'d="',m,'" stroke-linecap="round" ',`/>
`]},_getOffsetTransform:function(){var m=p.Object.NUM_FRACTION_DIGITS;return" translate("+h(-this.pathOffset.x,m)+", "+h(-this.pathOffset.y,m)+")"},toClipPathSVG:function(m){var g=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:m,additionalTransform:g})},toSVG:function(m){var g=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:m,additionalTransform:g})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var m=[],g=[],d,w=0,E=0,O=0,L=0,V,$=0,ne=this.path.length;$<ne;++$){switch(d=this.path[$],d[0]){case"L":O=d[1],L=d[2],V=[];break;case"M":O=d[1],L=d[2],w=O,E=L,V=[];break;case"C":V=p.util.getBoundsOfCurve(O,L,d[1],d[2],d[3],d[4],d[5],d[6]),O=d[5],L=d[6];break;case"Q":V=p.util.getBoundsOfCurve(O,L,d[1],d[2],d[1],d[2],d[3],d[4]),O=d[3],L=d[4];break;case"z":case"Z":O=w,L=E;break}V.forEach(function(nt){m.push(nt.x),g.push(nt.y)}),m.push(O),g.push(L)}var xe=C(m)||0,ze=C(g)||0,Ke=b(m)||0,Je=b(g)||0,tt=Ke-xe,ht=Je-ze;return{left:xe,top:ze,width:tt,height:ht}}}),p.Path.fromObject=function(m,g){if(typeof m.sourcePath=="string"){var d=m.sourcePath;p.loadSVGFromURL(d,function(w){var E=w[0];E.setOptions(m),m.clipPath?p.util.enlivenObjects([m.clipPath],function(O){E.clipPath=O[0],g&&g(E)}):g&&g(E)})}else p.Object._fromObject("Path",m,g,"path")},p.Path.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat(["d"]),p.Path.fromElement=function(m,g,d){var w=p.parseAttributes(m,p.Path.ATTRIBUTE_NAMES);w.fromSVG=!0,g(new p.Path(w.d,l(w,d)))}}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.util.array.min,b=p.util.array.max;p.Group||(p.Group=p.util.createClass(p.Object,p.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(l,c,h){c=c||{},this._objects=[],h&&this.callSuper("initialize",c),this._objects=l||[];for(var m=this._objects.length;m--;)this._objects[m].group=this;if(h)this._updateObjectsACoords();else{var g=c&&c.centerPoint;c.originX!==void 0&&(this.originX=c.originX),c.originY!==void 0&&(this.originY=c.originY),g||this._calcBounds(),this._updateObjectsCoords(g),delete c.centerPoint,this.callSuper("initialize",c)}this.setCoords()},_updateObjectsACoords:function(){for(var l=!0,c=this._objects.length;c--;)this._objects[c].setCoords(l)},_updateObjectsCoords:function(c){for(var c=c||this.getCenterPoint(),h=this._objects.length;h--;)this._updateObjectCoords(this._objects[h],c)},_updateObjectCoords:function(l,c){var h=l.left,m=l.top,g=!0;l.set({left:h-c.x,top:m-c.y}),l.group=this,l.setCoords(g)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(l){var c=!!this.group;return this._restoreObjectsState(),p.util.resetObjectTransform(this),l&&(c&&p.util.removeTransformFromObject(l,this.group.calcTransformMatrix()),this._objects.push(l),l.group=this,l._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,c?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(l){return this._restoreObjectsState(),p.util.resetObjectTransform(this),this.remove(l),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(l){this.dirty=!0,l.group=this,l._set("canvas",this.canvas)},_onObjectRemoved:function(l){this.dirty=!0,delete l.group},_set:function(l,c){var h=this._objects.length;if(this.useSetOnGroup)for(;h--;)this._objects[h].setOnGroup(l,c);if(l==="canvas")for(;h--;)this._objects[h]._set(l,c);p.Object.prototype._set.call(this,l,c)},toObject:function(l){var c=this.includeDefaultValues,h=this._objects.filter(function(g){return!g.excludeFromExport}).map(function(g){var d=g.includeDefaultValues;g.includeDefaultValues=c;var w=g.toObject(l);return g.includeDefaultValues=d,w}),m=p.Object.prototype.toObject.call(this,l);return m.objects=h,m},toDatalessObject:function(l){var c,h=this.sourcePath;if(h)c=h;else{var m=this.includeDefaultValues;c=this._objects.map(function(d){var w=d.includeDefaultValues;d.includeDefaultValues=m;var E=d.toDatalessObject(l);return d.includeDefaultValues=w,E})}var g=p.Object.prototype.toDatalessObject.call(this,l);return g.objects=c,g},render:function(l){this._transformDone=!0,this.callSuper("render",l),this._transformDone=!1},shouldCache:function(){var l=p.Object.prototype.shouldCache.call(this);if(l){for(var c=0,h=this._objects.length;c<h;c++)if(this._objects[c].willDrawShadow())return this.ownCaching=!1,!1}return l},willDrawShadow:function(){if(p.Object.prototype.willDrawShadow.call(this))return!0;for(var l=0,c=this._objects.length;l<c;l++)if(this._objects[l].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(l){for(var c=0,h=this._objects.length;c<h;c++)this._objects[c].render(l);this._drawClipPath(l,this.clipPath)},isCacheDirty:function(l){if(this.callSuper("isCacheDirty",l))return!0;if(!this.statefullCache)return!1;for(var c=0,h=this._objects.length;c<h;c++)if(this._objects[c].isCacheDirty(!0)){if(this._cacheCanvas){var m=this.cacheWidth/this.zoomX,g=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-m/2,-g/2,m,g)}return!0}return!1},_restoreObjectsState:function(){var l=this.calcOwnMatrix();return this._objects.forEach(function(c){p.util.addTransformToObject(c,l),delete c.group,c.setCoords()}),this},destroy:function(){return this._objects.forEach(function(l){l.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(l){l.dispose&&l.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var l=this._objects,c=this.canvas;this._objects=[];var h=this.toObject();delete h.objects;var m=new p.ActiveSelection([]);return m.set(h),m.type="activeSelection",c.remove(this),l.forEach(function(g){g.group=m,g.dirty=!0,c.add(g)}),m.canvas=c,m._objects=l,c._activeObject=m,m.setCoords(),m}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){var l=!0;return this.forEachObject(function(c){c.setCoords(l)}),this},_calcBounds:function(l){for(var c=[],h=[],m,g,d,w=["tr","br","bl","tl"],E=0,O=this._objects.length,L,V=w.length;E<O;++E){for(m=this._objects[E],d=m.calcACoords(),L=0;L<V;L++)g=w[L],c.push(d[g].x),h.push(d[g].y);m.aCoords=d}this._getBounds(c,h,l)},_getBounds:function(l,c,h){var m=new p.Point(C(l),C(c)),g=new p.Point(b(l),b(c)),d=m.y||0,w=m.x||0,E=g.x-m.x||0,O=g.y-m.y||0;this.width=E,this.height=O,h||this.setPositionByOrigin({x:w,y:d},"left","top")},_toSVG:function(l){for(var c=["<g ","COMMON_PARTS",` >
`],h=0,m=this._objects.length;h<m;h++)c.push("		",this._objects[h].toSVG(l));return c.push(`</g>
`),c},getSvgStyles:function(){var l=typeof this.opacity<"u"&&this.opacity!==1?"opacity: "+this.opacity+";":"",c=this.visible?"":" visibility: hidden;";return[l,this.getSvgFilter(),c].join("")},toClipPathSVG:function(l){for(var c=[],h=0,m=this._objects.length;h<m;h++)c.push("	",this._objects[h].toClipPathSVG(l));return this._createBaseClipPathSVGMarkup(c,{reviver:l})}}),p.Group.fromObject=function(l,c){var h=l.objects,m=p.util.object.clone(l,!0);if(delete m.objects,typeof h=="string"){p.loadSVGFromURL(h,function(g){var d=p.util.groupSVGElements(g,l,h),w=m.clipPath;delete m.clipPath,d.set(m),w?p.util.enlivenObjects([w],function(E){d.clipPath=E[0],c&&c(d)}):c&&c(d)});return}p.util.enlivenObjects(h,function(g){p.util.enlivenObjectEnlivables(l,m,function(){c&&c(new p.Group(g,m,!0))})})})}(Y),function(s){var p=s.fabric||(s.fabric={});p.ActiveSelection||(p.ActiveSelection=p.util.createClass(p.Group,{type:"activeSelection",initialize:function(C,b){b=b||{},this._objects=C||[];for(var l=this._objects.length;l--;)this._objects[l].group=this;b.originX&&(this.originX=b.originX),b.originY&&(this.originY=b.originY),this._calcBounds(),this._updateObjectsCoords(),p.Object.prototype.initialize.call(this,b),this.setCoords()},toGroup:function(){var C=this._objects.concat();this._objects=[];var b=p.Object.prototype.toObject.call(this),l=new p.Group([]);if(delete b.type,l.set(b),C.forEach(function(h){h.canvas.remove(h),h.group=l}),l._objects=C,!this.canvas)return l;var c=this.canvas;return c.add(l),c._activeObject=l,l.setCoords(),l},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(C,b,l){C.save(),C.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",C,b),l=l||{},typeof l.hasControls>"u"&&(l.hasControls=!1),l.forActiveSelection=!0;for(var c=0,h=this._objects.length;c<h;c++)this._objects[c]._renderControls(C,l);C.restore()}}),p.ActiveSelection.fromObject=function(C,b){p.util.enlivenObjects(C.objects,function(l){delete C.objects,b&&b(new p.ActiveSelection(l,C,!0))})})}(Y),function(s){var p=T.util.object.extend;if(s.fabric||(s.fabric={}),s.fabric.Image){T.warn("fabric.Image is already defined.");return}T.Image=T.util.createClass(T.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:T.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:T.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(C,b){b||(b={}),this.filters=[],this.cacheKey="texture"+T.Object.__uid++,this.callSuper("initialize",b),this._initElement(C,b)},getElement:function(){return this._element||{}},setElement:function(C,b){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=C,this._originalElement=C,this._initConfig(b),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(C){var b=T.filterBackend;b&&b.evictCachesForKey&&b.evictCachesForKey(C)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((function(C){T.util.cleanUpJsdomNode(this[C]),this[C]=void 0}).bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var C=this.getElement();return{width:C.naturalWidth||C.width,height:C.naturalHeight||C.height}},_stroke:function(C){if(!(!this.stroke||this.strokeWidth===0)){var b=this.width/2,l=this.height/2;C.beginPath(),C.moveTo(-b,-l),C.lineTo(b,-l),C.lineTo(b,l),C.lineTo(-b,l),C.lineTo(-b,-l),C.closePath()}},toObject:function(C){var b=[];this.filters.forEach(function(c){c&&b.push(c.toObject())});var l=p(this.callSuper("toObject",["cropX","cropY"].concat(C)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:b});return this.resizeFilter&&(l.resizeFilter=this.resizeFilter.toObject()),l},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var C=[],b=[],l,c=this._element,h=-this.width/2,m=-this.height/2,g="",d="";if(!c)return[];if(this.hasCrop()){var w=T.Object.__uid++;C.push('<clipPath id="imageCrop_'+w+`">
`,'	<rect x="'+h+'" y="'+m+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),g=' clip-path="url(#imageCrop_'+w+')" '}if(this.imageSmoothing||(d='" image-rendering="optimizeSpeed'),b.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',h-this.cropX,'" y="',m-this.cropY,'" width="',c.width||c.naturalWidth,'" height="',c.height||c.height,d,'"',g,`></image>
`),this.stroke||this.strokeDashArray){var E=this.fill;this.fill=null,l=["	<rect ",'x="',h,'" y="',m,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),`"/>
`],this.fill=E}return this.paintFirst!=="fill"?C=C.concat(l,b):C=C.concat(b,l),C},getSrc:function(C){var b=C?this._element:this._originalElement;return b?b.toDataURL?b.toDataURL():this.srcFromAttribute?b.getAttribute("src"):b.src:this.src||""},setSrc:function(C,b,l){return T.util.loadImage(C,function(c,h){this.setElement(c,l),this._setWidthHeight(),b&&b(this,h)},this,l&&l.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var C=this.resizeFilter,b=this.minimumScaleTrigger,l=this.getTotalObjectScaling(),c=l.scaleX,h=l.scaleY,m=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!C||c>b&&h>b){this._element=m,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=c,this._lastScaleY=h;return}T.filterBackend||(T.filterBackend=T.initFilterBackend());var g=T.util.createCanvasElement(),d=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,w=m.width,E=m.height;g.width=w,g.height=E,this._element=g,this._lastScaleX=C.scaleX=c,this._lastScaleY=C.scaleY=h,T.filterBackend.applyFilters([C],m,w,E,this._element,d),this._filterScalingX=g.width/this._originalElement.width,this._filterScalingY=g.height/this._originalElement.height},applyFilters:function(C){if(C=C||this.filters||[],C=C.filter(function(m){return m&&!m.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),C.length===0)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var b=this._originalElement,l=b.naturalWidth||b.width,c=b.naturalHeight||b.height;if(this._element===this._originalElement){var h=T.util.createCanvasElement();h.width=l,h.height=c,this._element=h,this._filteredEl=h}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,l,c),this._lastScaleX=1,this._lastScaleY=1;return T.filterBackend||(T.filterBackend=T.initFilterBackend()),T.filterBackend.applyFilters(C,this._originalElement,l,c,this._element,this.cacheKey),(this._originalElement.width!==this._element.width||this._originalElement.height!==this._element.height)&&(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(C){T.util.setImageSmoothing(C,this.imageSmoothing),this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(C),this._renderPaintInOrder(C)},drawCacheOnCanvas:function(C){T.util.setImageSmoothing(C,this.imageSmoothing),T.Object.prototype.drawCacheOnCanvas.call(this,C)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(C){var b=this._element;if(b){var l=this._filterScalingX,c=this._filterScalingY,h=this.width,m=this.height,g=Math.min,d=Math.max,w=d(this.cropX,0),E=d(this.cropY,0),O=b.naturalWidth||b.width,L=b.naturalHeight||b.height,V=w*l,$=E*c,ne=g(h*l,O-V),xe=g(m*c,L-$),ze=-h/2,Ke=-m/2,Je=g(h,O/l-w),tt=g(m,L/c-E);b&&C.drawImage(b,V,$,ne,xe,ze,Ke,Je,tt)}},_needsResize:function(){var C=this.getTotalObjectScaling();return C.scaleX!==this._lastScaleX||C.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(C,b){this.setElement(T.util.getById(C),b),T.util.addClass(this.getElement(),T.Image.CSS_CANVAS)},_initConfig:function(C){C||(C={}),this.setOptions(C),this._setWidthHeight(C)},_initFilters:function(C,b){C&&C.length?T.util.enlivenObjects(C,function(l){b&&b(l)},"fabric.Image.filters"):b&&b()},_setWidthHeight:function(C){C||(C={});var b=this.getElement();this.width=C.width||b.naturalWidth||b.width||0,this.height=C.height||b.naturalHeight||b.height||0},parsePreserveAspectRatioAttribute:function(){var C=T.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),b=this._element.width,l=this._element.height,c=1,h=1,m=0,g=0,d=0,w=0,E,O=this.width,L=this.height,V={width:O,height:L};return C&&(C.alignX!=="none"||C.alignY!=="none")?(C.meetOrSlice==="meet"&&(c=h=T.util.findScaleToFit(this._element,V),E=(O-b*c)/2,C.alignX==="Min"&&(m=-E),C.alignX==="Max"&&(m=E),E=(L-l*h)/2,C.alignY==="Min"&&(g=-E),C.alignY==="Max"&&(g=E)),C.meetOrSlice==="slice"&&(c=h=T.util.findScaleToCover(this._element,V),E=b-O/c,C.alignX==="Mid"&&(d=E/2),C.alignX==="Max"&&(d=E),E=l-L/h,C.alignY==="Mid"&&(w=E/2),C.alignY==="Max"&&(w=E),b=O/c,l=L/h)):(c=O/b,h=L/l),{width:b,height:l,scaleX:c,scaleY:h,offsetLeft:m,offsetTop:g,cropX:d,cropY:w}}}),T.Image.CSS_CANVAS="canvas-img",T.Image.prototype.getSvgSrc=T.Image.prototype.getSrc,T.Image.fromObject=function(C,b){var l=T.util.object.clone(C);T.util.loadImage(l.src,function(c,h){if(h){b&&b(null,!0);return}T.Image.prototype._initFilters.call(l,l.filters,function(m){l.filters=m||[],T.Image.prototype._initFilters.call(l,[l.resizeFilter],function(g){l.resizeFilter=g[0],T.util.enlivenObjectEnlivables(l,l,function(){var d=new T.Image(c,l);b(d,!1)})})})},null,l.crossOrigin)},T.Image.fromURL=function(C,b,l){T.util.loadImage(C,function(c,h){b&&b(new T.Image(c,l),h)},null,l&&l.crossOrigin)},T.Image.ATTRIBUTE_NAMES=T.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),T.Image.fromElement=function(C,b,l){var c=T.parseAttributes(C,T.Image.ATTRIBUTE_NAMES);T.Image.fromURL(c["xlink:href"],b,p(l?T.util.object.clone(l):{},c))}}(Y),T.util.object.extend(T.Object.prototype,{_getAngleValueForStraighten:function(){var s=this.angle%360;return s>0?Math.round((s-1)/90)*90:Math.round(s/90)*90},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(s){s=s||{};var p=function(){},C=s.onComplete||p,b=s.onChange||p,l=this;return T.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(c){l.rotate(c),b()},onComplete:function(){l.setCoords(),C()}})}}),T.util.object.extend(T.StaticCanvas.prototype,{straightenObject:function(s){return s.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(s){return s.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){function s(C,b){var l="precision "+b+` float;
void main(){}`,c=C.createShader(C.FRAGMENT_SHADER);return C.shaderSource(c,l),C.compileShader(c),!!C.getShaderParameter(c,C.COMPILE_STATUS)}T.isWebglSupported=function(C){if(T.isLikelyNode)return!1;C=C||T.WebglFilterBackend.prototype.tileSize;var b=document.createElement("canvas"),l=b.getContext("webgl")||b.getContext("experimental-webgl"),c=!1;if(l){T.maxTextureSize=l.getParameter(l.MAX_TEXTURE_SIZE),c=T.maxTextureSize>=C;for(var h=["highp","mediump","lowp"],m=0;m<3;m++)if(s(l,h[m])){T.webGlPrecision=h[m];break}}return this.isSupported=c,c},T.WebglFilterBackend=p;function p(C){C&&C.tileSize&&(this.tileSize=C.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}p.prototype={tileSize:2048,resources:{},setupGLContext:function(C,b){this.dispose(),this.createWebGLCanvas(C,b),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(C,b)},chooseFastestCopyGLTo2DMethod:function(C,b){var l=typeof window.performance<"u",c;try{new ImageData(1,1),c=!0}catch{c=!1}var h=typeof ArrayBuffer<"u",m=typeof Uint8ClampedArray<"u";if(l&&c&&h&&m){var g=T.util.createCanvasElement(),d=new ArrayBuffer(C*b*4);if(T.forceGLPutImageData){this.imageBuffer=d,this.copyGLTo2D=N;return}var w={imageBuffer:d,destinationWidth:C,destinationHeight:b,targetCanvas:g},E,O,L;g.width=C,g.height=b,E=window.performance.now(),Ie.call(w,this.gl,w),O=window.performance.now()-E,E=window.performance.now(),N.call(w,this.gl,w),L=window.performance.now()-E,O>L?(this.imageBuffer=d,this.copyGLTo2D=N):this.copyGLTo2D=Ie}},createWebGLCanvas:function(C,b){var l=T.util.createCanvasElement();l.width=C,l.height=b;var c={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},h=l.getContext("webgl",c);h||(h=l.getContext("experimental-webgl",c)),h&&(h.clearColor(0,0,0,0),this.canvas=l,this.gl=h)},applyFilters:function(C,b,l,c,h,m){var g=this.gl,d;m&&(d=this.getCachedTexture(m,b));var w={originalWidth:b.width||b.originalWidth,originalHeight:b.height||b.originalHeight,sourceWidth:l,sourceHeight:c,destinationWidth:l,destinationHeight:c,context:g,sourceTexture:this.createTexture(g,l,c,!d&&b),targetTexture:this.createTexture(g,l,c),originalTexture:d||this.createTexture(g,l,c,!d&&b),passes:C.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:h},E=g.createFramebuffer();return g.bindFramebuffer(g.FRAMEBUFFER,E),C.forEach(function(O){O&&O.applyTo(w)}),he(w),this.copyGLTo2D(g,w),g.bindTexture(g.TEXTURE_2D,null),g.deleteTexture(w.sourceTexture),g.deleteTexture(w.targetTexture),g.deleteFramebuffer(E),h.getContext("2d").setTransform(1,0,0,1,0,0),w},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(C,b,l,c,h){var m=C.createTexture();return C.bindTexture(C.TEXTURE_2D,m),C.texParameteri(C.TEXTURE_2D,C.TEXTURE_MAG_FILTER,h||C.NEAREST),C.texParameteri(C.TEXTURE_2D,C.TEXTURE_MIN_FILTER,h||C.NEAREST),C.texParameteri(C.TEXTURE_2D,C.TEXTURE_WRAP_S,C.CLAMP_TO_EDGE),C.texParameteri(C.TEXTURE_2D,C.TEXTURE_WRAP_T,C.CLAMP_TO_EDGE),c?C.texImage2D(C.TEXTURE_2D,0,C.RGBA,C.RGBA,C.UNSIGNED_BYTE,c):C.texImage2D(C.TEXTURE_2D,0,C.RGBA,b,l,0,C.RGBA,C.UNSIGNED_BYTE,null),m},getCachedTexture:function(C,b){if(this.textureCache[C])return this.textureCache[C];var l=this.createTexture(this.gl,b.width,b.height,b);return this.textureCache[C]=l,l},evictCachesForKey:function(C){this.textureCache[C]&&(this.gl.deleteTexture(this.textureCache[C]),delete this.textureCache[C])},copyGLTo2D:Ie,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var C=this.gl,b={renderer:"",vendor:""};if(!C)return b;var l=C.getExtension("WEBGL_debug_renderer_info");if(l){var c=C.getParameter(l.UNMASKED_RENDERER_WEBGL),h=C.getParameter(l.UNMASKED_VENDOR_WEBGL);c&&(b.renderer=c.toLowerCase()),h&&(b.vendor=h.toLowerCase())}return this.gpuInfo=b,b}}}();function he(s){var p=s.targetCanvas,C=p.width,b=p.height,l=s.destinationWidth,c=s.destinationHeight;(C!==l||b!==c)&&(p.width=l,p.height=c)}function Ie(s,p){var C=s.canvas,b=p.targetCanvas,l=b.getContext("2d");l.translate(0,b.height),l.scale(1,-1);var c=C.height-b.height;l.drawImage(C,0,c,b.width,b.height,0,0,b.width,b.height)}function N(s,p){var C=p.targetCanvas,b=C.getContext("2d"),l=p.destinationWidth,c=p.destinationHeight,h=l*c*4,m=new Uint8Array(this.imageBuffer,0,h),g=new Uint8ClampedArray(this.imageBuffer,0,h);s.readPixels(0,0,l,c,s.RGBA,s.UNSIGNED_BYTE,m);var d=new ImageData(g,l,c);b.putImageData(d,0,0)}(function(){var s=function(){};T.Canvas2dFilterBackend=p;function p(){}p.prototype={evictCachesForKey:s,dispose:s,clearWebGLCaches:s,resources:{},applyFilters:function(C,b,l,c,h){var m=h.getContext("2d");m.drawImage(b,0,0,l,c);var g=m.getImageData(0,0,l,c),d=m.getImageData(0,0,l,c),w={sourceWidth:l,sourceHeight:c,imageData:g,originalEl:b,originalImageData:d,canvasEl:h,ctx:m,filterBackend:this};return C.forEach(function(E){E.applyTo(w)}),(w.imageData.width!==l||w.imageData.height!==c)&&(h.width=w.imageData.width,h.height=w.imageData.height),m.putImageData(w.imageData,0,0),w}}})(),T.Image=T.Image||{},T.Image.filters=T.Image.filters||{},T.Image.filters.BaseFilter=T.util.createClass({type:"BaseFilter",vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
void main() {
vTexCoord = aPosition;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:`precision highp float;
varying vec2 vTexCoord;
uniform sampler2D uTexture;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
}`,initialize:function(s){s&&this.setOptions(s)},setOptions:function(s){for(var p in s)this[p]=s[p]},createProgram:function(s,p,C){p=p||this.fragmentSource,C=C||this.vertexSource,T.webGlPrecision!=="highp"&&(p=p.replace(/precision highp float/g,"precision "+T.webGlPrecision+" float"));var b=s.createShader(s.VERTEX_SHADER);if(s.shaderSource(b,C),s.compileShader(b),!s.getShaderParameter(b,s.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+s.getShaderInfoLog(b));var l=s.createShader(s.FRAGMENT_SHADER);if(s.shaderSource(l,p),s.compileShader(l),!s.getShaderParameter(l,s.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+s.getShaderInfoLog(l));var c=s.createProgram();if(s.attachShader(c,b),s.attachShader(c,l),s.linkProgram(c),!s.getProgramParameter(c,s.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+s.getProgramInfoLog(c));var h=this.getAttributeLocations(s,c),m=this.getUniformLocations(s,c)||{};return m.uStepW=s.getUniformLocation(c,"uStepW"),m.uStepH=s.getUniformLocation(c,"uStepH"),{program:c,attributeLocations:h,uniformLocations:m}},getAttributeLocations:function(s,p){return{aPosition:s.getAttribLocation(p,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(s,p,C){var b=p.aPosition,l=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,l),s.enableVertexAttribArray(b),s.vertexAttribPointer(b,2,s.FLOAT,!1,0,0),s.bufferData(s.ARRAY_BUFFER,C,s.STATIC_DRAW)},_setupFrameBuffer:function(s){var p=s.context,C,b;s.passes>1?(C=s.destinationWidth,b=s.destinationHeight,(s.sourceWidth!==C||s.sourceHeight!==b)&&(p.deleteTexture(s.targetTexture),s.targetTexture=s.filterBackend.createTexture(p,C,b)),p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,s.targetTexture,0)):(p.bindFramebuffer(p.FRAMEBUFFER,null),p.finish())},_swapTextures:function(s){s.passes--,s.pass++;var p=s.targetTexture;s.targetTexture=s.sourceTexture,s.sourceTexture=p},isNeutralState:function(){var s=this.mainParameter,p=T.Image.filters[this.type].prototype;if(s)if(Array.isArray(p[s])){for(var C=p[s].length;C--;)if(this[s][C]!==p[s][C])return!1;return!0}else return p[s]===this[s];else return!1},applyTo:function(s){s.webgl?(this._setupFrameBuffer(s),this.applyToWebGL(s),this._swapTextures(s)):this.applyTo2d(s)},retrieveShader:function(s){return s.programCache.hasOwnProperty(this.type)||(s.programCache[this.type]=this.createProgram(s.context)),s.programCache[this.type]},applyToWebGL:function(s){var p=s.context,C=this.retrieveShader(s);s.pass===0&&s.originalTexture?p.bindTexture(p.TEXTURE_2D,s.originalTexture):p.bindTexture(p.TEXTURE_2D,s.sourceTexture),p.useProgram(C.program),this.sendAttributeData(p,C.attributeLocations,s.aPosition),p.uniform1f(C.uniformLocations.uStepW,1/s.sourceWidth),p.uniform1f(C.uniformLocations.uStepH,1/s.sourceHeight),this.sendUniformData(p,C.uniformLocations),p.viewport(0,0,s.destinationWidth,s.destinationHeight),p.drawArrays(p.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(s,p,C){s.activeTexture(C),s.bindTexture(s.TEXTURE_2D,p),s.activeTexture(s.TEXTURE0)},unbindAdditionalTexture:function(s,p){s.activeTexture(p),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(s){this[this.mainParameter]=s},sendUniformData:function(){},createHelpLayer:function(s){if(!s.helpLayer){var p=document.createElement("canvas");p.width=s.sourceWidth,p.height=s.sourceHeight,s.helpLayer=p}},toObject:function(){var s={type:this.type},p=this.mainParameter;return p&&(s[p]=this[p]),s},toJSON:function(){return this.toObject()}}),T.Image.filters.BaseFilter.fromObject=function(s,p){var C=new T.Image.filters[s.type](s);return p&&p(C),C},function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.ColorMatrix=b(C.BaseFilter,{type:"ColorMatrix",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
uniform mat4 uColorMatrix;
uniform vec4 uConstants;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color *= uColorMatrix;
color += uConstants;
gl_FragColor = color;
}`,matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(l){this.callSuper("initialize",l),this.matrix=this.matrix.slice(0)},applyTo2d:function(l){var c=l.imageData,h=c.data,m=h.length,g=this.matrix,d,w,E,O,L,V=this.colorsOnly;for(L=0;L<m;L+=4)d=h[L],w=h[L+1],E=h[L+2],V?(h[L]=d*g[0]+w*g[1]+E*g[2]+g[4]*255,h[L+1]=d*g[5]+w*g[6]+E*g[7]+g[9]*255,h[L+2]=d*g[10]+w*g[11]+E*g[12]+g[14]*255):(O=h[L+3],h[L]=d*g[0]+w*g[1]+E*g[2]+O*g[3]+g[4]*255,h[L+1]=d*g[5]+w*g[6]+E*g[7]+O*g[8]+g[9]*255,h[L+2]=d*g[10]+w*g[11]+E*g[12]+O*g[13]+g[14]*255,h[L+3]=d*g[15]+w*g[16]+E*g[17]+O*g[18]+g[19]*255)},getUniformLocations:function(l,c){return{uColorMatrix:l.getUniformLocation(c,"uColorMatrix"),uConstants:l.getUniformLocation(c,"uConstants")}},sendUniformData:function(l,c){var h=this.matrix,m=[h[0],h[1],h[2],h[3],h[5],h[6],h[7],h[8],h[10],h[11],h[12],h[13],h[15],h[16],h[17],h[18]],g=[h[4],h[9],h[14],h[19]];l.uniformMatrix4fv(c.uColorMatrix,!1,m),l.uniform4fv(c.uConstants,g)}}),p.Image.filters.ColorMatrix.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Brightness=b(C.BaseFilter,{type:"Brightness",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBrightness;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += uBrightness;
gl_FragColor = color;
}`,brightness:0,mainParameter:"brightness",applyTo2d:function(l){if(this.brightness!==0){var c=l.imageData,h=c.data,m,g=h.length,d=Math.round(this.brightness*255);for(m=0;m<g;m+=4)h[m]=h[m]+d,h[m+1]=h[m+1]+d,h[m+2]=h[m+2]+d}},getUniformLocations:function(l,c){return{uBrightness:l.getUniformLocation(c,"uBrightness")}},sendUniformData:function(l,c){l.uniform1f(c.uBrightness,this.brightness)}}),p.Image.filters.Brightness.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.Image.filters,l=p.util.createClass;b.Convolute=l(b.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_3_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_5_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_5_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_7_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_7_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_9_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_9_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`},retrieveShader:function(c){var h=Math.sqrt(this.matrix.length),m=this.type+"_"+h+"_"+(this.opaque?1:0),g=this.fragmentSource[m];return c.programCache.hasOwnProperty(m)||(c.programCache[m]=this.createProgram(c.context,g)),c.programCache[m]},applyTo2d:function(c){var h=c.imageData,m=h.data,g=this.matrix,d=Math.round(Math.sqrt(g.length)),w=Math.floor(d/2),E=h.width,O=h.height,L=c.ctx.createImageData(E,O),V=L.data,$=this.opaque?1:0,ne,xe,ze,Ke,Je,tt,ht,nt,_t,Ot,ot,wt,ee;for(ot=0;ot<O;ot++)for(Ot=0;Ot<E;Ot++){for(Je=(ot*E+Ot)*4,ne=0,xe=0,ze=0,Ke=0,ee=0;ee<d;ee++)for(wt=0;wt<d;wt++)ht=ot+ee-w,tt=Ot+wt-w,!(ht<0||ht>=O||tt<0||tt>=E)&&(nt=(ht*E+tt)*4,_t=g[ee*d+wt],ne+=m[nt]*_t,xe+=m[nt+1]*_t,ze+=m[nt+2]*_t,$||(Ke+=m[nt+3]*_t));V[Je]=ne,V[Je+1]=xe,V[Je+2]=ze,$?V[Je+3]=m[Je+3]:V[Je+3]=Ke}c.imageData=L},getUniformLocations:function(c,h){return{uMatrix:c.getUniformLocation(h,"uMatrix"),uOpaque:c.getUniformLocation(h,"uOpaque"),uHalfSize:c.getUniformLocation(h,"uHalfSize"),uSize:c.getUniformLocation(h,"uSize")}},sendUniformData:function(c,h){c.uniform1fv(h.uMatrix,this.matrix)},toObject:function(){return C(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),p.Image.filters.Convolute.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Grayscale=b(C.BaseFilter,{type:"Grayscale",fragmentSource:{average:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float average = (color.r + color.b + color.g) / 3.0;
gl_FragColor = vec4(average, average, average, color.a);
}`,lightness:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
gl_FragColor = vec4(average, average, average, col.a);
}`,luminosity:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
gl_FragColor = vec4(average, average, average, col.a);
}`},mode:"average",mainParameter:"mode",applyTo2d:function(l){var c=l.imageData,h=c.data,m,g=h.length,d,w=this.mode;for(m=0;m<g;m+=4)w==="average"?d=(h[m]+h[m+1]+h[m+2])/3:w==="lightness"?d=(Math.min(h[m],h[m+1],h[m+2])+Math.max(h[m],h[m+1],h[m+2]))/2:w==="luminosity"&&(d=.21*h[m]+.72*h[m+1]+.07*h[m+2]),h[m]=d,h[m+1]=d,h[m+2]=d},retrieveShader:function(l){var c=this.type+"_"+this.mode;if(!l.programCache.hasOwnProperty(c)){var h=this.fragmentSource[this.mode];l.programCache[c]=this.createProgram(l.context,h)}return l.programCache[c]},getUniformLocations:function(l,c){return{uMode:l.getUniformLocation(c,"uMode")}},sendUniformData:function(l,c){var h=1;l.uniform1i(c.uMode,h)},isNeutralState:function(){return!1}}),p.Image.filters.Grayscale.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Invert=b(C.BaseFilter,{type:"Invert",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform int uInvert;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
if (uInvert == 1) {
gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
} else {
gl_FragColor = color;
}
}`,invert:!0,mainParameter:"invert",applyTo2d:function(l){var c=l.imageData,h=c.data,m,g=h.length;for(m=0;m<g;m+=4)h[m]=255-h[m],h[m+1]=255-h[m+1],h[m+2]=255-h[m+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(l,c){return{uInvert:l.getUniformLocation(c,"uInvert")}},sendUniformData:function(l,c){l.uniform1i(c.uInvert,this.invert)}}),p.Image.filters.Invert.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.Image.filters,l=p.util.createClass;b.Noise=l(b.BaseFilter,{type:"Noise",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uStepH;
uniform float uNoise;
uniform float uSeed;
varying vec2 vTexCoord;
float rand(vec2 co, float seed, float vScale) {
return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
}
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
gl_FragColor = color;
}`,mainParameter:"noise",noise:0,applyTo2d:function(c){if(this.noise!==0){var h=c.imageData,m=h.data,g,d=m.length,w=this.noise,E;for(g=0,d=m.length;g<d;g+=4)E=(.5-Math.random())*w,m[g]+=E,m[g+1]+=E,m[g+2]+=E}},getUniformLocations:function(c,h){return{uNoise:c.getUniformLocation(h,"uNoise"),uSeed:c.getUniformLocation(h,"uSeed")}},sendUniformData:function(c,h){c.uniform1f(h.uNoise,this.noise/255),c.uniform1f(h.uSeed,Math.random())},toObject:function(){return C(this.callSuper("toObject"),{noise:this.noise})}}),p.Image.filters.Noise.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Pixelate=b(C.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBlocksize;
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
float blockW = uBlocksize * uStepW;
float blockH = uBlocksize * uStepW;
int posX = int(vTexCoord.x / blockW);
int posY = int(vTexCoord.y / blockH);
float fposX = float(posX);
float fposY = float(posY);
vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
vec4 color = texture2D(uTexture, squareCoords);
gl_FragColor = color;
}`,applyTo2d:function(l){var c=l.imageData,h=c.data,m=c.height,g=c.width,d,w,E,O,L,V,$,ne,xe,ze,Ke;for(w=0;w<m;w+=this.blocksize)for(E=0;E<g;E+=this.blocksize)for(d=w*4*g+E*4,O=h[d],L=h[d+1],V=h[d+2],$=h[d+3],ze=Math.min(w+this.blocksize,m),Ke=Math.min(E+this.blocksize,g),ne=w;ne<ze;ne++)for(xe=E;xe<Ke;xe++)d=ne*4*g+xe*4,h[d]=O,h[d+1]=L,h[d+2]=V,h[d+3]=$},isNeutralState:function(){return this.blocksize===1},getUniformLocations:function(l,c){return{uBlocksize:l.getUniformLocation(c,"uBlocksize"),uStepW:l.getUniformLocation(c,"uStepW"),uStepH:l.getUniformLocation(c,"uStepH")}},sendUniformData:function(l,c){l.uniform1f(c.uBlocksize,this.blocksize)}}),p.Image.filters.Pixelate.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.Image.filters,l=p.util.createClass;b.RemoveColor=l(b.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
gl_FragColor.a = 0.0;
}
}`,distance:.02,useAlpha:!1,applyTo2d:function(c){var h=c.imageData,m=h.data,g,d=this.distance*255,w,E,O,L=new p.Color(this.color).getSource(),V=[L[0]-d,L[1]-d,L[2]-d],$=[L[0]+d,L[1]+d,L[2]+d];for(g=0;g<m.length;g+=4)w=m[g],E=m[g+1],O=m[g+2],w>V[0]&&E>V[1]&&O>V[2]&&w<$[0]&&E<$[1]&&O<$[2]&&(m[g+3]=0)},getUniformLocations:function(c,h){return{uLow:c.getUniformLocation(h,"uLow"),uHigh:c.getUniformLocation(h,"uHigh")}},sendUniformData:function(c,h){var m=new p.Color(this.color).getSource(),g=parseFloat(this.distance),d=[0+m[0]/255-g,0+m[1]/255-g,0+m[2]/255-g,1],w=[m[0]/255+g,m[1]/255+g,m[2]/255+g,1];c.uniform4fv(h.uLow,d),c.uniform4fv(h.uHigh,w)},toObject:function(){return C(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),p.Image.filters.RemoveColor.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass,l={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var c in l)C[c]=b(C.ColorMatrix,{type:c,matrix:l[c],mainParameter:!1,colorsOnly:!0}),p.Image.filters[c].fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric,C=p.Image.filters,b=p.util.createClass;C.BlendColor=b(C.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,diff:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`if (uColor.r < 0.5) {
gl_FragColor.r *= 2.0 * uColor.r;
} else {
gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
}
if (uColor.g < 0.5) {
gl_FragColor.g *= 2.0 * uColor.g;
} else {
gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
}
if (uColor.b < 0.5) {
gl_FragColor.b *= 2.0 * uColor.b;
} else {
gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
}
`,tint:`gl_FragColor.rgb *= (1.0 - uColor.a);
gl_FragColor.rgb += uColor.rgb;
`},buildSource:function(l){return`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uColor;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
gl_FragColor = color;
if (color.a > 0.0) {
`+this.fragmentSource[l]+`}
}`},retrieveShader:function(l){var c=this.type+"_"+this.mode,h;return l.programCache.hasOwnProperty(c)||(h=this.buildSource(this.mode),l.programCache[c]=this.createProgram(l.context,h)),l.programCache[c]},applyTo2d:function(l){var c=l.imageData,h=c.data,m=h.length,g,d,w,E,O,L,V,$=1-this.alpha;V=new p.Color(this.color).getSource(),g=V[0]*this.alpha,d=V[1]*this.alpha,w=V[2]*this.alpha;for(var ne=0;ne<m;ne+=4)switch(E=h[ne],O=h[ne+1],L=h[ne+2],this.mode){case"multiply":h[ne]=E*g/255,h[ne+1]=O*d/255,h[ne+2]=L*w/255;break;case"screen":h[ne]=255-(255-E)*(255-g)/255,h[ne+1]=255-(255-O)*(255-d)/255,h[ne+2]=255-(255-L)*(255-w)/255;break;case"add":h[ne]=E+g,h[ne+1]=O+d,h[ne+2]=L+w;break;case"diff":case"difference":h[ne]=Math.abs(E-g),h[ne+1]=Math.abs(O-d),h[ne+2]=Math.abs(L-w);break;case"subtract":h[ne]=E-g,h[ne+1]=O-d,h[ne+2]=L-w;break;case"darken":h[ne]=Math.min(E,g),h[ne+1]=Math.min(O,d),h[ne+2]=Math.min(L,w);break;case"lighten":h[ne]=Math.max(E,g),h[ne+1]=Math.max(O,d),h[ne+2]=Math.max(L,w);break;case"overlay":h[ne]=g<128?2*E*g/255:255-2*(255-E)*(255-g)/255,h[ne+1]=d<128?2*O*d/255:255-2*(255-O)*(255-d)/255,h[ne+2]=w<128?2*L*w/255:255-2*(255-L)*(255-w)/255;break;case"exclusion":h[ne]=g+E-2*g*E/255,h[ne+1]=d+O-2*d*O/255,h[ne+2]=w+L-2*w*L/255;break;case"tint":h[ne]=g+E*$,h[ne+1]=d+O*$,h[ne+2]=w+L*$}},getUniformLocations:function(l,c){return{uColor:l.getUniformLocation(c,"uColor")}},sendUniformData:function(l,c){var h=new p.Color(this.color).getSource();h[0]=this.alpha*h[0]/255,h[1]=this.alpha*h[1]/255,h[2]=this.alpha*h[2]/255,h[3]=this.alpha,l.uniform4fv(c.uColor,h)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),p.Image.filters.BlendColor.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric,C=p.Image.filters,b=p.util.createClass;C.BlendImage=b(C.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
uniform mat3 uTransformMatrix;
void main() {
vTexCoord = aPosition;
vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:{multiply:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.rgba *= color2.rgba;
gl_FragColor = color;
}`,mask:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.a = color2.a;
gl_FragColor = color;
}`},retrieveShader:function(l){var c=this.type+"_"+this.mode,h=this.fragmentSource[this.mode];return l.programCache.hasOwnProperty(c)||(l.programCache[c]=this.createProgram(l.context,h)),l.programCache[c]},applyToWebGL:function(l){var c=l.context,h=this.createTexture(l.filterBackend,this.image);this.bindAdditionalTexture(c,h,c.TEXTURE1),this.callSuper("applyToWebGL",l),this.unbindAdditionalTexture(c,c.TEXTURE1)},createTexture:function(l,c){return l.getCachedTexture(c.cacheKey,c._element)},calculateMatrix:function(){var l=this.image,c=l._element.width,h=l._element.height;return[1/l.scaleX,0,0,0,1/l.scaleY,0,-l.left/c,-l.top/h,1]},applyTo2d:function(l){var c=l.imageData,h=l.filterBackend.resources,m=c.data,g=m.length,d=c.width,w=c.height,E,O,L,V,$,ne,xe,ze,Ke,Je,tt=this.image,ht;h.blendImage||(h.blendImage=p.util.createCanvasElement()),Ke=h.blendImage,Je=Ke.getContext("2d"),Ke.width!==d||Ke.height!==w?(Ke.width=d,Ke.height=w):Je.clearRect(0,0,d,w),Je.setTransform(tt.scaleX,0,0,tt.scaleY,tt.left,tt.top),Je.drawImage(tt._element,0,0,d,w),ht=Je.getImageData(0,0,d,w).data;for(var nt=0;nt<g;nt+=4)switch($=m[nt],ne=m[nt+1],xe=m[nt+2],ze=m[nt+3],E=ht[nt],O=ht[nt+1],L=ht[nt+2],V=ht[nt+3],this.mode){case"multiply":m[nt]=$*E/255,m[nt+1]=ne*O/255,m[nt+2]=xe*L/255,m[nt+3]=ze*V/255;break;case"mask":m[nt+3]=V;break}},getUniformLocations:function(l,c){return{uTransformMatrix:l.getUniformLocation(c,"uTransformMatrix"),uImage:l.getUniformLocation(c,"uImage")}},sendUniformData:function(l,c){var h=this.calculateMatrix();l.uniform1i(c.uImage,1),l.uniformMatrix3fv(c.uTransformMatrix,!1,h)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),p.Image.filters.BlendImage.fromObject=function(l,c){p.Image.fromObject(l.image,function(h){var m=p.util.object.clone(l);m.image=h,c(new p.Image.filters.BlendImage(m))})}}(Y),function(s){var p=s.fabric||(s.fabric={}),C=Math.pow,b=Math.floor,l=Math.sqrt,c=Math.abs,h=Math.round,m=Math.sin,g=Math.ceil,d=p.Image.filters,w=p.util.createClass;d.Resize=w(d.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(E,O){return{uDelta:E.getUniformLocation(O,"uDelta"),uTaps:E.getUniformLocation(O,"uTaps")}},sendUniformData:function(E,O){E.uniform2fv(O.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),E.uniform1fv(O.uTaps,this.taps)},retrieveShader:function(E){var O=this.getFilterWindow(),L=this.type+"_"+O;if(!E.programCache.hasOwnProperty(L)){var V=this.generateShader(O);E.programCache[L]=this.createProgram(E.context,V)}return E.programCache[L]},getFilterWindow:function(){var E=this.tempScale;return Math.ceil(this.lanczosLobes/E)},getTaps:function(){for(var E=this.lanczosCreate(this.lanczosLobes),O=this.tempScale,L=this.getFilterWindow(),V=new Array(L),$=1;$<=L;$++)V[$-1]=E($*O);return V},generateShader:function(V){for(var O=new Array(V),L=this.fragmentSourceTOP,V,$=1;$<=V;$++)O[$-1]=$+".0 * uDelta";return L+="uniform float uTaps["+V+`];
`,L+=`void main() {
`,L+=`  vec4 color = texture2D(uTexture, vTexCoord);
`,L+=`  float sum = 1.0;
`,O.forEach(function(ne,xe){L+="  color += texture2D(uTexture, vTexCoord + "+ne+") * uTaps["+xe+`];
`,L+="  color += texture2D(uTexture, vTexCoord - "+ne+") * uTaps["+xe+`];
`,L+="  sum += 2.0 * uTaps["+xe+`];
`}),L+=`  gl_FragColor = color / sum;
`,L+="}",L},fragmentSourceTOP:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
`,applyTo:function(E){E.webgl?(E.passes++,this.width=E.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=E.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),E.destinationWidth=this.dW,this._setupFrameBuffer(E),this.applyToWebGL(E),this._swapTextures(E),E.sourceWidth=E.destinationWidth,this.height=E.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),E.destinationHeight=this.dH,this._setupFrameBuffer(E),this.applyToWebGL(E),this._swapTextures(E),E.sourceHeight=E.destinationHeight):this.applyTo2d(E)},isNeutralState:function(){return this.scaleX===1&&this.scaleY===1},lanczosCreate:function(E){return function(O){if(O>=E||O<=-E)return 0;if(O<11920929e-14&&O>-11920929e-14)return 1;O*=Math.PI;var L=O/E;return m(O)/O*m(L)/L}},applyTo2d:function(E){var O=E.imageData,L=this.scaleX,V=this.scaleY;this.rcpScaleX=1/L,this.rcpScaleY=1/V;var $=O.width,ne=O.height,xe=h($*L),ze=h(ne*V),Ke;this.resizeType==="sliceHack"?Ke=this.sliceByTwo(E,$,ne,xe,ze):this.resizeType==="hermite"?Ke=this.hermiteFastResize(E,$,ne,xe,ze):this.resizeType==="bilinear"?Ke=this.bilinearFiltering(E,$,ne,xe,ze):this.resizeType==="lanczos"&&(Ke=this.lanczosResize(E,$,ne,xe,ze)),E.imageData=Ke},sliceByTwo:function(E,O,L,V,$){var ne=E.imageData,xe=.5,ze=!1,Ke=!1,Je=O*xe,tt=L*xe,ht=p.filterBackend.resources,nt,_t,Ot=0,ot=0,wt=O,ee=0;for(ht.sliceByTwo||(ht.sliceByTwo=document.createElement("canvas")),nt=ht.sliceByTwo,(nt.width<O*1.5||nt.height<L)&&(nt.width=O*1.5,nt.height=L),_t=nt.getContext("2d"),_t.clearRect(0,0,O*1.5,L),_t.putImageData(ne,0,0),V=b(V),$=b($);!ze||!Ke;)O=Je,L=tt,V<b(Je*xe)?Je=b(Je*xe):(Je=V,ze=!0),$<b(tt*xe)?tt=b(tt*xe):(tt=$,Ke=!0),_t.drawImage(nt,Ot,ot,O,L,wt,ee,Je,tt),Ot=wt,ot=ee,ee+=tt;return _t.getImageData(Ot,ot,V,$)},lanczosResize:function(E,O,L,V,$){function ne(me){var ye,Ve,ge,te,Ae,Ue,it,Xe,He,vt,Et;for(ee.x=(me+.5)*tt,be.x=b(ee.x),ye=0;ye<$;ye++){for(ee.y=(ye+.5)*ht,be.y=b(ee.y),Ae=0,Ue=0,it=0,Xe=0,He=0,Ve=be.x-Ot;Ve<=be.x+Ot;Ve++)if(!(Ve<0||Ve>=O)){vt=b(1e3*c(Ve-ee.x)),wt[vt]||(wt[vt]={});for(var $e=be.y-ot;$e<=be.y+ot;$e++)$e<0||$e>=L||(Et=b(1e3*c($e-ee.y)),wt[vt][Et]||(wt[vt][Et]=Je(l(C(vt*nt,2)+C(Et*_t,2))/1e3)),ge=wt[vt][Et],ge>0&&(te=($e*O+Ve)*4,Ae+=ge,Ue+=ge*xe[te],it+=ge*xe[te+1],Xe+=ge*xe[te+2],He+=ge*xe[te+3]))}te=(ye*V+me)*4,Ke[te]=Ue/Ae,Ke[te+1]=it/Ae,Ke[te+2]=Xe/Ae,Ke[te+3]=He/Ae}return++me<V?ne(me):ze}var xe=E.imageData.data,ze=E.ctx.createImageData(V,$),Ke=ze.data,Je=this.lanczosCreate(this.lanczosLobes),tt=this.rcpScaleX,ht=this.rcpScaleY,nt=2/this.rcpScaleX,_t=2/this.rcpScaleY,Ot=g(tt*this.lanczosLobes/2),ot=g(ht*this.lanczosLobes/2),wt={},ee={},be={};return ne(0)},bilinearFiltering:function(E,O,L,V,$){var ne,xe,ze,Ke,Je,tt,ht,nt,_t,Ot,ot,wt,ee=0,be,me=this.rcpScaleX,ye=this.rcpScaleY,Ve=4*(O-1),ge=E.imageData,te=ge.data,Ae=E.ctx.createImageData(V,$),Ue=Ae.data;for(ht=0;ht<$;ht++)for(nt=0;nt<V;nt++)for(Je=b(me*nt),tt=b(ye*ht),_t=me*nt-Je,Ot=ye*ht-tt,be=4*(tt*O+Je),ot=0;ot<4;ot++)ne=te[be+ot],xe=te[be+4+ot],ze=te[be+Ve+ot],Ke=te[be+Ve+4+ot],wt=ne*(1-_t)*(1-Ot)+xe*_t*(1-Ot)+ze*Ot*(1-_t)+Ke*_t*Ot,Ue[ee++]=wt;return Ae},hermiteFastResize:function(E,O,L,V,$){for(var ne=this.rcpScaleX,xe=this.rcpScaleY,ze=g(ne/2),Ke=g(xe/2),Je=E.imageData,tt=Je.data,ht=E.ctx.createImageData(V,$),nt=ht.data,_t=0;_t<$;_t++)for(var Ot=0;Ot<V;Ot++){for(var ot=(Ot+_t*V)*4,wt=0,ee=0,be=0,me=0,ye=0,Ve=0,ge=0,te=(_t+.5)*xe,Ae=b(_t*xe);Ae<(_t+1)*xe;Ae++)for(var Ue=c(te-(Ae+.5))/Ke,it=(Ot+.5)*ne,Xe=Ue*Ue,He=b(Ot*ne);He<(Ot+1)*ne;He++){var vt=c(it-(He+.5))/ze,Et=l(Xe+vt*vt);Et>1&&Et<-1||(wt=2*Et*Et*Et-3*Et*Et+1,wt>0&&(vt=4*(He+Ae*O),ge+=wt*tt[vt+3],be+=wt,tt[vt+3]<255&&(wt=wt*tt[vt+3]/250),me+=wt*tt[vt],ye+=wt*tt[vt+1],Ve+=wt*tt[vt+2],ee+=wt))}nt[ot]=me/ee,nt[ot+1]=ye/ee,nt[ot+2]=Ve/ee,nt[ot+3]=ge/be}return ht},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),p.Image.filters.Resize.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Contrast=b(C.BaseFilter,{type:"Contrast",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uContrast;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
gl_FragColor = color;
}`,contrast:0,mainParameter:"contrast",applyTo2d:function(l){if(this.contrast!==0){var c=l.imageData,h,g,m=c.data,g=m.length,d=Math.floor(this.contrast*255),w=259*(d+255)/(255*(259-d));for(h=0;h<g;h+=4)m[h]=w*(m[h]-128)+128,m[h+1]=w*(m[h+1]-128)+128,m[h+2]=w*(m[h+2]-128)+128}},getUniformLocations:function(l,c){return{uContrast:l.getUniformLocation(c,"uContrast")}},sendUniformData:function(l,c){l.uniform1f(c.uContrast,this.contrast)}}),p.Image.filters.Contrast.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Saturation=b(C.BaseFilter,{type:"Saturation",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uSaturation;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float rgMax = max(color.r, color.g);
float rgbMax = max(rgMax, color.b);
color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
gl_FragColor = color;
}`,saturation:0,mainParameter:"saturation",applyTo2d:function(l){if(this.saturation!==0){var c=l.imageData,h=c.data,m=h.length,g=-this.saturation,d,w;for(d=0;d<m;d+=4)w=Math.max(h[d],h[d+1],h[d+2]),h[d]+=w!==h[d]?(w-h[d])*g:0,h[d+1]+=w!==h[d+1]?(w-h[d+1])*g:0,h[d+2]+=w!==h[d+2]?(w-h[d+2])*g:0}},getUniformLocations:function(l,c){return{uSaturation:l.getUniformLocation(c,"uSaturation")}},sendUniformData:function(l,c){l.uniform1f(c.uSaturation,-this.saturation)}}),p.Image.filters.Saturation.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Vibrance=b(C.BaseFilter,{type:"Vibrance",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uVibrance;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float max = max(color.r, max(color.g, color.b));
float avg = (color.r + color.g + color.b) / 3.0;
float amt = (abs(max - avg) * 2.0) * uVibrance;
color.r += max != color.r ? (max - color.r) * amt : 0.00;
color.g += max != color.g ? (max - color.g) * amt : 0.00;
color.b += max != color.b ? (max - color.b) * amt : 0.00;
gl_FragColor = color;
}`,vibrance:0,mainParameter:"vibrance",applyTo2d:function(l){if(this.vibrance!==0){var c=l.imageData,h=c.data,m=h.length,g=-this.vibrance,d,w,E,O;for(d=0;d<m;d+=4)w=Math.max(h[d],h[d+1],h[d+2]),E=(h[d]+h[d+1]+h[d+2])/3,O=Math.abs(w-E)*2/255*g,h[d]+=w!==h[d]?(w-h[d])*O:0,h[d+1]+=w!==h[d+1]?(w-h[d+1])*O:0,h[d+2]+=w!==h[d+2]?(w-h[d+2])*O:0}},getUniformLocations:function(l,c){return{uVibrance:l.getUniformLocation(c,"uVibrance")}},sendUniformData:function(l,c){l.uniform1f(c.uVibrance,-this.vibrance)}}),p.Image.filters.Vibrance.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Blur=b(C.BaseFilter,{type:"Blur",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
const float nSamples = 15.0;
vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
float random(vec3 scale) {
return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
}
void main() {
vec4 color = vec4(0.0);
float total = 0.0;
float offset = random(v3offset);
for (float t = -nSamples; t <= nSamples; t++) {
float percent = (t + offset - 0.5) / nSamples;
float weight = 1.0 - abs(percent);
color += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;
total += weight;
}
gl_FragColor = color / total;
}`,blur:0,mainParameter:"blur",applyTo:function(l){l.webgl?(this.aspectRatio=l.sourceWidth/l.sourceHeight,l.passes++,this._setupFrameBuffer(l),this.horizontal=!0,this.applyToWebGL(l),this._swapTextures(l),this._setupFrameBuffer(l),this.horizontal=!1,this.applyToWebGL(l),this._swapTextures(l)):this.applyTo2d(l)},applyTo2d:function(l){l.imageData=this.simpleBlur(l)},simpleBlur:function(l){var c=l.filterBackend.resources,h,m,g=l.imageData.width,d=l.imageData.height;c.blurLayer1||(c.blurLayer1=p.util.createCanvasElement(),c.blurLayer2=p.util.createCanvasElement()),h=c.blurLayer1,m=c.blurLayer2,(h.width!==g||h.height!==d)&&(m.width=h.width=g,m.height=h.height=d);var w=h.getContext("2d"),E=m.getContext("2d"),O=15,L,V,$,ne,xe=this.blur*.06*.5;for(w.putImageData(l.imageData,0,0),E.clearRect(0,0,g,d),ne=-O;ne<=O;ne++)L=(Math.random()-.5)/4,V=ne/O,$=xe*V*g+L,E.globalAlpha=1-Math.abs(V),E.drawImage(h,$,L),w.drawImage(m,0,0),E.globalAlpha=1,E.clearRect(0,0,m.width,m.height);for(ne=-O;ne<=O;ne++)L=(Math.random()-.5)/4,V=ne/O,$=xe*V*d+L,E.globalAlpha=1-Math.abs(V),E.drawImage(h,L,$),w.drawImage(m,0,0),E.globalAlpha=1,E.clearRect(0,0,m.width,m.height);l.ctx.drawImage(h,0,0);var ze=l.ctx.getImageData(0,0,h.width,h.height);return w.globalAlpha=1,w.clearRect(0,0,h.width,h.height),ze},getUniformLocations:function(l,c){return{delta:l.getUniformLocation(c,"uDelta")}},sendUniformData:function(l,c){var h=this.chooseRightDelta();l.uniform2fv(c.delta,h)},chooseRightDelta:function(){var l=1,c=[0,0],h;return this.horizontal?this.aspectRatio>1&&(l=1/this.aspectRatio):this.aspectRatio<1&&(l=this.aspectRatio),h=l*this.blur*.12,this.horizontal?c[0]=h:c[1]=h,c}}),C.Blur.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Gamma=b(C.BaseFilter,{type:"Gamma",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec3 uGamma;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec3 correction = (1.0 / uGamma);
color.r = pow(color.r, correction.r);
color.g = pow(color.g, correction.g);
color.b = pow(color.b, correction.b);
gl_FragColor = color;
gl_FragColor.rgb *= color.a;
}`,gamma:[1,1,1],mainParameter:"gamma",initialize:function(l){this.gamma=[1,1,1],C.BaseFilter.prototype.initialize.call(this,l)},applyTo2d:function(l){var c=l.imageData,h=c.data,m=this.gamma,g=h.length,d=1/m[0],w=1/m[1],E=1/m[2],O;for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),O=0,g=256;O<g;O++)this.rVals[O]=Math.pow(O/255,d)*255,this.gVals[O]=Math.pow(O/255,w)*255,this.bVals[O]=Math.pow(O/255,E)*255;for(O=0,g=h.length;O<g;O+=4)h[O]=this.rVals[h[O]],h[O+1]=this.gVals[h[O+1]],h[O+2]=this.bVals[h[O+2]]},getUniformLocations:function(l,c){return{uGamma:l.getUniformLocation(c,"uGamma")}},sendUniformData:function(l,c){l.uniform3fv(c.uGamma,this.gamma)}}),p.Image.filters.Gamma.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Composed=b(C.BaseFilter,{type:"Composed",subFilters:[],initialize:function(l){this.callSuper("initialize",l),this.subFilters=this.subFilters.slice(0)},applyTo:function(l){l.passes+=this.subFilters.length-1,this.subFilters.forEach(function(c){c.applyTo(l)})},toObject:function(){return p.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(l){return l.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(l){return!l.isNeutralState()})}}),p.Image.filters.Composed.fromObject=function(l,c){var h=l.subFilters||[],m=h.map(function(d){return new p.Image.filters[d.type](d)}),g=new p.Image.filters.Composed({subFilters:m});return c&&c(g),g}}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.HueRotation=b(C.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var l=this.rotation*Math.PI,c=p.util.cos(l),h=p.util.sin(l),m=1/3,g=Math.sqrt(m)*h,d=1-c;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=c+d/3,this.matrix[1]=m*d-g,this.matrix[2]=m*d+g,this.matrix[5]=m*d+g,this.matrix[6]=c+m*d,this.matrix[7]=m*d-g,this.matrix[10]=m*d-g,this.matrix[11]=m*d+g,this.matrix[12]=c+m*d},isNeutralState:function(l){return this.calculateMatrix(),C.BaseFilter.prototype.isNeutralState.call(this,l)},applyTo:function(l){this.calculateMatrix(),C.BaseFilter.prototype.applyTo.call(this,l)}}),p.Image.filters.HueRotation.fromObject=p.Image.filters.BaseFilter.fromObject}(Y),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.clone;if(p.Text){p.warn("fabric.Text is already defined");return}var b="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");p.Text=p.util.createClass(p.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:p.Object.prototype.stateProperties.concat(b),cacheProperties:p.Object.prototype.cacheProperties.concat(b),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(l,c){this.styles=c?c.styles||{}:{},this.text=l,this.__skipDimension=!0,this.callSuper("initialize",c),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var l=this.path;l&&(l.segmentsInfo=p.util.getPathSegmentsInfo(l.path))},getMeasuringContext:function(){return p._measuringContext||(p._measuringContext=this.canvas&&this.canvas.contextCache||p.util.createCanvasElement().getContext("2d")),p._measuringContext},_splitText:function(){var l=this._splitTextIntoLines(this.text);return this.textLines=l.lines,this._textLines=l.graphemeLines,this._unwrappedTextLines=l._unwrappedLines,this._text=l.graphemeText,l},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var l,c,h,m,g,d,w,E=0,O=this._textLines.length;E<O;E++)if(!(this.textAlign!=="justify"&&(E===O-1||this.isEndOfWrapping(E)))&&(m=0,g=this._textLines[E],c=this.getLineWidth(E),c<this.width&&(w=this.textLines[E].match(this._reSpacesAndTabs)))){h=w.length,l=(this.width-c)/h;for(var L=0,V=g.length;L<=V;L++)d=this.__charBounds[E][L],this._reSpaceAndTab.test(g[L])?(d.width+=l,d.kernedWidth+=l,d.left+=m,m+=l):d.left+=m}},isEndOfWrapping:function(l){return l===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var l=this.callSuper("_getCacheCanvasDimensions"),c=this.fontSize;return l.width+=c*l.zoomX,l.height+=c*l.zoomY,l},_render:function(l){var c=this.path;c&&!c.isNotVisible()&&c._render(l),this._setTextStyles(l),this._renderTextLinesBackground(l),this._renderTextDecoration(l,"underline"),this._renderText(l),this._renderTextDecoration(l,"overline"),this._renderTextDecoration(l,"linethrough")},_renderText:function(l){this.paintFirst==="stroke"?(this._renderTextStroke(l),this._renderTextFill(l)):(this._renderTextFill(l),this._renderTextStroke(l))},_setTextStyles:function(l,c,h){if(l.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":l.textBaseline="middle";break;case"ascender":l.textBaseline="top";break;case"descender":l.textBaseline="bottom";break}l.font=this._getFontDeclaration(c,h)},calcTextWidth:function(){for(var l=this.getLineWidth(0),c=1,h=this._textLines.length;c<h;c++){var m=this.getLineWidth(c);m>l&&(l=m)}return l},_renderTextLine:function(l,c,h,m,g,d){this._renderChars(l,c,h,m,g,d)},_renderTextLinesBackground:function(l){if(!(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))){for(var c,h,m=l.fillStyle,g,d,w=this._getLeftOffset(),E=this._getTopOffset(),O=0,L=0,V,$,ne=this.path,xe,ze=0,Ke=this._textLines.length;ze<Ke;ze++){if(c=this.getHeightOfLine(ze),!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",ze)){E+=c;continue}g=this._textLines[ze],h=this._getLineLeftOffset(ze),L=0,O=0,d=this.getValueOfPropertyAt(ze,0,"textBackgroundColor");for(var Je=0,tt=g.length;Je<tt;Je++)V=this.__charBounds[ze][Je],$=this.getValueOfPropertyAt(ze,Je,"textBackgroundColor"),ne?(l.save(),l.translate(V.renderLeft,V.renderTop),l.rotate(V.angle),l.fillStyle=$,$&&l.fillRect(-V.width/2,-c/this.lineHeight*(1-this._fontSizeFraction),V.width,c/this.lineHeight),l.restore()):$!==d?(xe=w+h+O,this.direction==="rtl"&&(xe=this.width-xe-L),l.fillStyle=d,d&&l.fillRect(xe,E,L,c/this.lineHeight),O=V.left,L=V.width,d=$):L+=V.kernedWidth;$&&!ne&&(xe=w+h+O,this.direction==="rtl"&&(xe=this.width-xe-L),l.fillStyle=$,l.fillRect(xe,E,L,c/this.lineHeight)),E+=c}l.fillStyle=m,this._removeShadow(l)}},getFontCache:function(l){var c=l.fontFamily.toLowerCase();p.charWidthsCache[c]||(p.charWidthsCache[c]={});var h=p.charWidthsCache[c],m=l.fontStyle.toLowerCase()+"_"+(l.fontWeight+"").toLowerCase();return h[m]||(h[m]={}),h[m]},_measureChar:function(l,c,h,m){var g=this.getFontCache(c),d=this._getFontDeclaration(c),w=this._getFontDeclaration(m),E=h+l,O=d===w,L,V,$,ne=c.fontSize/this.CACHE_FONT_SIZE,xe;if(h&&g[h]!==void 0&&($=g[h]),g[l]!==void 0&&(xe=L=g[l]),O&&g[E]!==void 0&&(V=g[E],xe=V-$),L===void 0||$===void 0||V===void 0){var ze=this.getMeasuringContext();this._setTextStyles(ze,c,!0)}return L===void 0&&(xe=L=ze.measureText(l).width,g[l]=L),$===void 0&&O&&h&&($=ze.measureText(h).width,g[h]=$),O&&V===void 0&&(V=ze.measureText(E).width,g[E]=V,xe=V-$),{width:L*ne,kernedWidth:xe*ne}},getHeightOfChar:function(l,c){return this.getValueOfPropertyAt(l,c,"fontSize")},measureLine:function(l){var c=this._measureLine(l);return this.charSpacing!==0&&(c.width-=this._getWidthOfCharSpacing()),c.width<0&&(c.width=0),c},_measureLine:function(l){var c=0,h,m,g=this._textLines[l],d,w,E=0,O=new Array(g.length),L=0,V,$,ne=this.path,xe=this.pathSide==="right";for(this.__charBounds[l]=O,h=0;h<g.length;h++)m=g[h],w=this._getGraphemeBox(m,l,h,d),O[h]=w,c+=w.kernedWidth,d=m;if(O[h]={left:w?w.left+w.width:0,width:0,kernedWidth:0,height:this.fontSize},ne){switch($=ne.segmentsInfo[ne.segmentsInfo.length-1].length,V=p.util.getPointOnPath(ne.path,0,ne.segmentsInfo),V.x+=ne.pathOffset.x,V.y+=ne.pathOffset.y,this.textAlign){case"left":L=xe?$-c:0;break;case"center":L=($-c)/2;break;case"right":L=xe?0:$-c;break}for(L+=this.pathStartOffset*(xe?-1:1),h=xe?g.length-1:0;xe?h>=0:h<g.length;xe?h--:h++)w=O[h],L>$?L%=$:L<0&&(L+=$),this._setGraphemeOnPath(L,w,V),L+=w.kernedWidth}return{width:c,numOfSpaces:E}},_setGraphemeOnPath:function(l,c,h){var m=l+c.kernedWidth/2,g=this.path,d=p.util.getPointOnPath(g.path,m,g.segmentsInfo);c.renderLeft=d.x-h.x,c.renderTop=d.y-h.y,c.angle=d.angle+(this.pathSide==="right"?Math.PI:0)},_getGraphemeBox:function(l,c,h,m,g){var d=this.getCompleteStyleDeclaration(c,h),w=m?this.getCompleteStyleDeclaration(c,h-1):{},E=this._measureChar(l,d,m,w),O=E.kernedWidth,L=E.width,V;this.charSpacing!==0&&(V=this._getWidthOfCharSpacing(),L+=V,O+=V);var $={width:L,left:0,height:d.fontSize,kernedWidth:O,deltaY:d.deltaY};if(h>0&&!g){var ne=this.__charBounds[c][h-1];$.left=ne.left+ne.width+E.kernedWidth-E.width}return $},getHeightOfLine:function(l){if(this.__lineHeights[l])return this.__lineHeights[l];for(var c=this._textLines[l],h=this.getHeightOfChar(l,0),m=1,g=c.length;m<g;m++)h=Math.max(this.getHeightOfChar(l,m),h);return this.__lineHeights[l]=h*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var l,c=0,h=0,m=this._textLines.length;h<m;h++)l=this.getHeightOfLine(h),c+=h===m-1?l/this.lineHeight:l;return c},_getLeftOffset:function(){return this.direction==="ltr"?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(l,c){l.save();for(var h=0,m=this._getLeftOffset(),g=this._getTopOffset(),d=0,w=this._textLines.length;d<w;d++){var E=this.getHeightOfLine(d),O=E/this.lineHeight,L=this._getLineLeftOffset(d);this._renderTextLine(c,l,this._textLines[d],m+L,g+h+O,d),h+=E}l.restore()},_renderTextFill:function(l){!this.fill&&!this.styleHas("fill")||this._renderTextCommon(l,"fillText")},_renderTextStroke:function(l){(!this.stroke||this.strokeWidth===0)&&this.isEmptyStyles()||(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(l),l.save(),this._setLineDash(l,this.strokeDashArray),l.beginPath(),this._renderTextCommon(l,"strokeText"),l.closePath(),l.restore())},_renderChars:function(l,c,h,m,g,d){var w=this.getHeightOfLine(d),E=this.textAlign.indexOf("justify")!==-1,O,L,V="",$,ne=0,xe,ze=this.path,Ke=!E&&this.charSpacing===0&&this.isEmptyStyles(d)&&!ze,Je=this.direction==="ltr",tt=this.direction==="ltr"?1:-1,ht,nt=c.canvas.getAttribute("dir");if(c.save(),nt!==this.direction&&(c.canvas.setAttribute("dir",Je?"ltr":"rtl"),c.direction=Je?"ltr":"rtl",c.textAlign=Je?"left":"right"),g-=w*this._fontSizeFraction/this.lineHeight,Ke){this._renderChar(l,c,d,0,h.join(""),m,g,w),c.restore();return}for(var _t=0,Ot=h.length-1;_t<=Ot;_t++)xe=_t===Ot||this.charSpacing||ze,V+=h[_t],$=this.__charBounds[d][_t],ne===0?(m+=tt*($.kernedWidth-$.width),ne+=$.width):ne+=$.kernedWidth,E&&!xe&&this._reSpaceAndTab.test(h[_t])&&(xe=!0),xe||(O=O||this.getCompleteStyleDeclaration(d,_t),L=this.getCompleteStyleDeclaration(d,_t+1),xe=p.util.hasStyleChanged(O,L,!1)),xe&&(ze?(c.save(),c.translate($.renderLeft,$.renderTop),c.rotate($.angle),this._renderChar(l,c,d,_t,V,-ne/2,0,w),c.restore()):(ht=m,this._renderChar(l,c,d,_t,V,ht,g,w)),V="",O=L,m+=tt*ne,ne=0);c.restore()},_applyPatternGradientTransformText:function(l){var c=p.util.createCanvasElement(),h,m=this.width+this.strokeWidth,g=this.height+this.strokeWidth;return c.width=m,c.height=g,h=c.getContext("2d"),h.beginPath(),h.moveTo(0,0),h.lineTo(m,0),h.lineTo(m,g),h.lineTo(0,g),h.closePath(),h.translate(m/2,g/2),h.fillStyle=l.toLive(h),this._applyPatternGradientTransform(h,l),h.fill(),h.createPattern(c,"no-repeat")},handleFiller:function(l,c,h){var m,g;return h.toLive?h.gradientUnits==="percentage"||h.gradientTransform||h.patternTransform?(m=-this.width/2,g=-this.height/2,l.translate(m,g),l[c]=this._applyPatternGradientTransformText(h),{offsetX:m,offsetY:g}):(l[c]=h.toLive(l,this),this._applyPatternGradientTransform(l,h)):(l[c]=h,{offsetX:0,offsetY:0})},_setStrokeStyles:function(l,c){return l.lineWidth=c.strokeWidth,l.lineCap=this.strokeLineCap,l.lineDashOffset=this.strokeDashOffset,l.lineJoin=this.strokeLineJoin,l.miterLimit=this.strokeMiterLimit,this.handleFiller(l,"strokeStyle",c.stroke)},_setFillStyles:function(l,c){return this.handleFiller(l,"fillStyle",c.fill)},_renderChar:function(l,c,h,m,g,d,w){var E=this._getStyleDeclaration(h,m),O=this.getCompleteStyleDeclaration(h,m),L=l==="fillText"&&O.fill,V=l==="strokeText"&&O.stroke&&O.strokeWidth,$,ne;!V&&!L||(c.save(),L&&($=this._setFillStyles(c,O)),V&&(ne=this._setStrokeStyles(c,O)),c.font=this._getFontDeclaration(O),E&&E.textBackgroundColor&&this._removeShadow(c),E&&E.deltaY&&(w+=E.deltaY),L&&c.fillText(g,d-$.offsetX,w-$.offsetY),V&&c.strokeText(g,d-ne.offsetX,w-ne.offsetY),c.restore())},setSuperscript:function(l,c){return this._setScript(l,c,this.superscript)},setSubscript:function(l,c){return this._setScript(l,c,this.subscript)},_setScript:function(l,c,h){var m=this.get2DCursorLocation(l,!0),g=this.getValueOfPropertyAt(m.lineIndex,m.charIndex,"fontSize"),d=this.getValueOfPropertyAt(m.lineIndex,m.charIndex,"deltaY"),w={fontSize:g*h.size,deltaY:d+g*h.baseline};return this.setSelectionStyles(w,l,c),this},_getLineLeftOffset:function(l){var c=this.getLineWidth(l),h=this.width-c,m=this.textAlign,g=this.direction,w,d=0,w=this.isEndOfWrapping(l);return m==="justify"||m==="justify-center"&&!w||m==="justify-right"&&!w||m==="justify-left"&&!w?0:(m==="center"&&(d=h/2),m==="right"&&(d=h),m==="justify-center"&&(d=h/2),m==="justify-right"&&(d=h),g==="rtl"&&(d-=h),d)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var l=this._forceClearCache;return l||(l=this.hasStateChanged("_dimensionAffectingProps")),l&&(this.dirty=!0,this._forceClearCache=!1),l},getLineWidth:function(l){if(this.__lineWidths[l]!==void 0)return this.__lineWidths[l];var c=this.measureLine(l),h=c.width;return this.__lineWidths[l]=h,h},_getWidthOfCharSpacing:function(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(l,c,h){var m=this._getStyleDeclaration(l,c);return m&&typeof m[h]<"u"?m[h]:this[h]},_renderTextDecoration:function(l,c){if(!(!this[c]&&!this.styleHas(c))){for(var h,m,g,d,w,E,O,L,V=this._getLeftOffset(),$=this._getTopOffset(),ne,xe,ze,Ke,Je,tt,ht,nt,_t=this.path,Ot=this._getWidthOfCharSpacing(),ot=this.offsets[c],wt=0,ee=this._textLines.length;wt<ee;wt++){if(h=this.getHeightOfLine(wt),!this[c]&&!this.styleHas(c,wt)){$+=h;continue}O=this._textLines[wt],tt=h/this.lineHeight,d=this._getLineLeftOffset(wt),xe=0,ze=0,L=this.getValueOfPropertyAt(wt,0,c),nt=this.getValueOfPropertyAt(wt,0,"fill"),ne=$+tt*(1-this._fontSizeFraction),m=this.getHeightOfChar(wt,0),w=this.getValueOfPropertyAt(wt,0,"deltaY");for(var be=0,me=O.length;be<me;be++)if(Ke=this.__charBounds[wt][be],Je=this.getValueOfPropertyAt(wt,be,c),ht=this.getValueOfPropertyAt(wt,be,"fill"),g=this.getHeightOfChar(wt,be),E=this.getValueOfPropertyAt(wt,be,"deltaY"),_t&&Je&&ht)l.save(),l.fillStyle=nt,l.translate(Ke.renderLeft,Ke.renderTop),l.rotate(Ke.angle),l.fillRect(-Ke.kernedWidth/2,ot*g+E,Ke.kernedWidth,this.fontSize/15),l.restore();else if((Je!==L||ht!==nt||g!==m||E!==w)&&ze>0){var ye=V+d+xe;this.direction==="rtl"&&(ye=this.width-ye-ze),L&&nt&&(l.fillStyle=nt,l.fillRect(ye,ne+ot*m+w,ze,this.fontSize/15)),xe=Ke.left,ze=Ke.width,L=Je,nt=ht,m=g,w=E}else ze+=Ke.kernedWidth;var ye=V+d+xe;this.direction==="rtl"&&(ye=this.width-ye-ze),l.fillStyle=ht,Je&&ht&&l.fillRect(ye,ne+ot*m+w,ze-Ot,this.fontSize/15),$+=h}this._removeShadow(l)}},_getFontDeclaration:function(l,c){var h=l||this,m=this.fontFamily,g=p.Text.genericFonts.indexOf(m.toLowerCase())>-1,d=m===void 0||m.indexOf("'")>-1||m.indexOf(",")>-1||m.indexOf('"')>-1||g?h.fontFamily:'"'+h.fontFamily+'"';return[p.isLikelyNode?h.fontWeight:h.fontStyle,p.isLikelyNode?h.fontStyle:h.fontWeight,c?this.CACHE_FONT_SIZE+"px":h.fontSize+"px",d].join(" ")},render:function(l){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",l)))},_splitTextIntoLines:function(l){for(var c=l.split(this._reNewline),h=new Array(c.length),m=[`
`],g=[],d=0;d<c.length;d++)h[d]=p.util.string.graphemeSplit(c[d]),g=g.concat(h[d],m);return g.pop(),{_unwrappedLines:h,lines:c,graphemeText:g,graphemeLines:h}},toObject:function(l){var c=b.concat(l),h=this.callSuper("toObject",c);return h.styles=p.util.stylesToArray(this.styles,this.text),h.path&&(h.path=this.path.toObject()),h},set:function(l,c){this.callSuper("set",l,c);var h=!1,m=!1;if(typeof l=="object")for(var g in l)g==="path"&&this.setPathInfo(),h=h||this._dimensionAffectingProps.indexOf(g)!==-1,m=m||g==="path";else h=this._dimensionAffectingProps.indexOf(l)!==-1,m=l==="path";return m&&this.setPathInfo(),h&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),p.Text.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),p.Text.DEFAULT_SVG_FONT_SIZE=16,p.Text.fromElement=function(l,c,h){if(!l)return c(null);var m=p.parseAttributes(l,p.Text.ATTRIBUTE_NAMES),g=m.textAnchor||"left";if(h=p.util.object.extend(h?C(h):{},m),h.top=h.top||0,h.left=h.left||0,m.textDecoration){var d=m.textDecoration;d.indexOf("underline")!==-1&&(h.underline=!0),d.indexOf("overline")!==-1&&(h.overline=!0),d.indexOf("line-through")!==-1&&(h.linethrough=!0),delete h.textDecoration}"dx"in m&&(h.left+=m.dx),"dy"in m&&(h.top+=m.dy),"fontSize"in h||(h.fontSize=p.Text.DEFAULT_SVG_FONT_SIZE);var w="";"textContent"in l?w=l.textContent:"firstChild"in l&&l.firstChild!==null&&"data"in l.firstChild&&l.firstChild.data!==null&&(w=l.firstChild.data),w=w.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var E=h.strokeWidth;h.strokeWidth=0;var O=new p.Text(w,h),L=O.getScaledHeight()/O.height,V=(O.height+O.strokeWidth)*O.lineHeight-O.height,$=V*L,ne=O.getScaledHeight()+$,xe=0;g==="center"&&(xe=O.getScaledWidth()/2),g==="right"&&(xe=O.getScaledWidth()),O.set({left:O.left-xe,top:O.top-(ne-O.fontSize*(.07+O._fontSizeFraction))/O.lineHeight,strokeWidth:typeof E<"u"?E:1}),c(O)},p.Text.fromObject=function(l,c){var h=C(l),m=l.path;return delete h.path,p.Object._fromObject("Text",h,function(g){g.styles=p.util.stylesFromArray(l.styles,l.text),m?p.Object._fromObject("Path",m,function(d){g.set("path",d),c(g)},"path"):c(g)},"text")},p.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],p.util.createAccessors&&p.util.createAccessors(p.Text)}(Y),function(){T.util.object.extend(T.Text.prototype,{isEmptyStyles:function(s){if(!this.styles||typeof s<"u"&&!this.styles[s])return!0;var p=typeof s>"u"?this.styles:{line:this.styles[s]};for(var C in p)for(var b in p[C])for(var l in p[C][b])return!1;return!0},styleHas:function(s,p){if(!this.styles||!s||s===""||typeof p<"u"&&!this.styles[p])return!1;var C=typeof p>"u"?this.styles:{0:this.styles[p]};for(var b in C)for(var l in C[b])if(typeof C[b][l][s]<"u")return!0;return!1},cleanStyle:function(s){if(!this.styles||!s||s==="")return!1;var p=this.styles,C=0,b,l,c=!0,h=0,m;for(var g in p){b=0;for(var d in p[g]){var m=p[g][d],w=m.hasOwnProperty(s);C++,w?(l?m[s]!==l&&(c=!1):l=m[s],m[s]===this[s]&&delete m[s]):c=!1,Object.keys(m).length!==0?b++:delete p[g][d]}b===0&&delete p[g]}for(var E=0;E<this._textLines.length;E++)h+=this._textLines[E].length;c&&C===h&&(this[s]=l,this.removeStyle(s))},removeStyle:function(s){if(!(!this.styles||!s||s==="")){var p=this.styles,C,b,l;for(b in p){C=p[b];for(l in C)delete C[l][s],Object.keys(C[l]).length===0&&delete C[l];Object.keys(C).length===0&&delete p[b]}}},_extendStyles:function(s,p){var C=this.get2DCursorLocation(s);this._getLineStyle(C.lineIndex)||this._setLineStyle(C.lineIndex),this._getStyleDeclaration(C.lineIndex,C.charIndex)||this._setStyleDeclaration(C.lineIndex,C.charIndex,{}),T.util.object.extend(this._getStyleDeclaration(C.lineIndex,C.charIndex),p)},get2DCursorLocation:function(s,p){typeof s>"u"&&(s=this.selectionStart);for(var C=p?this._unwrappedTextLines:this._textLines,b=C.length,l=0;l<b;l++){if(s<=C[l].length)return{lineIndex:l,charIndex:s};s-=C[l].length+this.missingNewlineOffset(l)}return{lineIndex:l-1,charIndex:C[l-1].length<s?C[l-1].length:s}},getSelectionStyles:function(s,p,C){typeof s>"u"&&(s=this.selectionStart||0),typeof p>"u"&&(p=this.selectionEnd||s);for(var b=[],l=s;l<p;l++)b.push(this.getStyleAtPosition(l,C));return b},getStyleAtPosition:function(s,p){var C=this.get2DCursorLocation(s),b=p?this.getCompleteStyleDeclaration(C.lineIndex,C.charIndex):this._getStyleDeclaration(C.lineIndex,C.charIndex);return b||{}},setSelectionStyles:function(s,p,C){typeof p>"u"&&(p=this.selectionStart||0),typeof C>"u"&&(C=this.selectionEnd||p);for(var b=p;b<C;b++)this._extendStyles(b,s);return this._forceClearCache=!0,this},_getStyleDeclaration:function(s,p){var C=this.styles&&this.styles[s];return C?C[p]:null},getCompleteStyleDeclaration:function(s,p){for(var C=this._getStyleDeclaration(s,p)||{},b={},l,c=0;c<this._styleProperties.length;c++)l=this._styleProperties[c],b[l]=typeof C[l]>"u"?this[l]:C[l];return b},_setStyleDeclaration:function(s,p,C){this.styles[s][p]=C},_deleteStyleDeclaration:function(s,p){delete this.styles[s][p]},_getLineStyle:function(s){return!!this.styles[s]},_setLineStyle:function(s){this.styles[s]={}},_deleteLineStyle:function(s){delete this.styles[s]}})}(),function(){function s(p){p.textDecoration&&(p.textDecoration.indexOf("underline")>-1&&(p.underline=!0),p.textDecoration.indexOf("line-through")>-1&&(p.linethrough=!0),p.textDecoration.indexOf("overline")>-1&&(p.overline=!0),delete p.textDecoration)}T.IText=T.util.createClass(T.Text,T.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(p,C){this.callSuper("initialize",p,C),this.initBehavior()},setSelectionStart:function(p){p=Math.max(p,0),this._updateAndFire("selectionStart",p)},setSelectionEnd:function(p){p=Math.min(p,this.text.length),this._updateAndFire("selectionEnd",p)},_updateAndFire:function(p,C){this[p]!==C&&(this._fireSelectionChanged(),this[p]=C),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(p){this.clearContextTop(),this.callSuper("render",p),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(p){this.callSuper("_render",p)},clearContextTop:function(p){if(!(!this.isEditing||!this.canvas||!this.canvas.contextTop)){var C=this.canvas.contextTop,b=this.canvas.viewportTransform;C.save(),C.transform(b[0],b[1],b[2],b[3],b[4],b[5]),this.transform(C),this._clearTextArea(C),p||C.restore()}},renderCursorOrSelection:function(){if(!(!this.isEditing||!this.canvas||!this.canvas.contextTop)){var p=this._getCursorBoundaries(),C=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(p,C):this.renderSelection(p,C),C.restore()}},_clearTextArea:function(p){var C=this.width+4,b=this.height+4;p.clearRect(-C/2,-b/2,C,b)},_getCursorBoundaries:function(p){typeof p>"u"&&(p=this.selectionStart);var C=this._getLeftOffset(),b=this._getTopOffset(),l=this._getCursorBoundariesOffsets(p);return{left:C,top:b,leftOffset:l.left,topOffset:l.top}},_getCursorBoundariesOffsets:function(p){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var C,b,l,c=0,h=0,m,g=this.get2DCursorLocation(p);l=g.charIndex,b=g.lineIndex;for(var d=0;d<b;d++)c+=this.getHeightOfLine(d);C=this._getLineLeftOffset(b);var w=this.__charBounds[b][l];return w&&(h=w.left),this.charSpacing!==0&&l===this._textLines[b].length&&(h-=this._getWidthOfCharSpacing()),m={top:c,left:C+(h>0?h:0)},this.direction==="rtl"&&(m.left*=-1),this.cursorOffsetCache=m,this.cursorOffsetCache},renderCursor:function(p,C){var b=this.get2DCursorLocation(),l=b.lineIndex,c=b.charIndex>0?b.charIndex-1:0,h=this.getValueOfPropertyAt(l,c,"fontSize"),m=this.scaleX*this.canvas.getZoom(),g=this.cursorWidth/m,d=p.topOffset,w=this.getValueOfPropertyAt(l,c,"deltaY");d+=(1-this._fontSizeFraction)*this.getHeightOfLine(l)/this.lineHeight-h*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(p,C),C.fillStyle=this.cursorColor||this.getValueOfPropertyAt(l,c,"fill"),C.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,C.fillRect(p.left+p.leftOffset-g/2,d+p.top+w,g,h)},renderSelection:function(p,C){for(var b=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,l=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,c=this.textAlign.indexOf("justify")!==-1,h=this.get2DCursorLocation(b),m=this.get2DCursorLocation(l),g=h.lineIndex,d=m.lineIndex,w=h.charIndex<0?0:h.charIndex,E=m.charIndex<0?0:m.charIndex,O=g;O<=d;O++){var L=this._getLineLeftOffset(O)||0,V=this.getHeightOfLine(O),$=0,ne=0,xe=0;if(O===g&&(ne=this.__charBounds[g][w].left),O>=g&&O<d)xe=c&&!this.isEndOfWrapping(O)?this.width:this.getLineWidth(O)||5;else if(O===d)if(E===0)xe=this.__charBounds[d][E].left;else{var ze=this._getWidthOfCharSpacing();xe=this.__charBounds[d][E-1].left+this.__charBounds[d][E-1].width-ze}$=V,(this.lineHeight<1||O===d&&this.lineHeight>1)&&(V/=this.lineHeight);var Ke=p.left+L+ne,Je=xe-ne,tt=V,ht=0;this.inCompositionMode?(C.fillStyle=this.compositionColor||"black",tt=1,ht=V):C.fillStyle=this.selectionColor,this.direction==="rtl"&&(Ke=this.width-Ke-Je),C.fillRect(Ke,p.top+p.topOffset+ht,Je,tt),p.topOffset+=$}},getCurrentCharFontSize:function(){var p=this._getCurrentCharIndex();return this.getValueOfPropertyAt(p.l,p.c,"fontSize")},getCurrentCharColor:function(){var p=this._getCurrentCharIndex();return this.getValueOfPropertyAt(p.l,p.c,"fill")},_getCurrentCharIndex:function(){var p=this.get2DCursorLocation(this.selectionStart,!0),C=p.charIndex>0?p.charIndex-1:0;return{l:p.lineIndex,c:C}}}),T.IText.fromObject=function(p,C){var b=T.util.stylesFromArray(p.styles,p.text),l=Object.assign({},p,{styles:b});if(s(l),l.styles)for(var c in l.styles)for(var h in l.styles[c])s(l.styles[c][h]);T.Object._fromObject("IText",l,C,"text")}}(),function(){var s=T.util.object.clone;T.util.object.extend(T.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var p=this;this.on("added",function(){var C=p.canvas;C&&(C._hasITextHandlers||(C._hasITextHandlers=!0,p._initCanvasHandlers(C)),C._iTextInstances=C._iTextInstances||[],C._iTextInstances.push(p))})},initRemovedHandler:function(){var p=this;this.on("removed",function(){var C=p.canvas;C&&(C._iTextInstances=C._iTextInstances||[],T.util.removeFromArray(C._iTextInstances,p),C._iTextInstances.length===0&&(C._hasITextHandlers=!1,p._removeCanvasHandlers(C)))})},_initCanvasHandlers:function(p){p._mouseUpITextHandler=function(){p._iTextInstances&&p._iTextInstances.forEach(function(C){C.__isMousedown=!1})},p.on("mouse:up",p._mouseUpITextHandler)},_removeCanvasHandlers:function(p){p.off("mouse:up",p._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(p,C,b,l){var c;return c={isAborted:!1,abort:function(){this.isAborted=!0}},p.animate("_currentCursorOpacity",C,{duration:b,onComplete:function(){c.isAborted||p[l]()},onChange:function(){p.canvas&&p.selectionStart===p.selectionEnd&&p.renderCursorOrSelection()},abort:function(){return c.isAborted}}),c},_onTickComplete:function(){var p=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){p._currentTickCompleteState=p._animateCursor(p,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(p){var C=this,b=p?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){C._tick()},b)},abortCursorAnimation:function(){var p=this._currentTickState||this._currentTickCompleteState,C=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,p&&C&&C.clearContext(C.contextTop||C.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(p){var C=0,b=p-1;if(this._reSpace.test(this._text[b]))for(;this._reSpace.test(this._text[b]);)C++,b--;for(;/\S/.test(this._text[b])&&b>-1;)C++,b--;return p-C},findWordBoundaryRight:function(p){var C=0,b=p;if(this._reSpace.test(this._text[b]))for(;this._reSpace.test(this._text[b]);)C++,b++;for(;/\S/.test(this._text[b])&&b<this._text.length;)C++,b++;return p+C},findLineBoundaryLeft:function(p){for(var C=0,b=p-1;!/\n/.test(this._text[b])&&b>-1;)C++,b--;return p-C},findLineBoundaryRight:function(p){for(var C=0,b=p;!/\n/.test(this._text[b])&&b<this._text.length;)C++,b++;return p+C},searchWordBoundary:function(p,C){for(var b=this._text,l=this._reSpace.test(b[p])?p-1:p,c=b[l],h=T.reNonWord;!h.test(c)&&l>0&&l<b.length;)l+=C,c=b[l];return h.test(c)&&(l+=C===1?0:1),l},selectWord:function(p){p=p||this.selectionStart;var C=this.searchWordBoundary(p,-1),b=this.searchWordBoundary(p,1);this.selectionStart=C,this.selectionEnd=b,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(p){p=p||this.selectionStart;var C=this.findLineBoundaryLeft(p),b=this.findLineBoundaryRight(p);return this.selectionStart=C,this.selectionEnd=b,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(p){if(!(this.isEditing||!this.editable))return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(p),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(p){p._iTextInstances&&p._iTextInstances.forEach(function(C){C.selected=!1,C.isEditing&&C.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(p){if(!(!this.__isMousedown||!this.isEditing)){document.activeElement!==this.hiddenTextarea&&this.hiddenTextarea.focus();var C=this.getSelectionStartFromPointer(p.e),b=this.selectionStart,l=this.selectionEnd;(C!==this.__selectionStartOnMouseDown||b===l)&&(b===C||l===C)||(C>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=C):(this.selectionStart=C,this.selectionEnd=this.__selectionStartOnMouseDown),(this.selectionStart!==b||this.selectionEnd!==l)&&(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(p,C,b){var l=b.slice(0,p),c=T.util.string.graphemeSplit(l).length;if(p===C)return{selectionStart:c,selectionEnd:c};var h=b.slice(p,C),m=T.util.string.graphemeSplit(h).length;return{selectionStart:c,selectionEnd:c+m}},fromGraphemeToStringSelection:function(p,C,b){var l=b.slice(0,p),c=l.join("").length;if(p===C)return{selectionStart:c,selectionEnd:c};var h=b.slice(p,C),m=h.join("").length;return{selectionStart:c,selectionEnd:c+m}},_updateTextarea:function(){if(this.cursorOffsetCache={},!!this.hiddenTextarea){if(!this.inCompositionMode){var p=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=p.selectionStart,this.hiddenTextarea.selectionEnd=p.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var p=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=p.selectionEnd,this.inCompositionMode||(this.selectionStart=p.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var p=this._calcTextareaPosition();this.hiddenTextarea.style.left=p.left,this.hiddenTextarea.style.top=p.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var p=this.inCompositionMode?this.compositionStart:this.selectionStart,C=this._getCursorBoundaries(p),b=this.get2DCursorLocation(p),l=b.lineIndex,c=b.charIndex,h=this.getValueOfPropertyAt(l,c,"fontSize")*this.lineHeight,m=C.leftOffset,g=this.calcTransformMatrix(),d={x:C.left+m,y:C.top+C.topOffset+h},w=this.canvas.getRetinaScaling(),E=this.canvas.upperCanvasEl,O=E.width/w,L=E.height/w,V=O-h,$=L-h,ne=E.clientWidth/O,xe=E.clientHeight/L;return d=T.util.transformPoint(d,g),d=T.util.transformPoint(d,this.canvas.viewportTransform),d.x*=ne,d.y*=xe,d.x<0&&(d.x=0),d.x>V&&(d.x=V),d.y<0&&(d.y=0),d.y>$&&(d.y=$),d.x+=this.canvas._offset.left,d.y+=this.canvas._offset.top,{left:d.x+"px",top:d.y+"px",fontSize:h+"px",charHeight:h}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var p=this._textBeforeEdit!==this.text,C=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,C&&(C.blur&&C.blur(),C.parentNode&&C.parentNode.removeChild(C)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),p&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),p&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var p in this.styles)this._textLines[p]||delete this.styles[p]},removeStyleFromTo:function(p,C){var b=this.get2DCursorLocation(p,!0),l=this.get2DCursorLocation(C,!0),c=b.lineIndex,h=b.charIndex,m=l.lineIndex,g=l.charIndex,d,w;if(c!==m){if(this.styles[c])for(d=h;d<this._unwrappedTextLines[c].length;d++)delete this.styles[c][d];if(this.styles[m])for(d=g;d<this._unwrappedTextLines[m].length;d++)w=this.styles[m][d],w&&(this.styles[c]||(this.styles[c]={}),this.styles[c][h+d-g]=w);for(d=c+1;d<=m;d++)delete this.styles[d];this.shiftLineStyles(m,c-m)}else if(this.styles[c]){w=this.styles[c];var E=g-h,O,L;for(d=h;d<g;d++)delete w[d];for(L in this.styles[c])O=parseInt(L,10),O>=g&&(w[O-E]=w[L],delete w[L])}},shiftLineStyles:function(p,C){var b=s(this.styles);for(var l in this.styles){var c=parseInt(l,10);c>p&&(this.styles[c+C]=b[c],b[c-C]||delete this.styles[c])}},restartCursorIfNeeded:function(){(!this._currentTickState||this._currentTickState.isAborted||!this._currentTickCompleteState||this._currentTickCompleteState.isAborted)&&this.initDelayedCursor()},insertNewlineStyleObject:function(p,C,b,l){var c,h={},m=!1,g=this._unwrappedTextLines[p].length===C;b||(b=1),this.shiftLineStyles(p,b),this.styles[p]&&(c=this.styles[p][C===0?C:C-1]);for(var d in this.styles[p]){var w=parseInt(d,10);w>=C&&(m=!0,h[w-C]=this.styles[p][d],g&&C===0||delete this.styles[p][d])}var E=!1;for(m&&!g&&(this.styles[p+b]=h,E=!0),E&&b--;b>0;)l&&l[b-1]?this.styles[p+b]={0:s(l[b-1])}:c?this.styles[p+b]={0:s(c)}:delete this.styles[p+b],b--;this._forceClearCache=!0},insertCharStyleObject:function(p,C,b,l){this.styles||(this.styles={});var c=this.styles[p],h=c?s(c):{};b||(b=1);for(var m in h){var g=parseInt(m,10);g>=C&&(c[g+b]=h[g],h[g-b]||delete c[g])}if(this._forceClearCache=!0,l){for(;b--;)Object.keys(l[b]).length&&(this.styles[p]||(this.styles[p]={}),this.styles[p][C+b]=s(l[b]));return}if(c)for(var d=c[C?C-1:1];d&&b--;)this.styles[p][C+b]=s(d)},insertNewStyleBlock:function(p,C,b){for(var l=this.get2DCursorLocation(C,!0),c=[0],h=0,m=0;m<p.length;m++)p[m]===`
`?(h++,c[h]=0):c[h]++;c[0]>0&&(this.insertCharStyleObject(l.lineIndex,l.charIndex,c[0],b),b=b&&b.slice(c[0]+1)),h&&this.insertNewlineStyleObject(l.lineIndex,l.charIndex+c[0],h);for(var m=1;m<h;m++)c[m]>0?this.insertCharStyleObject(l.lineIndex+m,0,c[m],b):b&&this.styles[l.lineIndex+m]&&b[0]&&(this.styles[l.lineIndex+m][0]=b[0]),b=b&&b.slice(c[m]+1);c[m]>0&&this.insertCharStyleObject(l.lineIndex+m,0,c[m],b)},setSelectionStartEndWithShift:function(p,C,b){b<=p?(C===p?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=p),this.selectionStart=b):b>p&&b<C?this._selectionDirection==="right"?this.selectionEnd=b:this.selectionStart=b:(C===p?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=C),this.selectionEnd=b)},setSelectionInBoundaries:function(){var p=this.text.length;this.selectionStart>p?this.selectionStart=p:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>p?this.selectionEnd=p:this.selectionEnd<0&&(this.selectionEnd=0)}})}(),T.util.object.extend(T.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(s){if(this.canvas){this.__newClickTime=+new Date;var p=s.pointer;this.isTripleClick(p)&&(this.fire("tripleclick",s),this._stopEvent(s.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=p,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(s){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===s.x&&this.__lastPointer.y===s.y},_stopEvent:function(s){s.preventDefault&&s.preventDefault(),s.stopPropagation&&s.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(s){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(s.e))},tripleClickHandler:function(s){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(s.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(s){!this.canvas||!this.editable||s.e.button&&s.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(s.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(s){!this.canvas||!this.editable||s.e.button&&s.e.button!==1||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(s){if(this.__isMousedown=!1,!(!this.editable||this.group||s.transform&&s.transform.actionPerformed||s.e.button&&s.e.button!==1)){if(this.canvas){var p=this.canvas._activeObject;if(p&&p!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(s.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(s){var p=this.getSelectionStartFromPointer(s),C=this.selectionStart,b=this.selectionEnd;s.shiftKey?this.setSelectionStartEndWithShift(C,b,p):(this.selectionStart=p,this.selectionEnd=p),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(s){for(var p=this.getLocalPointer(s),C=0,b=0,l=0,c=0,h=0,m,g,d=0,w=this._textLines.length;d<w&&l<=p.y;d++)l+=this.getHeightOfLine(d)*this.scaleY,h=d,d>0&&(c+=this._textLines[d-1].length+this.missingNewlineOffset(d-1));m=this._getLineLeftOffset(h),b=m*this.scaleX,g=this._textLines[h],this.direction==="rtl"&&(p.x=this.width*this.scaleX-p.x+b);for(var E=0,O=g.length;E<O&&(C=b,b+=this.__charBounds[h][E].kernedWidth*this.scaleX,b<=p.x);E++)c++;return this._getNewSelectionStartFromOffset(p,C,b,c,O)},_getNewSelectionStartFromOffset:function(s,p,C,b,l){var c=s.x-p,h=C-s.x,m=h>c||h<0?0:1,g=b+m;return this.flipX&&(g=l-g),g>this._text.length&&(g=this._text.length),g}}),T.util.object.extend(T.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=T.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var s=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+s.top+"; left: "+s.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding-top: "+s.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):T.document.body.appendChild(this.hiddenTextarea),T.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),T.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),T.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),T.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),T.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),T.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),T.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),T.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),T.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(T.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(s){if(this.isEditing){var p=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(s.keyCode in p)this[p[s.keyCode]](s);else if(s.keyCode in this.ctrlKeysMapDown&&(s.ctrlKey||s.metaKey))this[this.ctrlKeysMapDown[s.keyCode]](s);else return;s.stopImmediatePropagation(),s.preventDefault(),s.keyCode>=33&&s.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(s){if(!this.isEditing||this._copyDone||this.inCompositionMode){this._copyDone=!1;return}if(s.keyCode in this.ctrlKeysMapUp&&(s.ctrlKey||s.metaKey))this[this.ctrlKeysMapUp[s.keyCode]](s);else return;s.stopImmediatePropagation(),s.preventDefault(),this.canvas&&this.canvas.requestRenderAll()},onInput:function(s){var p=this.fromPaste;if(this.fromPaste=!1,s&&s.stopPropagation(),!!this.isEditing){var C=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,b=this._text.length,l=C.length,c,h,m=l-b,g=this.selectionStart,d=this.selectionEnd,w=g!==d,E,O,L;if(this.hiddenTextarea.value===""){this.styles={},this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll());return}var V=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),$=g>V.selectionStart;w?(c=this._text.slice(g,d),m+=d-g):l<b&&($?c=this._text.slice(d+m,d):c=this._text.slice(g,g-m)),h=C.slice(V.selectionEnd-m,V.selectionEnd),c&&c.length&&(h.length&&(E=this.getSelectionStyles(g,g+1,!1),E=h.map(function(){return E[0]})),w?(O=g,L=d):$?(O=d-c.length,L=d):(O=d,L=d+c.length),this.removeStyleFromTo(O,L)),h.length&&(p&&h.join("")===T.copiedText&&!T.disableStyleCopyPaste&&(E=T.copiedTextStyle),this.insertNewStyleBlock(h,g,E)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(s){this.compositionStart=s.target.selectionStart,this.compositionEnd=s.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(T.copiedText=this.getSelectedText(),T.disableStyleCopyPaste?T.copiedTextStyle=null:T.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(s){return s&&s.clipboardData||T.window.clipboardData},_getWidthBeforeCursor:function(s,p){var C=this._getLineLeftOffset(s),b;return p>0&&(b=this.__charBounds[s][p-1],C+=b.left+b.width),C},getDownCursorOffset:function(s,p){var C=this._getSelectionForOffset(s,p),b=this.get2DCursorLocation(C),l=b.lineIndex;if(l===this._textLines.length-1||s.metaKey||s.keyCode===34)return this._text.length-C;var c=b.charIndex,h=this._getWidthBeforeCursor(l,c),m=this._getIndexOnLine(l+1,h),g=this._textLines[l].slice(c);return g.length+m+1+this.missingNewlineOffset(l)},_getSelectionForOffset:function(s,p){return s.shiftKey&&this.selectionStart!==this.selectionEnd&&p?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(s,p){var C=this._getSelectionForOffset(s,p),b=this.get2DCursorLocation(C),l=b.lineIndex;if(l===0||s.metaKey||s.keyCode===33)return-C;var c=b.charIndex,h=this._getWidthBeforeCursor(l,c),m=this._getIndexOnLine(l-1,h),g=this._textLines[l].slice(0,c),d=this.missingNewlineOffset(l-1);return-this._textLines[l-1].length+m-g.length+(1-d)},_getIndexOnLine:function(s,p){for(var C=this._textLines[s],b=this._getLineLeftOffset(s),l=b,c=0,h,m,g=0,d=C.length;g<d;g++)if(h=this.__charBounds[s][g].width,l+=h,l>p){m=!0;var w=l-h,E=l,O=Math.abs(w-p),L=Math.abs(E-p);c=L<O?g:g-1;break}return m||(c=C.length-1),c},moveCursorDown:function(s){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",s)},moveCursorUp:function(s){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",s)},_moveCursorUpOrDown:function(s,p){var C="get"+s+"CursorOffset",b=this[C](p,this._selectionDirection==="right");p.shiftKey?this.moveCursorWithShift(b):this.moveCursorWithoutShift(b),b!==0&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(s){var p=this._selectionDirection==="left"?this.selectionStart+s:this.selectionEnd+s;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,p),s!==0},moveCursorWithoutShift:function(s){return s<0?(this.selectionStart+=s,this.selectionEnd=this.selectionStart):(this.selectionEnd+=s,this.selectionStart=this.selectionEnd),s!==0},moveCursorLeft:function(s){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",s)},_move:function(s,p,C){var b;if(s.altKey)b=this["findWordBoundary"+C](this[p]);else if(s.metaKey||s.keyCode===35||s.keyCode===36)b=this["findLineBoundary"+C](this[p]);else return this[p]+=C==="Left"?-1:1,!0;if(typeof b<"u"&&this[p]!==b)return this[p]=b,!0},_moveLeft:function(s,p){return this._move(s,p,"Left")},_moveRight:function(s,p){return this._move(s,p,"Right")},moveCursorLeftWithoutShift:function(s){var p=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(p=this._moveLeft(s,"selectionStart")),this.selectionEnd=this.selectionStart,p},moveCursorLeftWithShift:function(s){if(this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd)return this._moveLeft(s,"selectionEnd");if(this.selectionStart!==0)return this._selectionDirection="left",this._moveLeft(s,"selectionStart")},moveCursorRight:function(s){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",s)},_moveCursorLeftOrRight:function(s,p){var C="moveCursor"+s+"With";this._currentCursorOpacity=1,p.shiftKey?C+="Shift":C+="outShift",this[C](p)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(s){if(this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd)return this._moveRight(s,"selectionStart");if(this.selectionEnd!==this._text.length)return this._selectionDirection="right",this._moveRight(s,"selectionEnd")},moveCursorRightWithoutShift:function(s){var p=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(p=this._moveRight(s,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,p},removeChars:function(s,p){typeof p>"u"&&(p=s+1),this.removeStyleFromTo(s,p),this._text.splice(s,p-s),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(s,p,C,b){typeof b>"u"&&(b=C),b>C&&this.removeStyleFromTo(C,b);var l=T.util.string.graphemeSplit(s);this.insertNewStyleBlock(l,C,p),this._text=[].concat(this._text.slice(0,C),l,this._text.slice(b)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var s=T.util.toFixed,p=/  +/g;T.util.object.extend(T.Text.prototype,{_toSVG:function(){var C=this._getSVGLeftTopOffsets(),b=this._getSVGTextAndBg(C.textTop,C.textLeft);return this._wrapSVGTextAndBg(b)},toSVG:function(C){return this._createBaseSVGMarkup(this._toSVG(),{reviver:C,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(C){var b=!0,l=this.getSvgTextDecoration(this);return[C.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",l?'text-decoration="'+l+'" ':"",'style="',this.getSvgStyles(b),'"',this.addPaintOrder()," >",C.textSpans.join(""),`</text>
`]},_getSVGTextAndBg:function(C,b){var l=[],c=[],h=C,m;this._setSVGBg(c);for(var g=0,d=this._textLines.length;g<d;g++)m=this._getLineLeftOffset(g),(this.textBackgroundColor||this.styleHas("textBackgroundColor",g))&&this._setSVGTextLineBg(c,g,b+m,h),this._setSVGTextLineText(l,g,b+m,h),h+=this.getHeightOfLine(g);return{textSpans:l,textBgRects:c}},_createTextCharSpan:function(C,b,l,c){var h=C!==C.trim()||C.match(p),m=this.getSvgSpanStyles(b,h),g=m?'style="'+m+'"':"",d=b.deltaY,w="",E=T.Object.NUM_FRACTION_DIGITS;return d&&(w=' dy="'+s(d,E)+'" '),['<tspan x="',s(l,E),'" y="',s(c,E),'" ',w,g,">",T.util.string.escapeXml(C),"</tspan>"].join("")},_setSVGTextLineText:function(C,b,l,c){var h=this.getHeightOfLine(b),m=this.textAlign.indexOf("justify")!==-1,g,d,w="",E,O,L=0,V=this._textLines[b],$;c+=h*(1-this._fontSizeFraction)/this.lineHeight;for(var ne=0,xe=V.length-1;ne<=xe;ne++)$=ne===xe||this.charSpacing,w+=V[ne],E=this.__charBounds[b][ne],L===0?(l+=E.kernedWidth-E.width,L+=E.width):L+=E.kernedWidth,m&&!$&&this._reSpaceAndTab.test(V[ne])&&($=!0),$||(g=g||this.getCompleteStyleDeclaration(b,ne),d=this.getCompleteStyleDeclaration(b,ne+1),$=T.util.hasStyleChanged(g,d,!0)),$&&(O=this._getStyleDeclaration(b,ne)||{},C.push(this._createTextCharSpan(w,O,l,c)),w="",g=d,l+=L,L=0)},_pushTextBgRect:function(C,b,l,c,h,m){var g=T.Object.NUM_FRACTION_DIGITS;C.push("		<rect ",this._getFillAttributes(b),' x="',s(l,g),'" y="',s(c,g),'" width="',s(h,g),'" height="',s(m,g),`"></rect>
`)},_setSVGTextLineBg:function(C,b,l,c){for(var h=this._textLines[b],m=this.getHeightOfLine(b)/this.lineHeight,g=0,d=0,w,E,O=this.getValueOfPropertyAt(b,0,"textBackgroundColor"),L=0,V=h.length;L<V;L++)w=this.__charBounds[b][L],E=this.getValueOfPropertyAt(b,L,"textBackgroundColor"),E!==O?(O&&this._pushTextBgRect(C,O,l+d,c,g,m),d=w.left,g=w.width,O=E):g+=w.kernedWidth;E&&this._pushTextBgRect(C,E,l+d,c,g,m)},_getFillAttributes:function(C){var b=C&&typeof C=="string"?new T.Color(C):"";return!b||!b.getSource()||b.getAlpha()===1?'fill="'+C+'"':'opacity="'+b.getAlpha()+'" fill="'+b.setAlpha(1).toRgb()+'"'},_getSVGLineTopOffset:function(C){for(var b=0,l=0,c=0;c<C;c++)b+=this.getHeightOfLine(c);return l=this.getHeightOfLine(c),{lineTop:b,offset:(this._fontSizeMult-this._fontSizeFraction)*l/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(C){var b=T.Object.prototype.getSvgStyles.call(this,C);return b+" white-space: pre;"}})}(),function(s){var p=s.fabric||(s.fabric={});p.Textbox=p.util.createClass(p.IText,p.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:p.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(C){for(var b=0,l=0,c=0,h={},m=0;m<C.graphemeLines.length;m++)C.graphemeText[c]===`
`&&m>0?(l=0,c++,b++):!this.splitByGrapheme&&this._reSpaceAndTab.test(C.graphemeText[c])&&m>0&&(l++,c++),h[m]={line:b,offset:l},c+=C.graphemeLines[m].length,l+=C.graphemeLines[m].length;return h},styleHas:function(C,b){if(this._styleMap&&!this.isWrapping){var l=this._styleMap[b];l&&(b=l.line)}return p.Text.prototype.styleHas.call(this,C,b)},isEmptyStyles:function(C){if(!this.styles)return!0;var b=0,l=C+1,c,h,m=!1,g=this._styleMap[C],d=this._styleMap[C+1];g&&(C=g.line,b=g.offset),d&&(l=d.line,m=l===C,c=d.offset),h=typeof C>"u"?this.styles:{line:this.styles[C]};for(var w in h)for(var E in h[w])if(E>=b&&(!m||E<c))for(var O in h[w][E])return!1;return!0},_getStyleDeclaration:function(C,b){if(this._styleMap&&!this.isWrapping){var l=this._styleMap[C];if(!l)return null;C=l.line,b=l.offset+b}return this.callSuper("_getStyleDeclaration",C,b)},_setStyleDeclaration:function(C,b,l){var c=this._styleMap[C];C=c.line,b=c.offset+b,this.styles[C][b]=l},_deleteStyleDeclaration:function(C,b){var l=this._styleMap[C];C=l.line,b=l.offset+b,delete this.styles[C][b]},_getLineStyle:function(C){var b=this._styleMap[C];return!!this.styles[b.line]},_setLineStyle:function(C){var b=this._styleMap[C];this.styles[b.line]={}},_wrapText:function(C,b){var l=[],c;for(this.isWrapping=!0,c=0;c<C.length;c++)l=l.concat(this._wrapLine(C[c],c,b));return this.isWrapping=!1,l},_measureWord:function(C,b,l){var c=0,h,m=!0;l=l||0;for(var g=0,d=C.length;g<d;g++){var w=this._getGraphemeBox(C[g],b,g+l,h,m);c+=w.kernedWidth,h=C[g]}return c},_wrapLine:function(C,b,l,Ke){var h=0,m=this.splitByGrapheme,g=[],d=[],w=m?p.util.string.graphemeSplit(C):C.split(this._wordJoiners),E="",O=0,L=m?"":" ",V=0,$=0,ne=0,xe=!0,ze=this._getWidthOfCharSpacing(),Ke=Ke||0;w.length===0&&w.push([]),l-=Ke;for(var Je=0;Je<w.length;Je++)E=m?w[Je]:p.util.string.graphemeSplit(w[Je]),V=this._measureWord(E,b,O),O+=E.length,h+=$+V-ze,h>l&&!xe?(g.push(d),d=[],h=V,xe=!0):h+=ze,!xe&&!m&&d.push(L),d=d.concat(E),$=m?0:this._measureWord([L],b,O),O++,xe=!1,V>ne&&(ne=V);return Je&&g.push(d),ne+Ke>this.dynamicMinWidth&&(this.dynamicMinWidth=ne-ze+Ke),g},isEndOfWrapping:function(C){return!this._styleMap[C+1]||this._styleMap[C+1].line!==this._styleMap[C].line},missingNewlineOffset:function(C){return this.splitByGrapheme?this.isEndOfWrapping(C)?1:0:1},_splitTextIntoLines:function(C){for(var b=p.Text.prototype._splitTextIntoLines.call(this,C),l=this._wrapText(b.lines,this.width),c=new Array(l.length),h=0;h<l.length;h++)c[h]=l[h].join("");return b.lines=c,b.graphemeLines=l,b},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var C={};for(var b in this._styleMap)this._textLines[b]&&(C[this._styleMap[b].line]=1);for(var b in this.styles)C[b]||delete this.styles[b]},toObject:function(C){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(C))}}),p.Textbox.fromObject=function(C,b){var l=p.util.stylesFromArray(C.styles,C.text),c=Object.assign({},C,{styles:l});return p.Object._fromObject("Textbox",c,b,"text")}}(Y),function(){var s=T.controlsUtils,p=s.scaleSkewCursorStyleHandler,C=s.scaleCursorStyleHandler,b=s.scalingEqually,l=s.scalingYOrSkewingX,c=s.scalingXOrSkewingY,h=s.scaleOrSkewActionName,m=T.Object.prototype.controls;if(m.ml=new T.Control({x:-.5,y:0,cursorStyleHandler:p,actionHandler:c,getActionName:h}),m.mr=new T.Control({x:.5,y:0,cursorStyleHandler:p,actionHandler:c,getActionName:h}),m.mb=new T.Control({x:0,y:.5,cursorStyleHandler:p,actionHandler:l,getActionName:h}),m.mt=new T.Control({x:0,y:-.5,cursorStyleHandler:p,actionHandler:l,getActionName:h}),m.tl=new T.Control({x:-.5,y:-.5,cursorStyleHandler:C,actionHandler:b}),m.tr=new T.Control({x:.5,y:-.5,cursorStyleHandler:C,actionHandler:b}),m.bl=new T.Control({x:-.5,y:.5,cursorStyleHandler:C,actionHandler:b}),m.br=new T.Control({x:.5,y:.5,cursorStyleHandler:C,actionHandler:b}),m.mtr=new T.Control({x:0,y:-.5,actionHandler:s.rotationWithSnapping,cursorStyleHandler:s.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),T.Textbox){var g=T.Textbox.prototype.controls={};g.mtr=m.mtr,g.tr=m.tr,g.br=m.br,g.tl=m.tl,g.bl=m.bl,g.mt=m.mt,g.mb=m.mb,g.mr=new T.Control({x:.5,y:0,actionHandler:s.changeWidth,cursorStyleHandler:p,actionName:"resizing"}),g.ml=new T.Control({x:-.5,y:0,actionHandler:s.changeWidth,cursorStyleHandler:p,actionName:"resizing"})}}()})(wi);function _f(){const Y=Math.round(16777215*Math.random()),T=Y>>16,se=Y>>8&255,fe=Y&255;return"rgb("+T+", "+se+", "+fe+")"}const ou=Y=>{if(!Y)return[0,0,0];const T=Y.match(/rgba?\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)?(?:, ?(\d(?:\.\d?))\))?/);return T?[parseInt(T[1]),parseInt(T[2]),parseInt(T[3])]:[0,0,0]},Zd=(Y,T)=>{const se=Y._offset.left,fe=Y._offset.top,he=T.e.pageX-se,Ie=T.e.pageY-fe;return{x:he,y:Ie}},Zm=Y=>Math.abs(Math.min.apply(Math,Y.map(function(T){return T.y}))),Km=Y=>Math.abs(Math.min.apply(Math,Y.map(function(T){return T.x}))),yf=Y=>{let T=new wi.fabric.Point(Y.strokeUniform?1/Y.scaleX:1,Y.strokeUniform?1/Y.scaleY:1).multiply(Y.strokeWidth);return new wi.fabric.Point(Y.width+T.x,Y.height+T.y)};class Jm{generateNumber(T){return T*Math.random()|0}generateX(){return this.generateNumber(16).toString(16)}generateXes(T){let se="";for(let fe=0;fe<T;++fe)se+=this.generateX();return se}generateVariant(){return(this.generateNumber(16)&3|8).toString(16)}generate(){return this.generateXes(8)+"-"+this.generateXes(4)+"-4"+this.generateXes(3)+"-"+this.generateVariant()+this.generateXes(3)+"-"+this.generateXes(12)}}const Kd=(Y,T,se)=>{const fe=Y.x,he=Y.y,Ie=T.x,N=T.y,s=se/Math.hypot(Ie-fe,N-he),p=Ie+(Ie-fe)*s,C=N+(N-he)*s;return new wi.fabric.Point(p,C)},rh=(Y,T,se,fe,he)=>{Y.x<T&&(Y.x=T),Y.y<se&&(Y.y=se),Y.x>fe&&(Y.x=fe),Y.y>he&&(Y.y=he)},Jd=(Y,T,se)=>new wi.fabric.Point(Math.floor(Y.x/T),Math.floor(Y.y/se));var $n=(Y=>(Y.LeftRightTopBottom="lrtb",Y.RightLeftBottomTop="rlbt",Y))($n||{});const Qm=new Map([["lrtb",""],["rlbt",""]]),eg=new Map([["lrtb","Left->Right or Top->Bottom"],["rlbt","Right->Left or Bottom->Top"]]),tg=new Map([["","lrtb"],["","rlbt"]]);(Y=>{function T(he){return Qm.get(he)??"err"}Y.toString=T;function se(he){return eg.get(he)??"err"}Y.toHumanString=se;function fe(he){return tg.get(he)}Y.parse=fe})($n||($n={}));var fo=(Y=>(Y.LINE_CONTROL="lineControl",Y.CHANGE_DIRECTION_CONTROL="changeDirectionControl",Y.DELETE_VIRTUAL_LINE_CONTROL="deleteVirtualLineControl",Y))(fo||{});const ig="TYPE_VIRTUAL_LINE_GROUP";class Qd extends wi.fabric.Line{constructor(T,se){super(T,se)}calcCurrentPoints(){var s,p;const T=this.calcLinePoints(),se=this.calcTransformMatrix(),fe=((s=this.canvas)==null?void 0:s.getWidth())??10,he=((p=this.canvas)==null?void 0:p.getHeight())??10,Ie=wi.fabric.util.transformPoint(new wi.fabric.Point(T.x1,T.y1),se);rh(Ie,0,0,fe,he);const N=wi.fabric.util.transformPoint(new wi.fabric.Point(T.x2,T.y2),se);return rh(N,0,0,fe,he),[Ie,N]}}class ho extends wi.fabric.Group{constructor(se,fe,he){super(se,fe,he);kn(this,"segment_object_idx");kn(this,"direction");kn(this,"current_points");kn(this,"color_rgb");kn(this,"parentContour");this.segment_object_idx=0,this.direction=$n.LeftRightTopBottom,this.current_points=[[0,0],[0,0]],this.color_rgb=[0,0,0],this.type=ig}}function vf(Y,T,se){const fe=Y.canvas;if(!fe)return console.error("Empty target canvas for preparing virtual line"),!1;const he=new wi.fabric.Point(se.geometry[0][0],se.geometry[0][1]),Ie=new wi.fabric.Point(se.geometry[1][0],se.geometry[1][1]),N=new wi.fabric.Shadow({color:"rgba(0, 0, 0, 1)",affectStroke:!0,blur:30}),s=T?new wi.fabric.Point(Math.floor(he.x*fe.scaleWidth),Math.floor(he.y*fe.scaleHeight)):new wi.fabric.Point(Math.floor(he.x/fe.scaleWidth),Math.floor(he.y/fe.scaleHeight)),p=T?new wi.fabric.Point(Math.floor(Ie.x*fe.scaleWidth),Math.floor(Ie.y*fe.scaleHeight)):new wi.fabric.Point(Math.floor(Ie.x/fe.scaleWidth),Math.floor(Ie.y/fe.scaleHeight)),C=T?s:he,b=T?p:Ie,l=new Qd([C.x,C.y,b.x,b.y],{stroke:Y.stroke,strokeWidth:5,strokeDashArray:[5],strokeUniform:!0,objectCaching:!1,shadow:N}),c={fontWeight:"bold",fontSize:42},h=new wi.fabric.Point((C.x+b.x)/2,(C.y+b.y)/2),m=new wi.fabric.IText($n.toString(se.direction),{left:h.x-20,top:h.y,fontSize:18,fontFamily:"Roboto",fill:Y.stroke,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9,objectCaching:!1,styles:{0:{0:c,1:c}}}),g=new wi.fabric.Text("L1",{left:C.x-5,top:C.y+10,fontSize:18,fontFamily:"Roboto",fill:Y.stroke,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9,objectCaching:!1}),d=new wi.fabric.Text("L2",{left:b.x-5,top:b.y+10,fontSize:18,fontFamily:"Roboto",fill:Y.stroke,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9,objectCaching:!1}),w=new ho([l,m,g,d],{strokeUniform:!0,objectCaching:!1});w.current_points=T?[[he.x,he.y],[Ie.x,Ie.y]]:[[s.x,s.y],[p.x,p.y]],w.color_rgb=ou(l.stroke),w.direction=se.direction,w.segment_object_idx=0,w.setControlsVisibility({bl:!1,br:!1,mb:!1,ml:!0,mr:!0,mt:!1,tl:!1,tr:!1,mtr:!0}),w.setControlVisible(fo.LINE_CONTROL,!1),w.setControlVisible(fo.CHANGE_DIRECTION_CONTROL,!0),w.setControlVisible(fo.DELETE_VIRTUAL_LINE_CONTROL,!0),w.on("scaling",function(E){const O=E.transform;if(!O){console.error("Empty transform event for group object on line group. Event: modified. Options:",E);return}const L=O.target;if(!L){console.error("Empty target group object on line group. Event: scaling. Options:",E);return}if(!(L instanceof ho)){console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: scaling. Options:",E);return}const V=1/(L.scaleX??1),$=1/(L.scaleY??1);L.getObjects("text").forEach(ze=>{ze.set("scaleX",V),ze.set("scaleY",$)}),L.getObjects("i-text").forEach(ze=>{ze.set("scaleX",V),ze.set("scaleY",$)})}),w.on("rotating",function(E){const O=E.transform;if(!O){console.error("Empty transform event for group object on line group. Event: modified. Options:",E);return}const L=O.target;if(!L){console.error("Empty target group object on line group. Event: scaling. Options:",E);return}if(!(L instanceof ho)){console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: scaling. Options:",E);return}const V=360-(L.angle??0);L.getObjects("text").forEach(xe=>{xe.rotate(V)}),L.getObjects("i-text").forEach(xe=>{xe.rotate(V)})}),w.on("modified",E=>{const O=E.target;if(!O){console.error("Empty target group object on line group. Event: modified. Options:",E);return}if(!(O instanceof ho)){console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: modified. Options:",E);return}const L=O.canvas;if(!L){console.error("Empty target canvas on line group. Event: modified. Options:",E);return}const V=O.getObjects()[O.segment_object_idx];if(!(V instanceof Qd)){console.error("Unhandled type. Only CustomLime on top of fabric.Object has been implemented. Event: modified. Options:",E);return}const $=V.calcCurrentPoints(),ne=Jd($[0],L.scaleWidth,L.scaleHeight),xe=Jd($[1],L.scaleWidth,L.scaleHeight);O.current_points[0][0]=ne.x,O.current_points[0][1]=ne.y,O.current_points[1][0]=xe.x,O.current_points[1][1]=xe.y,Y.fire("virtial_line:modified",{target:Y})}),w.on("mouseover",function(E){const O=E.target;if(!O){console.error("Empty target group object on line group. Event: mouseover. Options:",E);return}const L=O.canvas;if(!L){console.error("Empty target canvas on line group. Event: mouseover. Options:",E);return}if(!(O instanceof ho))return;O.getObjects().forEach($=>{var nt,_t;const ne=(nt=$.shadow)==null?void 0:nt.valueOf();if(!(ne&&ne instanceof wi.fabric.Shadow))return;const ze=ne;ze.color="rgba(255, 255, 255, 1)",ze.blur=30;const Je=(_t=Y.shadow)==null?void 0:_t.valueOf();if(!(Je&&Je instanceof wi.fabric.Shadow))return;const ht=Je;ht.color="rgba(255, 255, 255, 1)",ht.blur=30}),L.renderAll()}),w.on("mouseout",function(E){const O=E.target;if(!O){console.error("Empty target object on line group. Event: mouseout. Options:",E);return}const L=O.canvas;if(!L){console.error("Empty target canvas on line group. Event: mouseout. Options:",E);return}if(!(O instanceof ho))return;O.getObjects().forEach($=>{var nt,_t;const ne=(nt=$.shadow)==null?void 0:nt.valueOf();if(!(ne&&ne instanceof wi.fabric.Shadow))return;const ze=ne;ze.color="rgba(0, 0, 0, 1)",ze.blur=30;const Ke=Y,Je=(_t=Ke.shadow)==null?void 0:_t.valueOf();if(!(Je&&Je instanceof wi.fabric.Shadow))return;const ht=Je;ht.color=Ke.stroke,ht.blur=0}),L.renderAll()}),w.on("removed",function(E){w.parentContour&&w.parentContour.fire("virtial_line:removed",{target:Y})}),Y.virtual_line=w,Y.fire("virtial_line:created",{target:Y}),w.parentContour=Y,fe.add(w)}class rg extends wi.fabric.Canvas{constructor(se,fe){super(se,fe);kn(this,"scaleWidth");kn(this,"scaleHeight");kn(this,"contourTemporary");kn(this,"contourNotationTemporary");kn(this,"contourFinalized");this.scaleWidth=1,this.scaleHeight=1,this.contourTemporary=new Array,this.contourNotationTemporary=new Array,this.contourFinalized=new Array}editContour(se){var fe,he;if(this.setActiveObject(se),se.edit=!se.edit,se.edit){let Ie=((fe=se==null?void 0:se.points)==null?void 0:fe.length)-1;se.cornerStyle="circle",se.cornerSize=15,se.cornerColor="rgba(0, 0, 255, 1.0)",se.controls=(he=se==null?void 0:se.points)==null?void 0:he.reduce(function(N,s,p){return N["p"+p]=new wi.fabric.Control({positionHandler:sg,actionHandler:ng(p>0?p-1:Ie,og),actionName:"modifyPolygon",pointIndex:p}),N},{})}else se.cornerColor="rgb(178, 204, 255)",se.cornerStyle="rect",se.controls=wi.fabric.Object.prototype.controls;se.hasBorders=!se.edit,this.requestRenderAll()}}const ng=function(Y,T){return function(se,fe,he,Ie){let N=fe.target;const s=new wi.fabric.Point(N.points[Y].x-N.pathOffset.x,N.points[Y].y-N.pathOffset.y);let p=wi.fabric.util.transformPoint(s,N.calcTransformMatrix()),C=T(se,fe,he,Ie);N._setPositionDimensions({});let b=yf(N),l=(N.points[Y].x-N.pathOffset.x)/b.x,c=(N.points[Y].y-N.pathOffset.y)/b.y;return N.setPositionByOrigin(p,l+.5,c+.5),C}},sg=function(Y,T,se){let fe=se.points[this.pointIndex].x-se.pathOffset.x,he=se.points[this.pointIndex].y-se.pathOffset.y;const Ie=new wi.fabric.Point(fe,he);return wi.fabric.util.transformPoint(Ie,wi.fabric.util.multiplyTransformMatrices(se.canvas.viewportTransform,se.calcTransformMatrix()))},og=function(Y,T,se,fe){let he=T.target,Ie=he.controls[he.__corner],N=he.toLocalPoint(new wi.fabric.Point(se,fe),"center","center"),s=yf(he),p=he._getTransformedDimensions(0,0),C={x:N.x*s.x/p.x+he.pathOffset.x,y:N.y*s.y/p.y+he.pathOffset.y};return he.points[Ie.pointIndex]=C,!0};class fa extends wi.fabric.Polygon{constructor(se,fe){super(se,fe);kn(this,"inner");kn(this,"unid");kn(this,"notation");kn(this,"current_points");kn(this,"virtual_line");this.unid="",this.notation=[],this.inner=this,this.current_points=[],this.virtual_line=void 0}}const xf=["A","B","C","D"],ag=(Y,T=_f())=>{let se=Km(Y),fe=Zm(Y);const he=new wi.fabric.Shadow({color:T,affectStroke:!0,blur:0});let Ie=new fa(Y,{fill:"rgba(0,0,0,0)",stroke:T,strokeWidth:3,objectCaching:!1,shadow:he});Ie.set({left:se,top:fe});const N=new Array;return Y.forEach((s,p)=>{const C=new wi.fabric.Text(xf[p],{left:s.x,top:s.y,fontSize:24,fontFamily:"Roboto",fill:T,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9,selectable:!1});N.push(C)}),Ie.current_points=Ie.points,Ie.unid="00000000-0000-0000-0000-000000000000",Ie.notation=N,Ie};function bf(Y,T,se,fe,he="",Ie=_f(),N=!0){const s=ag(Y,Ie);return s.setControlVisible(fo.LINE_CONTROL,!0),s.setControlVisible(fo.CHANGE_DIRECTION_CONTROL,!1),s.setControlVisible(fo.DELETE_VIRTUAL_LINE_CONTROL,!1),s.inner.on("mousedown",lg(T,se,fe)),s.inner.on("modified",cg(se,fe)),N&&(s.inner.on("virtial_line:created",au(se,fe)),s.inner.on("virtial_line:modified",wf(se,fe)),s.inner.on("virtial_line:removed",Cf(se,fe))),s.inner.on("mouseover",function(p){var m;const C=p.target;if(!C){console.error("Empty target contour on mouseover. Options:",p);return}const b=C.canvas;if(!b){console.error("Empty target canvas on mouseover. Options:",p);return}C.set("fill","rgba(0, 0, 0, 0.1)");const l=(m=C.shadow)==null?void 0:m.valueOf();if(!(l&&l instanceof wi.fabric.Shadow))return;const h=l;h.blur=30,b.renderAll()}),s.inner.on("mouseout",function(p){var m;const C=p.target;if(!C){console.error("Empty target contour on mouseout. Options:",p);return}const b=C.canvas;if(!b){console.error("Empty target canvas on mouseout. Options:",p);return}C.set("fill","rgba(0, 0, 0, 0)");const l=(m=C.shadow)==null?void 0:m.valueOf();if(!(l&&l instanceof wi.fabric.Shadow))return;const h=l;h.blur=0,b.renderAll()}),he!==""?s.unid=he:s.unid=new Jm().generate(),s.notation.forEach((p,C)=>{s.notation[C].text_id=s.unid}),s}function au(Y,T){return function(se){const fe=se.target;if(!fe){console.error("Empty target contour on virtual_line:created. Options:",se);return}if(!(fe instanceof fa)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: virtual_line:created. Options:",se);return}const he=fe,Ie=he.virtual_line;if(!Ie){console.error("Empty virtual line. Event: virtual_line:created. Options:",se);return}let N=Sl(Y).get(he.unid);if(!N){console.error("No contour in datastorage. Event: virtual_line:created. Options:",se);return}N.properties.virtual_line={geometry:Ie.current_points,color_rgb:Ie.color_rgb,direction:Ie.direction},T(he.unid,N)}}function wf(Y,T){return au(Y,T)}function Cf(Y,T){return function(se){const fe=se.target;if(!fe){console.error("Empty target contour on virtual_line:removed. Options:",se);return}if(!(fe instanceof fa)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: virtual_line:removed. Options:",se);return}fe.virtual_line=void 0;let he=Sl(Y).get(fe.unid);if(!he){console.warn("No contour in datastorage. Event: virtual_line:removed. Options:",se);return}he.properties.virtual_line=void 0,T(fe.unid,he)}}function lg(Y,T,se){return function(fe){const he=fe.target;if(!he){console.error("Empty target contour on mouse:down. Options:",fe);return}if(!(he instanceof fa)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: mouse:down. Options:",fe);return}const Ie=he,N=he.canvas;if(!N){console.error("Empty target canvas on mouse:down. Options:",fe);return}if(fe.e.preventDefault(),fe.e.stopPropagation(),fe.button===3){if(Sl(Y)!=Gi.EditingZone)Y.set(Gi.EditingZone);else{Y.set(Gi.Waiting);let p=Sl(T).get(Ie.unid);if(!p){console.error("No contour in datastorage. Event: mouse:down. Options:",fe);return}if(!Ie.current_points){console.error("No current points in target polygon. Event: mouse:down. Options:",fe);return}p.properties.coordinates=Ie.current_points.map(C=>[Math.floor(C.x/N.scaleWidth),Math.floor(C.y/N.scaleHeight)]),se(Ie.unid,p)}N.editContour(Ie)}}}function cg(Y,T){return function(se){const fe=se.target;if(!fe){console.error("Empty target contour on modified. Options:",se);return}if(!(fe instanceof fa)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: modified. Options:",se);return}const he=fe,Ie=fe.canvas;if(!Ie){console.error("Empty target canvas on modified. Options:",se);return}const N=he.inner.calcTransformMatrix();if(!he.inner.points){console.error("No points in fabric.Polygon. Event: modified. Options:",se);return}const s=he.inner.points.map(function(C){return new wi.fabric.Point(C.x-he.inner.pathOffset.x,C.y-he.inner.pathOffset.y)}).map(function(C){return wi.fabric.util.transformPoint(C,N)});he.current_points=s,he.notation.forEach((C,b)=>{var c;const l=(c=he.current_points)==null?void 0:c[b];if(!l){console.error(`No vertex at pos #${b} in target polygon. Event: modified`,"Options:",se);return}C.set({left:l.x,top:l.y})});let p=Sl(Y).get(he.unid);if(!p){console.error("No contour in datastorage. Event: modified. Options:",se);return}p.properties.coordinates=he.current_points.map(C=>[Math.floor(C.x/Ie.scaleWidth),Math.floor(C.y/Ie.scaleHeight)]),T(he.unid,p)}}const ef=(Y,T,se,fe)=>{Sl(se).forEach(he=>{const Ie=he.properties.coordinates.map(s=>({x:s[0]*Y.scaleWidth,y:s[1]*Y.scaleHeight})),N=bf(Ie,T,se,fe,he.id,`rgb(${he.properties.color_rgb[0]},${he.properties.color_rgb[1]},${he.properties.color_rgb[2]})`,!1);Y.add(N.inner),he.properties.virtual_line&&vf(N,!0,he.properties.virtual_line),N.inner.on("virtial_line:created",au(se,fe)),N.inner.on("virtial_line:modified",wf(se,fe)),N.inner.on("virtial_line:removed",Cf(se,fe)),N.notation.forEach(s=>{Y.add(s)}),Y.renderAll()})},Cl=32,hg="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1.2rem' height='1.2rem' viewBox='0 0 24 24'%3E %3Crect width='100%25' height='100%25' stroke='rgba(0, 0, 0, 1)' stroke-width='2px' fill='rgba(255, 255, 255, 0.3)' %2F%3E %3Cpath fill='red' stroke='%234b4b4b' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 18a2 2 0 1 0 4 0a2 2 0 1 0-4 0M16 6a2 2 0 1 0 4 0a2 2 0 1 0-4 0M7.5 16.5l9-9'/%3E%3C/svg%3E",Sf=document.createElement("img");Sf.src=hg;const ug=(Y,T,se,fe)=>{var d;const he=T.target;if(!he)return console.error("Empty target contour on control click. Transform data:",T),!1;if(!(he instanceof fa))return console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: control click. Transform data:",T),!1;if(he.virtual_line)return console.warn("Target contour already has virtual line. Ignoring. Transform data:",T),!1;const Ie=he.canvas;if(!Ie)return console.error("Empty target canvas on control click. transform Data:",T),!1;const N=(d=he.current_points)==null?void 0:d.slice();if(!N)return console.error("Empty target canvas points on control click. transform Data:",T),!1;if(N.length!==4)return console.error("Target canvas points should have 4 points exactly on control click. transform Data:",T),!1;const s=N[0],p=N[1],C=N[2],b=N[3],l=30,c=Ie.getWidth()-10,h=Ie.getHeight()-10,m=Kd(b,s,l);rh(m,0,0,c,h);const g=Kd(C,p,l);return rh(g,0,0,c,h),vf(he,!1,{geometry:[[m.x,m.y],[g.x,g.y]],color_rgb:ou(he.stroke),direction:$n.LeftRightTopBottom}),!0},dg=(Y,T,se,fe,he)=>{he instanceof fa&&(Y.save(),Y.translate(T,se),he.angle&&Y.rotate(wi.fabric.util.degreesToRadians(he.angle)),Y.drawImage(Sf,-Cl/2,-Cl/2,Cl,Cl),Y.restore())},fg=new wi.fabric.Control({x:.5,y:-.5,offsetY:-16,offsetX:16,cursorStyle:"pointer",mouseUpHandler:ug,render:dg,sizeX:Cl,sizeY:Cl}),bs=32,pg="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1.2rem' height='1.2rem' viewBox='0 0 24 24'%3E%3Crect width='100%25' height='100%25' stroke='rgba(0, 0, 0, 1)' stroke-width='2px' fill='rgba(255, 255, 255, 0.3)'/%3E%3Cpath fill='none' stroke='%23ff0000' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.75' d='M17 20V8m0 12l-3.5-3.5M17 20l3.5-3.5M7 17V4m0 0L3.5 7.5M7 4l3.5 3.5'/%3E%3C/svg%3E",Tf=document.createElement("img");Tf.src=pg;const mg=(Y,T,se,fe)=>{var N;const he=T.target;if(!he)return console.error("Empty target. Event: change_direction_control. Transform data:",T),!1;if(!(he instanceof ho))return console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: change_direction_control. Transform data:",T),!1;if(!he.parentContour)return console.error("Empty parent contour. Event: change_direction_control. Transform data:",T),!1;he.direction=he.direction===$n.LeftRightTopBottom?$n.RightLeftBottomTop:$n.LeftRightTopBottom;const Ie=he.getObjects()[1];return Ie instanceof wi.fabric.IText?(Ie.set("text",$n.toString(he.direction)),he.parentContour.fire("virtial_line:modified",{target:he.parentContour}),(N=he.canvas)==null||N.renderAll(),!0):(console.error("Unhandled object. Should be fabric.IText at position #1 Event: change_direction_control. Transform data:",T),!1)},gg=(Y,T,se,fe,he)=>{he instanceof ho&&(Y.save(),Y.translate(T,se),he.angle&&Y.rotate(wi.fabric.util.degreesToRadians(he.angle)),Y.drawImage(Tf,-bs/2,-bs/2,bs,bs),Y.restore())},_g=new wi.fabric.Control({x:.5,y:-.5,offsetY:-16,offsetX:-16,cursorStyle:"pointer",mouseUpHandler:mg,render:gg,sizeX:bs,sizeY:bs}),yg="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1.2rem' height='1.2rem' viewBox='0 0 24 24'%3E%3Crect width='100%25' height='100%25' stroke='rgba(0, 0, 0, 1)' stroke-width='2px' fill='rgba(255, 255, 255, 0.3)'/%3E%3Cpath fill='%23ff0000' d='M12 2a10 10 0 0 1 10 10a10 10 0 0 1-10 10A10 10 0 0 1 2 12A10 10 0 0 1 12 2m0 2a8 8 0 0 0-8 8a8 8 0 0 0 8 8a8 8 0 0 0 8-8a8 8 0 0 0-8-8m4 6v7a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-7zm-2.5-4l1 1H17v2H7V7h2.5l1-1z'/%3E%3C/svg%3E",Ef=document.createElement("img");Ef.src=yg;const vg=(Y,T,se,fe)=>{var Ie;const he=T.target;return he?he instanceof ho?he.parentContour?((Ie=he.canvas)==null||Ie.remove(he),!0):(console.error("Empty parent contour. Event: delete_virtual_line_control. Transform data:",T),!1):(console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: delete_virtual_line_control. Transform data:",T),!1):(console.error("Empty target. Event: delete_virtual_line_control. Transform data:",T),!1)},xg=(Y,T,se,fe,he)=>{he instanceof ho&&(Y.save(),Y.translate(T,se),he.angle&&Y.rotate(wi.fabric.util.degreesToRadians(he.angle)),Y.drawImage(Ef,-bs/2,-bs/2,bs,bs),Y.restore())},bg=new wi.fabric.Control({x:.5,y:-.5,offsetY:-16,offsetX:16,cursorStyle:"pointer",mouseUpHandler:vg,render:xg,sizeX:bs,sizeY:bs});function wg(Y){let T,se,fe,he,Ie,N,s,p,C,b,l,c,h,m,g;return C=new qm({props:{msgText:"Please wait until image is loaded"}}),{c(){T=At("div"),se=At("img"),he=Ai(),Ie=At("canvas"),N=Ai(),s=At("div"),p=At("div"),Ra(C.$$.fragment),this.h()},l(d){T=Mt(d,"DIV",{id:!0,class:!0});var w=ri(T);se=Mt(w,"IMG",{id:!0,src:!0,width:!0,height:!0,class:!0}),he=Mi(w),Ie=Mt(w,"CANVAS",{id:!0,class:!0}),ri(Ie).forEach(Rt),N=Mi(w),s=Mt(w,"DIV",{id:!0,class:!0});var E=ri(s);p=Mt(E,"DIV",{class:!0});var O=ri(p);Ba(C.$$.fragment,O),O.forEach(Rt),E.forEach(Rt),w.forEach(Rt),this.h()},h(){dt(se,"id","fit_img"),Xd(se.src,fe=Y[1]+"/live_streaming")||dt(se,"src",fe),dt(se,"width","500"),dt(se,"height","500"),dt(se,"class","svelte-ao3ads"),dt(Ie,"id","fit_canvas"),dt(Ie,"class","svelte-ao3ads"),dt(p,"class",b=co(Y[2]?"d-none":"loading d-block")+" svelte-ao3ads"),dt(s,"id","loading-message"),dt(s,"class",l=co(Y[2]?"d-none":"d-block")+" svelte-ao3ads"),dt(T,"id","mjpeg"),dt(T,"class",c=co("mjpeg-canvas "+Y[0])+" svelte-ao3ads")},m(d,w){fn(d,T,w),rt(T,se),rt(T,he),rt(T,Ie),rt(T,N),rt(T,s),rt(s,p),ja(C,p,null),h=!0,m||(g=ls(se,"load",Y[5]),m=!0)},p(d,[w]){(!h||w&2&&!Xd(se.src,fe=d[1]+"/live_streaming"))&&dt(se,"src",fe),(!h||w&4&&b!==(b=co(d[2]?"d-none":"loading d-block")+" svelte-ao3ads"))&&dt(p,"class",b),(!h||w&4&&l!==(l=co(d[2]?"d-none":"d-block")+" svelte-ao3ads"))&&dt(s,"class",l),(!h||w&1&&c!==(c=co("mjpeg-canvas "+d[0])+" svelte-ao3ads"))&&dt(T,"class",c)},i(d){h||(Na(C.$$.fragment,d),h=!0)},o(d){Va(C.$$.fragment,d),h=!1},d(d){d&&Rt(T),Ua(C),m=!1,g()}}}function Cg(Y,T,se){let fe,he,Ie,N,s;jr(Y,iu,w=>se(8,fe=w)),jr(Y,uo,w=>se(9,he=w)),jr(Y,eh,w=>se(10,Ie=w));let{klass:p=""}=T;const{apiURL:C}=th;jr(Y,C,w=>se(11,N=w));let b=`${N}`,l;Xr.subscribe(w=>l=w);let c=Vn(!1);jr(Y,c,w=>se(2,s=w));const h=()=>{if(console.log("Image source reloaded"),Ie==null){console.log("Prepare canvas on first initialization");const w=d();eh.set(w)}c.set(!0),wl.set(!0)},m=su.subscribe(w=>{b!==w&&(console.log(`Need to change API URL for MJPEG: '${N}'`),se(1,b=w),c.set(!1))});uc(()=>{console.log("Mounted canvas component")}),Qh(()=>{wl.set(!1),Ie==null||Ie.getObjects().forEach(w=>{Ie.remove(w)}),m(),eh.set(void 0)});const g=(w,E)=>{w.getObjects().forEach(O=>{O instanceof fa&&O.unid===E&&(O.virtual_line&&w.remove(O.virtual_line),O.notation.forEach(L=>{w.remove(L)}),w.remove(O))}),Nm(he,fe,E),Bm(E)},d=()=>{const w=document.getElementById("fit_canvas"),E=document.getElementById("fit_img");w.width=E.clientWidth,w.height=E.clientHeight;const O=new rg("fit_canvas",{containerClass:"custom-container-canvas",fireRightClick:!0,fireMiddleClick:!0,stopContextMenu:!0});O.scaleWidth=E.clientWidth/E.naturalWidth,O.scaleHeight=E.clientHeight/E.naturalHeight,wi.fabric.Object.prototype.controls[fo.LINE_CONTROL]=fg,wi.fabric.Object.prototype.controls[fo.CHANGE_DIRECTION_CONTROL]=_g,wi.fabric.Object.prototype.controls[fo.DELETE_VIRTUAL_LINE_CONTROL]=bg;const L=document.getElementsByClassName("custom-container-canvas")[0];return L.id="fbcanvas",O.on("selection:created",V=>{l===Gi.DeletingZoneCanvas&&(g(O,V.selected[0].unid),Xr.set(Gi.Waiting))}),O.on("selection:updated",V=>{l===Gi.DeletingZoneCanvas&&(g(O,V.selected[0].unid),Xr.set(Gi.Waiting))}),O.on("mouse:move",V=>{if(O.contourTemporary[0]!==null&&O.contourTemporary[0]!==void 0&&l===Gi.AddingZoneCanvas){const $=Zd(O,V);O.contourTemporary[O.contourTemporary.length-1].set({x2:$.x,y2:$.y}),O.renderAll()}}),O.on("mouse:down",V=>{if(l!==Gi.AddingZoneCanvas)return;O.selection=!1;const $=Zd(O,V);O.contourFinalized.push({x:$.x,y:$.y});const ne=[$.x,$.y,$.x,$.y],xe=new wi.fabric.Line(ne,{strokeWidth:3,selectable:!1,stroke:"purple"}),ze=new wi.fabric.Text(xf[O.contourFinalized.length-1],{left:$.x,top:$.y,fontSize:24,fontFamily:"Roboto",fill:"purple",shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9});if(O.contourNotationTemporary.push(ze),O.contourTemporary.push(xe),O.add(xe),O.add(ze),O.on("mouse:up",function(tt){O.selection=!0}),O.contourFinalized.length<=3)return;O.contourTemporary.forEach(tt=>{O.remove(tt)}),O.contourNotationTemporary.forEach(tt=>{O.remove(tt)});const Ke=bf(O.contourFinalized,Xr,uo,Ga),Je={type:"Feature",id:Ke.unid,properties:{color_rgb:ou(Ke.inner.stroke),color_rgb_str:Ke.inner.stroke?Ke.inner.stroke:"rgb(0, 0, 0)",coordinates:Ke.inner.current_points.map(tt=>[Math.floor(tt.x/O.scaleWidth),Math.floor(tt.y/O.scaleHeight)]),road_lane_direction:-1,road_lane_num:-1,spatial_object_id:void 0},geometry:{type:"Polygon",coordinates:[[[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1]]]}};Ga(Ke.unid,Je),O.add(Ke.inner),Ke.notation.forEach(tt=>{O.add(tt)}),O.renderAll(),O.contourTemporary=[],O.contourNotationTemporary=[],O.contourFinalized=[],Xr.set(Gi.Waiting),fe.changeMode("simple_select")}),O};return Y.$$set=w=>{"klass"in w&&se(0,p=w.klass)},[p,b,s,C,c,h]}class Sg extends ua{constructor(T){super(),da(this,T,Cg,wg,ha,{klass:0})}}function Tg(Y){let T,se,fe,he,Ie,N,s,p,C="Protocol schema type",b,l,c,h,m,g,d="Address or explicit IP",w,E,O,L,V,$,ne="Port",xe,ze,Ke="Switch",Je,tt;return{c(){T=At("div"),se=At("form"),fe=At("div"),he=At("div"),Ie=At("div"),N=At("input"),s=Ai(),p=At("label"),p.textContent=C,b=Ai(),l=At("div"),c=At("div"),h=At("input"),m=Ai(),g=At("label"),g.textContent=d,w=Ai(),E=At("div"),O=At("div"),L=At("input"),V=Ai(),$=At("label"),$.textContent=ne,xe=Ai(),ze=At("button"),ze.textContent=Ke,this.h()},l(ht){T=Mt(ht,"DIV",{class:!0});var nt=ri(T);se=Mt(nt,"FORM",{autocomplete:!0});var _t=ri(se);fe=Mt(_t,"DIV",{class:!0});var Ot=ri(fe);he=Mt(Ot,"DIV",{class:!0});var ot=ri(he);Ie=Mt(ot,"DIV",{class:!0});var wt=ri(Ie);N=Mt(wt,"INPUT",{id:!0,type:!0,class:!0}),s=Mi(wt),p=Mt(wt,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),wr(p)!=="svelte-4i6s19"&&(p.textContent=C),wt.forEach(Rt),ot.forEach(Rt),b=Mi(Ot),l=Mt(Ot,"DIV",{class:!0});var ee=ri(l);c=Mt(ee,"DIV",{class:!0});var be=ri(c);h=Mt(be,"INPUT",{id:!0,type:!0,class:!0}),m=Mi(be),g=Mt(be,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),wr(g)!=="svelte-1tjbdse"&&(g.textContent=d),be.forEach(Rt),ee.forEach(Rt),w=Mi(Ot),E=Mt(Ot,"DIV",{class:!0});var me=ri(E);O=Mt(me,"DIV",{class:!0});var ye=ri(O);L=Mt(ye,"INPUT",{id:!0,type:!0,class:!0}),V=Mi(ye),$=Mt(ye,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),wr($)!=="svelte-1gcg7vj"&&($.textContent=ne),ye.forEach(Rt),me.forEach(Rt),Ot.forEach(Rt),_t.forEach(Rt),xe=Mi(nt),ze=Mt(nt,"BUTTON",{class:!0,type:!0,name:!0,"data-svelte-h":!0}),wr(ze)!=="svelte-14v6gij"&&(ze.textContent=Ke),nt.forEach(Rt),this.h()},h(){dt(N,"id","input_protocol"),dt(N,"type","text"),dt(N,"class","validate"),dt(p,"class","active"),dt(p,"for","input_protocol"),dt(Ie,"class","input-field"),dt(he,"class","addr-part row svelte-142324r"),dt(h,"id","input_protocol"),dt(h,"type","text"),dt(h,"class","validate"),dt(g,"class","active"),dt(g,"for","input_protocol"),dt(c,"class","input-field"),dt(l,"class","addr-part row svelte-142324r"),dt(L,"id","input_protocol"),dt(L,"type","number"),dt(L,"class","validate"),dt($,"class","active"),dt($,"for","input_protocol"),dt(O,"class","input-field"),dt(E,"class","addr-part row svelte-142324r"),dt(fe,"class","addr-form svelte-142324r"),dt(se,"autocomplete","off"),dt(ze,"class","btn waves-effect waves-light btn-small red"),dt(ze,"type","submit"),dt(ze,"name","action"),dt(T,"class","addr-container svelte-142324r")},m(ht,nt){fn(ht,T,nt),rt(T,se),rt(se,fe),rt(fe,he),rt(he,Ie),rt(Ie,N),ca(N,Y[0]),rt(Ie,s),rt(Ie,p),rt(fe,b),rt(fe,l),rt(l,c),rt(c,h),ca(h,Y[1]),rt(c,m),rt(c,g),rt(fe,w),rt(fe,E),rt(E,O),rt(O,L),ca(L,Y[2]),rt(O,V),rt(O,$),rt(T,xe),rt(T,ze),Je||(tt=[ls(N,"input",Y[8]),ls(h,"input",Y[9]),ls(L,"input",Y[10]),ls(ze,"click",Y[7])],Je=!0)},p(ht,[nt]){nt&1&&N.value!==ht[0]&&ca(N,ht[0]),nt&2&&h.value!==ht[1]&&ca(h,ht[1]),nt&4&&af(L.value)!==ht[2]&&ca(L,ht[2])},i:cs,o:cs,d(ht){ht&&Rt(T),Je=!1,eu(tt)}}}function Eg(Y,T,se){let fe,he,Ie,N;const{schema:s,host:p,port:C}=th;jr(Y,s,d=>se(0,he=d)),jr(Y,p,d=>se(1,Ie=d)),jr(Y,C,d=>se(2,N=d));const{apiURL:b}=th;jr(Y,b,d=>se(12,fe=d));let l=fe;const c=()=>{l!==fe&&(su.set(fe),l=fe)};uc(()=>{console.log(`Mount IP form. Initial address: '${fe}'`)});function h(){he=this.value,s.set(he)}function m(){Ie=this.value,p.set(Ie)}function g(){N=af(this.value),C.set(N)}return[he,Ie,N,s,p,C,b,c,h,m,g]}class Pg extends ua{constructor(T){super(),da(this,T,Eg,Tg,ha,{})}}function Ig(Y){let T,se,fe,he,Ie,N,s,p,C="URI for Maptiler styles JSON",b,l,c="Switch",h,m;return{c(){T=At("div"),se=At("form"),fe=At("div"),he=At("div"),Ie=At("div"),N=At("input"),s=Ai(),p=At("label"),p.textContent=C,b=Ai(),l=At("button"),l.textContent=c,this.h()},l(g){T=Mt(g,"DIV",{class:!0});var d=ri(T);se=Mt(d,"FORM",{autocomplete:!0});var w=ri(se);fe=Mt(w,"DIV",{class:!0});var E=ri(fe);he=Mt(E,"DIV",{class:!0});var O=ri(he);Ie=Mt(O,"DIV",{class:!0});var L=ri(Ie);N=Mt(L,"INPUT",{id:!0,type:!0,class:!0}),s=Mi(L),p=Mt(L,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),wr(p)!=="svelte-1xx2eh2"&&(p.textContent=C),L.forEach(Rt),O.forEach(Rt),E.forEach(Rt),w.forEach(Rt),b=Mi(d),l=Mt(d,"BUTTON",{class:!0,type:!0,name:!0,"data-svelte-h":!0}),wr(l)!=="svelte-1zwpv7"&&(l.textContent=c),d.forEach(Rt),this.h()},h(){dt(N,"id","input_protocol"),dt(N,"type","text"),dt(N,"class","validate"),dt(p,"class","active"),dt(p,"for","input_style_url"),dt(Ie,"class","input-field"),dt(he,"class","styles-switch-part row svelte-4gm7qr"),dt(fe,"class","styles-switch-form svelte-4gm7qr"),dt(se,"autocomplete","off"),dt(l,"class","btn waves-effect waves-light btn-small red"),dt(l,"type","submit"),dt(l,"name","action"),dt(T,"class","styles-switch-container svelte-4gm7qr")},m(g,d){fn(g,T,d),rt(T,se),rt(se,fe),rt(fe,he),rt(he,Ie),rt(Ie,N),ca(N,Y[0]),rt(Ie,s),rt(Ie,p),rt(T,b),rt(T,l),h||(m=[ls(N,"input",Y[3]),ls(l,"click",Y[2])],h=!0)},p(g,[d]){d&1&&N.value!==g[0]&&ca(N,g[0])},i:cs,o:cs,d(g){g&&Rt(T),h=!1,eu(m)}}}function Ag(Y,T,se){let fe;const{uri:he}=ih;jr(Y,he,p=>se(0,fe=p));let Ie=fe;const N=()=>{Ie!==fe&&(Ie=fe,ih.accepted_uri.update(()=>Ie))};uc(()=>{console.log(`Mount styles form. Initial styles URL: '${fe}'`)});function s(){fe=this.value,he.set(fe)}return[fe,he,N,s]}class Mg extends ua{constructor(T){super(),da(this,T,Ag,Ig,ha,{})}}function kg(Y){let T,se,fe,he,Ie,N;return se=new Pg({}),he=new Mg({}),{c(){T=At("div"),Ra(se.$$.fragment),fe=Ai(),Ra(he.$$.fragment),this.h()},l(s){T=Mt(s,"DIV",{class:!0});var p=ri(T);Ba(se.$$.fragment,p),fe=Mi(p),Ba(he.$$.fragment,p),p.forEach(Rt),this.h()},h(){dt(T,"class",Ie=co("switcher-container "+Y[0])+" svelte-19pygco")},m(s,p){fn(s,T,p),ja(se,T,null),rt(T,fe),ja(he,T,null),N=!0},p(s,[p]){(!N||p&1&&Ie!==(Ie=co("switcher-container "+s[0])+" svelte-19pygco"))&&dt(T,"class",Ie)},i(s){N||(Na(se.$$.fragment,s),Na(he.$$.fragment,s),N=!0)},o(s){Va(se.$$.fragment,s),Va(he.$$.fragment,s),N=!1},d(s){s&&Rt(T),Ua(se),Ua(he)}}}function Og(Y,T,se){let{klass:fe=""}=T;return Y.$$set=he=>{"klass"in he&&se(0,fe=he.klass)},[fe]}class Dg extends ua{constructor(T){super(),da(this,T,Og,kg,ha,{klass:0})}}function tf(Y,T,se){const fe=Y.slice();return fe[4]=T[se][0],fe[5]=T[se][1],fe}function rf(Y){let T,se=$d(Y[2]),fe=[];for(let he=0;he<se.length;he+=1)fe[he]=nf(tf(Y,se,he));return{c(){for(let he=0;he<fe.length;he+=1)fe[he].c();T=qd()},l(he){for(let Ie=0;Ie<fe.length;Ie+=1)fe[Ie].l(he);T=qd()},m(he,Ie){for(let N=0;N<fe.length;N+=1)fe[N]&&fe[N].m(he,Ie);fn(he,T,Ie)},p(he,Ie){if(Ie&4){se=$d(he[2]);let N;for(N=0;N<se.length;N+=1){const s=tf(he,se,N);fe[N]?fe[N].p(s,Ie):(fe[N]=nf(s),fe[N].c(),fe[N].m(T.parentNode,T))}for(;N<fe.length;N+=1)fe[N].d(1);fe.length=se.length}},d(he){he&&Rt(T),Cm(fe,he)}}}function Lg(Y){let T,se="None";return{c(){T=At("span"),T.textContent=se,this.h()},l(fe){T=Mt(fe,"SPAN",{style:!0,"data-svelte-h":!0}),wr(T)!=="svelte-6frfcq"&&(T.textContent=se),this.h()},h(){za(T,"font-weight","bold")},m(fe,he){fn(fe,T,he)},p:cs,d(fe){fe&&Rt(T)}}}function Fg(Y){let T,se=$n.toHumanString(Y[5].properties.virtual_line.direction)+"",fe;return{c(){T=At("span"),fe=xn(se)},l(he){T=Mt(he,"SPAN",{});var Ie=ri(T);fe=bn(Ie,se),Ie.forEach(Rt)},m(he,Ie){fn(he,T,Ie),rt(T,fe)},p(he,Ie){Ie&4&&se!==(se=$n.toHumanString(he[5].properties.virtual_line.direction)+"")&&Ds(fe,se)},d(he){he&&Rt(T)}}}function zg(Y){let T,se='<td>Virtual line</td> <td><span style="font-weight: bold;">None</span></td>';return{c(){T=At("tr"),T.innerHTML=se},l(fe){T=Mt(fe,"TR",{"data-svelte-h":!0}),wr(T)!=="svelte-1un2uac"&&(T.innerHTML=se)},m(fe,he){fn(fe,T,he)},p:cs,d(fe){fe&&Rt(T)}}}function Rg(Y){let T,se,fe="Virtual line direction",he,Ie,N,s=$n.toHumanString(Y[5].properties.virtual_line.direction)+"",p,C,b,l,c="Virtual line coordinates",h,m,g=JSON.stringify(Y[5].properties.virtual_line.geometry)+"",d;return{c(){T=At("tr"),se=At("td"),se.textContent=fe,he=Ai(),Ie=At("td"),N=At("span"),p=xn(s),C=Ai(),b=At("tr"),l=At("td"),l.textContent=c,h=Ai(),m=At("td"),d=xn(g)},l(w){T=Mt(w,"TR",{});var E=ri(T);se=Mt(E,"TD",{"data-svelte-h":!0}),wr(se)!=="svelte-1p9a9lk"&&(se.textContent=fe),he=Mi(E),Ie=Mt(E,"TD",{});var O=ri(Ie);N=Mt(O,"SPAN",{});var L=ri(N);p=bn(L,s),L.forEach(Rt),O.forEach(Rt),E.forEach(Rt),C=Mi(w),b=Mt(w,"TR",{});var V=ri(b);l=Mt(V,"TD",{"data-svelte-h":!0}),wr(l)!=="svelte-11bq1zi"&&(l.textContent=c),h=Mi(V),m=Mt(V,"TD",{});var $=ri(m);d=bn($,g),$.forEach(Rt),V.forEach(Rt)},m(w,E){fn(w,T,E),rt(T,se),rt(T,he),rt(T,Ie),rt(Ie,N),rt(N,p),fn(w,C,E),fn(w,b,E),rt(b,l),rt(b,h),rt(b,m),rt(m,d)},p(w,E){E&4&&s!==(s=$n.toHumanString(w[5].properties.virtual_line.direction)+"")&&Ds(p,s),E&4&&g!==(g=JSON.stringify(w[5].properties.virtual_line.geometry)+"")&&Ds(d,g)},d(w){w&&(Rt(T),Rt(C),Rt(b))}}}function nf(Y){let T,se,fe,he,Ie,N,s,p,C,b,l,c=Y[5].id+"",h,m,g,d,w,E,O,L="Virtual line:",V,$,ne,xe,ze,Ke="<tr><th>Attirubute</th> <th>Value</th></tr>",Je,tt,ht,nt,_t="Road lane direction",Ot,ot,wt=Y[5].properties.road_lane_direction+"",ee,be,me,ye,Ve="Road lane number",ge,te,Ae=Y[5].properties.road_lane_num+"",Ue,it,Xe,He,vt="Color",Et,$e,Oe,at,ae,Ze,pt="Canvas coordinates",ft,Lt,$t=JSON.stringify(Y[5].properties.coordinates)+"",lt,St,Xt,di,vi="Spatial coordinates",Ci,ct,Ei=JSON.stringify(Y[5].geometry.coordinates)+"",Fi,yr,Zi;function Ct(Oi,$i){return Oi[5].properties.virtual_line?Fg:Lg}let pi=Ct(Y),Qt=pi(Y);function qi(Oi,$i){return Oi[5].properties.virtual_line?Rg:zg}let ar=qi(Y),si=ar(Y);return{c(){T=At("li"),se=At("div"),fe=At("div"),he=Zc("svg"),Ie=Zc("g"),N=Zc("path"),s=Zc("path"),C=Ai(),b=At("span"),l=xn("Zone identifier: "),h=xn(c),m=Ai(),g=At("div"),d=Ai(),w=At("div"),E=At("div"),O=At("span"),O.textContent=L,V=Ai(),Qt.c(),$=Ai(),ne=At("div"),xe=At("table"),ze=At("thead"),ze.innerHTML=Ke,Je=Ai(),tt=At("tbody"),ht=At("tr"),nt=At("td"),nt.textContent=_t,Ot=Ai(),ot=At("td"),ee=xn(wt),be=Ai(),me=At("tr"),ye=At("td"),ye.textContent=Ve,ge=Ai(),te=At("td"),Ue=xn(Ae),it=Ai(),Xe=At("tr"),He=At("td"),He.textContent=vt,Et=Ai(),$e=At("td"),Oe=At("div"),at=Ai(),ae=At("tr"),Ze=At("td"),Ze.textContent=pt,ft=Ai(),Lt=At("td"),lt=xn($t),St=Ai(),Xt=At("tr"),di=At("td"),di.textContent=vi,Ci=Ai(),ct=At("td"),Fi=xn(Ei),yr=Ai(),si.c(),Zi=Ai(),this.h()},l(Oi){T=Mt(Oi,"LI",{class:!0});var $i=ri(T);se=Mt($i,"DIV",{class:!0});var Ki=ri(se);fe=Mt(Ki,"DIV",{class:!0});var le=ri(fe);he=Kc(le,"svg",{xmlns:!0,width:!0,height:!0,viewBox:!0});var H=ri(he);Ie=Kc(H,"g",{fill:!0});var X=ri(Ie);N=Kc(X,"path",{d:!0,opacity:!0}),ri(N).forEach(Rt),s=Kc(X,"path",{d:!0}),ri(s).forEach(Rt),X.forEach(Rt),H.forEach(Rt),C=Mi(le),b=Mt(le,"SPAN",{style:!0});var J=ri(b);l=bn(J,"Zone identifier: "),h=bn(J,c),J.forEach(Rt),le.forEach(Rt),m=Mi(Ki),g=Mt(Ki,"DIV",{class:!0}),ri(g).forEach(Rt),d=Mi(Ki),w=Mt(Ki,"DIV",{class:!0});var de=ri(w);E=Mt(de,"DIV",{});var Te=ri(E);O=Mt(Te,"SPAN",{"data-svelte-h":!0}),wr(O)!=="svelte-epbrqr"&&(O.textContent=L),V=Mi(Te),Qt.l(Te),Te.forEach(Rt),de.forEach(Rt),Ki.forEach(Rt),$=Mi($i),ne=Mt($i,"DIV",{class:!0});var De=ri(ne);xe=Mt(De,"TABLE",{class:!0});var Le=ri(xe);ze=Mt(Le,"THEAD",{"data-svelte-h":!0}),wr(ze)!=="svelte-12gwnin"&&(ze.innerHTML=Ke),Je=Mi(Le),tt=Mt(Le,"TBODY",{});var Ce=ri(tt);ht=Mt(Ce,"TR",{});var Ge=ri(ht);nt=Mt(Ge,"TD",{"data-svelte-h":!0}),wr(nt)!=="svelte-t6zzid"&&(nt.textContent=_t),Ot=Mi(Ge),ot=Mt(Ge,"TD",{});var gt=ri(ot);ee=bn(gt,wt),gt.forEach(Rt),Ge.forEach(Rt),be=Mi(Ce),me=Mt(Ce,"TR",{});var Qe=ri(me);ye=Mt(Qe,"TD",{"data-svelte-h":!0}),wr(ye)!=="svelte-5n5jo3"&&(ye.textContent=Ve),ge=Mi(Qe),te=Mt(Qe,"TD",{});var st=ri(te);Ue=bn(st,Ae),st.forEach(Rt),Qe.forEach(Rt),it=Mi(Ce),Xe=Mt(Ce,"TR",{});var ti=ri(Xe);He=Mt(ti,"TD",{"data-svelte-h":!0}),wr(He)!=="svelte-1ghfwjz"&&(He.textContent=vt),Et=Mi(ti),$e=Mt(ti,"TD",{});var ei=ri($e);Oe=Mt(ei,"DIV",{style:!0}),ri(Oe).forEach(Rt),ei.forEach(Rt),ti.forEach(Rt),at=Mi(Ce),ae=Mt(Ce,"TR",{});var xi=ri(ae);Ze=Mt(xi,"TD",{"data-svelte-h":!0}),wr(Ze)!=="svelte-n6p0xp"&&(Ze.textContent=pt),ft=Mi(xi),Lt=Mt(xi,"TD",{});var mi=ri(Lt);lt=bn(mi,$t),mi.forEach(Rt),xi.forEach(Rt),St=Mi(Ce),Xt=Mt(Ce,"TR",{});var Pi=ri(Xt);di=Mt(Pi,"TD",{"data-svelte-h":!0}),wr(di)!=="svelte-1ypus8v"&&(di.textContent=vi),Ci=Mi(Pi),ct=Mt(Pi,"TD",{});var Li=ri(ct);Fi=bn(Li,Ei),Li.forEach(Rt),Pi.forEach(Rt),yr=Mi(Ce),si.l(Ce),Ce.forEach(Rt),Le.forEach(Rt),De.forEach(Rt),Zi=Mi($i),$i.forEach(Rt),this.h()},h(){dt(N,"d","M137 65a24 24 0 1 1 0-34a24 24 0 0 1 0 34M23 103a24 24 0 1 0 34 0a24 24 0 0 0-34 0m120 88a24 24 0 1 0 34 0a24 24 0 0 0-34 0m82-136a24 24 0 1 0 0 34a24 24 0 0 0 0-34"),dt(N,"opacity","0.2"),dt(s,"d","M230.64 49.36a32 32 0 0 0-45.26 0a32 32 0 0 0-5.16 6.76L152 48.42a32 32 0 0 0-54.63-23.06a32.06 32.06 0 0 0-5.76 37.41L57.67 93.32a32.05 32.05 0 0 0-40.31 4.05a32 32 0 0 0 42.89 47.41l70 51.36a32 32 0 1 0 47.57-14.69l27.39-77.59q1.38.12 2.76.12a32 32 0 0 0 22.63-54.62Zm-122-12.69a16 16 0 1 1 0 22.64a16 16 0 0 1 .04-22.64Zm-80 94.65a16 16 0 0 1 0-22.64a16 16 0 1 1 0 22.64m142.65 88a16 16 0 0 1-22.63-22.63a16 16 0 1 1 22.63 22.63m-8.55-43.18a32 32 0 0 0-23 7.08l-70-51.36a32.17 32.17 0 0 0-1.34-26.65l33.95-30.55a32 32 0 0 0 45.47-10.81L176 71.56a32 32 0 0 0 14.12 27ZM219.3 83.3a16 16 0 1 1-22.6-22.62a16 16 0 0 1 22.63 22.63Z"),dt(Ie,"fill",p=Y[5].properties.color_rgb_str),dt(he,"xmlns","http://www.w3.org/2000/svg"),dt(he,"width","1.6rem"),dt(he,"height","1.6rem"),dt(he,"viewBox","0 0 256 256"),za(b,"padding-left","0.5rem"),dt(fe,"class","collapbisle-header-zone svelte-iuhs3p"),dt(g,"class","collapbisle-header-divider svelte-iuhs3p"),dt(w,"class","collapbisle-header-zone svelte-iuhs3p"),dt(se,"class","collapsible-header collapsible-header-content svelte-iuhs3p"),za(Oe,"background-color",Y[5].properties.color_rgb_str),za(Oe,"width","32px"),za(Oe,"height","16px"),za(Oe,"border","1px solid #000000"),dt(xe,"class","collapsible-table svelte-iuhs3p"),dt(ne,"class","collapsible-body svelte-iuhs3p"),dt(T,"class","svelte-iuhs3p")},m(Oi,$i){fn(Oi,T,$i),rt(T,se),rt(se,fe),rt(fe,he),rt(he,Ie),rt(Ie,N),rt(Ie,s),rt(fe,C),rt(fe,b),rt(b,l),rt(b,h),rt(se,m),rt(se,g),rt(se,d),rt(se,w),rt(w,E),rt(E,O),rt(E,V),Qt.m(E,null),rt(T,$),rt(T,ne),rt(ne,xe),rt(xe,ze),rt(xe,Je),rt(xe,tt),rt(tt,ht),rt(ht,nt),rt(ht,Ot),rt(ht,ot),rt(ot,ee),rt(tt,be),rt(tt,me),rt(me,ye),rt(me,ge),rt(me,te),rt(te,Ue),rt(tt,it),rt(tt,Xe),rt(Xe,He),rt(Xe,Et),rt(Xe,$e),rt($e,Oe),rt(tt,at),rt(tt,ae),rt(ae,Ze),rt(ae,ft),rt(ae,Lt),rt(Lt,lt),rt(tt,St),rt(tt,Xt),rt(Xt,di),rt(Xt,Ci),rt(Xt,ct),rt(ct,Fi),rt(tt,yr),si.m(tt,null),rt(T,Zi)},p(Oi,$i){$i&4&&p!==(p=Oi[5].properties.color_rgb_str)&&dt(Ie,"fill",p),$i&4&&c!==(c=Oi[5].id+"")&&Ds(h,c),pi===(pi=Ct(Oi))&&Qt?Qt.p(Oi,$i):(Qt.d(1),Qt=pi(Oi),Qt&&(Qt.c(),Qt.m(E,null))),$i&4&&wt!==(wt=Oi[5].properties.road_lane_direction+"")&&Ds(ee,wt),$i&4&&Ae!==(Ae=Oi[5].properties.road_lane_num+"")&&Ds(Ue,Ae),$i&4&&za(Oe,"background-color",Oi[5].properties.color_rgb_str),$i&4&&$t!==($t=JSON.stringify(Oi[5].properties.coordinates)+"")&&Ds(lt,$t),$i&4&&Ei!==(Ei=JSON.stringify(Oi[5].geometry.coordinates)+"")&&Ds(Fi,Ei),ar===(ar=qi(Oi))&&si?si.p(Oi,$i):(si.d(1),si=ar(Oi),si&&(si.c(),si.m(tt,null)))},d(Oi){Oi&&Rt(T),Qt.d(),si.d()}}}function Bg(Y){let T,se,fe,he,Ie=Y[3]===!0&&rf(Y);return{c(){T=At("div"),se=At("div"),fe=At("ul"),Ie&&Ie.c(),this.h()},l(N){T=Mt(N,"DIV",{id:!0,class:!0});var s=ri(T);se=Mt(s,"DIV",{id:!0});var p=ri(se);fe=Mt(p,"UL",{id:!0,class:!0});var C=ri(fe);Ie&&Ie.l(C),C.forEach(Rt),p.forEach(Rt),s.forEach(Rt),this.h()},h(){dt(fe,"id","collapsible-data"),dt(fe,"class","collapsible svelte-iuhs3p"),dt(se,"id","configuration-content"),dt(T,"id","configuration"),dt(T,"class",he=co(Y[0])+" svelte-iuhs3p")},m(N,s){fn(N,T,s),rt(T,se),rt(se,fe),Ie&&Ie.m(fe,null)},p(N,[s]){N[3]===!0?Ie?Ie.p(N,s):(Ie=rf(N),Ie.c(),Ie.m(fe,null)):Ie&&(Ie.d(1),Ie=null),s&1&&he!==(he=co(N[0])+" svelte-iuhs3p")&&dt(T,"class",he)},i:cs,o:cs,d(N){N&&Rt(T),Ie&&Ie.d()}}}function jg(Y,T,se){let fe,he=cs,Ie=()=>(he(),he=wm(s,C=>se(3,fe=C)),s);Y.$$.on_destroy.push(()=>he());let{klass:N=""}=T,{dataReady:s}=T;Ie();let{data:p}=T;return Y.$$set=C=>{"klass"in C&&se(0,N=C.klass),"dataReady"in C&&Ie(se(1,s=C.dataReady)),"data"in C&&se(2,p=C.data)},[N,s,p,fe]}class Ng extends ua{constructor(T){super(),da(this,T,jg,Bg,ha,{klass:0,dataReady:1,data:2})}}const Vg=(Y,T)=>{const se={data:T.map(he=>{const Ie=he[1];return{lane_number:Ie.properties.road_lane_num,lane_direction:Ie.properties.road_lane_direction,color_rgb:Ie.properties.color_rgb,pixel_points:Ie.properties.coordinates,spatial_points:[...Ie.geometry.coordinates[0].slice(0,-1)],virtual_line:Ie.properties.virtual_line?{geometry:Ie.properties.virtual_line.geometry,color_rgb:Ie.properties.virtual_line.color_rgb,direction:Ie.properties.virtual_line.direction}:null}})};console.log("Replacing data");const fe=`${Y}/api/mutations/replace_all`;fetch(`${fe}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(se)}).then(he=>he.json()).then(he=>{const Ie=`${Y}/api/mutations/save_toml`;console.log("Replacing configuration with polygons:",he),fetch(`${Ie}`,{method:"GET"}).then(N=>N.json()).then(N=>{console.log("Configuration has been updated. Reply from server:",N)}).catch(N=>{console.log("Error on updating configuration:",N)})}).catch(he=>{console.log("Error on replacing data",he)})};function Ug(Y){let T,se,fe,he,Ie,N,s,p='<i class="material-icons">edit</i>',C,b,l,c,h='<i class="material-icons">add</i>',m,g,d,w='<i class="material-icons">delete</i>',E,O,L,V='<i class="material-icons">add_location</i>',$,ne,xe,ze='<i class="material-icons">location_off</i>',Ke,Je,tt,ht='<i class="material-icons">save</i>',nt,_t,Ot,ot,wt,ee,be,me,ye,Ve,ge,te=(Y[2]!==void 0?Y[2]:Jc)+"",Ae,Ue,it,Xe,He,vt,Et,$e,Oe,at=(Y[2]!==void 0?Y[2]:Jc)+"",ae,Ze,pt,ft,Lt,$t;_t=new Dg({props:{klass:Y[5]||Y[4]?"blurred noselect":""}}),ee=new Sg({props:{klass:!Y[5]&&Y[4]?"blurred noselect":""}}),me=new Ng({props:{dataReady:bl,data:Y[3],klass:!Y[6]||Y[5]||Y[4]?"blurred noselect":""}});let lt={klass:!Y[6]||Y[5]&&!Y[4]?"blurred noselect":""};return vt=new Wm({props:lt}),Y[16](vt),{c(){T=At("sveltekit:head"),se=At("title"),fe=xn(sf),he=Ai(),Ie=At("div"),N=At("div"),s=At("a"),s.innerHTML=p,C=Ai(),b=At("ul"),l=At("li"),c=At("a"),c.innerHTML=h,m=Ai(),g=At("li"),d=At("a"),d.innerHTML=w,E=Ai(),O=At("li"),L=At("a"),L.innerHTML=V,$=Ai(),ne=At("li"),xe=At("a"),xe.innerHTML=ze,Ke=Ai(),Je=At("li"),tt=At("a"),tt.innerHTML=ht,nt=Ai(),Ra(_t.$$.fragment),Ot=Ai(),ot=At("div"),wt=At("div"),Ra(ee.$$.fragment),be=Ai(),Ra(me.$$.fragment),ye=Ai(),Ve=At("div"),ge=xn("Press ESC to cancel '"),Ae=xn(te),Ue=xn("' mode"),Xe=Ai(),He=At("div"),Ra(vt.$$.fragment),Et=Ai(),$e=At("div"),Oe=xn("Press ESC to cancel '"),ae=xn(at),Ze=xn("' mode"),this.h()},l(St){T=Mt(St,"SVELTEKIT:HEAD",{});var Xt=ri(T);se=Mt(Xt,"TITLE",{});var di=ri(se);fe=bn(di,sf),di.forEach(Rt),Xt.forEach(Rt),he=Mi(St),Ie=Mt(St,"DIV",{id:!0});var vi=ri(Ie);N=Mt(vi,"DIV",{class:!0});var Ci=ri(N);s=Mt(Ci,"A",{class:!0,"data-svelte-h":!0}),wr(s)!=="svelte-1f8sujf"&&(s.innerHTML=p),C=Mi(Ci),b=Mt(Ci,"UL",{});var ct=ri(b);l=Mt(ct,"LI",{});var Ei=ri(l);c=Mt(Ei,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),wr(c)!=="svelte-1iozari"&&(c.innerHTML=h),Ei.forEach(Rt),m=Mi(ct),g=Mt(ct,"LI",{});var Fi=ri(g);d=Mt(Fi,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),wr(d)!=="svelte-1wbicqg"&&(d.innerHTML=w),Fi.forEach(Rt),E=Mi(ct),O=Mt(ct,"LI",{});var yr=ri(O);L=Mt(yr,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),wr(L)!=="svelte-1t3kq67"&&(L.innerHTML=V),yr.forEach(Rt),$=Mi(ct),ne=Mt(ct,"LI",{});var Zi=ri(ne);xe=Mt(Zi,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),wr(xe)!=="svelte-1in2wxm"&&(xe.innerHTML=ze),Zi.forEach(Rt),Ke=Mi(ct),Je=Mt(ct,"LI",{});var Ct=ri(Je);tt=Mt(Ct,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),wr(tt)!=="svelte-93o42s"&&(tt.innerHTML=ht),Ct.forEach(Rt),ct.forEach(Rt),Ci.forEach(Rt),nt=Mi(vi),Ba(_t.$$.fragment,vi),Ot=Mi(vi),ot=Mt(vi,"DIV",{id:!0});var pi=ri(ot);wt=Mt(pi,"DIV",{id:!0});var Qt=ri(wt);Ba(ee.$$.fragment,Qt),be=Mi(Qt),Ba(me.$$.fragment,Qt),ye=Mi(Qt),Ve=Mt(Qt,"DIV",{class:!0,style:!0});var qi=ri(Ve);ge=bn(qi,"Press ESC to cancel '"),Ae=bn(qi,te),Ue=bn(qi,"' mode"),qi.forEach(Rt),Qt.forEach(Rt),Xe=Mi(pi),He=Mt(pi,"DIV",{id:!0});var ar=ri(He);Ba(vt.$$.fragment,ar),Et=Mi(ar),$e=Mt(ar,"DIV",{class:!0,style:!0});var si=ri($e);Oe=bn(si,"Press ESC to cancel '"),ae=bn(si,at),Ze=bn(si,"' mode"),si.forEach(Rt),ar.forEach(Rt),pi.forEach(Rt),vi.forEach(Rt),this.h()},h(){dt(s,"class","btn-floating btn-large red"),dt(c,"id","add-btn"),dt(c,"class","btn-floating green"),dt(c,"title","Add zone to the canvas"),dt(c,"aria-label","Add zone to the canvas"),dt(c,"role","button"),dt(c,"tabindex","0"),dt(d,"id","del-btn"),dt(d,"class","btn-floating blue"),dt(d,"title","Delete zone from the canvas"),dt(d,"aria-label","Delete zone from the canvas"),dt(d,"role","button"),dt(d,"tabindex","0"),dt(L,"id","add-btn"),dt(L,"class","btn-floating orange"),dt(L,"title","Add zone to the map"),dt(L,"aria-label","Add zone to the map"),dt(L,"role","button"),dt(L,"tabindex","0"),dt(xe,"id","del-btn"),dt(xe,"class","btn-floating blue"),dt(xe,"title","Delete zone from the map"),dt(xe,"aria-label","Delete zone from the map"),dt(xe,"role","button"),dt(xe,"tabindex","0"),dt(tt,"id","save-btn"),dt(tt,"class","btn-floating grey"),dt(tt,"title","Apply and save changes"),dt(tt,"aria-label","Apply and save changes"),dt(tt,"role","button"),dt(tt,"tabindex","0"),dt(N,"class","fixed-action-btn horizontal click-to-toggle spin-close"),dt(Ve,"class","overlay"),dt(Ve,"style",it=!Y[5]&&Y[4]?"display: block;":"display: none;"),dt(wt,"id","left_workspace"),dt($e,"class","overlay"),dt($e,"style",pt=Y[5]&&!Y[4]?"display: block;":"display: none;"),dt(He,"id","right_workspace"),dt(ot,"id","main_workspace"),dt(Ie,"id","main-app")},m(St,Xt){fn(St,T,Xt),rt(T,se),rt(se,fe),fn(St,he,Xt),fn(St,Ie,Xt),rt(Ie,N),rt(N,s),rt(N,C),rt(N,b),rt(b,l),rt(l,c),rt(b,m),rt(b,g),rt(g,d),rt(b,E),rt(b,O),rt(O,L),rt(b,$),rt(b,ne),rt(ne,xe),rt(b,Ke),rt(b,Je),rt(Je,tt),rt(Ie,nt),ja(_t,Ie,null),rt(Ie,Ot),rt(Ie,ot),rt(ot,wt),ja(ee,wt,null),rt(wt,be),ja(me,wt,null),rt(wt,ye),rt(wt,Ve),rt(Ve,ge),rt(Ve,Ae),rt(Ve,Ue),rt(ot,Xe),rt(ot,He),ja(vt,He,null),rt(He,Et),rt(He,$e),rt($e,Oe),rt($e,ae),rt($e,Ze),ft=!0,Lt||($t=[ls(window,"keydown",Y[8]),ls(c,"click",Y[9]),ls(d,"click",Y[11]),ls(L,"click",Y[10]),ls(xe,"click",Y[12]),ls(tt,"click",Y[15])],Lt=!0)},p(St,[Xt]){const di={};Xt&48&&(di.klass=St[5]||St[4]?"blurred noselect":""),_t.$set(di);const vi={};Xt&48&&(vi.klass=!St[5]&&St[4]?"blurred noselect":""),ee.$set(vi);const Ci={};Xt&8&&(Ci.data=St[3]),Xt&112&&(Ci.klass=!St[6]||St[5]||St[4]?"blurred noselect":""),me.$set(Ci),(!ft||Xt&4)&&te!==(te=(St[2]!==void 0?St[2]:Jc)+"")&&Ds(Ae,te),(!ft||Xt&48&&it!==(it=!St[5]&&St[4]?"display: block;":"display: none;"))&&dt(Ve,"style",it);const ct={};Xt&112&&(ct.klass=!St[6]||St[5]&&!St[4]?"blurred noselect":""),vt.$set(ct),(!ft||Xt&4)&&at!==(at=(St[2]!==void 0?St[2]:Jc)+"")&&Ds(ae,at),(!ft||Xt&48&&pt!==(pt=St[5]&&!St[4]?"display: block;":"display: none;"))&&dt($e,"style",pt)},i(St){ft||(Na(_t.$$.fragment,St),Na(ee.$$.fragment,St),Na(me.$$.fragment,St),Na(vt.$$.fragment,St),ft=!0)},o(St){Va(_t.$$.fragment,St),Va(ee.$$.fragment,St),Va(me.$$.fragment,St),Va(vt.$$.fragment,St),ft=!1},d(St){St&&(Rt(T),Rt(he),Rt(Ie)),Ua(_t),Ua(ee),Ua(me),Y[16](null),Ua(vt),Lt=!1,eu($t)}}}const sf="Rust Road Traffic UI",Jc="Unexpected action";function Gg(Y,T,se){let fe,he,Ie,N,s,p,C,b,l,c,h,m;jr(Y,iu,ot=>se(21,s=ot)),jr(Y,eh,ot=>se(22,p=ot)),jr(Y,uo,ot=>se(13,C=ot)),jr(Y,Jh,ot=>se(23,b=ot)),jr(Y,wl,ot=>se(6,c=ot)),jr(Y,bl,ot=>se(25,h=ot)),jr(Y,Xr,ot=>se(14,m=ot));const{apiURL:g}=th;jr(Y,g,ot=>se(24,l=ot));let d=l,w;Xr.subscribe(ot=>w=ot);let E,O,L;const V=new Map([[Gi.AddingZoneCanvas,"Adding zone to the canvas"],[Gi.DeletingZoneCanvas,"Deleting zone from the canvas"],[Gi.AddingZoneMap,"Adding zone to the map"],[Gi.DeletingZoneMap,"Deleting zone from the map"]]),$=ot=>{O=wl.subscribe(ee=>{ee===!0&&h==!0&&(console.log(`MJPEG is loaded after geo data: ${ot}`),ef(p,Xr,uo,Ga))}),L=bl.subscribe(ee=>{ee===!0&&c==!0&&(console.log(`MJPEG is loaded before geo data: '${ot}'`),ef(p,Xr,uo,Ga))});const wt=`${d}/api/polygons/geojson`;fetch(`${wt}`).then(ee=>ee.json()).then(ee=>{ee.features.forEach(be=>{Rm(be)}),ot===Qc.ReInit?E.drawGeoPolygons(s,C):b.on("load",()=>{E.drawGeoPolygons(s,C)}),bl.set(!0)}).catch(ee=>{console.log(`Error on loading polygons ['${ot}']`,ee)})},ne=su.subscribe(ot=>{d!==ot&&(console.log(`Need to change API URL for Data: '${l}'`),se(0,d=ot),wl.set(!1),bl.set(!1),O(),L(),jm(),p!==void 0&&p!=null&&p.getObjects().forEach(wt=>{p.remove(wt)}),s.deleteAll(),$(Qc.ReInit))});uc(()=>{console.log("Mounted page"),ze(),$(Qc.Init),ff.onClick=(ot,wt)=>{var ee;if(wt.featureTarget&&w===Gi.DeletingZoneMap){const me=wt.featureTarget.properties.id;Xr.set(Gi.Waiting);let ye=(ee=[...C].find(Ve=>Ve[1].properties.spatial_object_id===me))==null?void 0:ee[1];if(!ye){console.warn(`Spatial ID '${me}' not found in datastorage. Just removing from the spatial map...`),s.delete(me),s.changeMode("simple_select");return}gf(C,ye.id),s.delete(me),s.changeMode("simple_select")}},E.attachDraw(s),b.on("draw.create",function(ot){ot.features[0].properties={color_rgb_str:hc},s.add(ot.features[0]),Xr.set(Gi.Waiting)}),b.on("draw.update",function(ot){var ye;const wt=ot.features[0],ee=wt.id;let be=(ye=[...C].find(Ve=>Ve[1].properties.spatial_object_id===ee))==null?void 0:ye[1];if(!be){console.warn(`Spatial ID '${ee}' not found in datastorage. Ignoring...`);return}const me=wt.geometry;be.geometry.coordinates=me.coordinates,Ga(be.id,be)})}),Qh(()=>{console.log("Destroyed"),wl.set(!1),bl.set(!1),O(),L(),ne()});function xe(ot){ot.key==="Escape"&&(Ke(p),s.changeMode("simple_select"),Xr.set(Gi.Waiting))}const ze=()=>{const ot=document.querySelectorAll(".fixed-action-btn");M.FloatingActionButton.init(ot,{direction:"left",hoverEnabled:!1});const wt=document.getElementById("collapsible-data");M.Collapsible.init(wt,{})},Ke=ot=>{ot.contourTemporary.forEach(wt=>{ot.remove(wt)}),ot.contourNotationTemporary.forEach(wt=>{ot.remove(wt)}),ot.contourTemporary=[],ot.contourNotationTemporary=[],ot.contourFinalized=[]},Je=()=>{w!==Gi.AddingZoneCanvas?(Xr.set(Gi.AddingZoneCanvas),s.changeMode("draw_restricted_polygon")):(Xr.set(Gi.Waiting),s.changeMode("simple_select"))},tt=()=>{w!==Gi.AddingZoneMap?(Xr.set(Gi.AddingZoneMap),s.changeMode("draw_restricted_polygon")):(Xr.set(Gi.Waiting),s.changeMode("simple_select"))},ht=()=>{w!==Gi.DeletingZoneCanvas?Xr.set(Gi.DeletingZoneCanvas):Xr.set(Gi.Waiting)},nt=()=>{w!==Gi.DeletingZoneMap?(Xr.set(Gi.DeletingZoneMap),s.changeMode("delete_zone")):(Xr.set(Gi.Waiting),s.changeMode("simple_select"))},_t=()=>Vg(d,Ie);function Ot(ot){of[ot?"unshift":"push"](()=>{E=ot,se(1,E)})}return Y.$$.update=()=>{Y.$$.dirty&16384&&se(5,fe=m===Gi.AddingZoneCanvas||m===Gi.DeletingZoneCanvas),Y.$$.dirty&16384&&se(4,he=m===Gi.AddingZoneMap||m===Gi.DeletingZoneMap),Y.$$.dirty&8192&&se(3,Ie=[...C].filter(ot=>ot[1].id&&ot[1].properties.spatial_object_id)),Y.$$.dirty&16384&&se(2,N=V.get(m))},[d,E,N,Ie,he,fe,c,g,xe,Je,tt,ht,nt,C,m,_t,Ot]}class Zg extends ua{constructor(T){super(),da(this,T,Gg,Ug,ha,{})}}export{Zg as component,Yg as universal};
