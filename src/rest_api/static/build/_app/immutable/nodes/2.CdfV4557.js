var wp=Object.defineProperty;var Cp=(ie,I,xe)=>I in ie?wp(ie,I,{enumerable:!0,configurable:!0,writable:!0,value:xe}):ie[I]=xe;var ra=(ie,I,xe)=>(Cp(ie,typeof I!="symbol"?I+"":I,xe),xe);import{s as Po,n as Us,d as Or,o as Jl,y as Sh,f as gd,z as Sp,A as xh,B as na,r as Th,a as Tp}from"../chunks/scheduler.CaRJYrIE.js";import{S as Ao,i as Mo,e as Wt,c as Ht,d as mi,g as ri,o as yt,j as Vs,k as mt,s as Bi,b as Nn,h as ji,f as Vn,y as Kn,z as tn,A as Ja,B as _d,u as ol,v as ll,w as cl,t as hl,a as ul,x as dl,m as od,C as Ep,p as To,l as Eo}from"../chunks/index.D1vAg01J.js";import{w as Un,d as Ip}from"../chunks/index.DzW_SDg6.js";function ld(ie){return(ie==null?void 0:ie.length)!==void 0?ie:Array.from(ie)}const Pp=!1,Am=Object.freeze(Object.defineProperty({__proto__:null,ssr:Pp},Symbol.toStringTag,{value:"Module"}));var sl=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function yd(ie){return ie&&ie.__esModule&&Object.prototype.hasOwnProperty.call(ie,"default")?ie.default:ie}function Ap(ie){if(ie.__esModule)return ie;var I=ie.default;if(typeof I=="function"){var xe=function Ae(){return this instanceof Ae?Reflect.construct(I,arguments,this.constructor):I.apply(this,arguments)};xe.prototype=I.prototype}else xe={};return Object.defineProperty(xe,"__esModule",{value:!0}),Object.keys(ie).forEach(function(Ae){var Ne=Object.getOwnPropertyDescriptor(ie,Ae);Object.defineProperty(xe,Ae,Ne.get?Ne:{enumerable:!0,get:function(){return ie[Ae]}})}),xe}var vd={exports:{}};/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v4.1.2/LICENSE.txt
 */(function(ie,I){(function(xe,Ae){ie.exports=Ae()})(sl,function(){var xe={},Ae={};function Ne(V,s,m){if(Ae[V]=m,V==="index"){var b="var sharedModule = {}; ("+Ae.shared+")(sharedModule); ("+Ae.worker+")(sharedModule);",x={};return Ae.shared(x),Ae.index(xe,x),typeof window<"u"&&xe.setWorkerUrl(window.URL.createObjectURL(new Blob([b],{type:"text/javascript"}))),xe}}Ne("shared",["exports"],function(V){function s(i,e,r,a){return new(r||(r=Promise))(function(f,v){function w(F){try{k(a.next(F))}catch(B){v(B)}}function E(F){try{k(a.throw(F))}catch(B){v(B)}}function k(F){var B;F.done?f(F.value):(B=F.value,B instanceof r?B:new r(function(j){j(B)})).then(w,E)}k((a=a.apply(i,e||[])).next())})}function m(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}typeof SuppressedError=="function"&&SuppressedError;var b=x;function x(i,e){this.x=i,this.y=e}x.prototype={clone:function(){return new x(this.x,this.y)},add:function(i){return this.clone()._add(i)},sub:function(i){return this.clone()._sub(i)},multByPoint:function(i){return this.clone()._multByPoint(i)},divByPoint:function(i){return this.clone()._divByPoint(i)},mult:function(i){return this.clone()._mult(i)},div:function(i){return this.clone()._div(i)},rotate:function(i){return this.clone()._rotate(i)},rotateAround:function(i,e){return this.clone()._rotateAround(i,e)},matMult:function(i){return this.clone()._matMult(i)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(i){return this.x===i.x&&this.y===i.y},dist:function(i){return Math.sqrt(this.distSqr(i))},distSqr:function(i){var e=i.x-this.x,r=i.y-this.y;return e*e+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(i){return Math.atan2(this.y-i.y,this.x-i.x)},angleWith:function(i){return this.angleWithSep(i.x,i.y)},angleWithSep:function(i,e){return Math.atan2(this.x*e-this.y*i,this.x*i+this.y*e)},_matMult:function(i){var e=i[2]*this.x+i[3]*this.y;return this.x=i[0]*this.x+i[1]*this.y,this.y=e,this},_add:function(i){return this.x+=i.x,this.y+=i.y,this},_sub:function(i){return this.x-=i.x,this.y-=i.y,this},_mult:function(i){return this.x*=i,this.y*=i,this},_div:function(i){return this.x/=i,this.y/=i,this},_multByPoint:function(i){return this.x*=i.x,this.y*=i.y,this},_divByPoint:function(i){return this.x/=i.x,this.y/=i.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var i=this.y;return this.y=this.x,this.x=-i,this},_rotate:function(i){var e=Math.cos(i),r=Math.sin(i),a=r*this.x+e*this.y;return this.x=e*this.x-r*this.y,this.y=a,this},_rotateAround:function(i,e){var r=Math.cos(i),a=Math.sin(i),f=e.y+a*(this.x-e.x)+r*(this.y-e.y);return this.x=e.x+r*(this.x-e.x)-a*(this.y-e.y),this.y=f,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},x.convert=function(i){return i instanceof x?i:Array.isArray(i)?new x(i[0],i[1]):i};var o=m(b),c=h;function h(i,e,r,a){this.cx=3*i,this.bx=3*(r-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(a-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=e,this.p2x=r,this.p2y=a}h.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,e){if(e===void 0&&(e=1e-6),i<0)return 0;if(i>1)return 1;for(var r=i,a=0;a<8;a++){var f=this.sampleCurveX(r)-i;if(Math.abs(f)<e)return r;var v=this.sampleCurveDerivativeX(r);if(Math.abs(v)<1e-6)break;r-=f/v}var w=0,E=1;for(r=i,a=0;a<20&&(f=this.sampleCurveX(r),!(Math.abs(f-i)<e));a++)i>f?w=r:E=r,r=.5*(E-w)+w;return r},solve:function(i,e){return this.sampleCurveY(this.solveCurveX(i,e))}};var p=m(c);let _,u;function C(){return _==null&&(_=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),_}function S(){if(u==null&&(u=!1,C())){const e=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(e){for(let a=0;a<5*5;a++){const f=4*a;e.fillStyle=`rgb(${f},${f+1},${f+2})`,e.fillRect(a%5,Math.floor(a/5),1,1)}const r=e.getImageData(0,0,5,5).data;for(let a=0;a<5*5*4;a++)if(a%4!=3&&r[a]!==a){u=!0;break}}}return u||!1}function D(i,e,r,a){const f=new p(i,e,r,a);return function(v){return f.solve(v)}}const L=D(.25,.1,.25,1);function U(i,e,r){return Math.min(r,Math.max(e,i))}function $(i,e,r){const a=r-e,f=((i-e)%a+a)%a+e;return f===e?r:f}function ne(i,...e){for(const r of e)for(const a in r)i[a]=r[a];return i}let ye=1;function Ve(i,e,r){const a={};for(const f in i)a[f]=e.call(r||this,i[f],f,i);return a}function Ke(i,e,r){const a={};for(const f in i)e.call(r||this,i[f],f,i)&&(a[f]=i[f]);return a}function at(i){return Array.isArray(i)?i.map(at):typeof i=="object"&&i?Ve(i,at):i}const $e={};function ut(i){$e[i]||(typeof console<"u"&&console.warn(i),$e[i]=!0)}function ot(i,e,r){return(r.y-i.y)*(e.x-i.x)>(e.y-i.y)*(r.x-i.x)}function vt(i){let e=0;for(let r,a,f=0,v=i.length,w=v-1;f<v;w=f++)r=i[f],a=i[w],e+=(a.x-r.x)*(r.y+a.y);return e}function St(i){return typeof WorkerGlobalScope<"u"&&i!==void 0&&i instanceof WorkerGlobalScope}let ct=null;function Et(i){return typeof ImageBitmap<"u"&&i instanceof ImageBitmap}const Q="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function de(i,e,r,a,f){return s(this,void 0,void 0,function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const v=new VideoFrame(i,{timestamp:0});try{const w=v==null?void 0:v.format;if(!w||!w.startsWith("BGR")&&!w.startsWith("RGB"))throw new Error(`Unrecognized format ${w}`);const E=w.startsWith("BGR"),k=new Uint8ClampedArray(a*f*4);if(yield v.copyTo(k,function(F,B,j,H,Y){const K=4*Math.max(-B,0),re=(Math.max(0,j)-j)*H*4+K,he=4*H,ve=Math.max(0,B),Be=Math.max(0,j);return{rect:{x:ve,y:Be,width:Math.min(F.width,B+H)-ve,height:Math.min(F.height,j+Y)-Be},layout:[{offset:re,stride:he}]}}(i,e,r,a,f)),E)for(let F=0;F<k.length;F+=4){const B=k[F];k[F]=k[F+2],k[F+2]=B}return k}finally{v.close()}})}let _e,pe;const Re="AbortError";function fe(){return new Error(Re)}const ee={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function Ce(i){return ee.REGISTERED_PROTOCOLS[i.substring(0,i.indexOf("://"))]}const Le="global-dispatcher";class Je extends Error{constructor(e,r,a,f){super(`AJAXError: ${r} (${e}): ${a}`),this.status=e,this.statusText=r,this.url=a,this.body=f}}const Ue=()=>St(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,Ge=function(i,e){if(/:\/\//.test(i.url)&&!/^https?:|^file:/.test(i.url)){const a=Ce(i.url);if(a)return a(i,e);if(St(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"getResource",data:i,targetMapId:Le},e)}if(!(/^file:/.test(r=i.url)||/^file:/.test(Ue())&&!/^\w+:/.test(r))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(a,f){return s(this,void 0,void 0,function*(){const v=new Request(a.url,{method:a.method||"GET",body:a.body,credentials:a.credentials,headers:a.headers,cache:a.cache,referrer:Ue(),signal:f.signal});a.type==="json"&&v.headers.set("Accept","application/json");const w=yield fetch(v);if(!w.ok){const F=yield w.blob();throw new Je(w.status,w.statusText,a.url,F)}let E;E=a.type==="arrayBuffer"||a.type==="image"?w.arrayBuffer():a.type==="json"?w.json():w.text();const k=yield E;if(f.signal.aborted)throw fe();return{data:k,cacheControl:w.headers.get("Cache-Control"),expires:w.headers.get("Expires")}})}(i,e);if(St(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"getResource",data:i,mustQueue:!0,targetMapId:Le},e)}var r;return function(a,f){return new Promise((v,w)=>{const E=new XMLHttpRequest;E.open(a.method||"GET",a.url,!0),a.type!=="arrayBuffer"&&a.type!=="image"||(E.responseType="arraybuffer");for(const k in a.headers)E.setRequestHeader(k,a.headers[k]);a.type==="json"&&(E.responseType="text",E.setRequestHeader("Accept","application/json")),E.withCredentials=a.credentials==="include",E.onerror=()=>{w(new Error(E.statusText))},E.onload=()=>{if(!f.signal.aborted)if((E.status>=200&&E.status<300||E.status===0)&&E.response!==null){let k=E.response;if(a.type==="json")try{k=JSON.parse(E.response)}catch(F){return void w(F)}v({data:k,cacheControl:E.getResponseHeader("Cache-Control"),expires:E.getResponseHeader("Expires")})}else{const k=new Blob([E.response],{type:E.getResponseHeader("Content-Type")});w(new Je(E.status,E.statusText,a.url,k))}},f.signal.addEventListener("abort",()=>{E.abort(),w(fe())}),E.send(a.body)})}(i,e)};function dt(i){if(!i||i.indexOf("://")<=0||i.indexOf("data:image/")===0||i.indexOf("blob:")===0)return!0;const e=new URL(i),r=window.location;return e.protocol===r.protocol&&e.host===r.host}function At(i,e,r){r[i]&&r[i].indexOf(e)!==-1||(r[i]=r[i]||[],r[i].push(e))}function Ye(i,e,r){if(r&&r[i]){const a=r[i].indexOf(e);a!==-1&&r[i].splice(a,1)}}class Oe{constructor(e,r={}){ne(this,r),this.type=e}}class Qe extends Oe{constructor(e,r={}){super("error",ne({error:e},r))}}class Xe{on(e,r){return this._listeners=this._listeners||{},At(e,r,this._listeners),this}off(e,r){return Ye(e,r,this._listeners),Ye(e,r,this._oneTimeListeners),this}once(e,r){return r?(this._oneTimeListeners=this._oneTimeListeners||{},At(e,r,this._oneTimeListeners),this):new Promise(a=>this.once(e,a))}fire(e,r){typeof e=="string"&&(e=new Oe(e,r||{}));const a=e.type;if(this.listens(a)){e.target=this;const f=this._listeners&&this._listeners[a]?this._listeners[a].slice():[];for(const E of f)E.call(this,e);const v=this._oneTimeListeners&&this._oneTimeListeners[a]?this._oneTimeListeners[a].slice():[];for(const E of v)Ye(a,E,this._oneTimeListeners),E.call(this,e);const w=this._eventedParent;w&&(ne(e,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),w.fire(e))}else e instanceof Qe&&console.error(e.error);return this}listens(e){return this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e)}setEventedParent(e,r){return this._eventedParent=e,this._eventedParentData=r,this}}var le={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{},within:{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const it=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function bt(i,e){const r={};for(const a in i)a!=="ref"&&(r[a]=i[a]);return it.forEach(a=>{a in e&&(r[a]=e[a])}),r}function Pt(i,e){if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let r=0;r<i.length;r++)if(!Pt(i[r],e[r]))return!1;return!0}if(typeof i=="object"&&i!==null&&e!==null){if(typeof e!="object"||Object.keys(i).length!==Object.keys(e).length)return!1;for(const r in i)if(!Pt(i[r],e[r]))return!1;return!0}return i===e}function Ot(i,e){i.push(e)}function nt(i,e,r){Ot(r,{command:"addSource",args:[i,e[i]]})}function qt(i,e,r){Ot(e,{command:"removeSource",args:[i]}),r[i]=!0}function Yt(i,e,r,a){qt(i,r,a),nt(i,e,r)}function gi(i,e,r){let a;for(a in i[r])if(Object.prototype.hasOwnProperty.call(i[r],a)&&a!=="data"&&!Pt(i[r][a],e[r][a]))return!1;for(a in e[r])if(Object.prototype.hasOwnProperty.call(e[r],a)&&a!=="data"&&!Pt(i[r][a],e[r][a]))return!1;return!0}function xi(i,e,r,a,f,v){i=i||{},e=e||{};for(const w in i)Object.prototype.hasOwnProperty.call(i,w)&&(Pt(i[w],e[w])||r.push({command:v,args:[a,w,e[w],f]}));for(const w in e)Object.prototype.hasOwnProperty.call(e,w)&&!Object.prototype.hasOwnProperty.call(i,w)&&(Pt(i[w],e[w])||r.push({command:v,args:[a,w,e[w],f]}))}function fi(i){return i.id}function Gi(i,e){return i[e.id]=e,i}class ht{constructor(e,r,a,f){this.message=(e?`${e}: `:"")+a,f&&(this.identifier=f),r!=null&&r.__line__&&(this.line=r.__line__)}}function Hi(i,...e){for(const r of e)for(const a in r)i[a]=r[a];return i}class Zt extends Error{constructor(e,r){super(r),this.message=r,this.key=e}}class bi{constructor(e,r=[]){this.parent=e,this.bindings={};for(const[a,f]of r)this.bindings[a]=f}concat(e){return new bi(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const cr={kind:"null"},xt={kind:"number"},li={kind:"string"},Kt={kind:"boolean"},Tr={kind:"color"},Lr={kind:"object"},ui={kind:"value"},wn={kind:"collator"},$r={kind:"formatted"},se={kind:"padding"},W={kind:"resolvedImage"},X={kind:"variableAnchorOffsetCollection"};function J(i,e){return{kind:"array",itemType:i,N:e}}function ae(i){if(i.kind==="array"){const e=ae(i.itemType);return typeof i.N=="number"?`array<${e}, ${i.N}>`:i.itemType.kind==="value"?"array":`array<${e}>`}return i.kind}const Ie=[cr,xt,li,Kt,Tr,$r,Lr,J(ui),se,W,X];function Pe(i,e){if(e.kind==="error")return null;if(i.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Pe(i.itemType,e.itemType))&&(typeof i.N!="number"||i.N===e.N))return null}else{if(i.kind===e.kind)return null;if(i.kind==="value"){for(const r of Ie)if(!Pe(r,e))return null}}return`Expected ${ae(i)} but found ${ae(e)} instead.`}function De(i,e){return e.some(r=>r.kind===i.kind)}function be(i,e){return e.some(r=>r==="null"?i===null:r==="array"?Array.isArray(i):r==="object"?i&&!Array.isArray(i)&&typeof i=="object":r===typeof i)}function je(i,e){return i.kind==="array"&&e.kind==="array"?i.itemType.kind===e.itemType.kind&&typeof i.N=="number":i.kind===e.kind}const gt=.96422,et=.82521,lt=4/29,Jt=6/29,ci=3*Jt*Jt,si=Jt*Jt*Jt,Mi=Math.PI/180,pi=180/Math.PI;function Xi(i){return(i%=360)<0&&(i+=360),i}function Zi([i,e,r,a]){let f,v;const w=ai((.2225045*(i=xr(i))+.7168786*(e=xr(e))+.0606169*(r=xr(r)))/1);i===e&&e===r?f=v=w:(f=ai((.4360747*i+.3850649*e+.1430804*r)/gt),v=ai((.0139322*i+.0971045*e+.7141733*r)/et));const E=116*w-16;return[E<0?0:E,500*(f-w),200*(w-v),a]}function xr(i){return i<=.04045?i/12.92:Math.pow((i+.055)/1.055,2.4)}function ai(i){return i>si?Math.pow(i,1/3):i/ci+lt}function hr([i,e,r,a]){let f=(i+16)/116,v=isNaN(e)?f:f+e/500,w=isNaN(r)?f:f-r/200;return f=1*nn(f),v=gt*nn(v),w=et*nn(w),[Mr(3.1338561*v-1.6168667*f-.4906146*w),Mr(-.9787684*v+1.9161415*f+.033454*w),Mr(.0719453*v-.2289914*f+1.4052427*w),a]}function Mr(i){return(i=i<=.00304?12.92*i:1.055*Math.pow(i,1/2.4)-.055)<0?0:i>1?1:i}function nn(i){return i>Jt?i*i*i:ci*(i-lt)}function Fr(i){return parseInt(i.padEnd(2,i),16)/255}function Yr(i,e){return Zr(e?i/100:i,0,1)}function Zr(i,e,r){return Math.min(Math.max(e,i),r)}function Do(i){return!i.some(Number.isNaN)}const Ta={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};class Ni{constructor(e,r,a,f=1,v=!0){this.r=e,this.g=r,this.b=a,this.a=f,v||(this.r*=f,this.g*=f,this.b*=f,f||this.overwriteGetter("rgb",[e,r,a,f]))}static parse(e){if(e instanceof Ni)return e;if(typeof e!="string")return;const r=function(a){if((a=a.toLowerCase().trim())==="transparent")return[0,0,0,0];const f=Ta[a];if(f){const[w,E,k]=f;return[w/255,E/255,k/255,1]}if(a.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(a)){const w=a.length<6?1:2;let E=1;return[Fr(a.slice(E,E+=w)),Fr(a.slice(E,E+=w)),Fr(a.slice(E,E+=w)),Fr(a.slice(E,E+w)||"ff")]}if(a.startsWith("rgb")){const w=a.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(w){const[E,k,F,B,j,H,Y,K,re,he,ve,Be]=w,we=[B||" ",Y||" ",he].join("");if(we==="  "||we==="  /"||we===",,"||we===",,,"){const Me=[F,H,re].join(""),st=Me==="%%%"?100:Me===""?255:0;if(st){const pt=[Zr(+k/st,0,1),Zr(+j/st,0,1),Zr(+K/st,0,1),ve?Yr(+ve,Be):1];if(Do(pt))return pt}}return}}const v=a.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(v){const[w,E,k,F,B,j,H,Y,K]=v,re=[k||" ",B||" ",H].join("");if(re==="  "||re==="  /"||re===",,"||re===",,,"){const he=[+E,Zr(+F,0,100),Zr(+j,0,100),Y?Yr(+Y,K):1];if(Do(he))return function([ve,Be,we,Me]){function st(pt){const Gt=(pt+ve/30)%12,ei=Be*Math.min(we,1-we);return we-ei*Math.max(-1,Math.min(Gt-3,9-Gt,1))}return ve=Xi(ve),Be/=100,we/=100,[st(0),st(8),st(4),Me]}(he)}}}(e);return r?new Ni(...r,!1):void 0}get rgb(){const{r:e,g:r,b:a,a:f}=this,v=f||1/0;return this.overwriteGetter("rgb",[e/v,r/v,a/v,f])}get hcl(){return this.overwriteGetter("hcl",function(e){const[r,a,f,v]=Zi(e),w=Math.sqrt(a*a+f*f);return[Math.round(1e4*w)?Xi(Math.atan2(f,a)*pi):NaN,w,r,v]}(this.rgb))}get lab(){return this.overwriteGetter("lab",Zi(this.rgb))}overwriteGetter(e,r){return Object.defineProperty(this,e,{value:r}),r}toString(){const[e,r,a,f]=this.rgb;return`rgba(${[e,r,a].map(v=>Math.round(255*v)).join(",")},${f})`}}Ni.black=new Ni(0,0,0,1),Ni.white=new Ni(1,1,1,1),Ni.transparent=new Ni(0,0,0,0),Ni.red=new Ni(1,0,0,1);class sa{constructor(e,r,a){this.sensitivity=e?r?"variant":"case":r?"accent":"base",this.locale=a,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,r){return this.collator.compare(e,r)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class br{constructor(e,r,a,f,v){this.text=e,this.image=r,this.scale=a,this.fontStack=f,this.textColor=v}}class sn{constructor(e){this.sections=e}static fromString(e){return new sn([new br(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||e.image&&e.image.name.length!==0)}static factory(e){return e instanceof sn?e:sn.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}}class an{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof an)return e;if(typeof e=="number")return new an([e,e,e,e]);if(Array.isArray(e)&&!(e.length<1||e.length>4)){for(const r of e)if(typeof r!="number")return;switch(e.length){case 1:e=[e[0],e[0],e[0],e[0]];break;case 2:e=[e[0],e[1],e[0],e[1]];break;case 3:e=[e[0],e[1],e[2],e[1]]}return new an(e)}}toString(){return JSON.stringify(this.values)}}const Jn=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class tr{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof tr)return e;if(Array.isArray(e)&&!(e.length<1)&&e.length%2==0){for(let r=0;r<e.length;r+=2){const a=e[r],f=e[r+1];if(typeof a!="string"||!Jn.has(a)||!Array.isArray(f)||f.length!==2||typeof f[0]!="number"||typeof f[1]!="number")return}return new tr(e)}}toString(){return JSON.stringify(this.values)}}class Kr{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new Kr({name:e,available:!1}):null}}function us(i,e,r,a){return typeof i=="number"&&i>=0&&i<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof r=="number"&&r>=0&&r<=255?a===void 0||typeof a=="number"&&a>=0&&a<=1?null:`Invalid rgba value [${[i,e,r,a].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof a=="number"?[i,e,r,a]:[i,e,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function on(i){if(i===null||typeof i=="string"||typeof i=="boolean"||typeof i=="number"||i instanceof Ni||i instanceof sa||i instanceof sn||i instanceof an||i instanceof tr||i instanceof Kr)return!0;if(Array.isArray(i)){for(const e of i)if(!on(e))return!1;return!0}if(typeof i=="object"){for(const e in i)if(!on(i[e]))return!1;return!0}return!1}function wr(i){if(i===null)return cr;if(typeof i=="string")return li;if(typeof i=="boolean")return Kt;if(typeof i=="number")return xt;if(i instanceof Ni)return Tr;if(i instanceof sa)return wn;if(i instanceof sn)return $r;if(i instanceof an)return se;if(i instanceof tr)return X;if(i instanceof Kr)return W;if(Array.isArray(i)){const e=i.length;let r;for(const a of i){const f=wr(a);if(r){if(r===f)continue;r=ui;break}r=f}return J(r||ui,e)}return Lr}function aa(i){const e=typeof i;return i===null?"":e==="string"||e==="number"||e==="boolean"?String(i):i instanceof Ni||i instanceof sn||i instanceof an||i instanceof tr||i instanceof Kr?i.toString():JSON.stringify(i)}class Cs{constructor(e,r){this.type=e,this.value=r}static parse(e,r){if(e.length!==2)return r.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!on(e[1]))return r.error("invalid value");const a=e[1];let f=wr(a);const v=r.expectedType;return f.kind!=="array"||f.N!==0||!v||v.kind!=="array"||typeof v.N=="number"&&v.N!==0||(f=v),new Cs(f,a)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}class gr{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const ds={string:li,number:xt,boolean:Kt,object:Lr};class fn{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");let a,f=1;const v=e[0];if(v==="array"){let E,k;if(e.length>2){const F=e[1];if(typeof F!="string"||!(F in ds)||F==="object")return r.error('The item type argument of "array" must be one of string, number, boolean',1);E=ds[F],f++}else E=ui;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return r.error('The length argument to "array" must be a positive integer literal',2);k=e[2],f++}a=J(E,k)}else{if(!ds[v])throw new Error(`Types doesn't contain name = ${v}`);a=ds[v]}const w=[];for(;f<e.length;f++){const E=r.parse(e[f],f,ui);if(!E)return null;w.push(E)}return new fn(a,w)}evaluate(e){for(let r=0;r<this.args.length;r++){const a=this.args[r].evaluate(e);if(!Pe(this.type,wr(a)))return a;if(r===this.args.length-1)throw new gr(`Expected value to be of type ${ae(this.type)}, but found ${ae(wr(a))} instead.`)}throw new Error}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}const oa={"to-boolean":Kt,"to-color":Tr,"to-number":xt,"to-string":li};class On{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const a=e[0];if(!oa[a])throw new Error(`Can't parse ${a} as it is not part of the known types`);if((a==="to-boolean"||a==="to-string")&&e.length!==2)return r.error("Expected one argument.");const f=oa[a],v=[];for(let w=1;w<e.length;w++){const E=r.parse(e[w],w,ui);if(!E)return null;v.push(E)}return new On(f,v)}evaluate(e){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(e);case"color":{let r,a;for(const f of this.args){if(r=f.evaluate(e),a=null,r instanceof Ni)return r;if(typeof r=="string"){const v=e.parseColor(r);if(v)return v}else if(Array.isArray(r)&&(a=r.length<3||r.length>4?`Invalid rbga value ${JSON.stringify(r)}: expected an array containing either three or four numeric values.`:us(r[0],r[1],r[2],r[3]),!a))return new Ni(r[0]/255,r[1]/255,r[2]/255,r[3])}throw new gr(a||`Could not parse color from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"padding":{let r;for(const a of this.args){r=a.evaluate(e);const f=an.parse(r);if(f)return f}throw new gr(`Could not parse padding from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"variableAnchorOffsetCollection":{let r;for(const a of this.args){r=a.evaluate(e);const f=tr.parse(r);if(f)return f}throw new gr(`Could not parse variableAnchorOffsetCollection from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"number":{let r=null;for(const a of this.args){if(r=a.evaluate(e),r===null)return 0;const f=Number(r);if(!isNaN(f))return f}throw new gr(`Could not convert ${JSON.stringify(r)} to number.`)}case"formatted":return sn.fromString(aa(this.args[0].evaluate(e)));case"resolvedImage":return Kr.fromString(aa(this.args[0].evaluate(e)));default:return aa(this.args[0].evaluate(e))}}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}const Qa=["Unknown","Point","LineString","Polygon"];class Gs{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Qa[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(e){let r=this._parseColorCache[e];return r||(r=this._parseColorCache[e]=Ni.parse(e)),r}}class Vi{constructor(e,r,a=[],f,v=new bi,w=[]){this.registry=e,this.path=a,this.key=a.map(E=>`[${E}]`).join(""),this.scope=v,this.errors=w,this.expectedType=f,this._isConstant=r}parse(e,r,a,f,v={}){return r?this.concat(r,a,f)._parse(e,v):this._parse(e,v)}_parse(e,r){function a(f,v,w){return w==="assert"?new fn(v,[f]):w==="coerce"?new On(v,[f]):f}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const f=e[0];if(typeof f!="string")return this.error(`Expression name must be a string, but found ${typeof f} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const v=this.registry[f];if(v){let w=v.parse(e,this);if(!w)return null;if(this.expectedType){const E=this.expectedType,k=w.type;if(E.kind!=="string"&&E.kind!=="number"&&E.kind!=="boolean"&&E.kind!=="object"&&E.kind!=="array"||k.kind!=="value")if(E.kind!=="color"&&E.kind!=="formatted"&&E.kind!=="resolvedImage"||k.kind!=="value"&&k.kind!=="string")if(E.kind!=="padding"||k.kind!=="value"&&k.kind!=="number"&&k.kind!=="array")if(E.kind!=="variableAnchorOffsetCollection"||k.kind!=="value"&&k.kind!=="array"){if(this.checkSubtype(E,k))return null}else w=a(w,E,r.typeAnnotation||"coerce");else w=a(w,E,r.typeAnnotation||"coerce");else w=a(w,E,r.typeAnnotation||"coerce");else w=a(w,E,r.typeAnnotation||"assert")}if(!(w instanceof Cs)&&w.type.kind!=="resolvedImage"&&this._isConstant(w)){const E=new Gs;try{w=new Cs(w.type,w.evaluate(E))}catch(k){return this.error(k.message),null}}return w}return this.error(`Unknown expression "${f}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,r,a){const f=typeof e=="number"?this.path.concat(e):this.path,v=a?this.scope.concat(a):this.scope;return new Vi(this.registry,this._isConstant,f,r||null,v,this.errors)}error(e,...r){const a=`${this.key}${r.map(f=>`[${f}]`).join("")}`;this.errors.push(new Zt(a,e))}checkSubtype(e,r){const a=Pe(e,r);return a&&this.error(a),a}}class Ss{constructor(e,r,a){this.type=wn,this.locale=a,this.caseSensitive=e,this.diacriticSensitive=r}static parse(e,r){if(e.length!==2)return r.error("Expected one argument.");const a=e[1];if(typeof a!="object"||Array.isArray(a))return r.error("Collator options argument must be an object.");const f=r.parse(a["case-sensitive"]!==void 0&&a["case-sensitive"],1,Kt);if(!f)return null;const v=r.parse(a["diacritic-sensitive"]!==void 0&&a["diacritic-sensitive"],1,Kt);if(!v)return null;let w=null;return a.locale&&(w=r.parse(a.locale,1,li),!w)?null:new Ss(f,v,w)}evaluate(e){return new sa(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}}const T=8192;function z(i,e){i[0]=Math.min(i[0],e[0]),i[1]=Math.min(i[1],e[1]),i[2]=Math.max(i[2],e[0]),i[3]=Math.max(i[3],e[1])}function q(i,e){return!(i[0]<=e[0]||i[2]>=e[2]||i[1]<=e[1]||i[3]>=e[3])}function me(i,e){const r=(180+i[0])/360,a=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i[1]*Math.PI/360)))/360,f=Math.pow(2,e.z);return[Math.round(r*f*T),Math.round(a*f*T)]}function Te(i,e,r){const a=i[0]-e[0],f=i[1]-e[1],v=i[0]-r[0],w=i[1]-r[1];return a*w-v*f==0&&a*v<=0&&f*w<=0}function Ee(i,e){let r=!1;for(let w=0,E=e.length;w<E;w++){const k=e[w];for(let F=0,B=k.length;F<B-1;F++){if(Te(i,k[F],k[F+1]))return!1;(f=k[F])[1]>(a=i)[1]!=(v=k[F+1])[1]>a[1]&&a[0]<(v[0]-f[0])*(a[1]-f[1])/(v[1]-f[1])+f[0]&&(r=!r)}}var a,f,v;return r}function Fe(i,e){for(let r=0;r<e.length;r++)if(Ee(i,e[r]))return!0;return!1}function Tt(i,e,r,a){const f=a[0]-r[0],v=a[1]-r[1],w=(i[0]-r[0])*v-f*(i[1]-r[1]),E=(e[0]-r[0])*v-f*(e[1]-r[1]);return w>0&&E<0||w<0&&E>0}function Mt(i,e,r){for(const F of r)for(let B=0;B<F.length-1;++B)if((E=[(w=F[B+1])[0]-(v=F[B])[0],w[1]-v[1]])[0]*(k=[(f=e)[0]-(a=i)[0],f[1]-a[1]])[1]-E[1]*k[0]!=0&&Tt(a,f,v,w)&&Tt(v,w,a,f))return!0;var a,f,v,w,E,k;return!1}function jt(i,e){for(let r=0;r<i.length;++r)if(!Ee(i[r],e))return!1;for(let r=0;r<i.length-1;++r)if(Mt(i[r],i[r+1],e))return!1;return!0}function Ut(i,e){for(let r=0;r<e.length;r++)if(jt(i,e[r]))return!0;return!1}function Dt(i,e,r){const a=[];for(let f=0;f<i.length;f++){const v=[];for(let w=0;w<i[f].length;w++){const E=me(i[f][w],r);z(e,E),v.push(E)}a.push(v)}return a}function yi(i,e,r){const a=[];for(let f=0;f<i.length;f++){const v=Dt(i[f],e,r);a.push(v)}return a}function nr(i,e,r,a){if(i[0]<r[0]||i[0]>r[2]){const f=.5*a;let v=i[0]-r[0]>f?-a:r[0]-i[0]>f?a:0;v===0&&(v=i[0]-r[2]>f?-a:r[2]-i[0]>f?a:0),i[0]+=v}z(e,i)}function wi(i,e,r,a){const f=Math.pow(2,a.z)*T,v=[a.x*T,a.y*T],w=[];for(const E of i)for(const k of E){const F=[k.x+v[0],k.y+v[1]];nr(F,e,r,f),w.push(F)}return w}function ur(i,e,r,a){const f=Math.pow(2,a.z)*T,v=[a.x*T,a.y*T],w=[];for(const k of i){const F=[];for(const B of k){const j=[B.x+v[0],B.y+v[1]];z(e,j),F.push(j)}w.push(F)}if(e[2]-e[0]<=f/2){(E=e)[0]=E[1]=1/0,E[2]=E[3]=-1/0;for(const k of w)for(const F of k)nr(F,e,r,f)}var E;return w}class ft{constructor(e,r){this.type=Kt,this.geojson=e,this.geometries=r}static parse(e,r){if(e.length!==2)return r.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(on(e[1])){const a=e[1];if(a.type==="FeatureCollection"){const f=[];for(const v of a.features){const{type:w,coordinates:E}=v.geometry;w==="Polygon"&&f.push(E),w==="MultiPolygon"&&f.push(...E)}if(f.length)return new ft(a,{type:"MultiPolygon",coordinates:f})}else if(a.type==="Feature"){const f=a.geometry.type;if(f==="Polygon"||f==="MultiPolygon")return new ft(a,a.geometry)}else if(a.type==="Polygon"||a.type==="MultiPolygon")return new ft(a,a)}return r.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(r,a){const f=[1/0,1/0,-1/0,-1/0],v=[1/0,1/0,-1/0,-1/0],w=r.canonicalID();if(a.type==="Polygon"){const E=Dt(a.coordinates,v,w),k=wi(r.geometry(),f,v,w);if(!q(f,v))return!1;for(const F of k)if(!Ee(F,E))return!1}if(a.type==="MultiPolygon"){const E=yi(a.coordinates,v,w),k=wi(r.geometry(),f,v,w);if(!q(f,v))return!1;for(const F of k)if(!Fe(F,E))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(r,a){const f=[1/0,1/0,-1/0,-1/0],v=[1/0,1/0,-1/0,-1/0],w=r.canonicalID();if(a.type==="Polygon"){const E=Dt(a.coordinates,v,w),k=ur(r.geometry(),f,v,w);if(!q(f,v))return!1;for(const F of k)if(!jt(F,E))return!1}if(a.type==="MultiPolygon"){const E=yi(a.coordinates,v,w),k=ur(r.geometry(),f,v,w);if(!q(f,v))return!1;for(const F of k)if(!Ut(F,E))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}class Qt{constructor(e,r){this.type=r.type,this.name=e,this.boundExpression=r}static parse(e,r){if(e.length!==2||typeof e[1]!="string")return r.error("'var' expression requires exactly one string literal argument.");const a=e[1];return r.scope.has(a)?new Qt(a,r.scope.get(a)):r.error(`Unknown variable "${a}". Make sure "${a}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}}class Ei{constructor(e,r,a,f){this.name=e,this.type=r,this._evaluate=a,this.args=f}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}static parse(e,r){const a=e[0],f=Ei.definitions[a];if(!f)return r.error(`Unknown expression "${a}". If you wanted a literal array, use ["literal", [...]].`,0);const v=Array.isArray(f)?f[0]:f.type,w=Array.isArray(f)?[[f[1],f[2]]]:f.overloads,E=w.filter(([F])=>!Array.isArray(F)||F.length===e.length-1);let k=null;for(const[F,B]of E){k=new Vi(r.registry,_r,r.path,null,r.scope);const j=[];let H=!1;for(let Y=1;Y<e.length;Y++){const K=e[Y],re=Array.isArray(F)?F[Y-1]:F.type,he=k.parse(K,1+j.length,re);if(!he){H=!0;break}j.push(he)}if(!H)if(Array.isArray(F)&&F.length!==j.length)k.error(`Expected ${F.length} arguments, but found ${j.length} instead.`);else{for(let Y=0;Y<j.length;Y++){const K=Array.isArray(F)?F[Y]:F.type,re=j[Y];k.concat(Y+1).checkSubtype(K,re.type)}if(k.errors.length===0)return new Ei(a,v,B,j)}}if(E.length===1)r.errors.push(...k.errors);else{const F=(E.length?E:w).map(([j])=>{return H=j,Array.isArray(H)?`(${H.map(ae).join(", ")})`:`(${ae(H.type)}...)`;var H}).join(" | "),B=[];for(let j=1;j<e.length;j++){const H=r.parse(e[j],1+B.length);if(!H)return null;B.push(ae(H.type))}r.error(`Expected arguments of type ${F}, but found (${B.join(", ")}) instead.`)}return null}static register(e,r){Ei.definitions=r;for(const a in r)e[a]=Ei}}function _r(i){if(i instanceof Qt)return _r(i.boundExpression);if(i instanceof Ei&&i.name==="error"||i instanceof Ss||i instanceof ft)return!1;const e=i instanceof On||i instanceof fn;let r=!0;return i.eachChild(a=>{r=e?r&&_r(a):r&&a instanceof Cs}),!!r&&sr(i)&&Ea(i,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function sr(i){if(i instanceof Ei&&(i.name==="get"&&i.args.length===1||i.name==="feature-state"||i.name==="has"&&i.args.length===1||i.name==="properties"||i.name==="geometry-type"||i.name==="id"||/^filter-/.test(i.name))||i instanceof ft)return!1;let e=!0;return i.eachChild(r=>{e&&!sr(r)&&(e=!1)}),e}function Ts(i){if(i instanceof Ei&&i.name==="feature-state")return!1;let e=!0;return i.eachChild(r=>{e&&!Ts(r)&&(e=!1)}),e}function Ea(i,e){if(i instanceof Ei&&e.indexOf(i.name)>=0)return!1;let r=!0;return i.eachChild(a=>{r&&!Ea(a,e)&&(r=!1)}),r}function qi(i,e){const r=i.length-1;let a,f,v=0,w=r,E=0;for(;v<=w;)if(E=Math.floor((v+w)/2),a=i[E],f=i[E+1],a<=e){if(E===r||e<f)return E;v=E+1}else{if(!(a>e))throw new gr("Input is not a number.");w=E-1}return 0}class Es{constructor(e,r,a){this.type=e,this.input=r,this.labels=[],this.outputs=[];for(const[f,v]of a)this.labels.push(f),this.outputs.push(v)}static parse(e,r){if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");const a=r.parse(e[1],1,xt);if(!a)return null;const f=[];let v=null;r.expectedType&&r.expectedType.kind!=="value"&&(v=r.expectedType);for(let w=1;w<e.length;w+=2){const E=w===1?-1/0:e[w],k=e[w+1],F=w,B=w+1;if(typeof E!="number")return r.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',F);if(f.length&&f[f.length-1][0]>=E)return r.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',F);const j=r.parse(k,B,v);if(!j)return null;v=v||j.type,f.push([E,j])}return new Es(v,a,f)}evaluate(e){const r=this.labels,a=this.outputs;if(r.length===1)return a[0].evaluate(e);const f=this.input.evaluate(e);if(f<=r[0])return a[0].evaluate(e);const v=r.length;return f>=r[v-1]?a[v-1].evaluate(e):a[qi(r,f)].evaluate(e)}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}}function fl(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var Qn=eo;function eo(i,e,r,a){this.cx=3*i,this.bx=3*(r-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(a-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=e,this.p2x=r,this.p2y=a}eo.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,e){if(e===void 0&&(e=1e-6),i<0)return 0;if(i>1)return 1;for(var r=i,a=0;a<8;a++){var f=this.sampleCurveX(r)-i;if(Math.abs(f)<e)return r;var v=this.sampleCurveDerivativeX(r);if(Math.abs(v)<1e-6)break;r-=f/v}var w=0,E=1;for(r=i,a=0;a<20&&(f=this.sampleCurveX(r),!(Math.abs(f-i)<e));a++)i>f?w=r:E=r,r=.5*(E-w)+w;return r},solve:function(i,e){return this.sampleCurveY(this.solveCurveX(i,e))}};var Oo=fl(Qn);function fs(i,e,r){return i+r*(e-i)}function Ws(i,e,r){return i.map((a,f)=>fs(a,e[f],r))}const ln={number:fs,color:function(i,e,r,a="rgb"){switch(a){case"rgb":{const[f,v,w,E]=Ws(i.rgb,e.rgb,r);return new Ni(f,v,w,E,!1)}case"hcl":{const[f,v,w,E]=i.hcl,[k,F,B,j]=e.hcl;let H,Y;if(isNaN(f)||isNaN(k))isNaN(f)?isNaN(k)?H=NaN:(H=k,w!==1&&w!==0||(Y=F)):(H=f,B!==1&&B!==0||(Y=v));else{let Be=k-f;k>f&&Be>180?Be-=360:k<f&&f-k>180&&(Be+=360),H=f+r*Be}const[K,re,he,ve]=function([Be,we,Me,st]){return Be=isNaN(Be)?0:Be*Mi,hr([Me,Math.cos(Be)*we,Math.sin(Be)*we,st])}([H,Y??fs(v,F,r),fs(w,B,r),fs(E,j,r)]);return new Ni(K,re,he,ve,!1)}case"lab":{const[f,v,w,E]=hr(Ws(i.lab,e.lab,r));return new Ni(f,v,w,E,!1)}}},array:Ws,padding:function(i,e,r){return new an(Ws(i.values,e.values,r))},variableAnchorOffsetCollection:function(i,e,r){const a=i.values,f=e.values;if(a.length!==f.length)throw new gr(`Cannot interpolate values of different length. from: ${i.toString()}, to: ${e.toString()}`);const v=[];for(let w=0;w<a.length;w+=2){if(a[w]!==f[w])throw new gr(`Cannot interpolate values containing mismatched anchors. from[${w}]: ${a[w]}, to[${w}]: ${f[w]}`);v.push(a[w]);const[E,k]=a[w+1],[F,B]=f[w+1];v.push([fs(E,F,r),fs(k,B,r)])}return new tr(v)}};class Wr{constructor(e,r,a,f,v){this.type=e,this.operator=r,this.interpolation=a,this.input=f,this.labels=[],this.outputs=[];for(const[w,E]of v)this.labels.push(w),this.outputs.push(E)}static interpolationFactor(e,r,a,f){let v=0;if(e.name==="exponential")v=Hs(r,e.base,a,f);else if(e.name==="linear")v=Hs(r,1,a,f);else if(e.name==="cubic-bezier"){const w=e.controlPoints;v=new Oo(w[0],w[1],w[2],w[3]).solve(Hs(r,1,a,f))}return v}static parse(e,r){let[a,f,v,...w]=e;if(!Array.isArray(f)||f.length===0)return r.error("Expected an interpolation type expression.",1);if(f[0]==="linear")f={name:"linear"};else if(f[0]==="exponential"){const F=f[1];if(typeof F!="number")return r.error("Exponential interpolation requires a numeric base.",1,1);f={name:"exponential",base:F}}else{if(f[0]!=="cubic-bezier")return r.error(`Unknown interpolation type ${String(f[0])}`,1,0);{const F=f.slice(1);if(F.length!==4||F.some(B=>typeof B!="number"||B<0||B>1))return r.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);f={name:"cubic-bezier",controlPoints:F}}}if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");if(v=r.parse(v,2,xt),!v)return null;const E=[];let k=null;a==="interpolate-hcl"||a==="interpolate-lab"?k=Tr:r.expectedType&&r.expectedType.kind!=="value"&&(k=r.expectedType);for(let F=0;F<w.length;F+=2){const B=w[F],j=w[F+1],H=F+3,Y=F+4;if(typeof B!="number")return r.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',H);if(E.length&&E[E.length-1][0]>=B)return r.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',H);const K=r.parse(j,Y,k);if(!K)return null;k=k||K.type,E.push([B,K])}return je(k,xt)||je(k,Tr)||je(k,se)||je(k,X)||je(k,J(xt))?new Wr(k,a,f,v,E):r.error(`Type ${ae(k)} is not interpolatable.`)}evaluate(e){const r=this.labels,a=this.outputs;if(r.length===1)return a[0].evaluate(e);const f=this.input.evaluate(e);if(f<=r[0])return a[0].evaluate(e);const v=r.length;if(f>=r[v-1])return a[v-1].evaluate(e);const w=qi(r,f),E=Wr.interpolationFactor(this.interpolation,f,r[w],r[w+1]),k=a[w].evaluate(e),F=a[w+1].evaluate(e);switch(this.operator){case"interpolate":return ln[this.type.kind](k,F,E);case"interpolate-hcl":return ln.color(k,F,E,"hcl");case"interpolate-lab":return ln.color(k,F,E,"lab")}}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}}function Hs(i,e,r,a){const f=a-r,v=i-r;return f===0?0:e===1?v/f:(Math.pow(e,v)-1)/(Math.pow(e,f)-1)}class Fi{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expectected at least one argument.");let a=null;const f=r.expectedType;f&&f.kind!=="value"&&(a=f);const v=[];for(const E of e.slice(1)){const k=r.parse(E,1+v.length,a,void 0,{typeAnnotation:"omit"});if(!k)return null;a=a||k.type,v.push(k)}if(!a)throw new Error("No output type");const w=f&&v.some(E=>Pe(f,E.type));return new Fi(w?ui:a,v)}evaluate(e){let r,a=null,f=0;for(const v of this.args)if(f++,a=v.evaluate(e),a&&a instanceof Kr&&!a.available&&(r||(r=a.name),a=null,f===this.args.length&&(a=r)),a!==null)break;return a}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}class Ia{constructor(e,r){this.type=r.type,this.bindings=[].concat(e),this.result=r}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const r of this.bindings)e(r[1]);e(this.result)}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const a=[];for(let v=1;v<e.length-1;v+=2){const w=e[v];if(typeof w!="string")return r.error(`Expected string, but found ${typeof w} instead.`,v);if(/[^a-zA-Z0-9_]/.test(w))return r.error("Variable names must contain only alphanumeric characters or '_'.",v);const E=r.parse(e[v+1],v+1);if(!E)return null;a.push([w,E])}const f=r.parse(e[e.length-1],e.length-1,r.expectedType,a);return f?new Ia(a,f):null}outputDefined(){return this.result.outputDefined()}}class Pa{constructor(e,r,a){this.type=e,this.index=r,this.input=a}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const a=r.parse(e[1],1,xt),f=r.parse(e[2],2,J(r.expectedType||ui));return a&&f?new Pa(f.type.itemType,a,f):null}evaluate(e){const r=this.index.evaluate(e),a=this.input.evaluate(e);if(r<0)throw new gr(`Array index out of bounds: ${r} < 0.`);if(r>=a.length)throw new gr(`Array index out of bounds: ${r} > ${a.length-1}.`);if(r!==Math.floor(r))throw new gr(`Array index must be an integer, but found ${r} instead.`);return a[r]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}}class Aa{constructor(e,r){this.type=Kt,this.needle=e,this.haystack=r}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const a=r.parse(e[1],1,ui),f=r.parse(e[2],2,ui);return a&&f?De(a.type,[Kt,li,xt,cr,ui])?new Aa(a,f):r.error(`Expected first argument to be of type boolean, string, number or null, but found ${ae(a.type)} instead`):null}evaluate(e){const r=this.needle.evaluate(e),a=this.haystack.evaluate(e);if(!a)return!1;if(!be(r,["boolean","string","number","null"]))throw new gr(`Expected first argument to be of type boolean, string, number or null, but found ${ae(wr(r))} instead.`);if(!be(a,["string","array"]))throw new gr(`Expected second argument to be of type array or string, but found ${ae(wr(a))} instead.`);return a.indexOf(r)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}}class la{constructor(e,r,a){this.type=xt,this.needle=e,this.haystack=r,this.fromIndex=a}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const a=r.parse(e[1],1,ui),f=r.parse(e[2],2,ui);if(!a||!f)return null;if(!De(a.type,[Kt,li,xt,cr,ui]))return r.error(`Expected first argument to be of type boolean, string, number or null, but found ${ae(a.type)} instead`);if(e.length===4){const v=r.parse(e[3],3,xt);return v?new la(a,f,v):null}return new la(a,f)}evaluate(e){const r=this.needle.evaluate(e),a=this.haystack.evaluate(e);if(!be(r,["boolean","string","number","null"]))throw new gr(`Expected first argument to be of type boolean, string, number or null, but found ${ae(wr(r))} instead.`);if(!be(a,["string","array"]))throw new gr(`Expected second argument to be of type array or string, but found ${ae(wr(a))} instead.`);if(this.fromIndex){const f=this.fromIndex.evaluate(e);return a.indexOf(r,f)}return a.indexOf(r)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}}class to{constructor(e,r,a,f,v,w){this.inputType=e,this.type=r,this.input=a,this.cases=f,this.outputs=v,this.otherwise=w}static parse(e,r){if(e.length<5)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return r.error("Expected an even number of arguments.");let a,f;r.expectedType&&r.expectedType.kind!=="value"&&(f=r.expectedType);const v={},w=[];for(let F=2;F<e.length-1;F+=2){let B=e[F];const j=e[F+1];Array.isArray(B)||(B=[B]);const H=r.concat(F);if(B.length===0)return H.error("Expected at least one branch label.");for(const K of B){if(typeof K!="number"&&typeof K!="string")return H.error("Branch labels must be numbers or strings.");if(typeof K=="number"&&Math.abs(K)>Number.MAX_SAFE_INTEGER)return H.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof K=="number"&&Math.floor(K)!==K)return H.error("Numeric branch labels must be integer values.");if(a){if(H.checkSubtype(a,wr(K)))return null}else a=wr(K);if(v[String(K)]!==void 0)return H.error("Branch labels must be unique.");v[String(K)]=w.length}const Y=r.parse(j,F,f);if(!Y)return null;f=f||Y.type,w.push(Y)}const E=r.parse(e[1],1,ui);if(!E)return null;const k=r.parse(e[e.length-1],e.length-1,f);return k?E.type.kind!=="value"&&r.concat(1).checkSubtype(a,E.type)?null:new to(a,f,E,v,w,k):null}evaluate(e){const r=this.input.evaluate(e);return(wr(r)===this.inputType&&this.outputs[this.cases[r]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}}class io{constructor(e,r,a){this.type=e,this.branches=r,this.otherwise=a}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return r.error("Expected an odd number of arguments.");let a;r.expectedType&&r.expectedType.kind!=="value"&&(a=r.expectedType);const f=[];for(let w=1;w<e.length-1;w+=2){const E=r.parse(e[w],w,Kt);if(!E)return null;const k=r.parse(e[w+1],w+1,a);if(!k)return null;f.push([E,k]),a=a||k.type}const v=r.parse(e[e.length-1],e.length-1,a);if(!v)return null;if(!a)throw new Error("Can't infer output type");return new io(a,f,v)}evaluate(e){for(const[r,a]of this.branches)if(r.evaluate(e))return a.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[r,a]of this.branches)e(r),e(a);e(this.otherwise)}outputDefined(){return this.branches.every(([e,r])=>r.outputDefined())&&this.otherwise.outputDefined()}}class Is{constructor(e,r,a,f){this.type=e,this.input=r,this.beginIndex=a,this.endIndex=f}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const a=r.parse(e[1],1,ui),f=r.parse(e[2],2,xt);if(!a||!f)return null;if(!De(a.type,[J(ui),li,ui]))return r.error(`Expected first argument to be of type array or string, but found ${ae(a.type)} instead`);if(e.length===4){const v=r.parse(e[3],3,xt);return v?new Is(a.type,a,f,v):null}return new Is(a.type,a,f)}evaluate(e){const r=this.input.evaluate(e),a=this.beginIndex.evaluate(e);if(!be(r,["string","array"]))throw new gr(`Expected first argument to be of type array or string, but found ${ae(wr(r))} instead.`);if(this.endIndex){const f=this.endIndex.evaluate(e);return r.slice(a,f)}return r.slice(a)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}}function Ma(i,e){return i==="=="||i==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function ro(i,e,r,a){return a.compare(e,r)===0}function Jr(i,e,r){const a=i!=="=="&&i!=="!=";return class xd{constructor(v,w,E){this.type=Kt,this.lhs=v,this.rhs=w,this.collator=E,this.hasUntypedArgument=v.type.kind==="value"||w.type.kind==="value"}static parse(v,w){if(v.length!==3&&v.length!==4)return w.error("Expected two or three arguments.");const E=v[0];let k=w.parse(v[1],1,ui);if(!k)return null;if(!Ma(E,k.type))return w.concat(1).error(`"${E}" comparisons are not supported for type '${ae(k.type)}'.`);let F=w.parse(v[2],2,ui);if(!F)return null;if(!Ma(E,F.type))return w.concat(2).error(`"${E}" comparisons are not supported for type '${ae(F.type)}'.`);if(k.type.kind!==F.type.kind&&k.type.kind!=="value"&&F.type.kind!=="value")return w.error(`Cannot compare types '${ae(k.type)}' and '${ae(F.type)}'.`);a&&(k.type.kind==="value"&&F.type.kind!=="value"?k=new fn(F.type,[k]):k.type.kind!=="value"&&F.type.kind==="value"&&(F=new fn(k.type,[F])));let B=null;if(v.length===4){if(k.type.kind!=="string"&&F.type.kind!=="string"&&k.type.kind!=="value"&&F.type.kind!=="value")return w.error("Cannot use collator to compare non-string types.");if(B=w.parse(v[3],3,wn),!B)return null}return new xd(k,F,B)}evaluate(v){const w=this.lhs.evaluate(v),E=this.rhs.evaluate(v);if(a&&this.hasUntypedArgument){const k=wr(w),F=wr(E);if(k.kind!==F.kind||k.kind!=="string"&&k.kind!=="number")throw new gr(`Expected arguments for "${i}" to be (string, string) or (number, number), but found (${k.kind}, ${F.kind}) instead.`)}if(this.collator&&!a&&this.hasUntypedArgument){const k=wr(w),F=wr(E);if(k.kind!=="string"||F.kind!=="string")return e(v,w,E)}return this.collator?r(v,w,E,this.collator.evaluate(v)):e(v,w,E)}eachChild(v){v(this.lhs),v(this.rhs),this.collator&&v(this.collator)}outputDefined(){return!0}}}const Lo=Jr("==",function(i,e,r){return e===r},ro),Fo=Jr("!=",function(i,e,r){return e!==r},function(i,e,r,a){return!ro(0,e,r,a)}),pl=Jr("<",function(i,e,r){return e<r},function(i,e,r,a){return a.compare(e,r)<0}),zo=Jr(">",function(i,e,r){return e>r},function(i,e,r,a){return a.compare(e,r)>0}),ka=Jr("<=",function(i,e,r){return e<=r},function(i,e,r,a){return a.compare(e,r)<=0}),Ro=Jr(">=",function(i,e,r){return e>=r},function(i,e,r,a){return a.compare(e,r)>=0});class Da{constructor(e,r,a,f,v){this.type=li,this.number=e,this.locale=r,this.currency=a,this.minFractionDigits=f,this.maxFractionDigits=v}static parse(e,r){if(e.length!==3)return r.error("Expected two arguments.");const a=r.parse(e[1],1,xt);if(!a)return null;const f=e[2];if(typeof f!="object"||Array.isArray(f))return r.error("NumberFormat options argument must be an object.");let v=null;if(f.locale&&(v=r.parse(f.locale,1,li),!v))return null;let w=null;if(f.currency&&(w=r.parse(f.currency,1,li),!w))return null;let E=null;if(f["min-fraction-digits"]&&(E=r.parse(f["min-fraction-digits"],1,xt),!E))return null;let k=null;return f["max-fraction-digits"]&&(k=r.parse(f["max-fraction-digits"],1,xt),!k)?null:new Da(a,v,w,E,k)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}}class Oa{constructor(e){this.type=$r,this.sections=e}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const a=e[1];if(!Array.isArray(a)&&typeof a=="object")return r.error("First argument must be an image or text section.");const f=[];let v=!1;for(let w=1;w<=e.length-1;++w){const E=e[w];if(v&&typeof E=="object"&&!Array.isArray(E)){v=!1;let k=null;if(E["font-scale"]&&(k=r.parse(E["font-scale"],1,xt),!k))return null;let F=null;if(E["text-font"]&&(F=r.parse(E["text-font"],1,J(li)),!F))return null;let B=null;if(E["text-color"]&&(B=r.parse(E["text-color"],1,Tr),!B))return null;const j=f[f.length-1];j.scale=k,j.font=F,j.textColor=B}else{const k=r.parse(e[w],1,ui);if(!k)return null;const F=k.type.kind;if(F!=="string"&&F!=="value"&&F!=="null"&&F!=="resolvedImage")return r.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");v=!0,f.push({content:k,scale:null,font:null,textColor:null})}}return new Oa(f)}evaluate(e){return new sn(this.sections.map(r=>{const a=r.content.evaluate(e);return wr(a)===W?new br("",a,null,null,null):new br(aa(a),null,r.scale?r.scale.evaluate(e):null,r.font?r.font.evaluate(e).join(","):null,r.textColor?r.textColor.evaluate(e):null)}))}eachChild(e){for(const r of this.sections)e(r.content),r.scale&&e(r.scale),r.font&&e(r.font),r.textColor&&e(r.textColor)}outputDefined(){return!1}}class es{constructor(e){this.type=W,this.input=e}static parse(e,r){if(e.length!==2)return r.error("Expected two arguments.");const a=r.parse(e[1],1,li);return a?new es(a):r.error("No image name provided.")}evaluate(e){const r=this.input.evaluate(e),a=Kr.fromString(r);return a&&e.availableImages&&(a.available=e.availableImages.indexOf(r)>-1),a}eachChild(e){e(this.input)}outputDefined(){return!1}}class La{constructor(e){this.type=xt,this.input=e}static parse(e,r){if(e.length!==2)return r.error(`Expected 1 argument, but found ${e.length-1} instead.`);const a=r.parse(e[1],1);return a?a.type.kind!=="array"&&a.type.kind!=="string"&&a.type.kind!=="value"?r.error(`Expected argument of type string or array, but found ${ae(a.type)} instead.`):new La(a):null}evaluate(e){const r=this.input.evaluate(e);if(typeof r=="string"||Array.isArray(r))return r.length;throw new gr(`Expected value to be of type string or array, but found ${ae(wr(r))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}}const Xs={"==":Lo,"!=":Fo,">":zo,"<":pl,">=":Ro,"<=":ka,array:fn,at:Pa,boolean:fn,case:io,coalesce:Fi,collator:Ss,format:Oa,image:es,in:Aa,"index-of":la,interpolate:Wr,"interpolate-hcl":Wr,"interpolate-lab":Wr,length:La,let:Ia,literal:Cs,match:to,number:fn,"number-format":Da,object:fn,slice:Is,step:Es,string:fn,"to-boolean":On,"to-color":On,"to-number":On,"to-string":On,var:Qt,within:ft};function Bo(i,[e,r,a,f]){e=e.evaluate(i),r=r.evaluate(i),a=a.evaluate(i);const v=f?f.evaluate(i):1,w=us(e,r,a,v);if(w)throw new gr(w);return new Ni(e/255,r/255,a/255,v,!1)}function Fa(i,e){return i in e}function Ps(i,e){const r=e[i];return r===void 0?null:r}function ts(i){return{type:i}}function za(i){return{result:"success",value:i}}function ps(i){return{result:"error",value:i}}function Gn(i){return i["property-type"]==="data-driven"||i["property-type"]==="cross-faded-data-driven"}function jo(i){return!!i.expression&&i.expression.parameters.indexOf("zoom")>-1}function no(i){return!!i.expression&&i.expression.interpolated}function zi(i){return i instanceof Number?"number":i instanceof String?"string":i instanceof Boolean?"boolean":Array.isArray(i)?"array":i===null?"null":typeof i}function qs(i){return typeof i=="object"&&i!==null&&!Array.isArray(i)}function ml(i){return i}function so(i,e){const r=e.type==="color",a=i.stops&&typeof i.stops[0][0]=="object",f=a||!(a||i.property!==void 0),v=i.type||(no(e)?"exponential":"interval");if(r||e.type==="padding"){const B=r?Ni.parse:an.parse;(i=Hi({},i)).stops&&(i.stops=i.stops.map(j=>[j[0],B(j[1])])),i.default=B(i.default?i.default:e.default)}if(i.colorSpace&&(w=i.colorSpace)!=="rgb"&&w!=="hcl"&&w!=="lab")throw new Error(`Unknown color space: "${i.colorSpace}"`);var w;let E,k,F;if(v==="exponential")E=ms;else if(v==="interval")E=$i;else if(v==="categorical"){E=Ms,k=Object.create(null);for(const B of i.stops)k[B[0]]=B[1];F=typeof i.stops[0][0]}else{if(v!=="identity")throw new Error(`Unknown function type "${v}"`);E=Ii}if(a){const B={},j=[];for(let K=0;K<i.stops.length;K++){const re=i.stops[K],he=re[0].zoom;B[he]===void 0&&(B[he]={zoom:he,type:i.type,property:i.property,default:i.default,stops:[]},j.push(he)),B[he].stops.push([re[0].value,re[1]])}const H=[];for(const K of j)H.push([B[K].zoom,so(B[K],e)]);const Y={name:"linear"};return{kind:"composite",interpolationType:Y,interpolationFactor:Wr.interpolationFactor.bind(void 0,Y),zoomStops:H.map(K=>K[0]),evaluate:({zoom:K},re)=>ms({stops:H,base:i.base},e,K).evaluate(K,re)}}if(f){const B=v==="exponential"?{name:"exponential",base:i.base!==void 0?i.base:1}:null;return{kind:"camera",interpolationType:B,interpolationFactor:Wr.interpolationFactor.bind(void 0,B),zoomStops:i.stops.map(j=>j[0]),evaluate:({zoom:j})=>E(i,e,j,k,F)}}return{kind:"source",evaluate(B,j){const H=j&&j.properties?j.properties[i.property]:void 0;return H===void 0?As(i.default,e.default):E(i,e,H,k,F)}}}function As(i,e,r){return i!==void 0?i:e!==void 0?e:r!==void 0?r:void 0}function Ms(i,e,r,a,f){return As(typeof r===f?a[r]:void 0,i.default,e.default)}function $i(i,e,r){if(zi(r)!=="number")return As(i.default,e.default);const a=i.stops.length;if(a===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[a-1][0])return i.stops[a-1][1];const f=qi(i.stops.map(v=>v[0]),r);return i.stops[f][1]}function ms(i,e,r){const a=i.base!==void 0?i.base:1;if(zi(r)!=="number")return As(i.default,e.default);const f=i.stops.length;if(f===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[f-1][0])return i.stops[f-1][1];const v=qi(i.stops.map(B=>B[0]),r),w=function(B,j,H,Y){const K=Y-H,re=B-H;return K===0?0:j===1?re/K:(Math.pow(j,re)-1)/(Math.pow(j,K)-1)}(r,a,i.stops[v][0],i.stops[v+1][0]),E=i.stops[v][1],k=i.stops[v+1][1],F=ln[e.type]||ml;return typeof E.evaluate=="function"?{evaluate(...B){const j=E.evaluate.apply(void 0,B),H=k.evaluate.apply(void 0,B);if(j!==void 0&&H!==void 0)return F(j,H,w,i.colorSpace)}}:F(E,k,w,i.colorSpace)}function Ii(i,e,r){switch(e.type){case"color":r=Ni.parse(r);break;case"formatted":r=sn.fromString(r.toString());break;case"resolvedImage":r=Kr.fromString(r.toString());break;case"padding":r=an.parse(r);break;default:zi(r)===e.type||e.type==="enum"&&e.values[r]||(r=void 0)}return As(r,i.default,e.default)}Ei.register(Xs,{error:[{kind:"error"},[li],(i,[e])=>{throw new gr(e.evaluate(i))}],typeof:[li,[ui],(i,[e])=>ae(wr(e.evaluate(i)))],"to-rgba":[J(xt,4),[Tr],(i,[e])=>{const[r,a,f,v]=e.evaluate(i).rgb;return[255*r,255*a,255*f,v]}],rgb:[Tr,[xt,xt,xt],Bo],rgba:[Tr,[xt,xt,xt,xt],Bo],has:{type:Kt,overloads:[[[li],(i,[e])=>Fa(e.evaluate(i),i.properties())],[[li,Lr],(i,[e,r])=>Fa(e.evaluate(i),r.evaluate(i))]]},get:{type:ui,overloads:[[[li],(i,[e])=>Ps(e.evaluate(i),i.properties())],[[li,Lr],(i,[e,r])=>Ps(e.evaluate(i),r.evaluate(i))]]},"feature-state":[ui,[li],(i,[e])=>Ps(e.evaluate(i),i.featureState||{})],properties:[Lr,[],i=>i.properties()],"geometry-type":[li,[],i=>i.geometryType()],id:[ui,[],i=>i.id()],zoom:[xt,[],i=>i.globals.zoom],"heatmap-density":[xt,[],i=>i.globals.heatmapDensity||0],"line-progress":[xt,[],i=>i.globals.lineProgress||0],accumulated:[ui,[],i=>i.globals.accumulated===void 0?null:i.globals.accumulated],"+":[xt,ts(xt),(i,e)=>{let r=0;for(const a of e)r+=a.evaluate(i);return r}],"*":[xt,ts(xt),(i,e)=>{let r=1;for(const a of e)r*=a.evaluate(i);return r}],"-":{type:xt,overloads:[[[xt,xt],(i,[e,r])=>e.evaluate(i)-r.evaluate(i)],[[xt],(i,[e])=>-e.evaluate(i)]]},"/":[xt,[xt,xt],(i,[e,r])=>e.evaluate(i)/r.evaluate(i)],"%":[xt,[xt,xt],(i,[e,r])=>e.evaluate(i)%r.evaluate(i)],ln2:[xt,[],()=>Math.LN2],pi:[xt,[],()=>Math.PI],e:[xt,[],()=>Math.E],"^":[xt,[xt,xt],(i,[e,r])=>Math.pow(e.evaluate(i),r.evaluate(i))],sqrt:[xt,[xt],(i,[e])=>Math.sqrt(e.evaluate(i))],log10:[xt,[xt],(i,[e])=>Math.log(e.evaluate(i))/Math.LN10],ln:[xt,[xt],(i,[e])=>Math.log(e.evaluate(i))],log2:[xt,[xt],(i,[e])=>Math.log(e.evaluate(i))/Math.LN2],sin:[xt,[xt],(i,[e])=>Math.sin(e.evaluate(i))],cos:[xt,[xt],(i,[e])=>Math.cos(e.evaluate(i))],tan:[xt,[xt],(i,[e])=>Math.tan(e.evaluate(i))],asin:[xt,[xt],(i,[e])=>Math.asin(e.evaluate(i))],acos:[xt,[xt],(i,[e])=>Math.acos(e.evaluate(i))],atan:[xt,[xt],(i,[e])=>Math.atan(e.evaluate(i))],min:[xt,ts(xt),(i,e)=>Math.min(...e.map(r=>r.evaluate(i)))],max:[xt,ts(xt),(i,e)=>Math.max(...e.map(r=>r.evaluate(i)))],abs:[xt,[xt],(i,[e])=>Math.abs(e.evaluate(i))],round:[xt,[xt],(i,[e])=>{const r=e.evaluate(i);return r<0?-Math.round(-r):Math.round(r)}],floor:[xt,[xt],(i,[e])=>Math.floor(e.evaluate(i))],ceil:[xt,[xt],(i,[e])=>Math.ceil(e.evaluate(i))],"filter-==":[Kt,[li,ui],(i,[e,r])=>i.properties()[e.value]===r.value],"filter-id-==":[Kt,[ui],(i,[e])=>i.id()===e.value],"filter-type-==":[Kt,[li],(i,[e])=>i.geometryType()===e.value],"filter-<":[Kt,[li,ui],(i,[e,r])=>{const a=i.properties()[e.value],f=r.value;return typeof a==typeof f&&a<f}],"filter-id-<":[Kt,[ui],(i,[e])=>{const r=i.id(),a=e.value;return typeof r==typeof a&&r<a}],"filter->":[Kt,[li,ui],(i,[e,r])=>{const a=i.properties()[e.value],f=r.value;return typeof a==typeof f&&a>f}],"filter-id->":[Kt,[ui],(i,[e])=>{const r=i.id(),a=e.value;return typeof r==typeof a&&r>a}],"filter-<=":[Kt,[li,ui],(i,[e,r])=>{const a=i.properties()[e.value],f=r.value;return typeof a==typeof f&&a<=f}],"filter-id-<=":[Kt,[ui],(i,[e])=>{const r=i.id(),a=e.value;return typeof r==typeof a&&r<=a}],"filter->=":[Kt,[li,ui],(i,[e,r])=>{const a=i.properties()[e.value],f=r.value;return typeof a==typeof f&&a>=f}],"filter-id->=":[Kt,[ui],(i,[e])=>{const r=i.id(),a=e.value;return typeof r==typeof a&&r>=a}],"filter-has":[Kt,[ui],(i,[e])=>e.value in i.properties()],"filter-has-id":[Kt,[],i=>i.id()!==null&&i.id()!==void 0],"filter-type-in":[Kt,[J(li)],(i,[e])=>e.value.indexOf(i.geometryType())>=0],"filter-id-in":[Kt,[J(ui)],(i,[e])=>e.value.indexOf(i.id())>=0],"filter-in-small":[Kt,[li,J(ui)],(i,[e,r])=>r.value.indexOf(i.properties()[e.value])>=0],"filter-in-large":[Kt,[li,J(ui)],(i,[e,r])=>function(a,f,v,w){for(;v<=w;){const E=v+w>>1;if(f[E]===a)return!0;f[E]>a?w=E-1:v=E+1}return!1}(i.properties()[e.value],r.value,0,r.value.length-1)],all:{type:Kt,overloads:[[[Kt,Kt],(i,[e,r])=>e.evaluate(i)&&r.evaluate(i)],[ts(Kt),(i,e)=>{for(const r of e)if(!r.evaluate(i))return!1;return!0}]]},any:{type:Kt,overloads:[[[Kt,Kt],(i,[e,r])=>e.evaluate(i)||r.evaluate(i)],[ts(Kt),(i,e)=>{for(const r of e)if(r.evaluate(i))return!0;return!1}]]},"!":[Kt,[Kt],(i,[e])=>!e.evaluate(i)],"is-supported-script":[Kt,[li],(i,[e])=>{const r=i.globals&&i.globals.isSupportedScript;return!r||r(e.evaluate(i))}],upcase:[li,[li],(i,[e])=>e.evaluate(i).toUpperCase()],downcase:[li,[li],(i,[e])=>e.evaluate(i).toLowerCase()],concat:[li,ts(ui),(i,e)=>e.map(r=>aa(r.evaluate(i))).join("")],"resolved-locale":[li,[wn],(i,[e])=>e.evaluate(i).resolvedLocale()]});class Cn{constructor(e,r){var a;this.expression=e,this._warningHistory={},this._evaluator=new Gs,this._defaultValue=r?(a=r).type==="color"&&qs(a.default)?new Ni(0,0,0,0):a.type==="color"?Ni.parse(a.default)||null:a.type==="padding"?an.parse(a.default)||null:a.type==="variableAnchorOffsetCollection"?tr.parse(a.default)||null:a.default===void 0?null:a.default:null,this._enumValues=r&&r.type==="enum"?r.values:null}evaluateWithoutErrorHandling(e,r,a,f,v,w){return this._evaluator.globals=e,this._evaluator.feature=r,this._evaluator.featureState=a,this._evaluator.canonical=f,this._evaluator.availableImages=v||null,this._evaluator.formattedSection=w,this.expression.evaluate(this._evaluator)}evaluate(e,r,a,f,v,w){this._evaluator.globals=e,this._evaluator.feature=r||null,this._evaluator.featureState=a||null,this._evaluator.canonical=f,this._evaluator.availableImages=v||null,this._evaluator.formattedSection=w||null;try{const E=this.expression.evaluate(this._evaluator);if(E==null||typeof E=="number"&&E!=E)return this._defaultValue;if(this._enumValues&&!(E in this._enumValues))throw new gr(`Expected value to be one of ${Object.keys(this._enumValues).map(k=>JSON.stringify(k)).join(", ")}, but found ${JSON.stringify(E)} instead.`);return E}catch(E){return this._warningHistory[E.message]||(this._warningHistory[E.message]=!0,typeof console<"u"&&console.warn(E.message)),this._defaultValue}}}function Ji(i){return Array.isArray(i)&&i.length>0&&typeof i[0]=="string"&&i[0]in Xs}function Wi(i,e){const r=new Vi(Xs,_r,[],e?function(f){const v={color:Tr,string:li,number:xt,enum:li,boolean:Kt,formatted:$r,padding:se,resolvedImage:W,variableAnchorOffsetCollection:X};return f.type==="array"?J(v[f.value]||ui,f.length):v[f.type]}(e):void 0),a=r.parse(i,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return a?za(new Cn(a,e)):ps(r.errors)}class Wn{constructor(e,r){this.kind=e,this._styleExpression=r,this.isStateDependent=e!=="constant"&&!Ts(r.expression)}evaluateWithoutErrorHandling(e,r,a,f,v,w){return this._styleExpression.evaluateWithoutErrorHandling(e,r,a,f,v,w)}evaluate(e,r,a,f,v,w){return this._styleExpression.evaluate(e,r,a,f,v,w)}}class ca{constructor(e,r,a,f){this.kind=e,this.zoomStops=a,this._styleExpression=r,this.isStateDependent=e!=="camera"&&!Ts(r.expression),this.interpolationType=f}evaluateWithoutErrorHandling(e,r,a,f,v,w){return this._styleExpression.evaluateWithoutErrorHandling(e,r,a,f,v,w)}evaluate(e,r,a,f,v,w){return this._styleExpression.evaluate(e,r,a,f,v,w)}interpolationFactor(e,r,a){return this.interpolationType?Wr.interpolationFactor(this.interpolationType,e,r,a):0}}function ao(i,e){const r=Wi(i,e);if(r.result==="error")return r;const a=r.value.expression,f=sr(a);if(!f&&!Gn(e))return ps([new Zt("","data expressions not supported")]);const v=Ea(a,["zoom"]);if(!v&&!jo(e))return ps([new Zt("","zoom expressions not supported")]);const w=Ba(a);return w||v?w instanceof Zt?ps([w]):w instanceof Wr&&!no(e)?ps([new Zt("",'"interpolate" expressions cannot be used with this property')]):za(w?new ca(f?"camera":"composite",r.value,w.labels,w instanceof Wr?w.interpolation:void 0):new Wn(f?"constant":"source",r.value)):ps([new Zt("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Ra{constructor(e,r){this._parameters=e,this._specification=r,Hi(this,so(this._parameters,this._specification))}static deserialize(e){return new Ra(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Ba(i){let e=null;if(i instanceof Ia)e=Ba(i.result);else if(i instanceof Fi){for(const r of i.args)if(e=Ba(r),e)break}else(i instanceof Es||i instanceof Wr)&&i.input instanceof Ei&&i.input.name==="zoom"&&(e=i);return e instanceof Zt||i.eachChild(r=>{const a=Ba(r);a instanceof Zt?e=a:!e&&a?e=new Zt("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&a&&e!==a&&(e=new Zt("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}function ja(i){if(i===!0||i===!1)return!0;if(!Array.isArray(i)||i.length===0)return!1;switch(i[0]){case"has":return i.length>=2&&i[1]!=="$id"&&i[1]!=="$type";case"in":return i.length>=3&&(typeof i[1]!="string"||Array.isArray(i[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return i.length!==3||Array.isArray(i[1])||Array.isArray(i[2]);case"any":case"all":for(const e of i.slice(1))if(!ja(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}const oo={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function ks(i){if(i==null)return{filter:()=>!0,needGeometry:!1};ja(i)||(i=pn(i));const e=Wi(i,oo);if(e.result==="error")throw new Error(e.value.map(r=>`${r.key}: ${r.message}`).join(", "));return{filter:(r,a,f)=>e.value.evaluate(r,a,{},f),needGeometry:lo(i)}}function Ds(i,e){return i<e?-1:i>e?1:0}function lo(i){if(!Array.isArray(i))return!1;if(i[0]==="within")return!0;for(let e=1;e<i.length;e++)if(lo(i[e]))return!0;return!1}function pn(i){if(!i)return!0;const e=i[0];return i.length<=1?e!=="any":e==="=="?co(i[1],i[2],"=="):e==="!="?Na(co(i[1],i[2],"==")):e==="<"||e===">"||e==="<="||e===">="?co(i[1],i[2],e):e==="any"?(r=i.slice(1),["any"].concat(r.map(pn))):e==="all"?["all"].concat(i.slice(1).map(pn)):e==="none"?["all"].concat(i.slice(1).map(pn).map(Na)):e==="in"?gs(i[1],i.slice(2)):e==="!in"?Na(gs(i[1],i.slice(2))):e==="has"?ho(i[1]):e==="!has"?Na(ho(i[1])):e!=="within"||i;var r}function co(i,e,r){switch(i){case"$type":return[`filter-type-${r}`,e];case"$id":return[`filter-id-${r}`,e];default:return[`filter-${r}`,i,e]}}function gs(i,e){if(e.length===0)return!1;switch(i){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(r=>typeof r!=typeof e[0])?["filter-in-large",i,["literal",e.sort(Ds)]]:["filter-in-small",i,["literal",e]]}}function ho(i){switch(i){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",i]}}function Na(i){return["!",i]}function $s(i){const e=typeof i;if(e==="number"||e==="boolean"||e==="string"||i==null)return JSON.stringify(i);if(Array.isArray(i)){let f="[";for(const v of i)f+=`${$s(v)},`;return`${f}]`}const r=Object.keys(i).sort();let a="{";for(let f=0;f<r.length;f++)a+=`${JSON.stringify(r[f])}:${$s(i[r[f]])},`;return`${a}}`}function uo(i){let e="";for(const r of it)e+=`/${$s(i[r])}`;return e}function fo(i){const e=i.value;return e?[new ht(i.key,e,"constants have been deprecated as of v8")]:[]}function dr(i){return i instanceof Number||i instanceof String||i instanceof Boolean?i.valueOf():i}function is(i){if(Array.isArray(i))return i.map(is);if(i instanceof Object&&!(i instanceof Number||i instanceof String||i instanceof Boolean)){const e={};for(const r in i)e[r]=is(i[r]);return e}return dr(i)}function zr(i){const e=i.key,r=i.value,a=i.valueSpec||{},f=i.objectElementValidators||{},v=i.style,w=i.styleSpec,E=i.validateSpec;let k=[];const F=zi(r);if(F!=="object")return[new ht(e,r,`object expected, ${F} found`)];for(const B in r){const j=B.split(".")[0],H=a[j]||a["*"];let Y;if(f[j])Y=f[j];else if(a[j])Y=E;else if(f["*"])Y=f["*"];else{if(!a["*"]){k.push(new ht(e,r[B],`unknown property "${B}"`));continue}Y=E}k=k.concat(Y({key:(e&&`${e}.`)+B,value:r[B],valueSpec:H,style:v,styleSpec:w,object:r,objectKey:B,validateSpec:E},r))}for(const B in a)f[B]||a[B].required&&a[B].default===void 0&&r[B]===void 0&&k.push(new ht(e,r,`missing required property "${B}"`));return k}function Os(i){const e=i.value,r=i.valueSpec,a=i.style,f=i.styleSpec,v=i.key,w=i.arrayElementValidator||i.validateSpec;if(zi(e)!=="array")return[new ht(v,e,`array expected, ${zi(e)} found`)];if(r.length&&e.length!==r.length)return[new ht(v,e,`array length ${r.length} expected, length ${e.length} found`)];if(r["min-length"]&&e.length<r["min-length"])return[new ht(v,e,`array length at least ${r["min-length"]} expected, length ${e.length} found`)];let E={type:r.value,values:r.values};f.$version<7&&(E.function=r.function),zi(r.value)==="object"&&(E=r.value);let k=[];for(let F=0;F<e.length;F++)k=k.concat(w({array:e,arrayIndex:F,value:e[F],valueSpec:E,validateSpec:i.validateSpec,style:a,styleSpec:f,key:`${v}[${F}]`}));return k}function po(i){const e=i.key,r=i.value,a=i.valueSpec;let f=zi(r);return f==="number"&&r!=r&&(f="NaN"),f!=="number"?[new ht(e,r,`number expected, ${f} found`)]:"minimum"in a&&r<a.minimum?[new ht(e,r,`${r} is less than the minimum value ${a.minimum}`)]:"maximum"in a&&r>a.maximum?[new ht(e,r,`${r} is greater than the maximum value ${a.maximum}`)]:[]}function ze(i){const e=i.valueSpec,r=dr(i.value.type);let a,f,v,w={};const E=r!=="categorical"&&i.value.property===void 0,k=!E,F=zi(i.value.stops)==="array"&&zi(i.value.stops[0])==="array"&&zi(i.value.stops[0][0])==="object",B=zr({key:i.key,value:i.value,valueSpec:i.styleSpec.function,validateSpec:i.validateSpec,style:i.style,styleSpec:i.styleSpec,objectElementValidators:{stops:function(Y){if(r==="identity")return[new ht(Y.key,Y.value,'identity function may not have a "stops" property')];let K=[];const re=Y.value;return K=K.concat(Os({key:Y.key,value:re,valueSpec:Y.valueSpec,validateSpec:Y.validateSpec,style:Y.style,styleSpec:Y.styleSpec,arrayElementValidator:j})),zi(re)==="array"&&re.length===0&&K.push(new ht(Y.key,re,"array must have at least one stop")),K},default:function(Y){return Y.validateSpec({key:Y.key,value:Y.value,valueSpec:e,validateSpec:Y.validateSpec,style:Y.style,styleSpec:Y.styleSpec})}}});return r==="identity"&&E&&B.push(new ht(i.key,i.value,'missing required property "property"')),r==="identity"||i.value.stops||B.push(new ht(i.key,i.value,'missing required property "stops"')),r==="exponential"&&i.valueSpec.expression&&!no(i.valueSpec)&&B.push(new ht(i.key,i.value,"exponential functions not supported")),i.styleSpec.$version>=8&&(k&&!Gn(i.valueSpec)?B.push(new ht(i.key,i.value,"property functions not supported")):E&&!jo(i.valueSpec)&&B.push(new ht(i.key,i.value,"zoom functions not supported"))),r!=="categorical"&&!F||i.value.property!==void 0||B.push(new ht(i.key,i.value,'"property" property is required')),B;function j(Y){let K=[];const re=Y.value,he=Y.key;if(zi(re)!=="array")return[new ht(he,re,`array expected, ${zi(re)} found`)];if(re.length!==2)return[new ht(he,re,`array length 2 expected, length ${re.length} found`)];if(F){if(zi(re[0])!=="object")return[new ht(he,re,`object expected, ${zi(re[0])} found`)];if(re[0].zoom===void 0)return[new ht(he,re,"object stop key must have zoom")];if(re[0].value===void 0)return[new ht(he,re,"object stop key must have value")];if(v&&v>dr(re[0].zoom))return[new ht(he,re[0].zoom,"stop zoom values must appear in ascending order")];dr(re[0].zoom)!==v&&(v=dr(re[0].zoom),f=void 0,w={}),K=K.concat(zr({key:`${he}[0]`,value:re[0],valueSpec:{zoom:{}},validateSpec:Y.validateSpec,style:Y.style,styleSpec:Y.styleSpec,objectElementValidators:{zoom:po,value:H}}))}else K=K.concat(H({key:`${he}[0]`,value:re[0],valueSpec:{},validateSpec:Y.validateSpec,style:Y.style,styleSpec:Y.styleSpec},re));return Ji(is(re[1]))?K.concat([new ht(`${he}[1]`,re[1],"expressions are not allowed in function stops.")]):K.concat(Y.validateSpec({key:`${he}[1]`,value:re[1],valueSpec:e,validateSpec:Y.validateSpec,style:Y.style,styleSpec:Y.styleSpec}))}function H(Y,K){const re=zi(Y.value),he=dr(Y.value),ve=Y.value!==null?Y.value:K;if(a){if(re!==a)return[new ht(Y.key,ve,`${re} stop domain type must match previous stop domain type ${a}`)]}else a=re;if(re!=="number"&&re!=="string"&&re!=="boolean")return[new ht(Y.key,ve,"stop domain value must be a number, string, or boolean")];if(re!=="number"&&r!=="categorical"){let Be=`number expected, ${re} found`;return Gn(e)&&r===void 0&&(Be+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new ht(Y.key,ve,Be)]}return r!=="categorical"||re!=="number"||isFinite(he)&&Math.floor(he)===he?r!=="categorical"&&re==="number"&&f!==void 0&&he<f?[new ht(Y.key,ve,"stop domain values must appear in ascending order")]:(f=he,r==="categorical"&&he in w?[new ht(Y.key,ve,"stop domain values must be unique")]:(w[he]=!0,[])):[new ht(Y.key,ve,`integer expected, found ${he}`)]}}function tt(i){const e=(i.expressionContext==="property"?ao:Wi)(is(i.value),i.valueSpec);if(e.result==="error")return e.value.map(a=>new ht(`${i.key}${a.key}`,i.value,a.message));const r=e.value.expression||e.value._styleExpression.expression;if(i.expressionContext==="property"&&i.propertyKey==="text-font"&&!r.outputDefined())return[new ht(i.key,i.value,`Invalid data expression for "${i.propertyKey}". Output values must be contained as literals within the expression.`)];if(i.expressionContext==="property"&&i.propertyType==="layout"&&!Ts(r))return[new ht(i.key,i.value,'"feature-state" data expressions are not supported with layout properties.')];if(i.expressionContext==="filter"&&!Ts(r))return[new ht(i.key,i.value,'"feature-state" data expressions are not supported with filters.')];if(i.expressionContext&&i.expressionContext.indexOf("cluster")===0){if(!Ea(r,["zoom","feature-state"]))return[new ht(i.key,i.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(i.expressionContext==="cluster-initial"&&!sr(r))return[new ht(i.key,i.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Lt(i){const e=i.key,r=i.value,a=i.valueSpec,f=[];return Array.isArray(a.values)?a.values.indexOf(dr(r))===-1&&f.push(new ht(e,r,`expected one of [${a.values.join(", ")}], ${JSON.stringify(r)} found`)):Object.keys(a.values).indexOf(dr(r))===-1&&f.push(new ht(e,r,`expected one of [${Object.keys(a.values).join(", ")}], ${JSON.stringify(r)} found`)),f}function ni(i){return ja(is(i.value))?tt(Hi({},i,{expressionContext:"filter",valueSpec:{value:"boolean"}})):Yi(i)}function Yi(i){const e=i.value,r=i.key;if(zi(e)!=="array")return[new ht(r,e,`array expected, ${zi(e)} found`)];const a=i.styleSpec;let f,v=[];if(e.length<1)return[new ht(r,e,"filter array must have at least 1 element")];switch(v=v.concat(Lt({key:`${r}[0]`,value:e[0],valueSpec:a.filter_operator,style:i.style,styleSpec:i.styleSpec})),dr(e[0])){case"<":case"<=":case">":case">=":e.length>=2&&dr(e[1])==="$type"&&v.push(new ht(r,e,`"$type" cannot be use with operator "${e[0]}"`));case"==":case"!=":e.length!==3&&v.push(new ht(r,e,`filter array for operator "${e[0]}" must have 3 elements`));case"in":case"!in":e.length>=2&&(f=zi(e[1]),f!=="string"&&v.push(new ht(`${r}[1]`,e[1],`string expected, ${f} found`)));for(let w=2;w<e.length;w++)f=zi(e[w]),dr(e[1])==="$type"?v=v.concat(Lt({key:`${r}[${w}]`,value:e[w],valueSpec:a.geometry_type,style:i.style,styleSpec:i.styleSpec})):f!=="string"&&f!=="number"&&f!=="boolean"&&v.push(new ht(`${r}[${w}]`,e[w],`string, number, or boolean expected, ${f} found`));break;case"any":case"all":case"none":for(let w=1;w<e.length;w++)v=v.concat(Yi({key:`${r}[${w}]`,value:e[w],style:i.style,styleSpec:i.styleSpec}));break;case"has":case"!has":f=zi(e[1]),e.length!==2?v.push(new ht(r,e,`filter array for "${e[0]}" operator must have 2 elements`)):f!=="string"&&v.push(new ht(`${r}[1]`,e[1],`string expected, ${f} found`));break;case"within":f=zi(e[1]),e.length!==2?v.push(new ht(r,e,`filter array for "${e[0]}" operator must have 2 elements`)):f!=="object"&&v.push(new ht(`${r}[1]`,e[1],`object expected, ${f} found`))}return v}function ki(i,e){const r=i.key,a=i.validateSpec,f=i.style,v=i.styleSpec,w=i.value,E=i.objectKey,k=v[`${e}_${i.layerType}`];if(!k)return[];const F=E.match(/^(.*)-transition$/);if(e==="paint"&&F&&k[F[1]]&&k[F[1]].transition)return a({key:r,value:w,valueSpec:v.transition,style:f,styleSpec:v});const B=i.valueSpec||k[E];if(!B)return[new ht(r,w,`unknown property "${E}"`)];let j;if(zi(w)==="string"&&Gn(B)&&!B.tokens&&(j=/^{([^}]+)}$/.exec(w)))return[new ht(r,w,`"${E}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(j[1])} }\`.`)];const H=[];return i.layerType==="symbol"&&(E==="text-field"&&f&&!f.glyphs&&H.push(new ht(r,w,'use of "text-field" requires a style "glyphs" property')),E==="text-font"&&qs(is(w))&&dr(w.type)==="identity"&&H.push(new ht(r,w,'"text-font" does not support identity functions'))),H.concat(a({key:i.key,value:w,valueSpec:B,style:f,styleSpec:v,expressionContext:"property",propertyType:e,propertyKey:E}))}function ir(i){return ki(i,"paint")}function yr(i){return ki(i,"layout")}function mn(i){let e=[];const r=i.value,a=i.key,f=i.style,v=i.styleSpec;r.type||r.ref||e.push(new ht(a,r,'either "type" or "ref" is required'));let w=dr(r.type);const E=dr(r.ref);if(r.id){const k=dr(r.id);for(let F=0;F<i.arrayIndex;F++){const B=f.layers[F];dr(B.id)===k&&e.push(new ht(a,r.id,`duplicate layer id "${r.id}", previously used at line ${B.id.__line__}`))}}if("ref"in r){let k;["type","source","source-layer","filter","layout"].forEach(F=>{F in r&&e.push(new ht(a,r[F],`"${F}" is prohibited for ref layers`))}),f.layers.forEach(F=>{dr(F.id)===E&&(k=F)}),k?k.ref?e.push(new ht(a,r.ref,"ref cannot reference another ref layer")):w=dr(k.type):e.push(new ht(a,r.ref,`ref layer "${E}" not found`))}else if(w!=="background")if(r.source){const k=f.sources&&f.sources[r.source],F=k&&dr(k.type);k?F==="vector"&&w==="raster"?e.push(new ht(a,r.source,`layer "${r.id}" requires a raster source`)):F!=="raster-dem"&&w==="hillshade"?e.push(new ht(a,r.source,`layer "${r.id}" requires a raster-dem source`)):F==="raster"&&w!=="raster"?e.push(new ht(a,r.source,`layer "${r.id}" requires a vector source`)):F!=="vector"||r["source-layer"]?F==="raster-dem"&&w!=="hillshade"?e.push(new ht(a,r.source,"raster-dem source can only be used with layer type 'hillshade'.")):w!=="line"||!r.paint||!r.paint["line-gradient"]||F==="geojson"&&k.lineMetrics||e.push(new ht(a,r,`layer "${r.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):e.push(new ht(a,r,`layer "${r.id}" must specify a "source-layer"`)):e.push(new ht(a,r.source,`source "${r.source}" not found`))}else e.push(new ht(a,r,'missing required property "source"'));return e=e.concat(zr({key:a,value:r,valueSpec:v.layer,style:i.style,styleSpec:i.styleSpec,validateSpec:i.validateSpec,objectElementValidators:{"*":()=>[],type:()=>i.validateSpec({key:`${a}.type`,value:r.type,valueSpec:v.layer.type,style:i.style,styleSpec:i.styleSpec,validateSpec:i.validateSpec,object:r,objectKey:"type"}),filter:ni,layout:k=>zr({layer:r,key:k.key,value:k.value,style:k.style,styleSpec:k.styleSpec,validateSpec:k.validateSpec,objectElementValidators:{"*":F=>yr(Hi({layerType:w},F))}}),paint:k=>zr({layer:r,key:k.key,value:k.value,style:k.style,styleSpec:k.styleSpec,validateSpec:k.validateSpec,objectElementValidators:{"*":F=>ir(Hi({layerType:w},F))}})}})),e}function Ki(i){const e=i.value,r=i.key,a=zi(e);return a!=="string"?[new ht(r,e,`string expected, ${a} found`)]:[]}const Er={promoteId:function({key:i,value:e}){if(zi(e)==="string")return Ki({key:i,value:e});{const r=[];for(const a in e)r.push(...Ki({key:`${i}.${a}`,value:e[a]}));return r}}};function Ln(i){const e=i.value,r=i.key,a=i.styleSpec,f=i.style,v=i.validateSpec;if(!e.type)return[new ht(r,e,'"type" is required')];const w=dr(e.type);let E;switch(w){case"vector":case"raster":return E=zr({key:r,value:e,valueSpec:a[`source_${w.replace("-","_")}`],style:i.style,styleSpec:a,objectElementValidators:Er,validateSpec:v}),E;case"raster-dem":return E=function(k){var F;const B=(F=k.sourceName)!==null&&F!==void 0?F:"",j=k.value,H=k.styleSpec,Y=H.source_raster_dem,K=k.style;let re=[];const he=zi(j);if(j===void 0)return re;if(he!=="object")return re.push(new ht("source_raster_dem",j,`object expected, ${he} found`)),re;const ve=dr(j.encoding)==="custom",Be=["redFactor","greenFactor","blueFactor","baseShift"],we=k.value.encoding?`"${k.value.encoding}"`:"Default";for(const Me in j)!ve&&Be.includes(Me)?re.push(new ht(Me,j[Me],`In "${B}": "${Me}" is only valid when "encoding" is set to "custom". ${we} encoding found`)):Y[Me]?re=re.concat(k.validateSpec({key:Me,value:j[Me],valueSpec:Y[Me],validateSpec:k.validateSpec,style:K,styleSpec:H})):re.push(new ht(Me,j[Me],`unknown property "${Me}"`));return re}({sourceName:r,value:e,style:i.style,styleSpec:a,validateSpec:v}),E;case"geojson":if(E=zr({key:r,value:e,valueSpec:a.source_geojson,style:f,styleSpec:a,validateSpec:v,objectElementValidators:Er}),e.cluster)for(const k in e.clusterProperties){const[F,B]=e.clusterProperties[k],j=typeof F=="string"?[F,["accumulated"],["get",k]]:F;E.push(...tt({key:`${r}.${k}.map`,value:B,validateSpec:v,expressionContext:"cluster-map"})),E.push(...tt({key:`${r}.${k}.reduce`,value:j,validateSpec:v,expressionContext:"cluster-reduce"}))}return E;case"video":return zr({key:r,value:e,valueSpec:a.source_video,style:f,validateSpec:v,styleSpec:a});case"image":return zr({key:r,value:e,valueSpec:a.source_image,style:f,validateSpec:v,styleSpec:a});case"canvas":return[new ht(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Lt({key:`${r}.type`,value:e.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:f,validateSpec:v,styleSpec:a})}}function Hn(i){const e=i.value,r=i.styleSpec,a=r.light,f=i.style;let v=[];const w=zi(e);if(e===void 0)return v;if(w!=="object")return v=v.concat([new ht("light",e,`object expected, ${w} found`)]),v;for(const E in e){const k=E.match(/^(.*)-transition$/);v=v.concat(k&&a[k[1]]&&a[k[1]].transition?i.validateSpec({key:E,value:e[E],valueSpec:r.transition,validateSpec:i.validateSpec,style:f,styleSpec:r}):a[E]?i.validateSpec({key:E,value:e[E],valueSpec:a[E],validateSpec:i.validateSpec,style:f,styleSpec:r}):[new ht(E,e[E],`unknown property "${E}"`)])}return v}function Hr(i){const e=i.value,r=i.styleSpec,a=r.sky,f=i.style,v=zi(e);if(e===void 0)return[];if(v!=="object")return[new ht("sky",e,`object expected, ${v} found`)];let w=[];for(const E in e)w=w.concat(a[E]?fr({key:E,value:e[E],valueSpec:a[E],style:f,styleSpec:r}):[new ht(E,e[E],`unknown property "${E}"`)]);return w}function Xn(i){const e=i.value,r=i.styleSpec,a=r.terrain,f=i.style;let v=[];const w=zi(e);if(e===void 0)return v;if(w!=="object")return v=v.concat([new ht("terrain",e,`object expected, ${w} found`)]),v;for(const E in e)v=v.concat(a[E]?i.validateSpec({key:E,value:e[E],valueSpec:a[E],validateSpec:i.validateSpec,style:f,styleSpec:r}):[new ht(E,e[E],`unknown property "${E}"`)]);return v}function qn(i){let e=[];const r=i.value,a=i.key;if(Array.isArray(r)){const f=[],v=[];for(const w in r)r[w].id&&f.includes(r[w].id)&&e.push(new ht(a,r,`all the sprites' ids must be unique, but ${r[w].id} is duplicated`)),f.push(r[w].id),r[w].url&&v.includes(r[w].url)&&e.push(new ht(a,r,`all the sprites' URLs must be unique, but ${r[w].url} is duplicated`)),v.push(r[w].url),e=e.concat(zr({key:`${a}[${w}]`,value:r[w],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:i.validateSpec}));return e}return Ki({key:a,value:r})}const _s={"*":()=>[],array:Os,boolean:function(i){const e=i.value,r=i.key,a=zi(e);return a!=="boolean"?[new ht(r,e,`boolean expected, ${a} found`)]:[]},number:po,color:function(i){const e=i.key,r=i.value,a=zi(r);return a!=="string"?[new ht(e,r,`color expected, ${a} found`)]:Ni.parse(String(r))?[]:[new ht(e,r,`color expected, "${r}" found`)]},constants:fo,enum:Lt,filter:ni,function:ze,layer:mn,object:zr,source:Ln,light:Hn,sky:Hr,terrain:Xn,string:Ki,formatted:function(i){return Ki(i).length===0?[]:tt(i)},resolvedImage:function(i){return Ki(i).length===0?[]:tt(i)},padding:function(i){const e=i.key,r=i.value;if(zi(r)==="array"){if(r.length<1||r.length>4)return[new ht(e,r,`padding requires 1 to 4 values; ${r.length} values found`)];const a={type:"number"};let f=[];for(let v=0;v<r.length;v++)f=f.concat(i.validateSpec({key:`${e}[${v}]`,value:r[v],validateSpec:i.validateSpec,valueSpec:a}));return f}return po({key:e,value:r,valueSpec:{}})},variableAnchorOffsetCollection:function(i){const e=i.key,r=i.value,a=zi(r),f=i.styleSpec;if(a!=="array"||r.length<1||r.length%2!=0)return[new ht(e,r,"variableAnchorOffsetCollection requires a non-empty array of even length")];let v=[];for(let w=0;w<r.length;w+=2)v=v.concat(Lt({key:`${e}[${w}]`,value:r[w],valueSpec:f.layout_symbol["text-anchor"]})),v=v.concat(Os({key:`${e}[${w+1}]`,value:r[w+1],valueSpec:{length:2,value:"number"},validateSpec:i.validateSpec,style:i.style,styleSpec:f}));return v},sprite:qn};function fr(i){const e=i.value,r=i.valueSpec,a=i.styleSpec;return i.validateSpec=fr,r.expression&&qs(dr(e))?ze(i):r.expression&&Ji(is(e))?tt(i):r.type&&_s[r.type]?_s[r.type](i):zr(Hi({},i,{valueSpec:r.type?a[r.type]:r}))}function $n(i){const e=i.value,r=i.key,a=Ki(i);return a.length||(e.indexOf("{fontstack}")===-1&&a.push(new ht(r,e,'"glyphs" url must include a "{fontstack}" token')),e.indexOf("{range}")===-1&&a.push(new ht(r,e,'"glyphs" url must include a "{range}" token'))),a}function gn(i,e=le){let r=[];return r=r.concat(fr({key:"",value:i,valueSpec:e.$root,styleSpec:e,style:i,validateSpec:fr,objectElementValidators:{glyphs:$n,"*":()=>[]}})),i.constants&&(r=r.concat(fo({key:"constants",value:i.constants,style:i,styleSpec:e,validateSpec:fr}))),No(r)}function Yn(i){return function(e){return i({...e,validateSpec:fr})}}function No(i){return[].concat(i).sort((e,r)=>e.line-r.line)}function Pi(i){return function(...e){return No(i.apply(this,e))}}gn.source=Pi(Yn(Ln)),gn.sprite=Pi(Yn(qn)),gn.glyphs=Pi(Yn($n)),gn.light=Pi(Yn(Hn)),gn.sky=Pi(Yn(Hr)),gn.terrain=Pi(Yn(Xn)),gn.layer=Pi(Yn(mn)),gn.filter=Pi(Yn(ni)),gn.paintProperty=Pi(Yn(ir)),gn.layoutProperty=Pi(Yn(yr));const Ri=gn,Ys=Ri.light,ys=Ri.paintProperty,ha=Ri.layoutProperty;function _n(i,e){let r=!1;if(e&&e.length)for(const a of e)i.fire(new Qe(new Error(a.message))),r=!0;return r}class Rr{constructor(e,r,a){const f=this.cells=[];if(e instanceof ArrayBuffer){this.arrayBuffer=e;const w=new Int32Array(this.arrayBuffer);e=w[0],this.d=(r=w[1])+2*(a=w[2]);for(let k=0;k<this.d*this.d;k++){const F=w[3+k],B=w[3+k+1];f.push(F===B?null:w.subarray(F,B))}const E=w[3+f.length+1];this.keys=w.subarray(w[3+f.length],E),this.bboxes=w.subarray(E),this.insert=this._insertReadonly}else{this.d=r+2*a;for(let w=0;w<this.d*this.d;w++)f.push([]);this.keys=[],this.bboxes=[]}this.n=r,this.extent=e,this.padding=a,this.scale=r/e,this.uid=0;const v=a/r*e;this.min=-v,this.max=e+v}insert(e,r,a,f,v){this._forEachCell(r,a,f,v,this._insertCell,this.uid++,void 0,void 0),this.keys.push(e),this.bboxes.push(r),this.bboxes.push(a),this.bboxes.push(f),this.bboxes.push(v)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(e,r,a,f,v,w){this.cells[v].push(w)}query(e,r,a,f,v){const w=this.min,E=this.max;if(e<=w&&r<=w&&E<=a&&E<=f&&!v)return Array.prototype.slice.call(this.keys);{const k=[];return this._forEachCell(e,r,a,f,this._queryCell,k,{},v),k}}_queryCell(e,r,a,f,v,w,E,k){const F=this.cells[v];if(F!==null){const B=this.keys,j=this.bboxes;for(let H=0;H<F.length;H++){const Y=F[H];if(E[Y]===void 0){const K=4*Y;(k?k(j[K+0],j[K+1],j[K+2],j[K+3]):e<=j[K+2]&&r<=j[K+3]&&a>=j[K+0]&&f>=j[K+1])?(E[Y]=!0,w.push(B[Y])):E[Y]=!1}}}}_forEachCell(e,r,a,f,v,w,E,k){const F=this._convertToCellCoord(e),B=this._convertToCellCoord(r),j=this._convertToCellCoord(a),H=this._convertToCellCoord(f);for(let Y=F;Y<=j;Y++)for(let K=B;K<=H;K++){const re=this.d*K+Y;if((!k||k(this._convertFromCellCoord(Y),this._convertFromCellCoord(K),this._convertFromCellCoord(Y+1),this._convertFromCellCoord(K+1)))&&v.call(this,e,r,a,f,re,w,E,k))return}}_convertFromCellCoord(e){return(e-this.padding)/this.scale}_convertToCellCoord(e){return Math.max(0,Math.min(this.d-1,Math.floor(e*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const e=this.cells,r=3+this.cells.length+1+1;let a=0;for(let w=0;w<this.cells.length;w++)a+=this.cells[w].length;const f=new Int32Array(r+a+this.keys.length+this.bboxes.length);f[0]=this.extent,f[1]=this.n,f[2]=this.padding;let v=r;for(let w=0;w<e.length;w++){const E=e[w];f[3+w]=v,f.set(E,v),v+=E.length}return f[3+e.length]=v,f.set(this.keys,v),v+=this.keys.length,f[3+e.length+1]=v,f.set(this.bboxes,v),v+=this.bboxes.length,f.buffer}static serialize(e,r){const a=e.toArrayBuffer();return r&&r.push(a),{buffer:a}}static deserialize(e){return new Rr(e.buffer)}}const Qr={};function Nt(i,e,r={}){if(Qr[i])throw new Error(`${i} is already registered.`);Object.defineProperty(e,"_classRegistryKey",{value:i,writeable:!1}),Qr[i]={klass:e,omit:r.omit||[],shallow:r.shallow||[]}}Nt("Object",Object),Nt("TransferableGridIndex",Rr),Nt("Color",Ni),Nt("Error",Error),Nt("AJAXError",Je),Nt("ResolvedImage",Kr),Nt("StylePropertyFunction",Ra),Nt("StyleExpression",Cn,{omit:["_evaluator"]}),Nt("ZoomDependentExpression",ca),Nt("ZoomConstantExpression",Wn),Nt("CompoundExpression",Ei,{omit:["_evaluate"]});for(const i in Xs)Xs[i]._classRegistryKey||Nt(`Expression_${i}`,Xs[i]);function Zs(i){return i&&typeof ArrayBuffer<"u"&&(i instanceof ArrayBuffer||i.constructor&&i.constructor.name==="ArrayBuffer")}function Sn(i,e){if(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||i instanceof Blob||i instanceof Error)return i;if(Zs(i)||Et(i))return e&&e.push(i),i;if(ArrayBuffer.isView(i)){const r=i;return e&&e.push(r.buffer),r}if(i instanceof ImageData)return e&&e.push(i.data.buffer),i;if(Array.isArray(i)){const r=[];for(const a of i)r.push(Sn(a,e));return r}if(typeof i=="object"){const r=i.constructor,a=r._classRegistryKey;if(!a)throw new Error(`can't serialize object of unregistered class ${r.name}`);if(!Qr[a])throw new Error(`${a} is not registered.`);const f=r.serialize?r.serialize(i,e):{};if(r.serialize){if(e&&f===e[e.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const v in i){if(!i.hasOwnProperty(v)||Qr[a].omit.indexOf(v)>=0)continue;const w=i[v];f[v]=Qr[a].shallow.indexOf(v)>=0?w:Sn(w,e)}i instanceof Error&&(f.message=i.message)}if(f.$name)throw new Error("$name property is reserved for worker serialization logic.");return a!=="Object"&&(f.$name=a),f}throw new Error("can't serialize object of type "+typeof i)}function Tn(i){if(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||i instanceof Blob||i instanceof Error||Zs(i)||Et(i)||ArrayBuffer.isView(i)||i instanceof ImageData)return i;if(Array.isArray(i))return i.map(Tn);if(typeof i=="object"){const e=i.$name||"Object";if(!Qr[e])throw new Error(`can't deserialize unregistered class ${e}`);const{klass:r}=Qr[e];if(!r)throw new Error(`can't deserialize unregistered class ${e}`);if(r.deserialize)return r.deserialize(i);const a=Object.create(r.prototype);for(const f of Object.keys(i)){if(f==="$name")continue;const v=i[f];a[f]=Qr[e].shallow.indexOf(f)>=0?v:Tn(v)}return a}throw new Error("can't deserialize object of type "+typeof i)}class Va{constructor(){this.first=!0}update(e,r){const a=Math.floor(e);return this.first?(this.first=!1,this.lastIntegerZoom=a,this.lastIntegerZoomTime=0,this.lastZoom=e,this.lastFloorZoom=a,!0):(this.lastFloorZoom>a?(this.lastIntegerZoom=a+1,this.lastIntegerZoomTime=r):this.lastFloorZoom<a&&(this.lastIntegerZoom=a,this.lastIntegerZoomTime=r),e!==this.lastZoom&&(this.lastZoom=e,this.lastFloorZoom=a,!0))}}const Bt={"Latin-1 Supplement":i=>i>=128&&i<=255,Arabic:i=>i>=1536&&i<=1791,"Arabic Supplement":i=>i>=1872&&i<=1919,"Arabic Extended-A":i=>i>=2208&&i<=2303,"Hangul Jamo":i=>i>=4352&&i<=4607,"Unified Canadian Aboriginal Syllabics":i=>i>=5120&&i<=5759,Khmer:i=>i>=6016&&i<=6143,"Unified Canadian Aboriginal Syllabics Extended":i=>i>=6320&&i<=6399,"General Punctuation":i=>i>=8192&&i<=8303,"Letterlike Symbols":i=>i>=8448&&i<=8527,"Number Forms":i=>i>=8528&&i<=8591,"Miscellaneous Technical":i=>i>=8960&&i<=9215,"Control Pictures":i=>i>=9216&&i<=9279,"Optical Character Recognition":i=>i>=9280&&i<=9311,"Enclosed Alphanumerics":i=>i>=9312&&i<=9471,"Geometric Shapes":i=>i>=9632&&i<=9727,"Miscellaneous Symbols":i=>i>=9728&&i<=9983,"Miscellaneous Symbols and Arrows":i=>i>=11008&&i<=11263,"CJK Radicals Supplement":i=>i>=11904&&i<=12031,"Kangxi Radicals":i=>i>=12032&&i<=12255,"Ideographic Description Characters":i=>i>=12272&&i<=12287,"CJK Symbols and Punctuation":i=>i>=12288&&i<=12351,Hiragana:i=>i>=12352&&i<=12447,Katakana:i=>i>=12448&&i<=12543,Bopomofo:i=>i>=12544&&i<=12591,"Hangul Compatibility Jamo":i=>i>=12592&&i<=12687,Kanbun:i=>i>=12688&&i<=12703,"Bopomofo Extended":i=>i>=12704&&i<=12735,"CJK Strokes":i=>i>=12736&&i<=12783,"Katakana Phonetic Extensions":i=>i>=12784&&i<=12799,"Enclosed CJK Letters and Months":i=>i>=12800&&i<=13055,"CJK Compatibility":i=>i>=13056&&i<=13311,"CJK Unified Ideographs Extension A":i=>i>=13312&&i<=19903,"Yijing Hexagram Symbols":i=>i>=19904&&i<=19967,"CJK Unified Ideographs":i=>i>=19968&&i<=40959,"Yi Syllables":i=>i>=40960&&i<=42127,"Yi Radicals":i=>i>=42128&&i<=42191,"Hangul Jamo Extended-A":i=>i>=43360&&i<=43391,"Hangul Syllables":i=>i>=44032&&i<=55215,"Hangul Jamo Extended-B":i=>i>=55216&&i<=55295,"Private Use Area":i=>i>=57344&&i<=63743,"CJK Compatibility Ideographs":i=>i>=63744&&i<=64255,"Arabic Presentation Forms-A":i=>i>=64336&&i<=65023,"Vertical Forms":i=>i>=65040&&i<=65055,"CJK Compatibility Forms":i=>i>=65072&&i<=65103,"Small Form Variants":i=>i>=65104&&i<=65135,"Arabic Presentation Forms-B":i=>i>=65136&&i<=65279,"Halfwidth and Fullwidth Forms":i=>i>=65280&&i<=65519};function Ls(i){for(const e of i)if(da(e.charCodeAt(0)))return!0;return!1}function Fs(i){for(const e of i)if(!ua(e.charCodeAt(0)))return!1;return!0}function ua(i){return!(Bt.Arabic(i)||Bt["Arabic Supplement"](i)||Bt["Arabic Extended-A"](i)||Bt["Arabic Presentation Forms-A"](i)||Bt["Arabic Presentation Forms-B"](i))}function da(i){return!(i!==746&&i!==747&&(i<4352||!(Bt["Bopomofo Extended"](i)||Bt.Bopomofo(i)||Bt["CJK Compatibility Forms"](i)&&!(i>=65097&&i<=65103)||Bt["CJK Compatibility Ideographs"](i)||Bt["CJK Compatibility"](i)||Bt["CJK Radicals Supplement"](i)||Bt["CJK Strokes"](i)||!(!Bt["CJK Symbols and Punctuation"](i)||i>=12296&&i<=12305||i>=12308&&i<=12319||i===12336)||Bt["CJK Unified Ideographs Extension A"](i)||Bt["CJK Unified Ideographs"](i)||Bt["Enclosed CJK Letters and Months"](i)||Bt["Hangul Compatibility Jamo"](i)||Bt["Hangul Jamo Extended-A"](i)||Bt["Hangul Jamo Extended-B"](i)||Bt["Hangul Jamo"](i)||Bt["Hangul Syllables"](i)||Bt.Hiragana(i)||Bt["Ideographic Description Characters"](i)||Bt.Kanbun(i)||Bt["Kangxi Radicals"](i)||Bt["Katakana Phonetic Extensions"](i)||Bt.Katakana(i)&&i!==12540||!(!Bt["Halfwidth and Fullwidth Forms"](i)||i===65288||i===65289||i===65293||i>=65306&&i<=65310||i===65339||i===65341||i===65343||i>=65371&&i<=65503||i===65507||i>=65512&&i<=65519)||!(!Bt["Small Form Variants"](i)||i>=65112&&i<=65118||i>=65123&&i<=65126)||Bt["Unified Canadian Aboriginal Syllabics"](i)||Bt["Unified Canadian Aboriginal Syllabics Extended"](i)||Bt["Vertical Forms"](i)||Bt["Yijing Hexagram Symbols"](i)||Bt["Yi Syllables"](i)||Bt["Yi Radicals"](i))))}function Ks(i){return!(da(i)||function(e){return!!(Bt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Bt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Bt["Letterlike Symbols"](e)||Bt["Number Forms"](e)||Bt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Bt["Control Pictures"](e)&&e!==9251||Bt["Optical Character Recognition"](e)||Bt["Enclosed Alphanumerics"](e)||Bt["Geometric Shapes"](e)||Bt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Bt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Bt["CJK Symbols and Punctuation"](e)||Bt.Katakana(e)||Bt["Private Use Area"](e)||Bt["CJK Compatibility Forms"](e)||Bt["Small Form Variants"](e)||Bt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(i))}function Js(i){return i>=1424&&i<=2303||Bt["Arabic Presentation Forms-A"](i)||Bt["Arabic Presentation Forms-B"](i)}function gl(i,e){return!(!e&&Js(i)||i>=2304&&i<=3583||i>=3840&&i<=4255||Bt.Khmer(i))}function Ql(i){for(const e of i)if(Js(e.charCodeAt(0)))return!0;return!1}const fa=new class{constructor(){this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null}setState(i){this.pluginStatus=i.pluginStatus,this.pluginURL=i.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(i){this.applyArabicShaping=i.applyArabicShaping,this.processBidirectionalText=i.processBidirectionalText,this.processStyledBidirectionalText=i.processStyledBidirectionalText}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getPluginURL(){return this.pluginURL}getRTLTextPluginStatus(){return this.pluginStatus}};class ar{constructor(e,r){this.zoom=e,r?(this.now=r.now,this.fadeDuration=r.fadeDuration,this.zoomHistory=r.zoomHistory,this.transition=r.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new Va,this.transition={})}isSupportedScript(e){return function(r,a){for(const f of r)if(!gl(f.charCodeAt(0),a))return!1;return!0}(e,fa.getRTLTextPluginStatus()==="loaded")}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const e=this.zoom,r=e-Math.floor(e),a=this.crossFadingFactor();return e>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:r+(1-r)*a}:{fromScale:.5,toScale:1,t:1-(1-a)*r}}}class Vo{constructor(e,r){this.property=e,this.value=r,this.expression=function(a,f){if(qs(a))return new Ra(a,f);if(Ji(a)){const v=ao(a,f);if(v.result==="error")throw new Error(v.value.map(w=>`${w.key}: ${w.message}`).join(", "));return v.value}{let v=a;return f.type==="color"&&typeof a=="string"?v=Ni.parse(a):f.type!=="padding"||typeof a!="number"&&!Array.isArray(a)?f.type==="variableAnchorOffsetCollection"&&Array.isArray(a)&&(v=tr.parse(a)):v=an.parse(a),{kind:"constant",evaluate:()=>v}}}(r===void 0?e.specification.default:r,e.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,r,a){return this.property.possiblyEvaluate(this,e,r,a)}}class Uo{constructor(e){this.property=e,this.value=new Vo(e,void 0)}transitioned(e,r){return new yl(this.property,this.value,r,ne({},e.transition,this.transition),e.now)}untransitioned(){return new yl(this.property,this.value,null,{},0)}}class _l{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues)}getValue(e){return at(this._values[e].value.value)}setValue(e,r){Object.prototype.hasOwnProperty.call(this._values,e)||(this._values[e]=new Uo(this._values[e].property)),this._values[e].value=new Vo(this._values[e].property,r===null?void 0:at(r))}getTransition(e){return at(this._values[e].transition)}setTransition(e,r){Object.prototype.hasOwnProperty.call(this._values,e)||(this._values[e]=new Uo(this._values[e].property)),this._values[e].transition=at(r)||void 0}serialize(){const e={};for(const r of Object.keys(this._values)){const a=this.getValue(r);a!==void 0&&(e[r]=a);const f=this.getTransition(r);f!==void 0&&(e[`${r}-transition`]=f)}return e}transitioned(e,r){const a=new ec(this._properties);for(const f of Object.keys(this._values))a._values[f]=this._values[f].transitioned(e,r._values[f]);return a}untransitioned(){const e=new ec(this._properties);for(const r of Object.keys(this._values))e._values[r]=this._values[r].untransitioned();return e}}class yl{constructor(e,r,a,f,v){this.property=e,this.value=r,this.begin=v+f.delay||0,this.end=this.begin+f.duration||0,e.specification.transition&&(f.delay||f.duration)&&(this.prior=a)}possiblyEvaluate(e,r,a){const f=e.now||0,v=this.value.possiblyEvaluate(e,r,a),w=this.prior;if(w){if(f>this.end)return this.prior=null,v;if(this.value.isDataDriven())return this.prior=null,v;if(f<this.begin)return w.possiblyEvaluate(e,r,a);{const E=(f-this.begin)/(this.end-this.begin);return this.property.interpolate(w.possiblyEvaluate(e,r,a),v,function(k){if(k<=0)return 0;if(k>=1)return 1;const F=k*k,B=F*k;return 4*(k<.5?B:3*(k-F)+B-.75)}(E))}}return v}}class ec{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,r,a){const f=new mo(this._properties);for(const v of Object.keys(this._values))f._values[v]=this._values[v].possiblyEvaluate(e,r,a);return f}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Oc{constructor(e){this._properties=e,this._values=Object.create(e.defaultPropertyValues)}hasValue(e){return this._values[e].value!==void 0}getValue(e){return at(this._values[e].value)}setValue(e,r){this._values[e]=new Vo(this._values[e].property,r===null?void 0:at(r))}serialize(){const e={};for(const r of Object.keys(this._values)){const a=this.getValue(r);a!==void 0&&(e[r]=a)}return e}possiblyEvaluate(e,r,a){const f=new mo(this._properties);for(const v of Object.keys(this._values))f._values[v]=this._values[v].possiblyEvaluate(e,r,a);return f}}class rs{constructor(e,r,a){this.property=e,this.value=r,this.parameters=a}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,r,a,f){return this.property.evaluate(this.value,this.parameters,e,r,a,f)}}class mo{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class ii{constructor(e){this.specification=e}possiblyEvaluate(e,r){if(e.isDataDriven())throw new Error("Value should not be data driven");return e.expression.evaluate(r)}interpolate(e,r,a){const f=ln[this.specification.type];return f?f(e,r,a):e}}class hi{constructor(e,r){this.specification=e,this.overrides=r}possiblyEvaluate(e,r,a,f){return new rs(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(r,null,{},a,f)}:e.expression,r)}interpolate(e,r,a){if(e.value.kind!=="constant"||r.value.kind!=="constant")return e;if(e.value.value===void 0||r.value.value===void 0)return new rs(this,{kind:"constant",value:void 0},e.parameters);const f=ln[this.specification.type];if(f){const v=f(e.value.value,r.value.value,a);return new rs(this,{kind:"constant",value:v},e.parameters)}return e}evaluate(e,r,a,f,v,w){return e.kind==="constant"?e.value:e.evaluate(r,a,f,v,w)}}class pa extends hi{possiblyEvaluate(e,r,a,f){if(e.value===void 0)return new rs(this,{kind:"constant",value:void 0},r);if(e.expression.kind==="constant"){const v=e.expression.evaluate(r,null,{},a,f),w=e.property.specification.type==="resolvedImage"&&typeof v!="string"?v.name:v,E=this._calculate(w,w,w,r);return new rs(this,{kind:"constant",value:E},r)}if(e.expression.kind==="camera"){const v=this._calculate(e.expression.evaluate({zoom:r.zoom-1}),e.expression.evaluate({zoom:r.zoom}),e.expression.evaluate({zoom:r.zoom+1}),r);return new rs(this,{kind:"constant",value:v},r)}return new rs(this,e.expression,r)}evaluate(e,r,a,f,v,w){if(e.kind==="source"){const E=e.evaluate(r,a,f,v,w);return this._calculate(E,E,E,r)}return e.kind==="composite"?this._calculate(e.evaluate({zoom:Math.floor(r.zoom)-1},a,f),e.evaluate({zoom:Math.floor(r.zoom)},a,f),e.evaluate({zoom:Math.floor(r.zoom)+1},a,f),r):e.value}_calculate(e,r,a,f){return f.zoom>f.zoomHistory.lastIntegerZoom?{from:e,to:r}:{from:a,to:r}}interpolate(e){return e}}class vl{constructor(e){this.specification=e}possiblyEvaluate(e,r,a,f){if(e.value!==void 0){if(e.expression.kind==="constant"){const v=e.expression.evaluate(r,null,{},a,f);return this._calculate(v,v,v,r)}return this._calculate(e.expression.evaluate(new ar(Math.floor(r.zoom-1),r)),e.expression.evaluate(new ar(Math.floor(r.zoom),r)),e.expression.evaluate(new ar(Math.floor(r.zoom+1),r)),r)}}_calculate(e,r,a,f){return f.zoom>f.zoomHistory.lastIntegerZoom?{from:e,to:r}:{from:a,to:r}}interpolate(e){return e}}class go{constructor(e){this.specification=e}possiblyEvaluate(e,r,a,f){return!!e.expression.evaluate(r,null,{},a,f)}interpolate(){return!1}}class En{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const r in e){const a=e[r];a.specification.overridable&&this.overridableProperties.push(r);const f=this.defaultPropertyValues[r]=new Vo(a,void 0),v=this.defaultTransitionablePropertyValues[r]=new Uo(a);this.defaultTransitioningPropertyValues[r]=v.untransitioned(),this.defaultPossiblyEvaluatedValues[r]=f.possiblyEvaluate({})}}}Nt("DataDrivenProperty",hi),Nt("DataConstantProperty",ii),Nt("CrossFadedDataDrivenProperty",pa),Nt("CrossFadedProperty",vl),Nt("ColorRampProperty",go);const tc="-transition";class ns extends Xe{constructor(e,r){if(super(),this.id=e.id,this.type=e.type,this._featureFilter={filter:()=>!0,needGeometry:!1},e.type!=="custom"&&(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type!=="background"&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),r.layout&&(this._unevaluatedLayout=new Oc(r.layout)),r.paint)){this._transitionablePaint=new _l(r.paint);for(const a in e.paint)this.setPaintProperty(a,e.paint[a],{validate:!1});for(const a in e.layout)this.setLayoutProperty(a,e.layout[a],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new mo(r.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,r,a={}){r!=null&&this._validate(ha,`layers.${this.id}.layout.${e}`,e,r,a)||(e!=="visibility"?this._unevaluatedLayout.setValue(e,r):this.visibility=r)}getPaintProperty(e){return e.endsWith(tc)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,r,a={}){if(r!=null&&this._validate(ys,`layers.${this.id}.paint.${e}`,e,r,a))return!1;if(e.endsWith(tc))return this._transitionablePaint.setTransition(e.slice(0,-11),r||void 0),!1;{const f=this._transitionablePaint._values[e],v=f.property.specification["property-type"]==="cross-faded-data-driven",w=f.value.isDataDriven(),E=f.value;this._transitionablePaint.setValue(e,r),this._handleSpecialPaintPropertyUpdate(e);const k=this._transitionablePaint._values[e].value;return k.isDataDriven()||w||v||this._handleOverridablePaintPropertyUpdate(e,E,k)}}_handleSpecialPaintPropertyUpdate(e){}_handleOverridablePaintPropertyUpdate(e,r,a){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,r){e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,r)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,r)}serialize(){const e={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(e.layout=e.layout||{},e.layout.visibility=this.visibility),Ke(e,(r,a)=>!(r===void 0||a==="layout"&&!Object.keys(r).length||a==="paint"&&!Object.keys(r).length))}_validate(e,r,a,f,v={}){return(!v||v.validate!==!1)&&_n(this,e.call(Ri,{key:r,layerType:this.type,objectKey:a,value:f,styleSpec:le,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const e in this.paint._values){const r=this.paint.get(e);if(r instanceof rs&&Gn(r.property.specification)&&(r.value.kind==="source"||r.value.kind==="composite")&&r.value.isStateDependent)return!0}return!1}}const ic={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Ua{constructor(e,r){this._structArray=e,this._pos1=r*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Cr{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,r){return e._trim(),r&&(e.isTransferred=!0,r.push(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const r=Object.create(this.prototype);return r.arrayBuffer=e.arrayBuffer,r.length=e.length,r.capacity=e.arrayBuffer.byteLength/r.bytesPerElement,r._refreshViews(),r}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const r=this.uint8;this._refreshViews(),r&&this.uint8.set(r)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function Pr(i,e=1){let r=0,a=0;return{members:i.map(f=>{const v=ic[f.type].BYTES_PER_ELEMENT,w=r=rc(r,Math.max(e,v)),E=f.components||1;return a=Math.max(a,v),r+=v*E,{name:f.name,type:f.type,components:E,offset:w}}),size:rc(r,Math.max(a,e)),alignment:e}}function rc(i,e){return Math.ceil(i/e)*e}class _o extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r){const a=this.length;return this.resize(a+1),this.emplace(a,e,r)}emplace(e,r,a){const f=2*e;return this.int16[f+0]=r,this.int16[f+1]=a,e}}_o.prototype.bytesPerElement=4,Nt("StructArrayLayout2i4",_o);class Go extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,a){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,a)}emplace(e,r,a,f){const v=3*e;return this.int16[v+0]=r,this.int16[v+1]=a,this.int16[v+2]=f,e}}Go.prototype.bytesPerElement=6,Nt("StructArrayLayout3i6",Go);class Qs extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,a,f){const v=this.length;return this.resize(v+1),this.emplace(v,e,r,a,f)}emplace(e,r,a,f,v){const w=4*e;return this.int16[w+0]=r,this.int16[w+1]=a,this.int16[w+2]=f,this.int16[w+3]=v,e}}Qs.prototype.bytesPerElement=8,Nt("StructArrayLayout4i8",Qs);class xl extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,a,f,v,w){const E=this.length;return this.resize(E+1),this.emplace(E,e,r,a,f,v,w)}emplace(e,r,a,f,v,w,E){const k=6*e;return this.int16[k+0]=r,this.int16[k+1]=a,this.int16[k+2]=f,this.int16[k+3]=v,this.int16[k+4]=w,this.int16[k+5]=E,e}}xl.prototype.bytesPerElement=12,Nt("StructArrayLayout2i4i12",xl);class bl extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,a,f,v,w){const E=this.length;return this.resize(E+1),this.emplace(E,e,r,a,f,v,w)}emplace(e,r,a,f,v,w,E){const k=4*e,F=8*e;return this.int16[k+0]=r,this.int16[k+1]=a,this.uint8[F+4]=f,this.uint8[F+5]=v,this.uint8[F+6]=w,this.uint8[F+7]=E,e}}bl.prototype.bytesPerElement=8,Nt("StructArrayLayout2i4ub8",bl);class yo extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r){const a=this.length;return this.resize(a+1),this.emplace(a,e,r)}emplace(e,r,a){const f=2*e;return this.float32[f+0]=r,this.float32[f+1]=a,e}}yo.prototype.bytesPerElement=8,Nt("StructArrayLayout2f8",yo);class wl extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,a,f,v,w,E,k,F,B){const j=this.length;return this.resize(j+1),this.emplace(j,e,r,a,f,v,w,E,k,F,B)}emplace(e,r,a,f,v,w,E,k,F,B,j){const H=10*e;return this.uint16[H+0]=r,this.uint16[H+1]=a,this.uint16[H+2]=f,this.uint16[H+3]=v,this.uint16[H+4]=w,this.uint16[H+5]=E,this.uint16[H+6]=k,this.uint16[H+7]=F,this.uint16[H+8]=B,this.uint16[H+9]=j,e}}wl.prototype.bytesPerElement=20,Nt("StructArrayLayout10ui20",wl);class Wo extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,a,f,v,w,E,k,F,B,j,H){const Y=this.length;return this.resize(Y+1),this.emplace(Y,e,r,a,f,v,w,E,k,F,B,j,H)}emplace(e,r,a,f,v,w,E,k,F,B,j,H,Y){const K=12*e;return this.int16[K+0]=r,this.int16[K+1]=a,this.int16[K+2]=f,this.int16[K+3]=v,this.uint16[K+4]=w,this.uint16[K+5]=E,this.uint16[K+6]=k,this.uint16[K+7]=F,this.int16[K+8]=B,this.int16[K+9]=j,this.int16[K+10]=H,this.int16[K+11]=Y,e}}Wo.prototype.bytesPerElement=24,Nt("StructArrayLayout4i4ui4i24",Wo);class Cl extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,a){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,a)}emplace(e,r,a,f){const v=3*e;return this.float32[v+0]=r,this.float32[v+1]=a,this.float32[v+2]=f,e}}Cl.prototype.bytesPerElement=12,Nt("StructArrayLayout3f12",Cl);class Sl extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint32[1*e+0]=r,e}}Sl.prototype.bytesPerElement=4,Nt("StructArrayLayout1ul4",Sl);class zs extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,a,f,v,w,E,k,F){const B=this.length;return this.resize(B+1),this.emplace(B,e,r,a,f,v,w,E,k,F)}emplace(e,r,a,f,v,w,E,k,F,B){const j=10*e,H=5*e;return this.int16[j+0]=r,this.int16[j+1]=a,this.int16[j+2]=f,this.int16[j+3]=v,this.int16[j+4]=w,this.int16[j+5]=E,this.uint32[H+3]=k,this.uint16[j+8]=F,this.uint16[j+9]=B,e}}zs.prototype.bytesPerElement=20,Nt("StructArrayLayout6i1ul2ui20",zs);class Ho extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,a,f,v,w){const E=this.length;return this.resize(E+1),this.emplace(E,e,r,a,f,v,w)}emplace(e,r,a,f,v,w,E){const k=6*e;return this.int16[k+0]=r,this.int16[k+1]=a,this.int16[k+2]=f,this.int16[k+3]=v,this.int16[k+4]=w,this.int16[k+5]=E,e}}Ho.prototype.bytesPerElement=12,Nt("StructArrayLayout2i2i2i12",Ho);class vo extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,a,f,v){const w=this.length;return this.resize(w+1),this.emplace(w,e,r,a,f,v)}emplace(e,r,a,f,v,w){const E=4*e,k=8*e;return this.float32[E+0]=r,this.float32[E+1]=a,this.float32[E+2]=f,this.int16[k+6]=v,this.int16[k+7]=w,e}}vo.prototype.bytesPerElement=16,Nt("StructArrayLayout2f1f2i16",vo);class Xo extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,a,f){const v=this.length;return this.resize(v+1),this.emplace(v,e,r,a,f)}emplace(e,r,a,f,v){const w=12*e,E=3*e;return this.uint8[w+0]=r,this.uint8[w+1]=a,this.float32[E+1]=f,this.float32[E+2]=v,e}}Xo.prototype.bytesPerElement=12,Nt("StructArrayLayout2ub2f12",Xo);class Ga extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,a){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,a)}emplace(e,r,a,f){const v=3*e;return this.uint16[v+0]=r,this.uint16[v+1]=a,this.uint16[v+2]=f,e}}Ga.prototype.bytesPerElement=6,Nt("StructArrayLayout3ui6",Ga);class Tl extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,a,f,v,w,E,k,F,B,j,H,Y,K,re,he,ve){const Be=this.length;return this.resize(Be+1),this.emplace(Be,e,r,a,f,v,w,E,k,F,B,j,H,Y,K,re,he,ve)}emplace(e,r,a,f,v,w,E,k,F,B,j,H,Y,K,re,he,ve,Be){const we=24*e,Me=12*e,st=48*e;return this.int16[we+0]=r,this.int16[we+1]=a,this.uint16[we+2]=f,this.uint16[we+3]=v,this.uint32[Me+2]=w,this.uint32[Me+3]=E,this.uint32[Me+4]=k,this.uint16[we+10]=F,this.uint16[we+11]=B,this.uint16[we+12]=j,this.float32[Me+7]=H,this.float32[Me+8]=Y,this.uint8[st+36]=K,this.uint8[st+37]=re,this.uint8[st+38]=he,this.uint32[Me+10]=ve,this.int16[we+22]=Be,e}}Tl.prototype.bytesPerElement=48,Nt("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",Tl);class Wa extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,a,f,v,w,E,k,F,B,j,H,Y,K,re,he,ve,Be,we,Me,st,pt,Gt,ei,Vt,Rt,kt,$t){const zt=this.length;return this.resize(zt+1),this.emplace(zt,e,r,a,f,v,w,E,k,F,B,j,H,Y,K,re,he,ve,Be,we,Me,st,pt,Gt,ei,Vt,Rt,kt,$t)}emplace(e,r,a,f,v,w,E,k,F,B,j,H,Y,K,re,he,ve,Be,we,Me,st,pt,Gt,ei,Vt,Rt,kt,$t,zt){const It=32*e,oi=16*e;return this.int16[It+0]=r,this.int16[It+1]=a,this.int16[It+2]=f,this.int16[It+3]=v,this.int16[It+4]=w,this.int16[It+5]=E,this.int16[It+6]=k,this.int16[It+7]=F,this.uint16[It+8]=B,this.uint16[It+9]=j,this.uint16[It+10]=H,this.uint16[It+11]=Y,this.uint16[It+12]=K,this.uint16[It+13]=re,this.uint16[It+14]=he,this.uint16[It+15]=ve,this.uint16[It+16]=Be,this.uint16[It+17]=we,this.uint16[It+18]=Me,this.uint16[It+19]=st,this.uint16[It+20]=pt,this.uint16[It+21]=Gt,this.uint16[It+22]=ei,this.uint32[oi+12]=Vt,this.float32[oi+13]=Rt,this.float32[oi+14]=kt,this.uint16[It+30]=$t,this.uint16[It+31]=zt,e}}Wa.prototype.bytesPerElement=64,Nt("StructArrayLayout8i15ui1ul2f2ui64",Wa);class ea extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.float32[1*e+0]=r,e}}ea.prototype.bytesPerElement=4,Nt("StructArrayLayout1f4",ea);class El extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,a){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,a)}emplace(e,r,a,f){const v=3*e;return this.uint16[6*e+0]=r,this.float32[v+1]=a,this.float32[v+2]=f,e}}El.prototype.bytesPerElement=12,Nt("StructArrayLayout1ui2f12",El);class qo extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,a){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,a)}emplace(e,r,a,f){const v=4*e;return this.uint32[2*e+0]=r,this.uint16[v+2]=a,this.uint16[v+3]=f,e}}qo.prototype.bytesPerElement=8,Nt("StructArrayLayout1ul2ui8",qo);class ma extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r){const a=this.length;return this.resize(a+1),this.emplace(a,e,r)}emplace(e,r,a){const f=2*e;return this.uint16[f+0]=r,this.uint16[f+1]=a,e}}ma.prototype.bytesPerElement=4,Nt("StructArrayLayout2ui4",ma);class Il extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint16[1*e+0]=r,e}}Il.prototype.bytesPerElement=2,Nt("StructArrayLayout1ui2",Il);class Pl extends Cr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,a,f){const v=this.length;return this.resize(v+1),this.emplace(v,e,r,a,f)}emplace(e,r,a,f,v){const w=4*e;return this.float32[w+0]=r,this.float32[w+1]=a,this.float32[w+2]=f,this.float32[w+3]=v,e}}Pl.prototype.bytesPerElement=16,Nt("StructArrayLayout4f16",Pl);class Al extends Ua{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new o(this.anchorPointX,this.anchorPointY)}}Al.prototype.size=20;class nc extends zs{get(e){return new Al(this,e)}}Nt("CollisionBoxArray",nc);class g extends Ua{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(e){this._structArray.uint8[this._pos1+37]=e}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(e){this._structArray.uint8[this._pos1+38]=e}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(e){this._structArray.uint32[this._pos4+10]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}g.prototype.size=48;class t extends Tl{get(e){return new g(this,e)}}Nt("PlacedSymbolArray",t);class n extends Ua{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(e){this._structArray.uint32[this._pos4+12]=e}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}n.prototype.size=64;class l extends Wa{get(e){return new n(this,e)}}Nt("SymbolInstanceArray",l);class d extends ea{getoffsetX(e){return this.float32[1*e+0]}}Nt("GlyphOffsetArray",d);class y extends Go{getx(e){return this.int16[3*e+0]}gety(e){return this.int16[3*e+1]}gettileUnitDistanceFromAnchor(e){return this.int16[3*e+2]}}Nt("SymbolLineVertexArray",y);class P extends Ua{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}P.prototype.size=12;class A extends El{get(e){return new P(this,e)}}Nt("TextAnchorOffsetArray",A);class O extends Ua{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}O.prototype.size=8;class R extends qo{get(e){return new O(this,e)}}Nt("FeatureIndexArray",R);class N extends _o{}class G extends _o{}class Z extends _o{}class ce extends xl{}class oe extends bl{}class ue extends yo{}class te extends wl{}class Se extends Wo{}class We extends Cl{}class ge extends Sl{}class ke extends Ho{}class He extends Xo{}class qe extends Ga{}class rt extends ma{}const Ct=Pr([{name:"a_pos",components:2,type:"Int16"}],4),{members:_t}=Ct;class wt{constructor(e=[]){this.segments=e}prepareSegment(e,r,a,f){let v=this.segments[this.segments.length-1];return e>wt.MAX_VERTEX_ARRAY_LENGTH&&ut(`Max vertices per segment is ${wt.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!v||v.vertexLength+e>wt.MAX_VERTEX_ARRAY_LENGTH||v.sortKey!==f)&&(v={vertexOffset:r.length,primitiveOffset:a.length,vertexLength:0,primitiveLength:0},f!==void 0&&(v.sortKey=f),this.segments.push(v)),v}get(){return this.segments}destroy(){for(const e of this.segments)for(const r in e.vaos)e.vaos[r].destroy()}static simpleSegment(e,r,a,f){return new wt([{vertexOffset:e,primitiveOffset:r,vertexLength:a,primitiveLength:f,vaos:{},sortKey:0}])}}function Xt(i,e){return 256*(i=U(Math.floor(i),0,255))+U(Math.floor(e),0,255)}wt.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Nt("SegmentVector",wt);const vi=Pr([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var Ft={exports:{}},di={exports:{}};di.exports=function(i,e){var r,a,f,v,w,E,k,F;for(a=i.length-(r=3&i.length),f=e,w=3432918353,E=461845907,F=0;F<a;)k=255&i.charCodeAt(F)|(255&i.charCodeAt(++F))<<8|(255&i.charCodeAt(++F))<<16|(255&i.charCodeAt(++F))<<24,++F,f=27492+(65535&(v=5*(65535&(f=(f^=k=(65535&(k=(k=(65535&k)*w+(((k>>>16)*w&65535)<<16)&4294967295)<<15|k>>>17))*E+(((k>>>16)*E&65535)<<16)&4294967295)<<13|f>>>19))+((5*(f>>>16)&65535)<<16)&4294967295))+((58964+(v>>>16)&65535)<<16);switch(k=0,r){case 3:k^=(255&i.charCodeAt(F+2))<<16;case 2:k^=(255&i.charCodeAt(F+1))<<8;case 1:f^=k=(65535&(k=(k=(65535&(k^=255&i.charCodeAt(F)))*w+(((k>>>16)*w&65535)<<16)&4294967295)<<15|k>>>17))*E+(((k>>>16)*E&65535)<<16)&4294967295}return f^=i.length,f=2246822507*(65535&(f^=f>>>16))+((2246822507*(f>>>16)&65535)<<16)&4294967295,f=3266489909*(65535&(f^=f>>>13))+((3266489909*(f>>>16)&65535)<<16)&4294967295,(f^=f>>>16)>>>0};var Ci=di.exports,Oi={exports:{}};Oi.exports=function(i,e){for(var r,a=i.length,f=e^a,v=0;a>=4;)r=1540483477*(65535&(r=255&i.charCodeAt(v)|(255&i.charCodeAt(++v))<<8|(255&i.charCodeAt(++v))<<16|(255&i.charCodeAt(++v))<<24))+((1540483477*(r>>>16)&65535)<<16),f=1540483477*(65535&f)+((1540483477*(f>>>16)&65535)<<16)^(r=1540483477*(65535&(r^=r>>>24))+((1540483477*(r>>>16)&65535)<<16)),a-=4,++v;switch(a){case 3:f^=(255&i.charCodeAt(v+2))<<16;case 2:f^=(255&i.charCodeAt(v+1))<<8;case 1:f=1540483477*(65535&(f^=255&i.charCodeAt(v)))+((1540483477*(f>>>16)&65535)<<16)}return f=1540483477*(65535&(f^=f>>>13))+((1540483477*(f>>>16)&65535)<<16),(f^=f>>>15)>>>0};var _i=Ci,Si=Oi.exports;Ft.exports=_i,Ft.exports.murmur3=_i,Ft.exports.murmur2=Si;var Ti=m(Ft.exports);class vr{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(e,r,a,f){this.ids.push(er(e)),this.positions.push(r,a,f)}getPositions(e){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const r=er(e);let a=0,f=this.ids.length-1;for(;a<f;){const w=a+f>>1;this.ids[w]>=r?f=w:a=w+1}const v=[];for(;this.ids[a]===r;)v.push({index:this.positions[3*a],start:this.positions[3*a+1],end:this.positions[3*a+2]}),a++;return v}static serialize(e,r){const a=new Float64Array(e.ids),f=new Uint32Array(e.positions);return In(a,f,0,a.length-1),r&&r.push(a.buffer,f.buffer),{ids:a,positions:f}}static deserialize(e){const r=new vr;return r.ids=e.ids,r.positions=e.positions,r.indexed=!0,r}}function er(i){const e=+i;return!isNaN(e)&&e<=Number.MAX_SAFE_INTEGER?e:Ti(String(i))}function In(i,e,r,a){for(;r<a;){const f=i[r+a>>1];let v=r-1,w=a+1;for(;;){do v++;while(i[v]<f);do w--;while(i[w]>f);if(v>=w)break;kr(i,v,w),kr(e,3*v,3*w),kr(e,3*v+1,3*w+1),kr(e,3*v+2,3*w+2)}w-r<a-w?(In(i,e,r,w),r=w+1):(In(i,e,w+1,a),a=w)}}function kr(i,e,r){const a=i[e];i[e]=i[r],i[r]=a}Nt("FeaturePositionMap",vr);class rr{constructor(e,r){this.gl=e.gl,this.location=r}}class cn extends rr{constructor(e,r){super(e,r),this.current=0}set(e){this.current!==e&&(this.current=e,this.gl.uniform1f(this.location,e))}}class ss extends rr{constructor(e,r){super(e,r),this.current=[0,0,0,0]}set(e){e[0]===this.current[0]&&e[1]===this.current[1]&&e[2]===this.current[2]&&e[3]===this.current[3]||(this.current=e,this.gl.uniform4f(this.location,e[0],e[1],e[2],e[3]))}}class vs extends rr{constructor(e,r){super(e,r),this.current=Ni.transparent}set(e){e.r===this.current.r&&e.g===this.current.g&&e.b===this.current.b&&e.a===this.current.a||(this.current=e,this.gl.uniform4f(this.location,e.r,e.g,e.b,e.a))}}const ga=new Float32Array(16);function _a(i){return[Xt(255*i.r,255*i.g),Xt(255*i.b,255*i.a)]}class xs{constructor(e,r,a){this.value=e,this.uniformNames=r.map(f=>`u_${f}`),this.type=a}setUniform(e,r,a){e.set(a.constantOr(this.value))}getBinding(e,r,a){return this.type==="color"?new vs(e,r):new cn(e,r)}}class as{constructor(e,r){this.uniformNames=r.map(a=>`u_${a}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(e,r){this.pixelRatioFrom=r.pixelRatio,this.pixelRatioTo=e.pixelRatio,this.patternFrom=r.tlbr,this.patternTo=e.tlbr}setUniform(e,r,a,f){const v=f==="u_pattern_to"?this.patternTo:f==="u_pattern_from"?this.patternFrom:f==="u_pixel_ratio_to"?this.pixelRatioTo:f==="u_pixel_ratio_from"?this.pixelRatioFrom:null;v&&e.set(v)}getBinding(e,r,a){return a.substr(0,9)==="u_pattern"?new ss(e,r):new cn(e,r)}}class Sr{constructor(e,r,a,f){this.expression=e,this.type=a,this.maxValue=0,this.paintVertexAttributes=r.map(v=>({name:`a_${v}`,type:"Float32",components:a==="color"?2:1,offset:0})),this.paintVertexArray=new f}populatePaintArray(e,r,a,f,v){const w=this.paintVertexArray.length,E=this.expression.evaluate(new ar(0),r,{},f,[],v);this.paintVertexArray.resize(e),this._setPaintValue(w,e,E)}updatePaintArray(e,r,a,f){const v=this.expression.evaluate({zoom:0},a,f);this._setPaintValue(e,r,v)}_setPaintValue(e,r,a){if(this.type==="color"){const f=_a(a);for(let v=e;v<r;v++)this.paintVertexArray.emplace(v,f[0],f[1])}else{for(let f=e;f<r;f++)this.paintVertexArray.emplace(f,a);this.maxValue=Math.max(this.maxValue,Math.abs(a))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class or{constructor(e,r,a,f,v,w){this.expression=e,this.uniformNames=r.map(E=>`u_${E}_t`),this.type=a,this.useIntegerZoom=f,this.zoom=v,this.maxValue=0,this.paintVertexAttributes=r.map(E=>({name:`a_${E}`,type:"Float32",components:a==="color"?4:2,offset:0})),this.paintVertexArray=new w}populatePaintArray(e,r,a,f,v){const w=this.expression.evaluate(new ar(this.zoom),r,{},f,[],v),E=this.expression.evaluate(new ar(this.zoom+1),r,{},f,[],v),k=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(k,e,w,E)}updatePaintArray(e,r,a,f){const v=this.expression.evaluate({zoom:this.zoom},a,f),w=this.expression.evaluate({zoom:this.zoom+1},a,f);this._setPaintValue(e,r,v,w)}_setPaintValue(e,r,a,f){if(this.type==="color"){const v=_a(a),w=_a(f);for(let E=e;E<r;E++)this.paintVertexArray.emplace(E,v[0],v[1],w[0],w[1])}else{for(let v=e;v<r;v++)this.paintVertexArray.emplace(v,a,f);this.maxValue=Math.max(this.maxValue,Math.abs(a),Math.abs(f))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,r){const a=this.useIntegerZoom?Math.floor(r.zoom):r.zoom,f=U(this.expression.interpolationFactor(a,this.zoom,this.zoom+1),0,1);e.set(f)}getBinding(e,r,a){return new cn(e,r)}}class Ir{constructor(e,r,a,f,v,w){this.expression=e,this.type=r,this.useIntegerZoom=a,this.zoom=f,this.layerId=w,this.zoomInPaintVertexArray=new v,this.zoomOutPaintVertexArray=new v}populatePaintArray(e,r,a){const f=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(e),this.zoomOutPaintVertexArray.resize(e),this._setPaintValues(f,e,r.patterns&&r.patterns[this.layerId],a)}updatePaintArray(e,r,a,f,v){this._setPaintValues(e,r,a.patterns&&a.patterns[this.layerId],v)}_setPaintValues(e,r,a,f){if(!f||!a)return;const{min:v,mid:w,max:E}=a,k=f[v],F=f[w],B=f[E];if(k&&F&&B)for(let j=e;j<r;j++)this.zoomInPaintVertexArray.emplace(j,F.tl[0],F.tl[1],F.br[0],F.br[1],k.tl[0],k.tl[1],k.br[0],k.br[1],F.pixelRatio,k.pixelRatio),this.zoomOutPaintVertexArray.emplace(j,F.tl[0],F.tl[1],F.br[0],F.br[1],B.tl[0],B.tl[1],B.br[0],B.br[1],F.pixelRatio,B.pixelRatio)}upload(e){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=e.createVertexBuffer(this.zoomInPaintVertexArray,vi.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=e.createVertexBuffer(this.zoomOutPaintVertexArray,vi.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class Ha{constructor(e,r,a){this.binders={},this._buffers=[];const f=[];for(const v in e.paint._values){if(!a(v))continue;const w=e.paint.get(v);if(!(w instanceof rs&&Gn(w.property.specification)))continue;const E=Xr(v,e.type),k=w.value,F=w.property.specification.type,B=w.property.useIntegerZoom,j=w.property.specification["property-type"],H=j==="cross-faded"||j==="cross-faded-data-driven";if(k.kind==="constant")this.binders[v]=H?new as(k.value,E):new xs(k.value,E,F),f.push(`/u_${v}`);else if(k.kind==="source"||H){const Y=Fn(v,F,"source");this.binders[v]=H?new Ir(k,F,B,r,Y,e.id):new Sr(k,E,F,Y),f.push(`/a_${v}`)}else{const Y=Fn(v,F,"composite");this.binders[v]=new or(k,E,F,B,r,Y),f.push(`/z_${v}`)}}this.cacheKey=f.sort().join("")}getMaxValue(e){const r=this.binders[e];return r instanceof Sr||r instanceof or?r.maxValue:0}populatePaintArrays(e,r,a,f,v){for(const w in this.binders){const E=this.binders[w];(E instanceof Sr||E instanceof or||E instanceof Ir)&&E.populatePaintArray(e,r,a,f,v)}}setConstantPatternPositions(e,r){for(const a in this.binders){const f=this.binders[a];f instanceof as&&f.setConstantPatternPositions(e,r)}}updatePaintArrays(e,r,a,f,v){let w=!1;for(const E in e){const k=r.getPositions(E);for(const F of k){const B=a.feature(F.index);for(const j in this.binders){const H=this.binders[j];if((H instanceof Sr||H instanceof or||H instanceof Ir)&&H.expression.isStateDependent===!0){const Y=f.paint.get(j);H.expression=Y.value,H.updatePaintArray(F.start,F.end,B,e[E],v),w=!0}}}}return w}defines(){const e=[];for(const r in this.binders){const a=this.binders[r];(a instanceof xs||a instanceof as)&&e.push(...a.uniformNames.map(f=>`#define HAS_UNIFORM_${f}`))}return e}getBinderAttributes(){const e=[];for(const r in this.binders){const a=this.binders[r];if(a instanceof Sr||a instanceof or)for(let f=0;f<a.paintVertexAttributes.length;f++)e.push(a.paintVertexAttributes[f].name);else if(a instanceof Ir)for(let f=0;f<vi.members.length;f++)e.push(vi.members[f].name)}return e}getBinderUniforms(){const e=[];for(const r in this.binders){const a=this.binders[r];if(a instanceof xs||a instanceof as||a instanceof or)for(const f of a.uniformNames)e.push(f)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e,r){const a=[];for(const f in this.binders){const v=this.binders[f];if(v instanceof xs||v instanceof as||v instanceof or){for(const w of v.uniformNames)if(r[w]){const E=v.getBinding(e,r[w],w);a.push({name:w,property:f,binding:E})}}}return a}setUniforms(e,r,a,f){for(const{name:v,property:w,binding:E}of r)this.binders[w].setUniform(E,f,a.get(w),v)}updatePaintBuffers(e){this._buffers=[];for(const r in this.binders){const a=this.binders[r];if(e&&a instanceof Ir){const f=e.fromScale===2?a.zoomInPaintVertexBuffer:a.zoomOutPaintVertexBuffer;f&&this._buffers.push(f)}else(a instanceof Sr||a instanceof or)&&a.paintVertexBuffer&&this._buffers.push(a.paintVertexBuffer)}}upload(e){for(const r in this.binders){const a=this.binders[r];(a instanceof Sr||a instanceof or||a instanceof Ir)&&a.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const r=this.binders[e];(r instanceof Sr||r instanceof or||r instanceof Ir)&&r.destroy()}}}class pr{constructor(e,r,a=()=>!0){this.programConfigurations={};for(const f of e)this.programConfigurations[f.id]=new Ha(f,r,a);this.needsUpload=!1,this._featureMap=new vr,this._bufferOffset=0}populatePaintArrays(e,r,a,f,v,w){for(const E in this.programConfigurations)this.programConfigurations[E].populatePaintArrays(e,r,f,v,w);r.id!==void 0&&this._featureMap.add(r.id,a,this._bufferOffset,e),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,r,a,f){for(const v of a)this.needsUpload=this.programConfigurations[v.id].updatePaintArrays(e,this._featureMap,r,v,f)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const r in this.programConfigurations)this.programConfigurations[r].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}function Xr(i,e){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[i]||[i.replace(`${e}-`,"").replace(/-/g,"_")]}function Fn(i,e,r){const a={color:{source:yo,composite:Pl},number:{source:ea,composite:yo}},f=function(v){return{"line-pattern":{source:te,composite:te},"fill-pattern":{source:te,composite:te},"fill-extrusion-pattern":{source:te,composite:te}}[v]}(i);return f&&f[r]||a[e][r]}Nt("ConstantBinder",xs),Nt("CrossFadedConstantBinder",as),Nt("SourceExpressionBinder",Sr),Nt("CrossFadedCompositeBinder",Ir),Nt("CompositeExpressionBinder",or),Nt("ProgramConfiguration",Ha,{omit:["_buffers"]}),Nt("ProgramConfigurationSet",pr);const Di=8192,Ml=Math.pow(2,14)-1,sc=-Ml-1;function ya(i){const e=Di/i.extent,r=i.loadGeometry();for(let a=0;a<r.length;a++){const f=r[a];for(let v=0;v<f.length;v++){const w=f[v],E=Math.round(w.x*e),k=Math.round(w.y*e);w.x=U(E,sc,Ml),w.y=U(k,sc,Ml),(E<w.x||E>w.x+1||k<w.y||k>w.y+1)&&ut("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return r}function va(i,e){return{type:i.type,id:i.id,properties:i.properties,geometry:e?ya(i):[]}}function $o(i,e,r,a,f){i.emplaceBack(2*e+(a+1)/2,2*r+(f+1)/2)}class kl{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new G,this.indexArray=new qe,this.segments=new wt,this.programConfigurations=new pr(e.layers,e.zoom),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,a){const f=this.layers[0],v=[];let w=null,E=!1;f.type==="circle"&&(w=f.layout.get("circle-sort-key"),E=!w.isConstant());for(const{feature:k,id:F,index:B,sourceLayerIndex:j}of e){const H=this.layers[0]._featureFilter.needGeometry,Y=va(k,H);if(!this.layers[0]._featureFilter.filter(new ar(this.zoom),Y,a))continue;const K=E?w.evaluate(Y,{},a):void 0,re={id:F,properties:k.properties,type:k.type,sourceLayerIndex:j,index:B,geometry:H?Y.geometry:ya(k),patterns:{},sortKey:K};v.push(re)}E&&v.sort((k,F)=>k.sortKey-F.sortKey);for(const k of v){const{geometry:F,index:B,sourceLayerIndex:j}=k,H=e[B].feature;this.addFeature(k,F,B,a),r.featureIndex.insert(H,F,B,j,this.index)}}update(e,r,a){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,a)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,_t),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,r,a,f){for(const v of r)for(const w of v){const E=w.x,k=w.y;if(E<0||E>=Di||k<0||k>=Di)continue;const F=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),B=F.vertexLength;$o(this.layoutVertexArray,E,k,-1,-1),$o(this.layoutVertexArray,E,k,1,-1),$o(this.layoutVertexArray,E,k,1,1),$o(this.layoutVertexArray,E,k,-1,1),this.indexArray.emplaceBack(B,B+1,B+2),this.indexArray.emplaceBack(B,B+3,B+2),F.vertexLength+=4,F.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,a,{},f)}}function xa(i,e){for(let r=0;r<i.length;r++)if(Yo(e,i[r]))return!0;for(let r=0;r<e.length;r++)if(Yo(i,e[r]))return!0;return!!xo(i,e)}function ac(i,e,r){return!!Yo(i,e)||!!bo(e,i,r)}function Dl(i,e){if(i.length===1)return Oh(e,i[0]);for(let r=0;r<e.length;r++){const a=e[r];for(let f=0;f<a.length;f++)if(Yo(i,a[f]))return!0}for(let r=0;r<i.length;r++)if(Oh(e,i[r]))return!0;for(let r=0;r<e.length;r++)if(xo(i,e[r]))return!0;return!1}function oc(i,e,r){if(i.length>1){if(xo(i,e))return!0;for(let a=0;a<e.length;a++)if(bo(e[a],i,r))return!0}for(let a=0;a<i.length;a++)if(bo(i[a],e,r))return!0;return!1}function xo(i,e){if(i.length===0||e.length===0)return!1;for(let r=0;r<i.length-1;r++){const a=i[r],f=i[r+1];for(let v=0;v<e.length-1;v++)if(lc(a,f,e[v],e[v+1]))return!0}return!1}function lc(i,e,r,a){return ot(i,r,a)!==ot(e,r,a)&&ot(i,e,r)!==ot(i,e,a)}function bo(i,e,r){const a=r*r;if(e.length===1)return i.distSqr(e[0])<a;for(let f=1;f<e.length;f++)if(Dh(i,e[f-1],e[f])<a)return!0;return!1}function Dh(i,e,r){const a=e.distSqr(r);if(a===0)return i.distSqr(e);const f=((i.x-e.x)*(r.x-e.x)+(i.y-e.y)*(r.y-e.y))/a;return i.distSqr(f<0?e:f>1?r:r.sub(e)._mult(f)._add(e))}function Oh(i,e){let r,a,f,v=!1;for(let w=0;w<i.length;w++){r=i[w];for(let E=0,k=r.length-1;E<r.length;k=E++)a=r[E],f=r[k],a.y>e.y!=f.y>e.y&&e.x<(f.x-a.x)*(e.y-a.y)/(f.y-a.y)+a.x&&(v=!v)}return v}function Yo(i,e){let r=!1;for(let a=0,f=i.length-1;a<i.length;f=a++){const v=i[a],w=i[f];v.y>e.y!=w.y>e.y&&e.x<(w.x-v.x)*(e.y-v.y)/(w.y-v.y)+v.x&&(r=!r)}return r}function kd(i,e,r){const a=r[0],f=r[2];if(i.x<a.x&&e.x<a.x||i.x>f.x&&e.x>f.x||i.y<a.y&&e.y<a.y||i.y>f.y&&e.y>f.y)return!1;const v=ot(i,e,r[0]);return v!==ot(i,e,r[1])||v!==ot(i,e,r[2])||v!==ot(i,e,r[3])}function Ol(i,e,r){const a=e.paint.get(i).value;return a.kind==="constant"?a.value:r.programConfigurations.get(e.id).getMaxValue(i)}function cc(i){return Math.sqrt(i[0]*i[0]+i[1]*i[1])}function hc(i,e,r,a,f){if(!e[0]&&!e[1])return i;const v=o.convert(e)._mult(f);r==="viewport"&&v._rotate(-a);const w=[];for(let E=0;E<i.length;E++)w.push(i[E].sub(v));return w}let Lh,Fh;Nt("CircleBucket",kl,{omit:["layers"]});var Dd={get paint(){return Fh=Fh||new En({"circle-radius":new hi(le.paint_circle["circle-radius"]),"circle-color":new hi(le.paint_circle["circle-color"]),"circle-blur":new hi(le.paint_circle["circle-blur"]),"circle-opacity":new hi(le.paint_circle["circle-opacity"]),"circle-translate":new ii(le.paint_circle["circle-translate"]),"circle-translate-anchor":new ii(le.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ii(le.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ii(le.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new hi(le.paint_circle["circle-stroke-width"]),"circle-stroke-color":new hi(le.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new hi(le.paint_circle["circle-stroke-opacity"])})},get layout(){return Lh=Lh||new En({"circle-sort-key":new hi(le.layout_circle["circle-sort-key"])})}},Pn=1e-6,Zo=typeof Float32Array<"u"?Float32Array:Array;function Lc(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function zh(i,e,r){var a=e[0],f=e[1],v=e[2],w=e[3],E=e[4],k=e[5],F=e[6],B=e[7],j=e[8],H=e[9],Y=e[10],K=e[11],re=e[12],he=e[13],ve=e[14],Be=e[15],we=r[0],Me=r[1],st=r[2],pt=r[3];return i[0]=we*a+Me*E+st*j+pt*re,i[1]=we*f+Me*k+st*H+pt*he,i[2]=we*v+Me*F+st*Y+pt*ve,i[3]=we*w+Me*B+st*K+pt*Be,i[4]=(we=r[4])*a+(Me=r[5])*E+(st=r[6])*j+(pt=r[7])*re,i[5]=we*f+Me*k+st*H+pt*he,i[6]=we*v+Me*F+st*Y+pt*ve,i[7]=we*w+Me*B+st*K+pt*Be,i[8]=(we=r[8])*a+(Me=r[9])*E+(st=r[10])*j+(pt=r[11])*re,i[9]=we*f+Me*k+st*H+pt*he,i[10]=we*v+Me*F+st*Y+pt*ve,i[11]=we*w+Me*B+st*K+pt*Be,i[12]=(we=r[12])*a+(Me=r[13])*E+(st=r[14])*j+(pt=r[15])*re,i[13]=we*f+Me*k+st*H+pt*he,i[14]=we*v+Me*F+st*Y+pt*ve,i[15]=we*w+Me*B+st*K+pt*Be,i}Math.hypot||(Math.hypot=function(){for(var i=0,e=arguments.length;e--;)i+=arguments[e]*arguments[e];return Math.sqrt(i)});var Ll,Od=zh;function uc(i,e,r){var a=e[0],f=e[1],v=e[2],w=e[3];return i[0]=r[0]*a+r[4]*f+r[8]*v+r[12]*w,i[1]=r[1]*a+r[5]*f+r[9]*v+r[13]*w,i[2]=r[2]*a+r[6]*f+r[10]*v+r[14]*w,i[3]=r[3]*a+r[7]*f+r[11]*v+r[15]*w,i}Ll=new Zo(4),Zo!=Float32Array&&(Ll[0]=0,Ll[1]=0,Ll[2]=0,Ll[3]=0);class Ld extends ns{constructor(e){super(e,Dd)}createBucket(e){return new kl(e)}queryRadius(e){const r=e;return Ol("circle-radius",this,r)+Ol("circle-stroke-width",this,r)+cc(this.paint.get("circle-translate"))}queryIntersectsFeature(e,r,a,f,v,w,E,k){const F=hc(e,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),w.angle,E),B=this.paint.get("circle-radius").evaluate(r,a)+this.paint.get("circle-stroke-width").evaluate(r,a),j=this.paint.get("circle-pitch-alignment")==="map",H=j?F:function(K,re){return K.map(he=>Rh(he,re))}(F,k),Y=j?B*E:B;for(const K of f)for(const re of K){const he=j?re:Rh(re,k);let ve=Y;const Be=uc([],[re.x,re.y,0,1],k);if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"?ve*=Be[3]/w.cameraToCenterDistance:this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"&&(ve*=w.cameraToCenterDistance/Be[3]),ac(H,he,ve))return!0}return!1}}function Rh(i,e){const r=uc([],[i.x,i.y,0,1],e);return new o(r[0]/r[3],r[1]/r[3])}class Bh extends kl{}let jh;Nt("HeatmapBucket",Bh,{omit:["layers"]});var Fd={get paint(){return jh=jh||new En({"heatmap-radius":new hi(le.paint_heatmap["heatmap-radius"]),"heatmap-weight":new hi(le.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ii(le.paint_heatmap["heatmap-intensity"]),"heatmap-color":new go(le.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ii(le.paint_heatmap["heatmap-opacity"])})}};function Fc(i,{width:e,height:r},a,f){if(f){if(f instanceof Uint8ClampedArray)f=new Uint8Array(f.buffer);else if(f.length!==e*r*a)throw new RangeError(`mismatched image size. expected: ${f.length} but got: ${e*r*a}`)}else f=new Uint8Array(e*r*a);return i.width=e,i.height=r,i.data=f,i}function Nh(i,{width:e,height:r},a){if(e===i.width&&r===i.height)return;const f=Fc({},{width:e,height:r},a);zc(i,f,{x:0,y:0},{x:0,y:0},{width:Math.min(i.width,e),height:Math.min(i.height,r)},a),i.width=e,i.height=r,i.data=f.data}function zc(i,e,r,a,f,v){if(f.width===0||f.height===0)return e;if(f.width>i.width||f.height>i.height||r.x>i.width-f.width||r.y>i.height-f.height)throw new RangeError("out of range source coordinates for image copy");if(f.width>e.width||f.height>e.height||a.x>e.width-f.width||a.y>e.height-f.height)throw new RangeError("out of range destination coordinates for image copy");const w=i.data,E=e.data;if(w===E)throw new Error("srcData equals dstData, so image is already copied");for(let k=0;k<f.height;k++){const F=((r.y+k)*i.width+r.x)*v,B=((a.y+k)*e.width+a.x)*v;for(let j=0;j<f.width*v;j++)E[B+j]=w[F+j]}return e}class Fl{constructor(e,r){Fc(this,e,1,r)}resize(e){Nh(this,e,1)}clone(){return new Fl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,a,f,v){zc(e,r,a,f,v,1)}}class os{constructor(e,r){Fc(this,e,4,r)}resize(e){Nh(this,e,4)}replace(e,r){r?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new os({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,a,f,v){zc(e,r,a,f,v,4)}}function Vh(i){const e={},r=i.resolution||256,a=i.clips?i.clips.length:1,f=i.image||new os({width:r,height:a});if(Math.log(r)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${r}`);const v=(w,E,k)=>{e[i.evaluationKey]=k;const F=i.expression.evaluate(e);f.data[w+E+0]=Math.floor(255*F.r/F.a),f.data[w+E+1]=Math.floor(255*F.g/F.a),f.data[w+E+2]=Math.floor(255*F.b/F.a),f.data[w+E+3]=Math.floor(255*F.a)};if(i.clips)for(let w=0,E=0;w<a;++w,E+=4*r)for(let k=0,F=0;k<r;k++,F+=4){const B=k/(r-1),{start:j,end:H}=i.clips[w];v(E,F,j*(1-B)+H*B)}else for(let w=0,E=0;w<r;w++,E+=4)v(0,E,w/(r-1));return f}Nt("AlphaImage",Fl),Nt("RGBAImage",os);class zd extends ns{createBucket(e){return new Bh(e)}constructor(e){super(e,Fd),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){e==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Vh({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let Uh;var Rd={get paint(){return Uh=Uh||new En({"hillshade-illumination-direction":new ii(le.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ii(le.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ii(le.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ii(le.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ii(le.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ii(le.paint_hillshade["hillshade-accent-color"])})}};class Bd extends ns{constructor(e){super(e,Rd)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}const jd=Pr([{name:"a_pos",components:2,type:"Int16"}],4),{members:Nd}=jd;var Rc={exports:{}};function dc(i,e,r){r=r||2;var a,f,v,w,E,k,F,B=e&&e.length,j=B?e[0]*r:i.length,H=Gh(i,0,j,r,!0),Y=[];if(!H||H.next===H.prev)return Y;if(B&&(H=function(re,he,ve,Be){var we,Me,st,pt=[];for(we=0,Me=he.length;we<Me;we++)(st=Gh(re,he[we]*Be,we<Me-1?he[we+1]*Be:re.length,Be,!1))===st.next&&(st.steiner=!0),pt.push($d(st));for(pt.sort(Hd),we=0;we<pt.length;we++)ve=Xd(pt[we],ve);return ve}(i,e,H,r)),i.length>80*r){a=v=i[0],f=w=i[1];for(var K=r;K<j;K+=r)(E=i[K])<a&&(a=E),(k=i[K+1])<f&&(f=k),E>v&&(v=E),k>w&&(w=k);F=(F=Math.max(v-a,w-f))!==0?32767/F:0}return zl(H,Y,r,a,f,F,0),Y}function Gh(i,e,r,a,f){var v,w;if(f===Nc(i,e,r,a)>0)for(v=e;v<r;v+=a)w=Xh(v,i[v],i[v+1],w);else for(v=r-a;v>=e;v-=a)w=Xh(v,i[v],i[v+1],w);return w&&fc(w,w.next)&&(Bl(w),w=w.next),w}function wo(i,e){if(!i)return i;e||(e=i);var r,a=i;do if(r=!1,a.steiner||!fc(a,a.next)&&Ar(a.prev,a,a.next)!==0)a=a.next;else{if(Bl(a),(a=e=a.prev)===a.next)break;r=!0}while(r||a!==e);return e}function zl(i,e,r,a,f,v,w){if(i){!w&&v&&function(B,j,H,Y){var K=B;do K.z===0&&(K.z=Bc(K.x,K.y,j,H,Y)),K.prevZ=K.prev,K.nextZ=K.next,K=K.next;while(K!==B);K.prevZ.nextZ=null,K.prevZ=null,function(re){var he,ve,Be,we,Me,st,pt,Gt,ei=1;do{for(ve=re,re=null,Me=null,st=0;ve;){for(st++,Be=ve,pt=0,he=0;he<ei&&(pt++,Be=Be.nextZ);he++);for(Gt=ei;pt>0||Gt>0&&Be;)pt!==0&&(Gt===0||!Be||ve.z<=Be.z)?(we=ve,ve=ve.nextZ,pt--):(we=Be,Be=Be.nextZ,Gt--),Me?Me.nextZ=we:re=we,we.prevZ=Me,Me=we;ve=Be}Me.nextZ=null,ei*=2}while(st>1)}(K)}(i,a,f,v);for(var E,k,F=i;i.prev!==i.next;)if(E=i.prev,k=i.next,v?Ud(i,a,f,v):Vd(i))e.push(E.i/r|0),e.push(i.i/r|0),e.push(k.i/r|0),Bl(i),i=k.next,F=k.next;else if((i=k)===F){w?w===1?zl(i=Gd(wo(i),e,r),e,r,a,f,v,2):w===2&&Wd(i,e,r,a,f,v):zl(wo(i),e,r,a,f,v,1);break}}}function Vd(i){var e=i.prev,r=i,a=i.next;if(Ar(e,r,a)>=0)return!1;for(var f=e.x,v=r.x,w=a.x,E=e.y,k=r.y,F=a.y,B=f<v?f<w?f:w:v<w?v:w,j=E<k?E<F?E:F:k<F?k:F,H=f>v?f>w?f:w:v>w?v:w,Y=E>k?E>F?E:F:k>F?k:F,K=a.next;K!==e;){if(K.x>=B&&K.x<=H&&K.y>=j&&K.y<=Y&&Ko(f,E,v,k,w,F,K.x,K.y)&&Ar(K.prev,K,K.next)>=0)return!1;K=K.next}return!0}function Ud(i,e,r,a){var f=i.prev,v=i,w=i.next;if(Ar(f,v,w)>=0)return!1;for(var E=f.x,k=v.x,F=w.x,B=f.y,j=v.y,H=w.y,Y=E<k?E<F?E:F:k<F?k:F,K=B<j?B<H?B:H:j<H?j:H,re=E>k?E>F?E:F:k>F?k:F,he=B>j?B>H?B:H:j>H?j:H,ve=Bc(Y,K,e,r,a),Be=Bc(re,he,e,r,a),we=i.prevZ,Me=i.nextZ;we&&we.z>=ve&&Me&&Me.z<=Be;){if(we.x>=Y&&we.x<=re&&we.y>=K&&we.y<=he&&we!==f&&we!==w&&Ko(E,B,k,j,F,H,we.x,we.y)&&Ar(we.prev,we,we.next)>=0||(we=we.prevZ,Me.x>=Y&&Me.x<=re&&Me.y>=K&&Me.y<=he&&Me!==f&&Me!==w&&Ko(E,B,k,j,F,H,Me.x,Me.y)&&Ar(Me.prev,Me,Me.next)>=0))return!1;Me=Me.nextZ}for(;we&&we.z>=ve;){if(we.x>=Y&&we.x<=re&&we.y>=K&&we.y<=he&&we!==f&&we!==w&&Ko(E,B,k,j,F,H,we.x,we.y)&&Ar(we.prev,we,we.next)>=0)return!1;we=we.prevZ}for(;Me&&Me.z<=Be;){if(Me.x>=Y&&Me.x<=re&&Me.y>=K&&Me.y<=he&&Me!==f&&Me!==w&&Ko(E,B,k,j,F,H,Me.x,Me.y)&&Ar(Me.prev,Me,Me.next)>=0)return!1;Me=Me.nextZ}return!0}function Gd(i,e,r){var a=i;do{var f=a.prev,v=a.next.next;!fc(f,v)&&Wh(f,a,a.next,v)&&Rl(f,v)&&Rl(v,f)&&(e.push(f.i/r|0),e.push(a.i/r|0),e.push(v.i/r|0),Bl(a),Bl(a.next),a=i=v),a=a.next}while(a!==i);return wo(a)}function Wd(i,e,r,a,f,v){var w=i;do{for(var E=w.next.next;E!==w.prev;){if(w.i!==E.i&&Yd(w,E)){var k=Hh(w,E);return w=wo(w,w.next),k=wo(k,k.next),zl(w,e,r,a,f,v,0),void zl(k,e,r,a,f,v,0)}E=E.next}w=w.next}while(w!==i)}function Hd(i,e){return i.x-e.x}function Xd(i,e){var r=function(f,v){var w,E=v,k=f.x,F=f.y,B=-1/0;do{if(F<=E.y&&F>=E.next.y&&E.next.y!==E.y){var j=E.x+(F-E.y)*(E.next.x-E.x)/(E.next.y-E.y);if(j<=k&&j>B&&(B=j,w=E.x<E.next.x?E:E.next,j===k))return w}E=E.next}while(E!==v);if(!w)return null;var H,Y=w,K=w.x,re=w.y,he=1/0;E=w;do k>=E.x&&E.x>=K&&k!==E.x&&Ko(F<re?k:B,F,K,re,F<re?B:k,F,E.x,E.y)&&(H=Math.abs(F-E.y)/(k-E.x),Rl(E,f)&&(H<he||H===he&&(E.x>w.x||E.x===w.x&&qd(w,E)))&&(w=E,he=H)),E=E.next;while(E!==Y);return w}(i,e);if(!r)return e;var a=Hh(r,i);return wo(a,a.next),wo(r,r.next)}function qd(i,e){return Ar(i.prev,i,e.prev)<0&&Ar(e.next,i,i.next)<0}function Bc(i,e,r,a,f){return(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=(i-r)*f|0)|i<<8))|i<<4))|i<<2))|i<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-a)*f|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function $d(i){var e=i,r=i;do(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next;while(e!==i);return r}function Ko(i,e,r,a,f,v,w,E){return(f-w)*(e-E)>=(i-w)*(v-E)&&(i-w)*(a-E)>=(r-w)*(e-E)&&(r-w)*(v-E)>=(f-w)*(a-E)}function Yd(i,e){return i.next.i!==e.i&&i.prev.i!==e.i&&!function(r,a){var f=r;do{if(f.i!==r.i&&f.next.i!==r.i&&f.i!==a.i&&f.next.i!==a.i&&Wh(f,f.next,r,a))return!0;f=f.next}while(f!==r);return!1}(i,e)&&(Rl(i,e)&&Rl(e,i)&&function(r,a){var f=r,v=!1,w=(r.x+a.x)/2,E=(r.y+a.y)/2;do f.y>E!=f.next.y>E&&f.next.y!==f.y&&w<(f.next.x-f.x)*(E-f.y)/(f.next.y-f.y)+f.x&&(v=!v),f=f.next;while(f!==r);return v}(i,e)&&(Ar(i.prev,i,e.prev)||Ar(i,e.prev,e))||fc(i,e)&&Ar(i.prev,i,i.next)>0&&Ar(e.prev,e,e.next)>0)}function Ar(i,e,r){return(e.y-i.y)*(r.x-e.x)-(e.x-i.x)*(r.y-e.y)}function fc(i,e){return i.x===e.x&&i.y===e.y}function Wh(i,e,r,a){var f=mc(Ar(i,e,r)),v=mc(Ar(i,e,a)),w=mc(Ar(r,a,i)),E=mc(Ar(r,a,e));return f!==v&&w!==E||!(f!==0||!pc(i,r,e))||!(v!==0||!pc(i,a,e))||!(w!==0||!pc(r,i,a))||!(E!==0||!pc(r,e,a))}function pc(i,e,r){return e.x<=Math.max(i.x,r.x)&&e.x>=Math.min(i.x,r.x)&&e.y<=Math.max(i.y,r.y)&&e.y>=Math.min(i.y,r.y)}function mc(i){return i>0?1:i<0?-1:0}function Rl(i,e){return Ar(i.prev,i,i.next)<0?Ar(i,e,i.next)>=0&&Ar(i,i.prev,e)>=0:Ar(i,e,i.prev)<0||Ar(i,i.next,e)<0}function Hh(i,e){var r=new jc(i.i,i.x,i.y),a=new jc(e.i,e.x,e.y),f=i.next,v=e.prev;return i.next=e,e.prev=i,r.next=f,f.prev=r,a.next=r,r.prev=a,v.next=a,a.prev=v,a}function Xh(i,e,r,a){var f=new jc(i,e,r);return a?(f.next=a.next,f.prev=a,a.next.prev=f,a.next=f):(f.prev=f,f.next=f),f}function Bl(i){i.next.prev=i.prev,i.prev.next=i.next,i.prevZ&&(i.prevZ.nextZ=i.nextZ),i.nextZ&&(i.nextZ.prevZ=i.prevZ)}function jc(i,e,r){this.i=i,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Nc(i,e,r,a){for(var f=0,v=e,w=r-a;v<r;v+=a)f+=(i[w]-i[v])*(i[v+1]+i[w+1]),w=v;return f}Rc.exports=dc,Rc.exports.default=dc,dc.deviation=function(i,e,r,a){var f=e&&e.length,v=Math.abs(Nc(i,0,f?e[0]*r:i.length,r));if(f)for(var w=0,E=e.length;w<E;w++)v-=Math.abs(Nc(i,e[w]*r,w<E-1?e[w+1]*r:i.length,r));var k=0;for(w=0;w<a.length;w+=3){var F=a[w]*r,B=a[w+1]*r,j=a[w+2]*r;k+=Math.abs((i[F]-i[j])*(i[B+1]-i[F+1])-(i[F]-i[B])*(i[j+1]-i[F+1]))}return v===0&&k===0?0:Math.abs((k-v)/v)},dc.flatten=function(i){for(var e=i[0][0].length,r={vertices:[],holes:[],dimensions:e},a=0,f=0;f<i.length;f++){for(var v=0;v<i[f].length;v++)for(var w=0;w<e;w++)r.vertices.push(i[f][v][w]);f>0&&r.holes.push(a+=i[f-1].length)}return r};var qh=m(Rc.exports);function Zd(i,e,r,a,f){$h(i,e,r||0,a||i.length-1,f||Kd)}function $h(i,e,r,a,f){for(;a>r;){if(a-r>600){var v=a-r+1,w=e-r+1,E=Math.log(v),k=.5*Math.exp(2*E/3),F=.5*Math.sqrt(E*k*(v-k)/v)*(w-v/2<0?-1:1);$h(i,e,Math.max(r,Math.floor(e-w*k/v+F)),Math.min(a,Math.floor(e+(v-w)*k/v+F)),f)}var B=i[e],j=r,H=a;for(jl(i,r,e),f(i[a],B)>0&&jl(i,r,a);j<H;){for(jl(i,j,H),j++,H--;f(i[j],B)<0;)j++;for(;f(i[H],B)>0;)H--}f(i[r],B)===0?jl(i,r,H):jl(i,++H,a),H<=e&&(r=H+1),e<=H&&(a=H-1)}}function jl(i,e,r){var a=i[e];i[e]=i[r],i[r]=a}function Kd(i,e){return i<e?-1:i>e?1:0}function Vc(i,e){const r=i.length;if(r<=1)return[i];const a=[];let f,v;for(let w=0;w<r;w++){const E=vt(i[w]);E!==0&&(i[w].area=Math.abs(E),v===void 0&&(v=E<0),v===E<0?(f&&a.push(f),f=[i[w]]):f.push(i[w]))}if(f&&a.push(f),e>1)for(let w=0;w<a.length;w++)a[w].length<=e||(Zd(a[w],e,1,a[w].length-1,Jd),a[w]=a[w].slice(0,e));return a}function Jd(i,e){return e.area-i.area}function Uc(i,e,r){const a=r.patternDependencies;let f=!1;for(const v of e){const w=v.paint.get(`${i}-pattern`);w.isConstant()||(f=!0);const E=w.constantOr(null);E&&(f=!0,a[E.to]=!0,a[E.from]=!0)}return f}function Gc(i,e,r,a,f){const v=f.patternDependencies;for(const w of e){const E=w.paint.get(`${i}-pattern`).value;if(E.kind!=="constant"){let k=E.evaluate({zoom:a-1},r,{},f.availableImages),F=E.evaluate({zoom:a},r,{},f.availableImages),B=E.evaluate({zoom:a+1},r,{},f.availableImages);k=k&&k.name?k.name:k,F=F&&F.name?F.name:F,B=B&&B.name?B.name:B,v[k]=!0,v[F]=!0,v[B]=!0,r.patterns[w.id]={min:k,mid:F,max:B}}}return r}class Wc{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Z,this.indexArray=new qe,this.indexArray2=new rt,this.programConfigurations=new pr(e.layers,e.zoom),this.segments=new wt,this.segments2=new wt,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,a){this.hasPattern=Uc("fill",this.layers,r);const f=this.layers[0].layout.get("fill-sort-key"),v=!f.isConstant(),w=[];for(const{feature:E,id:k,index:F,sourceLayerIndex:B}of e){const j=this.layers[0]._featureFilter.needGeometry,H=va(E,j);if(!this.layers[0]._featureFilter.filter(new ar(this.zoom),H,a))continue;const Y=v?f.evaluate(H,{},a,r.availableImages):void 0,K={id:k,properties:E.properties,type:E.type,sourceLayerIndex:B,index:F,geometry:j?H.geometry:ya(E),patterns:{},sortKey:Y};w.push(K)}v&&w.sort((E,k)=>E.sortKey-k.sortKey);for(const E of w){const{geometry:k,index:F,sourceLayerIndex:B}=E;if(this.hasPattern){const j=Gc("fill",this.layers,E,this.zoom,r);this.patternFeatures.push(j)}else this.addFeature(E,k,F,a,{});r.featureIndex.insert(e[F].feature,k,F,B,this.index)}}update(e,r,a){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,a)}addFeatures(e,r,a){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,r,a)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Nd),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,r,a,f,v){for(const w of Vc(r,500)){let E=0;for(const Y of w)E+=Y.length;const k=this.segments.prepareSegment(E,this.layoutVertexArray,this.indexArray),F=k.vertexLength,B=[],j=[];for(const Y of w){if(Y.length===0)continue;Y!==w[0]&&j.push(B.length/2);const K=this.segments2.prepareSegment(Y.length,this.layoutVertexArray,this.indexArray2),re=K.vertexLength;this.layoutVertexArray.emplaceBack(Y[0].x,Y[0].y),this.indexArray2.emplaceBack(re+Y.length-1,re),B.push(Y[0].x),B.push(Y[0].y);for(let he=1;he<Y.length;he++)this.layoutVertexArray.emplaceBack(Y[he].x,Y[he].y),this.indexArray2.emplaceBack(re+he-1,re+he),B.push(Y[he].x),B.push(Y[he].y);K.vertexLength+=Y.length,K.primitiveLength+=Y.length}const H=qh(B,j);for(let Y=0;Y<H.length;Y+=3)this.indexArray.emplaceBack(F+H[Y],F+H[Y+1],F+H[Y+2]);k.vertexLength+=E,k.primitiveLength+=H.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,a,v,f)}}let Yh,Zh;Nt("FillBucket",Wc,{omit:["layers","patternFeatures"]});var Qd={get paint(){return Zh=Zh||new En({"fill-antialias":new ii(le.paint_fill["fill-antialias"]),"fill-opacity":new hi(le.paint_fill["fill-opacity"]),"fill-color":new hi(le.paint_fill["fill-color"]),"fill-outline-color":new hi(le.paint_fill["fill-outline-color"]),"fill-translate":new ii(le.paint_fill["fill-translate"]),"fill-translate-anchor":new ii(le.paint_fill["fill-translate-anchor"]),"fill-pattern":new pa(le.paint_fill["fill-pattern"])})},get layout(){return Yh=Yh||new En({"fill-sort-key":new hi(le.layout_fill["fill-sort-key"])})}};class ef extends ns{constructor(e){super(e,Qd)}recalculate(e,r){super.recalculate(e,r);const a=this.paint._values["fill-outline-color"];a.value.kind==="constant"&&a.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(e){return new Wc(e)}queryRadius(){return cc(this.paint.get("fill-translate"))}queryIntersectsFeature(e,r,a,f,v,w,E){return Dl(hc(e,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),w.angle,E),f)}isTileClipped(){return!0}}const tf=Pr([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),rf=Pr([{name:"a_centroid",components:2,type:"Int16"}],4),{members:nf}=tf;var Xa={},sf=b,Kh=Jo;function Jo(i,e,r,a,f){this.properties={},this.extent=r,this.type=0,this._pbf=i,this._geometry=-1,this._keys=a,this._values=f,i.readFields(af,this,e)}function af(i,e,r){i==1?e.id=r.readVarint():i==2?function(a,f){for(var v=a.readVarint()+a.pos;a.pos<v;){var w=f._keys[a.readVarint()],E=f._values[a.readVarint()];f.properties[w]=E}}(r,e):i==3?e.type=r.readVarint():i==4&&(e._geometry=r.pos)}function of(i){for(var e,r,a=0,f=0,v=i.length,w=v-1;f<v;w=f++)a+=((r=i[w]).x-(e=i[f]).x)*(e.y+r.y);return a}Jo.types=["Unknown","Point","LineString","Polygon"],Jo.prototype.loadGeometry=function(){var i=this._pbf;i.pos=this._geometry;for(var e,r=i.readVarint()+i.pos,a=1,f=0,v=0,w=0,E=[];i.pos<r;){if(f<=0){var k=i.readVarint();a=7&k,f=k>>3}if(f--,a===1||a===2)v+=i.readSVarint(),w+=i.readSVarint(),a===1&&(e&&E.push(e),e=[]),e.push(new sf(v,w));else{if(a!==7)throw new Error("unknown command "+a);e&&e.push(e[0].clone())}}return e&&E.push(e),E},Jo.prototype.bbox=function(){var i=this._pbf;i.pos=this._geometry;for(var e=i.readVarint()+i.pos,r=1,a=0,f=0,v=0,w=1/0,E=-1/0,k=1/0,F=-1/0;i.pos<e;){if(a<=0){var B=i.readVarint();r=7&B,a=B>>3}if(a--,r===1||r===2)(f+=i.readSVarint())<w&&(w=f),f>E&&(E=f),(v+=i.readSVarint())<k&&(k=v),v>F&&(F=v);else if(r!==7)throw new Error("unknown command "+r)}return[w,k,E,F]},Jo.prototype.toGeoJSON=function(i,e,r){var a,f,v=this.extent*Math.pow(2,r),w=this.extent*i,E=this.extent*e,k=this.loadGeometry(),F=Jo.types[this.type];function B(Y){for(var K=0;K<Y.length;K++){var re=Y[K];Y[K]=[360*(re.x+w)/v-180,360/Math.PI*Math.atan(Math.exp((180-360*(re.y+E)/v)*Math.PI/180))-90]}}switch(this.type){case 1:var j=[];for(a=0;a<k.length;a++)j[a]=k[a][0];B(k=j);break;case 2:for(a=0;a<k.length;a++)B(k[a]);break;case 3:for(k=function(Y){var K=Y.length;if(K<=1)return[Y];for(var re,he,ve=[],Be=0;Be<K;Be++){var we=of(Y[Be]);we!==0&&(he===void 0&&(he=we<0),he===we<0?(re&&ve.push(re),re=[Y[Be]]):re.push(Y[Be]))}return re&&ve.push(re),ve}(k),a=0;a<k.length;a++)for(f=0;f<k[a].length;f++)B(k[a][f])}k.length===1?k=k[0]:F="Multi"+F;var H={type:"Feature",geometry:{type:F,coordinates:k},properties:this.properties};return"id"in this&&(H.id=this.id),H};var lf=Kh,Jh=Qh;function Qh(i,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=i,this._keys=[],this._values=[],this._features=[],i.readFields(cf,this,e),this.length=this._features.length}function cf(i,e,r){i===15?e.version=r.readVarint():i===1?e.name=r.readString():i===5?e.extent=r.readVarint():i===2?e._features.push(r.pos):i===3?e._keys.push(r.readString()):i===4&&e._values.push(function(a){for(var f=null,v=a.readVarint()+a.pos;a.pos<v;){var w=a.readVarint()>>3;f=w===1?a.readString():w===2?a.readFloat():w===3?a.readDouble():w===4?a.readVarint64():w===5?a.readVarint():w===6?a.readSVarint():w===7?a.readBoolean():null}return f}(r))}Qh.prototype.feature=function(i){if(i<0||i>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[i];var e=this._pbf.readVarint()+this._pbf.pos;return new lf(this._pbf,e,this.extent,this._keys,this._values)};var hf=Jh;function uf(i,e,r){if(i===3){var a=new hf(r,r.readVarint()+r.pos);a.length&&(e[a.name]=a)}}Xa.VectorTile=function(i,e){this.layers=i.readFields(uf,{},e)},Xa.VectorTileFeature=Kh,Xa.VectorTileLayer=Jh;const df=Xa.VectorTileFeature.types,Hc=Math.pow(2,13);function Nl(i,e,r,a,f,v,w,E){i.emplaceBack(e,r,2*Math.floor(a*Hc)+w,f*Hc*2,v*Hc*2,Math.round(E))}class Xc{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new ce,this.centroidVertexArray=new N,this.indexArray=new qe,this.programConfigurations=new pr(e.layers,e.zoom),this.segments=new wt,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,a){this.features=[],this.hasPattern=Uc("fill-extrusion",this.layers,r);for(const{feature:f,id:v,index:w,sourceLayerIndex:E}of e){const k=this.layers[0]._featureFilter.needGeometry,F=va(f,k);if(!this.layers[0]._featureFilter.filter(new ar(this.zoom),F,a))continue;const B={id:v,sourceLayerIndex:E,index:w,geometry:k?F.geometry:ya(f),properties:f.properties,type:f.type,patterns:{}};this.hasPattern?this.features.push(Gc("fill-extrusion",this.layers,B,this.zoom,r)):this.addFeature(B,B.geometry,w,a,{}),r.featureIndex.insert(f,B.geometry,w,E,this.index,!0)}}addFeatures(e,r,a){for(const f of this.features){const{geometry:v}=f;this.addFeature(f,v,f.index,r,a)}}update(e,r,a){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,a)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,nf),this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,rf.members,!0),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(e,r,a,f,v){const w={x:0,y:0,vertexCount:0};for(const E of Vc(r,500)){let k=0;for(const K of E)k+=K.length;let F=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);for(const K of E){if(K.length===0||pf(K))continue;let re=0;for(let he=0;he<K.length;he++){const ve=K[he];if(he>=1){const Be=K[he-1];if(!ff(ve,Be)){F.vertexLength+4>wt.MAX_VERTEX_ARRAY_LENGTH&&(F=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const we=ve.sub(Be)._perp()._unit(),Me=Be.dist(ve);re+Me>32768&&(re=0),Nl(this.layoutVertexArray,ve.x,ve.y,we.x,we.y,0,0,re),Nl(this.layoutVertexArray,ve.x,ve.y,we.x,we.y,0,1,re),w.x+=2*ve.x,w.y+=2*ve.y,w.vertexCount+=2,re+=Me,Nl(this.layoutVertexArray,Be.x,Be.y,we.x,we.y,0,0,re),Nl(this.layoutVertexArray,Be.x,Be.y,we.x,we.y,0,1,re),w.x+=2*Be.x,w.y+=2*Be.y,w.vertexCount+=2;const st=F.vertexLength;this.indexArray.emplaceBack(st,st+2,st+1),this.indexArray.emplaceBack(st+1,st+2,st+3),F.vertexLength+=4,F.primitiveLength+=2}}}}if(F.vertexLength+k>wt.MAX_VERTEX_ARRAY_LENGTH&&(F=this.segments.prepareSegment(k,this.layoutVertexArray,this.indexArray)),df[e.type]!=="Polygon")continue;const B=[],j=[],H=F.vertexLength;for(const K of E)if(K.length!==0){K!==E[0]&&j.push(B.length/2);for(let re=0;re<K.length;re++){const he=K[re];Nl(this.layoutVertexArray,he.x,he.y,0,0,1,1,0),w.x+=he.x,w.y+=he.y,w.vertexCount+=1,B.push(he.x),B.push(he.y)}}const Y=qh(B,j);for(let K=0;K<Y.length;K+=3)this.indexArray.emplaceBack(H+Y[K],H+Y[K+2],H+Y[K+1]);F.primitiveLength+=Y.length/3,F.vertexLength+=k}for(let E=0;E<w.vertexCount;E++)this.centroidVertexArray.emplaceBack(Math.floor(w.x/w.vertexCount),Math.floor(w.y/w.vertexCount));this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,a,v,f)}}function ff(i,e){return i.x===e.x&&(i.x<0||i.x>Di)||i.y===e.y&&(i.y<0||i.y>Di)}function pf(i){return i.every(e=>e.x<0)||i.every(e=>e.x>Di)||i.every(e=>e.y<0)||i.every(e=>e.y>Di)}let eu;Nt("FillExtrusionBucket",Xc,{omit:["layers","features"]});var mf={get paint(){return eu=eu||new En({"fill-extrusion-opacity":new ii(le["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new hi(le["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ii(le["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ii(le["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new pa(le["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new hi(le["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new hi(le["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new ii(le["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class gf extends ns{constructor(e){super(e,mf)}createBucket(e){return new Xc(e)}queryRadius(){return cc(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature(e,r,a,f,v,w,E,k){const F=hc(e,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),w.angle,E),B=this.paint.get("fill-extrusion-height").evaluate(r,a),j=this.paint.get("fill-extrusion-base").evaluate(r,a),H=function(K,re,he,ve){const Be=[];for(const we of K){const Me=[we.x,we.y,0,1];uc(Me,Me,re),Be.push(new o(Me[0]/Me[3],Me[1]/Me[3]))}return Be}(F,k),Y=function(K,re,he,ve){const Be=[],we=[],Me=ve[8]*re,st=ve[9]*re,pt=ve[10]*re,Gt=ve[11]*re,ei=ve[8]*he,Vt=ve[9]*he,Rt=ve[10]*he,kt=ve[11]*he;for(const $t of K){const zt=[],It=[];for(const oi of $t){const ti=oi.x,Ai=oi.y,lr=ve[0]*ti+ve[4]*Ai+ve[12],mr=ve[1]*ti+ve[5]*Ai+ve[13],jr=ve[2]*ti+ve[6]*Ai+ve[14],Zn=ve[3]*ti+ve[7]*Ai+ve[15],An=jr+pt,Dr=Zn+Gt,en=lr+ei,un=mr+Vt,Mn=jr+Rt,kn=Zn+kt,Nr=new o((lr+Me)/Dr,(mr+st)/Dr);Nr.z=An/Dr,zt.push(Nr);const Vr=new o(en/kn,un/kn);Vr.z=Mn/kn,It.push(Vr)}Be.push(zt),we.push(It)}return[Be,we]}(f,j,B,k);return function(K,re,he){let ve=1/0;Dl(he,re)&&(ve=tu(he,re[0]));for(let Be=0;Be<re.length;Be++){const we=re[Be],Me=K[Be];for(let st=0;st<we.length-1;st++){const pt=we[st],Gt=[pt,we[st+1],Me[st+1],Me[st],pt];xa(he,Gt)&&(ve=Math.min(ve,tu(he,Gt)))}}return ve!==1/0&&ve}(Y[0],Y[1],H)}}function Vl(i,e){return i.x*e.x+i.y*e.y}function tu(i,e){if(i.length===1){let r=0;const a=e[r++];let f;for(;!f||a.equals(f);)if(f=e[r++],!f)return 1/0;for(;r<e.length;r++){const v=e[r],w=i[0],E=f.sub(a),k=v.sub(a),F=w.sub(a),B=Vl(E,E),j=Vl(E,k),H=Vl(k,k),Y=Vl(F,E),K=Vl(F,k),re=B*H-j*j,he=(H*Y-j*K)/re,ve=(B*K-j*Y)/re,Be=a.z*(1-he-ve)+f.z*he+v.z*ve;if(isFinite(Be))return Be}return 1/0}{let r=1/0;for(const a of e)r=Math.min(r,a.z);return r}}const _f=Pr([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:yf}=_f,vf=Pr([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:xf}=vf,bf=Xa.VectorTileFeature.types,wf=Math.cos(Math.PI/180*37.5),iu=Math.pow(2,14)/.5;class qc{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(r=>{this.gradients[r.id]={}}),this.layoutVertexArray=new oe,this.layoutVertexArray2=new ue,this.indexArray=new qe,this.programConfigurations=new pr(e.layers,e.zoom),this.segments=new wt,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,a){this.hasPattern=Uc("line",this.layers,r);const f=this.layers[0].layout.get("line-sort-key"),v=!f.isConstant(),w=[];for(const{feature:E,id:k,index:F,sourceLayerIndex:B}of e){const j=this.layers[0]._featureFilter.needGeometry,H=va(E,j);if(!this.layers[0]._featureFilter.filter(new ar(this.zoom),H,a))continue;const Y=v?f.evaluate(H,{},a):void 0,K={id:k,properties:E.properties,type:E.type,sourceLayerIndex:B,index:F,geometry:j?H.geometry:ya(E),patterns:{},sortKey:Y};w.push(K)}v&&w.sort((E,k)=>E.sortKey-k.sortKey);for(const E of w){const{geometry:k,index:F,sourceLayerIndex:B}=E;if(this.hasPattern){const j=Gc("line",this.layers,E,this.zoom,r);this.patternFeatures.push(j)}else this.addFeature(E,k,F,a,{});r.featureIndex.insert(e[F].feature,k,F,B,this.index)}}update(e,r,a){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,a)}addFeatures(e,r,a){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,r,a)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,xf)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,yf),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&Object.prototype.hasOwnProperty.call(e.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(e.properties,"mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,r,a,f,v){const w=this.layers[0].layout,E=w.get("line-join").evaluate(e,{}),k=w.get("line-cap"),F=w.get("line-miter-limit"),B=w.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const j of r)this.addLine(j,e,E,k,F,B);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,a,v,f)}addLine(e,r,a,f,v,w){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let ve=0;ve<e.length-1;ve++)this.totalDistance+=e[ve].dist(e[ve+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const E=bf[r.type]==="Polygon";let k=e.length;for(;k>=2&&e[k-1].equals(e[k-2]);)k--;let F=0;for(;F<k-1&&e[F].equals(e[F+1]);)F++;if(k<(E?3:2))return;a==="bevel"&&(v=1.05);const B=this.overscaling<=16?15*Di/(512*this.overscaling):0,j=this.segments.prepareSegment(10*k,this.layoutVertexArray,this.indexArray);let H,Y,K,re,he;this.e1=this.e2=-1,E&&(H=e[k-2],he=e[F].sub(H)._unit()._perp());for(let ve=F;ve<k;ve++){if(K=ve===k-1?E?e[F+1]:void 0:e[ve+1],K&&e[ve].equals(K))continue;he&&(re=he),H&&(Y=H),H=e[ve],he=K?K.sub(H)._unit()._perp():re,re=re||he;let Be=re.add(he);Be.x===0&&Be.y===0||Be._unit();const we=re.x*he.x+re.y*he.y,Me=Be.x*he.x+Be.y*he.y,st=Me!==0?1/Me:1/0,pt=2*Math.sqrt(2-2*Me),Gt=Me<wf&&Y&&K,ei=re.x*he.y-re.y*he.x>0;if(Gt&&ve>F){const kt=H.dist(Y);if(kt>2*B){const $t=H.sub(H.sub(Y)._mult(B/kt)._round());this.updateDistance(Y,$t),this.addCurrentVertex($t,re,0,0,j),Y=$t}}const Vt=Y&&K;let Rt=Vt?a:E?"butt":f;if(Vt&&Rt==="round"&&(st<w?Rt="miter":st<=2&&(Rt="fakeround")),Rt==="miter"&&st>v&&(Rt="bevel"),Rt==="bevel"&&(st>2&&(Rt="flipbevel"),st<v&&(Rt="miter")),Y&&this.updateDistance(Y,H),Rt==="miter")Be._mult(st),this.addCurrentVertex(H,Be,0,0,j);else if(Rt==="flipbevel"){if(st>100)Be=he.mult(-1);else{const kt=st*re.add(he).mag()/re.sub(he).mag();Be._perp()._mult(kt*(ei?-1:1))}this.addCurrentVertex(H,Be,0,0,j),this.addCurrentVertex(H,Be.mult(-1),0,0,j)}else if(Rt==="bevel"||Rt==="fakeround"){const kt=-Math.sqrt(st*st-1),$t=ei?kt:0,zt=ei?0:kt;if(Y&&this.addCurrentVertex(H,re,$t,zt,j),Rt==="fakeround"){const It=Math.round(180*pt/Math.PI/20);for(let oi=1;oi<It;oi++){let ti=oi/It;if(ti!==.5){const lr=ti-.5;ti+=ti*lr*(ti-1)*((1.0904+we*(we*(3.55645-1.43519*we)-3.2452))*lr*lr+(.848013+we*(.215638*we-1.06021)))}const Ai=he.sub(re)._mult(ti)._add(re)._unit()._mult(ei?-1:1);this.addHalfVertex(H,Ai.x,Ai.y,!1,ei,0,j)}}K&&this.addCurrentVertex(H,he,-$t,-zt,j)}else if(Rt==="butt")this.addCurrentVertex(H,Be,0,0,j);else if(Rt==="square"){const kt=Y?1:-1;this.addCurrentVertex(H,Be,kt,kt,j)}else Rt==="round"&&(Y&&(this.addCurrentVertex(H,re,0,0,j),this.addCurrentVertex(H,re,1,1,j,!0)),K&&(this.addCurrentVertex(H,he,-1,-1,j,!0),this.addCurrentVertex(H,he,0,0,j)));if(Gt&&ve<k-1){const kt=H.dist(K);if(kt>2*B){const $t=H.add(K.sub(H)._mult(B/kt)._round());this.updateDistance(H,$t),this.addCurrentVertex($t,he,0,0,j),H=$t}}}}addCurrentVertex(e,r,a,f,v,w=!1){const E=r.y*f-r.x,k=-r.y-r.x*f;this.addHalfVertex(e,r.x+r.y*a,r.y-r.x*a,w,!1,a,v),this.addHalfVertex(e,E,k,w,!0,-f,v),this.distance>iu/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(e,r,a,f,v,w))}addHalfVertex({x:e,y:r},a,f,v,w,E,k){const F=.5*(this.lineClips?this.scaledDistance*(iu-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((e<<1)+(v?1:0),(r<<1)+(w?1:0),Math.round(63*a)+128,Math.round(63*f)+128,1+(E===0?0:E<0?-1:1)|(63&F)<<2,F>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const B=k.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,B),k.primitiveLength++),w?this.e2=B:this.e1=B}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(e,r){this.distance+=e.dist(r),this.updateScaledDistance()}}let ru,nu;Nt("LineBucket",qc,{omit:["layers","patternFeatures"]});var su={get paint(){return nu=nu||new En({"line-opacity":new hi(le.paint_line["line-opacity"]),"line-color":new hi(le.paint_line["line-color"]),"line-translate":new ii(le.paint_line["line-translate"]),"line-translate-anchor":new ii(le.paint_line["line-translate-anchor"]),"line-width":new hi(le.paint_line["line-width"]),"line-gap-width":new hi(le.paint_line["line-gap-width"]),"line-offset":new hi(le.paint_line["line-offset"]),"line-blur":new hi(le.paint_line["line-blur"]),"line-dasharray":new vl(le.paint_line["line-dasharray"]),"line-pattern":new pa(le.paint_line["line-pattern"]),"line-gradient":new go(le.paint_line["line-gradient"])})},get layout(){return ru=ru||new En({"line-cap":new ii(le.layout_line["line-cap"]),"line-join":new hi(le.layout_line["line-join"]),"line-miter-limit":new ii(le.layout_line["line-miter-limit"]),"line-round-limit":new ii(le.layout_line["line-round-limit"]),"line-sort-key":new hi(le.layout_line["line-sort-key"])})}};class Cf extends hi{possiblyEvaluate(e,r){return r=new ar(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,zoomHistory:r.zoomHistory,transition:r.transition}),super.possiblyEvaluate(e,r)}evaluate(e,r,a,f){return r=ne({},r,{zoom:Math.floor(r.zoom)}),super.evaluate(e,r,a,f)}}let gc;class Sf extends ns{constructor(e){super(e,su),this.gradientVersion=0,gc||(gc=new Cf(su.paint.properties["line-width"].specification),gc.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(e){if(e==="line-gradient"){const r=this.gradientExpression();this.stepInterpolant=!!function(a){return a._styleExpression!==void 0}(r)&&r._styleExpression.expression instanceof Es,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(e,r){super.recalculate(e,r),this.paint._values["line-floorwidth"]=gc.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e)}createBucket(e){return new qc(e)}queryRadius(e){const r=e,a=au(Ol("line-width",this,r),Ol("line-gap-width",this,r)),f=Ol("line-offset",this,r);return a/2+Math.abs(f)+cc(this.paint.get("line-translate"))}queryIntersectsFeature(e,r,a,f,v,w,E){const k=hc(e,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),w.angle,E),F=E/2*au(this.paint.get("line-width").evaluate(r,a),this.paint.get("line-gap-width").evaluate(r,a)),B=this.paint.get("line-offset").evaluate(r,a);return B&&(f=function(j,H){const Y=[];for(let K=0;K<j.length;K++){const re=j[K],he=[];for(let ve=0;ve<re.length;ve++){const Be=re[ve-1],we=re[ve],Me=re[ve+1],st=ve===0?new o(0,0):we.sub(Be)._unit()._perp(),pt=ve===re.length-1?new o(0,0):Me.sub(we)._unit()._perp(),Gt=st._add(pt)._unit(),ei=Gt.x*pt.x+Gt.y*pt.y;ei!==0&&Gt._mult(1/ei),he.push(Gt._mult(H)._add(we))}Y.push(he)}return Y}(f,B*E)),function(j,H,Y){for(let K=0;K<H.length;K++){const re=H[K];if(j.length>=3){for(let he=0;he<re.length;he++)if(Yo(j,re[he]))return!0}if(oc(j,re,Y))return!0}return!1}(k,f,F)}isTileClipped(){return!0}}function au(i,e){return e>0?e+2*i:i}const Tf=Pr([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Ef=Pr([{name:"a_projected_pos",components:3,type:"Float32"}],4);Pr([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const If=Pr([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]);Pr([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const ou=Pr([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Pf=Pr([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function Af(i,e,r){return i.sections.forEach(a=>{a.text=function(f,v,w){const E=v.layout.get("text-transform").evaluate(w,{});return E==="uppercase"?f=f.toLocaleUpperCase():E==="lowercase"&&(f=f.toLocaleLowerCase()),fa.applyArabicShaping&&(f=fa.applyArabicShaping(f)),f}(a.text,e,r)}),i}Pr([{name:"triangle",components:3,type:"Uint16"}]),Pr([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),Pr([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),Pr([{type:"Float32",name:"offsetX"}]),Pr([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),Pr([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);const Ul={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"};var Br=24,lu=Qi,cu=function(i,e,r,a,f){var v,w,E=8*f-a-1,k=(1<<E)-1,F=k>>1,B=-7,j=r?f-1:0,H=r?-1:1,Y=i[e+j];for(j+=H,v=Y&(1<<-B)-1,Y>>=-B,B+=E;B>0;v=256*v+i[e+j],j+=H,B-=8);for(w=v&(1<<-B)-1,v>>=-B,B+=a;B>0;w=256*w+i[e+j],j+=H,B-=8);if(v===0)v=1-F;else{if(v===k)return w?NaN:1/0*(Y?-1:1);w+=Math.pow(2,a),v-=F}return(Y?-1:1)*w*Math.pow(2,v-a)},hu=function(i,e,r,a,f,v){var w,E,k,F=8*v-f-1,B=(1<<F)-1,j=B>>1,H=f===23?Math.pow(2,-24)-Math.pow(2,-77):0,Y=a?0:v-1,K=a?1:-1,re=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(E=isNaN(e)?1:0,w=B):(w=Math.floor(Math.log(e)/Math.LN2),e*(k=Math.pow(2,-w))<1&&(w--,k*=2),(e+=w+j>=1?H/k:H*Math.pow(2,1-j))*k>=2&&(w++,k/=2),w+j>=B?(E=0,w=B):w+j>=1?(E=(e*k-1)*Math.pow(2,f),w+=j):(E=e*Math.pow(2,j-1)*Math.pow(2,f),w=0));f>=8;i[r+Y]=255&E,Y+=K,E/=256,f-=8);for(w=w<<f|E,F+=f;F>0;i[r+Y]=255&w,Y+=K,w/=256,F-=8);i[r+Y-K]|=128*re};function Qi(i){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(i)?i:new Uint8Array(i||0),this.pos=0,this.type=0,this.length=this.buf.length}Qi.Varint=0,Qi.Fixed64=1,Qi.Bytes=2,Qi.Fixed32=5;var $c=4294967296,uu=1/$c,du=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function ba(i){return i.type===Qi.Bytes?i.readVarint()+i.pos:i.pos+1}function Qo(i,e,r){return r?4294967296*e+(i>>>0):4294967296*(e>>>0)+(i>>>0)}function fu(i,e,r){var a=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));r.realloc(a);for(var f=r.pos-1;f>=i;f--)r.buf[f+a]=r.buf[f]}function Mf(i,e){for(var r=0;r<i.length;r++)e.writeVarint(i[r])}function kf(i,e){for(var r=0;r<i.length;r++)e.writeSVarint(i[r])}function Df(i,e){for(var r=0;r<i.length;r++)e.writeFloat(i[r])}function Of(i,e){for(var r=0;r<i.length;r++)e.writeDouble(i[r])}function Lf(i,e){for(var r=0;r<i.length;r++)e.writeBoolean(i[r])}function Ff(i,e){for(var r=0;r<i.length;r++)e.writeFixed32(i[r])}function zf(i,e){for(var r=0;r<i.length;r++)e.writeSFixed32(i[r])}function Rf(i,e){for(var r=0;r<i.length;r++)e.writeFixed64(i[r])}function Bf(i,e){for(var r=0;r<i.length;r++)e.writeSFixed64(i[r])}function _c(i,e){return(i[e]|i[e+1]<<8|i[e+2]<<16)+16777216*i[e+3]}function el(i,e,r){i[r]=e,i[r+1]=e>>>8,i[r+2]=e>>>16,i[r+3]=e>>>24}function pu(i,e){return(i[e]|i[e+1]<<8|i[e+2]<<16)+(i[e+3]<<24)}Qi.prototype={destroy:function(){this.buf=null},readFields:function(i,e,r){for(r=r||this.length;this.pos<r;){var a=this.readVarint(),f=a>>3,v=this.pos;this.type=7&a,i(f,e,this),this.pos===v&&this.skip(a)}return e},readMessage:function(i,e){return this.readFields(i,e,this.readVarint()+this.pos)},readFixed32:function(){var i=_c(this.buf,this.pos);return this.pos+=4,i},readSFixed32:function(){var i=pu(this.buf,this.pos);return this.pos+=4,i},readFixed64:function(){var i=_c(this.buf,this.pos)+_c(this.buf,this.pos+4)*$c;return this.pos+=8,i},readSFixed64:function(){var i=_c(this.buf,this.pos)+pu(this.buf,this.pos+4)*$c;return this.pos+=8,i},readFloat:function(){var i=cu(this.buf,this.pos,!0,23,4);return this.pos+=4,i},readDouble:function(){var i=cu(this.buf,this.pos,!0,52,8);return this.pos+=8,i},readVarint:function(i){var e,r,a=this.buf;return e=127&(r=a[this.pos++]),r<128?e:(e|=(127&(r=a[this.pos++]))<<7,r<128?e:(e|=(127&(r=a[this.pos++]))<<14,r<128?e:(e|=(127&(r=a[this.pos++]))<<21,r<128?e:function(f,v,w){var E,k,F=w.buf;if(E=(112&(k=F[w.pos++]))>>4,k<128||(E|=(127&(k=F[w.pos++]))<<3,k<128)||(E|=(127&(k=F[w.pos++]))<<10,k<128)||(E|=(127&(k=F[w.pos++]))<<17,k<128)||(E|=(127&(k=F[w.pos++]))<<24,k<128)||(E|=(1&(k=F[w.pos++]))<<31,k<128))return Qo(f,E,v);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(r=a[this.pos]))<<28,i,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var i=this.readVarint();return i%2==1?(i+1)/-2:i/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var i=this.readVarint()+this.pos,e=this.pos;return this.pos=i,i-e>=12&&du?function(r,a,f){return du.decode(r.subarray(a,f))}(this.buf,e,i):function(r,a,f){for(var v="",w=a;w<f;){var E,k,F,B=r[w],j=null,H=B>239?4:B>223?3:B>191?2:1;if(w+H>f)break;H===1?B<128&&(j=B):H===2?(192&(E=r[w+1]))==128&&(j=(31&B)<<6|63&E)<=127&&(j=null):H===3?(k=r[w+2],(192&(E=r[w+1]))==128&&(192&k)==128&&((j=(15&B)<<12|(63&E)<<6|63&k)<=2047||j>=55296&&j<=57343)&&(j=null)):H===4&&(k=r[w+2],F=r[w+3],(192&(E=r[w+1]))==128&&(192&k)==128&&(192&F)==128&&((j=(15&B)<<18|(63&E)<<12|(63&k)<<6|63&F)<=65535||j>=1114112)&&(j=null)),j===null?(j=65533,H=1):j>65535&&(j-=65536,v+=String.fromCharCode(j>>>10&1023|55296),j=56320|1023&j),v+=String.fromCharCode(j),w+=H}return v}(this.buf,e,i)},readBytes:function(){var i=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,i);return this.pos=i,e},readPackedVarint:function(i,e){if(this.type!==Qi.Bytes)return i.push(this.readVarint(e));var r=ba(this);for(i=i||[];this.pos<r;)i.push(this.readVarint(e));return i},readPackedSVarint:function(i){if(this.type!==Qi.Bytes)return i.push(this.readSVarint());var e=ba(this);for(i=i||[];this.pos<e;)i.push(this.readSVarint());return i},readPackedBoolean:function(i){if(this.type!==Qi.Bytes)return i.push(this.readBoolean());var e=ba(this);for(i=i||[];this.pos<e;)i.push(this.readBoolean());return i},readPackedFloat:function(i){if(this.type!==Qi.Bytes)return i.push(this.readFloat());var e=ba(this);for(i=i||[];this.pos<e;)i.push(this.readFloat());return i},readPackedDouble:function(i){if(this.type!==Qi.Bytes)return i.push(this.readDouble());var e=ba(this);for(i=i||[];this.pos<e;)i.push(this.readDouble());return i},readPackedFixed32:function(i){if(this.type!==Qi.Bytes)return i.push(this.readFixed32());var e=ba(this);for(i=i||[];this.pos<e;)i.push(this.readFixed32());return i},readPackedSFixed32:function(i){if(this.type!==Qi.Bytes)return i.push(this.readSFixed32());var e=ba(this);for(i=i||[];this.pos<e;)i.push(this.readSFixed32());return i},readPackedFixed64:function(i){if(this.type!==Qi.Bytes)return i.push(this.readFixed64());var e=ba(this);for(i=i||[];this.pos<e;)i.push(this.readFixed64());return i},readPackedSFixed64:function(i){if(this.type!==Qi.Bytes)return i.push(this.readSFixed64());var e=ba(this);for(i=i||[];this.pos<e;)i.push(this.readSFixed64());return i},skip:function(i){var e=7&i;if(e===Qi.Varint)for(;this.buf[this.pos++]>127;);else if(e===Qi.Bytes)this.pos=this.readVarint()+this.pos;else if(e===Qi.Fixed32)this.pos+=4;else{if(e!==Qi.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(i,e){this.writeVarint(i<<3|e)},realloc:function(i){for(var e=this.length||16;e<this.pos+i;)e*=2;if(e!==this.length){var r=new Uint8Array(e);r.set(this.buf),this.buf=r,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(i){this.realloc(4),el(this.buf,i,this.pos),this.pos+=4},writeSFixed32:function(i){this.realloc(4),el(this.buf,i,this.pos),this.pos+=4},writeFixed64:function(i){this.realloc(8),el(this.buf,-1&i,this.pos),el(this.buf,Math.floor(i*uu),this.pos+4),this.pos+=8},writeSFixed64:function(i){this.realloc(8),el(this.buf,-1&i,this.pos),el(this.buf,Math.floor(i*uu),this.pos+4),this.pos+=8},writeVarint:function(i){(i=+i||0)>268435455||i<0?function(e,r){var a,f;if(e>=0?(a=e%4294967296|0,f=e/4294967296|0):(f=~(-e/4294967296),4294967295^(a=~(-e%4294967296))?a=a+1|0:(a=0,f=f+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");r.realloc(10),function(v,w,E){E.buf[E.pos++]=127&v|128,v>>>=7,E.buf[E.pos++]=127&v|128,v>>>=7,E.buf[E.pos++]=127&v|128,v>>>=7,E.buf[E.pos++]=127&v|128,E.buf[E.pos]=127&(v>>>=7)}(a,0,r),function(v,w){var E=(7&v)<<4;w.buf[w.pos++]|=E|((v>>>=3)?128:0),v&&(w.buf[w.pos++]=127&v|((v>>>=7)?128:0),v&&(w.buf[w.pos++]=127&v|((v>>>=7)?128:0),v&&(w.buf[w.pos++]=127&v|((v>>>=7)?128:0),v&&(w.buf[w.pos++]=127&v|((v>>>=7)?128:0),v&&(w.buf[w.pos++]=127&v)))))}(f,r)}(i,this):(this.realloc(4),this.buf[this.pos++]=127&i|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=i>>>7&127))))},writeSVarint:function(i){this.writeVarint(i<0?2*-i-1:2*i)},writeBoolean:function(i){this.writeVarint(!!i)},writeString:function(i){i=String(i),this.realloc(4*i.length),this.pos++;var e=this.pos;this.pos=function(a,f,v){for(var w,E,k=0;k<f.length;k++){if((w=f.charCodeAt(k))>55295&&w<57344){if(!E){w>56319||k+1===f.length?(a[v++]=239,a[v++]=191,a[v++]=189):E=w;continue}if(w<56320){a[v++]=239,a[v++]=191,a[v++]=189,E=w;continue}w=E-55296<<10|w-56320|65536,E=null}else E&&(a[v++]=239,a[v++]=191,a[v++]=189,E=null);w<128?a[v++]=w:(w<2048?a[v++]=w>>6|192:(w<65536?a[v++]=w>>12|224:(a[v++]=w>>18|240,a[v++]=w>>12&63|128),a[v++]=w>>6&63|128),a[v++]=63&w|128)}return v}(this.buf,i,this.pos);var r=this.pos-e;r>=128&&fu(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r},writeFloat:function(i){this.realloc(4),hu(this.buf,i,this.pos,!0,23,4),this.pos+=4},writeDouble:function(i){this.realloc(8),hu(this.buf,i,this.pos,!0,52,8),this.pos+=8},writeBytes:function(i){var e=i.length;this.writeVarint(e),this.realloc(e);for(var r=0;r<e;r++)this.buf[this.pos++]=i[r]},writeRawMessage:function(i,e){this.pos++;var r=this.pos;i(e,this);var a=this.pos-r;a>=128&&fu(r,a,this),this.pos=r-1,this.writeVarint(a),this.pos+=a},writeMessage:function(i,e,r){this.writeTag(i,Qi.Bytes),this.writeRawMessage(e,r)},writePackedVarint:function(i,e){e.length&&this.writeMessage(i,Mf,e)},writePackedSVarint:function(i,e){e.length&&this.writeMessage(i,kf,e)},writePackedBoolean:function(i,e){e.length&&this.writeMessage(i,Lf,e)},writePackedFloat:function(i,e){e.length&&this.writeMessage(i,Df,e)},writePackedDouble:function(i,e){e.length&&this.writeMessage(i,Of,e)},writePackedFixed32:function(i,e){e.length&&this.writeMessage(i,Ff,e)},writePackedSFixed32:function(i,e){e.length&&this.writeMessage(i,zf,e)},writePackedFixed64:function(i,e){e.length&&this.writeMessage(i,Rf,e)},writePackedSFixed64:function(i,e){e.length&&this.writeMessage(i,Bf,e)},writeBytesField:function(i,e){this.writeTag(i,Qi.Bytes),this.writeBytes(e)},writeFixed32Field:function(i,e){this.writeTag(i,Qi.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(i,e){this.writeTag(i,Qi.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(i,e){this.writeTag(i,Qi.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(i,e){this.writeTag(i,Qi.Fixed64),this.writeSFixed64(e)},writeVarintField:function(i,e){this.writeTag(i,Qi.Varint),this.writeVarint(e)},writeSVarintField:function(i,e){this.writeTag(i,Qi.Varint),this.writeSVarint(e)},writeStringField:function(i,e){this.writeTag(i,Qi.Bytes),this.writeString(e)},writeFloatField:function(i,e){this.writeTag(i,Qi.Fixed32),this.writeFloat(e)},writeDoubleField:function(i,e){this.writeTag(i,Qi.Fixed64),this.writeDouble(e)},writeBooleanField:function(i,e){this.writeVarintField(i,!!e)}};var Yc=m(lu);const Zc=3;function jf(i,e,r){i===1&&r.readMessage(Nf,e)}function Nf(i,e,r){if(i===3){const{id:a,bitmap:f,width:v,height:w,left:E,top:k,advance:F}=r.readMessage(Vf,{});e.push({id:a,bitmap:new Fl({width:v+2*Zc,height:w+2*Zc},f),metrics:{width:v,height:w,left:E,top:k,advance:F}})}}function Vf(i,e,r){i===1?e.id=r.readVarint():i===2?e.bitmap=r.readBytes():i===3?e.width=r.readVarint():i===4?e.height=r.readVarint():i===5?e.left=r.readSVarint():i===6?e.top=r.readSVarint():i===7&&(e.advance=r.readVarint())}const mu=Zc;function gu(i){let e=0,r=0;for(const w of i)e+=w.w*w.h,r=Math.max(r,w.w);i.sort((w,E)=>E.h-w.h);const a=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),r),h:1/0}];let f=0,v=0;for(const w of i)for(let E=a.length-1;E>=0;E--){const k=a[E];if(!(w.w>k.w||w.h>k.h)){if(w.x=k.x,w.y=k.y,v=Math.max(v,w.y+w.h),f=Math.max(f,w.x+w.w),w.w===k.w&&w.h===k.h){const F=a.pop();E<a.length&&(a[E]=F)}else w.h===k.h?(k.x+=w.w,k.w-=w.w):w.w===k.w?(k.y+=w.h,k.h-=w.h):(a.push({x:k.x+w.w,y:k.y,w:k.w-w.w,h:w.h}),k.y+=w.h,k.h-=w.h);break}}return{w:f,h:v,fill:e/(f*v)||0}}const zn=1;class Kc{constructor(e,{pixelRatio:r,version:a,stretchX:f,stretchY:v,content:w}){this.paddedRect=e,this.pixelRatio=r,this.stretchX=f,this.stretchY=v,this.content=w,this.version=a}get tl(){return[this.paddedRect.x+zn,this.paddedRect.y+zn]}get br(){return[this.paddedRect.x+this.paddedRect.w-zn,this.paddedRect.y+this.paddedRect.h-zn]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2*zn)/this.pixelRatio,(this.paddedRect.h-2*zn)/this.pixelRatio]}}class _u{constructor(e,r){const a={},f={};this.haveRenderCallbacks=[];const v=[];this.addImages(e,a,v),this.addImages(r,f,v);const{w,h:E}=gu(v),k=new os({width:w||1,height:E||1});for(const F in e){const B=e[F],j=a[F].paddedRect;os.copy(B.data,k,{x:0,y:0},{x:j.x+zn,y:j.y+zn},B.data)}for(const F in r){const B=r[F],j=f[F].paddedRect,H=j.x+zn,Y=j.y+zn,K=B.data.width,re=B.data.height;os.copy(B.data,k,{x:0,y:0},{x:H,y:Y},B.data),os.copy(B.data,k,{x:0,y:re-1},{x:H,y:Y-1},{width:K,height:1}),os.copy(B.data,k,{x:0,y:0},{x:H,y:Y+re},{width:K,height:1}),os.copy(B.data,k,{x:K-1,y:0},{x:H-1,y:Y},{width:1,height:re}),os.copy(B.data,k,{x:0,y:0},{x:H+K,y:Y},{width:1,height:re})}this.image=k,this.iconPositions=a,this.patternPositions=f}addImages(e,r,a){for(const f in e){const v=e[f],w={x:0,y:0,w:v.data.width+2*zn,h:v.data.height+2*zn};a.push(w),r[f]=new Kc(w,v),v.hasRenderCallback&&this.haveRenderCallbacks.push(f)}}patchUpdatedImages(e,r){e.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const a in e.updatedImages)this.patchUpdatedImage(this.iconPositions[a],e.getImage(a),r),this.patchUpdatedImage(this.patternPositions[a],e.getImage(a),r)}patchUpdatedImage(e,r,a){if(!e||!r||e.version===r.version)return;e.version=r.version;const[f,v]=e.tl;a.update(r.data,void 0,{x:f,y:v})}}var qa;Nt("ImagePosition",Kc),Nt("ImageAtlas",_u),V.ah=void 0,(qa=V.ah||(V.ah={}))[qa.none=0]="none",qa[qa.horizontal=1]="horizontal",qa[qa.vertical=2]="vertical",qa[qa.horizontalOnly=3]="horizontalOnly";const Gl=-17;class Wl{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(e,r){const a=new Wl;return a.scale=e||1,a.fontStack=r,a}static forImage(e){const r=new Wl;return r.imageName=e,r}}class tl{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,r){const a=new tl;for(let f=0;f<e.sections.length;f++){const v=e.sections[f];v.image?a.addImageSection(v):a.addTextSection(v,r)}return a}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSectionIndex(e){return this.sectionIndex[e]}getCharCode(e){return this.text.charCodeAt(e)}verticalizePunctuation(){this.text=function(e){let r="";for(let a=0;a<e.length;a++){const f=e.charCodeAt(a+1)||null,v=e.charCodeAt(a-1)||null;r+=f&&Ks(f)&&!Ul[e[a+1]]||v&&Ks(v)&&!Ul[e[a-1]]||!Ul[e[a]]?e[a]:Ul[e[a]]}return r}(this.text)}trim(){let e=0;for(let a=0;a<this.text.length&&vc[this.text.charCodeAt(a)];a++)e++;let r=this.text.length;for(let a=this.text.length-1;a>=0&&a>=e&&vc[this.text.charCodeAt(a)];a--)r--;this.text=this.text.substring(e,r),this.sectionIndex=this.sectionIndex.slice(e,r)}substring(e,r){const a=new tl;return a.text=this.text.substring(e,r),a.sectionIndex=this.sectionIndex.slice(e,r),a.sections=this.sections,a}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,r)=>Math.max(e,this.sections[r].scale),0)}addTextSection(e,r){this.text+=e.text,this.sections.push(Wl.forText(e.scale,e.fontStack||r));const a=this.sections.length-1;for(let f=0;f<e.text.length;++f)this.sectionIndex.push(a)}addImageSection(e){const r=e.image?e.image.name:"";if(r.length===0)return void ut("Can't add FormattedSection with an empty image.");const a=this.getNextImageSectionCharCode();a?(this.text+=String.fromCharCode(a),this.sections.push(Wl.forImage(r)),this.sectionIndex.push(this.sections.length-1)):ut("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function yc(i,e,r,a,f,v,w,E,k,F,B,j,H,Y,K,re){const he=tl.fromFeature(i,f);let ve;j===V.ah.vertical&&he.verticalizePunctuation();const{processBidirectionalText:Be,processStyledBidirectionalText:we}=fa;if(Be&&he.sections.length===1){ve=[];const pt=Be(he.toString(),Jc(he,F,v,e,a,Y,K));for(const Gt of pt){const ei=new tl;ei.text=Gt,ei.sections=he.sections;for(let Vt=0;Vt<Gt.length;Vt++)ei.sectionIndex.push(0);ve.push(ei)}}else if(we){ve=[];const pt=we(he.text,he.sectionIndex,Jc(he,F,v,e,a,Y,K));for(const Gt of pt){const ei=new tl;ei.text=Gt[0],ei.sectionIndex=Gt[1],ei.sections=he.sections,ve.push(ei)}}else ve=function(pt,Gt){const ei=[],Vt=pt.text;let Rt=0;for(const kt of Gt)ei.push(pt.substring(Rt,kt)),Rt=kt;return Rt<Vt.length&&ei.push(pt.substring(Rt,Vt.length)),ei}(he,Jc(he,F,v,e,a,Y,K));const Me=[],st={positionedLines:Me,text:he.toString(),top:B[1],bottom:B[1],left:B[0],right:B[0],writingMode:j,iconsInText:!1,verticalizable:!1};return function(pt,Gt,ei,Vt,Rt,kt,$t,zt,It,oi,ti,Ai){let lr=0,mr=Gl,jr=0,Zn=0;const An=zt==="right"?1:zt==="left"?0:.5;let Dr=0;for(const Nr of Rt){Nr.trim();const Vr=Nr.getMaxScale(),yn=(Vr-1)*Br,Dn={positionedGlyphs:[],lineOffset:0};pt.positionedLines[Dr]=Dn;const vn=Dn.positionedGlyphs;let Rn=0;if(!Nr.length()){mr+=kt,++Dr;continue}for(let Ur=0;Ur<Nr.length();Ur++){const Li=Nr.getSection(Ur),xn=Nr.getSectionIndex(Ur),dn=Nr.getCharCode(Ur);let Gr=0,bs=null,Rs=null,Bs=null,wa=Br;const ws=!(It===V.ah.horizontal||!ti&&!da(dn)||ti&&(vc[dn]||(en=dn,Bt.Arabic(en)||Bt["Arabic Supplement"](en)||Bt["Arabic Extended-A"](en)||Bt["Arabic Presentation Forms-A"](en)||Bt["Arabic Presentation Forms-B"](en))));if(Li.imageName){const cs=Vt[Li.imageName];if(!cs)continue;Bs=Li.imageName,pt.iconsInText=pt.iconsInText||!0,Rs=cs.paddedRect;const jn=cs.displaySize;Li.scale=Li.scale*Br/Ai,bs={width:jn[0],height:jn[1],left:zn,top:-mu,advance:ws?jn[1]:jn[0]},Gr=yn+(Br-jn[1]*Li.scale),wa=bs.advance;const Ca=ws?jn[0]*Li.scale-Br*Vr:jn[1]*Li.scale-Br*Vr;Ca>0&&Ca>Rn&&(Rn=Ca)}else{const cs=ei[Li.fontStack],jn=cs&&cs[dn];if(jn&&jn.rect)Rs=jn.rect,bs=jn.metrics;else{const Ca=Gt[Li.fontStack],Yl=Ca&&Ca[dn];if(!Yl)continue;bs=Yl.metrics}Gr=(Vr-Li.scale)*Br}ws?(pt.verticalizable=!0,vn.push({glyph:dn,imageName:Bs,x:lr,y:mr+Gr,vertical:ws,scale:Li.scale,fontStack:Li.fontStack,sectionIndex:xn,metrics:bs,rect:Rs}),lr+=wa*Li.scale+oi):(vn.push({glyph:dn,imageName:Bs,x:lr,y:mr+Gr,vertical:ws,scale:Li.scale,fontStack:Li.fontStack,sectionIndex:xn,metrics:bs,rect:Rs}),lr+=bs.advance*Li.scale+oi)}vn.length!==0&&(jr=Math.max(lr-oi,jr),Wf(vn,0,vn.length-1,An,Rn)),lr=0;const Bn=kt*Vr+Rn;Dn.lineOffset=Math.max(Rn,yn),mr+=Bn,Zn=Math.max(Bn,Zn),++Dr}var en;const un=mr-Gl,{horizontalAlign:Mn,verticalAlign:kn}=Qc($t);(function(Nr,Vr,yn,Dn,vn,Rn,Bn,Ur,Li){const xn=(Vr-yn)*vn;let dn=0;dn=Rn!==Bn?-Ur*Dn-Gl:(-Dn*Li+.5)*Bn;for(const Gr of Nr)for(const bs of Gr.positionedGlyphs)bs.x+=xn,bs.y+=dn})(pt.positionedLines,An,Mn,kn,jr,Zn,kt,un,Rt.length),pt.top+=-kn*un,pt.bottom=pt.top+un,pt.left+=-Mn*jr,pt.right=pt.left+jr}(st,e,r,a,ve,w,E,k,j,F,H,re),!function(pt){for(const Gt of pt)if(Gt.positionedGlyphs.length!==0)return!1;return!0}(Me)&&st}const vc={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Uf={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function yu(i,e,r,a,f,v){if(e.imageName){const w=a[e.imageName];return w?w.displaySize[0]*e.scale*Br/v+f:0}{const w=r[e.fontStack],E=w&&w[i];return E?E.metrics.advance*e.scale+f:0}}function vu(i,e,r,a){const f=Math.pow(i-e,2);return a?i<e?f/2:2*f:f+Math.abs(r)*r}function Gf(i,e,r){let a=0;return i===10&&(a-=1e4),r&&(a+=150),i!==40&&i!==65288||(a+=50),e!==41&&e!==65289||(a+=50),a}function xu(i,e,r,a,f,v){let w=null,E=vu(e,r,f,v);for(const k of a){const F=vu(e-k.x,r,f,v)+k.badness;F<=E&&(w=k,E=F)}return{index:i,x:e,priorBreak:w,badness:E}}function bu(i){return i?bu(i.priorBreak).concat(i.index):[]}function Jc(i,e,r,a,f,v,w){if(v!=="point")return[];if(!i)return[];const E=[],k=function(H,Y,K,re,he,ve){let Be=0;for(let we=0;we<H.length();we++){const Me=H.getSection(we);Be+=yu(H.getCharCode(we),Me,re,he,Y,ve)}return Be/Math.max(1,Math.ceil(Be/K))}(i,e,r,a,f,w),F=i.text.indexOf("​")>=0;let B=0;for(let H=0;H<i.length();H++){const Y=i.getSection(H),K=i.getCharCode(H);if(vc[K]||(B+=yu(K,Y,a,f,e,w)),H<i.length()-1){const re=!((j=K)<11904||!(Bt["Bopomofo Extended"](j)||Bt.Bopomofo(j)||Bt["CJK Compatibility Forms"](j)||Bt["CJK Compatibility Ideographs"](j)||Bt["CJK Compatibility"](j)||Bt["CJK Radicals Supplement"](j)||Bt["CJK Strokes"](j)||Bt["CJK Symbols and Punctuation"](j)||Bt["CJK Unified Ideographs Extension A"](j)||Bt["CJK Unified Ideographs"](j)||Bt["Enclosed CJK Letters and Months"](j)||Bt["Halfwidth and Fullwidth Forms"](j)||Bt.Hiragana(j)||Bt["Ideographic Description Characters"](j)||Bt["Kangxi Radicals"](j)||Bt["Katakana Phonetic Extensions"](j)||Bt.Katakana(j)||Bt["Vertical Forms"](j)||Bt["Yi Radicals"](j)||Bt["Yi Syllables"](j)));(Uf[K]||re||Y.imageName)&&E.push(xu(H+1,B,k,E,Gf(K,i.getCharCode(H+1),re&&F),!1))}}var j;return bu(xu(i.length(),B,k,E,0,!0))}function Qc(i){let e=.5,r=.5;switch(i){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(i){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:e,verticalAlign:r}}function Wf(i,e,r,a,f){if(!a&&!f)return;const v=i[r],w=(i[r].x+v.metrics.advance*v.scale)*a;for(let E=e;E<=r;E++)i[E].x-=w,i[E].y+=f}function Hf(i,e,r){const{horizontalAlign:a,verticalAlign:f}=Qc(r),v=e[0]-i.displaySize[0]*a,w=e[1]-i.displaySize[1]*f;return{image:i,top:w,bottom:w+i.displaySize[1],left:v,right:v+i.displaySize[0]}}function wu(i,e,r,a,f,v){const w=i.image;let E;if(w.content){const he=w.content,ve=w.pixelRatio||1;E=[he[0]/ve,he[1]/ve,w.displaySize[0]-he[2]/ve,w.displaySize[1]-he[3]/ve]}const k=e.left*v,F=e.right*v;let B,j,H,Y;r==="width"||r==="both"?(Y=f[0]+k-a[3],j=f[0]+F+a[1]):(Y=f[0]+(k+F-w.displaySize[0])/2,j=Y+w.displaySize[0]);const K=e.top*v,re=e.bottom*v;return r==="height"||r==="both"?(B=f[1]+K-a[0],H=f[1]+re+a[2]):(B=f[1]+(K+re-w.displaySize[1])/2,H=B+w.displaySize[1]),{image:w,top:B,right:j,bottom:H,left:Y,collisionPadding:E}}const Hl=255,ta=128,$a=Hl*ta;function Cu(i,e){const{expression:r}=e;if(r.kind==="constant")return{kind:"constant",layoutSize:r.evaluate(new ar(i+1))};if(r.kind==="source")return{kind:"source"};{const{zoomStops:a,interpolationType:f}=r;let v=0;for(;v<a.length&&a[v]<=i;)v++;v=Math.max(0,v-1);let w=v;for(;w<a.length&&a[w]<i+1;)w++;w=Math.min(a.length-1,w);const E=a[v],k=a[w];return r.kind==="composite"?{kind:"composite",minZoom:E,maxZoom:k,interpolationType:f}:{kind:"camera",minZoom:E,maxZoom:k,minSize:r.evaluate(new ar(E)),maxSize:r.evaluate(new ar(k)),interpolationType:f}}}function eh(i,e,r){let a="never";const f=i.get(e);return f?a=f:i.get(r)&&(a="always"),a}const Xf=Xa.VectorTileFeature.types,qf=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function xc(i,e,r,a,f,v,w,E,k,F,B,j,H){const Y=E?Math.min($a,Math.round(E[0])):0,K=E?Math.min($a,Math.round(E[1])):0;i.emplaceBack(e,r,Math.round(32*a),Math.round(32*f),v,w,(Y<<1)+(k?1:0),K,16*F,16*B,256*j,256*H)}function th(i,e,r){i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r)}function $f(i){for(const e of i.sections)if(Ql(e.text))return!0;return!1}class ih{constructor(e){this.layoutVertexArray=new Se,this.indexArray=new qe,this.programConfigurations=e,this.segments=new wt,this.dynamicLayoutVertexArray=new We,this.opacityVertexArray=new ge,this.hasVisibleVertices=!1,this.placedSymbolArray=new t}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(e,r,a,f){this.isEmpty()||(a&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Tf.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,r),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,Ef.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,qf,!0),this.opacityVertexBuffer.itemSize=1),(a||f)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}Nt("SymbolBuffers",ih);class rh{constructor(e,r,a){this.layoutVertexArray=new e,this.layoutAttributes=r,this.indexArray=new a,this.segments=new wt,this.collisionVertexArray=new He}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,If.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}Nt("CollisionBuffers",rh);class il{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(w=>w.id),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Lc([]),this.placementViewportMatrix=Lc([]);const r=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Cu(this.zoom,r["text-size"]),this.iconSizeData=Cu(this.zoom,r["icon-size"]);const a=this.layers[0].layout,f=a.get("symbol-sort-key"),v=a.get("symbol-z-order");this.canOverlap=eh(a,"text-overlap","text-allow-overlap")!=="never"||eh(a,"icon-overlap","icon-allow-overlap")!=="never"||a.get("text-ignore-placement")||a.get("icon-ignore-placement"),this.sortFeaturesByKey=v!=="viewport-y"&&!f.isConstant(),this.sortFeaturesByY=(v==="viewport-y"||v==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,a.get("symbol-placement")==="point"&&(this.writingModes=a.get("text-writing-mode").map(w=>V.ah[w])),this.stateDependentLayerIds=this.layers.filter(w=>w.isStateDependent()).map(w=>w.id),this.sourceID=e.sourceID}createArrays(){this.text=new ih(new pr(this.layers,this.zoom,e=>/^text/.test(e))),this.icon=new ih(new pr(this.layers,this.zoom,e=>/^icon/.test(e))),this.glyphOffsetArray=new d,this.lineVertexArray=new y,this.symbolInstances=new l,this.textAnchorOffsets=new A}calculateGlyphDependencies(e,r,a,f,v){for(let w=0;w<e.length;w++)if(r[e.charCodeAt(w)]=!0,(a||f)&&v){const E=Ul[e.charAt(w)];E&&(r[E.charCodeAt(0)]=!0)}}populate(e,r,a){const f=this.layers[0],v=f.layout,w=v.get("text-font"),E=v.get("text-field"),k=v.get("icon-image"),F=(E.value.kind!=="constant"||E.value.value instanceof sn&&!E.value.value.isEmpty()||E.value.value.toString().length>0)&&(w.value.kind!=="constant"||w.value.value.length>0),B=k.value.kind!=="constant"||!!k.value.value||Object.keys(k.parameters).length>0,j=v.get("symbol-sort-key");if(this.features=[],!F&&!B)return;const H=r.iconDependencies,Y=r.glyphDependencies,K=r.availableImages,re=new ar(this.zoom);for(const{feature:he,id:ve,index:Be,sourceLayerIndex:we}of e){const Me=f._featureFilter.needGeometry,st=va(he,Me);if(!f._featureFilter.filter(re,st,a))continue;let pt,Gt;if(Me||(st.geometry=ya(he)),F){const Vt=f.getValueAndResolveTokens("text-field",st,a,K),Rt=sn.factory(Vt),kt=this.hasRTLText=this.hasRTLText||$f(Rt);(!kt||fa.getRTLTextPluginStatus()==="unavailable"||kt&&fa.isParsed())&&(pt=Af(Rt,f,st))}if(B){const Vt=f.getValueAndResolveTokens("icon-image",st,a,K);Gt=Vt instanceof Kr?Vt:Kr.fromString(Vt)}if(!pt&&!Gt)continue;const ei=this.sortFeaturesByKey?j.evaluate(st,{},a):void 0;if(this.features.push({id:ve,text:pt,icon:Gt,index:Be,sourceLayerIndex:we,geometry:st.geometry,properties:he.properties,type:Xf[he.type],sortKey:ei}),Gt&&(H[Gt.name]=!0),pt){const Vt=w.evaluate(st,{},a).join(","),Rt=v.get("text-rotation-alignment")!=="viewport"&&v.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(V.ah.vertical)>=0;for(const kt of pt.sections)if(kt.image)H[kt.image.name]=!0;else{const $t=Ls(pt.toString()),zt=kt.fontStack||Vt,It=Y[zt]=Y[zt]||{};this.calculateGlyphDependencies(kt.text,It,Rt,this.allowVerticalPlacement,$t)}}}v.get("symbol-placement")==="line"&&(this.features=function(he){const ve={},Be={},we=[];let Me=0;function st(Vt){we.push(he[Vt]),Me++}function pt(Vt,Rt,kt){const $t=Be[Vt];return delete Be[Vt],Be[Rt]=$t,we[$t].geometry[0].pop(),we[$t].geometry[0]=we[$t].geometry[0].concat(kt[0]),$t}function Gt(Vt,Rt,kt){const $t=ve[Rt];return delete ve[Rt],ve[Vt]=$t,we[$t].geometry[0].shift(),we[$t].geometry[0]=kt[0].concat(we[$t].geometry[0]),$t}function ei(Vt,Rt,kt){const $t=kt?Rt[0][Rt[0].length-1]:Rt[0][0];return`${Vt}:${$t.x}:${$t.y}`}for(let Vt=0;Vt<he.length;Vt++){const Rt=he[Vt],kt=Rt.geometry,$t=Rt.text?Rt.text.toString():null;if(!$t){st(Vt);continue}const zt=ei($t,kt),It=ei($t,kt,!0);if(zt in Be&&It in ve&&Be[zt]!==ve[It]){const oi=Gt(zt,It,kt),ti=pt(zt,It,we[oi].geometry);delete ve[zt],delete Be[It],Be[ei($t,we[ti].geometry,!0)]=ti,we[oi].geometry=null}else zt in Be?pt(zt,It,kt):It in ve?Gt(zt,It,kt):(st(Vt),ve[zt]=Me-1,Be[It]=Me-1)}return we.filter(Vt=>Vt.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((he,ve)=>he.sortKey-ve.sortKey)}update(e,r,a){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(e,r,this.layers,a),this.icon.programConfigurations.updatePaintArrays(e,r,this.layers,a))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,r){const a=this.lineVertexArray.length;if(e.segment!==void 0){let f=e.dist(r[e.segment+1]),v=e.dist(r[e.segment]);const w={};for(let E=e.segment+1;E<r.length;E++)w[E]={x:r[E].x,y:r[E].y,tileUnitDistanceFromAnchor:f},E<r.length-1&&(f+=r[E+1].dist(r[E]));for(let E=e.segment||0;E>=0;E--)w[E]={x:r[E].x,y:r[E].y,tileUnitDistanceFromAnchor:v},E>0&&(v+=r[E-1].dist(r[E]));for(let E=0;E<r.length;E++){const k=w[E];this.lineVertexArray.emplaceBack(k.x,k.y,k.tileUnitDistanceFromAnchor)}}return{lineStartIndex:a,lineLength:this.lineVertexArray.length-a}}addSymbols(e,r,a,f,v,w,E,k,F,B,j,H){const Y=e.indexArray,K=e.layoutVertexArray,re=e.segments.prepareSegment(4*r.length,K,Y,this.canOverlap?w.sortKey:void 0),he=this.glyphOffsetArray.length,ve=re.vertexLength,Be=this.allowVerticalPlacement&&E===V.ah.vertical?Math.PI/2:0,we=w.text&&w.text.sections;for(let Me=0;Me<r.length;Me++){const{tl:st,tr:pt,bl:Gt,br:ei,tex:Vt,pixelOffsetTL:Rt,pixelOffsetBR:kt,minFontScaleX:$t,minFontScaleY:zt,glyphOffset:It,isSDF:oi,sectionIndex:ti}=r[Me],Ai=re.vertexLength,lr=It[1];xc(K,k.x,k.y,st.x,lr+st.y,Vt.x,Vt.y,a,oi,Rt.x,Rt.y,$t,zt),xc(K,k.x,k.y,pt.x,lr+pt.y,Vt.x+Vt.w,Vt.y,a,oi,kt.x,Rt.y,$t,zt),xc(K,k.x,k.y,Gt.x,lr+Gt.y,Vt.x,Vt.y+Vt.h,a,oi,Rt.x,kt.y,$t,zt),xc(K,k.x,k.y,ei.x,lr+ei.y,Vt.x+Vt.w,Vt.y+Vt.h,a,oi,kt.x,kt.y,$t,zt),th(e.dynamicLayoutVertexArray,k,Be),Y.emplaceBack(Ai,Ai+1,Ai+2),Y.emplaceBack(Ai+1,Ai+2,Ai+3),re.vertexLength+=4,re.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(It[0]),Me!==r.length-1&&ti===r[Me+1].sectionIndex||e.programConfigurations.populatePaintArrays(K.length,w,w.index,{},H,we&&we[ti])}e.placedSymbolArray.emplaceBack(k.x,k.y,he,this.glyphOffsetArray.length-he,ve,F,B,k.segment,a?a[0]:0,a?a[1]:0,f[0],f[1],E,0,!1,0,j)}_addCollisionDebugVertex(e,r,a,f,v,w){return r.emplaceBack(0,0),e.emplaceBack(a.x,a.y,f,v,Math.round(w.x),Math.round(w.y))}addCollisionDebugVertices(e,r,a,f,v,w,E){const k=v.segments.prepareSegment(4,v.layoutVertexArray,v.indexArray),F=k.vertexLength,B=v.layoutVertexArray,j=v.collisionVertexArray,H=E.anchorX,Y=E.anchorY;this._addCollisionDebugVertex(B,j,w,H,Y,new o(e,r)),this._addCollisionDebugVertex(B,j,w,H,Y,new o(a,r)),this._addCollisionDebugVertex(B,j,w,H,Y,new o(a,f)),this._addCollisionDebugVertex(B,j,w,H,Y,new o(e,f)),k.vertexLength+=4;const K=v.indexArray;K.emplaceBack(F,F+1),K.emplaceBack(F+1,F+2),K.emplaceBack(F+2,F+3),K.emplaceBack(F+3,F),k.primitiveLength+=4}addDebugCollisionBoxes(e,r,a,f){for(let v=e;v<r;v++){const w=this.collisionBoxArray.get(v);this.addCollisionDebugVertices(w.x1,w.y1,w.x2,w.y2,f?this.textCollisionBox:this.iconCollisionBox,w.anchorPoint,a)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new rh(ke,ou.members,rt),this.iconCollisionBox=new rh(ke,ou.members,rt);for(let e=0;e<this.symbolInstances.length;e++){const r=this.symbolInstances.get(e);this.addDebugCollisionBoxes(r.textBoxStartIndex,r.textBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.verticalTextBoxStartIndex,r.verticalTextBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.iconBoxStartIndex,r.iconBoxEndIndex,r,!1),this.addDebugCollisionBoxes(r.verticalIconBoxStartIndex,r.verticalIconBoxEndIndex,r,!1)}}_deserializeCollisionBoxesForSymbol(e,r,a,f,v,w,E,k,F){const B={};for(let j=r;j<a;j++){const H=e.get(j);B.textBox={x1:H.x1,y1:H.y1,x2:H.x2,y2:H.y2,anchorPointX:H.anchorPointX,anchorPointY:H.anchorPointY},B.textFeatureIndex=H.featureIndex;break}for(let j=f;j<v;j++){const H=e.get(j);B.verticalTextBox={x1:H.x1,y1:H.y1,x2:H.x2,y2:H.y2,anchorPointX:H.anchorPointX,anchorPointY:H.anchorPointY},B.verticalTextFeatureIndex=H.featureIndex;break}for(let j=w;j<E;j++){const H=e.get(j);B.iconBox={x1:H.x1,y1:H.y1,x2:H.x2,y2:H.y2,anchorPointX:H.anchorPointX,anchorPointY:H.anchorPointY},B.iconFeatureIndex=H.featureIndex;break}for(let j=k;j<F;j++){const H=e.get(j);B.verticalIconBox={x1:H.x1,y1:H.y1,x2:H.x2,y2:H.y2,anchorPointX:H.anchorPointX,anchorPointY:H.anchorPointY},B.verticalIconFeatureIndex=H.featureIndex;break}return B}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let r=0;r<this.symbolInstances.length;r++){const a=this.symbolInstances.get(r);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,a.textBoxStartIndex,a.textBoxEndIndex,a.verticalTextBoxStartIndex,a.verticalTextBoxEndIndex,a.iconBoxStartIndex,a.iconBoxEndIndex,a.verticalIconBoxStartIndex,a.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(e,r){const a=e.placedSymbolArray.get(r),f=a.vertexStartIndex+4*a.numGlyphs;for(let v=a.vertexStartIndex;v<f;v+=4)e.indexArray.emplaceBack(v,v+1,v+2),e.indexArray.emplaceBack(v+1,v+2,v+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const r=Math.sin(e),a=Math.cos(e),f=[],v=[],w=[];for(let E=0;E<this.symbolInstances.length;++E){w.push(E);const k=this.symbolInstances.get(E);f.push(0|Math.round(r*k.anchorX+a*k.anchorY)),v.push(k.featureIndex)}return w.sort((E,k)=>f[E]-f[k]||v[k]-v[E]),w}addToSortKeyRanges(e,r){const a=this.sortKeyRanges[this.sortKeyRanges.length-1];a&&a.sortKey===r?a.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:r,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const r of this.symbolInstanceIndexes){const a=this.symbolInstances.get(r);this.featureSortOrder.push(a.featureIndex),[a.rightJustifiedTextSymbolIndex,a.centerJustifiedTextSymbolIndex,a.leftJustifiedTextSymbolIndex].forEach((f,v,w)=>{f>=0&&w.indexOf(f)===v&&this.addIndicesForPlacedSymbol(this.text,f)}),a.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,a.verticalPlacedTextSymbolIndex),a.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,a.placedIconSymbolIndex),a.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,a.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Su,Tu;Nt("SymbolBucket",il,{omit:["layers","collisionBoxArray","features","compareText"]}),il.MAX_GLYPHS=65535,il.addDynamicAttributes=th;var nh={get paint(){return Tu=Tu||new En({"icon-opacity":new hi(le.paint_symbol["icon-opacity"]),"icon-color":new hi(le.paint_symbol["icon-color"]),"icon-halo-color":new hi(le.paint_symbol["icon-halo-color"]),"icon-halo-width":new hi(le.paint_symbol["icon-halo-width"]),"icon-halo-blur":new hi(le.paint_symbol["icon-halo-blur"]),"icon-translate":new ii(le.paint_symbol["icon-translate"]),"icon-translate-anchor":new ii(le.paint_symbol["icon-translate-anchor"]),"text-opacity":new hi(le.paint_symbol["text-opacity"]),"text-color":new hi(le.paint_symbol["text-color"],{runtimeType:Tr,getOverride:i=>i.textColor,hasOverride:i=>!!i.textColor}),"text-halo-color":new hi(le.paint_symbol["text-halo-color"]),"text-halo-width":new hi(le.paint_symbol["text-halo-width"]),"text-halo-blur":new hi(le.paint_symbol["text-halo-blur"]),"text-translate":new ii(le.paint_symbol["text-translate"]),"text-translate-anchor":new ii(le.paint_symbol["text-translate-anchor"])})},get layout(){return Su=Su||new En({"symbol-placement":new ii(le.layout_symbol["symbol-placement"]),"symbol-spacing":new ii(le.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ii(le.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new hi(le.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ii(le.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new ii(le.layout_symbol["icon-allow-overlap"]),"icon-overlap":new ii(le.layout_symbol["icon-overlap"]),"icon-ignore-placement":new ii(le.layout_symbol["icon-ignore-placement"]),"icon-optional":new ii(le.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ii(le.layout_symbol["icon-rotation-alignment"]),"icon-size":new hi(le.layout_symbol["icon-size"]),"icon-text-fit":new ii(le.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new ii(le.layout_symbol["icon-text-fit-padding"]),"icon-image":new hi(le.layout_symbol["icon-image"]),"icon-rotate":new hi(le.layout_symbol["icon-rotate"]),"icon-padding":new hi(le.layout_symbol["icon-padding"]),"icon-keep-upright":new ii(le.layout_symbol["icon-keep-upright"]),"icon-offset":new hi(le.layout_symbol["icon-offset"]),"icon-anchor":new hi(le.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ii(le.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ii(le.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ii(le.layout_symbol["text-rotation-alignment"]),"text-field":new hi(le.layout_symbol["text-field"]),"text-font":new hi(le.layout_symbol["text-font"]),"text-size":new hi(le.layout_symbol["text-size"]),"text-max-width":new hi(le.layout_symbol["text-max-width"]),"text-line-height":new ii(le.layout_symbol["text-line-height"]),"text-letter-spacing":new hi(le.layout_symbol["text-letter-spacing"]),"text-justify":new hi(le.layout_symbol["text-justify"]),"text-radial-offset":new hi(le.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ii(le.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new hi(le.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new hi(le.layout_symbol["text-anchor"]),"text-max-angle":new ii(le.layout_symbol["text-max-angle"]),"text-writing-mode":new ii(le.layout_symbol["text-writing-mode"]),"text-rotate":new hi(le.layout_symbol["text-rotate"]),"text-padding":new ii(le.layout_symbol["text-padding"]),"text-keep-upright":new ii(le.layout_symbol["text-keep-upright"]),"text-transform":new hi(le.layout_symbol["text-transform"]),"text-offset":new hi(le.layout_symbol["text-offset"]),"text-allow-overlap":new ii(le.layout_symbol["text-allow-overlap"]),"text-overlap":new ii(le.layout_symbol["text-overlap"]),"text-ignore-placement":new ii(le.layout_symbol["text-ignore-placement"]),"text-optional":new ii(le.layout_symbol["text-optional"])})}};class Eu{constructor(e){if(e.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=e.property.overrides?e.property.overrides.runtimeType:cr,this.defaultValue=e}evaluate(e){if(e.formattedSection){const r=this.defaultValue.property.overrides;if(r&&r.hasOverride(e.formattedSection))return r.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Nt("FormatSectionOverride",Eu,{omit:["defaultValue"]});class bc extends ns{constructor(e){super(e,nh)}recalculate(e,r){if(super.recalculate(e,r),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const a=this.layout.get("text-writing-mode");if(a){const f=[];for(const v of a)f.indexOf(v)<0&&f.push(v);this.layout._values["text-writing-mode"]=f}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(e,r,a,f){const v=this.layout.get(e).evaluate(r,{},a,f),w=this._unevaluatedLayout._values[e];return w.isDataDriven()||Ji(w.value)||!v?v:function(E,k){return k.replace(/{([^{}]+)}/g,(F,B)=>E&&B in E?String(E[B]):"")}(r.properties,v)}createBucket(e){return new il(e)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const e of nh.paint.overridableProperties){if(!bc.hasPaintOverride(this.layout,e))continue;const r=this.paint.get(e),a=new Eu(r),f=new Cn(a,r.property.specification);let v=null;v=r.value.kind==="constant"||r.value.kind==="source"?new Wn("source",f):new ca("composite",f,r.value.zoomStops),this.paint._values[e]=new rs(r.property,v,r.parameters)}}_handleOverridablePaintPropertyUpdate(e,r,a){return!(!this.layout||r.isDataDriven()||a.isDataDriven())&&bc.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,r){const a=e.get("text-field"),f=nh.paint.properties[r];let v=!1;const w=E=>{for(const k of E)if(f.overrides&&f.overrides.hasOverride(k))return void(v=!0)};if(a.value.kind==="constant"&&a.value.value instanceof sn)w(a.value.value.sections);else if(a.value.kind==="source"){const E=F=>{v||(F instanceof Cs&&wr(F.value)===$r?w(F.value.sections):F instanceof Oa?w(F.sections):F.eachChild(E))},k=a.value;k._styleExpression&&E(k._styleExpression.expression)}return v}}let Iu;var Yf={get paint(){return Iu=Iu||new En({"background-color":new ii(le.paint_background["background-color"]),"background-pattern":new vl(le.paint_background["background-pattern"]),"background-opacity":new ii(le.paint_background["background-opacity"])})}};class Zf extends ns{constructor(e){super(e,Yf)}}let Pu;var Kf={get paint(){return Pu=Pu||new En({"raster-opacity":new ii(le.paint_raster["raster-opacity"]),"raster-hue-rotate":new ii(le.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ii(le.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ii(le.paint_raster["raster-brightness-max"]),"raster-saturation":new ii(le.paint_raster["raster-saturation"]),"raster-contrast":new ii(le.paint_raster["raster-contrast"]),"raster-resampling":new ii(le.paint_raster["raster-resampling"]),"raster-fade-duration":new ii(le.paint_raster["raster-fade-duration"])})}};class Jf extends ns{constructor(e){super(e,Kf)}}class Qf extends ns{constructor(e){super(e,{}),this.onAdd=r=>{this.implementation.onAdd&&this.implementation.onAdd(r,r.painter.context.gl)},this.onRemove=r=>{this.implementation.onRemove&&this.implementation.onRemove(r,r.painter.context.gl)},this.implementation=e}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class ep{constructor(e){this._methodToThrottle=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._methodToThrottle()},0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const sh=63710088e-1;class Ya{constructor(e,r){if(isNaN(e)||isNaN(r))throw new Error(`Invalid LngLat object: (${e}, ${r})`);if(this.lng=+e,this.lat=+r,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Ya($(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const r=Math.PI/180,a=this.lat*r,f=e.lat*r,v=Math.sin(a)*Math.sin(f)+Math.cos(a)*Math.cos(f)*Math.cos((e.lng-this.lng)*r);return sh*Math.acos(Math.min(v,1))}static convert(e){if(e instanceof Ya)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new Ya(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new Ya(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const Au=2*Math.PI*sh;function Mu(i){return Au*Math.cos(i*Math.PI/180)}function ku(i){return(180+i)/360}function Du(i){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i*Math.PI/360)))/360}function Ou(i,e){return i/Mu(e)}function ah(i){return 360/Math.PI*Math.atan(Math.exp((180-360*i)*Math.PI/180))-90}class wc{constructor(e,r,a=0){this.x=+e,this.y=+r,this.z=+a}static fromLngLat(e,r=0){const a=Ya.convert(e);return new wc(ku(a.lng),Du(a.lat),Ou(r,a.lat))}toLngLat(){return new Ya(360*this.x-180,ah(this.y))}toAltitude(){return this.z*Mu(ah(this.y))}meterInMercatorCoordinateUnits(){return 1/Au*(e=ah(this.y),1/Math.cos(e*Math.PI/180));var e}}function Lu(i,e,r){var a=2*Math.PI*6378137/256/Math.pow(2,r);return[i*a-2*Math.PI*6378137/2,e*a-2*Math.PI*6378137/2]}class oh{constructor(e,r,a){if(e<0||e>25||a<0||a>=Math.pow(2,e)||r<0||r>=Math.pow(2,e))throw new Error(`x=${r}, y=${a}, z=${e} outside of bounds. 0<=x<${Math.pow(2,e)}, 0<=y<${Math.pow(2,e)} 0<=z<=25 `);this.z=e,this.x=r,this.y=a,this.key=Xl(0,e,e,r,a)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,r,a){const f=(w=this.y,E=this.z,k=Lu(256*(v=this.x),256*(w=Math.pow(2,E)-w-1),E),F=Lu(256*(v+1),256*(w+1),E),k[0]+","+k[1]+","+F[0]+","+F[1]);var v,w,E,k,F;const B=function(j,H,Y){let K,re="";for(let he=j;he>0;he--)K=1<<he-1,re+=(H&K?1:0)+(Y&K?2:0);return re}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(a==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,r>1?"@2x":"").replace(/{quadkey}/g,B).replace(/{bbox-epsg-3857}/g,f)}isChildOf(e){const r=this.z-e.z;return r>0&&e.x===this.x>>r&&e.y===this.y>>r}getTilePoint(e){const r=Math.pow(2,this.z);return new o((e.x*r-this.x)*Di,(e.y*r-this.y)*Di)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Fu{constructor(e,r){this.wrap=e,this.canonical=r,this.key=Xl(e,r.z,r.z,r.x,r.y)}}class ls{constructor(e,r,a,f,v){if(e<a)throw new Error(`overscaledZ should be >= z; overscaledZ = ${e}; z = ${a}`);this.overscaledZ=e,this.wrap=r,this.canonical=new oh(a,+f,+v),this.key=Xl(r,e,a,f,v)}clone(){return new ls(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){if(e>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${e}; overscaledZ = ${this.overscaledZ}`);const r=this.canonical.z-e;return e>this.canonical.z?new ls(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new ls(e,this.wrap,e,this.canonical.x>>r,this.canonical.y>>r)}calculateScaledKey(e,r){if(e>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${e}; overscaledZ = ${this.overscaledZ}`);const a=this.canonical.z-e;return e>this.canonical.z?Xl(this.wrap*+r,e,this.canonical.z,this.canonical.x,this.canonical.y):Xl(this.wrap*+r,e,e,this.canonical.x>>a,this.canonical.y>>a)}isChildOf(e){if(e.wrap!==this.wrap)return!1;const r=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.x===this.canonical.x>>r&&e.canonical.y===this.canonical.y>>r}children(e){if(this.overscaledZ>=e)return[new ls(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const r=this.canonical.z+1,a=2*this.canonical.x,f=2*this.canonical.y;return[new ls(r,this.wrap,r,a,f),new ls(r,this.wrap,r,a+1,f),new ls(r,this.wrap,r,a,f+1),new ls(r,this.wrap,r,a+1,f+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new ls(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new ls(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Fu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(e){return this.canonical.getTilePoint(new wc(e.x-this.wrap,e.y))}}function Xl(i,e,r,a,f){(i*=2)<0&&(i=-1*i-1);const v=1<<r;return(v*v*i+v*f+a).toString(36)+r.toString(36)+e.toString(36)}Nt("CanonicalTileID",oh),Nt("OverscaledTileID",ls,{omit:["posMatrix"]});class zu{constructor(e,r,a,f=1,v=1,w=1,E=0){if(this.uid=e,r.height!==r.width)throw new RangeError("DEM tiles must be square");if(a&&!["mapbox","terrarium","custom"].includes(a))return void ut(`"${a}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=r.height;const k=this.dim=r.height-2;switch(this.data=new Uint32Array(r.data.buffer),a){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=f,this.greenFactor=v,this.blueFactor=w,this.baseShift=E;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let F=0;F<k;F++)this.data[this._idx(-1,F)]=this.data[this._idx(0,F)],this.data[this._idx(k,F)]=this.data[this._idx(k-1,F)],this.data[this._idx(F,-1)]=this.data[this._idx(F,0)],this.data[this._idx(F,k)]=this.data[this._idx(F,k-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(k,-1)]=this.data[this._idx(k-1,0)],this.data[this._idx(-1,k)]=this.data[this._idx(0,k-1)],this.data[this._idx(k,k)]=this.data[this._idx(k-1,k-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let F=0;F<k;F++)for(let B=0;B<k;B++){const j=this.get(F,B);j>this.max&&(this.max=j),j<this.min&&(this.min=j)}}get(e,r){const a=new Uint8Array(this.data.buffer),f=4*this._idx(e,r);return this.unpack(a[f],a[f+1],a[f+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(e,r){if(e<-1||e>=this.dim+1||r<-1||r>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(r+1)*this.stride+(e+1)}unpack(e,r,a){return e*this.redFactor+r*this.greenFactor+a*this.blueFactor-this.baseShift}getPixels(){return new os({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(e,r,a){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let f=r*this.dim,v=r*this.dim+this.dim,w=a*this.dim,E=a*this.dim+this.dim;switch(r){case-1:f=v-1;break;case 1:v=f+1}switch(a){case-1:w=E-1;break;case 1:E=w+1}const k=-r*this.dim,F=-a*this.dim;for(let B=w;B<E;B++)for(let j=f;j<v;j++)this.data[this._idx(j,B)]=e.data[this._idx(j+k,B+F)]}}Nt("DEMData",zu);class Ru{constructor(e){this._stringToNumber={},this._numberToString=[];for(let r=0;r<e.length;r++){const a=e[r];this._stringToNumber[a]=r,this._numberToString[r]=a}}encode(e){return this._stringToNumber[e]}decode(e){if(e>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${e} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[e]}}class Bu{constructor(e,r,a,f,v){this.type="Feature",this._vectorTileFeature=e,e._z=r,e._x=a,e._y=f,this.properties=e.properties,this.id=v}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={geometry:this.geometry};for(const r in this)r!=="_geometry"&&r!=="_vectorTileFeature"&&(e[r]=this[r]);return e}}class ju{constructor(e,r){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Rr(Di,16,0),this.grid3D=new Rr(Di,16,0),this.featureIndexArray=new R,this.promoteId=r}insert(e,r,a,f,v,w){const E=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(a,f,v);const k=w?this.grid3D:this.grid;for(let F=0;F<r.length;F++){const B=r[F],j=[1/0,1/0,-1/0,-1/0];for(let H=0;H<B.length;H++){const Y=B[H];j[0]=Math.min(j[0],Y.x),j[1]=Math.min(j[1],Y.y),j[2]=Math.max(j[2],Y.x),j[3]=Math.max(j[3],Y.y)}j[0]<Di&&j[1]<Di&&j[2]>=0&&j[3]>=0&&k.insert(E,j[0],j[1],j[2],j[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new Xa.VectorTile(new Yc(this.rawTileData)).layers,this.sourceLayerCoder=new Ru(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(e,r,a,f){this.loadVTLayers();const v=e.params||{},w=Di/e.tileSize/e.scale,E=ks(v.filter),k=e.queryGeometry,F=e.queryPadding*w,B=Vu(k),j=this.grid.query(B.minX-F,B.minY-F,B.maxX+F,B.maxY+F),H=Vu(e.cameraQueryGeometry),Y=this.grid3D.query(H.minX-F,H.minY-F,H.maxX+F,H.maxY+F,(he,ve,Be,we)=>function(Me,st,pt,Gt,ei){for(const Rt of Me)if(st<=Rt.x&&pt<=Rt.y&&Gt>=Rt.x&&ei>=Rt.y)return!0;const Vt=[new o(st,pt),new o(st,ei),new o(Gt,ei),new o(Gt,pt)];if(Me.length>2){for(const Rt of Vt)if(Yo(Me,Rt))return!0}for(let Rt=0;Rt<Me.length-1;Rt++)if(kd(Me[Rt],Me[Rt+1],Vt))return!0;return!1}(e.cameraQueryGeometry,he-F,ve-F,Be+F,we+F));for(const he of Y)j.push(he);j.sort(tp);const K={};let re;for(let he=0;he<j.length;he++){const ve=j[he];if(ve===re)continue;re=ve;const Be=this.featureIndexArray.get(ve);let we=null;this.loadMatchingFeature(K,Be.bucketIndex,Be.sourceLayerIndex,Be.featureIndex,E,v.layers,v.availableImages,r,a,f,(Me,st,pt)=>(we||(we=ya(Me)),st.queryIntersectsFeature(k,Me,pt,we,this.z,e.transform,w,e.pixelPosMatrix)))}return K}loadMatchingFeature(e,r,a,f,v,w,E,k,F,B,j){const H=this.bucketLayerIDs[r];if(w&&!function(he,ve){for(let Be=0;Be<he.length;Be++)if(ve.indexOf(he[Be])>=0)return!0;return!1}(w,H))return;const Y=this.sourceLayerCoder.decode(a),K=this.vtLayers[Y].feature(f);if(v.needGeometry){const he=va(K,!0);if(!v.filter(new ar(this.tileID.overscaledZ),he,this.tileID.canonical))return}else if(!v.filter(new ar(this.tileID.overscaledZ),K))return;const re=this.getId(K,Y);for(let he=0;he<H.length;he++){const ve=H[he];if(w&&w.indexOf(ve)<0)continue;const Be=k[ve];if(!Be)continue;let we={};re&&B&&(we=B.getState(Be.sourceLayer||"_geojsonTileLayer",re));const Me=ne({},F[ve]);Me.paint=Nu(Me.paint,Be.paint,K,we,E),Me.layout=Nu(Me.layout,Be.layout,K,we,E);const st=!j||j(K,Be,we);if(!st)continue;const pt=new Bu(K,this.z,this.x,this.y,re);pt.layer=Me;let Gt=e[ve];Gt===void 0&&(Gt=e[ve]=[]),Gt.push({featureIndex:f,feature:pt,intersectionZ:st})}}lookupSymbolFeatures(e,r,a,f,v,w,E,k){const F={};this.loadVTLayers();const B=ks(v);for(const j of e)this.loadMatchingFeature(F,a,f,j,B,w,E,k,r);return F}hasLayer(e){for(const r of this.bucketLayerIDs)for(const a of r)if(e===a)return!0;return!1}getId(e,r){let a=e.id;return this.promoteId&&(a=e.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[r]],typeof a=="boolean"&&(a=Number(a))),a}}function Nu(i,e,r,a,f){return Ve(i,(v,w)=>{const E=e instanceof mo?e.get(w):null;return E&&E.evaluate?E.evaluate(r,a,f):E})}function Vu(i){let e=1/0,r=1/0,a=-1/0,f=-1/0;for(const v of i)e=Math.min(e,v.x),r=Math.min(r,v.y),a=Math.max(a,v.x),f=Math.max(f,v.y);return{minX:e,minY:r,maxX:a,maxY:f}}function tp(i,e){return e-i}function Uu(i,e,r,a,f){const v=[];for(let w=0;w<i.length;w++){const E=i[w];let k;for(let F=0;F<E.length-1;F++){let B=E[F],j=E[F+1];B.x<e&&j.x<e||(B.x<e?B=new o(e,B.y+(e-B.x)/(j.x-B.x)*(j.y-B.y))._round():j.x<e&&(j=new o(e,B.y+(e-B.x)/(j.x-B.x)*(j.y-B.y))._round()),B.y<r&&j.y<r||(B.y<r?B=new o(B.x+(r-B.y)/(j.y-B.y)*(j.x-B.x),r)._round():j.y<r&&(j=new o(B.x+(r-B.y)/(j.y-B.y)*(j.x-B.x),r)._round()),B.x>=a&&j.x>=a||(B.x>=a?B=new o(a,B.y+(a-B.x)/(j.x-B.x)*(j.y-B.y))._round():j.x>=a&&(j=new o(a,B.y+(a-B.x)/(j.x-B.x)*(j.y-B.y))._round()),B.y>=f&&j.y>=f||(B.y>=f?B=new o(B.x+(f-B.y)/(j.y-B.y)*(j.x-B.x),f)._round():j.y>=f&&(j=new o(B.x+(f-B.y)/(j.y-B.y)*(j.x-B.x),f)._round()),k&&B.equals(k[k.length-1])||(k=[B],v.push(k)),k.push(j)))))}}return v}Nt("FeatureIndex",ju,{omit:["rawTileData","sourceLayerCoder"]});class Za extends o{constructor(e,r,a,f){super(e,r),this.angle=a,f!==void 0&&(this.segment=f)}clone(){return new Za(this.x,this.y,this.angle,this.segment)}}function Gu(i,e,r,a,f){if(e.segment===void 0||r===0)return!0;let v=e,w=e.segment+1,E=0;for(;E>-r/2;){if(w--,w<0)return!1;E-=i[w].dist(v),v=i[w]}E+=i[w].dist(i[w+1]),w++;const k=[];let F=0;for(;E<r/2;){const B=i[w],j=i[w+1];if(!j)return!1;let H=i[w-1].angleTo(B)-B.angleTo(j);for(H=Math.abs((H+3*Math.PI)%(2*Math.PI)-Math.PI),k.push({distance:E,angleDelta:H}),F+=H;E-k[0].distance>a;)F-=k.shift().angleDelta;if(F>f)return!1;w++,E+=B.dist(j)}return!0}function Wu(i){let e=0;for(let r=0;r<i.length-1;r++)e+=i[r].dist(i[r+1]);return e}function Hu(i,e,r){return i?.6*e*r:0}function Xu(i,e){return Math.max(i?i.right-i.left:0,e?e.right-e.left:0)}function ip(i,e,r,a,f,v){const w=Hu(r,f,v),E=Xu(r,a)*v;let k=0;const F=Wu(i)/2;for(let B=0;B<i.length-1;B++){const j=i[B],H=i[B+1],Y=j.dist(H);if(k+Y>F){const K=(F-k)/Y,re=ln.number(j.x,H.x,K),he=ln.number(j.y,H.y,K),ve=new Za(re,he,H.angleTo(j),B);return ve._round(),!w||Gu(i,ve,E,w,e)?ve:void 0}k+=Y}}function rp(i,e,r,a,f,v,w,E,k){const F=Hu(a,v,w),B=Xu(a,f),j=B*w,H=i[0].x===0||i[0].x===k||i[0].y===0||i[0].y===k;return e-j<e/4&&(e=j+e/4),qu(i,H?e/2*E%e:(B/2+2*v)*w*E%e,e,F,r,j,H,!1,k)}function qu(i,e,r,a,f,v,w,E,k){const F=v/2,B=Wu(i);let j=0,H=e-r,Y=[];for(let K=0;K<i.length-1;K++){const re=i[K],he=i[K+1],ve=re.dist(he),Be=he.angleTo(re);for(;H+r<j+ve;){H+=r;const we=(H-j)/ve,Me=ln.number(re.x,he.x,we),st=ln.number(re.y,he.y,we);if(Me>=0&&Me<k&&st>=0&&st<k&&H-F>=0&&H+F<=B){const pt=new Za(Me,st,Be,K);pt._round(),a&&!Gu(i,pt,v,a,f)||Y.push(pt)}}j+=ve}return E||Y.length||w||(Y=qu(i,j/2,r,a,f,v,w,!0,k)),Y}Nt("Anchor",Za);const rl=zn;function $u(i,e,r,a){const f=[],v=i.image,w=v.pixelRatio,E=v.paddedRect.w-2*rl,k=v.paddedRect.h-2*rl,F=i.right-i.left,B=i.bottom-i.top,j=v.stretchX||[[0,E]],H=v.stretchY||[[0,k]],Y=(kt,$t)=>kt+$t[1]-$t[0],K=j.reduce(Y,0),re=H.reduce(Y,0),he=E-K,ve=k-re;let Be=0,we=K,Me=0,st=re,pt=0,Gt=he,ei=0,Vt=ve;if(v.content&&a){const kt=v.content;Be=Cc(j,0,kt[0]),Me=Cc(H,0,kt[1]),we=Cc(j,kt[0],kt[2]),st=Cc(H,kt[1],kt[3]),pt=kt[0]-Be,ei=kt[1]-Me,Gt=kt[2]-kt[0]-we,Vt=kt[3]-kt[1]-st}const Rt=(kt,$t,zt,It)=>{const oi=Sc(kt.stretch-Be,we,F,i.left),ti=Tc(kt.fixed-pt,Gt,kt.stretch,K),Ai=Sc($t.stretch-Me,st,B,i.top),lr=Tc($t.fixed-ei,Vt,$t.stretch,re),mr=Sc(zt.stretch-Be,we,F,i.left),jr=Tc(zt.fixed-pt,Gt,zt.stretch,K),Zn=Sc(It.stretch-Me,st,B,i.top),An=Tc(It.fixed-ei,Vt,It.stretch,re),Dr=new o(oi,Ai),en=new o(mr,Ai),un=new o(mr,Zn),Mn=new o(oi,Zn),kn=new o(ti/w,lr/w),Nr=new o(jr/w,An/w),Vr=e*Math.PI/180;if(Vr){const vn=Math.sin(Vr),Rn=Math.cos(Vr),Bn=[Rn,-vn,vn,Rn];Dr._matMult(Bn),en._matMult(Bn),Mn._matMult(Bn),un._matMult(Bn)}const yn=kt.stretch+kt.fixed,Dn=$t.stretch+$t.fixed;return{tl:Dr,tr:en,bl:Mn,br:un,tex:{x:v.paddedRect.x+rl+yn,y:v.paddedRect.y+rl+Dn,w:zt.stretch+zt.fixed-yn,h:It.stretch+It.fixed-Dn},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:kn,pixelOffsetBR:Nr,minFontScaleX:Gt/w/F,minFontScaleY:Vt/w/B,isSDF:r}};if(a&&(v.stretchX||v.stretchY)){const kt=Yu(j,he,K),$t=Yu(H,ve,re);for(let zt=0;zt<kt.length-1;zt++){const It=kt[zt],oi=kt[zt+1];for(let ti=0;ti<$t.length-1;ti++)f.push(Rt(It,$t[ti],oi,$t[ti+1]))}}else f.push(Rt({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:E+1},{fixed:0,stretch:k+1}));return f}function Cc(i,e,r){let a=0;for(const f of i)a+=Math.max(e,Math.min(r,f[1]))-Math.max(e,Math.min(r,f[0]));return a}function Yu(i,e,r){const a=[{fixed:-rl,stretch:0}];for(const[f,v]of i){const w=a[a.length-1];a.push({fixed:f-w.stretch,stretch:w.stretch}),a.push({fixed:f-w.stretch,stretch:w.stretch+(v-f)})}return a.push({fixed:e+rl,stretch:r}),a}function Sc(i,e,r,a){return i/e*r+a}function Tc(i,e,r,a){return i-e*r/a}class Ec{constructor(e,r,a,f,v,w,E,k,F,B){if(this.boxStartIndex=e.length,F){let j=w.top,H=w.bottom;const Y=w.collisionPadding;Y&&(j-=Y[1],H+=Y[3]);let K=H-j;K>0&&(K=Math.max(10,K),this.circleDiameter=K)}else{let j=w.top*E-k[0],H=w.bottom*E+k[2],Y=w.left*E-k[3],K=w.right*E+k[1];const re=w.collisionPadding;if(re&&(Y-=re[0]*E,j-=re[1]*E,K+=re[2]*E,H+=re[3]*E),B){const he=new o(Y,j),ve=new o(K,j),Be=new o(Y,H),we=new o(K,H),Me=B*Math.PI/180;he._rotate(Me),ve._rotate(Me),Be._rotate(Me),we._rotate(Me),Y=Math.min(he.x,ve.x,Be.x,we.x),K=Math.max(he.x,ve.x,Be.x,we.x),j=Math.min(he.y,ve.y,Be.y,we.y),H=Math.max(he.y,ve.y,Be.y,we.y)}e.emplaceBack(r.x,r.y,Y,j,K,H,a,f,v)}this.boxEndIndex=e.length}}class np{constructor(e=[],r=sp){if(this.data=e,this.length=this.data.length,this.compare=r,this.length>0)for(let a=(this.length>>1)-1;a>=0;a--)this._down(a)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const e=this.data[0],r=this.data.pop();return this.length--,this.length>0&&(this.data[0]=r,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:r,compare:a}=this,f=r[e];for(;e>0;){const v=e-1>>1,w=r[v];if(a(f,w)>=0)break;r[e]=w,e=v}r[e]=f}_down(e){const{data:r,compare:a}=this,f=this.length>>1,v=r[e];for(;e<f;){let w=1+(e<<1),E=r[w];const k=w+1;if(k<this.length&&a(r[k],E)<0&&(w=k,E=r[k]),a(E,v)>=0)break;r[e]=E,e=w}r[e]=v}}function sp(i,e){return i<e?-1:i>e?1:0}function ap(i,e=1,r=!1){let a=1/0,f=1/0,v=-1/0,w=-1/0;const E=i[0];for(let Y=0;Y<E.length;Y++){const K=E[Y];(!Y||K.x<a)&&(a=K.x),(!Y||K.y<f)&&(f=K.y),(!Y||K.x>v)&&(v=K.x),(!Y||K.y>w)&&(w=K.y)}const k=Math.min(v-a,w-f);let F=k/2;const B=new np([],op);if(k===0)return new o(a,f);for(let Y=a;Y<v;Y+=k)for(let K=f;K<w;K+=k)B.push(new nl(Y+F,K+F,F,i));let j=function(Y){let K=0,re=0,he=0;const ve=Y[0];for(let Be=0,we=ve.length,Me=we-1;Be<we;Me=Be++){const st=ve[Be],pt=ve[Me],Gt=st.x*pt.y-pt.x*st.y;re+=(st.x+pt.x)*Gt,he+=(st.y+pt.y)*Gt,K+=3*Gt}return new nl(re/K,he/K,0,Y)}(i),H=B.length;for(;B.length;){const Y=B.pop();(Y.d>j.d||!j.d)&&(j=Y,r&&console.log("found best %d after %d probes",Math.round(1e4*Y.d)/1e4,H)),Y.max-j.d<=e||(F=Y.h/2,B.push(new nl(Y.p.x-F,Y.p.y-F,F,i)),B.push(new nl(Y.p.x+F,Y.p.y-F,F,i)),B.push(new nl(Y.p.x-F,Y.p.y+F,F,i)),B.push(new nl(Y.p.x+F,Y.p.y+F,F,i)),H+=4)}return r&&(console.log(`num probes: ${H}`),console.log(`best distance: ${j.d}`)),j.p}function op(i,e){return e.max-i.max}function nl(i,e,r,a){this.p=new o(i,e),this.h=r,this.d=function(f,v){let w=!1,E=1/0;for(let k=0;k<v.length;k++){const F=v[k];for(let B=0,j=F.length,H=j-1;B<j;H=B++){const Y=F[B],K=F[H];Y.y>f.y!=K.y>f.y&&f.x<(K.x-Y.x)*(f.y-Y.y)/(K.y-Y.y)+Y.x&&(w=!w),E=Math.min(E,Dh(f,Y,K))}}return(w?1:-1)*Math.sqrt(E)}(this.p,a),this.max=this.d+this.h*Math.SQRT2}var hn;V.ap=void 0,(hn=V.ap||(V.ap={}))[hn.center=1]="center",hn[hn.left=2]="left",hn[hn.right=3]="right",hn[hn.top=4]="top",hn[hn.bottom=5]="bottom",hn[hn["top-left"]=6]="top-left",hn[hn["top-right"]=7]="top-right",hn[hn["bottom-left"]=8]="bottom-left",hn[hn["bottom-right"]=9]="bottom-right";const Ka=7,lh=Number.POSITIVE_INFINITY;function Zu(i,e){return e[1]!==lh?function(r,a,f){let v=0,w=0;switch(a=Math.abs(a),f=Math.abs(f),r){case"top-right":case"top-left":case"top":w=f-Ka;break;case"bottom-right":case"bottom-left":case"bottom":w=-f+Ka}switch(r){case"top-right":case"bottom-right":case"right":v=-a;break;case"top-left":case"bottom-left":case"left":v=a}return[v,w]}(i,e[0],e[1]):function(r,a){let f=0,v=0;a<0&&(a=0);const w=a/Math.SQRT2;switch(r){case"top-right":case"top-left":v=w-Ka;break;case"bottom-right":case"bottom-left":v=-w+Ka;break;case"bottom":v=-a+Ka;break;case"top":v=a-Ka}switch(r){case"top-right":case"bottom-right":f=-w;break;case"top-left":case"bottom-left":f=w;break;case"left":f=a;break;case"right":f=-a}return[f,v]}(i,e[0])}function Ku(i,e,r){var a;const f=i.layout,v=(a=f.get("text-variable-anchor-offset"))===null||a===void 0?void 0:a.evaluate(e,{},r);if(v){const E=v.values,k=[];for(let F=0;F<E.length;F+=2){const B=k[F]=E[F],j=E[F+1].map(H=>H*Br);B.startsWith("top")?j[1]-=Ka:B.startsWith("bottom")&&(j[1]+=Ka),k[F+1]=j}return new tr(k)}const w=f.get("text-variable-anchor");if(w){let E;E=i._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[f.get("text-radial-offset").evaluate(e,{},r)*Br,lh]:f.get("text-offset").evaluate(e,{},r).map(F=>F*Br);const k=[];for(const F of w)k.push(F,Zu(F,E));return new tr(k)}return null}function ch(i){switch(i){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function lp(i,e,r,a,f,v,w,E,k,F,B){let j=v.textMaxSize.evaluate(e,{});j===void 0&&(j=w);const H=i.layers[0].layout,Y=H.get("icon-offset").evaluate(e,{},B),K=Qu(r.horizontal),re=w/24,he=i.tilePixelRatio*re,ve=i.tilePixelRatio*j/24,Be=i.tilePixelRatio*E,we=i.tilePixelRatio*H.get("symbol-spacing"),Me=H.get("text-padding")*i.tilePixelRatio,st=function(It,oi,ti,Ai=1){const lr=It.get("icon-padding").evaluate(oi,{},ti),mr=lr&&lr.values;return[mr[0]*Ai,mr[1]*Ai,mr[2]*Ai,mr[3]*Ai]}(H,e,B,i.tilePixelRatio),pt=H.get("text-max-angle")/180*Math.PI,Gt=H.get("text-rotation-alignment")!=="viewport"&&H.get("symbol-placement")!=="point",ei=H.get("icon-rotation-alignment")==="map"&&H.get("symbol-placement")!=="point",Vt=H.get("symbol-placement"),Rt=we/2,kt=H.get("icon-text-fit");let $t;a&&kt!=="none"&&(i.allowVerticalPlacement&&r.vertical&&($t=wu(a,r.vertical,kt,H.get("icon-text-fit-padding"),Y,re)),K&&(a=wu(a,K,kt,H.get("icon-text-fit-padding"),Y,re)));const zt=(It,oi)=>{oi.x<0||oi.x>=Di||oi.y<0||oi.y>=Di||function(ti,Ai,lr,mr,jr,Zn,An,Dr,en,un,Mn,kn,Nr,Vr,yn,Dn,vn,Rn,Bn,Ur,Li,xn,dn,Gr,bs){const Rs=ti.addToLineVertexArray(Ai,lr);let Bs,wa,ws,cs,jn=0,Ca=0,Yl=0,rd=0,_h=-1,yh=-1;const Sa={};let nd=Ti("");if(ti.allowVerticalPlacement&&mr.vertical){const bn=Dr.layout.get("text-rotate").evaluate(Li,{},Gr)+90;ws=new Ec(en,Ai,un,Mn,kn,mr.vertical,Nr,Vr,yn,bn),An&&(cs=new Ec(en,Ai,un,Mn,kn,An,vn,Rn,yn,bn))}if(jr){const bn=Dr.layout.get("icon-rotate").evaluate(Li,{}),hs=Dr.layout.get("icon-text-fit")!=="none",Co=$u(jr,bn,dn,hs),Ns=An?$u(An,bn,dn,hs):void 0;wa=new Ec(en,Ai,un,Mn,kn,jr,vn,Rn,!1,bn),jn=4*Co.length;const So=ti.iconSizeData;let ia=null;So.kind==="source"?(ia=[ta*Dr.layout.get("icon-size").evaluate(Li,{})],ia[0]>$a&&ut(`${ti.layerIds[0]}: Value for "icon-size" is >= ${Hl}. Reduce your "icon-size".`)):So.kind==="composite"&&(ia=[ta*xn.compositeIconSizes[0].evaluate(Li,{},Gr),ta*xn.compositeIconSizes[1].evaluate(Li,{},Gr)],(ia[0]>$a||ia[1]>$a)&&ut(`${ti.layerIds[0]}: Value for "icon-size" is >= ${Hl}. Reduce your "icon-size".`)),ti.addSymbols(ti.icon,Co,ia,Ur,Bn,Li,V.ah.none,Ai,Rs.lineStartIndex,Rs.lineLength,-1,Gr),_h=ti.icon.placedSymbolArray.length-1,Ns&&(Ca=4*Ns.length,ti.addSymbols(ti.icon,Ns,ia,Ur,Bn,Li,V.ah.vertical,Ai,Rs.lineStartIndex,Rs.lineLength,-1,Gr),yh=ti.icon.placedSymbolArray.length-1)}const sd=Object.keys(mr.horizontal);for(const bn of sd){const hs=mr.horizontal[bn];if(!Bs){nd=Ti(hs.text);const Ns=Dr.layout.get("text-rotate").evaluate(Li,{},Gr);Bs=new Ec(en,Ai,un,Mn,kn,hs,Nr,Vr,yn,Ns)}const Co=hs.positionedLines.length===1;if(Yl+=Ju(ti,Ai,hs,Zn,Dr,yn,Li,Dn,Rs,mr.vertical?V.ah.horizontal:V.ah.horizontalOnly,Co?sd:[bn],Sa,_h,xn,Gr),Co)break}mr.vertical&&(rd+=Ju(ti,Ai,mr.vertical,Zn,Dr,yn,Li,Dn,Rs,V.ah.vertical,["vertical"],Sa,yh,xn,Gr));const up=Bs?Bs.boxStartIndex:ti.collisionBoxArray.length,dp=Bs?Bs.boxEndIndex:ti.collisionBoxArray.length,fp=ws?ws.boxStartIndex:ti.collisionBoxArray.length,pp=ws?ws.boxEndIndex:ti.collisionBoxArray.length,mp=wa?wa.boxStartIndex:ti.collisionBoxArray.length,gp=wa?wa.boxEndIndex:ti.collisionBoxArray.length,_p=cs?cs.boxStartIndex:ti.collisionBoxArray.length,yp=cs?cs.boxEndIndex:ti.collisionBoxArray.length;let js=-1;const Pc=(bn,hs)=>bn&&bn.circleDiameter?Math.max(bn.circleDiameter,hs):hs;js=Pc(Bs,js),js=Pc(ws,js),js=Pc(wa,js),js=Pc(cs,js);const ad=js>-1?1:0;ad&&(js*=bs/Br),ti.glyphOffsetArray.length>=il.MAX_GLYPHS&&ut("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Li.sortKey!==void 0&&ti.addToSortKeyRanges(ti.symbolInstances.length,Li.sortKey);const vp=Ku(Dr,Li,Gr),[xp,bp]=function(bn,hs){const Co=bn.length,Ns=hs==null?void 0:hs.values;if((Ns==null?void 0:Ns.length)>0)for(let So=0;So<Ns.length;So+=2){const ia=Ns[So+1];bn.emplaceBack(V.ap[Ns[So]],ia[0],ia[1])}return[Co,bn.length]}(ti.textAnchorOffsets,vp);ti.symbolInstances.emplaceBack(Ai.x,Ai.y,Sa.right>=0?Sa.right:-1,Sa.center>=0?Sa.center:-1,Sa.left>=0?Sa.left:-1,Sa.vertical||-1,_h,yh,nd,up,dp,fp,pp,mp,gp,_p,yp,un,Yl,rd,jn,Ca,ad,0,Nr,js,xp,bp)}(i,oi,It,r,a,f,$t,i.layers[0],i.collisionBoxArray,e.index,e.sourceLayerIndex,i.index,he,[Me,Me,Me,Me],Gt,k,Be,st,ei,Y,e,v,F,B,w)};if(Vt==="line")for(const It of Uu(e.geometry,0,0,Di,Di)){const oi=rp(It,we,pt,r.vertical||K,a,24,ve,i.overscaling,Di);for(const ti of oi)K&&cp(i,K.text,Rt,ti)||zt(It,ti)}else if(Vt==="line-center"){for(const It of e.geometry)if(It.length>1){const oi=ip(It,pt,r.vertical||K,a,24,ve);oi&&zt(It,oi)}}else if(e.type==="Polygon")for(const It of Vc(e.geometry,0)){const oi=ap(It,16);zt(It[0],new Za(oi.x,oi.y,0))}else if(e.type==="LineString")for(const It of e.geometry)zt(It,new Za(It[0].x,It[0].y,0));else if(e.type==="Point")for(const It of e.geometry)for(const oi of It)zt([oi],new Za(oi.x,oi.y,0))}function Ju(i,e,r,a,f,v,w,E,k,F,B,j,H,Y,K){const re=function(Be,we,Me,st,pt,Gt,ei,Vt){const Rt=st.layout.get("text-rotate").evaluate(Gt,{})*Math.PI/180,kt=[];for(const $t of we.positionedLines)for(const zt of $t.positionedGlyphs){if(!zt.rect)continue;const It=zt.rect||{};let oi=mu+1,ti=!0,Ai=1,lr=0;const mr=(pt||Vt)&&zt.vertical,jr=zt.metrics.advance*zt.scale/2;if(Vt&&we.verticalizable&&(lr=$t.lineOffset/2-(zt.imageName?-(Br-zt.metrics.width*zt.scale)/2:(zt.scale-1)*Br)),zt.imageName){const Ur=ei[zt.imageName];ti=Ur.sdf,Ai=Ur.pixelRatio,oi=zn/Ai}const Zn=pt?[zt.x+jr,zt.y]:[0,0];let An=pt?[0,0]:[zt.x+jr+Me[0],zt.y+Me[1]-lr],Dr=[0,0];mr&&(Dr=An,An=[0,0]);const en=zt.metrics.isDoubleResolution?2:1,un=(zt.metrics.left-oi)*zt.scale-jr+An[0],Mn=(-zt.metrics.top-oi)*zt.scale+An[1],kn=un+It.w/en*zt.scale/Ai,Nr=Mn+It.h/en*zt.scale/Ai,Vr=new o(un,Mn),yn=new o(kn,Mn),Dn=new o(un,Nr),vn=new o(kn,Nr);if(mr){const Ur=new o(-jr,jr-Gl),Li=-Math.PI/2,xn=Br/2-jr,dn=new o(5-Gl-xn,-(zt.imageName?xn:0)),Gr=new o(...Dr);Vr._rotateAround(Li,Ur)._add(dn)._add(Gr),yn._rotateAround(Li,Ur)._add(dn)._add(Gr),Dn._rotateAround(Li,Ur)._add(dn)._add(Gr),vn._rotateAround(Li,Ur)._add(dn)._add(Gr)}if(Rt){const Ur=Math.sin(Rt),Li=Math.cos(Rt),xn=[Li,-Ur,Ur,Li];Vr._matMult(xn),yn._matMult(xn),Dn._matMult(xn),vn._matMult(xn)}const Rn=new o(0,0),Bn=new o(0,0);kt.push({tl:Vr,tr:yn,bl:Dn,br:vn,tex:It,writingMode:we.writingMode,glyphOffset:Zn,sectionIndex:zt.sectionIndex,isSDF:ti,pixelOffsetTL:Rn,pixelOffsetBR:Bn,minFontScaleX:0,minFontScaleY:0})}return kt}(0,r,E,f,v,w,a,i.allowVerticalPlacement),he=i.textSizeData;let ve=null;he.kind==="source"?(ve=[ta*f.layout.get("text-size").evaluate(w,{})],ve[0]>$a&&ut(`${i.layerIds[0]}: Value for "text-size" is >= ${Hl}. Reduce your "text-size".`)):he.kind==="composite"&&(ve=[ta*Y.compositeTextSizes[0].evaluate(w,{},K),ta*Y.compositeTextSizes[1].evaluate(w,{},K)],(ve[0]>$a||ve[1]>$a)&&ut(`${i.layerIds[0]}: Value for "text-size" is >= ${Hl}. Reduce your "text-size".`)),i.addSymbols(i.text,re,ve,E,v,w,F,e,k.lineStartIndex,k.lineLength,H,K);for(const Be of B)j[Be]=i.text.placedSymbolArray.length-1;return 4*re.length}function Qu(i){for(const e in i)return i[e];return null}function cp(i,e,r,a){const f=i.compareText;if(e in f){const v=f[e];for(let w=v.length-1;w>=0;w--)if(a.dist(v[w])<r)return!0}else f[e]=[];return f[e].push(a),!1}const ed=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class hh{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[r,a]=new Uint8Array(e,0,2);if(r!==219)throw new Error("Data does not appear to be in a KDBush format.");const f=a>>4;if(f!==1)throw new Error(`Got v${f} data when expected v1.`);const v=ed[15&a];if(!v)throw new Error("Unrecognized array type.");const[w]=new Uint16Array(e,2,1),[E]=new Uint32Array(e,4,1);return new hh(E,w,v,e)}constructor(e,r=64,a=Float64Array,f){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+r,2),65535),this.ArrayType=a,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const v=ed.indexOf(this.ArrayType),w=2*e*this.ArrayType.BYTES_PER_ELEMENT,E=e*this.IndexArrayType.BYTES_PER_ELEMENT,k=(8-E%8)%8;if(v<0)throw new Error(`Unexpected typed array class: ${a}.`);f&&f instanceof ArrayBuffer?(this.data=f,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+E+k,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+w+E+k),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+E+k,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+v]),new Uint16Array(this.data,2,1)[0]=r,new Uint32Array(this.data,4,1)[0]=e)}add(e,r){const a=this._pos>>1;return this.ids[a]=a,this.coords[this._pos++]=e,this.coords[this._pos++]=r,a}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return uh(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,r,a,f){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:v,coords:w,nodeSize:E}=this,k=[0,v.length-1,0],F=[];for(;k.length;){const B=k.pop()||0,j=k.pop()||0,H=k.pop()||0;if(j-H<=E){for(let he=H;he<=j;he++){const ve=w[2*he],Be=w[2*he+1];ve>=e&&ve<=a&&Be>=r&&Be<=f&&F.push(v[he])}continue}const Y=H+j>>1,K=w[2*Y],re=w[2*Y+1];K>=e&&K<=a&&re>=r&&re<=f&&F.push(v[Y]),(B===0?e<=K:r<=re)&&(k.push(H),k.push(Y-1),k.push(1-B)),(B===0?a>=K:f>=re)&&(k.push(Y+1),k.push(j),k.push(1-B))}return F}within(e,r,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:f,coords:v,nodeSize:w}=this,E=[0,f.length-1,0],k=[],F=a*a;for(;E.length;){const B=E.pop()||0,j=E.pop()||0,H=E.pop()||0;if(j-H<=w){for(let he=H;he<=j;he++)id(v[2*he],v[2*he+1],e,r)<=F&&k.push(f[he]);continue}const Y=H+j>>1,K=v[2*Y],re=v[2*Y+1];id(K,re,e,r)<=F&&k.push(f[Y]),(B===0?e-a<=K:r-a<=re)&&(E.push(H),E.push(Y-1),E.push(1-B)),(B===0?e+a>=K:r+a>=re)&&(E.push(Y+1),E.push(j),E.push(1-B))}return k}}function uh(i,e,r,a,f,v){if(f-a<=r)return;const w=a+f>>1;td(i,e,w,a,f,v),uh(i,e,r,a,w-1,1-v),uh(i,e,r,w+1,f,1-v)}function td(i,e,r,a,f,v){for(;f>a;){if(f-a>600){const F=f-a+1,B=r-a+1,j=Math.log(F),H=.5*Math.exp(2*j/3),Y=.5*Math.sqrt(j*H*(F-H)/F)*(B-F/2<0?-1:1);td(i,e,r,Math.max(a,Math.floor(r-B*H/F+Y)),Math.min(f,Math.floor(r+(F-B)*H/F+Y)),v)}const w=e[2*r+v];let E=a,k=f;for(ql(i,e,a,r),e[2*f+v]>w&&ql(i,e,a,f);E<k;){for(ql(i,e,E,k),E++,k--;e[2*E+v]<w;)E++;for(;e[2*k+v]>w;)k--}e[2*a+v]===w?ql(i,e,a,k):(k++,ql(i,e,k,f)),k<=r&&(a=k+1),r<=k&&(f=k-1)}}function ql(i,e,r,a){dh(i,r,a),dh(e,2*r,2*a),dh(e,2*r+1,2*a+1)}function dh(i,e,r){const a=i[e];i[e]=i[r],i[r]=a}function id(i,e,r,a){const f=i-r,v=e-a;return f*f+v*v}var fh;V.bd=void 0,(fh=V.bd||(V.bd={})).create="create",fh.load="load",fh.fullLoad="fullLoad";let Ic=null,$l=[];const ph=1e3/60,mh="loadTime",gh="fullLoadTime",hp={mark(i){performance.mark(i)},frame(i){const e=i;Ic!=null&&$l.push(e-Ic),Ic=e},clearMetrics(){Ic=null,$l=[],performance.clearMeasures(mh),performance.clearMeasures(gh);for(const i in V.bd)performance.clearMarks(V.bd[i])},getPerformanceMetrics(){performance.measure(mh,V.bd.create,V.bd.load),performance.measure(gh,V.bd.create,V.bd.fullLoad);const i=performance.getEntriesByName(mh)[0].duration,e=performance.getEntriesByName(gh)[0].duration,r=$l.length,a=1/($l.reduce((v,w)=>v+w,0)/r/1e3),f=$l.filter(v=>v>ph).reduce((v,w)=>v+(w-ph)/ph,0);return{loadTime:i,fullLoadTime:e,fps:a,percentDroppedFrames:f/(r+f)*100,totalFrames:r}}};V.$=wt,V.A=Zo,V.B=function(i){if(ct==null){const e=i.navigator?i.navigator.userAgent:null;ct=!!i.safari||!(!e||!(/\b(iPad|iPhone|iPod)\b/.test(e)||e.match("Safari")&&!e.match("Chrome")))}return ct},V.C=class{constructor(i,e){this.target=i,this.mapId=e,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new ep(()=>this.process()),this.subscription=function(r,a,f,v){return r.addEventListener(a,f,!1),{unsubscribe:()=>{r.removeEventListener(a,f,!1)}}}(this.target,"message",r=>this.receive(r)),this.globalScope=St(self)?i:window}registerMessageHandler(i,e){this.messageHandlers[i]=e}sendAsync(i,e){return new Promise((r,a)=>{const f=Math.round(1e18*Math.random()).toString(36).substring(0,10);this.resolveRejects[f]={resolve:r,reject:a},e&&e.signal.addEventListener("abort",()=>{delete this.resolveRejects[f];const E={id:f,type:"<cancel>",origin:location.origin,targetMapId:i.targetMapId,sourceMapId:this.mapId};this.target.postMessage(E)},{once:!0});const v=[],w=Object.assign(Object.assign({},i),{id:f,sourceMapId:this.mapId,origin:location.origin,data:Sn(i.data,v)});this.target.postMessage(w,{transfer:v})})}receive(i){const e=i.data,r=e.id;if(!(e.origin!=="file://"&&location.origin!=="file://"&&e.origin!==location.origin||e.targetMapId&&this.mapId!==e.targetMapId)){if(e.type==="<cancel>"){delete this.tasks[r];const a=this.abortControllers[r];return delete this.abortControllers[r],void(a&&a.abort())}if(St(self)||e.mustQueue)return this.tasks[r]=e,this.taskQueue.push(r),void this.invoker.trigger();this.processTask(r,e)}}process(){if(this.taskQueue.length===0)return;const i=this.taskQueue.shift(),e=this.tasks[i];delete this.tasks[i],this.taskQueue.length>0&&this.invoker.trigger(),e&&this.processTask(i,e)}processTask(i,e){return s(this,void 0,void 0,function*(){if(e.type==="<response>"){const f=this.resolveRejects[i];return delete this.resolveRejects[i],f?void(e.error?f.reject(Tn(e.error)):f.resolve(Tn(e.data))):void 0}if(!this.messageHandlers[e.type])return void this.completeTask(i,new Error(`Could not find a registered handler for ${e.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const r=Tn(e.data),a=new AbortController;this.abortControllers[i]=a;try{const f=yield this.messageHandlers[e.type](e.sourceMapId,r,a);this.completeTask(i,null,f)}catch(f){this.completeTask(i,f)}})}completeTask(i,e,r){const a=[];delete this.abortControllers[i];const f={id:i,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:e?Sn(e):null,data:Sn(r,a)};this.target.postMessage(f,{transfer:a})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},V.D=ii,V.E=Xe,V.F=function(){var i=new Zo(16);return Zo!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i},V.G=Le,V.H=function(i,e,r){var a,f,v,w,E,k,F,B,j,H,Y,K,re=r[0],he=r[1],ve=r[2];return e===i?(i[12]=e[0]*re+e[4]*he+e[8]*ve+e[12],i[13]=e[1]*re+e[5]*he+e[9]*ve+e[13],i[14]=e[2]*re+e[6]*he+e[10]*ve+e[14],i[15]=e[3]*re+e[7]*he+e[11]*ve+e[15]):(f=e[1],v=e[2],w=e[3],E=e[4],k=e[5],F=e[6],B=e[7],j=e[8],H=e[9],Y=e[10],K=e[11],i[0]=a=e[0],i[1]=f,i[2]=v,i[3]=w,i[4]=E,i[5]=k,i[6]=F,i[7]=B,i[8]=j,i[9]=H,i[10]=Y,i[11]=K,i[12]=a*re+E*he+j*ve+e[12],i[13]=f*re+k*he+H*ve+e[13],i[14]=v*re+F*he+Y*ve+e[14],i[15]=w*re+B*he+K*ve+e[15]),i},V.I=Kc,V.J=function(i,e,r){var a=r[0],f=r[1],v=r[2];return i[0]=e[0]*a,i[1]=e[1]*a,i[2]=e[2]*a,i[3]=e[3]*a,i[4]=e[4]*f,i[5]=e[5]*f,i[6]=e[6]*f,i[7]=e[7]*f,i[8]=e[8]*v,i[9]=e[9]*v,i[10]=e[10]*v,i[11]=e[11]*v,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i},V.K=zh,V.L=function(i,e){const r={};for(let a=0;a<e.length;a++){const f=e[a];f in i&&(r[f]=i[f])}return r},V.M=Ya,V.N=ku,V.O=Du,V.P=o,V.Q=ls,V.R=os,V.S=C,V.T=_l,V.U=S,V.V=de,V.W=Di,V.X=Pr,V.Y=wc,V.Z=class extends Qs{},V._=s,V.a=ee,V.a$=function(i,e,r){return i[0]=e[0]*r[0],i[1]=e[1]*r[1],i[2]=e[2]*r[2],i[3]=e[3]*r[3],i},V.a0=oh,V.a1=ht,V.a2=i=>{const e=window.document.createElement("video");return e.muted=!0,new Promise(r=>{e.onloadstart=()=>{r(e)};for(const a of i){const f=window.document.createElement("source");dt(a)||(e.crossOrigin="Anonymous"),f.src=a,e.appendChild(f)}})},V.a3=function(){return ye++},V.a4=nc,V.a5=il,V.a6=ks,V.a7=va,V.a8=ar,V.a9=Bu,V.aA=at,V.aB=function(i,e){if(!i)return[{command:"setStyle",args:[e]}];let r=[];try{if(!Pt(i.version,e.version))return[{command:"setStyle",args:[e]}];Pt(i.center,e.center)||r.push({command:"setCenter",args:[e.center]}),Pt(i.zoom,e.zoom)||r.push({command:"setZoom",args:[e.zoom]}),Pt(i.bearing,e.bearing)||r.push({command:"setBearing",args:[e.bearing]}),Pt(i.pitch,e.pitch)||r.push({command:"setPitch",args:[e.pitch]}),Pt(i.sprite,e.sprite)||r.push({command:"setSprite",args:[e.sprite]}),Pt(i.glyphs,e.glyphs)||r.push({command:"setGlyphs",args:[e.glyphs]}),Pt(i.transition,e.transition)||r.push({command:"setTransition",args:[e.transition]}),Pt(i.light,e.light)||r.push({command:"setLight",args:[e.light]}),Pt(i.terrain,e.terrain)||r.push({command:"setTerrain",args:[e.terrain]}),Pt(i.sky,e.sky)||r.push({command:"setSky",args:[e.sky]});const a={},f=[];(function(w,E,k,F){let B;for(B in E=E||{},w=w||{})Object.prototype.hasOwnProperty.call(w,B)&&(Object.prototype.hasOwnProperty.call(E,B)||qt(B,k,F));for(B in E)Object.prototype.hasOwnProperty.call(E,B)&&(Object.prototype.hasOwnProperty.call(w,B)?Pt(w[B],E[B])||(w[B].type==="geojson"&&E[B].type==="geojson"&&gi(w,E,B)?Ot(k,{command:"setGeoJSONSourceData",args:[B,E[B].data]}):Yt(B,E,k,F)):nt(B,E,k))})(i.sources,e.sources,f,a);const v=[];i.layers&&i.layers.forEach(w=>{"source"in w&&a[w.source]?r.push({command:"removeLayer",args:[w.id]}):v.push(w)}),r=r.concat(f),function(w,E,k){E=E||[];const F=(w=w||[]).map(fi),B=E.map(fi),j=w.reduce(Gi,{}),H=E.reduce(Gi,{}),Y=F.slice(),K=Object.create(null);let re,he,ve,Be,we;for(let Me=0,st=0;Me<F.length;Me++)re=F[Me],Object.prototype.hasOwnProperty.call(H,re)?st++:(Ot(k,{command:"removeLayer",args:[re]}),Y.splice(Y.indexOf(re,st),1));for(let Me=0,st=0;Me<B.length;Me++)re=B[B.length-1-Me],Y[Y.length-1-Me]!==re&&(Object.prototype.hasOwnProperty.call(j,re)?(Ot(k,{command:"removeLayer",args:[re]}),Y.splice(Y.lastIndexOf(re,Y.length-st),1)):st++,Be=Y[Y.length-Me],Ot(k,{command:"addLayer",args:[H[re],Be]}),Y.splice(Y.length-Me,0,re),K[re]=!0);for(let Me=0;Me<B.length;Me++)if(re=B[Me],he=j[re],ve=H[re],!K[re]&&!Pt(he,ve))if(Pt(he.source,ve.source)&&Pt(he["source-layer"],ve["source-layer"])&&Pt(he.type,ve.type)){for(we in xi(he.layout,ve.layout,k,re,null,"setLayoutProperty"),xi(he.paint,ve.paint,k,re,null,"setPaintProperty"),Pt(he.filter,ve.filter)||Ot(k,{command:"setFilter",args:[re,ve.filter]}),Pt(he.minzoom,ve.minzoom)&&Pt(he.maxzoom,ve.maxzoom)||Ot(k,{command:"setLayerZoomRange",args:[re,ve.minzoom,ve.maxzoom]}),he)Object.prototype.hasOwnProperty.call(he,we)&&we!=="layout"&&we!=="paint"&&we!=="filter"&&we!=="metadata"&&we!=="minzoom"&&we!=="maxzoom"&&(we.indexOf("paint.")===0?xi(he[we],ve[we],k,re,we.slice(6),"setPaintProperty"):Pt(he[we],ve[we])||Ot(k,{command:"setLayerProperty",args:[re,we,ve[we]]}));for(we in ve)Object.prototype.hasOwnProperty.call(ve,we)&&!Object.prototype.hasOwnProperty.call(he,we)&&we!=="layout"&&we!=="paint"&&we!=="filter"&&we!=="metadata"&&we!=="minzoom"&&we!=="maxzoom"&&(we.indexOf("paint.")===0?xi(he[we],ve[we],k,re,we.slice(6),"setPaintProperty"):Pt(he[we],ve[we])||Ot(k,{command:"setLayerProperty",args:[re,we,ve[we]]}))}else Ot(k,{command:"removeLayer",args:[re]}),Be=Y[Y.lastIndexOf(re)+1],Ot(k,{command:"addLayer",args:[ve,Be]})}(v,e.layers,r)}catch(a){console.warn("Unable to compute style diff:",a),r=[{command:"setStyle",args:[e]}]}return r},V.aC=function(i){const e=[],r=i.id;return r===void 0&&e.push({message:`layers.${r}: missing required property "id"`}),i.render===void 0&&e.push({message:`layers.${r}: missing required method "render"`}),i.renderingMode&&i.renderingMode!=="2d"&&i.renderingMode!=="3d"&&e.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),e},V.aD=function i(e,r){if(Array.isArray(e)){if(!Array.isArray(r)||e.length!==r.length)return!1;for(let a=0;a<e.length;a++)if(!i(e[a],r[a]))return!1;return!0}if(typeof e=="object"&&e!==null&&r!==null){if(typeof r!="object"||Object.keys(e).length!==Object.keys(r).length)return!1;for(const a in e)if(!i(e[a],r[a]))return!1;return!0}return e===r},V.aE=Ve,V.aF=Ke,V.aG=class extends rr{constructor(i,e){super(i,e),this.current=0}set(i){this.current!==i&&(this.current=i,this.gl.uniform1i(this.location,i))}},V.aH=cn,V.aI=class extends rr{constructor(i,e){super(i,e),this.current=ga}set(i){if(i[12]!==this.current[12]||i[0]!==this.current[0])return this.current=i,void this.gl.uniformMatrix4fv(this.location,!1,i);for(let e=1;e<16;e++)if(i[e]!==this.current[e]){this.current=i,this.gl.uniformMatrix4fv(this.location,!1,i);break}}},V.aJ=ss,V.aK=class extends rr{constructor(i,e){super(i,e),this.current=[0,0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]&&i[2]===this.current[2]||(this.current=i,this.gl.uniform3f(this.location,i[0],i[1],i[2]))}},V.aL=class extends rr{constructor(i,e){super(i,e),this.current=[0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]||(this.current=i,this.gl.uniform2f(this.location,i[0],i[1]))}},V.aM=vs,V.aN=function(i,e,r,a,f,v,w){var E=1/(e-r),k=1/(a-f),F=1/(v-w);return i[0]=-2*E,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*k,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*F,i[11]=0,i[12]=(e+r)*E,i[13]=(f+a)*k,i[14]=(w+v)*F,i[15]=1,i},V.aO=Ni,V.aP=Od,V.aQ=class extends vo{},V.aR=Pf,V.aS=class extends Ga{},V.aT=function(i){return i<=1?1:Math.pow(2,Math.ceil(Math.log(i)/Math.LN2))},V.aU=Vh,V.aV=N,V.aW=class extends Il{},V.aX=qe,V.aY=function(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]&&i[3]===e[3]&&i[4]===e[4]&&i[5]===e[5]&&i[6]===e[6]&&i[7]===e[7]&&i[8]===e[8]&&i[9]===e[9]&&i[10]===e[10]&&i[11]===e[11]&&i[12]===e[12]&&i[13]===e[13]&&i[14]===e[14]&&i[15]===e[15]},V.aZ=function(i,e){var r=i[0],a=i[1],f=i[2],v=i[3],w=i[4],E=i[5],k=i[6],F=i[7],B=i[8],j=i[9],H=i[10],Y=i[11],K=i[12],re=i[13],he=i[14],ve=i[15],Be=e[0],we=e[1],Me=e[2],st=e[3],pt=e[4],Gt=e[5],ei=e[6],Vt=e[7],Rt=e[8],kt=e[9],$t=e[10],zt=e[11],It=e[12],oi=e[13],ti=e[14],Ai=e[15];return Math.abs(r-Be)<=Pn*Math.max(1,Math.abs(r),Math.abs(Be))&&Math.abs(a-we)<=Pn*Math.max(1,Math.abs(a),Math.abs(we))&&Math.abs(f-Me)<=Pn*Math.max(1,Math.abs(f),Math.abs(Me))&&Math.abs(v-st)<=Pn*Math.max(1,Math.abs(v),Math.abs(st))&&Math.abs(w-pt)<=Pn*Math.max(1,Math.abs(w),Math.abs(pt))&&Math.abs(E-Gt)<=Pn*Math.max(1,Math.abs(E),Math.abs(Gt))&&Math.abs(k-ei)<=Pn*Math.max(1,Math.abs(k),Math.abs(ei))&&Math.abs(F-Vt)<=Pn*Math.max(1,Math.abs(F),Math.abs(Vt))&&Math.abs(B-Rt)<=Pn*Math.max(1,Math.abs(B),Math.abs(Rt))&&Math.abs(j-kt)<=Pn*Math.max(1,Math.abs(j),Math.abs(kt))&&Math.abs(H-$t)<=Pn*Math.max(1,Math.abs(H),Math.abs($t))&&Math.abs(Y-zt)<=Pn*Math.max(1,Math.abs(Y),Math.abs(zt))&&Math.abs(K-It)<=Pn*Math.max(1,Math.abs(K),Math.abs(It))&&Math.abs(re-oi)<=Pn*Math.max(1,Math.abs(re),Math.abs(oi))&&Math.abs(he-ti)<=Pn*Math.max(1,Math.abs(he),Math.abs(ti))&&Math.abs(ve-Ai)<=Pn*Math.max(1,Math.abs(ve),Math.abs(Ai))},V.a_=function(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i},V.aa=function(i){const e={};if(i.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,a,f,v)=>{const w=f||v;return e[a]=!w||w.toLowerCase(),""}),e["max-age"]){const r=parseInt(e["max-age"],10);isNaN(r)?delete e["max-age"]:e["max-age"]=r}return e},V.ab=function(i,e){const r=[];for(const a in i)a in e||r.push(a);return r},V.ac=U,V.ad=function(i,e,r){var a=Math.sin(r),f=Math.cos(r),v=e[0],w=e[1],E=e[2],k=e[3],F=e[4],B=e[5],j=e[6],H=e[7];return e!==i&&(i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=v*f+F*a,i[1]=w*f+B*a,i[2]=E*f+j*a,i[3]=k*f+H*a,i[4]=F*f-v*a,i[5]=B*f-w*a,i[6]=j*f-E*a,i[7]=H*f-k*a,i},V.ae=function(i){var e=new Zo(16);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],e},V.af=uc,V.ag=function(i,e){let r=0,a=0;if(i.kind==="constant")a=i.layoutSize;else if(i.kind!=="source"){const{interpolationType:f,minZoom:v,maxZoom:w}=i,E=f?U(Wr.interpolationFactor(f,e,v,w),0,1):0;i.kind==="camera"?a=ln.number(i.minSize,i.maxSize,E):r=E}return{uSizeT:r,uSize:a}},V.ai=function(i,{uSize:e,uSizeT:r},{lowerSize:a,upperSize:f}){return i.kind==="source"?a/ta:i.kind==="composite"?ln.number(a/ta,f/ta,r):e},V.aj=th,V.ak=function(i,e,r,a){const f=e.y-i.y,v=e.x-i.x,w=a.y-r.y,E=a.x-r.x,k=w*v-E*f;if(k===0)return null;const F=(E*(i.y-r.y)-w*(i.x-r.x))/k;return new o(i.x+F*v,i.y+F*f)},V.al=Uu,V.am=xa,V.an=Lc,V.ao=Br,V.aq=eh,V.ar=function(i,e){var r=e[0],a=e[1],f=e[2],v=e[3],w=e[4],E=e[5],k=e[6],F=e[7],B=e[8],j=e[9],H=e[10],Y=e[11],K=e[12],re=e[13],he=e[14],ve=e[15],Be=r*E-a*w,we=r*k-f*w,Me=r*F-v*w,st=a*k-f*E,pt=a*F-v*E,Gt=f*F-v*k,ei=B*re-j*K,Vt=B*he-H*K,Rt=B*ve-Y*K,kt=j*he-H*re,$t=j*ve-Y*re,zt=H*ve-Y*he,It=Be*zt-we*$t+Me*kt+st*Rt-pt*Vt+Gt*ei;return It?(i[0]=(E*zt-k*$t+F*kt)*(It=1/It),i[1]=(f*$t-a*zt-v*kt)*It,i[2]=(re*Gt-he*pt+ve*st)*It,i[3]=(H*pt-j*Gt-Y*st)*It,i[4]=(k*Rt-w*zt-F*Vt)*It,i[5]=(r*zt-f*Rt+v*Vt)*It,i[6]=(he*Me-K*Gt-ve*we)*It,i[7]=(B*Gt-H*Me+Y*we)*It,i[8]=(w*$t-E*Rt+F*ei)*It,i[9]=(a*Rt-r*$t-v*ei)*It,i[10]=(K*pt-re*Me+ve*Be)*It,i[11]=(j*Me-B*pt-Y*Be)*It,i[12]=(E*Vt-w*kt-k*ei)*It,i[13]=(r*kt-a*Vt+f*ei)*It,i[14]=(re*we-K*st-he*Be)*It,i[15]=(B*st-j*we+H*Be)*It,i):null},V.as=ch,V.at=Qc,V.au=hh,V.av=function(){const i={},e=le.$version;for(const r in le.$root){const a=le.$root[r];if(a.required){let f=null;f=r==="version"?e:a.type==="array"?[]:{},f!=null&&(i[r]=f)}}return i},V.aw=Va,V.ax=Ue,V.ay=function(i){i=i.slice();const e=Object.create(null);for(let r=0;r<i.length;r++)e[i[r].id]=i[r];for(let r=0;r<i.length;r++)"ref"in i[r]&&(i[r]=bt(i[r],e[i[r].ref]));return i},V.az=function(i){if(i.type==="custom")return new Qf(i);switch(i.type){case"background":return new Zf(i);case"circle":return new Ld(i);case"fill":return new ef(i);case"fill-extrusion":return new gf(i);case"heatmap":return new zd(i);case"hillshade":return new Bd(i);case"line":return new Sf(i);case"raster":return new Jf(i);case"symbol":return new bc(i)}},V.b=Et,V.b0=function(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]+i[3]*e[3]},V.b1=$,V.b2=Fu,V.b3=Ou,V.b4=function(i,e,r,a,f){var v,w=1/Math.tan(e/2);return i[0]=w/r,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=w,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,f!=null&&f!==1/0?(i[10]=(f+a)*(v=1/(a-f)),i[14]=2*f*a*v):(i[10]=-1,i[14]=-2*a),i},V.b5=function(i,e,r){var a=Math.sin(r),f=Math.cos(r),v=e[4],w=e[5],E=e[6],k=e[7],F=e[8],B=e[9],j=e[10],H=e[11];return e!==i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[4]=v*f+F*a,i[5]=w*f+B*a,i[6]=E*f+j*a,i[7]=k*f+H*a,i[8]=F*f-v*a,i[9]=B*f-w*a,i[10]=j*f-E*a,i[11]=H*f-k*a,i},V.b6=D,V.b7=L,V.b8=function(i){return i*Math.PI/180},V.b9=function(i,e){return i[0]=e[0],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e[1],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=e[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},V.bA=fa,V.ba=class extends Go{},V.bb=sh,V.bc=hp,V.be=Je,V.bf=function(i,e){ee.REGISTERED_PROTOCOLS[i]=e},V.bg=function(i){delete ee.REGISTERED_PROTOCOLS[i]},V.bh=function(i,e){const r={};for(let f=0;f<i.length;f++){const v=e&&e[i[f].id]||uo(i[f]);e&&(e[i[f].id]=v);let w=r[v];w||(w=r[v]=[]),w.push(i[f])}const a=[];for(const f in r)a.push(r[f]);return a},V.bi=Nt,V.bj=Ru,V.bk=ju,V.bl=_u,V.bm=function(i){i.bucket.createArrays(),i.bucket.tilePixelRatio=Di/(512*i.bucket.overscaling),i.bucket.compareText={},i.bucket.iconsNeedLinear=!1;const e=i.bucket.layers[0],r=e.layout,a=e._unevaluatedLayout._values,f={layoutIconSize:a["icon-size"].possiblyEvaluate(new ar(i.bucket.zoom+1),i.canonical),layoutTextSize:a["text-size"].possiblyEvaluate(new ar(i.bucket.zoom+1),i.canonical),textMaxSize:a["text-size"].possiblyEvaluate(new ar(18))};if(i.bucket.textSizeData.kind==="composite"){const{minZoom:F,maxZoom:B}=i.bucket.textSizeData;f.compositeTextSizes=[a["text-size"].possiblyEvaluate(new ar(F),i.canonical),a["text-size"].possiblyEvaluate(new ar(B),i.canonical)]}if(i.bucket.iconSizeData.kind==="composite"){const{minZoom:F,maxZoom:B}=i.bucket.iconSizeData;f.compositeIconSizes=[a["icon-size"].possiblyEvaluate(new ar(F),i.canonical),a["icon-size"].possiblyEvaluate(new ar(B),i.canonical)]}const v=r.get("text-line-height")*Br,w=r.get("text-rotation-alignment")!=="viewport"&&r.get("symbol-placement")!=="point",E=r.get("text-keep-upright"),k=r.get("text-size");for(const F of i.bucket.features){const B=r.get("text-font").evaluate(F,{},i.canonical).join(","),j=k.evaluate(F,{},i.canonical),H=f.layoutTextSize.evaluate(F,{},i.canonical),Y=f.layoutIconSize.evaluate(F,{},i.canonical),K={horizontal:{},vertical:void 0},re=F.text;let he,ve=[0,0];if(re){const Me=re.toString(),st=r.get("text-letter-spacing").evaluate(F,{},i.canonical)*Br,pt=Fs(Me)?st:0,Gt=r.get("text-anchor").evaluate(F,{},i.canonical),ei=Ku(e,F,i.canonical);if(!ei){const zt=r.get("text-radial-offset").evaluate(F,{},i.canonical);ve=zt?Zu(Gt,[zt*Br,lh]):r.get("text-offset").evaluate(F,{},i.canonical).map(It=>It*Br)}let Vt=w?"center":r.get("text-justify").evaluate(F,{},i.canonical);const Rt=r.get("symbol-placement"),kt=Rt==="point"?r.get("text-max-width").evaluate(F,{},i.canonical)*Br:0,$t=()=>{i.bucket.allowVerticalPlacement&&Ls(Me)&&(K.vertical=yc(re,i.glyphMap,i.glyphPositions,i.imagePositions,B,kt,v,Gt,"left",pt,ve,V.ah.vertical,!0,Rt,H,j))};if(!w&&ei){const zt=new Set;if(Vt==="auto")for(let oi=0;oi<ei.values.length;oi+=2)zt.add(ch(ei.values[oi]));else zt.add(Vt);let It=!1;for(const oi of zt)if(!K.horizontal[oi])if(It)K.horizontal[oi]=K.horizontal[0];else{const ti=yc(re,i.glyphMap,i.glyphPositions,i.imagePositions,B,kt,v,"center",oi,pt,ve,V.ah.horizontal,!1,Rt,H,j);ti&&(K.horizontal[oi]=ti,It=ti.positionedLines.length===1)}$t()}else{Vt==="auto"&&(Vt=ch(Gt));const zt=yc(re,i.glyphMap,i.glyphPositions,i.imagePositions,B,kt,v,Gt,Vt,pt,ve,V.ah.horizontal,!1,Rt,H,j);zt&&(K.horizontal[Vt]=zt),$t(),Ls(Me)&&w&&E&&(K.vertical=yc(re,i.glyphMap,i.glyphPositions,i.imagePositions,B,kt,v,Gt,Vt,pt,ve,V.ah.vertical,!1,Rt,H,j))}}let Be=!1;if(F.icon&&F.icon.name){const Me=i.imageMap[F.icon.name];Me&&(he=Hf(i.imagePositions[F.icon.name],r.get("icon-offset").evaluate(F,{},i.canonical),r.get("icon-anchor").evaluate(F,{},i.canonical)),Be=!!Me.sdf,i.bucket.sdfIcons===void 0?i.bucket.sdfIcons=Be:i.bucket.sdfIcons!==Be&&ut("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Me.pixelRatio!==i.bucket.pixelRatio||r.get("icon-rotate").constantOr(1)!==0)&&(i.bucket.iconsNeedLinear=!0))}const we=Qu(K.horizontal)||K.vertical;i.bucket.iconsInText=!!we&&we.iconsInText,(we||he)&&lp(i.bucket,F,K,he,i.imageMap,f,H,Y,ve,Be,i.canonical)}i.showCollisionBoxes&&i.bucket.generateCollisionDebugBuffers()},V.bn=qc,V.bo=Wc,V.bp=Xc,V.bq=Xa,V.br=Yc,V.bs=class{constructor(i){this._marks={start:[i.url,"start"].join("#"),end:[i.url,"end"].join("#"),measure:i.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let i=performance.getEntriesByName(this._marks.measure);return i.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),i=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),i}},V.bt=function(i,e,r,a,f){return s(this,void 0,void 0,function*(){if(S())try{return yield de(i,e,r,a,f)}catch{}return function(v,w,E,k,F){const B=v.width,j=v.height;_e&&pe||(_e=new OffscreenCanvas(B,j),pe=_e.getContext("2d",{willReadFrequently:!0})),_e.width=B,_e.height=j,pe.drawImage(v,0,0,B,j);const H=pe.getImageData(w,E,k,F);return pe.clearRect(0,0,B,j),H.data}(i,e,r,a,f)})},V.bu=zu,V.bv=m,V.bw=b,V.bx=lu,V.by=Wi,V.bz=function(i){return i.message===Re},V.c=fe,V.d=i=>s(void 0,void 0,void 0,function*(){if(i.byteLength===0)return createImageBitmap(new ImageData(1,1));const e=new Blob([new Uint8Array(i)],{type:"image/png"});try{return createImageBitmap(e)}catch(r){throw new Error(`Could not load image because of ${r.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}}),V.e=ne,V.f=i=>new Promise((e,r)=>{const a=new Image;a.onload=()=>{e(a),URL.revokeObjectURL(a.src),a.onload=null,window.requestAnimationFrame(()=>{a.src=Q})},a.onerror=()=>r(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const f=new Blob([new Uint8Array(i)],{type:"image/png"});a.src=i.byteLength?URL.createObjectURL(f):Q}),V.g=Ce,V.h=(i,e)=>Ge(ne(i,{type:"json"}),e),V.i=St,V.j=Qe,V.k=Oe,V.l=(i,e)=>Ge(ne(i,{type:"arrayBuffer"}),e),V.m=Ge,V.n=function(i){return new Yc(i).readFields(jf,[])},V.o=Fl,V.p=gu,V.q=En,V.r=Ys,V.s=dt,V.t=_n,V.u=Bt,V.v=le,V.w=ut,V.x=Ri,V.y=function([i,e,r]){return e+=90,e*=Math.PI/180,r*=Math.PI/180,{x:i*Math.cos(e)*Math.sin(r),y:i*Math.sin(e)*Math.sin(r),z:i*Math.cos(r)}},V.z=ln}),Ne("worker",["./shared"],function(V){class s{constructor(W){this.keyCache={},W&&this.replace(W)}replace(W){this._layerConfigs={},this._layers={},this.update(W,[])}update(W,X){for(const ae of W){this._layerConfigs[ae.id]=ae;const Ie=this._layers[ae.id]=V.az(ae);Ie._featureFilter=V.a6(Ie.filter),this.keyCache[ae.id]&&delete this.keyCache[ae.id]}for(const ae of X)delete this.keyCache[ae],delete this._layerConfigs[ae],delete this._layers[ae];this.familiesBySource={};const J=V.bh(Object.values(this._layerConfigs),this.keyCache);for(const ae of J){const Ie=ae.map(et=>this._layers[et.id]),Pe=Ie[0];if(Pe.visibility==="none")continue;const De=Pe.source||"";let be=this.familiesBySource[De];be||(be=this.familiesBySource[De]={});const je=Pe.sourceLayer||"_geojsonTileLayer";let gt=be[je];gt||(gt=be[je]=[]),gt.push(Ie)}}}class m{constructor(W){const X={},J=[];for(const De in W){const be=W[De],je=X[De]={};for(const gt in be){const et=be[+gt];if(!et||et.bitmap.width===0||et.bitmap.height===0)continue;const lt={x:0,y:0,w:et.bitmap.width+2,h:et.bitmap.height+2};J.push(lt),je[gt]={rect:lt,metrics:et.metrics}}}const{w:ae,h:Ie}=V.p(J),Pe=new V.o({width:ae||1,height:Ie||1});for(const De in W){const be=W[De];for(const je in be){const gt=be[+je];if(!gt||gt.bitmap.width===0||gt.bitmap.height===0)continue;const et=X[De][je].rect;V.o.copy(gt.bitmap,Pe,{x:0,y:0},{x:et.x+1,y:et.y+1},gt.bitmap)}}this.image=Pe,this.positions=X}}V.bi("GlyphAtlas",m);class b{constructor(W){this.tileID=new V.Q(W.tileID.overscaledZ,W.tileID.wrap,W.tileID.canonical.z,W.tileID.canonical.x,W.tileID.canonical.y),this.uid=W.uid,this.zoom=W.zoom,this.pixelRatio=W.pixelRatio,this.tileSize=W.tileSize,this.source=W.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=W.showCollisionBoxes,this.collectResourceTiming=!!W.collectResourceTiming,this.returnDependencies=!!W.returnDependencies,this.promoteId=W.promoteId,this.inFlightDependencies=[]}parse(W,X,J,ae){return V._(this,void 0,void 0,function*(){this.status="parsing",this.data=W,this.collisionBoxArray=new V.a4;const Ie=new V.bj(Object.keys(W.layers).sort()),Pe=new V.bk(this.tileID,this.promoteId);Pe.bucketLayerIDs=[];const De={},be={featureIndex:Pe,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:J},je=X.familiesBySource[this.source];for(const ai in je){const hr=W.layers[ai];if(!hr)continue;hr.version===1&&V.w(`Vector tile source "${this.source}" layer "${ai}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Mr=Ie.encode(ai),nn=[];for(let Fr=0;Fr<hr.length;Fr++){const Yr=hr.feature(Fr),Zr=Pe.getId(Yr,ai);nn.push({feature:Yr,id:Zr,index:Fr,sourceLayerIndex:Mr})}for(const Fr of je[ai]){const Yr=Fr[0];Yr.source!==this.source&&V.w(`layer.source = ${Yr.source} does not equal this.source = ${this.source}`),Yr.minzoom&&this.zoom<Math.floor(Yr.minzoom)||Yr.maxzoom&&this.zoom>=Yr.maxzoom||Yr.visibility!=="none"&&(x(Fr,this.zoom,J),(De[Yr.id]=Yr.createBucket({index:Pe.bucketLayerIDs.length,layers:Fr,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Mr,sourceID:this.source})).populate(nn,be,this.tileID.canonical),Pe.bucketLayerIDs.push(Fr.map(Zr=>Zr.id)))}}const gt=V.aE(be.glyphDependencies,ai=>Object.keys(ai).map(Number));this.inFlightDependencies.forEach(ai=>ai==null?void 0:ai.abort()),this.inFlightDependencies=[];let et=Promise.resolve({});if(Object.keys(gt).length){const ai=new AbortController;this.inFlightDependencies.push(ai),et=ae.sendAsync({type:"getGlyphs",data:{stacks:gt,source:this.source,tileID:this.tileID,type:"glyphs"}},ai)}const lt=Object.keys(be.iconDependencies);let Jt=Promise.resolve({});if(lt.length){const ai=new AbortController;this.inFlightDependencies.push(ai),Jt=ae.sendAsync({type:"getImages",data:{icons:lt,source:this.source,tileID:this.tileID,type:"icons"}},ai)}const ci=Object.keys(be.patternDependencies);let si=Promise.resolve({});if(ci.length){const ai=new AbortController;this.inFlightDependencies.push(ai),si=ae.sendAsync({type:"getImages",data:{icons:ci,source:this.source,tileID:this.tileID,type:"patterns"}},ai)}const[Mi,pi,Xi]=yield Promise.all([et,Jt,si]),Zi=new m(Mi),xr=new V.bl(pi,Xi);for(const ai in De){const hr=De[ai];hr instanceof V.a5?(x(hr.layers,this.zoom,J),V.bm({bucket:hr,glyphMap:Mi,glyphPositions:Zi.positions,imageMap:pi,imagePositions:xr.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical})):hr.hasPattern&&(hr instanceof V.bn||hr instanceof V.bo||hr instanceof V.bp)&&(x(hr.layers,this.zoom,J),hr.addFeatures(be,this.tileID.canonical,xr.patternPositions))}return this.status="done",{buckets:Object.values(De).filter(ai=>!ai.isEmpty()),featureIndex:Pe,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Zi.image,imageAtlas:xr,glyphMap:this.returnDependencies?Mi:null,iconMap:this.returnDependencies?pi:null,glyphPositions:this.returnDependencies?Zi.positions:null}})}}function x(se,W,X){const J=new V.a8(W);for(const ae of se)ae.recalculate(J,X)}class o{constructor(W,X,J){this.actor=W,this.layerIndex=X,this.availableImages=J,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(W,X){return V._(this,void 0,void 0,function*(){const J=yield V.l(W.request,X);try{return{vectorTile:new V.bq.VectorTile(new V.br(J.data)),rawData:J.data,cacheControl:J.cacheControl,expires:J.expires}}catch(ae){const Ie=new Uint8Array(J.data);let Pe=`Unable to parse the tile at ${W.request.url}, `;throw Pe+=Ie[0]===31&&Ie[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${ae.messge}`,new Error(Pe)}})}loadTile(W){return V._(this,void 0,void 0,function*(){const X=W.uid,J=!!(W&&W.request&&W.request.collectResourceTiming)&&new V.bs(W.request),ae=new b(W);this.loading[X]=ae;const Ie=new AbortController;ae.abort=Ie;try{const Pe=yield this.loadVectorTile(W,Ie);if(delete this.loading[X],!Pe)return null;const De=Pe.rawData,be={};Pe.expires&&(be.expires=Pe.expires),Pe.cacheControl&&(be.cacheControl=Pe.cacheControl);const je={};if(J){const et=J.finish();et&&(je.resourceTiming=JSON.parse(JSON.stringify(et)))}ae.vectorTile=Pe.vectorTile;const gt=ae.parse(Pe.vectorTile,this.layerIndex,this.availableImages,this.actor);this.loaded[X]=ae,this.fetching[X]={rawTileData:De,cacheControl:be,resourceTiming:je};try{const et=yield gt;return V.e({rawTileData:De.slice(0)},et,be,je)}finally{delete this.fetching[X]}}catch(Pe){throw delete this.loading[X],ae.status="done",this.loaded[X]=ae,Pe}})}reloadTile(W){return V._(this,void 0,void 0,function*(){const X=W.uid;if(!this.loaded||!this.loaded[X])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const J=this.loaded[X];if(J.showCollisionBoxes=W.showCollisionBoxes,J.status==="parsing"){const ae=yield J.parse(J.vectorTile,this.layerIndex,this.availableImages,this.actor);let Ie;if(this.fetching[X]){const{rawTileData:Pe,cacheControl:De,resourceTiming:be}=this.fetching[X];delete this.fetching[X],Ie=V.e({rawTileData:Pe.slice(0)},ae,De,be)}else Ie=ae;return Ie}if(J.status==="done"&&J.vectorTile)return J.parse(J.vectorTile,this.layerIndex,this.availableImages,this.actor)})}abortTile(W){return V._(this,void 0,void 0,function*(){const X=this.loading,J=W.uid;X&&X[J]&&X[J].abort&&(X[J].abort.abort(),delete X[J])})}removeTile(W){return V._(this,void 0,void 0,function*(){this.loaded&&this.loaded[W.uid]&&delete this.loaded[W.uid]})}}class c{constructor(){this.loaded={}}loadTile(W){return V._(this,void 0,void 0,function*(){const{uid:X,encoding:J,rawImageData:ae,redFactor:Ie,greenFactor:Pe,blueFactor:De,baseShift:be}=W,je=ae.width+2,gt=ae.height+2,et=V.b(ae)?new V.R({width:je,height:gt},yield V.bt(ae,-1,-1,je,gt)):ae,lt=new V.bu(X,et,J,Ie,Pe,De,be);return this.loaded=this.loaded||{},this.loaded[X]=lt,lt})}removeTile(W){const X=this.loaded,J=W.uid;X&&X[J]&&delete X[J]}}function h(se,W){if(se.length!==0){p(se[0],W);for(var X=1;X<se.length;X++)p(se[X],!W)}}function p(se,W){for(var X=0,J=0,ae=0,Ie=se.length,Pe=Ie-1;ae<Ie;Pe=ae++){var De=(se[ae][0]-se[Pe][0])*(se[Pe][1]+se[ae][1]),be=X+De;J+=Math.abs(X)>=Math.abs(De)?X-be+De:De-be+X,X=be}X+J>=0!=!!W&&se.reverse()}var _=V.bv(function se(W,X){var J,ae=W&&W.type;if(ae==="FeatureCollection")for(J=0;J<W.features.length;J++)se(W.features[J],X);else if(ae==="GeometryCollection")for(J=0;J<W.geometries.length;J++)se(W.geometries[J],X);else if(ae==="Feature")se(W.geometry,X);else if(ae==="Polygon")h(W.coordinates,X);else if(ae==="MultiPolygon")for(J=0;J<W.coordinates.length;J++)h(W.coordinates[J],X);return W});const u=V.bq.VectorTileFeature.prototype.toGeoJSON;var C={exports:{}},S=V.bw,D=V.bq.VectorTileFeature,L=U;function U(se,W){this.options=W||{},this.features=se,this.length=se.length}function $(se,W){this.id=typeof se.id=="number"?se.id:void 0,this.type=se.type,this.rawGeometry=se.type===1?[se.geometry]:se.geometry,this.properties=se.tags,this.extent=W||4096}U.prototype.feature=function(se){return new $(this.features[se],this.options.extent)},$.prototype.loadGeometry=function(){var se=this.rawGeometry;this.geometry=[];for(var W=0;W<se.length;W++){for(var X=se[W],J=[],ae=0;ae<X.length;ae++)J.push(new S(X[ae][0],X[ae][1]));this.geometry.push(J)}return this.geometry},$.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var se=this.geometry,W=1/0,X=-1/0,J=1/0,ae=-1/0,Ie=0;Ie<se.length;Ie++)for(var Pe=se[Ie],De=0;De<Pe.length;De++){var be=Pe[De];W=Math.min(W,be.x),X=Math.max(X,be.x),J=Math.min(J,be.y),ae=Math.max(ae,be.y)}return[W,J,X,ae]},$.prototype.toGeoJSON=D.prototype.toGeoJSON;var ne=V.bx,ye=L;function Ve(se){var W=new ne;return function(X,J){for(var ae in X.layers)J.writeMessage(3,Ke,X.layers[ae])}(se,W),W.finish()}function Ke(se,W){var X;W.writeVarintField(15,se.version||1),W.writeStringField(1,se.name||""),W.writeVarintField(5,se.extent||4096);var J={keys:[],values:[],keycache:{},valuecache:{}};for(X=0;X<se.length;X++)J.feature=se.feature(X),W.writeMessage(2,at,J);var ae=J.keys;for(X=0;X<ae.length;X++)W.writeStringField(3,ae[X]);var Ie=J.values;for(X=0;X<Ie.length;X++)W.writeMessage(4,St,Ie[X])}function at(se,W){var X=se.feature;X.id!==void 0&&W.writeVarintField(1,X.id),W.writeMessage(2,$e,se),W.writeVarintField(3,X.type),W.writeMessage(4,vt,X)}function $e(se,W){var X=se.feature,J=se.keys,ae=se.values,Ie=se.keycache,Pe=se.valuecache;for(var De in X.properties){var be=X.properties[De],je=Ie[De];if(be!==null){je===void 0&&(J.push(De),Ie[De]=je=J.length-1),W.writeVarint(je);var gt=typeof be;gt!=="string"&&gt!=="boolean"&&gt!=="number"&&(be=JSON.stringify(be));var et=gt+":"+be,lt=Pe[et];lt===void 0&&(ae.push(be),Pe[et]=lt=ae.length-1),W.writeVarint(lt)}}}function ut(se,W){return(W<<3)+(7&se)}function ot(se){return se<<1^se>>31}function vt(se,W){for(var X=se.loadGeometry(),J=se.type,ae=0,Ie=0,Pe=X.length,De=0;De<Pe;De++){var be=X[De],je=1;J===1&&(je=be.length),W.writeVarint(ut(1,je));for(var gt=J===3?be.length-1:be.length,et=0;et<gt;et++){et===1&&J!==1&&W.writeVarint(ut(2,gt-1));var lt=be[et].x-ae,Jt=be[et].y-Ie;W.writeVarint(ot(lt)),W.writeVarint(ot(Jt)),ae+=lt,Ie+=Jt}J===3&&W.writeVarint(ut(7,1))}}function St(se,W){var X=typeof se;X==="string"?W.writeStringField(1,se):X==="boolean"?W.writeBooleanField(7,se):X==="number"&&(se%1!=0?W.writeDoubleField(3,se):se<0?W.writeSVarintField(6,se):W.writeVarintField(5,se))}C.exports=Ve,C.exports.fromVectorTileJs=Ve,C.exports.fromGeojsonVt=function(se,W){W=W||{};var X={};for(var J in se)X[J]=new ye(se[J].features,W),X[J].name=J,X[J].version=W.version,X[J].extent=W.extent;return Ve({layers:X})},C.exports.GeoJSONWrapper=ye;var ct=V.bv(C.exports);const Et={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:se=>se},Q=Math.fround||(de=new Float32Array(1),se=>(de[0]=+se,de[0]));var de;const _e=3,pe=5,Re=6;class fe{constructor(W){this.options=Object.assign(Object.create(Et),W),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(W){const{log:X,minZoom:J,maxZoom:ae}=this.options;X&&console.time("total time");const Ie=`prepare ${W.length} points`;X&&console.time(Ie),this.points=W;const Pe=[];for(let be=0;be<W.length;be++){const je=W[be];if(!je.geometry)continue;const[gt,et]=je.geometry.coordinates,lt=Q(Le(gt)),Jt=Q(Je(et));Pe.push(lt,Jt,1/0,be,-1,1),this.options.reduce&&Pe.push(0)}let De=this.trees[ae+1]=this._createTree(Pe);X&&console.timeEnd(Ie);for(let be=ae;be>=J;be--){const je=+Date.now();De=this.trees[be]=this._createTree(this._cluster(De,be)),X&&console.log("z%d: %d clusters in %dms",be,De.numItems,+Date.now()-je)}return X&&console.timeEnd("total time"),this}getClusters(W,X){let J=((W[0]+180)%360+360)%360-180;const ae=Math.max(-90,Math.min(90,W[1]));let Ie=W[2]===180?180:((W[2]+180)%360+360)%360-180;const Pe=Math.max(-90,Math.min(90,W[3]));if(W[2]-W[0]>=360)J=-180,Ie=180;else if(J>Ie){const et=this.getClusters([J,ae,180,Pe],X),lt=this.getClusters([-180,ae,Ie,Pe],X);return et.concat(lt)}const De=this.trees[this._limitZoom(X)],be=De.range(Le(J),Je(Pe),Le(Ie),Je(ae)),je=De.data,gt=[];for(const et of be){const lt=this.stride*et;gt.push(je[lt+pe]>1?ee(je,lt,this.clusterProps):this.points[je[lt+_e]])}return gt}getChildren(W){const X=this._getOriginId(W),J=this._getOriginZoom(W),ae="No cluster with the specified id.",Ie=this.trees[J];if(!Ie)throw new Error(ae);const Pe=Ie.data;if(X*this.stride>=Pe.length)throw new Error(ae);const De=this.options.radius/(this.options.extent*Math.pow(2,J-1)),be=Ie.within(Pe[X*this.stride],Pe[X*this.stride+1],De),je=[];for(const gt of be){const et=gt*this.stride;Pe[et+4]===W&&je.push(Pe[et+pe]>1?ee(Pe,et,this.clusterProps):this.points[Pe[et+_e]])}if(je.length===0)throw new Error(ae);return je}getLeaves(W,X,J){const ae=[];return this._appendLeaves(ae,W,X=X||10,J=J||0,0),ae}getTile(W,X,J){const ae=this.trees[this._limitZoom(W)],Ie=Math.pow(2,W),{extent:Pe,radius:De}=this.options,be=De/Pe,je=(J-be)/Ie,gt=(J+1+be)/Ie,et={features:[]};return this._addTileFeatures(ae.range((X-be)/Ie,je,(X+1+be)/Ie,gt),ae.data,X,J,Ie,et),X===0&&this._addTileFeatures(ae.range(1-be/Ie,je,1,gt),ae.data,Ie,J,Ie,et),X===Ie-1&&this._addTileFeatures(ae.range(0,je,be/Ie,gt),ae.data,-1,J,Ie,et),et.features.length?et:null}getClusterExpansionZoom(W){let X=this._getOriginZoom(W)-1;for(;X<=this.options.maxZoom;){const J=this.getChildren(W);if(X++,J.length!==1)break;W=J[0].properties.cluster_id}return X}_appendLeaves(W,X,J,ae,Ie){const Pe=this.getChildren(X);for(const De of Pe){const be=De.properties;if(be&&be.cluster?Ie+be.point_count<=ae?Ie+=be.point_count:Ie=this._appendLeaves(W,be.cluster_id,J,ae,Ie):Ie<ae?Ie++:W.push(De),W.length===J)break}return Ie}_createTree(W){const X=new V.au(W.length/this.stride|0,this.options.nodeSize,Float32Array);for(let J=0;J<W.length;J+=this.stride)X.add(W[J],W[J+1]);return X.finish(),X.data=W,X}_addTileFeatures(W,X,J,ae,Ie,Pe){for(const De of W){const be=De*this.stride,je=X[be+pe]>1;let gt,et,lt;if(je)gt=Ce(X,be,this.clusterProps),et=X[be],lt=X[be+1];else{const si=this.points[X[be+_e]];gt=si.properties;const[Mi,pi]=si.geometry.coordinates;et=Le(Mi),lt=Je(pi)}const Jt={type:1,geometry:[[Math.round(this.options.extent*(et*Ie-J)),Math.round(this.options.extent*(lt*Ie-ae))]],tags:gt};let ci;ci=je||this.options.generateId?X[be+_e]:this.points[X[be+_e]].id,ci!==void 0&&(Jt.id=ci),Pe.features.push(Jt)}}_limitZoom(W){return Math.max(this.options.minZoom,Math.min(Math.floor(+W),this.options.maxZoom+1))}_cluster(W,X){const{radius:J,extent:ae,reduce:Ie,minPoints:Pe}=this.options,De=J/(ae*Math.pow(2,X)),be=W.data,je=[],gt=this.stride;for(let et=0;et<be.length;et+=gt){if(be[et+2]<=X)continue;be[et+2]=X;const lt=be[et],Jt=be[et+1],ci=W.within(be[et],be[et+1],De),si=be[et+pe];let Mi=si;for(const pi of ci){const Xi=pi*gt;be[Xi+2]>X&&(Mi+=be[Xi+pe])}if(Mi>si&&Mi>=Pe){let pi,Xi=lt*si,Zi=Jt*si,xr=-1;const ai=((et/gt|0)<<5)+(X+1)+this.points.length;for(const hr of ci){const Mr=hr*gt;if(be[Mr+2]<=X)continue;be[Mr+2]=X;const nn=be[Mr+pe];Xi+=be[Mr]*nn,Zi+=be[Mr+1]*nn,be[Mr+4]=ai,Ie&&(pi||(pi=this._map(be,et,!0),xr=this.clusterProps.length,this.clusterProps.push(pi)),Ie(pi,this._map(be,Mr)))}be[et+4]=ai,je.push(Xi/Mi,Zi/Mi,1/0,ai,-1,Mi),Ie&&je.push(xr)}else{for(let pi=0;pi<gt;pi++)je.push(be[et+pi]);if(Mi>1)for(const pi of ci){const Xi=pi*gt;if(!(be[Xi+2]<=X)){be[Xi+2]=X;for(let Zi=0;Zi<gt;Zi++)je.push(be[Xi+Zi])}}}}return je}_getOriginId(W){return W-this.points.length>>5}_getOriginZoom(W){return(W-this.points.length)%32}_map(W,X,J){if(W[X+pe]>1){const Pe=this.clusterProps[W[X+Re]];return J?Object.assign({},Pe):Pe}const ae=this.points[W[X+_e]].properties,Ie=this.options.map(ae);return J&&Ie===ae?Object.assign({},Ie):Ie}}function ee(se,W,X){return{type:"Feature",id:se[W+_e],properties:Ce(se,W,X),geometry:{type:"Point",coordinates:[(J=se[W],360*(J-.5)),Ue(se[W+1])]}};var J}function Ce(se,W,X){const J=se[W+pe],ae=J>=1e4?`${Math.round(J/1e3)}k`:J>=1e3?Math.round(J/100)/10+"k":J,Ie=se[W+Re],Pe=Ie===-1?{}:Object.assign({},X[Ie]);return Object.assign(Pe,{cluster:!0,cluster_id:se[W+_e],point_count:J,point_count_abbreviated:ae})}function Le(se){return se/360+.5}function Je(se){const W=Math.sin(se*Math.PI/180),X=.5-.25*Math.log((1+W)/(1-W))/Math.PI;return X<0?0:X>1?1:X}function Ue(se){const W=(180-360*se)*Math.PI/180;return 360*Math.atan(Math.exp(W))/Math.PI-90}function Ge(se,W,X,J){for(var ae,Ie=J,Pe=X-W>>1,De=X-W,be=se[W],je=se[W+1],gt=se[X],et=se[X+1],lt=W+3;lt<X;lt+=3){var Jt=dt(se[lt],se[lt+1],be,je,gt,et);if(Jt>Ie)ae=lt,Ie=Jt;else if(Jt===Ie){var ci=Math.abs(lt-Pe);ci<De&&(ae=lt,De=ci)}}Ie>J&&(ae-W>3&&Ge(se,W,ae,J),se[ae+2]=Ie,X-ae>3&&Ge(se,ae,X,J))}function dt(se,W,X,J,ae,Ie){var Pe=ae-X,De=Ie-J;if(Pe!==0||De!==0){var be=((se-X)*Pe+(W-J)*De)/(Pe*Pe+De*De);be>1?(X=ae,J=Ie):be>0&&(X+=Pe*be,J+=De*be)}return(Pe=se-X)*Pe+(De=W-J)*De}function At(se,W,X,J){var ae={id:se===void 0?null:se,type:W,geometry:X,tags:J,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(Ie){var Pe=Ie.geometry,De=Ie.type;if(De==="Point"||De==="MultiPoint"||De==="LineString")Ye(Ie,Pe);else if(De==="Polygon"||De==="MultiLineString")for(var be=0;be<Pe.length;be++)Ye(Ie,Pe[be]);else if(De==="MultiPolygon")for(be=0;be<Pe.length;be++)for(var je=0;je<Pe[be].length;je++)Ye(Ie,Pe[be][je])}(ae),ae}function Ye(se,W){for(var X=0;X<W.length;X+=3)se.minX=Math.min(se.minX,W[X]),se.minY=Math.min(se.minY,W[X+1]),se.maxX=Math.max(se.maxX,W[X]),se.maxY=Math.max(se.maxY,W[X+1])}function Oe(se,W,X,J){if(W.geometry){var ae=W.geometry.coordinates,Ie=W.geometry.type,Pe=Math.pow(X.tolerance/((1<<X.maxZoom)*X.extent),2),De=[],be=W.id;if(X.promoteId?be=W.properties[X.promoteId]:X.generateId&&(be=J||0),Ie==="Point")Qe(ae,De);else if(Ie==="MultiPoint")for(var je=0;je<ae.length;je++)Qe(ae[je],De);else if(Ie==="LineString")Xe(ae,De,Pe,!1);else if(Ie==="MultiLineString"){if(X.lineMetrics){for(je=0;je<ae.length;je++)Xe(ae[je],De=[],Pe,!1),se.push(At(be,"LineString",De,W.properties));return}le(ae,De,Pe,!1)}else if(Ie==="Polygon")le(ae,De,Pe,!0);else{if(Ie!=="MultiPolygon"){if(Ie==="GeometryCollection"){for(je=0;je<W.geometry.geometries.length;je++)Oe(se,{id:be,geometry:W.geometry.geometries[je],properties:W.properties},X,J);return}throw new Error("Input data is not a valid GeoJSON object.")}for(je=0;je<ae.length;je++){var gt=[];le(ae[je],gt,Pe,!0),De.push(gt)}}se.push(At(be,Ie,De,W.properties))}}function Qe(se,W){W.push(it(se[0])),W.push(bt(se[1])),W.push(0)}function Xe(se,W,X,J){for(var ae,Ie,Pe=0,De=0;De<se.length;De++){var be=it(se[De][0]),je=bt(se[De][1]);W.push(be),W.push(je),W.push(0),De>0&&(Pe+=J?(ae*je-be*Ie)/2:Math.sqrt(Math.pow(be-ae,2)+Math.pow(je-Ie,2))),ae=be,Ie=je}var gt=W.length-3;W[2]=1,Ge(W,0,gt,X),W[gt+2]=1,W.size=Math.abs(Pe),W.start=0,W.end=W.size}function le(se,W,X,J){for(var ae=0;ae<se.length;ae++){var Ie=[];Xe(se[ae],Ie,X,J),W.push(Ie)}}function it(se){return se/360+.5}function bt(se){var W=Math.sin(se*Math.PI/180),X=.5-.25*Math.log((1+W)/(1-W))/Math.PI;return X<0?0:X>1?1:X}function Pt(se,W,X,J,ae,Ie,Pe,De){if(J/=W,Ie>=(X/=W)&&Pe<J)return se;if(Pe<X||Ie>=J)return null;for(var be=[],je=0;je<se.length;je++){var gt=se[je],et=gt.geometry,lt=gt.type,Jt=ae===0?gt.minX:gt.minY,ci=ae===0?gt.maxX:gt.maxY;if(Jt>=X&&ci<J)be.push(gt);else if(!(ci<X||Jt>=J)){var si=[];if(lt==="Point"||lt==="MultiPoint")Ot(et,si,X,J,ae);else if(lt==="LineString")nt(et,si,X,J,ae,!1,De.lineMetrics);else if(lt==="MultiLineString")Yt(et,si,X,J,ae,!1);else if(lt==="Polygon")Yt(et,si,X,J,ae,!0);else if(lt==="MultiPolygon")for(var Mi=0;Mi<et.length;Mi++){var pi=[];Yt(et[Mi],pi,X,J,ae,!0),pi.length&&si.push(pi)}if(si.length){if(De.lineMetrics&&lt==="LineString"){for(Mi=0;Mi<si.length;Mi++)be.push(At(gt.id,lt,si[Mi],gt.tags));continue}lt!=="LineString"&&lt!=="MultiLineString"||(si.length===1?(lt="LineString",si=si[0]):lt="MultiLineString"),lt!=="Point"&&lt!=="MultiPoint"||(lt=si.length===3?"Point":"MultiPoint"),be.push(At(gt.id,lt,si,gt.tags))}}}return be.length?be:null}function Ot(se,W,X,J,ae){for(var Ie=0;Ie<se.length;Ie+=3){var Pe=se[Ie+ae];Pe>=X&&Pe<=J&&(W.push(se[Ie]),W.push(se[Ie+1]),W.push(se[Ie+2]))}}function nt(se,W,X,J,ae,Ie,Pe){for(var De,be,je=qt(se),gt=ae===0?xi:fi,et=se.start,lt=0;lt<se.length-3;lt+=3){var Jt=se[lt],ci=se[lt+1],si=se[lt+2],Mi=se[lt+3],pi=se[lt+4],Xi=ae===0?Jt:ci,Zi=ae===0?Mi:pi,xr=!1;Pe&&(De=Math.sqrt(Math.pow(Jt-Mi,2)+Math.pow(ci-pi,2))),Xi<X?Zi>X&&(be=gt(je,Jt,ci,Mi,pi,X),Pe&&(je.start=et+De*be)):Xi>J?Zi<J&&(be=gt(je,Jt,ci,Mi,pi,J),Pe&&(je.start=et+De*be)):gi(je,Jt,ci,si),Zi<X&&Xi>=X&&(be=gt(je,Jt,ci,Mi,pi,X),xr=!0),Zi>J&&Xi<=J&&(be=gt(je,Jt,ci,Mi,pi,J),xr=!0),!Ie&&xr&&(Pe&&(je.end=et+De*be),W.push(je),je=qt(se)),Pe&&(et+=De)}var ai=se.length-3;Jt=se[ai],ci=se[ai+1],si=se[ai+2],(Xi=ae===0?Jt:ci)>=X&&Xi<=J&&gi(je,Jt,ci,si),ai=je.length-3,Ie&&ai>=3&&(je[ai]!==je[0]||je[ai+1]!==je[1])&&gi(je,je[0],je[1],je[2]),je.length&&W.push(je)}function qt(se){var W=[];return W.size=se.size,W.start=se.start,W.end=se.end,W}function Yt(se,W,X,J,ae,Ie){for(var Pe=0;Pe<se.length;Pe++)nt(se[Pe],W,X,J,ae,Ie,!1)}function gi(se,W,X,J){se.push(W),se.push(X),se.push(J)}function xi(se,W,X,J,ae,Ie){var Pe=(Ie-W)/(J-W);return se.push(Ie),se.push(X+(ae-X)*Pe),se.push(1),Pe}function fi(se,W,X,J,ae,Ie){var Pe=(Ie-X)/(ae-X);return se.push(W+(J-W)*Pe),se.push(Ie),se.push(1),Pe}function Gi(se,W){for(var X=[],J=0;J<se.length;J++){var ae,Ie=se[J],Pe=Ie.type;if(Pe==="Point"||Pe==="MultiPoint"||Pe==="LineString")ae=ht(Ie.geometry,W);else if(Pe==="MultiLineString"||Pe==="Polygon"){ae=[];for(var De=0;De<Ie.geometry.length;De++)ae.push(ht(Ie.geometry[De],W))}else if(Pe==="MultiPolygon")for(ae=[],De=0;De<Ie.geometry.length;De++){for(var be=[],je=0;je<Ie.geometry[De].length;je++)be.push(ht(Ie.geometry[De][je],W));ae.push(be)}X.push(At(Ie.id,Pe,ae,Ie.tags))}return X}function ht(se,W){var X=[];X.size=se.size,se.start!==void 0&&(X.start=se.start,X.end=se.end);for(var J=0;J<se.length;J+=3)X.push(se[J]+W,se[J+1],se[J+2]);return X}function Hi(se,W){if(se.transformed)return se;var X,J,ae,Ie=1<<se.z,Pe=se.x,De=se.y;for(X=0;X<se.features.length;X++){var be=se.features[X],je=be.geometry,gt=be.type;if(be.geometry=[],gt===1)for(J=0;J<je.length;J+=2)be.geometry.push(Zt(je[J],je[J+1],W,Ie,Pe,De));else for(J=0;J<je.length;J++){var et=[];for(ae=0;ae<je[J].length;ae+=2)et.push(Zt(je[J][ae],je[J][ae+1],W,Ie,Pe,De));be.geometry.push(et)}}return se.transformed=!0,se}function Zt(se,W,X,J,ae,Ie){return[Math.round(X*(se*J-ae)),Math.round(X*(W*J-Ie))]}function bi(se,W,X,J,ae){for(var Ie=W===ae.maxZoom?0:ae.tolerance/((1<<W)*ae.extent),Pe={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:X,y:J,z:W,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},De=0;De<se.length;De++){Pe.numFeatures++,cr(Pe,se[De],Ie,ae);var be=se[De].minX,je=se[De].minY,gt=se[De].maxX,et=se[De].maxY;be<Pe.minX&&(Pe.minX=be),je<Pe.minY&&(Pe.minY=je),gt>Pe.maxX&&(Pe.maxX=gt),et>Pe.maxY&&(Pe.maxY=et)}return Pe}function cr(se,W,X,J){var ae=W.geometry,Ie=W.type,Pe=[];if(Ie==="Point"||Ie==="MultiPoint")for(var De=0;De<ae.length;De+=3)Pe.push(ae[De]),Pe.push(ae[De+1]),se.numPoints++,se.numSimplified++;else if(Ie==="LineString")xt(Pe,ae,se,X,!1,!1);else if(Ie==="MultiLineString"||Ie==="Polygon")for(De=0;De<ae.length;De++)xt(Pe,ae[De],se,X,Ie==="Polygon",De===0);else if(Ie==="MultiPolygon")for(var be=0;be<ae.length;be++){var je=ae[be];for(De=0;De<je.length;De++)xt(Pe,je[De],se,X,!0,De===0)}if(Pe.length){var gt=W.tags||null;if(Ie==="LineString"&&J.lineMetrics){for(var et in gt={},W.tags)gt[et]=W.tags[et];gt.mapbox_clip_start=ae.start/ae.size,gt.mapbox_clip_end=ae.end/ae.size}var lt={geometry:Pe,type:Ie==="Polygon"||Ie==="MultiPolygon"?3:Ie==="LineString"||Ie==="MultiLineString"?2:1,tags:gt};W.id!==null&&(lt.id=W.id),se.features.push(lt)}}function xt(se,W,X,J,ae,Ie){var Pe=J*J;if(J>0&&W.size<(ae?Pe:J))X.numPoints+=W.length/3;else{for(var De=[],be=0;be<W.length;be+=3)(J===0||W[be+2]>Pe)&&(X.numSimplified++,De.push(W[be]),De.push(W[be+1])),X.numPoints++;ae&&function(je,gt){for(var et=0,lt=0,Jt=je.length,ci=Jt-2;lt<Jt;ci=lt,lt+=2)et+=(je[lt]-je[ci])*(je[lt+1]+je[ci+1]);if(et>0===gt)for(lt=0,Jt=je.length;lt<Jt/2;lt+=2){var si=je[lt],Mi=je[lt+1];je[lt]=je[Jt-2-lt],je[lt+1]=je[Jt-1-lt],je[Jt-2-lt]=si,je[Jt-1-lt]=Mi}}(De,Ie),se.push(De)}}function li(se,W){var X=(W=this.options=function(ae,Ie){for(var Pe in Ie)ae[Pe]=Ie[Pe];return ae}(Object.create(this.options),W)).debug;if(X&&console.time("preprocess data"),W.maxZoom<0||W.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(W.promoteId&&W.generateId)throw new Error("promoteId and generateId cannot be used together.");var J=function(ae,Ie){var Pe=[];if(ae.type==="FeatureCollection")for(var De=0;De<ae.features.length;De++)Oe(Pe,ae.features[De],Ie,De);else Oe(Pe,ae.type==="Feature"?ae:{geometry:ae},Ie);return Pe}(se,W);this.tiles={},this.tileCoords=[],X&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",W.indexMaxZoom,W.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),J=function(ae,Ie){var Pe=Ie.buffer/Ie.extent,De=ae,be=Pt(ae,1,-1-Pe,Pe,0,-1,2,Ie),je=Pt(ae,1,1-Pe,2+Pe,0,-1,2,Ie);return(be||je)&&(De=Pt(ae,1,-Pe,1+Pe,0,-1,2,Ie)||[],be&&(De=Gi(be,1).concat(De)),je&&(De=De.concat(Gi(je,-1)))),De}(J,W),J.length&&this.splitTile(J,0,0,0),X&&(J.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function Kt(se,W,X){return 32*((1<<se)*X+W)+se}function Tr(se,W){return W?se.properties[W]:se.id}function Lr(se,W){if(se==null)return!0;if(se.type==="Feature")return Tr(se,W)!=null;if(se.type==="FeatureCollection"){const X=new Set;for(const J of se.features){const ae=Tr(J,W);if(ae==null||X.has(ae))return!1;X.add(ae)}return!0}return!1}function ui(se,W){const X=new Map;if(se!=null)if(se.type==="Feature")X.set(Tr(se,W),se);else for(const J of se.features)X.set(Tr(J,W),J);return X}li.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},li.prototype.splitTile=function(se,W,X,J,ae,Ie,Pe){for(var De=[se,W,X,J],be=this.options,je=be.debug;De.length;){J=De.pop(),X=De.pop(),W=De.pop(),se=De.pop();var gt=1<<W,et=Kt(W,X,J),lt=this.tiles[et];if(!lt&&(je>1&&console.time("creation"),lt=this.tiles[et]=bi(se,W,X,J,be),this.tileCoords.push({z:W,x:X,y:J}),je)){je>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",W,X,J,lt.numFeatures,lt.numPoints,lt.numSimplified),console.timeEnd("creation"));var Jt="z"+W;this.stats[Jt]=(this.stats[Jt]||0)+1,this.total++}if(lt.source=se,ae){if(W===be.maxZoom||W===ae)continue;var ci=1<<ae-W;if(X!==Math.floor(Ie/ci)||J!==Math.floor(Pe/ci))continue}else if(W===be.indexMaxZoom||lt.numPoints<=be.indexMaxPoints)continue;if(lt.source=null,se.length!==0){je>1&&console.time("clipping");var si,Mi,pi,Xi,Zi,xr,ai=.5*be.buffer/be.extent,hr=.5-ai,Mr=.5+ai,nn=1+ai;si=Mi=pi=Xi=null,Zi=Pt(se,gt,X-ai,X+Mr,0,lt.minX,lt.maxX,be),xr=Pt(se,gt,X+hr,X+nn,0,lt.minX,lt.maxX,be),se=null,Zi&&(si=Pt(Zi,gt,J-ai,J+Mr,1,lt.minY,lt.maxY,be),Mi=Pt(Zi,gt,J+hr,J+nn,1,lt.minY,lt.maxY,be),Zi=null),xr&&(pi=Pt(xr,gt,J-ai,J+Mr,1,lt.minY,lt.maxY,be),Xi=Pt(xr,gt,J+hr,J+nn,1,lt.minY,lt.maxY,be),xr=null),je>1&&console.timeEnd("clipping"),De.push(si||[],W+1,2*X,2*J),De.push(Mi||[],W+1,2*X,2*J+1),De.push(pi||[],W+1,2*X+1,2*J),De.push(Xi||[],W+1,2*X+1,2*J+1)}}},li.prototype.getTile=function(se,W,X){var J=this.options,ae=J.extent,Ie=J.debug;if(se<0||se>24)return null;var Pe=1<<se,De=Kt(se,W=(W%Pe+Pe)%Pe,X);if(this.tiles[De])return Hi(this.tiles[De],ae);Ie>1&&console.log("drilling down to z%d-%d-%d",se,W,X);for(var be,je=se,gt=W,et=X;!be&&je>0;)je--,gt=Math.floor(gt/2),et=Math.floor(et/2),be=this.tiles[Kt(je,gt,et)];return be&&be.source?(Ie>1&&console.log("found parent tile z%d-%d-%d",je,gt,et),Ie>1&&console.time("drilling down"),this.splitTile(be.source,je,gt,et,se,W,X),Ie>1&&console.timeEnd("drilling down"),this.tiles[De]?Hi(this.tiles[De],ae):null):null};class wn extends o{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(W,X){return V._(this,void 0,void 0,function*(){const J=W.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const ae=this._geoJSONIndex.getTile(J.z,J.x,J.y);if(!ae)return null;const Ie=new class{constructor(De){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=V.W,this.length=De.length,this._features=De}feature(De){return new class{constructor(be){this._feature=be,this.extent=V.W,this.type=be.type,this.properties=be.tags,"id"in be&&!isNaN(be.id)&&(this.id=parseInt(be.id,10))}loadGeometry(){if(this._feature.type===1){const be=[];for(const je of this._feature.geometry)be.push([new V.P(je[0],je[1])]);return be}{const be=[];for(const je of this._feature.geometry){const gt=[];for(const et of je)gt.push(new V.P(et[0],et[1]));be.push(gt)}return be}}toGeoJSON(be,je,gt){return u.call(this,be,je,gt)}}(this._features[De])}}(ae.features);let Pe=ct(Ie);return Pe.byteOffset===0&&Pe.byteLength===Pe.buffer.byteLength||(Pe=new Uint8Array(Pe)),{vectorTile:Ie,rawData:Pe.buffer}})}loadData(W){return V._(this,void 0,void 0,function*(){var X;(X=this._pendingRequest)===null||X===void 0||X.abort();const J=!!(W&&W.request&&W.request.collectResourceTiming)&&new V.bs(W.request);this._pendingRequest=new AbortController;try{let ae=yield this.loadGeoJSON(W,this._pendingRequest);if(delete this._pendingRequest,typeof ae!="object")throw new Error(`Input data given to '${W.source}' is not a valid GeoJSON object.`);if(_(ae,!0),W.filter){const Pe=V.by(W.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Pe.result==="error")throw new Error(Pe.value.map(be=>`${be.key}: ${be.message}`).join(", "));ae={type:"FeatureCollection",features:ae.features.filter(be=>Pe.value.evaluate({zoom:0},be))}}this._geoJSONIndex=W.cluster?new fe(function({superclusterOptions:Pe,clusterProperties:De}){if(!De||!Pe)return Pe;const be={},je={},gt={accumulated:null,zoom:0},et={properties:null},lt=Object.keys(De);for(const Jt of lt){const[ci,si]=De[Jt],Mi=V.by(si),pi=V.by(typeof ci=="string"?[ci,["accumulated"],["get",Jt]]:ci);be[Jt]=Mi.value,je[Jt]=pi.value}return Pe.map=Jt=>{et.properties=Jt;const ci={};for(const si of lt)ci[si]=be[si].evaluate(gt,et);return ci},Pe.reduce=(Jt,ci)=>{et.properties=ci;for(const si of lt)gt.accumulated=Jt[si],Jt[si]=je[si].evaluate(gt,et)},Pe}(W)).load(ae.features):function(Pe,De){return new li(Pe,De)}(ae,W.geojsonVtOptions),this.loaded={};const Ie={};if(J){const Pe=J.finish();Pe&&(Ie.resourceTiming={},Ie.resourceTiming[W.source]=JSON.parse(JSON.stringify(Pe)))}return Ie}catch(ae){if(delete this._pendingRequest,V.bz(ae))return{abandoned:!0};throw ae}})}reloadTile(W){const X=this.loaded;return X&&X[W.uid]?super.reloadTile(W):this.loadTile(W)}loadGeoJSON(W,X){return V._(this,void 0,void 0,function*(){const{promoteId:J}=W;if(W.request){const ae=yield V.h(W.request,X);return this._dataUpdateable=Lr(ae.data,J)?ui(ae.data,J):void 0,ae.data}if(typeof W.data=="string")try{const ae=JSON.parse(W.data);return this._dataUpdateable=Lr(ae,J)?ui(ae,J):void 0,ae}catch{throw new Error(`Input data given to '${W.source}' is not a valid GeoJSON object.`)}if(!W.dataDiff)throw new Error(`Input data given to '${W.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${W.source}`);return function(ae,Ie,Pe){var De,be,je,gt;if(Ie.removeAll&&ae.clear(),Ie.remove)for(const et of Ie.remove)ae.delete(et);if(Ie.add)for(const et of Ie.add){const lt=Tr(et,Pe);lt!=null&&ae.set(lt,et)}if(Ie.update)for(const et of Ie.update){let lt=ae.get(et.id);if(lt==null)continue;const Jt=!et.removeAllProperties&&(((De=et.removeProperties)===null||De===void 0?void 0:De.length)>0||((be=et.addOrUpdateProperties)===null||be===void 0?void 0:be.length)>0);if((et.newGeometry||et.removeAllProperties||Jt)&&(lt=Object.assign({},lt),ae.set(et.id,lt),Jt&&(lt.properties=Object.assign({},lt.properties))),et.newGeometry&&(lt.geometry=et.newGeometry),et.removeAllProperties)lt.properties={};else if(((je=et.removeProperties)===null||je===void 0?void 0:je.length)>0)for(const ci of et.removeProperties)Object.prototype.hasOwnProperty.call(lt.properties,ci)&&delete lt.properties[ci];if(((gt=et.addOrUpdateProperties)===null||gt===void 0?void 0:gt.length)>0)for(const{key:ci,value:si}of et.addOrUpdateProperties)lt.properties[ci]=si}}(this._dataUpdateable,W.dataDiff,J),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}})}removeSource(W){return V._(this,void 0,void 0,function*(){this._pendingRequest&&this._pendingRequest.abort()})}getClusterExpansionZoom(W){return this._geoJSONIndex.getClusterExpansionZoom(W.clusterId)}getClusterChildren(W){return this._geoJSONIndex.getChildren(W.clusterId)}getClusterLeaves(W){return this._geoJSONIndex.getLeaves(W.clusterId,W.limit,W.offset)}}class $r{constructor(W){this.self=W,this.actor=new V.C(W),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(X,J)=>{if(this.externalWorkerSourceTypes[X])throw new Error(`Worker source with name "${X}" already registered.`);this.externalWorkerSourceTypes[X]=J},this.self.addProtocol=V.bf,this.self.removeProtocol=V.bg,this.self.registerRTLTextPlugin=X=>{if(V.bA.isParsed())throw new Error("RTL text plugin already registered.");V.bA.setMethods(X)},this.actor.registerMessageHandler("loadDEMTile",(X,J)=>this._getDEMWorkerSource(X,J.source).loadTile(J)),this.actor.registerMessageHandler("removeDEMTile",(X,J)=>V._(this,void 0,void 0,function*(){this._getDEMWorkerSource(X,J.source).removeTile(J)})),this.actor.registerMessageHandler("getClusterExpansionZoom",(X,J)=>V._(this,void 0,void 0,function*(){return this._getWorkerSource(X,J.type,J.source).getClusterExpansionZoom(J)})),this.actor.registerMessageHandler("getClusterChildren",(X,J)=>V._(this,void 0,void 0,function*(){return this._getWorkerSource(X,J.type,J.source).getClusterChildren(J)})),this.actor.registerMessageHandler("getClusterLeaves",(X,J)=>V._(this,void 0,void 0,function*(){return this._getWorkerSource(X,J.type,J.source).getClusterLeaves(J)})),this.actor.registerMessageHandler("loadData",(X,J)=>this._getWorkerSource(X,J.type,J.source).loadData(J)),this.actor.registerMessageHandler("loadTile",(X,J)=>this._getWorkerSource(X,J.type,J.source).loadTile(J)),this.actor.registerMessageHandler("reloadTile",(X,J)=>this._getWorkerSource(X,J.type,J.source).reloadTile(J)),this.actor.registerMessageHandler("abortTile",(X,J)=>this._getWorkerSource(X,J.type,J.source).abortTile(J)),this.actor.registerMessageHandler("removeTile",(X,J)=>this._getWorkerSource(X,J.type,J.source).removeTile(J)),this.actor.registerMessageHandler("removeSource",(X,J)=>V._(this,void 0,void 0,function*(){if(!this.workerSources[X]||!this.workerSources[X][J.type]||!this.workerSources[X][J.type][J.source])return;const ae=this.workerSources[X][J.type][J.source];delete this.workerSources[X][J.type][J.source],ae.removeSource!==void 0&&ae.removeSource(J)})),this.actor.registerMessageHandler("removeMap",X=>V._(this,void 0,void 0,function*(){delete this.layerIndexes[X],delete this.availableImages[X],delete this.workerSources[X],delete this.demWorkerSources[X]})),this.actor.registerMessageHandler("setReferrer",(X,J)=>V._(this,void 0,void 0,function*(){this.referrer=J})),this.actor.registerMessageHandler("syncRTLPluginState",(X,J)=>this._syncRTLPluginState(X,J)),this.actor.registerMessageHandler("importScript",(X,J)=>V._(this,void 0,void 0,function*(){this.self.importScripts(J)})),this.actor.registerMessageHandler("setImages",(X,J)=>this._setImages(X,J)),this.actor.registerMessageHandler("updateLayers",(X,J)=>V._(this,void 0,void 0,function*(){this._getLayerIndex(X).update(J.layers,J.removedIds)})),this.actor.registerMessageHandler("setLayers",(X,J)=>V._(this,void 0,void 0,function*(){this._getLayerIndex(X).replace(J)}))}_setImages(W,X){return V._(this,void 0,void 0,function*(){this.availableImages[W]=X;for(const J in this.workerSources[W]){const ae=this.workerSources[W][J];for(const Ie in ae)ae[Ie].availableImages=X}})}_syncRTLPluginState(W,X){return V._(this,void 0,void 0,function*(){if(V.bA.isParsed())return V.bA.getState();if(X.pluginStatus!=="loading")return V.bA.setState(X),X;const J=X.pluginURL;if(this.self.importScripts(J),V.bA.isParsed()){const ae={pluginStatus:"loaded",pluginURL:J};return V.bA.setState(ae),ae}throw V.bA.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${J}`)})}_getAvailableImages(W){let X=this.availableImages[W];return X||(X=[]),X}_getLayerIndex(W){let X=this.layerIndexes[W];return X||(X=this.layerIndexes[W]=new s),X}_getWorkerSource(W,X,J){if(this.workerSources[W]||(this.workerSources[W]={}),this.workerSources[W][X]||(this.workerSources[W][X]={}),!this.workerSources[W][X][J]){const ae={sendAsync:(Ie,Pe)=>(Ie.targetMapId=W,this.actor.sendAsync(Ie,Pe))};switch(X){case"vector":this.workerSources[W][X][J]=new o(ae,this._getLayerIndex(W),this._getAvailableImages(W));break;case"geojson":this.workerSources[W][X][J]=new wn(ae,this._getLayerIndex(W),this._getAvailableImages(W));break;default:this.workerSources[W][X][J]=new this.externalWorkerSourceTypes[X](ae,this._getLayerIndex(W),this._getAvailableImages(W))}}return this.workerSources[W][X][J]}_getDEMWorkerSource(W,X){return this.demWorkerSources[W]||(this.demWorkerSources[W]={}),this.demWorkerSources[W][X]||(this.demWorkerSources[W][X]=new c),this.demWorkerSources[W][X]}}return V.i(self)&&(self.worker=new $r(self)),$r}),Ne("index",["exports","./shared"],function(V,s){var m="4.1.2";let b,x;const o={now:typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frameAsync:g=>new Promise((t,n)=>{const l=requestAnimationFrame(t);g.signal.addEventListener("abort",()=>{cancelAnimationFrame(l),n(s.c())})}),getImageData(g,t=0){return this.getImageCanvasContext(g).getImageData(-t,-t,g.width+2*t,g.height+2*t)},getImageCanvasContext(g){const t=window.document.createElement("canvas"),n=t.getContext("2d",{willReadFrequently:!0});if(!n)throw new Error("failed to create canvas 2d context");return t.width=g.width,t.height=g.height,n.drawImage(g,0,0,g.width,g.height),n},resolveURL:g=>(b||(b=document.createElement("a")),b.href=g,b.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(x==null&&(x=matchMedia("(prefers-reduced-motion: reduce)")),x.matches)}};class c{static testProp(t){if(!c.docStyle)return t[0];for(let n=0;n<t.length;n++)if(t[n]in c.docStyle)return t[n];return t[0]}static create(t,n,l){const d=window.document.createElement(t);return n!==void 0&&(d.className=n),l&&l.appendChild(d),d}static createNS(t,n){return window.document.createElementNS(t,n)}static disableDrag(){c.docStyle&&c.selectProp&&(c.userSelect=c.docStyle[c.selectProp],c.docStyle[c.selectProp]="none")}static enableDrag(){c.docStyle&&c.selectProp&&(c.docStyle[c.selectProp]=c.userSelect)}static setTransform(t,n){t.style[c.transformProp]=n}static addEventListener(t,n,l,d={}){t.addEventListener(n,l,"passive"in d?d:d.capture)}static removeEventListener(t,n,l,d={}){t.removeEventListener(n,l,"passive"in d?d:d.capture)}static suppressClickInternal(t){t.preventDefault(),t.stopPropagation(),window.removeEventListener("click",c.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",c.suppressClickInternal,!0),window.setTimeout(()=>{window.removeEventListener("click",c.suppressClickInternal,!0)},0)}static getScale(t){const n=t.getBoundingClientRect();return{x:n.width/t.offsetWidth||1,y:n.height/t.offsetHeight||1,boundingClientRect:n}}static getPoint(t,n,l){const d=n.boundingClientRect;return new s.P((l.clientX-d.left)/n.x-t.clientLeft,(l.clientY-d.top)/n.y-t.clientTop)}static mousePos(t,n){const l=c.getScale(t);return c.getPoint(t,l,n)}static touchPos(t,n){const l=[],d=c.getScale(t);for(let y=0;y<n.length;y++)l.push(c.getPoint(t,d,n[y]));return l}static mouseButton(t){return t.button}static remove(t){t.parentNode&&t.parentNode.removeChild(t)}}c.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,c.selectProp=c.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),c.transformProp=c.testProp(["transform","WebkitTransform"]);const h={supported:!1,testSupport:function(g){!u&&_&&(C?S(g):p=g)}};let p,_,u=!1,C=!1;function S(g){const t=g.createTexture();g.bindTexture(g.TEXTURE_2D,t);try{if(g.texImage2D(g.TEXTURE_2D,0,g.RGBA,g.RGBA,g.UNSIGNED_BYTE,_),g.isContextLost())return;h.supported=!0}catch{}g.deleteTexture(t),u=!0}var D,L;typeof document<"u"&&(_=document.createElement("img"),_.onload=function(){p&&S(p),p=null,C=!0},_.onerror=function(){u=!0,p=null},_.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(g){let t,n,l,d;g.resetRequestQueue=()=>{t=[],n=0,l=0,d={}},g.addThrottleControl=O=>{const R=l++;return d[R]=O,R},g.removeThrottleControl=O=>{delete d[O],P()},g.getImage=(O,R,N=!0)=>new Promise((G,Z)=>{h.supported&&(O.headers||(O.headers={}),O.headers.accept="image/webp,*/*"),s.e(O,{type:"image"}),t.push({abortController:R,requestParameters:O,supportImageRefresh:N,state:"queued",onError:ce=>{Z(ce)},onSuccess:ce=>{G(ce)}}),P()});const y=O=>s._(this,void 0,void 0,function*(){O.state="running";const{requestParameters:R,supportImageRefresh:N,onError:G,onSuccess:Z,abortController:ce}=O,oe=N===!1&&!s.i(self)&&!s.g(R.url)&&(!R.headers||Object.keys(R.headers).reduce((Se,We)=>Se&&We==="accept",!0));n++;const ue=oe?A(R,ce):s.m(R,ce);try{const Se=yield ue;delete O.abortController,O.state="completed",Se.data instanceof HTMLImageElement||s.b(Se.data)?Z(Se):Se.data&&Z({data:yield(te=Se.data,typeof createImageBitmap=="function"?s.d(te):s.f(te)),cacheControl:Se.cacheControl,expires:Se.expires})}catch(Se){delete O.abortController,G(Se)}finally{n--,P()}var te}),P=()=>{const O=(()=>{for(const R of Object.keys(d))if(d[R]())return!0;return!1})()?s.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:s.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let R=n;R<O&&t.length>0;R++){const N=t.shift();N.abortController.signal.aborted?R--:y(N)}},A=(O,R)=>new Promise((N,G)=>{const Z=new Image,ce=O.url,oe=O.credentials;oe&&oe==="include"?Z.crossOrigin="use-credentials":(oe&&oe==="same-origin"||!s.s(ce))&&(Z.crossOrigin="anonymous"),R.signal.addEventListener("abort",()=>{Z.src="",G(s.c())}),Z.fetchPriority="high",Z.onload=()=>{Z.onerror=Z.onload=null,N({data:Z})},Z.onerror=()=>{Z.onerror=Z.onload=null,R.signal.aborted||G(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},Z.src=ce})}(D||(D={})),D.resetRequestQueue(),function(g){g.Glyphs="Glyphs",g.Image="Image",g.Source="Source",g.SpriteImage="SpriteImage",g.SpriteJSON="SpriteJSON",g.Style="Style",g.Tile="Tile",g.Unknown="Unknown"}(L||(L={}));class U{constructor(t){this._transformRequestFn=t}transformRequest(t,n){return this._transformRequestFn&&this._transformRequestFn(t,n)||{url:t}}normalizeSpriteURL(t,n,l){const d=function(y){const P=y.match($);if(!P)throw new Error(`Unable to parse URL "${y}"`);return{protocol:P[1],authority:P[2],path:P[3]||"/",params:P[4]?P[4].split("&"):[]}}(t);return d.path+=`${n}${l}`,function(y){const P=y.params.length?`?${y.params.join("&")}`:"";return`${y.protocol}://${y.authority}${y.path}${P}`}(d)}setTransformRequest(t){this._transformRequestFn=t}}const $=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function ne(g){var t=new s.A(3);return t[0]=g[0],t[1]=g[1],t[2]=g[2],t}var ye,Ve=function(g,t,n){return g[0]=t[0]-n[0],g[1]=t[1]-n[1],g[2]=t[2]-n[2],g};ye=new s.A(3),s.A!=Float32Array&&(ye[0]=0,ye[1]=0,ye[2]=0);var Ke=function(g){var t=g[0],n=g[1];return t*t+n*n};function at(g){const t=[];if(typeof g=="string")t.push({id:"default",url:g});else if(g&&g.length>0){const n=[];for(const{id:l,url:d}of g){const y=`${l}${d}`;n.indexOf(y)===-1&&(n.push(y),t.push({id:l,url:d}))}}return t}(function(){var g=new s.A(2);s.A!=Float32Array&&(g[0]=0,g[1]=0)})();class $e{constructor(t,n,l,d){this.context=t,this.format=l,this.texture=t.gl.createTexture(),this.update(n,d)}update(t,n,l){const{width:d,height:y}=t,P=!(this.size&&this.size[0]===d&&this.size[1]===y||l),{context:A}=this,{gl:O}=A;if(this.useMipmap=!!(n&&n.useMipmap),O.bindTexture(O.TEXTURE_2D,this.texture),A.pixelStoreUnpackFlipY.set(!1),A.pixelStoreUnpack.set(1),A.pixelStoreUnpackPremultiplyAlpha.set(this.format===O.RGBA&&(!n||n.premultiply!==!1)),P)this.size=[d,y],t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||s.b(t)?O.texImage2D(O.TEXTURE_2D,0,this.format,this.format,O.UNSIGNED_BYTE,t):O.texImage2D(O.TEXTURE_2D,0,this.format,d,y,0,this.format,O.UNSIGNED_BYTE,t.data);else{const{x:R,y:N}=l||{x:0,y:0};t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||s.b(t)?O.texSubImage2D(O.TEXTURE_2D,0,R,N,O.RGBA,O.UNSIGNED_BYTE,t):O.texSubImage2D(O.TEXTURE_2D,0,R,N,d,y,O.RGBA,O.UNSIGNED_BYTE,t.data)}this.useMipmap&&this.isSizePowerOfTwo()&&O.generateMipmap(O.TEXTURE_2D)}bind(t,n,l){const{context:d}=this,{gl:y}=d;y.bindTexture(y.TEXTURE_2D,this.texture),l!==y.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(l=y.LINEAR),t!==this.filter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,t),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,l||t),this.filter=t),n!==this.wrap&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,n),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,n),this.wrap=n)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}function ut(g){const{userImage:t}=g;return!!(t&&t.render&&t.render())&&(g.data.replace(new Uint8Array(t.data.buffer)),!0)}class ot extends s.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new s.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(t){if(this.loaded!==t&&(this.loaded=t,t)){for(const{ids:n,promiseResolve:l}of this.requestors)l(this._getImagesForIds(n));this.requestors=[]}}getImage(t){const n=this.images[t];if(n&&!n.data&&n.spriteData){const l=n.spriteData;n.data=new s.R({width:l.width,height:l.height},l.context.getImageData(l.x,l.y,l.width,l.height).data),n.spriteData=null}return n}addImage(t,n){if(this.images[t])throw new Error(`Image id ${t} already exist, use updateImage instead`);this._validate(t,n)&&(this.images[t]=n)}_validate(t,n){let l=!0;const d=n.data||n.spriteData;return this._validateStretch(n.stretchX,d&&d.width)||(this.fire(new s.j(new Error(`Image "${t}" has invalid "stretchX" value`))),l=!1),this._validateStretch(n.stretchY,d&&d.height)||(this.fire(new s.j(new Error(`Image "${t}" has invalid "stretchY" value`))),l=!1),this._validateContent(n.content,n)||(this.fire(new s.j(new Error(`Image "${t}" has invalid "content" value`))),l=!1),l}_validateStretch(t,n){if(!t)return!0;let l=0;for(const d of t){if(d[0]<l||d[1]<d[0]||n<d[1])return!1;l=d[1]}return!0}_validateContent(t,n){if(!t)return!0;if(t.length!==4)return!1;const l=n.spriteData,d=l&&l.width||n.data.width,y=l&&l.height||n.data.height;return!(t[0]<0||d<t[0]||t[1]<0||y<t[1]||t[2]<0||d<t[2]||t[3]<0||y<t[3]||t[2]<t[0]||t[3]<t[1])}updateImage(t,n,l=!0){const d=this.getImage(t);if(l&&(d.data.width!==n.data.width||d.data.height!==n.data.height))throw new Error(`size mismatch between old image (${d.data.width}x${d.data.height}) and new image (${n.data.width}x${n.data.height}).`);n.version=d.version+1,this.images[t]=n,this.updatedImages[t]=!0}removeImage(t){const n=this.images[t];delete this.images[t],delete this.patterns[t],n.userImage&&n.userImage.onRemove&&n.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(t){return new Promise((n,l)=>{let d=!0;if(!this.isLoaded())for(const y of t)this.images[y]||(d=!1);this.isLoaded()||d?n(this._getImagesForIds(t)):this.requestors.push({ids:t,promiseResolve:n})})}_getImagesForIds(t){const n={};for(const l of t){let d=this.getImage(l);d||(this.fire(new s.k("styleimagemissing",{id:l})),d=this.getImage(l)),d?n[l]={data:d.data.clone(),pixelRatio:d.pixelRatio,sdf:d.sdf,version:d.version,stretchX:d.stretchX,stretchY:d.stretchY,content:d.content,hasRenderCallback:!!(d.userImage&&d.userImage.render)}:s.w(`Image "${l}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return n}getPixelSize(){const{width:t,height:n}=this.atlasImage;return{width:t,height:n}}getPattern(t){const n=this.patterns[t],l=this.getImage(t);if(!l)return null;if(n&&n.position.version===l.version)return n.position;if(n)n.position.version=l.version;else{const d={w:l.data.width+2,h:l.data.height+2,x:0,y:0},y=new s.I(d,l);this.patterns[t]={bin:d,position:y}}return this._updatePatternAtlas(),this.patterns[t].position}bind(t){const n=t.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new $e(t,this.atlasImage,n.RGBA),this.atlasTexture.bind(n.LINEAR,n.CLAMP_TO_EDGE)}_updatePatternAtlas(){const t=[];for(const y in this.patterns)t.push(this.patterns[y].bin);const{w:n,h:l}=s.p(t),d=this.atlasImage;d.resize({width:n||1,height:l||1});for(const y in this.patterns){const{bin:P}=this.patterns[y],A=P.x+1,O=P.y+1,R=this.getImage(y).data,N=R.width,G=R.height;s.R.copy(R,d,{x:0,y:0},{x:A,y:O},{width:N,height:G}),s.R.copy(R,d,{x:0,y:G-1},{x:A,y:O-1},{width:N,height:1}),s.R.copy(R,d,{x:0,y:0},{x:A,y:O+G},{width:N,height:1}),s.R.copy(R,d,{x:N-1,y:0},{x:A-1,y:O},{width:1,height:G}),s.R.copy(R,d,{x:0,y:0},{x:A+N,y:O},{width:1,height:G})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(t){for(const n of t){if(this.callbackDispatchedThisFrame[n])continue;this.callbackDispatchedThisFrame[n]=!0;const l=this.getImage(n);l||s.w(`Image with ID: "${n}" was not found`),ut(l)&&this.updateImage(n,l)}}}const vt=1e20;function St(g,t,n,l,d,y,P,A,O){for(let R=t;R<t+l;R++)ct(g,n*y+R,y,d,P,A,O);for(let R=n;R<n+d;R++)ct(g,R*y+t,1,l,P,A,O)}function ct(g,t,n,l,d,y,P){y[0]=0,P[0]=-vt,P[1]=vt,d[0]=g[t];for(let A=1,O=0,R=0;A<l;A++){d[A]=g[t+A*n];const N=A*A;do{const G=y[O];R=(d[A]-d[G]+N-G*G)/(A-G)/2}while(R<=P[O]&&--O>-1);O++,y[O]=A,P[O]=R,P[O+1]=vt}for(let A=0,O=0;A<l;A++){for(;P[O+1]<A;)O++;const R=y[O],N=A-R;g[t+A*n]=d[R]+N*N}}class Et{constructor(t,n){this.requestManager=t,this.localIdeographFontFamily=n,this.entries={}}setURL(t){this.url=t}getGlyphs(t){return s._(this,void 0,void 0,function*(){const n=[];for(const y in t)for(const P of t[y])n.push(this._getAndCacheGlyphsPromise(y,P));const l=yield Promise.all(n),d={};for(const{stack:y,id:P,glyph:A}of l)d[y]||(d[y]={}),d[y][P]=A&&{id:A.id,bitmap:A.bitmap.clone(),metrics:A.metrics};return d})}_getAndCacheGlyphsPromise(t,n){return s._(this,void 0,void 0,function*(){let l=this.entries[t];l||(l=this.entries[t]={glyphs:{},requests:{},ranges:{}});let d=l.glyphs[n];if(d!==void 0)return{stack:t,id:n,glyph:d};if(d=this._tinySDF(l,t,n),d)return l.glyphs[n]=d,{stack:t,id:n,glyph:d};const y=Math.floor(n/256);if(256*y>65535)throw new Error("glyphs > 65535 not supported");if(l.ranges[y])return{stack:t,id:n,glyph:d};if(!this.url)throw new Error("glyphsUrl is not set");if(!l.requests[y]){const A=Et.loadGlyphRange(t,y,this.url,this.requestManager);l.requests[y]=A}const P=yield l.requests[y];for(const A in P)this._doesCharSupportLocalGlyph(+A)||(l.glyphs[+A]=P[+A]);return l.ranges[y]=!0,{stack:t,id:n,glyph:P[n]||null}})}_doesCharSupportLocalGlyph(t){return!!this.localIdeographFontFamily&&(s.u["CJK Unified Ideographs"](t)||s.u["Hangul Syllables"](t)||s.u.Hiragana(t)||s.u.Katakana(t))}_tinySDF(t,n,l){const d=this.localIdeographFontFamily;if(!d||!this._doesCharSupportLocalGlyph(l))return;let y=t.tinySDF;if(!y){let A="400";/bold/i.test(n)?A="900":/medium/i.test(n)?A="500":/light/i.test(n)&&(A="200"),y=t.tinySDF=new Et.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:d,fontWeight:A})}const P=y.draw(String.fromCharCode(l));return{id:l,bitmap:new s.o({width:P.width||60,height:P.height||60},P.data),metrics:{width:P.glyphWidth/2||24,height:P.glyphHeight/2||24,left:P.glyphLeft/2+.5||0,top:P.glyphTop/2-27.5||-8,advance:P.glyphAdvance/2||24,isDoubleResolution:!0}}}}Et.loadGlyphRange=function(g,t,n,l){return s._(this,void 0,void 0,function*(){const d=256*t,y=d+255,P=l.transformRequest(n.replace("{fontstack}",g).replace("{range}",`${d}-${y}`),L.Glyphs),A=yield s.l(P,new AbortController);if(!A||!A.data)throw new Error(`Could not load glyph range. range: ${t}, ${d}-${y}`);const O={};for(const R of s.n(A.data))O[R.id]=R;return O})},Et.TinySDF=class{constructor({fontSize:g=24,buffer:t=3,radius:n=8,cutoff:l=.25,fontFamily:d="sans-serif",fontWeight:y="normal",fontStyle:P="normal"}={}){this.buffer=t,this.cutoff=l,this.radius=n;const A=this.size=g+4*t,O=this._createCanvas(A),R=this.ctx=O.getContext("2d",{willReadFrequently:!0});R.font=`${P} ${y} ${g}px ${d}`,R.textBaseline="alphabetic",R.textAlign="left",R.fillStyle="black",this.gridOuter=new Float64Array(A*A),this.gridInner=new Float64Array(A*A),this.f=new Float64Array(A),this.z=new Float64Array(A+1),this.v=new Uint16Array(A)}_createCanvas(g){const t=document.createElement("canvas");return t.width=t.height=g,t}draw(g){const{width:t,actualBoundingBoxAscent:n,actualBoundingBoxDescent:l,actualBoundingBoxLeft:d,actualBoundingBoxRight:y}=this.ctx.measureText(g),P=Math.ceil(n),A=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(y-d))),O=Math.min(this.size-this.buffer,P+Math.ceil(l)),R=A+2*this.buffer,N=O+2*this.buffer,G=Math.max(R*N,0),Z=new Uint8ClampedArray(G),ce={data:Z,width:R,height:N,glyphWidth:A,glyphHeight:O,glyphTop:P,glyphLeft:0,glyphAdvance:t};if(A===0||O===0)return ce;const{ctx:oe,buffer:ue,gridInner:te,gridOuter:Se}=this;oe.clearRect(ue,ue,A,O),oe.fillText(g,ue,ue+P);const We=oe.getImageData(ue,ue,A,O);Se.fill(vt,0,G),te.fill(0,0,G);for(let ge=0;ge<O;ge++)for(let ke=0;ke<A;ke++){const He=We.data[4*(ge*A+ke)+3]/255;if(He===0)continue;const qe=(ge+ue)*R+ke+ue;if(He===1)Se[qe]=0,te[qe]=vt;else{const rt=.5-He;Se[qe]=rt>0?rt*rt:0,te[qe]=rt<0?rt*rt:0}}St(Se,0,0,R,N,R,this.f,this.v,this.z),St(te,ue,ue,A,O,R,this.f,this.v,this.z);for(let ge=0;ge<G;ge++){const ke=Math.sqrt(Se[ge])-Math.sqrt(te[ge]);Z[ge]=Math.round(255-255*(ke/this.radius+this.cutoff))}return ce}};class Q{constructor(){this.specification=s.v.light.position}possiblyEvaluate(t,n){return s.y(t.expression.evaluate(n))}interpolate(t,n,l){return{x:s.z.number(t.x,n.x,l),y:s.z.number(t.y,n.y,l),z:s.z.number(t.z,n.z,l)}}}let de;class _e extends s.E{constructor(t){super(),de=de||new s.q({anchor:new s.D(s.v.light.anchor),position:new Q,color:new s.D(s.v.light.color),intensity:new s.D(s.v.light.intensity)}),this._transitionable=new s.T(de),this.setLight(t),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,n={}){if(!this._validate(s.r,t,n))for(const l in t){const d=t[l];l.endsWith("-transition")?this._transitionable.setTransition(l.slice(0,-11),d):this._transitionable.setValue(l,d)}}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,l){return(!l||l.validate!==!1)&&s.t(this,t.call(s.x,{value:n,style:{glyphs:!0,sprite:!0},styleSpec:s.v}))}}class pe{constructor(t,n){this.width=t,this.height=n,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(t,n){const l=t.join(",")+String(n);return this.dashEntry[l]||(this.dashEntry[l]=this.addDash(t,n)),this.dashEntry[l]}getDashRanges(t,n,l){const d=[];let y=t.length%2==1?-t[t.length-1]*l:0,P=t[0]*l,A=!0;d.push({left:y,right:P,isDash:A,zeroLength:t[0]===0});let O=t[0];for(let R=1;R<t.length;R++){A=!A;const N=t[R];y=O*l,O+=N,P=O*l,d.push({left:y,right:P,isDash:A,zeroLength:N===0})}return d}addRoundDash(t,n,l){const d=n/2;for(let y=-l;y<=l;y++){const P=this.width*(this.nextRow+l+y);let A=0,O=t[A];for(let R=0;R<this.width;R++){R/O.right>1&&(O=t[++A]);const N=Math.abs(R-O.left),G=Math.abs(R-O.right),Z=Math.min(N,G);let ce;const oe=y/l*(d+1);if(O.isDash){const ue=d-Math.abs(oe);ce=Math.sqrt(Z*Z+ue*ue)}else ce=d-Math.sqrt(Z*Z+oe*oe);this.data[P+R]=Math.max(0,Math.min(255,ce+128))}}}addRegularDash(t){for(let A=t.length-1;A>=0;--A){const O=t[A],R=t[A+1];O.zeroLength?t.splice(A,1):R&&R.isDash===O.isDash&&(R.left=O.left,t.splice(A,1))}const n=t[0],l=t[t.length-1];n.isDash===l.isDash&&(n.left=l.left-this.width,l.right=n.right+this.width);const d=this.width*this.nextRow;let y=0,P=t[y];for(let A=0;A<this.width;A++){A/P.right>1&&(P=t[++y]);const O=Math.abs(A-P.left),R=Math.abs(A-P.right),N=Math.min(O,R);this.data[d+A]=Math.max(0,Math.min(255,(P.isDash?N:-N)+128))}}addDash(t,n){const l=n?7:0,d=2*l+1;if(this.nextRow+d>this.height)return s.w("LineAtlas out of space"),null;let y=0;for(let A=0;A<t.length;A++)y+=t[A];if(y!==0){const A=this.width/y,O=this.getDashRanges(t,this.width,A);n?this.addRoundDash(O,A,l):this.addRegularDash(O)}const P={y:(this.nextRow+l+.5)/this.height,height:2*l/this.height,width:y};return this.nextRow+=d,this.dirty=!0,P}bind(t){const n=t.gl;this.texture?(n.bindTexture(n.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,n.texSubImage2D(n.TEXTURE_2D,0,0,0,this.width,this.height,n.ALPHA,n.UNSIGNED_BYTE,this.data))):(this.texture=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this.texture),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texImage2D(n.TEXTURE_2D,0,n.ALPHA,this.width,this.height,0,n.ALPHA,n.UNSIGNED_BYTE,this.data))}}const Re="maplibre_preloaded_worker_pool";class fe{constructor(){this.active={}}acquire(t){if(!this.workers)for(this.workers=[];this.workers.length<fe.workerCount;)this.workers.push(new Worker(s.a.WORKER_URL));return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],this.numActive()===0&&(this.workers.forEach(n=>{n.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Re]}numActive(){return Object.keys(this.active).length}}const ee=Math.floor(o.hardwareConcurrency/2);let Ce,Le;function Je(){return Ce||(Ce=new fe),Ce}fe.workerCount=s.B(globalThis)?Math.max(Math.min(ee,3),1):1;class Ue{constructor(t,n){this.workerPool=t,this.actors=[],this.currentActor=0,this.id=n;const l=this.workerPool.acquire(n);for(let d=0;d<l.length;d++){const y=new s.C(l[d],n);y.name=`Worker ${d}`,this.actors.push(y)}if(!this.actors.length)throw new Error("No actors found")}broadcast(t,n){const l=[];for(const d of this.actors)l.push(d.sendAsync({type:t,data:n}));return Promise.all(l)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(t=!0){this.actors.forEach(n=>{n.remove()}),this.actors=[],t&&this.workerPool.release(this.id)}registerMessageHandler(t,n){for(const l of this.actors)l.registerMessageHandler(t,n)}}function Ge(){return Le||(Le=new Ue(Je(),s.G),Le.registerMessageHandler("getResource",(g,t,n)=>s.m(t,n))),Le}function dt(g,t){const n=s.F();return s.H(n,n,[1,1,0]),s.J(n,n,[.5*g.width,.5*g.height,1]),s.K(n,n,g.calculatePosMatrix(t.toUnwrapped()))}function At(g,t,n,l,d,y){const P=function(G,Z,ce){if(G)for(const oe of G){const ue=Z[oe];if(ue&&ue.source===ce&&ue.type==="fill-extrusion")return!0}else for(const oe in Z){const ue=Z[oe];if(ue.source===ce&&ue.type==="fill-extrusion")return!0}return!1}(d&&d.layers,t,g.id),A=y.maxPitchScaleFactor(),O=g.tilesIn(l,A,P);O.sort(Ye);const R=[];for(const G of O)R.push({wrappedTileID:G.tileID.wrapped().key,queryResults:G.tile.queryRenderedFeatures(t,n,g._state,G.queryGeometry,G.cameraQueryGeometry,G.scale,d,y,A,dt(g.transform,G.tileID))});const N=function(G){const Z={},ce={};for(const oe of G){const ue=oe.queryResults,te=oe.wrappedTileID,Se=ce[te]=ce[te]||{};for(const We in ue){const ge=ue[We],ke=Se[We]=Se[We]||{},He=Z[We]=Z[We]||[];for(const qe of ge)ke[qe.featureIndex]||(ke[qe.featureIndex]=!0,He.push(qe))}}return Z}(R);for(const G in N)N[G].forEach(Z=>{const ce=Z.feature,oe=g.getFeatureState(ce.layer["source-layer"],ce.id);ce.source=ce.layer.source,ce.layer["source-layer"]&&(ce.sourceLayer=ce.layer["source-layer"]),ce.state=oe});return N}function Ye(g,t){const n=g.tileID,l=t.tileID;return n.overscaledZ-l.overscaledZ||n.canonical.y-l.canonical.y||n.wrap-l.wrap||n.canonical.x-l.canonical.x}function Oe(g,t,n){return s._(this,void 0,void 0,function*(){let l=g;if(g.url?l=(yield s.h(t.transformRequest(g.url,L.Source),n)).data:yield o.frameAsync(n),!l)return null;const d=s.L(s.e(l,g),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in l&&l.vector_layers&&(d.vectorLayerIds=l.vector_layers.map(y=>y.id)),d})}class Qe{constructor(t,n){t&&(n?this.setSouthWest(t).setNorthEast(n):Array.isArray(t)&&(t.length===4?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1])))}setNorthEast(t){return this._ne=t instanceof s.M?new s.M(t.lng,t.lat):s.M.convert(t),this}setSouthWest(t){return this._sw=t instanceof s.M?new s.M(t.lng,t.lat):s.M.convert(t),this}extend(t){const n=this._sw,l=this._ne;let d,y;if(t instanceof s.M)d=t,y=t;else{if(!(t instanceof Qe))return Array.isArray(t)?t.length===4||t.every(Array.isArray)?this.extend(Qe.convert(t)):this.extend(s.M.convert(t)):t&&("lng"in t||"lon"in t)&&"lat"in t?this.extend(s.M.convert(t)):this;if(d=t._sw,y=t._ne,!d||!y)return this}return n||l?(n.lng=Math.min(d.lng,n.lng),n.lat=Math.min(d.lat,n.lat),l.lng=Math.max(y.lng,l.lng),l.lat=Math.max(y.lat,l.lat)):(this._sw=new s.M(d.lng,d.lat),this._ne=new s.M(y.lng,y.lat)),this}getCenter(){return new s.M((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new s.M(this.getWest(),this.getNorth())}getSouthEast(){return new s.M(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:n,lat:l}=s.M.convert(t);let d=this._sw.lng<=n&&n<=this._ne.lng;return this._sw.lng>this._ne.lng&&(d=this._sw.lng>=n&&n>=this._ne.lng),this._sw.lat<=l&&l<=this._ne.lat&&d}static convert(t){return t instanceof Qe?t:t&&new Qe(t)}static fromLngLat(t,n=0){const l=360*n/40075017,d=l/Math.cos(Math.PI/180*t.lat);return new Qe(new s.M(t.lng-d,t.lat-l),new s.M(t.lng+d,t.lat+l))}}class Xe{constructor(t,n,l){this.bounds=Qe.convert(this.validateBounds(t)),this.minzoom=n||0,this.maxzoom=l||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(t){const n=Math.pow(2,t.z),l=Math.floor(s.N(this.bounds.getWest())*n),d=Math.floor(s.O(this.bounds.getNorth())*n),y=Math.ceil(s.N(this.bounds.getEast())*n),P=Math.ceil(s.O(this.bounds.getSouth())*n);return t.x>=l&&t.x<y&&t.y>=d&&t.y<P}}class le extends s.E{constructor(t,n,l,d){if(super(),this.id=t,this.dispatcher=l,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,s.e(this,s.L(n,["url","scheme","tileSize","promoteId"])),this._options=s.e({type:"vector"},n),this._collectResourceTiming=n.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(d)}load(){return s._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new s.k("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const t=yield Oe(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),t&&(s.e(this,t),t.bounds&&(this.tileBounds=new Xe(t.bounds,this.minzoom,this.maxzoom)),this.fire(new s.k("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.k("data",{dataType:"source",sourceDataType:"content"})))}catch(t){this._tileJSONRequest=null,this.fire(new s.j(t))}})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}setSourceProperty(t){this._tileJSONRequest&&this._tileJSONRequest.abort(),t(),this.load()}setTiles(t){return this.setSourceProperty(()=>{this._options.tiles=t}),this}setUrl(t){return this.setSourceProperty(()=>{this.url=t,this._options.url=t}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return s.e({},this._options)}loadTile(t){return s._(this,void 0,void 0,function*(){const n=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),l={request:this.map._requestManager.transformRequest(n,L.Tile),uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};l.request.collectResourceTiming=this._collectResourceTiming;let d="reloadTile";if(t.actor&&t.state!=="expired"){if(t.state==="loading")return new Promise((y,P)=>{t.reloadPromise={resolve:y,reject:P}})}else t.actor=this.dispatcher.getActor(),d="loadTile";t.abortController=new AbortController;try{const y=yield t.actor.sendAsync({type:d,data:l},t.abortController);if(delete t.abortController,t.aborted)return;this._afterTileLoadWorkerResponse(t,y)}catch(y){if(delete t.abortController,t.aborted)return;if(y&&y.status!==404)throw y;this._afterTileLoadWorkerResponse(t,null)}})}_afterTileLoadWorkerResponse(t,n){if(n&&n.resourceTiming&&(t.resourceTiming=n.resourceTiming),n&&this.map._refreshExpiredTiles&&t.setExpiryData(n),t.loadVectorData(n,this.map.painter),t.reloadPromise){const l=t.reloadPromise;t.reloadPromise=null,this.loadTile(t).then(l.resolve).catch(l.reject)}}abortTile(t){return s._(this,void 0,void 0,function*(){t.abortController&&(t.abortController.abort(),delete t.abortController),t.actor&&(yield t.actor.sendAsync({type:"abortTile",data:{uid:t.uid,type:this.type,source:this.id}}))})}unloadTile(t){return s._(this,void 0,void 0,function*(){t.unloadVectorData(),t.actor&&(yield t.actor.sendAsync({type:"removeTile",data:{uid:t.uid,type:this.type,source:this.id}}))})}hasTransition(){return!1}}class it extends s.E{constructor(t,n,l,d){super(),this.id=t,this.dispatcher=l,this.setEventedParent(d),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=s.e({type:"raster"},n),s.e(this,s.L(n,["url","scheme","tileSize"]))}load(){return s._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new s.k("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const t=yield Oe(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,t&&(s.e(this,t),t.bounds&&(this.tileBounds=new Xe(t.bounds,this.minzoom,this.maxzoom)),this.fire(new s.k("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.k("data",{dataType:"source",sourceDataType:"content"})))}catch(t){this._tileJSONRequest=null,this.fire(new s.j(t))}})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(t){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),t(),this.load()}setTiles(t){return this.setSourceProperty(()=>{this._options.tiles=t}),this}setUrl(t){return this.setSourceProperty(()=>{this.url=t,this._options.url=t}),this}serialize(){return s.e({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t){return s._(this,void 0,void 0,function*(){const n=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);t.abortController=new AbortController;try{const l=yield D.getImage(this.map._requestManager.transformRequest(n,L.Tile),t.abortController,this.map._refreshExpiredTiles);if(delete t.abortController,t.aborted)return void(t.state="unloaded");if(l&&l.data){this.map._refreshExpiredTiles&&l.cacheControl&&l.expires&&t.setExpiryData({cacheControl:l.cacheControl,expires:l.expires});const d=this.map.painter.context,y=d.gl,P=l.data;t.texture=this.map.painter.getTileTexture(P.width),t.texture?t.texture.update(P,{useMipmap:!0}):(t.texture=new $e(d,P,y.RGBA,{useMipmap:!0}),t.texture.bind(y.LINEAR,y.CLAMP_TO_EDGE,y.LINEAR_MIPMAP_NEAREST),d.extTextureFilterAnisotropic&&y.texParameterf(y.TEXTURE_2D,d.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,d.extTextureFilterAnisotropicMax)),t.state="loaded"}}catch(l){if(delete t.abortController,t.aborted)t.state="unloaded";else if(l)throw t.state="errored",l}})}abortTile(t){return s._(this,void 0,void 0,function*(){t.abortController&&(t.abortController.abort(),delete t.abortController)})}unloadTile(t){return s._(this,void 0,void 0,function*(){t.texture&&this.map.painter.saveTileTexture(t.texture)})}hasTransition(){return!1}}class bt extends it{constructor(t,n,l,d){super(t,n,l,d),this.type="raster-dem",this.maxzoom=22,this._options=s.e({type:"raster-dem"},n),this.encoding=n.encoding||"mapbox",this.redFactor=n.redFactor,this.greenFactor=n.greenFactor,this.blueFactor=n.blueFactor,this.baseShift=n.baseShift}loadTile(t){return s._(this,void 0,void 0,function*(){const n=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),l=this.map._requestManager.transformRequest(n,L.Tile);t.neighboringTiles=this._getNeighboringTiles(t.tileID),t.abortController=new AbortController;try{const d=yield D.getImage(l,t.abortController,this.map._refreshExpiredTiles);if(delete t.abortController,t.aborted)return void(t.state="unloaded");if(d&&d.data){const y=d.data;this.map._refreshExpiredTiles&&d.cacheControl&&d.expires&&t.setExpiryData({cacheControl:d.cacheControl,expires:d.expires});const P=s.b(y)&&s.S()?y:yield this.readImageNow(y),A={type:this.type,uid:t.uid,source:this.id,rawImageData:P,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!t.actor||t.state==="expired"){t.actor=this.dispatcher.getActor();const O=yield t.actor.sendAsync({type:"loadDEMTile",data:A});t.dem=O,t.needsHillshadePrepare=!0,t.needsTerrainPrepare=!0,t.state="loaded"}}}catch(d){if(delete t.abortController,t.aborted)t.state="unloaded";else if(d)throw t.state="errored",d}})}readImageNow(t){return s._(this,void 0,void 0,function*(){if(typeof VideoFrame<"u"&&s.U()){const n=t.width+2,l=t.height+2;try{return new s.R({width:n,height:l},yield s.V(t,-1,-1,n,l))}catch{}}return o.getImageData(t,1)})}_getNeighboringTiles(t){const n=t.canonical,l=Math.pow(2,n.z),d=(n.x-1+l)%l,y=n.x===0?t.wrap-1:t.wrap,P=(n.x+1+l)%l,A=n.x+1===l?t.wrap+1:t.wrap,O={};return O[new s.Q(t.overscaledZ,y,n.z,d,n.y).key]={backfilled:!1},O[new s.Q(t.overscaledZ,A,n.z,P,n.y).key]={backfilled:!1},n.y>0&&(O[new s.Q(t.overscaledZ,y,n.z,d,n.y-1).key]={backfilled:!1},O[new s.Q(t.overscaledZ,t.wrap,n.z,n.x,n.y-1).key]={backfilled:!1},O[new s.Q(t.overscaledZ,A,n.z,P,n.y-1).key]={backfilled:!1}),n.y+1<l&&(O[new s.Q(t.overscaledZ,y,n.z,d,n.y+1).key]={backfilled:!1},O[new s.Q(t.overscaledZ,t.wrap,n.z,n.x,n.y+1).key]={backfilled:!1},O[new s.Q(t.overscaledZ,A,n.z,P,n.y+1).key]={backfilled:!1}),O}unloadTile(t){return s._(this,void 0,void 0,function*(){t.demTexture&&this.map.painter.saveTileTexture(t.demTexture),t.fbo&&(t.fbo.destroy(),delete t.fbo),t.dem&&delete t.dem,delete t.neighboringTiles,t.state="unloaded",t.actor&&(yield t.actor.sendAsync({type:"removeDEMTile",data:{type:this.type,uid:t.uid,source:this.id}}))})}}class Pt extends s.E{constructor(t,n,l,d){super(),this.id=t,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=l.getActor(),this.setEventedParent(d),this._data=n.data,this._options=s.e({},n),this._collectResourceTiming=n.collectResourceTiming,n.maxzoom!==void 0&&(this.maxzoom=n.maxzoom),n.type&&(this.type=n.type),n.attribution&&(this.attribution=n.attribution),this.promoteId=n.promoteId;const y=s.W/this.tileSize;this.workerOptions=s.e({source:this.id,cluster:n.cluster||!1,geojsonVtOptions:{buffer:(n.buffer!==void 0?n.buffer:128)*y,tolerance:(n.tolerance!==void 0?n.tolerance:.375)*y,extent:s.W,maxZoom:this.maxzoom,lineMetrics:n.lineMetrics||!1,generateId:n.generateId||!1},superclusterOptions:{maxZoom:n.clusterMaxZoom!==void 0?n.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,n.clusterMinPoints||2),extent:s.W,radius:(n.clusterRadius||50)*y,log:!1,generateId:n.generateId||!1},clusterProperties:n.clusterProperties,filter:n.filter},n.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}load(){return s._(this,void 0,void 0,function*(){yield this._updateWorkerData()})}onAdd(t){this.map=t,this.load()}setData(t){return this._data=t,this._updateWorkerData(),this}updateData(t){return this._updateWorkerData(t),this}setClusterOptions(t){return this.workerOptions.cluster=t.cluster,t&&(t.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=t.clusterRadius),t.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=t.clusterMaxZoom)),this._updateWorkerData(),this}getClusterExpansionZoom(t){return this.actor.sendAsync({type:"getClusterExpansionZoom",data:{type:this.type,clusterId:t,source:this.id}})}getClusterChildren(t){return this.actor.sendAsync({type:"getClusterChildren",data:{type:this.type,clusterId:t,source:this.id}})}getClusterLeaves(t,n,l){return this.actor.sendAsync({type:"getClusterLeaves",data:{type:this.type,source:this.id,clusterId:t,limit:n,offset:l}})}_updateWorkerData(t){return s._(this,void 0,void 0,function*(){const n=s.e({type:this.type},this.workerOptions);t?n.dataDiff=t:typeof this._data=="string"?(n.request=this.map._requestManager.transformRequest(o.resolveURL(this._data),L.Source),n.request.collectResourceTiming=this._collectResourceTiming):n.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new s.k("dataloading",{dataType:"source"}));try{const l=yield this.actor.sendAsync({type:"loadData",data:n});if(this._pendingLoads--,this._removed||l.abandoned)return void this.fire(new s.k("dataabort",{dataType:"source"}));let d=null;l.resourceTiming&&l.resourceTiming[this.id]&&(d=l.resourceTiming[this.id].slice(0));const y={dataType:"source"};this._collectResourceTiming&&d&&d.length>0&&s.e(y,{resourceTiming:d}),this.fire(new s.k("data",Object.assign(Object.assign({},y),{sourceDataType:"metadata"}))),this.fire(new s.k("data",Object.assign(Object.assign({},y),{sourceDataType:"content"})))}catch(l){if(this._pendingLoads--,this._removed)return void this.fire(new s.k("dataabort",{dataType:"source"}));this.fire(new s.j(l))}})}loaded(){return this._pendingLoads===0}loadTile(t){return s._(this,void 0,void 0,function*(){const n=t.actor?"reloadTile":"loadTile";t.actor=this.actor;const l={type:this.type,uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};t.abortController=new AbortController;const d=yield this.actor.sendAsync({type:n,data:l},t.abortController);delete t.abortController,t.unloadVectorData(),t.aborted||t.loadVectorData(d,this.map.painter,n==="reloadTile")})}abortTile(t){return s._(this,void 0,void 0,function*(){t.abortController&&(t.abortController.abort(),delete t.abortController),t.aborted=!0})}unloadTile(t){return s._(this,void 0,void 0,function*(){t.unloadVectorData(),yield this.actor.sendAsync({type:"removeTile",data:{uid:t.uid,type:this.type,source:this.id}})})}onRemove(){this._removed=!0,this.actor.sendAsync({type:"removeSource",data:{type:this.type,source:this.id}})}serialize(){return s.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}var Ot=s.X([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class nt extends s.E{constructor(t,n,l,d){super(),this.id=t,this.dispatcher=l,this.coordinates=n.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(d),this.options=n}load(t){return s._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new s.k("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const n=yield D.getImage(this.map._requestManager.transformRequest(this.url,L.Image),this._request);this._request=null,this._loaded=!0,n&&n.data&&(this.image=n.data,t&&(this.coordinates=t),this._finishLoading())}catch(n){this._request=null,this.fire(new s.j(n))}})}loaded(){return this._loaded}updateImage(t){return t.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=t.url,this.load(t.coordinates).finally(()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new s.k("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(t){this.coordinates=t;const n=t.map(s.Y.fromLngLat);this.tileID=function(d){let y=1/0,P=1/0,A=-1/0,O=-1/0;for(const Z of d)y=Math.min(y,Z.x),P=Math.min(P,Z.y),A=Math.max(A,Z.x),O=Math.max(O,Z.y);const R=Math.max(A-y,O-P),N=Math.max(0,Math.floor(-Math.log(R)/Math.LN2)),G=Math.pow(2,N);return new s.a0(N,Math.floor((y+A)/2*G),Math.floor((P+O)/2*G))}(n),this.minzoom=this.maxzoom=this.tileID.z;const l=n.map(d=>this.tileID.getTilePoint(d)._round());return this._boundsArray=new s.Z,this._boundsArray.emplaceBack(l[0].x,l[0].y,0,0),this._boundsArray.emplaceBack(l[1].x,l[1].y,s.W,0),this._boundsArray.emplaceBack(l[3].x,l[3].y,0,s.W),this._boundsArray.emplaceBack(l[2].x,l[2].y,s.W,s.W),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this.fire(new s.k("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const t=this.map.painter.context,n=t.gl;this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,Ot.members)),this.boundsSegments||(this.boundsSegments=s.$.simpleSegment(0,0,4,2)),this.texture||(this.texture=new $e(t,this.image,n.RGBA),this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE));let l=!1;for(const d in this.tiles){const y=this.tiles[d];y.state!=="loaded"&&(y.state="loaded",y.texture=this.texture,l=!0)}l&&this.fire(new s.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(t){return s._(this,void 0,void 0,function*(){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={}):t.state="errored"})}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class qt extends nt{constructor(t,n,l,d){super(t,n,l,d),this.roundZoom=!0,this.type="video",this.options=n}load(){return s._(this,void 0,void 0,function*(){this._loaded=!1;const t=this.options;this.urls=[];for(const n of t.urls)this.urls.push(this.map._requestManager.transformRequest(n,L.Source).url);try{const n=yield s.a2(this.urls);if(this._loaded=!0,!n)return;this.video=n,this.video.loop=!0,this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading()}catch(n){this.fire(new s.j(n))}})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(t){if(this.video){const n=this.video.seekable;t<n.start(0)||t>n.end(0)?this.fire(new s.j(new s.a1(`sources.${this.id}`,null,`Playback for this video can be set only between the ${n.start(0)} and ${n.end(0)}-second mark.`))):this.video.currentTime=t}}getVideo(){return this.video}onAdd(t){this.map||(this.map=t,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const t=this.map.painter.context,n=t.gl;this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,Ot.members)),this.boundsSegments||(this.boundsSegments=s.$.simpleSegment(0,0,4,2)),this.texture?this.video.paused||(this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE),n.texSubImage2D(n.TEXTURE_2D,0,0,0,n.RGBA,n.UNSIGNED_BYTE,this.video)):(this.texture=new $e(t,this.video,n.RGBA),this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE));let l=!1;for(const d in this.tiles){const y=this.tiles[d];y.state!=="loaded"&&(y.state="loaded",y.texture=this.texture,l=!0)}l&&this.fire(new s.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class Yt extends nt{constructor(t,n,l,d){super(t,n,l,d),n.coordinates?Array.isArray(n.coordinates)&&n.coordinates.length===4&&!n.coordinates.some(y=>!Array.isArray(y)||y.length!==2||y.some(P=>typeof P!="number"))||this.fire(new s.j(new s.a1(`sources.${t}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.j(new s.a1(`sources.${t}`,null,'missing required property "coordinates"'))),n.animate&&typeof n.animate!="boolean"&&this.fire(new s.j(new s.a1(`sources.${t}`,null,'optional "animate" property must be a boolean value'))),n.canvas?typeof n.canvas=="string"||n.canvas instanceof HTMLCanvasElement||this.fire(new s.j(new s.a1(`sources.${t}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.j(new s.a1(`sources.${t}`,null,'missing required property "canvas"'))),this.options=n,this.animate=n.animate===void 0||n.animate}load(){return s._(this,void 0,void 0,function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.j(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())})}getCanvas(){return this.canvas}onAdd(t){this.map=t,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let t=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,t=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,t=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const n=this.map.painter.context,l=n.gl;this.boundsBuffer||(this.boundsBuffer=n.createVertexBuffer(this._boundsArray,Ot.members)),this.boundsSegments||(this.boundsSegments=s.$.simpleSegment(0,0,4,2)),this.texture?(t||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new $e(n,this.canvas,l.RGBA,{premultiply:!0});let d=!1;for(const y in this.tiles){const P=this.tiles[y];P.state!=="loaded"&&(P.state="loaded",P.texture=this.texture,d=!0)}d&&this.fire(new s.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const t of[this.canvas.width,this.canvas.height])if(isNaN(t)||t<=0)return!0;return!1}}const gi={},xi=g=>{switch(g){case"geojson":return Pt;case"image":return nt;case"raster":return it;case"raster-dem":return bt;case"vector":return le;case"video":return qt;case"canvas":return Yt}return gi[g]},fi="RTLPluginLoaded";class Gi extends s.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=Ge()}_syncState(t){return this.status=t,this.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:t,pluginURL:this.url}).catch(n=>{throw this.status="error",n})}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(t){return s._(this,arguments,void 0,function*(n,l=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=o.resolveURL(n),!this.url)throw new Error(`requested url ${n} is invalid`);if(this.status==="unavailable"){if(!l)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()})}_requestImport(){return s._(this,void 0,void 0,function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new s.k(fi))})}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let ht=null;function Hi(){return ht||(ht=new Gi),ht}class Zt{constructor(t,n){this.timeAdded=0,this.fadeEndTime=0,this.tileID=t,this.uid=s.a3(),this.uses=0,this.tileSize=n,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(t){const n=t+this.timeAdded;n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(t){this.demTexture&&t.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(t,n,l){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(d,y){const P={};if(!y)return P;for(const A of d){const O=A.layerIds.map(R=>y.getLayer(R)).filter(Boolean);if(O.length!==0){A.layers=O,A.stateDependentLayerIds&&(A.stateDependentLayers=A.stateDependentLayerIds.map(R=>O.filter(N=>N.id===R)[0]));for(const R of O)P[R.id]=A}}return P}(t.buckets,n.style),this.hasSymbolBuckets=!1;for(const d in this.buckets){const y=this.buckets[d];if(y instanceof s.a5){if(this.hasSymbolBuckets=!0,!l)break;y.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const d in this.buckets){const y=this.buckets[d];if(y instanceof s.a5&&y.hasRTLText){this.hasRTLText=!0,Hi().lazyLoad();break}}this.queryPadding=0;for(const d in this.buckets){const y=this.buckets[d];this.queryPadding=Math.max(this.queryPadding,n.style.getLayer(d).queryRadius(y))}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage)}else this.collisionBoxArray=new s.a4}unloadVectorData(){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(t){return this.buckets[t.id]}upload(t){for(const l in this.buckets){const d=this.buckets[l];d.uploadPending()&&d.upload(t)}const n=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new $e(t,this.imageAtlas.image,n.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new $e(t,this.glyphAtlasImage,n.ALPHA),this.glyphAtlasImage=null)}prepare(t){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture)}queryRenderedFeatures(t,n,l,d,y,P,A,O,R,N){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:d,cameraQueryGeometry:y,scale:P,tileSize:this.tileSize,pixelPosMatrix:N,transform:O,params:A,queryPadding:this.queryPadding*R},t,n,l):{}}querySourceFeatures(t,n){const l=this.latestFeatureIndex;if(!l||!l.rawTileData)return;const d=l.loadVTLayers(),y=n&&n.sourceLayer?n.sourceLayer:"",P=d._geojsonTileLayer||d[y];if(!P)return;const A=s.a6(n&&n.filter),{z:O,x:R,y:N}=this.tileID.canonical,G={z:O,x:R,y:N};for(let Z=0;Z<P.length;Z++){const ce=P.feature(Z);if(A.needGeometry){const te=s.a7(ce,!0);if(!A.filter(new s.a8(this.tileID.overscaledZ),te,this.tileID.canonical))continue}else if(!A.filter(new s.a8(this.tileID.overscaledZ),ce))continue;const oe=l.getId(ce,y),ue=new s.a9(ce,O,R,N,oe);ue.tile=G,t.push(ue)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const n=this.expirationTime;if(t.cacheControl){const l=s.aa(t.cacheControl);l["max-age"]&&(this.expirationTime=Date.now()+1e3*l["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const l=Date.now();let d=!1;if(this.expirationTime>l)d=!1;else if(n)if(this.expirationTime<n)d=!0;else{const y=this.expirationTime-n;y?this.expirationTime=l+Math.max(y,3e4):d=!0}else d=!0;d?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(t,n){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(t).length===0)return;const l=this.latestFeatureIndex.loadVTLayers();for(const d in this.buckets){if(!n.style.hasLayer(d))continue;const y=this.buckets[d],P=y.layers[0].sourceLayer||"_geojsonTileLayer",A=l[P],O=t[P];if(!A||!O||Object.keys(O).length===0)continue;y.update(O,A,this.imageAtlas&&this.imageAtlas.patternPositions||{});const R=n&&n.style&&n.style.getLayer(d);R&&(this.queryPadding=Math.max(this.queryPadding,R.queryRadius(y)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<o.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=o.now()+t}setDependencies(t,n){const l={};for(const d of n)l[d]=!0;this.dependencies[t]=l}hasDependency(t,n){for(const l of t){const d=this.dependencies[l];if(d){for(const y of n)if(d[y])return!0}}return!1}}class bi{constructor(t,n){this.max=t,this.onRemove=n,this.reset()}reset(){for(const t in this.data)for(const n of this.data[t])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(t,n,l){const d=t.wrapped().key;this.data[d]===void 0&&(this.data[d]=[]);const y={value:n,timeout:void 0};if(l!==void 0&&(y.timeout=setTimeout(()=>{this.remove(t,y)},l)),this.data[d].push(y),this.order.push(d),this.order.length>this.max){const P=this._getAndRemoveByKey(this.order[0]);P&&this.onRemove(P)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const n=this.data[t].shift();return n.timeout&&clearTimeout(n.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),n.value}getByKey(t){const n=this.data[t];return n?n[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,n){if(!this.has(t))return this;const l=t.wrapped().key,d=n===void 0?0:this.data[l].indexOf(n),y=this.data[l][d];return this.data[l].splice(d,1),y.timeout&&clearTimeout(y.timeout),this.data[l].length===0&&delete this.data[l],this.onRemove(y.value),this.order.splice(this.order.indexOf(l),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(t){const n=[];for(const l in this.data)for(const d of this.data[l])t(d.value)||n.push(d);for(const l of n)this.remove(l.value.tileID,l)}}class cr{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,n,l){const d=String(n);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][d]=this.stateChanges[t][d]||{},s.e(this.stateChanges[t][d],l),this.deletedStates[t]===null){this.deletedStates[t]={};for(const y in this.state[t])y!==d&&(this.deletedStates[t][y]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][d]===null){this.deletedStates[t][d]={};for(const y in this.state[t][d])l[y]||(this.deletedStates[t][d][y]=null)}else for(const y in l)this.deletedStates[t]&&this.deletedStates[t][d]&&this.deletedStates[t][d][y]===null&&delete this.deletedStates[t][d][y]}removeFeatureState(t,n,l){if(this.deletedStates[t]===null)return;const d=String(n);if(this.deletedStates[t]=this.deletedStates[t]||{},l&&n!==void 0)this.deletedStates[t][d]!==null&&(this.deletedStates[t][d]=this.deletedStates[t][d]||{},this.deletedStates[t][d][l]=null);else if(n!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][d])for(l in this.deletedStates[t][d]={},this.stateChanges[t][d])this.deletedStates[t][d][l]=null;else this.deletedStates[t][d]=null;else this.deletedStates[t]=null}getState(t,n){const l=String(n),d=s.e({},(this.state[t]||{})[l],(this.stateChanges[t]||{})[l]);if(this.deletedStates[t]===null)return{};if(this.deletedStates[t]){const y=this.deletedStates[t][n];if(y===null)return{};for(const P in y)delete d[P]}return d}initializeTileState(t,n){t.setFeatureState(this.state,n)}coalesceChanges(t,n){const l={};for(const d in this.stateChanges){this.state[d]=this.state[d]||{};const y={};for(const P in this.stateChanges[d])this.state[d][P]||(this.state[d][P]={}),s.e(this.state[d][P],this.stateChanges[d][P]),y[P]=this.state[d][P];l[d]=y}for(const d in this.deletedStates){this.state[d]=this.state[d]||{};const y={};if(this.deletedStates[d]===null)for(const P in this.state[d])y[P]={},this.state[d][P]={};else for(const P in this.deletedStates[d]){if(this.deletedStates[d][P]===null)this.state[d][P]={};else for(const A of Object.keys(this.deletedStates[d][P]))delete this.state[d][P][A];y[P]=this.state[d][P]}l[d]=l[d]||{},s.e(l[d],y)}if(this.stateChanges={},this.deletedStates={},Object.keys(l).length!==0)for(const d in t)t[d].setFeatureState(l,n)}}class xt extends s.E{constructor(t,n,l){super(),this.id=t,this.dispatcher=l,this.on("data",d=>{d.dataType==="source"&&d.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&d.dataType==="source"&&d.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)}),this.on("dataloading",()=>{this._sourceErrored=!1}),this.on("error",()=>{this._sourceErrored=this._source.loaded()}),this._source=((d,y,P,A)=>{const O=new(xi(y.type))(d,y,P,A);if(O.id!==d)throw new Error(`Expected Source id to be ${d} instead of ${O.id}`);return O})(t,n,l,this),this._tiles={},this._cache=new bi(0,d=>this._unloadTile(d)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new cr,this._didEmitContent=!1,this._updated=!1}onAdd(t){this.map=t,this._maxTileCacheSize=t?t._maxTileCacheSize:null,this._maxTileCacheZoomLevels=t?t._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(t)}onRemove(t){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(t)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const t in this._tiles){const n=this._tiles[t];if(n.state!=="loaded"&&n.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(t,n,l){return s._(this,void 0,void 0,function*(){try{yield this._source.loadTile(t),this._tileLoaded(t,n,l)}catch(d){t.state="errored",d.status!==404?this._source.fire(new s.j(d,{tile:t})):this.update(this.transform,this.terrain)}})}_unloadTile(t){this._source.unloadTile&&this._source.unloadTile(t)}_abortTile(t){this._source.abortTile&&this._source.abortTile(t),this._source.fire(new s.k("dataabort",{tile:t,coord:t.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const l=this._tiles[n];l.upload(t),l.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(li).map(t=>t.key)}getRenderableIds(t){const n=[];for(const l in this._tiles)this._isIdRenderable(l,t)&&n.push(this._tiles[l]);return t?n.sort((l,d)=>{const y=l.tileID,P=d.tileID,A=new s.P(y.canonical.x,y.canonical.y)._rotate(this.transform.angle),O=new s.P(P.canonical.x,P.canonical.y)._rotate(this.transform.angle);return y.overscaledZ-P.overscaledZ||O.y-A.y||O.x-A.x}).map(l=>l.tileID.key):n.map(l=>l.tileID).sort(li).map(l=>l.key)}hasRenderableParent(t){const n=this.findLoadedParent(t,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(t,n){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(n||!this._tiles[t].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(t,"reloading")}}_reloadTile(t,n){return s._(this,void 0,void 0,function*(){const l=this._tiles[t];l&&(l.state!=="loading"&&(l.state=n),yield this._loadTile(l,t,n))})}_tileLoaded(t,n,l){t.timeAdded=o.now(),l==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(n,t),this.getSource().type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),t.aborted||this._source.fire(new s.k("data",{dataType:"source",tile:t,coord:t.tileID}))}_backfillDEM(t){const n=this.getRenderableIds();for(let d=0;d<n.length;d++){const y=n[d];if(t.neighboringTiles&&t.neighboringTiles[y]){const P=this.getTileByID(y);l(t,P),l(P,t)}}function l(d,y){d.needsHillshadePrepare=!0,d.needsTerrainPrepare=!0;let P=y.tileID.canonical.x-d.tileID.canonical.x;const A=y.tileID.canonical.y-d.tileID.canonical.y,O=Math.pow(2,d.tileID.canonical.z),R=y.tileID.key;P===0&&A===0||Math.abs(A)>1||(Math.abs(P)>1&&(Math.abs(P+O)===1?P+=O:Math.abs(P-O)===1&&(P-=O)),y.dem&&d.dem&&(d.dem.backfillBorder(y.dem,P,A),d.neighboringTiles&&d.neighboringTiles[R]&&(d.neighboringTiles[R].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,n,l,d){for(const y in this._tiles){let P=this._tiles[y];if(d[y]||!P.hasData()||P.tileID.overscaledZ<=n||P.tileID.overscaledZ>l)continue;let A=P.tileID;for(;P&&P.tileID.overscaledZ>n+1;){const R=P.tileID.scaledTo(P.tileID.overscaledZ-1);P=this._tiles[R.key],P&&P.hasData()&&(A=R)}let O=A;for(;O.overscaledZ>n;)if(O=O.scaledTo(O.overscaledZ-1),t[O.key]){d[A.key]=A;break}}}findLoadedParent(t,n){if(t.key in this._loadedParentTiles){const l=this._loadedParentTiles[t.key];return l&&l.tileID.overscaledZ>=n?l:null}for(let l=t.overscaledZ-1;l>=n;l--){const d=t.scaledTo(l),y=this._getLoadedTile(d);if(y)return y}}_getLoadedTile(t){const n=this._tiles[t.key];return n&&n.hasData()?n:this._cache.getByKey(t.wrapped().key)}updateCacheSize(t){const n=Math.ceil(t.width/this._source.tileSize)+1,l=Math.ceil(t.height/this._source.tileSize)+1,d=Math.floor(n*l*(this._maxTileCacheZoomLevels===null?s.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),y=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,d):d;this._cache.setMaxSize(y)}handleWrapJump(t){const n=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,n){const l={};for(const d in this._tiles){const y=this._tiles[d];y.tileID=y.tileID.unwrapTo(y.tileID.wrap+n),l[y.tileID.key]=y}this._tiles=l;for(const d in this._timers)clearTimeout(this._timers[d]),delete this._timers[d];for(const d in this._tiles)this._setTileReloadTimer(d,this._tiles[d])}}update(t,n){if(this.transform=t,this.terrain=n,!this._sourceLoaded||this._paused)return;let l;this.updateCacheSize(t),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?l=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(N=>new s.Q(N.canonical.z,N.wrap,N.canonical.z,N.canonical.x,N.canonical.y)):(l=t.coveringTiles({tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:n}),this._source.hasTile&&(l=l.filter(N=>this._source.hasTile(N)))):l=[];const d=t.coveringZoomLevel(this._source),y=Math.max(d-xt.maxOverzooming,this._source.minzoom),P=Math.max(d+xt.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const N={};for(const G of l)if(G.canonical.z>this._source.minzoom){const Z=G.scaledTo(G.canonical.z-1);N[Z.key]=Z;const ce=G.scaledTo(Math.max(this._source.minzoom,Math.min(G.canonical.z,5)));N[ce.key]=ce}l=l.concat(Object.values(N))}const A=l.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,A&&this.fire(new s.k("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const O=this._updateRetainedTiles(l,d);if(Kt(this._source.type)){const N={},G={},Z=Object.keys(O),ce=o.now();for(const oe of Z){const ue=O[oe],te=this._tiles[oe];if(!te||te.fadeEndTime!==0&&te.fadeEndTime<=ce)continue;const Se=this.findLoadedParent(ue,y);Se&&(this._addTile(Se.tileID),N[Se.tileID.key]=Se.tileID),G[oe]=ue}this._retainLoadedChildren(G,d,P,O);for(const oe in N)O[oe]||(this._coveredTiles[oe]=!0,O[oe]=N[oe]);if(n){const oe={},ue={};for(const te of l)this._tiles[te.key].hasData()?oe[te.key]=te:ue[te.key]=te;for(const te in ue){const Se=ue[te].children(this._source.maxzoom);this._tiles[Se[0].key]&&this._tiles[Se[1].key]&&this._tiles[Se[2].key]&&this._tiles[Se[3].key]&&(oe[Se[0].key]=O[Se[0].key]=Se[0],oe[Se[1].key]=O[Se[1].key]=Se[1],oe[Se[2].key]=O[Se[2].key]=Se[2],oe[Se[3].key]=O[Se[3].key]=Se[3],delete ue[te])}for(const te in ue){const Se=this.findLoadedParent(ue[te],this._source.minzoom);if(Se){oe[Se.tileID.key]=O[Se.tileID.key]=Se.tileID;for(const We in oe)oe[We].isChildOf(Se.tileID)&&delete oe[We]}}for(const te in this._tiles)oe[te]||(this._coveredTiles[te]=!0)}}for(const N in O)this._tiles[N].clearFadeHold();const R=s.ab(this._tiles,O);for(const N of R){const G=this._tiles[N];G.hasSymbolBuckets&&!G.holdingForFade()?G.setHoldDuration(this.map._fadeDuration):G.hasSymbolBuckets&&!G.symbolFadeFinished()||this._removeTile(N)}this._updateLoadedParentTileCache()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(t)}_updateRetainedTiles(t,n){const l={},d={},y=Math.max(n-xt.maxOverzooming,this._source.minzoom),P=Math.max(n+xt.maxUnderzooming,this._source.minzoom),A={};for(const O of t){const R=this._addTile(O);l[O.key]=O,R.hasData()||n<this._source.maxzoom&&(A[O.key]=O)}this._retainLoadedChildren(A,n,P,l);for(const O of t){let R=this._tiles[O.key];if(R.hasData())continue;if(n+1>this._source.maxzoom){const G=O.children(this._source.maxzoom)[0],Z=this.getTile(G);if(Z&&Z.hasData()){l[G.key]=G;continue}}else{const G=O.children(this._source.maxzoom);if(l[G[0].key]&&l[G[1].key]&&l[G[2].key]&&l[G[3].key])continue}let N=R.wasRequested();for(let G=O.overscaledZ-1;G>=y;--G){const Z=O.scaledTo(G);if(d[Z.key])break;if(d[Z.key]=!0,R=this.getTile(Z),!R&&N&&(R=this._addTile(Z)),R){const ce=R.hasData();if((N||ce)&&(l[Z.key]=Z),N=R.wasRequested(),ce)break}}}return l}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const n=[];let l,d=this._tiles[t].tileID;for(;d.overscaledZ>0;){if(d.key in this._loadedParentTiles){l=this._loadedParentTiles[d.key];break}n.push(d.key);const y=d.scaledTo(d.overscaledZ-1);if(l=this._getLoadedTile(y),l)break;d=y}for(const y of n)this._loadedParentTiles[y]=l}}_addTile(t){let n=this._tiles[t.key];if(n)return n;n=this._cache.getAndRemove(t),n&&(this._setTileReloadTimer(t.key,n),n.tileID=t,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,n)));const l=n;return n||(n=new Zt(t,this._source.tileSize*t.overscaleFactor()),this._loadTile(n,t.key,n.state)),n.uses++,this._tiles[t.key]=n,l||this._source.fire(new s.k("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n}_setTileReloadTimer(t,n){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const l=n.getExpiryTimeout();l&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},l))}_removeTile(t){const n=this._tiles[t];n&&(n.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),n.uses>0||(n.hasData()&&n.state!=="reloading"?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(t);this._cache.reset()}tilesIn(t,n,l){const d=[],y=this.transform;if(!y)return d;const P=l?y.getCameraQueryGeometry(t):t,A=t.map(oe=>y.pointCoordinate(oe,this.terrain)),O=P.map(oe=>y.pointCoordinate(oe,this.terrain)),R=this.getIds();let N=1/0,G=1/0,Z=-1/0,ce=-1/0;for(const oe of O)N=Math.min(N,oe.x),G=Math.min(G,oe.y),Z=Math.max(Z,oe.x),ce=Math.max(ce,oe.y);for(let oe=0;oe<R.length;oe++){const ue=this._tiles[R[oe]];if(ue.holdingForFade())continue;const te=ue.tileID,Se=Math.pow(2,y.zoom-ue.tileID.overscaledZ),We=n*ue.queryPadding*s.W/ue.tileSize/Se,ge=[te.getTilePoint(new s.Y(N,G)),te.getTilePoint(new s.Y(Z,ce))];if(ge[0].x-We<s.W&&ge[0].y-We<s.W&&ge[1].x+We>=0&&ge[1].y+We>=0){const ke=A.map(qe=>te.getTilePoint(qe)),He=O.map(qe=>te.getTilePoint(qe));d.push({tile:ue,tileID:te,queryGeometry:ke,cameraQueryGeometry:He,scale:Se})}}return d}getVisibleCoordinates(t){const n=this.getRenderableIds(t).map(l=>this._tiles[l].tileID);for(const l of n)l.posMatrix=this.transform.calculatePosMatrix(l.toUnwrapped());return n}hasTransition(){if(this._source.hasTransition())return!0;if(Kt(this._source.type)){const t=o.now();for(const n in this._tiles)if(this._tiles[n].fadeEndTime>=t)return!0}return!1}setFeatureState(t,n,l){this._state.updateState(t=t||"_geojsonTileLayer",n,l)}removeFeatureState(t,n,l){this._state.removeFeatureState(t=t||"_geojsonTileLayer",n,l)}getFeatureState(t,n){return this._state.getState(t=t||"_geojsonTileLayer",n)}setDependencies(t,n,l){const d=this._tiles[t];d&&d.setDependencies(n,l)}reloadTilesForDependencies(t,n){for(const l in this._tiles)this._tiles[l].hasDependency(t,n)&&this._reloadTile(l,"reloading");this._cache.filter(l=>!l.hasDependency(t,n))}}function li(g,t){const n=Math.abs(2*g.wrap)-+(g.wrap<0),l=Math.abs(2*t.wrap)-+(t.wrap<0);return g.overscaledZ-t.overscaledZ||l-n||t.canonical.y-g.canonical.y||t.canonical.x-g.canonical.x}function Kt(g){return g==="raster"||g==="image"||g==="video"}xt.maxOverzooming=10,xt.maxUnderzooming=3;class Tr{constructor(t,n){this.reset(t,n)}reset(t,n){this.points=t||[],this._distances=[0];for(let l=1;l<this.points.length;l++)this._distances[l]=this._distances[l-1]+this.points[l].dist(this.points[l-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(n||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=s.ac(t,0,1);let n=1,l=this._distances[n];const d=t*this.paddedLength+this.padding;for(;l<d&&n<this._distances.length;)l=this._distances[++n];const y=n-1,P=this._distances[y],A=l-P,O=A>0?(d-P)/A:0;return this.points[y].mult(1-O).add(this.points[n].mult(O))}}function Lr(g,t){let n=!0;return g==="always"||g!=="never"&&t!=="never"||(n=!1),n}class ui{constructor(t,n,l){const d=this.boxCells=[],y=this.circleCells=[];this.xCellCount=Math.ceil(t/l),this.yCellCount=Math.ceil(n/l);for(let P=0;P<this.xCellCount*this.yCellCount;P++)d.push([]),y.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=n,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/n,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,n,l,d,y){this._forEachCell(n,l,d,y,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(n),this.bboxes.push(l),this.bboxes.push(d),this.bboxes.push(y)}insertCircle(t,n,l,d){this._forEachCell(n-d,l-d,n+d,l+d,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(n),this.circles.push(l),this.circles.push(d)}_insertBoxCell(t,n,l,d,y,P){this.boxCells[y].push(P)}_insertCircleCell(t,n,l,d,y,P){this.circleCells[y].push(P)}_query(t,n,l,d,y,P,A){if(l<0||t>this.width||d<0||n>this.height)return[];const O=[];if(t<=0&&n<=0&&this.width<=l&&this.height<=d){if(y)return[{key:null,x1:t,y1:n,x2:l,y2:d}];for(let R=0;R<this.boxKeys.length;R++)O.push({key:this.boxKeys[R],x1:this.bboxes[4*R],y1:this.bboxes[4*R+1],x2:this.bboxes[4*R+2],y2:this.bboxes[4*R+3]});for(let R=0;R<this.circleKeys.length;R++){const N=this.circles[3*R],G=this.circles[3*R+1],Z=this.circles[3*R+2];O.push({key:this.circleKeys[R],x1:N-Z,y1:G-Z,x2:N+Z,y2:G+Z})}}else this._forEachCell(t,n,l,d,this._queryCell,O,{hitTest:y,overlapMode:P,seenUids:{box:{},circle:{}}},A);return O}query(t,n,l,d){return this._query(t,n,l,d,!1,null)}hitTest(t,n,l,d,y,P){return this._query(t,n,l,d,!0,y,P).length>0}hitTestCircle(t,n,l,d,y){const P=t-l,A=t+l,O=n-l,R=n+l;if(A<0||P>this.width||R<0||O>this.height)return!1;const N=[];return this._forEachCell(P,O,A,R,this._queryCellCircle,N,{hitTest:!0,overlapMode:d,circle:{x:t,y:n,radius:l},seenUids:{box:{},circle:{}}},y),N.length>0}_queryCell(t,n,l,d,y,P,A,O){const{seenUids:R,hitTest:N,overlapMode:G}=A,Z=this.boxCells[y];if(Z!==null){const oe=this.bboxes;for(const ue of Z)if(!R.box[ue]){R.box[ue]=!0;const te=4*ue,Se=this.boxKeys[ue];if(t<=oe[te+2]&&n<=oe[te+3]&&l>=oe[te+0]&&d>=oe[te+1]&&(!O||O(Se))&&(!N||!Lr(G,Se.overlapMode))&&(P.push({key:Se,x1:oe[te],y1:oe[te+1],x2:oe[te+2],y2:oe[te+3]}),N))return!0}}const ce=this.circleCells[y];if(ce!==null){const oe=this.circles;for(const ue of ce)if(!R.circle[ue]){R.circle[ue]=!0;const te=3*ue,Se=this.circleKeys[ue];if(this._circleAndRectCollide(oe[te],oe[te+1],oe[te+2],t,n,l,d)&&(!O||O(Se))&&(!N||!Lr(G,Se.overlapMode))){const We=oe[te],ge=oe[te+1],ke=oe[te+2];if(P.push({key:Se,x1:We-ke,y1:ge-ke,x2:We+ke,y2:ge+ke}),N)return!0}}}return!1}_queryCellCircle(t,n,l,d,y,P,A,O){const{circle:R,seenUids:N,overlapMode:G}=A,Z=this.boxCells[y];if(Z!==null){const oe=this.bboxes;for(const ue of Z)if(!N.box[ue]){N.box[ue]=!0;const te=4*ue,Se=this.boxKeys[ue];if(this._circleAndRectCollide(R.x,R.y,R.radius,oe[te+0],oe[te+1],oe[te+2],oe[te+3])&&(!O||O(Se))&&!Lr(G,Se.overlapMode))return P.push(!0),!0}}const ce=this.circleCells[y];if(ce!==null){const oe=this.circles;for(const ue of ce)if(!N.circle[ue]){N.circle[ue]=!0;const te=3*ue,Se=this.circleKeys[ue];if(this._circlesCollide(oe[te],oe[te+1],oe[te+2],R.x,R.y,R.radius)&&(!O||O(Se))&&!Lr(G,Se.overlapMode))return P.push(!0),!0}}}_forEachCell(t,n,l,d,y,P,A,O){const R=this._convertToXCellCoord(t),N=this._convertToYCellCoord(n),G=this._convertToXCellCoord(l),Z=this._convertToYCellCoord(d);for(let ce=R;ce<=G;ce++)for(let oe=N;oe<=Z;oe++)if(y.call(this,t,n,l,d,this.xCellCount*oe+ce,P,A,O))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,n,l,d,y,P){const A=d-t,O=y-n,R=l+P;return R*R>A*A+O*O}_circleAndRectCollide(t,n,l,d,y,P,A){const O=(P-d)/2,R=Math.abs(t-(d+O));if(R>O+l)return!1;const N=(A-y)/2,G=Math.abs(n-(y+N));if(G>N+l)return!1;if(R<=O||G<=N)return!0;const Z=R-O,ce=G-N;return Z*Z+ce*ce<=l*l}}function wn(g,t,n,l,d){const y=s.F();return t?(s.J(y,y,[1/d,1/d,1]),n||s.ad(y,y,l.angle)):s.K(y,l.labelPlaneMatrix,g),y}function $r(g,t,n,l,d){if(t){const y=s.ae(g);return s.J(y,y,[d,d,1]),n||s.ad(y,y,-l.angle),y}return l.glCoordMatrix}function se(g,t,n){let l;n?(l=[g.x,g.y,n(g.x,g.y),1],s.af(l,l,t)):(l=[g.x,g.y,0,1],ci(l,l,t));const d=l[3];return{point:new s.P(l[0]/d,l[1]/d),signedDistanceFromCamera:d}}function W(g,t){return .5+g/t*.5}function X(g,t){const n=g[0]/g[3],l=g[1]/g[3];return n>=-t[0]&&n<=t[0]&&l>=-t[1]&&l<=t[1]}function J(g,t,n,l,d,y,P,A,O,R){const N=l?g.textSizeData:g.iconSizeData,G=s.ag(N,n.transform.zoom),Z=[256/n.width*2+1,256/n.height*2+1],ce=l?g.text.dynamicLayoutVertexArray:g.icon.dynamicLayoutVertexArray;ce.clear();const oe=g.lineVertexArray,ue=l?g.text.placedSymbolArray:g.icon.placedSymbolArray,te=n.transform.width/n.transform.height;let Se=!1;for(let We=0;We<ue.length;We++){const ge=ue.get(We);if(ge.hidden||ge.writingMode===s.ah.vertical&&!Se){Jt(ge.numGlyphs,ce);continue}let ke;if(Se=!1,R?(ke=[ge.anchorX,ge.anchorY,R(ge.anchorX,ge.anchorY),1],s.af(ke,ke,t)):(ke=[ge.anchorX,ge.anchorY,0,1],ci(ke,ke,t)),!X(ke,Z)){Jt(ge.numGlyphs,ce);continue}const He=W(n.transform.cameraToCenterDistance,ke[3]),qe=s.ai(N,G,ge),rt=P?qe/He:qe*He,Ct=new s.P(ge.anchorX,ge.anchorY),_t=se(Ct,d,R).point,wt={projections:{},offsets:{}},Xt=Pe(ge,rt,!1,A,t,d,y,g.glyphOffsetArray,oe,ce,_t,Ct,wt,te,O,R);Se=Xt.useVertical,(Xt.notEnoughRoom||Se||Xt.needsFlipping&&Pe(ge,rt,!0,A,t,d,y,g.glyphOffsetArray,oe,ce,_t,Ct,wt,te,O,R).notEnoughRoom)&&Jt(ge.numGlyphs,ce)}l?g.text.dynamicLayoutVertexBuffer.updateData(ce):g.icon.dynamicLayoutVertexBuffer.updateData(ce)}function ae(g,t,n,l,d,y,P,A,O,R,N,G,Z){const ce=A.glyphStartIndex+A.numGlyphs,oe=A.lineStartIndex,ue=A.lineStartIndex+A.lineLength,te=t.getoffsetX(A.glyphStartIndex),Se=t.getoffsetX(ce-1),We=et(g*te,n,l,d,y,P,A.segment,oe,ue,O,R,N,G,Z);if(!We)return null;const ge=et(g*Se,n,l,d,y,P,A.segment,oe,ue,O,R,N,G,Z);return ge?{first:We,last:ge}:null}function Ie(g,t,n,l){return g===s.ah.horizontal&&Math.abs(n.y-t.y)>Math.abs(n.x-t.x)*l?{useVertical:!0}:(g===s.ah.vertical?t.y<n.y:t.x>n.x)?{needsFlipping:!0}:null}function Pe(g,t,n,l,d,y,P,A,O,R,N,G,Z,ce,oe,ue){const te=t/24,Se=g.lineOffsetX*te,We=g.lineOffsetY*te;let ge;if(g.numGlyphs>1){const ke=g.glyphStartIndex+g.numGlyphs,He=g.lineStartIndex,qe=g.lineStartIndex+g.lineLength,rt=ae(te,A,Se,We,n,N,G,g,O,y,Z,oe,ue);if(!rt)return{notEnoughRoom:!0};const Ct=se(rt.first.point,P,ue).point,_t=se(rt.last.point,P,ue).point;if(l&&!n){const wt=Ie(g.writingMode,Ct,_t,ce);if(wt)return wt}ge=[rt.first];for(let wt=g.glyphStartIndex+1;wt<ke-1;wt++)ge.push(et(te*A.getoffsetX(wt),Se,We,n,N,G,g.segment,He,qe,O,y,Z,oe,ue));ge.push(rt.last)}else{if(l&&!n){const He=se(G,d,ue).point,qe=g.lineStartIndex+g.segment+1,rt=new s.P(O.getx(qe),O.gety(qe)),Ct=se(rt,d,ue),_t=Ct.signedDistanceFromCamera>0?Ct.point:De(G,rt,He,1,d,ue),wt=Ie(g.writingMode,He,_t,ce);if(wt)return wt}const ke=et(te*A.getoffsetX(g.glyphStartIndex),Se,We,n,N,G,g.segment,g.lineStartIndex,g.lineStartIndex+g.lineLength,O,y,Z,oe,ue);if(!ke)return{notEnoughRoom:!0};ge=[ke]}for(const ke of ge)s.aj(R,ke.point,ke.angle);return{}}function De(g,t,n,l,d,y){const P=se(g.add(g.sub(t)._unit()),d,y).point,A=n.sub(P);return n.add(A._mult(l/A.mag()))}function be(g,t){const{projectionCache:n,lineVertexArray:l,labelPlaneMatrix:d,tileAnchorPoint:y,distanceFromAnchor:P,getElevation:A,previousVertex:O,direction:R,absOffsetX:N}=t;if(n.projections[g])return n.projections[g];const G=new s.P(l.getx(g),l.gety(g)),Z=se(G,d,A);if(Z.signedDistanceFromCamera>0)return n.projections[g]=Z.point,Z.point;const ce=g-R;return De(P===0?y:new s.P(l.getx(ce),l.gety(ce)),G,O,N-P+1,d,A)}function je(g,t,n){return g._unit()._perp()._mult(t*n)}function gt(g,t,n,l,d,y,P,A){const{projectionCache:O,direction:R}=A;if(O.offsets[g])return O.offsets[g];const N=n.add(t);if(g+R<l||g+R>=d)return O.offsets[g]=N,N;const G=be(g+R,A),Z=je(G.sub(n),P,R),ce=n.add(Z),oe=G.add(Z);return O.offsets[g]=s.ak(y,N,ce,oe)||N,O.offsets[g]}function et(g,t,n,l,d,y,P,A,O,R,N,G,Z,ce){const oe=l?g-t:g+t;let ue=oe>0?1:-1,te=0;l&&(ue*=-1,te=Math.PI),ue<0&&(te+=Math.PI);let Se,We,ge=ue>0?A+P:A+P+1,ke=d,He=d,qe=0,rt=0;const Ct=Math.abs(oe),_t=[];let wt;for(;qe+rt<=Ct;){if(ge+=ue,ge<A||ge>=O)return null;qe+=rt,He=ke,We=Se;const Ft={projectionCache:G,lineVertexArray:R,labelPlaneMatrix:N,tileAnchorPoint:y,distanceFromAnchor:qe,getElevation:ce,previousVertex:He,direction:ue,absOffsetX:Ct};if(ke=be(ge,Ft),n===0)_t.push(He),wt=ke.sub(He);else{let di;const Ci=ke.sub(He);di=Ci.mag()===0?je(be(ge+ue,Ft).sub(ke),n,ue):je(Ci,n,ue),We||(We=He.add(di)),Se=gt(ge,di,ke,A,O,We,n,Ft),_t.push(We),wt=Se.sub(We)}rt=wt.mag()}const Xt=wt._mult((Ct-qe)/rt)._add(We||He),vi=te+Math.atan2(ke.y-He.y,ke.x-He.x);return _t.push(Xt),{point:Xt,angle:Z?vi:0,path:_t}}const lt=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function Jt(g,t){for(let n=0;n<g;n++){const l=t.length;t.resize(l+4),t.float32.set(lt,3*l)}}function ci(g,t,n){const l=t[0],d=t[1];return g[0]=n[0]*l+n[4]*d+n[12],g[1]=n[1]*l+n[5]*d+n[13],g[3]=n[3]*l+n[7]*d+n[15],g}const si=100;class Mi{constructor(t,n=new ui(t.width+200,t.height+200,25),l=new ui(t.width+200,t.height+200,25)){this.transform=t,this.grid=n,this.ignoredGrid=l,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+si,this.screenBottomBoundary=t.height+si,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(t,n,l,d,y,P){const A=this.projectAndGetPerspectiveRatio(d,t.anchorPointX,t.anchorPointY,P),O=l*A.perspectiveRatio,R=t.x1*O+A.point.x,N=t.y1*O+A.point.y,G=t.x2*O+A.point.x,Z=t.y2*O+A.point.y;return!this.isInsideGrid(R,N,G,Z)||n!=="always"&&this.grid.hitTest(R,N,G,Z,n,y)||A.perspectiveRatio<this.perspectiveRatioCutoff?{box:[],offscreen:!1}:{box:[R,N,G,Z],offscreen:this.isOffscreen(R,N,G,Z)}}placeCollisionCircles(t,n,l,d,y,P,A,O,R,N,G,Z,ce,oe){const ue=[],te=new s.P(n.anchorX,n.anchorY),Se=se(te,P,oe),We=W(this.transform.cameraToCenterDistance,Se.signedDistanceFromCamera),ge=(N?y/We:y*We)/s.ao,ke=se(te,A,oe).point,He=ae(ge,d,n.lineOffsetX*ge,n.lineOffsetY*ge,!1,ke,te,n,l,A,{projections:{},offsets:{}},!1,oe);let qe=!1,rt=!1,Ct=!0;if(He){const _t=.5*Z*We+ce,wt=new s.P(-100,-100),Xt=new s.P(this.screenRightBoundary,this.screenBottomBoundary),vi=new Tr,Ft=He.first,di=He.last;let Ci=[];for(let Si=Ft.path.length-1;Si>=1;Si--)Ci.push(Ft.path[Si]);for(let Si=1;Si<di.path.length;Si++)Ci.push(di.path[Si]);const Oi=2.5*_t;if(O){const Si=Ci.map(Ti=>se(Ti,O,oe));Ci=Si.some(Ti=>Ti.signedDistanceFromCamera<=0)?[]:Si.map(Ti=>Ti.point)}let _i=[];if(Ci.length>0){const Si=Ci[0].clone(),Ti=Ci[0].clone();for(let vr=1;vr<Ci.length;vr++)Si.x=Math.min(Si.x,Ci[vr].x),Si.y=Math.min(Si.y,Ci[vr].y),Ti.x=Math.max(Ti.x,Ci[vr].x),Ti.y=Math.max(Ti.y,Ci[vr].y);_i=Si.x>=wt.x&&Ti.x<=Xt.x&&Si.y>=wt.y&&Ti.y<=Xt.y?[Ci]:Ti.x<wt.x||Si.x>Xt.x||Ti.y<wt.y||Si.y>Xt.y?[]:s.al([Ci],wt.x,wt.y,Xt.x,Xt.y)}for(const Si of _i){vi.reset(Si,.25*_t);let Ti=0;Ti=vi.length<=.5*_t?1:Math.ceil(vi.paddedLength/Oi)+1;for(let vr=0;vr<Ti;vr++){const er=vr/Math.max(Ti-1,1),In=vi.lerp(er),kr=In.x+si,rr=In.y+si;ue.push(kr,rr,_t,0);const cn=kr-_t,ss=rr-_t,vs=kr+_t,ga=rr+_t;if(Ct=Ct&&this.isOffscreen(cn,ss,vs,ga),rt=rt||this.isInsideGrid(cn,ss,vs,ga),t!=="always"&&this.grid.hitTestCircle(kr,rr,_t,t,G)&&(qe=!0,!R))return{circles:[],offscreen:!1,collisionDetected:qe}}}}return{circles:!R&&qe||!rt||We<this.perspectiveRatioCutoff?[]:ue,offscreen:Ct,collisionDetected:qe}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const n=[];let l=1/0,d=1/0,y=-1/0,P=-1/0;for(const N of t){const G=new s.P(N.x+si,N.y+si);l=Math.min(l,G.x),d=Math.min(d,G.y),y=Math.max(y,G.x),P=Math.max(P,G.y),n.push(G)}const A=this.grid.query(l,d,y,P).concat(this.ignoredGrid.query(l,d,y,P)),O={},R={};for(const N of A){const G=N.key;if(O[G.bucketInstanceId]===void 0&&(O[G.bucketInstanceId]={}),O[G.bucketInstanceId][G.featureIndex])continue;const Z=[new s.P(N.x1,N.y1),new s.P(N.x2,N.y1),new s.P(N.x2,N.y2),new s.P(N.x1,N.y2)];s.am(n,Z)&&(O[G.bucketInstanceId][G.featureIndex]=!0,R[G.bucketInstanceId]===void 0&&(R[G.bucketInstanceId]=[]),R[G.bucketInstanceId].push(G.featureIndex))}return R}insertCollisionBox(t,n,l,d,y,P){(l?this.ignoredGrid:this.grid).insert({bucketInstanceId:d,featureIndex:y,collisionGroupID:P,overlapMode:n},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,n,l,d,y,P){const A=l?this.ignoredGrid:this.grid,O={bucketInstanceId:d,featureIndex:y,collisionGroupID:P,overlapMode:n};for(let R=0;R<t.length;R+=4)A.insertCircle(O,t[R],t[R+1],t[R+2])}projectAndGetPerspectiveRatio(t,n,l,d){let y;return d?(y=[n,l,d(n,l),1],s.af(y,y,t)):(y=[n,l,0,1],ci(y,y,t)),{point:new s.P((y[0]/y[3]+1)/2*this.transform.width+si,(-y[1]/y[3]+1)/2*this.transform.height+si),perspectiveRatio:.5+this.transform.cameraToCenterDistance/y[3]*.5}}isOffscreen(t,n,l,d){return l<si||t>=this.screenRightBoundary||d<si||n>this.screenBottomBoundary}isInsideGrid(t,n,l,d){return l>=0&&t<this.gridRightBoundary&&d>=0&&n<this.gridBottomBoundary}getViewportMatrix(){const t=s.an([]);return s.H(t,t,[-100,-100,0]),t}}function pi(g,t,n){return t*(s.W/(g.tileSize*Math.pow(2,n-g.tileID.overscaledZ)))}class Xi{constructor(t,n,l,d){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?n:-n))):d&&l?1:0,this.placed=l}isHidden(){return this.opacity===0&&!this.placed}}class Zi{constructor(t,n,l,d,y){this.text=new Xi(t?t.text:null,n,l,y),this.icon=new Xi(t?t.icon:null,n,d,y)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class xr{constructor(t,n,l){this.text=t,this.icon=n,this.skipFade=l}}class ai{constructor(){this.invProjMatrix=s.F(),this.viewportMatrix=s.F(),this.circles=[]}}class hr{constructor(t,n,l,d,y){this.bucketInstanceId=t,this.featureIndex=n,this.sourceLayerIndex=l,this.bucketIndex=d,this.tileID=y}}class Mr{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const n=++this.maxGroupID;this.collisionGroups[t]={ID:n,predicate:l=>l.collisionGroupID===n}}return this.collisionGroups[t]}}function nn(g,t,n,l,d){const{horizontalAlign:y,verticalAlign:P}=s.at(g);return new s.P(-(y-.5)*t+l[0]*d,-(P-.5)*n+l[1]*d)}function Fr(g,t,n,l,d,y){const{x1:P,x2:A,y1:O,y2:R,anchorPointX:N,anchorPointY:G}=g,Z=new s.P(t,n);return l&&Z._rotate(d?y:-y),{x1:P+Z.x,y1:O+Z.y,x2:A+Z.x,y2:R+Z.y,anchorPointX:N,anchorPointY:G}}class Yr{constructor(t,n,l,d,y){this.transform=t.clone(),this.terrain=n,this.collisionIndex=new Mi(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=l,this.retainedQueryData={},this.collisionGroups=new Mr(d),this.collisionCircleArrays={},this.prevPlacement=y,y&&(y.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,n,l,d){const y=l.getBucket(n),P=l.latestFeatureIndex;if(!y||!P||n.id!==y.layerIds[0])return;const A=l.collisionBoxArray,O=y.layers[0].layout,R=Math.pow(2,this.transform.zoom-l.tileID.overscaledZ),N=l.tileSize/s.W,G=this.transform.calculatePosMatrix(l.tileID.toUnwrapped()),Z=O.get("text-pitch-alignment")==="map",ce=O.get("text-rotation-alignment")==="map",oe=pi(l,1,this.transform.zoom),ue=wn(G,Z,ce,this.transform,oe);let te=null;if(Z){const We=$r(G,Z,ce,this.transform,oe);te=s.K([],this.transform.labelPlaneMatrix,We)}this.retainedQueryData[y.bucketInstanceId]=new hr(y.bucketInstanceId,P,y.sourceLayerIndex,y.index,l.tileID);const Se={bucket:y,layout:O,posMatrix:G,textLabelPlaneMatrix:ue,labelToScreenMatrix:te,scale:R,textPixelRatio:N,holdingForFade:l.holdingForFade(),collisionBoxArray:A,partiallyEvaluatedTextSize:s.ag(y.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(y.sourceID)};if(d)for(const We of y.sortKeyRanges){const{sortKey:ge,symbolInstanceStart:ke,symbolInstanceEnd:He}=We;t.push({sortKey:ge,symbolInstanceStart:ke,symbolInstanceEnd:He,parameters:Se})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:y.symbolInstances.length,parameters:Se})}attemptAnchorPlacement(t,n,l,d,y,P,A,O,R,N,G,Z,ce,oe,ue,te){const Se=s.ap[t.textAnchor],We=[t.textOffset0,t.textOffset1],ge=nn(Se,l,d,We,y),ke=this.collisionIndex.placeCollisionBox(Fr(n,ge.x,ge.y,P,A,this.transform.angle),G,O,R,N.predicate,te);if((!ue||this.collisionIndex.placeCollisionBox(Fr(ue,ge.x,ge.y,P,A,this.transform.angle),G,O,R,N.predicate,te).box.length!==0)&&ke.box.length>0){let He;if(this.prevPlacement&&this.prevPlacement.variableOffsets[Z.crossTileID]&&this.prevPlacement.placements[Z.crossTileID]&&this.prevPlacement.placements[Z.crossTileID].text&&(He=this.prevPlacement.variableOffsets[Z.crossTileID].anchor),Z.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[Z.crossTileID]={textOffset:We,width:l,height:d,anchor:Se,textBoxScale:y,prevAnchor:He},this.markUsedJustification(ce,Se,Z,oe),ce.allowVerticalPlacement&&(this.markUsedOrientation(ce,oe,Z),this.placedOrientations[Z.crossTileID]=oe),{shift:ge,placedGlyphBoxes:ke}}}placeLayerBucketPart(t,n,l){const{bucket:d,layout:y,posMatrix:P,textLabelPlaneMatrix:A,labelToScreenMatrix:O,textPixelRatio:R,holdingForFade:N,collisionBoxArray:G,partiallyEvaluatedTextSize:Z,collisionGroup:ce}=t.parameters,oe=y.get("text-optional"),ue=y.get("icon-optional"),te=s.aq(y,"text-overlap","text-allow-overlap"),Se=te==="always",We=s.aq(y,"icon-overlap","icon-allow-overlap"),ge=We==="always",ke=y.get("text-rotation-alignment")==="map",He=y.get("text-pitch-alignment")==="map",qe=y.get("icon-text-fit")!=="none",rt=y.get("symbol-z-order")==="viewport-y",Ct=Se&&(ge||!d.hasIconData()||ue),_t=ge&&(Se||!d.hasTextData()||oe);!d.collisionArrays&&G&&d.deserializeCollisionBoxes(G);const wt=this.retainedQueryData[d.bucketInstanceId].tileID,Xt=this.terrain?(Ft,di)=>this.terrain.getElevation(wt,Ft,di):null,vi=(Ft,di)=>{var Ci,Oi;if(n[Ft.crossTileID])return;if(N)return void(this.placements[Ft.crossTileID]=new xr(!1,!1,!1));let _i=!1,Si=!1,Ti=!0,vr=null,er={box:null,offscreen:null},In={box:null,offscreen:null},kr=null,rr=null,cn=null,ss=0,vs=0,ga=0;di.textFeatureIndex?ss=di.textFeatureIndex:Ft.useRuntimeCollisionCircles&&(ss=Ft.featureIndex),di.verticalTextFeatureIndex&&(vs=di.verticalTextFeatureIndex);const _a=di.textBox;if(_a){const Sr=pr=>{let Xr=s.ah.horizontal;if(d.allowVerticalPlacement&&!pr&&this.prevPlacement){const Fn=this.prevPlacement.placedOrientations[Ft.crossTileID];Fn&&(this.placedOrientations[Ft.crossTileID]=Fn,Xr=Fn,this.markUsedOrientation(d,Xr,Ft))}return Xr},or=(pr,Xr)=>{if(d.allowVerticalPlacement&&Ft.numVerticalGlyphVertices>0&&di.verticalTextBox){for(const Fn of d.writingModes)if(Fn===s.ah.vertical?(er=Xr(),In=er):er=pr(),er&&er.box&&er.box.length)break}else er=pr()},Ir=Ft.textAnchorOffsetStartIndex,Ha=Ft.textAnchorOffsetEndIndex;if(Ha===Ir){const pr=(Xr,Fn)=>{const Di=this.collisionIndex.placeCollisionBox(Xr,te,R,P,ce.predicate,Xt);return Di&&Di.box&&Di.box.length&&(this.markUsedOrientation(d,Fn,Ft),this.placedOrientations[Ft.crossTileID]=Fn),Di};or(()=>pr(_a,s.ah.horizontal),()=>{const Xr=di.verticalTextBox;return d.allowVerticalPlacement&&Ft.numVerticalGlyphVertices>0&&Xr?pr(Xr,s.ah.vertical):{box:null,offscreen:null}}),Sr(er&&er.box&&er.box.length)}else{let pr=s.ap[(Oi=(Ci=this.prevPlacement)===null||Ci===void 0?void 0:Ci.variableOffsets[Ft.crossTileID])===null||Oi===void 0?void 0:Oi.anchor];const Xr=(Di,Ml,sc)=>{const ya=Di.x2-Di.x1,va=Di.y2-Di.y1,$o=Ft.textBoxScale,kl=qe&&We==="never"?Ml:null;let xa={box:[],offscreen:!1},ac=te==="never"?1:2,Dl="never";pr&&ac++;for(let oc=0;oc<ac;oc++){for(let xo=Ir;xo<Ha;xo++){const lc=d.textAnchorOffsets.get(xo);if(pr&&lc.textAnchor!==pr)continue;const bo=this.attemptAnchorPlacement(lc,Di,ya,va,$o,ke,He,R,P,ce,Dl,Ft,d,sc,kl,Xt);if(bo&&(xa=bo.placedGlyphBoxes,xa&&xa.box&&xa.box.length))return _i=!0,vr=bo.shift,xa}pr?pr=null:Dl=te}return xa};or(()=>Xr(_a,di.iconBox,s.ah.horizontal),()=>{const Di=di.verticalTextBox;return d.allowVerticalPlacement&&!(er&&er.box&&er.box.length)&&Ft.numVerticalGlyphVertices>0&&Di?Xr(Di,di.verticalIconBox,s.ah.vertical):{box:null,offscreen:null}}),er&&(_i=er.box,Ti=er.offscreen);const Fn=Sr(er&&er.box);if(!_i&&this.prevPlacement){const Di=this.prevPlacement.variableOffsets[Ft.crossTileID];Di&&(this.variableOffsets[Ft.crossTileID]=Di,this.markUsedJustification(d,Di.anchor,Ft,Fn))}}}if(kr=er,_i=kr&&kr.box&&kr.box.length>0,Ti=kr&&kr.offscreen,Ft.useRuntimeCollisionCircles){const Sr=d.text.placedSymbolArray.get(Ft.centerJustifiedTextSymbolIndex),or=s.ai(d.textSizeData,Z,Sr),Ir=y.get("text-padding");rr=this.collisionIndex.placeCollisionCircles(te,Sr,d.lineVertexArray,d.glyphOffsetArray,or,P,A,O,l,He,ce.predicate,Ft.collisionCircleDiameter,Ir,Xt),rr.circles.length&&rr.collisionDetected&&!l&&s.w("Collisions detected, but collision boxes are not shown"),_i=Se||rr.circles.length>0&&!rr.collisionDetected,Ti=Ti&&rr.offscreen}if(di.iconFeatureIndex&&(ga=di.iconFeatureIndex),di.iconBox){const Sr=or=>{const Ir=qe&&vr?Fr(or,vr.x,vr.y,ke,He,this.transform.angle):or;return this.collisionIndex.placeCollisionBox(Ir,We,R,P,ce.predicate,Xt)};In&&In.box&&In.box.length&&di.verticalIconBox?(cn=Sr(di.verticalIconBox),Si=cn.box.length>0):(cn=Sr(di.iconBox),Si=cn.box.length>0),Ti=Ti&&cn.offscreen}const xs=oe||Ft.numHorizontalGlyphVertices===0&&Ft.numVerticalGlyphVertices===0,as=ue||Ft.numIconVertices===0;if(xs||as?as?xs||(Si=Si&&_i):_i=Si&&_i:Si=_i=Si&&_i,_i&&kr&&kr.box&&this.collisionIndex.insertCollisionBox(kr.box,te,y.get("text-ignore-placement"),d.bucketInstanceId,In&&In.box&&vs?vs:ss,ce.ID),Si&&cn&&this.collisionIndex.insertCollisionBox(cn.box,We,y.get("icon-ignore-placement"),d.bucketInstanceId,ga,ce.ID),rr&&(_i&&this.collisionIndex.insertCollisionCircles(rr.circles,te,y.get("text-ignore-placement"),d.bucketInstanceId,ss,ce.ID),l)){const Sr=d.bucketInstanceId;let or=this.collisionCircleArrays[Sr];or===void 0&&(or=this.collisionCircleArrays[Sr]=new ai);for(let Ir=0;Ir<rr.circles.length;Ir+=4)or.circles.push(rr.circles[Ir+0]),or.circles.push(rr.circles[Ir+1]),or.circles.push(rr.circles[Ir+2]),or.circles.push(rr.collisionDetected?1:0)}if(Ft.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(d.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[Ft.crossTileID]=new xr(_i||Ct,Si||_t,Ti||d.justReloaded),n[Ft.crossTileID]=!0};if(rt){if(t.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const Ft=d.getSortedSymbolIndexes(this.transform.angle);for(let di=Ft.length-1;di>=0;--di){const Ci=Ft[di];vi(d.symbolInstances.get(Ci),d.collisionArrays[Ci])}}else for(let Ft=t.symbolInstanceStart;Ft<t.symbolInstanceEnd;Ft++)vi(d.symbolInstances.get(Ft),d.collisionArrays[Ft]);if(l&&d.bucketInstanceId in this.collisionCircleArrays){const Ft=this.collisionCircleArrays[d.bucketInstanceId];s.ar(Ft.invProjMatrix,P),Ft.viewportMatrix=this.collisionIndex.getViewportMatrix()}d.justReloaded=!1}markUsedJustification(t,n,l,d){let y;y=d===s.ah.vertical?l.verticalPlacedTextSymbolIndex:{left:l.leftJustifiedTextSymbolIndex,center:l.centerJustifiedTextSymbolIndex,right:l.rightJustifiedTextSymbolIndex}[s.as(n)];const P=[l.leftJustifiedTextSymbolIndex,l.centerJustifiedTextSymbolIndex,l.rightJustifiedTextSymbolIndex,l.verticalPlacedTextSymbolIndex];for(const A of P)A>=0&&(t.text.placedSymbolArray.get(A).crossTileID=y>=0&&A!==y?0:l.crossTileID)}markUsedOrientation(t,n,l){const d=n===s.ah.horizontal||n===s.ah.horizontalOnly?n:0,y=n===s.ah.vertical?n:0,P=[l.leftJustifiedTextSymbolIndex,l.centerJustifiedTextSymbolIndex,l.rightJustifiedTextSymbolIndex];for(const A of P)t.text.placedSymbolArray.get(A).placedOrientation=d;l.verticalPlacedTextSymbolIndex&&(t.text.placedSymbolArray.get(l.verticalPlacedTextSymbolIndex).placedOrientation=y)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const n=this.prevPlacement;let l=!1;this.prevZoomAdjustment=n?n.zoomAdjustment(this.transform.zoom):0;const d=n?n.symbolFadeChange(t):1,y=n?n.opacities:{},P=n?n.variableOffsets:{},A=n?n.placedOrientations:{};for(const O in this.placements){const R=this.placements[O],N=y[O];N?(this.opacities[O]=new Zi(N,d,R.text,R.icon),l=l||R.text!==N.text.placed||R.icon!==N.icon.placed):(this.opacities[O]=new Zi(null,d,R.text,R.icon,R.skipFade),l=l||R.text||R.icon)}for(const O in y){const R=y[O];if(!this.opacities[O]){const N=new Zi(R,d,!1,!1);N.isHidden()||(this.opacities[O]=N,l=l||R.text.placed||R.icon.placed)}}for(const O in P)this.variableOffsets[O]||!this.opacities[O]||this.opacities[O].isHidden()||(this.variableOffsets[O]=P[O]);for(const O in A)this.placedOrientations[O]||!this.opacities[O]||this.opacities[O].isHidden()||(this.placedOrientations[O]=A[O]);if(n&&n.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");l?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=n?n.lastPlacementChangeTime:t)}updateLayerOpacities(t,n){const l={};for(const d of n){const y=d.getBucket(t);y&&d.latestFeatureIndex&&t.id===y.layerIds[0]&&this.updateBucketOpacities(y,l,d.collisionBoxArray)}}updateBucketOpacities(t,n,l){t.hasTextData()&&(t.text.opacityVertexArray.clear(),t.text.hasVisibleVertices=!1),t.hasIconData()&&(t.icon.opacityVertexArray.clear(),t.icon.hasVisibleVertices=!1),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const d=t.layers[0],y=d.layout,P=new Zi(null,0,!1,!1,!0),A=y.get("text-allow-overlap"),O=y.get("icon-allow-overlap"),R=d._unevaluatedLayout.hasValue("text-variable-anchor")||d._unevaluatedLayout.hasValue("text-variable-anchor-offset"),N=y.get("text-rotation-alignment")==="map",G=y.get("text-pitch-alignment")==="map",Z=y.get("icon-text-fit")!=="none",ce=new Zi(null,0,A&&(O||!t.hasIconData()||y.get("icon-optional")),O&&(A||!t.hasTextData()||y.get("text-optional")),!0);!t.collisionArrays&&l&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(l);const oe=(ue,te,Se)=>{for(let We=0;We<te/4;We++)ue.opacityVertexArray.emplaceBack(Se);ue.hasVisibleVertices=ue.hasVisibleVertices||Se!==tr};for(let ue=0;ue<t.symbolInstances.length;ue++){const te=t.symbolInstances.get(ue),{numHorizontalGlyphVertices:Se,numVerticalGlyphVertices:We,crossTileID:ge}=te;let ke=this.opacities[ge];n[ge]?ke=P:ke||(ke=ce,this.opacities[ge]=ke),n[ge]=!0;const He=te.numIconVertices>0,qe=this.placedOrientations[te.crossTileID],rt=qe===s.ah.vertical,Ct=qe===s.ah.horizontal||qe===s.ah.horizontalOnly;if(Se>0||We>0){const _t=Jn(ke.text);oe(t.text,Se,rt?tr:_t),oe(t.text,We,Ct?tr:_t);const wt=ke.text.isHidden();[te.rightJustifiedTextSymbolIndex,te.centerJustifiedTextSymbolIndex,te.leftJustifiedTextSymbolIndex].forEach(Ft=>{Ft>=0&&(t.text.placedSymbolArray.get(Ft).hidden=wt||rt?1:0)}),te.verticalPlacedTextSymbolIndex>=0&&(t.text.placedSymbolArray.get(te.verticalPlacedTextSymbolIndex).hidden=wt||Ct?1:0);const Xt=this.variableOffsets[te.crossTileID];Xt&&this.markUsedJustification(t,Xt.anchor,te,qe);const vi=this.placedOrientations[te.crossTileID];vi&&(this.markUsedJustification(t,"left",te,vi),this.markUsedOrientation(t,vi,te))}if(He){const _t=Jn(ke.icon),wt=!(Z&&te.verticalPlacedIconSymbolIndex&&rt);te.placedIconSymbolIndex>=0&&(oe(t.icon,te.numIconVertices,wt?_t:tr),t.icon.placedSymbolArray.get(te.placedIconSymbolIndex).hidden=ke.icon.isHidden()),te.verticalPlacedIconSymbolIndex>=0&&(oe(t.icon,te.numVerticalIconVertices,wt?tr:_t),t.icon.placedSymbolArray.get(te.verticalPlacedIconSymbolIndex).hidden=ke.icon.isHidden())}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const _t=t.collisionArrays[ue];if(_t){let wt=new s.P(0,0);if(_t.textBox||_t.verticalTextBox){let vi=!0;if(R){const Ft=this.variableOffsets[ge];Ft?(wt=nn(Ft.anchor,Ft.width,Ft.height,Ft.textOffset,Ft.textBoxScale),N&&wt._rotate(G?this.transform.angle:-this.transform.angle)):vi=!1}_t.textBox&&Zr(t.textCollisionBox.collisionVertexArray,ke.text.placed,!vi||rt,wt.x,wt.y),_t.verticalTextBox&&Zr(t.textCollisionBox.collisionVertexArray,ke.text.placed,!vi||Ct,wt.x,wt.y)}const Xt=!!(!Ct&&_t.verticalIconBox);_t.iconBox&&Zr(t.iconCollisionBox.collisionVertexArray,ke.icon.placed,Xt,Z?wt.x:0,Z?wt.y:0),_t.verticalIconBox&&Zr(t.iconCollisionBox.collisionVertexArray,ke.icon.placed,!Xt,Z?wt.x:0,Z?wt.y:0)}}}if(t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.text.opacityVertexArray.length!==t.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${t.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${t.text.layoutVertexArray.length}) / 4`);if(t.icon.opacityVertexArray.length!==t.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${t.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${t.icon.layoutVertexArray.length}) / 4`);if(t.bucketInstanceId in this.collisionCircleArrays){const ue=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=ue.invProjMatrix,t.placementViewportMatrix=ue.viewportMatrix,t.collisionCircleArray=ue.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,n){const l=this.zoomAtLastRecencyCheck===n?1-this.zoomAdjustment(n):1;return this.zoomAtLastRecencyCheck=n,this.commitTime+this.fadeDuration*l>t}setStale(){this.stale=!0}}function Zr(g,t,n,l,d){g.emplaceBack(t?1:0,n?1:0,l||0,d||0),g.emplaceBack(t?1:0,n?1:0,l||0,d||0),g.emplaceBack(t?1:0,n?1:0,l||0,d||0),g.emplaceBack(t?1:0,n?1:0,l||0,d||0)}const Do=Math.pow(2,25),Ta=Math.pow(2,24),Ni=Math.pow(2,17),sa=Math.pow(2,16),br=Math.pow(2,9),sn=Math.pow(2,8),an=Math.pow(2,1);function Jn(g){if(g.opacity===0&&!g.placed)return 0;if(g.opacity===1&&g.placed)return 4294967295;const t=g.placed?1:0,n=Math.floor(127*g.opacity);return n*Do+t*Ta+n*Ni+t*sa+n*br+t*sn+n*an+t}const tr=0;class Kr{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&!t.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(t,n,l,d,y){const P=this._bucketParts;for(;this._currentTileIndex<t.length;)if(n.getBucketParts(P,d,t[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,y())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,P.sort((A,O)=>A.sortKey-O.sortKey));this._currentPartIndex<P.length;)if(n.placeLayerBucketPart(P[this._currentPartIndex],this._seenCrossTileIDs,l),this._currentPartIndex++,y())return!0;return!1}}class us{constructor(t,n,l,d,y,P,A,O){this.placement=new Yr(t,n,P,A,O),this._currentPlacementIndex=l.length-1,this._forceFullPlacement=d,this._showCollisionBoxes=y,this._done=!1}isDone(){return this._done}continuePlacement(t,n,l){const d=o.now(),y=()=>!this._forceFullPlacement&&o.now()-d>2;for(;this._currentPlacementIndex>=0;){const P=n[t[this._currentPlacementIndex]],A=this.placement.collisionIndex.transform.zoom;if(P.type==="symbol"&&(!P.minzoom||P.minzoom<=A)&&(!P.maxzoom||P.maxzoom>A)){if(this._inProgressLayer||(this._inProgressLayer=new Kr(P)),this._inProgressLayer.continuePlacement(l[P.source],this.placement,this._showCollisionBoxes,P,y))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const on=512/s.W/2;class wr{constructor(t,n,l){this.tileID=t,this.bucketInstanceId=l,this._symbolsByKey={};const d=new Map;for(let y=0;y<n.length;y++){const P=n.get(y),A=P.key,O=d.get(A);O?O.push(P):d.set(A,[P])}for(const[y,P]of d){const A={positions:P.map(O=>({x:Math.floor(O.anchorX*on),y:Math.floor(O.anchorY*on)})),crossTileIDs:P.map(O=>O.crossTileID)};if(A.positions.length>128){const O=new s.au(A.positions.length,16,Uint16Array);for(const{x:R,y:N}of A.positions)O.add(R,N);O.finish(),delete A.positions,A.index=O}this._symbolsByKey[y]=A}}getScaledCoordinates(t,n){const{x:l,y:d,z:y}=this.tileID.canonical,{x:P,y:A,z:O}=n.canonical,R=on/Math.pow(2,O-y),N=(A*s.W+t.anchorY)*R,G=d*s.W*on;return{x:Math.floor((P*s.W+t.anchorX)*R-l*s.W*on),y:Math.floor(N-G)}}findMatches(t,n,l){const d=this.tileID.canonical.z<n.canonical.z?1:Math.pow(2,this.tileID.canonical.z-n.canonical.z);for(let y=0;y<t.length;y++){const P=t.get(y);if(P.crossTileID)continue;const A=this._symbolsByKey[P.key];if(!A)continue;const O=this.getScaledCoordinates(P,n);if(A.index){const R=A.index.range(O.x-d,O.y-d,O.x+d,O.y+d).sort();for(const N of R){const G=A.crossTileIDs[N];if(!l[G]){l[G]=!0,P.crossTileID=G;break}}}else if(A.positions)for(let R=0;R<A.positions.length;R++){const N=A.positions[R],G=A.crossTileIDs[R];if(Math.abs(N.x-O.x)<=d&&Math.abs(N.y-O.y)<=d&&!l[G]){l[G]=!0,P.crossTileID=G;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map(({crossTileIDs:t})=>t)}}class aa{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Cs{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const n=Math.round((t-this.lng)/360);if(n!==0)for(const l in this.indexes){const d=this.indexes[l],y={};for(const P in d){const A=d[P];A.tileID=A.tileID.unwrapTo(A.tileID.wrap+n),y[A.tileID.key]=A}this.indexes[l]=y}this.lng=t}addBucket(t,n,l){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===n.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let y=0;y<n.symbolInstances.length;y++)n.symbolInstances.get(y).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]={});const d=this.usedCrossTileIDs[t.overscaledZ];for(const y in this.indexes){const P=this.indexes[y];if(Number(y)>t.overscaledZ)for(const A in P){const O=P[A];O.tileID.isChildOf(t)&&O.findMatches(n.symbolInstances,t,d)}else{const A=P[t.scaledTo(Number(y)).key];A&&A.findMatches(n.symbolInstances,t,d)}}for(let y=0;y<n.symbolInstances.length;y++){const P=n.symbolInstances.get(y);P.crossTileID||(P.crossTileID=l.generate(),d[P.crossTileID]=!0)}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new wr(t,n.symbolInstances,n.bucketInstanceId),!0}removeBucketCrossTileIDs(t,n){for(const l of n.getCrossTileIDsLists())for(const d of l)delete this.usedCrossTileIDs[t][d]}removeStaleBuckets(t){let n=!1;for(const l in this.indexes){const d=this.indexes[l];for(const y in d)t[d[y].bucketInstanceId]||(this.removeBucketCrossTileIDs(l,d[y]),delete d[y],n=!0)}return n}}class gr{constructor(){this.layerIndexes={},this.crossTileIDs=new aa,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,n,l){let d=this.layerIndexes[t.id];d===void 0&&(d=this.layerIndexes[t.id]=new Cs);let y=!1;const P={};d.handleWrapJump(l);for(const A of n){const O=A.getBucket(t);O&&t.id===O.layerIds[0]&&(O.bucketInstanceId||(O.bucketInstanceId=++this.maxBucketInstanceId),d.addBucket(A.tileID,O,this.crossTileIDs)&&(y=!0),P[O.bucketInstanceId]=!0)}return d.removeStaleBuckets(P)&&(y=!0),y}pruneUnusedLayers(t){const n={};t.forEach(l=>{n[l]=!0});for(const l in this.layerIndexes)n[l]||delete this.layerIndexes[l]}}const ds=(g,t)=>s.t(g,t&&t.filter(n=>n.identifier!=="source.canvas")),fn=s.av();class oa extends s.E{constructor(t,n={}){super(),this._rtlPluginLoaded=()=>{for(const l in this.sourceCaches){const d=this.sourceCaches[l].getSource().type;d!=="vector"&&d!=="geojson"||this.sourceCaches[l].reload()}},this.map=t,this.dispatcher=new Ue(Je(),t._getMapId()),this.dispatcher.registerMessageHandler("getGlyphs",(l,d)=>this.getGlyphs(l,d)),this.dispatcher.registerMessageHandler("getImages",(l,d)=>this.getImages(l,d)),this.imageManager=new ot,this.imageManager.setEventedParent(this),this.glyphManager=new Et(t._requestManager,n.localIdeographFontFamily),this.lineAtlas=new pe(256,512),this.crossTileSymbolIndex=new gr,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new s.aw,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("setReferrer",s.ax()),Hi().on(fi,this._rtlPluginLoaded),this.on("data",l=>{if(l.dataType!=="source"||l.sourceDataType!=="metadata")return;const d=this.sourceCaches[l.sourceId];if(!d)return;const y=d.getSource();if(y&&y.vectorLayerIds)for(const P in this._layers){const A=this._layers[P];A.source===y.id&&this._validateLayer(A)}})}loadURL(t,n={},l){this.fire(new s.k("dataloading",{dataType:"style"})),n.validate=typeof n.validate!="boolean"||n.validate;const d=this.map._requestManager.transformRequest(t,L.Style);this._loadStyleRequest=new AbortController,s.h(d,this._loadStyleRequest).then(y=>{this._loadStyleRequest=null,this._load(y.data,n,l)}).catch(y=>{this._loadStyleRequest=null,y&&this.fire(new s.j(y))})}loadJSON(t,n={},l){this.fire(new s.k("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,o.frameAsync(this._frameRequest).then(()=>{this._frameRequest=null,n.validate=n.validate!==!1,this._load(t,n,l)}).catch(()=>{})}loadEmpty(){this.fire(new s.k("dataloading",{dataType:"style"})),this._load(fn,{validate:!1})}_load(t,n,l){var d;const y=n.transformStyle?n.transformStyle(l,t):t;if(!n.validate||!ds(this,s.x(y))){this._loaded=!0,this.stylesheet=y;for(const P in y.sources)this.addSource(P,y.sources[P],{validate:!1});y.sprite?this._loadSprite(y.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(y.glyphs),this._createLayers(),this.light=new _e(this.stylesheet.light),this.map.setTerrain((d=this.stylesheet.terrain)!==null&&d!==void 0?d:null),this.fire(new s.k("data",{dataType:"style"})),this.fire(new s.k("style.load"))}}_createLayers(){const t=s.ay(this.stylesheet.layers);this.dispatcher.broadcast("setLayers",t),this._order=t.map(n=>n.id),this._layers={},this._serializedLayers=null;for(const n of t){const l=s.az(n);l.setEventedParent(this,{layer:{id:n.id}}),this._layers[n.id]=l}}_loadSprite(t,n=!1,l=void 0){let d;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,function(y,P,A,O){return s._(this,void 0,void 0,function*(){const R=at(y),N=A>1?"@2x":"",G={},Z={};for(const{id:ce,url:oe}of R){const ue=P.transformRequest(P.normalizeSpriteURL(oe,N,".json"),L.SpriteJSON);G[ce]=s.h(ue,O);const te=P.transformRequest(P.normalizeSpriteURL(oe,N,".png"),L.SpriteImage);Z[ce]=D.getImage(te,O)}return yield Promise.all([...Object.values(G),...Object.values(Z)]),function(ce,oe){return s._(this,void 0,void 0,function*(){const ue={};for(const te in ce){ue[te]={};const Se=o.getImageCanvasContext((yield oe[te]).data),We=(yield ce[te]).data;for(const ge in We){const{width:ke,height:He,x:qe,y:rt,sdf:Ct,pixelRatio:_t,stretchX:wt,stretchY:Xt,content:vi}=We[ge];ue[te][ge]={data:null,pixelRatio:_t,sdf:Ct,stretchX:wt,stretchY:Xt,content:vi,spriteData:{width:ke,height:He,x:qe,y:rt,context:Se}}}}return ue})}(G,Z)})}(t,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then(y=>{if(this._spriteRequest=null,y)for(const P in y){this._spritesImagesIds[P]=[];const A=this._spritesImagesIds[P]?this._spritesImagesIds[P].filter(O=>!(O in y)):[];for(const O of A)this.imageManager.removeImage(O),this._changedImages[O]=!0;for(const O in y[P]){const R=P==="default"?O:`${P}:${O}`;this._spritesImagesIds[P].push(R),R in this.imageManager.images?this.imageManager.updateImage(R,y[P][O],!1):this.imageManager.addImage(R,y[P][O]),n&&(this._changedImages[R]=!0)}}}).catch(y=>{this._spriteRequest=null,d=y,this.fire(new s.j(d))}).finally(()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),n&&(this._changed=!0),this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new s.k("data",{dataType:"style"})),l&&l(d)})}_unloadSprite(){for(const t of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(t),this._changedImages[t]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new s.k("data",{dataType:"style"}))}_validateLayer(t){const n=this.sourceCaches[t.source];if(!n)return;const l=t.sourceLayer;if(!l)return;const d=n.getSource();(d.type==="geojson"||d.vectorLayerIds&&d.vectorLayerIds.indexOf(l)===-1)&&this.fire(new s.j(new Error(`Source layer "${l}" does not exist on source "${d.id}" as specified by style layer "${t.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const t in this.sourceCaches)if(!this.sourceCaches[t].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(t){const n=this._serializedAllLayers();if(!t||t.length===0)return Object.values(n);const l=[];for(const d of t)n[d]&&l.push(n[d]);return l}_serializedAllLayers(){let t=this._serializedLayers;if(t)return t;t=this._serializedLayers={};const n=Object.keys(this._layers);for(const l of n){const d=this._layers[l];d.type!=="custom"&&(t[l]=d.serialize())}return t}hasTransitions(){if(this.light&&this.light.hasTransition())return!0;for(const t in this.sourceCaches)if(this.sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(t){if(!this._loaded)return;const n=this._changed;if(this._changed){const d=Object.keys(this._updatedLayers),y=Object.keys(this._removedLayers);(d.length||y.length)&&this._updateWorkerLayers(d,y);for(const P in this._updatedSources){const A=this._updatedSources[P];if(A==="reload")this._reloadSource(P);else{if(A!=="clear")throw new Error(`Invalid action ${A}`);this._clearSource(P)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const P in this._updatedPaintProps)this._layers[P].updateTransitions(t);this.light.updateTransitions(t),this._resetUpdates()}const l={};for(const d in this.sourceCaches){const y=this.sourceCaches[d];l[d]=y.used,y.used=!1}for(const d of this._order){const y=this._layers[d];y.recalculate(t,this._availableImages),!y.isHidden(t.zoom)&&y.source&&(this.sourceCaches[y.source].used=!0)}for(const d in l){const y=this.sourceCaches[d];l[d]!==y.used&&y.fire(new s.k("data",{sourceDataType:"visibility",dataType:"source",sourceId:d}))}this.light.recalculate(t),this.z=t.zoom,n&&this.fire(new s.k("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=Object.keys(this._changedImages);if(t.length){for(const n in this.sourceCaches)this.sourceCaches[n].reloadTilesForDependencies(["icons","patterns"],t);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const t in this.sourceCaches)this.sourceCaches[t].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(t,n){this.dispatcher.broadcast("updateLayers",{layers:this._serializeByIds(t),removedIds:n})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(t,n={}){var l;this._checkLoaded();const d=this.serialize();if(t=n.transformStyle?n.transformStyle(d,t):t,((l=n.validate)===null||l===void 0||l)&&ds(this,s.x(t)))return!1;(t=s.aA(t)).layers=s.ay(t.layers);const y=s.aB(d,t),P=this._getOperationsToPerform(y);if(P.unimplemented.length>0)throw new Error(`Unimplemented: ${P.unimplemented.join(", ")}.`);if(P.operations.length===0)return!1;for(const A of P.operations)A();return this.stylesheet=t,this._serializedLayers=null,!0}_getOperationsToPerform(t){const n=[],l=[];for(const d of t)switch(d.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":continue;case"addLayer":n.push(()=>this.addLayer.apply(this,d.args));break;case"removeLayer":n.push(()=>this.removeLayer.apply(this,d.args));break;case"setPaintProperty":n.push(()=>this.setPaintProperty.apply(this,d.args));break;case"setLayoutProperty":n.push(()=>this.setLayoutProperty.apply(this,d.args));break;case"setFilter":n.push(()=>this.setFilter.apply(this,d.args));break;case"addSource":n.push(()=>this.addSource.apply(this,d.args));break;case"removeSource":n.push(()=>this.removeSource.apply(this,d.args));break;case"setLayerZoomRange":n.push(()=>this.setLayerZoomRange.apply(this,d.args));break;case"setLight":n.push(()=>this.setLight.apply(this,d.args));break;case"setGeoJSONSourceData":n.push(()=>this.setGeoJSONSourceData.apply(this,d.args));break;case"setGlyphs":n.push(()=>this.setGlyphs.apply(this,d.args));break;case"setSprite":n.push(()=>this.setSprite.apply(this,d.args));break;case"setTerrain":n.push(()=>this.map.setTerrain.apply(this,d.args));break;case"setTransition":n.push(()=>{});break;default:l.push(d.command)}return{operations:n,unimplemented:l}}addImage(t,n){if(this.getImage(t))return this.fire(new s.j(new Error(`An image named "${t}" already exists.`)));this.imageManager.addImage(t,n),this._afterImageUpdated(t)}updateImage(t,n){this.imageManager.updateImage(t,n)}getImage(t){return this.imageManager.getImage(t)}removeImage(t){if(!this.getImage(t))return this.fire(new s.j(new Error(`An image named "${t}" does not exist.`)));this.imageManager.removeImage(t),this._afterImageUpdated(t)}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(),this._changedImages[t]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new s.k("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(t,n,l={}){if(this._checkLoaded(),this.sourceCaches[t]!==void 0)throw new Error(`Source "${t}" already exists.`);if(!n.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(n).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(n.type)>=0&&this._validate(s.x.source,`sources.${t}`,n,null,l))return;this.map&&this.map._collectResourceTiming&&(n.collectResourceTiming=!0);const d=this.sourceCaches[t]=new xt(t,n,this.dispatcher);d.style=this,d.setEventedParent(this,()=>({isSourceLoaded:d.loaded(),source:d.serialize(),sourceId:t})),d.onAdd(this.map),this._changed=!0}removeSource(t){if(this._checkLoaded(),this.sourceCaches[t]===void 0)throw new Error("There is no source with this ID");for(const l in this._layers)if(this._layers[l].source===t)return this.fire(new s.j(new Error(`Source "${t}" cannot be removed while layer "${l}" is using it.`)));const n=this.sourceCaches[t];delete this.sourceCaches[t],delete this._updatedSources[t],n.fire(new s.k("data",{sourceDataType:"metadata",dataType:"source",sourceId:t})),n.setEventedParent(null),n.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(t,n){if(this._checkLoaded(),this.sourceCaches[t]===void 0)throw new Error(`There is no source with this ID=${t}`);const l=this.sourceCaches[t].getSource();if(l.type!=="geojson")throw new Error(`geojsonSource.type is ${l.type}, which is !== 'geojson`);l.setData(n),this._changed=!0}getSource(t){return this.sourceCaches[t]&&this.sourceCaches[t].getSource()}addLayer(t,n,l={}){this._checkLoaded();const d=t.id;if(this.getLayer(d))return void this.fire(new s.j(new Error(`Layer "${d}" already exists on this map.`)));let y;if(t.type==="custom"){if(ds(this,s.aC(t)))return;y=s.az(t)}else{if("source"in t&&typeof t.source=="object"&&(this.addSource(d,t.source),t=s.aA(t),t=s.e(t,{source:d})),this._validate(s.x.layer,`layers.${d}`,t,{arrayIndex:-1},l))return;y=s.az(t),this._validateLayer(y),y.setEventedParent(this,{layer:{id:d}})}const P=n?this._order.indexOf(n):this._order.length;if(n&&P===-1)this.fire(new s.j(new Error(`Cannot add layer "${d}" before non-existing layer "${n}".`)));else{if(this._order.splice(P,0,d),this._layerOrderChanged=!0,this._layers[d]=y,this._removedLayers[d]&&y.source&&y.type!=="custom"){const A=this._removedLayers[d];delete this._removedLayers[d],A.type!==y.type?this._updatedSources[y.source]="clear":(this._updatedSources[y.source]="reload",this.sourceCaches[y.source].pause())}this._updateLayer(y),y.onAdd&&y.onAdd(this.map)}}moveLayer(t,n){if(this._checkLoaded(),this._changed=!0,!this._layers[t])return void this.fire(new s.j(new Error(`The layer '${t}' does not exist in the map's style and cannot be moved.`)));if(t===n)return;const l=this._order.indexOf(t);this._order.splice(l,1);const d=n?this._order.indexOf(n):this._order.length;n&&d===-1?this.fire(new s.j(new Error(`Cannot move layer "${t}" before non-existing layer "${n}".`))):(this._order.splice(d,0,t),this._layerOrderChanged=!0)}removeLayer(t){this._checkLoaded();const n=this._layers[t];if(!n)return void this.fire(new s.j(new Error(`Cannot remove non-existing layer "${t}".`)));n.setEventedParent(null);const l=this._order.indexOf(t);this._order.splice(l,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[t]=n,delete this._layers[t],this._serializedLayers&&delete this._serializedLayers[t],delete this._updatedLayers[t],delete this._updatedPaintProps[t],n.onRemove&&n.onRemove(this.map)}getLayer(t){return this._layers[t]}getLayersOrder(){return[...this._order]}hasLayer(t){return t in this._layers}setLayerZoomRange(t,n,l){this._checkLoaded();const d=this.getLayer(t);d?d.minzoom===n&&d.maxzoom===l||(n!=null&&(d.minzoom=n),l!=null&&(d.maxzoom=l),this._updateLayer(d)):this.fire(new s.j(new Error(`Cannot set the zoom range of non-existing layer "${t}".`)))}setFilter(t,n,l={}){this._checkLoaded();const d=this.getLayer(t);if(d){if(!s.aD(d.filter,n))return n==null?(d.filter=void 0,void this._updateLayer(d)):void(this._validate(s.x.filter,`layers.${d.id}.filter`,n,null,l)||(d.filter=s.aA(n),this._updateLayer(d)))}else this.fire(new s.j(new Error(`Cannot filter non-existing layer "${t}".`)))}getFilter(t){return s.aA(this.getLayer(t).filter)}setLayoutProperty(t,n,l,d={}){this._checkLoaded();const y=this.getLayer(t);y?s.aD(y.getLayoutProperty(n),l)||(y.setLayoutProperty(n,l,d),this._updateLayer(y)):this.fire(new s.j(new Error(`Cannot style non-existing layer "${t}".`)))}getLayoutProperty(t,n){const l=this.getLayer(t);if(l)return l.getLayoutProperty(n);this.fire(new s.j(new Error(`Cannot get style of non-existing layer "${t}".`)))}setPaintProperty(t,n,l,d={}){this._checkLoaded();const y=this.getLayer(t);y?s.aD(y.getPaintProperty(n),l)||(y.setPaintProperty(n,l,d)&&this._updateLayer(y),this._changed=!0,this._updatedPaintProps[t]=!0):this.fire(new s.j(new Error(`Cannot style non-existing layer "${t}".`)))}getPaintProperty(t,n){return this.getLayer(t).getPaintProperty(n)}setFeatureState(t,n){this._checkLoaded();const l=t.source,d=t.sourceLayer,y=this.sourceCaches[l];if(y===void 0)return void this.fire(new s.j(new Error(`The source '${l}' does not exist in the map's style.`)));const P=y.getSource().type;P==="geojson"&&d?this.fire(new s.j(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):P!=="vector"||d?(t.id===void 0&&this.fire(new s.j(new Error("The feature id parameter must be provided."))),y.setFeatureState(d,t.id,n)):this.fire(new s.j(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(t,n){this._checkLoaded();const l=t.source,d=this.sourceCaches[l];if(d===void 0)return void this.fire(new s.j(new Error(`The source '${l}' does not exist in the map's style.`)));const y=d.getSource().type,P=y==="vector"?t.sourceLayer:void 0;y!=="vector"||P?n&&typeof t.id!="string"&&typeof t.id!="number"?this.fire(new s.j(new Error("A feature id is required to remove its specific state property."))):d.removeFeatureState(P,t.id,n):this.fire(new s.j(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(t){this._checkLoaded();const n=t.source,l=t.sourceLayer,d=this.sourceCaches[n];if(d!==void 0)return d.getSource().type!=="vector"||l?(t.id===void 0&&this.fire(new s.j(new Error("The feature id parameter must be provided."))),d.getFeatureState(l,t.id)):void this.fire(new s.j(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new s.j(new Error(`The source '${n}' does not exist in the map's style.`)))}getTransition(){return s.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const t=s.aE(this.sourceCaches,y=>y.serialize()),n=this._serializeByIds(this._order),l=this.map.getTerrain()||void 0,d=this.stylesheet;return s.aF({version:d.version,name:d.name,metadata:d.metadata,light:d.light,center:d.center,zoom:d.zoom,bearing:d.bearing,pitch:d.pitch,sprite:d.sprite,glyphs:d.glyphs,transition:d.transition,sources:t,layers:n,terrain:l},y=>y!==void 0)}_updateLayer(t){this._updatedLayers[t.id]=!0,t.source&&!this._updatedSources[t.source]&&this.sourceCaches[t.source].getSource().type!=="raster"&&(this._updatedSources[t.source]="reload",this.sourceCaches[t.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(t){const n=P=>this._layers[P].type==="fill-extrusion",l={},d=[];for(let P=this._order.length-1;P>=0;P--){const A=this._order[P];if(n(A)){l[A]=P;for(const O of t){const R=O[A];if(R)for(const N of R)d.push(N)}}}d.sort((P,A)=>A.intersectionZ-P.intersectionZ);const y=[];for(let P=this._order.length-1;P>=0;P--){const A=this._order[P];if(n(A))for(let O=d.length-1;O>=0;O--){const R=d[O].feature;if(l[R.layer.id]<P)break;y.push(R),d.pop()}else for(const O of t){const R=O[A];if(R)for(const N of R)y.push(N.feature)}}return y}queryRenderedFeatures(t,n,l){n&&n.filter&&this._validate(s.x.filter,"queryRenderedFeatures.filter",n.filter,null,n);const d={};if(n&&n.layers){if(!Array.isArray(n.layers))return this.fire(new s.j(new Error("parameters.layers must be an Array."))),[];for(const A of n.layers){const O=this._layers[A];if(!O)return this.fire(new s.j(new Error(`The layer '${A}' does not exist in the map's style and cannot be queried for features.`))),[];d[O.source]=!0}}const y=[];n.availableImages=this._availableImages;const P=this._serializedAllLayers();for(const A in this.sourceCaches)n.layers&&!d[A]||y.push(At(this.sourceCaches[A],this._layers,P,t,n,l));return this.placement&&y.push(function(A,O,R,N,G,Z,ce){const oe={},ue=Z.queryRenderedSymbols(N),te=[];for(const Se of Object.keys(ue).map(Number))te.push(ce[Se]);te.sort(Ye);for(const Se of te){const We=Se.featureIndex.lookupSymbolFeatures(ue[Se.bucketInstanceId],O,Se.bucketIndex,Se.sourceLayerIndex,G.filter,G.layers,G.availableImages,A);for(const ge in We){const ke=oe[ge]=oe[ge]||[],He=We[ge];He.sort((qe,rt)=>{const Ct=Se.featureSortOrder;if(Ct){const _t=Ct.indexOf(qe.featureIndex);return Ct.indexOf(rt.featureIndex)-_t}return rt.featureIndex-qe.featureIndex});for(const qe of He)ke.push(qe)}}for(const Se in oe)oe[Se].forEach(We=>{const ge=We.feature,ke=R[A[Se].source].getFeatureState(ge.layer["source-layer"],ge.id);ge.source=ge.layer.source,ge.layer["source-layer"]&&(ge.sourceLayer=ge.layer["source-layer"]),ge.state=ke});return oe}(this._layers,P,this.sourceCaches,t,n,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(y)}querySourceFeatures(t,n){n&&n.filter&&this._validate(s.x.filter,"querySourceFeatures.filter",n.filter,null,n);const l=this.sourceCaches[t];return l?function(d,y){const P=d.getRenderableIds().map(R=>d.getTileByID(R)),A=[],O={};for(let R=0;R<P.length;R++){const N=P[R],G=N.tileID.canonical.key;O[G]||(O[G]=!0,N.querySourceFeatures(A,y))}return A}(l,n):[]}getLight(){return this.light.getLight()}setLight(t,n={}){this._checkLoaded();const l=this.light.getLight();let d=!1;for(const P in t)if(!s.aD(t[P],l[P])){d=!0;break}if(!d)return;const y={now:o.now(),transition:s.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(t,n),this.light.updateTransitions(y)}_validate(t,n,l,d,y={}){return(!y||y.validate!==!1)&&ds(this,t.call(s.x,s.e({key:n,style:this.serialize(),value:l,styleSpec:s.v},d)))}_remove(t=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),Hi().off(fi,this._rtlPluginLoaded);for(const n in this._layers)this._layers[n].setEventedParent(null);for(const n in this.sourceCaches){const l=this.sourceCaches[n];l.setEventedParent(null),l.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),t&&this.dispatcher.broadcast("removeMap",void 0),this.dispatcher.remove(t)}_clearSource(t){this.sourceCaches[t].clearTiles()}_reloadSource(t){this.sourceCaches[t].resume(),this.sourceCaches[t].reload()}_updateSources(t){for(const n in this.sourceCaches)this.sourceCaches[n].update(t,this.map.terrain)}_generateCollisionBoxes(){for(const t in this.sourceCaches)this._reloadSource(t)}_updatePlacement(t,n,l,d,y=!1){let P=!1,A=!1;const O={};for(const R of this._order){const N=this._layers[R];if(N.type!=="symbol")continue;if(!O[N.source]){const Z=this.sourceCaches[N.source];O[N.source]=Z.getRenderableIds(!0).map(ce=>Z.getTileByID(ce)).sort((ce,oe)=>oe.tileID.overscaledZ-ce.tileID.overscaledZ||(ce.tileID.isLessThan(oe.tileID)?-1:1))}const G=this.crossTileSymbolIndex.addLayer(N,O[N.source],t.center.lng);P=P||G}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((y=y||this._layerOrderChanged||l===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(o.now(),t.zoom))&&(this.pauseablePlacement=new us(t,this.map.terrain,this._order,y,n,l,d,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,O),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(o.now()),A=!0),P&&this.pauseablePlacement.placement.setStale()),A||P)for(const R of this._order){const N=this._layers[R];N.type==="symbol"&&this.placement.updateLayerOpacities(N,O[N.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(o.now())}_releaseSymbolFadeTiles(){for(const t in this.sourceCaches)this.sourceCaches[t].releaseSymbolFadeTiles()}getImages(t,n){return s._(this,void 0,void 0,function*(){const l=yield this.imageManager.getImages(n.icons);this._updateTilesForChangedImages();const d=this.sourceCaches[n.source];return d&&d.setDependencies(n.tileID.key,n.type,n.icons),l})}getGlyphs(t,n){return s._(this,void 0,void 0,function*(){const l=yield this.glyphManager.getGlyphs(n.stacks),d=this.sourceCaches[n.source];return d&&d.setDependencies(n.tileID.key,n.type,[""]),l})}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(t,n={}){this._checkLoaded(),t&&this._validate(s.x.glyphs,"glyphs",t,null,n)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=t,this.glyphManager.entries={},this.glyphManager.setURL(t))}addSprite(t,n,l={},d){this._checkLoaded();const y=[{id:t,url:n}],P=[...at(this.stylesheet.sprite),...y];this._validate(s.x.sprite,"sprite",P,null,l)||(this.stylesheet.sprite=P,this._loadSprite(y,!0,d))}removeSprite(t){this._checkLoaded();const n=at(this.stylesheet.sprite);if(n.find(l=>l.id===t)){if(this._spritesImagesIds[t])for(const l of this._spritesImagesIds[t])this.imageManager.removeImage(l),this._changedImages[l]=!0;n.splice(n.findIndex(l=>l.id===t),1),this.stylesheet.sprite=n.length>0?n:void 0,delete this._spritesImagesIds[t],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new s.k("data",{dataType:"style"}))}else this.fire(new s.j(new Error(`Sprite "${t}" doesn't exists on this map.`)))}getSprite(){return at(this.stylesheet.sprite)}setSprite(t,n={},l){this._checkLoaded(),t&&this._validate(s.x.sprite,"sprite",t,null,n)||(this.stylesheet.sprite=t,t?this._loadSprite(t,!0,l):(this._unloadSprite(),l&&l(null)))}}var On=s.X([{name:"a_pos",type:"Int16",components:2}]),Qa="attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform float u_ele_delta;varying vec2 v_texture_pos;varying float v_depth;void main() {float extent=8192.0;float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/extent;gl_Position=u_matrix*vec4(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta,1.0);v_depth=gl_Position.z/gl_Position.w;}";const Gs={prelude:Vi(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture2D(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture2D(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}`),background:Vi(`uniform vec4 u_color;uniform float u_opacity;void main() {gl_FragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),backgroundPattern:Vi(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:Vi(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));gl_FragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);float ele=get_elevation(circle_center);v_visibility=calculate_visibility(u_matrix*vec4(circle_center,ele,1.0));if (u_pitch_with_map) {vec2 corner_position=circle_center;if (u_scale_with_map) {corner_position+=extrude*(radius+stroke_width)*u_extrude_scale;} else {vec4 projected_center=u_matrix*vec4(circle_center,0,1);corner_position+=extrude*(radius+stroke_width)*u_extrude_scale*(projected_center.w/u_camera_to_center_distance);}gl_Position=u_matrix*vec4(corner_position,ele,1);} else {gl_Position=u_matrix*vec4(circle_center,ele,1);if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:Vi("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Vi(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec4 pos=vec4(floor(a_pos*0.5)+extrude,0,1);gl_Position=u_matrix*pos;}`),heatmapTexture:Vi(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:Vi("varying float v_placed;varying float v_notUsed;void main() {float alpha=0.5;gl_FragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {gl_FragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {gl_FragColor*=.1;}}","attribute vec2 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_anchor_pos,0,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);gl_Position=u_matrix*vec4(a_pos,get_elevation(a_pos),1.0);gl_Position.xy+=(a_extrude+a_shift)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Vi("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Vi("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,get_elevation(a_pos),1);}"),fill:Vi(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_FragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);}`),fillOutline:Vi(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=outline_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillOutlinePattern:Vi(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillPattern:Vi(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:Vi(`varying vec4 v_color;void main() {gl_FragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t > 0.0 ? height : base,1);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:Vi(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);gl_FragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float z=t > 0.0 ? height : base;gl_Position=u_matrix*vec4(a_pos,z,1);vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:Vi(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Vi(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;
#define PI 3.141592653589793
void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;}"),line:Vi(`uniform lowp float u_device_pixel_ratio;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp float v_linesofar;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:Vi(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture2D(u_image,v_uv);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_uv_x;attribute float a_split_index;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:Vi(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);gl_FragColor=color*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:Vi(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture2D(u_image,v_tex_a).a;float sdfdist_b=texture2D(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}`),raster:Vi(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);gl_FragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos0=(((a_texture_pos/8192.0)-0.5)/u_buffer_scale )+0.5;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}"),symbolIcon:Vi(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0),z,1.0);v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:Vi(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset),z,1.0);float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:Vi(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale),z,1.0);float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:Vi("uniform sampler2D u_texture;varying vec2 v_texture_pos;void main() {gl_FragColor=texture2D(u_texture,v_texture_pos);}",Qa),terrainDepth:Vi("varying float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {gl_FragColor=pack(v_depth);}",Qa),terrainCoords:Vi("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;varying vec2 v_texture_pos;void main() {vec4 rgba=texture2D(u_texture,v_texture_pos);gl_FragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}",Qa)};function Vi(g,t){const n=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,l=t.match(/attribute ([\w]+) ([\w]+)/g),d=g.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),y=t.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),P=y?y.concat(d):d,A={};return{fragmentSource:g=g.replace(n,(O,R,N,G,Z)=>(A[Z]=!0,R==="define"?`
#ifndef HAS_UNIFORM_u_${Z}
varying ${N} ${G} ${Z};
#else
uniform ${N} ${G} u_${Z};
#endif
`:`
#ifdef HAS_UNIFORM_u_${Z}
    ${N} ${G} ${Z} = u_${Z};
#endif
`)),vertexSource:t=t.replace(n,(O,R,N,G,Z)=>{const ce=G==="float"?"vec2":"vec4",oe=Z.match(/color/)?"color":ce;return A[Z]?R==="define"?`
#ifndef HAS_UNIFORM_u_${Z}
uniform lowp float u_${Z}_t;
attribute ${N} ${ce} a_${Z};
varying ${N} ${G} ${Z};
#else
uniform ${N} ${G} u_${Z};
#endif
`:oe==="vec4"?`
#ifndef HAS_UNIFORM_u_${Z}
    ${Z} = a_${Z};
#else
    ${N} ${G} ${Z} = u_${Z};
#endif
`:`
#ifndef HAS_UNIFORM_u_${Z}
    ${Z} = unpack_mix_${oe}(a_${Z}, u_${Z}_t);
#else
    ${N} ${G} ${Z} = u_${Z};
#endif
`:R==="define"?`
#ifndef HAS_UNIFORM_u_${Z}
uniform lowp float u_${Z}_t;
attribute ${N} ${ce} a_${Z};
#else
uniform ${N} ${G} u_${Z};
#endif
`:oe==="vec4"?`
#ifndef HAS_UNIFORM_u_${Z}
    ${N} ${G} ${Z} = a_${Z};
#else
    ${N} ${G} ${Z} = u_${Z};
#endif
`:`
#ifndef HAS_UNIFORM_u_${Z}
    ${N} ${G} ${Z} = unpack_mix_${oe}(a_${Z}, u_${Z}_t);
#else
    ${N} ${G} ${Z} = u_${Z};
#endif
`}),staticAttributes:l,staticUniforms:P}}class Ss{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(t,n,l,d,y,P,A,O,R){this.context=t;let N=this.boundPaintVertexBuffers.length!==d.length;for(let G=0;!N&&G<d.length;G++)this.boundPaintVertexBuffers[G]!==d[G]&&(N=!0);!this.vao||this.boundProgram!==n||this.boundLayoutVertexBuffer!==l||N||this.boundIndexBuffer!==y||this.boundVertexOffset!==P||this.boundDynamicVertexBuffer!==A||this.boundDynamicVertexBuffer2!==O||this.boundDynamicVertexBuffer3!==R?this.freshBind(n,l,d,y,P,A,O,R):(t.bindVertexArray.set(this.vao),A&&A.bind(),y&&y.dynamicDraw&&y.bind(),O&&O.bind(),R&&R.bind())}freshBind(t,n,l,d,y,P,A,O){const R=t.numAttributes,N=this.context,G=N.gl;this.vao&&this.destroy(),this.vao=N.createVertexArray(),N.bindVertexArray.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=n,this.boundPaintVertexBuffers=l,this.boundIndexBuffer=d,this.boundVertexOffset=y,this.boundDynamicVertexBuffer=P,this.boundDynamicVertexBuffer2=A,this.boundDynamicVertexBuffer3=O,n.enableAttributes(G,t);for(const Z of l)Z.enableAttributes(G,t);P&&P.enableAttributes(G,t),A&&A.enableAttributes(G,t),O&&O.enableAttributes(G,t),n.bind(),n.setVertexAttribPointers(G,t,y);for(const Z of l)Z.bind(),Z.setVertexAttribPointers(G,t,y);P&&(P.bind(),P.setVertexAttribPointers(G,t,y)),d&&d.bind(),A&&(A.bind(),A.setVertexAttribPointers(G,t,y)),O&&(O.bind(),O.setVertexAttribPointers(G,t,y)),N.currentNumAttributes=R}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}function T(g){const t=[];for(let n=0;n<g.length;n++){if(g[n]===null)continue;const l=g[n].split(" ");t.push(l.pop())}return t}class z{constructor(t,n,l,d,y,P){const A=t.gl;this.program=A.createProgram();const O=T(n.staticAttributes),R=l?l.getBinderAttributes():[],N=O.concat(R),G=Gs.prelude.staticUniforms?T(Gs.prelude.staticUniforms):[],Z=n.staticUniforms?T(n.staticUniforms):[],ce=l?l.getBinderUniforms():[],oe=G.concat(Z).concat(ce),ue=[];for(const qe of oe)ue.indexOf(qe)<0&&ue.push(qe);const te=l?l.defines():[];y&&te.push("#define OVERDRAW_INSPECTOR;"),P&&te.push("#define TERRAIN3D;");const Se=te.concat(Gs.prelude.fragmentSource,n.fragmentSource).join(`
`),We=te.concat(Gs.prelude.vertexSource,n.vertexSource).join(`
`),ge=A.createShader(A.FRAGMENT_SHADER);if(A.isContextLost())return void(this.failedToCreate=!0);if(A.shaderSource(ge,Se),A.compileShader(ge),!A.getShaderParameter(ge,A.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${A.getShaderInfoLog(ge)}`);A.attachShader(this.program,ge);const ke=A.createShader(A.VERTEX_SHADER);if(A.isContextLost())return void(this.failedToCreate=!0);if(A.shaderSource(ke,We),A.compileShader(ke),!A.getShaderParameter(ke,A.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${A.getShaderInfoLog(ke)}`);A.attachShader(this.program,ke),this.attributes={};const He={};this.numAttributes=N.length;for(let qe=0;qe<this.numAttributes;qe++)N[qe]&&(A.bindAttribLocation(this.program,qe,N[qe]),this.attributes[N[qe]]=qe);if(A.linkProgram(this.program),!A.getProgramParameter(this.program,A.LINK_STATUS))throw new Error(`Program failed to link: ${A.getProgramInfoLog(this.program)}`);A.deleteShader(ke),A.deleteShader(ge);for(let qe=0;qe<ue.length;qe++){const rt=ue[qe];if(rt&&!He[rt]){const Ct=A.getUniformLocation(this.program,rt);Ct&&(He[rt]=Ct)}}this.fixedUniforms=d(t,He),this.terrainUniforms=((qe,rt)=>({u_depth:new s.aG(qe,rt.u_depth),u_terrain:new s.aG(qe,rt.u_terrain),u_terrain_dim:new s.aH(qe,rt.u_terrain_dim),u_terrain_matrix:new s.aI(qe,rt.u_terrain_matrix),u_terrain_unpack:new s.aJ(qe,rt.u_terrain_unpack),u_terrain_exaggeration:new s.aH(qe,rt.u_terrain_exaggeration)}))(t,He),this.binderUniforms=l?l.getUniforms(t,He):[]}draw(t,n,l,d,y,P,A,O,R,N,G,Z,ce,oe,ue,te,Se,We){const ge=t.gl;if(this.failedToCreate)return;if(t.program.set(this.program),t.setDepthMode(l),t.setStencilMode(d),t.setColorMode(y),t.setCullFace(P),O){t.activeTexture.set(ge.TEXTURE2),ge.bindTexture(ge.TEXTURE_2D,O.depthTexture),t.activeTexture.set(ge.TEXTURE3),ge.bindTexture(ge.TEXTURE_2D,O.texture);for(const He in this.terrainUniforms)this.terrainUniforms[He].set(O[He])}for(const He in this.fixedUniforms)this.fixedUniforms[He].set(A[He]);ue&&ue.setUniforms(t,this.binderUniforms,ce,{zoom:oe});let ke=0;switch(n){case ge.LINES:ke=2;break;case ge.TRIANGLES:ke=3;break;case ge.LINE_STRIP:ke=1}for(const He of Z.get()){const qe=He.vaos||(He.vaos={});(qe[R]||(qe[R]=new Ss)).bind(t,this,N,ue?ue.getPaintVertexBuffers():[],G,He.vertexOffset,te,Se,We),ge.drawElements(n,He.primitiveLength*ke,ge.UNSIGNED_SHORT,He.primitiveOffset*ke*2)}}}function q(g,t,n){const l=1/pi(n,1,t.transform.tileZoom),d=Math.pow(2,n.tileID.overscaledZ),y=n.tileSize*Math.pow(2,t.transform.tileZoom)/d,P=y*(n.tileID.canonical.x+n.tileID.wrap*d),A=y*n.tileID.canonical.y;return{u_image:0,u_texsize:n.imageAtlasTexture.size,u_scale:[l,g.fromScale,g.toScale],u_fade:g.t,u_pixel_coord_upper:[P>>16,A>>16],u_pixel_coord_lower:[65535&P,65535&A]}}const me=(g,t,n,l)=>{const d=t.style.light,y=d.properties.get("position"),P=[y.x,y.y,y.z],A=function(){var R=new s.A(9);return s.A!=Float32Array&&(R[1]=0,R[2]=0,R[3]=0,R[5]=0,R[6]=0,R[7]=0),R[0]=1,R[4]=1,R[8]=1,R}();d.properties.get("anchor")==="viewport"&&function(R,N){var G=Math.sin(N),Z=Math.cos(N);R[0]=Z,R[1]=G,R[2]=0,R[3]=-G,R[4]=Z,R[5]=0,R[6]=0,R[7]=0,R[8]=1}(A,-t.transform.angle),function(R,N,G){var Z=N[0],ce=N[1],oe=N[2];R[0]=Z*G[0]+ce*G[3]+oe*G[6],R[1]=Z*G[1]+ce*G[4]+oe*G[7],R[2]=Z*G[2]+ce*G[5]+oe*G[8]}(P,P,A);const O=d.properties.get("color");return{u_matrix:g,u_lightpos:P,u_lightintensity:d.properties.get("intensity"),u_lightcolor:[O.r,O.g,O.b],u_vertical_gradient:+n,u_opacity:l}},Te=(g,t,n,l,d,y,P)=>s.e(me(g,t,n,l),q(y,t,P),{u_height_factor:-Math.pow(2,d.overscaledZ)/P.tileSize/8}),Ee=g=>({u_matrix:g}),Fe=(g,t,n,l)=>s.e(Ee(g),q(n,t,l)),Tt=(g,t)=>({u_matrix:g,u_world:t}),Mt=(g,t,n,l,d)=>s.e(Fe(g,t,n,l),{u_world:d}),jt=(g,t,n,l)=>{const d=g.transform;let y,P;if(l.paint.get("circle-pitch-alignment")==="map"){const A=pi(n,1,d.zoom);y=!0,P=[A,A]}else y=!1,P=d.pixelsToGLUnits;return{u_camera_to_center_distance:d.cameraToCenterDistance,u_scale_with_map:+(l.paint.get("circle-pitch-scale")==="map"),u_matrix:g.translatePosMatrix(t.posMatrix,n,l.paint.get("circle-translate"),l.paint.get("circle-translate-anchor")),u_pitch_with_map:+y,u_device_pixel_ratio:g.pixelRatio,u_extrude_scale:P}},Ut=(g,t,n)=>{const l=pi(n,1,t.zoom),d=Math.pow(2,t.zoom-n.tileID.overscaledZ),y=n.tileID.overscaleFactor();return{u_matrix:g,u_camera_to_center_distance:t.cameraToCenterDistance,u_pixels_to_tile_units:l,u_extrude_scale:[t.pixelsToGLUnits[0]/(l*d),t.pixelsToGLUnits[1]/(l*d)],u_overscale_factor:y}},Dt=(g,t,n=1)=>({u_matrix:g,u_color:t,u_overlay:0,u_overlay_scale:n}),yi=g=>({u_matrix:g}),nr=(g,t,n,l)=>({u_matrix:g,u_extrude_scale:pi(t,1,n),u_intensity:l});function wi(g,t){const n=Math.pow(2,t.canonical.z),l=t.canonical.y;return[new s.Y(0,l/n).toLngLat().lat,new s.Y(0,(l+1)/n).toLngLat().lat]}const ur=(g,t,n,l)=>{const d=g.transform;return{u_matrix:sr(g,t,n,l),u_ratio:1/pi(t,1,d.zoom),u_device_pixel_ratio:g.pixelRatio,u_units_to_pixels:[1/d.pixelsToGLUnits[0],1/d.pixelsToGLUnits[1]]}},ft=(g,t,n,l,d)=>s.e(ur(g,t,n,d),{u_image:0,u_image_height:l}),Qt=(g,t,n,l,d)=>{const y=g.transform,P=_r(t,y);return{u_matrix:sr(g,t,n,d),u_texsize:t.imageAtlasTexture.size,u_ratio:1/pi(t,1,y.zoom),u_device_pixel_ratio:g.pixelRatio,u_image:0,u_scale:[P,l.fromScale,l.toScale],u_fade:l.t,u_units_to_pixels:[1/y.pixelsToGLUnits[0],1/y.pixelsToGLUnits[1]]}},Ei=(g,t,n,l,d,y)=>{const P=g.lineAtlas,A=_r(t,g.transform),O=n.layout.get("line-cap")==="round",R=P.getDash(l.from,O),N=P.getDash(l.to,O),G=R.width*d.fromScale,Z=N.width*d.toScale;return s.e(ur(g,t,n,y),{u_patternscale_a:[A/G,-R.height/2],u_patternscale_b:[A/Z,-N.height/2],u_sdfgamma:P.width/(256*Math.min(G,Z)*g.pixelRatio)/2,u_image:0,u_tex_y_a:R.y,u_tex_y_b:N.y,u_mix:d.t})};function _r(g,t){return 1/pi(g,1,t.tileZoom)}function sr(g,t,n,l){return g.translatePosMatrix(l?l.posMatrix:t.tileID.posMatrix,t,n.paint.get("line-translate"),n.paint.get("line-translate-anchor"))}const Ts=(g,t,n,l,d)=>{return{u_matrix:g,u_tl_parent:t,u_scale_parent:n,u_buffer_scale:1,u_fade_t:l.mix,u_opacity:l.opacity*d.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:d.paint.get("raster-brightness-min"),u_brightness_high:d.paint.get("raster-brightness-max"),u_saturation_factor:(P=d.paint.get("raster-saturation"),P>0?1-1/(1.001-P):-P),u_contrast_factor:(y=d.paint.get("raster-contrast"),y>0?1/(1-y):1+y),u_spin_weights:Ea(d.paint.get("raster-hue-rotate"))};var y,P};function Ea(g){g*=Math.PI/180;const t=Math.sin(g),n=Math.cos(g);return[(2*n+1)/3,(-Math.sqrt(3)*t-n+1)/3,(Math.sqrt(3)*t-n+1)/3]}const qi=(g,t,n,l,d,y,P,A,O,R)=>{const N=d.transform;return{u_is_size_zoom_constant:+(g==="constant"||g==="source"),u_is_size_feature_constant:+(g==="constant"||g==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:N.cameraToCenterDistance,u_pitch:N.pitch/360*2*Math.PI,u_rotate_symbol:+n,u_aspect_ratio:N.width/N.height,u_fade_change:d.options.fadeDuration?d.symbolFadeChange:1,u_matrix:y,u_label_plane_matrix:P,u_coord_matrix:A,u_is_text:+O,u_pitch_with_map:+l,u_texsize:R,u_texture:0}},Es=(g,t,n,l,d,y,P,A,O,R,N)=>{const G=d.transform;return s.e(qi(g,t,n,l,d,y,P,A,O,R),{u_gamma_scale:l?Math.cos(G._pitch)*G.cameraToCenterDistance:1,u_device_pixel_ratio:d.pixelRatio,u_is_halo:+N})},fl=(g,t,n,l,d,y,P,A,O,R)=>s.e(Es(g,t,n,l,d,y,P,A,!0,O,!0),{u_texsize_icon:R,u_texture_icon:1}),Qn=(g,t,n)=>({u_matrix:g,u_opacity:t,u_color:n}),eo=(g,t,n,l,d,y)=>s.e(function(P,A,O,R){const N=O.imageManager.getPattern(P.from.toString()),G=O.imageManager.getPattern(P.to.toString()),{width:Z,height:ce}=O.imageManager.getPixelSize(),oe=Math.pow(2,R.tileID.overscaledZ),ue=R.tileSize*Math.pow(2,O.transform.tileZoom)/oe,te=ue*(R.tileID.canonical.x+R.tileID.wrap*oe),Se=ue*R.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:N.tl,u_pattern_br_a:N.br,u_pattern_tl_b:G.tl,u_pattern_br_b:G.br,u_texsize:[Z,ce],u_mix:A.t,u_pattern_size_a:N.displaySize,u_pattern_size_b:G.displaySize,u_scale_a:A.fromScale,u_scale_b:A.toScale,u_tile_units_to_pixels:1/pi(R,1,O.transform.tileZoom),u_pixel_coord_upper:[te>>16,Se>>16],u_pixel_coord_lower:[65535&te,65535&Se]}}(l,y,n,d),{u_matrix:g,u_opacity:t}),Oo={fillExtrusion:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_lightpos:new s.aK(g,t.u_lightpos),u_lightintensity:new s.aH(g,t.u_lightintensity),u_lightcolor:new s.aK(g,t.u_lightcolor),u_vertical_gradient:new s.aH(g,t.u_vertical_gradient),u_opacity:new s.aH(g,t.u_opacity)}),fillExtrusionPattern:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_lightpos:new s.aK(g,t.u_lightpos),u_lightintensity:new s.aH(g,t.u_lightintensity),u_lightcolor:new s.aK(g,t.u_lightcolor),u_vertical_gradient:new s.aH(g,t.u_vertical_gradient),u_height_factor:new s.aH(g,t.u_height_factor),u_image:new s.aG(g,t.u_image),u_texsize:new s.aL(g,t.u_texsize),u_pixel_coord_upper:new s.aL(g,t.u_pixel_coord_upper),u_pixel_coord_lower:new s.aL(g,t.u_pixel_coord_lower),u_scale:new s.aK(g,t.u_scale),u_fade:new s.aH(g,t.u_fade),u_opacity:new s.aH(g,t.u_opacity)}),fill:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix)}),fillPattern:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_image:new s.aG(g,t.u_image),u_texsize:new s.aL(g,t.u_texsize),u_pixel_coord_upper:new s.aL(g,t.u_pixel_coord_upper),u_pixel_coord_lower:new s.aL(g,t.u_pixel_coord_lower),u_scale:new s.aK(g,t.u_scale),u_fade:new s.aH(g,t.u_fade)}),fillOutline:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_world:new s.aL(g,t.u_world)}),fillOutlinePattern:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_world:new s.aL(g,t.u_world),u_image:new s.aG(g,t.u_image),u_texsize:new s.aL(g,t.u_texsize),u_pixel_coord_upper:new s.aL(g,t.u_pixel_coord_upper),u_pixel_coord_lower:new s.aL(g,t.u_pixel_coord_lower),u_scale:new s.aK(g,t.u_scale),u_fade:new s.aH(g,t.u_fade)}),circle:(g,t)=>({u_camera_to_center_distance:new s.aH(g,t.u_camera_to_center_distance),u_scale_with_map:new s.aG(g,t.u_scale_with_map),u_pitch_with_map:new s.aG(g,t.u_pitch_with_map),u_extrude_scale:new s.aL(g,t.u_extrude_scale),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_matrix:new s.aI(g,t.u_matrix)}),collisionBox:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_camera_to_center_distance:new s.aH(g,t.u_camera_to_center_distance),u_pixels_to_tile_units:new s.aH(g,t.u_pixels_to_tile_units),u_extrude_scale:new s.aL(g,t.u_extrude_scale),u_overscale_factor:new s.aH(g,t.u_overscale_factor)}),collisionCircle:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_inv_matrix:new s.aI(g,t.u_inv_matrix),u_camera_to_center_distance:new s.aH(g,t.u_camera_to_center_distance),u_viewport_size:new s.aL(g,t.u_viewport_size)}),debug:(g,t)=>({u_color:new s.aM(g,t.u_color),u_matrix:new s.aI(g,t.u_matrix),u_overlay:new s.aG(g,t.u_overlay),u_overlay_scale:new s.aH(g,t.u_overlay_scale)}),clippingMask:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix)}),heatmap:(g,t)=>({u_extrude_scale:new s.aH(g,t.u_extrude_scale),u_intensity:new s.aH(g,t.u_intensity),u_matrix:new s.aI(g,t.u_matrix)}),heatmapTexture:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_world:new s.aL(g,t.u_world),u_image:new s.aG(g,t.u_image),u_color_ramp:new s.aG(g,t.u_color_ramp),u_opacity:new s.aH(g,t.u_opacity)}),hillshade:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_image:new s.aG(g,t.u_image),u_latrange:new s.aL(g,t.u_latrange),u_light:new s.aL(g,t.u_light),u_shadow:new s.aM(g,t.u_shadow),u_highlight:new s.aM(g,t.u_highlight),u_accent:new s.aM(g,t.u_accent)}),hillshadePrepare:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_image:new s.aG(g,t.u_image),u_dimension:new s.aL(g,t.u_dimension),u_zoom:new s.aH(g,t.u_zoom),u_unpack:new s.aJ(g,t.u_unpack)}),line:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_ratio:new s.aH(g,t.u_ratio),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_units_to_pixels:new s.aL(g,t.u_units_to_pixels)}),lineGradient:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_ratio:new s.aH(g,t.u_ratio),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_units_to_pixels:new s.aL(g,t.u_units_to_pixels),u_image:new s.aG(g,t.u_image),u_image_height:new s.aH(g,t.u_image_height)}),linePattern:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_texsize:new s.aL(g,t.u_texsize),u_ratio:new s.aH(g,t.u_ratio),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_image:new s.aG(g,t.u_image),u_units_to_pixels:new s.aL(g,t.u_units_to_pixels),u_scale:new s.aK(g,t.u_scale),u_fade:new s.aH(g,t.u_fade)}),lineSDF:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_ratio:new s.aH(g,t.u_ratio),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_units_to_pixels:new s.aL(g,t.u_units_to_pixels),u_patternscale_a:new s.aL(g,t.u_patternscale_a),u_patternscale_b:new s.aL(g,t.u_patternscale_b),u_sdfgamma:new s.aH(g,t.u_sdfgamma),u_image:new s.aG(g,t.u_image),u_tex_y_a:new s.aH(g,t.u_tex_y_a),u_tex_y_b:new s.aH(g,t.u_tex_y_b),u_mix:new s.aH(g,t.u_mix)}),raster:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_tl_parent:new s.aL(g,t.u_tl_parent),u_scale_parent:new s.aH(g,t.u_scale_parent),u_buffer_scale:new s.aH(g,t.u_buffer_scale),u_fade_t:new s.aH(g,t.u_fade_t),u_opacity:new s.aH(g,t.u_opacity),u_image0:new s.aG(g,t.u_image0),u_image1:new s.aG(g,t.u_image1),u_brightness_low:new s.aH(g,t.u_brightness_low),u_brightness_high:new s.aH(g,t.u_brightness_high),u_saturation_factor:new s.aH(g,t.u_saturation_factor),u_contrast_factor:new s.aH(g,t.u_contrast_factor),u_spin_weights:new s.aK(g,t.u_spin_weights)}),symbolIcon:(g,t)=>({u_is_size_zoom_constant:new s.aG(g,t.u_is_size_zoom_constant),u_is_size_feature_constant:new s.aG(g,t.u_is_size_feature_constant),u_size_t:new s.aH(g,t.u_size_t),u_size:new s.aH(g,t.u_size),u_camera_to_center_distance:new s.aH(g,t.u_camera_to_center_distance),u_pitch:new s.aH(g,t.u_pitch),u_rotate_symbol:new s.aG(g,t.u_rotate_symbol),u_aspect_ratio:new s.aH(g,t.u_aspect_ratio),u_fade_change:new s.aH(g,t.u_fade_change),u_matrix:new s.aI(g,t.u_matrix),u_label_plane_matrix:new s.aI(g,t.u_label_plane_matrix),u_coord_matrix:new s.aI(g,t.u_coord_matrix),u_is_text:new s.aG(g,t.u_is_text),u_pitch_with_map:new s.aG(g,t.u_pitch_with_map),u_texsize:new s.aL(g,t.u_texsize),u_texture:new s.aG(g,t.u_texture)}),symbolSDF:(g,t)=>({u_is_size_zoom_constant:new s.aG(g,t.u_is_size_zoom_constant),u_is_size_feature_constant:new s.aG(g,t.u_is_size_feature_constant),u_size_t:new s.aH(g,t.u_size_t),u_size:new s.aH(g,t.u_size),u_camera_to_center_distance:new s.aH(g,t.u_camera_to_center_distance),u_pitch:new s.aH(g,t.u_pitch),u_rotate_symbol:new s.aG(g,t.u_rotate_symbol),u_aspect_ratio:new s.aH(g,t.u_aspect_ratio),u_fade_change:new s.aH(g,t.u_fade_change),u_matrix:new s.aI(g,t.u_matrix),u_label_plane_matrix:new s.aI(g,t.u_label_plane_matrix),u_coord_matrix:new s.aI(g,t.u_coord_matrix),u_is_text:new s.aG(g,t.u_is_text),u_pitch_with_map:new s.aG(g,t.u_pitch_with_map),u_texsize:new s.aL(g,t.u_texsize),u_texture:new s.aG(g,t.u_texture),u_gamma_scale:new s.aH(g,t.u_gamma_scale),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_is_halo:new s.aG(g,t.u_is_halo)}),symbolTextAndIcon:(g,t)=>({u_is_size_zoom_constant:new s.aG(g,t.u_is_size_zoom_constant),u_is_size_feature_constant:new s.aG(g,t.u_is_size_feature_constant),u_size_t:new s.aH(g,t.u_size_t),u_size:new s.aH(g,t.u_size),u_camera_to_center_distance:new s.aH(g,t.u_camera_to_center_distance),u_pitch:new s.aH(g,t.u_pitch),u_rotate_symbol:new s.aG(g,t.u_rotate_symbol),u_aspect_ratio:new s.aH(g,t.u_aspect_ratio),u_fade_change:new s.aH(g,t.u_fade_change),u_matrix:new s.aI(g,t.u_matrix),u_label_plane_matrix:new s.aI(g,t.u_label_plane_matrix),u_coord_matrix:new s.aI(g,t.u_coord_matrix),u_is_text:new s.aG(g,t.u_is_text),u_pitch_with_map:new s.aG(g,t.u_pitch_with_map),u_texsize:new s.aL(g,t.u_texsize),u_texsize_icon:new s.aL(g,t.u_texsize_icon),u_texture:new s.aG(g,t.u_texture),u_texture_icon:new s.aG(g,t.u_texture_icon),u_gamma_scale:new s.aH(g,t.u_gamma_scale),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_is_halo:new s.aG(g,t.u_is_halo)}),background:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_opacity:new s.aH(g,t.u_opacity),u_color:new s.aM(g,t.u_color)}),backgroundPattern:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_opacity:new s.aH(g,t.u_opacity),u_image:new s.aG(g,t.u_image),u_pattern_tl_a:new s.aL(g,t.u_pattern_tl_a),u_pattern_br_a:new s.aL(g,t.u_pattern_br_a),u_pattern_tl_b:new s.aL(g,t.u_pattern_tl_b),u_pattern_br_b:new s.aL(g,t.u_pattern_br_b),u_texsize:new s.aL(g,t.u_texsize),u_mix:new s.aH(g,t.u_mix),u_pattern_size_a:new s.aL(g,t.u_pattern_size_a),u_pattern_size_b:new s.aL(g,t.u_pattern_size_b),u_scale_a:new s.aH(g,t.u_scale_a),u_scale_b:new s.aH(g,t.u_scale_b),u_pixel_coord_upper:new s.aL(g,t.u_pixel_coord_upper),u_pixel_coord_lower:new s.aL(g,t.u_pixel_coord_lower),u_tile_units_to_pixels:new s.aH(g,t.u_tile_units_to_pixels)}),terrain:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_texture:new s.aG(g,t.u_texture),u_ele_delta:new s.aH(g,t.u_ele_delta)}),terrainDepth:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_ele_delta:new s.aH(g,t.u_ele_delta)}),terrainCoords:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_texture:new s.aG(g,t.u_texture),u_terrain_coords_id:new s.aH(g,t.u_terrain_coords_id),u_ele_delta:new s.aH(g,t.u_ele_delta)})};class fs{constructor(t,n,l){this.context=t;const d=t.gl;this.buffer=d.createBuffer(),this.dynamicDraw=!!l,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),d.bufferData(d.ELEMENT_ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?d.DYNAMIC_DRAW:d.STATIC_DRAW),this.dynamicDraw||delete n.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){const n=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Ws={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class ln{constructor(t,n,l,d){this.length=n.length,this.attributes=l,this.itemSize=n.bytesPerElement,this.dynamicDraw=d,this.context=t;const y=t.gl;this.buffer=y.createBuffer(),t.bindVertexBuffer.set(this.buffer),y.bufferData(y.ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?y.DYNAMIC_DRAW:y.STATIC_DRAW),this.dynamicDraw||delete n.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){if(t.length!==this.length)throw new Error(`Length of new data is ${t.length}, which doesn't match current length of ${this.length}`);const n=this.context.gl;this.bind(),n.bufferSubData(n.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,n){for(let l=0;l<this.attributes.length;l++){const d=n.attributes[this.attributes[l].name];d!==void 0&&t.enableVertexAttribArray(d)}}setVertexAttribPointers(t,n,l){for(let d=0;d<this.attributes.length;d++){const y=this.attributes[d],P=n.attributes[y.name];P!==void 0&&t.vertexAttribPointer(P,y.components,t[Ws[y.type]],!1,this.itemSize,y.offset+this.itemSize*(l||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Wr=new WeakMap;function Hs(g){var t;if(Wr.has(g))return Wr.get(g);{const n=(t=g.getParameter(g.VERSION))===null||t===void 0?void 0:t.startsWith("WebGL 2.0");return Wr.set(g,n),n}}class Fi{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Ia extends Fi{getDefault(){return s.aO.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Pa extends Fi{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Aa extends Fi{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class la extends Fi{getDefault(){return[!0,!0,!0,!0]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class to extends Fi{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class io extends Fi{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class Is extends Fi{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const n=this.current;(t.func!==n.func||t.ref!==n.ref||t.mask!==n.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class Ma extends Fi{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class ro extends Fi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.current=t,this.dirty=!1}}class Jr extends Fi{getDefault(){return[0,1]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class Lo extends Fi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.current=t,this.dirty=!1}}class Fo extends Fi{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class pl extends Fi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.BLEND):n.disable(n.BLEND),this.current=t,this.dirty=!1}}class zo extends Fi{getDefault(){const t=this.gl;return[t.ONE,t.ZERO]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.blendFunc(t[0],t[1]),this.current=t,this.dirty=!1)}}class ka extends Fi{getDefault(){return s.aO.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Ro extends Fi{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquation(t),this.current=t,this.dirty=!1)}}class Da extends Fi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this.current=t,this.dirty=!1}}class Oa extends Fi{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class es extends Fi{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}class La extends Fi{getDefault(){return null}set(t){(t!==this.current||this.dirty)&&(this.gl.useProgram(t),this.current=t,this.dirty=!1)}}class Xs extends Fi{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class Bo extends Fi{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Fa extends Fi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Ps extends Fi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class ts extends Fi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindTexture(n.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class za extends Fi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class ps extends Fi{getDefault(){return null}set(t){const n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Gn extends Fi{getDefault(){return null}set(t){var n;if(t===this.current&&!this.dirty)return;const l=this.gl;Hs(l)?l.bindVertexArray(t):(n=l.getExtension("OES_vertex_array_object"))===null||n===void 0||n.bindVertexArrayOES(t),this.current=t,this.dirty=!1}}class jo extends Fi{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class no extends Fi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class zi extends Fi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class qs extends Fi{constructor(t,n){super(t),this.context=t,this.parent=n}getDefault(){return null}}class ml extends qs{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class so extends qs{set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class As extends qs{set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Ms{constructor(t,n,l,d,y){this.context=t,this.width=n,this.height=l;const P=t.gl,A=this.framebuffer=P.createFramebuffer();if(this.colorAttachment=new ml(t,A),d)this.depthAttachment=y?new As(t,A):new so(t,A);else if(y)throw new Error("Stencil cannot be set without depth");if(P.checkFramebufferStatus(P.FRAMEBUFFER)!==P.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer is not complete")}destroy(){const t=this.context.gl,n=this.colorAttachment.get();if(n&&t.deleteTexture(n),this.depthAttachment){const l=this.depthAttachment.get();l&&t.deleteRenderbuffer(l)}t.deleteFramebuffer(this.framebuffer)}}class $i{constructor(t,n,l){this.blendFunction=t,this.blendColor=n,this.mask=l}}$i.Replace=[1,0],$i.disabled=new $i($i.Replace,s.aO.transparent,[!1,!1,!1,!1]),$i.unblended=new $i($i.Replace,s.aO.transparent,[!0,!0,!0,!0]),$i.alphaBlended=new $i([1,771],s.aO.transparent,[!0,!0,!0,!0]);class ms{constructor(t){var n,l;if(this.gl=t,this.clearColor=new Ia(this),this.clearDepth=new Pa(this),this.clearStencil=new Aa(this),this.colorMask=new la(this),this.depthMask=new to(this),this.stencilMask=new io(this),this.stencilFunc=new Is(this),this.stencilOp=new Ma(this),this.stencilTest=new ro(this),this.depthRange=new Jr(this),this.depthTest=new Lo(this),this.depthFunc=new Fo(this),this.blend=new pl(this),this.blendFunc=new zo(this),this.blendColor=new ka(this),this.blendEquation=new Ro(this),this.cullFace=new Da(this),this.cullFaceSide=new Oa(this),this.frontFace=new es(this),this.program=new La(this),this.activeTexture=new Xs(this),this.viewport=new Bo(this),this.bindFramebuffer=new Fa(this),this.bindRenderbuffer=new Ps(this),this.bindTexture=new ts(this),this.bindVertexBuffer=new za(this),this.bindElementBuffer=new ps(this),this.bindVertexArray=new Gn(this),this.pixelStoreUnpack=new jo(this),this.pixelStoreUnpackPremultiplyAlpha=new no(this),this.pixelStoreUnpackFlipY=new zi(this),this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),Hs(t)){this.HALF_FLOAT=t.HALF_FLOAT;const d=t.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(n=t.RGBA16F)!==null&&n!==void 0?n:d==null?void 0:d.RGBA16F_EXT,this.RGB16F=(l=t.RGB16F)!==null&&l!==void 0?l:d==null?void 0:d.RGB16F_EXT,t.getExtension("EXT_color_buffer_float")}else{t.getExtension("EXT_color_buffer_half_float"),t.getExtension("OES_texture_half_float_linear");const d=t.getExtension("OES_texture_half_float");this.HALF_FLOAT=d==null?void 0:d.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,n){return new fs(this,t,n)}createVertexBuffer(t,n,l){return new ln(this,t,n,l)}createRenderbuffer(t,n,l){const d=this.gl,y=d.createRenderbuffer();return this.bindRenderbuffer.set(y),d.renderbufferStorage(d.RENDERBUFFER,t,n,l),this.bindRenderbuffer.set(null),y}createFramebuffer(t,n,l,d){return new Ms(this,t,n,l,d)}clear({color:t,depth:n,stencil:l}){const d=this.gl;let y=0;t&&(y|=d.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set([!0,!0,!0,!0])),n!==void 0&&(y|=d.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(n),this.depthMask.set(!0)),l!==void 0&&(y|=d.STENCIL_BUFFER_BIT,this.clearStencil.set(l),this.stencilMask.set(255)),d.clear(y)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){s.aD(t.blendFunction,$i.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor)),this.colorMask.set(t.mask)}createVertexArray(){var t;return Hs(this.gl)?this.gl.createVertexArray():(t=this.gl.getExtension("OES_vertex_array_object"))===null||t===void 0?void 0:t.createVertexArrayOES()}deleteVertexArray(t){var n;return Hs(this.gl)?this.gl.deleteVertexArray(t):(n=this.gl.getExtension("OES_vertex_array_object"))===null||n===void 0?void 0:n.deleteVertexArrayOES(t)}unbindVAO(){this.bindVertexArray.set(null)}}class Ii{constructor(t,n,l){this.func=t,this.mask=n,this.range=l}}Ii.ReadOnly=!1,Ii.ReadWrite=!0,Ii.disabled=new Ii(519,Ii.ReadOnly,[0,1]);const Cn=7680;class Ji{constructor(t,n,l,d,y,P){this.test=t,this.ref=n,this.mask=l,this.fail=d,this.depthFail=y,this.pass=P}}Ji.disabled=new Ji({func:519,mask:0},0,0,Cn,Cn,Cn);class Wi{constructor(t,n,l){this.enable=t,this.mode=n,this.frontFace=l}}let Wn;function ca(g,t,n,l,d,y,P){const A=g.context,O=A.gl,R=g.useProgram("collisionBox"),N=[];let G=0,Z=0;for(let ge=0;ge<l.length;ge++){const ke=l[ge],He=t.getTile(ke),qe=He.getBucket(n);if(!qe)continue;let rt=ke.posMatrix;d[0]===0&&d[1]===0||(rt=g.translatePosMatrix(ke.posMatrix,He,d,y));const Ct=P?qe.textCollisionBox:qe.iconCollisionBox,_t=qe.collisionCircleArray;if(_t.length>0){const wt=s.F(),Xt=rt;s.aP(wt,qe.placementInvProjMatrix,g.transform.glCoordMatrix),s.aP(wt,wt,qe.placementViewportMatrix),N.push({circleArray:_t,circleOffset:Z,transform:Xt,invTransform:wt,coord:ke}),G+=_t.length/4,Z=G}Ct&&R.draw(A,O.LINES,Ii.disabled,Ji.disabled,g.colorModeForRenderPass(),Wi.disabled,Ut(rt,g.transform,He),g.style.map.terrain&&g.style.map.terrain.getTerrainData(ke),n.id,Ct.layoutVertexBuffer,Ct.indexBuffer,Ct.segments,null,g.transform.zoom,null,null,Ct.collisionVertexBuffer)}if(!P||!N.length)return;const ce=g.useProgram("collisionCircle"),oe=new s.aQ;oe.resize(4*G),oe._trim();let ue=0;for(const ge of N)for(let ke=0;ke<ge.circleArray.length/4;ke++){const He=4*ke,qe=ge.circleArray[He+0],rt=ge.circleArray[He+1],Ct=ge.circleArray[He+2],_t=ge.circleArray[He+3];oe.emplace(ue++,qe,rt,Ct,_t,0),oe.emplace(ue++,qe,rt,Ct,_t,1),oe.emplace(ue++,qe,rt,Ct,_t,2),oe.emplace(ue++,qe,rt,Ct,_t,3)}(!Wn||Wn.length<2*G)&&(Wn=function(ge){const ke=2*ge,He=new s.aS;He.resize(ke),He._trim();for(let qe=0;qe<ke;qe++){const rt=6*qe;He.uint16[rt+0]=4*qe+0,He.uint16[rt+1]=4*qe+1,He.uint16[rt+2]=4*qe+2,He.uint16[rt+3]=4*qe+2,He.uint16[rt+4]=4*qe+3,He.uint16[rt+5]=4*qe+0}return He}(G));const te=A.createIndexBuffer(Wn,!0),Se=A.createVertexBuffer(oe,s.aR.members,!0);for(const ge of N){const ke={u_matrix:ge.transform,u_inv_matrix:ge.invTransform,u_camera_to_center_distance:(We=g.transform).cameraToCenterDistance,u_viewport_size:[We.width,We.height]};ce.draw(A,O.TRIANGLES,Ii.disabled,Ji.disabled,g.colorModeForRenderPass(),Wi.disabled,ke,g.style.map.terrain&&g.style.map.terrain.getTerrainData(ge.coord),n.id,Se,te,s.$.simpleSegment(0,2*ge.circleOffset,ge.circleArray.length,ge.circleArray.length/2),null,g.transform.zoom,null,null,null)}var We;Se.destroy(),te.destroy()}Wi.disabled=new Wi(!1,1029,2305),Wi.backCCW=new Wi(!0,1029,2305);const ao=s.an(new Float32Array(16));function Ra(g,t,n,l,d,y){const{horizontalAlign:P,verticalAlign:A}=s.at(g);return new s.P((-(P-.5)*t/d+l[0])*y,(-(A-.5)*n/d+l[1])*y)}function Ba(g,t,n,l,d,y,P,A,O,R,N){const G=g.text.placedSymbolArray,Z=g.text.dynamicLayoutVertexArray,ce=g.icon.dynamicLayoutVertexArray,oe={};Z.clear();for(let ue=0;ue<G.length;ue++){const te=G.get(ue),Se=te.hidden||!te.crossTileID||g.allowVerticalPlacement&&!te.placedOrientation?null:l[te.crossTileID];if(Se){const We=new s.P(te.anchorX,te.anchorY),ge=se(We,n?P:y,N),ke=W(d.cameraToCenterDistance,ge.signedDistanceFromCamera);let He=s.ai(g.textSizeData,O,te)*ke/s.ao;n&&(He*=g.tilePixelRatio/A);const{width:qe,height:rt,anchor:Ct,textOffset:_t,textBoxScale:wt}=Se,Xt=Ra(Ct,qe,rt,_t,wt,He),vi=n?se(We.add(Xt),y,N).point:ge.point.add(t?Xt.rotate(-d.angle):Xt),Ft=g.allowVerticalPlacement&&te.placedOrientation===s.ah.vertical?Math.PI/2:0;for(let di=0;di<te.numGlyphs;di++)s.aj(Z,vi,Ft);R&&te.associatedIconIndex>=0&&(oe[te.associatedIconIndex]={shiftedAnchor:vi,angle:Ft})}else Jt(te.numGlyphs,Z)}if(R){ce.clear();const ue=g.icon.placedSymbolArray;for(let te=0;te<ue.length;te++){const Se=ue.get(te);if(Se.hidden)Jt(Se.numGlyphs,ce);else{const We=oe[te];if(We)for(let ge=0;ge<Se.numGlyphs;ge++)s.aj(ce,We.shiftedAnchor,We.angle);else Jt(Se.numGlyphs,ce)}}g.icon.dynamicLayoutVertexBuffer.updateData(ce)}g.text.dynamicLayoutVertexBuffer.updateData(Z)}function ja(g,t,n){return n.iconsInText&&t?"symbolTextAndIcon":g?"symbolSDF":"symbolIcon"}function oo(g,t,n,l,d,y,P,A,O,R,N,G){const Z=g.context,ce=Z.gl,oe=g.transform,ue=A==="map",te=O==="map",Se=A!=="viewport"&&n.layout.get("symbol-placement")!=="point",We=ue&&!te&&!Se,ge=!n.layout.get("symbol-sort-key").isConstant();let ke=!1;const He=g.depthModeForSublayer(0,Ii.ReadOnly),qe=n._unevaluatedLayout.hasValue("text-variable-anchor")||n._unevaluatedLayout.hasValue("text-variable-anchor-offset"),rt=[];for(const Ct of l){const _t=t.getTile(Ct),wt=_t.getBucket(n);if(!wt)continue;const Xt=d?wt.text:wt.icon;if(!Xt||!Xt.segments.get().length||!Xt.hasVisibleVertices)continue;const vi=Xt.programConfigurations.get(n.id),Ft=d||wt.sdfIcons,di=d?wt.textSizeData:wt.iconSizeData,Ci=te||oe.pitch!==0,Oi=g.useProgram(ja(Ft,d,wt),vi),_i=s.ag(di,oe.zoom),Si=g.style.map.terrain&&g.style.map.terrain.getTerrainData(Ct);let Ti,vr,er,In,kr=[0,0],rr=null;if(d)vr=_t.glyphAtlasTexture,er=ce.LINEAR,Ti=_t.glyphAtlasTexture.size,wt.iconsInText&&(kr=_t.imageAtlasTexture.size,rr=_t.imageAtlasTexture,In=Ci||g.options.rotating||g.options.zooming||di.kind==="composite"||di.kind==="camera"?ce.LINEAR:ce.NEAREST);else{const pr=n.layout.get("icon-size").constantOr(0)!==1||wt.iconsNeedLinear;vr=_t.imageAtlasTexture,er=Ft||g.options.rotating||g.options.zooming||pr||Ci?ce.LINEAR:ce.NEAREST,Ti=_t.imageAtlasTexture.size}const cn=pi(_t,1,g.transform.zoom),ss=wn(Ct.posMatrix,te,ue,g.transform,cn),vs=$r(Ct.posMatrix,te,ue,g.transform,cn),ga=qe&&wt.hasTextData(),_a=n.layout.get("icon-text-fit")!=="none"&&ga&&wt.hasIconData();if(Se){const pr=g.style.map.terrain?(Fn,Di)=>g.style.map.terrain.getElevation(Ct,Fn,Di):null,Xr=n.layout.get("text-rotation-alignment")==="map";J(wt,Ct.posMatrix,g,d,ss,vs,te,R,Xr,pr)}const xs=g.translatePosMatrix(Ct.posMatrix,_t,y,P),as=Se||d&&qe||_a?ao:ss,Sr=g.translatePosMatrix(vs,_t,y,P,!0),or=Ft&&n.paint.get(d?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let Ir;Ir=Ft?wt.iconsInText?fl(di.kind,_i,We,te,g,xs,as,Sr,Ti,kr):Es(di.kind,_i,We,te,g,xs,as,Sr,d,Ti,!0):qi(di.kind,_i,We,te,g,xs,as,Sr,d,Ti);const Ha={program:Oi,buffers:Xt,uniformValues:Ir,atlasTexture:vr,atlasTextureIcon:rr,atlasInterpolation:er,atlasInterpolationIcon:In,isSDF:Ft,hasHalo:or};if(ge&&wt.canOverlap){ke=!0;const pr=Xt.segments.get();for(const Xr of pr)rt.push({segments:new s.$([Xr]),sortKey:Xr.sortKey,state:Ha,terrainData:Si})}else rt.push({segments:Xt.segments,sortKey:0,state:Ha,terrainData:Si})}ke&&rt.sort((Ct,_t)=>Ct.sortKey-_t.sortKey);for(const Ct of rt){const _t=Ct.state;if(Z.activeTexture.set(ce.TEXTURE0),_t.atlasTexture.bind(_t.atlasInterpolation,ce.CLAMP_TO_EDGE),_t.atlasTextureIcon&&(Z.activeTexture.set(ce.TEXTURE1),_t.atlasTextureIcon&&_t.atlasTextureIcon.bind(_t.atlasInterpolationIcon,ce.CLAMP_TO_EDGE)),_t.isSDF){const wt=_t.uniformValues;_t.hasHalo&&(wt.u_is_halo=1,ks(_t.buffers,Ct.segments,n,g,_t.program,He,N,G,wt,Ct.terrainData)),wt.u_is_halo=0}ks(_t.buffers,Ct.segments,n,g,_t.program,He,N,G,_t.uniformValues,Ct.terrainData)}}function ks(g,t,n,l,d,y,P,A,O,R){const N=l.context;d.draw(N,N.gl.TRIANGLES,y,P,A,Wi.disabled,O,R,n.id,g.layoutVertexBuffer,g.indexBuffer,t,n.paint,l.transform.zoom,g.programConfigurations.get(n.id),g.dynamicLayoutVertexBuffer,g.opacityVertexBuffer)}function Ds(g,t,n,l,d){if(!n||!l||!l.imageAtlas)return;const y=l.imageAtlas.patternPositions;let P=y[n.to.toString()],A=y[n.from.toString()];if(!P&&A&&(P=A),!A&&P&&(A=P),!P||!A){const O=d.getPaintProperty(t);P=y[O],A=y[O]}P&&A&&g.setConstantPatternPositions(P,A)}function lo(g,t,n,l,d,y,P){const A=g.context.gl,O="fill-pattern",R=n.paint.get(O),N=R&&R.constantOr(1),G=n.getCrossfadeParameters();let Z,ce,oe,ue,te;P?(ce=N&&!n.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Z=A.LINES):(ce=N?"fillPattern":"fill",Z=A.TRIANGLES);const Se=R.constantOr(null);for(const We of l){const ge=t.getTile(We);if(N&&!ge.patternsLoaded())continue;const ke=ge.getBucket(n);if(!ke)continue;const He=ke.programConfigurations.get(n.id),qe=g.useProgram(ce,He),rt=g.style.map.terrain&&g.style.map.terrain.getTerrainData(We);N&&(g.context.activeTexture.set(A.TEXTURE0),ge.imageAtlasTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE),He.updatePaintBuffers(G)),Ds(He,O,Se,ge,n);const Ct=rt?We:null,_t=g.translatePosMatrix(Ct?Ct.posMatrix:We.posMatrix,ge,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor"));if(P){ue=ke.indexBuffer2,te=ke.segments2;const wt=[A.drawingBufferWidth,A.drawingBufferHeight];oe=ce==="fillOutlinePattern"&&N?Mt(_t,g,G,ge,wt):Tt(_t,wt)}else ue=ke.indexBuffer,te=ke.segments,oe=N?Fe(_t,g,G,ge):Ee(_t);qe.draw(g.context,Z,d,g.stencilModeForClipping(We),y,Wi.disabled,oe,rt,n.id,ke.layoutVertexBuffer,ue,te,n.paint,g.transform.zoom,He)}}function pn(g,t,n,l,d,y,P){const A=g.context,O=A.gl,R="fill-extrusion-pattern",N=n.paint.get(R),G=N.constantOr(1),Z=n.getCrossfadeParameters(),ce=n.paint.get("fill-extrusion-opacity"),oe=N.constantOr(null);for(const ue of l){const te=t.getTile(ue),Se=te.getBucket(n);if(!Se)continue;const We=g.style.map.terrain&&g.style.map.terrain.getTerrainData(ue),ge=Se.programConfigurations.get(n.id),ke=g.useProgram(G?"fillExtrusionPattern":"fillExtrusion",ge);G&&(g.context.activeTexture.set(O.TEXTURE0),te.imageAtlasTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE),ge.updatePaintBuffers(Z)),Ds(ge,R,oe,te,n);const He=g.translatePosMatrix(ue.posMatrix,te,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),qe=n.paint.get("fill-extrusion-vertical-gradient"),rt=G?Te(He,g,qe,ce,ue,Z,te):me(He,g,qe,ce);ke.draw(A,A.gl.TRIANGLES,d,y,P,Wi.backCCW,rt,We,n.id,Se.layoutVertexBuffer,Se.indexBuffer,Se.segments,n.paint,g.transform.zoom,ge,g.style.map.terrain&&Se.centroidVertexBuffer)}}function co(g,t,n,l,d,y,P){const A=g.context,O=A.gl,R=n.fbo;if(!R)return;const N=g.useProgram("hillshade"),G=g.style.map.terrain&&g.style.map.terrain.getTerrainData(t);A.activeTexture.set(O.TEXTURE0),O.bindTexture(O.TEXTURE_2D,R.colorAttachment.get()),N.draw(A,O.TRIANGLES,d,y,P,Wi.disabled,((Z,ce,oe,ue)=>{const te=oe.paint.get("hillshade-shadow-color"),Se=oe.paint.get("hillshade-highlight-color"),We=oe.paint.get("hillshade-accent-color");let ge=oe.paint.get("hillshade-illumination-direction")*(Math.PI/180);oe.paint.get("hillshade-illumination-anchor")==="viewport"&&(ge-=Z.transform.angle);const ke=!Z.options.moving;return{u_matrix:ue?ue.posMatrix:Z.transform.calculatePosMatrix(ce.tileID.toUnwrapped(),ke),u_image:0,u_latrange:wi(0,ce.tileID),u_light:[oe.paint.get("hillshade-exaggeration"),ge],u_shadow:te,u_highlight:Se,u_accent:We}})(g,n,l,G?t:null),G,l.id,g.rasterBoundsBuffer,g.quadTriangleIndexBuffer,g.rasterBoundsSegments)}function gs(g,t,n,l,d,y){const P=g.context,A=P.gl,O=t.dem;if(O&&O.data){const R=O.dim,N=O.stride,G=O.getPixels();if(P.activeTexture.set(A.TEXTURE1),P.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||g.getTileTexture(N),t.demTexture){const ce=t.demTexture;ce.update(G,{premultiply:!1}),ce.bind(A.NEAREST,A.CLAMP_TO_EDGE)}else t.demTexture=new $e(P,G,A.RGBA,{premultiply:!1}),t.demTexture.bind(A.NEAREST,A.CLAMP_TO_EDGE);P.activeTexture.set(A.TEXTURE0);let Z=t.fbo;if(!Z){const ce=new $e(P,{width:R,height:R,data:null},A.RGBA);ce.bind(A.LINEAR,A.CLAMP_TO_EDGE),Z=t.fbo=P.createFramebuffer(R,R,!0,!1),Z.colorAttachment.set(ce.texture)}P.bindFramebuffer.set(Z.framebuffer),P.viewport.set([0,0,R,R]),g.useProgram("hillshadePrepare").draw(P,A.TRIANGLES,l,d,y,Wi.disabled,((ce,oe)=>{const ue=oe.stride,te=s.F();return s.aN(te,0,s.W,-s.W,0,0,1),s.H(te,te,[0,-s.W,0]),{u_matrix:te,u_image:1,u_dimension:[ue,ue],u_zoom:ce.overscaledZ,u_unpack:oe.getUnpackVector()}})(t.tileID,O),null,n.id,g.rasterBoundsBuffer,g.quadTriangleIndexBuffer,g.rasterBoundsSegments),t.needsHillshadePrepare=!1}}function ho(g,t,n,l,d,y){const P=l.paint.get("raster-fade-duration");if(!y&&P>0){const A=o.now(),O=(A-g.timeAdded)/P,R=t?(A-t.timeAdded)/P:-1,N=n.getSource(),G=d.coveringZoomLevel({tileSize:N.tileSize,roundZoom:N.roundZoom}),Z=!t||Math.abs(t.tileID.overscaledZ-G)>Math.abs(g.tileID.overscaledZ-G),ce=Z&&g.refreshedUponExpiration?1:s.ac(Z?O:1-R,0,1);return g.refreshedUponExpiration&&O>=1&&(g.refreshedUponExpiration=!1),t?{opacity:1,mix:1-ce}:{opacity:ce,mix:0}}return{opacity:1,mix:0}}const Na=new s.aO(1,0,0,1),$s=new s.aO(0,1,0,1),uo=new s.aO(0,0,1,1),fo=new s.aO(1,0,1,1),dr=new s.aO(0,1,1,1);function is(g,t,n,l){Os(g,0,t+n/2,g.transform.width,n,l)}function zr(g,t,n,l){Os(g,t-n/2,0,n,g.transform.height,l)}function Os(g,t,n,l,d,y){const P=g.context,A=P.gl;A.enable(A.SCISSOR_TEST),A.scissor(t*g.pixelRatio,n*g.pixelRatio,l*g.pixelRatio,d*g.pixelRatio),P.clear({color:y}),A.disable(A.SCISSOR_TEST)}function po(g,t,n){const l=g.context,d=l.gl,y=n.posMatrix,P=g.useProgram("debug"),A=Ii.disabled,O=Ji.disabled,R=g.colorModeForRenderPass(),N="$debug",G=g.style.map.terrain&&g.style.map.terrain.getTerrainData(n);l.activeTexture.set(d.TEXTURE0);const Z=t.getTileByID(n.key).latestRawTileData,ce=Math.floor((Z&&Z.byteLength||0)/1024),oe=t.getTile(n).tileSize,ue=512/Math.min(oe,512)*(n.overscaledZ/g.transform.zoom)*.5;let te=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(te+=` => ${n.overscaledZ}`),function(Se,We){Se.initDebugOverlayCanvas();const ge=Se.debugOverlayCanvas,ke=Se.context.gl,He=Se.debugOverlayCanvas.getContext("2d");He.clearRect(0,0,ge.width,ge.height),He.shadowColor="white",He.shadowBlur=2,He.lineWidth=1.5,He.strokeStyle="white",He.textBaseline="top",He.font="bold 36px Open Sans, sans-serif",He.fillText(We,5,5),He.strokeText(We,5,5),Se.debugOverlayTexture.update(ge),Se.debugOverlayTexture.bind(ke.LINEAR,ke.CLAMP_TO_EDGE)}(g,`${te} ${ce}kB`),P.draw(l,d.TRIANGLES,A,O,$i.alphaBlended,Wi.disabled,Dt(y,s.aO.transparent,ue),null,N,g.debugBuffer,g.quadTriangleIndexBuffer,g.debugSegments),P.draw(l,d.LINE_STRIP,A,O,R,Wi.disabled,Dt(y,s.aO.red),G,N,g.debugBuffer,g.tileBorderIndexBuffer,g.debugSegments)}function ze(g,t,n){const l=g.context,d=l.gl,y=g.colorModeForRenderPass(),P=new Ii(d.LEQUAL,Ii.ReadWrite,g.depthRangeFor3D),A=g.useProgram("terrain"),O=t.getTerrainMesh();l.bindFramebuffer.set(null),l.viewport.set([0,0,g.width,g.height]);for(const R of n){const N=g.renderToTexture.getTexture(R),G=t.getTerrainData(R.tileID);l.activeTexture.set(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,N.texture);const Z={u_matrix:g.transform.calculatePosMatrix(R.tileID.toUnwrapped()),u_texture:0,u_ele_delta:t.getMeshFrameDelta(g.transform.zoom)};A.draw(l,d.TRIANGLES,P,Ji.disabled,y,Wi.backCCW,Z,G,"terrain",O.vertexBuffer,O.indexBuffer,O.segments)}}class tt{constructor(t,n){this.context=new ms(t),this.transform=n,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:s.an(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=xt.maxUnderzooming+xt.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new gr}resize(t,n,l){if(this.width=Math.floor(t*l),this.height=Math.floor(n*l),this.pixelRatio=l,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const d of this.style._order)this.style._layers[d].resize()}setup(){const t=this.context,n=new s.aV;n.emplaceBack(0,0),n.emplaceBack(s.W,0),n.emplaceBack(0,s.W),n.emplaceBack(s.W,s.W),this.tileExtentBuffer=t.createVertexBuffer(n,On.members),this.tileExtentSegments=s.$.simpleSegment(0,0,4,2);const l=new s.aV;l.emplaceBack(0,0),l.emplaceBack(s.W,0),l.emplaceBack(0,s.W),l.emplaceBack(s.W,s.W),this.debugBuffer=t.createVertexBuffer(l,On.members),this.debugSegments=s.$.simpleSegment(0,0,4,5);const d=new s.Z;d.emplaceBack(0,0,0,0),d.emplaceBack(s.W,0,s.W,0),d.emplaceBack(0,s.W,0,s.W),d.emplaceBack(s.W,s.W,s.W,s.W),this.rasterBoundsBuffer=t.createVertexBuffer(d,Ot.members),this.rasterBoundsSegments=s.$.simpleSegment(0,0,4,2);const y=new s.aV;y.emplaceBack(0,0),y.emplaceBack(1,0),y.emplaceBack(0,1),y.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(y,On.members),this.viewportSegments=s.$.simpleSegment(0,0,4,2);const P=new s.aW;P.emplaceBack(0),P.emplaceBack(1),P.emplaceBack(3),P.emplaceBack(2),P.emplaceBack(0),this.tileBorderIndexBuffer=t.createIndexBuffer(P);const A=new s.aX;A.emplaceBack(0,1,2),A.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(A);const O=this.context.gl;this.stencilClearMode=new Ji({func:O.ALWAYS,mask:0},0,255,O.ZERO,O.ZERO,O.ZERO)}clearStencil(){const t=this.context,n=t.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const l=s.F();s.aN(l,0,this.width,this.height,0,0,1),s.J(l,l,[n.drawingBufferWidth,n.drawingBufferHeight,0]),this.useProgram("clippingMask").draw(t,n.TRIANGLES,Ii.disabled,this.stencilClearMode,$i.disabled,Wi.disabled,yi(l),null,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(t,n){if(this.currentStencilSource===t.source||!t.isTileClipped()||!n||!n.length)return;this.currentStencilSource=t.source;const l=this.context,d=l.gl;this.nextStencilID+n.length>256&&this.clearStencil(),l.setColorMode($i.disabled),l.setDepthMode(Ii.disabled);const y=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const P of n){const A=this._tileClippingMaskIDs[P.key]=this.nextStencilID++,O=this.style.map.terrain&&this.style.map.terrain.getTerrainData(P);y.draw(l,d.TRIANGLES,Ii.disabled,new Ji({func:d.ALWAYS,mask:0},A,255,d.KEEP,d.KEEP,d.REPLACE),$i.disabled,Wi.disabled,yi(P.posMatrix),O,"$clipping",this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,n=this.context.gl;return new Ji({func:n.NOTEQUAL,mask:255},t,255,n.KEEP,n.KEEP,n.REPLACE)}stencilModeForClipping(t){const n=this.context.gl;return new Ji({func:n.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,n.KEEP,n.KEEP,n.REPLACE)}stencilConfigForOverlap(t){const n=this.context.gl,l=t.sort((P,A)=>A.overscaledZ-P.overscaledZ),d=l[l.length-1].overscaledZ,y=l[0].overscaledZ-d+1;if(y>1){this.currentStencilSource=void 0,this.nextStencilID+y>256&&this.clearStencil();const P={};for(let A=0;A<y;A++)P[A+d]=new Ji({func:n.GEQUAL,mask:255},A+this.nextStencilID,255,n.KEEP,n.KEEP,n.REPLACE);return this.nextStencilID+=y,[P,l]}return[{[d]:Ji.disabled},l]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new $i([t.CONSTANT_COLOR,t.ONE],new s.aO(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?$i.unblended:$i.alphaBlended}depthModeForSublayer(t,n,l){if(!this.opaquePassEnabledForLayer())return Ii.disabled;const d=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new Ii(l||this.context.gl.LEQUAL,n,[d,d])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(t,n){this.style=t,this.options=n,this.lineAtlas=t.lineAtlas,this.imageManager=t.imageManager,this.glyphManager=t.glyphManager,this.symbolFadeChange=t.placement.symbolFadeChange(o.now()),this.imageManager.beginFrame();const l=this.style._order,d=this.style.sourceCaches,y={},P={},A={};for(const O in d){const R=d[O];R.used&&R.prepare(this.context),y[O]=R.getVisibleCoordinates(),P[O]=y[O].slice().reverse(),A[O]=R.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let O=0;O<l.length;O++)if(this.style._layers[l[O]].is3D()){this.opaquePassCutoff=O;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const O of l){const R=this.style._layers[O];if(!R.hasOffscreenPass()||R.isHidden(this.transform.zoom))continue;const N=P[R.source];(R.type==="custom"||N.length)&&this.renderLayer(this,d[R.source],R,N)}if(this.context.bindFramebuffer.set(null),this.context.clear({color:n.showOverdrawInspector?s.aO.black:s.aO.transparent,depth:1}),this.clearStencil(),this._showOverdrawInspector=n.showOverdrawInspector,this.depthRangeFor3D=[0,1-(t._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=l.length-1;this.currentLayer>=0;this.currentLayer--){const O=this.style._layers[l[this.currentLayer]],R=d[O.source],N=y[O.source];this._renderTileClippingMasks(O,N),this.renderLayer(this,R,O,N)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<l.length;this.currentLayer++){const O=this.style._layers[l[this.currentLayer]],R=d[O.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(O))continue;const N=(O.type==="symbol"?A:P)[O.source];this._renderTileClippingMasks(O,y[O.source]),this.renderLayer(this,R,O,N)}if(this.options.showTileBoundaries){const O=function(R,N){let G=null;const Z=Object.values(R._layers).flatMap(te=>te.source&&!te.isHidden(N)?[R.sourceCaches[te.source]]:[]),ce=Z.filter(te=>te.getSource().type==="vector"),oe=Z.filter(te=>te.getSource().type!=="vector"),ue=te=>{(!G||G.getSource().maxzoom<te.getSource().maxzoom)&&(G=te)};return ce.forEach(te=>ue(te)),G||oe.forEach(te=>ue(te)),G}(this.style,this.transform.zoom);O&&function(R,N,G){for(let Z=0;Z<G.length;Z++)po(R,N,G[Z])}(this,O,O.getVisibleCoordinates())}this.options.showPadding&&function(O){const R=O.transform.padding;is(O,O.transform.height-(R.top||0),3,Na),is(O,R.bottom||0,3,$s),zr(O,R.left||0,3,uo),zr(O,O.transform.width-(R.right||0),3,fo);const N=O.transform.centerPoint;(function(G,Z,ce,oe){Os(G,Z-1,ce-10,2,20,oe),Os(G,Z-10,ce-1,20,2,oe)})(O,N.x,O.transform.height-N.y,dr)}(this),this.context.setDefault()}maybeDrawDepthAndCoords(t){if(!this.style||!this.style.map||!this.style.map.terrain)return;const n=this.terrainFacilitator.matrix,l=this.transform.projMatrix;let d=this.terrainFacilitator.dirty;d||(d=t?!s.aY(n,l):!s.aZ(n,l)),d||(d=this.style.map.terrain.sourceCache.tilesAfterTime(this.terrainFacilitator.renderTime).length>0),d&&(s.a_(n,l),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(y,P){const A=y.context,O=A.gl,R=$i.unblended,N=new Ii(O.LEQUAL,Ii.ReadWrite,[0,1]),G=P.getTerrainMesh(),Z=P.sourceCache.getRenderableTiles(),ce=y.useProgram("terrainDepth");A.bindFramebuffer.set(P.getFramebuffer("depth").framebuffer),A.viewport.set([0,0,y.width/devicePixelRatio,y.height/devicePixelRatio]),A.clear({color:s.aO.transparent,depth:1});for(const oe of Z){const ue=P.getTerrainData(oe.tileID),te={u_matrix:y.transform.calculatePosMatrix(oe.tileID.toUnwrapped()),u_ele_delta:P.getMeshFrameDelta(y.transform.zoom)};ce.draw(A,O.TRIANGLES,N,Ji.disabled,R,Wi.backCCW,te,ue,"terrain",G.vertexBuffer,G.indexBuffer,G.segments)}A.bindFramebuffer.set(null),A.viewport.set([0,0,y.width,y.height])}(this,this.style.map.terrain),function(y,P){const A=y.context,O=A.gl,R=$i.unblended,N=new Ii(O.LEQUAL,Ii.ReadWrite,[0,1]),G=P.getTerrainMesh(),Z=P.getCoordsTexture(),ce=P.sourceCache.getRenderableTiles(),oe=y.useProgram("terrainCoords");A.bindFramebuffer.set(P.getFramebuffer("coords").framebuffer),A.viewport.set([0,0,y.width/devicePixelRatio,y.height/devicePixelRatio]),A.clear({color:s.aO.transparent,depth:1}),P.coordsIndex=[];for(const ue of ce){const te=P.getTerrainData(ue.tileID);A.activeTexture.set(O.TEXTURE0),O.bindTexture(O.TEXTURE_2D,Z.texture);const Se={u_matrix:y.transform.calculatePosMatrix(ue.tileID.toUnwrapped()),u_terrain_coords_id:(255-P.coordsIndex.length)/255,u_texture:0,u_ele_delta:P.getMeshFrameDelta(y.transform.zoom)};oe.draw(A,O.TRIANGLES,N,Ji.disabled,R,Wi.backCCW,Se,te,"terrain",G.vertexBuffer,G.indexBuffer,G.segments),P.coordsIndex.push(ue.tileID.key)}A.bindFramebuffer.set(null),A.viewport.set([0,0,y.width,y.height])}(this,this.style.map.terrain))}renderLayer(t,n,l,d){if(!l.isHidden(this.transform.zoom)&&(l.type==="background"||l.type==="custom"||(d||[]).length))switch(this.id=l.id,l.type){case"symbol":(function(y,P,A,O,R){if(y.renderPass!=="translucent")return;const N=Ji.disabled,G=y.colorModeForRenderPass();(A._unevaluatedLayout.hasValue("text-variable-anchor")||A._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(Z,ce,oe,ue,te,Se,We){const ge=ce.transform,ke=te==="map",He=Se==="map";for(const qe of Z){const rt=ue.getTile(qe),Ct=rt.getBucket(oe);if(!Ct||!Ct.text||!Ct.text.segments.get().length)continue;const _t=s.ag(Ct.textSizeData,ge.zoom),wt=pi(rt,1,ce.transform.zoom),Xt=wn(qe.posMatrix,He,ke,ce.transform,wt),vi=oe.layout.get("icon-text-fit")!=="none"&&Ct.hasIconData();if(_t){const Ft=Math.pow(2,ge.zoom-rt.tileID.overscaledZ);Ba(Ct,ke,He,We,ge,Xt,qe.posMatrix,Ft,_t,vi,ce.style.map.terrain?(di,Ci)=>ce.style.map.terrain.getElevation(qe,di,Ci):null)}}}(O,y,A,P,A.layout.get("text-rotation-alignment"),A.layout.get("text-pitch-alignment"),R),A.paint.get("icon-opacity").constantOr(1)!==0&&oo(y,P,A,O,!1,A.paint.get("icon-translate"),A.paint.get("icon-translate-anchor"),A.layout.get("icon-rotation-alignment"),A.layout.get("icon-pitch-alignment"),A.layout.get("icon-keep-upright"),N,G),A.paint.get("text-opacity").constantOr(1)!==0&&oo(y,P,A,O,!0,A.paint.get("text-translate"),A.paint.get("text-translate-anchor"),A.layout.get("text-rotation-alignment"),A.layout.get("text-pitch-alignment"),A.layout.get("text-keep-upright"),N,G),P.map.showCollisionBoxes&&(ca(y,P,A,O,A.paint.get("text-translate"),A.paint.get("text-translate-anchor"),!0),ca(y,P,A,O,A.paint.get("icon-translate"),A.paint.get("icon-translate-anchor"),!1))})(t,n,l,d,this.style.placement.variableOffsets);break;case"circle":(function(y,P,A,O){if(y.renderPass!=="translucent")return;const R=A.paint.get("circle-opacity"),N=A.paint.get("circle-stroke-width"),G=A.paint.get("circle-stroke-opacity"),Z=!A.layout.get("circle-sort-key").isConstant();if(R.constantOr(1)===0&&(N.constantOr(1)===0||G.constantOr(1)===0))return;const ce=y.context,oe=ce.gl,ue=y.depthModeForSublayer(0,Ii.ReadOnly),te=Ji.disabled,Se=y.colorModeForRenderPass(),We=[];for(let ge=0;ge<O.length;ge++){const ke=O[ge],He=P.getTile(ke),qe=He.getBucket(A);if(!qe)continue;const rt=qe.programConfigurations.get(A.id),Ct=y.useProgram("circle",rt),_t=qe.layoutVertexBuffer,wt=qe.indexBuffer,Xt=y.style.map.terrain&&y.style.map.terrain.getTerrainData(ke),vi={programConfiguration:rt,program:Ct,layoutVertexBuffer:_t,indexBuffer:wt,uniformValues:jt(y,ke,He,A),terrainData:Xt};if(Z){const Ft=qe.segments.get();for(const di of Ft)We.push({segments:new s.$([di]),sortKey:di.sortKey,state:vi})}else We.push({segments:qe.segments,sortKey:0,state:vi})}Z&&We.sort((ge,ke)=>ge.sortKey-ke.sortKey);for(const ge of We){const{programConfiguration:ke,program:He,layoutVertexBuffer:qe,indexBuffer:rt,uniformValues:Ct,terrainData:_t}=ge.state;He.draw(ce,oe.TRIANGLES,ue,te,Se,Wi.disabled,Ct,_t,A.id,qe,rt,ge.segments,A.paint,y.transform.zoom,ke)}})(t,n,l,d);break;case"heatmap":(function(y,P,A,O){if(A.paint.get("heatmap-opacity")!==0)if(y.renderPass==="offscreen"){const R=y.context,N=R.gl,G=Ji.disabled,Z=new $i([N.ONE,N.ONE],s.aO.transparent,[!0,!0,!0,!0]);(function(ce,oe,ue){const te=ce.gl;ce.activeTexture.set(te.TEXTURE1),ce.viewport.set([0,0,oe.width/4,oe.height/4]);let Se=ue.heatmapFbo;if(Se)te.bindTexture(te.TEXTURE_2D,Se.colorAttachment.get()),ce.bindFramebuffer.set(Se.framebuffer);else{const We=te.createTexture();te.bindTexture(te.TEXTURE_2D,We),te.texParameteri(te.TEXTURE_2D,te.TEXTURE_WRAP_S,te.CLAMP_TO_EDGE),te.texParameteri(te.TEXTURE_2D,te.TEXTURE_WRAP_T,te.CLAMP_TO_EDGE),te.texParameteri(te.TEXTURE_2D,te.TEXTURE_MIN_FILTER,te.LINEAR),te.texParameteri(te.TEXTURE_2D,te.TEXTURE_MAG_FILTER,te.LINEAR),Se=ue.heatmapFbo=ce.createFramebuffer(oe.width/4,oe.height/4,!1,!1),function(ge,ke,He,qe){var rt,Ct;const _t=ge.gl,wt=(rt=ge.HALF_FLOAT)!==null&&rt!==void 0?rt:_t.UNSIGNED_BYTE,Xt=(Ct=ge.RGBA16F)!==null&&Ct!==void 0?Ct:_t.RGBA;_t.texImage2D(_t.TEXTURE_2D,0,Xt,ke.width/4,ke.height/4,0,_t.RGBA,wt,null),qe.colorAttachment.set(He)}(ce,oe,We,Se)}})(R,y,A),R.clear({color:s.aO.transparent});for(let ce=0;ce<O.length;ce++){const oe=O[ce];if(P.hasRenderableParent(oe))continue;const ue=P.getTile(oe),te=ue.getBucket(A);if(!te)continue;const Se=te.programConfigurations.get(A.id),We=y.useProgram("heatmap",Se),{zoom:ge}=y.transform;We.draw(R,N.TRIANGLES,Ii.disabled,G,Z,Wi.disabled,nr(oe.posMatrix,ue,ge,A.paint.get("heatmap-intensity")),null,A.id,te.layoutVertexBuffer,te.indexBuffer,te.segments,A.paint,y.transform.zoom,Se)}R.viewport.set([0,0,y.width,y.height])}else y.renderPass==="translucent"&&(y.context.setColorMode(y.colorModeForRenderPass()),function(R,N){const G=R.context,Z=G.gl,ce=N.heatmapFbo;if(!ce)return;G.activeTexture.set(Z.TEXTURE0),Z.bindTexture(Z.TEXTURE_2D,ce.colorAttachment.get()),G.activeTexture.set(Z.TEXTURE1);let oe=N.colorRampTexture;oe||(oe=N.colorRampTexture=new $e(G,N.colorRamp,Z.RGBA)),oe.bind(Z.LINEAR,Z.CLAMP_TO_EDGE),R.useProgram("heatmapTexture").draw(G,Z.TRIANGLES,Ii.disabled,Ji.disabled,R.colorModeForRenderPass(),Wi.disabled,((ue,te,Se,We)=>{const ge=s.F();s.aN(ge,0,ue.width,ue.height,0,0,1);const ke=ue.context.gl;return{u_matrix:ge,u_world:[ke.drawingBufferWidth,ke.drawingBufferHeight],u_image:0,u_color_ramp:1,u_opacity:te.paint.get("heatmap-opacity")}})(R,N),null,N.id,R.viewportBuffer,R.quadTriangleIndexBuffer,R.viewportSegments,N.paint,R.transform.zoom)}(y,A))})(t,n,l,d);break;case"line":(function(y,P,A,O){if(y.renderPass!=="translucent")return;const R=A.paint.get("line-opacity"),N=A.paint.get("line-width");if(R.constantOr(1)===0||N.constantOr(1)===0)return;const G=y.depthModeForSublayer(0,Ii.ReadOnly),Z=y.colorModeForRenderPass(),ce=A.paint.get("line-dasharray"),oe=A.paint.get("line-pattern"),ue=oe.constantOr(1),te=A.paint.get("line-gradient"),Se=A.getCrossfadeParameters(),We=ue?"linePattern":ce?"lineSDF":te?"lineGradient":"line",ge=y.context,ke=ge.gl;let He=!0;for(const qe of O){const rt=P.getTile(qe);if(ue&&!rt.patternsLoaded())continue;const Ct=rt.getBucket(A);if(!Ct)continue;const _t=Ct.programConfigurations.get(A.id),wt=y.context.program.get(),Xt=y.useProgram(We,_t),vi=He||Xt.program!==wt,Ft=y.style.map.terrain&&y.style.map.terrain.getTerrainData(qe),di=oe.constantOr(null);if(di&&rt.imageAtlas){const _i=rt.imageAtlas,Si=_i.patternPositions[di.to.toString()],Ti=_i.patternPositions[di.from.toString()];Si&&Ti&&_t.setConstantPatternPositions(Si,Ti)}const Ci=Ft?qe:null,Oi=ue?Qt(y,rt,A,Se,Ci):ce?Ei(y,rt,A,ce,Se,Ci):te?ft(y,rt,A,Ct.lineClipsArray.length,Ci):ur(y,rt,A,Ci);if(ue)ge.activeTexture.set(ke.TEXTURE0),rt.imageAtlasTexture.bind(ke.LINEAR,ke.CLAMP_TO_EDGE),_t.updatePaintBuffers(Se);else if(ce&&(vi||y.lineAtlas.dirty))ge.activeTexture.set(ke.TEXTURE0),y.lineAtlas.bind(ge);else if(te){const _i=Ct.gradients[A.id];let Si=_i.texture;if(A.gradientVersion!==_i.version){let Ti=256;if(A.stepInterpolant){const vr=P.getSource().maxzoom,er=qe.canonical.z===vr?Math.ceil(1<<y.transform.maxZoom-qe.canonical.z):1;Ti=s.ac(s.aT(Ct.maxLineLength/s.W*1024*er),256,ge.maxTextureSize)}_i.gradient=s.aU({expression:A.gradientExpression(),evaluationKey:"lineProgress",resolution:Ti,image:_i.gradient||void 0,clips:Ct.lineClipsArray}),_i.texture?_i.texture.update(_i.gradient):_i.texture=new $e(ge,_i.gradient,ke.RGBA),_i.version=A.gradientVersion,Si=_i.texture}ge.activeTexture.set(ke.TEXTURE0),Si.bind(A.stepInterpolant?ke.NEAREST:ke.LINEAR,ke.CLAMP_TO_EDGE)}Xt.draw(ge,ke.TRIANGLES,G,y.stencilModeForClipping(qe),Z,Wi.disabled,Oi,Ft,A.id,Ct.layoutVertexBuffer,Ct.indexBuffer,Ct.segments,A.paint,y.transform.zoom,_t,Ct.layoutVertexBuffer2),He=!1}})(t,n,l,d);break;case"fill":(function(y,P,A,O){const R=A.paint.get("fill-color"),N=A.paint.get("fill-opacity");if(N.constantOr(1)===0)return;const G=y.colorModeForRenderPass(),Z=A.paint.get("fill-pattern"),ce=y.opaquePassEnabledForLayer()&&!Z.constantOr(1)&&R.constantOr(s.aO.transparent).a===1&&N.constantOr(0)===1?"opaque":"translucent";if(y.renderPass===ce){const oe=y.depthModeForSublayer(1,y.renderPass==="opaque"?Ii.ReadWrite:Ii.ReadOnly);lo(y,P,A,O,oe,G,!1)}if(y.renderPass==="translucent"&&A.paint.get("fill-antialias")){const oe=y.depthModeForSublayer(A.getPaintProperty("fill-outline-color")?2:0,Ii.ReadOnly);lo(y,P,A,O,oe,G,!0)}})(t,n,l,d);break;case"fill-extrusion":(function(y,P,A,O){const R=A.paint.get("fill-extrusion-opacity");if(R!==0&&y.renderPass==="translucent"){const N=new Ii(y.context.gl.LEQUAL,Ii.ReadWrite,y.depthRangeFor3D);if(R!==1||A.paint.get("fill-extrusion-pattern").constantOr(1))pn(y,P,A,O,N,Ji.disabled,$i.disabled),pn(y,P,A,O,N,y.stencilModeFor3D(),y.colorModeForRenderPass());else{const G=y.colorModeForRenderPass();pn(y,P,A,O,N,Ji.disabled,G)}}})(t,n,l,d);break;case"hillshade":(function(y,P,A,O){if(y.renderPass!=="offscreen"&&y.renderPass!=="translucent")return;const R=y.context,N=y.depthModeForSublayer(0,Ii.ReadOnly),G=y.colorModeForRenderPass(),[Z,ce]=y.renderPass==="translucent"?y.stencilConfigForOverlap(O):[{},O];for(const oe of ce){const ue=P.getTile(oe);ue.needsHillshadePrepare!==void 0&&ue.needsHillshadePrepare&&y.renderPass==="offscreen"?gs(y,ue,A,N,Ji.disabled,G):y.renderPass==="translucent"&&co(y,oe,ue,A,N,Z[oe.overscaledZ],G)}R.viewport.set([0,0,y.width,y.height])})(t,n,l,d);break;case"raster":(function(y,P,A,O){if(y.renderPass!=="translucent"||A.paint.get("raster-opacity")===0||!O.length)return;const R=y.context,N=R.gl,G=P.getSource(),Z=y.useProgram("raster"),ce=y.colorModeForRenderPass(),[oe,ue]=G instanceof nt?[{},O]:y.stencilConfigForOverlap(O),te=ue[ue.length-1].overscaledZ,Se=!y.options.moving;for(const We of ue){const ge=y.depthModeForSublayer(We.overscaledZ-te,A.paint.get("raster-opacity")===1?Ii.ReadWrite:Ii.ReadOnly,N.LESS),ke=P.getTile(We);ke.registerFadeDuration(A.paint.get("raster-fade-duration"));const He=P.findLoadedParent(We,0),qe=ho(ke,He,P,A,y.transform,y.style.map.terrain);let rt,Ct;const _t=A.paint.get("raster-resampling")==="nearest"?N.NEAREST:N.LINEAR;R.activeTexture.set(N.TEXTURE0),ke.texture.bind(_t,N.CLAMP_TO_EDGE,N.LINEAR_MIPMAP_NEAREST),R.activeTexture.set(N.TEXTURE1),He?(He.texture.bind(_t,N.CLAMP_TO_EDGE,N.LINEAR_MIPMAP_NEAREST),rt=Math.pow(2,He.tileID.overscaledZ-ke.tileID.overscaledZ),Ct=[ke.tileID.canonical.x*rt%1,ke.tileID.canonical.y*rt%1]):ke.texture.bind(_t,N.CLAMP_TO_EDGE,N.LINEAR_MIPMAP_NEAREST);const wt=y.style.map.terrain&&y.style.map.terrain.getTerrainData(We),Xt=wt?We:null,vi=Xt?Xt.posMatrix:y.transform.calculatePosMatrix(We.toUnwrapped(),Se),Ft=Ts(vi,Ct||[0,0],rt||1,qe,A);G instanceof nt?Z.draw(R,N.TRIANGLES,ge,Ji.disabled,ce,Wi.disabled,Ft,wt,A.id,G.boundsBuffer,y.quadTriangleIndexBuffer,G.boundsSegments):Z.draw(R,N.TRIANGLES,ge,oe[We.overscaledZ],ce,Wi.disabled,Ft,wt,A.id,y.rasterBoundsBuffer,y.quadTriangleIndexBuffer,y.rasterBoundsSegments)}})(t,n,l,d);break;case"background":(function(y,P,A,O){const R=A.paint.get("background-color"),N=A.paint.get("background-opacity");if(N===0)return;const G=y.context,Z=G.gl,ce=y.transform,oe=ce.tileSize,ue=A.paint.get("background-pattern");if(y.isPatternMissing(ue))return;const te=!ue&&R.a===1&&N===1&&y.opaquePassEnabledForLayer()?"opaque":"translucent";if(y.renderPass!==te)return;const Se=Ji.disabled,We=y.depthModeForSublayer(0,te==="opaque"?Ii.ReadWrite:Ii.ReadOnly),ge=y.colorModeForRenderPass(),ke=y.useProgram(ue?"backgroundPattern":"background"),He=O||ce.coveringTiles({tileSize:oe,terrain:y.style.map.terrain});ue&&(G.activeTexture.set(Z.TEXTURE0),y.imageManager.bind(y.context));const qe=A.getCrossfadeParameters();for(const rt of He){const Ct=O?rt.posMatrix:y.transform.calculatePosMatrix(rt.toUnwrapped()),_t=ue?eo(Ct,N,y,ue,{tileID:rt,tileSize:oe},qe):Qn(Ct,N,R),wt=y.style.map.terrain&&y.style.map.terrain.getTerrainData(rt);ke.draw(G,Z.TRIANGLES,We,Se,ge,Wi.disabled,_t,wt,A.id,y.tileExtentBuffer,y.quadTriangleIndexBuffer,y.tileExtentSegments)}})(t,0,l,d);break;case"custom":(function(y,P,A){const O=y.context,R=A.implementation;if(y.renderPass==="offscreen"){const N=R.prerender;N&&(y.setCustomLayerDefaults(),O.setColorMode(y.colorModeForRenderPass()),N.call(R,O.gl,y.transform.customLayerMatrix()),O.setDirty(),y.setBaseState())}else if(y.renderPass==="translucent"){y.setCustomLayerDefaults(),O.setColorMode(y.colorModeForRenderPass()),O.setStencilMode(Ji.disabled);const N=R.renderingMode==="3d"?new Ii(y.context.gl.LEQUAL,Ii.ReadWrite,y.depthRangeFor3D):y.depthModeForSublayer(0,Ii.ReadOnly);O.setDepthMode(N),R.render(O.gl,y.transform.customLayerMatrix()),O.setDirty(),y.setBaseState(),O.bindFramebuffer.set(null)}})(t,0,l)}}translatePosMatrix(t,n,l,d,y){if(!l[0]&&!l[1])return t;const P=y?d==="map"?this.transform.angle:0:d==="viewport"?-this.transform.angle:0;if(P){const R=Math.sin(P),N=Math.cos(P);l=[l[0]*N-l[1]*R,l[0]*R+l[1]*N]}const A=[y?l[0]:pi(n,l[0],this.transform.zoom),y?l[1]:pi(n,l[1],this.transform.zoom),0],O=new Float32Array(16);return s.H(O,t,A),O}saveTileTexture(t){const n=this._tileTextures[t.size[0]];n?n.push(t):this._tileTextures[t.size[0]]=[t]}getTileTexture(t){const n=this._tileTextures[t];return n&&n.length>0?n.pop():null}isPatternMissing(t){if(!t)return!1;if(!t.from||!t.to)return!0;const n=this.imageManager.getPattern(t.from.toString()),l=this.imageManager.getPattern(t.to.toString());return!n||!l}useProgram(t,n){this.cache=this.cache||{};const l=t+(n?n.cacheKey:"")+(this._showOverdrawInspector?"/overdraw":"")+(this.style.map.terrain?"/terrain":"");return this.cache[l]||(this.cache[l]=new z(this.context,Gs[t],n,Oo[t],this._showOverdrawInspector,this.style.map.terrain)),this.cache[l]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new $e(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){const{drawingBufferWidth:t,drawingBufferHeight:n}=this.context.gl;return this.width!==t||this.height!==n}}class Lt{constructor(t,n){this.points=t,this.planes=n}static fromInvProjectionMatrix(t,n,l){const d=Math.pow(2,l),y=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(A=>{const O=1/(A=s.af([],A,t))[3]/n*d;return s.a$(A,A,[O,O,1/A[3],O])}),P=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(A=>{const O=function(Z,ce){var oe=ce[0],ue=ce[1],te=ce[2],Se=oe*oe+ue*ue+te*te;return Se>0&&(Se=1/Math.sqrt(Se)),Z[0]=ce[0]*Se,Z[1]=ce[1]*Se,Z[2]=ce[2]*Se,Z}([],function(Z,ce,oe){var ue=ce[0],te=ce[1],Se=ce[2],We=oe[0],ge=oe[1],ke=oe[2];return Z[0]=te*ke-Se*ge,Z[1]=Se*We-ue*ke,Z[2]=ue*ge-te*We,Z}([],Ve([],y[A[0]],y[A[1]]),Ve([],y[A[2]],y[A[1]]))),R=-((N=O)[0]*(G=y[A[1]])[0]+N[1]*G[1]+N[2]*G[2]);var N,G;return O.concat(R)});return new Lt(y,P)}}class ni{constructor(t,n){this.min=t,this.max=n,this.center=function(l,d,y){return l[0]=.5*d[0],l[1]=.5*d[1],l[2]=.5*d[2],l}([],function(l,d,y){return l[0]=d[0]+y[0],l[1]=d[1]+y[1],l[2]=d[2]+y[2],l}([],this.min,this.max))}quadrant(t){const n=[t%2==0,t<2],l=ne(this.min),d=ne(this.max);for(let y=0;y<n.length;y++)l[y]=n[y]?this.min[y]:this.center[y],d[y]=n[y]?this.center[y]:this.max[y];return d[2]=this.max[2],new ni(l,d)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}intersects(t){const n=[[this.min[0],this.min[1],this.min[2],1],[this.max[0],this.min[1],this.min[2],1],[this.max[0],this.max[1],this.min[2],1],[this.min[0],this.max[1],this.min[2],1],[this.min[0],this.min[1],this.max[2],1],[this.max[0],this.min[1],this.max[2],1],[this.max[0],this.max[1],this.max[2],1],[this.min[0],this.max[1],this.max[2],1]];let l=!0;for(let d=0;d<t.planes.length;d++){const y=t.planes[d];let P=0;for(let A=0;A<n.length;A++)s.b0(y,n[A])>=0&&P++;if(P===0)return 0;P!==n.length&&(l=!1)}if(l)return 2;for(let d=0;d<3;d++){let y=Number.MAX_VALUE,P=-Number.MAX_VALUE;for(let A=0;A<t.points.length;A++){const O=t.points[A][d]-this.min[d];y=Math.min(y,O),P=Math.max(P,O)}if(P<0||y>this.max[d]-this.min[d])return 0}return 1}}class Yi{constructor(t=0,n=0,l=0,d=0){if(isNaN(t)||t<0||isNaN(n)||n<0||isNaN(l)||l<0||isNaN(d)||d<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=n,this.left=l,this.right=d}interpolate(t,n,l){return n.top!=null&&t.top!=null&&(this.top=s.z.number(t.top,n.top,l)),n.bottom!=null&&t.bottom!=null&&(this.bottom=s.z.number(t.bottom,n.bottom,l)),n.left!=null&&t.left!=null&&(this.left=s.z.number(t.left,n.left,l)),n.right!=null&&t.right!=null&&(this.right=s.z.number(t.right,n.right,l)),this}getCenter(t,n){const l=s.ac((this.left+t-this.right)/2,0,t),d=s.ac((this.top+n-this.bottom)/2,0,n);return new s.P(l,d)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Yi(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const ki=85.051129;class ir{constructor(t,n,l,d,y){this.tileSize=512,this._renderWorldCopies=y===void 0||!!y,this._minZoom=t||0,this._maxZoom=n||22,this._minPitch=l??0,this._maxPitch=d??60,this.setMaxBounds(),this.width=0,this.height=0,this._center=new s.M(0,0),this._elevation=0,this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._unmodified=!0,this._edgeInsets=new Yi,this._posMatrixCache={},this._alignedPosMatrixCache={},this.minElevationForCurrentTile=0}clone(){const t=new ir(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return t.apply(this),t}apply(t){this.tileSize=t.tileSize,this.latRange=t.latRange,this.width=t.width,this.height=t.height,this._center=t._center,this._elevation=t._elevation,this.minElevationForCurrentTile=t.minElevationForCurrentTile,this.zoom=t.zoom,this.angle=t.angle,this._fov=t._fov,this._pitch=t._pitch,this._unmodified=t._unmodified,this._edgeInsets=t._edgeInsets.clone(),this._calcMatrices()}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this.width,this.height)}get bearing(){return-this.angle/Math.PI*180}set bearing(t){const n=-s.b1(t,-180,180)*Math.PI/180;this.angle!==n&&(this._unmodified=!1,this.angle=n,this._calcMatrices(),this.rotationMatrix=function(){var l=new s.A(4);return s.A!=Float32Array&&(l[1]=0,l[2]=0),l[0]=1,l[3]=1,l}(),function(l,d,y){var P=d[0],A=d[1],O=d[2],R=d[3],N=Math.sin(y),G=Math.cos(y);l[0]=P*G+O*N,l[1]=A*G+R*N,l[2]=P*-N+O*G,l[3]=A*-N+R*G}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const n=s.ac(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==n&&(this._unmodified=!1,this._pitch=n,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=t/180*Math.PI,this._calcMatrices())}get zoom(){return this._zoom}set zoom(t){const n=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==n&&(this._unmodified=!1,this._zoom=n,this.tileZoom=Math.max(0,Math.floor(n)),this.scale=this.zoomScale(n),this._constrain(),this._calcMatrices())}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}set elevation(t){t!==this._elevation&&(this._elevation=t,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,n,l){this._unmodified=!1,this._edgeInsets.interpolate(t,n,l),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const n=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,n)}getVisibleUnwrappedCoordinates(t){const n=[new s.b2(0,t)];if(this._renderWorldCopies){const l=this.pointCoordinate(new s.P(0,0)),d=this.pointCoordinate(new s.P(this.width,0)),y=this.pointCoordinate(new s.P(this.width,this.height)),P=this.pointCoordinate(new s.P(0,this.height)),A=Math.floor(Math.min(l.x,d.x,y.x,P.x)),O=Math.floor(Math.max(l.x,d.x,y.x,P.x)),R=1;for(let N=A-R;N<=O+R;N++)N!==0&&n.push(new s.b2(N,t))}return n}coveringTiles(t){var n,l;let d=this.coveringZoomLevel(t);const y=d;if(t.minzoom!==void 0&&d<t.minzoom)return[];t.maxzoom!==void 0&&d>t.maxzoom&&(d=t.maxzoom);const P=this.pointCoordinate(this.getCameraPoint()),A=s.Y.fromLngLat(this.center),O=Math.pow(2,d),R=[O*P.x,O*P.y,0],N=[O*A.x,O*A.y,0],G=Lt.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,d);let Z=t.minzoom||0;!t.terrain&&this.pitch<=60&&this._edgeInsets.top<.1&&(Z=d);const ce=t.terrain?2/Math.min(this.tileSize,t.tileSize)*this.tileSize:3,oe=ge=>({aabb:new ni([ge*O,0,0],[(ge+1)*O,O,0]),zoom:0,x:0,y:0,wrap:ge,fullyVisible:!1}),ue=[],te=[],Se=d,We=t.reparseOverscaled?y:d;if(this._renderWorldCopies)for(let ge=1;ge<=3;ge++)ue.push(oe(-ge)),ue.push(oe(ge));for(ue.push(oe(0));ue.length>0;){const ge=ue.pop(),ke=ge.x,He=ge.y;let qe=ge.fullyVisible;if(!qe){const Xt=ge.aabb.intersects(G);if(Xt===0)continue;qe=Xt===2}const rt=t.terrain?R:N,Ct=ge.aabb.distanceX(rt),_t=ge.aabb.distanceY(rt),wt=Math.max(Math.abs(Ct),Math.abs(_t));if(ge.zoom===Se||wt>ce+(1<<Se-ge.zoom)-2&&ge.zoom>=Z){const Xt=Se-ge.zoom,vi=R[0]-.5-(ke<<Xt),Ft=R[1]-.5-(He<<Xt);te.push({tileID:new s.Q(ge.zoom===Se?We:ge.zoom,ge.wrap,ge.zoom,ke,He),distanceSq:Ke([N[0]-.5-ke,N[1]-.5-He]),tileDistanceToCamera:Math.sqrt(vi*vi+Ft*Ft)})}else for(let Xt=0;Xt<4;Xt++){const vi=(ke<<1)+Xt%2,Ft=(He<<1)+(Xt>>1),di=ge.zoom+1;let Ci=ge.aabb.quadrant(Xt);if(t.terrain){const Oi=new s.Q(di,ge.wrap,di,vi,Ft),_i=t.terrain.getMinMaxElevation(Oi),Si=(n=_i.minElevation)!==null&&n!==void 0?n:this.elevation,Ti=(l=_i.maxElevation)!==null&&l!==void 0?l:this.elevation;Ci=new ni([Ci.min[0],Ci.min[1],Si],[Ci.max[0],Ci.max[1],Ti])}ue.push({aabb:Ci,zoom:di,x:vi,y:Ft,wrap:ge.wrap,fullyVisible:qe})}}return te.sort((ge,ke)=>ge.distanceSq-ke.distanceSq).map(ge=>ge.tileID)}resize(t,n){this.width=t,this.height=n,this.pixelsToGLUnits=[2/t,-2/n],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const n=s.ac(t.lat,-85.051129,ki);return new s.P(s.N(t.lng)*this.worldSize,s.O(n)*this.worldSize)}unproject(t){return new s.Y(t.x/this.worldSize,t.y/this.worldSize).toLngLat()}get point(){return this.project(this.center)}getCameraPosition(){return{lngLat:this.pointLocation(this.getCameraPoint()),altitude:Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter+this.elevation}}recalculateZoom(t){const n=this.elevation,l=Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter,d=this.pointLocation(this.centerPoint,t),y=t.getElevationForLngLatZoom(d,this.tileZoom);if(!(this.elevation-y))return;const P=l+n-y,A=Math.cos(this._pitch)*this.cameraToCenterDistance/P/s.b3(1,d.lat),O=this.scaleZoom(A/this.tileSize);this._elevation=y,this._center=d,this.zoom=O}setLocationAtPoint(t,n){const l=this.pointCoordinate(n),d=this.pointCoordinate(this.centerPoint),y=this.locationCoordinate(t),P=new s.Y(y.x-(l.x-d.x),y.y-(l.y-d.y));this.center=this.coordinateLocation(P),this._renderWorldCopies&&(this.center=this.center.wrap())}locationPoint(t,n){return n?this.coordinatePoint(this.locationCoordinate(t),n.getElevationForLngLatZoom(t,this.tileZoom),this.pixelMatrix3D):this.coordinatePoint(this.locationCoordinate(t))}pointLocation(t,n){return this.coordinateLocation(this.pointCoordinate(t,n))}locationCoordinate(t){return s.Y.fromLngLat(t)}coordinateLocation(t){return t&&t.toLngLat()}pointCoordinate(t,n){if(n){const Z=n.pointCoordinate(t);if(Z!=null)return Z}const l=[t.x,t.y,0,1],d=[t.x,t.y,1,1];s.af(l,l,this.pixelMatrixInverse),s.af(d,d,this.pixelMatrixInverse);const y=l[3],P=d[3],A=l[1]/y,O=d[1]/P,R=l[2]/y,N=d[2]/P,G=R===N?0:(0-R)/(N-R);return new s.Y(s.z.number(l[0]/y,d[0]/P,G)/this.worldSize,s.z.number(A,O,G)/this.worldSize)}coordinatePoint(t,n=0,l=this.pixelMatrix){const d=[t.x*this.worldSize,t.y*this.worldSize,n,1];return s.af(d,d,l),new s.P(d[0]/d[3],d[1]/d[3])}getBounds(){const t=Math.max(0,this.height/2-this.getHorizon());return new Qe().extend(this.pointLocation(new s.P(0,t))).extend(this.pointLocation(new s.P(this.width,t))).extend(this.pointLocation(new s.P(this.width,this.height))).extend(this.pointLocation(new s.P(0,this.height)))}getMaxBounds(){return this.latRange&&this.latRange.length===2&&this.lngRange&&this.lngRange.length===2?new Qe([this.lngRange[0],this.latRange[0]],[this.lngRange[1],this.latRange[1]]):null}getHorizon(){return Math.tan(Math.PI/2-this._pitch)*this.cameraToCenterDistance*.85}setMaxBounds(t){t?(this.lngRange=[t.getWest(),t.getEast()],this.latRange=[t.getSouth(),t.getNorth()],this._constrain()):(this.lngRange=null,this.latRange=[-85.051129,ki])}calculatePosMatrix(t,n=!1){const l=t.key,d=n?this._alignedPosMatrixCache:this._posMatrixCache;if(d[l])return d[l];const y=t.canonical,P=this.worldSize/this.zoomScale(y.z),A=y.x+Math.pow(2,y.z)*t.wrap,O=s.an(new Float64Array(16));return s.H(O,O,[A*P,y.y*P,0]),s.J(O,O,[P/s.W,P/s.W,1]),s.K(O,n?this.alignedProjMatrix:this.projMatrix,O),d[l]=new Float32Array(O),d[l]}customLayerMatrix(){return this.mercatorMatrix.slice()}getConstrained(t,n){n=s.ac(+n,this.minZoom,this.maxZoom);const l={center:new s.M(t.lng,t.lat),zoom:n};let d=this.lngRange;if(!this._renderWorldCopies&&d===null){const ge=179.9999999999;d=[-ge,ge]}const y=this.tileSize*this.zoomScale(l.zoom);let P=0,A=y,O=0,R=y,N=0,G=0;const{x:Z,y:ce}=this.size;if(this.latRange){const ge=this.latRange;P=s.O(ge[1])*y,A=s.O(ge[0])*y,A-P<ce&&(N=ce/(A-P))}d&&(O=s.b1(s.N(d[0])*y,0,y),R=s.b1(s.N(d[1])*y,0,y),R<O&&(R+=y),R-O<Z&&(G=Z/(R-O)));const{x:oe,y:ue}=this.project.call({worldSize:y},t);let te,Se;const We=Math.max(G||0,N||0);if(We){const ge=new s.P(G?(R+O)/2:oe,N?(A+P)/2:ue);return l.center=this.unproject.call({worldSize:y},ge).wrap(),l.zoom+=this.scaleZoom(We),l}if(this.latRange){const ge=ce/2;ue-ge<P&&(Se=P+ge),ue+ge>A&&(Se=A-ge)}if(d){const ge=(O+R)/2;let ke=oe;this._renderWorldCopies&&(ke=s.b1(oe,ge-y/2,ge+y/2));const He=Z/2;ke-He<O&&(te=O+He),ke+He>R&&(te=R-He)}if(te!==void 0||Se!==void 0){const ge=new s.P(te??oe,Se??ue);l.center=this.unproject.call({worldSize:y},ge).wrap()}return l}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this._unmodified,{center:n,zoom:l}=this.getConstrained(this.center,this.zoom);this.center=n,this.zoom=l,this._unmodified=t,this._constraining=!1}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,n=this.point.x,l=this.point.y;this.cameraToCenterDistance=.5/Math.tan(this._fov/2)*this.height,this._pixelPerMeter=s.b3(1,this.center.lat)*this.worldSize;let d=s.an(new Float64Array(16));s.J(d,d,[this.width/2,-this.height/2,1]),s.H(d,d,[1,-1,0]),this.labelPlaneMatrix=d,d=s.an(new Float64Array(16)),s.J(d,d,[1,-1,1]),s.H(d,d,[-1,-1,0]),s.J(d,d,[2/this.width,2/this.height,1]),this.glCoordMatrix=d;const y=this.cameraToCenterDistance+this._elevation*this._pixelPerMeter/Math.cos(this._pitch),P=Math.min(this.elevation,this.minElevationForCurrentTile),A=y-P*this._pixelPerMeter/Math.cos(this._pitch),O=P<0?A:y,R=Math.PI/2+this._pitch,N=this._fov*(.5+t.y/this.height),G=Math.sin(N)*O/Math.sin(s.ac(Math.PI-R-N,.01,Math.PI-.01)),Z=this.getHorizon(),ce=2*Math.atan(Z/this.cameraToCenterDistance)*(.5+t.y/(2*Z)),oe=Math.sin(ce)*O/Math.sin(s.ac(Math.PI-R-ce,.01,Math.PI-.01)),ue=Math.min(G,oe),te=1.01*(Math.cos(Math.PI/2-this._pitch)*ue+O),Se=this.height/50;d=new Float64Array(16),s.b4(d,this._fov,this.width/this.height,Se,te),d[8]=2*-t.x/this.width,d[9]=2*t.y/this.height,s.J(d,d,[1,-1,1]),s.H(d,d,[0,0,-this.cameraToCenterDistance]),s.b5(d,d,this._pitch),s.ad(d,d,this.angle),s.H(d,d,[-n,-l,0]),this.mercatorMatrix=s.J([],d,[this.worldSize,this.worldSize,this.worldSize]),s.J(d,d,[1,1,this._pixelPerMeter]),this.pixelMatrix=s.K(new Float64Array(16),this.labelPlaneMatrix,d),s.H(d,d,[0,0,-this.elevation]),this.projMatrix=d,this.invProjMatrix=s.ar([],d),this.pixelMatrix3D=s.K(new Float64Array(16),this.labelPlaneMatrix,d);const We=this.width%2/2,ge=this.height%2/2,ke=Math.cos(this.angle),He=Math.sin(this.angle),qe=n-Math.round(n)+ke*We+He*ge,rt=l-Math.round(l)+ke*ge+He*We,Ct=new Float64Array(d);if(s.H(Ct,Ct,[qe>.5?qe-1:qe,rt>.5?rt-1:rt,0]),this.alignedProjMatrix=Ct,d=s.ar(new Float64Array(16),this.pixelMatrix),!d)throw new Error("failed to invert matrix");this.pixelMatrixInverse=d,this._posMatrixCache={},this._alignedPosMatrixCache={}}maxPitchScaleFactor(){if(!this.pixelMatrixInverse)return 1;const t=this.pointCoordinate(new s.P(0,0)),n=[t.x*this.worldSize,t.y*this.worldSize,0,1];return s.af(n,n,this.pixelMatrix)[3]/this.cameraToCenterDistance}getCameraPoint(){const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(0,t))}getCameraQueryGeometry(t){const n=this.getCameraPoint();if(t.length===1)return[t[0],n];{let l=n.x,d=n.y,y=n.x,P=n.y;for(const A of t)l=Math.min(l,A.x),d=Math.min(d,A.y),y=Math.max(y,A.x),P=Math.max(P,A.y);return[new s.P(l,d),new s.P(y,d),new s.P(y,P),new s.P(l,P),new s.P(l,d)]}}lngLatToCameraDepth(t,n){const l=this.locationCoordinate(t),d=[l.x*this.worldSize,l.y*this.worldSize,n,1];return s.af(d,d,this.projMatrix),d[2]/d[3]}}function yr(g,t){let n,l=!1,d=null,y=null;const P=()=>{d=null,l&&(g.apply(y,n),d=setTimeout(P,t),l=!1)};return(...A)=>(l=!0,y=this,n=A,d||P(),d)}class mn{constructor(t){this._getCurrentHash=()=>{const n=window.location.hash.replace("#","");if(this._hashName){let l;return n.split("&").map(d=>d.split("=")).forEach(d=>{d[0]===this._hashName&&(l=d)}),(l&&l[1]||"").split("/")}return n.split("/")},this._onHashChange=()=>{const n=this._getCurrentHash();if(n.length>=3&&!n.some(l=>isNaN(l))){const l=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(n[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+n[2],+n[1]],zoom:+n[0],bearing:l,pitch:+(n[4]||0)}),!0}return!1},this._updateHashUnthrottled=()=>{const n=window.location.href.replace(/(#.+)?$/,this.getHashString());try{window.history.replaceState(window.history.state,null,n)}catch{}},this._updateHash=yr(this._updateHashUnthrottled,300),this._hashName=t&&encodeURIComponent(t)}addTo(t){return this._map=t,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),delete this._map,this}getHashString(t){const n=this._map.getCenter(),l=Math.round(100*this._map.getZoom())/100,d=Math.ceil((l*Math.LN2+Math.log(512/360/.5))/Math.LN10),y=Math.pow(10,d),P=Math.round(n.lng*y)/y,A=Math.round(n.lat*y)/y,O=this._map.getBearing(),R=this._map.getPitch();let N="";if(N+=t?`/${P}/${A}/${l}`:`${l}/${A}/${P}`,(O||R)&&(N+="/"+Math.round(10*O)/10),R&&(N+=`/${Math.round(R)}`),this._hashName){const G=this._hashName;let Z=!1;const ce=window.location.hash.slice(1).split("&").map(oe=>{const ue=oe.split("=")[0];return ue===G?(Z=!0,`${ue}=${N}`):oe}).filter(oe=>oe);return Z||ce.push(`${G}=${N}`),`#${ce.join("&")}`}return`#${N}`}}const Ki={linearity:.3,easing:s.b6(0,0,.3,1)},Er=s.e({deceleration:2500,maxSpeed:1400},Ki),Ln=s.e({deceleration:20,maxSpeed:1400},Ki),Hn=s.e({deceleration:1e3,maxSpeed:360},Ki),Hr=s.e({deceleration:1e3,maxSpeed:90},Ki);class Xn{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:o.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,n=o.now();for(;t.length>0&&n-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const n={zoom:0,bearing:0,pitch:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:y}of this._inertiaBuffer)n.zoom+=y.zoomDelta||0,n.bearing+=y.bearingDelta||0,n.pitch+=y.pitchDelta||0,y.panDelta&&n.pan._add(y.panDelta),y.around&&(n.around=y.around),y.pinchAround&&(n.pinchAround=y.pinchAround);const l=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,d={};if(n.pan.mag()){const y=_s(n.pan.mag(),l,s.e({},Er,t||{}));d.offset=n.pan.mult(y.amount/n.pan.mag()),d.center=this._map.transform.center,qn(d,y)}if(n.zoom){const y=_s(n.zoom,l,Ln);d.zoom=this._map.transform.zoom+y.amount,qn(d,y)}if(n.bearing){const y=_s(n.bearing,l,Hn);d.bearing=this._map.transform.bearing+s.ac(y.amount,-179,179),qn(d,y)}if(n.pitch){const y=_s(n.pitch,l,Hr);d.pitch=this._map.transform.pitch+y.amount,qn(d,y)}if(d.zoom||d.bearing){const y=n.pinchAround===void 0?n.around:n.pinchAround;d.around=y?this._map.unproject(y):this._map.getCenter()}return this.clear(),s.e(d,{noMoveStart:!0})}}function qn(g,t){(!g.duration||g.duration<t.duration)&&(g.duration=t.duration,g.easing=t.easing)}function _s(g,t,n){const{maxSpeed:l,linearity:d,deceleration:y}=n,P=s.ac(g*d/(t/1e3),-l,l),A=Math.abs(P)/(y*d);return{easing:n.easing,duration:1e3*A,amount:P*(A/2)}}class fr extends s.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,l,d={}){const y=c.mousePos(n.getCanvas(),l),P=n.unproject(y);super(t,s.e({point:y,lngLat:P,originalEvent:l},d)),this._defaultPrevented=!1,this.target=n}}class $n extends s.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,l){const d=t==="touchend"?l.changedTouches:l.touches,y=c.touchPos(n.getCanvasContainer(),d),P=y.map(O=>n.unproject(O)),A=y.reduce((O,R,N,G)=>O.add(R.div(G.length)),new s.P(0,0));super(t,{points:y,point:A,lngLats:P,lngLat:n.unproject(A),originalEvent:l}),this._defaultPrevented=!1}}class gn extends s.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,l){super(t,{originalEvent:l}),this._defaultPrevented=!1}}class Yn{constructor(t,n){this._map=t,this._clickTolerance=n.clickTolerance}reset(){delete this._mousedownPos}wheel(t){return this._firePreventable(new gn(t.type,this._map,t))}mousedown(t,n){return this._mousedownPos=n,this._firePreventable(new fr(t.type,this._map,t))}mouseup(t){this._map.fire(new fr(t.type,this._map,t))}click(t,n){this._mousedownPos&&this._mousedownPos.dist(n)>=this._clickTolerance||this._map.fire(new fr(t.type,this._map,t))}dblclick(t){return this._firePreventable(new fr(t.type,this._map,t))}mouseover(t){this._map.fire(new fr(t.type,this._map,t))}mouseout(t){this._map.fire(new fr(t.type,this._map,t))}touchstart(t){return this._firePreventable(new $n(t.type,this._map,t))}touchmove(t){this._map.fire(new $n(t.type,this._map,t))}touchend(t){this._map.fire(new $n(t.type,this._map,t))}touchcancel(t){this._map.fire(new $n(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class No{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(t){this._map.fire(new fr(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new fr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._ignoreContextMenu||this._map.fire(new fr(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Pi{constructor(t){this._map=t}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(t){return this.transform.pointLocation(s.P.convert(t),this._map.terrain)}}class Ri{constructor(t,n){this._map=t,this._tr=new Pi(t),this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=n.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,n){this.isEnabled()&&t.shiftKey&&t.button===0&&(c.disableDrag(),this._startPos=this._lastPos=n,this._active=!0)}mousemoveWindow(t,n){if(!this._active)return;const l=n;if(this._lastPos.equals(l)||!this._box&&l.dist(this._startPos)<this._clickTolerance)return;const d=this._startPos;this._lastPos=l,this._box||(this._box=c.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",t));const y=Math.min(d.x,l.x),P=Math.max(d.x,l.x),A=Math.min(d.y,l.y),O=Math.max(d.y,l.y);c.setTransform(this._box,`translate(${y}px,${A}px)`),this._box.style.width=P-y+"px",this._box.style.height=O-A+"px"}mouseupWindow(t,n){if(!this._active||t.button!==0)return;const l=this._startPos,d=n;if(this.reset(),c.suppressClick(),l.x!==d.x||l.y!==d.y)return this._map.fire(new s.k("boxzoomend",{originalEvent:t})),{cameraAnimation:y=>y.fitScreenCoordinates(l,d,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",t)}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(c.remove(this._box),this._box=null),c.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(t,n){return this._map.fire(new s.k(t,{originalEvent:n}))}}function Ys(g,t){if(g.length!==t.length)throw new Error(`The number of touches and points are not equal - touches ${g.length}, points ${t.length}`);const n={};for(let l=0;l<g.length;l++)n[g[l].identifier]=t[l];return n}class ys{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(t,n,l){(this.centroid||l.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=t.timeStamp),l.length===this.numTouches&&(this.centroid=function(d){const y=new s.P(0,0);for(const P of d)y._add(P);return y.div(d.length)}(n),this.touches=Ys(l,n)))}touchmove(t,n,l){if(this.aborted||!this.centroid)return;const d=Ys(l,n);for(const y in this.touches){const P=d[y];(!P||P.dist(this.touches[y])>30)&&(this.aborted=!0)}}touchend(t,n,l){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),l.length===0){const d=!this.aborted&&this.centroid;if(this.reset(),d)return d}}}class ha{constructor(t){this.singleTap=new ys(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(t,n,l){this.singleTap.touchstart(t,n,l)}touchmove(t,n,l){this.singleTap.touchmove(t,n,l)}touchend(t,n,l){const d=this.singleTap.touchend(t,n,l);if(d){const y=t.timeStamp-this.lastTime<500,P=!this.lastTap||this.lastTap.dist(d)<30;if(y&&P||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=d,this.count===this.numTaps)return this.reset(),d}}}class _n{constructor(t){this._tr=new Pi(t),this._zoomIn=new ha({numTouches:1,numTaps:2}),this._zoomOut=new ha({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,n,l){this._zoomIn.touchstart(t,n,l),this._zoomOut.touchstart(t,n,l)}touchmove(t,n,l){this._zoomIn.touchmove(t,n,l),this._zoomOut.touchmove(t,n,l)}touchend(t,n,l){const d=this._zoomIn.touchend(t,n,l),y=this._zoomOut.touchend(t,n,l),P=this._tr;return d?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:A=>A.easeTo({duration:300,zoom:P.zoom+1,around:P.unproject(d)},{originalEvent:t})}):y?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:A=>A.easeTo({duration:300,zoom:P.zoom-1,around:P.unproject(y)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Rr{constructor(t){this._enabled=!!t.enable,this._moveStateManager=t.moveStateManager,this._clickTolerance=t.clickTolerance||1,this._moveFunction=t.move,this._activateOnStart=!!t.activateOnStart,t.assignEvents(this),this.reset()}reset(t){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(t)}_move(...t){const n=this._moveFunction(...t);if(n.bearingDelta||n.pitchDelta||n.around||n.panDelta)return this._active=!0,n}dragStart(t,n){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(t)&&(this._moveStateManager.startMove(t),this._lastPoint=n.length?n[0]:n,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(t,n){if(!this.isEnabled())return;const l=this._lastPoint;if(!l)return;if(t.preventDefault(),!this._moveStateManager.isValidMoveEvent(t))return void this.reset(t);const d=n.length?n[0]:n;return!this._moved&&d.dist(l)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=d,this._move(l,d))}dragEnd(t){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(t)&&(this._moved&&c.suppressClick(),this.reset(t))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const Qr={0:1,2:2};class Nt{constructor(t){this._correctEvent=t.checkCorrectEvent}startMove(t){const n=c.mouseButton(t);this._eventButton=n}endMove(t){delete this._eventButton}isValidStartEvent(t){return this._correctEvent(t)}isValidMoveEvent(t){return!function(n,l){const d=Qr[l];return n.buttons===void 0||(n.buttons&d)!==d}(t,this._eventButton)}isValidEndEvent(t){return c.mouseButton(t)===this._eventButton}}class Zs{constructor(){this._firstTouch=void 0}_isOneFingerTouch(t){return t.targetTouches.length===1}_isSameTouchEvent(t){return t.targetTouches[0].identifier===this._firstTouch}startMove(t){this._firstTouch=t.targetTouches[0].identifier}endMove(t){delete this._firstTouch}isValidStartEvent(t){return this._isOneFingerTouch(t)}isValidMoveEvent(t){return this._isOneFingerTouch(t)&&this._isSameTouchEvent(t)}isValidEndEvent(t){return this._isOneFingerTouch(t)&&this._isSameTouchEvent(t)}}const Sn=g=>{g.mousedown=g.dragStart,g.mousemoveWindow=g.dragMove,g.mouseup=g.dragEnd,g.contextmenu=function(t){t.preventDefault()}},Tn=({enable:g,clickTolerance:t,bearingDegreesPerPixelMoved:n=.8})=>{const l=new Nt({checkCorrectEvent:d=>c.mouseButton(d)===0&&d.ctrlKey||c.mouseButton(d)===2});return new Rr({clickTolerance:t,move:(d,y)=>({bearingDelta:(y.x-d.x)*n}),moveStateManager:l,enable:g,assignEvents:Sn})},Va=({enable:g,clickTolerance:t,pitchDegreesPerPixelMoved:n=-.5})=>{const l=new Nt({checkCorrectEvent:d=>c.mouseButton(d)===0&&d.ctrlKey||c.mouseButton(d)===2});return new Rr({clickTolerance:t,move:(d,y)=>({pitchDelta:(y.y-d.y)*n}),moveStateManager:l,enable:g,assignEvents:Sn})};class Bt{constructor(t,n){this._clickTolerance=t.clickTolerance||1,this._map=n,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}minTouchs(){return this._map.cooperativeGestures.isEnabled()?2:1}touchstart(t,n,l){return this._calculateTransform(t,n,l)}touchmove(t,n,l){if(this._active&&!(l.length<this.minTouchs()))return t.preventDefault(),this._calculateTransform(t,n,l)}touchend(t,n,l){this._calculateTransform(t,n,l),this._active&&l.length<this.minTouchs()&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,n,l){l.length>0&&(this._active=!0);const d=Ys(l,n),y=new s.P(0,0),P=new s.P(0,0);let A=0;for(const R in d){const N=d[R],G=this._touches[R];G&&(y._add(N),P._add(N.sub(G)),A++,d[R]=N)}if(this._touches=d,A<this.minTouchs()||!P.mag())return;const O=P.div(A);return this._sum._add(O),this._sum.mag()<this._clickTolerance?void 0:{around:y.div(A),panDelta:O}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ls{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(t,n,l){this._firstTwoTouches||l.length<2||(this._firstTwoTouches=[l[0].identifier,l[1].identifier],this._start([n[0],n[1]]))}touchmove(t,n,l){if(!this._firstTwoTouches)return;t.preventDefault();const[d,y]=this._firstTwoTouches,P=Fs(l,n,d),A=Fs(l,n,y);if(!P||!A)return;const O=this._aroundCenter?null:P.add(A).div(2);return this._move([P,A],O,t)}touchend(t,n,l){if(!this._firstTwoTouches)return;const[d,y]=this._firstTwoTouches,P=Fs(l,n,d),A=Fs(l,n,y);P&&A||(this._active&&c.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function Fs(g,t,n){for(let l=0;l<g.length;l++)if(g[l].identifier===n)return t[l]}function ua(g,t){return Math.log(g/t)/Math.LN2}class da extends Ls{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,n){const l=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(ua(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:ua(this._distance,l),pinchAround:n}}}function Ks(g,t){return 180*g.angleWith(t)/Math.PI}class Js extends Ls{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,n,l){const d=this._vector;if(this._vector=t[0].sub(t[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:Ks(this._vector,d),pinchAround:n}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const n=25/(Math.PI*this._minDiameter)*360,l=Ks(t,this._startVector);return Math.abs(l)<n}}function gl(g){return Math.abs(g.y)>Math.abs(g.x)}class Ql extends Ls{constructor(t){super(),this._currentTouchCount=0,this._map=t}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(t,n,l){super.touchstart(t,n,l),this._currentTouchCount=l.length}_start(t){this._lastPoints=t,gl(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,n,l){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const d=t[0].sub(this._lastPoints[0]),y=t[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(d,y,l.timeStamp),this._valid?(this._lastPoints=t,this._active=!0,{pitchDelta:(d.y+y.y)/2*-.5}):void 0}gestureBeginsVertically(t,n,l){if(this._valid!==void 0)return this._valid;const d=t.mag()>=2,y=n.mag()>=2;if(!d&&!y)return;if(!d||!y)return this._firstMove===void 0&&(this._firstMove=l),l-this._firstMove<100&&void 0;const P=t.y>0==n.y>0;return gl(t)&&gl(n)&&P}}const fa={panStep:100,bearingStep:15,pitchStep:10};class ar{constructor(t){this._tr=new Pi(t);const n=fa;this._panStep=n.panStep,this._bearingStep=n.bearingStep,this._pitchStep=n.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let n=0,l=0,d=0,y=0,P=0;switch(t.keyCode){case 61:case 107:case 171:case 187:n=1;break;case 189:case 109:case 173:n=-1;break;case 37:t.shiftKey?l=-1:(t.preventDefault(),y=-1);break;case 39:t.shiftKey?l=1:(t.preventDefault(),y=1);break;case 38:t.shiftKey?d=1:(t.preventDefault(),P=-1);break;case 40:t.shiftKey?d=-1:(t.preventDefault(),P=1);break;default:return}return this._rotationDisabled&&(l=0,d=0),{cameraAnimation:A=>{const O=this._tr;A.easeTo({duration:300,easeId:"keyboardHandler",easing:Vo,zoom:n?Math.round(O.zoom)+n*(t.shiftKey?2:1):O.zoom,bearing:O.bearing+l*this._bearingStep,pitch:O.pitch+d*this._pitchStep,offset:[-y*this._panStep,-P*this._panStep],center:O.center},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Vo(g){return g*(2-g)}const Uo=4.000244140625;class _l{constructor(t,n){this._onTimeout=l=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(l)},this._map=t,this._tr=new Pi(t),this._triggerRenderFrame=n,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}wheel(t){if(!this.isEnabled()||this._map.cooperativeGestures.isEnabled()&&!t[this._map.cooperativeGestures._bypassKey])return;let n=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const l=o.now(),d=l-(this._lastWheelEventTime||0);this._lastWheelEventTime=l,n!==0&&n%Uo==0?this._type="wheel":n!==0&&Math.abs(n)<4?this._type="trackpad":d>400?(this._type=null,this._lastValue=n,this._timeout=setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(d*n)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,n+=this._lastValue)),t.shiftKey&&n&&(n/=4),this._type&&(this._lastWheelEvent=t,this._delta-=n,this._active||this._start(t)),t.preventDefault()}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const n=c.mousePos(this._map.getCanvas(),t),l=this._tr;this._around=n.y>l.transform.height/2-l.transform.getHorizon()?s.M.convert(this._aroundCenter?l.center:l.unproject(n)):s.M.convert(l.center),this._aroundPoint=l.transform.locationPoint(this._around),this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._tr.transform;if(this._delta!==0){const A=this._type==="wheel"&&Math.abs(this._delta)>Uo?this._wheelZoomRate:this._defaultZoomRate;let O=2/(1+Math.exp(-Math.abs(this._delta*A)));this._delta<0&&O!==0&&(O=1/O);const R=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):t.scale;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(R*O))),this._type==="wheel"&&(this._startZoom=t.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const n=typeof this._targetZoom=="number"?this._targetZoom:t.zoom,l=this._startZoom,d=this._easing;let y,P=!1;if(this._type==="wheel"&&l&&d){const A=Math.min((o.now()-this._lastWheelEventTime)/200,1),O=d(A);y=s.z.number(l,n,O),A<1?this._frameId||(this._frameId=!0):P=!0}else y=n,P=!0;return this._active=!0,P&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!P,zoomDelta:y-t.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let n=s.b7;if(this._prevEase){const l=this._prevEase,d=(o.now()-l.start)/l.duration,y=l.easing(d+.01)-l.easing(d),P=.27/Math.sqrt(y*y+1e-4)*.01,A=Math.sqrt(.0729-P*P);n=s.b6(P,A,.25,1)}return this._prevEase={start:o.now(),duration:t,easing:n},n}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class yl{constructor(t,n){this._clickZoom=t,this._tapZoom=n}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class ec{constructor(t){this._tr=new Pi(t),this.reset()}reset(){this._active=!1}dblclick(t,n){return t.preventDefault(),{cameraAnimation:l=>{l.easeTo({duration:300,zoom:this._tr.zoom+(t.shiftKey?-1:1),around:this._tr.unproject(n)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Oc{constructor(){this._tap=new ha({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(t,n,l){if(!this._swipePoint)if(this._tapTime){const d=n[0],y=t.timeStamp-this._tapTime<500,P=this._tapPoint.dist(d)<30;y&&P?l.length>0&&(this._swipePoint=d,this._swipeTouch=l[0].identifier):this.reset()}else this._tap.touchstart(t,n,l)}touchmove(t,n,l){if(this._tapTime){if(this._swipePoint){if(l[0].identifier!==this._swipeTouch)return;const d=n[0],y=d.y-this._swipePoint.y;return this._swipePoint=d,t.preventDefault(),this._active=!0,{zoomDelta:y/128}}}else this._tap.touchmove(t,n,l)}touchend(t,n,l){if(this._tapTime)this._swipePoint&&l.length===0&&this.reset();else{const d=this._tap.touchend(t,n,l);d&&(this._tapTime=t.timeStamp,this._tapPoint=d)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class rs{constructor(t,n,l){this._el=t,this._mousePan=n,this._touchPan=l}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class mo{constructor(t,n,l){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=n,this._mousePitch=l}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class ii{constructor(t,n,l,d){this._el=t,this._touchZoom=n,this._touchRotate=l,this._tapDragZoom=d,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class hi{constructor(t,n){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=t,this._options=n,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const t=this._map.getCanvasContainer();t.classList.add("maplibregl-cooperative-gestures"),this._container=c.create("div","maplibregl-cooperative-gesture-screen",t);let n=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(n=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const l=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),d=document.createElement("div");d.className="maplibregl-desktop-message",d.textContent=n,this._container.appendChild(d);const y=document.createElement("div");y.className="maplibregl-mobile-message",y.textContent=l,this._container.appendChild(y),this._container.setAttribute("aria-hidden","true")}_destoryUI(){this._container&&(c.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destoryUI()}isEnabled(){return this._enabled}touchmove(t){this._onCooperativeGesture(t.touches.length===1)}wheel(t){this._map.scrollZoom.isEnabled()&&this._onCooperativeGesture(!t[this._bypassKey])}_onCooperativeGesture(t){this._enabled&&t&&(this._container.classList.add("maplibregl-show"),setTimeout(()=>{this._container.classList.remove("maplibregl-show")},100))}}const pa=g=>g.zoom||g.drag||g.pitch||g.rotate;class vl extends s.k{}function go(g){return g.panDelta&&g.panDelta.mag()||g.zoomDelta||g.bearingDelta||g.pitchDelta}class En{constructor(t,n){this.handleWindowEvent=d=>{this.handleEvent(d,`${d.type}Window`)},this.handleEvent=(d,y)=>{if(d.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const P=d.type==="renderFrame"?void 0:d,A={needsRenderFrame:!1},O={},R={},N=d.touches,G=N?this._getMapTouches(N):void 0,Z=G?c.touchPos(this._map.getCanvas(),G):c.mousePos(this._map.getCanvas(),d);for(const{handlerName:ue,handler:te,allowed:Se}of this._handlers){if(!te.isEnabled())continue;let We;this._blockedByActive(R,Se,ue)?te.reset():te[y||d.type]&&(We=te[y||d.type](d,Z,G),this.mergeHandlerResult(A,O,We,ue,P),We&&We.needsRenderFrame&&this._triggerRenderFrame()),(We||te.isActive())&&(R[ue]=te)}const ce={};for(const ue in this._previousActiveHandlers)R[ue]||(ce[ue]=P);this._previousActiveHandlers=R,(Object.keys(ce).length||go(A))&&(this._changes.push([A,O,ce]),this._triggerRenderFrame()),(Object.keys(R).length||go(A))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:oe}=A;oe&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],oe(this._map))},this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Xn(t),this._bearingSnap=n.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(n);const l=this._el;this._listeners=[[l,"touchstart",{passive:!0}],[l,"touchmove",{passive:!1}],[l,"touchend",void 0],[l,"touchcancel",void 0],[l,"mousedown",void 0],[l,"mousemove",void 0],[l,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[l,"mouseover",void 0],[l,"mouseout",void 0],[l,"dblclick",void 0],[l,"click",void 0],[l,"keydown",{capture:!1}],[l,"keyup",void 0],[l,"wheel",{passive:!1}],[l,"contextmenu",void 0],[window,"blur",void 0]];for(const[d,y,P]of this._listeners)c.addEventListener(d,y,d===document?this.handleWindowEvent:this.handleEvent,P)}destroy(){for(const[t,n,l]of this._listeners)c.removeEventListener(t,n,t===document?this.handleWindowEvent:this.handleEvent,l)}_addDefaultHandlers(t){const n=this._map,l=n.getCanvasContainer();this._add("mapEvent",new Yn(n,t));const d=n.boxZoom=new Ri(n,t);this._add("boxZoom",d),t.interactive&&t.boxZoom&&d.enable();const y=n.cooperativeGestures=new hi(n,t.cooperativeGestures);this._add("cooperativeGestures",y),t.cooperativeGestures&&y.enable();const P=new _n(n),A=new ec(n);n.doubleClickZoom=new yl(A,P),this._add("tapZoom",P),this._add("clickZoom",A),t.interactive&&t.doubleClickZoom&&n.doubleClickZoom.enable();const O=new Oc;this._add("tapDragZoom",O);const R=n.touchPitch=new Ql(n);this._add("touchPitch",R),t.interactive&&t.touchPitch&&n.touchPitch.enable(t.touchPitch);const N=Tn(t),G=Va(t);n.dragRotate=new mo(t,N,G),this._add("mouseRotate",N,["mousePitch"]),this._add("mousePitch",G,["mouseRotate"]),t.interactive&&t.dragRotate&&n.dragRotate.enable();const Z=(({enable:We,clickTolerance:ge})=>{const ke=new Nt({checkCorrectEvent:He=>c.mouseButton(He)===0&&!He.ctrlKey});return new Rr({clickTolerance:ge,move:(He,qe)=>({around:qe,panDelta:qe.sub(He)}),activateOnStart:!0,moveStateManager:ke,enable:We,assignEvents:Sn})})(t),ce=new Bt(t,n);n.dragPan=new rs(l,Z,ce),this._add("mousePan",Z),this._add("touchPan",ce,["touchZoom","touchRotate"]),t.interactive&&t.dragPan&&n.dragPan.enable(t.dragPan);const oe=new Js,ue=new da;n.touchZoomRotate=new ii(l,ue,oe,O),this._add("touchRotate",oe,["touchPan","touchZoom"]),this._add("touchZoom",ue,["touchPan","touchRotate"]),t.interactive&&t.touchZoomRotate&&n.touchZoomRotate.enable(t.touchZoomRotate);const te=n.scrollZoom=new _l(n,()=>this._triggerRenderFrame());this._add("scrollZoom",te,["mousePan"]),t.interactive&&t.scrollZoom&&n.scrollZoom.enable(t.scrollZoom);const Se=n.keyboard=new ar(n);this._add("keyboard",Se),t.interactive&&t.keyboard&&n.keyboard.enable(),this._add("blockableMapEvent",new No(n))}_add(t,n,l){this._handlers.push({handlerName:t,handler:n,allowed:l}),this._handlersById[t]=n}stop(t){if(!this._updatingCamera){for(const{handler:n}of this._handlers)n.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[]}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!pa(this._eventsInProgress)||this.isZooming()}_blockedByActive(t,n,l){for(const d in t)if(d!==l&&(!n||n.indexOf(d)<0))return!0;return!1}_getMapTouches(t){const n=[];for(const l of t)this._el.contains(l.target)&&n.push(l);return n}mergeHandlerResult(t,n,l,d,y){if(!l)return;s.e(t,l);const P={handlerName:d,originalEvent:l.originalEvent||y};l.zoomDelta!==void 0&&(n.zoom=P),l.panDelta!==void 0&&(n.drag=P),l.pitchDelta!==void 0&&(n.pitch=P),l.bearingDelta!==void 0&&(n.rotate=P)}_applyChanges(){const t={},n={},l={};for(const[d,y,P]of this._changes)d.panDelta&&(t.panDelta=(t.panDelta||new s.P(0,0))._add(d.panDelta)),d.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+d.zoomDelta),d.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+d.bearingDelta),d.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+d.pitchDelta),d.around!==void 0&&(t.around=d.around),d.pinchAround!==void 0&&(t.pinchAround=d.pinchAround),d.noInertia&&(t.noInertia=d.noInertia),s.e(n,y),s.e(l,P);this._updateMapTransform(t,n,l),this._changes=[]}_updateMapTransform(t,n,l){const d=this._map,y=d._getTransformForUpdate(),P=d.terrain;if(!(go(t)||P&&this._terrainMovement))return this._fireEvents(n,l,!0);let{panDelta:A,zoomDelta:O,bearingDelta:R,pitchDelta:N,around:G,pinchAround:Z}=t;Z!==void 0&&(G=Z),d._stop(!0),G=G||d.transform.centerPoint;const ce=y.pointLocation(A?G.sub(A):G);R&&(y.bearing+=R),N&&(y.pitch+=N),O&&(y.zoom+=O),P?this._terrainMovement||!n.drag&&!n.zoom?n.drag&&this._terrainMovement?y.center=y.pointLocation(y.centerPoint.sub(A)):y.setLocationAtPoint(ce,G):(this._terrainMovement=!0,this._map._elevationFreeze=!0,y.setLocationAtPoint(ce,G),this._map.once("moveend",()=>{this._map._elevationFreeze=!1,this._terrainMovement=!1,y.recalculateZoom(d.terrain)})):y.setLocationAtPoint(ce,G),d._applyUpdatedTransform(y),this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(n,l,!0)}_fireEvents(t,n,l){const d=pa(this._eventsInProgress),y=pa(t),P={};for(const N in t){const{originalEvent:G}=t[N];this._eventsInProgress[N]||(P[`${N}start`]=G),this._eventsInProgress[N]=t[N]}!d&&y&&this._fireEvent("movestart",y.originalEvent);for(const N in P)this._fireEvent(N,P[N]);y&&this._fireEvent("move",y.originalEvent);for(const N in t){const{originalEvent:G}=t[N];this._fireEvent(N,G)}const A={};let O;for(const N in this._eventsInProgress){const{handlerName:G,originalEvent:Z}=this._eventsInProgress[N];this._handlersById[G].isActive()||(delete this._eventsInProgress[N],O=n[G]||Z,A[`${N}end`]=O)}for(const N in A)this._fireEvent(N,A[N]);const R=pa(this._eventsInProgress);if(l&&(d||y)&&!R){this._updatingCamera=!0;const N=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),G=Z=>Z!==0&&-this._bearingSnap<Z&&Z<this._bearingSnap;!N||!N.essential&&o.prefersReducedMotion?(this._map.fire(new s.k("moveend",{originalEvent:O})),G(this._map.getBearing())&&this._map.resetNorth()):(G(N.bearing||this._map.getBearing())&&(N.bearing=0),N.freezeElevation=!0,this._map.easeTo(N,{originalEvent:O})),this._updatingCamera=!1}}_fireEvent(t,n){this._map.fire(new s.k(t,n?{originalEvent:n}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{delete this._frameId,this.handleEvent(new vl("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class tc extends s.E{constructor(t,n){super(),this._renderFrameCallback=()=>{const l=Math.min((o.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(l)),l<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=n.bearingSnap,this.on("moveend",()=>{delete this._requestedCameraState})}getCenter(){return new s.M(this.transform.center.lng,this.transform.center.lat)}setCenter(t,n){return this.jumpTo({center:t},n)}panBy(t,n,l){return t=s.P.convert(t).mult(-1),this.panTo(this.transform.center,s.e({offset:t},n),l)}panTo(t,n,l){return this.easeTo(s.e({center:t},n),l)}getZoom(){return this.transform.zoom}setZoom(t,n){return this.jumpTo({zoom:t},n),this}zoomTo(t,n,l){return this.easeTo(s.e({zoom:t},n),l)}zoomIn(t,n){return this.zoomTo(this.getZoom()+1,t,n),this}zoomOut(t,n){return this.zoomTo(this.getZoom()-1,t,n),this}getBearing(){return this.transform.bearing}setBearing(t,n){return this.jumpTo({bearing:t},n),this}getPadding(){return this.transform.padding}setPadding(t,n){return this.jumpTo({padding:t},n),this}rotateTo(t,n,l){return this.easeTo(s.e({bearing:t},n),l)}resetNorth(t,n){return this.rotateTo(0,s.e({duration:1e3},t),n),this}resetNorthPitch(t,n){return this.easeTo(s.e({bearing:0,pitch:0,duration:1e3},t),n),this}snapToNorth(t,n){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,n):this}getPitch(){return this.transform.pitch}setPitch(t,n){return this.jumpTo({pitch:t},n),this}cameraForBounds(t,n){t=Qe.convert(t);const l=n&&n.bearing||0;return this._cameraForBoxAndBearing(t.getNorthWest(),t.getSouthEast(),l,n)}_cameraForBoxAndBearing(t,n,l,d){const y={top:0,bottom:0,right:0,left:0};if(typeof(d=s.e({padding:y,offset:[0,0],maxZoom:this.transform.maxZoom},d)).padding=="number"){const Xt=d.padding;d.padding={top:Xt,bottom:Xt,right:Xt,left:Xt}}d.padding=s.e(y,d.padding);const P=this.transform,A=P.padding,O=new Qe(t,n),R=P.project(O.getNorthWest()),N=P.project(O.getNorthEast()),G=P.project(O.getSouthEast()),Z=P.project(O.getSouthWest()),ce=s.b8(-l),oe=R.rotate(ce),ue=N.rotate(ce),te=G.rotate(ce),Se=Z.rotate(ce),We=new s.P(Math.max(oe.x,ue.x,Se.x,te.x),Math.max(oe.y,ue.y,Se.y,te.y)),ge=new s.P(Math.min(oe.x,ue.x,Se.x,te.x),Math.min(oe.y,ue.y,Se.y,te.y)),ke=We.sub(ge),He=(P.width-(A.left+A.right+d.padding.left+d.padding.right))/ke.x,qe=(P.height-(A.top+A.bottom+d.padding.top+d.padding.bottom))/ke.y;if(qe<0||He<0)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const rt=Math.min(P.scaleZoom(P.scale*Math.min(He,qe)),d.maxZoom),Ct=s.P.convert(d.offset),_t=new s.P((d.padding.left-d.padding.right)/2,(d.padding.top-d.padding.bottom)/2).rotate(s.b8(l)),wt=Ct.add(_t).mult(P.scale/P.zoomScale(rt));return{center:P.unproject(R.add(G).div(2).sub(wt)),zoom:rt,bearing:l}}fitBounds(t,n,l){return this._fitInternal(this.cameraForBounds(t,n),n,l)}fitScreenCoordinates(t,n,l,d,y){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.pointLocation(s.P.convert(t)),this.transform.pointLocation(s.P.convert(n)),l,d),d,y)}_fitInternal(t,n,l){return t?(delete(n=s.e(t,n)).padding,n.linear?this.easeTo(n,l):this.flyTo(n,l)):this}jumpTo(t,n){this.stop();const l=this._getTransformForUpdate();let d=!1,y=!1,P=!1;return"zoom"in t&&l.zoom!==+t.zoom&&(d=!0,l.zoom=+t.zoom),t.center!==void 0&&(l.center=s.M.convert(t.center)),"bearing"in t&&l.bearing!==+t.bearing&&(y=!0,l.bearing=+t.bearing),"pitch"in t&&l.pitch!==+t.pitch&&(P=!0,l.pitch=+t.pitch),t.padding==null||l.isPaddingEqual(t.padding)||(l.padding=t.padding),this._applyUpdatedTransform(l),this.fire(new s.k("movestart",n)).fire(new s.k("move",n)),d&&this.fire(new s.k("zoomstart",n)).fire(new s.k("zoom",n)).fire(new s.k("zoomend",n)),y&&this.fire(new s.k("rotatestart",n)).fire(new s.k("rotate",n)).fire(new s.k("rotateend",n)),P&&this.fire(new s.k("pitchstart",n)).fire(new s.k("pitch",n)).fire(new s.k("pitchend",n)),this.fire(new s.k("moveend",n))}calculateCameraOptionsFromTo(t,n,l,d=0){const y=s.Y.fromLngLat(t,n),P=s.Y.fromLngLat(l,d),A=P.x-y.x,O=P.y-y.y,R=P.z-y.z,N=Math.hypot(A,O,R);if(N===0)throw new Error("Can't calculate camera options with same From and To");const G=Math.hypot(A,O),Z=this.transform.scaleZoom(this.transform.cameraToCenterDistance/N/this.transform.tileSize),ce=180*Math.atan2(A,-O)/Math.PI;let oe=180*Math.acos(G/N)/Math.PI;return oe=R<0?90-oe:90+oe,{center:P.toLngLat(),zoom:Z,pitch:oe,bearing:ce}}easeTo(t,n){var l;this._stop(!1,t.easeId),((t=s.e({offset:[0,0],duration:500,easing:s.b7},t)).animate===!1||!t.essential&&o.prefersReducedMotion)&&(t.duration=0);const d=this._getTransformForUpdate(),y=this.getZoom(),P=this.getBearing(),A=this.getPitch(),O=this.getPadding(),R="bearing"in t?this._normalizeBearing(t.bearing,P):P,N="pitch"in t?+t.pitch:A,G="padding"in t?t.padding:d.padding,Z=s.P.convert(t.offset);let ce=d.centerPoint.add(Z);const oe=d.pointLocation(ce),{center:ue,zoom:te}=d.getConstrained(s.M.convert(t.center||oe),(l=t.zoom)!==null&&l!==void 0?l:y);this._normalizeCenter(ue);const Se=d.project(oe),We=d.project(ue).sub(Se),ge=d.zoomScale(te-y);let ke,He;t.around&&(ke=s.M.convert(t.around),He=d.locationPoint(ke));const qe={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=this._zooming||te!==y,this._rotating=this._rotating||P!==R,this._pitching=this._pitching||N!==A,this._padding=!d.isPaddingEqual(G),this._easeId=t.easeId,this._prepareEase(n,t.noMoveStart,qe),this.terrain&&this._prepareElevation(ue),this._ease(rt=>{if(this._zooming&&(d.zoom=s.z.number(y,te,rt)),this._rotating&&(d.bearing=s.z.number(P,R,rt)),this._pitching&&(d.pitch=s.z.number(A,N,rt)),this._padding&&(d.interpolatePadding(O,G,rt),ce=d.centerPoint.add(Z)),this.terrain&&!t.freezeElevation&&this._updateElevation(rt),ke)d.setLocationAtPoint(ke,He);else{const Ct=d.zoomScale(d.zoom-y),_t=te>y?Math.min(2,ge):Math.max(.5,ge),wt=Math.pow(_t,1-rt),Xt=d.unproject(Se.add(We.mult(rt*wt)).mult(Ct));d.setLocationAtPoint(d.renderWorldCopies?Xt.wrap():Xt,ce)}this._applyUpdatedTransform(d),this._fireMoveEvents(n)},rt=>{this.terrain&&this._finalizeElevation(),this._afterEase(n,rt)},t),this}_prepareEase(t,n,l={}){this._moving=!0,n||l.moving||this.fire(new s.k("movestart",t)),this._zooming&&!l.zooming&&this.fire(new s.k("zoomstart",t)),this._rotating&&!l.rotating&&this.fire(new s.k("rotatestart",t)),this._pitching&&!l.pitching&&this.fire(new s.k("pitchstart",t))}_prepareElevation(t){this._elevationCenter=t,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(t,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(t){this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);const n=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(t<1&&n!==this._elevationTarget){const l=this._elevationTarget-this._elevationStart;this._elevationStart+=t*(l-(n-(l*t+this._elevationStart))/(1-t)),this._elevationTarget=n}this.transform.elevation=s.z.number(this._elevationStart,this._elevationTarget,t)}_finalizeElevation(){this._elevationFreeze=!1,this.transform.recalculateZoom(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_applyUpdatedTransform(t){if(!this.transformCameraUpdate)return;const n=t.clone(),{center:l,zoom:d,pitch:y,bearing:P,elevation:A}=this.transformCameraUpdate(n);l&&(n.center=l),d!==void 0&&(n.zoom=d),y!==void 0&&(n.pitch=y),P!==void 0&&(n.bearing=P),A!==void 0&&(n.elevation=A),this.transform.apply(n)}_fireMoveEvents(t){this.fire(new s.k("move",t)),this._zooming&&this.fire(new s.k("zoom",t)),this._rotating&&this.fire(new s.k("rotate",t)),this._pitching&&this.fire(new s.k("pitch",t))}_afterEase(t,n){if(this._easeId&&n&&this._easeId===n)return;delete this._easeId;const l=this._zooming,d=this._rotating,y=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,l&&this.fire(new s.k("zoomend",t)),d&&this.fire(new s.k("rotateend",t)),y&&this.fire(new s.k("pitchend",t)),this.fire(new s.k("moveend",t))}flyTo(t,n){var l;if(!t.essential&&o.prefersReducedMotion){const Oi=s.L(t,["center","zoom","bearing","pitch","around"]);return this.jumpTo(Oi,n)}this.stop(),t=s.e({offset:[0,0],speed:1.2,curve:1.42,easing:s.b7},t);const d=this._getTransformForUpdate(),y=this.getZoom(),P=this.getBearing(),A=this.getPitch(),O=this.getPadding(),R="bearing"in t?this._normalizeBearing(t.bearing,P):P,N="pitch"in t?+t.pitch:A,G="padding"in t?t.padding:d.padding,Z=s.P.convert(t.offset);let ce=d.centerPoint.add(Z);const oe=d.pointLocation(ce),{center:ue,zoom:te}=d.getConstrained(s.M.convert(t.center||oe),(l=t.zoom)!==null&&l!==void 0?l:y);this._normalizeCenter(ue);const Se=d.zoomScale(te-y),We=d.project(oe),ge=d.project(ue).sub(We);let ke=t.curve;const He=Math.max(d.width,d.height),qe=He/Se,rt=ge.mag();if("minZoom"in t){const Oi=s.ac(Math.min(t.minZoom,y,te),d.minZoom,d.maxZoom),_i=He/d.zoomScale(Oi-y);ke=Math.sqrt(_i/rt*2)}const Ct=ke*ke;function _t(Oi){const _i=(qe*qe-He*He+(Oi?-1:1)*Ct*Ct*rt*rt)/(2*(Oi?qe:He)*Ct*rt);return Math.log(Math.sqrt(_i*_i+1)-_i)}function wt(Oi){return(Math.exp(Oi)-Math.exp(-Oi))/2}function Xt(Oi){return(Math.exp(Oi)+Math.exp(-Oi))/2}const vi=_t(!1);let Ft=function(Oi){return Xt(vi)/Xt(vi+ke*Oi)},di=function(Oi){return He*((Xt(vi)*(wt(_i=vi+ke*Oi)/Xt(_i))-wt(vi))/Ct)/rt;var _i},Ci=(_t(!0)-vi)/ke;if(Math.abs(rt)<1e-6||!isFinite(Ci)){if(Math.abs(He-qe)<1e-6)return this.easeTo(t,n);const Oi=qe<He?-1:1;Ci=Math.abs(Math.log(qe/He))/ke,di=function(){return 0},Ft=function(_i){return Math.exp(Oi*ke*_i)}}return t.duration="duration"in t?+t.duration:1e3*Ci/("screenSpeed"in t?+t.screenSpeed/ke:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0),this._zooming=!0,this._rotating=P!==R,this._pitching=N!==A,this._padding=!d.isPaddingEqual(G),this._prepareEase(n,!1),this.terrain&&this._prepareElevation(ue),this._ease(Oi=>{const _i=Oi*Ci,Si=1/Ft(_i);d.zoom=Oi===1?te:y+d.scaleZoom(Si),this._rotating&&(d.bearing=s.z.number(P,R,Oi)),this._pitching&&(d.pitch=s.z.number(A,N,Oi)),this._padding&&(d.interpolatePadding(O,G,Oi),ce=d.centerPoint.add(Z)),this.terrain&&!t.freezeElevation&&this._updateElevation(Oi);const Ti=Oi===1?ue:d.unproject(We.add(ge.mult(di(_i))).mult(Si));d.setLocationAtPoint(d.renderWorldCopies?Ti.wrap():Ti,ce),this._applyUpdatedTransform(d),this._fireMoveEvents(n)},()=>{this.terrain&&this._finalizeElevation(),this._afterEase(n)},t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(t,n){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const l=this._onEaseEnd;delete this._onEaseEnd,l.call(this,n)}if(!t){const l=this.handlers;l&&l.stop(!1)}return this}_ease(t,n,l){l.animate===!1||l.duration===0?(t(1),n()):(this._easeStart=o.now(),this._easeOptions=l,this._onEaseFrame=t,this._onEaseEnd=n,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(t,n){t=s.b1(t,-180,180);const l=Math.abs(t-n);return Math.abs(t-360-n)<l&&(t-=360),Math.abs(t+360-n)<l&&(t+=360),t}_normalizeCenter(t){const n=this.transform;if(!n.renderWorldCopies||n.lngRange)return;const l=t.lng-n.center.lng;t.lng+=l>180?-360:l<-180?360:0}queryTerrainElevation(t){return this.terrain?this.terrain.getElevationForLngLatZoom(s.M.convert(t),this.transform.tileZoom)-this.transform.elevation:null}}const ns={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class ic{constructor(t=ns){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=n=>{!n||n.sourceDataType!=="metadata"&&n.sourceDataType!=="visibility"&&n.dataType!=="style"&&n.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=t}getDefaultPosition(){return"bottom-right"}onAdd(t){return this._map=t,this._compact=this.options.compact,this._container=c.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=c.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=c.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){c.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(t,n){const l=this._map._getUIString(`AttributionControl.${n}`);t.title=l,t.setAttribute("aria-label",l)}_updateAttributions(){if(!this._map.style)return;let t=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=t.concat(this.options.customAttribution.map(d=>typeof d!="string"?"":d)):typeof this.options.customAttribution=="string"&&t.push(this.options.customAttribution)),this._map.style.stylesheet){const d=this._map.style.stylesheet;this.styleOwner=d.owner,this.styleId=d.id}const n=this._map.style.sourceCaches;for(const d in n){const y=n[d];if(y.used||y.usedForTerrain){const P=y.getSource();P.attribution&&t.indexOf(P.attribution)<0&&t.push(P.attribution)}}t=t.filter(d=>String(d).trim()),t.sort((d,y)=>d.length-y.length),t=t.filter((d,y)=>{for(let P=y+1;P<t.length;P++)if(t[P].indexOf(d)>=0)return!1;return!0});const l=t.join(" | ");l!==this._attribHTML&&(this._attribHTML=l,t.length?(this._innerContainer.innerHTML=l,this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class Ua{constructor(t={}){this._updateCompact=()=>{const n=this._container.children;if(n.length){const l=n[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&l.classList.add("maplibregl-compact"):l.classList.remove("maplibregl-compact")}},this.options=t}getDefaultPosition(){return"bottom-left"}onAdd(t){this._map=t,this._compact=this.options&&this.options.compact,this._container=c.create("div","maplibregl-ctrl");const n=c.create("a","maplibregl-ctrl-logo");return n.target="_blank",n.rel="noopener nofollow",n.href="https://maplibre.org/",n.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),n.setAttribute("rel","noopener nofollow"),this._container.appendChild(n),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){c.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class Cr{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const n=++this._id;return this._queue.push({callback:t,id:n,cancelled:!1}),n}remove(t){const n=this._currentlyRunning,l=n?this._queue.concat(n):this._queue;for(const d of l)if(d.id===t)return void(d.cancelled=!0)}run(t=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const n=this._currentlyRunning=this._queue;this._queue=[];for(const l of n)if(!l.cancelled&&(l.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var Pr=s.X([{name:"a_pos3d",type:"Int16",components:3}]);class rc extends s.E{constructor(t){super(),this.sourceCache=t,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.deltaZoom=1,t.usedForTerrain=!0,t.tileSize=this.tileSize*2**this.deltaZoom}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(t,n){this.sourceCache.update(t,n),this._renderableTilesKeys=[];const l={};for(const d of t.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:n}))l[d.key]=!0,this._renderableTilesKeys.push(d.key),this._tiles[d.key]||(d.posMatrix=new Float64Array(16),s.aN(d.posMatrix,0,s.W,0,s.W,0,1),this._tiles[d.key]=new Zt(d,this.tileSize));for(const d in this._tiles)l[d]||delete this._tiles[d]}freeRtt(t){for(const n in this._tiles){const l=this._tiles[n];(!t||l.tileID.equals(t)||l.tileID.isChildOf(t)||t.isChildOf(l.tileID))&&(l.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map(t=>this.getTileByID(t))}getTileByID(t){return this._tiles[t]}getTerrainCoords(t){const n={};for(const l of this._renderableTilesKeys){const d=this._tiles[l].tileID;if(d.canonical.equals(t.canonical)){const y=t.clone();y.posMatrix=new Float64Array(16),s.aN(y.posMatrix,0,s.W,0,s.W,0,1),n[l]=y}else if(d.canonical.isChildOf(t.canonical)){const y=t.clone();y.posMatrix=new Float64Array(16);const P=d.canonical.z-t.canonical.z,A=d.canonical.x-(d.canonical.x>>P<<P),O=d.canonical.y-(d.canonical.y>>P<<P),R=s.W>>P;s.aN(y.posMatrix,0,R,0,R,0,1),s.H(y.posMatrix,y.posMatrix,[-A*R,-O*R,0]),n[l]=y}else if(t.canonical.isChildOf(d.canonical)){const y=t.clone();y.posMatrix=new Float64Array(16);const P=t.canonical.z-d.canonical.z,A=t.canonical.x-(t.canonical.x>>P<<P),O=t.canonical.y-(t.canonical.y>>P<<P),R=s.W>>P;s.aN(y.posMatrix,0,s.W,0,s.W,0,1),s.H(y.posMatrix,y.posMatrix,[A*R,O*R,0]),s.J(y.posMatrix,y.posMatrix,[1/2**P,1/2**P,0]),n[l]=y}}return n}getSourceTile(t,n){const l=this.sourceCache._source;let d=t.overscaledZ-this.deltaZoom;if(d>l.maxzoom&&(d=l.maxzoom),d<l.minzoom)return null;this._sourceTileCache[t.key]||(this._sourceTileCache[t.key]=t.scaledTo(d).key);let y=this.sourceCache.getTileByID(this._sourceTileCache[t.key]);if((!y||!y.dem)&&n)for(;d>=l.minzoom&&(!y||!y.dem);)y=this.sourceCache.getTileByID(t.scaledTo(d--).key);return y}tilesAfterTime(t=Date.now()){return Object.values(this._tiles).filter(n=>n.timeAdded>=t)}}class _o{constructor(t,n,l){this.painter=t,this.sourceCache=new rc(n),this.options=l,this.exaggeration=typeof l.exaggeration=="number"?l.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(t,n,l,d=s.W){var y;if(!(n>=0&&n<d&&l>=0&&l<d))return 0;const P=this.getTerrainData(t),A=(y=P.tile)===null||y===void 0?void 0:y.dem;if(!A)return 0;const O=function(oe,ue,te){var Se=ue[0],We=ue[1];return oe[0]=te[0]*Se+te[4]*We+te[12],oe[1]=te[1]*Se+te[5]*We+te[13],oe}([],[n/d*s.W,l/d*s.W],P.u_terrain_matrix),R=[O[0]*A.dim,O[1]*A.dim],N=Math.floor(R[0]),G=Math.floor(R[1]),Z=R[0]-N,ce=R[1]-G;return A.get(N,G)*(1-Z)*(1-ce)+A.get(N+1,G)*Z*(1-ce)+A.get(N,G+1)*(1-Z)*ce+A.get(N+1,G+1)*Z*ce}getElevationForLngLatZoom(t,n){const{tileID:l,mercatorX:d,mercatorY:y}=this._getOverscaledTileIDFromLngLatZoom(t,n);return this.getElevation(l,d%s.W,y%s.W,s.W)}getElevation(t,n,l,d=s.W){return this.getDEMElevation(t,n,l,d)*this.exaggeration}getTerrainData(t){if(!this._emptyDemTexture){const d=this.painter.context,y=new s.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new $e(d,y,d.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new $e(d,new s.R({width:1,height:1}),d.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(d.gl.NEAREST,d.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=s.an([])}const n=this.sourceCache.getSourceTile(t,!0);if(n&&n.dem&&(!n.demTexture||n.needsTerrainPrepare)){const d=this.painter.context;n.demTexture=this.painter.getTileTexture(n.dem.stride),n.demTexture?n.demTexture.update(n.dem.getPixels(),{premultiply:!1}):n.demTexture=new $e(d,n.dem.getPixels(),d.gl.RGBA,{premultiply:!1}),n.demTexture.bind(d.gl.NEAREST,d.gl.CLAMP_TO_EDGE),n.needsTerrainPrepare=!1}const l=n&&n+n.tileID.key+t.key;if(l&&!this._demMatrixCache[l]){const d=this.sourceCache.sourceCache._source.maxzoom;let y=t.canonical.z-n.tileID.canonical.z;t.overscaledZ>t.canonical.z&&(t.canonical.z>=d?y=t.canonical.z-d:s.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const P=t.canonical.x-(t.canonical.x>>y<<y),A=t.canonical.y-(t.canonical.y>>y<<y),O=s.b9(new Float64Array(16),[1/(s.W<<y),1/(s.W<<y),0]);s.H(O,O,[P*s.W,A*s.W,0]),this._demMatrixCache[t.key]={matrix:O,coord:t}}return{u_depth:2,u_terrain:3,u_terrain_dim:n&&n.dem&&n.dem.dim||1,u_terrain_matrix:l?this._demMatrixCache[t.key].matrix:this._emptyDemMatrix,u_terrain_unpack:n&&n.dem&&n.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(n&&n.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:n}}getFramebuffer(t){const n=this.painter,l=n.width/devicePixelRatio,d=n.height/devicePixelRatio;return!this._fbo||this._fbo.width===l&&this._fbo.height===d||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new $e(n.context,{width:l,height:d,data:null},n.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(n.context.gl.NEAREST,n.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new $e(n.context,{width:l,height:d,data:null},n.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(n.context.gl.NEAREST,n.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=n.context.createFramebuffer(l,d,!0,!1),this._fbo.depthAttachment.set(n.context.createRenderbuffer(n.context.gl.DEPTH_COMPONENT16,l,d))),this._fbo.colorAttachment.set(t==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const t=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const n=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let y=0,P=0;y<this._coordsTextureSize;y++)for(let A=0;A<this._coordsTextureSize;A++,P+=4)n[P+0]=255&A,n[P+1]=255&y,n[P+2]=A>>8<<4|y>>8,n[P+3]=0;const l=new s.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(n.buffer)),d=new $e(t,l,t.gl.RGBA,{premultiply:!1});return d.bind(t.gl.NEAREST,t.gl.CLAMP_TO_EDGE),this._coordsTexture=d,d}pointCoordinate(t){this.painter.maybeDrawDepthAndCoords(!0);const n=new Uint8Array(4),l=this.painter.context,d=l.gl;l.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),d.readPixels(t.x,this.painter.height/devicePixelRatio-t.y-1,1,1,d.RGBA,d.UNSIGNED_BYTE,n),l.bindFramebuffer.set(null);const y=n[0]+(n[2]>>4<<8),P=n[1]+((15&n[2])<<8),A=this.coordsIndex[255-n[3]],O=A&&this.sourceCache.getTileByID(A);if(!O)return null;const R=this._coordsTextureSize,N=(1<<O.tileID.canonical.z)*R;return new s.Y((O.tileID.canonical.x*R+y)/N+O.tileID.wrap,(O.tileID.canonical.y*R+P)/N,this.getElevation(O.tileID,y,P,R))}depthAtPoint(t){const n=new Uint8Array(4),l=this.painter.context,d=l.gl;return l.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),d.readPixels(t.x,this.painter.height/devicePixelRatio-t.y-1,1,1,d.RGBA,d.UNSIGNED_BYTE,n),l.bindFramebuffer.set(null),(n[0]/16777216+n[1]/65536+n[2]/256+n[3])/256}getTerrainMesh(){if(this._mesh)return this._mesh;const t=this.painter.context,n=new s.ba,l=new s.aX,d=this.meshSize,y=s.W/d,P=d*d;for(let G=0;G<=d;G++)for(let Z=0;Z<=d;Z++)n.emplaceBack(Z*y,G*y,0);for(let G=0;G<P;G+=d+1)for(let Z=0;Z<d;Z++)l.emplaceBack(Z+G,d+Z+G+1,d+Z+G+2),l.emplaceBack(Z+G,d+Z+G+2,Z+G+1);const A=n.length,O=A+2*(d+1);for(const G of[0,1])for(let Z=0;Z<=d;Z++)for(const ce of[0,1])n.emplaceBack(Z*y,G*s.W,ce);for(let G=0;G<2*d;G+=2)l.emplaceBack(O+G,O+G+1,O+G+3),l.emplaceBack(O+G,O+G+3,O+G+2),l.emplaceBack(A+G,A+G+3,A+G+1),l.emplaceBack(A+G,A+G+2,A+G+3);const R=n.length,N=R+2*(d+1);for(const G of[0,1])for(let Z=0;Z<=d;Z++)for(const ce of[0,1])n.emplaceBack(G*s.W,Z*y,ce);for(let G=0;G<2*d;G+=2)l.emplaceBack(R+G,R+G+1,R+G+3),l.emplaceBack(R+G,R+G+3,R+G+2),l.emplaceBack(N+G,N+G+3,N+G+1),l.emplaceBack(N+G,N+G+2,N+G+3);return this._mesh={indexBuffer:t.createIndexBuffer(l),vertexBuffer:t.createVertexBuffer(n,Pr.members),segments:s.$.simpleSegment(0,0,n.length,l.length)},this._mesh}getMeshFrameDelta(t){return 2*Math.PI*s.bb/Math.pow(2,t)/5}getMinTileElevationForLngLatZoom(t,n){var l;const{tileID:d}=this._getOverscaledTileIDFromLngLatZoom(t,n);return(l=this.getMinMaxElevation(d).minElevation)!==null&&l!==void 0?l:0}getMinMaxElevation(t){const n=this.getTerrainData(t).tile,l={minElevation:null,maxElevation:null};return n&&n.dem&&(l.minElevation=n.dem.min*this.exaggeration,l.maxElevation=n.dem.max*this.exaggeration),l}_getOverscaledTileIDFromLngLatZoom(t,n){const l=s.Y.fromLngLat(t.wrap()),d=(1<<n)*s.W,y=l.x*d,P=l.y*d,A=Math.floor(y/s.W),O=Math.floor(P/s.W);return{tileID:new s.Q(n,0,n,A,O),mercatorX:y,mercatorY:P}}}class Go{constructor(t,n,l){this._context=t,this._size=n,this._tileSize=l,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const t of this._objects)t.texture.destroy(),t.fbo.destroy()}_createObject(t){const n=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),l=new $e(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return l.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),n.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),n.colorAttachment.set(l.texture),{id:t,fbo:n,texture:l,stamp:-1,inUse:!1}}getObjectForId(t){return this._objects[t]}useObject(t){t.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter(n=>t.id!==n),this._recentlyUsed.push(t.id)}stampObject(t){t.stamp=++this._stamp}getOrCreateFreeObject(){for(const n of this._recentlyUsed)if(!this._objects[n].inUse)return this._objects[n];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const t=this._createObject(this._objects.length);return this._objects.push(t),t}freeObject(t){t.inUse=!1}freeAllObjects(){for(const t of this._objects)this.freeObject(t)}isFull(){return!(this._objects.length<this._size)&&this._objects.some(t=>!t.inUse)===!1}}const Qs={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0};class xl{constructor(t,n){this.painter=t,this.terrain=n,this.pool=new Go(t.context,30,n.sourceCache.tileSize*n.qualityFactor)}destruct(){this.pool.destruct()}getTexture(t){return this.pool.getObjectForId(t.rtt[this._stacks.length-1].id).texture}prepareForRender(t,n){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=t._order.filter(l=>!t._layers[l].isHidden(n)),this._coordsDescendingInv={};for(const l in t.sourceCaches){this._coordsDescendingInv[l]={};const d=t.sourceCaches[l].getVisibleCoordinates();for(const y of d){const P=this.terrain.sourceCache.getTerrainCoords(y);for(const A in P)this._coordsDescendingInv[l][A]||(this._coordsDescendingInv[l][A]=[]),this._coordsDescendingInv[l][A].push(P[A])}}this._coordsDescendingInvStr={};for(const l of t._order){const d=t._layers[l],y=d.source;if(Qs[d.type]&&!this._coordsDescendingInvStr[y]){this._coordsDescendingInvStr[y]={};for(const P in this._coordsDescendingInv[y])this._coordsDescendingInvStr[y][P]=this._coordsDescendingInv[y][P].map(A=>A.key).sort().join()}}for(const l of this._renderableTiles)for(const d in this._coordsDescendingInvStr){const y=this._coordsDescendingInvStr[d][l.tileID.key];y&&y!==l.rttCoords[d]&&(l.rtt=[])}}renderLayer(t){if(t.isHidden(this.painter.transform.zoom))return!1;const n=t.type,l=this.painter,d=this._renderableLayerIds[this._renderableLayerIds.length-1]===t.id;if(Qs[n]&&(this._prevType&&Qs[this._prevType]||this._stacks.push([]),this._prevType=n,this._stacks[this._stacks.length-1].push(t.id),!d))return!0;if(Qs[this._prevType]||Qs[n]&&d){this._prevType=n;const y=this._stacks.length-1,P=this._stacks[y]||[];for(const A of this._renderableTiles){if(this.pool.isFull()&&(ze(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(A),A.rtt[y]){const R=this.pool.getObjectForId(A.rtt[y].id);if(R.stamp===A.rtt[y].stamp){this.pool.useObject(R);continue}}const O=this.pool.getOrCreateFreeObject();this.pool.useObject(O),this.pool.stampObject(O),A.rtt[y]={id:O.id,stamp:O.stamp},l.context.bindFramebuffer.set(O.fbo.framebuffer),l.context.clear({color:s.aO.transparent,stencil:0}),l.currentStencilSource=void 0;for(let R=0;R<P.length;R++){const N=l.style._layers[P[R]],G=N.source?this._coordsDescendingInv[N.source][A.tileID.key]:[A.tileID];l.context.viewport.set([0,0,O.fbo.width,O.fbo.height]),l._renderTileClippingMasks(N,G),l.renderLayer(l,l.style.sourceCaches[N.source],N,G),N.source&&(A.rttCoords[N.source]=this._coordsDescendingInvStr[N.source][A.tileID.key])}}return ze(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects(),Qs[n]}return!1}}const bl={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use ⌘ + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},yo=m,wl={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:ns,maplibreLogo:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:s.a.MAX_TILE_CACHE_ZOOM_LEVELS,localIdeographFontFamily:"sans-serif",transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,validateStyle:!0,maxCanvasSize:[4096,4096]},Wo=g=>{g.touchstart=g.dragStart,g.touchmoveWindow=g.dragMove,g.touchend=g.dragEnd},Cl={showCompass:!0,showZoom:!0,visualizePitch:!1};class Sl{constructor(t,n,l=!1){this.mousedown=P=>{this.startMouse(s.e({},P,{ctrlKey:!0,preventDefault:()=>P.preventDefault()}),c.mousePos(this.element,P)),c.addEventListener(window,"mousemove",this.mousemove),c.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=P=>{this.moveMouse(P,c.mousePos(this.element,P))},this.mouseup=P=>{this.mouseRotate.dragEnd(P),this.mousePitch&&this.mousePitch.dragEnd(P),this.offTemp()},this.touchstart=P=>{P.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=c.touchPos(this.element,P.targetTouches)[0],this.startTouch(P,this._startPos),c.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),c.addEventListener(window,"touchend",this.touchend))},this.touchmove=P=>{P.targetTouches.length!==1?this.reset():(this._lastPos=c.touchPos(this.element,P.targetTouches)[0],this.moveTouch(P,this._lastPos))},this.touchend=P=>{P.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),this.touchRotate.reset(),this.touchPitch&&this.touchPitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10;const d=t.dragRotate._mouseRotate.getClickTolerance(),y=t.dragRotate._mousePitch.getClickTolerance();this.element=n,this.mouseRotate=Tn({clickTolerance:d,enable:!0}),this.touchRotate=(({enable:P,clickTolerance:A,bearingDegreesPerPixelMoved:O=.8})=>{const R=new Zs;return new Rr({clickTolerance:A,move:(N,G)=>({bearingDelta:(G.x-N.x)*O}),moveStateManager:R,enable:P,assignEvents:Wo})})({clickTolerance:d,enable:!0}),this.map=t,l&&(this.mousePitch=Va({clickTolerance:y,enable:!0}),this.touchPitch=(({enable:P,clickTolerance:A,pitchDegreesPerPixelMoved:O=-.5})=>{const R=new Zs;return new Rr({clickTolerance:A,move:(N,G)=>({pitchDelta:(G.y-N.y)*O}),moveStateManager:R,enable:P,assignEvents:Wo})})({clickTolerance:y,enable:!0})),c.addEventListener(n,"mousedown",this.mousedown),c.addEventListener(n,"touchstart",this.touchstart,{passive:!1}),c.addEventListener(n,"touchcancel",this.reset)}startMouse(t,n){this.mouseRotate.dragStart(t,n),this.mousePitch&&this.mousePitch.dragStart(t,n),c.disableDrag()}startTouch(t,n){this.touchRotate.dragStart(t,n),this.touchPitch&&this.touchPitch.dragStart(t,n),c.disableDrag()}moveMouse(t,n){const l=this.map,{bearingDelta:d}=this.mouseRotate.dragMove(t,n)||{};if(d&&l.setBearing(l.getBearing()+d),this.mousePitch){const{pitchDelta:y}=this.mousePitch.dragMove(t,n)||{};y&&l.setPitch(l.getPitch()+y)}}moveTouch(t,n){const l=this.map,{bearingDelta:d}=this.touchRotate.dragMove(t,n)||{};if(d&&l.setBearing(l.getBearing()+d),this.touchPitch){const{pitchDelta:y}=this.touchPitch.dragMove(t,n)||{};y&&l.setPitch(l.getPitch()+y)}}off(){const t=this.element;c.removeEventListener(t,"mousedown",this.mousedown),c.removeEventListener(t,"touchstart",this.touchstart,{passive:!1}),c.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),c.removeEventListener(window,"touchend",this.touchend),c.removeEventListener(t,"touchcancel",this.reset),this.offTemp()}offTemp(){c.enableDrag(),c.removeEventListener(window,"mousemove",this.mousemove),c.removeEventListener(window,"mouseup",this.mouseup),c.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),c.removeEventListener(window,"touchend",this.touchend)}}let zs;function Ho(g,t,n){const l=new s.M(g.lng,g.lat);if(g=new s.M(g.lng,g.lat),t){const d=new s.M(g.lng-360,g.lat),y=new s.M(g.lng+360,g.lat),P=n.locationPoint(g).distSqr(t);n.locationPoint(d).distSqr(t)<P?g=d:n.locationPoint(y).distSqr(t)<P&&(g=y)}for(;Math.abs(g.lng-n.center.lng)>180;){const d=n.locationPoint(g);if(d.x>=0&&d.y>=0&&d.x<=n.width&&d.y<=n.height)break;g.lng>n.center.lng?g.lng-=360:g.lng+=360}return g.lng!==l.lng&&n.locationPoint(g).y>n.height/2-n.getHorizon()?g:l}const vo={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function Xo(g,t,n){const l=g.classList;for(const d in vo)l.remove(`maplibregl-${n}-anchor-${d}`);l.add(`maplibregl-${n}-anchor-${t}`)}class Ga extends s.E{constructor(t){if(super(),this._onKeyPress=n=>{const l=n.code,d=n.charCode||n.keyCode;l!=="Space"&&l!=="Enter"&&d!==32&&d!==13||this.togglePopup()},this._onMapClick=n=>{const l=n.originalEvent.target,d=this._element;this._popup&&(l===d||d.contains(l))&&this.togglePopup()},this._update=n=>{var l;if(!this._map)return;const d=this._map.loaded()&&!this._map.isMoving();((n==null?void 0:n.type)==="terrain"||(n==null?void 0:n.type)==="render"&&!d)&&this._map.once("render",this._update),this._lngLat=this._map.transform.renderWorldCopies?Ho(this._lngLat,this._flatPos,this._map.transform):(l=this._lngLat)===null||l===void 0?void 0:l.wrap(),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationPoint(this._lngLat)._add(this._offset));let y="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?y=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(y=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let P="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?P="rotateX(0deg)":this._pitchAlignment==="map"&&(P=`rotateX(${this._map.getPitch()}deg)`),n&&n.type!=="moveend"||(this._pos=this._pos.round()),c.setTransform(this._element,`${vo[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${P} ${y}`),o.frameAsync(new AbortController).then(()=>{this._updateOpacity(n&&n.type==="moveend")}).catch(()=>{})},this._onMove=n=>{if(!this._isDragging){const l=this._clickTolerance||this._map._clickTolerance;this._isDragging=n.point.dist(this._pointerdownPos)>=l}this._isDragging&&(this._pos=n.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.k("dragstart"))),this.fire(new s.k("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new s.k("dragend")),this._state="inactive"},this._addDragHandler=n=>{this._element.contains(n.originalEvent.target)&&(n.preventDefault(),this._positionDelta=n.point.sub(this._pos).add(this._offset),this._pointerdownPos=n.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&t.pitchAlignment!=="auto"?t.pitchAlignment:this._rotationAlignment,this.setOpacity(),this.setOpacity(t==null?void 0:t.opacity,t==null?void 0:t.opacityWhenCovered),t&&t.element)this._element=t.element,this._offset=s.P.convert(t&&t.offset||[0,0]);else{this._defaultMarker=!0,this._element=c.create("div"),this._element.setAttribute("aria-label","Map marker");const n=c.createNS("http://www.w3.org/2000/svg","svg"),l=41,d=27;n.setAttributeNS(null,"display","block"),n.setAttributeNS(null,"height",`${l}px`),n.setAttributeNS(null,"width",`${d}px`),n.setAttributeNS(null,"viewBox",`0 0 ${d} ${l}`);const y=c.createNS("http://www.w3.org/2000/svg","g");y.setAttributeNS(null,"stroke","none"),y.setAttributeNS(null,"stroke-width","1"),y.setAttributeNS(null,"fill","none"),y.setAttributeNS(null,"fill-rule","evenodd");const P=c.createNS("http://www.w3.org/2000/svg","g");P.setAttributeNS(null,"fill-rule","nonzero");const A=c.createNS("http://www.w3.org/2000/svg","g");A.setAttributeNS(null,"transform","translate(3.0, 29.0)"),A.setAttributeNS(null,"fill","#000000");const O=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const Se of O){const We=c.createNS("http://www.w3.org/2000/svg","ellipse");We.setAttributeNS(null,"opacity","0.04"),We.setAttributeNS(null,"cx","10.5"),We.setAttributeNS(null,"cy","5.80029008"),We.setAttributeNS(null,"rx",Se.rx),We.setAttributeNS(null,"ry",Se.ry),A.appendChild(We)}const R=c.createNS("http://www.w3.org/2000/svg","g");R.setAttributeNS(null,"fill",this._color);const N=c.createNS("http://www.w3.org/2000/svg","path");N.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),R.appendChild(N);const G=c.createNS("http://www.w3.org/2000/svg","g");G.setAttributeNS(null,"opacity","0.25"),G.setAttributeNS(null,"fill","#000000");const Z=c.createNS("http://www.w3.org/2000/svg","path");Z.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),G.appendChild(Z);const ce=c.createNS("http://www.w3.org/2000/svg","g");ce.setAttributeNS(null,"transform","translate(6.0, 7.0)"),ce.setAttributeNS(null,"fill","#FFFFFF");const oe=c.createNS("http://www.w3.org/2000/svg","g");oe.setAttributeNS(null,"transform","translate(8.0, 8.0)");const ue=c.createNS("http://www.w3.org/2000/svg","circle");ue.setAttributeNS(null,"fill","#000000"),ue.setAttributeNS(null,"opacity","0.25"),ue.setAttributeNS(null,"cx","5.5"),ue.setAttributeNS(null,"cy","5.5"),ue.setAttributeNS(null,"r","5.4999962");const te=c.createNS("http://www.w3.org/2000/svg","circle");te.setAttributeNS(null,"fill","#FFFFFF"),te.setAttributeNS(null,"cx","5.5"),te.setAttributeNS(null,"cy","5.5"),te.setAttributeNS(null,"r","5.4999962"),oe.appendChild(ue),oe.appendChild(te),P.appendChild(A),P.appendChild(R),P.appendChild(G),P.appendChild(ce),P.appendChild(oe),n.appendChild(P),n.setAttributeNS(null,"height",l*this._scale+"px"),n.setAttributeNS(null,"width",d*this._scale+"px"),this._element.appendChild(n),this._offset=s.P.convert(t&&t.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",n=>{n.preventDefault()}),this._element.addEventListener("mousedown",n=>{n.preventDefault()}),Xo(this._element,this._anchor,"marker"),t&&t.className)for(const n of t.className.split(" "))this._element.classList.add(n);this._popup=null}addTo(t){return this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._update),t.on("moveend",this._update),t.on("terrain",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),c.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=s.M.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const d=Math.abs(13.5)/Math.SQRT2;t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[d,-1*(38.1-13.5+d)],"bottom-right":[-d,-1*(38.1-13.5+d)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}getPopup(){return this._popup}togglePopup(){const t=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:t?(t.isOpen()?t.remove():(t.setLngLat(this._lngLat),t.addTo(this._map)),this):this}_updateOpacity(t=!1){var n,l;if(!(!((n=this._map)===null||n===void 0)&&n.terrain))return void(this._element.style.opacity!==this._opacity&&(this._element.style.opacity=this._opacity));if(t)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout(()=>{this._opacityTimeout=null},100)}const d=this._map,y=d.terrain.depthAtPoint(this._pos),P=d.terrain.getElevationForLngLatZoom(this._lngLat,d.transform.tileZoom);if(d.transform.lngLatToCameraDepth(this._lngLat,P)-y<.006)return void(this._element.style.opacity=this._opacity);const A=-this._offset.y/d.transform._pixelPerMeter,O=Math.sin(d.getPitch()*Math.PI/180)*A,R=d.terrain.depthAtPoint(new s.P(this._pos.x,this._pos.y-this._offset.y)),N=d.transform.lngLatToCameraDepth(this._lngLat,P+O)-R>.006;!((l=this._popup)===null||l===void 0)&&l.isOpen()&&N&&this._popup.remove(),this._element.style.opacity=N?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(t){return this._offset=s.P.convert(t),this._update(),this}addClassName(t){this._element.classList.add(t)}removeClassName(t){this._element.classList.remove(t)}toggleClassName(t){return this._element.classList.toggle(t)}setDraggable(t){return this._draggable=!!t,this._map&&(t?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t&&t!=="auto"?t:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(t,n){return t===void 0&&n===void 0&&(this._opacity="1",this._opacityWhenCovered="0.2"),t!==void 0&&(this._opacity=t),n!==void 0&&(this._opacityWhenCovered=n),this._map&&this._updateOpacity(!0),this}}const Tl={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let Wa=0,ea=!1;const El={maxWidth:100,unit:"metric"};function qo(g,t,n){const l=n&&n.maxWidth||100,d=g._container.clientHeight/2,y=g.unproject([0,d]),P=g.unproject([l,d]),A=y.distanceTo(P);if(n&&n.unit==="imperial"){const O=3.2808*A;O>5280?ma(t,l,O/5280,g._getUIString("ScaleControl.Miles")):ma(t,l,O,g._getUIString("ScaleControl.Feet"))}else n&&n.unit==="nautical"?ma(t,l,A/1852,g._getUIString("ScaleControl.NauticalMiles")):A>=1e3?ma(t,l,A/1e3,g._getUIString("ScaleControl.Kilometers")):ma(t,l,A,g._getUIString("ScaleControl.Meters"))}function ma(g,t,n,l){const d=function(y){const P=Math.pow(10,`${Math.floor(y)}`.length-1);let A=y/P;return A=A>=10?10:A>=5?5:A>=3?3:A>=2?2:A>=1?1:function(O){const R=Math.pow(10,Math.ceil(-Math.log(O)/Math.LN10));return Math.round(O*R)/R}(A),P*A}(n);g.style.width=t*(d/n)+"px",g.innerHTML=`${d}&nbsp;${l}`}const Il={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1},Pl=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Al(g){if(g){if(typeof g=="number"){const t=Math.round(Math.abs(g)/Math.SQRT2);return{center:new s.P(0,0),top:new s.P(0,g),"top-left":new s.P(t,t),"top-right":new s.P(-t,t),bottom:new s.P(0,-g),"bottom-left":new s.P(t,-t),"bottom-right":new s.P(-t,-t),left:new s.P(g,0),right:new s.P(-g,0)}}if(g instanceof s.P||Array.isArray(g)){const t=s.P.convert(g);return{center:t,top:t,"top-left":t,"top-right":t,bottom:t,"bottom-left":t,"bottom-right":t,left:t,right:t}}return{center:s.P.convert(g.center||[0,0]),top:s.P.convert(g.top||[0,0]),"top-left":s.P.convert(g["top-left"]||[0,0]),"top-right":s.P.convert(g["top-right"]||[0,0]),bottom:s.P.convert(g.bottom||[0,0]),"bottom-left":s.P.convert(g["bottom-left"]||[0,0]),"bottom-right":s.P.convert(g["bottom-right"]||[0,0]),left:s.P.convert(g.left||[0,0]),right:s.P.convert(g.right||[0,0])}}return Al(new s.P(0,0))}const nc=m;V.AJAXError=s.be,V.Evented=s.E,V.LngLat=s.M,V.MercatorCoordinate=s.Y,V.Point=s.P,V.addProtocol=s.bf,V.config=s.a,V.removeProtocol=s.bg,V.AttributionControl=ic,V.BoxZoomHandler=Ri,V.CanvasSource=Yt,V.CooperativeGesturesHandler=hi,V.DoubleClickZoomHandler=yl,V.DragPanHandler=rs,V.DragRotateHandler=mo,V.EdgeInsets=Yi,V.FullscreenControl=class extends s.E{constructor(g={}){super(),this._onFullscreenChange=()=>{var t;let n=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((t=n==null?void 0:n.shadowRoot)===null||t===void 0)&&t.fullscreenElement;)n=n.shadowRoot.fullscreenElement;n===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,g&&g.container&&(g.container instanceof HTMLElement?this._container=g.container:s.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(g){return this._map=g,this._container||(this._container=this._map.getContainer()),this._controlContainer=c.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){c.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const g=this._fullscreenButton=c.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);c.create("span","maplibregl-ctrl-icon",g).setAttribute("aria-hidden","true"),g.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const g=this._getTitle();this._fullscreenButton.setAttribute("aria-label",g),this._fullscreenButton.title=g}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new s.k("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new s.k("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},V.GeoJSONSource=Pt,V.GeolocateControl=class extends s.E{constructor(g){super(),this._onSuccess=t=>{if(this._map){if(this._isOutOfMapMaxBounds(t))return this._setErrorState(),this.fire(new s.k("outofmaxbounds",t)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=t,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(t),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(t),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new s.k("geolocate",t)),this._finish()}},this._updateCamera=t=>{const n=new s.M(t.coords.longitude,t.coords.latitude),l=t.coords.accuracy,d=this._map.getBearing(),y=s.e({bearing:d},this.options.fitBoundsOptions),P=Qe.fromLngLat(n,l);this._map.fitBounds(P,y,{geolocateSource:!0})},this._updateMarker=t=>{if(t){const n=new s.M(t.coords.longitude,t.coords.latitude);this._accuracyCircleMarker.setLngLat(n).addTo(this._map),this._userLocationDotMarker.setLngLat(n).addTo(this._map),this._accuracy=t.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=t=>{if(this._map){if(this.options.trackUserLocation)if(t.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const n=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=n,this._geolocateButton.setAttribute("aria-label",n),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(t.code===3&&ea)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new s.k("error",t)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=t=>{if(this._map){if(this._container.addEventListener("contextmenu",n=>n.preventDefault()),this._geolocateButton=c.create("button","maplibregl-ctrl-geolocate",this._container),c.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",t===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const n=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=n,this._geolocateButton.setAttribute("aria-label",n)}else{const n=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.title=n,this._geolocateButton.setAttribute("aria-label",n)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=c.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new Ga({element:this._dotElement}),this._circleElement=c.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Ga({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",()=>this.trigger()),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",n=>{n.geolocateSource||this._watchState!=="ACTIVE_LOCK"||n.originalEvent&&n.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new s.k("trackuserlocationend")))})}},this.options=s.e({},Tl,g)}onAdd(g){return this._map=g,this._container=c.create("div","maplibregl-ctrl maplibregl-ctrl-group"),function(){return s._(this,arguments,void 0,function*(t=!1){if(zs!==void 0&&!t)return zs;if(window.navigator.permissions===void 0)return zs=!!window.navigator.geolocation,zs;try{zs=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{zs=!!window.navigator.geolocation}return zs})}().then(t=>this._setupUI(t)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),c.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,Wa=0,ea=!1}_isOutOfMapMaxBounds(g){const t=this._map.getMaxBounds(),n=g.coords;return t&&(n.longitude<t.getWest()||n.longitude>t.getEast()||n.latitude<t.getSouth()||n.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const g=this._map.getBounds(),t=g.getSouthEast(),n=g.getNorthEast(),l=t.distanceTo(n),d=Math.ceil(this._accuracy/(l/this._map._container.clientHeight)*2);this._circleElement.style.width=`${d}px`,this._circleElement.style.height=`${d}px`}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.k("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Wa--,ea=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new s.k("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.k("trackuserlocationstart"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let g;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Wa++,Wa>1?(g={maximumAge:6e5,timeout:0},ea=!0):(g=this.options.positionOptions,ea=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,g)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},V.Hash=mn,V.ImageSource=nt,V.KeyboardHandler=ar,V.LngLatBounds=Qe,V.LogoControl=Ua,V.Map=class extends tc{constructor(g){if(s.bc.mark(s.bd.create),(g=s.e({},wl,g)).minZoom!=null&&g.maxZoom!=null&&g.minZoom>g.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(g.minPitch!=null&&g.maxPitch!=null&&g.minPitch>g.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(g.minPitch!=null&&g.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(g.maxPitch!=null&&g.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(super(new ir(g.minZoom,g.maxZoom,g.minPitch,g.maxPitch,g.renderWorldCopies),{bearingSnap:g.bearingSnap}),this._contextLost=t=>{t.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new s.k("webglcontextlost",{originalEvent:t}))},this._contextRestored=t=>{this._setupPainter(),this.resize(),this._update(),this.fire(new s.k("webglcontextrestored",{originalEvent:t}))},this._onMapScroll=t=>{if(t.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=g.interactive,this._maxTileCacheSize=g.maxTileCacheSize,this._maxTileCacheZoomLevels=g.maxTileCacheZoomLevels,this._failIfMajorPerformanceCaveat=g.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=g.preserveDrawingBuffer,this._antialias=g.antialias,this._trackResize=g.trackResize,this._bearingSnap=g.bearingSnap,this._refreshExpiredTiles=g.refreshExpiredTiles,this._fadeDuration=g.fadeDuration,this._crossSourceCollisions=g.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=g.collectResourceTiming,this._renderTaskQueue=new Cr,this._controls=[],this._mapId=s.a3(),this._locale=s.e({},bl,g.locale),this._clickTolerance=g.clickTolerance,this._overridePixelRatio=g.pixelRatio,this._maxCanvasSize=g.maxCanvasSize,this.transformCameraUpdate=g.transformCameraUpdate,this._imageQueueHandle=D.addThrottleControl(()=>this.isMoving()),this._requestManager=new U(g.transformRequest),typeof g.container=="string"){if(this._container=document.getElementById(g.container),!this._container)throw new Error(`Container '${g.container}' not found.`)}else{if(!(g.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=g.container}if(g.maxBounds&&this.setMaxBounds(g.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this.on("terrain",()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)}),this.once("idle",()=>{this._idleTriggered=!0}),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let t=!1;const n=yr(l=>{this._trackResize&&!this._removed&&this.resize(l)._update()},50);this._resizeObserver=new ResizeObserver(l=>{t?n(l):t=!0}),this._resizeObserver.observe(this._container)}this.handlers=new En(this,g),this._hash=g.hash&&new mn(typeof g.hash=="string"&&g.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:g.center,zoom:g.zoom,bearing:g.bearing,pitch:g.pitch}),g.bounds&&(this.resize(),this.fitBounds(g.bounds,s.e({},g.fitBoundsOptions,{duration:0})))),this.resize(),this._localIdeographFontFamily=g.localIdeographFontFamily,this._validateStyle=g.validateStyle,g.style&&this.setStyle(g.style,{localIdeographFontFamily:g.localIdeographFontFamily}),g.attributionControl&&this.addControl(new ic(typeof g.attributionControl=="boolean"?void 0:g.attributionControl)),g.maplibreLogo&&this.addControl(new Ua,g.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",t=>{this._update(t.dataType==="style"),this.fire(new s.k(`${t.dataType}data`,t))}),this.on("dataloading",t=>{this.fire(new s.k(`${t.dataType}dataloading`,t))}),this.on("dataabort",t=>{this.fire(new s.k("sourcedataabort",t))})}_getMapId(){return this._mapId}addControl(g,t){if(t===void 0&&(t=g.getDefaultPosition?g.getDefaultPosition():"top-right"),!g||!g.onAdd)return this.fire(new s.j(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=g.onAdd(this);this._controls.push(g);const l=this._controlPositions[t];return t.indexOf("bottom")!==-1?l.insertBefore(n,l.firstChild):l.appendChild(n),this}removeControl(g){if(!g||!g.onRemove)return this.fire(new s.j(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(g);return t>-1&&this._controls.splice(t,1),g.onRemove(this),this}hasControl(g){return this._controls.indexOf(g)>-1}calculateCameraOptionsFromTo(g,t,n,l){return l==null&&this.terrain&&(l=this.terrain.getElevationForLngLatZoom(n,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(g,t,n,l)}resize(g){var t;const n=this._containerDimensions(),l=n[0],d=n[1],y=this._getClampedPixelRatio(l,d);if(this._resizeCanvas(l,d,y),this.painter.resize(l,d,y),this.painter.overLimit()){const A=this.painter.context.gl;this._maxCanvasSize=[A.drawingBufferWidth,A.drawingBufferHeight];const O=this._getClampedPixelRatio(l,d);this._resizeCanvas(l,d,O),this.painter.resize(l,d,O)}this.transform.resize(l,d),(t=this._requestedCameraState)===null||t===void 0||t.resize(l,d);const P=!this._moving;return P&&(this.stop(),this.fire(new s.k("movestart",g)).fire(new s.k("move",g))),this.fire(new s.k("resize",g)),P&&this.fire(new s.k("moveend",g)),this}_getClampedPixelRatio(g,t){const{0:n,1:l}=this._maxCanvasSize,d=this.getPixelRatio(),y=g*d,P=t*d;return Math.min(y>n?n/y:1,P>l?l/P:1)*d}getPixelRatio(){var g;return(g=this._overridePixelRatio)!==null&&g!==void 0?g:devicePixelRatio}setPixelRatio(g){this._overridePixelRatio=g,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(g){return this.transform.setMaxBounds(Qe.convert(g)),this._update()}setMinZoom(g){if((g=g??-2)>=-2&&g<=this.transform.maxZoom)return this.transform.minZoom=g,this._update(),this.getZoom()<g&&this.setZoom(g),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(g){if((g=g??22)>=this.transform.minZoom)return this.transform.maxZoom=g,this._update(),this.getZoom()>g&&this.setZoom(g),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(g){if((g=g??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(g>=0&&g<=this.transform.maxPitch)return this.transform.minPitch=g,this._update(),this.getPitch()<g&&this.setPitch(g),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(g){if((g=g??60)>85)throw new Error("maxPitch must be less than or equal to 85");if(g>=this.transform.minPitch)return this.transform.maxPitch=g,this._update(),this.getPitch()>g&&this.setPitch(g),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(g){return this.transform.renderWorldCopies=g,this._update()}project(g){return this.transform.locationPoint(s.M.convert(g),this.style&&this.terrain)}unproject(g){return this.transform.pointLocation(s.P.convert(g),this.terrain)}isMoving(){var g;return this._moving||((g=this.handlers)===null||g===void 0?void 0:g.isMoving())}isZooming(){var g;return this._zooming||((g=this.handlers)===null||g===void 0?void 0:g.isZooming())}isRotating(){var g;return this._rotating||((g=this.handlers)===null||g===void 0?void 0:g.isRotating())}_createDelegatedListener(g,t,n){if(g==="mouseenter"||g==="mouseover"){let l=!1;return{layer:t,listener:n,delegates:{mousemove:y=>{const P=this.getLayer(t)?this.queryRenderedFeatures(y.point,{layers:[t]}):[];P.length?l||(l=!0,n.call(this,new fr(g,this,y.originalEvent,{features:P}))):l=!1},mouseout:()=>{l=!1}}}}if(g==="mouseleave"||g==="mouseout"){let l=!1;return{layer:t,listener:n,delegates:{mousemove:P=>{(this.getLayer(t)?this.queryRenderedFeatures(P.point,{layers:[t]}):[]).length?l=!0:l&&(l=!1,n.call(this,new fr(g,this,P.originalEvent)))},mouseout:P=>{l&&(l=!1,n.call(this,new fr(g,this,P.originalEvent)))}}}}{const l=d=>{const y=this.getLayer(t)?this.queryRenderedFeatures(d.point,{layers:[t]}):[];y.length&&(d.features=y,n.call(this,d),delete d.features)};return{layer:t,listener:n,delegates:{[g]:l}}}}on(g,t,n){if(n===void 0)return super.on(g,t);const l=this._createDelegatedListener(g,t,n);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[g]=this._delegatedListeners[g]||[],this._delegatedListeners[g].push(l);for(const d in l.delegates)this.on(d,l.delegates[d]);return this}once(g,t,n){if(n===void 0)return super.once(g,t);const l=this._createDelegatedListener(g,t,n);for(const d in l.delegates)this.once(d,l.delegates[d]);return this}off(g,t,n){return n===void 0?super.off(g,t):(this._delegatedListeners&&this._delegatedListeners[g]&&(l=>{const d=this._delegatedListeners[g];for(let y=0;y<d.length;y++){const P=d[y];if(P.layer===t&&P.listener===n){for(const A in P.delegates)this.off(A,P.delegates[A]);return d.splice(y,1),this}}})(),this)}queryRenderedFeatures(g,t){if(!this.style)return[];let n;const l=g instanceof s.P||Array.isArray(g),d=l?g:[[0,0],[this.transform.width,this.transform.height]];if(t=t||(l?{}:g)||{},d instanceof s.P||typeof d[0]=="number")n=[s.P.convert(d)];else{const y=s.P.convert(d[0]),P=s.P.convert(d[1]);n=[y,new s.P(P.x,y.y),P,new s.P(y.x,P.y),y]}return this.style.queryRenderedFeatures(n,t,this.transform)}querySourceFeatures(g,t){return this.style.querySourceFeatures(g,t)}setStyle(g,t){return(t=s.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},t)).diff!==!1&&t.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&g?(this._diffStyle(g,t),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._updateStyle(g,t))}setTransformRequest(g){return this._requestManager.setTransformRequest(g),this}_getUIString(g){const t=this._locale[g];if(t==null)throw new Error(`Missing UI string '${g}'`);return t}_updateStyle(g,t){if(t.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",()=>this._updateStyle(g,t));const n=this.style&&t.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!g)),g?(this.style=new oa(this,t||{}),this.style.setEventedParent(this,{style:this.style}),typeof g=="string"?this.style.loadURL(g,t,n):this.style.loadJSON(g,t,n),this):(delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new oa(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(g,t){if(typeof g=="string"){const n=this._requestManager.transformRequest(g,L.Style);s.h(n,new AbortController).then(l=>{this._updateDiff(l.data,t)}).catch(l=>{l&&this.fire(new s.j(l))})}else typeof g=="object"&&this._updateDiff(g,t)}_updateDiff(g,t){try{this.style.setState(g,t)&&this._update(!0)}catch(n){s.w(`Unable to perform style diff: ${n.message||n.error||n}.  Rebuilding the style from scratch.`),this._updateStyle(g,t)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():s.w("There is no style added to the map.")}addSource(g,t){return this._lazyInitEmptyStyle(),this.style.addSource(g,t),this._update(!0)}isSourceLoaded(g){const t=this.style&&this.style.sourceCaches[g];if(t!==void 0)return t.loaded();this.fire(new s.j(new Error(`There is no source with ID '${g}'`)))}setTerrain(g){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),g){const t=this.style.sourceCaches[g.source];if(!t)throw new Error(`cannot load terrain, because there exists no source with ID: ${g.source}`);this.terrain===null&&t.reload();for(const n in this.style._layers){const l=this.style._layers[n];l.type==="hillshade"&&l.source===g.source&&s.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new _o(this.painter,t,g),this.painter.renderToTexture=new xl(this.painter,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._terrainDataCallback=n=>{n.dataType==="style"?this.terrain.sourceCache.freeRtt():n.dataType==="source"&&n.tile&&(n.sourceId!==g.source||this._elevationFreeze||(this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.terrain.sourceCache.freeRtt(n.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.minElevationForCurrentTile=0,this.transform.elevation=0;return this.fire(new s.k("terrain",{terrain:g})),this}getTerrain(){var g,t;return(t=(g=this.terrain)===null||g===void 0?void 0:g.options)!==null&&t!==void 0?t:null}areTilesLoaded(){const g=this.style&&this.style.sourceCaches;for(const t in g){const n=g[t]._tiles;for(const l in n){const d=n[l];if(d.state!=="loaded"&&d.state!=="errored")return!1}}return!0}removeSource(g){return this.style.removeSource(g),this._update(!0)}getSource(g){return this.style.getSource(g)}addImage(g,t,n={}){const{pixelRatio:l=1,sdf:d=!1,stretchX:y,stretchY:P,content:A}=n;if(this._lazyInitEmptyStyle(),!(t instanceof HTMLImageElement||s.b(t))){if(t.width===void 0||t.height===void 0)return this.fire(new s.j(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:O,height:R,data:N}=t,G=t;return this.style.addImage(g,{data:new s.R({width:O,height:R},new Uint8Array(N)),pixelRatio:l,stretchX:y,stretchY:P,content:A,sdf:d,version:0,userImage:G}),G.onAdd&&G.onAdd(this,g),this}}{const{width:O,height:R,data:N}=o.getImageData(t);this.style.addImage(g,{data:new s.R({width:O,height:R},N),pixelRatio:l,stretchX:y,stretchY:P,content:A,sdf:d,version:0})}}updateImage(g,t){const n=this.style.getImage(g);if(!n)return this.fire(new s.j(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const l=t instanceof HTMLImageElement||s.b(t)?o.getImageData(t):t,{width:d,height:y,data:P}=l;if(d===void 0||y===void 0)return this.fire(new s.j(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(d!==n.data.width||y!==n.data.height)return this.fire(new s.j(new Error("The width and height of the updated image must be that same as the previous version of the image")));const A=!(t instanceof HTMLImageElement||s.b(t));return n.data.replace(P,A),this.style.updateImage(g,n),this}getImage(g){return this.style.getImage(g)}hasImage(g){return g?!!this.style.getImage(g):(this.fire(new s.j(new Error("Missing required image id"))),!1)}removeImage(g){this.style.removeImage(g)}loadImage(g){return D.getImage(this._requestManager.transformRequest(g,L.Image),new AbortController)}listImages(){return this.style.listImages()}addLayer(g,t){return this._lazyInitEmptyStyle(),this.style.addLayer(g,t),this._update(!0)}moveLayer(g,t){return this.style.moveLayer(g,t),this._update(!0)}removeLayer(g){return this.style.removeLayer(g),this._update(!0)}getLayer(g){return this.style.getLayer(g)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(g,t,n){return this.style.setLayerZoomRange(g,t,n),this._update(!0)}setFilter(g,t,n={}){return this.style.setFilter(g,t,n),this._update(!0)}getFilter(g){return this.style.getFilter(g)}setPaintProperty(g,t,n,l={}){return this.style.setPaintProperty(g,t,n,l),this._update(!0)}getPaintProperty(g,t){return this.style.getPaintProperty(g,t)}setLayoutProperty(g,t,n,l={}){return this.style.setLayoutProperty(g,t,n,l),this._update(!0)}getLayoutProperty(g,t){return this.style.getLayoutProperty(g,t)}setGlyphs(g,t={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(g,t),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(g,t,n={}){return this._lazyInitEmptyStyle(),this.style.addSprite(g,t,n,l=>{l||this._update(!0)}),this}removeSprite(g){return this._lazyInitEmptyStyle(),this.style.removeSprite(g),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(g,t={}){return this._lazyInitEmptyStyle(),this.style.setSprite(g,t,n=>{n||this._update(!0)}),this}setLight(g,t={}){return this._lazyInitEmptyStyle(),this.style.setLight(g,t),this._update(!0)}getLight(){return this.style.getLight()}setFeatureState(g,t){return this.style.setFeatureState(g,t),this._update()}removeFeatureState(g,t){return this.style.removeFeatureState(g,t),this._update()}getFeatureState(g){return this.style.getFeatureState(g)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let g=0,t=0;return this._container&&(g=this._container.clientWidth||400,t=this._container.clientHeight||300),[g,t]}_setupContainer(){const g=this._container;g.classList.add("maplibregl-map");const t=this._canvasContainer=c.create("div","maplibregl-canvas-container",g);this._interactive&&t.classList.add("maplibregl-interactive"),this._canvas=c.create("canvas","maplibregl-canvas",t),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map"),this._canvas.setAttribute("role","region");const n=this._containerDimensions(),l=this._getClampedPixelRatio(n[0],n[1]);this._resizeCanvas(n[0],n[1],l);const d=this._controlContainer=c.create("div","maplibregl-control-container",g),y=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(P=>{y[P]=c.create("div",`maplibregl-ctrl-${P} `,d)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(g,t,n){this._canvas.width=Math.floor(n*g),this._canvas.height=Math.floor(n*t),this._canvas.style.width=`${g}px`,this._canvas.style.height=`${t}px`}_setupPainter(){const g={alpha:!0,stencil:!0,depth:!0,failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1};let t=null;this._canvas.addEventListener("webglcontextcreationerror",l=>{t={requestedAttributes:g},l&&(t.statusMessage=l.statusMessage,t.type=l.type)},{once:!0});const n=this._canvas.getContext("webgl2",g)||this._canvas.getContext("webgl",g);if(!n){const l="Failed to initialize WebGL";throw t?(t.message=l,new Error(JSON.stringify(t))):new Error(l)}this.painter=new tt(n,this.transform),h.testSupport(n)}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(g){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||g,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(g){return this._update(),this._renderTaskQueue.add(g)}_cancelRenderFrame(g){this._renderTaskQueue.remove(g)}_render(g){const t=this._idleTriggered?this._fadeDuration:0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(g),this._removed)return;let n=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const d=this.transform.zoom,y=o.now();this.style.zoomHistory.update(d,y);const P=new s.a8(d,{now:y,fadeDuration:t,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),A=P.crossFadingFactor();A===1&&A===this._crossFadingFactor||(n=!0,this._crossFadingFactor=A),this.style.update(P)}this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._elevationFreeze||(this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.minElevationForCurrentTile=0,this.transform.elevation=0),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,t,this._crossSourceCollisions),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:t,showPadding:this.showPadding}),this.fire(new s.k("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,s.bc.mark(s.bd.load),this.fire(new s.k("load"))),this.style&&(this.style.hasTransitions()||n)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const l=this._sourcesDirty||this._styleDirty||this._placementDirty;return l||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new s.k("idle")),!this._loaded||this._fullyLoaded||l||(this._fullyLoaded=!0,s.bc.mark(s.bd.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var g;this._hash&&this._hash.remove();for(const n of this._controls)n.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),D.removeThrottleControl(this._imageQueueHandle),(g=this._resizeObserver)===null||g===void 0||g.disconnect();const t=this.painter.context.gl.getExtension("WEBGL_lose_context");t&&t.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),c.remove(this._canvasContainer),c.remove(this._controlContainer),this._container.classList.remove("maplibregl-map"),s.bc.clearMetrics(),this._removed=!0,this.fire(new s.k("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,o.frameAsync(this._frameRequest).then(g=>{s.bc.frame(g),this._frameRequest=null,this._render(g)}).catch(()=>{}))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(g){this._showTileBoundaries!==g&&(this._showTileBoundaries=g,this._update())}get showPadding(){return!!this._showPadding}set showPadding(g){this._showPadding!==g&&(this._showPadding=g,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(g){this._showCollisionBoxes!==g&&(this._showCollisionBoxes=g,g?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(g){this._showOverdrawInspector!==g&&(this._showOverdrawInspector=g,this._update())}get repaint(){return!!this._repaint}set repaint(g){this._repaint!==g&&(this._repaint=g,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(g){this._vertices=g,this._update()}get version(){return yo}getCameraTargetElevation(){return this.transform.elevation}},V.MapMouseEvent=fr,V.MapTouchEvent=$n,V.MapWheelEvent=gn,V.Marker=Ga,V.NavigationControl=class{constructor(g){this._updateZoomButtons=()=>{const t=this._map.getZoom(),n=t===this._map.getMaxZoom(),l=t===this._map.getMinZoom();this._zoomInButton.disabled=n,this._zoomOutButton.disabled=l,this._zoomInButton.setAttribute("aria-disabled",n.toString()),this._zoomOutButton.setAttribute("aria-disabled",l.toString())},this._rotateCompassArrow=()=>{const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._compassIcon.style.transform=t},this._setButtonTitle=(t,n)=>{const l=this._map._getUIString(`NavigationControl.${n}`);t.title=l,t.setAttribute("aria-label",l)},this.options=s.e({},Cl,g),this._container=c.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",t=>this._map.zoomIn({},{originalEvent:t})),c.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",t=>this._map.zoomOut({},{originalEvent:t})),c.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",t=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:t}):this._map.resetNorth({},{originalEvent:t})}),this._compassIcon=c.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(g){return this._map=g,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Sl(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){c.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(g,t){const n=c.create("button",g,this._container);return n.type="button",n.addEventListener("click",t),n}},V.Popup=class extends s.E{constructor(g){super(),this.remove=()=>(this._content&&c.remove(this._content),this._container&&(c.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new s.k("close"))),this),this._onMouseUp=t=>{this._update(t.point)},this._onMouseMove=t=>{this._update(t.point)},this._onDrag=t=>{this._update(t.point)},this._update=t=>{var n;if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=c.create("div","maplibregl-popup",this._map.getContainer()),this._tip=c.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const A of this.options.className.split(" "))this._container.classList.add(A);this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=this._map.transform.renderWorldCopies&&!this._trackPointer?Ho(this._lngLat,this._flatPos,this._map.transform):(n=this._lngLat)===null||n===void 0?void 0:n.wrap(),this._trackPointer&&!t)return;const l=this._flatPos=this._pos=this._trackPointer&&t?t:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&t?t:this._map.transform.locationPoint(this._lngLat));let d=this.options.anchor;const y=Al(this.options.offset);if(!d){const A=this._container.offsetWidth,O=this._container.offsetHeight;let R;R=l.y+y.bottom.y<O?["top"]:l.y>this._map.transform.height-O?["bottom"]:[],l.x<A/2?R.push("left"):l.x>this._map.transform.width-A/2&&R.push("right"),d=R.length===0?"bottom":R.join("-")}let P=l.add(y[d]);this.options.subpixelPositioning||(P=P.round()),c.setTransform(this._container,`${vo[d]} translate(${P.x}px,${P.y}px)`),Xo(this._container,d,"popup")},this._onClose=()=>{this.remove()},this.options=s.e(Object.create(Il),g)}addTo(g){return this._map&&this.remove(),this._map=g,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new s.k("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(g){return this._lngLat=s.M.convert(g),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(g){return this.setDOMContent(document.createTextNode(g))}setHTML(g){const t=document.createDocumentFragment(),n=document.createElement("body");let l;for(n.innerHTML=g;l=n.firstChild,l;)t.appendChild(l);return this.setDOMContent(t)}getMaxWidth(){var g;return(g=this._container)===null||g===void 0?void 0:g.style.maxWidth}setMaxWidth(g){return this.options.maxWidth=g,this._update(),this}setDOMContent(g){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=c.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(g),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(g){this._container&&this._container.classList.add(g)}removeClassName(g){this._container&&this._container.classList.remove(g)}setOffset(g){return this.options.offset=g,this._update(),this}toggleClassName(g){if(this._container)return this._container.classList.toggle(g)}setSubpixelPositioning(g){this.options.subpixelPositioning=g}_createCloseButton(){this.options.closeButton&&(this._closeButton=c.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.setAttribute("aria-label","Close popup"),this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const g=this._container.querySelector(Pl);g&&g.focus()}},V.RasterDEMTileSource=bt,V.RasterTileSource=it,V.ScaleControl=class{constructor(g){this._onMove=()=>{qo(this._map,this._container,this.options)},this.setUnit=t=>{this.options.unit=t,qo(this._map,this._container,this.options)},this.options=s.e({},El,g)}getDefaultPosition(){return"bottom-left"}onAdd(g){return this._map=g,this._container=c.create("div","maplibregl-ctrl maplibregl-ctrl-scale",g.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){c.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},V.ScrollZoomHandler=_l,V.Style=oa,V.TerrainControl=class{constructor(g){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=g}onAdd(g){return this._map=g,this._container=c.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=c.create("button","maplibregl-ctrl-terrain",this._container),c.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){c.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},V.TwoFingersTouchPitchHandler=Ql,V.TwoFingersTouchRotateHandler=Js,V.TwoFingersTouchZoomHandler=da,V.TwoFingersTouchZoomRotateHandler=ii,V.VectorTileSource=le,V.VideoSource=qt,V.addSourceType=(g,t)=>s._(void 0,void 0,void 0,function*(){if(xi(g))throw new Error(`A source type called "${g}" already exists.`);((n,l)=>{gi[n]=l})(g,t)}),V.clearPrewarmedResources=function(){const g=Ce;g&&(g.isPreloaded()&&g.numActive()===1?(g.release(Re),Ce=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},V.getMaxParallelImageRequests=function(){return s.a.MAX_PARALLEL_IMAGE_REQUESTS},V.getRTLTextPluginStatus=function(){return Hi().getRTLTextPluginStatus()},V.getVersion=function(){return nc},V.getWorkerCount=function(){return fe.workerCount},V.getWorkerUrl=function(){return s.a.WORKER_URL},V.importScriptInWorkers=function(g){return Ge().broadcast("importScript",g)},V.prewarm=function(){Je().acquire(Re)},V.setMaxParallelImageRequests=function(g){s.a.MAX_PARALLEL_IMAGE_REQUESTS=g},V.setRTLTextPlugin=function(g,t){return Hi().setRTLTextPlugin(g,t)},V.setWorkerCount=function(g){fe.workerCount=g},V.setWorkerUrl=function(g){s.a.WORKER_URL=g}});var Ze=xe;return Ze})})(vd);var bd=vd.exports;const cd=yd(bd);var wd={exports:{}};(function(ie,I){(function(xe,Ae){ie.exports=Ae()})(sl,function(){var xe=function(T,z){var q={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},me={on:function(Ee,Fe,Tt){if(q[Ee]===void 0)throw new Error("Invalid event type: "+Ee);q[Ee].push({selector:Fe,fn:Tt})},render:function(Ee){z.store.featureChanged(Ee)}},Te=function(Ee,Fe){for(var Tt=q[Ee],Mt=Tt.length;Mt--;){var jt=Tt[Mt];if(jt.selector(Fe)){jt.fn.call(me,Fe)||z.store.render(),z.ui.updateMapClasses();break}}};return T.start.call(me),{render:T.render,stop:function(){T.stop&&T.stop()},trash:function(){T.trash&&(T.trash(),z.store.render())},combineFeatures:function(){T.combineFeatures&&T.combineFeatures()},uncombineFeatures:function(){T.uncombineFeatures&&T.uncombineFeatures()},drag:function(Ee){Te("drag",Ee)},click:function(Ee){Te("click",Ee)},mousemove:function(Ee){Te("mousemove",Ee)},mousedown:function(Ee){Te("mousedown",Ee)},mouseup:function(Ee){Te("mouseup",Ee)},mouseout:function(Ee){Te("mouseout",Ee)},keydown:function(Ee){Te("keydown",Ee)},keyup:function(Ee){Te("keyup",Ee)},touchstart:function(Ee){Te("touchstart",Ee)},touchmove:function(Ee){Te("touchmove",Ee)},touchend:function(Ee){Te("touchend",Ee)},tap:function(Ee){Te("tap",Ee)}}};function Ae(T){return T&&T.__esModule&&Object.prototype.hasOwnProperty.call(T,"default")?T.default:T}function Ne(T){if(T.__esModule)return T;var z=T.default;if(typeof z=="function"){var q=function me(){if(this instanceof me){var Te=[null];Te.push.apply(Te,arguments);var Ee=Function.bind.apply(z,Te);return new Ee}return z.apply(this,arguments)};q.prototype=z.prototype}else q={};return Object.defineProperty(q,"__esModule",{value:!0}),Object.keys(T).forEach(function(me){var Te=Object.getOwnPropertyDescriptor(T,me);Object.defineProperty(q,me,Te.get?Te:{enumerable:!0,get:function(){return T[me]}})}),q}var Ze={},V={RADIUS:6378137,FLATTENING:1/298.257223563,POLAR_RADIUS:63567523142e-4},s=V;function m(T){var z=0;if(T&&T.length>0){z+=Math.abs(b(T[0]));for(var q=1;q<T.length;q++)z-=Math.abs(b(T[q]))}return z}function b(T){var z,q,me,Te,Ee,Fe,Tt=0,Mt=T.length;if(Mt>2){for(Fe=0;Fe<Mt;Fe++)Fe===Mt-2?(me=Mt-2,Te=Mt-1,Ee=0):Fe===Mt-1?(me=Mt-1,Te=0,Ee=1):(me=Fe,Te=Fe+1,Ee=Fe+2),z=T[me],q=T[Te],Tt+=(x(T[Ee][0])-x(z[0]))*Math.sin(x(q[1]));Tt=Tt*s.RADIUS*s.RADIUS/2}return Tt}function x(T){return T*Math.PI/180}Ze.geometry=function T(z){var q,me=0;switch(z.type){case"Polygon":return m(z.coordinates);case"MultiPolygon":for(q=0;q<z.coordinates.length;q++)me+=m(z.coordinates[q]);return me;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(q=0;q<z.geometries.length;q++)me+=T(z.geometries[q]);return me}},Ze.ring=b;var o={CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},c={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},h={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},p={POLYGON:"polygon",LINE:"line_string",POINT:"point"},_={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},u={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select",STATIC:"static"},C={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},S={MOVE:"move",CHANGE_COORDINATES:"change_coordinates"},D={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},L={ACTIVE:"true",INACTIVE:"false"},U=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],$=-85,ne=Object.freeze({__proto__:null,classes:o,sources:c,cursors:h,types:p,geojsonTypes:_,modes:u,events:C,updateActions:S,meta:D,activeStates:L,interactions:U,LAT_MIN:-90,LAT_RENDERED_MIN:$,LAT_MAX:90,LAT_RENDERED_MAX:85,LNG_MIN:-270,LNG_MAX:270}),ye={Point:0,LineString:1,MultiLineString:1,Polygon:2};function Ve(T,z){var q=ye[T.geometry.type]-ye[z.geometry.type];return q===0&&T.geometry.type===_.POLYGON?T.area-z.area:q}function Ke(T){return T.map(function(z){return z.geometry.type===_.POLYGON&&(z.area=Ze.geometry({type:_.FEATURE,property:{},geometry:z.geometry})),z}).sort(Ve).map(function(z){return delete z.area,z})}function at(T,z){return z===void 0&&(z=0),[[T.point.x-z,T.point.y-z],[T.point.x+z,T.point.y+z]]}function $e(T){if(this._items={},this._nums={},this._length=T?T.length:0,T)for(var z=0,q=T.length;z<q;z++)this.add(T[z]),T[z]!==void 0&&(typeof T[z]=="string"?this._items[T[z]]=z:this._nums[T[z]]=z)}$e.prototype.add=function(T){return this.has(T)||(this._length++,typeof T=="string"?this._items[T]=this._length:this._nums[T]=this._length),this},$e.prototype.delete=function(T){return this.has(T)===!1||(this._length--,delete this._items[T],delete this._nums[T]),this},$e.prototype.has=function(T){return(typeof T=="string"||typeof T=="number")&&(this._items[T]!==void 0||this._nums[T]!==void 0)},$e.prototype.values=function(){var T=this,z=[];return Object.keys(this._items).forEach(function(q){z.push({k:q,v:T._items[q]})}),Object.keys(this._nums).forEach(function(q){z.push({k:JSON.parse(q),v:T._nums[q]})}),z.sort(function(q,me){return q.v-me.v}).map(function(q){return q.k})},$e.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};var ut=[D.FEATURE,D.MIDPOINT,D.VERTEX],ot={click:function(T,z,q){return vt(T,z,q,q.options.clickBuffer)},touch:function(T,z,q){return vt(T,z,q,q.options.touchBuffer)}};function vt(T,z,q,me){if(q.map===null)return[];var Te=T?at(T,me):z,Ee={};q.options.styles&&(Ee.layers=q.options.styles.map(function(jt){return jt.id}).filter(function(jt){return q.map.getLayer(jt)!=null}));var Fe=q.map.queryRenderedFeatures(Te,Ee).filter(function(jt){return ut.indexOf(jt.properties.meta)!==-1}),Tt=new $e,Mt=[];return Fe.forEach(function(jt){var Ut=jt.properties.id;Tt.has(Ut)||(Tt.add(Ut),Mt.push(jt))}),Ke(Mt)}function St(T,z){var q=ot.click(T,null,z),me={mouse:h.NONE};return q[0]&&(me.mouse=q[0].properties.active===L.ACTIVE?h.MOVE:h.POINTER,me.feature=q[0].properties.meta),z.events.currentModeName().indexOf("draw")!==-1&&(me.mouse=h.ADD),z.ui.queueMapClasses(me),z.ui.updateMapClasses(),q[0]}function ct(T,z){var q=T.x-z.x,me=T.y-z.y;return Math.sqrt(q*q+me*me)}function Et(T,z,q){q===void 0&&(q={});var me=q.fineTolerance!=null?q.fineTolerance:4,Te=q.grossTolerance!=null?q.grossTolerance:12,Ee=q.interval!=null?q.interval:500;T.point=T.point||z.point,T.time=T.time||z.time;var Fe=ct(T.point,z.point);return Fe<me||Fe<Te&&z.time-T.time<Ee}function Q(T,z,q){q===void 0&&(q={});var me=q.tolerance!=null?q.tolerance:25,Te=q.interval!=null?q.interval:250;return T.point=T.point||z.point,T.time=T.time||z.time,ct(T.point,z.point)<me&&z.time-T.time<Te}var de={exports:{}},_e=de.exports=function(T,z){if(z||(z=16),T===void 0&&(T=128),T<=0)return"0";for(var q=Math.log(Math.pow(2,T))/Math.log(z),me=2;q===1/0;me*=2)q=Math.log(Math.pow(2,T/me))/Math.log(z)*me;var Te=q-Math.floor(q),Ee="";for(me=0;me<Math.floor(q);me++)Ee=Math.floor(Math.random()*z).toString(z)+Ee;if(Te){var Fe=Math.pow(z,Te);Ee=Math.floor(Math.random()*Fe).toString(z)+Ee}var Tt=parseInt(Ee,z);return Tt!==1/0&&Tt>=Math.pow(2,T)?_e(T,z):Ee};_e.rack=function(T,z,q){var me=function(Ee){var Fe=0;do{if(Fe++>10){if(!q)throw new Error("too many ID collisions, use more bits");T+=q}var Tt=_e(T,z)}while(Object.hasOwnProperty.call(Te,Tt));return Te[Tt]=Ee,Tt},Te=me.hats={};return me.get=function(Ee){return me.hats[Ee]},me.set=function(Ee,Fe){return me.hats[Ee]=Fe,me},me.bits=T||128,me.base=z||16,me};var pe=Ae(de.exports),Re=function(T,z){this.ctx=T,this.properties=z.properties||{},this.coordinates=z.geometry.coordinates,this.id=z.id||pe(),this.type=z.geometry.type};Re.prototype.changed=function(){this.ctx.store.featureChanged(this.id)},Re.prototype.incomingCoords=function(T){this.setCoordinates(T)},Re.prototype.setCoordinates=function(T){this.coordinates=T,this.changed()},Re.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))},Re.prototype.setProperty=function(T,z){this.properties[T]=z},Re.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:_.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))},Re.prototype.internal=function(T){var z={id:this.id,meta:D.FEATURE,"meta:type":this.type,active:L.INACTIVE,mode:T};if(this.ctx.options.userProperties)for(var q in this.properties)z["user_"+q]=this.properties[q];return{type:_.FEATURE,properties:z,geometry:{coordinates:this.getCoordinates(),type:this.type}}};var fe=function(T,z){Re.call(this,T,z)};(fe.prototype=Object.create(Re.prototype)).isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"},fe.prototype.updateCoordinate=function(T,z,q){this.coordinates=arguments.length===3?[z,q]:[T,z],this.changed()},fe.prototype.getCoordinate=function(){return this.getCoordinates()};var ee=function(T,z){Re.call(this,T,z)};(ee.prototype=Object.create(Re.prototype)).isValid=function(){return this.coordinates.length>1},ee.prototype.addCoordinate=function(T,z,q){this.changed();var me=parseInt(T,10);this.coordinates.splice(me,0,[z,q])},ee.prototype.getCoordinate=function(T){var z=parseInt(T,10);return JSON.parse(JSON.stringify(this.coordinates[z]))},ee.prototype.removeCoordinate=function(T){this.changed(),this.coordinates.splice(parseInt(T,10),1)},ee.prototype.updateCoordinate=function(T,z,q){var me=parseInt(T,10);this.coordinates[me]=[z,q],this.changed()};var Ce=function(T,z){Re.call(this,T,z),this.coordinates=this.coordinates.map(function(q){return q.slice(0,-1)})};(Ce.prototype=Object.create(Re.prototype)).isValid=function(){return this.coordinates.length!==0&&this.coordinates.every(function(T){return T.length>2})},Ce.prototype.incomingCoords=function(T){this.coordinates=T.map(function(z){return z.slice(0,-1)}),this.changed()},Ce.prototype.setCoordinates=function(T){this.coordinates=T,this.changed()},Ce.prototype.addCoordinate=function(T,z,q){this.changed();var me=T.split(".").map(function(Te){return parseInt(Te,10)});this.coordinates[me[0]].splice(me[1],0,[z,q])},Ce.prototype.removeCoordinate=function(T){this.changed();var z=T.split(".").map(function(me){return parseInt(me,10)}),q=this.coordinates[z[0]];q&&(q.splice(z[1],1),q.length<3&&this.coordinates.splice(z[0],1))},Ce.prototype.getCoordinate=function(T){var z=T.split(".").map(function(me){return parseInt(me,10)}),q=this.coordinates[z[0]];return JSON.parse(JSON.stringify(q[z[1]]))},Ce.prototype.getCoordinates=function(){return this.coordinates.map(function(T){return T.concat([T[0]])})},Ce.prototype.updateCoordinate=function(T,z,q){this.changed();var me=T.split("."),Te=parseInt(me[0],10),Ee=parseInt(me[1],10);this.coordinates[Te]===void 0&&(this.coordinates[Te]=[]),this.coordinates[Te][Ee]=[z,q]};var Le={MultiPoint:fe,MultiLineString:ee,MultiPolygon:Ce},Je=function(T,z,q,me,Te){var Ee=q.split("."),Fe=parseInt(Ee[0],10),Tt=Ee[1]?Ee.slice(1).join("."):null;return T[Fe][z](Tt,me,Te)},Ue=function(T,z){if(Re.call(this,T,z),delete this.coordinates,this.model=Le[z.geometry.type],this.model===void 0)throw new TypeError(z.geometry.type+" is not a valid type");this.features=this._coordinatesToFeatures(z.geometry.coordinates)};function Ge(T){this.map=T.map,this.drawConfig=JSON.parse(JSON.stringify(T.options||{})),this._ctx=T}(Ue.prototype=Object.create(Re.prototype))._coordinatesToFeatures=function(T){var z=this,q=this.model.bind(this);return T.map(function(me){return new q(z.ctx,{id:pe(),type:_.FEATURE,properties:{},geometry:{coordinates:me,type:z.type.replace("Multi","")}})})},Ue.prototype.isValid=function(){return this.features.every(function(T){return T.isValid()})},Ue.prototype.setCoordinates=function(T){this.features=this._coordinatesToFeatures(T),this.changed()},Ue.prototype.getCoordinate=function(T){return Je(this.features,"getCoordinate",T)},Ue.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(function(T){return T.type===_.POLYGON?T.getCoordinates():T.coordinates})))},Ue.prototype.updateCoordinate=function(T,z,q){Je(this.features,"updateCoordinate",T,z,q),this.changed()},Ue.prototype.addCoordinate=function(T,z,q){Je(this.features,"addCoordinate",T,z,q),this.changed()},Ue.prototype.removeCoordinate=function(T){Je(this.features,"removeCoordinate",T),this.changed()},Ue.prototype.getFeatures=function(){return this.features},Ge.prototype.setSelected=function(T){return this._ctx.store.setSelected(T)},Ge.prototype.setSelectedCoordinates=function(T){var z=this;this._ctx.store.setSelectedCoordinates(T),T.reduce(function(q,me){return q[me.feature_id]===void 0&&(q[me.feature_id]=!0,z._ctx.store.get(me.feature_id).changed()),q},{})},Ge.prototype.getSelected=function(){return this._ctx.store.getSelected()},Ge.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()},Ge.prototype.isSelected=function(T){return this._ctx.store.isSelected(T)},Ge.prototype.getFeature=function(T){return this._ctx.store.get(T)},Ge.prototype.select=function(T){return this._ctx.store.select(T)},Ge.prototype.deselect=function(T){return this._ctx.store.deselect(T)},Ge.prototype.deleteFeature=function(T,z){return z===void 0&&(z={}),this._ctx.store.delete(T,z)},Ge.prototype.addFeature=function(T){return this._ctx.store.add(T)},Ge.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()},Ge.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()},Ge.prototype.setActionableState=function(T){T===void 0&&(T={});var z={trash:T.trash||!1,combineFeatures:T.combineFeatures||!1,uncombineFeatures:T.uncombineFeatures||!1};return this._ctx.events.actionable(z)},Ge.prototype.changeMode=function(T,z,q){return z===void 0&&(z={}),q===void 0&&(q={}),this._ctx.events.changeMode(T,z,q)},Ge.prototype.updateUIClasses=function(T){return this._ctx.ui.queueMapClasses(T)},Ge.prototype.activateUIButton=function(T){return this._ctx.ui.setActiveButton(T)},Ge.prototype.featuresAt=function(T,z,q){if(q===void 0&&(q="click"),q!=="click"&&q!=="touch")throw new Error("invalid buffer type");return ot[q](T,z,this._ctx)},Ge.prototype.newFeature=function(T){var z=T.geometry.type;return z===_.POINT?new fe(this._ctx,T):z===_.LINE_STRING?new ee(this._ctx,T):z===_.POLYGON?new Ce(this._ctx,T):new Ue(this._ctx,T)},Ge.prototype.isInstanceOf=function(T,z){if(T===_.POINT)return z instanceof fe;if(T===_.LINE_STRING)return z instanceof ee;if(T===_.POLYGON)return z instanceof Ce;if(T==="MultiFeature")return z instanceof Ue;throw new Error("Unknown feature class: "+T)},Ge.prototype.doRender=function(T){return this._ctx.store.featureChanged(T)},Ge.prototype.onSetup=function(){},Ge.prototype.onDrag=function(){},Ge.prototype.onClick=function(){},Ge.prototype.onMouseMove=function(){},Ge.prototype.onMouseDown=function(){},Ge.prototype.onMouseUp=function(){},Ge.prototype.onMouseOut=function(){},Ge.prototype.onKeyUp=function(){},Ge.prototype.onKeyDown=function(){},Ge.prototype.onTouchStart=function(){},Ge.prototype.onTouchMove=function(){},Ge.prototype.onTouchEnd=function(){},Ge.prototype.onTap=function(){},Ge.prototype.onStop=function(){},Ge.prototype.onTrash=function(){},Ge.prototype.onCombineFeature=function(){},Ge.prototype.onUncombineFeature=function(){},Ge.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};var dt={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},At=Object.keys(dt);function Ye(T){var z=Object.keys(T);return function(q,me){me===void 0&&(me={});var Te={},Ee=z.reduce(function(Fe,Tt){return Fe[Tt]=T[Tt],Fe},new Ge(q));return{start:function(){var Fe=this;Te=Ee.onSetup(me),At.forEach(function(Tt){var Mt,jt=dt[Tt],Ut=function(){return!1};T[jt]&&(Ut=function(){return!0}),Fe.on(Tt,Ut,(Mt=jt,function(Dt){return Ee[Mt](Te,Dt)}))})},stop:function(){Ee.onStop(Te)},trash:function(){Ee.onTrash(Te)},combineFeatures:function(){Ee.onCombineFeatures(Te)},uncombineFeatures:function(){Ee.onUncombineFeatures(Te)},render:function(Fe,Tt){Ee.toDisplayFeatures(Te,Fe,Tt)}}}}function Oe(T){return[].concat(T).filter(function(z){return z!==void 0})}function Qe(){var T=this;if(!(T.ctx.map&&T.ctx.map.getSource(c.HOT)!==void 0))return Mt();var z=T.ctx.events.currentModeName();T.ctx.ui.queueMapClasses({mode:z});var q=[],me=[];T.isDirty?me=T.getAllIds():(q=T.getChangedIds().filter(function(jt){return T.get(jt)!==void 0}),me=T.sources.hot.filter(function(jt){return jt.properties.id&&q.indexOf(jt.properties.id)===-1&&T.get(jt.properties.id)!==void 0}).map(function(jt){return jt.properties.id})),T.sources.hot=[];var Te=T.sources.cold.length;T.sources.cold=T.isDirty?[]:T.sources.cold.filter(function(jt){var Ut=jt.properties.id||jt.properties.parent;return q.indexOf(Ut)===-1});var Ee=Te!==T.sources.cold.length||me.length>0;function Fe(jt,Ut){var Dt=T.get(jt).internal(z);T.ctx.events.currentModeRender(Dt,function(yi){T.sources[Ut].push(yi)})}if(q.forEach(function(jt){return Fe(jt,"hot")}),me.forEach(function(jt){return Fe(jt,"cold")}),Ee&&T.ctx.map.getSource(c.COLD).setData({type:_.FEATURE_COLLECTION,features:T.sources.cold}),T.ctx.map.getSource(c.HOT).setData({type:_.FEATURE_COLLECTION,features:T.sources.hot}),T._emitSelectionChange&&(T.ctx.map.fire(C.SELECTION_CHANGE,{features:T.getSelected().map(function(jt){return jt.toGeoJSON()}),points:T.getSelectedCoordinates().map(function(jt){return{type:_.FEATURE,properties:{},geometry:{type:_.POINT,coordinates:jt.coordinates}}})}),T._emitSelectionChange=!1),T._deletedFeaturesToEmit.length){var Tt=T._deletedFeaturesToEmit.map(function(jt){return jt.toGeoJSON()});T._deletedFeaturesToEmit=[],T.ctx.map.fire(C.DELETE,{features:Tt})}function Mt(){T.isDirty=!1,T.clearChangedIds()}Mt(),T.ctx.map.fire(C.RENDER,{})}function Xe(T){var z,q=this;this._features={},this._featureIds=new $e,this._selectedFeatureIds=new $e,this._selectedCoordinates=[],this._changedFeatureIds=new $e,this._deletedFeaturesToEmit=[],this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=T,this.sources={hot:[],cold:[]},this.render=function(){z||(z=requestAnimationFrame(function(){z=null,Qe.call(q)}))},this.isDirty=!1}function le(T,z){var q=T._selectedCoordinates.filter(function(me){return T._selectedFeatureIds.has(me.feature_id)});T._selectedCoordinates.length===q.length||z.silent||(T._emitSelectionChange=!0),T._selectedCoordinates=q}Xe.prototype.createRenderBatch=function(){var T=this,z=this.render,q=0;return this.render=function(){q++},function(){T.render=z,q>0&&T.render()}},Xe.prototype.setDirty=function(){return this.isDirty=!0,this},Xe.prototype.featureChanged=function(T){return this._changedFeatureIds.add(T),this},Xe.prototype.getChangedIds=function(){return this._changedFeatureIds.values()},Xe.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this},Xe.prototype.getAllIds=function(){return this._featureIds.values()},Xe.prototype.add=function(T){return this.featureChanged(T.id),this._features[T.id]=T,this._featureIds.add(T.id),this},Xe.prototype.delete=function(T,z){var q=this;return z===void 0&&(z={}),Oe(T).forEach(function(me){q._featureIds.has(me)&&(q._featureIds.delete(me),q._selectedFeatureIds.delete(me),z.silent||q._deletedFeaturesToEmit.indexOf(q._features[me])===-1&&q._deletedFeaturesToEmit.push(q._features[me]),delete q._features[me],q.isDirty=!0)}),le(this,z),this},Xe.prototype.get=function(T){return this._features[T]},Xe.prototype.getAll=function(){var T=this;return Object.keys(this._features).map(function(z){return T._features[z]})},Xe.prototype.select=function(T,z){var q=this;return z===void 0&&(z={}),Oe(T).forEach(function(me){q._selectedFeatureIds.has(me)||(q._selectedFeatureIds.add(me),q._changedFeatureIds.add(me),z.silent||(q._emitSelectionChange=!0))}),this},Xe.prototype.deselect=function(T,z){var q=this;return z===void 0&&(z={}),Oe(T).forEach(function(me){q._selectedFeatureIds.has(me)&&(q._selectedFeatureIds.delete(me),q._changedFeatureIds.add(me),z.silent||(q._emitSelectionChange=!0))}),le(this,z),this},Xe.prototype.clearSelected=function(T){return T===void 0&&(T={}),this.deselect(this._selectedFeatureIds.values(),{silent:T.silent}),this},Xe.prototype.setSelected=function(T,z){var q=this;return z===void 0&&(z={}),T=Oe(T),this.deselect(this._selectedFeatureIds.values().filter(function(me){return T.indexOf(me)===-1}),{silent:z.silent}),this.select(T.filter(function(me){return!q._selectedFeatureIds.has(me)}),{silent:z.silent}),this},Xe.prototype.setSelectedCoordinates=function(T){return this._selectedCoordinates=T,this._emitSelectionChange=!0,this},Xe.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this},Xe.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()},Xe.prototype.getSelected=function(){var T=this;return this._selectedFeatureIds.values().map(function(z){return T.get(z)})},Xe.prototype.getSelectedCoordinates=function(){var T=this;return this._selectedCoordinates.map(function(z){return{coordinates:T.get(z.feature_id).getCoordinate(z.coord_path)}})},Xe.prototype.isSelected=function(T){return this._selectedFeatureIds.has(T)},Xe.prototype.setFeatureProperty=function(T,z,q){this.get(T).setProperty(z,q),this.featureChanged(T)},Xe.prototype.storeMapConfig=function(){var T=this;U.forEach(function(z){T.ctx.map[z]&&(T._mapInitialConfig[z]=T.ctx.map[z].isEnabled())})},Xe.prototype.restoreMapConfig=function(){var T=this;Object.keys(this._mapInitialConfig).forEach(function(z){T._mapInitialConfig[z]?T.ctx.map[z].enable():T.ctx.map[z].disable()})},Xe.prototype.getInitialConfigValue=function(T){return this._mapInitialConfig[T]===void 0||this._mapInitialConfig[T]};var it=function(){for(var T=arguments,z={},q=0;q<arguments.length;q++){var me=T[q];for(var Te in me)bt.call(me,Te)&&(z[Te]=me[Te])}return z},bt=Object.prototype.hasOwnProperty,Pt=Ae(it),Ot=["mode","feature","mouse"];function nt(T){var z=null,q=null,me={onRemove:function(){return T.map.off("load",me.connect),clearInterval(q),me.removeLayers(),T.store.restoreMapConfig(),T.ui.removeButtons(),T.events.removeEventListeners(),T.ui.clearMapClasses(),T.boxZoomInitial&&T.map.boxZoom.enable(),T.map=null,T.container=null,T.store=null,z&&z.parentNode&&z.parentNode.removeChild(z),z=null,this},connect:function(){T.map.off("load",me.connect),clearInterval(q),me.addLayers(),T.store.storeMapConfig(),T.events.addEventListeners()},onAdd:function(Te){var Ee=Te.fire;return Te.fire=function(Fe,Tt){var Mt=arguments;return Ee.length===1&&arguments.length!==1&&(Mt=[Pt({},{type:Fe},Tt)]),Ee.apply(Te,Mt)},T.map=Te,T.events=function(Fe){var Tt=Object.keys(Fe.options.modes).reduce(function(ft,Qt){return ft[Qt]=Ye(Fe.options.modes[Qt]),ft},{}),Mt={},jt={},Ut={},Dt=null,yi=null;Ut.drag=function(ft,Qt){Qt({point:ft.point,time:new Date().getTime()})?(Fe.ui.queueMapClasses({mouse:h.DRAG}),yi.drag(ft)):ft.originalEvent.stopPropagation()},Ut.mousedrag=function(ft){Ut.drag(ft,function(Qt){return!Et(Mt,Qt)})},Ut.touchdrag=function(ft){Ut.drag(ft,function(Qt){return!Q(jt,Qt)})},Ut.mousemove=function(ft){if((ft.originalEvent.buttons!==void 0?ft.originalEvent.buttons:ft.originalEvent.which)===1)return Ut.mousedrag(ft);var Qt=St(ft,Fe);ft.featureTarget=Qt,yi.mousemove(ft)},Ut.mousedown=function(ft){Mt={time:new Date().getTime(),point:ft.point};var Qt=St(ft,Fe);ft.featureTarget=Qt,yi.mousedown(ft)},Ut.mouseup=function(ft){var Qt=St(ft,Fe);ft.featureTarget=Qt,Et(Mt,{point:ft.point,time:new Date().getTime()})?yi.click(ft):yi.mouseup(ft)},Ut.mouseout=function(ft){yi.mouseout(ft)},Ut.touchstart=function(ft){if(Fe.options.touchEnabled){jt={time:new Date().getTime(),point:ft.point};var Qt=ot.touch(ft,null,Fe)[0];ft.featureTarget=Qt,yi.touchstart(ft)}},Ut.touchmove=function(ft){if(Fe.options.touchEnabled)return yi.touchmove(ft),Ut.touchdrag(ft)},Ut.touchend=function(ft){if(ft.originalEvent.preventDefault(),Fe.options.touchEnabled){var Qt=ot.touch(ft,null,Fe)[0];ft.featureTarget=Qt,Q(jt,{time:new Date().getTime(),point:ft.point})?yi.tap(ft):yi.touchend(ft)}};var nr=function(ft){return!(ft===8||ft===46||ft>=48&&ft<=57)};function wi(ft,Qt,Ei){Ei===void 0&&(Ei={}),yi.stop();var _r=Tt[ft];if(_r===void 0)throw new Error(ft+" is not valid");Dt=ft;var sr=_r(Fe,Qt);yi=xe(sr,Fe),Ei.silent||Fe.map.fire(C.MODE_CHANGE,{mode:ft}),Fe.store.setDirty(),Fe.store.render()}Ut.keydown=function(ft){(ft.srcElement||ft.target).classList.contains("mapboxgl-canvas")&&(ft.keyCode!==8&&ft.keyCode!==46||!Fe.options.controls.trash?nr(ft.keyCode)?yi.keydown(ft):ft.keyCode===49&&Fe.options.controls.point?wi(u.DRAW_POINT):ft.keyCode===50&&Fe.options.controls.line_string?wi(u.DRAW_LINE_STRING):ft.keyCode===51&&Fe.options.controls.polygon&&wi(u.DRAW_POLYGON):(ft.preventDefault(),yi.trash()))},Ut.keyup=function(ft){nr(ft.keyCode)&&yi.keyup(ft)},Ut.zoomend=function(){Fe.store.changeZoom()},Ut.data=function(ft){if(ft.dataType==="style"){var Qt=Fe.setup,Ei=Fe.map,_r=Fe.options,sr=Fe.store;_r.styles.some(function(Ts){return Ei.getLayer(Ts.id)})||(Qt.addLayers(),sr.setDirty(),sr.render())}};var ur={trash:!1,combineFeatures:!1,uncombineFeatures:!1};return{start:function(){Dt=Fe.options.defaultMode,yi=xe(Tt[Dt](Fe),Fe)},changeMode:wi,actionable:function(ft){var Qt=!1;Object.keys(ft).forEach(function(Ei){if(ur[Ei]===void 0)throw new Error("Invalid action type");ur[Ei]!==ft[Ei]&&(Qt=!0),ur[Ei]=ft[Ei]}),Qt&&Fe.map.fire(C.ACTIONABLE,{actions:ur})},currentModeName:function(){return Dt},currentModeRender:function(ft,Qt){return yi.render(ft,Qt)},fire:function(ft,Qt){Ut[ft]&&Ut[ft](Qt)},addEventListeners:function(){Fe.map.on("mousemove",Ut.mousemove),Fe.map.on("mousedown",Ut.mousedown),Fe.map.on("mouseup",Ut.mouseup),Fe.map.on("data",Ut.data),Fe.map.on("touchmove",Ut.touchmove),Fe.map.on("touchstart",Ut.touchstart),Fe.map.on("touchend",Ut.touchend),Fe.container.addEventListener("mouseout",Ut.mouseout),Fe.options.keybindings&&(Fe.container.addEventListener("keydown",Ut.keydown),Fe.container.addEventListener("keyup",Ut.keyup))},removeEventListeners:function(){Fe.map.off("mousemove",Ut.mousemove),Fe.map.off("mousedown",Ut.mousedown),Fe.map.off("mouseup",Ut.mouseup),Fe.map.off("data",Ut.data),Fe.map.off("touchmove",Ut.touchmove),Fe.map.off("touchstart",Ut.touchstart),Fe.map.off("touchend",Ut.touchend),Fe.container.removeEventListener("mouseout",Ut.mouseout),Fe.options.keybindings&&(Fe.container.removeEventListener("keydown",Ut.keydown),Fe.container.removeEventListener("keyup",Ut.keyup))},trash:function(ft){yi.trash(ft)},combineFeatures:function(){yi.combineFeatures()},uncombineFeatures:function(){yi.uncombineFeatures()},getMode:function(){return Dt}}}(T),T.ui=function(Fe){var Tt={},Mt=null,jt={mode:null,feature:null,mouse:null},Ut={mode:null,feature:null,mouse:null};function Dt(ft){Ut=Pt(Ut,ft)}function yi(){var ft,Qt;if(Fe.container){var Ei=[],_r=[];Ot.forEach(function(sr){Ut[sr]!==jt[sr]&&(Ei.push(sr+"-"+jt[sr]),Ut[sr]!==null&&_r.push(sr+"-"+Ut[sr]))}),Ei.length>0&&(ft=Fe.container.classList).remove.apply(ft,Ei),_r.length>0&&(Qt=Fe.container.classList).add.apply(Qt,_r),jt=Pt(jt,Ut)}}function nr(ft,Qt){Qt===void 0&&(Qt={});var Ei=document.createElement("button");return Ei.className=o.CONTROL_BUTTON+" "+Qt.className,Ei.setAttribute("title",Qt.title),Qt.container.appendChild(Ei),Ei.addEventListener("click",function(_r){if(_r.preventDefault(),_r.stopPropagation(),_r.target===Mt)return wi(),void Qt.onDeactivate();ur(ft),Qt.onActivate()},!0),Ei}function wi(){Mt&&(Mt.classList.remove(o.ACTIVE_BUTTON),Mt=null)}function ur(ft){wi();var Qt=Tt[ft];Qt&&Qt&&ft!=="trash"&&(Qt.classList.add(o.ACTIVE_BUTTON),Mt=Qt)}return{setActiveButton:ur,queueMapClasses:Dt,updateMapClasses:yi,clearMapClasses:function(){Dt({mode:null,feature:null,mouse:null}),yi()},addButtons:function(){var ft=Fe.options.controls,Qt=document.createElement("div");return Qt.className=o.CONTROL_GROUP+" "+o.CONTROL_BASE,ft&&(ft[p.LINE]&&(Tt[p.LINE]=nr(p.LINE,{container:Qt,className:o.CONTROL_BUTTON_LINE,title:"LineString tool "+(Fe.options.keybindings?"(l)":""),onActivate:function(){return Fe.events.changeMode(u.DRAW_LINE_STRING)},onDeactivate:function(){return Fe.events.trash()}})),ft[p.POLYGON]&&(Tt[p.POLYGON]=nr(p.POLYGON,{container:Qt,className:o.CONTROL_BUTTON_POLYGON,title:"Polygon tool "+(Fe.options.keybindings?"(p)":""),onActivate:function(){return Fe.events.changeMode(u.DRAW_POLYGON)},onDeactivate:function(){return Fe.events.trash()}})),ft[p.POINT]&&(Tt[p.POINT]=nr(p.POINT,{container:Qt,className:o.CONTROL_BUTTON_POINT,title:"Marker tool "+(Fe.options.keybindings?"(m)":""),onActivate:function(){return Fe.events.changeMode(u.DRAW_POINT)},onDeactivate:function(){return Fe.events.trash()}})),ft.trash&&(Tt.trash=nr("trash",{container:Qt,className:o.CONTROL_BUTTON_TRASH,title:"Delete",onActivate:function(){Fe.events.trash()}})),ft.combine_features&&(Tt.combine_features=nr("combineFeatures",{container:Qt,className:o.CONTROL_BUTTON_COMBINE_FEATURES,title:"Combine",onActivate:function(){Fe.events.combineFeatures()}})),ft.uncombine_features&&(Tt.uncombine_features=nr("uncombineFeatures",{container:Qt,className:o.CONTROL_BUTTON_UNCOMBINE_FEATURES,title:"Uncombine",onActivate:function(){Fe.events.uncombineFeatures()}}))),Qt},removeButtons:function(){Object.keys(Tt).forEach(function(ft){var Qt=Tt[ft];Qt.parentNode&&Qt.parentNode.removeChild(Qt),delete Tt[ft]})}}}(T),T.container=Te.getContainer(),T.store=new Xe(T),z=T.ui.addButtons(),T.options.boxSelect&&(T.boxZoomInitial=Te.boxZoom.isEnabled(),Te.boxZoom.disable(),Te.dragPan.disable(),Te.dragPan.enable()),Te.loaded()?me.connect():(Te.on("load",me.connect),q=setInterval(function(){Te.loaded()&&me.connect()},16)),T.events.start(),z},addLayers:function(){T.map.addSource(c.COLD,{data:{type:_.FEATURE_COLLECTION,features:[]},type:"geojson"}),T.map.addSource(c.HOT,{data:{type:_.FEATURE_COLLECTION,features:[]},type:"geojson"}),T.options.styles.forEach(function(Te){T.map.addLayer(Te)}),T.store.setDirty(!0),T.store.render()},removeLayers:function(){T.options.styles.forEach(function(Te){T.map.getLayer(Te.id)&&T.map.removeLayer(Te.id)}),T.map.getSource(c.COLD)&&T.map.removeSource(c.COLD),T.map.getSource(c.HOT)&&T.map.removeSource(c.HOT)}};return T.setup=me,me}var qt=[{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":"#3bb2d0","fill-outline-color":"#3bb2d0","fill-opacity":.1}},{id:"gl-draw-polygon-fill-active",type:"fill",filter:["all",["==","active","true"],["==","$type","Polygon"]],paint:{"fill-color":"#fbb03b","fill-outline-color":"#fbb03b","fill-opacity":.1}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","active","true"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-line-active",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-stroke-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-color":"#fff"}},{id:"gl-draw-polygon-and-line-vertex-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-point-point-stroke-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-opacity":1,"circle-color":"#fff"}},{id:"gl-draw-point-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#3bb2d0"}},{id:"gl-draw-point-stroke-active",type:"circle",filter:["all",["==","$type","Point"],["==","active","true"],["!=","meta","midpoint"]],paint:{"circle-radius":7,"circle-color":"#fff"}},{id:"gl-draw-point-active",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","true"]],paint:{"circle-radius":5,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-fill-static",type:"fill",filter:["all",["==","mode","static"],["==","$type","Polygon"]],paint:{"fill-color":"#404040","fill-outline-color":"#404040","fill-opacity":.1}},{id:"gl-draw-polygon-stroke-static",type:"line",filter:["all",["==","mode","static"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-line-static",type:"line",filter:["all",["==","mode","static"],["==","$type","LineString"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-point-static",type:"circle",filter:["all",["==","mode","static"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"#404040"}}];function Yt(T){return function(z){var q=z.featureTarget;return!!q&&!!q.properties&&q.properties.meta===T}}function gi(T){return!!T.originalEvent&&!!T.originalEvent.shiftKey&&T.originalEvent.button===0}function xi(T){return!!T.featureTarget&&!!T.featureTarget.properties&&T.featureTarget.properties.active===L.ACTIVE&&T.featureTarget.properties.meta===D.FEATURE}function fi(T){return!!T.featureTarget&&!!T.featureTarget.properties&&T.featureTarget.properties.active===L.INACTIVE&&T.featureTarget.properties.meta===D.FEATURE}function Gi(T){return T.featureTarget===void 0}function ht(T){return!!T.featureTarget&&!!T.featureTarget.properties&&T.featureTarget.properties.meta===D.FEATURE}function Hi(T){var z=T.featureTarget;return!!z&&!!z.properties&&z.properties.meta===D.VERTEX}function Zt(T){return!!T.originalEvent&&T.originalEvent.shiftKey===!0}function bi(T){return T.keyCode===27}function cr(T){return T.keyCode===13}var xt=Object.freeze({__proto__:null,isOfMetaType:Yt,isShiftMousedown:gi,isActiveFeature:xi,isInactiveFeature:fi,noTarget:Gi,isFeature:ht,isVertex:Hi,isShiftDown:Zt,isEscapeKey:bi,isEnterKey:cr,isTrue:function(){return!0}}),li=Kt;function Kt(T,z){this.x=T,this.y=z}Kt.prototype={clone:function(){return new Kt(this.x,this.y)},add:function(T){return this.clone()._add(T)},sub:function(T){return this.clone()._sub(T)},multByPoint:function(T){return this.clone()._multByPoint(T)},divByPoint:function(T){return this.clone()._divByPoint(T)},mult:function(T){return this.clone()._mult(T)},div:function(T){return this.clone()._div(T)},rotate:function(T){return this.clone()._rotate(T)},rotateAround:function(T,z){return this.clone()._rotateAround(T,z)},matMult:function(T){return this.clone()._matMult(T)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(T){return this.x===T.x&&this.y===T.y},dist:function(T){return Math.sqrt(this.distSqr(T))},distSqr:function(T){var z=T.x-this.x,q=T.y-this.y;return z*z+q*q},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(T){return Math.atan2(this.y-T.y,this.x-T.x)},angleWith:function(T){return this.angleWithSep(T.x,T.y)},angleWithSep:function(T,z){return Math.atan2(this.x*z-this.y*T,this.x*T+this.y*z)},_matMult:function(T){var z=T[0]*this.x+T[1]*this.y,q=T[2]*this.x+T[3]*this.y;return this.x=z,this.y=q,this},_add:function(T){return this.x+=T.x,this.y+=T.y,this},_sub:function(T){return this.x-=T.x,this.y-=T.y,this},_mult:function(T){return this.x*=T,this.y*=T,this},_div:function(T){return this.x/=T,this.y/=T,this},_multByPoint:function(T){return this.x*=T.x,this.y*=T.y,this},_divByPoint:function(T){return this.x/=T.x,this.y/=T.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var T=this.y;return this.y=this.x,this.x=-T,this},_rotate:function(T){var z=Math.cos(T),q=Math.sin(T),me=z*this.x-q*this.y,Te=q*this.x+z*this.y;return this.x=me,this.y=Te,this},_rotateAround:function(T,z){var q=Math.cos(T),me=Math.sin(T),Te=z.x+q*(this.x-z.x)-me*(this.y-z.y),Ee=z.y+me*(this.x-z.x)+q*(this.y-z.y);return this.x=Te,this.y=Ee,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Kt.convert=function(T){return T instanceof Kt?T:Array.isArray(T)?new Kt(T[0],T[1]):T};var Tr=Ae(li);function Lr(T,z){var q=z.getBoundingClientRect();return new Tr(T.clientX-q.left-(z.clientLeft||0),T.clientY-q.top-(z.clientTop||0))}function ui(T,z,q,me){return{type:_.FEATURE,properties:{meta:D.VERTEX,parent:T,coord_path:q,active:me?L.ACTIVE:L.INACTIVE},geometry:{type:_.POINT,coordinates:z}}}function wn(T,z,q){var me=z.geometry.coordinates,Te=q.geometry.coordinates;if(me[1]>85||me[1]<$||Te[1]>85||Te[1]<$)return null;var Ee={lng:(me[0]+Te[0])/2,lat:(me[1]+Te[1])/2};return{type:_.FEATURE,properties:{meta:D.MIDPOINT,parent:T,lng:Ee.lng,lat:Ee.lat,coord_path:q.properties.coord_path},geometry:{type:_.POINT,coordinates:[Ee.lng,Ee.lat]}}}function $r(T,z,q){z===void 0&&(z={}),q===void 0&&(q=null);var me,Te=T.geometry,Ee=Te.type,Fe=Te.coordinates,Tt=T.properties&&T.properties.id,Mt=[];function jt(Dt,yi){var nr="",wi=null;Dt.forEach(function(ur,ft){var Qt=yi!=null?yi+"."+ft:String(ft),Ei=ui(Tt,ur,Qt,Ut(Qt));if(z.midpoints&&wi){var _r=wn(Tt,wi,Ei);_r&&Mt.push(_r)}wi=Ei;var sr=JSON.stringify(ur);nr!==sr&&Mt.push(Ei),ft===0&&(nr=sr)})}function Ut(Dt){return!!z.selectedPaths&&z.selectedPaths.indexOf(Dt)!==-1}return Ee===_.POINT?Mt.push(ui(Tt,Fe,q,Ut(q))):Ee===_.POLYGON?Fe.forEach(function(Dt,yi){jt(Dt,q!==null?q+"."+yi:String(yi))}):Ee===_.LINE_STRING?jt(Fe,q):Ee.indexOf(_.MULTI_PREFIX)===0&&(me=Ee.replace(_.MULTI_PREFIX,""),Fe.forEach(function(Dt,yi){var nr={type:_.FEATURE,properties:T.properties,geometry:{type:me,coordinates:Dt}};Mt=Mt.concat($r(nr,z,yi))})),Mt}var se={enable:function(T){setTimeout(function(){T.map&&T.map.doubleClickZoom&&T._ctx&&T._ctx.store&&T._ctx.store.getInitialConfigValue&&T._ctx.store.getInitialConfigValue("doubleClickZoom")&&T.map.doubleClickZoom.enable()},0)},disable:function(T){setTimeout(function(){T.map&&T.map.doubleClickZoom&&T.map.doubleClickZoom.disable()},0)}},W={exports:{}},X=function(T){if(!T||!T.type)return null;var z=J[T.type];if(!z)return null;if(z==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:T}]};if(z==="feature")return{type:"FeatureCollection",features:[T]};if(z==="featurecollection")return T},J={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"},ae=Ae(X),Ie=Object.freeze({__proto__:null,default:function T(z){switch(z&&z.type||null){case"FeatureCollection":return z.features=z.features.reduce(function(q,me){return q.concat(T(me))},[]),z;case"Feature":return z.geometry?T(z.geometry).map(function(q){var me={type:"Feature",properties:JSON.parse(JSON.stringify(z.properties)),geometry:q};return z.id!==void 0&&(me.id=z.id),me}):[z];case"MultiPoint":return z.coordinates.map(function(q){return{type:"Point",coordinates:q}});case"MultiPolygon":return z.coordinates.map(function(q){return{type:"Polygon",coordinates:q}});case"MultiLineString":return z.coordinates.map(function(q){return{type:"LineString",coordinates:q}});case"GeometryCollection":return z.geometries.map(T).reduce(function(q,me){return q.concat(me)},[]);case"Point":case"Polygon":case"LineString":return[z]}}}),Pe=X,De=Ne(Ie),be=function(T){return function z(q){return Array.isArray(q)&&q.length&&typeof q[0]=="number"?[q]:q.reduce(function(me,Te){return Array.isArray(Te)&&Array.isArray(Te[0])?me.concat(z(Te)):(me.push(Te),me)},[])}(T)};De instanceof Function||(De=De.default);var je={exports:{}},gt=je.exports=function(T){return new et(T)};function et(T){this.value=T}function lt(T,z,q){var me=[],Te=[],Ee=!0;return function Fe(Tt){var Mt=q?Jt(Tt):Tt,jt={},Ut=!0,Dt={node:Mt,node_:Tt,path:[].concat(me),parent:Te[Te.length-1],parents:Te,key:me.slice(-1)[0],isRoot:me.length===0,level:me.length,circular:null,update:function(wi,ur){Dt.isRoot||(Dt.parent.node[Dt.key]=wi),Dt.node=wi,ur&&(Ut=!1)},delete:function(wi){delete Dt.parent.node[Dt.key],wi&&(Ut=!1)},remove:function(wi){Mi(Dt.parent.node)?Dt.parent.node.splice(Dt.key,1):delete Dt.parent.node[Dt.key],wi&&(Ut=!1)},keys:null,before:function(wi){jt.before=wi},after:function(wi){jt.after=wi},pre:function(wi){jt.pre=wi},post:function(wi){jt.post=wi},stop:function(){Ee=!1},block:function(){Ut=!1}};if(!Ee)return Dt;function yi(){if(typeof Dt.node=="object"&&Dt.node!==null){Dt.keys&&Dt.node_===Dt.node||(Dt.keys=ci(Dt.node)),Dt.isLeaf=Dt.keys.length==0;for(var wi=0;wi<Te.length;wi++)if(Te[wi].node_===Tt){Dt.circular=Te[wi];break}}else Dt.isLeaf=!0,Dt.keys=null;Dt.notLeaf=!Dt.isLeaf,Dt.notRoot=!Dt.isRoot}yi();var nr=z.call(Dt,Dt.node);return nr!==void 0&&Dt.update&&Dt.update(nr),jt.before&&jt.before.call(Dt,Dt.node),Ut&&(typeof Dt.node!="object"||Dt.node===null||Dt.circular||(Te.push(Dt),yi(),pi(Dt.keys,function(wi,ur){me.push(wi),jt.pre&&jt.pre.call(Dt,Dt.node[wi],wi);var ft=Fe(Dt.node[wi]);q&&Xi.call(Dt.node,wi)&&(Dt.node[wi]=ft.node),ft.isLast=ur==Dt.keys.length-1,ft.isFirst=ur==0,jt.post&&jt.post.call(Dt,ft),me.pop()}),Te.pop()),jt.after&&jt.after.call(Dt,Dt.node)),Dt}(T).node}function Jt(T){if(typeof T=="object"&&T!==null){var z;if(Mi(T))z=[];else if(si(T)==="[object Date]")z=new Date(T.getTime?T.getTime():T);else if(function(Te){return si(Te)==="[object RegExp]"}(T))z=new RegExp(T);else if(function(Te){return si(Te)==="[object Error]"}(T))z={message:T.message};else if(function(Te){return si(Te)==="[object Boolean]"}(T))z=new Boolean(T);else if(function(Te){return si(Te)==="[object Number]"}(T))z=new Number(T);else if(function(Te){return si(Te)==="[object String]"}(T))z=new String(T);else if(Object.create&&Object.getPrototypeOf)z=Object.create(Object.getPrototypeOf(T));else if(T.constructor===Object)z={};else{var q=T.constructor&&T.constructor.prototype||T.__proto__||{},me=function(){};me.prototype=q,z=new me}return pi(ci(T),function(Te){z[Te]=T[Te]}),z}return T}et.prototype.get=function(T){for(var z=this.value,q=0;q<T.length;q++){var me=T[q];if(!z||!Xi.call(z,me)){z=void 0;break}z=z[me]}return z},et.prototype.has=function(T){for(var z=this.value,q=0;q<T.length;q++){var me=T[q];if(!z||!Xi.call(z,me))return!1;z=z[me]}return!0},et.prototype.set=function(T,z){for(var q=this.value,me=0;me<T.length-1;me++){var Te=T[me];Xi.call(q,Te)||(q[Te]={}),q=q[Te]}return q[T[me]]=z,z},et.prototype.map=function(T){return lt(this.value,T,!0)},et.prototype.forEach=function(T){return this.value=lt(this.value,T,!1),this.value},et.prototype.reduce=function(T,z){var q=arguments.length===1,me=q?this.value:z;return this.forEach(function(Te){this.isRoot&&q||(me=T.call(this,me,Te))}),me},et.prototype.paths=function(){var T=[];return this.forEach(function(z){T.push(this.path)}),T},et.prototype.nodes=function(){var T=[];return this.forEach(function(z){T.push(this.node)}),T},et.prototype.clone=function(){var T=[],z=[];return function q(me){for(var Te=0;Te<T.length;Te++)if(T[Te]===me)return z[Te];if(typeof me=="object"&&me!==null){var Ee=Jt(me);return T.push(me),z.push(Ee),pi(ci(me),function(Fe){Ee[Fe]=q(me[Fe])}),T.pop(),z.pop(),Ee}return me}(this.value)};var ci=Object.keys||function(T){var z=[];for(var q in T)z.push(q);return z};function si(T){return Object.prototype.toString.call(T)}var Mi=Array.isArray||function(T){return Object.prototype.toString.call(T)==="[object Array]"},pi=function(T,z){if(T.forEach)return T.forEach(z);for(var q=0;q<T.length;q++)z(T[q],q,T)};pi(ci(et.prototype),function(T){gt[T]=function(z){var q=[].slice.call(arguments,1),me=new et(z);return me[T].apply(me,q)}});var Xi=Object.hasOwnProperty||function(T,z){return z in T},Zi=je.exports,xr=ai;function ai(T){if(!(this instanceof ai))return new ai(T);this._bbox=T||[1/0,1/0,-1/0,-1/0],this._valid=!!T}ai.prototype.include=function(T){return this._valid=!0,this._bbox[0]=Math.min(this._bbox[0],T[0]),this._bbox[1]=Math.min(this._bbox[1],T[1]),this._bbox[2]=Math.max(this._bbox[2],T[0]),this._bbox[3]=Math.max(this._bbox[3],T[1]),this},ai.prototype.equals=function(T){var z;return z=T instanceof ai?T.bbox():T,this._bbox[0]==z[0]&&this._bbox[1]==z[1]&&this._bbox[2]==z[2]&&this._bbox[3]==z[3]},ai.prototype.center=function(T){return this._valid?[(this._bbox[0]+this._bbox[2])/2,(this._bbox[1]+this._bbox[3])/2]:null},ai.prototype.union=function(T){var z;return this._valid=!0,z=T instanceof ai?T.bbox():T,this._bbox[0]=Math.min(this._bbox[0],z[0]),this._bbox[1]=Math.min(this._bbox[1],z[1]),this._bbox[2]=Math.max(this._bbox[2],z[2]),this._bbox[3]=Math.max(this._bbox[3],z[3]),this},ai.prototype.bbox=function(){return this._valid?this._bbox:null},ai.prototype.contains=function(T){if(!T)return this._fastContains();if(!this._valid)return null;var z=T[0],q=T[1];return this._bbox[0]<=z&&this._bbox[1]<=q&&this._bbox[2]>=z&&this._bbox[3]>=q},ai.prototype.intersect=function(T){return this._valid?(z=T instanceof ai?T.bbox():T,!(this._bbox[0]>z[2]||this._bbox[2]<z[0]||this._bbox[3]<z[1]||this._bbox[1]>z[3])):null;var z},ai.prototype._fastContains=function(){if(!this._valid)return new Function("return null;");var T="return "+this._bbox[0]+"<= ll[0] &&"+this._bbox[1]+"<= ll[1] &&"+this._bbox[2]+">= ll[0] &&"+this._bbox[3]+">= ll[1]";return new Function("ll",T)},ai.prototype.polygon=function(){return this._valid?{type:"Polygon",coordinates:[[[this._bbox[0],this._bbox[1]],[this._bbox[2],this._bbox[1]],[this._bbox[2],this._bbox[3]],[this._bbox[0],this._bbox[3]],[this._bbox[0],this._bbox[1]]]]}:null};var hr=function(T){if(!T)return[];var z=De(Pe(T)),q=[];return z.features.forEach(function(me){me.geometry&&(q=q.concat(be(me.geometry.coordinates)))}),q},Mr=Zi,nn=xr,Fr={features:["FeatureCollection"],coordinates:["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],geometry:["Feature"],geometries:["GeometryCollection"]},Yr=Object.keys(Fr);function Zr(T){for(var z=nn(),q=hr(T),me=0;me<q.length;me++)z.include(q[me]);return z}W.exports=function(T){return Zr(T).bbox()},W.exports.polygon=function(T){return Zr(T).polygon()},W.exports.bboxify=function(T){return Mr(T).map(function(z){z&&Yr.some(function(q){return!!z[q]&&Fr[q].indexOf(z.type)!==-1})&&(z.bbox=Zr(z).bbox(),this.update(z))})};var Do=Ae(W.exports),Ta=-90;function Ni(T,z){var q=Ta,me=90,Te=Ta,Ee=90,Fe=270,Tt=-270;T.forEach(function(jt){var Ut=Do(jt),Dt=Ut[1],yi=Ut[3],nr=Ut[0],wi=Ut[2];Dt>q&&(q=Dt),yi<me&&(me=yi),yi>Te&&(Te=yi),Dt<Ee&&(Ee=Dt),nr<Fe&&(Fe=nr),wi>Tt&&(Tt=wi)});var Mt=z;return q+Mt.lat>85&&(Mt.lat=85-q),Te+Mt.lat>90&&(Mt.lat=90-Te),me+Mt.lat<-85&&(Mt.lat=-85-me),Ee+Mt.lat<Ta&&(Mt.lat=Ta-Ee),Fe+Mt.lng<=-270&&(Mt.lng+=360*Math.ceil(Math.abs(Mt.lng)/360)),Tt+Mt.lng>=270&&(Mt.lng-=360*Math.ceil(Math.abs(Mt.lng)/360)),Mt}function sa(T,z){var q=Ni(T.map(function(me){return me.toGeoJSON()}),z);T.forEach(function(me){var Te,Ee=me.getCoordinates(),Fe=function(Mt){var jt={lng:Mt[0]+q.lng,lat:Mt[1]+q.lat};return[jt.lng,jt.lat]},Tt=function(Mt){return Mt.map(function(jt){return Fe(jt)})};me.type===_.POINT?Te=Fe(Ee):me.type===_.LINE_STRING||me.type===_.MULTI_POINT?Te=Ee.map(Fe):me.type===_.POLYGON||me.type===_.MULTI_LINE_STRING?Te=Ee.map(Tt):me.type===_.MULTI_POLYGON&&(Te=Ee.map(function(Mt){return Mt.map(function(jt){return Tt(jt)})})),me.incomingCoords(Te)})}var br={onSetup:function(T){var z=this,q={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initiallySelectedFeatureIds:T.featureIds||[]};return this.setSelected(q.initiallySelectedFeatureIds.filter(function(me){return z.getFeature(me)!==void 0})),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),q},fireUpdate:function(){this.map.fire(C.UPDATE,{action:S.MOVE,features:this.getSelected().map(function(T){return T.toGeoJSON()})})},fireActionable:function(){var T=this,z=this.getSelected(),q=z.filter(function(Tt){return T.isInstanceOf("MultiFeature",Tt)}),me=!1;if(z.length>1){me=!0;var Te=z[0].type.replace("Multi","");z.forEach(function(Tt){Tt.type.replace("Multi","")!==Te&&(me=!1)})}var Ee=q.length>0,Fe=z.length>0;this.setActionableState({combineFeatures:me,uncombineFeatures:Ee,trash:Fe})},getUniqueIds:function(T){return T.length?T.map(function(z){return z.properties.id}).filter(function(z){return z!==void 0}).reduce(function(z,q){return z.add(q),z},new $e).values():[]},stopExtendedInteractions:function(T){T.boxSelectElement&&(T.boxSelectElement.parentNode&&T.boxSelectElement.parentNode.removeChild(T.boxSelectElement),T.boxSelectElement=null),this.map.dragPan.enable(),T.boxSelecting=!1,T.canBoxSelect=!1,T.dragMoving=!1,T.canDragMove=!1},onStop:function(){se.enable(this)},onMouseMove:function(T,z){return ht(z)&&T.dragMoving&&this.fireUpdate(),this.stopExtendedInteractions(T),!0},onMouseOut:function(T){return!T.dragMoving||this.fireUpdate()}};br.onTap=br.onClick=function(T,z){return Gi(z)?this.clickAnywhere(T,z):Yt(D.VERTEX)(z)?this.clickOnVertex(T,z):ht(z)?this.clickOnFeature(T,z):void 0},br.clickAnywhere=function(T){var z=this,q=this.getSelectedIds();q.length&&(this.clearSelectedFeatures(),q.forEach(function(me){return z.doRender(me)})),se.enable(this),this.stopExtendedInteractions(T)},br.clickOnVertex=function(T,z){this.changeMode(u.DIRECT_SELECT,{featureId:z.featureTarget.properties.parent,coordPath:z.featureTarget.properties.coord_path,startPos:z.lngLat}),this.updateUIClasses({mouse:h.MOVE})},br.startOnActiveFeature=function(T,z){this.stopExtendedInteractions(T),this.map.dragPan.disable(),this.doRender(z.featureTarget.properties.id),T.canDragMove=!0,T.dragMoveLocation=z.lngLat},br.clickOnFeature=function(T,z){var q=this;se.disable(this),this.stopExtendedInteractions(T);var me=Zt(z),Te=this.getSelectedIds(),Ee=z.featureTarget.properties.id,Fe=this.isSelected(Ee);if(!me&&Fe&&this.getFeature(Ee).type!==_.POINT)return this.changeMode(u.DIRECT_SELECT,{featureId:Ee});Fe&&me?(this.deselect(Ee),this.updateUIClasses({mouse:h.POINTER}),Te.length===1&&se.enable(this)):!Fe&&me?(this.select(Ee),this.updateUIClasses({mouse:h.MOVE})):Fe||me||(Te.forEach(function(Tt){return q.doRender(Tt)}),this.setSelected(Ee),this.updateUIClasses({mouse:h.MOVE})),this.doRender(Ee)},br.onMouseDown=function(T,z){return xi(z)?this.startOnActiveFeature(T,z):this.drawConfig.boxSelect&&gi(z)?this.startBoxSelect(T,z):void 0},br.startBoxSelect=function(T,z){this.stopExtendedInteractions(T),this.map.dragPan.disable(),T.boxSelectStartLocation=Lr(z.originalEvent,this.map.getContainer()),T.canBoxSelect=!0},br.onTouchStart=function(T,z){if(xi(z))return this.startOnActiveFeature(T,z)},br.onDrag=function(T,z){return T.canDragMove?this.dragMove(T,z):this.drawConfig.boxSelect&&T.canBoxSelect?this.whileBoxSelect(T,z):void 0},br.whileBoxSelect=function(T,z){T.boxSelecting=!0,this.updateUIClasses({mouse:h.ADD}),T.boxSelectElement||(T.boxSelectElement=document.createElement("div"),T.boxSelectElement.classList.add(o.BOX_SELECT),this.map.getContainer().appendChild(T.boxSelectElement));var q=Lr(z.originalEvent,this.map.getContainer()),me=Math.min(T.boxSelectStartLocation.x,q.x),Te=Math.max(T.boxSelectStartLocation.x,q.x),Ee=Math.min(T.boxSelectStartLocation.y,q.y),Fe=Math.max(T.boxSelectStartLocation.y,q.y),Tt="translate("+me+"px, "+Ee+"px)";T.boxSelectElement.style.transform=Tt,T.boxSelectElement.style.WebkitTransform=Tt,T.boxSelectElement.style.width=Te-me+"px",T.boxSelectElement.style.height=Fe-Ee+"px"},br.dragMove=function(T,z){T.dragMoving=!0,z.originalEvent.stopPropagation();var q={lng:z.lngLat.lng-T.dragMoveLocation.lng,lat:z.lngLat.lat-T.dragMoveLocation.lat};sa(this.getSelected(),q),T.dragMoveLocation=z.lngLat},br.onTouchEnd=br.onMouseUp=function(T,z){var q=this;if(T.dragMoving)this.fireUpdate();else if(T.boxSelecting){var me=[T.boxSelectStartLocation,Lr(z.originalEvent,this.map.getContainer())],Te=this.featuresAt(null,me,"click"),Ee=this.getUniqueIds(Te).filter(function(Fe){return!q.isSelected(Fe)});Ee.length&&(this.select(Ee),Ee.forEach(function(Fe){return q.doRender(Fe)}),this.updateUIClasses({mouse:h.MOVE}))}this.stopExtendedInteractions(T)},br.toDisplayFeatures=function(T,z,q){z.properties.active=this.isSelected(z.properties.id)?L.ACTIVE:L.INACTIVE,q(z),this.fireActionable(),z.properties.active===L.ACTIVE&&z.geometry.type!==_.POINT&&$r(z).forEach(q)},br.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()},br.onCombineFeatures=function(){var T=this.getSelected();if(!(T.length===0||T.length<2)){for(var z=[],q=[],me=T[0].type.replace("Multi",""),Te=0;Te<T.length;Te++){var Ee=T[Te];if(Ee.type.replace("Multi","")!==me)return;Ee.type.includes("Multi")?Ee.getCoordinates().forEach(function(Tt){z.push(Tt)}):z.push(Ee.getCoordinates()),q.push(Ee.toGeoJSON())}if(q.length>1){var Fe=this.newFeature({type:_.FEATURE,properties:q[0].properties,geometry:{type:"Multi"+me,coordinates:z}});this.addFeature(Fe),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([Fe.id]),this.map.fire(C.COMBINE_FEATURES,{createdFeatures:[Fe.toGeoJSON()],deletedFeatures:q})}this.fireActionable()}},br.onUncombineFeatures=function(){var T=this,z=this.getSelected();if(z.length!==0){for(var q=[],me=[],Te=function(Fe){var Tt=z[Fe];T.isInstanceOf("MultiFeature",Tt)&&(Tt.getFeatures().forEach(function(Mt){T.addFeature(Mt),Mt.properties=Tt.properties,q.push(Mt.toGeoJSON()),T.select([Mt.id])}),T.deleteFeature(Tt.id,{silent:!0}),me.push(Tt.toGeoJSON()))},Ee=0;Ee<z.length;Ee++)Te(Ee);q.length>1&&this.map.fire(C.UNCOMBINE_FEATURES,{createdFeatures:q,deletedFeatures:me}),this.fireActionable()}};var sn=Yt(D.VERTEX),an=Yt(D.MIDPOINT),Jn={fireUpdate:function(){this.map.fire(C.UPDATE,{action:S.CHANGE_COORDINATES,features:this.getSelected().map(function(T){return T.toGeoJSON()})})},fireActionable:function(T){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:T.selectedCoordPaths.length>0})},startDragging:function(T,z){this.map.dragPan.disable(),T.canDragMove=!0,T.dragMoveLocation=z.lngLat},stopDragging:function(T){this.map.dragPan.enable(),T.dragMoving=!1,T.canDragMove=!1,T.dragMoveLocation=null},onVertex:function(T,z){this.startDragging(T,z);var q=z.featureTarget.properties,me=T.selectedCoordPaths.indexOf(q.coord_path);Zt(z)||me!==-1?Zt(z)&&me===-1&&T.selectedCoordPaths.push(q.coord_path):T.selectedCoordPaths=[q.coord_path];var Te=this.pathsToCoordinates(T.featureId,T.selectedCoordPaths);this.setSelectedCoordinates(Te)},onMidpoint:function(T,z){this.startDragging(T,z);var q=z.featureTarget.properties;T.feature.addCoordinate(q.coord_path,q.lng,q.lat),this.fireUpdate(),T.selectedCoordPaths=[q.coord_path]},pathsToCoordinates:function(T,z){return z.map(function(q){return{feature_id:T,coord_path:q}})},onFeature:function(T,z){T.selectedCoordPaths.length===0?this.startDragging(T,z):this.stopDragging(T)},dragFeature:function(T,z,q){sa(this.getSelected(),q),T.dragMoveLocation=z.lngLat},dragVertex:function(T,z,q){for(var me=T.selectedCoordPaths.map(function(Tt){return T.feature.getCoordinate(Tt)}),Te=Ni(me.map(function(Tt){return{type:_.FEATURE,properties:{},geometry:{type:_.POINT,coordinates:Tt}}}),q),Ee=0;Ee<me.length;Ee++){var Fe=me[Ee];T.feature.updateCoordinate(T.selectedCoordPaths[Ee],Fe[0]+Te.lng,Fe[1]+Te.lat)}},clickNoTarget:function(){this.changeMode(u.SIMPLE_SELECT)},clickInactive:function(){this.changeMode(u.SIMPLE_SELECT)},clickActiveFeature:function(T){T.selectedCoordPaths=[],this.clearSelectedCoordinates(),T.feature.changed()},onSetup:function(T){var z=T.featureId,q=this.getFeature(z);if(!q)throw new Error("You must provide a featureId to enter direct_select mode");if(q.type===_.POINT)throw new TypeError("direct_select mode doesn't handle point features");var me={featureId:z,feature:q,dragMoveLocation:T.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:T.coordPath?[T.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(z,me.selectedCoordPaths)),this.setSelected(z),se.disable(this),this.setActionableState({trash:!0}),me},onStop:function(){se.enable(this),this.clearSelectedCoordinates()},toDisplayFeatures:function(T,z,q){T.featureId===z.properties.id?(z.properties.active=L.ACTIVE,q(z),$r(z,{map:this.map,midpoints:!0,selectedPaths:T.selectedCoordPaths}).forEach(q)):(z.properties.active=L.INACTIVE,q(z)),this.fireActionable(T)},onTrash:function(T){T.selectedCoordPaths.sort(function(z,q){return q.localeCompare(z,"en",{numeric:!0})}).forEach(function(z){return T.feature.removeCoordinate(z)}),this.fireUpdate(),T.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(T),T.feature.isValid()===!1&&(this.deleteFeature([T.featureId]),this.changeMode(u.SIMPLE_SELECT,{}))},onMouseMove:function(T,z){var q=xi(z),me=sn(z),Te=an(z),Ee=T.selectedCoordPaths.length===0;return q&&Ee||me&&!Ee?this.updateUIClasses({mouse:h.MOVE}):this.updateUIClasses({mouse:h.NONE}),(me||q||Te)&&T.dragMoving&&this.fireUpdate(),this.stopDragging(T),!0},onMouseOut:function(T){return T.dragMoving&&this.fireUpdate(),!0}};Jn.onTouchStart=Jn.onMouseDown=function(T,z){return sn(z)?this.onVertex(T,z):xi(z)?this.onFeature(T,z):an(z)?this.onMidpoint(T,z):void 0},Jn.onDrag=function(T,z){if(T.canDragMove===!0){T.dragMoving=!0,z.originalEvent.stopPropagation();var q={lng:z.lngLat.lng-T.dragMoveLocation.lng,lat:z.lngLat.lat-T.dragMoveLocation.lat};T.selectedCoordPaths.length>0?this.dragVertex(T,z,q):this.dragFeature(T,z,q),T.dragMoveLocation=z.lngLat}},Jn.onClick=function(T,z){return Gi(z)?this.clickNoTarget(T,z):xi(z)?this.clickActiveFeature(T,z):fi(z)?this.clickInactive(T,z):void this.stopDragging(T)},Jn.onTap=function(T,z){return Gi(z)?this.clickNoTarget(T,z):xi(z)?this.clickActiveFeature(T,z):fi(z)?this.clickInactive(T,z):void 0},Jn.onTouchEnd=Jn.onMouseUp=function(T){T.dragMoving&&this.fireUpdate(),this.stopDragging(T)};var tr={};function Kr(T,z){return!!T.lngLat&&T.lngLat.lng===z[0]&&T.lngLat.lat===z[1]}tr.onSetup=function(){var T=this.newFeature({type:_.FEATURE,properties:{},geometry:{type:_.POINT,coordinates:[]}});return this.addFeature(T),this.clearSelectedFeatures(),this.updateUIClasses({mouse:h.ADD}),this.activateUIButton(p.POINT),this.setActionableState({trash:!0}),{point:T}},tr.stopDrawingAndRemove=function(T){this.deleteFeature([T.point.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT)},tr.onTap=tr.onClick=function(T,z){this.updateUIClasses({mouse:h.MOVE}),T.point.updateCoordinate("",z.lngLat.lng,z.lngLat.lat),this.map.fire(C.CREATE,{features:[T.point.toGeoJSON()]}),this.changeMode(u.SIMPLE_SELECT,{featureIds:[T.point.id]})},tr.onStop=function(T){this.activateUIButton(),T.point.getCoordinate().length||this.deleteFeature([T.point.id],{silent:!0})},tr.toDisplayFeatures=function(T,z,q){var me=z.properties.id===T.point.id;if(z.properties.active=me?L.ACTIVE:L.INACTIVE,!me)return q(z)},tr.onTrash=tr.stopDrawingAndRemove,tr.onKeyUp=function(T,z){if(bi(z)||cr(z))return this.stopDrawingAndRemove(T,z)};var us={onSetup:function(){var T=this.newFeature({type:_.FEATURE,properties:{},geometry:{type:_.POLYGON,coordinates:[[]]}});return this.addFeature(T),this.clearSelectedFeatures(),se.disable(this),this.updateUIClasses({mouse:h.ADD}),this.activateUIButton(p.POLYGON),this.setActionableState({trash:!0}),{polygon:T,currentVertexPosition:0}},clickAnywhere:function(T,z){if(T.currentVertexPosition>0&&Kr(z,T.polygon.coordinates[0][T.currentVertexPosition-1]))return this.changeMode(u.SIMPLE_SELECT,{featureIds:[T.polygon.id]});this.updateUIClasses({mouse:h.ADD}),T.polygon.updateCoordinate("0."+T.currentVertexPosition,z.lngLat.lng,z.lngLat.lat),T.currentVertexPosition++,T.polygon.updateCoordinate("0."+T.currentVertexPosition,z.lngLat.lng,z.lngLat.lat)},clickOnVertex:function(T){return this.changeMode(u.SIMPLE_SELECT,{featureIds:[T.polygon.id]})},onMouseMove:function(T,z){T.polygon.updateCoordinate("0."+T.currentVertexPosition,z.lngLat.lng,z.lngLat.lat),Hi(z)&&this.updateUIClasses({mouse:h.POINTER})}};us.onTap=us.onClick=function(T,z){return Hi(z)?this.clickOnVertex(T,z):this.clickAnywhere(T,z)},us.onKeyUp=function(T,z){bi(z)?(this.deleteFeature([T.polygon.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT)):cr(z)&&this.changeMode(u.SIMPLE_SELECT,{featureIds:[T.polygon.id]})},us.onStop=function(T){this.updateUIClasses({mouse:h.NONE}),se.enable(this),this.activateUIButton(),this.getFeature(T.polygon.id)!==void 0&&(T.polygon.removeCoordinate("0."+T.currentVertexPosition),T.polygon.isValid()?this.map.fire(C.CREATE,{features:[T.polygon.toGeoJSON()]}):(this.deleteFeature([T.polygon.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT,{},{silent:!0})))},us.toDisplayFeatures=function(T,z,q){var me=z.properties.id===T.polygon.id;if(z.properties.active=me?L.ACTIVE:L.INACTIVE,!me)return q(z);if(z.geometry.coordinates.length!==0){var Te=z.geometry.coordinates[0].length;if(!(Te<3)){if(z.properties.meta=D.FEATURE,q(ui(T.polygon.id,z.geometry.coordinates[0][0],"0.0",!1)),Te>3){var Ee=z.geometry.coordinates[0].length-3;q(ui(T.polygon.id,z.geometry.coordinates[0][Ee],"0."+Ee,!1))}if(Te<=4){var Fe=[[z.geometry.coordinates[0][0][0],z.geometry.coordinates[0][0][1]],[z.geometry.coordinates[0][1][0],z.geometry.coordinates[0][1][1]]];if(q({type:_.FEATURE,properties:z.properties,geometry:{coordinates:Fe,type:_.LINE_STRING}}),Te===3)return}return q(z)}}},us.onTrash=function(T){this.deleteFeature([T.polygon.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT)};var on={onSetup:function(T){var z,q,me=(T=T||{}).featureId,Te="forward";if(me){if(!(z=this.getFeature(me)))throw new Error("Could not find a feature with the provided featureId");var Ee=T.from;if(Ee&&Ee.type==="Feature"&&Ee.geometry&&Ee.geometry.type==="Point"&&(Ee=Ee.geometry),Ee&&Ee.type==="Point"&&Ee.coordinates&&Ee.coordinates.length===2&&(Ee=Ee.coordinates),!Ee||!Array.isArray(Ee))throw new Error("Please use the `from` property to indicate which point to continue the line from");var Fe=z.coordinates.length-1;if(z.coordinates[Fe][0]===Ee[0]&&z.coordinates[Fe][1]===Ee[1])q=Fe+1,z.addCoordinate.apply(z,[q].concat(z.coordinates[Fe]));else{if(z.coordinates[0][0]!==Ee[0]||z.coordinates[0][1]!==Ee[1])throw new Error("`from` should match the point at either the start or the end of the provided LineString");Te="backwards",q=0,z.addCoordinate.apply(z,[q].concat(z.coordinates[0]))}}else z=this.newFeature({type:_.FEATURE,properties:{},geometry:{type:_.LINE_STRING,coordinates:[]}}),q=0,this.addFeature(z);return this.clearSelectedFeatures(),se.disable(this),this.updateUIClasses({mouse:h.ADD}),this.activateUIButton(p.LINE),this.setActionableState({trash:!0}),{line:z,currentVertexPosition:q,direction:Te}},clickAnywhere:function(T,z){if(T.currentVertexPosition>0&&Kr(z,T.line.coordinates[T.currentVertexPosition-1])||T.direction==="backwards"&&Kr(z,T.line.coordinates[T.currentVertexPosition+1]))return this.changeMode(u.SIMPLE_SELECT,{featureIds:[T.line.id]});this.updateUIClasses({mouse:h.ADD}),T.line.updateCoordinate(T.currentVertexPosition,z.lngLat.lng,z.lngLat.lat),T.direction==="forward"?(T.currentVertexPosition++,T.line.updateCoordinate(T.currentVertexPosition,z.lngLat.lng,z.lngLat.lat)):T.line.addCoordinate(0,z.lngLat.lng,z.lngLat.lat)},clickOnVertex:function(T){return this.changeMode(u.SIMPLE_SELECT,{featureIds:[T.line.id]})},onMouseMove:function(T,z){T.line.updateCoordinate(T.currentVertexPosition,z.lngLat.lng,z.lngLat.lat),Hi(z)&&this.updateUIClasses({mouse:h.POINTER})}};on.onTap=on.onClick=function(T,z){if(Hi(z))return this.clickOnVertex(T,z);this.clickAnywhere(T,z)},on.onKeyUp=function(T,z){cr(z)?this.changeMode(u.SIMPLE_SELECT,{featureIds:[T.line.id]}):bi(z)&&(this.deleteFeature([T.line.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT))},on.onStop=function(T){se.enable(this),this.activateUIButton(),this.getFeature(T.line.id)!==void 0&&(T.line.removeCoordinate(""+T.currentVertexPosition),T.line.isValid()?this.map.fire(C.CREATE,{features:[T.line.toGeoJSON()]}):(this.deleteFeature([T.line.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT,{},{silent:!0})))},on.onTrash=function(T){this.deleteFeature([T.line.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT)},on.toDisplayFeatures=function(T,z,q){var me=z.properties.id===T.line.id;if(z.properties.active=me?L.ACTIVE:L.INACTIVE,!me)return q(z);z.geometry.coordinates.length<2||(z.properties.meta=D.FEATURE,q(ui(T.line.id,z.geometry.coordinates[T.direction==="forward"?z.geometry.coordinates.length-2:1],""+(T.direction==="forward"?z.geometry.coordinates.length-2:1),!1)),q(z))};var wr={simple_select:br,direct_select:Jn,draw_point:tr,draw_polygon:us,draw_line_string:on},aa={defaultMode:u.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:qt,modes:wr,controls:{},userProperties:!1},Cs={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},gr={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function ds(T,z){return T.map(function(q){return q.source?q:Pt(q,{id:q.id+"."+z,source:z==="hot"?c.HOT:c.COLD})})}var fn={exports:{}};(function(T,z){var q="__lodash_hash_undefined__",me=9007199254740991,Te="[object Arguments]",Ee="[object Array]",Fe="[object Boolean]",Tt="[object Date]",Mt="[object Error]",jt="[object Function]",Ut="[object Map]",Dt="[object Number]",yi="[object Object]",nr="[object Promise]",wi="[object RegExp]",ur="[object Set]",ft="[object String]",Qt="[object Symbol]",Ei="[object WeakMap]",_r="[object ArrayBuffer]",sr="[object DataView]",Ts=/^\[object .+?Constructor\]$/,Ea=/^(?:0|[1-9]\d*)$/,qi={};qi["[object Float32Array]"]=qi["[object Float64Array]"]=qi["[object Int8Array]"]=qi["[object Int16Array]"]=qi["[object Int32Array]"]=qi["[object Uint8Array]"]=qi["[object Uint8ClampedArray]"]=qi["[object Uint16Array]"]=qi["[object Uint32Array]"]=!0,qi[Te]=qi[Ee]=qi[_r]=qi[Fe]=qi[sr]=qi[Tt]=qi[Mt]=qi[jt]=qi[Ut]=qi[Dt]=qi[yi]=qi[wi]=qi[ur]=qi[ft]=qi[Ei]=!1;var Es=typeof sl=="object"&&sl&&sl.Object===Object&&sl,fl=typeof self=="object"&&self&&self.Object===Object&&self,Qn=Es||fl||Function("return this")(),eo=z&&!z.nodeType&&z,Oo=eo&&T&&!T.nodeType&&T,fs=Oo&&Oo.exports===eo,Ws=fs&&Es.process,ln=function(){try{return Ws&&Ws.binding&&Ws.binding("util")}catch{}}(),Wr=ln&&ln.isTypedArray;function Hs(ze,tt){for(var Lt=-1,ni=ze==null?0:ze.length;++Lt<ni;)if(tt(ze[Lt],Lt,ze))return!0;return!1}function Fi(ze){var tt=-1,Lt=Array(ze.size);return ze.forEach(function(ni,Yi){Lt[++tt]=[Yi,ni]}),Lt}function Ia(ze){var tt=-1,Lt=Array(ze.size);return ze.forEach(function(ni){Lt[++tt]=ni}),Lt}var Pa,Aa,la,to=Array.prototype,io=Function.prototype,Is=Object.prototype,Ma=Qn["__core-js_shared__"],ro=io.toString,Jr=Is.hasOwnProperty,Lo=(Pa=/[^.]+$/.exec(Ma&&Ma.keys&&Ma.keys.IE_PROTO||""))?"Symbol(src)_1."+Pa:"",Fo=Is.toString,pl=RegExp("^"+ro.call(Jr).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),zo=fs?Qn.Buffer:void 0,ka=Qn.Symbol,Ro=Qn.Uint8Array,Da=Is.propertyIsEnumerable,Oa=to.splice,es=ka?ka.toStringTag:void 0,La=Object.getOwnPropertySymbols,Xs=zo?zo.isBuffer:void 0,Bo=(Aa=Object.keys,la=Object,function(ze){return Aa(la(ze))}),Fa=Ds(Qn,"DataView"),Ps=Ds(Qn,"Map"),ts=Ds(Qn,"Promise"),za=Ds(Qn,"Set"),ps=Ds(Qn,"WeakMap"),Gn=Ds(Object,"create"),jo=gs(Fa),no=gs(Ps),zi=gs(ts),qs=gs(za),ml=gs(ps),so=ka?ka.prototype:void 0,As=so?so.valueOf:void 0;function Ms(ze){var tt=-1,Lt=ze==null?0:ze.length;for(this.clear();++tt<Lt;){var ni=ze[tt];this.set(ni[0],ni[1])}}function $i(ze){var tt=-1,Lt=ze==null?0:ze.length;for(this.clear();++tt<Lt;){var ni=ze[tt];this.set(ni[0],ni[1])}}function ms(ze){var tt=-1,Lt=ze==null?0:ze.length;for(this.clear();++tt<Lt;){var ni=ze[tt];this.set(ni[0],ni[1])}}function Ii(ze){var tt=-1,Lt=ze==null?0:ze.length;for(this.__data__=new ms;++tt<Lt;)this.add(ze[tt])}function Cn(ze){var tt=this.__data__=new $i(ze);this.size=tt.size}function Ji(ze,tt){var Lt=$s(ze),ni=!Lt&&Na(ze),Yi=!Lt&&!ni&&uo(ze),ki=!Lt&&!ni&&!Yi&&Os(ze),ir=Lt||ni||Yi||ki,yr=ir?function(Er,Ln){for(var Hn=-1,Hr=Array(Er);++Hn<Er;)Hr[Hn]=Ln(Hn);return Hr}(ze.length,String):[],mn=yr.length;for(var Ki in ze)!tt&&!Jr.call(ze,Ki)||ir&&(Ki=="length"||Yi&&(Ki=="offset"||Ki=="parent")||ki&&(Ki=="buffer"||Ki=="byteLength"||Ki=="byteOffset")||co(Ki,mn))||yr.push(Ki);return yr}function Wi(ze,tt){for(var Lt=ze.length;Lt--;)if(ho(ze[Lt][0],tt))return Lt;return-1}function Wn(ze){return ze==null?ze===void 0?"[object Undefined]":"[object Null]":es&&es in Object(ze)?function(tt){var Lt=Jr.call(tt,es),ni=tt[es];try{tt[es]=void 0;var Yi=!0}catch{}var ki=Fo.call(tt);return Yi&&(Lt?tt[es]=ni:delete tt[es]),ki}(ze):function(tt){return Fo.call(tt)}(ze)}function ca(ze){return zr(ze)&&Wn(ze)==Te}function ao(ze,tt,Lt,ni,Yi){return ze===tt||(ze==null||tt==null||!zr(ze)&&!zr(tt)?ze!=ze&&tt!=tt:function(ki,ir,yr,mn,Ki,Er){var Ln=$s(ki),Hn=$s(ir),Hr=Ln?Ee:pn(ki),Xn=Hn?Ee:pn(ir),qn=(Hr=Hr==Te?yi:Hr)==yi,_s=(Xn=Xn==Te?yi:Xn)==yi,fr=Hr==Xn;if(fr&&uo(ki)){if(!uo(ir))return!1;Ln=!0,qn=!1}if(fr&&!qn)return Er||(Er=new Cn),Ln||Os(ki)?ja(ki,ir,yr,mn,Ki,Er):function(Pi,Ri,Ys,ys,ha,_n,Rr){switch(Ys){case sr:if(Pi.byteLength!=Ri.byteLength||Pi.byteOffset!=Ri.byteOffset)return!1;Pi=Pi.buffer,Ri=Ri.buffer;case _r:return!(Pi.byteLength!=Ri.byteLength||!_n(new Ro(Pi),new Ro(Ri)));case Fe:case Tt:case Dt:return ho(+Pi,+Ri);case Mt:return Pi.name==Ri.name&&Pi.message==Ri.message;case wi:case ft:return Pi==Ri+"";case Ut:var Qr=Fi;case ur:var Nt=1&ys;if(Qr||(Qr=Ia),Pi.size!=Ri.size&&!Nt)return!1;var Zs=Rr.get(Pi);if(Zs)return Zs==Ri;ys|=2,Rr.set(Pi,Ri);var Sn=ja(Qr(Pi),Qr(Ri),ys,ha,_n,Rr);return Rr.delete(Pi),Sn;case Qt:if(As)return As.call(Pi)==As.call(Ri)}return!1}(ki,ir,Hr,yr,mn,Ki,Er);if(!(1&yr)){var $n=qn&&Jr.call(ki,"__wrapped__"),gn=_s&&Jr.call(ir,"__wrapped__");if($n||gn){var Yn=$n?ki.value():ki,No=gn?ir.value():ir;return Er||(Er=new Cn),Ki(Yn,No,yr,mn,Er)}}return fr?(Er||(Er=new Cn),function(Pi,Ri,Ys,ys,ha,_n){var Rr=1&Ys,Qr=oo(Pi),Nt=Qr.length,Zs=oo(Ri).length;if(Nt!=Zs&&!Rr)return!1;for(var Sn=Nt;Sn--;){var Tn=Qr[Sn];if(!(Rr?Tn in Ri:Jr.call(Ri,Tn)))return!1}var Va=_n.get(Pi);if(Va&&_n.get(Ri))return Va==Ri;var Bt=!0;_n.set(Pi,Ri),_n.set(Ri,Pi);for(var Ls=Rr;++Sn<Nt;){var Fs=Pi[Tn=Qr[Sn]],ua=Ri[Tn];if(ys)var da=Rr?ys(ua,Fs,Tn,Ri,Pi,_n):ys(Fs,ua,Tn,Pi,Ri,_n);if(!(da===void 0?Fs===ua||ha(Fs,ua,Ys,ys,_n):da)){Bt=!1;break}Ls||(Ls=Tn=="constructor")}if(Bt&&!Ls){var Ks=Pi.constructor,Js=Ri.constructor;Ks==Js||!("constructor"in Pi)||!("constructor"in Ri)||typeof Ks=="function"&&Ks instanceof Ks&&typeof Js=="function"&&Js instanceof Js||(Bt=!1)}return _n.delete(Pi),_n.delete(Ri),Bt}(ki,ir,yr,mn,Ki,Er)):!1}(ze,tt,Lt,ni,ao,Yi))}function Ra(ze){return!(!is(ze)||function(tt){return!!Lo&&Lo in tt}(ze))&&(fo(ze)?pl:Ts).test(gs(ze))}function Ba(ze){if(Lt=(tt=ze)&&tt.constructor,ni=typeof Lt=="function"&&Lt.prototype||Is,tt!==ni)return Bo(ze);var tt,Lt,ni,Yi=[];for(var ki in Object(ze))Jr.call(ze,ki)&&ki!="constructor"&&Yi.push(ki);return Yi}function ja(ze,tt,Lt,ni,Yi,ki){var ir=1&Lt,yr=ze.length,mn=tt.length;if(yr!=mn&&!(ir&&mn>yr))return!1;var Ki=ki.get(ze);if(Ki&&ki.get(tt))return Ki==tt;var Er=-1,Ln=!0,Hn=2&Lt?new Ii:void 0;for(ki.set(ze,tt),ki.set(tt,ze);++Er<yr;){var Hr=ze[Er],Xn=tt[Er];if(ni)var qn=ir?ni(Xn,Hr,Er,tt,ze,ki):ni(Hr,Xn,Er,ze,tt,ki);if(qn!==void 0){if(qn)continue;Ln=!1;break}if(Hn){if(!Hs(tt,function(_s,fr){if($n=fr,!Hn.has($n)&&(Hr===_s||Yi(Hr,_s,Lt,ni,ki)))return Hn.push(fr);var $n})){Ln=!1;break}}else if(Hr!==Xn&&!Yi(Hr,Xn,Lt,ni,ki)){Ln=!1;break}}return ki.delete(ze),ki.delete(tt),Ln}function oo(ze){return function(tt,Lt,ni){var Yi=Lt(tt);return $s(tt)?Yi:function(ki,ir){for(var yr=-1,mn=ir.length,Ki=ki.length;++yr<mn;)ki[Ki+yr]=ir[yr];return ki}(Yi,ni(tt))}(ze,po,lo)}function ks(ze,tt){var Lt,ni,Yi=ze.__data__;return((ni=typeof(Lt=tt))=="string"||ni=="number"||ni=="symbol"||ni=="boolean"?Lt!=="__proto__":Lt===null)?Yi[typeof tt=="string"?"string":"hash"]:Yi.map}function Ds(ze,tt){var Lt=function(ni,Yi){return ni==null?void 0:ni[Yi]}(ze,tt);return Ra(Lt)?Lt:void 0}Ms.prototype.clear=function(){this.__data__=Gn?Gn(null):{},this.size=0},Ms.prototype.delete=function(ze){var tt=this.has(ze)&&delete this.__data__[ze];return this.size-=tt?1:0,tt},Ms.prototype.get=function(ze){var tt=this.__data__;if(Gn){var Lt=tt[ze];return Lt===q?void 0:Lt}return Jr.call(tt,ze)?tt[ze]:void 0},Ms.prototype.has=function(ze){var tt=this.__data__;return Gn?tt[ze]!==void 0:Jr.call(tt,ze)},Ms.prototype.set=function(ze,tt){var Lt=this.__data__;return this.size+=this.has(ze)?0:1,Lt[ze]=Gn&&tt===void 0?q:tt,this},$i.prototype.clear=function(){this.__data__=[],this.size=0},$i.prototype.delete=function(ze){var tt=this.__data__,Lt=Wi(tt,ze);return!(Lt<0)&&(Lt==tt.length-1?tt.pop():Oa.call(tt,Lt,1),--this.size,!0)},$i.prototype.get=function(ze){var tt=this.__data__,Lt=Wi(tt,ze);return Lt<0?void 0:tt[Lt][1]},$i.prototype.has=function(ze){return Wi(this.__data__,ze)>-1},$i.prototype.set=function(ze,tt){var Lt=this.__data__,ni=Wi(Lt,ze);return ni<0?(++this.size,Lt.push([ze,tt])):Lt[ni][1]=tt,this},ms.prototype.clear=function(){this.size=0,this.__data__={hash:new Ms,map:new(Ps||$i),string:new Ms}},ms.prototype.delete=function(ze){var tt=ks(this,ze).delete(ze);return this.size-=tt?1:0,tt},ms.prototype.get=function(ze){return ks(this,ze).get(ze)},ms.prototype.has=function(ze){return ks(this,ze).has(ze)},ms.prototype.set=function(ze,tt){var Lt=ks(this,ze),ni=Lt.size;return Lt.set(ze,tt),this.size+=Lt.size==ni?0:1,this},Ii.prototype.add=Ii.prototype.push=function(ze){return this.__data__.set(ze,q),this},Ii.prototype.has=function(ze){return this.__data__.has(ze)},Cn.prototype.clear=function(){this.__data__=new $i,this.size=0},Cn.prototype.delete=function(ze){var tt=this.__data__,Lt=tt.delete(ze);return this.size=tt.size,Lt},Cn.prototype.get=function(ze){return this.__data__.get(ze)},Cn.prototype.has=function(ze){return this.__data__.has(ze)},Cn.prototype.set=function(ze,tt){var Lt=this.__data__;if(Lt instanceof $i){var ni=Lt.__data__;if(!Ps||ni.length<199)return ni.push([ze,tt]),this.size=++Lt.size,this;Lt=this.__data__=new ms(ni)}return Lt.set(ze,tt),this.size=Lt.size,this};var lo=La?function(ze){return ze==null?[]:(ze=Object(ze),function(tt,Lt){for(var ni=-1,Yi=tt==null?0:tt.length,ki=0,ir=[];++ni<Yi;){var yr=tt[ni];Lt(yr,ni,tt)&&(ir[ki++]=yr)}return ir}(La(ze),function(tt){return Da.call(ze,tt)}))}:function(){return[]},pn=Wn;function co(ze,tt){return!!(tt=tt??me)&&(typeof ze=="number"||Ea.test(ze))&&ze>-1&&ze%1==0&&ze<tt}function gs(ze){if(ze!=null){try{return ro.call(ze)}catch{}try{return ze+""}catch{}}return""}function ho(ze,tt){return ze===tt||ze!=ze&&tt!=tt}(Fa&&pn(new Fa(new ArrayBuffer(1)))!=sr||Ps&&pn(new Ps)!=Ut||ts&&pn(ts.resolve())!=nr||za&&pn(new za)!=ur||ps&&pn(new ps)!=Ei)&&(pn=function(ze){var tt=Wn(ze),Lt=tt==yi?ze.constructor:void 0,ni=Lt?gs(Lt):"";if(ni)switch(ni){case jo:return sr;case no:return Ut;case zi:return nr;case qs:return ur;case ml:return Ei}return tt});var Na=ca(function(){return arguments}())?ca:function(ze){return zr(ze)&&Jr.call(ze,"callee")&&!Da.call(ze,"callee")},$s=Array.isArray,uo=Xs||function(){return!1};function fo(ze){if(!is(ze))return!1;var tt=Wn(ze);return tt==jt||tt=="[object GeneratorFunction]"||tt=="[object AsyncFunction]"||tt=="[object Proxy]"}function dr(ze){return typeof ze=="number"&&ze>-1&&ze%1==0&&ze<=me}function is(ze){var tt=typeof ze;return ze!=null&&(tt=="object"||tt=="function")}function zr(ze){return ze!=null&&typeof ze=="object"}var Os=Wr?function(ze){return function(tt){return ze(tt)}}(Wr):function(ze){return zr(ze)&&dr(ze.length)&&!!qi[Wn(ze)]};function po(ze){return(tt=ze)!=null&&dr(tt.length)&&!fo(tt)?Ji(ze):Ba(ze);var tt}T.exports=function(ze,tt){return ao(ze,tt)}})(fn,fn.exports);var oa=Ae(fn.exports);function On(T,z){return T.length===z.length&&JSON.stringify(T.map(function(q){return q}).sort())===JSON.stringify(z.map(function(q){return q}).sort())}var Qa={Polygon:Ce,LineString:ee,Point:fe,MultiPolygon:Ue,MultiLineString:Ue,MultiPoint:Ue},Gs=Object.freeze({__proto__:null,CommonSelectors:xt,constrainFeatureMovement:Ni,createMidPoint:wn,createSupplementaryPoints:$r,createVertex:ui,doubleClickZoom:se,euclideanDistance:ct,featuresAt:ot,getFeatureAtAndSetCursors:St,isClick:Et,isEventAtCoordinates:Kr,isTap:Q,mapEventToBoundingBox:at,ModeHandler:xe,moveFeatures:sa,sortFeatures:Ke,stringSetsAreEqual:On,StringSet:$e,theme:qt,toDenseArray:Oe}),Vi=function(T,z){var q={options:T=function(Te){Te===void 0&&(Te={});var Ee=Pt(Te);return Te.controls||(Ee.controls={}),Te.displayControlsDefault===!1?Ee.controls=Pt(gr,Te.controls):Ee.controls=Pt(Cs,Te.controls),(Ee=Pt(aa,Ee)).styles=ds(Ee.styles,"cold").concat(ds(Ee.styles,"hot")),Ee}(T)};z=function(Te,Ee){return Ee.modes=u,Ee.getFeatureIdsAt=function(Fe){return ot.click({point:Fe},null,Te).map(function(Tt){return Tt.properties.id})},Ee.getSelectedIds=function(){return Te.store.getSelectedIds()},Ee.getSelected=function(){return{type:_.FEATURE_COLLECTION,features:Te.store.getSelectedIds().map(function(Fe){return Te.store.get(Fe)}).map(function(Fe){return Fe.toGeoJSON()})}},Ee.getSelectedPoints=function(){return{type:_.FEATURE_COLLECTION,features:Te.store.getSelectedCoordinates().map(function(Fe){return{type:_.FEATURE,properties:{},geometry:{type:_.POINT,coordinates:Fe.coordinates}}})}},Ee.set=function(Fe){if(Fe.type===void 0||Fe.type!==_.FEATURE_COLLECTION||!Array.isArray(Fe.features))throw new Error("Invalid FeatureCollection");var Tt=Te.store.createRenderBatch(),Mt=Te.store.getAllIds().slice(),jt=Ee.add(Fe),Ut=new $e(jt);return(Mt=Mt.filter(function(Dt){return!Ut.has(Dt)})).length&&Ee.delete(Mt),Tt(),jt},Ee.add=function(Fe){var Tt=JSON.parse(JSON.stringify(ae(Fe))).features.map(function(Mt){if(Mt.id=Mt.id||pe(),Mt.geometry===null)throw new Error("Invalid geometry: null");if(Te.store.get(Mt.id)===void 0||Te.store.get(Mt.id).type!==Mt.geometry.type){var jt=Qa[Mt.geometry.type];if(jt===void 0)throw new Error("Invalid geometry type: "+Mt.geometry.type+".");var Ut=new jt(Te,Mt);Te.store.add(Ut)}else{var Dt=Te.store.get(Mt.id);Dt.properties=Mt.properties,oa(Dt.properties,Mt.properties)||Te.store.featureChanged(Dt.id),oa(Dt.getCoordinates(),Mt.geometry.coordinates)||Dt.incomingCoords(Mt.geometry.coordinates)}return Mt.id});return Te.store.render(),Tt},Ee.get=function(Fe){var Tt=Te.store.get(Fe);if(Tt)return Tt.toGeoJSON()},Ee.getAll=function(){return{type:_.FEATURE_COLLECTION,features:Te.store.getAll().map(function(Fe){return Fe.toGeoJSON()})}},Ee.delete=function(Fe){return Te.store.delete(Fe,{silent:!0}),Ee.getMode()!==u.DIRECT_SELECT||Te.store.getSelectedIds().length?Te.store.render():Te.events.changeMode(u.SIMPLE_SELECT,void 0,{silent:!0}),Ee},Ee.deleteAll=function(){return Te.store.delete(Te.store.getAllIds(),{silent:!0}),Ee.getMode()===u.DIRECT_SELECT?Te.events.changeMode(u.SIMPLE_SELECT,void 0,{silent:!0}):Te.store.render(),Ee},Ee.changeMode=function(Fe,Tt){return Tt===void 0&&(Tt={}),Fe===u.SIMPLE_SELECT&&Ee.getMode()===u.SIMPLE_SELECT?(On(Tt.featureIds||[],Te.store.getSelectedIds())||(Te.store.setSelected(Tt.featureIds,{silent:!0}),Te.store.render()),Ee):(Fe===u.DIRECT_SELECT&&Ee.getMode()===u.DIRECT_SELECT&&Tt.featureId===Te.store.getSelectedIds()[0]||Te.events.changeMode(Fe,Tt,{silent:!0}),Ee)},Ee.getMode=function(){return Te.events.getMode()},Ee.trash=function(){return Te.events.trash({silent:!0}),Ee},Ee.combineFeatures=function(){return Te.events.combineFeatures({silent:!0}),Ee},Ee.uncombineFeatures=function(){return Te.events.uncombineFeatures({silent:!0}),Ee},Ee.setFeatureProperty=function(Fe,Tt,Mt){return Te.store.setFeatureProperty(Fe,Tt,Mt),Ee},Ee}(q,z),q.api=z;var me=nt(q);return z.onAdd=me.onAdd,z.onRemove=me.onRemove,z.types=p,z.options=T,z};function Ss(T){Vi(T,this)}return Ss.modes=wr,Ss.constants=ne,Ss.lib=Gs,Ss})})(wd);var Mp=wd.exports;const bh=yd(Mp),Kl="rgb(127, 127, 127)",kp=[{id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","true"]],paint:{"fill-color":["case",["==",["get","user_color_rgb_str"],null],Kl,["get","user_color_rgb_str"]],"fill-outline-color":"rgb(0, 0, 0)","fill-opacity":.5}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","$type","Polygon"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(178, 204, 255)","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-halo-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-polygon-and-line-vertex-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"]],paint:{"circle-radius":3,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","$type","LineString"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-width":3}},{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","false"]],paint:{"fill-color":["case",["==",["get","user_color_rgb_str"],null],Kl,["get","user_color_rgb_str"]],"fill-outline-color":"rgb(0, 0, 0)","fill-opacity":.25}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","$type","Polygon"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-width":3}}];function Dp(ie,I){return ie.lngLat?ie.lngLat.lng===I[0]&&ie.lngLat.lat===I[1]:!1}const Eh=bh.modes.draw_polygon;Eh.maxVertices=4;Eh.clickAnywhere=function(ie,I){if(ie.currentVertexPosition>0&&Dp(I,ie.polygon.coordinates[0][ie.currentVertexPosition-1]))return this.changeMode("simple_select",{featureIds:[ie.polygon.id]});if(this.updateUIClasses({mouse:"add"}),ie.polygon.updateCoordinate(`0.${ie.currentVertexPosition}`,I.lngLat.lng,I.lngLat.lat),ie.currentVertexPosition++,ie.polygon.updateCoordinate(`0.${ie.currentVertexPosition}`,I.lngLat.lng,I.lngLat.lat),ie.currentVertexPosition>this.maxVertices-1)return this.updateUIClasses({mouse:"none"}),this.changeMode("simple_select",{featuresId:ie.polygon.id})};var Op={exports:{}};(function(ie){(function(I){I.version="0.5.0",I.defaults={doThrows:{invalidGeometry:!1}};function xe(){var _=1<=arguments.length?[].slice.call(arguments,0):[],u=_.shift(),C=_.shift();Error.apply(this,_),this.message=this.message||"Invalid Geometry: item: "+JSON.stringify(u)+", params: "+JSON.stringify(C)}xe.prototype=Error,I.errors={InvalidGeometryError:xe},I.isGeometryValid=function(_){return!_||!Object.keys(_).length?!1:!!_.type&&!!_.coordinates&&Array.isArray(_.coordinates)&&!!_.coordinates.length},I.parse=function(_,u,C){var S,D=Ze(u,this.defaults),L;if(Ne.length=0,m(D),L=h(D),Array.isArray(_)?(S={type:"FeatureCollection",features:[]},_.forEach(function(U){S.features.push(x({item:U,params:D,propFunc:L}))}),V(S,D)):(S=x({item:_,params:D,propFunc:L}),V(S,D)),C&&typeof C=="function")C(S);else return S};var Ae=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","GeoJSON"],Ne=[];function Ze(_,u){var C=_||{};for(var S in u)u.hasOwnProperty(S)&&!C[S]&&(C[S]=u[S]);return C}function V(_,u){if(u.crs&&s(u.crs)&&(u.isPostgres?_.geometry.crs=u.crs:_.crs=u.crs),u.bbox&&(_.bbox=u.bbox),u.extraGlobal){_.properties={};for(var C in u.extraGlobal)_.properties[C]=u.extraGlobal[C]}}function s(_){if(_.type==="name"){if(_.properties&&_.properties.name)return!0;throw new Error('Invalid CRS. Properties must contain "name" key')}else if(_.type==="link"){if(_.properties&&_.properties.href&&_.properties.type)return!0;throw new Error('Invalid CRS. Properties must contain "href" and "type" key')}else throw new Error('Invald CRS. Type attribute must be "name" or "link"')}function m(_){_.geom={};for(var u in _)_.hasOwnProperty(u)&&Ae.indexOf(u)!==-1&&(_.geom[u]=_[u],delete _[u]);b(_.geom)}function b(_){for(var u in _)_.hasOwnProperty(u)&&(typeof _[u]=="string"?Ne.push(_[u]):typeof _[u]=="object"&&(Ne.push(_[u][0]),Ne.push(_[u][1])));if(Ne.length===0)throw new Error("No geometry attributes specified")}function x(_){var u=_.item,C=_.params,S=_.propFunc,D={type:"Feature"};return D.geometry=c(u,C),D.properties=S.call(u),D}function o(_){return/^.+\..+$/.test(_)}function c(_,u){var C={};for(var S in u.geom){var D=u.geom[S];if(typeof D=="string"&&_.hasOwnProperty(D))S==="GeoJSON"?C=_[D]:(C.type=S,C.coordinates=_[D]);else if(typeof D=="object"&&!Array.isArray(D)){var L=Object.keys(D).map(function(Ke){var at=D[Ke],$e=_[Ke];return c($e,{geom:{Point:at}})});C.type=S,C.coordinates=[].concat(L.map(function(Ke){return Ke.coordinates}))}else if(Array.isArray(D)&&_.hasOwnProperty(D[0])&&_.hasOwnProperty(D[1]))C.type=S,C.coordinates=[Number(_[D[1]]),Number(_[D[0]])];else if(Array.isArray(D)&&o(D[0])&&o(D[1])){for(var U=[],$=0;$<D.length;$++){for(var ne=D[$].split("."),ye=_,Ve=0;Ve<ne.length;Ve++){if(!ye.hasOwnProperty(ne[Ve]))return!1;ye=ye[ne[Ve]]}U[$]=ye}C.type=S,C.coordinates=[Number(U[1]),Number(U[0])]}}if(u.doThrows&&u.doThrows.invalidGeometry&&!I.isGeometryValid(C))throw new xe(_,u);return C}function h(_){var u;return!_.exclude&&!_.include?u=function(C){for(var S in this)this.hasOwnProperty(S)&&Ne.indexOf(S)===-1&&(C[S]=this[S])}:_.include?u=function(C){_.include.forEach(function(S){C[S]=this[S]},this)}:_.exclude&&(u=function(C){for(var S in this)this.hasOwnProperty(S)&&Ne.indexOf(S)===-1&&_.exclude.indexOf(S)===-1&&(C[S]=this[S])}),function(){var C={};return u.call(this,C),_.extra&&p(C,_.extra),C}}function p(_,u){for(var C in u)u.hasOwnProperty(C)&&(_[C]=u[C]);return _}})(ie.exports)})(Op);const Cd={name:"delete_zone",onSetup:function(){return{}},onClick:function(ie,I){var xe;if(I.featureTarget){const Ae=I.featureTarget,Ne=(xe=Ae==null?void 0:Ae.properties)==null?void 0:xe.id;if(!Ne)return;this.deleteFeature(Ne),this.changeMode("simple_select")}},toDisplayFeatures:function(ie,I,xe){xe(I)}},wh=Un(),Ih=Un(new bh({userProperties:!0,displayControlsDefault:!1,controls:{polygon:!1,trash:!1},modes:Object.assign({draw_restricted_polygon:Eh,delete_zone:Cd},bh.modes),styles:kp}));var Ui=(ie=>(ie[ie.AddingZoneCanvas=1]="AddingZoneCanvas",ie[ie.AddingZoneMap=2]="AddingZoneMap",ie[ie.Waiting=3]="Waiting",ie[ie.EditingZone=4]="EditingZone",ie[ie.DeletingZoneCanvas=5]="DeletingZoneCanvas",ie[ie.DeletingZoneMap=6]="DeletingZoneMap",ie[ie.PickPolygon=7]="PickPolygon",ie))(Ui||{}),Mc=(ie=>(ie.Init="init",ie.ReInit="re-init",ie))(Mc||{});const Ch=Un(),qr=Un(Ui.Waiting),Zl=Un(!1),al=Un(!1),Lp="http",Fp="localhost",zp=42001,Rp=window.location.href,Ph=new URL(Rp),Ah=Ph.protocol.replace(/:/g,"")||Lp,Sd=Ph.hostname||Fp,Td=parseInt(Ph.port)||(Ah==="https:"?443:80)||zp;class Bp{constructor(I=Un(Ah),xe=Un(Sd),Ae=Un(Td)){this.schema=I,this.host=xe,this.port=Ae}get apiURL(){return Ip([this.schema,this.host,this.port],([I,xe,Ae])=>`${I}://${xe}:${Ae}`)}}const kc=new Bp,Mh=Un(`${Ah}://${Sd}:${Td}`);class jp{constructor(I=Un("https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL"),xe=Un("https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL")){this.uri=I,this.accepted_uri=xe}}const Dc=new jp;Un(Dc.accepted_uri);const ko=Un(new Map);function Np(ie){ko.update(I=>{const xe=new Map(I),Ae={type:ie.type,id:ie.id,properties:{road_lane_direction:ie.properties.road_lane_direction,road_lane_num:ie.properties.road_lane_num,coordinates:ie.properties.coordinates,color_rgb:ie.properties.color_rgb,ds_id:ie.id,spatial_object_id:`spatial-${ie.id}`,color_rgb_str:`rgb(${ie.properties.color_rgb[0]},${ie.properties.color_rgb[1]},${ie.properties.color_rgb[2]})`},geometry:{type:ie.geometry.type,coordinates:ie.geometry.coordinates}};return xe.set(ie.id,Ae),xe})}function Io(ie,I){ko.update(xe=>{const Ae=new Map(xe);return Ae.set(ie,I),Ae})}function Vp(ie){ko.update(I=>{const xe=new Map(I);return xe.delete(ie),xe})}function Up(){ko.update(ie=>{const I=new Map(ie);return I.clear(),I})}const Gp=(ie,I,xe)=>{const Ae=ie.get(xe);if(!Ae)return;if(!Ae.properties.spatial_object_id){console.error(`ID '${Ae.id}' should have 'spatial_object_id' in properties, but it has not`);return}const Ne=I.get(Ae.properties.spatial_object_id);Ne&&(I.add(Ne),I.setFeatureProperty(Ne.id,"color_rgb_str",Kl))},Ed=(ie,I)=>{const xe=ie.get(I);xe&&(xe.properties.spatial_object_id=void 0,xe.properties.road_lane_direction=-1,xe.properties.road_lane_num=-1,xe.geometry.coordinates=[[],[],[],[],[]],Io(I,xe))};function Wp(ie){let I,xe,Ae;return{c(){I=Wt("div"),xe=Wt("div"),this.h()},l(Ne){I=Ht(Ne,"DIV",{class:!0});var Ze=mi(I);xe=Ht(Ze,"DIV",{class:!0,id:!0}),mi(xe).forEach(ri),Ze.forEach(ri),this.h()},h(){yt(xe,"class","map"),yt(xe,"id","map"),yt(I,"class",Ae="map-wrap "+ie[0])},m(Ne,Ze){Vs(Ne,I,Ze),mt(I,xe),ie[5](xe)},p(Ne,[Ze]){Ze&1&&Ae!==(Ae="map-wrap "+Ne[0])&&yt(I,"class",Ae)},i:Us,o:Us,d(Ne){Ne&&ri(I),ie[5](null)}}}function Hp(ie){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(ie)}`}function Xp(ie,I,xe){let Ae,Ne,Ze,V;Or(ie,Ih,C=>xe(7,Ae=C)),Or(ie,ko,C=>xe(8,Ne=C)),Or(ie,wh,C=>xe(9,Ze=C));let{klass:s=""}=I,m;const{accepted_uri:b}=Dc;Or(ie,b,C=>xe(10,V=C));let x=V;const o=C=>`<svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="${C}"><path d="M480.276-96Q401-96 331-126q-70-30-122.5-82.5T126-330.958q-30-69.959-30-149.5Q96-560 126-629.5t82.5-122Q261-804 330.958-834q69.959-30 149.5-30Q560-864 629.5-834t122 82.5Q804-699 834-629.276q30 69.725 30 149Q864-401 834-331q-30 70-82.5 122.5T629.276-126q-69.725 30-149 30ZM480-168q130 0 221-91t91-221q0-130-91-221t-221-91q-130 0-221 91t-91 221q0 130 91 221t221 91Zm0 0q-130 0-221-91t-91-221q0-130 91-221t221-91q130 0 221 91t91 221q0 130-91 221t-221 91Z"/></svg>`,c=b.subscribe(C=>{x!==C&&(Ze.setStyle(C),x=V)});Jl(()=>{const C={lng:0,lat:0,zoom:5};wh.set(new bd.Map({container:m,style:x,center:[C.lng,C.lat],zoom:C.zoom})),Ze.on("load",()=>{Ze.resize()}),Ze.on("click","gl-draw-polygon-fill-inactive.cold",function(S){var Ve,Ke,at,$e;const D=Ae.get((Ve=S.features)==null?void 0:Ve[0].properties.id);if(!D)return;const L=Array.from(Ne.values()).map((ut,ot)=>{const vt=ut.properties.color_rgb_str;return`<option value="${ut.id}" data-icon="${Hp(o(vt))}">${ut.id}</option>`}),U=(Ke=[...Ne].find(ut=>ut[1].properties.spatial_object_id===D.id))==null?void 0:Ke[1],$=`
                <div id="custom-popup">
                    <div class="row">
                        <div class="input-field col s12">
                            <select id="select-canvas">
                                <option value="" disabled selected>Pick up polygon</option>
                                ${L.join(`
`)}
                            </select>
                            <label>Attach canvas polygons</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input value="${U?(at=U.properties)==null?void 0:at.road_lane_direction:-1}" id="lane-direction" type="number" class="validate">
                            <label class="active" for="lane-direction">Direction value</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input value="${U?($e=U.properties)==null?void 0:$e.road_lane_num:-1}" id="lane-number" type="number" class="validate">
                            <label class="active" for="lane-number">Lane</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12">
                            <button id="attach-canvas-btn" class="btn-small waves-effect waves-light" type="submit" name="action" onclick>Save
                                <i class="material-icons right">save</i>
                            </button>
                        </div>
                    </div>
                </div>
            `;new cd.Popup({className:"custom-popup"}).setLngLat(S.lngLat).setHTML($).addTo(Ze);const ne=document.getElementById("select-canvas");if(!ne)return;Array.from(Ne.values()).some(ut=>{if(ut.properties.spatial_object_id===D.id)return ne.value=ut.id??"No canvas ID",!0}),M.FormSelect.init(ne,{});const ye=document.getElementById("attach-canvas-btn");if(!ye){console.error("No container 'attach-canvas-btn'");return}ye.addEventListener("click",ut=>{const ot=document.getElementById("lane-direction"),vt=document.getElementById("lane-number");_(D,ne.value,{road_lane_direction:ot?parseInt(ot.value):-1,road_lane_num:vt?parseInt(vt.value):-1})})})}),Sh(()=>{c(),Ze.remove()});function h(C){Ze.addControl(C)}const p=(C,S)=>{if(S.forEach(U=>{const $={...U,properties:{color_rgb_str:U.properties.color_rgb_str},id:U.properties.spatial_object_id};C.add($)}),S.size===0)return;const D=Array.from(S.values())[0].geometry.coordinates;let L=new cd.LngLatBounds(D[0]);for(const U of D)L.extend(U);Ze.fitBounds(L,{maxZoom:18,padding:100})},_=(C,S,D={road_lane_direction:-1,road_lane_num:-1})=>{var Ve;if(S===""||S===null||S===void 0||!C.properties||!C.id)return;const L=Ne.get(S);if(!L){console.error(`ID '${S}' not found in datastorage`);return}const U=C.id,$=L.properties.spatial_object_id;if($){const Ke=Ae.get($);Ke&&(Ae.add(Ke),Ae.setFeatureProperty($,"color_rgb_str",Kl))}const ne=(Ve=[...Ne].find(Ke=>Ke[1].id!==S&&Ke[1].properties.spatial_object_id===U))==null?void 0:Ve[1];ne&&Ed(Ne,ne.id),L.properties.spatial_object_id=U,L.properties.road_lane_direction=D.road_lane_direction,L.properties.road_lane_num=D.road_lane_num;const ye=C.geometry;L.geometry.coordinates=ye.coordinates,Io(S,L),Ae.add(C),Ae.setFeatureProperty(U,"color_rgb_str",L.properties.color_rgb_str)};function u(C){gd[C?"unshift":"push"](()=>{m=C,xe(1,m)})}return ie.$$set=C=>{"klass"in C&&xe(0,s=C.klass)},[s,m,b,h,p,u]}class qp extends Ao{constructor(I){super(),Mo(this,I,Xp,Wp,Po,{klass:0,attachDraw:3,drawGeoPolygons:4})}get attachDraw(){return this.$$.ctx[3]}get drawGeoPolygons(){return this.$$.ctx[4]}}var rn={};const $p={},Yp=Object.freeze(Object.defineProperty({__proto__:null,default:$p},Symbol.toStringTag,{value:"Module"})),vh=Ap(Yp);(function(ie){/*! Fabric.js Copyright 2008-2015, Printio (Juriy Zaytsev, Maxim Chernyak) */var I=I||{version:"5.3.0"};if(ie.fabric=I,typeof document<"u"&&typeof window<"u")document instanceof(typeof HTMLDocument<"u"?HTMLDocument:Document)?I.document=document:I.document=document.implementation.createHTMLDocument(""),I.window=window;else{var xe=vh,Ae=new xe.JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;I.document=Ae.document,I.jsdomImplForWrapper=vh.implForWrapper,I.nodeCanvas=vh.Canvas,I.window=Ae,DOMParser=I.window.DOMParser}I.isTouchSupported="ontouchstart"in I.window||"ontouchstart"in I.document||I.window&&I.window.navigator&&I.window.navigator.maxTouchPoints>0,I.isLikelyNode=typeof Buffer<"u"&&typeof window>"u",I.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],I.DPI=96,I.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",I.commaWsp="(?:\\s+,?\\s*|,\\s*)",I.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/ig,I.reNonWord=/[ \n\.,;!\?\-]/,I.fontPaths={},I.iMatrix=[1,0,0,1,0,0],I.svgNS="http://www.w3.org/2000/svg",I.perfLimitSizeTotal=2097152,I.maxCacheSideLimit=4096,I.minCacheSideLimit=256,I.charWidthsCache={},I.textureSize=2048,I.disableStyleCopyPaste=!1,I.enableGLFiltering=!0,I.devicePixelRatio=I.window.devicePixelRatio||I.window.webkitDevicePixelRatio||I.window.mozDevicePixelRatio||1,I.browserShadowBlurConstant=1,I.arcToSegmentsCache={},I.boundsOfCurveCache={},I.cachesBoundsOfCurve=!0,I.forceGLPutImageData=!1,I.initFilterBackend=function(){if(I.enableGLFiltering&&I.isWebglSupported&&I.isWebglSupported(I.textureSize))return console.log("max texture size: "+I.maxTextureSize),new I.WebglFilterBackend({tileSize:I.textureSize});if(I.Canvas2dFilterBackend)return new I.Canvas2dFilterBackend},typeof document<"u"&&typeof window<"u"&&(window.fabric=I),function(){function s(h,p){if(this.__eventListeners[h]){var _=this.__eventListeners[h];p?_[_.indexOf(p)]=!1:I.util.array.fill(_,!1)}}function m(h,p){if(this.__eventListeners||(this.__eventListeners={}),arguments.length===1)for(var _ in h)this.on(_,h[_]);else this.__eventListeners[h]||(this.__eventListeners[h]=[]),this.__eventListeners[h].push(p);return this}function b(h,p){var _=(function(){p.apply(this,arguments),this.off(h,_)}).bind(this);this.on(h,_)}function x(h,p){if(arguments.length===1)for(var _ in h)b.call(this,_,h[_]);else b.call(this,h,p);return this}function o(h,p){if(!this.__eventListeners)return this;if(arguments.length===0)for(h in this.__eventListeners)s.call(this,h);else if(arguments.length===1&&typeof arguments[0]=="object")for(var _ in h)s.call(this,_,h[_]);else s.call(this,h,p);return this}function c(h,p){if(!this.__eventListeners)return this;var _=this.__eventListeners[h];if(!_)return this;for(var u=0,C=_.length;u<C;u++)_[u]&&_[u].call(this,p||{});return this.__eventListeners[h]=_.filter(function(S){return S!==!1}),this}I.Observable={fire:c,on:m,once:x,off:o}}(),I.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var s=0,m=arguments.length;s<m;s++)this._onObjectAdded(arguments[s]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(s,m,b){var x=this._objects;return b?x[m]=s:x.splice(m,0,s),this._onObjectAdded&&this._onObjectAdded(s),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var s=this._objects,m,b=!1,x=0,o=arguments.length;x<o;x++)m=s.indexOf(arguments[x]),m!==-1&&(b=!0,s.splice(m,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[x]));return this.renderOnAddRemove&&b&&this.requestRenderAll(),this},forEachObject:function(s,m){for(var b=this.getObjects(),x=0,o=b.length;x<o;x++)s.call(m,b[x],x,b);return this},getObjects:function(s){return typeof s>"u"?this._objects.concat():this._objects.filter(function(m){return m.type===s})},item:function(s){return this._objects[s]},isEmpty:function(){return this._objects.length===0},size:function(){return this._objects.length},contains:function(s,m){return this._objects.indexOf(s)>-1?!0:m?this._objects.some(function(b){return typeof b.contains=="function"&&b.contains(s,!0)}):!1},complexity:function(){return this._objects.reduce(function(s,m){return s+=m.complexity?m.complexity():0,s},0)}},I.CommonMethods={_setOptions:function(s){for(var m in s)this.set(m,s[m])},_initGradient:function(s,m){s&&s.colorStops&&!(s instanceof I.Gradient)&&this.set(m,new I.Gradient(s))},_initPattern:function(s,m,b){s&&s.source&&!(s instanceof I.Pattern)?this.set(m,new I.Pattern(s,b)):b&&b()},_setObject:function(s){for(var m in s)this._set(m,s[m])},set:function(s,m){return typeof s=="object"?this._setObject(s):this._set(s,m),this},_set:function(s,m){this[s]=m},toggle:function(s){var m=this.get(s);return typeof m=="boolean"&&this.set(s,!m),this},get:function(s){return this[s]}},function(s){var m=Math.sqrt,b=Math.atan2,x=Math.pow,o=Math.PI/180,c=Math.PI/2;I.util={cos:function(h){if(h===0)return 1;h<0&&(h=-h);var p=h/c;switch(p){case 1:case 3:return 0;case 2:return-1}return Math.cos(h)},sin:function(h){if(h===0)return 0;var p=h/c,_=1;switch(h<0&&(_=-1),p){case 1:return _;case 2:return 0;case 3:return-_}return Math.sin(h)},removeFromArray:function(h,p){var _=h.indexOf(p);return _!==-1&&h.splice(_,1),h},getRandomInt:function(h,p){return Math.floor(Math.random()*(p-h+1))+h},degreesToRadians:function(h){return h*o},radiansToDegrees:function(h){return h/o},rotatePoint:function(h,p,_){var u=new I.Point(h.x-p.x,h.y-p.y),C=I.util.rotateVector(u,_);return new I.Point(C.x,C.y).addEquals(p)},rotateVector:function(h,p){var _=I.util.sin(p),u=I.util.cos(p),C=h.x*u-h.y*_,S=h.x*_+h.y*u;return{x:C,y:S}},createVector:function(h,p){return new I.Point(p.x-h.x,p.y-h.y)},calcAngleBetweenVectors:function(h,p){return Math.acos((h.x*p.x+h.y*p.y)/(Math.hypot(h.x,h.y)*Math.hypot(p.x,p.y)))},getHatVector:function(h){return new I.Point(h.x,h.y).multiply(1/Math.hypot(h.x,h.y))},getBisector:function(h,p,_){var u=I.util.createVector(h,p),C=I.util.createVector(h,_),S=I.util.calcAngleBetweenVectors(u,C),D=I.util.calcAngleBetweenVectors(I.util.rotateVector(u,S),C),L=S*(D===0?1:-1)/2;return{vector:I.util.getHatVector(I.util.rotateVector(u,L)),angle:S}},projectStrokeOnPoints:function(h,p,_){var u=[],C=p.strokeWidth/2,S=p.strokeUniform?new I.Point(1/p.scaleX,1/p.scaleY):new I.Point(1,1),D=function(L){var U=C/Math.hypot(L.x,L.y);return new I.Point(L.x*U*S.x,L.y*U*S.y)};return h.length<=1||h.forEach(function(L,U){var $=new I.Point(L.x,L.y),ne,ye;U===0?(ye=h[U+1],ne=_?D(I.util.createVector(ye,$)).addEquals($):h[h.length-1]):U===h.length-1?(ne=h[U-1],ye=_?D(I.util.createVector(ne,$)).addEquals($):h[0]):(ne=h[U-1],ye=h[U+1]);var Ve=I.util.getBisector($,ne,ye),Ke=Ve.vector,at=Ve.angle,$e,ut;if(p.strokeLineJoin==="miter"&&($e=-C/Math.sin(at/2),ut=new I.Point(Ke.x*$e*S.x,Ke.y*$e*S.y),Math.hypot(ut.x,ut.y)/C<=p.strokeMiterLimit)){u.push($.add(ut)),u.push($.subtract(ut));return}$e=-C*Math.SQRT2,ut=new I.Point(Ke.x*$e*S.x,Ke.y*$e*S.y),u.push($.add(ut)),u.push($.subtract(ut))}),u},transformPoint:function(h,p,_){return _?new I.Point(p[0]*h.x+p[2]*h.y,p[1]*h.x+p[3]*h.y):new I.Point(p[0]*h.x+p[2]*h.y+p[4],p[1]*h.x+p[3]*h.y+p[5])},makeBoundingBoxFromPoints:function(h,p){if(p)for(var _=0;_<h.length;_++)h[_]=I.util.transformPoint(h[_],p);var u=[h[0].x,h[1].x,h[2].x,h[3].x],C=I.util.array.min(u),S=I.util.array.max(u),D=S-C,L=[h[0].y,h[1].y,h[2].y,h[3].y],U=I.util.array.min(L),$=I.util.array.max(L),ne=$-U;return{left:C,top:U,width:D,height:ne}},invertTransform:function(h){var p=1/(h[0]*h[3]-h[1]*h[2]),_=[p*h[3],-p*h[1],-p*h[2],p*h[0]],u=I.util.transformPoint({x:h[4],y:h[5]},_,!0);return _[4]=-u.x,_[5]=-u.y,_},toFixed:function(h,p){return parseFloat(Number(h).toFixed(p))},parseUnit:function(h,p){var _=/\D{0,2}$/.exec(h),u=parseFloat(h);switch(p||(p=I.Text.DEFAULT_SVG_FONT_SIZE),_[0]){case"mm":return u*I.DPI/25.4;case"cm":return u*I.DPI/2.54;case"in":return u*I.DPI;case"pt":return u*I.DPI/72;case"pc":return u*I.DPI/72*12;case"em":return u*p;default:return u}},falseFunction:function(){return!1},getKlass:function(h,p){return h=I.util.string.camelize(h.charAt(0).toUpperCase()+h.slice(1)),I.util.resolveNamespace(p)[h]},getSvgAttributes:function(h){var p=["instantiated_by_use","style","id","class"];switch(h){case"linearGradient":p=p.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":p=p.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":p=p.concat(["offset","stop-color","stop-opacity"]);break}return p},resolveNamespace:function(h){if(!h)return I;var p=h.split("."),_=p.length,u,C=s||I.window;for(u=0;u<_;++u)C=C[p[u]];return C},loadImage:function(h,p,_,u){if(!h){p&&p.call(_,h);return}var C=I.util.createImage(),S=function(){p&&p.call(_,C,!1),C=C.onload=C.onerror=null};C.onload=S,C.onerror=function(){I.log("Error loading "+C.src),p&&p.call(_,null,!0),C=C.onload=C.onerror=null},h.indexOf("data")!==0&&u!==void 0&&u!==null&&(C.crossOrigin=u),h.substring(0,14)==="data:image/svg"&&(C.onload=null,I.util.loadImageInDom(C,S)),C.src=h},loadImageInDom:function(h,p){var _=I.document.createElement("div");_.style.width=_.style.height="1px",_.style.left=_.style.top="-100%",_.style.position="absolute",_.appendChild(h),I.document.querySelector("body").appendChild(_),h.onload=function(){p(),_.parentNode.removeChild(_),_=null}},enlivenObjects:function(h,p,_,u){h=h||[];var C=[],S=0,D=h.length;function L(){++S===D&&p&&p(C.filter(function(U){return U}))}if(!D){p&&p(C);return}h.forEach(function(U,$){if(!U||!U.type){L();return}var ne=I.util.getKlass(U.type,_);ne.fromObject(U,function(ye,Ve){Ve||(C[$]=ye),u&&u(U,ye,Ve),L()})})},enlivenObjectEnlivables:function(h,p,_){var u=I.Object.ENLIVEN_PROPS.filter(function(C){return!!h[C]});I.util.enlivenObjects(u.map(function(C){return h[C]}),function(C){var S={};u.forEach(function(D,L){S[D]=C[L],p&&(p[D]=C[L])}),_&&_(S)})},enlivenPatterns:function(h,p){h=h||[];function _(){++C===S&&p&&p(u)}var u=[],C=0,S=h.length;if(!S){p&&p(u);return}h.forEach(function(D,L){D&&D.source?new I.Pattern(D,function(U){u[L]=U,_()}):(u[L]=D,_())})},groupSVGElements:function(h,p,_){var u;return h&&h.length===1?(typeof _<"u"&&(h[0].sourcePath=_),h[0]):(p&&(p.width&&p.height?p.centerPoint={x:p.width/2,y:p.height/2}:(delete p.width,delete p.height)),u=new I.Group(h,p),typeof _<"u"&&(u.sourcePath=_),u)},populateWithProperties:function(h,p,_){if(_&&Array.isArray(_))for(var u=0,C=_.length;u<C;u++)_[u]in h&&(p[_[u]]=h[_[u]])},createCanvasElement:function(){return I.document.createElement("canvas")},copyCanvasElement:function(h){var p=I.util.createCanvasElement();return p.width=h.width,p.height=h.height,p.getContext("2d").drawImage(h,0,0),p},toDataURL:function(h,p,_){return h.toDataURL("image/"+p,_)},createImage:function(){return I.document.createElement("img")},multiplyTransformMatrices:function(h,p,_){return[h[0]*p[0]+h[2]*p[1],h[1]*p[0]+h[3]*p[1],h[0]*p[2]+h[2]*p[3],h[1]*p[2]+h[3]*p[3],_?0:h[0]*p[4]+h[2]*p[5]+h[4],_?0:h[1]*p[4]+h[3]*p[5]+h[5]]},qrDecompose:function(h){var p=b(h[1],h[0]),_=x(h[0],2)+x(h[1],2),u=m(_),C=(h[0]*h[3]-h[2]*h[1])/u,S=b(h[0]*h[2]+h[1]*h[3],_);return{angle:p/o,scaleX:u,scaleY:C,skewX:S/o,skewY:0,translateX:h[4],translateY:h[5]}},calcRotateMatrix:function(h){if(!h.angle)return I.iMatrix.concat();var p=I.util.degreesToRadians(h.angle),_=I.util.cos(p),u=I.util.sin(p);return[_,u,-u,_,0,0]},calcDimensionsMatrix:function(h){var p=typeof h.scaleX>"u"?1:h.scaleX,_=typeof h.scaleY>"u"?1:h.scaleY,u=[h.flipX?-p:p,0,0,h.flipY?-_:_,0,0],C=I.util.multiplyTransformMatrices,S=I.util.degreesToRadians;return h.skewX&&(u=C(u,[1,0,Math.tan(S(h.skewX)),1],!0)),h.skewY&&(u=C(u,[1,Math.tan(S(h.skewY)),0,1],!0)),u},composeMatrix:function(h){var p=[1,0,0,1,h.translateX||0,h.translateY||0],_=I.util.multiplyTransformMatrices;return h.angle&&(p=_(p,I.util.calcRotateMatrix(h))),(h.scaleX!==1||h.scaleY!==1||h.skewX||h.skewY||h.flipX||h.flipY)&&(p=_(p,I.util.calcDimensionsMatrix(h))),p},resetObjectTransform:function(h){h.scaleX=1,h.scaleY=1,h.skewX=0,h.skewY=0,h.flipX=!1,h.flipY=!1,h.rotate(0)},saveObjectTransform:function(h){return{scaleX:h.scaleX,scaleY:h.scaleY,skewX:h.skewX,skewY:h.skewY,angle:h.angle,left:h.left,flipX:h.flipX,flipY:h.flipY,top:h.top}},isTransparent:function(h,p,_,u){u>0&&(p>u?p-=u:p=0,_>u?_-=u:_=0);var C=!0,S,D,L=h.getImageData(p,_,u*2||1,u*2||1),U=L.data.length;for(S=3;S<U&&(D=L.data[S],C=D<=0,C!==!1);S+=4);return L=null,C},parsePreserveAspectRatioAttribute:function(h){var p="meet",_="Mid",u="Mid",C=h.split(" "),S;return C&&C.length&&(p=C.pop(),p!=="meet"&&p!=="slice"?(S=p,p="meet"):C.length&&(S=C.pop())),_=S!=="none"?S.slice(1,4):"none",u=S!=="none"?S.slice(5,8):"none",{meetOrSlice:p,alignX:_,alignY:u}},clearFabricFontCache:function(h){h=(h||"").toLowerCase(),h?I.charWidthsCache[h]&&delete I.charWidthsCache[h]:I.charWidthsCache={}},limitDimsByArea:function(h,p){var _=Math.sqrt(p*h),u=Math.floor(p/_);return{x:Math.floor(_),y:u}},capValue:function(h,p,_){return Math.max(h,Math.min(p,_))},findScaleToFit:function(h,p){return Math.min(p.width/h.width,p.height/h.height)},findScaleToCover:function(h,p){return Math.max(p.width/h.width,p.height/h.height)},matrixToSVG:function(h){return"matrix("+h.map(function(p){return I.util.toFixed(p,I.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(h,p){var _=I.util.invertTransform(p),u=I.util.multiplyTransformMatrices(_,h.calcOwnMatrix());I.util.applyTransformToObject(h,u)},addTransformToObject:function(h,p){I.util.applyTransformToObject(h,I.util.multiplyTransformMatrices(p,h.calcOwnMatrix()))},applyTransformToObject:function(h,p){var _=I.util.qrDecompose(p),u=new I.Point(_.translateX,_.translateY);h.flipX=!1,h.flipY=!1,h.set("scaleX",_.scaleX),h.set("scaleY",_.scaleY),h.skewX=_.skewX,h.skewY=_.skewY,h.angle=_.angle,h.setPositionByOrigin(u,"center","center")},sizeAfterTransform:function(h,p,_){var u=h/2,C=p/2,S=[{x:-u,y:-C},{x:u,y:-C},{x:-u,y:C},{x:u,y:C}],D=I.util.calcDimensionsMatrix(_),L=I.util.makeBoundingBoxFromPoints(S,D);return{x:L.width,y:L.height}},mergeClipPaths:function(h,p){var _=h,u=p;_.inverted&&!u.inverted&&(_=p,u=h),I.util.applyTransformToObject(u,I.util.multiplyTransformMatrices(I.util.invertTransform(_.calcTransformMatrix()),u.calcTransformMatrix()));var C=_.inverted&&u.inverted;return C&&(_.inverted=u.inverted=!1),new I.Group([_],{clipPath:u,inverted:C})},hasStyleChanged:function(h,p,_){return _=_||!1,h.fill!==p.fill||h.stroke!==p.stroke||h.strokeWidth!==p.strokeWidth||h.fontSize!==p.fontSize||h.fontFamily!==p.fontFamily||h.fontWeight!==p.fontWeight||h.fontStyle!==p.fontStyle||h.textBackgroundColor!==p.textBackgroundColor||h.deltaY!==p.deltaY||_&&(h.overline!==p.overline||h.underline!==p.underline||h.linethrough!==p.linethrough)},stylesToArray:function(_,p){for(var _=I.util.object.clone(_,!0),u=p.split(`
`),C=-1,S={},D=[],L=0;L<u.length;L++){if(!_[L]){C+=u[L].length;continue}for(var U=0;U<u[L].length;U++){C++;var $=_[L][U];if($&&Object.keys($).length>0){var ne=I.util.hasStyleChanged(S,$,!0);ne?D.push({start:C,end:C+1,style:$}):D[D.length-1].end++}S=$||{}}}return D},stylesFromArray:function(h,p){if(!Array.isArray(h))return h;for(var _=p.split(`
`),u=-1,C=0,S={},D=0;D<_.length;D++)for(var L=0;L<_[D].length;L++)u++,h[C]&&h[C].start<=u&&u<h[C].end&&(S[D]=S[D]||{},S[D][L]=Object.assign({},h[C].style),u===h[C].end-1&&C++);return S}}}(ie),function(){var s=Array.prototype.join,m={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},b={m:"l",M:"L"};function x(Q,de,_e,pe,Re,fe,ee,Ce,Le,Je,Ue){var Ge=I.util.cos(Q),dt=I.util.sin(Q),At=I.util.cos(de),Ye=I.util.sin(de),Oe=_e*Re*At-pe*fe*Ye+ee,Qe=pe*Re*At+_e*fe*Ye+Ce,Xe=Je+Le*(-_e*Re*dt-pe*fe*Ge),le=Ue+Le*(-pe*Re*dt+_e*fe*Ge),it=Oe+Le*(_e*Re*Ye+pe*fe*At),bt=Qe+Le*(pe*Re*Ye-_e*fe*At);return["C",Xe,le,it,bt,Oe,Qe]}function o(Q,de,_e,pe,Re,fe,ee){var Ce=Math.PI,Le=ee*Ce/180,Je=I.util.sin(Le),Ue=I.util.cos(Le),Ge=0,dt=0;_e=Math.abs(_e),pe=Math.abs(pe);var At=-Ue*Q*.5-Je*de*.5,Ye=-Ue*de*.5+Je*Q*.5,Oe=_e*_e,Qe=pe*pe,Xe=Ye*Ye,le=At*At,it=Oe*Qe-Oe*Xe-Qe*le,bt=0;if(it<0){var Pt=Math.sqrt(1-it/(Oe*Qe));_e*=Pt,pe*=Pt}else bt=(Re===fe?-1:1)*Math.sqrt(it/(Oe*Xe+Qe*le));var Ot=bt*_e*Ye/pe,nt=-bt*pe*At/_e,qt=Ue*Ot-Je*nt+Q*.5,Yt=Je*Ot+Ue*nt+de*.5,gi=c(1,0,(At-Ot)/_e,(Ye-nt)/pe),xi=c((At-Ot)/_e,(Ye-nt)/pe,(-At-Ot)/_e,(-Ye-nt)/pe);fe===0&&xi>0?xi-=2*Ce:fe===1&&xi<0&&(xi+=2*Ce);for(var fi=Math.ceil(Math.abs(xi/Ce*2)),Gi=[],ht=xi/fi,Hi=8/3*Math.sin(ht/4)*Math.sin(ht/4)/Math.sin(ht/2),Zt=gi+ht,bi=0;bi<fi;bi++)Gi[bi]=x(gi,Zt,Ue,Je,_e,pe,qt,Yt,Hi,Ge,dt),Ge=Gi[bi][5],dt=Gi[bi][6],gi=Zt,Zt+=ht;return Gi}function c(Q,de,_e,pe){var Re=Math.atan2(de,Q),fe=Math.atan2(pe,_e);return fe>=Re?fe-Re:2*Math.PI-(Re-fe)}function h(Q,de,_e,pe,Re,fe,ee,Ce){var Le;if(I.cachesBoundsOfCurve&&(Le=s.call(arguments),I.boundsOfCurveCache[Le]))return I.boundsOfCurveCache[Le];var Je=Math.sqrt,Ue=Math.min,Ge=Math.max,dt=Math.abs,At=[],Ye=[[],[]],Oe,Qe,Xe,le,it,bt,Pt,Ot;Qe=6*Q-12*_e+6*Re,Oe=-3*Q+9*_e-9*Re+3*ee,Xe=3*_e-3*Q;for(var nt=0;nt<2;++nt){if(nt>0&&(Qe=6*de-12*pe+6*fe,Oe=-3*de+9*pe-9*fe+3*Ce,Xe=3*pe-3*de),dt(Oe)<1e-12){if(dt(Qe)<1e-12)continue;le=-Xe/Qe,0<le&&le<1&&At.push(le);continue}Pt=Qe*Qe-4*Xe*Oe,!(Pt<0)&&(Ot=Je(Pt),it=(-Qe+Ot)/(2*Oe),0<it&&it<1&&At.push(it),bt=(-Qe-Ot)/(2*Oe),0<bt&&bt<1&&At.push(bt))}for(var qt,Yt,gi=At.length,xi=gi,fi;gi--;)le=At[gi],fi=1-le,qt=fi*fi*fi*Q+3*fi*fi*le*_e+3*fi*le*le*Re+le*le*le*ee,Ye[0][gi]=qt,Yt=fi*fi*fi*de+3*fi*fi*le*pe+3*fi*le*le*fe+le*le*le*Ce,Ye[1][gi]=Yt;Ye[0][xi]=Q,Ye[1][xi]=de,Ye[0][xi+1]=ee,Ye[1][xi+1]=Ce;var Gi=[{x:Ue.apply(null,Ye[0]),y:Ue.apply(null,Ye[1])},{x:Ge.apply(null,Ye[0]),y:Ge.apply(null,Ye[1])}];return I.cachesBoundsOfCurve&&(I.boundsOfCurveCache[Le]=Gi),Gi}function p(Q,de,_e){for(var pe=_e[1],Re=_e[2],fe=_e[3],ee=_e[4],Ce=_e[5],Le=_e[6],Je=_e[7],Ue=o(Le-Q,Je-de,pe,Re,ee,Ce,fe),Ge=0,dt=Ue.length;Ge<dt;Ge++)Ue[Ge][1]+=Q,Ue[Ge][2]+=de,Ue[Ge][3]+=Q,Ue[Ge][4]+=de,Ue[Ge][5]+=Q,Ue[Ge][6]+=de;return Ue}function _(Q){var de=0,_e=0,pe=Q.length,Re=0,fe=0,ee,Ce,Le,Je=[],Ue,Ge,dt;for(Ce=0;Ce<pe;++Ce){switch(Le=!1,ee=Q[Ce].slice(0),ee[0]){case"l":ee[0]="L",ee[1]+=de,ee[2]+=_e;case"L":de=ee[1],_e=ee[2];break;case"h":ee[1]+=de;case"H":ee[0]="L",ee[2]=_e,de=ee[1];break;case"v":ee[1]+=_e;case"V":ee[0]="L",_e=ee[1],ee[1]=de,ee[2]=_e;break;case"m":ee[0]="M",ee[1]+=de,ee[2]+=_e;case"M":de=ee[1],_e=ee[2],Re=ee[1],fe=ee[2];break;case"c":ee[0]="C",ee[1]+=de,ee[2]+=_e,ee[3]+=de,ee[4]+=_e,ee[5]+=de,ee[6]+=_e;case"C":Ge=ee[3],dt=ee[4],de=ee[5],_e=ee[6];break;case"s":ee[0]="S",ee[1]+=de,ee[2]+=_e,ee[3]+=de,ee[4]+=_e;case"S":Ue==="C"?(Ge=2*de-Ge,dt=2*_e-dt):(Ge=de,dt=_e),de=ee[3],_e=ee[4],ee[0]="C",ee[5]=ee[3],ee[6]=ee[4],ee[3]=ee[1],ee[4]=ee[2],ee[1]=Ge,ee[2]=dt,Ge=ee[3],dt=ee[4];break;case"q":ee[0]="Q",ee[1]+=de,ee[2]+=_e,ee[3]+=de,ee[4]+=_e;case"Q":Ge=ee[1],dt=ee[2],de=ee[3],_e=ee[4];break;case"t":ee[0]="T",ee[1]+=de,ee[2]+=_e;case"T":Ue==="Q"?(Ge=2*de-Ge,dt=2*_e-dt):(Ge=de,dt=_e),ee[0]="Q",de=ee[1],_e=ee[2],ee[1]=Ge,ee[2]=dt,ee[3]=de,ee[4]=_e;break;case"a":ee[0]="A",ee[6]+=de,ee[7]+=_e;case"A":Le=!0,Je=Je.concat(p(de,_e,ee)),de=ee[6],_e=ee[7];break;case"z":case"Z":de=Re,_e=fe;break}Le||Je.push(ee),Ue=ee[0]}return Je}function u(Q,de,_e,pe){return Math.sqrt((_e-Q)*(_e-Q)+(pe-de)*(pe-de))}function C(Q){return Q*Q*Q}function S(Q){return 3*Q*Q*(1-Q)}function D(Q){return 3*Q*(1-Q)*(1-Q)}function L(Q){return(1-Q)*(1-Q)*(1-Q)}function U(Q,de,_e,pe,Re,fe,ee,Ce){return function(Le){var Je=C(Le),Ue=S(Le),Ge=D(Le),dt=L(Le);return{x:ee*Je+Re*Ue+_e*Ge+Q*dt,y:Ce*Je+fe*Ue+pe*Ge+de*dt}}}function $(Q,de,_e,pe,Re,fe,ee,Ce){return function(Le){var Je=1-Le,Ue=3*Je*Je*(_e-Q)+6*Je*Le*(Re-_e)+3*Le*Le*(ee-Re),Ge=3*Je*Je*(pe-de)+6*Je*Le*(fe-pe)+3*Le*Le*(Ce-fe);return Math.atan2(Ge,Ue)}}function ne(Q){return Q*Q}function ye(Q){return 2*Q*(1-Q)}function Ve(Q){return(1-Q)*(1-Q)}function Ke(Q,de,_e,pe,Re,fe){return function(ee){var Ce=ne(ee),Le=ye(ee),Je=Ve(ee);return{x:Re*Ce+_e*Le+Q*Je,y:fe*Ce+pe*Le+de*Je}}}function at(Q,de,_e,pe,Re,fe){return function(ee){var Ce=1-ee,Le=2*Ce*(_e-Q)+2*ee*(Re-_e),Je=2*Ce*(pe-de)+2*ee*(fe-pe);return Math.atan2(Je,Le)}}function $e(Q,de,_e){var pe={x:de,y:_e},Re,fe=0,ee;for(ee=1;ee<=100;ee+=1)Re=Q(ee/100),fe+=u(pe.x,pe.y,Re.x,Re.y),pe=Re;return fe}function ut(Q,de){for(var _e=0,pe=0,Re=Q.iterator,fe={x:Q.x,y:Q.y},ee,Ce,Le=.01,Je=Q.angleFinder,Ue;pe<de&&Le>1e-4;)ee=Re(_e),Ue=_e,Ce=u(fe.x,fe.y,ee.x,ee.y),Ce+pe>de?(_e-=Le,Le/=2):(fe=ee,_e+=Le,pe+=Ce);return ee.angle=Je(Ue),ee}function ot(Q){for(var de=0,_e=Q.length,pe,Re=0,fe=0,ee=0,Ce=0,Le=[],Je,Ue,Ge,dt=0;dt<_e;dt++){switch(pe=Q[dt],Ue={x:Re,y:fe,command:pe[0]},pe[0]){case"M":Ue.length=0,ee=Re=pe[1],Ce=fe=pe[2];break;case"L":Ue.length=u(Re,fe,pe[1],pe[2]),Re=pe[1],fe=pe[2];break;case"C":Je=U(Re,fe,pe[1],pe[2],pe[3],pe[4],pe[5],pe[6]),Ge=$(Re,fe,pe[1],pe[2],pe[3],pe[4],pe[5],pe[6]),Ue.iterator=Je,Ue.angleFinder=Ge,Ue.length=$e(Je,Re,fe),Re=pe[5],fe=pe[6];break;case"Q":Je=Ke(Re,fe,pe[1],pe[2],pe[3],pe[4]),Ge=at(Re,fe,pe[1],pe[2],pe[3],pe[4]),Ue.iterator=Je,Ue.angleFinder=Ge,Ue.length=$e(Je,Re,fe),Re=pe[3],fe=pe[4];break;case"Z":case"z":Ue.destX=ee,Ue.destY=Ce,Ue.length=u(Re,fe,ee,Ce),Re=ee,fe=Ce;break}de+=Ue.length,Le.push(Ue)}return Le.push({length:de,x:Re,y:fe}),Le}function vt(Q,de,_e){_e||(_e=ot(Q));for(var pe=0;de-_e[pe].length>0&&pe<_e.length-2;)de-=_e[pe].length,pe++;var Re=_e[pe],fe=de/Re.length,ee=Re.command,Ce=Q[pe],Le;switch(ee){case"M":return{x:Re.x,y:Re.y,angle:0};case"Z":case"z":return Le=new I.Point(Re.x,Re.y).lerp(new I.Point(Re.destX,Re.destY),fe),Le.angle=Math.atan2(Re.destY-Re.y,Re.destX-Re.x),Le;case"L":return Le=new I.Point(Re.x,Re.y).lerp(new I.Point(Ce[1],Ce[2]),fe),Le.angle=Math.atan2(Ce[2]-Re.y,Ce[1]-Re.x),Le;case"C":return ut(Re,de);case"Q":return ut(Re,de)}}function St(Q){var de=[],_e=[],pe,Re,fe=I.rePathCommand,ee="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",Ce="("+ee+")"+I.commaWsp,Le="([01])"+I.commaWsp+"?",Je=Ce+"?"+Ce+"?"+Ce+Le+Le+Ce+"?("+ee+")",Ue=new RegExp(Je,"g"),Ge,dt,At;if(!Q||!Q.match)return de;At=Q.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi);for(var Ye=0,Oe,Qe=At.length;Ye<Qe;Ye++){pe=At[Ye],dt=pe.slice(1).trim(),_e.length=0;var Xe=pe.charAt(0);if(Oe=[Xe],Xe.toLowerCase()==="a")for(var le;le=Ue.exec(dt);)for(var it=1;it<le.length;it++)_e.push(le[it]);else for(;Ge=fe.exec(dt);)_e.push(Ge[0]);for(var it=0,bt=_e.length;it<bt;it++)Re=parseFloat(_e[it]),isNaN(Re)||Oe.push(Re);var Pt=m[Xe.toLowerCase()],Ot=b[Xe]||Xe;if(Oe.length-1>Pt)for(var nt=1,qt=Oe.length;nt<qt;nt+=Pt)de.push([Xe].concat(Oe.slice(nt,nt+Pt))),Xe=Ot;else de.push(Oe)}return de}function ct(Q,de){var _e=[],pe,Re=new I.Point(Q[0].x,Q[0].y),fe=new I.Point(Q[1].x,Q[1].y),ee=Q.length,Ce=1,Le=0,Je=ee>2;for(de=de||0,Je&&(Ce=Q[2].x<fe.x?-1:Q[2].x===fe.x?0:1,Le=Q[2].y<fe.y?-1:Q[2].y===fe.y?0:1),_e.push(["M",Re.x-Ce*de,Re.y-Le*de]),pe=1;pe<ee;pe++){if(!Re.eq(fe)){var Ue=Re.midPointFrom(fe);_e.push(["Q",Re.x,Re.y,Ue.x,Ue.y])}Re=Q[pe],pe+1<Q.length&&(fe=Q[pe+1])}return Je&&(Ce=Re.x>Q[pe-2].x?1:Re.x===Q[pe-2].x?0:-1,Le=Re.y>Q[pe-2].y?1:Re.y===Q[pe-2].y?0:-1),_e.push(["L",Re.x+Ce*de,Re.y+Le*de]),_e}function Et(Q,de,_e){return _e&&(de=I.util.multiplyTransformMatrices(de,[1,0,0,1,-_e.x,-_e.y])),Q.map(function(pe){for(var Re=pe.slice(0),fe={},ee=1;ee<pe.length-1;ee+=2)fe.x=pe[ee],fe.y=pe[ee+1],fe=I.util.transformPoint(fe,de),Re[ee]=fe.x,Re[ee+1]=fe.y;return Re})}I.util.joinPath=function(Q){return Q.map(function(de){return de.join(" ")}).join(" ")},I.util.parsePath=St,I.util.makePathSimpler=_,I.util.getSmoothPathFromPoints=ct,I.util.getPathSegmentsInfo=ot,I.util.getBoundsOfCurve=h,I.util.getPointOnPath=vt,I.util.transformPath=Et}(),function(){var s=Array.prototype.slice;function m(h,p){for(var _=s.call(arguments,2),u=[],C=0,S=h.length;C<S;C++)u[C]=_.length?h[C][p].apply(h[C],_):h[C][p].call(h[C]);return u}function b(h,p){return c(h,p,function(_,u){return _>=u})}function x(h,p){return c(h,p,function(_,u){return _<u})}function o(h,p){for(var _=h.length;_--;)h[_]=p;return h}function c(h,p,_){if(!(!h||h.length===0)){var u=h.length-1,C=p?h[u][p]:h[u];if(p)for(;u--;)_(h[u][p],C)&&(C=h[u][p]);else for(;u--;)_(h[u],C)&&(C=h[u]);return C}}I.util.array={fill:o,invoke:m,min:x,max:b}}(),function(){function s(b,x,o){if(o)if(!I.isLikelyNode&&x instanceof Element)b=x;else if(x instanceof Array){b=[];for(var c=0,h=x.length;c<h;c++)b[c]=s({},x[c],o)}else if(x&&typeof x=="object")for(var p in x)p==="canvas"||p==="group"?b[p]=null:x.hasOwnProperty(p)&&(b[p]=s({},x[p],o));else b=x;else for(var p in x)b[p]=x[p];return b}function m(b,x){return s({},b,x)}I.util.object={extend:s,clone:m},I.util.object.extend(I.util,I.Observable)}(),function(){function s(c){return c.replace(/-+(.)?/g,function(h,p){return p?p.toUpperCase():""})}function m(c,h){return c.charAt(0).toUpperCase()+(h?c.slice(1):c.slice(1).toLowerCase())}function b(c){return c.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function x(c){var h=0,p,_=[];for(h=0,p;h<c.length;h++)(p=o(c,h))!==!1&&_.push(p);return _}function o(c,h){var p=c.charCodeAt(h);if(isNaN(p))return"";if(p<55296||p>57343)return c.charAt(h);if(55296<=p&&p<=56319){if(c.length<=h+1)throw"High surrogate without following low surrogate";var _=c.charCodeAt(h+1);if(56320>_||_>57343)throw"High surrogate without following low surrogate";return c.charAt(h)+c.charAt(h+1)}if(h===0)throw"Low surrogate without preceding high surrogate";var u=c.charCodeAt(h-1);if(55296>u||u>56319)throw"Low surrogate without preceding high surrogate";return!1}I.util.string={camelize:s,capitalize:m,escapeXml:b,graphemeSplit:x}}(),function(){var s=Array.prototype.slice,m=function(){},b=function(){for(var p in{toString:1})if(p==="toString")return!1;return!0}(),x=function(p,_,u){for(var C in _)C in p.prototype&&typeof p.prototype[C]=="function"&&(_[C]+"").indexOf("callSuper")>-1?p.prototype[C]=function(S){return function(){var D=this.constructor.superclass;this.constructor.superclass=u;var L=_[S].apply(this,arguments);if(this.constructor.superclass=D,S!=="initialize")return L}}(C):p.prototype[C]=_[C],b&&(_.toString!==Object.prototype.toString&&(p.prototype.toString=_.toString),_.valueOf!==Object.prototype.valueOf&&(p.prototype.valueOf=_.valueOf))};function o(){}function c(p){for(var _=null,u=this;u.constructor.superclass;){var C=u.constructor.superclass.prototype[p];if(u[p]!==C){_=C;break}u=u.constructor.superclass.prototype}return _?arguments.length>1?_.apply(this,s.call(arguments,1)):_.call(this):console.log("tried to callSuper "+p+", method not found in prototype chain",this)}function h(){var p=null,_=s.call(arguments,0);typeof _[0]=="function"&&(p=_.shift());function u(){this.initialize.apply(this,arguments)}u.superclass=p,u.subclasses=[],p&&(o.prototype=p.prototype,u.prototype=new o,p.subclasses.push(u));for(var C=0,S=_.length;C<S;C++)x(u,_[C],p);return u.prototype.initialize||(u.prototype.initialize=m),u.prototype.constructor=u,u.prototype.callSuper=c,u}I.util.createClass=h}(),function(){var s=!!I.document.createElement("div").attachEvent,m=["touchstart","touchmove","touchend"];I.util.addListener=function(x,o,c,h){x&&x.addEventListener(o,c,s?!1:h)},I.util.removeListener=function(x,o,c,h){x&&x.removeEventListener(o,c,s?!1:h)};function b(x){var o=x.changedTouches;return o&&o[0]?o[0]:x}I.util.getPointer=function(x){var o=x.target,c=I.util.getScrollLeftTop(o),h=b(x);return{x:h.clientX+c.left,y:h.clientY+c.top}},I.util.isTouchEvent=function(x){return m.indexOf(x.type)>-1||x.pointerType==="touch"}}(),function(){function s(h,p){var _=h.style;if(!_)return h;if(typeof p=="string")return h.style.cssText+=";"+p,p.indexOf("opacity")>-1?c(h,p.match(/opacity:\s*(\d?\.?\d*)/)[1]):h;for(var u in p)if(u==="opacity")c(h,p[u]);else{var C=u==="float"||u==="cssFloat"?typeof _.styleFloat>"u"?"cssFloat":"styleFloat":u;_.setProperty(C,p[u])}return h}var m=I.document.createElement("div"),b=typeof m.style.opacity=="string",x=typeof m.style.filter=="string",o=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,c=function(h){return h};b?c=function(h,p){return h.style.opacity=p,h}:x&&(c=function(h,p){var _=h.style;return h.currentStyle&&!h.currentStyle.hasLayout&&(_.zoom=1),o.test(_.filter)?(p=p>=.9999?"":"alpha(opacity="+p*100+")",_.filter=_.filter.replace(o,p)):_.filter+=" alpha(opacity="+p*100+")",h}),I.util.setStyle=s}(),function(){var s=Array.prototype.slice;function m(L){return typeof L=="string"?I.document.getElementById(L):L}var b,x=function(L){return s.call(L,0)};try{b=x(I.document.childNodes)instanceof Array}catch{}b||(x=function(L){for(var U=new Array(L.length),$=L.length;$--;)U[$]=L[$];return U});function o(L,U){var $=I.document.createElement(L);for(var ne in U)ne==="class"?$.className=U[ne]:ne==="for"?$.htmlFor=U[ne]:$.setAttribute(ne,U[ne]);return $}function c(L,U){L&&(" "+L.className+" ").indexOf(" "+U+" ")===-1&&(L.className+=(L.className?" ":"")+U)}function h(L,U,$){return typeof U=="string"&&(U=o(U,$)),L.parentNode&&L.parentNode.replaceChild(U,L),U.appendChild(L),U}function p(L){for(var U=0,$=0,ne=I.document.documentElement,ye=I.document.body||{scrollLeft:0,scrollTop:0};L&&(L.parentNode||L.host)&&(L=L.parentNode||L.host,L===I.document?(U=ye.scrollLeft||ne.scrollLeft||0,$=ye.scrollTop||ne.scrollTop||0):(U+=L.scrollLeft||0,$+=L.scrollTop||0),!(L.nodeType===1&&L.style.position==="fixed")););return{left:U,top:$}}function _(L){var U,$=L&&L.ownerDocument,ne={left:0,top:0},ye={left:0,top:0},Ve,Ke={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!$)return ye;for(var at in Ke)ye[Ke[at]]+=parseInt(u(L,at),10)||0;return U=$.documentElement,typeof L.getBoundingClientRect<"u"&&(ne=L.getBoundingClientRect()),Ve=p(L),{left:ne.left+Ve.left-(U.clientLeft||0)+ye.left,top:ne.top+Ve.top-(U.clientTop||0)+ye.top}}var u;I.document.defaultView&&I.document.defaultView.getComputedStyle?u=function(L,U){var $=I.document.defaultView.getComputedStyle(L,null);return $?$[U]:void 0}:u=function(L,U){var $=L.style[U];return!$&&L.currentStyle&&($=L.currentStyle[U]),$},function(){var L=I.document.documentElement.style,U="userSelect"in L?"userSelect":"MozUserSelect"in L?"MozUserSelect":"WebkitUserSelect"in L?"WebkitUserSelect":"KhtmlUserSelect"in L?"KhtmlUserSelect":"";function $(ye){return typeof ye.onselectstart<"u"&&(ye.onselectstart=I.util.falseFunction),U?ye.style[U]="none":typeof ye.unselectable=="string"&&(ye.unselectable="on"),ye}function ne(ye){return typeof ye.onselectstart<"u"&&(ye.onselectstart=null),U?ye.style[U]="":typeof ye.unselectable=="string"&&(ye.unselectable=""),ye}I.util.makeElementUnselectable=$,I.util.makeElementSelectable=ne}();function C(L){var U=I.jsdomImplForWrapper(L);return U._canvas||U._image}function S(L){if(I.isLikelyNode){var U=I.jsdomImplForWrapper(L);U&&(U._image=null,U._canvas=null,U._currentSrc=null,U._attributes=null,U._classList=null)}}function D(L,U){L.imageSmoothingEnabled=L.imageSmoothingEnabled||L.webkitImageSmoothingEnabled||L.mozImageSmoothingEnabled||L.msImageSmoothingEnabled||L.oImageSmoothingEnabled,L.imageSmoothingEnabled=U}I.util.setImageSmoothing=D,I.util.getById=m,I.util.toArray=x,I.util.addClass=c,I.util.makeElement=o,I.util.wrapElement=h,I.util.getScrollLeftTop=p,I.util.getElementOffset=_,I.util.getNodeCanvas=C,I.util.cleanUpJsdomNode=S}(),function(){function s(x,o){return x+(/\?/.test(x)?"&":"?")+o}function m(){}function b(x,o){o||(o={});var c=o.method?o.method.toUpperCase():"GET",h=o.onComplete||function(){},p=new I.window.XMLHttpRequest,_=o.body||o.parameters;return p.onreadystatechange=function(){p.readyState===4&&(h(p),p.onreadystatechange=m)},c==="GET"&&(_=null,typeof o.parameters=="string"&&(x=s(x,o.parameters))),p.open(c,x,!0),(c==="POST"||c==="PUT")&&p.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),p.send(_),p}I.util.request=b}(),I.log=console.log,I.warn=console.warn,function(){var s=I.util.object.extend,m=I.util.object.clone,b=[];I.util.object.extend(b,{cancelAll:function(){var C=this.splice(0);return C.forEach(function(S){S.cancel()}),C},cancelByCanvas:function(C){if(!C)return[];var S=this.filter(function(D){return typeof D.target=="object"&&D.target.canvas===C});return S.forEach(function(D){D.cancel()}),S},cancelByTarget:function(C){var S=this.findAnimationsByTarget(C);return S.forEach(function(D){D.cancel()}),S},findAnimationIndex:function(C){return this.indexOf(this.findAnimation(C))},findAnimation:function(C){return this.find(function(S){return S.cancel===C})},findAnimationsByTarget:function(C){return C?this.filter(function(S){return S.target===C}):[]}});function x(){return!1}function o(C,S,D,L){return-D*Math.cos(C/L*(Math.PI/2))+D+S}function c(C){C||(C={});var S=!1,D,L=function(){var U=I.runningAnimations.indexOf(D);return U>-1&&I.runningAnimations.splice(U,1)[0]};return D=s(m(C),{cancel:function(){return S=!0,L()},currentValue:"startValue"in C?C.startValue:0,completionRate:0,durationRate:0}),I.runningAnimations.push(D),_(function(U){var $=U||+new Date,ne=C.duration||500,ye=$+ne,Ve,Ke=C.onChange||x,at=C.abort||x,$e=C.onComplete||x,ut=C.easing||o,ot="startValue"in C?C.startValue.length>0:!1,vt="startValue"in C?C.startValue:0,St="endValue"in C?C.endValue:100,ct=C.byValue||(ot?vt.map(function(Et,Q){return St[Q]-vt[Q]}):St-vt);C.onStart&&C.onStart(),function Et(Q){Ve=Q||+new Date;var de=Ve>ye?ne:Ve-$,_e=de/ne,pe=ot?vt.map(function(fe,ee){return ut(de,vt[ee],ct[ee],ne)}):ut(de,vt,ct,ne),Re=Math.abs(ot?(pe[0]-vt[0])/ct[0]:(pe-vt)/ct);if(D.currentValue=ot?pe.slice():pe,D.completionRate=Re,D.durationRate=_e,!S){if(at(pe,Re,_e)){L();return}if(Ve>ye){D.currentValue=ot?St.slice():St,D.completionRate=1,D.durationRate=1,Ke(ot?St.slice():St,1,1),$e(St,1,1),L();return}else Ke(pe,Re,_e),_(Et)}}($)}),D.cancel}var h=I.window.requestAnimationFrame||I.window.webkitRequestAnimationFrame||I.window.mozRequestAnimationFrame||I.window.oRequestAnimationFrame||I.window.msRequestAnimationFrame||function(C){return I.window.setTimeout(C,1e3/60)},p=I.window.cancelAnimationFrame||I.window.clearTimeout;function _(){return h.apply(I.window,arguments)}function u(){return p.apply(I.window,arguments)}I.util.animate=c,I.util.requestAnimFrame=_,I.util.cancelAnimFrame=u,I.runningAnimations=b}(),function(){function s(b,x,o){var c="rgba("+parseInt(b[0]+o*(x[0]-b[0]),10)+","+parseInt(b[1]+o*(x[1]-b[1]),10)+","+parseInt(b[2]+o*(x[2]-b[2]),10);return c+=","+(b&&x?parseFloat(b[3]+o*(x[3]-b[3])):1),c+=")",c}function m(b,x,o,c){var h=new I.Color(b).getSource(),p=new I.Color(x).getSource(),_=c.onComplete,u=c.onChange;return c=c||{},I.util.animate(I.util.object.extend(c,{duration:o||500,startValue:h,endValue:p,byValue:p,easing:function(C,S,D,L){var U=c.colorEasing?c.colorEasing(C,L):1-Math.cos(C/L*(Math.PI/2));return s(S,D,U)},onComplete:function(C,S,D){if(_)return _(s(p,p,0),S,D)},onChange:function(C,S,D){if(u){if(Array.isArray(C))return u(s(C,C,0),S,D);u(C,S,D)}}}))}I.util.animateColor=m}(),function(){function s(Q,de,_e,pe){return Q<Math.abs(de)?(Q=de,pe=_e/4):de===0&&Q===0?pe=_e/(2*Math.PI)*Math.asin(1):pe=_e/(2*Math.PI)*Math.asin(de/Q),{a:Q,c:de,p:_e,s:pe}}function m(Q,de,_e){return Q.a*Math.pow(2,10*(de-=1))*Math.sin((de*_e-Q.s)*(2*Math.PI)/Q.p)}function b(Q,de,_e,pe){return _e*((Q=Q/pe-1)*Q*Q+1)+de}function x(Q,de,_e,pe){return Q/=pe/2,Q<1?_e/2*Q*Q*Q+de:_e/2*((Q-=2)*Q*Q+2)+de}function o(Q,de,_e,pe){return _e*(Q/=pe)*Q*Q*Q+de}function c(Q,de,_e,pe){return-_e*((Q=Q/pe-1)*Q*Q*Q-1)+de}function h(Q,de,_e,pe){return Q/=pe/2,Q<1?_e/2*Q*Q*Q*Q+de:-_e/2*((Q-=2)*Q*Q*Q-2)+de}function p(Q,de,_e,pe){return _e*(Q/=pe)*Q*Q*Q*Q+de}function _(Q,de,_e,pe){return _e*((Q=Q/pe-1)*Q*Q*Q*Q+1)+de}function u(Q,de,_e,pe){return Q/=pe/2,Q<1?_e/2*Q*Q*Q*Q*Q+de:_e/2*((Q-=2)*Q*Q*Q*Q+2)+de}function C(Q,de,_e,pe){return-_e*Math.cos(Q/pe*(Math.PI/2))+_e+de}function S(Q,de,_e,pe){return _e*Math.sin(Q/pe*(Math.PI/2))+de}function D(Q,de,_e,pe){return-_e/2*(Math.cos(Math.PI*Q/pe)-1)+de}function L(Q,de,_e,pe){return Q===0?de:_e*Math.pow(2,10*(Q/pe-1))+de}function U(Q,de,_e,pe){return Q===pe?de+_e:_e*(-Math.pow(2,-10*Q/pe)+1)+de}function $(Q,de,_e,pe){return Q===0?de:Q===pe?de+_e:(Q/=pe/2,Q<1?_e/2*Math.pow(2,10*(Q-1))+de:_e/2*(-Math.pow(2,-10*--Q)+2)+de)}function ne(Q,de,_e,pe){return-_e*(Math.sqrt(1-(Q/=pe)*Q)-1)+de}function ye(Q,de,_e,pe){return _e*Math.sqrt(1-(Q=Q/pe-1)*Q)+de}function Ve(Q,de,_e,pe){return Q/=pe/2,Q<1?-_e/2*(Math.sqrt(1-Q*Q)-1)+de:_e/2*(Math.sqrt(1-(Q-=2)*Q)+1)+de}function Ke(Q,de,_e,pe){var Re=1.70158,fe=0,ee=_e;if(Q===0)return de;if(Q/=pe,Q===1)return de+_e;fe||(fe=pe*.3);var Ce=s(ee,_e,fe,Re);return-m(Ce,Q,pe)+de}function at(Q,de,_e,pe){var Re=1.70158,fe=0,ee=_e;if(Q===0)return de;if(Q/=pe,Q===1)return de+_e;fe||(fe=pe*.3);var Ce=s(ee,_e,fe,Re);return Ce.a*Math.pow(2,-10*Q)*Math.sin((Q*pe-Ce.s)*(2*Math.PI)/Ce.p)+Ce.c+de}function $e(Q,de,_e,pe){var Re=1.70158,fe=0,ee=_e;if(Q===0)return de;if(Q/=pe/2,Q===2)return de+_e;fe||(fe=pe*(.3*1.5));var Ce=s(ee,_e,fe,Re);return Q<1?-.5*m(Ce,Q,pe)+de:Ce.a*Math.pow(2,-10*(Q-=1))*Math.sin((Q*pe-Ce.s)*(2*Math.PI)/Ce.p)*.5+Ce.c+de}function ut(Q,de,_e,pe,Re){return Re===void 0&&(Re=1.70158),_e*(Q/=pe)*Q*((Re+1)*Q-Re)+de}function ot(Q,de,_e,pe,Re){return Re===void 0&&(Re=1.70158),_e*((Q=Q/pe-1)*Q*((Re+1)*Q+Re)+1)+de}function vt(Q,de,_e,pe,Re){return Re===void 0&&(Re=1.70158),Q/=pe/2,Q<1?_e/2*(Q*Q*(((Re*=1.525)+1)*Q-Re))+de:_e/2*((Q-=2)*Q*(((Re*=1.525)+1)*Q+Re)+2)+de}function St(Q,de,_e,pe){return _e-ct(pe-Q,0,_e,pe)+de}function ct(Q,de,_e,pe){return(Q/=pe)<1/2.75?_e*(7.5625*Q*Q)+de:Q<2/2.75?_e*(7.5625*(Q-=1.5/2.75)*Q+.75)+de:Q<2.5/2.75?_e*(7.5625*(Q-=2.25/2.75)*Q+.9375)+de:_e*(7.5625*(Q-=2.625/2.75)*Q+.984375)+de}function Et(Q,de,_e,pe){return Q<pe/2?St(Q*2,0,_e,pe)*.5+de:ct(Q*2-pe,0,_e,pe)*.5+_e*.5+de}I.util.ease={easeInQuad:function(Q,de,_e,pe){return _e*(Q/=pe)*Q+de},easeOutQuad:function(Q,de,_e,pe){return-_e*(Q/=pe)*(Q-2)+de},easeInOutQuad:function(Q,de,_e,pe){return Q/=pe/2,Q<1?_e/2*Q*Q+de:-_e/2*(--Q*(Q-2)-1)+de},easeInCubic:function(Q,de,_e,pe){return _e*(Q/=pe)*Q*Q+de},easeOutCubic:b,easeInOutCubic:x,easeInQuart:o,easeOutQuart:c,easeInOutQuart:h,easeInQuint:p,easeOutQuint:_,easeInOutQuint:u,easeInSine:C,easeOutSine:S,easeInOutSine:D,easeInExpo:L,easeOutExpo:U,easeInOutExpo:$,easeInCirc:ne,easeOutCirc:ye,easeInOutCirc:Ve,easeInElastic:Ke,easeOutElastic:at,easeInOutElastic:$e,easeInBack:ut,easeOutBack:ot,easeInOutBack:vt,easeInBounce:St,easeOutBounce:ct,easeInOutBounce:Et}}(),function(s){var m=s.fabric||(s.fabric={}),b=m.util.object.extend,x=m.util.object.clone,o=m.util.toFixed,c=m.util.parseUnit,h=m.util.multiplyTransformMatrices,p=["path","circle","polygon","polyline","ellipse","rect","line","image","text"],_=["symbol","image","marker","pattern","view","svg"],u=["pattern","defs","symbol","metadata","clipPath","mask","desc"],C=["symbol","g","a","svg","clipPath","defs"],S={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},D={stroke:"strokeOpacity",fill:"fillOpacity"},L="font-size",U="clip-path";m.svgValidTagNamesRegEx=ye(p),m.svgViewBoxElementsRegEx=ye(_),m.svgInvalidAncestorsRegEx=ye(u),m.svgValidParentsRegEx=ye(C),m.cssRules={},m.gradientDefs={},m.clipPaths={};function $(fe){return fe in S?S[fe]:fe}function ne(fe,ee,Ce,Le){var Je=Array.isArray(ee),Ue;if((fe==="fill"||fe==="stroke")&&ee==="none")ee="";else{if(fe==="strokeUniform")return ee==="non-scaling-stroke";if(fe==="strokeDashArray")ee==="none"?ee=null:ee=ee.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(fe==="transformMatrix")Ce&&Ce.transformMatrix?ee=h(Ce.transformMatrix,m.parseTransformAttribute(ee)):ee=m.parseTransformAttribute(ee);else if(fe==="visible")ee=ee!=="none"&&ee!=="hidden",Ce&&Ce.visible===!1&&(ee=!1);else if(fe==="opacity")ee=parseFloat(ee),Ce&&typeof Ce.opacity<"u"&&(ee*=Ce.opacity);else if(fe==="textAnchor")ee=ee==="start"?"left":ee==="end"?"right":"center";else if(fe==="charSpacing")Ue=c(ee,Le)/Le*1e3;else if(fe==="paintFirst"){var Ge=ee.indexOf("fill"),dt=ee.indexOf("stroke"),ee="fill";(Ge>-1&&dt>-1&&dt<Ge||Ge===-1&&dt>-1)&&(ee="stroke")}else{if(fe==="href"||fe==="xlink:href"||fe==="font")return ee;if(fe==="imageSmoothing")return ee==="optimizeQuality";Ue=Je?ee.map(c):c(ee,Le)}}return!Je&&isNaN(Ue)?ee:Ue}function ye(fe){return new RegExp("^("+fe.join("|")+")\\b","i")}function Ve(fe){for(var ee in D)if(!(typeof fe[D[ee]]>"u"||fe[ee]==="")){if(typeof fe[ee]>"u"){if(!m.Object.prototype[ee])continue;fe[ee]=m.Object.prototype[ee]}if(fe[ee].indexOf("url(")!==0){var Ce=new m.Color(fe[ee]);fe[ee]=Ce.setAlpha(o(Ce.getAlpha()*fe[D[ee]],2)).toRgba()}}return fe}function Ke(fe,ee){var Ce,Le=[],Je,Ue,Ge;for(Ue=0,Ge=ee.length;Ue<Ge;Ue++)Ce=ee[Ue],Je=fe.getElementsByTagName(Ce),Le=Le.concat(Array.prototype.slice.call(Je));return Le}m.parseTransformAttribute=function(){function fe(nt,qt){var Yt=m.util.cos(qt[0]),gi=m.util.sin(qt[0]),xi=0,fi=0;qt.length===3&&(xi=qt[1],fi=qt[2]),nt[0]=Yt,nt[1]=gi,nt[2]=-gi,nt[3]=Yt,nt[4]=xi-(Yt*xi-gi*fi),nt[5]=fi-(gi*xi+Yt*fi)}function ee(nt,qt){var Yt=qt[0],gi=qt.length===2?qt[1]:qt[0];nt[0]=Yt,nt[3]=gi}function Ce(nt,qt,Yt){nt[Yt]=Math.tan(m.util.degreesToRadians(qt[0]))}function Le(nt,qt){nt[4]=qt[0],qt.length===2&&(nt[5]=qt[1])}var Je=m.iMatrix,Ue=m.reNum,Ge=m.commaWsp,dt="(?:(skewX)\\s*\\(\\s*("+Ue+")\\s*\\))",At="(?:(skewY)\\s*\\(\\s*("+Ue+")\\s*\\))",Ye="(?:(rotate)\\s*\\(\\s*("+Ue+")(?:"+Ge+"("+Ue+")"+Ge+"("+Ue+"))?\\s*\\))",Oe="(?:(scale)\\s*\\(\\s*("+Ue+")(?:"+Ge+"("+Ue+"))?\\s*\\))",Qe="(?:(translate)\\s*\\(\\s*("+Ue+")(?:"+Ge+"("+Ue+"))?\\s*\\))",Xe="(?:(matrix)\\s*\\(\\s*("+Ue+")"+Ge+"("+Ue+")"+Ge+"("+Ue+")"+Ge+"("+Ue+")"+Ge+"("+Ue+")"+Ge+"("+Ue+")\\s*\\))",le="(?:"+Xe+"|"+Qe+"|"+Oe+"|"+Ye+"|"+dt+"|"+At+")",it="(?:"+le+"(?:"+Ge+"*"+le+")*)",bt="^\\s*(?:"+it+"?)\\s*$",Pt=new RegExp(bt),Ot=new RegExp(le,"g");return function(nt){var qt=Je.concat(),Yt=[];if(!nt||nt&&!Pt.test(nt))return qt;nt.replace(Ot,function(xi){var fi=new RegExp(le).exec(xi).filter(function(Hi){return!!Hi}),Gi=fi[1],ht=fi.slice(2).map(parseFloat);switch(Gi){case"translate":Le(qt,ht);break;case"rotate":ht[0]=m.util.degreesToRadians(ht[0]),fe(qt,ht);break;case"scale":ee(qt,ht);break;case"skewX":Ce(qt,ht,2);break;case"skewY":Ce(qt,ht,1);break;case"matrix":qt=ht;break}Yt.push(qt.concat()),qt=Je.concat()});for(var gi=Yt[0];Yt.length>1;)Yt.shift(),gi=m.util.multiplyTransformMatrices(gi,Yt[0]);return gi}}();function at(fe,ee){var Ce,Le;fe.replace(/;\s*$/,"").split(";").forEach(function(Je){var Ue=Je.split(":");Ce=Ue[0].trim().toLowerCase(),Le=Ue[1].trim(),ee[Ce]=Le})}function $e(fe,ee){var Ce,Le;for(var Je in fe)typeof fe[Je]>"u"||(Ce=Je.toLowerCase(),Le=fe[Je],ee[Ce]=Le)}function ut(fe,ee){var Ce={};for(var Le in m.cssRules[ee])if(ot(fe,Le.split(" ")))for(var Je in m.cssRules[ee][Le])Ce[Je]=m.cssRules[ee][Le][Je];return Ce}function ot(fe,ee){var Ce,Le=!0;return Ce=St(fe,ee.pop()),Ce&&ee.length&&(Le=vt(fe,ee)),Ce&&Le&&ee.length===0}function vt(fe,ee){for(var Ce,Le=!0;fe.parentNode&&fe.parentNode.nodeType===1&&ee.length;)Le&&(Ce=ee.pop()),fe=fe.parentNode,Le=St(fe,Ce);return ee.length===0}function St(fe,ee){var Ce=fe.nodeName,Le=fe.getAttribute("class"),Je=fe.getAttribute("id"),Ue,Ge;if(Ue=new RegExp("^"+Ce,"i"),ee=ee.replace(Ue,""),Je&&ee.length&&(Ue=new RegExp("#"+Je+"(?![a-zA-Z\\-]+)","i"),ee=ee.replace(Ue,"")),Le&&ee.length)for(Le=Le.split(" "),Ge=Le.length;Ge--;)Ue=new RegExp("\\."+Le[Ge]+"(?![a-zA-Z\\-]+)","i"),ee=ee.replace(Ue,"");return ee.length===0}function ct(fe,ee){var Ce;if(fe.getElementById&&(Ce=fe.getElementById(ee)),Ce)return Ce;var Le,Je,Ue,Ge=fe.getElementsByTagName("*");for(Je=0,Ue=Ge.length;Je<Ue;Je++)if(Le=Ge[Je],ee===Le.getAttribute("id"))return Le}function Et(fe){for(var ee=Ke(fe,["use","svg:use"]),Ce=0;ee.length&&Ce<ee.length;){var Le=ee[Ce],Je=Le.getAttribute("xlink:href")||Le.getAttribute("href");if(Je===null)return;var Ue=Je.slice(1),Ge=Le.getAttribute("x")||0,dt=Le.getAttribute("y")||0,At=ct(fe,Ue).cloneNode(!0),Ye=(At.getAttribute("transform")||"")+" translate("+Ge+", "+dt+")",Oe,Qe=ee.length,Xe,le,it,bt,Pt=m.svgNS;if(de(At),/^svg$/i.test(At.nodeName)){var Ot=At.ownerDocument.createElementNS(Pt,"g");for(le=0,it=At.attributes,bt=it.length;le<bt;le++)Xe=it.item(le),Ot.setAttributeNS(Pt,Xe.nodeName,Xe.nodeValue);for(;At.firstChild;)Ot.appendChild(At.firstChild);At=Ot}for(le=0,it=Le.attributes,bt=it.length;le<bt;le++)Xe=it.item(le),!(Xe.nodeName==="x"||Xe.nodeName==="y"||Xe.nodeName==="xlink:href"||Xe.nodeName==="href")&&(Xe.nodeName==="transform"?Ye=Xe.nodeValue+" "+Ye:At.setAttribute(Xe.nodeName,Xe.nodeValue));At.setAttribute("transform",Ye),At.setAttribute("instantiated_by_use","1"),At.removeAttribute("id"),Oe=Le.parentNode,Oe.replaceChild(At,Le),ee.length===Qe&&Ce++}}var Q=new RegExp("^\\s*("+m.reNum+"+)\\s*,?\\s*("+m.reNum+"+)\\s*,?\\s*("+m.reNum+"+)\\s*,?\\s*("+m.reNum+"+)\\s*$");function de(fe){if(!m.svgViewBoxElementsRegEx.test(fe.nodeName))return{};var ee=fe.getAttribute("viewBox"),Ce=1,Le=1,Je=0,Ue=0,Ge,dt,At,Ye,Oe=fe.getAttribute("width"),Qe=fe.getAttribute("height"),Xe=fe.getAttribute("x")||0,le=fe.getAttribute("y")||0,it=fe.getAttribute("preserveAspectRatio")||"",bt=!ee||!(ee=ee.match(Q)),Pt=!Oe||!Qe||Oe==="100%"||Qe==="100%",Ot=bt&&Pt,nt={},qt="",Yt=0,gi=0;if(nt.width=0,nt.height=0,nt.toBeParsed=Ot,bt&&(Xe||le)&&fe.parentNode&&fe.parentNode.nodeName!=="#document"&&(qt=" translate("+c(Xe)+" "+c(le)+") ",At=(fe.getAttribute("transform")||"")+qt,fe.setAttribute("transform",At),fe.removeAttribute("x"),fe.removeAttribute("y")),Ot)return nt;if(bt)return nt.width=c(Oe),nt.height=c(Qe),nt;if(Je=-parseFloat(ee[1]),Ue=-parseFloat(ee[2]),Ge=parseFloat(ee[3]),dt=parseFloat(ee[4]),nt.minX=Je,nt.minY=Ue,nt.viewBoxWidth=Ge,nt.viewBoxHeight=dt,Pt?(nt.width=Ge,nt.height=dt):(nt.width=c(Oe),nt.height=c(Qe),Ce=nt.width/Ge,Le=nt.height/dt),it=m.util.parsePreserveAspectRatioAttribute(it),it.alignX!=="none"&&(it.meetOrSlice==="meet"&&(Le=Ce=Ce>Le?Le:Ce),it.meetOrSlice==="slice"&&(Le=Ce=Ce>Le?Ce:Le),Yt=nt.width-Ge*Ce,gi=nt.height-dt*Ce,it.alignX==="Mid"&&(Yt/=2),it.alignY==="Mid"&&(gi/=2),it.alignX==="Min"&&(Yt=0),it.alignY==="Min"&&(gi=0)),Ce===1&&Le===1&&Je===0&&Ue===0&&Xe===0&&le===0)return nt;if((Xe||le)&&fe.parentNode.nodeName!=="#document"&&(qt=" translate("+c(Xe)+" "+c(le)+") "),At=qt+" matrix("+Ce+" 0 0 "+Le+" "+(Je*Ce+Yt)+" "+(Ue*Le+gi)+") ",fe.nodeName==="svg"){for(Ye=fe.ownerDocument.createElementNS(m.svgNS,"g");fe.firstChild;)Ye.appendChild(fe.firstChild);fe.appendChild(Ye)}else Ye=fe,Ye.removeAttribute("x"),Ye.removeAttribute("y"),At=Ye.getAttribute("transform")+At;return Ye.setAttribute("transform",At),nt}function _e(fe,ee){for(;fe&&(fe=fe.parentNode);)if(fe.nodeName&&ee.test(fe.nodeName.replace("svg:",""))&&!fe.getAttribute("instantiated_by_use"))return!0;return!1}m.parseSVGDocument=function(fe,ee,Ce,Le){if(fe){Et(fe);var Je=m.Object.__uid++,Ue,Ge,dt=de(fe),At=m.util.toArray(fe.getElementsByTagName("*"));if(dt.crossOrigin=Le&&Le.crossOrigin,dt.svgUid=Je,At.length===0&&m.isLikelyNode){At=fe.selectNodes('//*[name(.)!="svg"]');var Ye=[];for(Ue=0,Ge=At.length;Ue<Ge;Ue++)Ye[Ue]=At[Ue];At=Ye}var Oe=At.filter(function(Xe){return de(Xe),m.svgValidTagNamesRegEx.test(Xe.nodeName.replace("svg:",""))&&!_e(Xe,m.svgInvalidAncestorsRegEx)});if(!Oe||Oe&&!Oe.length){ee&&ee([],{});return}var Qe={};At.filter(function(Xe){return Xe.nodeName.replace("svg:","")==="clipPath"}).forEach(function(Xe){var le=Xe.getAttribute("id");Qe[le]=m.util.toArray(Xe.getElementsByTagName("*")).filter(function(it){return m.svgValidTagNamesRegEx.test(it.nodeName.replace("svg:",""))})}),m.gradientDefs[Je]=m.getGradientDefs(fe),m.cssRules[Je]=m.getCSSRules(fe),m.clipPaths[Je]=Qe,m.parseElements(Oe,function(Xe,le){ee&&(ee(Xe,dt,le,At),delete m.gradientDefs[Je],delete m.cssRules[Je],delete m.clipPaths[Je])},x(dt),Ce,Le)}};function pe(fe,ee){var Ce=["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"],Le="xlink:href",Je=ee.getAttribute(Le).slice(1),Ue=ct(fe,Je);if(Ue&&Ue.getAttribute(Le)&&pe(fe,Ue),Ce.forEach(function(dt){Ue&&!ee.hasAttribute(dt)&&Ue.hasAttribute(dt)&&ee.setAttribute(dt,Ue.getAttribute(dt))}),!ee.children.length)for(var Ge=Ue.cloneNode(!0);Ge.firstChild;)ee.appendChild(Ge.firstChild);ee.removeAttribute(Le)}var Re=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+m.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+m.reNum+"))?\\s+(.*)");b(m,{parseFontDeclaration:function(fe,ee){var Ce=fe.match(Re);if(Ce){var Le=Ce[1],Je=Ce[3],Ue=Ce[4],Ge=Ce[5],dt=Ce[6];Le&&(ee.fontStyle=Le),Je&&(ee.fontWeight=isNaN(parseFloat(Je))?Je:parseFloat(Je)),Ue&&(ee.fontSize=c(Ue)),dt&&(ee.fontFamily=dt),Ge&&(ee.lineHeight=Ge==="normal"?1:Ge)}},getGradientDefs:function(fe){var ee=["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"],Ce=Ke(fe,ee),Le,Je=0,Ue={};for(Je=Ce.length;Je--;)Le=Ce[Je],Le.getAttribute("xlink:href")&&pe(fe,Le),Ue[Le.getAttribute("id")]=Le;return Ue},parseAttributes:function(fe,ee,Ce){if(fe){var Le,Je={},Ue,Ge;typeof Ce>"u"&&(Ce=fe.getAttribute("svgUid")),fe.parentNode&&m.svgValidParentsRegEx.test(fe.parentNode.nodeName)&&(Je=m.parseAttributes(fe.parentNode,ee,Ce));var dt=ee.reduce(function(it,bt){return Le=fe.getAttribute(bt),Le&&(it[bt]=Le),it},{}),At=b(ut(fe,Ce),m.parseStyleAttribute(fe));dt=b(dt,At),At[U]&&fe.setAttribute(U,At[U]),Ue=Ge=Je.fontSize||m.Text.DEFAULT_SVG_FONT_SIZE,dt[L]&&(dt[L]=Ue=c(dt[L],Ge));var Ye,Oe,Qe={};for(var Xe in dt)Ye=$(Xe),Oe=ne(Ye,dt[Xe],Je,Ue),Qe[Ye]=Oe;Qe&&Qe.font&&m.parseFontDeclaration(Qe.font,Qe);var le=b(Je,Qe);return m.svgValidParentsRegEx.test(fe.nodeName)?le:Ve(le)}},parseElements:function(fe,ee,Ce,Le,Je){new m.ElementsParser(fe,ee,Ce,Le,Je).parse()},parseStyleAttribute:function(fe){var ee={},Ce=fe.getAttribute("style");return Ce&&(typeof Ce=="string"?at(Ce,ee):$e(Ce,ee)),ee},parsePointsAttribute:function(fe){if(!fe)return null;fe=fe.replace(/,/g," ").trim(),fe=fe.split(/\s+/);var ee=[],Ce,Le;for(Ce=0,Le=fe.length;Ce<Le;Ce+=2)ee.push({x:parseFloat(fe[Ce]),y:parseFloat(fe[Ce+1])});return ee},getCSSRules:function(fe){var ee=fe.getElementsByTagName("style"),Ce,Le,Je={},Ue;for(Ce=0,Le=ee.length;Ce<Le;Ce++){var Ge=ee[Ce].textContent;Ge=Ge.replace(/\/\*[\s\S]*?\*\//g,""),Ge.trim()!==""&&(Ue=Ge.split("}"),Ue=Ue.filter(function(dt){return dt.trim()}),Ue.forEach(function(dt){var At=dt.split("{"),Ye={},Oe=At[1].trim(),Qe=Oe.split(";").filter(function(bt){return bt.trim()});for(Ce=0,Le=Qe.length;Ce<Le;Ce++){var Xe=Qe[Ce].split(":"),le=Xe[0].trim(),it=Xe[1].trim();Ye[le]=it}dt=At[0].trim(),dt.split(",").forEach(function(bt){bt=bt.replace(/^svg/i,"").trim(),bt!==""&&(Je[bt]?m.util.object.extend(Je[bt],Ye):Je[bt]=m.util.object.clone(Ye))})}))}return Je},loadSVGFromURL:function(fe,ee,Ce,Le){fe=fe.replace(/^\n\s*/,"").trim(),new m.util.request(fe,{method:"get",onComplete:Je});function Je(Ue){var Ge=Ue.responseXML;if(!Ge||!Ge.documentElement)return ee&&ee(null),!1;m.parseSVGDocument(Ge.documentElement,function(dt,At,Ye,Oe){ee&&ee(dt,At,Ye,Oe)},Ce,Le)}},loadSVGFromString:function(fe,ee,Ce,Le){var Je=new m.window.DOMParser,Ue=Je.parseFromString(fe.trim(),"text/xml");m.parseSVGDocument(Ue.documentElement,function(Ge,dt,At,Ye){ee(Ge,dt,At,Ye)},Ce,Le)}})}(ie),I.ElementsParser=function(s,m,b,x,o,c){this.elements=s,this.callback=m,this.options=b,this.reviver=x,this.svgUid=b&&b.svgUid||0,this.parsingOptions=o,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=c},function(s){s.parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},s.createObjects=function(){var m=this;this.elements.forEach(function(b,x){b.setAttribute("svgUid",m.svgUid),m.createObject(b,x)})},s.findTag=function(m){return I[I.util.string.capitalize(m.tagName.replace("svg:",""))]},s.createObject=function(m,b){var x=this.findTag(m);if(x&&x.fromElement)try{x.fromElement(m,this.createCallback(b,m),this.options)}catch(o){I.log(o)}else this.checkIfDone()},s.createCallback=function(m,b){var x=this;return function(o){var c;x.resolveGradient(o,b,"fill"),x.resolveGradient(o,b,"stroke"),o instanceof I.Image&&o._originalElement&&(c=o.parsePreserveAspectRatioAttribute(b)),o._removeTransformMatrix(c),x.resolveClipPath(o,b),x.reviver&&x.reviver(b,o),x.instances[m]=o,x.checkIfDone()}},s.extractPropertyDefinition=function(m,b,x){var o=m[b],c=this.regexUrl;if(c.test(o)){c.lastIndex=0;var h=c.exec(o)[1];return c.lastIndex=0,I[x][this.svgUid][h]}},s.resolveGradient=function(m,b,x){var o=this.extractPropertyDefinition(m,x,"gradientDefs");if(o){var c=b.getAttribute(x+"-opacity"),h=I.Gradient.fromElement(o,m,c,this.options);m.set(x,h)}},s.createClipPathCallback=function(m,b){return function(x){x._removeTransformMatrix(),x.fillRule=x.clipRule,b.push(x)}},s.resolveClipPath=function(m,b){var x=this.extractPropertyDefinition(m,"clipPath","clipPaths"),o,c,h,p,_,u;if(x){p=[],h=I.util.invertTransform(m.calcTransformMatrix());for(var C=x[0].parentNode,S=b;S.parentNode&&S.getAttribute("clip-path")!==m.clipPath;)S=S.parentNode;S.parentNode.appendChild(C);for(var D=0;D<x.length;D++)o=x[D],c=this.findTag(o),c.fromElement(o,this.createClipPathCallback(m,p),this.options);p.length===1?x=p[0]:x=new I.Group(p),_=I.util.multiplyTransformMatrices(h,x.calcTransformMatrix()),x.clipPath&&this.resolveClipPath(x,S);var u=I.util.qrDecompose(_);x.flipX=!1,x.flipY=!1,x.set("scaleX",u.scaleX),x.set("scaleY",u.scaleY),x.angle=u.angle,x.skewX=u.skewX,x.skewY=0,x.setPositionByOrigin({x:u.translateX,y:u.translateY},"center","center"),m.clipPath=x}else delete m.clipPath},s.checkIfDone=function(){--this.numElements===0&&(this.instances=this.instances.filter(function(m){return m!=null}),this.callback(this.instances,this.elements))}}(I.ElementsParser.prototype),function(s){var m=s.fabric||(s.fabric={});if(m.Point){m.warn("fabric.Point is already defined");return}m.Point=b;function b(x,o){this.x=x,this.y=o}b.prototype={type:"point",constructor:b,add:function(x){return new b(this.x+x.x,this.y+x.y)},addEquals:function(x){return this.x+=x.x,this.y+=x.y,this},scalarAdd:function(x){return new b(this.x+x,this.y+x)},scalarAddEquals:function(x){return this.x+=x,this.y+=x,this},subtract:function(x){return new b(this.x-x.x,this.y-x.y)},subtractEquals:function(x){return this.x-=x.x,this.y-=x.y,this},scalarSubtract:function(x){return new b(this.x-x,this.y-x)},scalarSubtractEquals:function(x){return this.x-=x,this.y-=x,this},multiply:function(x){return new b(this.x*x,this.y*x)},multiplyEquals:function(x){return this.x*=x,this.y*=x,this},divide:function(x){return new b(this.x/x,this.y/x)},divideEquals:function(x){return this.x/=x,this.y/=x,this},eq:function(x){return this.x===x.x&&this.y===x.y},lt:function(x){return this.x<x.x&&this.y<x.y},lte:function(x){return this.x<=x.x&&this.y<=x.y},gt:function(x){return this.x>x.x&&this.y>x.y},gte:function(x){return this.x>=x.x&&this.y>=x.y},lerp:function(x,o){return typeof o>"u"&&(o=.5),o=Math.max(Math.min(1,o),0),new b(this.x+(x.x-this.x)*o,this.y+(x.y-this.y)*o)},distanceFrom:function(x){var o=this.x-x.x,c=this.y-x.y;return Math.sqrt(o*o+c*c)},midPointFrom:function(x){return this.lerp(x)},min:function(x){return new b(Math.min(this.x,x.x),Math.min(this.y,x.y))},max:function(x){return new b(Math.max(this.x,x.x),Math.max(this.y,x.y))},toString:function(){return this.x+","+this.y},setXY:function(x,o){return this.x=x,this.y=o,this},setX:function(x){return this.x=x,this},setY:function(x){return this.y=x,this},setFromPoint:function(x){return this.x=x.x,this.y=x.y,this},swap:function(x){var o=this.x,c=this.y;this.x=x.x,this.y=x.y,x.x=o,x.y=c},clone:function(){return new b(this.x,this.y)}}}(ie),function(s){var m=s.fabric||(s.fabric={});if(m.Intersection){m.warn("fabric.Intersection is already defined");return}function b(x){this.status=x,this.points=[]}m.Intersection=b,m.Intersection.prototype={constructor:b,appendPoint:function(x){return this.points.push(x),this},appendPoints:function(x){return this.points=this.points.concat(x),this}},m.Intersection.intersectLineLine=function(x,o,c,h){var p,_=(h.x-c.x)*(x.y-c.y)-(h.y-c.y)*(x.x-c.x),u=(o.x-x.x)*(x.y-c.y)-(o.y-x.y)*(x.x-c.x),C=(h.y-c.y)*(o.x-x.x)-(h.x-c.x)*(o.y-x.y);if(C!==0){var S=_/C,D=u/C;0<=S&&S<=1&&0<=D&&D<=1?(p=new b("Intersection"),p.appendPoint(new m.Point(x.x+S*(o.x-x.x),x.y+S*(o.y-x.y)))):p=new b}else _===0||u===0?p=new b("Coincident"):p=new b("Parallel");return p},m.Intersection.intersectLinePolygon=function(x,o,c){var h=new b,p=c.length,_,u,C,S;for(S=0;S<p;S++)_=c[S],u=c[(S+1)%p],C=b.intersectLineLine(x,o,_,u),h.appendPoints(C.points);return h.points.length>0&&(h.status="Intersection"),h},m.Intersection.intersectPolygonPolygon=function(x,o){var c=new b,h=x.length,p;for(p=0;p<h;p++){var _=x[p],u=x[(p+1)%h],C=b.intersectLinePolygon(_,u,o);c.appendPoints(C.points)}return c.points.length>0&&(c.status="Intersection"),c},m.Intersection.intersectPolygonRectangle=function(x,o,c){var h=o.min(c),p=o.max(c),_=new m.Point(p.x,h.y),u=new m.Point(h.x,p.y),C=b.intersectLinePolygon(h,_,x),S=b.intersectLinePolygon(_,p,x),D=b.intersectLinePolygon(p,u,x),L=b.intersectLinePolygon(u,h,x),U=new b;return U.appendPoints(C.points),U.appendPoints(S.points),U.appendPoints(D.points),U.appendPoints(L.points),U.points.length>0&&(U.status="Intersection"),U}}(ie),function(s){var m=s.fabric||(s.fabric={});if(m.Color){m.warn("fabric.Color is already defined.");return}function b(o){o?this._tryParsingColor(o):this.setSource([0,0,0,1])}m.Color=b,m.Color.prototype={_tryParsingColor:function(o){var c;o in b.colorNameMap&&(o=b.colorNameMap[o]),o==="transparent"&&(c=[255,255,255,0]),c||(c=b.sourceFromHex(o)),c||(c=b.sourceFromRgb(o)),c||(c=b.sourceFromHsl(o)),c||(c=[0,0,0,1]),c&&this.setSource(c)},_rgbToHsl:function(o,c,h){o/=255,c/=255,h/=255;var p,_,u,C=m.util.array.max([o,c,h]),S=m.util.array.min([o,c,h]);if(u=(C+S)/2,C===S)p=_=0;else{var D=C-S;switch(_=u>.5?D/(2-C-S):D/(C+S),C){case o:p=(c-h)/D+(c<h?6:0);break;case c:p=(h-o)/D+2;break;case h:p=(o-c)/D+4;break}p/=6}return[Math.round(p*360),Math.round(_*100),Math.round(u*100)]},getSource:function(){return this._source},setSource:function(o){this._source=o},toRgb:function(){var o=this.getSource();return"rgb("+o[0]+","+o[1]+","+o[2]+")"},toRgba:function(){var o=this.getSource();return"rgba("+o[0]+","+o[1]+","+o[2]+","+o[3]+")"},toHsl:function(){var o=this.getSource(),c=this._rgbToHsl(o[0],o[1],o[2]);return"hsl("+c[0]+","+c[1]+"%,"+c[2]+"%)"},toHsla:function(){var o=this.getSource(),c=this._rgbToHsl(o[0],o[1],o[2]);return"hsla("+c[0]+","+c[1]+"%,"+c[2]+"%,"+o[3]+")"},toHex:function(){var o=this.getSource(),c,h,p;return c=o[0].toString(16),c=c.length===1?"0"+c:c,h=o[1].toString(16),h=h.length===1?"0"+h:h,p=o[2].toString(16),p=p.length===1?"0"+p:p,c.toUpperCase()+h.toUpperCase()+p.toUpperCase()},toHexa:function(){var o=this.getSource(),c;return c=Math.round(o[3]*255),c=c.toString(16),c=c.length===1?"0"+c:c,this.toHex()+c.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(o){var c=this.getSource();return c[3]=o,this.setSource(c),this},toGrayscale:function(){var o=this.getSource(),c=parseInt((o[0]*.3+o[1]*.59+o[2]*.11).toFixed(0),10),h=o[3];return this.setSource([c,c,c,h]),this},toBlackWhite:function(o){var c=this.getSource(),h=(c[0]*.3+c[1]*.59+c[2]*.11).toFixed(0),p=c[3];return o=o||127,h=Number(h)<Number(o)?0:255,this.setSource([h,h,h,p]),this},overlayWith:function(o){o instanceof b||(o=new b(o));var c=[],h=this.getAlpha(),p=.5,_=this.getSource(),u=o.getSource(),C;for(C=0;C<3;C++)c.push(Math.round(_[C]*(1-p)+u[C]*p));return c[3]=h,this.setSource(c),this}},m.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,m.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,m.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,m.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"};function x(o,c,h){return h<0&&(h+=1),h>1&&(h-=1),h<1/6?o+(c-o)*6*h:h<1/2?c:h<2/3?o+(c-o)*(2/3-h)*6:o}m.Color.fromRgb=function(o){return b.fromSource(b.sourceFromRgb(o))},m.Color.sourceFromRgb=function(o){var c=o.match(b.reRGBa);if(c){var h=parseInt(c[1],10)/(/%$/.test(c[1])?100:1)*(/%$/.test(c[1])?255:1),p=parseInt(c[2],10)/(/%$/.test(c[2])?100:1)*(/%$/.test(c[2])?255:1),_=parseInt(c[3],10)/(/%$/.test(c[3])?100:1)*(/%$/.test(c[3])?255:1);return[parseInt(h,10),parseInt(p,10),parseInt(_,10),c[4]?parseFloat(c[4]):1]}},m.Color.fromRgba=b.fromRgb,m.Color.fromHsl=function(o){return b.fromSource(b.sourceFromHsl(o))},m.Color.sourceFromHsl=function(o){var c=o.match(b.reHSLa);if(c){var h=(parseFloat(c[1])%360+360)%360/360,p=parseFloat(c[2])/(/%$/.test(c[2])?100:1),_=parseFloat(c[3])/(/%$/.test(c[3])?100:1),u,C,S;if(p===0)u=C=S=_;else{var D=_<=.5?_*(p+1):_+p-_*p,L=_*2-D;u=x(L,D,h+1/3),C=x(L,D,h),S=x(L,D,h-1/3)}return[Math.round(u*255),Math.round(C*255),Math.round(S*255),c[4]?parseFloat(c[4]):1]}},m.Color.fromHsla=b.fromHsl,m.Color.fromHex=function(o){return b.fromSource(b.sourceFromHex(o))},m.Color.sourceFromHex=function(o){if(o.match(b.reHex)){var c=o.slice(o.indexOf("#")+1),h=c.length===3||c.length===4,p=c.length===8||c.length===4,_=h?c.charAt(0)+c.charAt(0):c.substring(0,2),u=h?c.charAt(1)+c.charAt(1):c.substring(2,4),C=h?c.charAt(2)+c.charAt(2):c.substring(4,6),S=p?h?c.charAt(3)+c.charAt(3):c.substring(6,8):"FF";return[parseInt(_,16),parseInt(u,16),parseInt(C,16),parseFloat((parseInt(S,16)/255).toFixed(2))]}},m.Color.fromSource=function(o){var c=new b;return c.setSource(o),c}}(ie),function(s){var m=s.fabric||(s.fabric={}),b=["e","se","s","sw","w","nw","n","ne","e"],x=["ns","nesw","ew","nwse"],o={},c="left",h="top",p="right",_="bottom",u="center",C={top:_,bottom:h,left:p,right:c,center:u},S=m.util.radiansToDegrees,D=Math.sign||function(Ye){return(Ye>0)-(Ye<0)||+Ye};function L(Ye,Oe){var Qe=Ye.angle+S(Math.atan2(Oe.y,Oe.x))+360;return Math.round(Qe%360/45)}function U(Ye,Oe){var Qe=Oe.transform.target,Xe=Qe.canvas,le=m.util.object.clone(Oe);le.target=Qe,Xe&&Xe.fire("object:"+Ye,le),Qe.fire(Ye,Oe)}function $(Ye,Oe){var Qe=Oe.canvas,Xe=Qe.uniScaleKey,le=Ye[Xe];return Qe.uniformScaling&&!le||!Qe.uniformScaling&&le}function ne(Ye){return Ye.originX===u&&Ye.originY===u}function ye(Ye,Oe,Qe){var Xe=Ye.lockScalingX,le=Ye.lockScalingY;return!!(Xe&&le||!Oe&&(Xe||le)&&Qe||Xe&&Oe==="x"||le&&Oe==="y")}function Ve(Ye,Oe,Qe){var Xe="not-allowed",le=$(Ye,Qe),it="";if(Oe.x!==0&&Oe.y===0?it="x":Oe.x===0&&Oe.y!==0&&(it="y"),ye(Qe,it,le))return Xe;var bt=L(Qe,Oe);return b[bt]+"-resize"}function Ke(Ye,Oe,Qe){var Xe="not-allowed";if(Oe.x!==0&&Qe.lockSkewingY||Oe.y!==0&&Qe.lockSkewingX)return Xe;var le=L(Qe,Oe)%4;return x[le]+"-resize"}function at(Ye,Oe,Qe){return Ye[Qe.canvas.altActionKey]?o.skewCursorStyleHandler(Ye,Oe,Qe):o.scaleCursorStyleHandler(Ye,Oe,Qe)}function $e(Ye,Oe,Qe){var Xe=Ye[Qe.canvas.altActionKey];if(Oe.x===0)return Xe?"skewX":"scaleY";if(Oe.y===0)return Xe?"skewY":"scaleX"}function ut(Ye,Oe,Qe){return Qe.lockRotation?"not-allowed":Oe.cursorStyle}function ot(Ye,Oe,Qe,Xe){return{e:Ye,transform:Oe,pointer:{x:Qe,y:Xe}}}function vt(Ye){return function(Oe,Qe,Xe,le){var it=Qe.target,bt=it.getCenterPoint(),Pt=it.translateToOriginPoint(bt,Qe.originX,Qe.originY),Ot=Ye(Oe,Qe,Xe,le);return it.setPositionByOrigin(Pt,Qe.originX,Qe.originY),Ot}}function St(Ye,Oe){return function(Qe,Xe,le,it){var bt=Oe(Qe,Xe,le,it);return bt&&U(Ye,ot(Qe,Xe,le,it)),bt}}function ct(Ye,Oe,Qe,Xe,le){var it=Ye.target,bt=it.controls[Ye.corner],Pt=it.canvas.getZoom(),Ot=it.padding/Pt,nt=it.toLocalPoint(new m.Point(Xe,le),Oe,Qe);return nt.x>=Ot&&(nt.x-=Ot),nt.x<=-Ot&&(nt.x+=Ot),nt.y>=Ot&&(nt.y-=Ot),nt.y<=Ot&&(nt.y+=Ot),nt.x-=bt.offsetX,nt.y-=bt.offsetY,nt}function Et(Ye){return Ye.flipX!==Ye.flipY}function Q(Ye,Oe,Qe,Xe,le){if(Ye[Oe]!==0){var it=Ye._getTransformedDimensions()[Xe],bt=le/it*Ye[Qe];Ye.set(Qe,bt)}}function de(Ye,Oe,Qe,Xe){var le=Oe.target,it=le._getTransformedDimensions(0,le.skewY),bt=ct(Oe,Oe.originX,Oe.originY,Qe,Xe),Pt=Math.abs(bt.x*2)-it.x,Ot=le.skewX,nt;Pt<2?nt=0:(nt=S(Math.atan2(Pt/le.scaleX,it.y/le.scaleY)),Oe.originX===c&&Oe.originY===_&&(nt=-nt),Oe.originX===p&&Oe.originY===h&&(nt=-nt),Et(le)&&(nt=-nt));var qt=Ot!==nt;if(qt){var Yt=le._getTransformedDimensions().y;le.set("skewX",nt),Q(le,"skewY","scaleY","y",Yt)}return qt}function _e(Ye,Oe,Qe,Xe){var le=Oe.target,it=le._getTransformedDimensions(le.skewX,0),bt=ct(Oe,Oe.originX,Oe.originY,Qe,Xe),Pt=Math.abs(bt.y*2)-it.y,Ot=le.skewY,nt;Pt<2?nt=0:(nt=S(Math.atan2(Pt/le.scaleY,it.x/le.scaleX)),Oe.originX===c&&Oe.originY===_&&(nt=-nt),Oe.originX===p&&Oe.originY===h&&(nt=-nt),Et(le)&&(nt=-nt));var qt=Ot!==nt;if(qt){var Yt=le._getTransformedDimensions().x;le.set("skewY",nt),Q(le,"skewX","scaleX","x",Yt)}return qt}function pe(Ye,Oe,Qe,Xe){var le=Oe.target,it=le.skewX,bt,Pt=Oe.originY;if(le.lockSkewingX)return!1;if(it===0){var Ot=ct(Oe,u,u,Qe,Xe);Ot.x>0?bt=c:bt=p}else it>0&&(bt=Pt===h?c:p),it<0&&(bt=Pt===h?p:c),Et(le)&&(bt=bt===c?p:c);Oe.originX=bt;var nt=St("skewing",vt(de));return nt(Ye,Oe,Qe,Xe)}function Re(Ye,Oe,Qe,Xe){var le=Oe.target,it=le.skewY,bt,Pt=Oe.originX;if(le.lockSkewingY)return!1;if(it===0){var Ot=ct(Oe,u,u,Qe,Xe);Ot.y>0?bt=h:bt=_}else it>0&&(bt=Pt===c?h:_),it<0&&(bt=Pt===c?_:h),Et(le)&&(bt=bt===h?_:h);Oe.originY=bt;var nt=St("skewing",vt(_e));return nt(Ye,Oe,Qe,Xe)}function fe(Ye,Oe,Qe,Xe){var le=Oe,it=le.target,bt=it.translateToOriginPoint(it.getCenterPoint(),le.originX,le.originY);if(it.lockRotation)return!1;var Pt=Math.atan2(le.ey-bt.y,le.ex-bt.x),Ot=Math.atan2(Xe-bt.y,Qe-bt.x),nt=S(Ot-Pt+le.theta),qt=!0;if(it.snapAngle>0){var Yt=it.snapAngle,gi=it.snapThreshold||Yt,xi=Math.ceil(nt/Yt)*Yt,fi=Math.floor(nt/Yt)*Yt;Math.abs(nt-fi)<gi?nt=fi:Math.abs(nt-xi)<gi&&(nt=xi)}return nt<0&&(nt=360+nt),nt%=360,qt=it.angle!==nt,it.angle=nt,qt}function ee(Ye,Oe,Qe,Xe,le){le=le||{};var it=Oe.target,bt=it.lockScalingX,Pt=it.lockScalingY,Ot=le.by,nt,qt,Yt,gi,xi=$(Ye,it),fi=ye(it,Ot,xi),Gi,ht,Hi=Oe.gestureScale;if(fi)return!1;if(Hi)qt=Oe.scaleX*Hi,Yt=Oe.scaleY*Hi;else{if(nt=ct(Oe,Oe.originX,Oe.originY,Qe,Xe),Gi=Ot!=="y"?D(nt.x):1,ht=Ot!=="x"?D(nt.y):1,Oe.signX||(Oe.signX=Gi),Oe.signY||(Oe.signY=ht),it.lockScalingFlip&&(Oe.signX!==Gi||Oe.signY!==ht))return!1;if(gi=it._getTransformedDimensions(),xi&&!Ot){var Zt=Math.abs(nt.x)+Math.abs(nt.y),bi=Oe.original,cr=Math.abs(gi.x*bi.scaleX/it.scaleX)+Math.abs(gi.y*bi.scaleY/it.scaleY),xt=Zt/cr;qt=bi.scaleX*xt,Yt=bi.scaleY*xt}else qt=Math.abs(nt.x*it.scaleX/gi.x),Yt=Math.abs(nt.y*it.scaleY/gi.y);ne(Oe)&&(qt*=2,Yt*=2),Oe.signX!==Gi&&Ot!=="y"&&(Oe.originX=C[Oe.originX],qt*=-1,Oe.signX=Gi),Oe.signY!==ht&&Ot!=="x"&&(Oe.originY=C[Oe.originY],Yt*=-1,Oe.signY=ht)}var li=it.scaleX,Kt=it.scaleY;return Ot?(Ot==="x"&&it.set("scaleX",qt),Ot==="y"&&it.set("scaleY",Yt)):(!bt&&it.set("scaleX",qt),!Pt&&it.set("scaleY",Yt)),li!==it.scaleX||Kt!==it.scaleY}function Ce(Ye,Oe,Qe,Xe){return ee(Ye,Oe,Qe,Xe)}function Le(Ye,Oe,Qe,Xe){return ee(Ye,Oe,Qe,Xe,{by:"x"})}function Je(Ye,Oe,Qe,Xe){return ee(Ye,Oe,Qe,Xe,{by:"y"})}function Ue(Ye,Oe,Qe,Xe){return Ye[Oe.target.canvas.altActionKey]?o.skewHandlerX(Ye,Oe,Qe,Xe):o.scalingY(Ye,Oe,Qe,Xe)}function Ge(Ye,Oe,Qe,Xe){return Ye[Oe.target.canvas.altActionKey]?o.skewHandlerY(Ye,Oe,Qe,Xe):o.scalingX(Ye,Oe,Qe,Xe)}function dt(Ye,Oe,Qe,Xe){var le=Oe.target,it=ct(Oe,Oe.originX,Oe.originY,Qe,Xe),bt=le.strokeWidth/(le.strokeUniform?le.scaleX:1),Pt=ne(Oe)?2:1,Ot=le.width,nt=Math.abs(it.x*Pt/le.scaleX)-bt;return le.set("width",Math.max(nt,0)),Ot!==nt}function At(Ye,Oe,Qe,Xe){var le=Oe.target,it=Qe-Oe.offsetX,bt=Xe-Oe.offsetY,Pt=!le.get("lockMovementX")&&le.left!==it,Ot=!le.get("lockMovementY")&&le.top!==bt;return Pt&&le.set("left",it),Ot&&le.set("top",bt),(Pt||Ot)&&U("moving",ot(Ye,Oe,Qe,Xe)),Pt||Ot}o.scaleCursorStyleHandler=Ve,o.skewCursorStyleHandler=Ke,o.scaleSkewCursorStyleHandler=at,o.rotationWithSnapping=St("rotating",vt(fe)),o.scalingEqually=St("scaling",vt(Ce)),o.scalingX=St("scaling",vt(Le)),o.scalingY=St("scaling",vt(Je)),o.scalingYOrSkewingX=Ue,o.scalingXOrSkewingY=Ge,o.changeWidth=St("resizing",vt(dt)),o.skewHandlerX=pe,o.skewHandlerY=Re,o.dragHandler=At,o.scaleOrSkewActionName=$e,o.rotationStyleHandler=ut,o.fireEvent=U,o.wrapWithFixedAnchor=vt,o.wrapWithFireEvent=St,o.getLocalPoint=ct,m.controlsUtils=o}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.util.degreesToRadians,x=m.controlsUtils;function o(h,p,_,u,C){u=u||{};var S=this.sizeX||u.cornerSize||C.cornerSize,D=this.sizeY||u.cornerSize||C.cornerSize,L=typeof u.transparentCorners<"u"?u.transparentCorners:C.transparentCorners,U=L?"stroke":"fill",$=!L&&(u.cornerStrokeColor||C.cornerStrokeColor),ne=p,ye=_,Ve;h.save(),h.fillStyle=u.cornerColor||C.cornerColor,h.strokeStyle=u.cornerStrokeColor||C.cornerStrokeColor,S>D?(Ve=S,h.scale(1,D/S),ye=_*S/D):D>S?(Ve=D,h.scale(S/D,1),ne=p*D/S):Ve=S,h.lineWidth=1,h.beginPath(),h.arc(ne,ye,Ve/2,0,2*Math.PI,!1),h[U](),$&&h.stroke(),h.restore()}function c(h,p,_,u,C){u=u||{};var S=this.sizeX||u.cornerSize||C.cornerSize,D=this.sizeY||u.cornerSize||C.cornerSize,L=typeof u.transparentCorners<"u"?u.transparentCorners:C.transparentCorners,U=L?"stroke":"fill",$=!L&&(u.cornerStrokeColor||C.cornerStrokeColor),ne=S/2,ye=D/2;h.save(),h.fillStyle=u.cornerColor||C.cornerColor,h.strokeStyle=u.cornerStrokeColor||C.cornerStrokeColor,h.lineWidth=1,h.translate(p,_),h.rotate(b(C.angle)),h[U+"Rect"](-ne,-ye,S,D),$&&h.strokeRect(-ne,-ye,S,D),h.restore()}x.renderCircleControl=o,x.renderSquareControl=c}(ie),function(s){var m=s.fabric||(s.fabric={});function b(x){for(var o in x)this[o]=x[o]}m.Control=b,m.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(x,o){return o.cursorStyle},getActionName:function(x,o){return o.actionName},getVisibility:function(x,o){var c=x._controlsVisibility;return c&&typeof c[o]<"u"?c[o]:this.visible},setVisibility:function(x){this.visible=x},positionHandler:function(x,o){var c=m.util.transformPoint({x:this.x*x.x+this.offsetX,y:this.y*x.y+this.offsetY},o);return c},calcCornerCoords:function(x,o,c,h,p){var _,u,C,S,D=p?this.touchSizeX:this.sizeX,L=p?this.touchSizeY:this.sizeY;if(D&&L&&D!==L){var U=Math.atan2(L,D),$=Math.sqrt(D*D+L*L)/2,ne=U-m.util.degreesToRadians(x),ye=Math.PI/2-U-m.util.degreesToRadians(x);_=$*m.util.cos(ne),u=$*m.util.sin(ne),C=$*m.util.cos(ye),S=$*m.util.sin(ye)}else{var Ve=D&&L?D:o;$=Ve*.7071067812;var ne=m.util.degreesToRadians(45-x);_=C=$*m.util.cos(ne),u=S=$*m.util.sin(ne)}return{tl:{x:c-S,y:h-C},tr:{x:c+_,y:h-u},bl:{x:c-_,y:h+u},br:{x:c+S,y:h+C}}},render:function(x,o,c,h,p){switch(h=h||{},h.cornerStyle||p.cornerStyle){case"circle":m.controlsUtils.renderCircleControl.call(this,x,o,c,h,p);break;default:m.controlsUtils.renderSquareControl.call(this,x,o,c,h,p)}}}}(ie),function(){function s(c,h){var p=c.getAttribute("style"),_=c.getAttribute("offset")||0,u,C,S,D;if(_=parseFloat(_)/(/%$/.test(_)?100:1),_=_<0?0:_>1?1:_,p){var L=p.split(/\s*;\s*/);for(L[L.length-1]===""&&L.pop(),D=L.length;D--;){var U=L[D].split(/\s*:\s*/),$=U[0].trim(),ne=U[1].trim();$==="stop-color"?u=ne:$==="stop-opacity"&&(S=ne)}}return u||(u=c.getAttribute("stop-color")||"rgb(0,0,0)"),S||(S=c.getAttribute("stop-opacity")),u=new I.Color(u),C=u.getAlpha(),S=isNaN(parseFloat(S))?1:parseFloat(S),S*=C*h,{offset:_,color:u.toRgb(),opacity:S}}function m(c){return{x1:c.getAttribute("x1")||0,y1:c.getAttribute("y1")||0,x2:c.getAttribute("x2")||"100%",y2:c.getAttribute("y2")||0}}function b(c){return{x1:c.getAttribute("fx")||c.getAttribute("cx")||"50%",y1:c.getAttribute("fy")||c.getAttribute("cy")||"50%",r1:0,x2:c.getAttribute("cx")||"50%",y2:c.getAttribute("cy")||"50%",r2:c.getAttribute("r")||"50%"}}var x=I.util.object.clone;I.Gradient=I.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(c){c||(c={}),c.coords||(c.coords={});var h,p=this;Object.keys(c).forEach(function(_){p[_]=c[_]}),this.id?this.id+="_"+I.Object.__uid++:this.id=I.Object.__uid++,h={x1:c.coords.x1||0,y1:c.coords.y1||0,x2:c.coords.x2||0,y2:c.coords.y2||0},this.type==="radial"&&(h.r1=c.coords.r1||0,h.r2=c.coords.r2||0),this.coords=h,this.colorStops=c.colorStops.slice()},addColorStop:function(c){for(var h in c){var p=new I.Color(c[h]);this.colorStops.push({offset:parseFloat(h),color:p.toRgb(),opacity:p.getAlpha()})}return this},toObject:function(c){var h={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return I.util.populateWithProperties(this,h,c),h},toSVG:function(c,C){var p=x(this.coords,!0),_,u,C=C||{},S,D,L=x(this.colorStops,!0),U=p.r1>p.r2,$=this.gradientTransform?this.gradientTransform.concat():I.iMatrix.concat(),ne=-this.offsetX,ye=-this.offsetY,Ve=!!C.additionalTransform,Ke=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox";if(L.sort(function(vt,St){return vt.offset-St.offset}),Ke==="objectBoundingBox"?(ne/=c.width,ye/=c.height):(ne+=c.width/2,ye+=c.height/2),c.type==="path"&&this.gradientUnits!=="percentage"&&(ne-=c.pathOffset.x,ye-=c.pathOffset.y),$[4]-=ne,$[5]-=ye,D='id="SVGID_'+this.id+'" gradientUnits="'+Ke+'"',D+=' gradientTransform="'+(Ve?C.additionalTransform+" ":"")+I.util.matrixToSVG($)+'" ',this.type==="linear"?S=["<linearGradient ",D,' x1="',p.x1,'" y1="',p.y1,'" x2="',p.x2,'" y2="',p.y2,`">
`]:this.type==="radial"&&(S=["<radialGradient ",D,' cx="',U?p.x1:p.x2,'" cy="',U?p.y1:p.y2,'" r="',U?p.r1:p.r2,'" fx="',U?p.x2:p.x1,'" fy="',U?p.y2:p.y1,`">
`]),this.type==="radial"){if(U)for(L=L.concat(),L.reverse(),_=0,u=L.length;_<u;_++)L[_].offset=1-L[_].offset;var at=Math.min(p.r1,p.r2);if(at>0){var $e=Math.max(p.r1,p.r2),ut=at/$e;for(_=0,u=L.length;_<u;_++)L[_].offset+=ut*(1-L[_].offset)}}for(_=0,u=L.length;_<u;_++){var ot=L[_];S.push("<stop ",'offset="',ot.offset*100+"%",'" style="stop-color:',ot.color,typeof ot.opacity<"u"?";stop-opacity: "+ot.opacity:";",`"/>
`)}return S.push(this.type==="linear"?`</linearGradient>
`:`</radialGradient>
`),S.join("")},toLive:function(c){var h,p=I.util.object.clone(this.coords),_,u;if(this.type){for(this.type==="linear"?h=c.createLinearGradient(p.x1,p.y1,p.x2,p.y2):this.type==="radial"&&(h=c.createRadialGradient(p.x1,p.y1,p.r1,p.x2,p.y2,p.r2)),_=0,u=this.colorStops.length;_<u;_++){var C=this.colorStops[_].color,S=this.colorStops[_].opacity,D=this.colorStops[_].offset;typeof S<"u"&&(C=new I.Color(C).setAlpha(S).toRgba()),h.addColorStop(D,C)}return h}}}),I.util.object.extend(I.Gradient,{fromElement:function(c,h,p,_){var u=parseFloat(p)/(/%$/.test(p)?100:1);u=u<0?0:u>1?1:u,isNaN(u)&&(u=1);var C=c.getElementsByTagName("stop"),S,D=c.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage",L=c.getAttribute("gradientTransform")||"",U=[],$,ne,ye=0,Ve=0,Ke;for(c.nodeName==="linearGradient"||c.nodeName==="LINEARGRADIENT"?(S="linear",$=m(c)):(S="radial",$=b(c)),ne=C.length;ne--;)U.push(s(C[ne],u));Ke=I.parseTransformAttribute(L),o(h,$,_,D),D==="pixels"&&(ye=-h.left,Ve=-h.top);var at=new I.Gradient({id:c.getAttribute("id"),type:S,coords:$,colorStops:U,gradientUnits:D,gradientTransform:Ke,offsetX:ye,offsetY:Ve});return at}});function o(c,h,p,_){var u,C;Object.keys(h).forEach(function(S){u=h[S],u==="Infinity"?C=1:u==="-Infinity"?C=0:(C=parseFloat(h[S],10),typeof u=="string"&&/^(\d+\.\d+)%|(\d+)%$/.test(u)&&(C*=.01,_==="pixels"&&((S==="x1"||S==="x2"||S==="r2")&&(C*=p.viewBoxWidth||p.width),(S==="y1"||S==="y2")&&(C*=p.viewBoxHeight||p.height)))),h[S]=C})}}(),function(){var s=I.util.toFixed;I.Pattern=I.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(m,b){if(m||(m={}),this.id=I.Object.__uid++,this.setOptions(m),!m.source||m.source&&typeof m.source!="string"){b&&b(this);return}else{var x=this;this.source=I.util.createImage(),I.util.loadImage(m.source,function(o,c){x.source=o,b&&b(x,c)},null,this.crossOrigin)}},toObject:function(m){var b=I.Object.NUM_FRACTION_DIGITS,x,o;return typeof this.source.src=="string"?x=this.source.src:typeof this.source=="object"&&this.source.toDataURL&&(x=this.source.toDataURL()),o={type:"pattern",source:x,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:s(this.offsetX,b),offsetY:s(this.offsetY,b),patternTransform:this.patternTransform?this.patternTransform.concat():null},I.util.populateWithProperties(this,o,m),o},toSVG:function(m){var b=typeof this.source=="function"?this.source():this.source,x=b.width/m.width,o=b.height/m.height,c=this.offsetX/m.width,h=this.offsetY/m.height,p="";return(this.repeat==="repeat-x"||this.repeat==="no-repeat")&&(o=1,h&&(o+=Math.abs(h))),(this.repeat==="repeat-y"||this.repeat==="no-repeat")&&(x=1,c&&(x+=Math.abs(c))),b.src?p=b.src:b.toDataURL&&(p=b.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+c+'" y="'+h+'" width="'+x+'" height="'+o+`">
<image x="0" y="0" width="`+b.width+'" height="'+b.height+'" xlink:href="'+p+`"></image>
</pattern>
`},setOptions:function(m){for(var b in m)this[b]=m[b]},toLive:function(m){var b=this.source;return!b||typeof b.src<"u"&&(!b.complete||b.naturalWidth===0||b.naturalHeight===0)?"":m.createPattern(b,this.repeat)}})}(),function(s){var m=s.fabric||(s.fabric={}),b=m.util.toFixed;if(m.Shadow){m.warn("fabric.Shadow is already defined.");return}m.Shadow=m.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(x){typeof x=="string"&&(x=this._parseShadow(x));for(var o in x)this[o]=x[o];this.id=m.Object.__uid++},_parseShadow:function(x){var o=x.trim(),c=m.Shadow.reOffsetsAndBlur.exec(o)||[],h=o.replace(m.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)";return{color:h.trim(),offsetX:parseFloat(c[1],10)||0,offsetY:parseFloat(c[2],10)||0,blur:parseFloat(c[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(x){var o=40,c=40,h=m.Object.NUM_FRACTION_DIGITS,p=m.util.rotateVector({x:this.offsetX,y:this.offsetY},m.util.degreesToRadians(-x.angle)),_=20,u=new m.Color(this.color);return x.width&&x.height&&(o=b((Math.abs(p.x)+this.blur)/x.width,h)*100+_,c=b((Math.abs(p.y)+this.blur)/x.height,h)*100+_),x.flipX&&(p.x*=-1),x.flipY&&(p.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+c+'%" height="'+(100+2*c)+'%" x="-'+o+'%" width="'+(100+2*o)+`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`+b(this.blur?this.blur/2:0,h)+`"></feGaussianBlur>
	<feOffset dx="`+b(p.x,h)+'" dy="'+b(p.y,h)+`" result="oBlur" ></feOffset>
	<feFlood flood-color="`+u.toRgb()+'" flood-opacity="'+u.getAlpha()+`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var x={},o=m.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(c){this[c]!==o[c]&&(x[c]=this[c])},this),x}}),m.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/}(ie),function(){if(I.StaticCanvas){I.warn("fabric.StaticCanvas is already defined.");return}var s=I.util.object.extend,m=I.util.getElementOffset,b=I.util.removeFromArray,x=I.util.toFixed,o=I.util.transformPoint,c=I.util.invertTransform,h=I.util.getNodeCanvas,p=I.util.createCanvasElement,_=new Error("Could not initialize `canvas` element");I.StaticCanvas=I.util.createClass(I.CommonMethods,{initialize:function(u,C){C||(C={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(u,C)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:I.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(u,C){var S=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(u),this._initOptions(C),this.interactive||this._initRetinaScaling(),C.overlayImage&&this.setOverlayImage(C.overlayImage,S),C.backgroundImage&&this.setBackgroundImage(C.backgroundImage,S),C.backgroundColor&&this.setBackgroundColor(C.backgroundColor,S),C.overlayColor&&this.setOverlayColor(C.overlayColor,S),this.calcOffset()},_isRetinaScaling:function(){return I.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,I.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var u=I.devicePixelRatio;this.__initRetinaScaling(u,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(u,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(u,C,S){C.setAttribute("width",this.width*u),C.setAttribute("height",this.height*u),S.scale(u,u)},calcOffset:function(){return this._offset=m(this.lowerCanvasEl),this},setOverlayImage:function(u,C,S){return this.__setBgOverlayImage("overlayImage",u,C,S)},setBackgroundImage:function(u,C,S){return this.__setBgOverlayImage("backgroundImage",u,C,S)},setOverlayColor:function(u,C){return this.__setBgOverlayColor("overlayColor",u,C)},setBackgroundColor:function(u,C){return this.__setBgOverlayColor("backgroundColor",u,C)},__setBgOverlayImage:function(u,C,S,D){return typeof C=="string"?I.util.loadImage(C,function(L,U){if(L){var $=new I.Image(L,D);this[u]=$,$.canvas=this}S&&S(L,U)},this,D&&D.crossOrigin):(D&&C.setOptions(D),this[u]=C,C&&(C.canvas=this),S&&S(C,!1)),this},__setBgOverlayColor:function(u,C,S){return this[u]=C,this._initGradient(C,u),this._initPattern(C,u,S),this},_createCanvasElement:function(){var u=p();if(!u||(u.style||(u.style={}),typeof u.getContext>"u"))throw _;return u},_initOptions:function(u){var C=this.lowerCanvasEl;this._setOptions(u),this.width=this.width||parseInt(C.width,10)||0,this.height=this.height||parseInt(C.height,10)||0,this.lowerCanvasEl.style&&(C.width=this.width,C.height=this.height,C.style.width=this.width+"px",C.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(u){u&&u.getContext?this.lowerCanvasEl=u:this.lowerCanvasEl=I.util.getById(u)||this._createCanvasElement(),I.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(u,C){return this.setDimensions({width:u},C)},setHeight:function(u,C){return this.setDimensions({height:u},C)},setDimensions:function(u,C){var S;C=C||{};for(var D in u)S=u[D],C.cssOnly||(this._setBackstoreDimension(D,u[D]),S+="px",this.hasLostContext=!0),C.backstoreOnly||this._setCssDimension(D,S);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),C.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(u,C){return this.lowerCanvasEl[u]=C,this.upperCanvasEl&&(this.upperCanvasEl[u]=C),this.cacheCanvasEl&&(this.cacheCanvasEl[u]=C),this[u]=C,this},_setCssDimension:function(u,C){return this.lowerCanvasEl.style[u]=C,this.upperCanvasEl&&(this.upperCanvasEl.style[u]=C),this.wrapperEl&&(this.wrapperEl.style[u]=C),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(u){var C=this._activeObject,S=this.backgroundImage,D=this.overlayImage,L,U,$;for(this.viewportTransform=u,U=0,$=this._objects.length;U<$;U++)L=this._objects[U],L.group||L.setCoords(!0);return C&&C.setCoords(),S&&S.setCoords(!0),D&&D.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(u,C){var S=u,D=this.viewportTransform.slice(0);u=o(u,c(this.viewportTransform)),D[0]=C,D[3]=C;var L=o(u,D);return D[4]+=S.x-L.x,D[5]+=S.y-L.y,this.setViewportTransform(D)},setZoom:function(u){return this.zoomToPoint(new I.Point(0,0),u),this},absolutePan:function(u){var C=this.viewportTransform.slice(0);return C[4]=-u.x,C[5]=-u.y,this.setViewportTransform(C)},relativePan:function(u){return this.absolutePan(new I.Point(-u.x-this.viewportTransform[4],-u.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(u){this.stateful&&u.setupState(),u._set("canvas",this),u.setCoords(),this.fire("object:added",{target:u}),u.fire("added")},_onObjectRemoved:function(u){this.fire("object:removed",{target:u}),u.fire("removed"),delete u.canvas},clearContext:function(u){return u.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var u=this.contextContainer;return this.renderCanvas(u,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=I.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var u={},C=this.width,S=this.height,D=c(this.viewportTransform);return u.tl=o({x:0,y:0},D),u.br=o({x:C,y:S},D),u.tr=new I.Point(u.br.x,u.tl.y),u.bl=new I.Point(u.tl.x,u.br.y),this.vptCoords=u,u},cancelRequestedRender:function(){this.isRendering&&(I.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(u,C){var S=this.viewportTransform,D=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(u),I.util.setImageSmoothing(u,this.imageSmoothingEnabled),this.fire("before:render",{ctx:u}),this._renderBackground(u),u.save(),u.transform(S[0],S[1],S[2],S[3],S[4],S[5]),this._renderObjects(u,C),u.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(u),D&&(D.canvas=this,D.shouldCache(),D._transformDone=!0,D.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(u)),this._renderOverlay(u),this.controlsAboveOverlay&&this.interactive&&this.drawControls(u),this.fire("after:render",{ctx:u})},drawClipPathOnCanvas:function(u){var C=this.viewportTransform,S=this.clipPath;u.save(),u.transform(C[0],C[1],C[2],C[3],C[4],C[5]),u.globalCompositeOperation="destination-in",S.transform(u),u.scale(1/S.zoomX,1/S.zoomY),u.drawImage(S._cacheCanvas,-S.cacheTranslationX,-S.cacheTranslationY),u.restore()},_renderObjects:function(u,C){var S,D;for(S=0,D=C.length;S<D;++S)C[S]&&C[S].render(u)},_renderBackgroundOrOverlay:function(u,C){var S=this[C+"Color"],D=this[C+"Image"],L=this.viewportTransform,U=this[C+"Vpt"];if(!(!S&&!D)){if(S){u.save(),u.beginPath(),u.moveTo(0,0),u.lineTo(this.width,0),u.lineTo(this.width,this.height),u.lineTo(0,this.height),u.closePath(),u.fillStyle=S.toLive?S.toLive(u,this):S,U&&u.transform(L[0],L[1],L[2],L[3],L[4],L[5]),u.transform(1,0,0,1,S.offsetX||0,S.offsetY||0);var $=S.gradientTransform||S.patternTransform;$&&u.transform($[0],$[1],$[2],$[3],$[4],$[5]),u.fill(),u.restore()}D&&(u.save(),U&&u.transform(L[0],L[1],L[2],L[3],L[4],L[5]),D.render(u),u.restore())}},_renderBackground:function(u){this._renderBackgroundOrOverlay(u,"background")},_renderOverlay:function(u){this._renderBackgroundOrOverlay(u,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new I.Point(this.width/2,this.height/2)},centerObjectH:function(u){return this._centerObject(u,new I.Point(this.getCenterPoint().x,u.getCenterPoint().y))},centerObjectV:function(u){return this._centerObject(u,new I.Point(u.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(u){var C=this.getCenterPoint();return this._centerObject(u,C)},viewportCenterObject:function(u){var C=this.getVpCenter();return this._centerObject(u,C)},viewportCenterObjectH:function(u){var C=this.getVpCenter();return this._centerObject(u,new I.Point(C.x,u.getCenterPoint().y)),this},viewportCenterObjectV:function(u){var C=this.getVpCenter();return this._centerObject(u,new I.Point(u.getCenterPoint().x,C.y))},getVpCenter:function(){var u=this.getCenterPoint(),C=c(this.viewportTransform);return o(u,C)},_centerObject:function(u,C){return u.setPositionByOrigin(C,"center","center"),u.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(u){return this.toDatalessObject(u)},toObject:function(u){return this._toObjectMethod("toObject",u)},toDatalessObject:function(u){return this._toObjectMethod("toDatalessObject",u)},_toObjectMethod:function(u,C){var S=this.clipPath,D={version:I.version,objects:this._toObjects(u,C)};return S&&!S.excludeFromExport&&(D.clipPath=this._toObject(this.clipPath,u,C)),s(D,this.__serializeBgOverlay(u,C)),I.util.populateWithProperties(this,D,C),D},_toObjects:function(u,C){return this._objects.filter(function(S){return!S.excludeFromExport}).map(function(S){return this._toObject(S,u,C)},this)},_toObject:function(u,C,S){var D;this.includeDefaultValues||(D=u.includeDefaultValues,u.includeDefaultValues=!1);var L=u[C](S);return this.includeDefaultValues||(u.includeDefaultValues=D),L},__serializeBgOverlay:function(u,C){var S={},D=this.backgroundImage,L=this.overlayImage,U=this.backgroundColor,$=this.overlayColor;return U&&U.toObject?U.excludeFromExport||(S.background=U.toObject(C)):U&&(S.background=U),$&&$.toObject?$.excludeFromExport||(S.overlay=$.toObject(C)):$&&(S.overlay=$),D&&!D.excludeFromExport&&(S.backgroundImage=this._toObject(D,u,C)),L&&!L.excludeFromExport&&(S.overlayImage=this._toObject(L,u,C)),S},svgViewportTransformation:!0,toSVG:function(u,C){u||(u={}),u.reviver=C;var S=[];return this._setSVGPreamble(S,u),this._setSVGHeader(S,u),this.clipPath&&S.push('<g clip-path="url(#'+this.clipPath.clipPathId+`)" >
`),this._setSVGBgOverlayColor(S,"background"),this._setSVGBgOverlayImage(S,"backgroundImage",C),this._setSVGObjects(S,C),this.clipPath&&S.push(`</g>
`),this._setSVGBgOverlayColor(S,"overlay"),this._setSVGBgOverlayImage(S,"overlayImage",C),S.push("</svg>"),S.join("")},_setSVGPreamble:function(u,C){C.suppressPreamble||u.push('<?xml version="1.0" encoding="',C.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)},_setSVGHeader:function(u,C){var S=C.width||this.width,D=C.height||this.height,L,U='viewBox="0 0 '+this.width+" "+this.height+'" ',$=I.Object.NUM_FRACTION_DIGITS;C.viewBox?U='viewBox="'+C.viewBox.x+" "+C.viewBox.y+" "+C.viewBox.width+" "+C.viewBox.height+'" ':this.svgViewportTransformation&&(L=this.viewportTransform,U='viewBox="'+x(-L[4]/L[0],$)+" "+x(-L[5]/L[3],$)+" "+x(this.width/L[0],$)+" "+x(this.height/L[3],$)+'" '),u.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',S,'" ','height="',D,'" ',U,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",I.version,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(C),`</defs>
`)},createSVGClipPathMarkup:function(u){var C=this.clipPath;return C?(C.clipPathId="CLIPPATH_"+I.Object.__uid++,'<clipPath id="'+C.clipPathId+`" >
`+this.clipPath.toClipPathSVG(u.reviver)+`</clipPath>
`):""},createSVGRefElementsMarkup:function(){var u=this,C=["background","overlay"].map(function(S){var D=u[S+"Color"];if(D&&D.toLive){var L=u[S+"Vpt"],U=u.viewportTransform,$={width:u.width/(L?U[0]:1),height:u.height/(L?U[3]:1)};return D.toSVG($,{additionalTransform:L?I.util.matrixToSVG(U):""})}});return C.join("")},createSVGFontFacesMarkup:function(){var u="",C={},S,D,L,U,$,ne,ye,Ve,Ke,at=I.fontPaths,$e=[];for(this._objects.forEach(function ot(vt){$e.push(vt),vt._objects&&vt._objects.forEach(ot)}),Ve=0,Ke=$e.length;Ve<Ke;Ve++)if(S=$e[Ve],D=S.fontFamily,!(S.type.indexOf("text")===-1||C[D]||!at[D])&&(C[D]=!0,!!S.styles)){L=S.styles;for($ in L){U=L[$];for(ye in U)ne=U[ye],D=ne.fontFamily,!C[D]&&at[D]&&(C[D]=!0)}}for(var ut in C)u+=[`		@font-face {
`,"			font-family: '",ut,`';
`,"			src: url('",at[ut],`');
`,`		}
`].join("");return u&&(u=['	<style type="text/css">',`<![CDATA[
`,u,"]]>",`</style>
`].join("")),u},_setSVGObjects:function(u,C){var S,D,L,U=this._objects;for(D=0,L=U.length;D<L;D++)S=U[D],!S.excludeFromExport&&this._setSVGObject(u,S,C)},_setSVGObject:function(u,C,S){u.push(C.toSVG(S))},_setSVGBgOverlayImage:function(u,C,S){this[C]&&!this[C].excludeFromExport&&this[C].toSVG&&u.push(this[C].toSVG(S))},_setSVGBgOverlayColor:function(u,C){var S=this[C+"Color"],D=this.viewportTransform,L=this.width,U=this.height;if(S)if(S.toLive){var $=S.repeat,ne=I.util.invertTransform(D),ye=this[C+"Vpt"],Ve=ye?I.util.matrixToSVG(ne):"";u.push('<rect transform="'+Ve+" translate(",L/2,",",U/2,')"',' x="',S.offsetX-L/2,'" y="',S.offsetY-U/2,'" ','width="',$==="repeat-y"||$==="no-repeat"?S.source.width:L,'" height="',$==="repeat-x"||$==="no-repeat"?S.source.height:U,'" fill="url(#SVGID_'+S.id+')"',`></rect>
`)}else u.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',S,'"',`></rect>
`)},sendToBack:function(u){if(!u)return this;var C=this._activeObject,S,D,L;if(u===C&&u.type==="activeSelection")for(L=C._objects,S=L.length;S--;)D=L[S],b(this._objects,D),this._objects.unshift(D);else b(this._objects,u),this._objects.unshift(u);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(u){if(!u)return this;var C=this._activeObject,S,D,L;if(u===C&&u.type==="activeSelection")for(L=C._objects,S=0;S<L.length;S++)D=L[S],b(this._objects,D),this._objects.push(D);else b(this._objects,u),this._objects.push(u);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(u,C){if(!u)return this;var S=this._activeObject,D,L,U,$,ne,ye=0;if(u===S&&u.type==="activeSelection")for(ne=S._objects,D=0;D<ne.length;D++)L=ne[D],U=this._objects.indexOf(L),U>0+ye&&($=U-1,b(this._objects,L),this._objects.splice($,0,L)),ye++;else U=this._objects.indexOf(u),U!==0&&($=this._findNewLowerIndex(u,U,C),b(this._objects,u),this._objects.splice($,0,u));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(u,C,S){var D,L;if(S)for(D=C,L=C-1;L>=0;--L){var U=u.intersectsWithObject(this._objects[L])||u.isContainedWithinObject(this._objects[L])||this._objects[L].isContainedWithinObject(u);if(U){D=L;break}}else D=C-1;return D},bringForward:function(u,C){if(!u)return this;var S=this._activeObject,D,L,U,$,ne,ye=0;if(u===S&&u.type==="activeSelection")for(ne=S._objects,D=ne.length;D--;)L=ne[D],U=this._objects.indexOf(L),U<this._objects.length-1-ye&&($=U+1,b(this._objects,L),this._objects.splice($,0,L)),ye++;else U=this._objects.indexOf(u),U!==this._objects.length-1&&($=this._findNewUpperIndex(u,U,C),b(this._objects,u),this._objects.splice($,0,u));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(u,C,S){var D,L,U;if(S)for(D=C,L=C+1,U=this._objects.length;L<U;++L){var $=u.intersectsWithObject(this._objects[L])||u.isContainedWithinObject(this._objects[L])||this._objects[L].isContainedWithinObject(u);if($){D=L;break}}else D=C+1;return D},moveTo:function(u,C){return b(this._objects,u),this._objects.splice(C,0,u),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(I.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(u){u.dispose&&u.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),I.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),I.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),s(I.StaticCanvas.prototype,I.Observable),s(I.StaticCanvas.prototype,I.Collection),s(I.StaticCanvas.prototype,I.DataURLExporter),s(I.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(u){var C=p();if(!C||!C.getContext)return null;var S=C.getContext("2d");if(!S)return null;switch(u){case"setLineDash":return typeof S.setLineDash<"u";default:return null}}}),I.StaticCanvas.prototype.toJSON=I.StaticCanvas.prototype.toObject,I.isLikelyNode&&(I.StaticCanvas.prototype.createPNGStream=function(){var u=h(this.lowerCanvasEl);return u&&u.createPNGStream()},I.StaticCanvas.prototype.createJPEGStream=function(u){var C=h(this.lowerCanvasEl);return C&&C.createJPEGStream(u)})}(),I.BaseBrush=I.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(s){s.strokeStyle=this.color,s.lineWidth=this.width,s.lineCap=this.strokeLineCap,s.miterLimit=this.strokeMiterLimit,s.lineJoin=this.strokeLineJoin,s.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(s){var m=this.canvas.viewportTransform;s.save(),s.transform(m[0],m[1],m[2],m[3],m[4],m[5])},_setShadow:function(){if(this.shadow){var s=this.canvas,m=this.shadow,b=s.contextTop,x=s.getZoom();s&&s._isRetinaScaling()&&(x*=I.devicePixelRatio),b.shadowColor=m.color,b.shadowBlur=m.blur*x,b.shadowOffsetX=m.offsetX*x,b.shadowOffsetY=m.offsetY*x}},needsFullRender:function(){var s=new I.Color(this.color);return s.getAlpha()<1||!!this.shadow},_resetShadow:function(){var s=this.canvas.contextTop;s.shadowColor="",s.shadowBlur=s.shadowOffsetX=s.shadowOffsetY=0},_isOutSideCanvas:function(s){return s.x<0||s.x>this.canvas.getWidth()||s.y<0||s.y>this.canvas.getHeight()}}),function(){I.PencilBrush=I.util.createClass(I.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(s){this.canvas=s,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(s,m,b){var x=m.midPointFrom(b);return s.quadraticCurveTo(m.x,m.y,x.x,x.y),x},onMouseDown:function(s,m){this.canvas._isMainEvent(m.e)&&(this.drawStraightLine=m.e[this.straightLineKey],this._prepareForDrawing(s),this._captureDrawingPath(s),this._render())},onMouseMove:function(s,m){if(this.canvas._isMainEvent(m.e)&&(this.drawStraightLine=m.e[this.straightLineKey],!(this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s))&&this._captureDrawingPath(s)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var b=this._points,x=b.length,o=this.canvas.contextTop;this._saveAndTransform(o),this.oldEnd&&(o.beginPath(),o.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(o,b[x-2],b[x-1],!0),o.stroke(),o.restore()}},onMouseUp:function(s){return this.canvas._isMainEvent(s.e)?(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1):!0},_prepareForDrawing:function(s){var m=new I.Point(s.x,s.y);this._reset(),this._addPoint(m),this.canvas.contextTop.moveTo(m.x,m.y)},_addPoint:function(s){return this._points.length>1&&s.eq(this._points[this._points.length-1])?!1:(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(s),!0)},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(s){var m=new I.Point(s.x,s.y);return this._addPoint(m)},_render:function(s){var m,b,x=this._points[0],o=this._points[1];if(s=s||this.canvas.contextTop,this._saveAndTransform(s),s.beginPath(),this._points.length===2&&x.x===o.x&&x.y===o.y){var c=this.width/1e3;x=new I.Point(x.x,x.y),o=new I.Point(o.x,o.y),x.x-=c,o.x+=c}for(s.moveTo(x.x,x.y),m=1,b=this._points.length;m<b;m++)this._drawSegment(s,x,o),x=this._points[m],o=this._points[m+1];s.lineTo(x.x,x.y),s.stroke(),s.restore()},convertPointsToSVGPath:function(s){var m=this.width/1e3;return I.util.getSmoothPathFromPoints(s,m)},_isEmptySVGPath:function(s){var m=I.util.joinPath(s);return m==="M 0 0 Q 0 0 0 0 L 0 0"},createPath:function(s){var m=new I.Path(s,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,m.shadow=new I.Shadow(this.shadow)),m},decimatePoints:function(s,m){if(s.length<=2)return s;var b=this.canvas.getZoom(),x=Math.pow(m/b,2),o,c=s.length-1,h=s[0],p=[h],_;for(o=1;o<c-1;o++)_=Math.pow(h.x-s[o].x,2)+Math.pow(h.y-s[o].y,2),_>=x&&(h=s[o],p.push(h));return p.push(s[c]),p},_finalizeAndAddPath:function(){var s=this.canvas.contextTop;s.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var m=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(m)){this.canvas.requestRenderAll();return}var b=this.createPath(m);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:b}),this.canvas.add(b),this.canvas.requestRenderAll(),b.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:b})}})}(),I.CircleBrush=I.util.createClass(I.BaseBrush,{width:10,initialize:function(s){this.canvas=s,this.points=[]},drawDot:function(s){var m=this.addPoint(s),b=this.canvas.contextTop;this._saveAndTransform(b),this.dot(b,m),b.restore()},dot:function(s,m){s.fillStyle=m.fill,s.beginPath(),s.arc(m.x,m.y,m.radius,0,Math.PI*2,!1),s.closePath(),s.fill()},onMouseDown:function(s){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(s)},_render:function(){var s=this.canvas.contextTop,m,b,x=this.points;for(this._saveAndTransform(s),m=0,b=x.length;m<b;m++)this.dot(s,x[m]);s.restore()},onMouseMove:function(s){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(s),this._render()):this.drawDot(s))},onMouseUp:function(){var s=this.canvas.renderOnAddRemove,m,b;this.canvas.renderOnAddRemove=!1;var x=[];for(m=0,b=this.points.length;m<b;m++){var o=this.points[m],c=new I.Circle({radius:o.radius,left:o.x,top:o.y,originX:"center",originY:"center",fill:o.fill});this.shadow&&(c.shadow=new I.Shadow(this.shadow)),x.push(c)}var h=new I.Group(x);h.canvas=this.canvas,this.canvas.fire("before:path:created",{path:h}),this.canvas.add(h),this.canvas.fire("path:created",{path:h}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=s,this.canvas.requestRenderAll()},addPoint:function(s){var m=new I.Point(s.x,s.y),b=I.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,x=new I.Color(this.color).setAlpha(I.util.getRandomInt(0,100)/100).toRgba();return m.radius=b,m.fill=x,this.points.push(m),m}}),I.SprayBrush=I.util.createClass(I.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(s){this.canvas=s,this.sprayChunks=[]},onMouseDown:function(s){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(s),this.render(this.sprayChunkPoints)},onMouseMove:function(s){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s)||(this.addSprayChunk(s),this.render(this.sprayChunkPoints))},onMouseUp:function(){var s=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var m=[],b=0,x=this.sprayChunks.length;b<x;b++)for(var o=this.sprayChunks[b],c=0,h=o.length;c<h;c++){var p=new I.Rect({width:o[c].width,height:o[c].width,left:o[c].x+1,top:o[c].y+1,originX:"center",originY:"center",fill:this.color});m.push(p)}this.optimizeOverlapping&&(m=this._getOptimizedRects(m));var _=new I.Group(m);this.shadow&&_.set("shadow",new I.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:_}),this.canvas.add(_),this.canvas.fire("path:created",{path:_}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=s,this.canvas.requestRenderAll()},_getOptimizedRects:function(s){var m={},b,x,o;for(x=0,o=s.length;x<o;x++)b=s[x].left+""+s[x].top,m[b]||(m[b]=s[x]);var c=[];for(b in m)c.push(m[b]);return c},render:function(s){var m=this.canvas.contextTop,b,x;for(m.fillStyle=this.color,this._saveAndTransform(m),b=0,x=s.length;b<x;b++){var o=s[b];typeof o.opacity<"u"&&(m.globalAlpha=o.opacity),m.fillRect(o.x,o.y,o.width,o.width)}m.restore()},_render:function(){var s=this.canvas.contextTop,m,b;for(s.fillStyle=this.color,this._saveAndTransform(s),m=0,b=this.sprayChunks.length;m<b;m++)this.render(this.sprayChunks[m]);s.restore()},addSprayChunk:function(s){this.sprayChunkPoints=[];var m,b,x,o=this.width/2,c;for(c=0;c<this.density;c++){m=I.util.getRandomInt(s.x-o,s.x+o),b=I.util.getRandomInt(s.y-o,s.y+o),this.dotWidthVariance?x=I.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):x=this.dotWidth;var h=new I.Point(m,b);h.width=x,this.randomOpacity&&(h.opacity=I.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(h)}this.sprayChunks.push(this.sprayChunkPoints)}}),I.PatternBrush=I.util.createClass(I.PencilBrush,{getPatternSrc:function(){var s=20,m=5,b=I.util.createCanvasElement(),x=b.getContext("2d");return b.width=b.height=s+m,x.fillStyle=this.color,x.beginPath(),x.arc(s/2,s/2,s/2,0,Math.PI*2,!1),x.closePath(),x.fill(),b},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(s){return s.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(s){this.callSuper("_setBrushStyles",s),s.strokeStyle=this.getPattern(s)},createPath:function(s){var m=this.callSuper("createPath",s),b=m._getLeftTopCoords().scalarAdd(m.strokeWidth/2);return m.stroke=new I.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-b.x,offsetY:-b.y}),m}}),function(){var s=I.util.getPointer,m=I.util.degreesToRadians,b=I.util.isTouchEvent;I.Canvas=I.util.createClass(I.StaticCanvas,{initialize:function(o,c){c||(c={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(o,c),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=I.PencilBrush&&new I.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var o=this.getActiveObjects(),c,h,p;if(o.length>0&&!this.preserveObjectStacking){h=[],p=[];for(var _=0,u=this._objects.length;_<u;_++)c=this._objects[_],o.indexOf(c)===-1?h.push(c):p.push(c);o.length>1&&(this._activeObject._objects=p),h.push.apply(h,p)}else h=this._objects;return h},renderAll:function(){this.contextTopDirty&&!this._groupSelector&&!this.isDrawingMode&&(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var o=this.contextContainer;return this.renderCanvas(o,this._chooseObjectsToRender()),this},renderTopLayer:function(o){o.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(o),this.contextTopDirty=!0),o.restore()},renderTop:function(){var o=this.contextTop;return this.clearContext(o),this.renderTopLayer(o),this.fire("after:render"),this},_normalizePointer:function(o,c){var h=o.calcTransformMatrix(),p=I.util.invertTransform(h),_=this.restorePointerVpt(c);return I.util.transformPoint(_,p)},isTargetTransparent:function(o,c,h){if(o.shouldCache()&&o._cacheCanvas&&o!==this._activeObject){var p=this._normalizePointer(o,{x:c,y:h}),_=Math.max(o.cacheTranslationX+p.x*o.zoomX,0),u=Math.max(o.cacheTranslationY+p.y*o.zoomY,0),L=I.util.isTransparent(o._cacheContext,Math.round(_),Math.round(u),this.targetFindTolerance);return L}var C=this.contextCache,S=o.selectionBackgroundColor,D=this.viewportTransform;o.selectionBackgroundColor="",this.clearContext(C),C.save(),C.transform(D[0],D[1],D[2],D[3],D[4],D[5]),o.render(C),C.restore(),o.selectionBackgroundColor=S;var L=I.util.isTransparent(C,c,h,this.targetFindTolerance);return L},_isSelectionKeyPressed:function(o){var c=!1;return Array.isArray(this.selectionKey)?c=!!this.selectionKey.find(function(h){return o[h]===!0}):c=o[this.selectionKey],c},_shouldClearSelection:function(o,c){var h=this.getActiveObjects(),p=this._activeObject;return!c||c&&p&&h.length>1&&h.indexOf(c)===-1&&p!==c&&!this._isSelectionKeyPressed(o)||c&&!c.evented||c&&!c.selectable&&p&&p!==c},_shouldCenterTransform:function(o,c,h){if(o){var p;return c==="scale"||c==="scaleX"||c==="scaleY"||c==="resizing"?p=this.centeredScaling||o.centeredScaling:c==="rotate"&&(p=this.centeredRotation||o.centeredRotation),p?!h:h}},_getOriginFromCorner:function(o,c){var h={x:o.originX,y:o.originY};return c==="ml"||c==="tl"||c==="bl"?h.x="right":(c==="mr"||c==="tr"||c==="br")&&(h.x="left"),c==="tl"||c==="mt"||c==="tr"?h.y="bottom":(c==="bl"||c==="mb"||c==="br")&&(h.y="top"),h},_getActionFromCorner:function(o,c,h,p){if(!c||!o)return"drag";var _=p.controls[c];return _.getActionName(h,_,p)},_setupCurrentTransform:function(o,c,h){if(c){var p=this.getPointer(o),_=c.__corner,u=c.controls[_],C=h&&_?u.getActionHandler(o,c,u):I.controlsUtils.dragHandler,S=this._getActionFromCorner(h,_,o,c),D=this._getOriginFromCorner(c,_),L=o[this.centeredKey],U={target:c,action:S,actionHandler:C,corner:_,scaleX:c.scaleX,scaleY:c.scaleY,skewX:c.skewX,skewY:c.skewY,offsetX:p.x-c.left,offsetY:p.y-c.top,originX:D.x,originY:D.y,ex:p.x,ey:p.y,lastX:p.x,lastY:p.y,theta:m(c.angle),width:c.width*c.scaleX,shiftKey:o.shiftKey,altKey:L,original:I.util.saveObjectTransform(c)};this._shouldCenterTransform(c,S,L)&&(U.originX="center",U.originY="center"),U.original.originX=D.x,U.original.originY=D.y,this._currentTransform=U,this._beforeTransform(o)}},setCursor:function(o){this.upperCanvasEl.style.cursor=o},_drawSelection:function(o){var c=this._groupSelector,h=new I.Point(c.ex,c.ey),p=I.util.transformPoint(h,this.viewportTransform),_=new I.Point(c.ex+c.left,c.ey+c.top),u=I.util.transformPoint(_,this.viewportTransform),C=Math.min(p.x,u.x),S=Math.min(p.y,u.y),D=Math.max(p.x,u.x),L=Math.max(p.y,u.y),U=this.selectionLineWidth/2;this.selectionColor&&(o.fillStyle=this.selectionColor,o.fillRect(C,S,D-C,L-S)),!(!this.selectionLineWidth||!this.selectionBorderColor)&&(o.lineWidth=this.selectionLineWidth,o.strokeStyle=this.selectionBorderColor,C+=U,S+=U,D-=U,L-=U,I.Object.prototype._setLineDash.call(this,o,this.selectionDashArray),o.strokeRect(C,S,D-C,L-S))},findTarget:function(o,c){if(!this.skipTargetFind){var h=!0,p=this.getPointer(o,h),_=this._activeObject,u=this.getActiveObjects(),C,S,D=b(o),L=u.length>1&&!c||u.length===1;if(this.targets=[],L&&_._findTargetCorner(p,D)||u.length>1&&!c&&_===this._searchPossibleTargets([_],p))return _;if(u.length===1&&_===this._searchPossibleTargets([_],p))if(this.preserveObjectStacking)C=_,S=this.targets,this.targets=[];else return _;var U=this._searchPossibleTargets(this._objects,p);return o[this.altSelectionKey]&&U&&C&&U!==C&&(U=C,this.targets=S),U}},_checkTarget:function(o,c,h){if(c&&c.visible&&c.evented&&c.containsPoint(o))if((this.perPixelTargetFind||c.perPixelTargetFind)&&!c.isEditing){var p=this.isTargetTransparent(c,h.x,h.y);if(!p)return!0}else return!0},_searchPossibleTargets:function(o,c){for(var h,p=o.length,_;p--;){var u=o[p],C=u.group?this._normalizePointer(u.group,c):c;if(this._checkTarget(C,u,c)){h=o[p],h.subTargetCheck&&h instanceof I.Group&&(_=this._searchPossibleTargets(h._objects,c),_&&this.targets.push(_));break}}return h},restorePointerVpt:function(o){return I.util.transformPoint(o,I.util.invertTransform(this.viewportTransform))},getPointer:function(o,c){if(this._absolutePointer&&!c)return this._absolutePointer;if(this._pointer&&c)return this._pointer;var h=s(o),p=this.upperCanvasEl,_=p.getBoundingClientRect(),u=_.width||0,C=_.height||0,S;(!u||!C)&&("top"in _&&"bottom"in _&&(C=Math.abs(_.top-_.bottom)),"right"in _&&"left"in _&&(u=Math.abs(_.right-_.left))),this.calcOffset(),h.x=h.x-this._offset.left,h.y=h.y-this._offset.top,c||(h=this.restorePointerVpt(h));var D=this.getRetinaScaling();return D!==1&&(h.x/=D,h.y/=D),u===0||C===0?S={width:1,height:1}:S={width:p.width/u,height:p.height/C},{x:h.x*S.width,y:h.y*S.height}},_createUpperCanvas:function(){var o=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),c=this.lowerCanvasEl,h=this.upperCanvasEl;h?h.className="":(h=this._createCanvasElement(),this.upperCanvasEl=h),I.util.addClass(h,"upper-canvas "+o),this.wrapperEl.appendChild(h),this._copyCanvasStyle(c,h),this._applyCanvasStyle(h),this.contextTop=h.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=I.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),I.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),I.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(o){var c=this.width||o.width,h=this.height||o.height;I.util.setStyle(o,{position:"absolute",width:c+"px",height:h+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),o.width=c,o.height=h,I.util.makeElementUnselectable(o)},_copyCanvasStyle:function(o,c){c.style.cssText=o.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var o=this._activeObject;return o?o.type==="activeSelection"&&o._objects?o._objects.slice(0):[o]:[]},_onObjectRemoved:function(o){o===this._activeObject&&(this.fire("before:selection:cleared",{target:o}),this._discardActiveObject(),this.fire("selection:cleared",{target:o}),o.fire("deselected")),o===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",o)},_fireSelectionEvents:function(o,c){var h=!1,p=this.getActiveObjects(),_=[],u=[];o.forEach(function(C){p.indexOf(C)===-1&&(h=!0,C.fire("deselected",{e:c,target:C}),u.push(C))}),p.forEach(function(C){o.indexOf(C)===-1&&(h=!0,C.fire("selected",{e:c,target:C}),_.push(C))}),o.length>0&&p.length>0?h&&this.fire("selection:updated",{e:c,selected:_,deselected:u}):p.length>0?this.fire("selection:created",{e:c,selected:_}):o.length>0&&this.fire("selection:cleared",{e:c,deselected:u})},setActiveObject:function(o,c){var h=this.getActiveObjects();return this._setActiveObject(o,c),this._fireSelectionEvents(h,c),this},_setActiveObject:function(o,c){return this._activeObject===o||!this._discardActiveObject(c,o)||o.onSelect({e:c})?!1:(this._activeObject=o,!0)},_discardActiveObject:function(o,c){var h=this._activeObject;if(h){if(h.onDeselect({e:o,object:c}))return!1;this._activeObject=null}return!0},discardActiveObject:function(o){var c=this.getActiveObjects(),h=this.getActiveObject();return c.length&&this.fire("before:selection:cleared",{target:h,e:o}),this._discardActiveObject(o),this._fireSelectionEvents(c,o),this},dispose:function(){var o=this.wrapperEl;return this.removeListeners(),o.removeChild(this.upperCanvasEl),o.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach((function(c){I.util.cleanUpJsdomNode(this[c]),this[c]=void 0}).bind(this)),o.parentNode&&o.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,I.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(o){var c=this._activeObject;c&&c._renderControls(o)},_toObject:function(o,c,h){var p=this._realizeGroupTransformOnObject(o),_=this.callSuper("_toObject",o,c,h);return this._unwindGroupTransformOnObject(o,p),_},_realizeGroupTransformOnObject:function(o){if(o.group&&o.group.type==="activeSelection"&&this._activeObject===o.group){var c=["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"],h={};return c.forEach(function(p){h[p]=o[p]}),I.util.addTransformToObject(o,this._activeObject.calcOwnMatrix()),h}else return null},_unwindGroupTransformOnObject:function(o,c){c&&o.set(c)},_setSVGObject:function(o,c,h){var p=this._realizeGroupTransformOnObject(c);this.callSuper("_setSVGObject",o,c,h),this._unwindGroupTransformOnObject(c,p)},setViewportTransform:function(o){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),I.StaticCanvas.prototype.setViewportTransform.call(this,o)}});for(var x in I.StaticCanvas)x!=="prototype"&&(I.Canvas[x]=I.StaticCanvas[x])}(),function(){var s=I.util.addListener,m=I.util.removeListener,b=3,x=2,o=1,c={passive:!1};function h(p,_){return p.button&&p.button===_-1}I.util.object.extend(I.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(s,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(p,_){var u=this.upperCanvasEl,C=this._getEventPrefix();p(I.window,"resize",this._onResize),p(u,C+"down",this._onMouseDown),p(u,C+"move",this._onMouseMove,c),p(u,C+"out",this._onMouseOut),p(u,C+"enter",this._onMouseEnter),p(u,"wheel",this._onMouseWheel),p(u,"contextmenu",this._onContextMenu),p(u,"dblclick",this._onDoubleClick),p(u,"dragover",this._onDragOver),p(u,"dragenter",this._onDragEnter),p(u,"dragleave",this._onDragLeave),p(u,"drop",this._onDrop),this.enablePointerEvents||p(u,"touchstart",this._onTouchStart,c),typeof eventjs<"u"&&_ in eventjs&&(eventjs[_](u,"gesture",this._onGesture),eventjs[_](u,"drag",this._onDrag),eventjs[_](u,"orientation",this._onOrientationChange),eventjs[_](u,"shake",this._onShake),eventjs[_](u,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(m,"remove");var p=this._getEventPrefix();m(I.document,p+"up",this._onMouseUp),m(I.document,"touchend",this._onTouchEnd,c),m(I.document,p+"move",this._onMouseMove,c),m(I.document,"touchmove",this._onMouseMove,c)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(p,_){this.__onTransformGesture&&this.__onTransformGesture(p,_)},_onDrag:function(p,_){this.__onDrag&&this.__onDrag(p,_)},_onMouseWheel:function(p){this.__onMouseWheel(p)},_onMouseOut:function(p){var _=this._hoveredTarget;this.fire("mouse:out",{target:_,e:p}),this._hoveredTarget=null,_&&_.fire("mouseout",{e:p});var u=this;this._hoveredTargets.forEach(function(C){u.fire("mouse:out",{target:_,e:p}),C&&_.fire("mouseout",{e:p})}),this._hoveredTargets=[]},_onMouseEnter:function(p){!this._currentTransform&&!this.findTarget(p)&&(this.fire("mouse:over",{target:null,e:p}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(p,_){this.__onOrientationChange&&this.__onOrientationChange(p,_)},_onShake:function(p,_){this.__onShake&&this.__onShake(p,_)},_onLongPress:function(p,_){this.__onLongPress&&this.__onLongPress(p,_)},_onDragOver:function(p){p.preventDefault();var _=this._simpleEventHandler("dragover",p);this._fireEnterLeaveEvents(_,p)},_onDrop:function(p){return this._simpleEventHandler("drop:before",p),this._simpleEventHandler("drop",p)},_onContextMenu:function(p){return this.stopContextMenu&&(p.stopPropagation(),p.preventDefault()),!1},_onDoubleClick:function(p){this._cacheTransformEventData(p),this._handleEvent(p,"dblclick"),this._resetTransformEventData(p)},getPointerId:function(p){var _=p.changedTouches;return _?_[0]&&_[0].identifier:this.enablePointerEvents?p.pointerId:-1},_isMainEvent:function(p){return p.isPrimary===!0?!0:p.isPrimary===!1?!1:p.type==="touchend"&&p.touches.length===0?!0:p.changedTouches?p.changedTouches[0].identifier===this.mainTouchId:!0},_onTouchStart:function(p){p.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(p)),this.__onMouseDown(p),this._resetTransformEventData();var _=this.upperCanvasEl,u=this._getEventPrefix();s(I.document,"touchend",this._onTouchEnd,c),s(I.document,"touchmove",this._onMouseMove,c),m(_,u+"down",this._onMouseDown)},_onMouseDown:function(p){this.__onMouseDown(p),this._resetTransformEventData();var _=this.upperCanvasEl,u=this._getEventPrefix();m(_,u+"move",this._onMouseMove,c),s(I.document,u+"up",this._onMouseUp),s(I.document,u+"move",this._onMouseMove,c)},_onTouchEnd:function(p){if(!(p.touches.length>0)){this.__onMouseUp(p),this._resetTransformEventData(),this.mainTouchId=null;var _=this._getEventPrefix();m(I.document,"touchend",this._onTouchEnd,c),m(I.document,"touchmove",this._onMouseMove,c);var u=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){s(u.upperCanvasEl,_+"down",u._onMouseDown),u._willAddMouseDown=0},400)}},_onMouseUp:function(p){this.__onMouseUp(p),this._resetTransformEventData();var _=this.upperCanvasEl,u=this._getEventPrefix();this._isMainEvent(p)&&(m(I.document,u+"up",this._onMouseUp),m(I.document,u+"move",this._onMouseMove,c),s(_,u+"move",this._onMouseMove,c))},_onMouseMove:function(p){!this.allowTouchScrolling&&p.preventDefault&&p.preventDefault(),this.__onMouseMove(p)},_onResize:function(){this.calcOffset()},_shouldRender:function(p){var _=this._activeObject;return!!_!=!!p||_&&p&&_!==p?!0:(_&&_.isEditing,!1)},__onMouseUp:function(p){var _,u=this._currentTransform,C=this._groupSelector,S=!1,D=!C||C.left===0&&C.top===0;if(this._cacheTransformEventData(p),_=this._target,this._handleEvent(p,"up:before"),h(p,b)){this.fireRightClick&&this._handleEvent(p,"up",b,D);return}if(h(p,x)){this.fireMiddleClick&&this._handleEvent(p,"up",x,D),this._resetTransformEventData();return}if(this.isDrawingMode&&this._isCurrentlyDrawing){this._onMouseUpInDrawingMode(p);return}if(this._isMainEvent(p)){if(u&&(this._finalizeCurrentTransform(p),S=u.actionPerformed),!D){var L=_===this._activeObject;this._maybeGroupObjects(p),S||(S=this._shouldRender(_)||!L&&_===this._activeObject)}var U,$;if(_){if(U=_._findTargetCorner(this.getPointer(p,!0),I.util.isTouchEvent(p)),_.selectable&&_!==this._activeObject&&_.activeOn==="up")this.setActiveObject(_,p),S=!0;else{var ne=_.controls[U],ye=ne&&ne.getMouseUpHandler(p,_,ne);ye&&($=this.getPointer(p),ye(p,u,$.x,$.y))}_.isMoving=!1}if(u&&(u.target!==_||u.corner!==U)){var Ve=u.target&&u.target.controls[u.corner],Ke=Ve&&Ve.getMouseUpHandler(p,_,ne);$=$||this.getPointer(p),Ke&&Ke(p,u,$.x,$.y)}this._setCursorFromEvent(p,_),this._handleEvent(p,"up",o,D),this._groupSelector=null,this._currentTransform=null,_&&(_.__corner=0),S?this.requestRenderAll():D||this.renderTop()}},_simpleEventHandler:function(p,_){var u=this.findTarget(_),C=this.targets,S={e:_,target:u,subTargets:C};if(this.fire(p,S),u&&u.fire(p,S),!C)return u;for(var D=0;D<C.length;D++)C[D].fire(p,S);return u},_handleEvent:function(p,_,u,C){var S=this._target,D=this.targets||[],L={e:p,target:S,subTargets:D,button:u||o,isClick:C||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};_==="up"&&(L.currentTarget=this.findTarget(p),L.currentSubTargets=this.targets),this.fire("mouse:"+_,L),S&&S.fire("mouse"+_,L);for(var U=0;U<D.length;U++)D[U].fire("mouse"+_,L)},_finalizeCurrentTransform:function(p){var _=this._currentTransform,u=_.target,C={e:p,target:u,transform:_,action:_.action};u._scaling&&(u._scaling=!1),u.setCoords(),(_.actionPerformed||this.stateful&&u.hasStateChanged())&&this._fire("modified",C)},_onMouseDownInDrawingMode:function(p){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(p).requestRenderAll();var _=this.getPointer(p);this.freeDrawingBrush.onMouseDown(_,{e:p,pointer:_}),this._handleEvent(p,"down")},_onMouseMoveInDrawingMode:function(p){if(this._isCurrentlyDrawing){var _=this.getPointer(p);this.freeDrawingBrush.onMouseMove(_,{e:p,pointer:_})}this.setCursor(this.freeDrawingCursor),this._handleEvent(p,"move")},_onMouseUpInDrawingMode:function(p){var _=this.getPointer(p);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:p,pointer:_}),this._handleEvent(p,"up")},__onMouseDown:function(p){this._cacheTransformEventData(p),this._handleEvent(p,"down:before");var _=this._target;if(h(p,b)){this.fireRightClick&&this._handleEvent(p,"down",b);return}if(h(p,x)){this.fireMiddleClick&&this._handleEvent(p,"down",x);return}if(this.isDrawingMode){this._onMouseDownInDrawingMode(p);return}if(this._isMainEvent(p)&&!this._currentTransform){var u=this._pointer;this._previousPointer=u;var C=this._shouldRender(_),S=this._shouldGroup(p,_);if(this._shouldClearSelection(p,_)?this.discardActiveObject(p):S&&(this._handleGrouping(p,_),_=this._activeObject),this.selection&&(!_||!_.selectable&&!_.isEditing&&_!==this._activeObject)&&(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),_){var D=_===this._activeObject;_.selectable&&_.activeOn==="down"&&this.setActiveObject(_,p);var L=_._findTargetCorner(this.getPointer(p,!0),I.util.isTouchEvent(p));if(_.__corner=L,_===this._activeObject&&(L||!S)){this._setupCurrentTransform(p,_,D);var U=_.controls[L],u=this.getPointer(p),$=U&&U.getMouseDownHandler(p,_,U);$&&$(p,this._currentTransform,u.x,u.y)}}this._handleEvent(p,"down"),(C||S)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(p){this._resetTransformEventData(),this._pointer=this.getPointer(p,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(p)||null},_beforeTransform:function(p){var _=this._currentTransform;this.stateful&&_.target.saveState(),this.fire("before:transform",{e:p,transform:_})},__onMouseMove:function(p){this._handleEvent(p,"move:before"),this._cacheTransformEventData(p);var _,u;if(this.isDrawingMode){this._onMouseMoveInDrawingMode(p);return}if(this._isMainEvent(p)){var C=this._groupSelector;C?(u=this._absolutePointer,C.left=u.x-C.ex,C.top=u.y-C.ey,this.renderTop()):this._currentTransform?this._transformObject(p):(_=this.findTarget(p)||null,this._setCursorFromEvent(p,_),this._fireOverOutEvents(_,p)),this._handleEvent(p,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(p,_){var u=this._hoveredTarget,C=this._hoveredTargets,S=this.targets,D=Math.max(C.length,S.length);this.fireSyntheticInOutEvents(p,_,{oldTarget:u,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var L=0;L<D;L++)this.fireSyntheticInOutEvents(S[L],_,{oldTarget:C[L],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=p,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(p,_){var u=this._draggedoverTarget,C=this._hoveredTargets,S=this.targets,D=Math.max(C.length,S.length);this.fireSyntheticInOutEvents(p,_,{oldTarget:u,evtOut:"dragleave",evtIn:"dragenter"});for(var L=0;L<D;L++)this.fireSyntheticInOutEvents(S[L],_,{oldTarget:C[L],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=p},fireSyntheticInOutEvents:function(p,_,u){var C,S,D=u.oldTarget,L,U,$=D!==p,ne=u.canvasEvtIn,ye=u.canvasEvtOut;$&&(C={e:_,target:p,previousTarget:D},S={e:_,target:D,nextTarget:p}),U=p&&$,L=D&&$,L&&(ye&&this.fire(ye,S),D.fire(u.evtOut,S)),U&&(ne&&this.fire(ne,C),p.fire(u.evtIn,C))},__onMouseWheel:function(p){this._cacheTransformEventData(p),this._handleEvent(p,"wheel"),this._resetTransformEventData()},_transformObject:function(p){var _=this.getPointer(p),u=this._currentTransform;u.reset=!1,u.shiftKey=p.shiftKey,u.altKey=p[this.centeredKey],this._performTransformAction(p,u,_),u.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(p,_,u){var C=u.x,S=u.y,D=_.action,L=!1,U=_.actionHandler;U&&(L=U(p,_,C,S)),D==="drag"&&L&&(_.target.isMoving=!0,this.setCursor(_.target.moveCursor||this.moveCursor)),_.actionPerformed=_.actionPerformed||L},_fire:I.controlsUtils.fireEvent,_setCursorFromEvent:function(p,_){if(!_)return this.setCursor(this.defaultCursor),!1;var u=_.hoverCursor||this.hoverCursor,C=this._activeObject&&this._activeObject.type==="activeSelection"?this._activeObject:null,S=(!C||!C.contains(_))&&_._findTargetCorner(this.getPointer(p,!0));S?this.setCursor(this.getCornerCursor(S,_,p)):(_.subTargetCheck&&this.targets.concat().reverse().map(function(D){u=D.hoverCursor||u}),this.setCursor(u))},getCornerCursor:function(p,_,u){var C=_.controls[p];return C.cursorStyleHandler(u,C,_)}})}(),function(){var s=Math.min,m=Math.max;I.util.object.extend(I.Canvas.prototype,{_shouldGroup:function(b,x){var o=this._activeObject;return o&&this._isSelectionKeyPressed(b)&&x&&x.selectable&&this.selection&&(o!==x||o.type==="activeSelection")&&!x.onSelect({e:b})},_handleGrouping:function(b,x){var o=this._activeObject;o.__corner||x===o&&(x=this.findTarget(b,!0),!x||!x.selectable)||(o&&o.type==="activeSelection"?this._updateActiveSelection(x,b):this._createActiveSelection(x,b))},_updateActiveSelection:function(b,x){var o=this._activeObject,c=o._objects.slice(0);o.contains(b)?(o.removeWithUpdate(b),this._hoveredTarget=b,this._hoveredTargets=this.targets.concat(),o.size()===1&&this._setActiveObject(o.item(0),x)):(o.addWithUpdate(b),this._hoveredTarget=o,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(c,x)},_createActiveSelection:function(b,x){var o=this.getActiveObjects(),c=this._createGroup(b);this._hoveredTarget=c,this._setActiveObject(c,x),this._fireSelectionEvents(o,x)},_createGroup:function(b){var x=this._objects,o=x.indexOf(this._activeObject)<x.indexOf(b),c=o?[this._activeObject,b]:[b,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new I.ActiveSelection(c,{canvas:this})},_groupSelectedObjects:function(b){var x=this._collectObjects(b),o;x.length===1?this.setActiveObject(x[0],b):x.length>1&&(o=new I.ActiveSelection(x.reverse(),{canvas:this}),this.setActiveObject(o,b))},_collectObjects:function(b){for(var x=[],o,c=this._groupSelector.ex,h=this._groupSelector.ey,p=c+this._groupSelector.left,_=h+this._groupSelector.top,u=new I.Point(s(c,p),s(h,_)),C=new I.Point(m(c,p),m(h,_)),S=!this.selectionFullyContained,D=c===p&&h===_,L=this._objects.length;L--&&(o=this._objects[L],!(!(!o||!o.selectable||!o.visible)&&(S&&o.intersectsWithRect(u,C,!0)||o.isContainedWithinRect(u,C,!0)||S&&o.containsPoint(u,null,!0)||S&&o.containsPoint(C,null,!0))&&(x.push(o),D))););return x.length>1&&(x=x.filter(function(U){return!U.onSelect({e:b})})),x},_maybeGroupObjects:function(b){this.selection&&this._groupSelector&&this._groupSelectedObjects(b),this.setCursor(this.defaultCursor),this._groupSelector=null}})}(),function(){I.util.object.extend(I.StaticCanvas.prototype,{toDataURL:function(s){s||(s={});var m=s.format||"png",b=s.quality||1,x=(s.multiplier||1)*(s.enableRetinaScaling?this.getRetinaScaling():1),o=this.toCanvasElement(x,s);return I.util.toDataURL(o,m,b)},toCanvasElement:function(s,m){s=s||1,m=m||{};var b=(m.width||this.width)*s,x=(m.height||this.height)*s,o=this.getZoom(),c=this.width,h=this.height,p=o*s,_=this.viewportTransform,u=(_[4]-(m.left||0))*s,C=(_[5]-(m.top||0))*s,S=this.interactive,D=[p,0,0,p,u,C],L=this.enableRetinaScaling,U=I.util.createCanvasElement(),$=this.contextTop;return U.width=b,U.height=x,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=D,this.width=b,this.height=x,this.calcViewportBoundaries(),this.renderCanvas(U.getContext("2d"),this._objects),this.viewportTransform=_,this.width=c,this.height=h,this.calcViewportBoundaries(),this.interactive=S,this.enableRetinaScaling=L,this.contextTop=$,U}})}(),I.util.object.extend(I.StaticCanvas.prototype,{loadFromJSON:function(s,m,b){if(s){var x=typeof s=="string"?JSON.parse(s):I.util.object.clone(s),o=this,c=x.clipPath,h=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete x.clipPath,this._enlivenObjects(x.objects,function(p){o.clear(),o._setBgOverlay(x,function(){c?o._enlivenObjects([c],function(_){o.clipPath=_[0],o.__setupCanvas.call(o,x,p,h,m)}):o.__setupCanvas.call(o,x,p,h,m)})},b),this}},__setupCanvas:function(s,m,b,x){var o=this;m.forEach(function(c,h){o.insertAt(c,h)}),this.renderOnAddRemove=b,delete s.objects,delete s.backgroundImage,delete s.overlayImage,delete s.background,delete s.overlay,this._setOptions(s),this.renderAll(),x&&x()},_setBgOverlay:function(s,m){var b={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(!s.backgroundImage&&!s.overlayImage&&!s.background&&!s.overlay){m&&m();return}var x=function(){b.backgroundImage&&b.overlayImage&&b.backgroundColor&&b.overlayColor&&m&&m()};this.__setBgOverlay("backgroundImage",s.backgroundImage,b,x),this.__setBgOverlay("overlayImage",s.overlayImage,b,x),this.__setBgOverlay("backgroundColor",s.background,b,x),this.__setBgOverlay("overlayColor",s.overlay,b,x)},__setBgOverlay:function(s,m,b,x){var o=this;if(!m){b[s]=!0,x&&x();return}s==="backgroundImage"||s==="overlayImage"?I.util.enlivenObjects([m],function(c){o[s]=c[0],b[s]=!0,x&&x()}):this["set"+I.util.string.capitalize(s,!0)](m,function(){b[s]=!0,x&&x()})},_enlivenObjects:function(s,m,b){if(!s||s.length===0){m&&m([]);return}I.util.enlivenObjects(s,function(x){m&&m(x)},null,b)},_toDataURL:function(s,m){this.clone(function(b){m(b.toDataURL(s))})},_toDataURLWithMultiplier:function(s,m,b){this.clone(function(x){b(x.toDataURLWithMultiplier(s,m))})},clone:function(s,m){var b=JSON.stringify(this.toJSON(m));this.cloneWithoutData(function(x){x.loadFromJSON(b,function(){s&&s(x)})})},cloneWithoutData:function(s){var m=I.util.createCanvasElement();m.width=this.width,m.height=this.height;var b=new I.Canvas(m);this.backgroundImage?(b.setBackgroundImage(this.backgroundImage.src,function(){b.renderAll(),s&&s(b)}),b.backgroundImageOpacity=this.backgroundImageOpacity,b.backgroundImageStretch=this.backgroundImageStretch):s&&s(b)}}),function(s){var m=s.fabric||(s.fabric={}),b=m.util.object.extend,x=m.util.object.clone,o=m.util.toFixed,c=m.util.string.capitalize,h=m.util.degreesToRadians,p=!m.isLikelyNode,_=2;m.Object||(m.Object=m.util.createClass(m.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:p,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(u){u&&this.setOptions(u)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=m.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(u){var C=m.perfLimitSizeTotal,S=u.width,D=u.height,L=m.maxCacheSideLimit,U=m.minCacheSideLimit;if(S<=L&&D<=L&&S*D<=C)return S<U&&(u.width=U),D<U&&(u.height=U),u;var $=S/D,ne=m.util.limitDimsByArea($,C),ye=m.util.capValue,Ve=ye(U,ne.x,L),Ke=ye(U,ne.y,L);return S>Ve&&(u.zoomX/=S/Ve,u.width=Ve,u.capped=!0),D>Ke&&(u.zoomY/=D/Ke,u.height=Ke,u.capped=!0),u},_getCacheCanvasDimensions:function(){var u=this.getTotalObjectScaling(),C=this._getTransformedDimensions(0,0),S=C.x*u.scaleX/this.scaleX,D=C.y*u.scaleY/this.scaleY;return{width:S+_,height:D+_,zoomX:u.scaleX,zoomY:u.scaleY,x:S,y:D}},_updateCacheCanvas:function(){var u=this.canvas;if(this.noScaleCache&&u&&u._currentTransform){var C=u._currentTransform.target,S=u._currentTransform.action;if(this===C&&S.slice&&S.slice(0,5)==="scale")return!1}var D=this._cacheCanvas,L=this._limitCacheSize(this._getCacheCanvasDimensions()),U=m.minCacheSideLimit,$=L.width,ne=L.height,ye,Ve,Ke=L.zoomX,at=L.zoomY,$e=$!==this.cacheWidth||ne!==this.cacheHeight,ut=this.zoomX!==Ke||this.zoomY!==at,ot=$e||ut,vt=0,St=0,ct=!1;if($e){var Et=this._cacheCanvas.width,Q=this._cacheCanvas.height,de=$>Et||ne>Q,_e=($<Et*.9||ne<Q*.9)&&Et>U&&Q>U;ct=de||_e,de&&!L.capped&&($>U||ne>U)&&(vt=$*.1,St=ne*.1)}return this instanceof m.Text&&this.path&&(ot=!0,ct=!0,vt+=this.getHeightOfLine(0)*this.zoomX,St+=this.getHeightOfLine(0)*this.zoomY),ot?(ct?(D.width=Math.ceil($+vt),D.height=Math.ceil(ne+St)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,D.width,D.height)),ye=L.x/2,Ve=L.y/2,this.cacheTranslationX=Math.round(D.width/2-ye)+ye,this.cacheTranslationY=Math.round(D.height/2-Ve)+Ve,this.cacheWidth=$,this.cacheHeight=ne,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(Ke,at),this.zoomX=Ke,this.zoomY=at,!0):!1},setOptions:function(u){this._setOptions(u),this._initGradient(u.fill,"fill"),this._initGradient(u.stroke,"stroke"),this._initPattern(u.fill,"fill"),this._initPattern(u.stroke,"stroke")},transform:function(u){var C=this.group&&!this.group._transformDone||this.group&&this.canvas&&u===this.canvas.contextTop,S=this.calcTransformMatrix(!C);u.transform(S[0],S[1],S[2],S[3],S[4],S[5])},toObject:function(u){var C=m.Object.NUM_FRACTION_DIGITS,S={type:this.type,version:m.version,originX:this.originX,originY:this.originY,left:o(this.left,C),top:o(this.top,C),width:o(this.width,C),height:o(this.height,C),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:o(this.strokeWidth,C),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:o(this.strokeMiterLimit,C),scaleX:o(this.scaleX,C),scaleY:o(this.scaleY,C),angle:o(this.angle,C),flipX:this.flipX,flipY:this.flipY,opacity:o(this.opacity,C),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:o(this.skewX,C),skewY:o(this.skewY,C)};return this.clipPath&&!this.clipPath.excludeFromExport&&(S.clipPath=this.clipPath.toObject(u),S.clipPath.inverted=this.clipPath.inverted,S.clipPath.absolutePositioned=this.clipPath.absolutePositioned),m.util.populateWithProperties(this,S,u),this.includeDefaultValues||(S=this._removeDefaultValues(S)),S},toDatalessObject:function(u){return this.toObject(u)},_removeDefaultValues:function(u){var C=m.util.getKlass(u.type).prototype,S=C.stateProperties;return S.forEach(function(D){D==="left"||D==="top"||(u[D]===C[D]&&delete u[D],Array.isArray(u[D])&&Array.isArray(C[D])&&u[D].length===0&&C[D].length===0&&delete u[D])}),u},toString:function(){return"#<fabric."+c(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var u=m.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(u.scaleX),scaleY:Math.abs(u.scaleY)}},getTotalObjectScaling:function(){var u=this.getObjectScaling(),C=u.scaleX,S=u.scaleY;if(this.canvas){var D=this.canvas.getZoom(),L=this.canvas.getRetinaScaling();C*=D*L,S*=D*L}return{scaleX:C,scaleY:S}},getObjectOpacity:function(){var u=this.opacity;return this.group&&(u*=this.group.getObjectOpacity()),u},_set:function(u,C){var S=u==="scaleX"||u==="scaleY",D=this[u]!==C,L=!1;return S&&(C=this._constrainScale(C)),u==="scaleX"&&C<0?(this.flipX=!this.flipX,C*=-1):u==="scaleY"&&C<0?(this.flipY=!this.flipY,C*=-1):u==="shadow"&&C&&!(C instanceof m.Shadow)?C=new m.Shadow(C):u==="dirty"&&this.group&&this.group.set("dirty",C),this[u]=C,D&&(L=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(u)>-1?(this.dirty=!0,L&&this.group.set("dirty",!0)):L&&this.stateProperties.indexOf(u)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:m.iMatrix.concat()},isNotVisible:function(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible},render:function(u){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(u.save(),this._setupCompositeOperation(u),this.drawSelectionBackground(u),this.transform(u),this._setOpacity(u),this._setShadow(u,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(u)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(u),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),u.restore())},renderCache:function(u){u=u||{},(!this._cacheCanvas||!this._cacheContext)&&this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,u.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0},hasFill:function(){return this.fill&&this.fill!=="transparent"},needsItsOwnCache:function(){return!!(this.paintFirst==="stroke"&&this.hasFill()&&this.hasStroke()&&typeof this.shadow=="object"||this.clipPath)},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)},drawClipPathOnCache:function(u,C){if(u.save(),C.inverted?u.globalCompositeOperation="destination-out":u.globalCompositeOperation="destination-in",C.absolutePositioned){var S=m.util.invertTransform(this.calcTransformMatrix());u.transform(S[0],S[1],S[2],S[3],S[4],S[5])}C.transform(u),u.scale(1/C.zoomX,1/C.zoomY),u.drawImage(C._cacheCanvas,-C.cacheTranslationX,-C.cacheTranslationY),u.restore()},drawObject:function(u,C){var S=this.fill,D=this.stroke;C?(this.fill="black",this.stroke="",this._setClippingProperties(u)):this._renderBackground(u),this._render(u),this._drawClipPath(u,this.clipPath),this.fill=S,this.stroke=D},_drawClipPath:function(u,C){C&&(C.canvas=this.canvas,C.shouldCache(),C._transformDone=!0,C.renderCache({forClipping:!0}),this.drawClipPathOnCache(u,C))},drawCacheOnCanvas:function(u){u.scale(1/this.zoomX,1/this.zoomY),u.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(u){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!u&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!u){var C=this.cacheWidth/this.zoomX,S=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-C/2,-S/2,C,S)}return!0}return!1},_renderBackground:function(u){if(this.backgroundColor){var C=this._getNonTransformedDimensions();u.fillStyle=this.backgroundColor,u.fillRect(-C.x/2,-C.y/2,C.x,C.y),this._removeShadow(u)}},_setOpacity:function(u){this.group&&!this.group._transformDone?u.globalAlpha=this.getObjectOpacity():u.globalAlpha*=this.opacity},_setStrokeStyles:function(u,C){var S=C.stroke;S&&(u.lineWidth=C.strokeWidth,u.lineCap=C.strokeLineCap,u.lineDashOffset=C.strokeDashOffset,u.lineJoin=C.strokeLineJoin,u.miterLimit=C.strokeMiterLimit,S.toLive?S.gradientUnits==="percentage"||S.gradientTransform||S.patternTransform?this._applyPatternForTransformedGradient(u,S):(u.strokeStyle=S.toLive(u,this),this._applyPatternGradientTransform(u,S)):u.strokeStyle=C.stroke)},_setFillStyles:function(u,C){var S=C.fill;S&&(S.toLive?(u.fillStyle=S.toLive(u,this),this._applyPatternGradientTransform(u,C.fill)):u.fillStyle=S)},_setClippingProperties:function(u){u.globalAlpha=1,u.strokeStyle="transparent",u.fillStyle="#000000"},_setLineDash:function(u,C){!C||C.length===0||(1&C.length&&C.push.apply(C,C),u.setLineDash(C))},_renderControls:function(u,C){var S=this.getViewportTransform(),D=this.calcTransformMatrix(),L,U,$;C=C||{},U=typeof C.hasBorders<"u"?C.hasBorders:this.hasBorders,$=typeof C.hasControls<"u"?C.hasControls:this.hasControls,D=m.util.multiplyTransformMatrices(S,D),L=m.util.qrDecompose(D),u.save(),u.translate(L.translateX,L.translateY),u.lineWidth=1*this.borderScaleFactor,this.group||(u.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(L.angle-=180),u.rotate(h(this.group?L.angle:this.angle)),C.forActiveSelection||this.group?U&&this.drawBordersInGroup(u,L,C):U&&this.drawBorders(u,C),$&&this.drawControls(u,C),u.restore()},_setShadow:function(u){if(this.shadow){var C=this.shadow,S=this.canvas,D,L=S&&S.viewportTransform[0]||1,U=S&&S.viewportTransform[3]||1;C.nonScaling?D={scaleX:1,scaleY:1}:D=this.getObjectScaling(),S&&S._isRetinaScaling()&&(L*=m.devicePixelRatio,U*=m.devicePixelRatio),u.shadowColor=C.color,u.shadowBlur=C.blur*m.browserShadowBlurConstant*(L+U)*(D.scaleX+D.scaleY)/4,u.shadowOffsetX=C.offsetX*L*D.scaleX,u.shadowOffsetY=C.offsetY*U*D.scaleY}},_removeShadow:function(u){this.shadow&&(u.shadowColor="",u.shadowBlur=u.shadowOffsetX=u.shadowOffsetY=0)},_applyPatternGradientTransform:function(u,C){if(!C||!C.toLive)return{offsetX:0,offsetY:0};var S=C.gradientTransform||C.patternTransform,D=-this.width/2+C.offsetX||0,L=-this.height/2+C.offsetY||0;return C.gradientUnits==="percentage"?u.transform(this.width,0,0,this.height,D,L):u.transform(1,0,0,1,D,L),S&&u.transform(S[0],S[1],S[2],S[3],S[4],S[5]),{offsetX:D,offsetY:L}},_renderPaintInOrder:function(u){this.paintFirst==="stroke"?(this._renderStroke(u),this._renderFill(u)):(this._renderFill(u),this._renderStroke(u))},_render:function(){},_renderFill:function(u){this.fill&&(u.save(),this._setFillStyles(u,this),this.fillRule==="evenodd"?u.fill("evenodd"):u.fill(),u.restore())},_renderStroke:function(u){if(!(!this.stroke||this.strokeWidth===0)){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(u),u.save(),this.strokeUniform&&this.group){var C=this.getObjectScaling();u.scale(1/C.scaleX,1/C.scaleY)}else this.strokeUniform&&u.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(u,this.strokeDashArray),this._setStrokeStyles(u,this),u.stroke(),u.restore()}},_applyPatternForTransformedGradient:function(u,C){var S=this._limitCacheSize(this._getCacheCanvasDimensions()),D=m.util.createCanvasElement(),L,U=this.canvas.getRetinaScaling(),$=S.x/this.scaleX/U,ne=S.y/this.scaleY/U;D.width=$,D.height=ne,L=D.getContext("2d"),L.beginPath(),L.moveTo(0,0),L.lineTo($,0),L.lineTo($,ne),L.lineTo(0,ne),L.closePath(),L.translate($/2,ne/2),L.scale(S.zoomX/this.scaleX/U,S.zoomY/this.scaleY/U),this._applyPatternGradientTransform(L,C),L.fillStyle=C.toLive(u),L.fill(),u.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),u.scale(U*this.scaleX/S.zoomX,U*this.scaleY/S.zoomY),u.strokeStyle=L.createPattern(D,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var u=m.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",u.scaleX),this.set("scaleY",u.scaleY),this.angle=u.angle,this.skewX=u.skewX,this.skewY=0}},_removeTransformMatrix:function(u){var C=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),C=m.util.transformPoint(C,this.transformMatrix)),this.transformMatrix=null,u&&(this.scaleX*=u.scaleX,this.scaleY*=u.scaleY,this.cropX=u.cropX,this.cropY=u.cropY,C.x+=u.offsetLeft,C.y+=u.offsetTop,this.width=u.width,this.height=u.height),this.setPositionByOrigin(C,"center","center")},clone:function(u,C){var S=this.toObject(C);this.constructor.fromObject?this.constructor.fromObject(S,u):m.Object._fromObject("Object",S,u)},cloneAsImage:function(u,C){var S=this.toCanvasElement(C);return u&&u(new m.Image(S)),this},toCanvasElement:function(u){u||(u={});var C=m.util,S=C.saveObjectTransform(this),D=this.group,L=this.shadow,U=Math.abs,$=(u.multiplier||1)*(u.enableRetinaScaling?m.devicePixelRatio:1);delete this.group,u.withoutTransform&&C.resetObjectTransform(this),u.withoutShadow&&(this.shadow=null);var ne=m.util.createCanvasElement(),ye=this.getBoundingRect(!0,!0),Ve=this.shadow,Ke,at={x:0,y:0},$e,ut,ot;Ve&&($e=Ve.blur,Ve.nonScaling?Ke={scaleX:1,scaleY:1}:Ke=this.getObjectScaling(),at.x=2*Math.round(U(Ve.offsetX)+$e)*U(Ke.scaleX),at.y=2*Math.round(U(Ve.offsetY)+$e)*U(Ke.scaleY)),ut=ye.width+at.x,ot=ye.height+at.y,ne.width=Math.ceil(ut),ne.height=Math.ceil(ot);var vt=new m.StaticCanvas(ne,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});u.format==="jpeg"&&(vt.backgroundColor="#fff"),this.setPositionByOrigin(new m.Point(vt.width/2,vt.height/2),"center","center");var St=this.canvas;vt.add(this);var ct=vt.toCanvasElement($||1,u);return this.shadow=L,this.set("canvas",St),D&&(this.group=D),this.set(S).setCoords(),vt._objects=[],vt.dispose(),vt=null,ct},toDataURL:function(u){return u||(u={}),m.util.toDataURL(this.toCanvasElement(u),u.format||"png",u.quality||1)},isType:function(u){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===u},complexity:function(){return 1},toJSON:function(u){return this.toObject(u)},rotate:function(u){var C=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;return C&&this._setOriginToCenter(),this.set("angle",u),C&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(u,C){C=C||this.canvas.getPointer(u);var S=new m.Point(C.x,C.y),D=this._getLeftTopCoords();return this.angle&&(S=m.util.rotatePoint(S,D,h(-this.angle))),{x:S.x-D.x,y:S.y-D.y}},_setupCompositeOperation:function(u){this.globalCompositeOperation&&(u.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){m.runningAnimations&&m.runningAnimations.cancelByTarget(this)}}),m.util.createAccessors&&m.util.createAccessors(m.Object),b(m.Object.prototype,m.Observable),m.Object.NUM_FRACTION_DIGITS=2,m.Object.ENLIVEN_PROPS=["clipPath"],m.Object._fromObject=function(u,C,S,D){var L=m[u];C=x(C,!0),m.util.enlivenPatterns([C.fill,C.stroke],function(U){typeof U[0]<"u"&&(C.fill=U[0]),typeof U[1]<"u"&&(C.stroke=U[1]),m.util.enlivenObjectEnlivables(C,C,function(){var $=D?new L(C[D],C):new L(C);S&&S($)})})},m.Object.__uid=0)}(ie),function(){var s=I.util.degreesToRadians,m={left:-.5,center:0,right:.5},b={top:-.5,center:0,bottom:.5};I.util.object.extend(I.Object.prototype,{translateToGivenOrigin:function(x,o,c,h,p){var _=x.x,u=x.y,C,S,D;return typeof o=="string"?o=m[o]:o-=.5,typeof h=="string"?h=m[h]:h-=.5,C=h-o,typeof c=="string"?c=b[c]:c-=.5,typeof p=="string"?p=b[p]:p-=.5,S=p-c,(C||S)&&(D=this._getTransformedDimensions(),_=x.x+C*D.x,u=x.y+S*D.y),new I.Point(_,u)},translateToCenterPoint:function(x,o,c){var h=this.translateToGivenOrigin(x,o,c,"center","center");return this.angle?I.util.rotatePoint(h,x,s(this.angle)):h},translateToOriginPoint:function(x,o,c){var h=this.translateToGivenOrigin(x,"center","center",o,c);return this.angle?I.util.rotatePoint(h,x,s(this.angle)):h},getCenterPoint:function(){var x=new I.Point(this.left,this.top);return this.translateToCenterPoint(x,this.originX,this.originY)},getPointByOrigin:function(x,o){var c=this.getCenterPoint();return this.translateToOriginPoint(c,x,o)},toLocalPoint:function(x,o,c){var h=this.getCenterPoint(),p,_;return typeof o<"u"&&typeof c<"u"?p=this.translateToGivenOrigin(h,"center","center",o,c):p=new I.Point(this.left,this.top),_=new I.Point(x.x,x.y),this.angle&&(_=I.util.rotatePoint(_,h,-s(this.angle))),_.subtractEquals(p)},setPositionByOrigin:function(x,o,c){var h=this.translateToCenterPoint(x,o,c),p=this.translateToOriginPoint(h,this.originX,this.originY);this.set("left",p.x),this.set("top",p.y)},adjustPosition:function(x){var o=s(this.angle),c=this.getScaledWidth(),h=I.util.cos(o)*c,p=I.util.sin(o)*c,_,u;typeof this.originX=="string"?_=m[this.originX]:_=this.originX-.5,typeof x=="string"?u=m[x]:u=x-.5,this.left+=h*(u-_),this.top+=p*(u-_),this.setCoords(),this.originX=x},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var x=this.getCenterPoint();this.originX="center",this.originY="center",this.left=x.x,this.top=x.y},_resetOrigin:function(){var x=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=x.x,this.top=x.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}})}(),function(){function s(c){return[new I.Point(c.tl.x,c.tl.y),new I.Point(c.tr.x,c.tr.y),new I.Point(c.br.x,c.br.y),new I.Point(c.bl.x,c.bl.y)]}var m=I.util,b=m.degreesToRadians,x=m.multiplyTransformMatrices,o=m.transformPoint;m.object.extend(I.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(c,h){return h?c?this.calcACoords():this.calcLineCoords():((!this.aCoords||!this.lineCoords)&&this.setCoords(!0),c?this.aCoords:this.lineCoords)},getCoords:function(c,h){return s(this._getCoords(c,h))},intersectsWithRect:function(c,h,p,_){var u=this.getCoords(p,_),C=I.Intersection.intersectPolygonRectangle(u,c,h);return C.status==="Intersection"},intersectsWithObject:function(c,h,p){var _=I.Intersection.intersectPolygonPolygon(this.getCoords(h,p),c.getCoords(h,p));return _.status==="Intersection"||c.isContainedWithinObject(this,h,p)||this.isContainedWithinObject(c,h,p)},isContainedWithinObject:function(c,h,p){for(var _=this.getCoords(h,p),u=h?c.aCoords:c.lineCoords,C=0,S=c._getImageLines(u);C<4;C++)if(!c.containsPoint(_[C],S))return!1;return!0},isContainedWithinRect:function(c,h,p,_){var u=this.getBoundingRect(p,_);return u.left>=c.x&&u.left+u.width<=h.x&&u.top>=c.y&&u.top+u.height<=h.y},containsPoint:function(c,C,p,_){var u=this._getCoords(p,_),C=C||this._getImageLines(u),S=this._findCrossPoints(c,C);return S!==0&&S%2===1},isOnScreen:function(c){if(!this.canvas)return!1;var h=this.canvas.vptCoords.tl,p=this.canvas.vptCoords.br,_=this.getCoords(!0,c);return _.some(function(u){return u.x<=p.x&&u.x>=h.x&&u.y<=p.y&&u.y>=h.y})||this.intersectsWithRect(h,p,!0,c)?!0:this._containsCenterOfCanvas(h,p,c)},_containsCenterOfCanvas:function(c,h,p){var _={x:(c.x+h.x)/2,y:(c.y+h.y)/2};return!!this.containsPoint(_,null,!0,p)},isPartiallyOnScreen:function(c){if(!this.canvas)return!1;var h=this.canvas.vptCoords.tl,p=this.canvas.vptCoords.br;if(this.intersectsWithRect(h,p,!0,c))return!0;var _=this.getCoords(!0,c).every(function(u){return(u.x>=p.x||u.x<=h.x)&&(u.y>=p.y||u.y<=h.y)});return _&&this._containsCenterOfCanvas(h,p,c)},_getImageLines:function(c){var h={topline:{o:c.tl,d:c.tr},rightline:{o:c.tr,d:c.br},bottomline:{o:c.br,d:c.bl},leftline:{o:c.bl,d:c.tl}};return h},_findCrossPoints:function(c,h){var p,_,u,C,S,D=0,L;for(var U in h)if(L=h[U],!(L.o.y<c.y&&L.d.y<c.y)&&!(L.o.y>=c.y&&L.d.y>=c.y)&&(L.o.x===L.d.x&&L.o.x>=c.x?S=L.o.x:(p=0,_=(L.d.y-L.o.y)/(L.d.x-L.o.x),u=c.y-p*c.x,C=L.o.y-_*L.o.x,S=-(u-C)/(p-_)),S>=c.x&&(D+=1),D===2))break;return D},getBoundingRect:function(c,h){var p=this.getCoords(c,h);return m.makeBoundingBoxFromPoints(p)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(c){return Math.abs(c)<this.minScaleLimit?c<0?-this.minScaleLimit:this.minScaleLimit:c===0?1e-4:c},scale:function(c){return this._set("scaleX",c),this._set("scaleY",c),this.setCoords()},scaleToWidth:function(c,h){var p=this.getBoundingRect(h).width/this.getScaledWidth();return this.scale(c/this.width/p)},scaleToHeight:function(c,h){var p=this.getBoundingRect(h).height/this.getScaledHeight();return this.scale(c/this.height/p)},calcLineCoords:function(){var c=this.getViewportTransform(),h=this.padding,p=b(this.angle),_=m.cos(p),u=m.sin(p),C=_*h,S=u*h,D=C+S,L=C-S,U=this.calcACoords(),$={tl:o(U.tl,c),tr:o(U.tr,c),bl:o(U.bl,c),br:o(U.br,c)};return h&&($.tl.x-=L,$.tl.y-=D,$.tr.x+=D,$.tr.y-=L,$.bl.x-=D,$.bl.y+=L,$.br.x+=L,$.br.y+=D),$},calcOCoords:function(){var c=this._calcRotateMatrix(),h=this._calcTranslateMatrix(),p=this.getViewportTransform(),_=x(p,h),u=x(_,c),u=x(u,[1/p[0],0,0,1/p[3],0,0]),C=this._calculateCurrentDimensions(),S={};return this.forEachControl(function(D,L,U){S[L]=D.positionHandler(C,u,U)}),S},calcACoords:function(){var c=this._calcRotateMatrix(),h=this._calcTranslateMatrix(),p=x(h,c),_=this._getTransformedDimensions(),u=_.x/2,C=_.y/2;return{tl:o({x:-u,y:-C},p),tr:o({x:u,y:-C},p),bl:o({x:-u,y:C},p),br:o({x:u,y:C},p)}},setCoords:function(c){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),c?this:(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords(),this)},_calcRotateMatrix:function(){return m.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var c=this.getCenterPoint();return[1,0,0,1,c.x,c.y]},transformMatrixKey:function(c){var h="_",p="";return!c&&this.group&&(p=this.group.transformMatrixKey(c)+h),p+this.top+h+this.left+h+this.scaleX+h+this.scaleY+h+this.skewX+h+this.skewY+h+this.angle+h+this.originX+h+this.originY+h+this.width+h+this.height+h+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(c){var h=this.calcOwnMatrix();if(c||!this.group)return h;var p=this.transformMatrixKey(c),_=this.matrixCache||(this.matrixCache={});return _.key===p?_.value:(this.group&&(h=x(this.group.calcTransformMatrix(!1),h)),_.key=p,_.value=h,h)},calcOwnMatrix:function(){var c=this.transformMatrixKey(!0),h=this.ownMatrixCache||(this.ownMatrixCache={});if(h.key===c)return h.value;var p=this._calcTranslateMatrix(),_={angle:this.angle,translateX:p[4],translateY:p[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return h.key=c,h.value=m.composeMatrix(_),h.value},_getNonTransformedDimensions:function(){var c=this.strokeWidth,h=this.width+c,p=this.height+c;return{x:h,y:p}},_getTransformedDimensions:function(c,h){typeof c>"u"&&(c=this.skewX),typeof h>"u"&&(h=this.skewY);var p,_,u,C=c===0&&h===0;if(this.strokeUniform?(_=this.width,u=this.height):(p=this._getNonTransformedDimensions(),_=p.x,u=p.y),C)return this._finalizeDimensions(_*this.scaleX,u*this.scaleY);var S=m.sizeAfterTransform(_,u,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:c,skewY:h});return this._finalizeDimensions(S.x,S.y)},_finalizeDimensions:function(c,h){return this.strokeUniform?{x:c+this.strokeWidth,y:h+this.strokeWidth}:{x:c,y:h}},_calculateCurrentDimensions:function(){var c=this.getViewportTransform(),h=this._getTransformedDimensions(),p=o(h,c,!0);return p.scalarAdd(2*this.padding)}})}(),I.util.object.extend(I.Object.prototype,{sendToBack:function(){return this.group?I.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?I.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(s){return this.group?I.StaticCanvas.prototype.sendBackwards.call(this.group,this,s):this.canvas&&this.canvas.sendBackwards(this,s),this},bringForward:function(s){return this.group?I.StaticCanvas.prototype.bringForward.call(this.group,this,s):this.canvas&&this.canvas.bringForward(this,s),this},moveTo:function(s){return this.group&&this.group.type!=="activeSelection"?I.StaticCanvas.prototype.moveTo.call(this.group,this,s):this.canvas&&this.canvas.moveTo(this,s),this}}),function(){function s(b,x){if(x){if(x.toLive)return b+": url(#SVGID_"+x.id+"); ";var o=new I.Color(x),c=b+": "+o.toRgb()+"; ",h=o.getAlpha();return h!==1&&(c+=b+"-opacity: "+h.toString()+"; "),c}else return b+": none; "}var m=I.util.toFixed;I.util.object.extend(I.Object.prototype,{getSvgStyles:function(b){var x=this.fillRule?this.fillRule:"nonzero",o=this.strokeWidth?this.strokeWidth:"0",c=this.strokeDashArray?this.strokeDashArray.join(" "):"none",h=this.strokeDashOffset?this.strokeDashOffset:"0",p=this.strokeLineCap?this.strokeLineCap:"butt",_=this.strokeLineJoin?this.strokeLineJoin:"miter",u=this.strokeMiterLimit?this.strokeMiterLimit:"4",C=typeof this.opacity<"u"?this.opacity:"1",S=this.visible?"":" visibility: hidden;",D=b?"":this.getSvgFilter(),L=s("fill",this.fill),U=s("stroke",this.stroke);return[U,"stroke-width: ",o,"; ","stroke-dasharray: ",c,"; ","stroke-linecap: ",p,"; ","stroke-dashoffset: ",h,"; ","stroke-linejoin: ",_,"; ","stroke-miterlimit: ",u,"; ",L,"fill-rule: ",x,"; ","opacity: ",C,";",D,S].join("")},getSvgSpanStyles:function(b,x){var o="; ",h=b.fontFamily?"font-family: "+(b.fontFamily.indexOf("'")===-1&&b.fontFamily.indexOf('"')===-1?"'"+b.fontFamily+"'":b.fontFamily)+o:"",c=b.strokeWidth?"stroke-width: "+b.strokeWidth+o:"",h=h,p=b.fontSize?"font-size: "+b.fontSize+"px"+o:"",_=b.fontStyle?"font-style: "+b.fontStyle+o:"",u=b.fontWeight?"font-weight: "+b.fontWeight+o:"",C=b.fill?s("fill",b.fill):"",S=b.stroke?s("stroke",b.stroke):"",D=this.getSvgTextDecoration(b),L=b.deltaY?"baseline-shift: "+-b.deltaY+"; ":"";return D&&(D="text-decoration: "+D+o),[S,c,h,p,_,u,D,C,L,x?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(b){return["overline","underline","line-through"].filter(function(x){return b[x.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(b,x){var o=b?this.calcTransformMatrix():this.calcOwnMatrix(),c='transform="'+I.util.matrixToSVG(o);return c+(x||"")+'" '},_setSVGBg:function(b){if(this.backgroundColor){var x=I.Object.NUM_FRACTION_DIGITS;b.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',m(-this.width/2,x),'" y="',m(-this.height/2,x),'" width="',m(this.width,x),'" height="',m(this.height,x),`"></rect>
`)}},toSVG:function(b){return this._createBaseSVGMarkup(this._toSVG(b),{reviver:b})},toClipPathSVG:function(b){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(b),{reviver:b})},_createBaseClipPathSVGMarkup:function(b,x){x=x||{};var o=x.reviver,c=x.additionalTransform||"",h=[this.getSvgTransform(!0,c),this.getSvgCommons()].join(""),p=b.indexOf("COMMON_PARTS");return b[p]=h,o?o(b.join("")):b.join("")},_createBaseSVGMarkup:function(b,x){x=x||{};var o=x.noStyle,c=x.reviver,h=o?"":'style="'+this.getSvgStyles()+'" ',p=x.withShadow?'style="'+this.getSvgFilter()+'" ':"",_=this.clipPath,u=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",C=_&&_.absolutePositioned,S=this.stroke,D=this.fill,L=this.shadow,U,$=[],ne,ye=b.indexOf("COMMON_PARTS"),Ve=x.additionalTransform;return _&&(_.clipPathId="CLIPPATH_"+I.Object.__uid++,ne='<clipPath id="'+_.clipPathId+`" >
`+_.toClipPathSVG(c)+`</clipPath>
`),C&&$.push("<g ",p,this.getSvgCommons(),` >
`),$.push("<g ",this.getSvgTransform(!1),C?"":p+this.getSvgCommons(),` >
`),U=[h,u,o?"":this.addPaintOrder()," ",Ve?'transform="'+Ve+'" ':""].join(""),b[ye]=U,D&&D.toLive&&$.push(D.toSVG(this)),S&&S.toLive&&$.push(S.toSVG(this)),L&&$.push(L.toSVG(this)),_&&$.push(ne),$.push(b.join("")),$.push(`</g>
`),C&&$.push(`</g>
`),c?c($.join("")):$.join("")},addPaintOrder:function(){return this.paintFirst!=="fill"?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var s=I.util.object.extend,m="stateProperties";function b(o,c,h){var p={},_=!0;h.forEach(function(u){p[u]=o[u]}),s(o[c],p,_)}function x(o,c,h){if(o===c)return!0;if(Array.isArray(o)){if(!Array.isArray(c)||o.length!==c.length)return!1;for(var p=0,_=o.length;p<_;p++)if(!x(o[p],c[p]))return!1;return!0}else if(o&&typeof o=="object"){var u=Object.keys(o),C;if(!c||typeof c!="object"||!h&&u.length!==Object.keys(c).length)return!1;for(var p=0,_=u.length;p<_;p++)if(C=u[p],!(C==="canvas"||C==="group")&&!x(o[C],c[C]))return!1;return!0}}I.util.object.extend(I.Object.prototype,{hasStateChanged:function(o){o=o||m;var c="_"+o;return Object.keys(this[c]).length<this[o].length?!0:!x(this[c],this,!0)},saveState:function(o){var c=o&&o.propertySet||m,h="_"+c;return this[h]?(b(this,h,this[c]),o&&o.stateProperties&&b(this,h,o.stateProperties),this):this.setupState(o)},setupState:function(o){o=o||{};var c=o.propertySet||m;return o.propertySet=c,this["_"+c]={},this.saveState(o),this}})}(),function(){var s=I.util.degreesToRadians;I.util.object.extend(I.Object.prototype,{_findTargetCorner:function(m,b){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var x=m.x,o=m.y,c,h,p=Object.keys(this.oCoords),_=p.length-1,u;for(this.__corner=0;_>=0;_--)if(u=p[_],!!this.isControlVisible(u)&&(h=this._getImageLines(b?this.oCoords[u].touchCorner:this.oCoords[u].corner),c=this._findCrossPoints({x,y:o},h),c!==0&&c%2===1))return this.__corner=u,u;return!1},forEachControl:function(m){for(var b in this.controls)m(this.controls[b],b,this)},_setCornerCoords:function(){var m=this.oCoords;for(var b in m){var x=this.controls[b];m[b].corner=x.calcCornerCoords(this.angle,this.cornerSize,m[b].x,m[b].y,!1),m[b].touchCorner=x.calcCornerCoords(this.angle,this.touchCornerSize,m[b].x,m[b].y,!0)}},drawSelectionBackground:function(m){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;m.save();var b=this.getCenterPoint(),x=this._calculateCurrentDimensions(),o=this.canvas.viewportTransform;return m.translate(b.x,b.y),m.scale(1/o[0],1/o[3]),m.rotate(s(this.angle)),m.fillStyle=this.selectionBackgroundColor,m.fillRect(-x.x/2,-x.y/2,x.x,x.y),m.restore(),this},drawBorders:function(m,b){b=b||{};var x=this._calculateCurrentDimensions(),o=this.borderScaleFactor,c=x.x+o,h=x.y+o,p=typeof b.hasControls<"u"?b.hasControls:this.hasControls,_=!1;return m.save(),m.strokeStyle=b.borderColor||this.borderColor,this._setLineDash(m,b.borderDashArray||this.borderDashArray),m.strokeRect(-c/2,-h/2,c,h),p&&(m.beginPath(),this.forEachControl(function(u,C,S){u.withConnection&&u.getVisibility(S,C)&&(_=!0,m.moveTo(u.x*c,u.y*h),m.lineTo(u.x*c+u.offsetX,u.y*h+u.offsetY))}),_&&m.stroke()),m.restore(),this},drawBordersInGroup:function(m,b,x){x=x||{};var o=I.util.sizeAfterTransform(this.width,this.height,b),c=this.strokeWidth,h=this.strokeUniform,p=this.borderScaleFactor,_=o.x+c*(h?this.canvas.getZoom():b.scaleX)+p,u=o.y+c*(h?this.canvas.getZoom():b.scaleY)+p;return m.save(),this._setLineDash(m,x.borderDashArray||this.borderDashArray),m.strokeStyle=x.borderColor||this.borderColor,m.strokeRect(-_/2,-u/2,_,u),m.restore(),this},drawControls:function(m,b){b=b||{},m.save();var x=this.canvas.getRetinaScaling(),o,c;return m.setTransform(x,0,0,x,0,0),m.strokeStyle=m.fillStyle=b.cornerColor||this.cornerColor,this.transparentCorners||(m.strokeStyle=b.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(m,b.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(o=this.group.calcTransformMatrix()),this.forEachControl(function(h,p,_){c=_.oCoords[p],h.getVisibility(_,p)&&(o&&(c=I.util.transformPoint(c,o)),h.render(m,c.x,c.y,b,_))}),m.restore(),this},isControlVisible:function(m){return this.controls[m]&&this.controls[m].getVisibility(this,m)},setControlVisible:function(m,b){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[m]=b,this},setControlsVisibility:function(m){m||(m={});for(var b in m)this.setControlVisible(b,m[b]);return this},onDeselect:function(){},onSelect:function(){}})}(),I.util.object.extend(I.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(s,m){m=m||{};var b=function(){},x=m.onComplete||b,o=m.onChange||b,c=this;return I.util.animate({target:this,startValue:s.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(h){s.set("left",h),c.requestRenderAll(),o()},onComplete:function(){s.setCoords(),x()}})},fxCenterObjectV:function(s,m){m=m||{};var b=function(){},x=m.onComplete||b,o=m.onChange||b,c=this;return I.util.animate({target:this,startValue:s.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(h){s.set("top",h),c.requestRenderAll(),o()},onComplete:function(){s.setCoords(),x()}})},fxRemove:function(s,m){m=m||{};var b=function(){},x=m.onComplete||b,o=m.onChange||b,c=this;return I.util.animate({target:this,startValue:s.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(h){s.set("opacity",h),c.requestRenderAll(),o()},onComplete:function(){c.remove(s),x()}})}}),I.util.object.extend(I.Object.prototype,{animate:function(){if(arguments[0]&&typeof arguments[0]=="object"){var s=[],m,b,x=[];for(m in arguments[0])s.push(m);for(var o=0,c=s.length;o<c;o++)m=s[o],b=o!==c-1,x.push(this._animate(m,arguments[0][m],arguments[1],b));return x}else return this._animate.apply(this,arguments)},_animate:function(s,m,b,x){var o=this,c;m=m.toString(),b?b=I.util.object.clone(b):b={},~s.indexOf(".")&&(c=s.split("."));var h=o.colorProperties.indexOf(s)>-1||c&&o.colorProperties.indexOf(c[1])>-1,p=c?this.get(c[0])[c[1]]:this.get(s);"from"in b||(b.from=p),h||(~m.indexOf("=")?m=p+parseFloat(m.replace("=","")):m=parseFloat(m));var _={target:this,startValue:b.from,endValue:m,byValue:b.by,easing:b.easing,duration:b.duration,abort:b.abort&&function(u,C,S){return b.abort.call(o,u,C,S)},onChange:function(u,C,S){c?o[c[0]][c[1]]=u:o.set(s,u),!x&&b.onChange&&b.onChange(u,C,S)},onComplete:function(u,C,S){x||(o.setCoords(),b.onComplete&&b.onComplete(u,C,S))}};return h?I.util.animateColor(_.startValue,_.endValue,_.duration,_):I.util.animate(_)}}),function(s){var m=s.fabric||(s.fabric={}),b=m.util.object.extend,x=m.util.object.clone,o={x1:1,x2:1,y1:1,y2:1};if(m.Line){m.warn("fabric.Line is already defined");return}m.Line=m.util.createClass(m.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:m.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(h,p){h||(h=[0,0,0,0]),this.callSuper("initialize",p),this.set("x1",h[0]),this.set("y1",h[1]),this.set("x2",h[2]),this.set("y2",h[3]),this._setWidthHeight(p)},_setWidthHeight:function(h){h||(h={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in h?h.left:this._getLeftToOriginX(),this.top="top"in h?h.top:this._getTopToOriginY()},_set:function(h,p){return this.callSuper("_set",h,p),typeof o[h]<"u"&&this._setWidthHeight(),this},_getLeftToOriginX:c({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:c({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(h){h.beginPath();var p=this.calcLinePoints();h.moveTo(p.x1,p.y1),h.lineTo(p.x2,p.y2),h.lineWidth=this.strokeWidth;var _=h.strokeStyle;h.strokeStyle=this.stroke||h.fillStyle,this.stroke&&this._renderStroke(h),h.strokeStyle=_},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(h){return b(this.callSuper("toObject",h),this.calcLinePoints())},_getNonTransformedDimensions:function(){var h=this.callSuper("_getNonTransformedDimensions");return this.strokeLineCap==="butt"&&(this.width===0&&(h.y-=this.strokeWidth),this.height===0&&(h.x-=this.strokeWidth)),h},calcLinePoints:function(){var h=this.x1<=this.x2?-1:1,p=this.y1<=this.y2?-1:1,_=h*this.width*.5,u=p*this.height*.5,C=h*this.width*-.5,S=p*this.height*-.5;return{x1:_,x2:C,y1:u,y2:S}},_toSVG:function(){var h=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',h.x1,'" y1="',h.y1,'" x2="',h.x2,'" y2="',h.y2,`" />
`]}}),m.Line.ATTRIBUTE_NAMES=m.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),m.Line.fromElement=function(h,p,_){_=_||{};var u=m.parseAttributes(h,m.Line.ATTRIBUTE_NAMES),C=[u.x1||0,u.y1||0,u.x2||0,u.y2||0];p(new m.Line(C,b(u,_)))},m.Line.fromObject=function(h,p){function _(C){delete C.points,p&&p(C)}var u=x(h,!0);u.points=[h.x1,h.y1,h.x2,h.y2],m.Object._fromObject("Line",u,_,"points")};function c(h,p){var _=h.origin,u=h.axis1,C=h.axis2,S=h.dimension,D=p.nearest,L=p.center,U=p.farthest;return function(){switch(this.get(_)){case D:return Math.min(this.get(u),this.get(C));case L:return Math.min(this.get(u),this.get(C))+.5*this.get(S);case U:return Math.max(this.get(u),this.get(C))}}}}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.util.degreesToRadians;if(m.Circle){m.warn("fabric.Circle is already defined.");return}m.Circle=m.util.createClass(m.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:m.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(o,c){return this.callSuper("_set",o,c),o==="radius"&&this.setRadius(c),this},toObject:function(o){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(o))},_toSVG:function(){var o,c=0,h=0,p=(this.endAngle-this.startAngle)%360;if(p===0)o=["<circle ","COMMON_PARTS",'cx="'+c+'" cy="'+h+'" ','r="',this.radius,`" />
`];else{var _=b(this.startAngle),u=b(this.endAngle),C=this.radius,S=m.util.cos(_)*C,D=m.util.sin(_)*C,L=m.util.cos(u)*C,U=m.util.sin(u)*C,$=p>180?"1":"0";o=['<path d="M '+S+" "+D," A "+C+" "+C," 0 ",+$+" 1"," "+L+" "+U,'" ',"COMMON_PARTS",` />
`]}return o},_render:function(o){o.beginPath(),o.arc(0,0,this.radius,b(this.startAngle),b(this.endAngle),!1),this._renderPaintInOrder(o)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(o){return this.radius=o,this.set("width",o*2).set("height",o*2)}}),m.Circle.ATTRIBUTE_NAMES=m.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),m.Circle.fromElement=function(o,c){var h=m.parseAttributes(o,m.Circle.ATTRIBUTE_NAMES);if(!x(h))throw new Error("value of `r` attribute is required and can not be negative");h.left=(h.left||0)-h.radius,h.top=(h.top||0)-h.radius,c(new m.Circle(h))};function x(o){return"radius"in o&&o.radius>=0}m.Circle.fromObject=function(o,c){m.Object._fromObject("Circle",o,c)}}(ie),function(s){var m=s.fabric||(s.fabric={});if(m.Triangle){m.warn("fabric.Triangle is already defined");return}m.Triangle=m.util.createClass(m.Object,{type:"triangle",width:100,height:100,_render:function(b){var x=this.width/2,o=this.height/2;b.beginPath(),b.moveTo(-x,o),b.lineTo(0,-o),b.lineTo(x,o),b.closePath(),this._renderPaintInOrder(b)},_toSVG:function(){var b=this.width/2,x=this.height/2,o=[-b+" "+x,"0 "+-x,b+" "+x].join(",");return["<polygon ","COMMON_PARTS",'points="',o,'" />']}}),m.Triangle.fromObject=function(b,x){return m.Object._fromObject("Triangle",b,x)}}(ie),function(s){var m=s.fabric||(s.fabric={}),b=Math.PI*2;if(m.Ellipse){m.warn("fabric.Ellipse is already defined.");return}m.Ellipse=m.util.createClass(m.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:m.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(x){this.callSuper("initialize",x),this.set("rx",x&&x.rx||0),this.set("ry",x&&x.ry||0)},_set:function(x,o){switch(this.callSuper("_set",x,o),x){case"rx":this.rx=o,this.set("width",o*2);break;case"ry":this.ry=o,this.set("height",o*2);break}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(x){return this.callSuper("toObject",["rx","ry"].concat(x))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,`" />
`]},_render:function(x){x.beginPath(),x.save(),x.transform(1,0,0,this.ry/this.rx,0,0),x.arc(0,0,this.rx,0,b,!1),x.restore(),this._renderPaintInOrder(x)}}),m.Ellipse.ATTRIBUTE_NAMES=m.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),m.Ellipse.fromElement=function(x,o){var c=m.parseAttributes(x,m.Ellipse.ATTRIBUTE_NAMES);c.left=(c.left||0)-c.rx,c.top=(c.top||0)-c.ry,o(new m.Ellipse(c))},m.Ellipse.fromObject=function(x,o){m.Object._fromObject("Ellipse",x,o)}}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.util.object.extend;if(m.Rect){m.warn("fabric.Rect is already defined");return}m.Rect=m.util.createClass(m.Object,{stateProperties:m.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:m.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(x){this.callSuper("initialize",x),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(x){var o=this.rx?Math.min(this.rx,this.width/2):0,c=this.ry?Math.min(this.ry,this.height/2):0,h=this.width,p=this.height,_=-this.width/2,u=-this.height/2,C=o!==0||c!==0,S=1-.5522847498;x.beginPath(),x.moveTo(_+o,u),x.lineTo(_+h-o,u),C&&x.bezierCurveTo(_+h-S*o,u,_+h,u+S*c,_+h,u+c),x.lineTo(_+h,u+p-c),C&&x.bezierCurveTo(_+h,u+p-S*c,_+h-S*o,u+p,_+h-o,u+p),x.lineTo(_+o,u+p),C&&x.bezierCurveTo(_+S*o,u+p,_,u+p-S*c,_,u+p-c),x.lineTo(_,u+c),C&&x.bezierCurveTo(_,u+S*c,_+S*o,u,_+o,u),x.closePath(),this._renderPaintInOrder(x)},toObject:function(x){return this.callSuper("toObject",["rx","ry"].concat(x))},_toSVG:function(){var x=-this.width/2,o=-this.height/2;return["<rect ","COMMON_PARTS",'x="',x,'" y="',o,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,`" />
`]}}),m.Rect.ATTRIBUTE_NAMES=m.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),m.Rect.fromElement=function(x,o,c){if(!x)return o(null);c=c||{};var h=m.parseAttributes(x,m.Rect.ATTRIBUTE_NAMES);h.left=h.left||0,h.top=h.top||0,h.height=h.height||0,h.width=h.width||0;var p=new m.Rect(b(c?m.util.object.clone(c):{},h));p.visible=p.visible&&p.width>0&&p.height>0,o(p)},m.Rect.fromObject=function(x,o){return m.Object._fromObject("Rect",x,o)}}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.util.object.extend,x=m.util.array.min,o=m.util.array.max,c=m.util.toFixed,h=m.util.projectStrokeOnPoints;if(m.Polyline){m.warn("fabric.Polyline is already defined");return}m.Polyline=m.util.createClass(m.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:m.Object.prototype.cacheProperties.concat("points"),initialize:function(p,_){_=_||{},this.points=p||[],this.callSuper("initialize",_),this._setPositionDimensions(_)},_projectStrokeOnPoints:function(){return h(this.points,this,!0)},_setPositionDimensions:function(p){var _=this._calcDimensions(p),u,C=this.exactBoundingBox?this.strokeWidth:0;this.width=_.width-C,this.height=_.height-C,p.fromSVG||(u=this.translateToGivenOrigin({x:_.left-this.strokeWidth/2+C/2,y:_.top-this.strokeWidth/2+C/2},"left","top",this.originX,this.originY)),typeof p.left>"u"&&(this.left=p.fromSVG?_.left:u.x),typeof p.top>"u"&&(this.top=p.fromSVG?_.top:u.y),this.pathOffset={x:_.left+this.width/2+C/2,y:_.top+this.height/2+C/2}},_calcDimensions:function(){var p=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,_=x(p,"x")||0,u=x(p,"y")||0,C=o(p,"x")||0,S=o(p,"y")||0,D=C-_,L=S-u;return{left:_,top:u,width:D,height:L}},toObject:function(p){return b(this.callSuper("toObject",p),{points:this.points.concat()})},_toSVG:function(){for(var p=[],_=this.pathOffset.x,u=this.pathOffset.y,C=m.Object.NUM_FRACTION_DIGITS,S=0,D=this.points.length;S<D;S++)p.push(c(this.points[S].x-_,C),",",c(this.points[S].y-u,C)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',p.join(""),`" />
`]},commonRender:function(p){var _,u=this.points.length,C=this.pathOffset.x,S=this.pathOffset.y;if(!u||isNaN(this.points[u-1].y))return!1;p.beginPath(),p.moveTo(this.points[0].x-C,this.points[0].y-S);for(var D=0;D<u;D++)_=this.points[D],p.lineTo(_.x-C,_.y-S);return!0},_render:function(p){this.commonRender(p)&&this._renderPaintInOrder(p)},complexity:function(){return this.get("points").length}}),m.Polyline.ATTRIBUTE_NAMES=m.SHARED_ATTRIBUTES.concat(),m.Polyline.fromElementGenerator=function(p){return function(_,u,C){if(!_)return u(null);C||(C={});var S=m.parsePointsAttribute(_.getAttribute("points")),D=m.parseAttributes(_,m[p].ATTRIBUTE_NAMES);D.fromSVG=!0,u(new m[p](S,b(D,C)))}},m.Polyline.fromElement=m.Polyline.fromElementGenerator("Polyline"),m.Polyline.fromObject=function(p,_){return m.Object._fromObject("Polyline",p,_,"points")}}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.util.projectStrokeOnPoints;if(m.Polygon){m.warn("fabric.Polygon is already defined");return}m.Polygon=m.util.createClass(m.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return b(this.points,this)},_render:function(x){this.commonRender(x)&&(x.closePath(),this._renderPaintInOrder(x))}}),m.Polygon.ATTRIBUTE_NAMES=m.SHARED_ATTRIBUTES.concat(),m.Polygon.fromElement=m.Polyline.fromElementGenerator("Polygon"),m.Polygon.fromObject=function(x,o){m.Object._fromObject("Polygon",x,o,"points")}}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.util.array.min,x=m.util.array.max,o=m.util.object.extend,c=m.util.object.clone,h=m.util.toFixed;if(m.Path){m.warn("fabric.Path is already defined");return}m.Path=m.util.createClass(m.Object,{type:"path",path:null,cacheProperties:m.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:m.Object.prototype.stateProperties.concat("path"),initialize:function(p,_){_=c(_||{}),delete _.path,this.callSuper("initialize",_),this._setPath(p||[],_)},_setPath:function(p,_){this.path=m.util.makePathSimpler(Array.isArray(p)?p:m.util.parsePath(p)),m.Polyline.prototype._setPositionDimensions.call(this,_||{})},_renderPathCommands:function(p){var _,u=0,C=0,S=0,D=0,L=0,U=0,$=-this.pathOffset.x,ne=-this.pathOffset.y;p.beginPath();for(var ye=0,Ve=this.path.length;ye<Ve;++ye)switch(_=this.path[ye],_[0]){case"L":S=_[1],D=_[2],p.lineTo(S+$,D+ne);break;case"M":S=_[1],D=_[2],u=S,C=D,p.moveTo(S+$,D+ne);break;case"C":S=_[5],D=_[6],L=_[3],U=_[4],p.bezierCurveTo(_[1]+$,_[2]+ne,L+$,U+ne,S+$,D+ne);break;case"Q":p.quadraticCurveTo(_[1]+$,_[2]+ne,_[3]+$,_[4]+ne),S=_[3],D=_[4],L=_[1],U=_[2];break;case"z":case"Z":S=u,D=C,p.closePath();break}},_render:function(p){this._renderPathCommands(p),this._renderPaintInOrder(p)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(p){return o(this.callSuper("toObject",p),{path:this.path.map(function(_){return _.slice()})})},toDatalessObject:function(p){var _=this.toObject(["sourcePath"].concat(p));return _.sourcePath&&delete _.path,_},_toSVG:function(){var p=m.util.joinPath(this.path);return["<path ","COMMON_PARTS",'d="',p,'" stroke-linecap="round" ',`/>
`]},_getOffsetTransform:function(){var p=m.Object.NUM_FRACTION_DIGITS;return" translate("+h(-this.pathOffset.x,p)+", "+h(-this.pathOffset.y,p)+")"},toClipPathSVG:function(p){var _=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:p,additionalTransform:_})},toSVG:function(p){var _=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:p,additionalTransform:_})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var p=[],_=[],u,C=0,S=0,D=0,L=0,U,$=0,ne=this.path.length;$<ne;++$){switch(u=this.path[$],u[0]){case"L":D=u[1],L=u[2],U=[];break;case"M":D=u[1],L=u[2],C=D,S=L,U=[];break;case"C":U=m.util.getBoundsOfCurve(D,L,u[1],u[2],u[3],u[4],u[5],u[6]),D=u[5],L=u[6];break;case"Q":U=m.util.getBoundsOfCurve(D,L,u[1],u[2],u[1],u[2],u[3],u[4]),D=u[3],L=u[4];break;case"z":case"Z":D=C,L=S;break}U.forEach(function(ot){p.push(ot.x),_.push(ot.y)}),p.push(D),_.push(L)}var ye=b(p)||0,Ve=b(_)||0,Ke=x(p)||0,at=x(_)||0,$e=Ke-ye,ut=at-Ve;return{left:ye,top:Ve,width:$e,height:ut}}}),m.Path.fromObject=function(p,_){if(typeof p.sourcePath=="string"){var u=p.sourcePath;m.loadSVGFromURL(u,function(C){var S=C[0];S.setOptions(p),p.clipPath?m.util.enlivenObjects([p.clipPath],function(D){S.clipPath=D[0],_&&_(S)}):_&&_(S)})}else m.Object._fromObject("Path",p,_,"path")},m.Path.ATTRIBUTE_NAMES=m.SHARED_ATTRIBUTES.concat(["d"]),m.Path.fromElement=function(p,_,u){var C=m.parseAttributes(p,m.Path.ATTRIBUTE_NAMES);C.fromSVG=!0,_(new m.Path(C.d,o(C,u)))}}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.util.array.min,x=m.util.array.max;m.Group||(m.Group=m.util.createClass(m.Object,m.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(o,c,h){c=c||{},this._objects=[],h&&this.callSuper("initialize",c),this._objects=o||[];for(var p=this._objects.length;p--;)this._objects[p].group=this;if(h)this._updateObjectsACoords();else{var _=c&&c.centerPoint;c.originX!==void 0&&(this.originX=c.originX),c.originY!==void 0&&(this.originY=c.originY),_||this._calcBounds(),this._updateObjectsCoords(_),delete c.centerPoint,this.callSuper("initialize",c)}this.setCoords()},_updateObjectsACoords:function(){for(var o=!0,c=this._objects.length;c--;)this._objects[c].setCoords(o)},_updateObjectsCoords:function(c){for(var c=c||this.getCenterPoint(),h=this._objects.length;h--;)this._updateObjectCoords(this._objects[h],c)},_updateObjectCoords:function(o,c){var h=o.left,p=o.top,_=!0;o.set({left:h-c.x,top:p-c.y}),o.group=this,o.setCoords(_)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(o){var c=!!this.group;return this._restoreObjectsState(),m.util.resetObjectTransform(this),o&&(c&&m.util.removeTransformFromObject(o,this.group.calcTransformMatrix()),this._objects.push(o),o.group=this,o._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,c?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(o){return this._restoreObjectsState(),m.util.resetObjectTransform(this),this.remove(o),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(o){this.dirty=!0,o.group=this,o._set("canvas",this.canvas)},_onObjectRemoved:function(o){this.dirty=!0,delete o.group},_set:function(o,c){var h=this._objects.length;if(this.useSetOnGroup)for(;h--;)this._objects[h].setOnGroup(o,c);if(o==="canvas")for(;h--;)this._objects[h]._set(o,c);m.Object.prototype._set.call(this,o,c)},toObject:function(o){var c=this.includeDefaultValues,h=this._objects.filter(function(_){return!_.excludeFromExport}).map(function(_){var u=_.includeDefaultValues;_.includeDefaultValues=c;var C=_.toObject(o);return _.includeDefaultValues=u,C}),p=m.Object.prototype.toObject.call(this,o);return p.objects=h,p},toDatalessObject:function(o){var c,h=this.sourcePath;if(h)c=h;else{var p=this.includeDefaultValues;c=this._objects.map(function(u){var C=u.includeDefaultValues;u.includeDefaultValues=p;var S=u.toDatalessObject(o);return u.includeDefaultValues=C,S})}var _=m.Object.prototype.toDatalessObject.call(this,o);return _.objects=c,_},render:function(o){this._transformDone=!0,this.callSuper("render",o),this._transformDone=!1},shouldCache:function(){var o=m.Object.prototype.shouldCache.call(this);if(o){for(var c=0,h=this._objects.length;c<h;c++)if(this._objects[c].willDrawShadow())return this.ownCaching=!1,!1}return o},willDrawShadow:function(){if(m.Object.prototype.willDrawShadow.call(this))return!0;for(var o=0,c=this._objects.length;o<c;o++)if(this._objects[o].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(o){for(var c=0,h=this._objects.length;c<h;c++)this._objects[c].render(o);this._drawClipPath(o,this.clipPath)},isCacheDirty:function(o){if(this.callSuper("isCacheDirty",o))return!0;if(!this.statefullCache)return!1;for(var c=0,h=this._objects.length;c<h;c++)if(this._objects[c].isCacheDirty(!0)){if(this._cacheCanvas){var p=this.cacheWidth/this.zoomX,_=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-p/2,-_/2,p,_)}return!0}return!1},_restoreObjectsState:function(){var o=this.calcOwnMatrix();return this._objects.forEach(function(c){m.util.addTransformToObject(c,o),delete c.group,c.setCoords()}),this},destroy:function(){return this._objects.forEach(function(o){o.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(o){o.dispose&&o.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var o=this._objects,c=this.canvas;this._objects=[];var h=this.toObject();delete h.objects;var p=new m.ActiveSelection([]);return p.set(h),p.type="activeSelection",c.remove(this),o.forEach(function(_){_.group=p,_.dirty=!0,c.add(_)}),p.canvas=c,p._objects=o,c._activeObject=p,p.setCoords(),p}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){var o=!0;return this.forEachObject(function(c){c.setCoords(o)}),this},_calcBounds:function(o){for(var c=[],h=[],p,_,u,C=["tr","br","bl","tl"],S=0,D=this._objects.length,L,U=C.length;S<D;++S){for(p=this._objects[S],u=p.calcACoords(),L=0;L<U;L++)_=C[L],c.push(u[_].x),h.push(u[_].y);p.aCoords=u}this._getBounds(c,h,o)},_getBounds:function(o,c,h){var p=new m.Point(b(o),b(c)),_=new m.Point(x(o),x(c)),u=p.y||0,C=p.x||0,S=_.x-p.x||0,D=_.y-p.y||0;this.width=S,this.height=D,h||this.setPositionByOrigin({x:C,y:u},"left","top")},_toSVG:function(o){for(var c=["<g ","COMMON_PARTS",` >
`],h=0,p=this._objects.length;h<p;h++)c.push("		",this._objects[h].toSVG(o));return c.push(`</g>
`),c},getSvgStyles:function(){var o=typeof this.opacity<"u"&&this.opacity!==1?"opacity: "+this.opacity+";":"",c=this.visible?"":" visibility: hidden;";return[o,this.getSvgFilter(),c].join("")},toClipPathSVG:function(o){for(var c=[],h=0,p=this._objects.length;h<p;h++)c.push("	",this._objects[h].toClipPathSVG(o));return this._createBaseClipPathSVGMarkup(c,{reviver:o})}}),m.Group.fromObject=function(o,c){var h=o.objects,p=m.util.object.clone(o,!0);if(delete p.objects,typeof h=="string"){m.loadSVGFromURL(h,function(_){var u=m.util.groupSVGElements(_,o,h),C=p.clipPath;delete p.clipPath,u.set(p),C?m.util.enlivenObjects([C],function(S){u.clipPath=S[0],c&&c(u)}):c&&c(u)});return}m.util.enlivenObjects(h,function(_){m.util.enlivenObjectEnlivables(o,p,function(){c&&c(new m.Group(_,p,!0))})})})}(ie),function(s){var m=s.fabric||(s.fabric={});m.ActiveSelection||(m.ActiveSelection=m.util.createClass(m.Group,{type:"activeSelection",initialize:function(b,x){x=x||{},this._objects=b||[];for(var o=this._objects.length;o--;)this._objects[o].group=this;x.originX&&(this.originX=x.originX),x.originY&&(this.originY=x.originY),this._calcBounds(),this._updateObjectsCoords(),m.Object.prototype.initialize.call(this,x),this.setCoords()},toGroup:function(){var b=this._objects.concat();this._objects=[];var x=m.Object.prototype.toObject.call(this),o=new m.Group([]);if(delete x.type,o.set(x),b.forEach(function(h){h.canvas.remove(h),h.group=o}),o._objects=b,!this.canvas)return o;var c=this.canvas;return c.add(o),c._activeObject=o,o.setCoords(),o},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(b,x,o){b.save(),b.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",b,x),o=o||{},typeof o.hasControls>"u"&&(o.hasControls=!1),o.forActiveSelection=!0;for(var c=0,h=this._objects.length;c<h;c++)this._objects[c]._renderControls(b,o);b.restore()}}),m.ActiveSelection.fromObject=function(b,x){m.util.enlivenObjects(b.objects,function(o){delete b.objects,x&&x(new m.ActiveSelection(o,b,!0))})})}(ie),function(s){var m=I.util.object.extend;if(s.fabric||(s.fabric={}),s.fabric.Image){I.warn("fabric.Image is already defined.");return}I.Image=I.util.createClass(I.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:I.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:I.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(b,x){x||(x={}),this.filters=[],this.cacheKey="texture"+I.Object.__uid++,this.callSuper("initialize",x),this._initElement(b,x)},getElement:function(){return this._element||{}},setElement:function(b,x){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=b,this._originalElement=b,this._initConfig(x),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(b){var x=I.filterBackend;x&&x.evictCachesForKey&&x.evictCachesForKey(b)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((function(b){I.util.cleanUpJsdomNode(this[b]),this[b]=void 0}).bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var b=this.getElement();return{width:b.naturalWidth||b.width,height:b.naturalHeight||b.height}},_stroke:function(b){if(!(!this.stroke||this.strokeWidth===0)){var x=this.width/2,o=this.height/2;b.beginPath(),b.moveTo(-x,-o),b.lineTo(x,-o),b.lineTo(x,o),b.lineTo(-x,o),b.lineTo(-x,-o),b.closePath()}},toObject:function(b){var x=[];this.filters.forEach(function(c){c&&x.push(c.toObject())});var o=m(this.callSuper("toObject",["cropX","cropY"].concat(b)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:x});return this.resizeFilter&&(o.resizeFilter=this.resizeFilter.toObject()),o},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var b=[],x=[],o,c=this._element,h=-this.width/2,p=-this.height/2,_="",u="";if(!c)return[];if(this.hasCrop()){var C=I.Object.__uid++;b.push('<clipPath id="imageCrop_'+C+`">
`,'	<rect x="'+h+'" y="'+p+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),_=' clip-path="url(#imageCrop_'+C+')" '}if(this.imageSmoothing||(u='" image-rendering="optimizeSpeed'),x.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',h-this.cropX,'" y="',p-this.cropY,'" width="',c.width||c.naturalWidth,'" height="',c.height||c.height,u,'"',_,`></image>
`),this.stroke||this.strokeDashArray){var S=this.fill;this.fill=null,o=["	<rect ",'x="',h,'" y="',p,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),`"/>
`],this.fill=S}return this.paintFirst!=="fill"?b=b.concat(o,x):b=b.concat(x,o),b},getSrc:function(b){var x=b?this._element:this._originalElement;return x?x.toDataURL?x.toDataURL():this.srcFromAttribute?x.getAttribute("src"):x.src:this.src||""},setSrc:function(b,x,o){return I.util.loadImage(b,function(c,h){this.setElement(c,o),this._setWidthHeight(),x&&x(this,h)},this,o&&o.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var b=this.resizeFilter,x=this.minimumScaleTrigger,o=this.getTotalObjectScaling(),c=o.scaleX,h=o.scaleY,p=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!b||c>x&&h>x){this._element=p,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=c,this._lastScaleY=h;return}I.filterBackend||(I.filterBackend=I.initFilterBackend());var _=I.util.createCanvasElement(),u=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,C=p.width,S=p.height;_.width=C,_.height=S,this._element=_,this._lastScaleX=b.scaleX=c,this._lastScaleY=b.scaleY=h,I.filterBackend.applyFilters([b],p,C,S,this._element,u),this._filterScalingX=_.width/this._originalElement.width,this._filterScalingY=_.height/this._originalElement.height},applyFilters:function(b){if(b=b||this.filters||[],b=b.filter(function(p){return p&&!p.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),b.length===0)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var x=this._originalElement,o=x.naturalWidth||x.width,c=x.naturalHeight||x.height;if(this._element===this._originalElement){var h=I.util.createCanvasElement();h.width=o,h.height=c,this._element=h,this._filteredEl=h}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,o,c),this._lastScaleX=1,this._lastScaleY=1;return I.filterBackend||(I.filterBackend=I.initFilterBackend()),I.filterBackend.applyFilters(b,this._originalElement,o,c,this._element,this.cacheKey),(this._originalElement.width!==this._element.width||this._originalElement.height!==this._element.height)&&(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(b){I.util.setImageSmoothing(b,this.imageSmoothing),this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(b),this._renderPaintInOrder(b)},drawCacheOnCanvas:function(b){I.util.setImageSmoothing(b,this.imageSmoothing),I.Object.prototype.drawCacheOnCanvas.call(this,b)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(b){var x=this._element;if(x){var o=this._filterScalingX,c=this._filterScalingY,h=this.width,p=this.height,_=Math.min,u=Math.max,C=u(this.cropX,0),S=u(this.cropY,0),D=x.naturalWidth||x.width,L=x.naturalHeight||x.height,U=C*o,$=S*c,ne=_(h*o,D-U),ye=_(p*c,L-$),Ve=-h/2,Ke=-p/2,at=_(h,D/o-C),$e=_(p,L/c-S);x&&b.drawImage(x,U,$,ne,ye,Ve,Ke,at,$e)}},_needsResize:function(){var b=this.getTotalObjectScaling();return b.scaleX!==this._lastScaleX||b.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(b,x){this.setElement(I.util.getById(b),x),I.util.addClass(this.getElement(),I.Image.CSS_CANVAS)},_initConfig:function(b){b||(b={}),this.setOptions(b),this._setWidthHeight(b)},_initFilters:function(b,x){b&&b.length?I.util.enlivenObjects(b,function(o){x&&x(o)},"fabric.Image.filters"):x&&x()},_setWidthHeight:function(b){b||(b={});var x=this.getElement();this.width=b.width||x.naturalWidth||x.width||0,this.height=b.height||x.naturalHeight||x.height||0},parsePreserveAspectRatioAttribute:function(){var b=I.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),x=this._element.width,o=this._element.height,c=1,h=1,p=0,_=0,u=0,C=0,S,D=this.width,L=this.height,U={width:D,height:L};return b&&(b.alignX!=="none"||b.alignY!=="none")?(b.meetOrSlice==="meet"&&(c=h=I.util.findScaleToFit(this._element,U),S=(D-x*c)/2,b.alignX==="Min"&&(p=-S),b.alignX==="Max"&&(p=S),S=(L-o*h)/2,b.alignY==="Min"&&(_=-S),b.alignY==="Max"&&(_=S)),b.meetOrSlice==="slice"&&(c=h=I.util.findScaleToCover(this._element,U),S=x-D/c,b.alignX==="Mid"&&(u=S/2),b.alignX==="Max"&&(u=S),S=o-L/h,b.alignY==="Mid"&&(C=S/2),b.alignY==="Max"&&(C=S),x=D/c,o=L/h)):(c=D/x,h=L/o),{width:x,height:o,scaleX:c,scaleY:h,offsetLeft:p,offsetTop:_,cropX:u,cropY:C}}}),I.Image.CSS_CANVAS="canvas-img",I.Image.prototype.getSvgSrc=I.Image.prototype.getSrc,I.Image.fromObject=function(b,x){var o=I.util.object.clone(b);I.util.loadImage(o.src,function(c,h){if(h){x&&x(null,!0);return}I.Image.prototype._initFilters.call(o,o.filters,function(p){o.filters=p||[],I.Image.prototype._initFilters.call(o,[o.resizeFilter],function(_){o.resizeFilter=_[0],I.util.enlivenObjectEnlivables(o,o,function(){var u=new I.Image(c,o);x(u,!1)})})})},null,o.crossOrigin)},I.Image.fromURL=function(b,x,o){I.util.loadImage(b,function(c,h){x&&x(new I.Image(c,o),h)},null,o&&o.crossOrigin)},I.Image.ATTRIBUTE_NAMES=I.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),I.Image.fromElement=function(b,x,o){var c=I.parseAttributes(b,I.Image.ATTRIBUTE_NAMES);I.Image.fromURL(c["xlink:href"],x,m(o?I.util.object.clone(o):{},c))}}(ie),I.util.object.extend(I.Object.prototype,{_getAngleValueForStraighten:function(){var s=this.angle%360;return s>0?Math.round((s-1)/90)*90:Math.round(s/90)*90},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(s){s=s||{};var m=function(){},b=s.onComplete||m,x=s.onChange||m,o=this;return I.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(c){o.rotate(c),x()},onComplete:function(){o.setCoords(),b()}})}}),I.util.object.extend(I.StaticCanvas.prototype,{straightenObject:function(s){return s.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(s){return s.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){function s(b,x){var o="precision "+x+` float;
void main(){}`,c=b.createShader(b.FRAGMENT_SHADER);return b.shaderSource(c,o),b.compileShader(c),!!b.getShaderParameter(c,b.COMPILE_STATUS)}I.isWebglSupported=function(b){if(I.isLikelyNode)return!1;b=b||I.WebglFilterBackend.prototype.tileSize;var x=document.createElement("canvas"),o=x.getContext("webgl")||x.getContext("experimental-webgl"),c=!1;if(o){I.maxTextureSize=o.getParameter(o.MAX_TEXTURE_SIZE),c=I.maxTextureSize>=b;for(var h=["highp","mediump","lowp"],p=0;p<3;p++)if(s(o,h[p])){I.webGlPrecision=h[p];break}}return this.isSupported=c,c},I.WebglFilterBackend=m;function m(b){b&&b.tileSize&&(this.tileSize=b.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}m.prototype={tileSize:2048,resources:{},setupGLContext:function(b,x){this.dispose(),this.createWebGLCanvas(b,x),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(b,x)},chooseFastestCopyGLTo2DMethod:function(b,x){var o=typeof window.performance<"u",c;try{new ImageData(1,1),c=!0}catch{c=!1}var h=typeof ArrayBuffer<"u",p=typeof Uint8ClampedArray<"u";if(o&&c&&h&&p){var _=I.util.createCanvasElement(),u=new ArrayBuffer(b*x*4);if(I.forceGLPutImageData){this.imageBuffer=u,this.copyGLTo2D=V;return}var C={imageBuffer:u,destinationWidth:b,destinationHeight:x,targetCanvas:_},S,D,L;_.width=b,_.height=x,S=window.performance.now(),Ze.call(C,this.gl,C),D=window.performance.now()-S,S=window.performance.now(),V.call(C,this.gl,C),L=window.performance.now()-S,D>L?(this.imageBuffer=u,this.copyGLTo2D=V):this.copyGLTo2D=Ze}},createWebGLCanvas:function(b,x){var o=I.util.createCanvasElement();o.width=b,o.height=x;var c={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},h=o.getContext("webgl",c);h||(h=o.getContext("experimental-webgl",c)),h&&(h.clearColor(0,0,0,0),this.canvas=o,this.gl=h)},applyFilters:function(b,x,o,c,h,p){var _=this.gl,u;p&&(u=this.getCachedTexture(p,x));var C={originalWidth:x.width||x.originalWidth,originalHeight:x.height||x.originalHeight,sourceWidth:o,sourceHeight:c,destinationWidth:o,destinationHeight:c,context:_,sourceTexture:this.createTexture(_,o,c,!u&&x),targetTexture:this.createTexture(_,o,c),originalTexture:u||this.createTexture(_,o,c,!u&&x),passes:b.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:h},S=_.createFramebuffer();return _.bindFramebuffer(_.FRAMEBUFFER,S),b.forEach(function(D){D&&D.applyTo(C)}),Ne(C),this.copyGLTo2D(_,C),_.bindTexture(_.TEXTURE_2D,null),_.deleteTexture(C.sourceTexture),_.deleteTexture(C.targetTexture),_.deleteFramebuffer(S),h.getContext("2d").setTransform(1,0,0,1,0,0),C},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(b,x,o,c,h){var p=b.createTexture();return b.bindTexture(b.TEXTURE_2D,p),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,h||b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,h||b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),c?b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,c):b.texImage2D(b.TEXTURE_2D,0,b.RGBA,x,o,0,b.RGBA,b.UNSIGNED_BYTE,null),p},getCachedTexture:function(b,x){if(this.textureCache[b])return this.textureCache[b];var o=this.createTexture(this.gl,x.width,x.height,x);return this.textureCache[b]=o,o},evictCachesForKey:function(b){this.textureCache[b]&&(this.gl.deleteTexture(this.textureCache[b]),delete this.textureCache[b])},copyGLTo2D:Ze,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var b=this.gl,x={renderer:"",vendor:""};if(!b)return x;var o=b.getExtension("WEBGL_debug_renderer_info");if(o){var c=b.getParameter(o.UNMASKED_RENDERER_WEBGL),h=b.getParameter(o.UNMASKED_VENDOR_WEBGL);c&&(x.renderer=c.toLowerCase()),h&&(x.vendor=h.toLowerCase())}return this.gpuInfo=x,x}}}();function Ne(s){var m=s.targetCanvas,b=m.width,x=m.height,o=s.destinationWidth,c=s.destinationHeight;(b!==o||x!==c)&&(m.width=o,m.height=c)}function Ze(s,m){var b=s.canvas,x=m.targetCanvas,o=x.getContext("2d");o.translate(0,x.height),o.scale(1,-1);var c=b.height-x.height;o.drawImage(b,0,c,x.width,x.height,0,0,x.width,x.height)}function V(s,m){var b=m.targetCanvas,x=b.getContext("2d"),o=m.destinationWidth,c=m.destinationHeight,h=o*c*4,p=new Uint8Array(this.imageBuffer,0,h),_=new Uint8ClampedArray(this.imageBuffer,0,h);s.readPixels(0,0,o,c,s.RGBA,s.UNSIGNED_BYTE,p);var u=new ImageData(_,o,c);x.putImageData(u,0,0)}(function(){var s=function(){};I.Canvas2dFilterBackend=m;function m(){}m.prototype={evictCachesForKey:s,dispose:s,clearWebGLCaches:s,resources:{},applyFilters:function(b,x,o,c,h){var p=h.getContext("2d");p.drawImage(x,0,0,o,c);var _=p.getImageData(0,0,o,c),u=p.getImageData(0,0,o,c),C={sourceWidth:o,sourceHeight:c,imageData:_,originalEl:x,originalImageData:u,canvasEl:h,ctx:p,filterBackend:this};return b.forEach(function(S){S.applyTo(C)}),(C.imageData.width!==o||C.imageData.height!==c)&&(h.width=C.imageData.width,h.height=C.imageData.height),p.putImageData(C.imageData,0,0),C}}})(),I.Image=I.Image||{},I.Image.filters=I.Image.filters||{},I.Image.filters.BaseFilter=I.util.createClass({type:"BaseFilter",vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
void main() {
vTexCoord = aPosition;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:`precision highp float;
varying vec2 vTexCoord;
uniform sampler2D uTexture;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
}`,initialize:function(s){s&&this.setOptions(s)},setOptions:function(s){for(var m in s)this[m]=s[m]},createProgram:function(s,m,b){m=m||this.fragmentSource,b=b||this.vertexSource,I.webGlPrecision!=="highp"&&(m=m.replace(/precision highp float/g,"precision "+I.webGlPrecision+" float"));var x=s.createShader(s.VERTEX_SHADER);if(s.shaderSource(x,b),s.compileShader(x),!s.getShaderParameter(x,s.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+s.getShaderInfoLog(x));var o=s.createShader(s.FRAGMENT_SHADER);if(s.shaderSource(o,m),s.compileShader(o),!s.getShaderParameter(o,s.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+s.getShaderInfoLog(o));var c=s.createProgram();if(s.attachShader(c,x),s.attachShader(c,o),s.linkProgram(c),!s.getProgramParameter(c,s.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+s.getProgramInfoLog(c));var h=this.getAttributeLocations(s,c),p=this.getUniformLocations(s,c)||{};return p.uStepW=s.getUniformLocation(c,"uStepW"),p.uStepH=s.getUniformLocation(c,"uStepH"),{program:c,attributeLocations:h,uniformLocations:p}},getAttributeLocations:function(s,m){return{aPosition:s.getAttribLocation(m,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(s,m,b){var x=m.aPosition,o=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,o),s.enableVertexAttribArray(x),s.vertexAttribPointer(x,2,s.FLOAT,!1,0,0),s.bufferData(s.ARRAY_BUFFER,b,s.STATIC_DRAW)},_setupFrameBuffer:function(s){var m=s.context,b,x;s.passes>1?(b=s.destinationWidth,x=s.destinationHeight,(s.sourceWidth!==b||s.sourceHeight!==x)&&(m.deleteTexture(s.targetTexture),s.targetTexture=s.filterBackend.createTexture(m,b,x)),m.framebufferTexture2D(m.FRAMEBUFFER,m.COLOR_ATTACHMENT0,m.TEXTURE_2D,s.targetTexture,0)):(m.bindFramebuffer(m.FRAMEBUFFER,null),m.finish())},_swapTextures:function(s){s.passes--,s.pass++;var m=s.targetTexture;s.targetTexture=s.sourceTexture,s.sourceTexture=m},isNeutralState:function(){var s=this.mainParameter,m=I.Image.filters[this.type].prototype;if(s)if(Array.isArray(m[s])){for(var b=m[s].length;b--;)if(this[s][b]!==m[s][b])return!1;return!0}else return m[s]===this[s];else return!1},applyTo:function(s){s.webgl?(this._setupFrameBuffer(s),this.applyToWebGL(s),this._swapTextures(s)):this.applyTo2d(s)},retrieveShader:function(s){return s.programCache.hasOwnProperty(this.type)||(s.programCache[this.type]=this.createProgram(s.context)),s.programCache[this.type]},applyToWebGL:function(s){var m=s.context,b=this.retrieveShader(s);s.pass===0&&s.originalTexture?m.bindTexture(m.TEXTURE_2D,s.originalTexture):m.bindTexture(m.TEXTURE_2D,s.sourceTexture),m.useProgram(b.program),this.sendAttributeData(m,b.attributeLocations,s.aPosition),m.uniform1f(b.uniformLocations.uStepW,1/s.sourceWidth),m.uniform1f(b.uniformLocations.uStepH,1/s.sourceHeight),this.sendUniformData(m,b.uniformLocations),m.viewport(0,0,s.destinationWidth,s.destinationHeight),m.drawArrays(m.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(s,m,b){s.activeTexture(b),s.bindTexture(s.TEXTURE_2D,m),s.activeTexture(s.TEXTURE0)},unbindAdditionalTexture:function(s,m){s.activeTexture(m),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(s){this[this.mainParameter]=s},sendUniformData:function(){},createHelpLayer:function(s){if(!s.helpLayer){var m=document.createElement("canvas");m.width=s.sourceWidth,m.height=s.sourceHeight,s.helpLayer=m}},toObject:function(){var s={type:this.type},m=this.mainParameter;return m&&(s[m]=this[m]),s},toJSON:function(){return this.toObject()}}),I.Image.filters.BaseFilter.fromObject=function(s,m){var b=new I.Image.filters[s.type](s);return m&&m(b),b},function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass;b.ColorMatrix=x(b.BaseFilter,{type:"ColorMatrix",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
uniform mat4 uColorMatrix;
uniform vec4 uConstants;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color *= uColorMatrix;
color += uConstants;
gl_FragColor = color;
}`,matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(o){this.callSuper("initialize",o),this.matrix=this.matrix.slice(0)},applyTo2d:function(o){var c=o.imageData,h=c.data,p=h.length,_=this.matrix,u,C,S,D,L,U=this.colorsOnly;for(L=0;L<p;L+=4)u=h[L],C=h[L+1],S=h[L+2],U?(h[L]=u*_[0]+C*_[1]+S*_[2]+_[4]*255,h[L+1]=u*_[5]+C*_[6]+S*_[7]+_[9]*255,h[L+2]=u*_[10]+C*_[11]+S*_[12]+_[14]*255):(D=h[L+3],h[L]=u*_[0]+C*_[1]+S*_[2]+D*_[3]+_[4]*255,h[L+1]=u*_[5]+C*_[6]+S*_[7]+D*_[8]+_[9]*255,h[L+2]=u*_[10]+C*_[11]+S*_[12]+D*_[13]+_[14]*255,h[L+3]=u*_[15]+C*_[16]+S*_[17]+D*_[18]+_[19]*255)},getUniformLocations:function(o,c){return{uColorMatrix:o.getUniformLocation(c,"uColorMatrix"),uConstants:o.getUniformLocation(c,"uConstants")}},sendUniformData:function(o,c){var h=this.matrix,p=[h[0],h[1],h[2],h[3],h[5],h[6],h[7],h[8],h[10],h[11],h[12],h[13],h[15],h[16],h[17],h[18]],_=[h[4],h[9],h[14],h[19]];o.uniformMatrix4fv(c.uColorMatrix,!1,p),o.uniform4fv(c.uConstants,_)}}),m.Image.filters.ColorMatrix.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass;b.Brightness=x(b.BaseFilter,{type:"Brightness",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBrightness;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += uBrightness;
gl_FragColor = color;
}`,brightness:0,mainParameter:"brightness",applyTo2d:function(o){if(this.brightness!==0){var c=o.imageData,h=c.data,p,_=h.length,u=Math.round(this.brightness*255);for(p=0;p<_;p+=4)h[p]=h[p]+u,h[p+1]=h[p+1]+u,h[p+2]=h[p+2]+u}},getUniformLocations:function(o,c){return{uBrightness:o.getUniformLocation(c,"uBrightness")}},sendUniformData:function(o,c){o.uniform1f(c.uBrightness,this.brightness)}}),m.Image.filters.Brightness.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.util.object.extend,x=m.Image.filters,o=m.util.createClass;x.Convolute=o(x.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_3_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_5_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_5_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_7_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_7_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_9_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_9_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`},retrieveShader:function(c){var h=Math.sqrt(this.matrix.length),p=this.type+"_"+h+"_"+(this.opaque?1:0),_=this.fragmentSource[p];return c.programCache.hasOwnProperty(p)||(c.programCache[p]=this.createProgram(c.context,_)),c.programCache[p]},applyTo2d:function(c){var h=c.imageData,p=h.data,_=this.matrix,u=Math.round(Math.sqrt(_.length)),C=Math.floor(u/2),S=h.width,D=h.height,L=c.ctx.createImageData(S,D),U=L.data,$=this.opaque?1:0,ne,ye,Ve,Ke,at,$e,ut,ot,vt,St,ct,Et,Q;for(ct=0;ct<D;ct++)for(St=0;St<S;St++){for(at=(ct*S+St)*4,ne=0,ye=0,Ve=0,Ke=0,Q=0;Q<u;Q++)for(Et=0;Et<u;Et++)ut=ct+Q-C,$e=St+Et-C,!(ut<0||ut>=D||$e<0||$e>=S)&&(ot=(ut*S+$e)*4,vt=_[Q*u+Et],ne+=p[ot]*vt,ye+=p[ot+1]*vt,Ve+=p[ot+2]*vt,$||(Ke+=p[ot+3]*vt));U[at]=ne,U[at+1]=ye,U[at+2]=Ve,$?U[at+3]=p[at+3]:U[at+3]=Ke}c.imageData=L},getUniformLocations:function(c,h){return{uMatrix:c.getUniformLocation(h,"uMatrix"),uOpaque:c.getUniformLocation(h,"uOpaque"),uHalfSize:c.getUniformLocation(h,"uHalfSize"),uSize:c.getUniformLocation(h,"uSize")}},sendUniformData:function(c,h){c.uniform1fv(h.uMatrix,this.matrix)},toObject:function(){return b(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),m.Image.filters.Convolute.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass;b.Grayscale=x(b.BaseFilter,{type:"Grayscale",fragmentSource:{average:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float average = (color.r + color.b + color.g) / 3.0;
gl_FragColor = vec4(average, average, average, color.a);
}`,lightness:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
gl_FragColor = vec4(average, average, average, col.a);
}`,luminosity:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
gl_FragColor = vec4(average, average, average, col.a);
}`},mode:"average",mainParameter:"mode",applyTo2d:function(o){var c=o.imageData,h=c.data,p,_=h.length,u,C=this.mode;for(p=0;p<_;p+=4)C==="average"?u=(h[p]+h[p+1]+h[p+2])/3:C==="lightness"?u=(Math.min(h[p],h[p+1],h[p+2])+Math.max(h[p],h[p+1],h[p+2]))/2:C==="luminosity"&&(u=.21*h[p]+.72*h[p+1]+.07*h[p+2]),h[p]=u,h[p+1]=u,h[p+2]=u},retrieveShader:function(o){var c=this.type+"_"+this.mode;if(!o.programCache.hasOwnProperty(c)){var h=this.fragmentSource[this.mode];o.programCache[c]=this.createProgram(o.context,h)}return o.programCache[c]},getUniformLocations:function(o,c){return{uMode:o.getUniformLocation(c,"uMode")}},sendUniformData:function(o,c){var h=1;o.uniform1i(c.uMode,h)},isNeutralState:function(){return!1}}),m.Image.filters.Grayscale.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass;b.Invert=x(b.BaseFilter,{type:"Invert",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform int uInvert;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
if (uInvert == 1) {
gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
} else {
gl_FragColor = color;
}
}`,invert:!0,mainParameter:"invert",applyTo2d:function(o){var c=o.imageData,h=c.data,p,_=h.length;for(p=0;p<_;p+=4)h[p]=255-h[p],h[p+1]=255-h[p+1],h[p+2]=255-h[p+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(o,c){return{uInvert:o.getUniformLocation(c,"uInvert")}},sendUniformData:function(o,c){o.uniform1i(c.uInvert,this.invert)}}),m.Image.filters.Invert.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.util.object.extend,x=m.Image.filters,o=m.util.createClass;x.Noise=o(x.BaseFilter,{type:"Noise",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uStepH;
uniform float uNoise;
uniform float uSeed;
varying vec2 vTexCoord;
float rand(vec2 co, float seed, float vScale) {
return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
}
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
gl_FragColor = color;
}`,mainParameter:"noise",noise:0,applyTo2d:function(c){if(this.noise!==0){var h=c.imageData,p=h.data,_,u=p.length,C=this.noise,S;for(_=0,u=p.length;_<u;_+=4)S=(.5-Math.random())*C,p[_]+=S,p[_+1]+=S,p[_+2]+=S}},getUniformLocations:function(c,h){return{uNoise:c.getUniformLocation(h,"uNoise"),uSeed:c.getUniformLocation(h,"uSeed")}},sendUniformData:function(c,h){c.uniform1f(h.uNoise,this.noise/255),c.uniform1f(h.uSeed,Math.random())},toObject:function(){return b(this.callSuper("toObject"),{noise:this.noise})}}),m.Image.filters.Noise.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass;b.Pixelate=x(b.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBlocksize;
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
float blockW = uBlocksize * uStepW;
float blockH = uBlocksize * uStepW;
int posX = int(vTexCoord.x / blockW);
int posY = int(vTexCoord.y / blockH);
float fposX = float(posX);
float fposY = float(posY);
vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
vec4 color = texture2D(uTexture, squareCoords);
gl_FragColor = color;
}`,applyTo2d:function(o){var c=o.imageData,h=c.data,p=c.height,_=c.width,u,C,S,D,L,U,$,ne,ye,Ve,Ke;for(C=0;C<p;C+=this.blocksize)for(S=0;S<_;S+=this.blocksize)for(u=C*4*_+S*4,D=h[u],L=h[u+1],U=h[u+2],$=h[u+3],Ve=Math.min(C+this.blocksize,p),Ke=Math.min(S+this.blocksize,_),ne=C;ne<Ve;ne++)for(ye=S;ye<Ke;ye++)u=ne*4*_+ye*4,h[u]=D,h[u+1]=L,h[u+2]=U,h[u+3]=$},isNeutralState:function(){return this.blocksize===1},getUniformLocations:function(o,c){return{uBlocksize:o.getUniformLocation(c,"uBlocksize"),uStepW:o.getUniformLocation(c,"uStepW"),uStepH:o.getUniformLocation(c,"uStepH")}},sendUniformData:function(o,c){o.uniform1f(c.uBlocksize,this.blocksize)}}),m.Image.filters.Pixelate.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.util.object.extend,x=m.Image.filters,o=m.util.createClass;x.RemoveColor=o(x.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
gl_FragColor.a = 0.0;
}
}`,distance:.02,useAlpha:!1,applyTo2d:function(c){var h=c.imageData,p=h.data,_,u=this.distance*255,C,S,D,L=new m.Color(this.color).getSource(),U=[L[0]-u,L[1]-u,L[2]-u],$=[L[0]+u,L[1]+u,L[2]+u];for(_=0;_<p.length;_+=4)C=p[_],S=p[_+1],D=p[_+2],C>U[0]&&S>U[1]&&D>U[2]&&C<$[0]&&S<$[1]&&D<$[2]&&(p[_+3]=0)},getUniformLocations:function(c,h){return{uLow:c.getUniformLocation(h,"uLow"),uHigh:c.getUniformLocation(h,"uHigh")}},sendUniformData:function(c,h){var p=new m.Color(this.color).getSource(),_=parseFloat(this.distance),u=[0+p[0]/255-_,0+p[1]/255-_,0+p[2]/255-_,1],C=[p[0]/255+_,p[1]/255+_,p[2]/255+_,1];c.uniform4fv(h.uLow,u),c.uniform4fv(h.uHigh,C)},toObject:function(){return b(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),m.Image.filters.RemoveColor.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass,o={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var c in o)b[c]=x(b.ColorMatrix,{type:c,matrix:o[c],mainParameter:!1,colorsOnly:!0}),m.Image.filters[c].fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric,b=m.Image.filters,x=m.util.createClass;b.BlendColor=x(b.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,diff:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`if (uColor.r < 0.5) {
gl_FragColor.r *= 2.0 * uColor.r;
} else {
gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
}
if (uColor.g < 0.5) {
gl_FragColor.g *= 2.0 * uColor.g;
} else {
gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
}
if (uColor.b < 0.5) {
gl_FragColor.b *= 2.0 * uColor.b;
} else {
gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
}
`,tint:`gl_FragColor.rgb *= (1.0 - uColor.a);
gl_FragColor.rgb += uColor.rgb;
`},buildSource:function(o){return`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uColor;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
gl_FragColor = color;
if (color.a > 0.0) {
`+this.fragmentSource[o]+`}
}`},retrieveShader:function(o){var c=this.type+"_"+this.mode,h;return o.programCache.hasOwnProperty(c)||(h=this.buildSource(this.mode),o.programCache[c]=this.createProgram(o.context,h)),o.programCache[c]},applyTo2d:function(o){var c=o.imageData,h=c.data,p=h.length,_,u,C,S,D,L,U,$=1-this.alpha;U=new m.Color(this.color).getSource(),_=U[0]*this.alpha,u=U[1]*this.alpha,C=U[2]*this.alpha;for(var ne=0;ne<p;ne+=4)switch(S=h[ne],D=h[ne+1],L=h[ne+2],this.mode){case"multiply":h[ne]=S*_/255,h[ne+1]=D*u/255,h[ne+2]=L*C/255;break;case"screen":h[ne]=255-(255-S)*(255-_)/255,h[ne+1]=255-(255-D)*(255-u)/255,h[ne+2]=255-(255-L)*(255-C)/255;break;case"add":h[ne]=S+_,h[ne+1]=D+u,h[ne+2]=L+C;break;case"diff":case"difference":h[ne]=Math.abs(S-_),h[ne+1]=Math.abs(D-u),h[ne+2]=Math.abs(L-C);break;case"subtract":h[ne]=S-_,h[ne+1]=D-u,h[ne+2]=L-C;break;case"darken":h[ne]=Math.min(S,_),h[ne+1]=Math.min(D,u),h[ne+2]=Math.min(L,C);break;case"lighten":h[ne]=Math.max(S,_),h[ne+1]=Math.max(D,u),h[ne+2]=Math.max(L,C);break;case"overlay":h[ne]=_<128?2*S*_/255:255-2*(255-S)*(255-_)/255,h[ne+1]=u<128?2*D*u/255:255-2*(255-D)*(255-u)/255,h[ne+2]=C<128?2*L*C/255:255-2*(255-L)*(255-C)/255;break;case"exclusion":h[ne]=_+S-2*_*S/255,h[ne+1]=u+D-2*u*D/255,h[ne+2]=C+L-2*C*L/255;break;case"tint":h[ne]=_+S*$,h[ne+1]=u+D*$,h[ne+2]=C+L*$}},getUniformLocations:function(o,c){return{uColor:o.getUniformLocation(c,"uColor")}},sendUniformData:function(o,c){var h=new m.Color(this.color).getSource();h[0]=this.alpha*h[0]/255,h[1]=this.alpha*h[1]/255,h[2]=this.alpha*h[2]/255,h[3]=this.alpha,o.uniform4fv(c.uColor,h)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),m.Image.filters.BlendColor.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric,b=m.Image.filters,x=m.util.createClass;b.BlendImage=x(b.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
uniform mat3 uTransformMatrix;
void main() {
vTexCoord = aPosition;
vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:{multiply:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.rgba *= color2.rgba;
gl_FragColor = color;
}`,mask:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.a = color2.a;
gl_FragColor = color;
}`},retrieveShader:function(o){var c=this.type+"_"+this.mode,h=this.fragmentSource[this.mode];return o.programCache.hasOwnProperty(c)||(o.programCache[c]=this.createProgram(o.context,h)),o.programCache[c]},applyToWebGL:function(o){var c=o.context,h=this.createTexture(o.filterBackend,this.image);this.bindAdditionalTexture(c,h,c.TEXTURE1),this.callSuper("applyToWebGL",o),this.unbindAdditionalTexture(c,c.TEXTURE1)},createTexture:function(o,c){return o.getCachedTexture(c.cacheKey,c._element)},calculateMatrix:function(){var o=this.image,c=o._element.width,h=o._element.height;return[1/o.scaleX,0,0,0,1/o.scaleY,0,-o.left/c,-o.top/h,1]},applyTo2d:function(o){var c=o.imageData,h=o.filterBackend.resources,p=c.data,_=p.length,u=c.width,C=c.height,S,D,L,U,$,ne,ye,Ve,Ke,at,$e=this.image,ut;h.blendImage||(h.blendImage=m.util.createCanvasElement()),Ke=h.blendImage,at=Ke.getContext("2d"),Ke.width!==u||Ke.height!==C?(Ke.width=u,Ke.height=C):at.clearRect(0,0,u,C),at.setTransform($e.scaleX,0,0,$e.scaleY,$e.left,$e.top),at.drawImage($e._element,0,0,u,C),ut=at.getImageData(0,0,u,C).data;for(var ot=0;ot<_;ot+=4)switch($=p[ot],ne=p[ot+1],ye=p[ot+2],Ve=p[ot+3],S=ut[ot],D=ut[ot+1],L=ut[ot+2],U=ut[ot+3],this.mode){case"multiply":p[ot]=$*S/255,p[ot+1]=ne*D/255,p[ot+2]=ye*L/255,p[ot+3]=Ve*U/255;break;case"mask":p[ot+3]=U;break}},getUniformLocations:function(o,c){return{uTransformMatrix:o.getUniformLocation(c,"uTransformMatrix"),uImage:o.getUniformLocation(c,"uImage")}},sendUniformData:function(o,c){var h=this.calculateMatrix();o.uniform1i(c.uImage,1),o.uniformMatrix3fv(c.uTransformMatrix,!1,h)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),m.Image.filters.BlendImage.fromObject=function(o,c){m.Image.fromObject(o.image,function(h){var p=m.util.object.clone(o);p.image=h,c(new m.Image.filters.BlendImage(p))})}}(ie),function(s){var m=s.fabric||(s.fabric={}),b=Math.pow,x=Math.floor,o=Math.sqrt,c=Math.abs,h=Math.round,p=Math.sin,_=Math.ceil,u=m.Image.filters,C=m.util.createClass;u.Resize=C(u.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(S,D){return{uDelta:S.getUniformLocation(D,"uDelta"),uTaps:S.getUniformLocation(D,"uTaps")}},sendUniformData:function(S,D){S.uniform2fv(D.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),S.uniform1fv(D.uTaps,this.taps)},retrieveShader:function(S){var D=this.getFilterWindow(),L=this.type+"_"+D;if(!S.programCache.hasOwnProperty(L)){var U=this.generateShader(D);S.programCache[L]=this.createProgram(S.context,U)}return S.programCache[L]},getFilterWindow:function(){var S=this.tempScale;return Math.ceil(this.lanczosLobes/S)},getTaps:function(){for(var S=this.lanczosCreate(this.lanczosLobes),D=this.tempScale,L=this.getFilterWindow(),U=new Array(L),$=1;$<=L;$++)U[$-1]=S($*D);return U},generateShader:function(U){for(var D=new Array(U),L=this.fragmentSourceTOP,U,$=1;$<=U;$++)D[$-1]=$+".0 * uDelta";return L+="uniform float uTaps["+U+`];
`,L+=`void main() {
`,L+=`  vec4 color = texture2D(uTexture, vTexCoord);
`,L+=`  float sum = 1.0;
`,D.forEach(function(ne,ye){L+="  color += texture2D(uTexture, vTexCoord + "+ne+") * uTaps["+ye+`];
`,L+="  color += texture2D(uTexture, vTexCoord - "+ne+") * uTaps["+ye+`];
`,L+="  sum += 2.0 * uTaps["+ye+`];
`}),L+=`  gl_FragColor = color / sum;
`,L+="}",L},fragmentSourceTOP:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
`,applyTo:function(S){S.webgl?(S.passes++,this.width=S.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=S.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),S.destinationWidth=this.dW,this._setupFrameBuffer(S),this.applyToWebGL(S),this._swapTextures(S),S.sourceWidth=S.destinationWidth,this.height=S.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),S.destinationHeight=this.dH,this._setupFrameBuffer(S),this.applyToWebGL(S),this._swapTextures(S),S.sourceHeight=S.destinationHeight):this.applyTo2d(S)},isNeutralState:function(){return this.scaleX===1&&this.scaleY===1},lanczosCreate:function(S){return function(D){if(D>=S||D<=-S)return 0;if(D<11920929e-14&&D>-11920929e-14)return 1;D*=Math.PI;var L=D/S;return p(D)/D*p(L)/L}},applyTo2d:function(S){var D=S.imageData,L=this.scaleX,U=this.scaleY;this.rcpScaleX=1/L,this.rcpScaleY=1/U;var $=D.width,ne=D.height,ye=h($*L),Ve=h(ne*U),Ke;this.resizeType==="sliceHack"?Ke=this.sliceByTwo(S,$,ne,ye,Ve):this.resizeType==="hermite"?Ke=this.hermiteFastResize(S,$,ne,ye,Ve):this.resizeType==="bilinear"?Ke=this.bilinearFiltering(S,$,ne,ye,Ve):this.resizeType==="lanczos"&&(Ke=this.lanczosResize(S,$,ne,ye,Ve)),S.imageData=Ke},sliceByTwo:function(S,D,L,U,$){var ne=S.imageData,ye=.5,Ve=!1,Ke=!1,at=D*ye,$e=L*ye,ut=m.filterBackend.resources,ot,vt,St=0,ct=0,Et=D,Q=0;for(ut.sliceByTwo||(ut.sliceByTwo=document.createElement("canvas")),ot=ut.sliceByTwo,(ot.width<D*1.5||ot.height<L)&&(ot.width=D*1.5,ot.height=L),vt=ot.getContext("2d"),vt.clearRect(0,0,D*1.5,L),vt.putImageData(ne,0,0),U=x(U),$=x($);!Ve||!Ke;)D=at,L=$e,U<x(at*ye)?at=x(at*ye):(at=U,Ve=!0),$<x($e*ye)?$e=x($e*ye):($e=$,Ke=!0),vt.drawImage(ot,St,ct,D,L,Et,Q,at,$e),St=Et,ct=Q,Q+=$e;return vt.getImageData(St,ct,U,$)},lanczosResize:function(S,D,L,U,$){function ne(_e){var pe,Re,fe,ee,Ce,Le,Je,Ue,Ge,dt,At;for(Q.x=(_e+.5)*$e,de.x=x(Q.x),pe=0;pe<$;pe++){for(Q.y=(pe+.5)*ut,de.y=x(Q.y),Ce=0,Le=0,Je=0,Ue=0,Ge=0,Re=de.x-St;Re<=de.x+St;Re++)if(!(Re<0||Re>=D)){dt=x(1e3*c(Re-Q.x)),Et[dt]||(Et[dt]={});for(var Ye=de.y-ct;Ye<=de.y+ct;Ye++)Ye<0||Ye>=L||(At=x(1e3*c(Ye-Q.y)),Et[dt][At]||(Et[dt][At]=at(o(b(dt*ot,2)+b(At*vt,2))/1e3)),fe=Et[dt][At],fe>0&&(ee=(Ye*D+Re)*4,Ce+=fe,Le+=fe*ye[ee],Je+=fe*ye[ee+1],Ue+=fe*ye[ee+2],Ge+=fe*ye[ee+3]))}ee=(pe*U+_e)*4,Ke[ee]=Le/Ce,Ke[ee+1]=Je/Ce,Ke[ee+2]=Ue/Ce,Ke[ee+3]=Ge/Ce}return++_e<U?ne(_e):Ve}var ye=S.imageData.data,Ve=S.ctx.createImageData(U,$),Ke=Ve.data,at=this.lanczosCreate(this.lanczosLobes),$e=this.rcpScaleX,ut=this.rcpScaleY,ot=2/this.rcpScaleX,vt=2/this.rcpScaleY,St=_($e*this.lanczosLobes/2),ct=_(ut*this.lanczosLobes/2),Et={},Q={},de={};return ne(0)},bilinearFiltering:function(S,D,L,U,$){var ne,ye,Ve,Ke,at,$e,ut,ot,vt,St,ct,Et,Q=0,de,_e=this.rcpScaleX,pe=this.rcpScaleY,Re=4*(D-1),fe=S.imageData,ee=fe.data,Ce=S.ctx.createImageData(U,$),Le=Ce.data;for(ut=0;ut<$;ut++)for(ot=0;ot<U;ot++)for(at=x(_e*ot),$e=x(pe*ut),vt=_e*ot-at,St=pe*ut-$e,de=4*($e*D+at),ct=0;ct<4;ct++)ne=ee[de+ct],ye=ee[de+4+ct],Ve=ee[de+Re+ct],Ke=ee[de+Re+4+ct],Et=ne*(1-vt)*(1-St)+ye*vt*(1-St)+Ve*St*(1-vt)+Ke*vt*St,Le[Q++]=Et;return Ce},hermiteFastResize:function(S,D,L,U,$){for(var ne=this.rcpScaleX,ye=this.rcpScaleY,Ve=_(ne/2),Ke=_(ye/2),at=S.imageData,$e=at.data,ut=S.ctx.createImageData(U,$),ot=ut.data,vt=0;vt<$;vt++)for(var St=0;St<U;St++){for(var ct=(St+vt*U)*4,Et=0,Q=0,de=0,_e=0,pe=0,Re=0,fe=0,ee=(vt+.5)*ye,Ce=x(vt*ye);Ce<(vt+1)*ye;Ce++)for(var Le=c(ee-(Ce+.5))/Ke,Je=(St+.5)*ne,Ue=Le*Le,Ge=x(St*ne);Ge<(St+1)*ne;Ge++){var dt=c(Je-(Ge+.5))/Ve,At=o(Ue+dt*dt);At>1&&At<-1||(Et=2*At*At*At-3*At*At+1,Et>0&&(dt=4*(Ge+Ce*D),fe+=Et*$e[dt+3],de+=Et,$e[dt+3]<255&&(Et=Et*$e[dt+3]/250),_e+=Et*$e[dt],pe+=Et*$e[dt+1],Re+=Et*$e[dt+2],Q+=Et))}ot[ct]=_e/Q,ot[ct+1]=pe/Q,ot[ct+2]=Re/Q,ot[ct+3]=fe/de}return ut},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),m.Image.filters.Resize.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass;b.Contrast=x(b.BaseFilter,{type:"Contrast",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uContrast;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
gl_FragColor = color;
}`,contrast:0,mainParameter:"contrast",applyTo2d:function(o){if(this.contrast!==0){var c=o.imageData,h,_,p=c.data,_=p.length,u=Math.floor(this.contrast*255),C=259*(u+255)/(255*(259-u));for(h=0;h<_;h+=4)p[h]=C*(p[h]-128)+128,p[h+1]=C*(p[h+1]-128)+128,p[h+2]=C*(p[h+2]-128)+128}},getUniformLocations:function(o,c){return{uContrast:o.getUniformLocation(c,"uContrast")}},sendUniformData:function(o,c){o.uniform1f(c.uContrast,this.contrast)}}),m.Image.filters.Contrast.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass;b.Saturation=x(b.BaseFilter,{type:"Saturation",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uSaturation;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float rgMax = max(color.r, color.g);
float rgbMax = max(rgMax, color.b);
color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
gl_FragColor = color;
}`,saturation:0,mainParameter:"saturation",applyTo2d:function(o){if(this.saturation!==0){var c=o.imageData,h=c.data,p=h.length,_=-this.saturation,u,C;for(u=0;u<p;u+=4)C=Math.max(h[u],h[u+1],h[u+2]),h[u]+=C!==h[u]?(C-h[u])*_:0,h[u+1]+=C!==h[u+1]?(C-h[u+1])*_:0,h[u+2]+=C!==h[u+2]?(C-h[u+2])*_:0}},getUniformLocations:function(o,c){return{uSaturation:o.getUniformLocation(c,"uSaturation")}},sendUniformData:function(o,c){o.uniform1f(c.uSaturation,-this.saturation)}}),m.Image.filters.Saturation.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass;b.Vibrance=x(b.BaseFilter,{type:"Vibrance",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uVibrance;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float max = max(color.r, max(color.g, color.b));
float avg = (color.r + color.g + color.b) / 3.0;
float amt = (abs(max - avg) * 2.0) * uVibrance;
color.r += max != color.r ? (max - color.r) * amt : 0.00;
color.g += max != color.g ? (max - color.g) * amt : 0.00;
color.b += max != color.b ? (max - color.b) * amt : 0.00;
gl_FragColor = color;
}`,vibrance:0,mainParameter:"vibrance",applyTo2d:function(o){if(this.vibrance!==0){var c=o.imageData,h=c.data,p=h.length,_=-this.vibrance,u,C,S,D;for(u=0;u<p;u+=4)C=Math.max(h[u],h[u+1],h[u+2]),S=(h[u]+h[u+1]+h[u+2])/3,D=Math.abs(C-S)*2/255*_,h[u]+=C!==h[u]?(C-h[u])*D:0,h[u+1]+=C!==h[u+1]?(C-h[u+1])*D:0,h[u+2]+=C!==h[u+2]?(C-h[u+2])*D:0}},getUniformLocations:function(o,c){return{uVibrance:o.getUniformLocation(c,"uVibrance")}},sendUniformData:function(o,c){o.uniform1f(c.uVibrance,-this.vibrance)}}),m.Image.filters.Vibrance.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass;b.Blur=x(b.BaseFilter,{type:"Blur",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
const float nSamples = 15.0;
vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
float random(vec3 scale) {
return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
}
void main() {
vec4 color = vec4(0.0);
float total = 0.0;
float offset = random(v3offset);
for (float t = -nSamples; t <= nSamples; t++) {
float percent = (t + offset - 0.5) / nSamples;
float weight = 1.0 - abs(percent);
color += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;
total += weight;
}
gl_FragColor = color / total;
}`,blur:0,mainParameter:"blur",applyTo:function(o){o.webgl?(this.aspectRatio=o.sourceWidth/o.sourceHeight,o.passes++,this._setupFrameBuffer(o),this.horizontal=!0,this.applyToWebGL(o),this._swapTextures(o),this._setupFrameBuffer(o),this.horizontal=!1,this.applyToWebGL(o),this._swapTextures(o)):this.applyTo2d(o)},applyTo2d:function(o){o.imageData=this.simpleBlur(o)},simpleBlur:function(o){var c=o.filterBackend.resources,h,p,_=o.imageData.width,u=o.imageData.height;c.blurLayer1||(c.blurLayer1=m.util.createCanvasElement(),c.blurLayer2=m.util.createCanvasElement()),h=c.blurLayer1,p=c.blurLayer2,(h.width!==_||h.height!==u)&&(p.width=h.width=_,p.height=h.height=u);var C=h.getContext("2d"),S=p.getContext("2d"),D=15,L,U,$,ne,ye=this.blur*.06*.5;for(C.putImageData(o.imageData,0,0),S.clearRect(0,0,_,u),ne=-D;ne<=D;ne++)L=(Math.random()-.5)/4,U=ne/D,$=ye*U*_+L,S.globalAlpha=1-Math.abs(U),S.drawImage(h,$,L),C.drawImage(p,0,0),S.globalAlpha=1,S.clearRect(0,0,p.width,p.height);for(ne=-D;ne<=D;ne++)L=(Math.random()-.5)/4,U=ne/D,$=ye*U*u+L,S.globalAlpha=1-Math.abs(U),S.drawImage(h,L,$),C.drawImage(p,0,0),S.globalAlpha=1,S.clearRect(0,0,p.width,p.height);o.ctx.drawImage(h,0,0);var Ve=o.ctx.getImageData(0,0,h.width,h.height);return C.globalAlpha=1,C.clearRect(0,0,h.width,h.height),Ve},getUniformLocations:function(o,c){return{delta:o.getUniformLocation(c,"uDelta")}},sendUniformData:function(o,c){var h=this.chooseRightDelta();o.uniform2fv(c.delta,h)},chooseRightDelta:function(){var o=1,c=[0,0],h;return this.horizontal?this.aspectRatio>1&&(o=1/this.aspectRatio):this.aspectRatio<1&&(o=this.aspectRatio),h=o*this.blur*.12,this.horizontal?c[0]=h:c[1]=h,c}}),b.Blur.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass;b.Gamma=x(b.BaseFilter,{type:"Gamma",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec3 uGamma;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec3 correction = (1.0 / uGamma);
color.r = pow(color.r, correction.r);
color.g = pow(color.g, correction.g);
color.b = pow(color.b, correction.b);
gl_FragColor = color;
gl_FragColor.rgb *= color.a;
}`,gamma:[1,1,1],mainParameter:"gamma",initialize:function(o){this.gamma=[1,1,1],b.BaseFilter.prototype.initialize.call(this,o)},applyTo2d:function(o){var c=o.imageData,h=c.data,p=this.gamma,_=h.length,u=1/p[0],C=1/p[1],S=1/p[2],D;for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),D=0,_=256;D<_;D++)this.rVals[D]=Math.pow(D/255,u)*255,this.gVals[D]=Math.pow(D/255,C)*255,this.bVals[D]=Math.pow(D/255,S)*255;for(D=0,_=h.length;D<_;D+=4)h[D]=this.rVals[h[D]],h[D+1]=this.gVals[h[D+1]],h[D+2]=this.bVals[h[D+2]]},getUniformLocations:function(o,c){return{uGamma:o.getUniformLocation(c,"uGamma")}},sendUniformData:function(o,c){o.uniform3fv(c.uGamma,this.gamma)}}),m.Image.filters.Gamma.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass;b.Composed=x(b.BaseFilter,{type:"Composed",subFilters:[],initialize:function(o){this.callSuper("initialize",o),this.subFilters=this.subFilters.slice(0)},applyTo:function(o){o.passes+=this.subFilters.length-1,this.subFilters.forEach(function(c){c.applyTo(o)})},toObject:function(){return m.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(o){return o.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(o){return!o.isNeutralState()})}}),m.Image.filters.Composed.fromObject=function(o,c){var h=o.subFilters||[],p=h.map(function(u){return new m.Image.filters[u.type](u)}),_=new m.Image.filters.Composed({subFilters:p});return c&&c(_),_}}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.Image.filters,x=m.util.createClass;b.HueRotation=x(b.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var o=this.rotation*Math.PI,c=m.util.cos(o),h=m.util.sin(o),p=1/3,_=Math.sqrt(p)*h,u=1-c;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=c+u/3,this.matrix[1]=p*u-_,this.matrix[2]=p*u+_,this.matrix[5]=p*u+_,this.matrix[6]=c+p*u,this.matrix[7]=p*u-_,this.matrix[10]=p*u-_,this.matrix[11]=p*u+_,this.matrix[12]=c+p*u},isNeutralState:function(o){return this.calculateMatrix(),b.BaseFilter.prototype.isNeutralState.call(this,o)},applyTo:function(o){this.calculateMatrix(),b.BaseFilter.prototype.applyTo.call(this,o)}}),m.Image.filters.HueRotation.fromObject=m.Image.filters.BaseFilter.fromObject}(ie),function(s){var m=s.fabric||(s.fabric={}),b=m.util.object.clone;if(m.Text){m.warn("fabric.Text is already defined");return}var x="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");m.Text=m.util.createClass(m.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:m.Object.prototype.stateProperties.concat(x),cacheProperties:m.Object.prototype.cacheProperties.concat(x),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(o,c){this.styles=c?c.styles||{}:{},this.text=o,this.__skipDimension=!0,this.callSuper("initialize",c),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var o=this.path;o&&(o.segmentsInfo=m.util.getPathSegmentsInfo(o.path))},getMeasuringContext:function(){return m._measuringContext||(m._measuringContext=this.canvas&&this.canvas.contextCache||m.util.createCanvasElement().getContext("2d")),m._measuringContext},_splitText:function(){var o=this._splitTextIntoLines(this.text);return this.textLines=o.lines,this._textLines=o.graphemeLines,this._unwrappedTextLines=o._unwrappedLines,this._text=o.graphemeText,o},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var o,c,h,p,_,u,C,S=0,D=this._textLines.length;S<D;S++)if(!(this.textAlign!=="justify"&&(S===D-1||this.isEndOfWrapping(S)))&&(p=0,_=this._textLines[S],c=this.getLineWidth(S),c<this.width&&(C=this.textLines[S].match(this._reSpacesAndTabs)))){h=C.length,o=(this.width-c)/h;for(var L=0,U=_.length;L<=U;L++)u=this.__charBounds[S][L],this._reSpaceAndTab.test(_[L])?(u.width+=o,u.kernedWidth+=o,u.left+=p,p+=o):u.left+=p}},isEndOfWrapping:function(o){return o===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var o=this.callSuper("_getCacheCanvasDimensions"),c=this.fontSize;return o.width+=c*o.zoomX,o.height+=c*o.zoomY,o},_render:function(o){var c=this.path;c&&!c.isNotVisible()&&c._render(o),this._setTextStyles(o),this._renderTextLinesBackground(o),this._renderTextDecoration(o,"underline"),this._renderText(o),this._renderTextDecoration(o,"overline"),this._renderTextDecoration(o,"linethrough")},_renderText:function(o){this.paintFirst==="stroke"?(this._renderTextStroke(o),this._renderTextFill(o)):(this._renderTextFill(o),this._renderTextStroke(o))},_setTextStyles:function(o,c,h){if(o.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":o.textBaseline="middle";break;case"ascender":o.textBaseline="top";break;case"descender":o.textBaseline="bottom";break}o.font=this._getFontDeclaration(c,h)},calcTextWidth:function(){for(var o=this.getLineWidth(0),c=1,h=this._textLines.length;c<h;c++){var p=this.getLineWidth(c);p>o&&(o=p)}return o},_renderTextLine:function(o,c,h,p,_,u){this._renderChars(o,c,h,p,_,u)},_renderTextLinesBackground:function(o){if(!(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))){for(var c,h,p=o.fillStyle,_,u,C=this._getLeftOffset(),S=this._getTopOffset(),D=0,L=0,U,$,ne=this.path,ye,Ve=0,Ke=this._textLines.length;Ve<Ke;Ve++){if(c=this.getHeightOfLine(Ve),!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",Ve)){S+=c;continue}_=this._textLines[Ve],h=this._getLineLeftOffset(Ve),L=0,D=0,u=this.getValueOfPropertyAt(Ve,0,"textBackgroundColor");for(var at=0,$e=_.length;at<$e;at++)U=this.__charBounds[Ve][at],$=this.getValueOfPropertyAt(Ve,at,"textBackgroundColor"),ne?(o.save(),o.translate(U.renderLeft,U.renderTop),o.rotate(U.angle),o.fillStyle=$,$&&o.fillRect(-U.width/2,-c/this.lineHeight*(1-this._fontSizeFraction),U.width,c/this.lineHeight),o.restore()):$!==u?(ye=C+h+D,this.direction==="rtl"&&(ye=this.width-ye-L),o.fillStyle=u,u&&o.fillRect(ye,S,L,c/this.lineHeight),D=U.left,L=U.width,u=$):L+=U.kernedWidth;$&&!ne&&(ye=C+h+D,this.direction==="rtl"&&(ye=this.width-ye-L),o.fillStyle=$,o.fillRect(ye,S,L,c/this.lineHeight)),S+=c}o.fillStyle=p,this._removeShadow(o)}},getFontCache:function(o){var c=o.fontFamily.toLowerCase();m.charWidthsCache[c]||(m.charWidthsCache[c]={});var h=m.charWidthsCache[c],p=o.fontStyle.toLowerCase()+"_"+(o.fontWeight+"").toLowerCase();return h[p]||(h[p]={}),h[p]},_measureChar:function(o,c,h,p){var _=this.getFontCache(c),u=this._getFontDeclaration(c),C=this._getFontDeclaration(p),S=h+o,D=u===C,L,U,$,ne=c.fontSize/this.CACHE_FONT_SIZE,ye;if(h&&_[h]!==void 0&&($=_[h]),_[o]!==void 0&&(ye=L=_[o]),D&&_[S]!==void 0&&(U=_[S],ye=U-$),L===void 0||$===void 0||U===void 0){var Ve=this.getMeasuringContext();this._setTextStyles(Ve,c,!0)}return L===void 0&&(ye=L=Ve.measureText(o).width,_[o]=L),$===void 0&&D&&h&&($=Ve.measureText(h).width,_[h]=$),D&&U===void 0&&(U=Ve.measureText(S).width,_[S]=U,ye=U-$),{width:L*ne,kernedWidth:ye*ne}},getHeightOfChar:function(o,c){return this.getValueOfPropertyAt(o,c,"fontSize")},measureLine:function(o){var c=this._measureLine(o);return this.charSpacing!==0&&(c.width-=this._getWidthOfCharSpacing()),c.width<0&&(c.width=0),c},_measureLine:function(o){var c=0,h,p,_=this._textLines[o],u,C,S=0,D=new Array(_.length),L=0,U,$,ne=this.path,ye=this.pathSide==="right";for(this.__charBounds[o]=D,h=0;h<_.length;h++)p=_[h],C=this._getGraphemeBox(p,o,h,u),D[h]=C,c+=C.kernedWidth,u=p;if(D[h]={left:C?C.left+C.width:0,width:0,kernedWidth:0,height:this.fontSize},ne){switch($=ne.segmentsInfo[ne.segmentsInfo.length-1].length,U=m.util.getPointOnPath(ne.path,0,ne.segmentsInfo),U.x+=ne.pathOffset.x,U.y+=ne.pathOffset.y,this.textAlign){case"left":L=ye?$-c:0;break;case"center":L=($-c)/2;break;case"right":L=ye?0:$-c;break}for(L+=this.pathStartOffset*(ye?-1:1),h=ye?_.length-1:0;ye?h>=0:h<_.length;ye?h--:h++)C=D[h],L>$?L%=$:L<0&&(L+=$),this._setGraphemeOnPath(L,C,U),L+=C.kernedWidth}return{width:c,numOfSpaces:S}},_setGraphemeOnPath:function(o,c,h){var p=o+c.kernedWidth/2,_=this.path,u=m.util.getPointOnPath(_.path,p,_.segmentsInfo);c.renderLeft=u.x-h.x,c.renderTop=u.y-h.y,c.angle=u.angle+(this.pathSide==="right"?Math.PI:0)},_getGraphemeBox:function(o,c,h,p,_){var u=this.getCompleteStyleDeclaration(c,h),C=p?this.getCompleteStyleDeclaration(c,h-1):{},S=this._measureChar(o,u,p,C),D=S.kernedWidth,L=S.width,U;this.charSpacing!==0&&(U=this._getWidthOfCharSpacing(),L+=U,D+=U);var $={width:L,left:0,height:u.fontSize,kernedWidth:D,deltaY:u.deltaY};if(h>0&&!_){var ne=this.__charBounds[c][h-1];$.left=ne.left+ne.width+S.kernedWidth-S.width}return $},getHeightOfLine:function(o){if(this.__lineHeights[o])return this.__lineHeights[o];for(var c=this._textLines[o],h=this.getHeightOfChar(o,0),p=1,_=c.length;p<_;p++)h=Math.max(this.getHeightOfChar(o,p),h);return this.__lineHeights[o]=h*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var o,c=0,h=0,p=this._textLines.length;h<p;h++)o=this.getHeightOfLine(h),c+=h===p-1?o/this.lineHeight:o;return c},_getLeftOffset:function(){return this.direction==="ltr"?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(o,c){o.save();for(var h=0,p=this._getLeftOffset(),_=this._getTopOffset(),u=0,C=this._textLines.length;u<C;u++){var S=this.getHeightOfLine(u),D=S/this.lineHeight,L=this._getLineLeftOffset(u);this._renderTextLine(c,o,this._textLines[u],p+L,_+h+D,u),h+=S}o.restore()},_renderTextFill:function(o){!this.fill&&!this.styleHas("fill")||this._renderTextCommon(o,"fillText")},_renderTextStroke:function(o){(!this.stroke||this.strokeWidth===0)&&this.isEmptyStyles()||(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(o),o.save(),this._setLineDash(o,this.strokeDashArray),o.beginPath(),this._renderTextCommon(o,"strokeText"),o.closePath(),o.restore())},_renderChars:function(o,c,h,p,_,u){var C=this.getHeightOfLine(u),S=this.textAlign.indexOf("justify")!==-1,D,L,U="",$,ne=0,ye,Ve=this.path,Ke=!S&&this.charSpacing===0&&this.isEmptyStyles(u)&&!Ve,at=this.direction==="ltr",$e=this.direction==="ltr"?1:-1,ut,ot=c.canvas.getAttribute("dir");if(c.save(),ot!==this.direction&&(c.canvas.setAttribute("dir",at?"ltr":"rtl"),c.direction=at?"ltr":"rtl",c.textAlign=at?"left":"right"),_-=C*this._fontSizeFraction/this.lineHeight,Ke){this._renderChar(o,c,u,0,h.join(""),p,_,C),c.restore();return}for(var vt=0,St=h.length-1;vt<=St;vt++)ye=vt===St||this.charSpacing||Ve,U+=h[vt],$=this.__charBounds[u][vt],ne===0?(p+=$e*($.kernedWidth-$.width),ne+=$.width):ne+=$.kernedWidth,S&&!ye&&this._reSpaceAndTab.test(h[vt])&&(ye=!0),ye||(D=D||this.getCompleteStyleDeclaration(u,vt),L=this.getCompleteStyleDeclaration(u,vt+1),ye=m.util.hasStyleChanged(D,L,!1)),ye&&(Ve?(c.save(),c.translate($.renderLeft,$.renderTop),c.rotate($.angle),this._renderChar(o,c,u,vt,U,-ne/2,0,C),c.restore()):(ut=p,this._renderChar(o,c,u,vt,U,ut,_,C)),U="",D=L,p+=$e*ne,ne=0);c.restore()},_applyPatternGradientTransformText:function(o){var c=m.util.createCanvasElement(),h,p=this.width+this.strokeWidth,_=this.height+this.strokeWidth;return c.width=p,c.height=_,h=c.getContext("2d"),h.beginPath(),h.moveTo(0,0),h.lineTo(p,0),h.lineTo(p,_),h.lineTo(0,_),h.closePath(),h.translate(p/2,_/2),h.fillStyle=o.toLive(h),this._applyPatternGradientTransform(h,o),h.fill(),h.createPattern(c,"no-repeat")},handleFiller:function(o,c,h){var p,_;return h.toLive?h.gradientUnits==="percentage"||h.gradientTransform||h.patternTransform?(p=-this.width/2,_=-this.height/2,o.translate(p,_),o[c]=this._applyPatternGradientTransformText(h),{offsetX:p,offsetY:_}):(o[c]=h.toLive(o,this),this._applyPatternGradientTransform(o,h)):(o[c]=h,{offsetX:0,offsetY:0})},_setStrokeStyles:function(o,c){return o.lineWidth=c.strokeWidth,o.lineCap=this.strokeLineCap,o.lineDashOffset=this.strokeDashOffset,o.lineJoin=this.strokeLineJoin,o.miterLimit=this.strokeMiterLimit,this.handleFiller(o,"strokeStyle",c.stroke)},_setFillStyles:function(o,c){return this.handleFiller(o,"fillStyle",c.fill)},_renderChar:function(o,c,h,p,_,u,C){var S=this._getStyleDeclaration(h,p),D=this.getCompleteStyleDeclaration(h,p),L=o==="fillText"&&D.fill,U=o==="strokeText"&&D.stroke&&D.strokeWidth,$,ne;!U&&!L||(c.save(),L&&($=this._setFillStyles(c,D)),U&&(ne=this._setStrokeStyles(c,D)),c.font=this._getFontDeclaration(D),S&&S.textBackgroundColor&&this._removeShadow(c),S&&S.deltaY&&(C+=S.deltaY),L&&c.fillText(_,u-$.offsetX,C-$.offsetY),U&&c.strokeText(_,u-ne.offsetX,C-ne.offsetY),c.restore())},setSuperscript:function(o,c){return this._setScript(o,c,this.superscript)},setSubscript:function(o,c){return this._setScript(o,c,this.subscript)},_setScript:function(o,c,h){var p=this.get2DCursorLocation(o,!0),_=this.getValueOfPropertyAt(p.lineIndex,p.charIndex,"fontSize"),u=this.getValueOfPropertyAt(p.lineIndex,p.charIndex,"deltaY"),C={fontSize:_*h.size,deltaY:u+_*h.baseline};return this.setSelectionStyles(C,o,c),this},_getLineLeftOffset:function(o){var c=this.getLineWidth(o),h=this.width-c,p=this.textAlign,_=this.direction,C,u=0,C=this.isEndOfWrapping(o);return p==="justify"||p==="justify-center"&&!C||p==="justify-right"&&!C||p==="justify-left"&&!C?0:(p==="center"&&(u=h/2),p==="right"&&(u=h),p==="justify-center"&&(u=h/2),p==="justify-right"&&(u=h),_==="rtl"&&(u-=h),u)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var o=this._forceClearCache;return o||(o=this.hasStateChanged("_dimensionAffectingProps")),o&&(this.dirty=!0,this._forceClearCache=!1),o},getLineWidth:function(o){if(this.__lineWidths[o]!==void 0)return this.__lineWidths[o];var c=this.measureLine(o),h=c.width;return this.__lineWidths[o]=h,h},_getWidthOfCharSpacing:function(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(o,c,h){var p=this._getStyleDeclaration(o,c);return p&&typeof p[h]<"u"?p[h]:this[h]},_renderTextDecoration:function(o,c){if(!(!this[c]&&!this.styleHas(c))){for(var h,p,_,u,C,S,D,L,U=this._getLeftOffset(),$=this._getTopOffset(),ne,ye,Ve,Ke,at,$e,ut,ot,vt=this.path,St=this._getWidthOfCharSpacing(),ct=this.offsets[c],Et=0,Q=this._textLines.length;Et<Q;Et++){if(h=this.getHeightOfLine(Et),!this[c]&&!this.styleHas(c,Et)){$+=h;continue}D=this._textLines[Et],$e=h/this.lineHeight,u=this._getLineLeftOffset(Et),ye=0,Ve=0,L=this.getValueOfPropertyAt(Et,0,c),ot=this.getValueOfPropertyAt(Et,0,"fill"),ne=$+$e*(1-this._fontSizeFraction),p=this.getHeightOfChar(Et,0),C=this.getValueOfPropertyAt(Et,0,"deltaY");for(var de=0,_e=D.length;de<_e;de++)if(Ke=this.__charBounds[Et][de],at=this.getValueOfPropertyAt(Et,de,c),ut=this.getValueOfPropertyAt(Et,de,"fill"),_=this.getHeightOfChar(Et,de),S=this.getValueOfPropertyAt(Et,de,"deltaY"),vt&&at&&ut)o.save(),o.fillStyle=ot,o.translate(Ke.renderLeft,Ke.renderTop),o.rotate(Ke.angle),o.fillRect(-Ke.kernedWidth/2,ct*_+S,Ke.kernedWidth,this.fontSize/15),o.restore();else if((at!==L||ut!==ot||_!==p||S!==C)&&Ve>0){var pe=U+u+ye;this.direction==="rtl"&&(pe=this.width-pe-Ve),L&&ot&&(o.fillStyle=ot,o.fillRect(pe,ne+ct*p+C,Ve,this.fontSize/15)),ye=Ke.left,Ve=Ke.width,L=at,ot=ut,p=_,C=S}else Ve+=Ke.kernedWidth;var pe=U+u+ye;this.direction==="rtl"&&(pe=this.width-pe-Ve),o.fillStyle=ut,at&&ut&&o.fillRect(pe,ne+ct*p+C,Ve-St,this.fontSize/15),$+=h}this._removeShadow(o)}},_getFontDeclaration:function(o,c){var h=o||this,p=this.fontFamily,_=m.Text.genericFonts.indexOf(p.toLowerCase())>-1,u=p===void 0||p.indexOf("'")>-1||p.indexOf(",")>-1||p.indexOf('"')>-1||_?h.fontFamily:'"'+h.fontFamily+'"';return[m.isLikelyNode?h.fontWeight:h.fontStyle,m.isLikelyNode?h.fontStyle:h.fontWeight,c?this.CACHE_FONT_SIZE+"px":h.fontSize+"px",u].join(" ")},render:function(o){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",o)))},_splitTextIntoLines:function(o){for(var c=o.split(this._reNewline),h=new Array(c.length),p=[`
`],_=[],u=0;u<c.length;u++)h[u]=m.util.string.graphemeSplit(c[u]),_=_.concat(h[u],p);return _.pop(),{_unwrappedLines:h,lines:c,graphemeText:_,graphemeLines:h}},toObject:function(o){var c=x.concat(o),h=this.callSuper("toObject",c);return h.styles=m.util.stylesToArray(this.styles,this.text),h.path&&(h.path=this.path.toObject()),h},set:function(o,c){this.callSuper("set",o,c);var h=!1,p=!1;if(typeof o=="object")for(var _ in o)_==="path"&&this.setPathInfo(),h=h||this._dimensionAffectingProps.indexOf(_)!==-1,p=p||_==="path";else h=this._dimensionAffectingProps.indexOf(o)!==-1,p=o==="path";return p&&this.setPathInfo(),h&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),m.Text.ATTRIBUTE_NAMES=m.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),m.Text.DEFAULT_SVG_FONT_SIZE=16,m.Text.fromElement=function(o,c,h){if(!o)return c(null);var p=m.parseAttributes(o,m.Text.ATTRIBUTE_NAMES),_=p.textAnchor||"left";if(h=m.util.object.extend(h?b(h):{},p),h.top=h.top||0,h.left=h.left||0,p.textDecoration){var u=p.textDecoration;u.indexOf("underline")!==-1&&(h.underline=!0),u.indexOf("overline")!==-1&&(h.overline=!0),u.indexOf("line-through")!==-1&&(h.linethrough=!0),delete h.textDecoration}"dx"in p&&(h.left+=p.dx),"dy"in p&&(h.top+=p.dy),"fontSize"in h||(h.fontSize=m.Text.DEFAULT_SVG_FONT_SIZE);var C="";"textContent"in o?C=o.textContent:"firstChild"in o&&o.firstChild!==null&&"data"in o.firstChild&&o.firstChild.data!==null&&(C=o.firstChild.data),C=C.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var S=h.strokeWidth;h.strokeWidth=0;var D=new m.Text(C,h),L=D.getScaledHeight()/D.height,U=(D.height+D.strokeWidth)*D.lineHeight-D.height,$=U*L,ne=D.getScaledHeight()+$,ye=0;_==="center"&&(ye=D.getScaledWidth()/2),_==="right"&&(ye=D.getScaledWidth()),D.set({left:D.left-ye,top:D.top-(ne-D.fontSize*(.07+D._fontSizeFraction))/D.lineHeight,strokeWidth:typeof S<"u"?S:1}),c(D)},m.Text.fromObject=function(o,c){var h=b(o),p=o.path;return delete h.path,m.Object._fromObject("Text",h,function(_){_.styles=m.util.stylesFromArray(o.styles,o.text),p?m.Object._fromObject("Path",p,function(u){_.set("path",u),c(_)},"path"):c(_)},"text")},m.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],m.util.createAccessors&&m.util.createAccessors(m.Text)}(ie),function(){I.util.object.extend(I.Text.prototype,{isEmptyStyles:function(s){if(!this.styles||typeof s<"u"&&!this.styles[s])return!0;var m=typeof s>"u"?this.styles:{line:this.styles[s]};for(var b in m)for(var x in m[b])for(var o in m[b][x])return!1;return!0},styleHas:function(s,m){if(!this.styles||!s||s===""||typeof m<"u"&&!this.styles[m])return!1;var b=typeof m>"u"?this.styles:{0:this.styles[m]};for(var x in b)for(var o in b[x])if(typeof b[x][o][s]<"u")return!0;return!1},cleanStyle:function(s){if(!this.styles||!s||s==="")return!1;var m=this.styles,b=0,x,o,c=!0,h=0,p;for(var _ in m){x=0;for(var u in m[_]){var p=m[_][u],C=p.hasOwnProperty(s);b++,C?(o?p[s]!==o&&(c=!1):o=p[s],p[s]===this[s]&&delete p[s]):c=!1,Object.keys(p).length!==0?x++:delete m[_][u]}x===0&&delete m[_]}for(var S=0;S<this._textLines.length;S++)h+=this._textLines[S].length;c&&b===h&&(this[s]=o,this.removeStyle(s))},removeStyle:function(s){if(!(!this.styles||!s||s==="")){var m=this.styles,b,x,o;for(x in m){b=m[x];for(o in b)delete b[o][s],Object.keys(b[o]).length===0&&delete b[o];Object.keys(b).length===0&&delete m[x]}}},_extendStyles:function(s,m){var b=this.get2DCursorLocation(s);this._getLineStyle(b.lineIndex)||this._setLineStyle(b.lineIndex),this._getStyleDeclaration(b.lineIndex,b.charIndex)||this._setStyleDeclaration(b.lineIndex,b.charIndex,{}),I.util.object.extend(this._getStyleDeclaration(b.lineIndex,b.charIndex),m)},get2DCursorLocation:function(s,m){typeof s>"u"&&(s=this.selectionStart);for(var b=m?this._unwrappedTextLines:this._textLines,x=b.length,o=0;o<x;o++){if(s<=b[o].length)return{lineIndex:o,charIndex:s};s-=b[o].length+this.missingNewlineOffset(o)}return{lineIndex:o-1,charIndex:b[o-1].length<s?b[o-1].length:s}},getSelectionStyles:function(s,m,b){typeof s>"u"&&(s=this.selectionStart||0),typeof m>"u"&&(m=this.selectionEnd||s);for(var x=[],o=s;o<m;o++)x.push(this.getStyleAtPosition(o,b));return x},getStyleAtPosition:function(s,m){var b=this.get2DCursorLocation(s),x=m?this.getCompleteStyleDeclaration(b.lineIndex,b.charIndex):this._getStyleDeclaration(b.lineIndex,b.charIndex);return x||{}},setSelectionStyles:function(s,m,b){typeof m>"u"&&(m=this.selectionStart||0),typeof b>"u"&&(b=this.selectionEnd||m);for(var x=m;x<b;x++)this._extendStyles(x,s);return this._forceClearCache=!0,this},_getStyleDeclaration:function(s,m){var b=this.styles&&this.styles[s];return b?b[m]:null},getCompleteStyleDeclaration:function(s,m){for(var b=this._getStyleDeclaration(s,m)||{},x={},o,c=0;c<this._styleProperties.length;c++)o=this._styleProperties[c],x[o]=typeof b[o]>"u"?this[o]:b[o];return x},_setStyleDeclaration:function(s,m,b){this.styles[s][m]=b},_deleteStyleDeclaration:function(s,m){delete this.styles[s][m]},_getLineStyle:function(s){return!!this.styles[s]},_setLineStyle:function(s){this.styles[s]={}},_deleteLineStyle:function(s){delete this.styles[s]}})}(),function(){function s(m){m.textDecoration&&(m.textDecoration.indexOf("underline")>-1&&(m.underline=!0),m.textDecoration.indexOf("line-through")>-1&&(m.linethrough=!0),m.textDecoration.indexOf("overline")>-1&&(m.overline=!0),delete m.textDecoration)}I.IText=I.util.createClass(I.Text,I.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(m,b){this.callSuper("initialize",m,b),this.initBehavior()},setSelectionStart:function(m){m=Math.max(m,0),this._updateAndFire("selectionStart",m)},setSelectionEnd:function(m){m=Math.min(m,this.text.length),this._updateAndFire("selectionEnd",m)},_updateAndFire:function(m,b){this[m]!==b&&(this._fireSelectionChanged(),this[m]=b),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(m){this.clearContextTop(),this.callSuper("render",m),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(m){this.callSuper("_render",m)},clearContextTop:function(m){if(!(!this.isEditing||!this.canvas||!this.canvas.contextTop)){var b=this.canvas.contextTop,x=this.canvas.viewportTransform;b.save(),b.transform(x[0],x[1],x[2],x[3],x[4],x[5]),this.transform(b),this._clearTextArea(b),m||b.restore()}},renderCursorOrSelection:function(){if(!(!this.isEditing||!this.canvas||!this.canvas.contextTop)){var m=this._getCursorBoundaries(),b=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(m,b):this.renderSelection(m,b),b.restore()}},_clearTextArea:function(m){var b=this.width+4,x=this.height+4;m.clearRect(-b/2,-x/2,b,x)},_getCursorBoundaries:function(m){typeof m>"u"&&(m=this.selectionStart);var b=this._getLeftOffset(),x=this._getTopOffset(),o=this._getCursorBoundariesOffsets(m);return{left:b,top:x,leftOffset:o.left,topOffset:o.top}},_getCursorBoundariesOffsets:function(m){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var b,x,o,c=0,h=0,p,_=this.get2DCursorLocation(m);o=_.charIndex,x=_.lineIndex;for(var u=0;u<x;u++)c+=this.getHeightOfLine(u);b=this._getLineLeftOffset(x);var C=this.__charBounds[x][o];return C&&(h=C.left),this.charSpacing!==0&&o===this._textLines[x].length&&(h-=this._getWidthOfCharSpacing()),p={top:c,left:b+(h>0?h:0)},this.direction==="rtl"&&(p.left*=-1),this.cursorOffsetCache=p,this.cursorOffsetCache},renderCursor:function(m,b){var x=this.get2DCursorLocation(),o=x.lineIndex,c=x.charIndex>0?x.charIndex-1:0,h=this.getValueOfPropertyAt(o,c,"fontSize"),p=this.scaleX*this.canvas.getZoom(),_=this.cursorWidth/p,u=m.topOffset,C=this.getValueOfPropertyAt(o,c,"deltaY");u+=(1-this._fontSizeFraction)*this.getHeightOfLine(o)/this.lineHeight-h*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(m,b),b.fillStyle=this.cursorColor||this.getValueOfPropertyAt(o,c,"fill"),b.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,b.fillRect(m.left+m.leftOffset-_/2,u+m.top+C,_,h)},renderSelection:function(m,b){for(var x=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,o=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,c=this.textAlign.indexOf("justify")!==-1,h=this.get2DCursorLocation(x),p=this.get2DCursorLocation(o),_=h.lineIndex,u=p.lineIndex,C=h.charIndex<0?0:h.charIndex,S=p.charIndex<0?0:p.charIndex,D=_;D<=u;D++){var L=this._getLineLeftOffset(D)||0,U=this.getHeightOfLine(D),$=0,ne=0,ye=0;if(D===_&&(ne=this.__charBounds[_][C].left),D>=_&&D<u)ye=c&&!this.isEndOfWrapping(D)?this.width:this.getLineWidth(D)||5;else if(D===u)if(S===0)ye=this.__charBounds[u][S].left;else{var Ve=this._getWidthOfCharSpacing();ye=this.__charBounds[u][S-1].left+this.__charBounds[u][S-1].width-Ve}$=U,(this.lineHeight<1||D===u&&this.lineHeight>1)&&(U/=this.lineHeight);var Ke=m.left+L+ne,at=ye-ne,$e=U,ut=0;this.inCompositionMode?(b.fillStyle=this.compositionColor||"black",$e=1,ut=U):b.fillStyle=this.selectionColor,this.direction==="rtl"&&(Ke=this.width-Ke-at),b.fillRect(Ke,m.top+m.topOffset+ut,at,$e),m.topOffset+=$}},getCurrentCharFontSize:function(){var m=this._getCurrentCharIndex();return this.getValueOfPropertyAt(m.l,m.c,"fontSize")},getCurrentCharColor:function(){var m=this._getCurrentCharIndex();return this.getValueOfPropertyAt(m.l,m.c,"fill")},_getCurrentCharIndex:function(){var m=this.get2DCursorLocation(this.selectionStart,!0),b=m.charIndex>0?m.charIndex-1:0;return{l:m.lineIndex,c:b}}}),I.IText.fromObject=function(m,b){var x=I.util.stylesFromArray(m.styles,m.text),o=Object.assign({},m,{styles:x});if(s(o),o.styles)for(var c in o.styles)for(var h in o.styles[c])s(o.styles[c][h]);I.Object._fromObject("IText",o,b,"text")}}(),function(){var s=I.util.object.clone;I.util.object.extend(I.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var m=this;this.on("added",function(){var b=m.canvas;b&&(b._hasITextHandlers||(b._hasITextHandlers=!0,m._initCanvasHandlers(b)),b._iTextInstances=b._iTextInstances||[],b._iTextInstances.push(m))})},initRemovedHandler:function(){var m=this;this.on("removed",function(){var b=m.canvas;b&&(b._iTextInstances=b._iTextInstances||[],I.util.removeFromArray(b._iTextInstances,m),b._iTextInstances.length===0&&(b._hasITextHandlers=!1,m._removeCanvasHandlers(b)))})},_initCanvasHandlers:function(m){m._mouseUpITextHandler=function(){m._iTextInstances&&m._iTextInstances.forEach(function(b){b.__isMousedown=!1})},m.on("mouse:up",m._mouseUpITextHandler)},_removeCanvasHandlers:function(m){m.off("mouse:up",m._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(m,b,x,o){var c;return c={isAborted:!1,abort:function(){this.isAborted=!0}},m.animate("_currentCursorOpacity",b,{duration:x,onComplete:function(){c.isAborted||m[o]()},onChange:function(){m.canvas&&m.selectionStart===m.selectionEnd&&m.renderCursorOrSelection()},abort:function(){return c.isAborted}}),c},_onTickComplete:function(){var m=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){m._currentTickCompleteState=m._animateCursor(m,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(m){var b=this,x=m?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){b._tick()},x)},abortCursorAnimation:function(){var m=this._currentTickState||this._currentTickCompleteState,b=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,m&&b&&b.clearContext(b.contextTop||b.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(m){var b=0,x=m-1;if(this._reSpace.test(this._text[x]))for(;this._reSpace.test(this._text[x]);)b++,x--;for(;/\S/.test(this._text[x])&&x>-1;)b++,x--;return m-b},findWordBoundaryRight:function(m){var b=0,x=m;if(this._reSpace.test(this._text[x]))for(;this._reSpace.test(this._text[x]);)b++,x++;for(;/\S/.test(this._text[x])&&x<this._text.length;)b++,x++;return m+b},findLineBoundaryLeft:function(m){for(var b=0,x=m-1;!/\n/.test(this._text[x])&&x>-1;)b++,x--;return m-b},findLineBoundaryRight:function(m){for(var b=0,x=m;!/\n/.test(this._text[x])&&x<this._text.length;)b++,x++;return m+b},searchWordBoundary:function(m,b){for(var x=this._text,o=this._reSpace.test(x[m])?m-1:m,c=x[o],h=I.reNonWord;!h.test(c)&&o>0&&o<x.length;)o+=b,c=x[o];return h.test(c)&&(o+=b===1?0:1),o},selectWord:function(m){m=m||this.selectionStart;var b=this.searchWordBoundary(m,-1),x=this.searchWordBoundary(m,1);this.selectionStart=b,this.selectionEnd=x,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(m){m=m||this.selectionStart;var b=this.findLineBoundaryLeft(m),x=this.findLineBoundaryRight(m);return this.selectionStart=b,this.selectionEnd=x,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(m){if(!(this.isEditing||!this.editable))return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(m),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(m){m._iTextInstances&&m._iTextInstances.forEach(function(b){b.selected=!1,b.isEditing&&b.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(m){if(!(!this.__isMousedown||!this.isEditing)){document.activeElement!==this.hiddenTextarea&&this.hiddenTextarea.focus();var b=this.getSelectionStartFromPointer(m.e),x=this.selectionStart,o=this.selectionEnd;(b!==this.__selectionStartOnMouseDown||x===o)&&(x===b||o===b)||(b>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=b):(this.selectionStart=b,this.selectionEnd=this.__selectionStartOnMouseDown),(this.selectionStart!==x||this.selectionEnd!==o)&&(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(m,b,x){var o=x.slice(0,m),c=I.util.string.graphemeSplit(o).length;if(m===b)return{selectionStart:c,selectionEnd:c};var h=x.slice(m,b),p=I.util.string.graphemeSplit(h).length;return{selectionStart:c,selectionEnd:c+p}},fromGraphemeToStringSelection:function(m,b,x){var o=x.slice(0,m),c=o.join("").length;if(m===b)return{selectionStart:c,selectionEnd:c};var h=x.slice(m,b),p=h.join("").length;return{selectionStart:c,selectionEnd:c+p}},_updateTextarea:function(){if(this.cursorOffsetCache={},!!this.hiddenTextarea){if(!this.inCompositionMode){var m=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=m.selectionStart,this.hiddenTextarea.selectionEnd=m.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var m=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=m.selectionEnd,this.inCompositionMode||(this.selectionStart=m.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var m=this._calcTextareaPosition();this.hiddenTextarea.style.left=m.left,this.hiddenTextarea.style.top=m.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var m=this.inCompositionMode?this.compositionStart:this.selectionStart,b=this._getCursorBoundaries(m),x=this.get2DCursorLocation(m),o=x.lineIndex,c=x.charIndex,h=this.getValueOfPropertyAt(o,c,"fontSize")*this.lineHeight,p=b.leftOffset,_=this.calcTransformMatrix(),u={x:b.left+p,y:b.top+b.topOffset+h},C=this.canvas.getRetinaScaling(),S=this.canvas.upperCanvasEl,D=S.width/C,L=S.height/C,U=D-h,$=L-h,ne=S.clientWidth/D,ye=S.clientHeight/L;return u=I.util.transformPoint(u,_),u=I.util.transformPoint(u,this.canvas.viewportTransform),u.x*=ne,u.y*=ye,u.x<0&&(u.x=0),u.x>U&&(u.x=U),u.y<0&&(u.y=0),u.y>$&&(u.y=$),u.x+=this.canvas._offset.left,u.y+=this.canvas._offset.top,{left:u.x+"px",top:u.y+"px",fontSize:h+"px",charHeight:h}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var m=this._textBeforeEdit!==this.text,b=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,b&&(b.blur&&b.blur(),b.parentNode&&b.parentNode.removeChild(b)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),m&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),m&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var m in this.styles)this._textLines[m]||delete this.styles[m]},removeStyleFromTo:function(m,b){var x=this.get2DCursorLocation(m,!0),o=this.get2DCursorLocation(b,!0),c=x.lineIndex,h=x.charIndex,p=o.lineIndex,_=o.charIndex,u,C;if(c!==p){if(this.styles[c])for(u=h;u<this._unwrappedTextLines[c].length;u++)delete this.styles[c][u];if(this.styles[p])for(u=_;u<this._unwrappedTextLines[p].length;u++)C=this.styles[p][u],C&&(this.styles[c]||(this.styles[c]={}),this.styles[c][h+u-_]=C);for(u=c+1;u<=p;u++)delete this.styles[u];this.shiftLineStyles(p,c-p)}else if(this.styles[c]){C=this.styles[c];var S=_-h,D,L;for(u=h;u<_;u++)delete C[u];for(L in this.styles[c])D=parseInt(L,10),D>=_&&(C[D-S]=C[L],delete C[L])}},shiftLineStyles:function(m,b){var x=s(this.styles);for(var o in this.styles){var c=parseInt(o,10);c>m&&(this.styles[c+b]=x[c],x[c-b]||delete this.styles[c])}},restartCursorIfNeeded:function(){(!this._currentTickState||this._currentTickState.isAborted||!this._currentTickCompleteState||this._currentTickCompleteState.isAborted)&&this.initDelayedCursor()},insertNewlineStyleObject:function(m,b,x,o){var c,h={},p=!1,_=this._unwrappedTextLines[m].length===b;x||(x=1),this.shiftLineStyles(m,x),this.styles[m]&&(c=this.styles[m][b===0?b:b-1]);for(var u in this.styles[m]){var C=parseInt(u,10);C>=b&&(p=!0,h[C-b]=this.styles[m][u],_&&b===0||delete this.styles[m][u])}var S=!1;for(p&&!_&&(this.styles[m+x]=h,S=!0),S&&x--;x>0;)o&&o[x-1]?this.styles[m+x]={0:s(o[x-1])}:c?this.styles[m+x]={0:s(c)}:delete this.styles[m+x],x--;this._forceClearCache=!0},insertCharStyleObject:function(m,b,x,o){this.styles||(this.styles={});var c=this.styles[m],h=c?s(c):{};x||(x=1);for(var p in h){var _=parseInt(p,10);_>=b&&(c[_+x]=h[_],h[_-x]||delete c[_])}if(this._forceClearCache=!0,o){for(;x--;)Object.keys(o[x]).length&&(this.styles[m]||(this.styles[m]={}),this.styles[m][b+x]=s(o[x]));return}if(c)for(var u=c[b?b-1:1];u&&x--;)this.styles[m][b+x]=s(u)},insertNewStyleBlock:function(m,b,x){for(var o=this.get2DCursorLocation(b,!0),c=[0],h=0,p=0;p<m.length;p++)m[p]===`
`?(h++,c[h]=0):c[h]++;c[0]>0&&(this.insertCharStyleObject(o.lineIndex,o.charIndex,c[0],x),x=x&&x.slice(c[0]+1)),h&&this.insertNewlineStyleObject(o.lineIndex,o.charIndex+c[0],h);for(var p=1;p<h;p++)c[p]>0?this.insertCharStyleObject(o.lineIndex+p,0,c[p],x):x&&this.styles[o.lineIndex+p]&&x[0]&&(this.styles[o.lineIndex+p][0]=x[0]),x=x&&x.slice(c[p]+1);c[p]>0&&this.insertCharStyleObject(o.lineIndex+p,0,c[p],x)},setSelectionStartEndWithShift:function(m,b,x){x<=m?(b===m?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=m),this.selectionStart=x):x>m&&x<b?this._selectionDirection==="right"?this.selectionEnd=x:this.selectionStart=x:(b===m?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=b),this.selectionEnd=x)},setSelectionInBoundaries:function(){var m=this.text.length;this.selectionStart>m?this.selectionStart=m:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>m?this.selectionEnd=m:this.selectionEnd<0&&(this.selectionEnd=0)}})}(),I.util.object.extend(I.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(s){if(this.canvas){this.__newClickTime=+new Date;var m=s.pointer;this.isTripleClick(m)&&(this.fire("tripleclick",s),this._stopEvent(s.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=m,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(s){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===s.x&&this.__lastPointer.y===s.y},_stopEvent:function(s){s.preventDefault&&s.preventDefault(),s.stopPropagation&&s.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(s){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(s.e))},tripleClickHandler:function(s){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(s.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(s){!this.canvas||!this.editable||s.e.button&&s.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(s.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(s){!this.canvas||!this.editable||s.e.button&&s.e.button!==1||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(s){if(this.__isMousedown=!1,!(!this.editable||this.group||s.transform&&s.transform.actionPerformed||s.e.button&&s.e.button!==1)){if(this.canvas){var m=this.canvas._activeObject;if(m&&m!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(s.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(s){var m=this.getSelectionStartFromPointer(s),b=this.selectionStart,x=this.selectionEnd;s.shiftKey?this.setSelectionStartEndWithShift(b,x,m):(this.selectionStart=m,this.selectionEnd=m),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(s){for(var m=this.getLocalPointer(s),b=0,x=0,o=0,c=0,h=0,p,_,u=0,C=this._textLines.length;u<C&&o<=m.y;u++)o+=this.getHeightOfLine(u)*this.scaleY,h=u,u>0&&(c+=this._textLines[u-1].length+this.missingNewlineOffset(u-1));p=this._getLineLeftOffset(h),x=p*this.scaleX,_=this._textLines[h],this.direction==="rtl"&&(m.x=this.width*this.scaleX-m.x+x);for(var S=0,D=_.length;S<D&&(b=x,x+=this.__charBounds[h][S].kernedWidth*this.scaleX,x<=m.x);S++)c++;return this._getNewSelectionStartFromOffset(m,b,x,c,D)},_getNewSelectionStartFromOffset:function(s,m,b,x,o){var c=s.x-m,h=b-s.x,p=h>c||h<0?0:1,_=x+p;return this.flipX&&(_=o-_),_>this._text.length&&(_=this._text.length),_}}),I.util.object.extend(I.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=I.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var s=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+s.top+"; left: "+s.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding-top: "+s.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):I.document.body.appendChild(this.hiddenTextarea),I.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),I.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),I.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),I.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),I.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),I.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),I.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),I.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),I.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(I.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(s){if(this.isEditing){var m=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(s.keyCode in m)this[m[s.keyCode]](s);else if(s.keyCode in this.ctrlKeysMapDown&&(s.ctrlKey||s.metaKey))this[this.ctrlKeysMapDown[s.keyCode]](s);else return;s.stopImmediatePropagation(),s.preventDefault(),s.keyCode>=33&&s.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(s){if(!this.isEditing||this._copyDone||this.inCompositionMode){this._copyDone=!1;return}if(s.keyCode in this.ctrlKeysMapUp&&(s.ctrlKey||s.metaKey))this[this.ctrlKeysMapUp[s.keyCode]](s);else return;s.stopImmediatePropagation(),s.preventDefault(),this.canvas&&this.canvas.requestRenderAll()},onInput:function(s){var m=this.fromPaste;if(this.fromPaste=!1,s&&s.stopPropagation(),!!this.isEditing){var b=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,x=this._text.length,o=b.length,c,h,p=o-x,_=this.selectionStart,u=this.selectionEnd,C=_!==u,S,D,L;if(this.hiddenTextarea.value===""){this.styles={},this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll());return}var U=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),$=_>U.selectionStart;C?(c=this._text.slice(_,u),p+=u-_):o<x&&($?c=this._text.slice(u+p,u):c=this._text.slice(_,_-p)),h=b.slice(U.selectionEnd-p,U.selectionEnd),c&&c.length&&(h.length&&(S=this.getSelectionStyles(_,_+1,!1),S=h.map(function(){return S[0]})),C?(D=_,L=u):$?(D=u-c.length,L=u):(D=u,L=u+c.length),this.removeStyleFromTo(D,L)),h.length&&(m&&h.join("")===I.copiedText&&!I.disableStyleCopyPaste&&(S=I.copiedTextStyle),this.insertNewStyleBlock(h,_,S)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(s){this.compositionStart=s.target.selectionStart,this.compositionEnd=s.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(I.copiedText=this.getSelectedText(),I.disableStyleCopyPaste?I.copiedTextStyle=null:I.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(s){return s&&s.clipboardData||I.window.clipboardData},_getWidthBeforeCursor:function(s,m){var b=this._getLineLeftOffset(s),x;return m>0&&(x=this.__charBounds[s][m-1],b+=x.left+x.width),b},getDownCursorOffset:function(s,m){var b=this._getSelectionForOffset(s,m),x=this.get2DCursorLocation(b),o=x.lineIndex;if(o===this._textLines.length-1||s.metaKey||s.keyCode===34)return this._text.length-b;var c=x.charIndex,h=this._getWidthBeforeCursor(o,c),p=this._getIndexOnLine(o+1,h),_=this._textLines[o].slice(c);return _.length+p+1+this.missingNewlineOffset(o)},_getSelectionForOffset:function(s,m){return s.shiftKey&&this.selectionStart!==this.selectionEnd&&m?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(s,m){var b=this._getSelectionForOffset(s,m),x=this.get2DCursorLocation(b),o=x.lineIndex;if(o===0||s.metaKey||s.keyCode===33)return-b;var c=x.charIndex,h=this._getWidthBeforeCursor(o,c),p=this._getIndexOnLine(o-1,h),_=this._textLines[o].slice(0,c),u=this.missingNewlineOffset(o-1);return-this._textLines[o-1].length+p-_.length+(1-u)},_getIndexOnLine:function(s,m){for(var b=this._textLines[s],x=this._getLineLeftOffset(s),o=x,c=0,h,p,_=0,u=b.length;_<u;_++)if(h=this.__charBounds[s][_].width,o+=h,o>m){p=!0;var C=o-h,S=o,D=Math.abs(C-m),L=Math.abs(S-m);c=L<D?_:_-1;break}return p||(c=b.length-1),c},moveCursorDown:function(s){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",s)},moveCursorUp:function(s){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",s)},_moveCursorUpOrDown:function(s,m){var b="get"+s+"CursorOffset",x=this[b](m,this._selectionDirection==="right");m.shiftKey?this.moveCursorWithShift(x):this.moveCursorWithoutShift(x),x!==0&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(s){var m=this._selectionDirection==="left"?this.selectionStart+s:this.selectionEnd+s;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,m),s!==0},moveCursorWithoutShift:function(s){return s<0?(this.selectionStart+=s,this.selectionEnd=this.selectionStart):(this.selectionEnd+=s,this.selectionStart=this.selectionEnd),s!==0},moveCursorLeft:function(s){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",s)},_move:function(s,m,b){var x;if(s.altKey)x=this["findWordBoundary"+b](this[m]);else if(s.metaKey||s.keyCode===35||s.keyCode===36)x=this["findLineBoundary"+b](this[m]);else return this[m]+=b==="Left"?-1:1,!0;if(typeof x<"u"&&this[m]!==x)return this[m]=x,!0},_moveLeft:function(s,m){return this._move(s,m,"Left")},_moveRight:function(s,m){return this._move(s,m,"Right")},moveCursorLeftWithoutShift:function(s){var m=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(m=this._moveLeft(s,"selectionStart")),this.selectionEnd=this.selectionStart,m},moveCursorLeftWithShift:function(s){if(this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd)return this._moveLeft(s,"selectionEnd");if(this.selectionStart!==0)return this._selectionDirection="left",this._moveLeft(s,"selectionStart")},moveCursorRight:function(s){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",s)},_moveCursorLeftOrRight:function(s,m){var b="moveCursor"+s+"With";this._currentCursorOpacity=1,m.shiftKey?b+="Shift":b+="outShift",this[b](m)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(s){if(this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd)return this._moveRight(s,"selectionStart");if(this.selectionEnd!==this._text.length)return this._selectionDirection="right",this._moveRight(s,"selectionEnd")},moveCursorRightWithoutShift:function(s){var m=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(m=this._moveRight(s,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,m},removeChars:function(s,m){typeof m>"u"&&(m=s+1),this.removeStyleFromTo(s,m),this._text.splice(s,m-s),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(s,m,b,x){typeof x>"u"&&(x=b),x>b&&this.removeStyleFromTo(b,x);var o=I.util.string.graphemeSplit(s);this.insertNewStyleBlock(o,b,m),this._text=[].concat(this._text.slice(0,b),o,this._text.slice(x)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var s=I.util.toFixed,m=/  +/g;I.util.object.extend(I.Text.prototype,{_toSVG:function(){var b=this._getSVGLeftTopOffsets(),x=this._getSVGTextAndBg(b.textTop,b.textLeft);return this._wrapSVGTextAndBg(x)},toSVG:function(b){return this._createBaseSVGMarkup(this._toSVG(),{reviver:b,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(b){var x=!0,o=this.getSvgTextDecoration(this);return[b.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",o?'text-decoration="'+o+'" ':"",'style="',this.getSvgStyles(x),'"',this.addPaintOrder()," >",b.textSpans.join(""),`</text>
`]},_getSVGTextAndBg:function(b,x){var o=[],c=[],h=b,p;this._setSVGBg(c);for(var _=0,u=this._textLines.length;_<u;_++)p=this._getLineLeftOffset(_),(this.textBackgroundColor||this.styleHas("textBackgroundColor",_))&&this._setSVGTextLineBg(c,_,x+p,h),this._setSVGTextLineText(o,_,x+p,h),h+=this.getHeightOfLine(_);return{textSpans:o,textBgRects:c}},_createTextCharSpan:function(b,x,o,c){var h=b!==b.trim()||b.match(m),p=this.getSvgSpanStyles(x,h),_=p?'style="'+p+'"':"",u=x.deltaY,C="",S=I.Object.NUM_FRACTION_DIGITS;return u&&(C=' dy="'+s(u,S)+'" '),['<tspan x="',s(o,S),'" y="',s(c,S),'" ',C,_,">",I.util.string.escapeXml(b),"</tspan>"].join("")},_setSVGTextLineText:function(b,x,o,c){var h=this.getHeightOfLine(x),p=this.textAlign.indexOf("justify")!==-1,_,u,C="",S,D,L=0,U=this._textLines[x],$;c+=h*(1-this._fontSizeFraction)/this.lineHeight;for(var ne=0,ye=U.length-1;ne<=ye;ne++)$=ne===ye||this.charSpacing,C+=U[ne],S=this.__charBounds[x][ne],L===0?(o+=S.kernedWidth-S.width,L+=S.width):L+=S.kernedWidth,p&&!$&&this._reSpaceAndTab.test(U[ne])&&($=!0),$||(_=_||this.getCompleteStyleDeclaration(x,ne),u=this.getCompleteStyleDeclaration(x,ne+1),$=I.util.hasStyleChanged(_,u,!0)),$&&(D=this._getStyleDeclaration(x,ne)||{},b.push(this._createTextCharSpan(C,D,o,c)),C="",_=u,o+=L,L=0)},_pushTextBgRect:function(b,x,o,c,h,p){var _=I.Object.NUM_FRACTION_DIGITS;b.push("		<rect ",this._getFillAttributes(x),' x="',s(o,_),'" y="',s(c,_),'" width="',s(h,_),'" height="',s(p,_),`"></rect>
`)},_setSVGTextLineBg:function(b,x,o,c){for(var h=this._textLines[x],p=this.getHeightOfLine(x)/this.lineHeight,_=0,u=0,C,S,D=this.getValueOfPropertyAt(x,0,"textBackgroundColor"),L=0,U=h.length;L<U;L++)C=this.__charBounds[x][L],S=this.getValueOfPropertyAt(x,L,"textBackgroundColor"),S!==D?(D&&this._pushTextBgRect(b,D,o+u,c,_,p),u=C.left,_=C.width,D=S):_+=C.kernedWidth;S&&this._pushTextBgRect(b,S,o+u,c,_,p)},_getFillAttributes:function(b){var x=b&&typeof b=="string"?new I.Color(b):"";return!x||!x.getSource()||x.getAlpha()===1?'fill="'+b+'"':'opacity="'+x.getAlpha()+'" fill="'+x.setAlpha(1).toRgb()+'"'},_getSVGLineTopOffset:function(b){for(var x=0,o=0,c=0;c<b;c++)x+=this.getHeightOfLine(c);return o=this.getHeightOfLine(c),{lineTop:x,offset:(this._fontSizeMult-this._fontSizeFraction)*o/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(b){var x=I.Object.prototype.getSvgStyles.call(this,b);return x+" white-space: pre;"}})}(),function(s){var m=s.fabric||(s.fabric={});m.Textbox=m.util.createClass(m.IText,m.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:m.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(b){for(var x=0,o=0,c=0,h={},p=0;p<b.graphemeLines.length;p++)b.graphemeText[c]===`
`&&p>0?(o=0,c++,x++):!this.splitByGrapheme&&this._reSpaceAndTab.test(b.graphemeText[c])&&p>0&&(o++,c++),h[p]={line:x,offset:o},c+=b.graphemeLines[p].length,o+=b.graphemeLines[p].length;return h},styleHas:function(b,x){if(this._styleMap&&!this.isWrapping){var o=this._styleMap[x];o&&(x=o.line)}return m.Text.prototype.styleHas.call(this,b,x)},isEmptyStyles:function(b){if(!this.styles)return!0;var x=0,o=b+1,c,h,p=!1,_=this._styleMap[b],u=this._styleMap[b+1];_&&(b=_.line,x=_.offset),u&&(o=u.line,p=o===b,c=u.offset),h=typeof b>"u"?this.styles:{line:this.styles[b]};for(var C in h)for(var S in h[C])if(S>=x&&(!p||S<c))for(var D in h[C][S])return!1;return!0},_getStyleDeclaration:function(b,x){if(this._styleMap&&!this.isWrapping){var o=this._styleMap[b];if(!o)return null;b=o.line,x=o.offset+x}return this.callSuper("_getStyleDeclaration",b,x)},_setStyleDeclaration:function(b,x,o){var c=this._styleMap[b];b=c.line,x=c.offset+x,this.styles[b][x]=o},_deleteStyleDeclaration:function(b,x){var o=this._styleMap[b];b=o.line,x=o.offset+x,delete this.styles[b][x]},_getLineStyle:function(b){var x=this._styleMap[b];return!!this.styles[x.line]},_setLineStyle:function(b){var x=this._styleMap[b];this.styles[x.line]={}},_wrapText:function(b,x){var o=[],c;for(this.isWrapping=!0,c=0;c<b.length;c++)o=o.concat(this._wrapLine(b[c],c,x));return this.isWrapping=!1,o},_measureWord:function(b,x,o){var c=0,h,p=!0;o=o||0;for(var _=0,u=b.length;_<u;_++){var C=this._getGraphemeBox(b[_],x,_+o,h,p);c+=C.kernedWidth,h=b[_]}return c},_wrapLine:function(b,x,o,Ke){var h=0,p=this.splitByGrapheme,_=[],u=[],C=p?m.util.string.graphemeSplit(b):b.split(this._wordJoiners),S="",D=0,L=p?"":" ",U=0,$=0,ne=0,ye=!0,Ve=this._getWidthOfCharSpacing(),Ke=Ke||0;C.length===0&&C.push([]),o-=Ke;for(var at=0;at<C.length;at++)S=p?C[at]:m.util.string.graphemeSplit(C[at]),U=this._measureWord(S,x,D),D+=S.length,h+=$+U-Ve,h>o&&!ye?(_.push(u),u=[],h=U,ye=!0):h+=Ve,!ye&&!p&&u.push(L),u=u.concat(S),$=p?0:this._measureWord([L],x,D),D++,ye=!1,U>ne&&(ne=U);return at&&_.push(u),ne+Ke>this.dynamicMinWidth&&(this.dynamicMinWidth=ne-Ve+Ke),_},isEndOfWrapping:function(b){return!this._styleMap[b+1]||this._styleMap[b+1].line!==this._styleMap[b].line},missingNewlineOffset:function(b){return this.splitByGrapheme?this.isEndOfWrapping(b)?1:0:1},_splitTextIntoLines:function(b){for(var x=m.Text.prototype._splitTextIntoLines.call(this,b),o=this._wrapText(x.lines,this.width),c=new Array(o.length),h=0;h<o.length;h++)c[h]=o[h].join("");return x.lines=c,x.graphemeLines=o,x},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var b={};for(var x in this._styleMap)this._textLines[x]&&(b[this._styleMap[x].line]=1);for(var x in this.styles)b[x]||delete this.styles[x]},toObject:function(b){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(b))}}),m.Textbox.fromObject=function(b,x){var o=m.util.stylesFromArray(b.styles,b.text),c=Object.assign({},b,{styles:o});return m.Object._fromObject("Textbox",c,x,"text")}}(ie),function(){var s=I.controlsUtils,m=s.scaleSkewCursorStyleHandler,b=s.scaleCursorStyleHandler,x=s.scalingEqually,o=s.scalingYOrSkewingX,c=s.scalingXOrSkewingY,h=s.scaleOrSkewActionName,p=I.Object.prototype.controls;if(p.ml=new I.Control({x:-.5,y:0,cursorStyleHandler:m,actionHandler:c,getActionName:h}),p.mr=new I.Control({x:.5,y:0,cursorStyleHandler:m,actionHandler:c,getActionName:h}),p.mb=new I.Control({x:0,y:.5,cursorStyleHandler:m,actionHandler:o,getActionName:h}),p.mt=new I.Control({x:0,y:-.5,cursorStyleHandler:m,actionHandler:o,getActionName:h}),p.tl=new I.Control({x:-.5,y:-.5,cursorStyleHandler:b,actionHandler:x}),p.tr=new I.Control({x:.5,y:-.5,cursorStyleHandler:b,actionHandler:x}),p.bl=new I.Control({x:-.5,y:.5,cursorStyleHandler:b,actionHandler:x}),p.br=new I.Control({x:.5,y:.5,cursorStyleHandler:b,actionHandler:x}),p.mtr=new I.Control({x:0,y:-.5,actionHandler:s.rotationWithSnapping,cursorStyleHandler:s.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),I.Textbox){var _=I.Textbox.prototype.controls={};_.mtr=p.mtr,_.tr=p.tr,_.br=p.br,_.tl=p.tl,_.bl=p.bl,_.mt=p.mt,_.mb=p.mb,_.mr=new I.Control({x:.5,y:0,actionHandler:s.changeWidth,cursorStyleHandler:m,actionName:"resizing"}),_.ml=new I.Control({x:-.5,y:0,actionHandler:s.changeWidth,cursorStyleHandler:m,actionName:"resizing"})}}()})(rn);function Id(){const ie=Math.round(16777215*Math.random()),I=ie>>16,xe=ie>>8&255,Ae=ie&255;return"rgb("+I+", "+xe+", "+Ae+")"}const Zp=ie=>{if(!ie)return[0,0,0];const I=ie.match(/rgba?\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)?(?:, ?(\d(?:\.\d?))\))?/);return I?[parseInt(I[1]),parseInt(I[2]),parseInt(I[3])]:[0,0,0]},hd=(ie,I)=>{const xe=ie._offset.left,Ae=ie._offset.top,Ne=I.e.pageX-xe,Ze=I.e.pageY-Ae;return{x:Ne,y:Ze}},Kp=ie=>Math.abs(Math.min.apply(Math,ie.map(function(I){return I.y}))),Jp=ie=>Math.abs(Math.min.apply(Math,ie.map(function(I){return I.x}))),Pd=ie=>{let I=new fabric.Point(ie.strokeUniform?1/ie.scaleX:1,ie.strokeUniform?1/ie.scaleY:1).multiply(ie.strokeWidth);return new fabric.Point(ie.width+I.x,ie.height+I.y)};class Qp{generateNumber(I){return I*Math.random()|0}generateX(){return this.generateNumber(16).toString(16)}generateXes(I){let xe="";for(let Ae=0;Ae<I;++Ae)xe+=this.generateX();return xe}generateVariant(){return(this.generateNumber(16)&3|8).toString(16)}generate(){return this.generateXes(8)+"-"+this.generateXes(4)+"-4"+this.generateXes(3)+"-"+this.generateVariant()+this.generateXes(3)+"-"+this.generateXes(12)}}class em extends rn.fabric.Canvas{constructor(xe,Ae){super(xe,Ae);ra(this,"scaleWidth");ra(this,"scaleHeight");ra(this,"contourTemporary");ra(this,"contourNotationTemporary");ra(this,"contourFinalized");this.scaleWidth=1,this.scaleHeight=1,this.contourTemporary=new Array,this.contourNotationTemporary=new Array,this.contourFinalized=new Array}editContour(xe){var Ae,Ne;if(this.setActiveObject(xe),xe.edit=!xe.edit,xe.edit){let Ze=((Ae=xe==null?void 0:xe.points)==null?void 0:Ae.length)-1;xe.cornerStyle="circle",xe.cornerSize=15,xe.cornerColor="rgba(0, 0, 255, 1.0)",xe.controls=(Ne=xe==null?void 0:xe.points)==null?void 0:Ne.reduce(function(V,s,m){return V["p"+m]=new rn.fabric.Control({positionHandler:im,actionHandler:tm(m>0?m-1:Ze,rm),actionName:"modifyPolygon",pointIndex:m}),V},{})}else xe.cornerColor="rgb(178, 204, 255)",xe.cornerStyle="rect",xe.controls=rn.fabric.Object.prototype.controls;xe.hasBorders=!xe.edit,this.requestRenderAll()}}const tm=function(ie,I){return function(xe,Ae,Ne,Ze){let V=Ae.target;const s=new rn.fabric.Point(V.points[ie].x-V.pathOffset.x,V.points[ie].y-V.pathOffset.y);let m=rn.fabric.util.transformPoint(s,V.calcTransformMatrix()),b=I(xe,Ae,Ne,Ze);V._setPositionDimensions({});let x=Pd(V),o=(V.points[ie].x-V.pathOffset.x)/x.x,c=(V.points[ie].y-V.pathOffset.y)/x.y;return V.setPositionByOrigin(m,o+.5,c+.5),b}},im=function(ie,I,xe){let Ae=xe.points[this.pointIndex].x-xe.pathOffset.x,Ne=xe.points[this.pointIndex].y-xe.pathOffset.y;const Ze=new rn.fabric.Point(Ae,Ne);return rn.fabric.util.transformPoint(Ze,rn.fabric.util.multiplyTransformMatrices(xe.canvas.viewportTransform,xe.calcTransformMatrix()))},rm=function(ie,I,xe,Ae){let Ne=I.target,Ze=Ne.controls[Ne.__corner],V=Ne.toLocalPoint(new rn.fabric.Point(xe,Ae),"center","center"),s=Pd(Ne),m=Ne._getTransformedDimensions(0,0),b={x:V.x*s.x/m.x+Ne.pathOffset.x,y:V.y*s.y/m.y+Ne.pathOffset.y};return Ne.points[Ze.pointIndex]=b,!0};class kh extends rn.fabric.Polygon{constructor(xe,Ae){super(xe,Ae);ra(this,"inner");ra(this,"unid");ra(this,"notation");ra(this,"current_points");this.unid="",this.notation=[],this.inner=this,this.current_points=[]}}const Ad=["A","B","C","D"],nm=(ie,I=Id())=>{let xe=Jp(ie),Ae=Kp(ie);const Ne=new rn.fabric.Shadow({color:I,affectStroke:!0,blur:0});let Ze=new kh(ie,{fill:"rgba(0,0,0,0)",stroke:I,strokeWidth:3,objectCaching:!1,shadow:Ne});Ze.set({left:xe,top:Ae});const V=new Array;return ie.forEach((s,m)=>{const b=new rn.fabric.Text(Ad[m],{left:s.x,top:s.y,fontSize:24,fontFamily:"Roboto",fill:I,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9});V.push(b)}),Ze.current_points=Ze.points,Ze.unid="00000000-0000-0000-0000-000000000000",Ze.notation=V,Ze};function Md(ie,I,xe,Ae,Ne="",Ze=Id()){const V=nm(ie,Ze);return V.inner.on("mousedown",sm(I,xe,Ae)),V.inner.on("modified",am(xe,Ae)),V.inner.on("mouseover",function(s){var h;const m=s.target;if(!m){console.error("Empty target contour on modified. Options:",s);return}const b=m.canvas;if(!b){console.error("Empty target canvas on modified. Options:",s);return}m.set("fill","rgba(0, 0, 0, 0.1)");const x=(h=m.shadow)==null?void 0:h.valueOf();if(!(x&&x instanceof rn.fabric.Shadow))return;const c=x;c.blur=30,b.renderAll()}),V.inner.on("mouseout",function(s){var h;const m=s.target;if(!m){console.error("Empty target contour on modified. Options:",s);return}const b=m.canvas;if(!b){console.error("Empty target canvas on modified. Options:",s);return}m.set("fill","rgba(0, 0, 0, 0)");const x=(h=m.shadow)==null?void 0:h.valueOf();if(!(x&&x instanceof rn.fabric.Shadow))return;const c=x;c.blur=0,b.renderAll()}),Ne!==""?V.unid=Ne:V.unid=new Qp().generate(),V.notation.forEach((s,m)=>{V.notation[m].text_id=V.unid}),V}function sm(ie,I,xe){return function(Ae){const Ne=Ae.target;if(!Ne){console.error("Empty target contour on mouse:down. Options:",Ae);return}if(!(Ne instanceof kh)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: mouse:down. Options:",Ae);return}const Ze=Ne,V=Ne.canvas;if(!V){console.error("Empty target canvas on mouse:down. Options:",Ae);return}if(Ae.e.preventDefault(),Ae.e.stopPropagation(),Ae.button===3){if(Sp(ie)!=Ui.EditingZone)ie.set(Ui.EditingZone);else{ie.set(Ui.Waiting);let m=I.get(Ze.unid);if(!m)return;if(!Ze.current_points){console.error("No current points in target polygon. Event: mouse:down. Options:",Ae);return}m.properties.coordinates=Ze.current_points.map(b=>[Math.floor(b.x/V.scaleWidth),Math.floor(b.y/V.scaleHeight)]),xe(Ze.unid,m)}V.editContour(Ze)}}}function am(ie,I){return function(xe){const Ae=xe.target;if(!Ae){console.error("Empty target contour on modified. Options:",xe);return}if(!(Ae instanceof kh)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: modified. Options:",xe);return}const Ne=Ae,Ze=Ae.canvas;if(!Ze){console.error("Empty target canvas on modified. Options:",xe);return}const V=Ne.inner.calcTransformMatrix();if(!Ne.inner.points){console.error("No points in fabric.Polygon. Event: modified. Options:",xe);return}const s=Ne.inner.points.map(function(b){return new rn.fabric.Point(b.x-Ne.inner.pathOffset.x,b.y-Ne.inner.pathOffset.y)}).map(function(b){return rn.fabric.util.transformPoint(b,V)});Ne.current_points=s,Ne.notation.forEach((b,x)=>{var c;const o=(c=Ne.current_points)==null?void 0:c[x];if(!o){console.error(`No vertex at pos #${x} in target polygon`,"Options:",xe);return}b.set({left:o.x,top:o.y})});let m=ie.get(Ne.unid);m&&(m.properties.coordinates=Ne.current_points.map(b=>[Math.floor(b.x/Ze.scaleWidth),Math.floor(b.y/Ze.scaleHeight)]),I(Ne.unid,m))}}const ud=(ie,I,xe,Ae)=>{xe.forEach(Ne=>{const Ze=Ne.properties.coordinates.map(s=>({x:s[0]*ie.scaleWidth,y:s[1]*ie.scaleHeight})),V=Md(Ze,I,xe,Ae,Ne.id,`rgb(${Ne.properties.color_rgb[0]},${Ne.properties.color_rgb[1]},${Ne.properties.color_rgb[2]})`);ie.add(V.inner),V.notation.forEach(s=>{ie.add(s)}),ie.renderAll()})};function om(ie){let I,xe,Ae,Ne,Ze,V,s,m,b,x,o,c,h,p;return{c(){I=Wt("div"),xe=Wt("img"),Ne=Bi(),Ze=Wt("canvas"),V=Bi(),s=Wt("div"),m=Wt("div"),b=Nn("Please wait until image is loaded"),this.h()},l(_){I=Ht(_,"DIV",{id:!0,class:!0});var u=mi(I);xe=Ht(u,"IMG",{id:!0,src:!0,width:!0,height:!0,class:!0}),Ne=ji(u),Ze=Ht(u,"CANVAS",{id:!0,class:!0}),mi(Ze).forEach(ri),V=ji(u),s=Ht(u,"DIV",{id:!0,class:!0});var C=mi(s);m=Ht(C,"DIV",{class:!0});var S=mi(m);b=Vn(S,"Please wait until image is loaded"),S.forEach(ri),C.forEach(ri),u.forEach(ri),this.h()},h(){yt(xe,"id","fit_img"),xh(xe.src,Ae=ie[1]+"/live_streaming")||yt(xe,"src",Ae),yt(xe,"width","500"),yt(xe,"height","500"),yt(xe,"class","svelte-1g9m4by"),yt(Ze,"id","fit_canvas"),yt(Ze,"class","svelte-1g9m4by"),yt(m,"class",x=na(ie[2]?"d-none":"loading d-block")+" svelte-1g9m4by"),yt(s,"id","loading-message"),yt(s,"class",o=na(ie[2]?"d-none":"d-block")+" svelte-1g9m4by"),yt(I,"id","mjpeg"),yt(I,"class",c=na("mjpeg-canvas "+ie[0])+" svelte-1g9m4by")},m(_,u){Vs(_,I,u),mt(I,xe),mt(I,Ne),mt(I,Ze),mt(I,V),mt(I,s),mt(s,m),mt(m,b),h||(p=Kn(xe,"load",ie[5]),h=!0)},p(_,[u]){u&2&&!xh(xe.src,Ae=_[1]+"/live_streaming")&&yt(xe,"src",Ae),u&4&&x!==(x=na(_[2]?"d-none":"loading d-block")+" svelte-1g9m4by")&&yt(m,"class",x),u&4&&o!==(o=na(_[2]?"d-none":"d-block")+" svelte-1g9m4by")&&yt(s,"class",o),u&1&&c!==(c=na("mjpeg-canvas "+_[0])+" svelte-1g9m4by")&&yt(I,"class",c)},i:Us,o:Us,d(_){_&&ri(I),h=!1,p()}}}function lm(ie,I,xe){let Ae,Ne,Ze,V,s;Or(ie,Ih,C=>xe(7,Ae=C)),Or(ie,ko,C=>xe(8,Ne=C)),Or(ie,Ch,C=>xe(10,V=C));let{klass:m=""}=I;const{apiURL:b}=kc;Or(ie,b,C=>xe(9,Ze=C));let x=`${Ze}`,o;qr.subscribe(C=>o=C);let c=Un(!1);Or(ie,c,C=>xe(2,s=C));const h=()=>{if(console.log("Image source reloaded"),V===void 0||V==null){console.log("Prepare canvas on first initialization");const C=u();Ch.set(C)}c.set(!0),Zl.set(!0)},p=Mh.subscribe(C=>{x!==C&&(console.log(`Need to change API URL for MJPEG: '${Ze}'`),xe(1,x=C),c.set(!1))});Jl(()=>{}),Sh(()=>{p()});const _=(C,S)=>{C.getObjects().forEach(D=>{if(D.unid===S){C.remove(D);return}}),C.getObjects().forEach(D=>{if(D.text_id===S){C.remove(D);return}}),Gp(Ne,Ae,S),Vp(S)},u=()=>{const C=document.getElementById("fit_canvas"),S=document.getElementById("fit_img");C.width=S.clientWidth,C.height=S.clientHeight;const D=new em("fit_canvas",{containerClass:"custom-container-canvas",fireRightClick:!0,fireMiddleClick:!0,stopContextMenu:!0});D.scaleWidth=S.clientWidth/S.naturalWidth,D.scaleHeight=S.clientHeight/S.naturalHeight;const L=document.getElementsByClassName("custom-container-canvas")[0];return L.id="fbcanvas",D.on("selection:created",U=>{o===Ui.DeletingZoneCanvas&&(_(D,U.selected[0].unid),qr.set(Ui.Waiting))}),D.on("selection:updated",U=>{o===Ui.DeletingZoneCanvas&&(_(D,U.selected[0].unid),qr.set(Ui.Waiting))}),D.on("mouse:move",U=>{if(D.contourTemporary[0]!==null&&D.contourTemporary[0]!==void 0&&o===Ui.AddingZoneCanvas){const $=hd(D,U);D.contourTemporary[D.contourTemporary.length-1].set({x2:$.x,y2:$.y}),D.renderAll()}}),D.on("mouse:down",U=>{if(o!==Ui.AddingZoneCanvas)return;D.selection=!1;const $=hd(D,U);D.contourFinalized.push({x:$.x,y:$.y});const ne=[$.x,$.y,$.x,$.y],ye=new rn.fabric.Line(ne,{strokeWidth:3,selectable:!1,stroke:"purple"}),Ve=new rn.fabric.Text(Ad[D.contourFinalized.length-1],{left:$.x,top:$.y,fontSize:24,fontFamily:"Roboto",fill:"purple",shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9});if(D.contourNotationTemporary.push(Ve),D.contourTemporary.push(ye),D.add(ye),D.add(Ve),D.on("mouse:up",function($e){D.selection=!0}),D.contourFinalized.length<=3)return;D.contourTemporary.forEach($e=>{D.remove($e)}),D.contourNotationTemporary.forEach($e=>{D.remove($e)});const Ke=Md(D.contourFinalized,qr,Ne,Io),at={type:"Feature",id:Ke.unid,properties:{color_rgb:Zp(Ke.inner.stroke),color_rgb_str:Ke.inner.stroke?Ke.inner.stroke:"rgb(0, 0, 0)",coordinates:Ke.inner.current_points.map($e=>[Math.floor($e.x/D.scaleWidth),Math.floor($e.y/D.scaleHeight)]),road_lane_direction:-1,road_lane_num:-1,spatial_object_id:void 0},geometry:{type:"Polygon",coordinates:[[[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1]]]}};Io(Ke.unid,at),D.add(Ke.inner),Ke.notation.forEach($e=>{D.add($e)}),D.renderAll(),D.contourTemporary=[],D.contourNotationTemporary=[],D.contourFinalized=[],qr.set(Ui.Waiting),Ae.changeMode("simple_select")}),D};return ie.$$set=C=>{"klass"in C&&xe(0,m=C.klass)},[m,x,s,b,c,h]}class cm extends Ao{constructor(I){super(),Mo(this,I,lm,om,Po,{klass:0})}}function hm(ie){let I,xe,Ae,Ne,Ze,V,s,m,b="Protocol schema type",x,o,c,h,p,_,u="Address or explicit IP",C,S,D,L,U,$,ne="Port",ye,Ve,Ke="Switch",at,$e;return{c(){I=Wt("div"),xe=Wt("form"),Ae=Wt("div"),Ne=Wt("div"),Ze=Wt("div"),V=Wt("input"),s=Bi(),m=Wt("label"),m.textContent=b,x=Bi(),o=Wt("div"),c=Wt("div"),h=Wt("input"),p=Bi(),_=Wt("label"),_.textContent=u,C=Bi(),S=Wt("div"),D=Wt("div"),L=Wt("input"),U=Bi(),$=Wt("label"),$.textContent=ne,ye=Bi(),Ve=Wt("button"),Ve.textContent=Ke,this.h()},l(ut){I=Ht(ut,"DIV",{class:!0});var ot=mi(I);xe=Ht(ot,"FORM",{autocomplete:!0});var vt=mi(xe);Ae=Ht(vt,"DIV",{class:!0});var St=mi(Ae);Ne=Ht(St,"DIV",{class:!0});var ct=mi(Ne);Ze=Ht(ct,"DIV",{class:!0});var Et=mi(Ze);V=Ht(Et,"INPUT",{id:!0,type:!0,class:!0}),s=ji(Et),m=Ht(Et,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),tn(m)!=="svelte-4i6s19"&&(m.textContent=b),Et.forEach(ri),ct.forEach(ri),x=ji(St),o=Ht(St,"DIV",{class:!0});var Q=mi(o);c=Ht(Q,"DIV",{class:!0});var de=mi(c);h=Ht(de,"INPUT",{id:!0,type:!0,class:!0}),p=ji(de),_=Ht(de,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),tn(_)!=="svelte-1tjbdse"&&(_.textContent=u),de.forEach(ri),Q.forEach(ri),C=ji(St),S=Ht(St,"DIV",{class:!0});var _e=mi(S);D=Ht(_e,"DIV",{class:!0});var pe=mi(D);L=Ht(pe,"INPUT",{id:!0,type:!0,class:!0}),U=ji(pe),$=Ht(pe,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),tn($)!=="svelte-1gcg7vj"&&($.textContent=ne),pe.forEach(ri),_e.forEach(ri),St.forEach(ri),vt.forEach(ri),ye=ji(ot),Ve=Ht(ot,"BUTTON",{class:!0,type:!0,name:!0,"data-svelte-h":!0}),tn(Ve)!=="svelte-14v6gij"&&(Ve.textContent=Ke),ot.forEach(ri),this.h()},h(){yt(V,"id","input_protocol"),yt(V,"type","text"),yt(V,"class","validate"),yt(m,"class","active"),yt(m,"for","input_protocol"),yt(Ze,"class","input-field"),yt(Ne,"class","addr-part row svelte-1mo9bfd"),yt(h,"id","input_protocol"),yt(h,"type","text"),yt(h,"class","validate"),yt(_,"class","active"),yt(_,"for","input_protocol"),yt(c,"class","input-field"),yt(o,"class","addr-part row svelte-1mo9bfd"),yt(L,"id","input_protocol"),yt(L,"type","number"),yt(L,"class","validate"),yt($,"class","active"),yt($,"for","input_protocol"),yt(D,"class","input-field"),yt(S,"class","addr-part row svelte-1mo9bfd"),yt(Ae,"class","addr-form svelte-1mo9bfd"),yt(xe,"autocomplete","off"),yt(Ve,"class","btn waves-effect waves-light btn-small red"),yt(Ve,"type","submit"),yt(Ve,"name","action"),yt(I,"class","addr-container svelte-1mo9bfd")},m(ut,ot){Vs(ut,I,ot),mt(I,xe),mt(xe,Ae),mt(Ae,Ne),mt(Ne,Ze),mt(Ze,V),Ja(V,ie[0]),mt(Ze,s),mt(Ze,m),mt(Ae,x),mt(Ae,o),mt(o,c),mt(c,h),Ja(h,ie[1]),mt(c,p),mt(c,_),mt(Ae,C),mt(Ae,S),mt(S,D),mt(D,L),Ja(L,ie[2]),mt(D,U),mt(D,$),mt(I,ye),mt(I,Ve),at||($e=[Kn(V,"input",ie[8]),Kn(h,"input",ie[9]),Kn(L,"input",ie[10]),Kn(Ve,"click",ie[7])],at=!0)},p(ut,[ot]){ot&1&&V.value!==ut[0]&&Ja(V,ut[0]),ot&2&&h.value!==ut[1]&&Ja(h,ut[1]),ot&4&&_d(L.value)!==ut[2]&&Ja(L,ut[2])},i:Us,o:Us,d(ut){ut&&ri(I),at=!1,Th($e)}}}function um(ie,I,xe){let Ae,Ne,Ze,V;const{schema:s,host:m,port:b}=kc;Or(ie,s,u=>xe(0,Ne=u)),Or(ie,m,u=>xe(1,Ze=u)),Or(ie,b,u=>xe(2,V=u));const{apiURL:x}=kc;Or(ie,x,u=>xe(12,Ae=u));let o=Ae;const c=()=>{o!==Ae&&(Mh.set(Ae),o=Ae)};Jl(()=>{console.log(`Initial address: '${Ae}'`)});function h(){Ne=this.value,s.set(Ne)}function p(){Ze=this.value,m.set(Ze)}function _(){V=_d(this.value),b.set(V)}return[Ne,Ze,V,s,m,b,x,c,h,p,_]}class dm extends Ao{constructor(I){super(),Mo(this,I,um,hm,Po,{})}}function fm(ie){let I,xe,Ae,Ne,Ze,V,s,m,b="URI for Maptiler styles JSON",x,o,c="Switch",h,p;return{c(){I=Wt("div"),xe=Wt("form"),Ae=Wt("div"),Ne=Wt("div"),Ze=Wt("div"),V=Wt("input"),s=Bi(),m=Wt("label"),m.textContent=b,x=Bi(),o=Wt("button"),o.textContent=c,this.h()},l(_){I=Ht(_,"DIV",{class:!0});var u=mi(I);xe=Ht(u,"FORM",{autocomplete:!0});var C=mi(xe);Ae=Ht(C,"DIV",{class:!0});var S=mi(Ae);Ne=Ht(S,"DIV",{class:!0});var D=mi(Ne);Ze=Ht(D,"DIV",{class:!0});var L=mi(Ze);V=Ht(L,"INPUT",{id:!0,type:!0,class:!0}),s=ji(L),m=Ht(L,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),tn(m)!=="svelte-1xx2eh2"&&(m.textContent=b),L.forEach(ri),D.forEach(ri),S.forEach(ri),C.forEach(ri),x=ji(u),o=Ht(u,"BUTTON",{class:!0,type:!0,name:!0,"data-svelte-h":!0}),tn(o)!=="svelte-1zwpv7"&&(o.textContent=c),u.forEach(ri),this.h()},h(){yt(V,"id","input_protocol"),yt(V,"type","text"),yt(V,"class","validate"),yt(m,"class","active"),yt(m,"for","input_style_url"),yt(Ze,"class","input-field"),yt(Ne,"class","styles-switch-part row svelte-qox066"),yt(Ae,"class","styles-switch-form svelte-qox066"),yt(xe,"autocomplete","off"),yt(o,"class","btn waves-effect waves-light btn-small red"),yt(o,"type","submit"),yt(o,"name","action"),yt(I,"class","styles-switch-container svelte-qox066")},m(_,u){Vs(_,I,u),mt(I,xe),mt(xe,Ae),mt(Ae,Ne),mt(Ne,Ze),mt(Ze,V),Ja(V,ie[0]),mt(Ze,s),mt(Ze,m),mt(I,x),mt(I,o),h||(p=[Kn(V,"input",ie[3]),Kn(o,"click",ie[2])],h=!0)},p(_,[u]){u&1&&V.value!==_[0]&&Ja(V,_[0])},i:Us,o:Us,d(_){_&&ri(I),h=!1,Th(p)}}}function pm(ie,I,xe){let Ae;const{uri:Ne}=Dc;Or(ie,Ne,m=>xe(0,Ae=m));let Ze=Ae;const V=()=>{Ze!==Ae&&(Ze=Ae,Dc.accepted_uri.update(()=>Ze))};Jl(()=>{console.log(`Initial styles URL: '${Ae}'`)});function s(){Ae=this.value,Ne.set(Ae)}return[Ae,Ne,V,s]}class mm extends Ao{constructor(I){super(),Mo(this,I,pm,fm,Po,{})}}function gm(ie){let I,xe,Ae,Ne,Ze,V;return xe=new dm({}),Ne=new mm({}),{c(){I=Wt("div"),ol(xe.$$.fragment),Ae=Bi(),ol(Ne.$$.fragment),this.h()},l(s){I=Ht(s,"DIV",{class:!0});var m=mi(I);ll(xe.$$.fragment,m),Ae=ji(m),ll(Ne.$$.fragment,m),m.forEach(ri),this.h()},h(){yt(I,"class",Ze=na("switcher-container "+ie[0])+" svelte-19pygco")},m(s,m){Vs(s,I,m),cl(xe,I,null),mt(I,Ae),cl(Ne,I,null),V=!0},p(s,[m]){(!V||m&1&&Ze!==(Ze=na("switcher-container "+s[0])+" svelte-19pygco"))&&yt(I,"class",Ze)},i(s){V||(hl(xe.$$.fragment,s),hl(Ne.$$.fragment,s),V=!0)},o(s){ul(xe.$$.fragment,s),ul(Ne.$$.fragment,s),V=!1},d(s){s&&ri(I),dl(xe),dl(Ne)}}}function _m(ie,I,xe){let{klass:Ae=""}=I;return ie.$$set=Ne=>{"klass"in Ne&&xe(0,Ae=Ne.klass)},[Ae]}class ym extends Ao{constructor(I){super(),Mo(this,I,_m,gm,Po,{klass:0})}}function dd(ie,I,xe){const Ae=ie.slice();return Ae[4]=I[xe][0],Ae[5]=I[xe][1],Ae}function fd(ie){let I,xe=ld(ie[2]),Ae=[];for(let Ne=0;Ne<xe.length;Ne+=1)Ae[Ne]=pd(dd(ie,xe,Ne));return{c(){for(let Ne=0;Ne<Ae.length;Ne+=1)Ae[Ne].c();I=od()},l(Ne){for(let Ze=0;Ze<Ae.length;Ze+=1)Ae[Ze].l(Ne);I=od()},m(Ne,Ze){for(let V=0;V<Ae.length;V+=1)Ae[V]&&Ae[V].m(Ne,Ze);Vs(Ne,I,Ze)},p(Ne,Ze){if(Ze&4){xe=ld(Ne[2]);let V;for(V=0;V<xe.length;V+=1){const s=dd(Ne,xe,V);Ae[V]?Ae[V].p(s,Ze):(Ae[V]=pd(s),Ae[V].c(),Ae[V].m(I.parentNode,I))}for(;V<Ae.length;V+=1)Ae[V].d(1);Ae.length=xe.length}},d(Ne){Ne&&ri(I),Ep(Ae,Ne)}}}function pd(ie){let I,xe,Ae,Ne,Ze,V=ie[5].id+"",s,m,b,x,o,c="<tr><th>Attirubute</th> <th>Value</th></tr>",h,p,_,u,C="Road lane direction",S,D,L=ie[5].properties.road_lane_direction+"",U,$,ne,ye,Ve="Road lane number",Ke,at,$e=ie[5].properties.road_lane_num+"",ut,ot,vt,St,ct="Color",Et,Q,de,_e,pe,Re,fe="Canvas coordinates",ee,Ce,Le=JSON.stringify(ie[5].properties.coordinates)+"",Je,Ue,Ge,dt,At="Spatial coordinates",Ye,Oe,Qe=JSON.stringify(ie[5].geometry.coordinates)+"",Xe,le;return{c(){I=Wt("li"),xe=Wt("div"),Ae=Wt("i"),Ne=Nn("place"),Ze=Nn("Polygon identifier: "),s=Nn(V),m=Bi(),b=Wt("div"),x=Wt("table"),o=Wt("thead"),o.innerHTML=c,h=Bi(),p=Wt("tbody"),_=Wt("tr"),u=Wt("td"),u.textContent=C,S=Bi(),D=Wt("td"),U=Nn(L),$=Bi(),ne=Wt("tr"),ye=Wt("td"),ye.textContent=Ve,Ke=Bi(),at=Wt("td"),ut=Nn($e),ot=Bi(),vt=Wt("tr"),St=Wt("td"),St.textContent=ct,Et=Bi(),Q=Wt("td"),de=Wt("div"),_e=Bi(),pe=Wt("tr"),Re=Wt("td"),Re.textContent=fe,ee=Bi(),Ce=Wt("td"),Je=Nn(Le),Ue=Bi(),Ge=Wt("tr"),dt=Wt("td"),dt.textContent=At,Ye=Bi(),Oe=Wt("td"),Xe=Nn(Qe),le=Bi(),this.h()},l(it){I=Ht(it,"LI",{class:!0});var bt=mi(I);xe=Ht(bt,"DIV",{class:!0});var Pt=mi(xe);Ae=Ht(Pt,"I",{class:!0,style:!0});var Ot=mi(Ae);Ne=Vn(Ot,"place"),Ot.forEach(ri),Ze=Vn(Pt,"Polygon identifier: "),s=Vn(Pt,V),Pt.forEach(ri),m=ji(bt),b=Ht(bt,"DIV",{class:!0});var nt=mi(b);x=Ht(nt,"TABLE",{class:!0});var qt=mi(x);o=Ht(qt,"THEAD",{"data-svelte-h":!0}),tn(o)!=="svelte-12gwnin"&&(o.innerHTML=c),h=ji(qt),p=Ht(qt,"TBODY",{});var Yt=mi(p);_=Ht(Yt,"TR",{});var gi=mi(_);u=Ht(gi,"TD",{"data-svelte-h":!0}),tn(u)!=="svelte-t6zzid"&&(u.textContent=C),S=ji(gi),D=Ht(gi,"TD",{});var xi=mi(D);U=Vn(xi,L),xi.forEach(ri),gi.forEach(ri),$=ji(Yt),ne=Ht(Yt,"TR",{});var fi=mi(ne);ye=Ht(fi,"TD",{"data-svelte-h":!0}),tn(ye)!=="svelte-5n5jo3"&&(ye.textContent=Ve),Ke=ji(fi),at=Ht(fi,"TD",{});var Gi=mi(at);ut=Vn(Gi,$e),Gi.forEach(ri),fi.forEach(ri),ot=ji(Yt),vt=Ht(Yt,"TR",{});var ht=mi(vt);St=Ht(ht,"TD",{"data-svelte-h":!0}),tn(St)!=="svelte-1ghfwjz"&&(St.textContent=ct),Et=ji(ht),Q=Ht(ht,"TD",{});var Hi=mi(Q);de=Ht(Hi,"DIV",{style:!0}),mi(de).forEach(ri),Hi.forEach(ri),ht.forEach(ri),_e=ji(Yt),pe=Ht(Yt,"TR",{});var Zt=mi(pe);Re=Ht(Zt,"TD",{"data-svelte-h":!0}),tn(Re)!=="svelte-n6p0xp"&&(Re.textContent=fe),ee=ji(Zt),Ce=Ht(Zt,"TD",{});var bi=mi(Ce);Je=Vn(bi,Le),bi.forEach(ri),Zt.forEach(ri),Ue=ji(Yt),Ge=Ht(Yt,"TR",{});var cr=mi(Ge);dt=Ht(cr,"TD",{"data-svelte-h":!0}),tn(dt)!=="svelte-1ypus8v"&&(dt.textContent=At),Ye=ji(cr),Oe=Ht(cr,"TD",{});var xt=mi(Oe);Xe=Vn(xt,Qe),xt.forEach(ri),cr.forEach(ri),Yt.forEach(ri),qt.forEach(ri),nt.forEach(ri),le=ji(bt),bt.forEach(ri),this.h()},h(){yt(Ae,"class","material-icons"),To(Ae,"color",ie[5].properties.color_rgb_str),yt(xe,"class","collapsible-header svelte-qpd866"),To(de,"background-color",ie[5].properties.color_rgb_str),To(de,"width","32px"),To(de,"height","16px"),To(de,"border","1px solid #000000"),yt(x,"class","collapsible-table svelte-qpd866"),yt(b,"class","collapsible-body svelte-qpd866"),yt(I,"class","svelte-qpd866")},m(it,bt){Vs(it,I,bt),mt(I,xe),mt(xe,Ae),mt(Ae,Ne),mt(xe,Ze),mt(xe,s),mt(I,m),mt(I,b),mt(b,x),mt(x,o),mt(x,h),mt(x,p),mt(p,_),mt(_,u),mt(_,S),mt(_,D),mt(D,U),mt(p,$),mt(p,ne),mt(ne,ye),mt(ne,Ke),mt(ne,at),mt(at,ut),mt(p,ot),mt(p,vt),mt(vt,St),mt(vt,Et),mt(vt,Q),mt(Q,de),mt(p,_e),mt(p,pe),mt(pe,Re),mt(pe,ee),mt(pe,Ce),mt(Ce,Je),mt(p,Ue),mt(p,Ge),mt(Ge,dt),mt(Ge,Ye),mt(Ge,Oe),mt(Oe,Xe),mt(I,le)},p(it,bt){bt&4&&To(Ae,"color",it[5].properties.color_rgb_str),bt&4&&V!==(V=it[5].id+"")&&Eo(s,V),bt&4&&L!==(L=it[5].properties.road_lane_direction+"")&&Eo(U,L),bt&4&&$e!==($e=it[5].properties.road_lane_num+"")&&Eo(ut,$e),bt&4&&To(de,"background-color",it[5].properties.color_rgb_str),bt&4&&Le!==(Le=JSON.stringify(it[5].properties.coordinates)+"")&&Eo(Je,Le),bt&4&&Qe!==(Qe=JSON.stringify(it[5].geometry.coordinates)+"")&&Eo(Xe,Qe)},d(it){it&&ri(I)}}}function vm(ie){let I,xe,Ae,Ne,Ze=ie[3]===!0&&fd(ie);return{c(){I=Wt("div"),xe=Wt("div"),Ae=Wt("ul"),Ze&&Ze.c(),this.h()},l(V){I=Ht(V,"DIV",{id:!0,class:!0});var s=mi(I);xe=Ht(s,"DIV",{id:!0});var m=mi(xe);Ae=Ht(m,"UL",{id:!0,class:!0});var b=mi(Ae);Ze&&Ze.l(b),b.forEach(ri),m.forEach(ri),s.forEach(ri),this.h()},h(){yt(Ae,"id","collapsible-data"),yt(Ae,"class","collapsible svelte-qpd866"),yt(xe,"id","configuration-content"),yt(I,"id","configuration"),yt(I,"class",Ne=na(ie[0])+" svelte-qpd866")},m(V,s){Vs(V,I,s),mt(I,xe),mt(xe,Ae),Ze&&Ze.m(Ae,null)},p(V,[s]){V[3]===!0?Ze?Ze.p(V,s):(Ze=fd(V),Ze.c(),Ze.m(Ae,null)):Ze&&(Ze.d(1),Ze=null),s&1&&Ne!==(Ne=na(V[0])+" svelte-qpd866")&&yt(I,"class",Ne)},i:Us,o:Us,d(V){V&&ri(I),Ze&&Ze.d()}}}function xm(ie,I,xe){let Ae,Ne=Us,Ze=()=>(Ne(),Ne=Tp(s,b=>xe(3,Ae=b)),s);ie.$$.on_destroy.push(()=>Ne());let{klass:V=""}=I,{dataReady:s}=I;Ze();let{data:m}=I;return ie.$$set=b=>{"klass"in b&&xe(0,V=b.klass),"dataReady"in b&&Ze(xe(1,s=b.dataReady)),"data"in b&&xe(2,m=b.data)},[V,s,m,Ae]}class bm extends Ao{constructor(I){super(),Mo(this,I,xm,vm,Po,{klass:0,dataReady:1,data:2})}}const wm=(ie,I)=>{const xe={data:I.map(Ne=>{const Ze=Ne[1];return{lane_number:Ze.properties.road_lane_num,lane_direction:Ze.properties.road_lane_direction,color_rgb:Ze.properties.color_rgb,pixel_points:Ze.properties.coordinates,spatial_points:[...Ze.geometry.coordinates[0].slice(0,-1)]}})};console.log("Replacing data");const Ae=`${ie}/api/mutations/replace_all`;fetch(`${Ae}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(xe)}).then(Ne=>Ne.json()).then(Ne=>{const Ze=`${ie}/api/mutations/save_toml`;console.log("Replacing configuration with polygons:",Ne),fetch(`${Ze}`,{method:"GET"}).then(V=>V.json()).then(V=>{console.log("Configuration has been updated. Reply from server:",V)}).catch(V=>{console.log("Error on updating configuration:",V)})}).catch(Ne=>{console.log("Error on replacing data",Ne)})};function Cm(ie){let I,xe,Ae,Ne,Ze,V,s="",m,b,x,o,c,h,p,_,u='<i class="material-icons">edit</i>',C,S,D,L,U='<i class="material-icons">add</i>',$,ne,ye,Ve='<i class="material-icons">delete</i>',Ke,at,$e,ut='<i class="material-icons">add_location</i>',ot,vt,St,ct='<i class="material-icons">location_off</i>',Et,Q,de,_e='<i class="material-icons">save</i>',pe,Re,fe,ee,Ce,Le,Je,Ue,Ge,dt,At,Ye=(ie[2]!==void 0?ie[2]:Ac)+"",Oe,Qe,Xe,le,it,bt,Pt,Ot,nt,qt=(ie[2]!==void 0?ie[2]:Ac)+"",Yt,gi,xi,fi,Gi,ht;Re=new ym({props:{klass:ie[5]||ie[4]?"blurred noselect":""}}),Le=new cm({props:{klass:!ie[5]&&ie[4]?"blurred noselect":""}}),Ue=new bm({props:{dataReady:al,data:ie[3],klass:!ie[6]||ie[5]||ie[4]?"blurred noselect":""}});let Hi={klass:!ie[6]||ie[5]&&!ie[4]?"blurred noselect":""};return bt=new qp({props:Hi}),ie[17](bt),{c(){I=Wt("sveltekit:head"),xe=Wt("link"),Ae=Bi(),Ne=Wt("link"),Ze=Bi(),V=Wt("script"),V.innerHTML=s,b=Bi(),x=Wt("title"),o=Nn(md),c=Bi(),h=Wt("div"),p=Wt("div"),_=Wt("a"),_.innerHTML=u,C=Bi(),S=Wt("ul"),D=Wt("li"),L=Wt("a"),L.innerHTML=U,$=Bi(),ne=Wt("li"),ye=Wt("a"),ye.innerHTML=Ve,Ke=Bi(),at=Wt("li"),$e=Wt("a"),$e.innerHTML=ut,ot=Bi(),vt=Wt("li"),St=Wt("a"),St.innerHTML=ct,Et=Bi(),Q=Wt("li"),de=Wt("a"),de.innerHTML=_e,pe=Bi(),ol(Re.$$.fragment),fe=Bi(),ee=Wt("div"),Ce=Wt("div"),ol(Le.$$.fragment),Je=Bi(),ol(Ue.$$.fragment),Ge=Bi(),dt=Wt("div"),At=Nn("Press ESC to cancel '"),Oe=Nn(Ye),Qe=Nn("' mode"),le=Bi(),it=Wt("div"),ol(bt.$$.fragment),Pt=Bi(),Ot=Wt("div"),nt=Nn("Press ESC to cancel '"),Yt=Nn(qt),gi=Nn("' mode"),this.h()},l(Zt){I=Ht(Zt,"SVELTEKIT:HEAD",{});var bi=mi(I);xe=Ht(bi,"LINK",{rel:!0,href:!0}),Ae=ji(bi),Ne=Ht(bi,"LINK",{href:!0,rel:!0}),Ze=ji(bi),V=Ht(bi,"SCRIPT",{src:!0,"data-svelte-h":!0}),tn(V)!=="svelte-144jung"&&(V.innerHTML=s),b=ji(bi),x=Ht(bi,"TITLE",{});var cr=mi(x);o=Vn(cr,md),cr.forEach(ri),bi.forEach(ri),c=ji(Zt),h=Ht(Zt,"DIV",{id:!0});var xt=mi(h);p=Ht(xt,"DIV",{class:!0});var li=mi(p);_=Ht(li,"A",{class:!0,"data-svelte-h":!0}),tn(_)!=="svelte-1f8sujf"&&(_.innerHTML=u),C=ji(li),S=Ht(li,"UL",{});var Kt=mi(S);D=Ht(Kt,"LI",{});var Tr=mi(D);L=Ht(Tr,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),tn(L)!=="svelte-1iozari"&&(L.innerHTML=U),Tr.forEach(ri),$=ji(Kt),ne=Ht(Kt,"LI",{});var Lr=mi(ne);ye=Ht(Lr,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),tn(ye)!=="svelte-1wbicqg"&&(ye.innerHTML=Ve),Lr.forEach(ri),Ke=ji(Kt),at=Ht(Kt,"LI",{});var ui=mi(at);$e=Ht(ui,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),tn($e)!=="svelte-1t3kq67"&&($e.innerHTML=ut),ui.forEach(ri),ot=ji(Kt),vt=Ht(Kt,"LI",{});var wn=mi(vt);St=Ht(wn,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),tn(St)!=="svelte-1in2wxm"&&(St.innerHTML=ct),wn.forEach(ri),Et=ji(Kt),Q=Ht(Kt,"LI",{});var $r=mi(Q);de=Ht($r,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),tn(de)!=="svelte-93o42s"&&(de.innerHTML=_e),$r.forEach(ri),Kt.forEach(ri),li.forEach(ri),pe=ji(xt),ll(Re.$$.fragment,xt),fe=ji(xt),ee=Ht(xt,"DIV",{id:!0});var se=mi(ee);Ce=Ht(se,"DIV",{id:!0});var W=mi(Ce);ll(Le.$$.fragment,W),Je=ji(W),ll(Ue.$$.fragment,W),Ge=ji(W),dt=Ht(W,"DIV",{class:!0,style:!0});var X=mi(dt);At=Vn(X,"Press ESC to cancel '"),Oe=Vn(X,Ye),Qe=Vn(X,"' mode"),X.forEach(ri),W.forEach(ri),le=ji(se),it=Ht(se,"DIV",{id:!0});var J=mi(it);ll(bt.$$.fragment,J),Pt=ji(J),Ot=Ht(J,"DIV",{class:!0,style:!0});var ae=mi(Ot);nt=Vn(ae,"Press ESC to cancel '"),Yt=Vn(ae,qt),gi=Vn(ae,"' mode"),ae.forEach(ri),J.forEach(ri),se.forEach(ri),xt.forEach(ri),this.h()},h(){yt(xe,"rel","stylesheet"),yt(xe,"href","https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"),yt(Ne,"href","https://fonts.googleapis.com/icon?family=Material+Icons"),yt(Ne,"rel","stylesheet"),xh(V.src,m="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js")||yt(V,"src",m),yt(_,"class","btn-floating btn-large red"),yt(L,"id","add-btn"),yt(L,"class","btn-floating green"),yt(L,"title","Add zone to the canvas"),yt(L,"aria-label","Add zone to the canvas"),yt(L,"role","button"),yt(L,"tabindex","0"),yt(ye,"id","del-btn"),yt(ye,"class","btn-floating blue"),yt(ye,"title","Delete zone from the canvas"),yt(ye,"aria-label","Delete zone from the canvas"),yt(ye,"role","button"),yt(ye,"tabindex","0"),yt($e,"id","add-btn"),yt($e,"class","btn-floating orange"),yt($e,"title","Add zone to the map"),yt($e,"aria-label","Add zone to the map"),yt($e,"role","button"),yt($e,"tabindex","0"),yt(St,"id","del-btn"),yt(St,"class","btn-floating blue"),yt(St,"title","Delete zone from the map"),yt(St,"aria-label","Delete zone from the map"),yt(St,"role","button"),yt(St,"tabindex","0"),yt(de,"id","save-btn"),yt(de,"class","btn-floating grey"),yt(de,"title","Apply and save changes"),yt(de,"aria-label","Apply and save changes"),yt(de,"role","button"),yt(de,"tabindex","0"),yt(p,"class","fixed-action-btn horizontal click-to-toggle spin-close"),yt(dt,"class","overlay"),yt(dt,"style",Xe=!ie[5]&&ie[4]?"display: block;":"display: none;"),yt(Ce,"id","left_workspace"),yt(Ot,"class","overlay"),yt(Ot,"style",xi=ie[5]&&!ie[4]?"display: block;":"display: none;"),yt(it,"id","right_workspace"),yt(ee,"id","main_workspace"),yt(h,"id","main-app")},m(Zt,bi){Vs(Zt,I,bi),mt(I,xe),mt(I,Ae),mt(I,Ne),mt(I,Ze),mt(I,V),mt(I,b),mt(I,x),mt(x,o),Vs(Zt,c,bi),Vs(Zt,h,bi),mt(h,p),mt(p,_),mt(p,C),mt(p,S),mt(S,D),mt(D,L),mt(S,$),mt(S,ne),mt(ne,ye),mt(S,Ke),mt(S,at),mt(at,$e),mt(S,ot),mt(S,vt),mt(vt,St),mt(S,Et),mt(S,Q),mt(Q,de),mt(h,pe),cl(Re,h,null),mt(h,fe),mt(h,ee),mt(ee,Ce),cl(Le,Ce,null),mt(Ce,Je),cl(Ue,Ce,null),mt(Ce,Ge),mt(Ce,dt),mt(dt,At),mt(dt,Oe),mt(dt,Qe),mt(ee,le),mt(ee,it),cl(bt,it,null),mt(it,Pt),mt(it,Ot),mt(Ot,nt),mt(Ot,Yt),mt(Ot,gi),fi=!0,Gi||(ht=[Kn(window,"keydown",ie[8]),Kn(V,"load",ie[9]),Kn(L,"click",ie[10]),Kn(ye,"click",ie[12]),Kn($e,"click",ie[11]),Kn(St,"click",ie[13]),Kn(de,"click",ie[16])],Gi=!0)},p(Zt,[bi]){const cr={};bi&48&&(cr.klass=Zt[5]||Zt[4]?"blurred noselect":""),Re.$set(cr);const xt={};bi&48&&(xt.klass=!Zt[5]&&Zt[4]?"blurred noselect":""),Le.$set(xt);const li={};bi&8&&(li.data=Zt[3]),bi&112&&(li.klass=!Zt[6]||Zt[5]||Zt[4]?"blurred noselect":""),Ue.$set(li),(!fi||bi&4)&&Ye!==(Ye=(Zt[2]!==void 0?Zt[2]:Ac)+"")&&Eo(Oe,Ye),(!fi||bi&48&&Xe!==(Xe=!Zt[5]&&Zt[4]?"display: block;":"display: none;"))&&yt(dt,"style",Xe);const Kt={};bi&112&&(Kt.klass=!Zt[6]||Zt[5]&&!Zt[4]?"blurred noselect":""),bt.$set(Kt),(!fi||bi&4)&&qt!==(qt=(Zt[2]!==void 0?Zt[2]:Ac)+"")&&Eo(Yt,qt),(!fi||bi&48&&xi!==(xi=Zt[5]&&!Zt[4]?"display: block;":"display: none;"))&&yt(Ot,"style",xi)},i(Zt){fi||(hl(Re.$$.fragment,Zt),hl(Le.$$.fragment,Zt),hl(Ue.$$.fragment,Zt),hl(bt.$$.fragment,Zt),fi=!0)},o(Zt){ul(Re.$$.fragment,Zt),ul(Le.$$.fragment,Zt),ul(Ue.$$.fragment,Zt),ul(bt.$$.fragment,Zt),fi=!1},d(Zt){Zt&&(ri(I),ri(c),ri(h)),dl(Re),dl(Le),dl(Ue),ie[17](null),dl(bt),Gi=!1,Th(ht)}}}const md="Rust Road Traffic UI",Ac="Unexpected action";function Sm(ie,I,xe){let Ae,Ne,Ze,V,s,m,b,x,o,c,h,p;Or(ie,Ih,ct=>xe(22,s=ct)),Or(ie,Ch,ct=>xe(23,m=ct)),Or(ie,ko,ct=>xe(14,b=ct)),Or(ie,wh,ct=>xe(24,x=ct)),Or(ie,Zl,ct=>xe(6,c=ct)),Or(ie,al,ct=>xe(26,h=ct)),Or(ie,qr,ct=>xe(15,p=ct));const{apiURL:_}=kc;Or(ie,_,ct=>xe(25,o=ct));let u=o,C;qr.subscribe(ct=>C=ct);let S,D,L;const U=new Map([[Ui.AddingZoneCanvas,"Adding zone to the canvas"],[Ui.DeletingZoneCanvas,"Deleting zone from the canvas"],[Ui.AddingZoneMap,"Adding zone to the map"],[Ui.DeletingZoneMap,"Deleting zone from the map"]]),$=ct=>{D=Zl.subscribe(Q=>{Q===!0&&h==!0&&(console.log(`MJPEG is loaded after geo data: ${ct}`),ud(m,qr,b,Io))}),L=al.subscribe(Q=>{Q===!0&&c==!0&&(console.log(`MJPEG is loaded before geo data: '${ct}'`),ud(m,qr,b,Io))});const Et=`${u}/api/polygons/geojson`;fetch(`${Et}`).then(Q=>Q.json()).then(Q=>{Q.features.forEach(de=>{Np(de)}),ct===Mc.ReInit?S.drawGeoPolygons(s,b):x.on("load",()=>{S.drawGeoPolygons(s,b)}),al.set(!0)}).catch(Q=>{console.log(`Error on loading polygons ['${ct}']`,Q)})},ne=Mh.subscribe(ct=>{u!==ct&&(console.log(`Need to change API URL for Data: '${o}'`),xe(0,u=ct),Zl.set(!1),al.set(!1),D(),L(),Up(),m!==void 0&&m!=null&&m.getObjects().forEach(Et=>{m.remove(Et)}),s.deleteAll(),$(Mc.ReInit))});Jl(()=>{console.log("Mounted"),$(Mc.Init),Cd.onClick=(ct,Et)=>{var Q;if(Et.featureTarget&&C===Ui.DeletingZoneMap){const _e=Et.featureTarget.properties.id;qr.set(Ui.Waiting);let pe=(Q=[...b].find(Re=>Re[1].properties.spatial_object_id===_e))==null?void 0:Q[1];if(!pe){console.warn(`Spatial ID '${_e}' not found in datastorage. Just removing from the spatial map...`),s.delete(_e),s.changeMode("simple_select");return}Ed(b,pe.id),s.delete(_e),s.changeMode("simple_select")}},S.attachDraw(s),x.on("draw.create",function(ct){ct.features[0].properties={color_rgb_str:Kl},s.add(ct.features[0]),qr.set(Ui.Waiting)}),x.on("draw.update",function(ct){var pe;const Et=ct.features[0],Q=Et.id;let de=(pe=[...b].find(Re=>Re[1].properties.spatial_object_id===Q))==null?void 0:pe[1];if(!de){console.warn(`Spatial ID '${Q}' not found in datastorage. Ignoring...`);return}const _e=Et.geometry;de.geometry.coordinates=_e.coordinates,Io(de.id,de)})}),Sh(()=>{console.log("Destroyed"),Zl.set(!1),al.set(!1),D(),L(),ne()});function ye(ct){ct.key==="Escape"&&(Ke(m),s.changeMode("simple_select"),qr.set(Ui.Waiting))}const Ve=()=>{const ct=document.querySelectorAll(".fixed-action-btn");M.FloatingActionButton.init(ct,{direction:"left",hoverEnabled:!1});const Et=document.getElementById("collapsible-data");M.Collapsible.init(Et,{})},Ke=ct=>{ct.contourTemporary.forEach(Et=>{ct.remove(Et)}),ct.contourNotationTemporary.forEach(Et=>{ct.remove(Et)}),ct.contourTemporary=[],ct.contourNotationTemporary=[],ct.contourFinalized=[]},at=()=>{C!==Ui.AddingZoneCanvas?(qr.set(Ui.AddingZoneCanvas),s.changeMode("draw_restricted_polygon")):(qr.set(Ui.Waiting),s.changeMode("simple_select"))},$e=()=>{C!==Ui.AddingZoneMap?(qr.set(Ui.AddingZoneMap),s.changeMode("draw_restricted_polygon")):(qr.set(Ui.Waiting),s.changeMode("simple_select"))},ut=()=>{C!==Ui.DeletingZoneCanvas?qr.set(Ui.DeletingZoneCanvas):qr.set(Ui.Waiting)},ot=()=>{C!==Ui.DeletingZoneMap?(qr.set(Ui.DeletingZoneMap),s.changeMode("delete_zone")):(qr.set(Ui.Waiting),s.changeMode("simple_select"))},vt=()=>wm(u,Ze);function St(ct){gd[ct?"unshift":"push"](()=>{S=ct,xe(1,S)})}return ie.$$.update=()=>{ie.$$.dirty&32768&&xe(5,Ae=p===Ui.AddingZoneCanvas||p===Ui.DeletingZoneCanvas),ie.$$.dirty&32768&&xe(4,Ne=p===Ui.AddingZoneMap||p===Ui.DeletingZoneMap),ie.$$.dirty&16384&&xe(3,Ze=[...b].filter(ct=>ct[1].id&&ct[1].properties.spatial_object_id)),ie.$$.dirty&32768&&xe(2,V=U.get(p))},[u,S,V,Ze,Ne,Ae,c,_,ye,Ve,at,$e,ut,ot,b,p,vt,St]}class Mm extends Ao{constructor(I){super(),Mo(this,I,Sm,Cm,Po,{})}}export{Mm as component,Am as universal};
