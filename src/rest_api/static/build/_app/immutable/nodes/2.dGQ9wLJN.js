var Up=Object.defineProperty;var Gp=($,S,re)=>S in $?Up($,S,{enumerable:!0,configurable:!0,writable:!0,value:re}):$[S]=re;var Fn=($,S,re)=>(Gp($,typeof S!="symbol"?S+"":S,re),re);import{s as sa,n as ys,c as Nr,o as sc,y as Dh,d as Md,z as wl,A as _d,B as so,r as Lh,a as Hp}from"../chunks/scheduler.D-x6b7vF.js";import{S as oa,i as aa,e as Ot,c as Dt,a as ti,d as Gt,o as dt,g as gn,h as it,t as Cn,s as Ii,b as Sn,f as Pi,y as br,j as Ws,u as Fa,v as Ra,w as Ba,z as _s,n as ja,l as Na,x as Va,A as na,B as kd,k as yd,C as Wp,D as zc,E as Fc,p as za}from"../chunks/index.D7zNCqp9.js";import{c as yl,g as Od,a as Xp}from"../chunks/_commonjsHelpers.BosuxZz1.js";import{w as qn,d as qp}from"../chunks/index.DZQZCYML.js";function vd($){return($==null?void 0:$.length)!==void 0?$:Array.from($)}const $p=!1,_g=Object.freeze(Object.defineProperty({__proto__:null,ssr:$p},Symbol.toStringTag,{value:"Module"}));var Dd={exports:{}};/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v4.1.3/LICENSE.txt
 */(function($,S){(function(re,pe){$.exports=pe()})(yl,function(){var re={},pe={};function ue(j,s,p){if(pe[j]=p,j==="index"){var b="var sharedModule = {}; ("+pe.shared+")(sharedModule); ("+pe.worker+")(sharedModule);",v={};return pe.shared(v),pe.index(re,v),typeof window<"u"&&re.setWorkerUrl(window.URL.createObjectURL(new Blob([b],{type:"text/javascript"}))),re}}ue("shared",["exports"],function(j){function s(i,e,r,o){return new(r||(r=Promise))(function(f,w){function C(z){try{O(o.next(z))}catch(B){w(B)}}function I(z){try{O(o.throw(z))}catch(B){w(B)}}function O(z){var B;z.done?f(z.value):(B=z.value,B instanceof r?B:new r(function(N){N(B)})).then(C,I)}O((o=o.apply(i,e||[])).next())})}function p(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}typeof SuppressedError=="function"&&SuppressedError;var b=v;function v(i,e){this.x=i,this.y=e}v.prototype={clone:function(){return new v(this.x,this.y)},add:function(i){return this.clone()._add(i)},sub:function(i){return this.clone()._sub(i)},multByPoint:function(i){return this.clone()._multByPoint(i)},divByPoint:function(i){return this.clone()._divByPoint(i)},mult:function(i){return this.clone()._mult(i)},div:function(i){return this.clone()._div(i)},rotate:function(i){return this.clone()._rotate(i)},rotateAround:function(i,e){return this.clone()._rotateAround(i,e)},matMult:function(i){return this.clone()._matMult(i)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(i){return this.x===i.x&&this.y===i.y},dist:function(i){return Math.sqrt(this.distSqr(i))},distSqr:function(i){var e=i.x-this.x,r=i.y-this.y;return e*e+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(i){return Math.atan2(this.y-i.y,this.x-i.x)},angleWith:function(i){return this.angleWithSep(i.x,i.y)},angleWithSep:function(i,e){return Math.atan2(this.x*e-this.y*i,this.x*i+this.y*e)},_matMult:function(i){var e=i[2]*this.x+i[3]*this.y;return this.x=i[0]*this.x+i[1]*this.y,this.y=e,this},_add:function(i){return this.x+=i.x,this.y+=i.y,this},_sub:function(i){return this.x-=i.x,this.y-=i.y,this},_mult:function(i){return this.x*=i,this.y*=i,this},_div:function(i){return this.x/=i,this.y/=i,this},_multByPoint:function(i){return this.x*=i.x,this.y*=i.y,this},_divByPoint:function(i){return this.x/=i.x,this.y/=i.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var i=this.y;return this.y=this.x,this.x=-i,this},_rotate:function(i){var e=Math.cos(i),r=Math.sin(i),o=r*this.x+e*this.y;return this.x=e*this.x-r*this.y,this.y=o,this},_rotateAround:function(i,e){var r=Math.cos(i),o=Math.sin(i),f=e.y+o*(this.x-e.x)+r*(this.y-e.y);return this.x=e.x+r*(this.x-e.x)-o*(this.y-e.y),this.y=f,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},v.convert=function(i){return i instanceof v?i:Array.isArray(i)?new v(i[0],i[1]):i};var a=p(b),l=h;function h(i,e,r,o){this.cx=3*i,this.bx=3*(r-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(o-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=e,this.p2x=r,this.p2y=o}h.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,e){if(e===void 0&&(e=1e-6),i<0)return 0;if(i>1)return 1;for(var r=i,o=0;o<8;o++){var f=this.sampleCurveX(r)-i;if(Math.abs(f)<e)return r;var w=this.sampleCurveDerivativeX(r);if(Math.abs(w)<1e-6)break;r-=f/w}var C=0,I=1;for(r=i,o=0;o<20&&(f=this.sampleCurveX(r),!(Math.abs(f-i)<e));o++)i>f?C=r:I=r,r=.5*(I-C)+C;return r},solve:function(i,e){return this.sampleCurveY(this.solveCurveX(i,e))}};var m=p(l);let _,u;function x(){return _==null&&(_=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),_}function T(){if(u==null&&(u=!1,x())){const e=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(e){for(let o=0;o<5*5;o++){const f=4*o;e.fillStyle=`rgb(${f},${f+1},${f+2})`,e.fillRect(o%5,Math.floor(o/5),1,1)}const r=e.getImageData(0,0,5,5).data;for(let o=0;o<5*5*4;o++)if(o%4!=3&&r[o]!==o){u=!0;break}}}return u||!1}function A(i,e,r,o){const f=new m(i,e,r,o);return function(w){return f.solve(w)}}const D=A(.25,.1,.25,1);function V(i,e,r){return Math.min(r,Math.max(e,i))}function X(i,e,r){const o=r-e,f=((i-e)%o+o)%o+e;return f===e?r:f}function ie(i,...e){for(const r of e)for(const o in r)i[o]=r[o];return i}let ve=1;function Fe(i,e,r){const o={};for(const f in i)o[f]=e.call(r||this,i[f],f,i);return o}function Ye(i,e,r){const o={};for(const f in i)e.call(r||this,i[f],f,i)&&(o[f]=i[f]);return o}function Ze(i){return Array.isArray(i)?i.map(Ze):typeof i=="object"&&i?Fe(i,Ze):i}const Je={};function ct(i){Je[i]||(typeof console<"u"&&console.warn(i),Je[i]=!0)}function nt(i,e,r){return(r.y-i.y)*(e.x-i.x)>(e.y-i.y)*(r.x-i.x)}function vt(i){let e=0;for(let r,o,f=0,w=i.length,C=w-1;f<w;C=f++)r=i[f],o=i[C],e+=(o.x-r.x)*(r.y+o.y);return e}function Mt(i){return typeof WorkerGlobalScope<"u"&&i!==void 0&&i instanceof WorkerGlobalScope}let st=null;function bt(i){return typeof ImageBitmap<"u"&&i instanceof ImageBitmap}const ee="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function be(i,e,r,o,f){return s(this,void 0,void 0,function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const w=new VideoFrame(i,{timestamp:0});try{const C=w==null?void 0:w.format;if(!C||!C.startsWith("BGR")&&!C.startsWith("RGB"))throw new Error(`Unrecognized format ${C}`);const I=C.startsWith("BGR"),O=new Uint8ClampedArray(o*f*4);if(yield w.copyTo(O,function(z,B,N,W,Z){const J=4*Math.max(-B,0),se=(Math.max(0,N)-N)*W*4+J,de=4*W,Ce=Math.max(0,B),Ve=Math.max(0,N);return{rect:{x:Ce,y:Ve,width:Math.min(z.width,B+W)-Ce,height:Math.min(z.height,N+Z)-Ve},layout:[{offset:se,stride:de}]}}(i,e,r,o,f)),I)for(let z=0;z<O.length;z+=4){const B=O[z];O[z]=O[z+2],O[z+2]=B}return O}finally{w.close()}})}let me,ge;const je="AbortError";function _e(){return new Error(je)}const te={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function Pe(i){return te.REGISTERED_PROTOCOLS[i.substring(0,i.indexOf("://"))]}const Ne="global-dispatcher";class et extends Error{constructor(e,r,o,f){super(`AJAXError: ${r} (${e}): ${o}`),this.status=e,this.statusText=r,this.url=o,this.body=f}}const He=()=>Mt(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,Ge=function(i,e){if(/:\/\//.test(i.url)&&!/^https?:|^file:/.test(i.url)){const o=Pe(i.url);if(o)return o(i,e);if(Mt(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:i,targetMapId:Ne},e)}if(!(/^file:/.test(r=i.url)||/^file:/.test(He())&&!/^\w+:/.test(r))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(o,f){return s(this,void 0,void 0,function*(){const w=new Request(o.url,{method:o.method||"GET",body:o.body,credentials:o.credentials,headers:o.headers,cache:o.cache,referrer:He(),signal:f.signal});o.type==="json"&&w.headers.set("Accept","application/json");const C=yield fetch(w);if(!C.ok){const z=yield C.blob();throw new et(C.status,C.statusText,o.url,z)}let I;I=o.type==="arrayBuffer"||o.type==="image"?C.arrayBuffer():o.type==="json"?C.json():C.text();const O=yield I;if(f.signal.aborted)throw _e();return{data:O,cacheControl:C.headers.get("Cache-Control"),expires:C.headers.get("Expires")}})}(i,e);if(Mt(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:i,mustQueue:!0,targetMapId:Ne},e)}var r;return function(o,f){return new Promise((w,C)=>{const I=new XMLHttpRequest;I.open(o.method||"GET",o.url,!0),o.type!=="arrayBuffer"&&o.type!=="image"||(I.responseType="arraybuffer");for(const O in o.headers)I.setRequestHeader(O,o.headers[O]);o.type==="json"&&(I.responseType="text",I.setRequestHeader("Accept","application/json")),I.withCredentials=o.credentials==="include",I.onerror=()=>{C(new Error(I.statusText))},I.onload=()=>{if(!f.signal.aborted)if((I.status>=200&&I.status<300||I.status===0)&&I.response!==null){let O=I.response;if(o.type==="json")try{O=JSON.parse(I.response)}catch(z){return void C(z)}w({data:O,cacheControl:I.getResponseHeader("Cache-Control"),expires:I.getResponseHeader("Expires")})}else{const O=new Blob([I.response],{type:I.getResponseHeader("Content-Type")});C(new et(I.status,I.statusText,o.url,O))}},f.signal.addEventListener("abort",()=>{I.abort(),C(_e())}),I.send(o.body)})}(i,e)};function _t(i){if(!i||i.indexOf("://")<=0||i.indexOf("data:image/")===0||i.indexOf("blob:")===0)return!0;const e=new URL(i),r=window.location;return e.protocol===r.protocol&&e.host===r.host}function It(i,e,r){r[i]&&r[i].indexOf(e)!==-1||(r[i]=r[i]||[],r[i].push(e))}function Xe(i,e,r){if(r&&r[i]){const o=r[i].indexOf(e);o!==-1&&r[i].splice(o,1)}}class Oe{constructor(e,r={}){ie(this,r),this.type=e}}class ot extends Oe{constructor(e,r={}){super("error",ie({error:e},r))}}class qe{on(e,r){return this._listeners=this._listeners||{},It(e,r,this._listeners),this}off(e,r){return Xe(e,r,this._listeners),Xe(e,r,this._oneTimeListeners),this}once(e,r){return r?(this._oneTimeListeners=this._oneTimeListeners||{},It(e,r,this._oneTimeListeners),this):new Promise(o=>this.once(e,o))}fire(e,r){typeof e=="string"&&(e=new Oe(e,r||{}));const o=e.type;if(this.listens(o)){e.target=this;const f=this._listeners&&this._listeners[o]?this._listeners[o].slice():[];for(const I of f)I.call(this,e);const w=this._oneTimeListeners&&this._oneTimeListeners[o]?this._oneTimeListeners[o].slice():[];for(const I of w)Xe(o,I,this._oneTimeListeners),I.call(this,e);const C=this._eventedParent;C&&(ie(e,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),C.fire(e))}else e instanceof ot&&console.error(e.error);return this}listens(e){return this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e)}setEventedParent(e,r){return this._eventedParent=e,this._eventedParentData=r,this}}var le={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{},within:{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const ft=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function Pt(i,e){const r={};for(const o in i)o!=="ref"&&(r[o]=i[o]);return ft.forEach(o=>{o in e&&(r[o]=e[o])}),r}function Tt(i,e){if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let r=0;r<i.length;r++)if(!Tt(i[r],e[r]))return!1;return!0}if(typeof i=="object"&&i!==null&&e!==null){if(typeof e!="object"||Object.keys(i).length!==Object.keys(e).length)return!1;for(const r in i)if(!Tt(i[r],e[r]))return!1;return!0}return i===e}function Nt(i,e){i.push(e)}function lt(i,e,r){Nt(r,{command:"addSource",args:[i,e[i]]})}function wt(i,e,r){Nt(e,{command:"removeSource",args:[i]}),r[i]=!0}function Yt(i,e,r,o){wt(i,r,o),lt(i,e,r)}function fi(i,e,r){let o;for(o in i[r])if(Object.prototype.hasOwnProperty.call(i[r],o)&&o!=="data"&&!Tt(i[r][o],e[r][o]))return!1;for(o in e[r])if(Object.prototype.hasOwnProperty.call(e[r],o)&&o!=="data"&&!Tt(i[r][o],e[r][o]))return!1;return!0}function mi(i,e,r,o,f,w){i=i||{},e=e||{};for(const C in i)Object.prototype.hasOwnProperty.call(i,C)&&(Tt(i[C],e[C])||r.push({command:w,args:[o,C,e[C],f]}));for(const C in e)Object.prototype.hasOwnProperty.call(e,C)&&!Object.prototype.hasOwnProperty.call(i,C)&&(Tt(i[C],e[C])||r.push({command:w,args:[o,C,e[C],f]}))}function yi(i){return i.id}function bi(i,e){return i[e.id]=e,i}class ut{constructor(e,r,o,f){this.message=(e?`${e}: `:"")+o,f&&(this.identifier=f),r!=null&&r.__line__&&(this.line=r.__line__)}}function Gi(i,...e){for(const r of e)for(const o in r)i[o]=r[o];return i}class Xi extends Error{constructor(e,r){super(r),this.message=r,this.key=e}}class rr{constructor(e,r=[]){this.parent=e,this.bindings={};for(const[o,f]of r)this.bindings[o]=f}concat(e){return new rr(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const Qi={kind:"null"},Et={kind:"number"},ii={kind:"string"},ai={kind:"boolean"},Hi={kind:"color"},qi={kind:"object"},Zt={kind:"value"},Zi={kind:"collator"},$i={kind:"formatted"},ae={kind:"padding"},H={kind:"resolvedImage"},q={kind:"variableAnchorOffsetCollection"};function Q(i,e){return{kind:"array",itemType:i,N:e}}function oe(i){if(i.kind==="array"){const e=oe(i.itemType);return typeof i.N=="number"?`array<${e}, ${i.N}>`:i.itemType.kind==="value"?"array":`array<${e}>`}return i.kind}const Ae=[Qi,Et,ii,ai,Hi,$i,qi,Q(Zt),ae,H,q];function ke(i,e){if(e.kind==="error")return null;if(i.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!ke(i.itemType,e.itemType))&&(typeof i.N!="number"||i.N===e.N))return null}else{if(i.kind===e.kind)return null;if(i.kind==="value"){for(const r of Ae)if(!ke(r,e))return null}}return`Expected ${oe(i)} but found ${oe(e)} instead.`}function Le(i,e){return e.some(r=>r.kind===i.kind)}function we(i,e){return e.some(r=>r==="null"?i===null:r==="array"?Array.isArray(i):r==="object"?i&&!Array.isArray(i)&&typeof i=="object":r===typeof i)}function Ue(i,e){return i.kind==="array"&&e.kind==="array"?i.itemType.kind===e.itemType.kind&&typeof i.N=="number":i.kind===e.kind}const pt=.96422,Qe=.82521,at=4/29,Jt=6/29,ri=3*Jt*Jt,ui=Jt*Jt*Jt,pi=Math.PI/180,wi=180/Math.PI;function Ri(i){return(i%=360)<0&&(i+=360),i}function nr([i,e,r,o]){let f,w;const C=li((.2225045*(i=Pr(i))+.7168786*(e=Pr(e))+.0606169*(r=Pr(r)))/1);i===e&&e===r?f=w=C:(f=li((.4360747*i+.3850649*e+.1430804*r)/pt),w=li((.0139322*i+.0971045*e+.7141733*r)/Qe));const I=116*C-16;return[I<0?0:I,500*(f-C),200*(C-w),o]}function Pr(i){return i<=.04045?i/12.92:Math.pow((i+.055)/1.055,2.4)}function li(i){return i>ui?Math.pow(i,1/3):i/ri+at}function ur([i,e,r,o]){let f=(i+16)/116,w=isNaN(e)?f:f+e/500,C=isNaN(r)?f:f-r/200;return f=1*rn(f),w=pt*rn(w),C=Qe*rn(C),[kr(3.1338561*w-1.6168667*f-.4906146*C),kr(-.9787684*w+1.9161415*f+.033454*C),kr(.0719453*w-.2289914*f+1.4052427*C),o]}function kr(i){return(i=i<=.00304?12.92*i:1.055*Math.pow(i,1/2.4)-.055)<0?0:i>1?1:i}function rn(i){return i>Jt?i*i*i:ri*(i-at)}function nn(i){return parseInt(i.padEnd(2,i),16)/255}function zr(i,e){return Tn(e?i/100:i,0,1)}function Tn(i,e,r){return Math.min(Math.max(e,i),r)}function Ga(i){return!i.some(Number.isNaN)}const Ao={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};class Vi{constructor(e,r,o,f=1,w=!0){this.r=e,this.g=r,this.b=o,this.a=f,w||(this.r*=f,this.g*=f,this.b*=f,f||this.overwriteGetter("rgb",[e,r,o,f]))}static parse(e){if(e instanceof Vi)return e;if(typeof e!="string")return;const r=function(o){if((o=o.toLowerCase().trim())==="transparent")return[0,0,0,0];const f=Ao[o];if(f){const[C,I,O]=f;return[C/255,I/255,O/255,1]}if(o.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(o)){const C=o.length<6?1:2;let I=1;return[nn(o.slice(I,I+=C)),nn(o.slice(I,I+=C)),nn(o.slice(I,I+=C)),nn(o.slice(I,I+C)||"ff")]}if(o.startsWith("rgb")){const C=o.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(C){const[I,O,z,B,N,W,Z,J,se,de,Ce,Ve]=C,Se=[B||" ",Z||" ",de].join("");if(Se==="  "||Se==="  /"||Se===",,"||Se===",,,"){const De=[z,W,se].join(""),ht=De==="%%%"?100:De===""?255:0;if(ht){const gt=[Tn(+O/ht,0,1),Tn(+N/ht,0,1),Tn(+J/ht,0,1),Ce?zr(+Ce,Ve):1];if(Ga(gt))return gt}}return}}const w=o.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(w){const[C,I,O,z,B,N,W,Z,J]=w,se=[O||" ",B||" ",W].join("");if(se==="  "||se==="  /"||se===",,"||se===",,,"){const de=[+I,Tn(+z,0,100),Tn(+N,0,100),Z?zr(+Z,J):1];if(Ga(de))return function([Ce,Ve,Se,De]){function ht(gt){const $t=(gt+Ce/30)%12,ei=Ve*Math.min(Se,1-Se);return Se-ei*Math.max(-1,Math.min($t-3,9-$t,1))}return Ce=Ri(Ce),Ve/=100,Se/=100,[ht(0),ht(8),ht(4),De]}(de)}}}(e);return r?new Vi(...r,!1):void 0}get rgb(){const{r:e,g:r,b:o,a:f}=this,w=f||1/0;return this.overwriteGetter("rgb",[e/w,r/w,o/w,f])}get hcl(){return this.overwriteGetter("hcl",function(e){const[r,o,f,w]=nr(e),C=Math.sqrt(o*o+f*f);return[Math.round(1e4*C)?Ri(Math.atan2(f,o)*wi):NaN,C,r,w]}(this.rgb))}get lab(){return this.overwriteGetter("lab",nr(this.rgb))}overwriteGetter(e,r){return Object.defineProperty(this,e,{value:r}),r}toString(){const[e,r,o,f]=this.rgb;return`rgba(${[e,r,o].map(w=>Math.round(255*w)).join(",")},${f})`}}Vi.black=new Vi(0,0,0,1),Vi.white=new Vi(1,1,1,1),Vi.transparent=new Vi(0,0,0,0),Vi.red=new Vi(1,0,0,1);class co{constructor(e,r,o){this.sensitivity=e?r?"variant":"case":r?"accent":"base",this.locale=o,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,r){return this.collator.compare(e,r)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class wr{constructor(e,r,o,f,w){this.text=e,this.image=r,this.scale=o,this.fontStack=f,this.textColor=w}}class dn{constructor(e){this.sections=e}static fromString(e){return new dn([new wr(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||e.image&&e.image.name.length!==0)}static factory(e){return e instanceof dn?e:dn.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}}class sn{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof sn)return e;if(typeof e=="number")return new sn([e,e,e,e]);if(Array.isArray(e)&&!(e.length<1||e.length>4)){for(const r of e)if(typeof r!="number")return;switch(e.length){case 1:e=[e[0],e[0],e[0],e[0]];break;case 2:e=[e[0],e[1],e[0],e[1]];break;case 3:e=[e[0],e[1],e[2],e[1]]}return new sn(e)}}toString(){return JSON.stringify(this.values)}}const En=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class Cr{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof Cr)return e;if(Array.isArray(e)&&!(e.length<1)&&e.length%2==0){for(let r=0;r<e.length;r+=2){const o=e[r],f=e[r+1];if(typeof o!="string"||!En.has(o)||!Array.isArray(f)||f.length!==2||typeof f[0]!="number"||typeof f[1]!="number")return}return new Cr(e)}}toString(){return JSON.stringify(this.values)}}class on{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new on({name:e,available:!1}):null}}function In(i,e,r,o){return typeof i=="number"&&i>=0&&i<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof r=="number"&&r>=0&&r<=255?o===void 0||typeof o=="number"&&o>=0&&o<=1?null:`Invalid rgba value [${[i,e,r,o].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof o=="number"?[i,e,r,o]:[i,e,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function $n(i){if(i===null||typeof i=="string"||typeof i=="boolean"||typeof i=="number"||i instanceof Vi||i instanceof co||i instanceof dn||i instanceof sn||i instanceof Cr||i instanceof on)return!0;if(Array.isArray(i)){for(const e of i)if(!$n(e))return!1;return!0}if(typeof i=="object"){for(const e in i)if(!$n(i[e]))return!1;return!0}return!1}function Sr(i){if(i===null)return Qi;if(typeof i=="string")return ii;if(typeof i=="boolean")return ai;if(typeof i=="number")return Et;if(i instanceof Vi)return Hi;if(i instanceof co)return Zi;if(i instanceof dn)return $i;if(i instanceof sn)return ae;if(i instanceof Cr)return q;if(i instanceof on)return H;if(Array.isArray(i)){const e=i.length;let r;for(const o of i){const f=Sr(o);if(r){if(r===f)continue;r=Zt;break}r=f}return Q(r||Zt,e)}return qi}function ho(i){const e=typeof i;return i===null?"":e==="string"||e==="number"||e==="boolean"?String(i):i instanceof Vi||i instanceof dn||i instanceof sn||i instanceof Cr||i instanceof on?i.toString():JSON.stringify(i)}class vs{constructor(e,r){this.type=e,this.value=r}static parse(e,r){if(e.length!==2)return r.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!$n(e[1]))return r.error("invalid value");const o=e[1];let f=Sr(o);const w=r.expectedType;return f.kind!=="array"||f.N!==0||!w||w.kind!=="array"||typeof w.N=="number"&&w.N!==0||(f=w),new vs(f,o)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}class or{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const uo={string:ii,number:Et,boolean:ai,object:qi};class an{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");let o,f=1;const w=e[0];if(w==="array"){let I,O;if(e.length>2){const z=e[1];if(typeof z!="string"||!(z in uo)||z==="object")return r.error('The item type argument of "array" must be one of string, number, boolean',1);I=uo[z],f++}else I=Zt;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return r.error('The length argument to "array" must be a positive integer literal',2);O=e[2],f++}o=Q(I,O)}else{if(!uo[w])throw new Error(`Types doesn't contain name = ${w}`);o=uo[w]}const C=[];for(;f<e.length;f++){const I=r.parse(e[f],f,Zt);if(!I)return null;C.push(I)}return new an(o,C)}evaluate(e){for(let r=0;r<this.args.length;r++){const o=this.args[r].evaluate(e);if(!ke(this.type,Sr(o)))return o;if(r===this.args.length-1)throw new or(`Expected value to be of type ${oe(this.type)}, but found ${oe(Sr(o))} instead.`)}throw new Error}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}const fo={"to-boolean":ai,"to-color":Hi,"to-number":Et,"to-string":ii};class Rn{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const o=e[0];if(!fo[o])throw new Error(`Can't parse ${o} as it is not part of the known types`);if((o==="to-boolean"||o==="to-string")&&e.length!==2)return r.error("Expected one argument.");const f=fo[o],w=[];for(let C=1;C<e.length;C++){const I=r.parse(e[C],C,Zt);if(!I)return null;w.push(I)}return new Rn(f,w)}evaluate(e){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(e);case"color":{let r,o;for(const f of this.args){if(r=f.evaluate(e),o=null,r instanceof Vi)return r;if(typeof r=="string"){const w=e.parseColor(r);if(w)return w}else if(Array.isArray(r)&&(o=r.length<3||r.length>4?`Invalid rbga value ${JSON.stringify(r)}: expected an array containing either three or four numeric values.`:In(r[0],r[1],r[2],r[3]),!o))return new Vi(r[0]/255,r[1]/255,r[2]/255,r[3])}throw new or(o||`Could not parse color from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"padding":{let r;for(const o of this.args){r=o.evaluate(e);const f=sn.parse(r);if(f)return f}throw new or(`Could not parse padding from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"variableAnchorOffsetCollection":{let r;for(const o of this.args){r=o.evaluate(e);const f=Cr.parse(r);if(f)return f}throw new or(`Could not parse variableAnchorOffsetCollection from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"number":{let r=null;for(const o of this.args){if(r=o.evaluate(e),r===null)return 0;const f=Number(r);if(!isNaN(f))return f}throw new or(`Could not convert ${JSON.stringify(r)} to number.`)}case"formatted":return dn.fromString(ho(this.args[0].evaluate(e)));case"resolvedImage":return on.fromString(ho(this.args[0].evaluate(e)));default:return ho(this.args[0].evaluate(e))}}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}const po=["Unknown","Point","LineString","Polygon"];class Wi{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?po[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(e){let r=this._parseColorCache[e];return r||(r=this._parseColorCache[e]=Vi.parse(e)),r}}class Mo{constructor(e,r,o=[],f,w=new rr,C=[]){this.registry=e,this.path=o,this.key=o.map(I=>`[${I}]`).join(""),this.scope=w,this.errors=C,this.expectedType=f,this._isConstant=r}parse(e,r,o,f,w={}){return r?this.concat(r,o,f)._parse(e,w):this._parse(e,w)}_parse(e,r){function o(f,w,C){return C==="assert"?new an(w,[f]):C==="coerce"?new Rn(w,[f]):f}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const f=e[0];if(typeof f!="string")return this.error(`Expression name must be a string, but found ${typeof f} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const w=this.registry[f];if(w){let C=w.parse(e,this);if(!C)return null;if(this.expectedType){const I=this.expectedType,O=C.type;if(I.kind!=="string"&&I.kind!=="number"&&I.kind!=="boolean"&&I.kind!=="object"&&I.kind!=="array"||O.kind!=="value")if(I.kind!=="color"&&I.kind!=="formatted"&&I.kind!=="resolvedImage"||O.kind!=="value"&&O.kind!=="string")if(I.kind!=="padding"||O.kind!=="value"&&O.kind!=="number"&&O.kind!=="array")if(I.kind!=="variableAnchorOffsetCollection"||O.kind!=="value"&&O.kind!=="array"){if(this.checkSubtype(I,O))return null}else C=o(C,I,r.typeAnnotation||"coerce");else C=o(C,I,r.typeAnnotation||"coerce");else C=o(C,I,r.typeAnnotation||"coerce");else C=o(C,I,r.typeAnnotation||"assert")}if(!(C instanceof vs)&&C.type.kind!=="resolvedImage"&&this._isConstant(C)){const I=new Wi;try{C=new vs(C.type,C.evaluate(I))}catch(O){return this.error(O.message),null}}return C}return this.error(`Unknown expression "${f}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,r,o){const f=typeof e=="number"?this.path.concat(e):this.path,w=o?this.scope.concat(o):this.scope;return new Mo(this.registry,this._isConstant,f,r||null,w,this.errors)}error(e,...r){const o=`${this.key}${r.map(f=>`[${f}]`).join("")}`;this.errors.push(new Xi(o,e))}checkSubtype(e,r){const o=ke(e,r);return o&&this.error(o),o}}class ss{constructor(e,r,o){this.type=Zi,this.locale=o,this.caseSensitive=e,this.diacriticSensitive=r}static parse(e,r){if(e.length!==2)return r.error("Expected one argument.");const o=e[1];if(typeof o!="object"||Array.isArray(o))return r.error("Collator options argument must be an object.");const f=r.parse(o["case-sensitive"]!==void 0&&o["case-sensitive"],1,ai);if(!f)return null;const w=r.parse(o["diacritic-sensitive"]!==void 0&&o["diacritic-sensitive"],1,ai);if(!w)return null;let C=null;return o.locale&&(C=r.parse(o.locale,1,ii),!C)?null:new ss(f,w,C)}evaluate(e){return new co(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}}const E=8192;function F(i,e){i[0]=Math.min(i[0],e[0]),i[1]=Math.min(i[1],e[1]),i[2]=Math.max(i[2],e[0]),i[3]=Math.max(i[3],e[1])}function Y(i,e){return!(i[0]<=e[0]||i[2]>=e[2]||i[1]<=e[1]||i[3]>=e[3])}function ye(i,e){const r=(180+i[0])/360,o=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i[1]*Math.PI/360)))/360,f=Math.pow(2,e.z);return[Math.round(r*f*E),Math.round(o*f*E)]}function Ee(i,e,r){const o=i[0]-e[0],f=i[1]-e[1],w=i[0]-r[0],C=i[1]-r[1];return o*C-w*f==0&&o*w<=0&&f*C<=0}function Me(i,e){let r=!1;for(let C=0,I=e.length;C<I;C++){const O=e[C];for(let z=0,B=O.length;z<B-1;z++){if(Ee(i,O[z],O[z+1]))return!1;(f=O[z])[1]>(o=i)[1]!=(w=O[z+1])[1]>o[1]&&o[0]<(w[0]-f[0])*(o[1]-f[1])/(w[1]-f[1])+f[0]&&(r=!r)}}var o,f,w;return r}function Re(i,e){for(let r=0;r<e.length;r++)if(Me(i,e[r]))return!0;return!1}function Ct(i,e,r,o){const f=o[0]-r[0],w=o[1]-r[1],C=(i[0]-r[0])*w-f*(i[1]-r[1]),I=(e[0]-r[0])*w-f*(e[1]-r[1]);return C>0&&I<0||C<0&&I>0}function kt(i,e,r){for(const z of r)for(let B=0;B<z.length-1;++B)if((I=[(C=z[B+1])[0]-(w=z[B])[0],C[1]-w[1]])[0]*(O=[(f=e)[0]-(o=i)[0],f[1]-o[1]])[1]-I[1]*O[0]!=0&&Ct(o,f,w,C)&&Ct(w,C,o,f))return!0;var o,f,w,C,I,O;return!1}function Ht(i,e){for(let r=0;r<i.length;++r)if(!Me(i[r],e))return!1;for(let r=0;r<i.length-1;++r)if(kt(i[r],i[r+1],e))return!1;return!0}function Wt(i,e){for(let r=0;r<e.length;r++)if(Ht(i,e[r]))return!0;return!1}function Ft(i,e,r){const o=[];for(let f=0;f<i.length;f++){const w=[];for(let C=0;C<i[f].length;C++){const I=ye(i[f][C],r);F(e,I),w.push(I)}o.push(w)}return o}function vi(i,e,r){const o=[];for(let f=0;f<i.length;f++){const w=Ft(i[f],e,r);o.push(w)}return o}function ar(i,e,r,o){if(i[0]<r[0]||i[0]>r[2]){const f=.5*o;let w=i[0]-r[0]>f?-o:r[0]-i[0]>f?o:0;w===0&&(w=i[0]-r[2]>f?-o:r[2]-i[0]>f?o:0),i[0]+=w}F(e,i)}function xi(i,e,r,o){const f=Math.pow(2,o.z)*E,w=[o.x*E,o.y*E],C=[];for(const I of i)for(const O of I){const z=[O.x+w[0],O.y+w[1]];ar(z,e,r,f),C.push(z)}return C}function Tr(i,e,r,o){const f=Math.pow(2,o.z)*E,w=[o.x*E,o.y*E],C=[];for(const O of i){const z=[];for(const B of O){const N=[B.x+w[0],B.y+w[1]];F(e,N),z.push(N)}C.push(z)}if(e[2]-e[0]<=f/2){(I=e)[0]=I[1]=1/0,I[2]=I[3]=-1/0;for(const O of C)for(const z of O)ar(z,e,r,f)}var I;return C}class mt{constructor(e,r){this.type=ai,this.geojson=e,this.geometries=r}static parse(e,r){if(e.length!==2)return r.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if($n(e[1])){const o=e[1];if(o.type==="FeatureCollection"){const f=[];for(const w of o.features){const{type:C,coordinates:I}=w.geometry;C==="Polygon"&&f.push(I),C==="MultiPolygon"&&f.push(...I)}if(f.length)return new mt(o,{type:"MultiPolygon",coordinates:f})}else if(o.type==="Feature"){const f=o.geometry.type;if(f==="Polygon"||f==="MultiPolygon")return new mt(o,o.geometry)}else if(o.type==="Polygon"||o.type==="MultiPolygon")return new mt(o,o)}return r.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(r,o){const f=[1/0,1/0,-1/0,-1/0],w=[1/0,1/0,-1/0,-1/0],C=r.canonicalID();if(o.type==="Polygon"){const I=Ft(o.coordinates,w,C),O=xi(r.geometry(),f,w,C);if(!Y(f,w))return!1;for(const z of O)if(!Me(z,I))return!1}if(o.type==="MultiPolygon"){const I=vi(o.coordinates,w,C),O=xi(r.geometry(),f,w,C);if(!Y(f,w))return!1;for(const z of O)if(!Re(z,I))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(r,o){const f=[1/0,1/0,-1/0,-1/0],w=[1/0,1/0,-1/0,-1/0],C=r.canonicalID();if(o.type==="Polygon"){const I=Ft(o.coordinates,w,C),O=Tr(r.geometry(),f,w,C);if(!Y(f,w))return!1;for(const z of O)if(!Ht(z,I))return!1}if(o.type==="MultiPolygon"){const I=vi(o.coordinates,w,C),O=Tr(r.geometry(),f,w,C);if(!Y(f,w))return!1;for(const z of O)if(!Wt(z,I))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}class Qt{constructor(e,r){this.type=r.type,this.name=e,this.boundExpression=r}static parse(e,r){if(e.length!==2||typeof e[1]!="string")return r.error("'var' expression requires exactly one string literal argument.");const o=e[1];return r.scope.has(o)?new Qt(o,r.scope.get(o)):r.error(`Unknown variable "${o}". Make sure "${o}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}}class Ai{constructor(e,r,o,f){this.name=e,this.type=r,this._evaluate=o,this.args=f}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}static parse(e,r){const o=e[0],f=Ai.definitions[o];if(!f)return r.error(`Unknown expression "${o}". If you wanted a literal array, use ["literal", [...]].`,0);const w=Array.isArray(f)?f[0]:f.type,C=Array.isArray(f)?[[f[1],f[2]]]:f.overloads,I=C.filter(([z])=>!Array.isArray(z)||z.length===e.length-1);let O=null;for(const[z,B]of I){O=new Mo(r.registry,gr,r.path,null,r.scope);const N=[];let W=!1;for(let Z=1;Z<e.length;Z++){const J=e[Z],se=Array.isArray(z)?z[Z-1]:z.type,de=O.parse(J,1+N.length,se);if(!de){W=!0;break}N.push(de)}if(!W)if(Array.isArray(z)&&z.length!==N.length)O.error(`Expected ${z.length} arguments, but found ${N.length} instead.`);else{for(let Z=0;Z<N.length;Z++){const J=Array.isArray(z)?z[Z]:z.type,se=N[Z];O.concat(Z+1).checkSubtype(J,se.type)}if(O.errors.length===0)return new Ai(o,w,B,N)}}if(I.length===1)r.errors.push(...O.errors);else{const z=(I.length?I:C).map(([N])=>{return W=N,Array.isArray(W)?`(${W.map(oe).join(", ")})`:`(${oe(W.type)}...)`;var W}).join(" | "),B=[];for(let N=1;N<e.length;N++){const W=r.parse(e[N],1+B.length);if(!W)return null;B.push(oe(W.type))}r.error(`Expected arguments of type ${z}, but found (${B.join(", ")}) instead.`)}return null}static register(e,r){Ai.definitions=r;for(const o in r)e[o]=Ai}}function gr(i){if(i instanceof Qt)return gr(i.boundExpression);if(i instanceof Ai&&i.name==="error"||i instanceof ss||i instanceof mt)return!1;const e=i instanceof Rn||i instanceof an;let r=!0;return i.eachChild(o=>{r=e?r&&gr(o):r&&o instanceof vs}),!!r&&dr(i)&&mo(i,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function dr(i){if(i instanceof Ai&&(i.name==="get"&&i.args.length===1||i.name==="feature-state"||i.name==="has"&&i.args.length===1||i.name==="properties"||i.name==="geometry-type"||i.name==="id"||/^filter-/.test(i.name))||i instanceof mt)return!1;let e=!0;return i.eachChild(r=>{e&&!dr(r)&&(e=!1)}),e}function Ms(i){if(i instanceof Ai&&i.name==="feature-state")return!1;let e=!0;return i.eachChild(r=>{e&&!Ms(r)&&(e=!1)}),e}function mo(i,e){if(i instanceof Ai&&e.indexOf(i.name)>=0)return!1;let r=!0;return i.eachChild(o=>{r&&!mo(o,e)&&(r=!1)}),r}function Yi(i,e){const r=i.length-1;let o,f,w=0,C=r,I=0;for(;w<=C;)if(I=Math.floor((w+C)/2),o=i[I],f=i[I+1],o<=e){if(I===r||e<f)return I;w=I+1}else{if(!(o>e))throw new or("Input is not a number.");C=I-1}return 0}class Xs{constructor(e,r,o){this.type=e,this.input=r,this.labels=[],this.outputs=[];for(const[f,w]of o)this.labels.push(f),this.outputs.push(w)}static parse(e,r){if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");const o=r.parse(e[1],1,Et);if(!o)return null;const f=[];let w=null;r.expectedType&&r.expectedType.kind!=="value"&&(w=r.expectedType);for(let C=1;C<e.length;C+=2){const I=C===1?-1/0:e[C],O=e[C+1],z=C,B=C+1;if(typeof I!="number")return r.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',z);if(f.length&&f[f.length-1][0]>=I)return r.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',z);const N=r.parse(O,B,w);if(!N)return null;w=w||N.type,f.push([I,N])}return new Xs(w,o,f)}evaluate(e){const r=this.labels,o=this.outputs;if(r.length===1)return o[0].evaluate(e);const f=this.input.evaluate(e);if(f<=r[0])return o[0].evaluate(e);const w=r.length;return f>=r[w-1]?o[w-1].evaluate(e):o[Yi(r,f)].evaluate(e)}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}}function Cl(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var os=ca;function ca(i,e,r,o){this.cx=3*i,this.bx=3*(r-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(o-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=e,this.p2x=r,this.p2y=o}ca.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,e){if(e===void 0&&(e=1e-6),i<0)return 0;if(i>1)return 1;for(var r=i,o=0;o<8;o++){var f=this.sampleCurveX(r)-i;if(Math.abs(f)<e)return r;var w=this.sampleCurveDerivativeX(r);if(Math.abs(w)<1e-6)break;r-=f/w}var C=0,I=1;for(r=i,o=0;o<20&&(f=this.sampleCurveX(r),!(Math.abs(f-i)<e));o++)i>f?C=r:I=r,r=.5*(I-C)+C;return r},solve:function(i,e){return this.sampleCurveY(this.solveCurveX(i,e))}};var Ha=Cl(os);function xs(i,e,r){return i+r*(e-i)}function qs(i,e,r){return i.map((o,f)=>xs(o,e[f],r))}const Qr={number:xs,color:function(i,e,r,o="rgb"){switch(o){case"rgb":{const[f,w,C,I]=qs(i.rgb,e.rgb,r);return new Vi(f,w,C,I,!1)}case"hcl":{const[f,w,C,I]=i.hcl,[O,z,B,N]=e.hcl;let W,Z;if(isNaN(f)||isNaN(O))isNaN(f)?isNaN(O)?W=NaN:(W=O,C!==1&&C!==0||(Z=z)):(W=f,B!==1&&B!==0||(Z=w));else{let Ve=O-f;O>f&&Ve>180?Ve-=360:O<f&&f-O>180&&(Ve+=360),W=f+r*Ve}const[J,se,de,Ce]=function([Ve,Se,De,ht]){return Ve=isNaN(Ve)?0:Ve*pi,ur([De,Math.cos(Ve)*Se,Math.sin(Ve)*Se,ht])}([W,Z??xs(w,z,r),xs(C,B,r),xs(I,N,r)]);return new Vi(J,se,de,Ce,!1)}case"lab":{const[f,w,C,I]=ur(qs(i.lab,e.lab,r));return new Vi(f,w,C,I,!1)}}},array:qs,padding:function(i,e,r){return new sn(qs(i.values,e.values,r))},variableAnchorOffsetCollection:function(i,e,r){const o=i.values,f=e.values;if(o.length!==f.length)throw new or(`Cannot interpolate values of different length. from: ${i.toString()}, to: ${e.toString()}`);const w=[];for(let C=0;C<o.length;C+=2){if(o[C]!==f[C])throw new or(`Cannot interpolate values containing mismatched anchors. from[${C}]: ${o[C]}, to[${C}]: ${f[C]}`);w.push(o[C]);const[I,O]=o[C+1],[z,B]=f[C+1];w.push([xs(I,z,r),xs(O,B,r)])}return new Cr(w)}};class Vr{constructor(e,r,o,f,w){this.type=e,this.operator=r,this.interpolation=o,this.input=f,this.labels=[],this.outputs=[];for(const[C,I]of w)this.labels.push(C),this.outputs.push(I)}static interpolationFactor(e,r,o,f){let w=0;if(e.name==="exponential")w=ji(r,e.base,o,f);else if(e.name==="linear")w=ji(r,1,o,f);else if(e.name==="cubic-bezier"){const C=e.controlPoints;w=new Ha(C[0],C[1],C[2],C[3]).solve(ji(r,1,o,f))}return w}static parse(e,r){let[o,f,w,...C]=e;if(!Array.isArray(f)||f.length===0)return r.error("Expected an interpolation type expression.",1);if(f[0]==="linear")f={name:"linear"};else if(f[0]==="exponential"){const z=f[1];if(typeof z!="number")return r.error("Exponential interpolation requires a numeric base.",1,1);f={name:"exponential",base:z}}else{if(f[0]!=="cubic-bezier")return r.error(`Unknown interpolation type ${String(f[0])}`,1,0);{const z=f.slice(1);if(z.length!==4||z.some(B=>typeof B!="number"||B<0||B>1))return r.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);f={name:"cubic-bezier",controlPoints:z}}}if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");if(w=r.parse(w,2,Et),!w)return null;const I=[];let O=null;o==="interpolate-hcl"||o==="interpolate-lab"?O=Hi:r.expectedType&&r.expectedType.kind!=="value"&&(O=r.expectedType);for(let z=0;z<C.length;z+=2){const B=C[z],N=C[z+1],W=z+3,Z=z+4;if(typeof B!="number")return r.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',W);if(I.length&&I[I.length-1][0]>=B)return r.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',W);const J=r.parse(N,Z,O);if(!J)return null;O=O||J.type,I.push([B,J])}return Ue(O,Et)||Ue(O,Hi)||Ue(O,ae)||Ue(O,q)||Ue(O,Q(Et))?new Vr(O,o,f,w,I):r.error(`Type ${oe(O)} is not interpolatable.`)}evaluate(e){const r=this.labels,o=this.outputs;if(r.length===1)return o[0].evaluate(e);const f=this.input.evaluate(e);if(f<=r[0])return o[0].evaluate(e);const w=r.length;if(f>=r[w-1])return o[w-1].evaluate(e);const C=Yi(r,f),I=Vr.interpolationFactor(this.interpolation,f,r[C],r[C+1]),O=o[C].evaluate(e),z=o[C+1].evaluate(e);switch(this.operator){case"interpolate":return Qr[this.type.kind](O,z,I);case"interpolate-hcl":return Qr.color(O,z,I,"hcl");case"interpolate-lab":return Qr.color(O,z,I,"lab")}}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}}function ji(i,e,r,o){const f=o-r,w=i-r;return f===0?0:e===1?w/f:(Math.pow(e,w)-1)/(Math.pow(e,f)-1)}class ko{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expectected at least one argument.");let o=null;const f=r.expectedType;f&&f.kind!=="value"&&(o=f);const w=[];for(const I of e.slice(1)){const O=r.parse(I,1+w.length,o,void 0,{typeAnnotation:"omit"});if(!O)return null;o=o||O.type,w.push(O)}if(!o)throw new Error("No output type");const C=f&&w.some(I=>ke(f,I.type));return new ko(C?Zt:o,w)}evaluate(e){let r,o=null,f=0;for(const w of this.args)if(f++,o=w.evaluate(e),o&&o instanceof on&&!o.available&&(r||(r=o.name),o=null,f===this.args.length&&(o=r)),o!==null)break;return o}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}class Oo{constructor(e,r){this.type=r.type,this.bindings=[].concat(e),this.result=r}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const r of this.bindings)e(r[1]);e(this.result)}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const o=[];for(let w=1;w<e.length-1;w+=2){const C=e[w];if(typeof C!="string")return r.error(`Expected string, but found ${typeof C} instead.`,w);if(/[^a-zA-Z0-9_]/.test(C))return r.error("Variable names must contain only alphanumeric characters or '_'.",w);const I=r.parse(e[w+1],w+1);if(!I)return null;o.push([C,I])}const f=r.parse(e[e.length-1],e.length-1,r.expectedType,o);return f?new Oo(o,f):null}outputDefined(){return this.result.outputDefined()}}class Do{constructor(e,r,o){this.type=e,this.index=r,this.input=o}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=r.parse(e[1],1,Et),f=r.parse(e[2],2,Q(r.expectedType||Zt));return o&&f?new Do(f.type.itemType,o,f):null}evaluate(e){const r=this.index.evaluate(e),o=this.input.evaluate(e);if(r<0)throw new or(`Array index out of bounds: ${r} < 0.`);if(r>=o.length)throw new or(`Array index out of bounds: ${r} > ${o.length-1}.`);if(r!==Math.floor(r))throw new or(`Array index must be an integer, but found ${r} instead.`);return o[r]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}}class Lo{constructor(e,r){this.type=ai,this.needle=e,this.haystack=r}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=r.parse(e[1],1,Zt),f=r.parse(e[2],2,Zt);return o&&f?Le(o.type,[ai,ii,Et,Qi,Zt])?new Lo(o,f):r.error(`Expected first argument to be of type boolean, string, number or null, but found ${oe(o.type)} instead`):null}evaluate(e){const r=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(!o)return!1;if(!we(r,["boolean","string","number","null"]))throw new or(`Expected first argument to be of type boolean, string, number or null, but found ${oe(Sr(r))} instead.`);if(!we(o,["string","array"]))throw new or(`Expected second argument to be of type array or string, but found ${oe(Sr(o))} instead.`);return o.indexOf(r)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}}class go{constructor(e,r,o){this.type=Et,this.needle=e,this.haystack=r,this.fromIndex=o}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=r.parse(e[1],1,Zt),f=r.parse(e[2],2,Zt);if(!o||!f)return null;if(!Le(o.type,[ai,ii,Et,Qi,Zt]))return r.error(`Expected first argument to be of type boolean, string, number or null, but found ${oe(o.type)} instead`);if(e.length===4){const w=r.parse(e[3],3,Et);return w?new go(o,f,w):null}return new go(o,f)}evaluate(e){const r=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(!we(r,["boolean","string","number","null"]))throw new or(`Expected first argument to be of type boolean, string, number or null, but found ${oe(Sr(r))} instead.`);if(!we(o,["string","array"]))throw new or(`Expected second argument to be of type array or string, but found ${oe(Sr(o))} instead.`);if(this.fromIndex){const f=this.fromIndex.evaluate(e);return o.indexOf(r,f)}return o.indexOf(r)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}}class ha{constructor(e,r,o,f,w,C){this.inputType=e,this.type=r,this.input=o,this.cases=f,this.outputs=w,this.otherwise=C}static parse(e,r){if(e.length<5)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return r.error("Expected an even number of arguments.");let o,f;r.expectedType&&r.expectedType.kind!=="value"&&(f=r.expectedType);const w={},C=[];for(let z=2;z<e.length-1;z+=2){let B=e[z];const N=e[z+1];Array.isArray(B)||(B=[B]);const W=r.concat(z);if(B.length===0)return W.error("Expected at least one branch label.");for(const J of B){if(typeof J!="number"&&typeof J!="string")return W.error("Branch labels must be numbers or strings.");if(typeof J=="number"&&Math.abs(J)>Number.MAX_SAFE_INTEGER)return W.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof J=="number"&&Math.floor(J)!==J)return W.error("Numeric branch labels must be integer values.");if(o){if(W.checkSubtype(o,Sr(J)))return null}else o=Sr(J);if(w[String(J)]!==void 0)return W.error("Branch labels must be unique.");w[String(J)]=C.length}const Z=r.parse(N,z,f);if(!Z)return null;f=f||Z.type,C.push(Z)}const I=r.parse(e[1],1,Zt);if(!I)return null;const O=r.parse(e[e.length-1],e.length-1,f);return O?I.type.kind!=="value"&&r.concat(1).checkSubtype(o,I.type)?null:new ha(o,f,I,w,C,O):null}evaluate(e){const r=this.input.evaluate(e);return(Sr(r)===this.inputType&&this.outputs[this.cases[r]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}}class ua{constructor(e,r,o){this.type=e,this.branches=r,this.otherwise=o}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return r.error("Expected an odd number of arguments.");let o;r.expectedType&&r.expectedType.kind!=="value"&&(o=r.expectedType);const f=[];for(let C=1;C<e.length-1;C+=2){const I=r.parse(e[C],C,ai);if(!I)return null;const O=r.parse(e[C+1],C+1,o);if(!O)return null;f.push([I,O]),o=o||O.type}const w=r.parse(e[e.length-1],e.length-1,o);if(!w)return null;if(!o)throw new Error("Can't infer output type");return new ua(o,f,w)}evaluate(e){for(const[r,o]of this.branches)if(r.evaluate(e))return o.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[r,o]of this.branches)e(r),e(o);e(this.otherwise)}outputDefined(){return this.branches.every(([e,r])=>r.outputDefined())&&this.otherwise.outputDefined()}}class ks{constructor(e,r,o,f){this.type=e,this.input=r,this.beginIndex=o,this.endIndex=f}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=r.parse(e[1],1,Zt),f=r.parse(e[2],2,Et);if(!o||!f)return null;if(!Le(o.type,[Q(Zt),ii,Zt]))return r.error(`Expected first argument to be of type array or string, but found ${oe(o.type)} instead`);if(e.length===4){const w=r.parse(e[3],3,Et);return w?new ks(o.type,o,f,w):null}return new ks(o.type,o,f)}evaluate(e){const r=this.input.evaluate(e),o=this.beginIndex.evaluate(e);if(!we(r,["string","array"]))throw new or(`Expected first argument to be of type array or string, but found ${oe(Sr(r))} instead.`);if(this.endIndex){const f=this.endIndex.evaluate(e);return r.slice(o,f)}return r.slice(o)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}}function zo(i,e){return i==="=="||i==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function da(i,e,r,o){return o.compare(e,r)===0}function ln(i,e,r){const o=i!=="=="&&i!=="!=";return class Ld{constructor(w,C,I){this.type=ai,this.lhs=w,this.rhs=C,this.collator=I,this.hasUntypedArgument=w.type.kind==="value"||C.type.kind==="value"}static parse(w,C){if(w.length!==3&&w.length!==4)return C.error("Expected two or three arguments.");const I=w[0];let O=C.parse(w[1],1,Zt);if(!O)return null;if(!zo(I,O.type))return C.concat(1).error(`"${I}" comparisons are not supported for type '${oe(O.type)}'.`);let z=C.parse(w[2],2,Zt);if(!z)return null;if(!zo(I,z.type))return C.concat(2).error(`"${I}" comparisons are not supported for type '${oe(z.type)}'.`);if(O.type.kind!==z.type.kind&&O.type.kind!=="value"&&z.type.kind!=="value")return C.error(`Cannot compare types '${oe(O.type)}' and '${oe(z.type)}'.`);o&&(O.type.kind==="value"&&z.type.kind!=="value"?O=new an(z.type,[O]):O.type.kind!=="value"&&z.type.kind==="value"&&(z=new an(O.type,[z])));let B=null;if(w.length===4){if(O.type.kind!=="string"&&z.type.kind!=="string"&&O.type.kind!=="value"&&z.type.kind!=="value")return C.error("Cannot use collator to compare non-string types.");if(B=C.parse(w[3],3,Zi),!B)return null}return new Ld(O,z,B)}evaluate(w){const C=this.lhs.evaluate(w),I=this.rhs.evaluate(w);if(o&&this.hasUntypedArgument){const O=Sr(C),z=Sr(I);if(O.kind!==z.kind||O.kind!=="string"&&O.kind!=="number")throw new or(`Expected arguments for "${i}" to be (string, string) or (number, number), but found (${O.kind}, ${z.kind}) instead.`)}if(this.collator&&!o&&this.hasUntypedArgument){const O=Sr(C),z=Sr(I);if(O.kind!=="string"||z.kind!=="string")return e(w,C,I)}return this.collator?r(w,C,I,this.collator.evaluate(w)):e(w,C,I)}eachChild(w){w(this.lhs),w(this.rhs),this.collator&&w(this.collator)}outputDefined(){return!0}}}const Wa=ln("==",function(i,e,r){return e===r},da),Xa=ln("!=",function(i,e,r){return e!==r},function(i,e,r,o){return!da(0,e,r,o)}),Sl=ln("<",function(i,e,r){return e<r},function(i,e,r,o){return o.compare(e,r)<0}),qa=ln(">",function(i,e,r){return e>r},function(i,e,r,o){return o.compare(e,r)>0}),Fo=ln("<=",function(i,e,r){return e<=r},function(i,e,r,o){return o.compare(e,r)<=0}),$a=ln(">=",function(i,e,r){return e>=r},function(i,e,r,o){return o.compare(e,r)>=0});class Ro{constructor(e,r,o,f,w){this.type=ii,this.number=e,this.locale=r,this.currency=o,this.minFractionDigits=f,this.maxFractionDigits=w}static parse(e,r){if(e.length!==3)return r.error("Expected two arguments.");const o=r.parse(e[1],1,Et);if(!o)return null;const f=e[2];if(typeof f!="object"||Array.isArray(f))return r.error("NumberFormat options argument must be an object.");let w=null;if(f.locale&&(w=r.parse(f.locale,1,ii),!w))return null;let C=null;if(f.currency&&(C=r.parse(f.currency,1,ii),!C))return null;let I=null;if(f["min-fraction-digits"]&&(I=r.parse(f["min-fraction-digits"],1,Et),!I))return null;let O=null;return f["max-fraction-digits"]&&(O=r.parse(f["max-fraction-digits"],1,Et),!O)?null:new Ro(o,w,C,I,O)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}}class Bo{constructor(e){this.type=$i,this.sections=e}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const o=e[1];if(!Array.isArray(o)&&typeof o=="object")return r.error("First argument must be an image or text section.");const f=[];let w=!1;for(let C=1;C<=e.length-1;++C){const I=e[C];if(w&&typeof I=="object"&&!Array.isArray(I)){w=!1;let O=null;if(I["font-scale"]&&(O=r.parse(I["font-scale"],1,Et),!O))return null;let z=null;if(I["text-font"]&&(z=r.parse(I["text-font"],1,Q(ii)),!z))return null;let B=null;if(I["text-color"]&&(B=r.parse(I["text-color"],1,Hi),!B))return null;const N=f[f.length-1];N.scale=O,N.font=z,N.textColor=B}else{const O=r.parse(e[C],1,Zt);if(!O)return null;const z=O.type.kind;if(z!=="string"&&z!=="value"&&z!=="null"&&z!=="resolvedImage")return r.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");w=!0,f.push({content:O,scale:null,font:null,textColor:null})}}return new Bo(f)}evaluate(e){return new dn(this.sections.map(r=>{const o=r.content.evaluate(e);return Sr(o)===H?new wr("",o,null,null,null):new wr(ho(o),null,r.scale?r.scale.evaluate(e):null,r.font?r.font.evaluate(e).join(","):null,r.textColor?r.textColor.evaluate(e):null)}))}eachChild(e){for(const r of this.sections)e(r.content),r.scale&&e(r.scale),r.font&&e(r.font),r.textColor&&e(r.textColor)}outputDefined(){return!1}}class as{constructor(e){this.type=H,this.input=e}static parse(e,r){if(e.length!==2)return r.error("Expected two arguments.");const o=r.parse(e[1],1,ii);return o?new as(o):r.error("No image name provided.")}evaluate(e){const r=this.input.evaluate(e),o=on.fromString(r);return o&&e.availableImages&&(o.available=e.availableImages.indexOf(r)>-1),o}eachChild(e){e(this.input)}outputDefined(){return!1}}class jo{constructor(e){this.type=Et,this.input=e}static parse(e,r){if(e.length!==2)return r.error(`Expected 1 argument, but found ${e.length-1} instead.`);const o=r.parse(e[1],1);return o?o.type.kind!=="array"&&o.type.kind!=="string"&&o.type.kind!=="value"?r.error(`Expected argument of type string or array, but found ${oe(o.type)} instead.`):new jo(o):null}evaluate(e){const r=this.input.evaluate(e);if(typeof r=="string"||Array.isArray(r))return r.length;throw new or(`Expected value to be of type string or array, but found ${oe(Sr(r))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}}const $s={"==":Wa,"!=":Xa,">":qa,"<":Sl,">=":$a,"<=":Fo,array:an,at:Do,boolean:an,case:ua,coalesce:ko,collator:ss,format:Bo,image:as,in:Lo,"index-of":go,interpolate:Vr,"interpolate-hcl":Vr,"interpolate-lab":Vr,length:jo,let:Oo,literal:vs,match:ha,number:an,"number-format":Ro,object:an,slice:ks,step:Xs,string:an,"to-boolean":Rn,"to-color":Rn,"to-number":Rn,"to-string":Rn,var:Qt,within:mt};function Ya(i,[e,r,o,f]){e=e.evaluate(i),r=r.evaluate(i),o=o.evaluate(i);const w=f?f.evaluate(i):1,C=In(e,r,o,w);if(C)throw new or(C);return new Vi(e/255,r/255,o/255,w,!1)}function No(i,e){return i in e}function Os(i,e){const r=e[i];return r===void 0?null:r}function ls(i){return{type:i}}function Vo(i){return{result:"success",value:i}}function bs(i){return{result:"error",value:i}}function Yn(i){return i["property-type"]==="data-driven"||i["property-type"]==="cross-faded-data-driven"}function Za(i){return!!i.expression&&i.expression.parameters.indexOf("zoom")>-1}function fa(i){return!!i.expression&&i.expression.interpolated}function zi(i){return i instanceof Number?"number":i instanceof String?"string":i instanceof Boolean?"boolean":Array.isArray(i)?"array":i===null?"null":typeof i}function Uo(i){return typeof i=="object"&&i!==null&&!Array.isArray(i)}function Tl(i){return i}function pa(i,e){const r=e.type==="color",o=i.stops&&typeof i.stops[0][0]=="object",f=o||!(o||i.property!==void 0),w=i.type||(fa(e)?"exponential":"interval");if(r||e.type==="padding"){const B=r?Vi.parse:sn.parse;(i=Gi({},i)).stops&&(i.stops=i.stops.map(N=>[N[0],B(N[1])])),i.default=B(i.default?i.default:e.default)}if(i.colorSpace&&(C=i.colorSpace)!=="rgb"&&C!=="hcl"&&C!=="lab")throw new Error(`Unknown color space: "${i.colorSpace}"`);var C;let I,O,z;if(w==="exponential")I=Ti;else if(w==="interval")I=cs;else if(w==="categorical"){I=er,O=Object.create(null);for(const B of i.stops)O[B[0]]=B[1];z=typeof i.stops[0][0]}else{if(w!=="identity")throw new Error(`Unknown function type "${w}"`);I=Ys}if(o){const B={},N=[];for(let J=0;J<i.stops.length;J++){const se=i.stops[J],de=se[0].zoom;B[de]===void 0&&(B[de]={zoom:de,type:i.type,property:i.property,default:i.default,stops:[]},N.push(de)),B[de].stops.push([se[0].value,se[1]])}const W=[];for(const J of N)W.push([B[J].zoom,pa(B[J],e)]);const Z={name:"linear"};return{kind:"composite",interpolationType:Z,interpolationFactor:Vr.interpolationFactor.bind(void 0,Z),zoomStops:W.map(J=>J[0]),evaluate:({zoom:J},se)=>Ti({stops:W,base:i.base},e,J).evaluate(J,se)}}if(f){const B=w==="exponential"?{name:"exponential",base:i.base!==void 0?i.base:1}:null;return{kind:"camera",interpolationType:B,interpolationFactor:Vr.interpolationFactor.bind(void 0,B),zoomStops:i.stops.map(N=>N[0]),evaluate:({zoom:N})=>I(i,e,N,O,z)}}return{kind:"source",evaluate(B,N){const W=N&&N.properties?N.properties[i.property]:void 0;return W===void 0?Ds(i.default,e.default):I(i,e,W,O,z)}}}function Ds(i,e,r){return i!==void 0?i:e!==void 0?e:r!==void 0?r:void 0}function er(i,e,r,o,f){return Ds(typeof r===f?o[r]:void 0,i.default,e.default)}function cs(i,e,r){if(zi(r)!=="number")return Ds(i.default,e.default);const o=i.stops.length;if(o===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[o-1][0])return i.stops[o-1][1];const f=Yi(i.stops.map(w=>w[0]),r);return i.stops[f][1]}function Ti(i,e,r){const o=i.base!==void 0?i.base:1;if(zi(r)!=="number")return Ds(i.default,e.default);const f=i.stops.length;if(f===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[f-1][0])return i.stops[f-1][1];const w=Yi(i.stops.map(B=>B[0]),r),C=function(B,N,W,Z){const J=Z-W,se=B-W;return J===0?0:N===1?se/J:(Math.pow(N,se)-1)/(Math.pow(N,J)-1)}(r,o,i.stops[w][0],i.stops[w+1][0]),I=i.stops[w][1],O=i.stops[w+1][1],z=Qr[e.type]||Tl;return typeof I.evaluate=="function"?{evaluate(...B){const N=I.evaluate.apply(void 0,B),W=O.evaluate.apply(void 0,B);if(N!==void 0&&W!==void 0)return z(N,W,C,i.colorSpace)}}:z(I,O,C,i.colorSpace)}function Ys(i,e,r){switch(e.type){case"color":r=Vi.parse(r);break;case"formatted":r=dn.fromString(r.toString());break;case"resolvedImage":r=on.fromString(r.toString());break;case"padding":r=sn.parse(r);break;default:zi(r)===e.type||e.type==="enum"&&e.values[r]||(r=void 0)}return Ds(r,i.default,e.default)}Ai.register($s,{error:[{kind:"error"},[ii],(i,[e])=>{throw new or(e.evaluate(i))}],typeof:[ii,[Zt],(i,[e])=>oe(Sr(e.evaluate(i)))],"to-rgba":[Q(Et,4),[Hi],(i,[e])=>{const[r,o,f,w]=e.evaluate(i).rgb;return[255*r,255*o,255*f,w]}],rgb:[Hi,[Et,Et,Et],Ya],rgba:[Hi,[Et,Et,Et,Et],Ya],has:{type:ai,overloads:[[[ii],(i,[e])=>No(e.evaluate(i),i.properties())],[[ii,qi],(i,[e,r])=>No(e.evaluate(i),r.evaluate(i))]]},get:{type:Zt,overloads:[[[ii],(i,[e])=>Os(e.evaluate(i),i.properties())],[[ii,qi],(i,[e,r])=>Os(e.evaluate(i),r.evaluate(i))]]},"feature-state":[Zt,[ii],(i,[e])=>Os(e.evaluate(i),i.featureState||{})],properties:[qi,[],i=>i.properties()],"geometry-type":[ii,[],i=>i.geometryType()],id:[Zt,[],i=>i.id()],zoom:[Et,[],i=>i.globals.zoom],"heatmap-density":[Et,[],i=>i.globals.heatmapDensity||0],"line-progress":[Et,[],i=>i.globals.lineProgress||0],accumulated:[Zt,[],i=>i.globals.accumulated===void 0?null:i.globals.accumulated],"+":[Et,ls(Et),(i,e)=>{let r=0;for(const o of e)r+=o.evaluate(i);return r}],"*":[Et,ls(Et),(i,e)=>{let r=1;for(const o of e)r*=o.evaluate(i);return r}],"-":{type:Et,overloads:[[[Et,Et],(i,[e,r])=>e.evaluate(i)-r.evaluate(i)],[[Et],(i,[e])=>-e.evaluate(i)]]},"/":[Et,[Et,Et],(i,[e,r])=>e.evaluate(i)/r.evaluate(i)],"%":[Et,[Et,Et],(i,[e,r])=>e.evaluate(i)%r.evaluate(i)],ln2:[Et,[],()=>Math.LN2],pi:[Et,[],()=>Math.PI],e:[Et,[],()=>Math.E],"^":[Et,[Et,Et],(i,[e,r])=>Math.pow(e.evaluate(i),r.evaluate(i))],sqrt:[Et,[Et],(i,[e])=>Math.sqrt(e.evaluate(i))],log10:[Et,[Et],(i,[e])=>Math.log(e.evaluate(i))/Math.LN10],ln:[Et,[Et],(i,[e])=>Math.log(e.evaluate(i))],log2:[Et,[Et],(i,[e])=>Math.log(e.evaluate(i))/Math.LN2],sin:[Et,[Et],(i,[e])=>Math.sin(e.evaluate(i))],cos:[Et,[Et],(i,[e])=>Math.cos(e.evaluate(i))],tan:[Et,[Et],(i,[e])=>Math.tan(e.evaluate(i))],asin:[Et,[Et],(i,[e])=>Math.asin(e.evaluate(i))],acos:[Et,[Et],(i,[e])=>Math.acos(e.evaluate(i))],atan:[Et,[Et],(i,[e])=>Math.atan(e.evaluate(i))],min:[Et,ls(Et),(i,e)=>Math.min(...e.map(r=>r.evaluate(i)))],max:[Et,ls(Et),(i,e)=>Math.max(...e.map(r=>r.evaluate(i)))],abs:[Et,[Et],(i,[e])=>Math.abs(e.evaluate(i))],round:[Et,[Et],(i,[e])=>{const r=e.evaluate(i);return r<0?-Math.round(-r):Math.round(r)}],floor:[Et,[Et],(i,[e])=>Math.floor(e.evaluate(i))],ceil:[Et,[Et],(i,[e])=>Math.ceil(e.evaluate(i))],"filter-==":[ai,[ii,Zt],(i,[e,r])=>i.properties()[e.value]===r.value],"filter-id-==":[ai,[Zt],(i,[e])=>i.id()===e.value],"filter-type-==":[ai,[ii],(i,[e])=>i.geometryType()===e.value],"filter-<":[ai,[ii,Zt],(i,[e,r])=>{const o=i.properties()[e.value],f=r.value;return typeof o==typeof f&&o<f}],"filter-id-<":[ai,[Zt],(i,[e])=>{const r=i.id(),o=e.value;return typeof r==typeof o&&r<o}],"filter->":[ai,[ii,Zt],(i,[e,r])=>{const o=i.properties()[e.value],f=r.value;return typeof o==typeof f&&o>f}],"filter-id->":[ai,[Zt],(i,[e])=>{const r=i.id(),o=e.value;return typeof r==typeof o&&r>o}],"filter-<=":[ai,[ii,Zt],(i,[e,r])=>{const o=i.properties()[e.value],f=r.value;return typeof o==typeof f&&o<=f}],"filter-id-<=":[ai,[Zt],(i,[e])=>{const r=i.id(),o=e.value;return typeof r==typeof o&&r<=o}],"filter->=":[ai,[ii,Zt],(i,[e,r])=>{const o=i.properties()[e.value],f=r.value;return typeof o==typeof f&&o>=f}],"filter-id->=":[ai,[Zt],(i,[e])=>{const r=i.id(),o=e.value;return typeof r==typeof o&&r>=o}],"filter-has":[ai,[Zt],(i,[e])=>e.value in i.properties()],"filter-has-id":[ai,[],i=>i.id()!==null&&i.id()!==void 0],"filter-type-in":[ai,[Q(ii)],(i,[e])=>e.value.indexOf(i.geometryType())>=0],"filter-id-in":[ai,[Q(Zt)],(i,[e])=>e.value.indexOf(i.id())>=0],"filter-in-small":[ai,[ii,Q(Zt)],(i,[e,r])=>r.value.indexOf(i.properties()[e.value])>=0],"filter-in-large":[ai,[ii,Q(Zt)],(i,[e,r])=>function(o,f,w,C){for(;w<=C;){const I=w+C>>1;if(f[I]===o)return!0;f[I]>o?C=I-1:w=I+1}return!1}(i.properties()[e.value],r.value,0,r.value.length-1)],all:{type:ai,overloads:[[[ai,ai],(i,[e,r])=>e.evaluate(i)&&r.evaluate(i)],[ls(ai),(i,e)=>{for(const r of e)if(!r.evaluate(i))return!1;return!0}]]},any:{type:ai,overloads:[[[ai,ai],(i,[e,r])=>e.evaluate(i)||r.evaluate(i)],[ls(ai),(i,e)=>{for(const r of e)if(r.evaluate(i))return!0;return!1}]]},"!":[ai,[ai],(i,[e])=>!e.evaluate(i)],"is-supported-script":[ai,[ii],(i,[e])=>{const r=i.globals&&i.globals.isSupportedScript;return!r||r(e.evaluate(i))}],upcase:[ii,[ii],(i,[e])=>e.evaluate(i).toUpperCase()],downcase:[ii,[ii],(i,[e])=>e.evaluate(i).toLowerCase()],concat:[ii,ls(Zt),(i,e)=>e.map(r=>ho(r.evaluate(i))).join("")],"resolved-locale":[ii,[Zi],(i,[e])=>e.evaluate(i).resolvedLocale()]});class Ni{constructor(e,r){var o;this.expression=e,this._warningHistory={},this._evaluator=new Wi,this._defaultValue=r?(o=r).type==="color"&&Uo(o.default)?new Vi(0,0,0,0):o.type==="color"?Vi.parse(o.default)||null:o.type==="padding"?sn.parse(o.default)||null:o.type==="variableAnchorOffsetCollection"?Cr.parse(o.default)||null:o.default===void 0?null:o.default:null,this._enumValues=r&&r.type==="enum"?r.values:null}evaluateWithoutErrorHandling(e,r,o,f,w,C){return this._evaluator.globals=e,this._evaluator.feature=r,this._evaluator.featureState=o,this._evaluator.canonical=f,this._evaluator.availableImages=w||null,this._evaluator.formattedSection=C,this.expression.evaluate(this._evaluator)}evaluate(e,r,o,f,w,C){this._evaluator.globals=e,this._evaluator.feature=r||null,this._evaluator.featureState=o||null,this._evaluator.canonical=f,this._evaluator.availableImages=w||null,this._evaluator.formattedSection=C||null;try{const I=this.expression.evaluate(this._evaluator);if(I==null||typeof I=="number"&&I!=I)return this._defaultValue;if(this._enumValues&&!(I in this._enumValues))throw new or(`Expected value to be one of ${Object.keys(this._enumValues).map(O=>JSON.stringify(O)).join(", ")}, but found ${JSON.stringify(I)} instead.`);return I}catch(I){return this._warningHistory[I.message]||(this._warningHistory[I.message]=!0,typeof console<"u"&&console.warn(I.message)),this._defaultValue}}}function Ki(i){return Array.isArray(i)&&i.length>0&&typeof i[0]=="string"&&i[0]in $s}function Zn(i,e){const r=new Mo($s,gr,[],e?function(f){const w={color:Hi,string:ii,number:Et,enum:ii,boolean:ai,formatted:$i,padding:ae,resolvedImage:H,variableAnchorOffsetCollection:q};return f.type==="array"?Q(w[f.value]||Zt,f.length):w[f.type]}(e):void 0),o=r.parse(i,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return o?Vo(new Ni(o,e)):bs(r.errors)}class ws{constructor(e,r){this.kind=e,this._styleExpression=r,this.isStateDependent=e!=="constant"&&!Ms(r.expression)}evaluateWithoutErrorHandling(e,r,o,f,w,C){return this._styleExpression.evaluateWithoutErrorHandling(e,r,o,f,w,C)}evaluate(e,r,o,f,w,C){return this._styleExpression.evaluate(e,r,o,f,w,C)}}class Go{constructor(e,r,o,f){this.kind=e,this.zoomStops=o,this._styleExpression=r,this.isStateDependent=e!=="camera"&&!Ms(r.expression),this.interpolationType=f}evaluateWithoutErrorHandling(e,r,o,f,w,C){return this._styleExpression.evaluateWithoutErrorHandling(e,r,o,f,w,C)}evaluate(e,r,o,f,w,C){return this._styleExpression.evaluate(e,r,o,f,w,C)}interpolationFactor(e,r,o){return this.interpolationType?Vr.interpolationFactor(this.interpolationType,e,r,o):0}}function ma(i,e){const r=Zn(i,e);if(r.result==="error")return r;const o=r.value.expression,f=dr(o);if(!f&&!Yn(e))return bs([new Xi("","data expressions not supported")]);const w=mo(o,["zoom"]);if(!w&&!Za(e))return bs([new Xi("","zoom expressions not supported")]);const C=Wo(o);return C||w?C instanceof Xi?bs([C]):C instanceof Vr&&!fa(e)?bs([new Xi("",'"interpolate" expressions cannot be used with this property')]):Vo(C?new Go(f?"camera":"composite",r.value,C.labels,C instanceof Vr?C.interpolation:void 0):new ws(f?"constant":"source",r.value)):bs([new Xi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Ho{constructor(e,r){this._parameters=e,this._specification=r,Gi(this,pa(this._parameters,this._specification))}static deserialize(e){return new Ho(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Wo(i){let e=null;if(i instanceof Oo)e=Wo(i.result);else if(i instanceof ko){for(const r of i.args)if(e=Wo(r),e)break}else(i instanceof Xs||i instanceof Vr)&&i.input instanceof Ai&&i.input.name==="zoom"&&(e=i);return e instanceof Xi||i.eachChild(r=>{const o=Wo(r);o instanceof Xi?e=o:!e&&o?e=new Xi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&o&&e!==o&&(e=new Xi("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}function _o(i){if(i===!0||i===!1)return!0;if(!Array.isArray(i)||i.length===0)return!1;switch(i[0]){case"has":return i.length>=2&&i[1]!=="$id"&&i[1]!=="$type";case"in":return i.length>=3&&(typeof i[1]!="string"||Array.isArray(i[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return i.length!==3||Array.isArray(i[1])||Array.isArray(i[2]);case"any":case"all":for(const e of i.slice(1))if(!_o(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}const ga={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function Ls(i){if(i==null)return{filter:()=>!0,needGeometry:!1};_o(i)||(i=Bn(i));const e=Zn(i,ga);if(e.result==="error")throw new Error(e.value.map(r=>`${r.key}: ${r.message}`).join(", "));return{filter:(r,o,f)=>e.value.evaluate(r,o,{},f),needGeometry:Xo(i)}}function zs(i,e){return i<e?-1:i>e?1:0}function Xo(i){if(!Array.isArray(i))return!1;if(i[0]==="within")return!0;for(let e=1;e<i.length;e++)if(Xo(i[e]))return!0;return!1}function Bn(i){if(!i)return!0;const e=i[0];return i.length<=1?e!=="any":e==="=="?_a(i[1],i[2],"=="):e==="!="?qo(_a(i[1],i[2],"==")):e==="<"||e===">"||e==="<="||e===">="?_a(i[1],i[2],e):e==="any"?(r=i.slice(1),["any"].concat(r.map(Bn))):e==="all"?["all"].concat(i.slice(1).map(Bn)):e==="none"?["all"].concat(i.slice(1).map(Bn).map(qo)):e==="in"?Cs(i[1],i.slice(2)):e==="!in"?qo(Cs(i[1],i.slice(2))):e==="has"?ya(i[1]):e==="!has"?qo(ya(i[1])):e!=="within"||i;var r}function _a(i,e,r){switch(i){case"$type":return[`filter-type-${r}`,e];case"$id":return[`filter-id-${r}`,e];default:return[`filter-${r}`,i,e]}}function Cs(i,e){if(e.length===0)return!1;switch(i){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(r=>typeof r!=typeof e[0])?["filter-in-large",i,["literal",e.sort(zs)]]:["filter-in-small",i,["literal",e]]}}function ya(i){switch(i){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",i]}}function qo(i){return["!",i]}function Zs(i){const e=typeof i;if(e==="number"||e==="boolean"||e==="string"||i==null)return JSON.stringify(i);if(Array.isArray(i)){let f="[";for(const w of i)f+=`${Zs(w)},`;return`${f}]`}const r=Object.keys(i).sort();let o="{";for(let f=0;f<r.length;f++)o+=`${JSON.stringify(r[f])}:${Zs(i[r[f]])},`;return`${o}}`}function va(i){let e="";for(const r of ft)e+=`/${Zs(i[r])}`;return e}function xa(i){const e=i.value;return e?[new ut(i.key,e,"constants have been deprecated as of v8")]:[]}function lr(i){return i instanceof Number||i instanceof String||i instanceof Boolean?i.valueOf():i}function hs(i){if(Array.isArray(i))return i.map(hs);if(i instanceof Object&&!(i instanceof Number||i instanceof String||i instanceof Boolean)){const e={};for(const r in i)e[r]=hs(i[r]);return e}return lr(i)}function Or(i){const e=i.key,r=i.value,o=i.valueSpec||{},f=i.objectElementValidators||{},w=i.style,C=i.styleSpec,I=i.validateSpec;let O=[];const z=zi(r);if(z!=="object")return[new ut(e,r,`object expected, ${z} found`)];for(const B in r){const N=B.split(".")[0],W=o[N]||o["*"];let Z;if(f[N])Z=f[N];else if(o[N])Z=I;else if(f["*"])Z=f["*"];else{if(!o["*"]){O.push(new ut(e,r[B],`unknown property "${B}"`));continue}Z=I}O=O.concat(Z({key:(e&&`${e}.`)+B,value:r[B],valueSpec:W,style:w,styleSpec:C,object:r,objectKey:B,validateSpec:I},r))}for(const B in o)f[B]||o[B].required&&o[B].default===void 0&&r[B]===void 0&&O.push(new ut(e,r,`missing required property "${B}"`));return O}function $o(i){const e=i.value,r=i.valueSpec,o=i.style,f=i.styleSpec,w=i.key,C=i.arrayElementValidator||i.validateSpec;if(zi(e)!=="array")return[new ut(w,e,`array expected, ${zi(e)} found`)];if(r.length&&e.length!==r.length)return[new ut(w,e,`array length ${r.length} expected, length ${e.length} found`)];if(r["min-length"]&&e.length<r["min-length"])return[new ut(w,e,`array length at least ${r["min-length"]} expected, length ${e.length} found`)];let I={type:r.value,values:r.values};f.$version<7&&(I.function=r.function),zi(r.value)==="object"&&(I=r.value);let O=[];for(let z=0;z<e.length;z++)O=O.concat(C({array:e,arrayIndex:z,value:e[z],valueSpec:I,validateSpec:i.validateSpec,style:o,styleSpec:f,key:`${w}[${z}]`}));return O}function Yo(i){const e=i.key,r=i.value,o=i.valueSpec;let f=zi(r);return f==="number"&&r!=r&&(f="NaN"),f!=="number"?[new ut(e,r,`number expected, ${f} found`)]:"minimum"in o&&r<o.minimum?[new ut(e,r,`${r} is less than the minimum value ${o.minimum}`)]:"maximum"in o&&r>o.maximum?[new ut(e,r,`${r} is greater than the maximum value ${o.maximum}`)]:[]}function Be(i){const e=i.valueSpec,r=lr(i.value.type);let o,f,w,C={};const I=r!=="categorical"&&i.value.property===void 0,O=!I,z=zi(i.value.stops)==="array"&&zi(i.value.stops[0])==="array"&&zi(i.value.stops[0][0])==="object",B=Or({key:i.key,value:i.value,valueSpec:i.styleSpec.function,validateSpec:i.validateSpec,style:i.style,styleSpec:i.styleSpec,objectElementValidators:{stops:function(Z){if(r==="identity")return[new ut(Z.key,Z.value,'identity function may not have a "stops" property')];let J=[];const se=Z.value;return J=J.concat($o({key:Z.key,value:se,valueSpec:Z.valueSpec,validateSpec:Z.validateSpec,style:Z.style,styleSpec:Z.styleSpec,arrayElementValidator:N})),zi(se)==="array"&&se.length===0&&J.push(new ut(Z.key,se,"array must have at least one stop")),J},default:function(Z){return Z.validateSpec({key:Z.key,value:Z.value,valueSpec:e,validateSpec:Z.validateSpec,style:Z.style,styleSpec:Z.styleSpec})}}});return r==="identity"&&I&&B.push(new ut(i.key,i.value,'missing required property "property"')),r==="identity"||i.value.stops||B.push(new ut(i.key,i.value,'missing required property "stops"')),r==="exponential"&&i.valueSpec.expression&&!fa(i.valueSpec)&&B.push(new ut(i.key,i.value,"exponential functions not supported")),i.styleSpec.$version>=8&&(O&&!Yn(i.valueSpec)?B.push(new ut(i.key,i.value,"property functions not supported")):I&&!Za(i.valueSpec)&&B.push(new ut(i.key,i.value,"zoom functions not supported"))),r!=="categorical"&&!z||i.value.property!==void 0||B.push(new ut(i.key,i.value,'"property" property is required')),B;function N(Z){let J=[];const se=Z.value,de=Z.key;if(zi(se)!=="array")return[new ut(de,se,`array expected, ${zi(se)} found`)];if(se.length!==2)return[new ut(de,se,`array length 2 expected, length ${se.length} found`)];if(z){if(zi(se[0])!=="object")return[new ut(de,se,`object expected, ${zi(se[0])} found`)];if(se[0].zoom===void 0)return[new ut(de,se,"object stop key must have zoom")];if(se[0].value===void 0)return[new ut(de,se,"object stop key must have value")];if(w&&w>lr(se[0].zoom))return[new ut(de,se[0].zoom,"stop zoom values must appear in ascending order")];lr(se[0].zoom)!==w&&(w=lr(se[0].zoom),f=void 0,C={}),J=J.concat(Or({key:`${de}[0]`,value:se[0],valueSpec:{zoom:{}},validateSpec:Z.validateSpec,style:Z.style,styleSpec:Z.styleSpec,objectElementValidators:{zoom:Yo,value:W}}))}else J=J.concat(W({key:`${de}[0]`,value:se[0],valueSpec:{},validateSpec:Z.validateSpec,style:Z.style,styleSpec:Z.styleSpec},se));return Ki(hs(se[1]))?J.concat([new ut(`${de}[1]`,se[1],"expressions are not allowed in function stops.")]):J.concat(Z.validateSpec({key:`${de}[1]`,value:se[1],valueSpec:e,validateSpec:Z.validateSpec,style:Z.style,styleSpec:Z.styleSpec}))}function W(Z,J){const se=zi(Z.value),de=lr(Z.value),Ce=Z.value!==null?Z.value:J;if(o){if(se!==o)return[new ut(Z.key,Ce,`${se} stop domain type must match previous stop domain type ${o}`)]}else o=se;if(se!=="number"&&se!=="string"&&se!=="boolean")return[new ut(Z.key,Ce,"stop domain value must be a number, string, or boolean")];if(se!=="number"&&r!=="categorical"){let Ve=`number expected, ${se} found`;return Yn(e)&&r===void 0&&(Ve+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new ut(Z.key,Ce,Ve)]}return r!=="categorical"||se!=="number"||isFinite(de)&&Math.floor(de)===de?r!=="categorical"&&se==="number"&&f!==void 0&&de<f?[new ut(Z.key,Ce,"stop domain values must appear in ascending order")]:(f=de,r==="categorical"&&de in C?[new ut(Z.key,Ce,"stop domain values must be unique")]:(C[de]=!0,[])):[new ut(Z.key,Ce,`integer expected, found ${de}`)]}}function tt(i){const e=(i.expressionContext==="property"?ma:Zn)(hs(i.value),i.valueSpec);if(e.result==="error")return e.value.map(o=>new ut(`${i.key}${o.key}`,i.value,o.message));const r=e.value.expression||e.value._styleExpression.expression;if(i.expressionContext==="property"&&i.propertyKey==="text-font"&&!r.outputDefined())return[new ut(i.key,i.value,`Invalid data expression for "${i.propertyKey}". Output values must be contained as literals within the expression.`)];if(i.expressionContext==="property"&&i.propertyType==="layout"&&!Ms(r))return[new ut(i.key,i.value,'"feature-state" data expressions are not supported with layout properties.')];if(i.expressionContext==="filter"&&!Ms(r))return[new ut(i.key,i.value,'"feature-state" data expressions are not supported with filters.')];if(i.expressionContext&&i.expressionContext.indexOf("cluster")===0){if(!mo(r,["zoom","feature-state"]))return[new ut(i.key,i.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(i.expressionContext==="cluster-initial"&&!dr(r))return[new ut(i.key,i.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Rt(i){const e=i.key,r=i.value,o=i.valueSpec,f=[];return Array.isArray(o.values)?o.values.indexOf(lr(r))===-1&&f.push(new ut(e,r,`expected one of [${o.values.join(", ")}], ${JSON.stringify(r)} found`)):Object.keys(o.values).indexOf(lr(r))===-1&&f.push(new ut(e,r,`expected one of [${Object.keys(o.values).join(", ")}], ${JSON.stringify(r)} found`)),f}function oi(i){return _o(hs(i.value))?tt(Gi({},i,{expressionContext:"filter",valueSpec:{value:"boolean"}})):tr(i)}function tr(i){const e=i.value,r=i.key;if(zi(e)!=="array")return[new ut(r,e,`array expected, ${zi(e)} found`)];const o=i.styleSpec;let f,w=[];if(e.length<1)return[new ut(r,e,"filter array must have at least 1 element")];switch(w=w.concat(Rt({key:`${r}[0]`,value:e[0],valueSpec:o.filter_operator,style:i.style,styleSpec:i.styleSpec})),lr(e[0])){case"<":case"<=":case">":case">=":e.length>=2&&lr(e[1])==="$type"&&w.push(new ut(r,e,`"$type" cannot be use with operator "${e[0]}"`));case"==":case"!=":e.length!==3&&w.push(new ut(r,e,`filter array for operator "${e[0]}" must have 3 elements`));case"in":case"!in":e.length>=2&&(f=zi(e[1]),f!=="string"&&w.push(new ut(`${r}[1]`,e[1],`string expected, ${f} found`)));for(let C=2;C<e.length;C++)f=zi(e[C]),lr(e[1])==="$type"?w=w.concat(Rt({key:`${r}[${C}]`,value:e[C],valueSpec:o.geometry_type,style:i.style,styleSpec:i.styleSpec})):f!=="string"&&f!=="number"&&f!=="boolean"&&w.push(new ut(`${r}[${C}]`,e[C],`string, number, or boolean expected, ${f} found`));break;case"any":case"all":case"none":for(let C=1;C<e.length;C++)w=w.concat(tr({key:`${r}[${C}]`,value:e[C],style:i.style,styleSpec:i.styleSpec}));break;case"has":case"!has":f=zi(e[1]),e.length!==2?w.push(new ut(r,e,`filter array for "${e[0]}" operator must have 2 elements`)):f!=="string"&&w.push(new ut(`${r}[1]`,e[1],`string expected, ${f} found`));break;case"within":f=zi(e[1]),e.length!==2?w.push(new ut(r,e,`filter array for "${e[0]}" operator must have 2 elements`)):f!=="object"&&w.push(new ut(`${r}[1]`,e[1],`object expected, ${f} found`))}return w}function Oi(i,e){const r=i.key,o=i.validateSpec,f=i.style,w=i.styleSpec,C=i.value,I=i.objectKey,O=w[`${e}_${i.layerType}`];if(!O)return[];const z=I.match(/^(.*)-transition$/);if(e==="paint"&&z&&O[z[1]]&&O[z[1]].transition)return o({key:r,value:C,valueSpec:w.transition,style:f,styleSpec:w});const B=i.valueSpec||O[I];if(!B)return[new ut(r,C,`unknown property "${I}"`)];let N;if(zi(C)==="string"&&Yn(B)&&!B.tokens&&(N=/^{([^}]+)}$/.exec(C)))return[new ut(r,C,`"${I}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(N[1])} }\`.`)];const W=[];return i.layerType==="symbol"&&(I==="text-field"&&f&&!f.glyphs&&W.push(new ut(r,C,'use of "text-field" requires a style "glyphs" property')),I==="text-font"&&Uo(hs(C))&&lr(C.type)==="identity"&&W.push(new ut(r,C,'"text-font" does not support identity functions'))),W.concat(o({key:i.key,value:C,valueSpec:B,style:f,styleSpec:w,expressionContext:"property",propertyType:e,propertyKey:I}))}function cr(i){return Oi(i,"paint")}function _r(i){return Oi(i,"layout")}function cn(i){let e=[];const r=i.value,o=i.key,f=i.style,w=i.styleSpec;r.type||r.ref||e.push(new ut(o,r,'either "type" or "ref" is required'));let C=lr(r.type);const I=lr(r.ref);if(r.id){const O=lr(r.id);for(let z=0;z<i.arrayIndex;z++){const B=f.layers[z];lr(B.id)===O&&e.push(new ut(o,r.id,`duplicate layer id "${r.id}", previously used at line ${B.id.__line__}`))}}if("ref"in r){let O;["type","source","source-layer","filter","layout"].forEach(z=>{z in r&&e.push(new ut(o,r[z],`"${z}" is prohibited for ref layers`))}),f.layers.forEach(z=>{lr(z.id)===I&&(O=z)}),O?O.ref?e.push(new ut(o,r.ref,"ref cannot reference another ref layer")):C=lr(O.type):e.push(new ut(o,r.ref,`ref layer "${I}" not found`))}else if(C!=="background")if(r.source){const O=f.sources&&f.sources[r.source],z=O&&lr(O.type);O?z==="vector"&&C==="raster"?e.push(new ut(o,r.source,`layer "${r.id}" requires a raster source`)):z!=="raster-dem"&&C==="hillshade"?e.push(new ut(o,r.source,`layer "${r.id}" requires a raster-dem source`)):z==="raster"&&C!=="raster"?e.push(new ut(o,r.source,`layer "${r.id}" requires a vector source`)):z!=="vector"||r["source-layer"]?z==="raster-dem"&&C!=="hillshade"?e.push(new ut(o,r.source,"raster-dem source can only be used with layer type 'hillshade'.")):C!=="line"||!r.paint||!r.paint["line-gradient"]||z==="geojson"&&O.lineMetrics||e.push(new ut(o,r,`layer "${r.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):e.push(new ut(o,r,`layer "${r.id}" must specify a "source-layer"`)):e.push(new ut(o,r.source,`source "${r.source}" not found`))}else e.push(new ut(o,r,'missing required property "source"'));return e=e.concat(Or({key:o,value:r,valueSpec:w.layer,style:i.style,styleSpec:i.styleSpec,validateSpec:i.validateSpec,objectElementValidators:{"*":()=>[],type:()=>i.validateSpec({key:`${o}.type`,value:r.type,valueSpec:w.layer.type,style:i.style,styleSpec:i.styleSpec,validateSpec:i.validateSpec,object:r,objectKey:"type"}),filter:oi,layout:O=>Or({layer:r,key:O.key,value:O.value,style:O.style,styleSpec:O.styleSpec,validateSpec:O.validateSpec,objectElementValidators:{"*":z=>_r(Gi({layerType:C},z))}}),paint:O=>Or({layer:r,key:O.key,value:O.value,style:O.style,styleSpec:O.styleSpec,validateSpec:O.validateSpec,objectElementValidators:{"*":z=>cr(Gi({layerType:C},z))}})}})),e}function sr(i){const e=i.value,r=i.key,o=zi(e);return o!=="string"?[new ut(r,e,`string expected, ${o} found`)]:[]}const Ar={promoteId:function({key:i,value:e}){if(zi(e)==="string")return sr({key:i,value:e});{const r=[];for(const o in e)r.push(...sr({key:`${i}.${o}`,value:e[o]}));return r}}};function jn(i){const e=i.value,r=i.key,o=i.styleSpec,f=i.style,w=i.validateSpec;if(!e.type)return[new ut(r,e,'"type" is required')];const C=lr(e.type);let I;switch(C){case"vector":case"raster":return I=Or({key:r,value:e,valueSpec:o[`source_${C.replace("-","_")}`],style:i.style,styleSpec:o,objectElementValidators:Ar,validateSpec:w}),I;case"raster-dem":return I=function(O){var z;const B=(z=O.sourceName)!==null&&z!==void 0?z:"",N=O.value,W=O.styleSpec,Z=W.source_raster_dem,J=O.style;let se=[];const de=zi(N);if(N===void 0)return se;if(de!=="object")return se.push(new ut("source_raster_dem",N,`object expected, ${de} found`)),se;const Ce=lr(N.encoding)==="custom",Ve=["redFactor","greenFactor","blueFactor","baseShift"],Se=O.value.encoding?`"${O.value.encoding}"`:"Default";for(const De in N)!Ce&&Ve.includes(De)?se.push(new ut(De,N[De],`In "${B}": "${De}" is only valid when "encoding" is set to "custom". ${Se} encoding found`)):Z[De]?se=se.concat(O.validateSpec({key:De,value:N[De],valueSpec:Z[De],validateSpec:O.validateSpec,style:J,styleSpec:W})):se.push(new ut(De,N[De],`unknown property "${De}"`));return se}({sourceName:r,value:e,style:i.style,styleSpec:o,validateSpec:w}),I;case"geojson":if(I=Or({key:r,value:e,valueSpec:o.source_geojson,style:f,styleSpec:o,validateSpec:w,objectElementValidators:Ar}),e.cluster)for(const O in e.clusterProperties){const[z,B]=e.clusterProperties[O],N=typeof z=="string"?[z,["accumulated"],["get",O]]:z;I.push(...tt({key:`${r}.${O}.map`,value:B,validateSpec:w,expressionContext:"cluster-map"})),I.push(...tt({key:`${r}.${O}.reduce`,value:N,validateSpec:w,expressionContext:"cluster-reduce"}))}return I;case"video":return Or({key:r,value:e,valueSpec:o.source_video,style:f,validateSpec:w,styleSpec:o});case"image":return Or({key:r,value:e,valueSpec:o.source_image,style:f,validateSpec:w,styleSpec:o});case"canvas":return[new ut(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Rt({key:`${r}.type`,value:e.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:f,validateSpec:w,styleSpec:o})}}function Kn(i){const e=i.value,r=i.styleSpec,o=r.light,f=i.style;let w=[];const C=zi(e);if(e===void 0)return w;if(C!=="object")return w=w.concat([new ut("light",e,`object expected, ${C} found`)]),w;for(const I in e){const O=I.match(/^(.*)-transition$/);w=w.concat(O&&o[O[1]]&&o[O[1]].transition?i.validateSpec({key:I,value:e[I],valueSpec:r.transition,validateSpec:i.validateSpec,style:f,styleSpec:r}):o[I]?i.validateSpec({key:I,value:e[I],valueSpec:o[I],validateSpec:i.validateSpec,style:f,styleSpec:r}):[new ut(I,e[I],`unknown property "${I}"`)])}return w}function en(i){const e=i.value,r=i.styleSpec,o=r.sky,f=i.style,w=zi(e);if(e===void 0)return[];if(w!=="object")return[new ut("sky",e,`object expected, ${w} found`)];let C=[];for(const I in e)C=C.concat(o[I]?hn({key:I,value:e[I],valueSpec:o[I],style:f,styleSpec:r}):[new ut(I,e[I],`unknown property "${I}"`)]);return C}function _n(i){const e=i.value,r=i.styleSpec,o=r.terrain,f=i.style;let w=[];const C=zi(e);if(e===void 0)return w;if(C!=="object")return w=w.concat([new ut("terrain",e,`object expected, ${C} found`)]),w;for(const I in e)w=w.concat(o[I]?i.validateSpec({key:I,value:e[I],valueSpec:o[I],validateSpec:i.validateSpec,style:f,styleSpec:r}):[new ut(I,e[I],`unknown property "${I}"`)]);return w}function Jn(i){let e=[];const r=i.value,o=i.key;if(Array.isArray(r)){const f=[],w=[];for(const C in r)r[C].id&&f.includes(r[C].id)&&e.push(new ut(o,r,`all the sprites' ids must be unique, but ${r[C].id} is duplicated`)),f.push(r[C].id),r[C].url&&w.includes(r[C].url)&&e.push(new ut(o,r,`all the sprites' URLs must be unique, but ${r[C].url} is duplicated`)),w.push(r[C].url),e=e.concat(Or({key:`${o}[${C}]`,value:r[C],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:i.validateSpec}));return e}return sr({key:o,value:r})}const Ur={"*":()=>[],array:$o,boolean:function(i){const e=i.value,r=i.key,o=zi(e);return o!=="boolean"?[new ut(r,e,`boolean expected, ${o} found`)]:[]},number:Yo,color:function(i){const e=i.key,r=i.value,o=zi(r);return o!=="string"?[new ut(e,r,`color expected, ${o} found`)]:Vi.parse(String(r))?[]:[new ut(e,r,`color expected, "${r}" found`)]},constants:xa,enum:Rt,filter:oi,function:Be,layer:cn,object:Or,source:jn,light:Kn,sky:en,terrain:_n,string:sr,formatted:function(i){return sr(i).length===0?[]:tt(i)},resolvedImage:function(i){return sr(i).length===0?[]:tt(i)},padding:function(i){const e=i.key,r=i.value;if(zi(r)==="array"){if(r.length<1||r.length>4)return[new ut(e,r,`padding requires 1 to 4 values; ${r.length} values found`)];const o={type:"number"};let f=[];for(let w=0;w<r.length;w++)f=f.concat(i.validateSpec({key:`${e}[${w}]`,value:r[w],validateSpec:i.validateSpec,valueSpec:o}));return f}return Yo({key:e,value:r,valueSpec:{}})},variableAnchorOffsetCollection:function(i){const e=i.key,r=i.value,o=zi(r),f=i.styleSpec;if(o!=="array"||r.length<1||r.length%2!=0)return[new ut(e,r,"variableAnchorOffsetCollection requires a non-empty array of even length")];let w=[];for(let C=0;C<r.length;C+=2)w=w.concat(Rt({key:`${e}[${C}]`,value:r[C],valueSpec:f.layout_symbol["text-anchor"]})),w=w.concat($o({key:`${e}[${C+1}]`,value:r[C+1],valueSpec:{length:2,value:"number"},validateSpec:i.validateSpec,style:i.style,styleSpec:f}));return w},sprite:Jn};function hn(i){const e=i.value,r=i.valueSpec,o=i.styleSpec;return i.validateSpec=hn,r.expression&&Uo(lr(e))?Be(i):r.expression&&Ki(hs(e))?tt(i):r.type&&Ur[r.type]?Ur[r.type](i):Or(Gi({},i,{valueSpec:r.type?o[r.type]:r}))}function Fs(i){const e=i.value,r=i.key,o=sr(i);return o.length||(e.indexOf("{fontstack}")===-1&&o.push(new ut(r,e,'"glyphs" url must include a "{fontstack}" token')),e.indexOf("{range}")===-1&&o.push(new ut(r,e,'"glyphs" url must include a "{range}" token'))),o}function Pn(i,e=le){let r=[];return r=r.concat(hn({key:"",value:i,valueSpec:e.$root,styleSpec:e,style:i,validateSpec:hn,objectElementValidators:{glyphs:Fs,"*":()=>[]}})),i.constants&&(r=r.concat(xa({key:"constants",value:i.constants,style:i,styleSpec:e,validateSpec:hn}))),Ks(r)}function Qn(i){return function(e){return i({...e,validateSpec:hn})}}function Ks(i){return[].concat(i).sort((e,r)=>e.line-r.line)}function Di(i){return function(...e){return Ks(i.apply(this,e))}}Pn.source=Di(Qn(jn)),Pn.sprite=Di(Qn(Jn)),Pn.glyphs=Di(Qn(Fs)),Pn.light=Di(Qn(Kn)),Pn.sky=Di(Qn(en)),Pn.terrain=Di(Qn(_n)),Pn.layer=Di(Qn(cn)),Pn.filter=Di(Qn(oi)),Pn.paintProperty=Di(Qn(cr)),Pn.layoutProperty=Di(Qn(_r));const Bi=Pn,Zo=Bi.light,es=Bi.paintProperty,ba=Bi.layoutProperty;function Gr(i,e){let r=!1;if(e&&e.length)for(const o of e)i.fire(new ot(new Error(o.message))),r=!0;return r}class yn{constructor(e,r,o){const f=this.cells=[];if(e instanceof ArrayBuffer){this.arrayBuffer=e;const C=new Int32Array(this.arrayBuffer);e=C[0],this.d=(r=C[1])+2*(o=C[2]);for(let O=0;O<this.d*this.d;O++){const z=C[3+O],B=C[3+O+1];f.push(z===B?null:C.subarray(z,B))}const I=C[3+f.length+1];this.keys=C.subarray(C[3+f.length],I),this.bboxes=C.subarray(I),this.insert=this._insertReadonly}else{this.d=r+2*o;for(let C=0;C<this.d*this.d;C++)f.push([]);this.keys=[],this.bboxes=[]}this.n=r,this.extent=e,this.padding=o,this.scale=r/e,this.uid=0;const w=o/r*e;this.min=-w,this.max=e+w}insert(e,r,o,f,w){this._forEachCell(r,o,f,w,this._insertCell,this.uid++,void 0,void 0),this.keys.push(e),this.bboxes.push(r),this.bboxes.push(o),this.bboxes.push(f),this.bboxes.push(w)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(e,r,o,f,w,C){this.cells[w].push(C)}query(e,r,o,f,w){const C=this.min,I=this.max;if(e<=C&&r<=C&&I<=o&&I<=f&&!w)return Array.prototype.slice.call(this.keys);{const O=[];return this._forEachCell(e,r,o,f,this._queryCell,O,{},w),O}}_queryCell(e,r,o,f,w,C,I,O){const z=this.cells[w];if(z!==null){const B=this.keys,N=this.bboxes;for(let W=0;W<z.length;W++){const Z=z[W];if(I[Z]===void 0){const J=4*Z;(O?O(N[J+0],N[J+1],N[J+2],N[J+3]):e<=N[J+2]&&r<=N[J+3]&&o>=N[J+0]&&f>=N[J+1])?(I[Z]=!0,C.push(B[Z])):I[Z]=!1}}}}_forEachCell(e,r,o,f,w,C,I,O){const z=this._convertToCellCoord(e),B=this._convertToCellCoord(r),N=this._convertToCellCoord(o),W=this._convertToCellCoord(f);for(let Z=z;Z<=N;Z++)for(let J=B;J<=W;J++){const se=this.d*J+Z;if((!O||O(this._convertFromCellCoord(Z),this._convertFromCellCoord(J),this._convertFromCellCoord(Z+1),this._convertFromCellCoord(J+1)))&&w.call(this,e,r,o,f,se,C,I,O))return}}_convertFromCellCoord(e){return(e-this.padding)/this.scale}_convertToCellCoord(e){return Math.max(0,Math.min(this.d-1,Math.floor(e*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const e=this.cells,r=3+this.cells.length+1+1;let o=0;for(let C=0;C<this.cells.length;C++)o+=this.cells[C].length;const f=new Int32Array(r+o+this.keys.length+this.bboxes.length);f[0]=this.extent,f[1]=this.n,f[2]=this.padding;let w=r;for(let C=0;C<e.length;C++){const I=e[C];f[3+C]=w,f.set(I,w),w+=I.length}return f[3+e.length]=w,f.set(this.keys,w),w+=this.keys.length,f[3+e.length+1]=w,f.set(this.bboxes,w),w+=this.bboxes.length,f.buffer}static serialize(e,r){const o=e.toArrayBuffer();return r&&r.push(o),{buffer:o}}static deserialize(e){return new yn(e.buffer)}}const Hr={};function qt(i,e,r={}){if(Hr[i])throw new Error(`${i} is already registered.`);Object.defineProperty(e,"_classRegistryKey",{value:i,writeable:!1}),Hr[i]={klass:e,omit:r.omit||[],shallow:r.shallow||[]}}qt("Object",Object),qt("TransferableGridIndex",yn),qt("Color",Vi),qt("Error",Error),qt("AJAXError",et),qt("ResolvedImage",on),qt("StylePropertyFunction",Ho),qt("StyleExpression",Ni,{omit:["_evaluator"]}),qt("ZoomDependentExpression",Go),qt("ZoomConstantExpression",ws),qt("CompoundExpression",Ai,{omit:["_evaluate"]});for(const i in $s)$s[i]._classRegistryKey||qt(`Expression_${i}`,$s[i]);function Rs(i){return i&&typeof ArrayBuffer<"u"&&(i instanceof ArrayBuffer||i.constructor&&i.constructor.name==="ArrayBuffer")}function Nn(i,e){if(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||i instanceof Blob||i instanceof Error)return i;if(Rs(i)||bt(i))return e&&e.push(i),i;if(ArrayBuffer.isView(i)){const r=i;return e&&e.push(r.buffer),r}if(i instanceof ImageData)return e&&e.push(i.data.buffer),i;if(Array.isArray(i)){const r=[];for(const o of i)r.push(Nn(o,e));return r}if(typeof i=="object"){const r=i.constructor,o=r._classRegistryKey;if(!o)throw new Error(`can't serialize object of unregistered class ${r.name}`);if(!Hr[o])throw new Error(`${o} is not registered.`);const f=r.serialize?r.serialize(i,e):{};if(r.serialize){if(e&&f===e[e.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const w in i){if(!i.hasOwnProperty(w)||Hr[o].omit.indexOf(w)>=0)continue;const C=i[w];f[w]=Hr[o].shallow.indexOf(w)>=0?C:Nn(C,e)}i instanceof Error&&(f.message=i.message)}if(f.$name)throw new Error("$name property is reserved for worker serialization logic.");return o!=="Object"&&(f.$name=o),f}throw new Error("can't serialize object of type "+typeof i)}function An(i){if(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||i instanceof Blob||i instanceof Error||Rs(i)||bt(i)||ArrayBuffer.isView(i)||i instanceof ImageData)return i;if(Array.isArray(i))return i.map(An);if(typeof i=="object"){const e=i.$name||"Object";if(!Hr[e])throw new Error(`can't deserialize unregistered class ${e}`);const{klass:r}=Hr[e];if(!r)throw new Error(`can't deserialize unregistered class ${e}`);if(r.deserialize)return r.deserialize(i);const o=Object.create(r.prototype);for(const f of Object.keys(i)){if(f==="$name")continue;const w=i[f];o[f]=Hr[e].shallow.indexOf(f)>=0?w:An(w)}return o}throw new Error("can't deserialize object of type "+typeof i)}class wa{constructor(){this.first=!0}update(e,r){const o=Math.floor(e);return this.first?(this.first=!1,this.lastIntegerZoom=o,this.lastIntegerZoomTime=0,this.lastZoom=e,this.lastFloorZoom=o,!0):(this.lastFloorZoom>o?(this.lastIntegerZoom=o+1,this.lastIntegerZoomTime=r):this.lastFloorZoom<o&&(this.lastIntegerZoom=o,this.lastIntegerZoomTime=r),e!==this.lastZoom&&(this.lastZoom=e,this.lastFloorZoom=o,!0))}}const Vt={"Latin-1 Supplement":i=>i>=128&&i<=255,Arabic:i=>i>=1536&&i<=1791,"Arabic Supplement":i=>i>=1872&&i<=1919,"Arabic Extended-A":i=>i>=2208&&i<=2303,"Hangul Jamo":i=>i>=4352&&i<=4607,"Unified Canadian Aboriginal Syllabics":i=>i>=5120&&i<=5759,Khmer:i=>i>=6016&&i<=6143,"Unified Canadian Aboriginal Syllabics Extended":i=>i>=6320&&i<=6399,"General Punctuation":i=>i>=8192&&i<=8303,"Letterlike Symbols":i=>i>=8448&&i<=8527,"Number Forms":i=>i>=8528&&i<=8591,"Miscellaneous Technical":i=>i>=8960&&i<=9215,"Control Pictures":i=>i>=9216&&i<=9279,"Optical Character Recognition":i=>i>=9280&&i<=9311,"Enclosed Alphanumerics":i=>i>=9312&&i<=9471,"Geometric Shapes":i=>i>=9632&&i<=9727,"Miscellaneous Symbols":i=>i>=9728&&i<=9983,"Miscellaneous Symbols and Arrows":i=>i>=11008&&i<=11263,"CJK Radicals Supplement":i=>i>=11904&&i<=12031,"Kangxi Radicals":i=>i>=12032&&i<=12255,"Ideographic Description Characters":i=>i>=12272&&i<=12287,"CJK Symbols and Punctuation":i=>i>=12288&&i<=12351,Hiragana:i=>i>=12352&&i<=12447,Katakana:i=>i>=12448&&i<=12543,Bopomofo:i=>i>=12544&&i<=12591,"Hangul Compatibility Jamo":i=>i>=12592&&i<=12687,Kanbun:i=>i>=12688&&i<=12703,"Bopomofo Extended":i=>i>=12704&&i<=12735,"CJK Strokes":i=>i>=12736&&i<=12783,"Katakana Phonetic Extensions":i=>i>=12784&&i<=12799,"Enclosed CJK Letters and Months":i=>i>=12800&&i<=13055,"CJK Compatibility":i=>i>=13056&&i<=13311,"CJK Unified Ideographs Extension A":i=>i>=13312&&i<=19903,"Yijing Hexagram Symbols":i=>i>=19904&&i<=19967,"CJK Unified Ideographs":i=>i>=19968&&i<=40959,"Yi Syllables":i=>i>=40960&&i<=42127,"Yi Radicals":i=>i>=42128&&i<=42191,"Hangul Jamo Extended-A":i=>i>=43360&&i<=43391,"Hangul Syllables":i=>i>=44032&&i<=55215,"Hangul Jamo Extended-B":i=>i>=55216&&i<=55295,"Private Use Area":i=>i>=57344&&i<=63743,"CJK Compatibility Ideographs":i=>i>=63744&&i<=64255,"Arabic Presentation Forms-A":i=>i>=64336&&i<=65023,"Vertical Forms":i=>i>=65040&&i<=65055,"CJK Compatibility Forms":i=>i>=65072&&i<=65103,"Small Form Variants":i=>i>=65104&&i<=65135,"Arabic Presentation Forms-B":i=>i>=65136&&i<=65279,"Halfwidth and Fullwidth Forms":i=>i>=65280&&i<=65519};function Ss(i){for(const e of i)if(xo(e.charCodeAt(0)))return!0;return!1}function yo(i){for(const e of i)if(!vo(e.charCodeAt(0)))return!1;return!0}function vo(i){return!(Vt.Arabic(i)||Vt["Arabic Supplement"](i)||Vt["Arabic Extended-A"](i)||Vt["Arabic Presentation Forms-A"](i)||Vt["Arabic Presentation Forms-B"](i))}function xo(i){return!(i!==746&&i!==747&&(i<4352||!(Vt["Bopomofo Extended"](i)||Vt.Bopomofo(i)||Vt["CJK Compatibility Forms"](i)&&!(i>=65097&&i<=65103)||Vt["CJK Compatibility Ideographs"](i)||Vt["CJK Compatibility"](i)||Vt["CJK Radicals Supplement"](i)||Vt["CJK Strokes"](i)||!(!Vt["CJK Symbols and Punctuation"](i)||i>=12296&&i<=12305||i>=12308&&i<=12319||i===12336)||Vt["CJK Unified Ideographs Extension A"](i)||Vt["CJK Unified Ideographs"](i)||Vt["Enclosed CJK Letters and Months"](i)||Vt["Hangul Compatibility Jamo"](i)||Vt["Hangul Jamo Extended-A"](i)||Vt["Hangul Jamo Extended-B"](i)||Vt["Hangul Jamo"](i)||Vt["Hangul Syllables"](i)||Vt.Hiragana(i)||Vt["Ideographic Description Characters"](i)||Vt.Kanbun(i)||Vt["Kangxi Radicals"](i)||Vt["Katakana Phonetic Extensions"](i)||Vt.Katakana(i)&&i!==12540||!(!Vt["Halfwidth and Fullwidth Forms"](i)||i===65288||i===65289||i===65293||i>=65306&&i<=65310||i===65339||i===65341||i===65343||i>=65371&&i<=65503||i===65507||i>=65512&&i<=65519)||!(!Vt["Small Form Variants"](i)||i>=65112&&i<=65118||i>=65123&&i<=65126)||Vt["Unified Canadian Aboriginal Syllabics"](i)||Vt["Unified Canadian Aboriginal Syllabics Extended"](i)||Vt["Vertical Forms"](i)||Vt["Yijing Hexagram Symbols"](i)||Vt["Yi Syllables"](i)||Vt["Yi Radicals"](i))))}function Js(i){return!(xo(i)||function(e){return!!(Vt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Vt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Vt["Letterlike Symbols"](e)||Vt["Number Forms"](e)||Vt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Vt["Control Pictures"](e)&&e!==9251||Vt["Optical Character Recognition"](e)||Vt["Enclosed Alphanumerics"](e)||Vt["Geometric Shapes"](e)||Vt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Vt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Vt["CJK Symbols and Punctuation"](e)||Vt.Katakana(e)||Vt["Private Use Area"](e)||Vt["CJK Compatibility Forms"](e)||Vt["Small Form Variants"](e)||Vt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(i))}function Bs(i){return i>=1424&&i<=2303||Vt["Arabic Presentation Forms-A"](i)||Vt["Arabic Presentation Forms-B"](i)}function oc(i,e){return!(!e&&Bs(i)||i>=2304&&i<=3583||i>=3840&&i<=4255||Vt.Khmer(i))}function Gc(i){for(const e of i)if(Bs(e.charCodeAt(0)))return!0;return!1}const Qs=new class{constructor(){this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null}setState(i){this.pluginStatus=i.pluginStatus,this.pluginURL=i.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(i){this.applyArabicShaping=i.applyArabicShaping,this.processBidirectionalText=i.processBidirectionalText,this.processStyledBidirectionalText=i.processStyledBidirectionalText}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getPluginURL(){return this.pluginURL}getRTLTextPluginStatus(){return this.pluginStatus}};class fr{constructor(e,r){this.zoom=e,r?(this.now=r.now,this.fadeDuration=r.fadeDuration,this.zoomHistory=r.zoomHistory,this.transition=r.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new wa,this.transition={})}isSupportedScript(e){return function(r,o){for(const f of r)if(!oc(f.charCodeAt(0),o))return!1;return!0}(e,Qs.getRTLTextPluginStatus()==="loaded")}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const e=this.zoom,r=e-Math.floor(e),o=this.crossFadingFactor();return e>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:r+(1-r)*o}:{fromScale:.5,toScale:1,t:1-(1-o)*r}}}class Ca{constructor(e,r){this.property=e,this.value=r,this.expression=function(o,f){if(Uo(o))return new Ho(o,f);if(Ki(o)){const w=ma(o,f);if(w.result==="error")throw new Error(w.value.map(C=>`${C.key}: ${C.message}`).join(", "));return w.value}{let w=o;return f.type==="color"&&typeof o=="string"?w=Vi.parse(o):f.type!=="padding"||typeof o!="number"&&!Array.isArray(o)?f.type==="variableAnchorOffsetCollection"&&Array.isArray(o)&&(w=Cr.parse(o)):w=sn.parse(o),{kind:"constant",evaluate:()=>w}}}(r===void 0?e.specification.default:r,e.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,r,o){return this.property.possiblyEvaluate(this,e,r,o)}}class Ka{constructor(e){this.property=e,this.value=new Ca(e,void 0)}transitioned(e,r){return new ac(this.property,this.value,r,ie({},e.transition,this.transition),e.now)}untransitioned(){return new ac(this.property,this.value,null,{},0)}}class El{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues)}getValue(e){return Ze(this._values[e].value.value)}setValue(e,r){Object.prototype.hasOwnProperty.call(this._values,e)||(this._values[e]=new Ka(this._values[e].property)),this._values[e].value=new Ca(this._values[e].property,r===null?void 0:Ze(r))}getTransition(e){return Ze(this._values[e].transition)}setTransition(e,r){Object.prototype.hasOwnProperty.call(this._values,e)||(this._values[e]=new Ka(this._values[e].property)),this._values[e].transition=Ze(r)||void 0}serialize(){const e={};for(const r of Object.keys(this._values)){const o=this.getValue(r);o!==void 0&&(e[r]=o);const f=this.getTransition(r);f!==void 0&&(e[`${r}-transition`]=f)}return e}transitioned(e,r){const o=new lc(this._properties);for(const f of Object.keys(this._values))o._values[f]=this._values[f].transitioned(e,r._values[f]);return o}untransitioned(){const e=new lc(this._properties);for(const r of Object.keys(this._values))e._values[r]=this._values[r].untransitioned();return e}}class ac{constructor(e,r,o,f,w){this.property=e,this.value=r,this.begin=w+f.delay||0,this.end=this.begin+f.duration||0,e.specification.transition&&(f.delay||f.duration)&&(this.prior=o)}possiblyEvaluate(e,r,o){const f=e.now||0,w=this.value.possiblyEvaluate(e,r,o),C=this.prior;if(C){if(f>this.end)return this.prior=null,w;if(this.value.isDataDriven())return this.prior=null,w;if(f<this.begin)return C.possiblyEvaluate(e,r,o);{const I=(f-this.begin)/(this.end-this.begin);return this.property.interpolate(C.possiblyEvaluate(e,r,o),w,function(O){if(O<=0)return 0;if(O>=1)return 1;const z=O*O,B=z*O;return 4*(O<.5?B:3*(O-z)+B-.75)}(I))}}return w}}class lc{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,r,o){const f=new Sa(this._properties);for(const w of Object.keys(this._values))f._values[w]=this._values[w].possiblyEvaluate(e,r,o);return f}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class cc{constructor(e){this._properties=e,this._values=Object.create(e.defaultPropertyValues)}hasValue(e){return this._values[e].value!==void 0}getValue(e){return Ze(this._values[e].value)}setValue(e,r){this._values[e]=new Ca(this._values[e].property,r===null?void 0:Ze(r))}serialize(){const e={};for(const r of Object.keys(this._values)){const o=this.getValue(r);o!==void 0&&(e[r]=o)}return e}possiblyEvaluate(e,r,o){const f=new Sa(this._properties);for(const w of Object.keys(this._values))f._values[w]=this._values[w].possiblyEvaluate(e,r,o);return f}}class us{constructor(e,r,o){this.property=e,this.value=r,this.parameters=o}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,r,o,f){return this.property.evaluate(this.value,this.parameters,e,r,o,f)}}class Sa{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class si{constructor(e){this.specification=e}possiblyEvaluate(e,r){if(e.isDataDriven())throw new Error("Value should not be data driven");return e.expression.evaluate(r)}interpolate(e,r,o){const f=Qr[this.specification.type];return f?f(e,r,o):e}}class hi{constructor(e,r){this.specification=e,this.overrides=r}possiblyEvaluate(e,r,o,f){return new us(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(r,null,{},o,f)}:e.expression,r)}interpolate(e,r,o){if(e.value.kind!=="constant"||r.value.kind!=="constant")return e;if(e.value.value===void 0||r.value.value===void 0)return new us(this,{kind:"constant",value:void 0},e.parameters);const f=Qr[this.specification.type];if(f){const w=f(e.value.value,r.value.value,o);return new us(this,{kind:"constant",value:w},e.parameters)}return e}evaluate(e,r,o,f,w,C){return e.kind==="constant"?e.value:e.evaluate(r,o,f,w,C)}}class Ja extends hi{possiblyEvaluate(e,r,o,f){if(e.value===void 0)return new us(this,{kind:"constant",value:void 0},r);if(e.expression.kind==="constant"){const w=e.expression.evaluate(r,null,{},o,f),C=e.property.specification.type==="resolvedImage"&&typeof w!="string"?w.name:w,I=this._calculate(C,C,C,r);return new us(this,{kind:"constant",value:I},r)}if(e.expression.kind==="camera"){const w=this._calculate(e.expression.evaluate({zoom:r.zoom-1}),e.expression.evaluate({zoom:r.zoom}),e.expression.evaluate({zoom:r.zoom+1}),r);return new us(this,{kind:"constant",value:w},r)}return new us(this,e.expression,r)}evaluate(e,r,o,f,w,C){if(e.kind==="source"){const I=e.evaluate(r,o,f,w,C);return this._calculate(I,I,I,r)}return e.kind==="composite"?this._calculate(e.evaluate({zoom:Math.floor(r.zoom)-1},o,f),e.evaluate({zoom:Math.floor(r.zoom)},o,f),e.evaluate({zoom:Math.floor(r.zoom)+1},o,f),r):e.value}_calculate(e,r,o,f){return f.zoom>f.zoomHistory.lastIntegerZoom?{from:e,to:r}:{from:o,to:r}}interpolate(e){return e}}class Ta{constructor(e){this.specification=e}possiblyEvaluate(e,r,o,f){if(e.value!==void 0){if(e.expression.kind==="constant"){const w=e.expression.evaluate(r,null,{},o,f);return this._calculate(w,w,w,r)}return this._calculate(e.expression.evaluate(new fr(Math.floor(r.zoom-1),r)),e.expression.evaluate(new fr(Math.floor(r.zoom),r)),e.expression.evaluate(new fr(Math.floor(r.zoom+1),r)),r)}}_calculate(e,r,o,f){return f.zoom>f.zoomHistory.lastIntegerZoom?{from:e,to:r}:{from:o,to:r}}interpolate(e){return e}}class Il{constructor(e){this.specification=e}possiblyEvaluate(e,r,o,f){return!!e.expression.evaluate(r,null,{},o,f)}interpolate(){return!1}}class Mn{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const r in e){const o=e[r];o.specification.overridable&&this.overridableProperties.push(r);const f=this.defaultPropertyValues[r]=new Ca(o,void 0),w=this.defaultTransitionablePropertyValues[r]=new Ka(o);this.defaultTransitioningPropertyValues[r]=w.untransitioned(),this.defaultPossiblyEvaluatedValues[r]=f.possiblyEvaluate({})}}}qt("DataDrivenProperty",hi),qt("DataConstantProperty",si),qt("CrossFadedDataDrivenProperty",Ja),qt("CrossFadedProperty",Ta),qt("ColorRampProperty",Il);const Pl="-transition";class ds extends qe{constructor(e,r){if(super(),this.id=e.id,this.type=e.type,this._featureFilter={filter:()=>!0,needGeometry:!1},e.type!=="custom"&&(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type!=="background"&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),r.layout&&(this._unevaluatedLayout=new cc(r.layout)),r.paint)){this._transitionablePaint=new El(r.paint);for(const o in e.paint)this.setPaintProperty(o,e.paint[o],{validate:!1});for(const o in e.layout)this.setLayoutProperty(o,e.layout[o],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Sa(r.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,r,o={}){r!=null&&this._validate(ba,`layers.${this.id}.layout.${e}`,e,r,o)||(e!=="visibility"?this._unevaluatedLayout.setValue(e,r):this.visibility=r)}getPaintProperty(e){return e.endsWith(Pl)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,r,o={}){if(r!=null&&this._validate(es,`layers.${this.id}.paint.${e}`,e,r,o))return!1;if(e.endsWith(Pl))return this._transitionablePaint.setTransition(e.slice(0,-11),r||void 0),!1;{const f=this._transitionablePaint._values[e],w=f.property.specification["property-type"]==="cross-faded-data-driven",C=f.value.isDataDriven(),I=f.value;this._transitionablePaint.setValue(e,r),this._handleSpecialPaintPropertyUpdate(e);const O=this._transitionablePaint._values[e].value;return O.isDataDriven()||C||w||this._handleOverridablePaintPropertyUpdate(e,I,O)}}_handleSpecialPaintPropertyUpdate(e){}_handleOverridablePaintPropertyUpdate(e,r,o){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,r){e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,r)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,r)}serialize(){const e={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(e.layout=e.layout||{},e.layout.visibility=this.visibility),Ye(e,(r,o)=>!(r===void 0||o==="layout"&&!Object.keys(r).length||o==="paint"&&!Object.keys(r).length))}_validate(e,r,o,f,w={}){return(!w||w.validate!==!1)&&Gr(this,e.call(Bi,{key:r,layerType:this.type,objectKey:o,value:f,styleSpec:le,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const e in this.paint._values){const r=this.paint.get(e);if(r instanceof us&&Yn(r.property.specification)&&(r.value.kind==="source"||r.value.kind==="composite")&&r.value.isStateDependent)return!0}return!1}}const hc={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Ea{constructor(e,r){this._structArray=e,this._pos1=r*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Er{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,r){return e._trim(),r&&(e.isTransferred=!0,r.push(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const r=Object.create(this.prototype);return r.arrayBuffer=e.arrayBuffer,r.length=e.length,r.capacity=e.arrayBuffer.byteLength/r.bytesPerElement,r._refreshViews(),r}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const r=this.uint8;this._refreshViews(),r&&this.uint8.set(r)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function Dr(i,e=1){let r=0,o=0;return{members:i.map(f=>{const w=hc[f.type].BYTES_PER_ELEMENT,C=r=uc(r,Math.max(e,w)),I=f.components||1;return o=Math.max(o,w),r+=w*I,{name:f.name,type:f.type,components:I,offset:C}}),size:uc(r,Math.max(o,e)),alignment:e}}function uc(i,e){return Math.ceil(i/e)*e}class Ia extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,r)}emplace(e,r,o){const f=2*e;return this.int16[f+0]=r,this.int16[f+1]=o,e}}Ia.prototype.bytesPerElement=4,qt("StructArrayLayout2i4",Ia);class js extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,o)}emplace(e,r,o,f){const w=3*e;return this.int16[w+0]=r,this.int16[w+1]=o,this.int16[w+2]=f,e}}js.prototype.bytesPerElement=6,qt("StructArrayLayout3i6",js);class Al extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,f){const w=this.length;return this.resize(w+1),this.emplace(w,e,r,o,f)}emplace(e,r,o,f,w){const C=4*e;return this.int16[C+0]=r,this.int16[C+1]=o,this.int16[C+2]=f,this.int16[C+3]=w,e}}Al.prototype.bytesPerElement=8,qt("StructArrayLayout4i8",Al);class Ml extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,f,w,C){const I=this.length;return this.resize(I+1),this.emplace(I,e,r,o,f,w,C)}emplace(e,r,o,f,w,C,I){const O=6*e;return this.int16[O+0]=r,this.int16[O+1]=o,this.int16[O+2]=f,this.int16[O+3]=w,this.int16[O+4]=C,this.int16[O+5]=I,e}}Ml.prototype.bytesPerElement=12,qt("StructArrayLayout2i4i12",Ml);class kl extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,f,w,C){const I=this.length;return this.resize(I+1),this.emplace(I,e,r,o,f,w,C)}emplace(e,r,o,f,w,C,I){const O=4*e,z=8*e;return this.int16[O+0]=r,this.int16[O+1]=o,this.uint8[z+4]=f,this.uint8[z+5]=w,this.uint8[z+6]=C,this.uint8[z+7]=I,e}}kl.prototype.bytesPerElement=8,qt("StructArrayLayout2i4ub8",kl);class Pa extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,r)}emplace(e,r,o){const f=2*e;return this.float32[f+0]=r,this.float32[f+1]=o,e}}Pa.prototype.bytesPerElement=8,qt("StructArrayLayout2f8",Pa);class Qa extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o,f,w,C,I,O,z,B){const N=this.length;return this.resize(N+1),this.emplace(N,e,r,o,f,w,C,I,O,z,B)}emplace(e,r,o,f,w,C,I,O,z,B,N){const W=10*e;return this.uint16[W+0]=r,this.uint16[W+1]=o,this.uint16[W+2]=f,this.uint16[W+3]=w,this.uint16[W+4]=C,this.uint16[W+5]=I,this.uint16[W+6]=O,this.uint16[W+7]=z,this.uint16[W+8]=B,this.uint16[W+9]=N,e}}Qa.prototype.bytesPerElement=20,qt("StructArrayLayout10ui20",Qa);class Ol extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o,f,w,C,I,O,z,B,N,W){const Z=this.length;return this.resize(Z+1),this.emplace(Z,e,r,o,f,w,C,I,O,z,B,N,W)}emplace(e,r,o,f,w,C,I,O,z,B,N,W,Z){const J=12*e;return this.int16[J+0]=r,this.int16[J+1]=o,this.int16[J+2]=f,this.int16[J+3]=w,this.uint16[J+4]=C,this.uint16[J+5]=I,this.uint16[J+6]=O,this.uint16[J+7]=z,this.int16[J+8]=B,this.int16[J+9]=N,this.int16[J+10]=W,this.int16[J+11]=Z,e}}Ol.prototype.bytesPerElement=24,qt("StructArrayLayout4i4ui4i24",Ol);class Dl extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,o)}emplace(e,r,o,f){const w=3*e;return this.float32[w+0]=r,this.float32[w+1]=o,this.float32[w+2]=f,e}}Dl.prototype.bytesPerElement=12,qt("StructArrayLayout3f12",Dl);class Ns extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint32[1*e+0]=r,e}}Ns.prototype.bytesPerElement=4,qt("StructArrayLayout1ul4",Ns);class el extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o,f,w,C,I,O,z){const B=this.length;return this.resize(B+1),this.emplace(B,e,r,o,f,w,C,I,O,z)}emplace(e,r,o,f,w,C,I,O,z,B){const N=10*e,W=5*e;return this.int16[N+0]=r,this.int16[N+1]=o,this.int16[N+2]=f,this.int16[N+3]=w,this.int16[N+4]=C,this.int16[N+5]=I,this.uint32[W+3]=O,this.uint16[N+8]=z,this.uint16[N+9]=B,e}}el.prototype.bytesPerElement=20,qt("StructArrayLayout6i1ul2ui20",el);class Aa extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,f,w,C){const I=this.length;return this.resize(I+1),this.emplace(I,e,r,o,f,w,C)}emplace(e,r,o,f,w,C,I){const O=6*e;return this.int16[O+0]=r,this.int16[O+1]=o,this.int16[O+2]=f,this.int16[O+3]=w,this.int16[O+4]=C,this.int16[O+5]=I,e}}Aa.prototype.bytesPerElement=12,qt("StructArrayLayout2i2i2i12",Aa);class tl extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,f,w){const C=this.length;return this.resize(C+1),this.emplace(C,e,r,o,f,w)}emplace(e,r,o,f,w,C){const I=4*e,O=8*e;return this.float32[I+0]=r,this.float32[I+1]=o,this.float32[I+2]=f,this.int16[O+6]=w,this.int16[O+7]=C,e}}tl.prototype.bytesPerElement=16,qt("StructArrayLayout2f1f2i16",tl);class Ma extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o,f){const w=this.length;return this.resize(w+1),this.emplace(w,e,r,o,f)}emplace(e,r,o,f,w){const C=12*e,I=3*e;return this.uint8[C+0]=r,this.uint8[C+1]=o,this.float32[I+1]=f,this.float32[I+2]=w,e}}Ma.prototype.bytesPerElement=12,qt("StructArrayLayout2ub2f12",Ma);class il extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,o)}emplace(e,r,o,f){const w=3*e;return this.uint16[w+0]=r,this.uint16[w+1]=o,this.uint16[w+2]=f,e}}il.prototype.bytesPerElement=6,qt("StructArrayLayout3ui6",il);class Ko extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o,f,w,C,I,O,z,B,N,W,Z,J,se,de,Ce){const Ve=this.length;return this.resize(Ve+1),this.emplace(Ve,e,r,o,f,w,C,I,O,z,B,N,W,Z,J,se,de,Ce)}emplace(e,r,o,f,w,C,I,O,z,B,N,W,Z,J,se,de,Ce,Ve){const Se=24*e,De=12*e,ht=48*e;return this.int16[Se+0]=r,this.int16[Se+1]=o,this.uint16[Se+2]=f,this.uint16[Se+3]=w,this.uint32[De+2]=C,this.uint32[De+3]=I,this.uint32[De+4]=O,this.uint16[Se+10]=z,this.uint16[Se+11]=B,this.uint16[Se+12]=N,this.float32[De+7]=W,this.float32[De+8]=Z,this.uint8[ht+36]=J,this.uint8[ht+37]=se,this.uint8[ht+38]=de,this.uint32[De+10]=Ce,this.int16[Se+22]=Ve,e}}Ko.prototype.bytesPerElement=48,qt("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",Ko);class bo extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o,f,w,C,I,O,z,B,N,W,Z,J,se,de,Ce,Ve,Se,De,ht,gt,$t,ei,Xt,Ut,Lt,Kt){const jt=this.length;return this.resize(jt+1),this.emplace(jt,e,r,o,f,w,C,I,O,z,B,N,W,Z,J,se,de,Ce,Ve,Se,De,ht,gt,$t,ei,Xt,Ut,Lt,Kt)}emplace(e,r,o,f,w,C,I,O,z,B,N,W,Z,J,se,de,Ce,Ve,Se,De,ht,gt,$t,ei,Xt,Ut,Lt,Kt,jt){const St=32*e,ci=16*e;return this.int16[St+0]=r,this.int16[St+1]=o,this.int16[St+2]=f,this.int16[St+3]=w,this.int16[St+4]=C,this.int16[St+5]=I,this.int16[St+6]=O,this.int16[St+7]=z,this.uint16[St+8]=B,this.uint16[St+9]=N,this.uint16[St+10]=W,this.uint16[St+11]=Z,this.uint16[St+12]=J,this.uint16[St+13]=se,this.uint16[St+14]=de,this.uint16[St+15]=Ce,this.uint16[St+16]=Ve,this.uint16[St+17]=Se,this.uint16[St+18]=De,this.uint16[St+19]=ht,this.uint16[St+20]=gt,this.uint16[St+21]=$t,this.uint16[St+22]=ei,this.uint32[ci+12]=Xt,this.float32[ci+13]=Ut,this.float32[ci+14]=Lt,this.uint16[St+30]=Kt,this.uint16[St+31]=jt,e}}bo.prototype.bytesPerElement=64,qt("StructArrayLayout8i15ui1ul2f2ui64",bo);class rl extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.float32[1*e+0]=r,e}}rl.prototype.bytesPerElement=4,qt("StructArrayLayout1f4",rl);class nl extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,o)}emplace(e,r,o,f){const w=3*e;return this.uint16[6*e+0]=r,this.float32[w+1]=o,this.float32[w+2]=f,e}}nl.prototype.bytesPerElement=12,qt("StructArrayLayout1ui2f12",nl);class wo extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o){const f=this.length;return this.resize(f+1),this.emplace(f,e,r,o)}emplace(e,r,o,f){const w=4*e;return this.uint32[2*e+0]=r,this.uint16[w+2]=o,this.uint16[w+3]=f,e}}wo.prototype.bytesPerElement=8,qt("StructArrayLayout1ul2ui8",wo);class Ll extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,r)}emplace(e,r,o){const f=2*e;return this.uint16[f+0]=r,this.uint16[f+1]=o,e}}Ll.prototype.bytesPerElement=4,qt("StructArrayLayout2ui4",Ll);class zl extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint16[1*e+0]=r,e}}zl.prototype.bytesPerElement=2,qt("StructArrayLayout1ui2",zl);class sl extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o,f){const w=this.length;return this.resize(w+1),this.emplace(w,e,r,o,f)}emplace(e,r,o,f,w){const C=4*e;return this.float32[C+0]=r,this.float32[C+1]=o,this.float32[C+2]=f,this.float32[C+3]=w,e}}sl.prototype.bytesPerElement=16,qt("StructArrayLayout4f16",sl);class dc extends Ea{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new a(this.anchorPointX,this.anchorPointY)}}dc.prototype.size=20;class g extends el{get(e){return new dc(this,e)}}qt("CollisionBoxArray",g);class t extends Ea{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(e){this._structArray.uint8[this._pos1+37]=e}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(e){this._structArray.uint8[this._pos1+38]=e}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(e){this._structArray.uint32[this._pos4+10]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}t.prototype.size=48;class n extends Ko{get(e){return new t(this,e)}}qt("PlacedSymbolArray",n);class c extends Ea{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(e){this._structArray.uint32[this._pos4+12]=e}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}c.prototype.size=64;class d extends bo{get(e){return new c(this,e)}}qt("SymbolInstanceArray",d);class y extends rl{getoffsetX(e){return this.float32[1*e+0]}}qt("GlyphOffsetArray",y);class P extends js{getx(e){return this.int16[3*e+0]}gety(e){return this.int16[3*e+1]}gettileUnitDistanceFromAnchor(e){return this.int16[3*e+2]}}qt("SymbolLineVertexArray",P);class k extends Ea{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}k.prototype.size=12;class L extends nl{get(e){return new k(this,e)}}qt("TextAnchorOffsetArray",L);class R extends Ea{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}R.prototype.size=8;class U extends wo{get(e){return new R(this,e)}}qt("FeatureIndexArray",U);class G extends Ia{}class K extends Ia{}class he extends Ia{}class ce extends Ml{}class fe extends kl{}class ne extends Pa{}class Te extends Qa{}class We extends Ol{}class xe extends Dl{}class ze extends Ns{}class $e extends Aa{}class Ke extends Ma{}class rt extends il{}class xt extends Ll{}const yt=Dr([{name:"a_pos",components:2,type:"Int16"}],4),{members:At}=yt;class zt{constructor(e=[]){this.segments=e}prepareSegment(e,r,o,f){let w=this.segments[this.segments.length-1];return e>zt.MAX_VERTEX_ARRAY_LENGTH&&ct(`Max vertices per segment is ${zt.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!w||w.vertexLength+e>zt.MAX_VERTEX_ARRAY_LENGTH||w.sortKey!==f)&&(w={vertexOffset:r.length,primitiveOffset:o.length,vertexLength:0,primitiveLength:0},f!==void 0&&(w.sortKey=f),this.segments.push(w)),w}get(){return this.segments}destroy(){for(const e of this.segments)for(const r in e.vaos)e.vaos[r].destroy()}static simpleSegment(e,r,o,f){return new zt([{vertexOffset:e,primitiveOffset:r,vertexLength:o,primitiveLength:f,vaos:{},sortKey:0}])}}function Ci(i,e){return 256*(i=V(Math.floor(i),0,255))+V(Math.floor(e),0,255)}zt.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,qt("SegmentVector",zt);const Bt=Dr([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var di={exports:{}},Si={exports:{}};Si.exports=function(i,e){var r,o,f,w,C,I,O,z;for(o=i.length-(r=3&i.length),f=e,C=3432918353,I=461845907,z=0;z<o;)O=255&i.charCodeAt(z)|(255&i.charCodeAt(++z))<<8|(255&i.charCodeAt(++z))<<16|(255&i.charCodeAt(++z))<<24,++z,f=27492+(65535&(w=5*(65535&(f=(f^=O=(65535&(O=(O=(65535&O)*C+(((O>>>16)*C&65535)<<16)&4294967295)<<15|O>>>17))*I+(((O>>>16)*I&65535)<<16)&4294967295)<<13|f>>>19))+((5*(f>>>16)&65535)<<16)&4294967295))+((58964+(w>>>16)&65535)<<16);switch(O=0,r){case 3:O^=(255&i.charCodeAt(z+2))<<16;case 2:O^=(255&i.charCodeAt(z+1))<<8;case 1:f^=O=(65535&(O=(O=(65535&(O^=255&i.charCodeAt(z)))*C+(((O>>>16)*C&65535)<<16)&4294967295)<<15|O>>>17))*I+(((O>>>16)*I&65535)<<16)&4294967295}return f^=i.length,f=2246822507*(65535&(f^=f>>>16))+((2246822507*(f>>>16)&65535)<<16)&4294967295,f=3266489909*(65535&(f^=f>>>13))+((3266489909*(f>>>16)&65535)<<16)&4294967295,(f^=f>>>16)>>>0};var Fi=Si.exports,gi={exports:{}};gi.exports=function(i,e){for(var r,o=i.length,f=e^o,w=0;o>=4;)r=1540483477*(65535&(r=255&i.charCodeAt(w)|(255&i.charCodeAt(++w))<<8|(255&i.charCodeAt(++w))<<16|(255&i.charCodeAt(++w))<<24))+((1540483477*(r>>>16)&65535)<<16),f=1540483477*(65535&f)+((1540483477*(f>>>16)&65535)<<16)^(r=1540483477*(65535&(r^=r>>>24))+((1540483477*(r>>>16)&65535)<<16)),o-=4,++w;switch(o){case 3:f^=(255&i.charCodeAt(w+2))<<16;case 2:f^=(255&i.charCodeAt(w+1))<<8;case 1:f=1540483477*(65535&(f^=255&i.charCodeAt(w)))+((1540483477*(f>>>16)&65535)<<16)}return f=1540483477*(65535&(f^=f>>>13))+((1540483477*(f>>>16)&65535)<<16),(f^=f>>>15)>>>0};var Ei=Fi,Mi=gi.exports;di.exports=Ei,di.exports.murmur3=Ei,di.exports.murmur2=Mi;var Ir=p(di.exports);class Ji{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(e,r,o,f){this.ids.push(Vn(e)),this.positions.push(r,o,f)}getPositions(e){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const r=Vn(e);let o=0,f=this.ids.length-1;for(;o<f;){const C=o+f>>1;this.ids[C]>=r?f=C:o=C+1}const w=[];for(;this.ids[o]===r;)w.push({index:this.positions[3*o],start:this.positions[3*o+1],end:this.positions[3*o+2]}),o++;return w}static serialize(e,r){const o=new Float64Array(e.ids),f=new Uint32Array(e.positions);return Wr(o,f,0,o.length-1),r&&r.push(o.buffer,f.buffer),{ids:o,positions:f}}static deserialize(e){const r=new Ji;return r.ids=e.ids,r.positions=e.positions,r.indexed=!0,r}}function Vn(i){const e=+i;return!isNaN(e)&&e<=Number.MAX_SAFE_INTEGER?e:Ir(String(i))}function Wr(i,e,r,o){for(;r<o;){const f=i[r+o>>1];let w=r-1,C=o+1;for(;;){do w++;while(i[w]<f);do C--;while(i[C]>f);if(w>=C)break;yr(i,w,C),yr(e,3*w,3*C),yr(e,3*w+1,3*C+1),yr(e,3*w+2,3*C+2)}C-r<o-C?(Wr(i,e,r,C),r=C+1):(Wr(i,e,C+1,o),o=C)}}function yr(i,e,r){const o=i[e];i[e]=i[r],i[r]=o}qt("FeaturePositionMap",Ji);class Xr{constructor(e,r){this.gl=e.gl,this.location=r}}class Un extends Xr{constructor(e,r){super(e,r),this.current=0}set(e){this.current!==e&&(this.current=e,this.gl.uniform1f(this.location,e))}}class Ts extends Xr{constructor(e,r){super(e,r),this.current=[0,0,0,0]}set(e){e[0]===this.current[0]&&e[1]===this.current[1]&&e[2]===this.current[2]&&e[3]===this.current[3]||(this.current=e,this.gl.uniform4f(this.location,e[0],e[1],e[2],e[3]))}}class eo extends Xr{constructor(e,r){super(e,r),this.current=Vi.transparent}set(e){e.r===this.current.r&&e.g===this.current.g&&e.b===this.current.b&&e.a===this.current.a||(this.current=e,this.gl.uniform4f(this.location,e.r,e.g,e.b,e.a))}}const ka=new Float32Array(16);function to(i){return[Ci(255*i.r,255*i.g),Ci(255*i.b,255*i.a)]}class Es{constructor(e,r,o){this.value=e,this.uniformNames=r.map(f=>`u_${f}`),this.type=o}setUniform(e,r,o){e.set(o.constantOr(this.value))}getBinding(e,r,o){return this.type==="color"?new eo(e,r):new Un(e,r)}}class Fr{constructor(e,r){this.uniformNames=r.map(o=>`u_${o}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(e,r){this.pixelRatioFrom=r.pixelRatio,this.pixelRatioTo=e.pixelRatio,this.patternFrom=r.tlbr,this.patternTo=e.tlbr}setUniform(e,r,o,f){const w=f==="u_pattern_to"?this.patternTo:f==="u_pattern_from"?this.patternFrom:f==="u_pixel_ratio_to"?this.pixelRatioTo:f==="u_pixel_ratio_from"?this.pixelRatioFrom:null;w&&e.set(w)}getBinding(e,r,o){return o.substr(0,9)==="u_pattern"?new Ts(e,r):new Un(e,r)}}class vr{constructor(e,r,o,f){this.expression=e,this.type=o,this.maxValue=0,this.paintVertexAttributes=r.map(w=>({name:`a_${w}`,type:"Float32",components:o==="color"?2:1,offset:0})),this.paintVertexArray=new f}populatePaintArray(e,r,o,f,w){const C=this.paintVertexArray.length,I=this.expression.evaluate(new fr(0),r,{},f,[],w);this.paintVertexArray.resize(e),this._setPaintValue(C,e,I)}updatePaintArray(e,r,o,f){const w=this.expression.evaluate({zoom:0},o,f);this._setPaintValue(e,r,w)}_setPaintValue(e,r,o){if(this.type==="color"){const f=to(o);for(let w=e;w<r;w++)this.paintVertexArray.emplace(w,f[0],f[1])}else{for(let f=e;f<r;f++)this.paintVertexArray.emplace(f,o);this.maxValue=Math.max(this.maxValue,Math.abs(o))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class pr{constructor(e,r,o,f,w,C){this.expression=e,this.uniformNames=r.map(I=>`u_${I}_t`),this.type=o,this.useIntegerZoom=f,this.zoom=w,this.maxValue=0,this.paintVertexAttributes=r.map(I=>({name:`a_${I}`,type:"Float32",components:o==="color"?4:2,offset:0})),this.paintVertexArray=new C}populatePaintArray(e,r,o,f,w){const C=this.expression.evaluate(new fr(this.zoom),r,{},f,[],w),I=this.expression.evaluate(new fr(this.zoom+1),r,{},f,[],w),O=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(O,e,C,I)}updatePaintArray(e,r,o,f){const w=this.expression.evaluate({zoom:this.zoom},o,f),C=this.expression.evaluate({zoom:this.zoom+1},o,f);this._setPaintValue(e,r,w,C)}_setPaintValue(e,r,o,f){if(this.type==="color"){const w=to(o),C=to(f);for(let I=e;I<r;I++)this.paintVertexArray.emplace(I,w[0],w[1],C[0],C[1])}else{for(let w=e;w<r;w++)this.paintVertexArray.emplace(w,o,f);this.maxValue=Math.max(this.maxValue,Math.abs(o),Math.abs(f))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,r){const o=this.useIntegerZoom?Math.floor(r.zoom):r.zoom,f=V(this.expression.interpolationFactor(o,this.zoom,this.zoom+1),0,1);e.set(f)}getBinding(e,r,o){return new Un(e,r)}}class ts{constructor(e,r,o,f,w,C){this.expression=e,this.type=r,this.useIntegerZoom=o,this.zoom=f,this.layerId=C,this.zoomInPaintVertexArray=new w,this.zoomOutPaintVertexArray=new w}populatePaintArray(e,r,o){const f=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(e),this.zoomOutPaintVertexArray.resize(e),this._setPaintValues(f,e,r.patterns&&r.patterns[this.layerId],o)}updatePaintArray(e,r,o,f,w){this._setPaintValues(e,r,o.patterns&&o.patterns[this.layerId],w)}_setPaintValues(e,r,o,f){if(!f||!o)return;const{min:w,mid:C,max:I}=o,O=f[w],z=f[C],B=f[I];if(O&&z&&B)for(let N=e;N<r;N++)this.zoomInPaintVertexArray.emplace(N,z.tl[0],z.tl[1],z.br[0],z.br[1],O.tl[0],O.tl[1],O.br[0],O.br[1],z.pixelRatio,O.pixelRatio),this.zoomOutPaintVertexArray.emplace(N,z.tl[0],z.tl[1],z.br[0],z.br[1],B.tl[0],B.tl[1],B.br[0],B.br[1],z.pixelRatio,B.pixelRatio)}upload(e){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=e.createVertexBuffer(this.zoomInPaintVertexArray,Bt.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=e.createVertexBuffer(this.zoomOutPaintVertexArray,Bt.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class Rr{constructor(e,r,o){this.binders={},this._buffers=[];const f=[];for(const w in e.paint._values){if(!o(w))continue;const C=e.paint.get(w);if(!(C instanceof us&&Yn(C.property.specification)))continue;const I=is(w,e.type),O=C.value,z=C.property.specification.type,B=C.property.useIntegerZoom,N=C.property.specification["property-type"],W=N==="cross-faded"||N==="cross-faded-data-driven";if(O.kind==="constant")this.binders[w]=W?new Fr(O.value,I):new Es(O.value,I,z),f.push(`/u_${w}`);else if(O.kind==="source"||W){const Z=Br(w,z,"source");this.binders[w]=W?new ts(O,z,B,r,Z,e.id):new vr(O,I,z,Z),f.push(`/a_${w}`)}else{const Z=Br(w,z,"composite");this.binders[w]=new pr(O,I,z,B,r,Z),f.push(`/z_${w}`)}}this.cacheKey=f.sort().join("")}getMaxValue(e){const r=this.binders[e];return r instanceof vr||r instanceof pr?r.maxValue:0}populatePaintArrays(e,r,o,f,w){for(const C in this.binders){const I=this.binders[C];(I instanceof vr||I instanceof pr||I instanceof ts)&&I.populatePaintArray(e,r,o,f,w)}}setConstantPatternPositions(e,r){for(const o in this.binders){const f=this.binders[o];f instanceof Fr&&f.setConstantPatternPositions(e,r)}}updatePaintArrays(e,r,o,f,w){let C=!1;for(const I in e){const O=r.getPositions(I);for(const z of O){const B=o.feature(z.index);for(const N in this.binders){const W=this.binders[N];if((W instanceof vr||W instanceof pr||W instanceof ts)&&W.expression.isStateDependent===!0){const Z=f.paint.get(N);W.expression=Z.value,W.updatePaintArray(z.start,z.end,B,e[I],w),C=!0}}}}return C}defines(){const e=[];for(const r in this.binders){const o=this.binders[r];(o instanceof Es||o instanceof Fr)&&e.push(...o.uniformNames.map(f=>`#define HAS_UNIFORM_${f}`))}return e}getBinderAttributes(){const e=[];for(const r in this.binders){const o=this.binders[r];if(o instanceof vr||o instanceof pr)for(let f=0;f<o.paintVertexAttributes.length;f++)e.push(o.paintVertexAttributes[f].name);else if(o instanceof ts)for(let f=0;f<Bt.members.length;f++)e.push(Bt.members[f].name)}return e}getBinderUniforms(){const e=[];for(const r in this.binders){const o=this.binders[r];if(o instanceof Es||o instanceof Fr||o instanceof pr)for(const f of o.uniformNames)e.push(f)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e,r){const o=[];for(const f in this.binders){const w=this.binders[f];if(w instanceof Es||w instanceof Fr||w instanceof pr){for(const C of w.uniformNames)if(r[C]){const I=w.getBinding(e,r[C],C);o.push({name:C,property:f,binding:I})}}}return o}setUniforms(e,r,o,f){for(const{name:w,property:C,binding:I}of r)this.binders[C].setUniform(I,f,o.get(C),w)}updatePaintBuffers(e){this._buffers=[];for(const r in this.binders){const o=this.binders[r];if(e&&o instanceof ts){const f=e.fromScale===2?o.zoomInPaintVertexBuffer:o.zoomOutPaintVertexBuffer;f&&this._buffers.push(f)}else(o instanceof vr||o instanceof pr)&&o.paintVertexBuffer&&this._buffers.push(o.paintVertexBuffer)}}upload(e){for(const r in this.binders){const o=this.binders[r];(o instanceof vr||o instanceof pr||o instanceof ts)&&o.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const r=this.binders[e];(r instanceof vr||r instanceof pr||r instanceof ts)&&r.destroy()}}}class xr{constructor(e,r,o=()=>!0){this.programConfigurations={};for(const f of e)this.programConfigurations[f.id]=new Rr(f,r,o);this.needsUpload=!1,this._featureMap=new Ji,this._bufferOffset=0}populatePaintArrays(e,r,o,f,w,C){for(const I in this.programConfigurations)this.programConfigurations[I].populatePaintArrays(e,r,f,w,C);r.id!==void 0&&this._featureMap.add(r.id,o,this._bufferOffset,e),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,r,o,f){for(const w of o)this.needsUpload=this.programConfigurations[w.id].updatePaintArrays(e,this._featureMap,r,w,f)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const r in this.programConfigurations)this.programConfigurations[r].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}function is(i,e){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[i]||[i.replace(`${e}-`,"").replace(/-/g,"_")]}function Br(i,e,r){const o={color:{source:Pa,composite:sl},number:{source:rl,composite:Pa}},f=function(w){return{"line-pattern":{source:Te,composite:Te},"fill-pattern":{source:Te,composite:Te},"fill-extrusion-pattern":{source:Te,composite:Te}}[w]}(i);return f&&f[r]||o[e][r]}qt("ConstantBinder",Es),qt("CrossFadedConstantBinder",Fr),qt("SourceExpressionBinder",vr),qt("CrossFadedCompositeBinder",ts),qt("CompositeExpressionBinder",pr),qt("ProgramConfiguration",Rr,{omit:["_buffers"]}),qt("ProgramConfigurationSet",xr);const Mr=8192,Fl=Math.pow(2,14)-1,fc=-Fl-1;function Co(i){const e=Mr/i.extent,r=i.loadGeometry();for(let o=0;o<r.length;o++){const f=r[o];for(let w=0;w<f.length;w++){const C=f[w],I=Math.round(C.x*e),O=Math.round(C.y*e);C.x=V(I,fc,Fl),C.y=V(O,fc,Fl),(I<C.x||I>C.x+1||O<C.y||O>C.y+1)&&ct("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return r}function So(i,e){return{type:i.type,id:i.id,properties:i.properties,geometry:e?Co(i):[]}}function ol(i,e,r,o,f){i.emplaceBack(2*e+(o+1)/2,2*r+(f+1)/2)}class io{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new K,this.indexArray=new rt,this.segments=new zt,this.programConfigurations=new xr(e.layers,e.zoom),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,o){const f=this.layers[0],w=[];let C=null,I=!1;f.type==="circle"&&(C=f.layout.get("circle-sort-key"),I=!C.isConstant());for(const{feature:O,id:z,index:B,sourceLayerIndex:N}of e){const W=this.layers[0]._featureFilter.needGeometry,Z=So(O,W);if(!this.layers[0]._featureFilter.filter(new fr(this.zoom),Z,o))continue;const J=I?C.evaluate(Z,{},o):void 0,se={id:z,properties:O.properties,type:O.type,sourceLayerIndex:N,index:B,geometry:W?Z.geometry:Co(O),patterns:{},sortKey:J};w.push(se)}I&&w.sort((O,z)=>O.sortKey-z.sortKey);for(const O of w){const{geometry:z,index:B,sourceLayerIndex:N}=O,W=e[B].feature;this.addFeature(O,z,B,o),r.featureIndex.insert(W,z,B,N,this.index)}}update(e,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,At),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,r,o,f){for(const w of r)for(const C of w){const I=C.x,O=C.y;if(I<0||I>=Mr||O<0||O>=Mr)continue;const z=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),B=z.vertexLength;ol(this.layoutVertexArray,I,O,-1,-1),ol(this.layoutVertexArray,I,O,1,-1),ol(this.layoutVertexArray,I,O,1,1),ol(this.layoutVertexArray,I,O,-1,1),this.indexArray.emplaceBack(B,B+1,B+2),this.indexArray.emplaceBack(B,B+3,B+2),z.vertexLength+=4,z.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,{},f)}}function Rl(i,e){for(let r=0;r<i.length;r++)if(ll(e,i[r]))return!0;for(let r=0;r<e.length;r++)if(ll(i,e[r]))return!0;return!!al(i,e)}function pc(i,e,r){return!!ll(i,e)||!!Hc(e,i,r)}function Bl(i,e){if(i.length===1)return Gh(e,i[0]);for(let r=0;r<e.length;r++){const o=e[r];for(let f=0;f<o.length;f++)if(ll(i,o[f]))return!0}for(let r=0;r<i.length;r++)if(Gh(e,i[r]))return!0;for(let r=0;r<e.length;r++)if(al(i,e[r]))return!0;return!1}function jl(i,e,r){if(i.length>1){if(al(i,e))return!0;for(let o=0;o<e.length;o++)if(Hc(e[o],i,r))return!0}for(let o=0;o<i.length;o++)if(Hc(i[o],e,r))return!0;return!1}function al(i,e){if(i.length===0||e.length===0)return!1;for(let r=0;r<i.length-1;r++){const o=i[r],f=i[r+1];for(let w=0;w<e.length-1;w++)if(Nl(o,f,e[w],e[w+1]))return!0}return!1}function Nl(i,e,r,o){return nt(i,r,o)!==nt(e,r,o)&&nt(i,e,r)!==nt(i,e,o)}function Hc(i,e,r){const o=r*r;if(e.length===1)return i.distSqr(e[0])<o;for(let f=1;f<e.length;f++)if(Uh(i,e[f-1],e[f])<o)return!0;return!1}function Uh(i,e,r){const o=e.distSqr(r);if(o===0)return i.distSqr(e);const f=((i.x-e.x)*(r.x-e.x)+(i.y-e.y)*(r.y-e.y))/o;return i.distSqr(f<0?e:f>1?r:r.sub(e)._mult(f)._add(e))}function Gh(i,e){let r,o,f,w=!1;for(let C=0;C<i.length;C++){r=i[C];for(let I=0,O=r.length-1;I<r.length;O=I++)o=r[I],f=r[O],o.y>e.y!=f.y>e.y&&e.x<(f.x-o.x)*(e.y-o.y)/(f.y-o.y)+o.x&&(w=!w)}return w}function ll(i,e){let r=!1;for(let o=0,f=i.length-1;o<i.length;f=o++){const w=i[o],C=i[f];w.y>e.y!=C.y>e.y&&e.x<(C.x-w.x)*(e.y-w.y)/(C.y-w.y)+w.x&&(r=!r)}return r}function Kd(i,e,r){const o=r[0],f=r[2];if(i.x<o.x&&e.x<o.x||i.x>f.x&&e.x>f.x||i.y<o.y&&e.y<o.y||i.y>f.y&&e.y>f.y)return!1;const w=nt(i,e,r[0]);return w!==nt(i,e,r[1])||w!==nt(i,e,r[2])||w!==nt(i,e,r[3])}function Vl(i,e,r){const o=e.paint.get(i).value;return o.kind==="constant"?o.value:r.programConfigurations.get(e.id).getMaxValue(i)}function mc(i){return Math.sqrt(i[0]*i[0]+i[1]*i[1])}function gc(i,e,r,o,f){if(!e[0]&&!e[1])return i;const w=a.convert(e)._mult(f);r==="viewport"&&w._rotate(-o);const C=[];for(let I=0;I<i.length;I++)C.push(i[I].sub(w));return C}let Hh,Wh;qt("CircleBucket",io,{omit:["layers"]});var Jd={get paint(){return Wh=Wh||new Mn({"circle-radius":new hi(le.paint_circle["circle-radius"]),"circle-color":new hi(le.paint_circle["circle-color"]),"circle-blur":new hi(le.paint_circle["circle-blur"]),"circle-opacity":new hi(le.paint_circle["circle-opacity"]),"circle-translate":new si(le.paint_circle["circle-translate"]),"circle-translate-anchor":new si(le.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new si(le.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new si(le.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new hi(le.paint_circle["circle-stroke-width"]),"circle-stroke-color":new hi(le.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new hi(le.paint_circle["circle-stroke-opacity"])})},get layout(){return Hh=Hh||new Mn({"circle-sort-key":new hi(le.layout_circle["circle-sort-key"])})}},kn=1e-6,cl=typeof Float32Array<"u"?Float32Array:Array;function Wc(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function Xh(i,e,r){var o=e[0],f=e[1],w=e[2],C=e[3],I=e[4],O=e[5],z=e[6],B=e[7],N=e[8],W=e[9],Z=e[10],J=e[11],se=e[12],de=e[13],Ce=e[14],Ve=e[15],Se=r[0],De=r[1],ht=r[2],gt=r[3];return i[0]=Se*o+De*I+ht*N+gt*se,i[1]=Se*f+De*O+ht*W+gt*de,i[2]=Se*w+De*z+ht*Z+gt*Ce,i[3]=Se*C+De*B+ht*J+gt*Ve,i[4]=(Se=r[4])*o+(De=r[5])*I+(ht=r[6])*N+(gt=r[7])*se,i[5]=Se*f+De*O+ht*W+gt*de,i[6]=Se*w+De*z+ht*Z+gt*Ce,i[7]=Se*C+De*B+ht*J+gt*Ve,i[8]=(Se=r[8])*o+(De=r[9])*I+(ht=r[10])*N+(gt=r[11])*se,i[9]=Se*f+De*O+ht*W+gt*de,i[10]=Se*w+De*z+ht*Z+gt*Ce,i[11]=Se*C+De*B+ht*J+gt*Ve,i[12]=(Se=r[12])*o+(De=r[13])*I+(ht=r[14])*N+(gt=r[15])*se,i[13]=Se*f+De*O+ht*W+gt*de,i[14]=Se*w+De*z+ht*Z+gt*Ce,i[15]=Se*C+De*B+ht*J+gt*Ve,i}Math.hypot||(Math.hypot=function(){for(var i=0,e=arguments.length;e--;)i+=arguments[e]*arguments[e];return Math.sqrt(i)});var Ul,Qd=Xh;function _c(i,e,r){var o=e[0],f=e[1],w=e[2],C=e[3];return i[0]=r[0]*o+r[4]*f+r[8]*w+r[12]*C,i[1]=r[1]*o+r[5]*f+r[9]*w+r[13]*C,i[2]=r[2]*o+r[6]*f+r[10]*w+r[14]*C,i[3]=r[3]*o+r[7]*f+r[11]*w+r[15]*C,i}Ul=new cl(4),cl!=Float32Array&&(Ul[0]=0,Ul[1]=0,Ul[2]=0,Ul[3]=0);class ef extends ds{constructor(e){super(e,Jd)}createBucket(e){return new io(e)}queryRadius(e){const r=e;return Vl("circle-radius",this,r)+Vl("circle-stroke-width",this,r)+mc(this.paint.get("circle-translate"))}queryIntersectsFeature(e,r,o,f,w,C,I,O){const z=gc(e,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),C.angle,I),B=this.paint.get("circle-radius").evaluate(r,o)+this.paint.get("circle-stroke-width").evaluate(r,o),N=this.paint.get("circle-pitch-alignment")==="map",W=N?z:function(J,se){return J.map(de=>qh(de,se))}(z,O),Z=N?B*I:B;for(const J of f)for(const se of J){const de=N?se:qh(se,O);let Ce=Z;const Ve=_c([],[se.x,se.y,0,1],O);if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"?Ce*=Ve[3]/C.cameraToCenterDistance:this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"&&(Ce*=C.cameraToCenterDistance/Ve[3]),pc(W,de,Ce))return!0}return!1}}function qh(i,e){const r=_c([],[i.x,i.y,0,1],e);return new a(r[0]/r[3],r[1]/r[3])}class $h extends io{}let Yh;qt("HeatmapBucket",$h,{omit:["layers"]});var tf={get paint(){return Yh=Yh||new Mn({"heatmap-radius":new hi(le.paint_heatmap["heatmap-radius"]),"heatmap-weight":new hi(le.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new si(le.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Il(le.paint_heatmap["heatmap-color"]),"heatmap-opacity":new si(le.paint_heatmap["heatmap-opacity"])})}};function Xc(i,{width:e,height:r},o,f){if(f){if(f instanceof Uint8ClampedArray)f=new Uint8Array(f.buffer);else if(f.length!==e*r*o)throw new RangeError(`mismatched image size. expected: ${f.length} but got: ${e*r*o}`)}else f=new Uint8Array(e*r*o);return i.width=e,i.height=r,i.data=f,i}function Zh(i,{width:e,height:r},o){if(e===i.width&&r===i.height)return;const f=Xc({},{width:e,height:r},o);qc(i,f,{x:0,y:0},{x:0,y:0},{width:Math.min(i.width,e),height:Math.min(i.height,r)},o),i.width=e,i.height=r,i.data=f.data}function qc(i,e,r,o,f,w){if(f.width===0||f.height===0)return e;if(f.width>i.width||f.height>i.height||r.x>i.width-f.width||r.y>i.height-f.height)throw new RangeError("out of range source coordinates for image copy");if(f.width>e.width||f.height>e.height||o.x>e.width-f.width||o.y>e.height-f.height)throw new RangeError("out of range destination coordinates for image copy");const C=i.data,I=e.data;if(C===I)throw new Error("srcData equals dstData, so image is already copied");for(let O=0;O<f.height;O++){const z=((r.y+O)*i.width+r.x)*w,B=((o.y+O)*e.width+o.x)*w;for(let N=0;N<f.width*w;N++)I[B+N]=C[z+N]}return e}class Gl{constructor(e,r){Xc(this,e,1,r)}resize(e){Zh(this,e,1)}clone(){return new Gl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,o,f,w){qc(e,r,o,f,w,1)}}class fs{constructor(e,r){Xc(this,e,4,r)}resize(e){Zh(this,e,4)}replace(e,r){r?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new fs({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,o,f,w){qc(e,r,o,f,w,4)}}function Kh(i){const e={},r=i.resolution||256,o=i.clips?i.clips.length:1,f=i.image||new fs({width:r,height:o});if(Math.log(r)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${r}`);const w=(C,I,O)=>{e[i.evaluationKey]=O;const z=i.expression.evaluate(e);f.data[C+I+0]=Math.floor(255*z.r/z.a),f.data[C+I+1]=Math.floor(255*z.g/z.a),f.data[C+I+2]=Math.floor(255*z.b/z.a),f.data[C+I+3]=Math.floor(255*z.a)};if(i.clips)for(let C=0,I=0;C<o;++C,I+=4*r)for(let O=0,z=0;O<r;O++,z+=4){const B=O/(r-1),{start:N,end:W}=i.clips[C];w(I,z,N*(1-B)+W*B)}else for(let C=0,I=0;C<r;C++,I+=4)w(0,I,C/(r-1));return f}qt("AlphaImage",Gl),qt("RGBAImage",fs);class rf extends ds{createBucket(e){return new $h(e)}constructor(e){super(e,tf),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){e==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Kh({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let Jh;var nf={get paint(){return Jh=Jh||new Mn({"hillshade-illumination-direction":new si(le.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new si(le.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new si(le.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new si(le.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new si(le.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new si(le.paint_hillshade["hillshade-accent-color"])})}};class sf extends ds{constructor(e){super(e,nf)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}const of=Dr([{name:"a_pos",components:2,type:"Int16"}],4),{members:af}=of;var $c={exports:{}};function yc(i,e,r){r=r||2;var o,f,w,C,I,O,z,B=e&&e.length,N=B?e[0]*r:i.length,W=Qh(i,0,N,r,!0),Z=[];if(!W||W.next===W.prev)return Z;if(B&&(W=function(se,de,Ce,Ve){var Se,De,ht,gt=[];for(Se=0,De=de.length;Se<De;Se++)(ht=Qh(se,de[Se]*Ve,Se<De-1?de[Se+1]*Ve:se.length,Ve,!1))===ht.next&&(ht.steiner=!0),gt.push(mf(ht));for(gt.sort(df),Se=0;Se<gt.length;Se++)Ce=ff(gt[Se],Ce);return Ce}(i,e,W,r)),i.length>80*r){o=w=i[0],f=C=i[1];for(var J=r;J<N;J+=r)(I=i[J])<o&&(o=I),(O=i[J+1])<f&&(f=O),I>w&&(w=I),O>C&&(C=O);z=(z=Math.max(w-o,C-f))!==0?32767/z:0}return Hl(W,Z,r,o,f,z,0),Z}function Qh(i,e,r,o,f){var w,C;if(f===Kc(i,e,r,o)>0)for(w=e;w<r;w+=o)C=iu(w,i[w],i[w+1],C);else for(w=r-o;w>=e;w-=o)C=iu(w,i[w],i[w+1],C);return C&&vc(C,C.next)&&(Xl(C),C=C.next),C}function Oa(i,e){if(!i)return i;e||(e=i);var r,o=i;do if(r=!1,o.steiner||!vc(o,o.next)&&Lr(o.prev,o,o.next)!==0)o=o.next;else{if(Xl(o),(o=e=o.prev)===o.next)break;r=!0}while(r||o!==e);return e}function Hl(i,e,r,o,f,w,C){if(i){!C&&w&&function(B,N,W,Z){var J=B;do J.z===0&&(J.z=Yc(J.x,J.y,N,W,Z)),J.prevZ=J.prev,J.nextZ=J.next,J=J.next;while(J!==B);J.prevZ.nextZ=null,J.prevZ=null,function(se){var de,Ce,Ve,Se,De,ht,gt,$t,ei=1;do{for(Ce=se,se=null,De=null,ht=0;Ce;){for(ht++,Ve=Ce,gt=0,de=0;de<ei&&(gt++,Ve=Ve.nextZ);de++);for($t=ei;gt>0||$t>0&&Ve;)gt!==0&&($t===0||!Ve||Ce.z<=Ve.z)?(Se=Ce,Ce=Ce.nextZ,gt--):(Se=Ve,Ve=Ve.nextZ,$t--),De?De.nextZ=Se:se=Se,Se.prevZ=De,De=Se;Ce=Ve}De.nextZ=null,ei*=2}while(ht>1)}(J)}(i,o,f,w);for(var I,O,z=i;i.prev!==i.next;)if(I=i.prev,O=i.next,w?cf(i,o,f,w):lf(i))e.push(I.i/r|0),e.push(i.i/r|0),e.push(O.i/r|0),Xl(i),i=O.next,z=O.next;else if((i=O)===z){C?C===1?Hl(i=hf(Oa(i),e,r),e,r,o,f,w,2):C===2&&uf(i,e,r,o,f,w):Hl(Oa(i),e,r,o,f,w,1);break}}}function lf(i){var e=i.prev,r=i,o=i.next;if(Lr(e,r,o)>=0)return!1;for(var f=e.x,w=r.x,C=o.x,I=e.y,O=r.y,z=o.y,B=f<w?f<C?f:C:w<C?w:C,N=I<O?I<z?I:z:O<z?O:z,W=f>w?f>C?f:C:w>C?w:C,Z=I>O?I>z?I:z:O>z?O:z,J=o.next;J!==e;){if(J.x>=B&&J.x<=W&&J.y>=N&&J.y<=Z&&hl(f,I,w,O,C,z,J.x,J.y)&&Lr(J.prev,J,J.next)>=0)return!1;J=J.next}return!0}function cf(i,e,r,o){var f=i.prev,w=i,C=i.next;if(Lr(f,w,C)>=0)return!1;for(var I=f.x,O=w.x,z=C.x,B=f.y,N=w.y,W=C.y,Z=I<O?I<z?I:z:O<z?O:z,J=B<N?B<W?B:W:N<W?N:W,se=I>O?I>z?I:z:O>z?O:z,de=B>N?B>W?B:W:N>W?N:W,Ce=Yc(Z,J,e,r,o),Ve=Yc(se,de,e,r,o),Se=i.prevZ,De=i.nextZ;Se&&Se.z>=Ce&&De&&De.z<=Ve;){if(Se.x>=Z&&Se.x<=se&&Se.y>=J&&Se.y<=de&&Se!==f&&Se!==C&&hl(I,B,O,N,z,W,Se.x,Se.y)&&Lr(Se.prev,Se,Se.next)>=0||(Se=Se.prevZ,De.x>=Z&&De.x<=se&&De.y>=J&&De.y<=de&&De!==f&&De!==C&&hl(I,B,O,N,z,W,De.x,De.y)&&Lr(De.prev,De,De.next)>=0))return!1;De=De.nextZ}for(;Se&&Se.z>=Ce;){if(Se.x>=Z&&Se.x<=se&&Se.y>=J&&Se.y<=de&&Se!==f&&Se!==C&&hl(I,B,O,N,z,W,Se.x,Se.y)&&Lr(Se.prev,Se,Se.next)>=0)return!1;Se=Se.prevZ}for(;De&&De.z<=Ve;){if(De.x>=Z&&De.x<=se&&De.y>=J&&De.y<=de&&De!==f&&De!==C&&hl(I,B,O,N,z,W,De.x,De.y)&&Lr(De.prev,De,De.next)>=0)return!1;De=De.nextZ}return!0}function hf(i,e,r){var o=i;do{var f=o.prev,w=o.next.next;!vc(f,w)&&eu(f,o,o.next,w)&&Wl(f,w)&&Wl(w,f)&&(e.push(f.i/r|0),e.push(o.i/r|0),e.push(w.i/r|0),Xl(o),Xl(o.next),o=i=w),o=o.next}while(o!==i);return Oa(o)}function uf(i,e,r,o,f,w){var C=i;do{for(var I=C.next.next;I!==C.prev;){if(C.i!==I.i&&gf(C,I)){var O=tu(C,I);return C=Oa(C,C.next),O=Oa(O,O.next),Hl(C,e,r,o,f,w,0),void Hl(O,e,r,o,f,w,0)}I=I.next}C=C.next}while(C!==i)}function df(i,e){return i.x-e.x}function ff(i,e){var r=function(f,w){var C,I=w,O=f.x,z=f.y,B=-1/0;do{if(z<=I.y&&z>=I.next.y&&I.next.y!==I.y){var N=I.x+(z-I.y)*(I.next.x-I.x)/(I.next.y-I.y);if(N<=O&&N>B&&(B=N,C=I.x<I.next.x?I:I.next,N===O))return C}I=I.next}while(I!==w);if(!C)return null;var W,Z=C,J=C.x,se=C.y,de=1/0;I=C;do O>=I.x&&I.x>=J&&O!==I.x&&hl(z<se?O:B,z,J,se,z<se?B:O,z,I.x,I.y)&&(W=Math.abs(z-I.y)/(O-I.x),Wl(I,f)&&(W<de||W===de&&(I.x>C.x||I.x===C.x&&pf(C,I)))&&(C=I,de=W)),I=I.next;while(I!==Z);return C}(i,e);if(!r)return e;var o=tu(r,i);return Oa(o,o.next),Oa(r,r.next)}function pf(i,e){return Lr(i.prev,i,e.prev)<0&&Lr(e.next,i,i.next)<0}function Yc(i,e,r,o,f){return(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=(i-r)*f|0)|i<<8))|i<<4))|i<<2))|i<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-o)*f|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function mf(i){var e=i,r=i;do(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next;while(e!==i);return r}function hl(i,e,r,o,f,w,C,I){return(f-C)*(e-I)>=(i-C)*(w-I)&&(i-C)*(o-I)>=(r-C)*(e-I)&&(r-C)*(w-I)>=(f-C)*(o-I)}function gf(i,e){return i.next.i!==e.i&&i.prev.i!==e.i&&!function(r,o){var f=r;do{if(f.i!==r.i&&f.next.i!==r.i&&f.i!==o.i&&f.next.i!==o.i&&eu(f,f.next,r,o))return!0;f=f.next}while(f!==r);return!1}(i,e)&&(Wl(i,e)&&Wl(e,i)&&function(r,o){var f=r,w=!1,C=(r.x+o.x)/2,I=(r.y+o.y)/2;do f.y>I!=f.next.y>I&&f.next.y!==f.y&&C<(f.next.x-f.x)*(I-f.y)/(f.next.y-f.y)+f.x&&(w=!w),f=f.next;while(f!==r);return w}(i,e)&&(Lr(i.prev,i,e.prev)||Lr(i,e.prev,e))||vc(i,e)&&Lr(i.prev,i,i.next)>0&&Lr(e.prev,e,e.next)>0)}function Lr(i,e,r){return(e.y-i.y)*(r.x-e.x)-(e.x-i.x)*(r.y-e.y)}function vc(i,e){return i.x===e.x&&i.y===e.y}function eu(i,e,r,o){var f=bc(Lr(i,e,r)),w=bc(Lr(i,e,o)),C=bc(Lr(r,o,i)),I=bc(Lr(r,o,e));return f!==w&&C!==I||!(f!==0||!xc(i,r,e))||!(w!==0||!xc(i,o,e))||!(C!==0||!xc(r,i,o))||!(I!==0||!xc(r,e,o))}function xc(i,e,r){return e.x<=Math.max(i.x,r.x)&&e.x>=Math.min(i.x,r.x)&&e.y<=Math.max(i.y,r.y)&&e.y>=Math.min(i.y,r.y)}function bc(i){return i>0?1:i<0?-1:0}function Wl(i,e){return Lr(i.prev,i,i.next)<0?Lr(i,e,i.next)>=0&&Lr(i,i.prev,e)>=0:Lr(i,e,i.prev)<0||Lr(i,i.next,e)<0}function tu(i,e){var r=new Zc(i.i,i.x,i.y),o=new Zc(e.i,e.x,e.y),f=i.next,w=e.prev;return i.next=e,e.prev=i,r.next=f,f.prev=r,o.next=r,r.prev=o,w.next=o,o.prev=w,o}function iu(i,e,r,o){var f=new Zc(i,e,r);return o?(f.next=o.next,f.prev=o,o.next.prev=f,o.next=f):(f.prev=f,f.next=f),f}function Xl(i){i.next.prev=i.prev,i.prev.next=i.next,i.prevZ&&(i.prevZ.nextZ=i.nextZ),i.nextZ&&(i.nextZ.prevZ=i.prevZ)}function Zc(i,e,r){this.i=i,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Kc(i,e,r,o){for(var f=0,w=e,C=r-o;w<r;w+=o)f+=(i[C]-i[w])*(i[w+1]+i[C+1]),C=w;return f}$c.exports=yc,$c.exports.default=yc,yc.deviation=function(i,e,r,o){var f=e&&e.length,w=Math.abs(Kc(i,0,f?e[0]*r:i.length,r));if(f)for(var C=0,I=e.length;C<I;C++)w-=Math.abs(Kc(i,e[C]*r,C<I-1?e[C+1]*r:i.length,r));var O=0;for(C=0;C<o.length;C+=3){var z=o[C]*r,B=o[C+1]*r,N=o[C+2]*r;O+=Math.abs((i[z]-i[N])*(i[B+1]-i[z+1])-(i[z]-i[B])*(i[N+1]-i[z+1]))}return w===0&&O===0?0:Math.abs((O-w)/w)},yc.flatten=function(i){for(var e=i[0][0].length,r={vertices:[],holes:[],dimensions:e},o=0,f=0;f<i.length;f++){for(var w=0;w<i[f].length;w++)for(var C=0;C<e;C++)r.vertices.push(i[f][w][C]);f>0&&r.holes.push(o+=i[f-1].length)}return r};var ru=p($c.exports);function _f(i,e,r,o,f){nu(i,e,r||0,o||i.length-1,f||yf)}function nu(i,e,r,o,f){for(;o>r;){if(o-r>600){var w=o-r+1,C=e-r+1,I=Math.log(w),O=.5*Math.exp(2*I/3),z=.5*Math.sqrt(I*O*(w-O)/w)*(C-w/2<0?-1:1);nu(i,e,Math.max(r,Math.floor(e-C*O/w+z)),Math.min(o,Math.floor(e+(w-C)*O/w+z)),f)}var B=i[e],N=r,W=o;for(ql(i,r,e),f(i[o],B)>0&&ql(i,r,o);N<W;){for(ql(i,N,W),N++,W--;f(i[N],B)<0;)N++;for(;f(i[W],B)>0;)W--}f(i[r],B)===0?ql(i,r,W):ql(i,++W,o),W<=e&&(r=W+1),e<=W&&(o=W-1)}}function ql(i,e,r){var o=i[e];i[e]=i[r],i[r]=o}function yf(i,e){return i<e?-1:i>e?1:0}function Jc(i,e){const r=i.length;if(r<=1)return[i];const o=[];let f,w;for(let C=0;C<r;C++){const I=vt(i[C]);I!==0&&(i[C].area=Math.abs(I),w===void 0&&(w=I<0),w===I<0?(f&&o.push(f),f=[i[C]]):f.push(i[C]))}if(f&&o.push(f),e>1)for(let C=0;C<o.length;C++)o[C].length<=e||(_f(o[C],e,1,o[C].length-1,vf),o[C]=o[C].slice(0,e));return o}function vf(i,e){return e.area-i.area}function Qc(i,e,r){const o=r.patternDependencies;let f=!1;for(const w of e){const C=w.paint.get(`${i}-pattern`);C.isConstant()||(f=!0);const I=C.constantOr(null);I&&(f=!0,o[I.to]=!0,o[I.from]=!0)}return f}function eh(i,e,r,o,f){const w=f.patternDependencies;for(const C of e){const I=C.paint.get(`${i}-pattern`).value;if(I.kind!=="constant"){let O=I.evaluate({zoom:o-1},r,{},f.availableImages),z=I.evaluate({zoom:o},r,{},f.availableImages),B=I.evaluate({zoom:o+1},r,{},f.availableImages);O=O&&O.name?O.name:O,z=z&&z.name?z.name:z,B=B&&B.name?B.name:B,w[O]=!0,w[z]=!0,w[B]=!0,r.patterns[C.id]={min:O,mid:z,max:B}}}return r}class th{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new he,this.indexArray=new rt,this.indexArray2=new xt,this.programConfigurations=new xr(e.layers,e.zoom),this.segments=new zt,this.segments2=new zt,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,o){this.hasPattern=Qc("fill",this.layers,r);const f=this.layers[0].layout.get("fill-sort-key"),w=!f.isConstant(),C=[];for(const{feature:I,id:O,index:z,sourceLayerIndex:B}of e){const N=this.layers[0]._featureFilter.needGeometry,W=So(I,N);if(!this.layers[0]._featureFilter.filter(new fr(this.zoom),W,o))continue;const Z=w?f.evaluate(W,{},o,r.availableImages):void 0,J={id:O,properties:I.properties,type:I.type,sourceLayerIndex:B,index:z,geometry:N?W.geometry:Co(I),patterns:{},sortKey:Z};C.push(J)}w&&C.sort((I,O)=>I.sortKey-O.sortKey);for(const I of C){const{geometry:O,index:z,sourceLayerIndex:B}=I;if(this.hasPattern){const N=eh("fill",this.layers,I,this.zoom,r);this.patternFeatures.push(N)}else this.addFeature(I,O,z,o,{});r.featureIndex.insert(e[z].feature,O,z,B,this.index)}}update(e,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,o)}addFeatures(e,r,o){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,r,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,af),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,r,o,f,w){for(const C of Jc(r,500)){let I=0;for(const Z of C)I+=Z.length;const O=this.segments.prepareSegment(I,this.layoutVertexArray,this.indexArray),z=O.vertexLength,B=[],N=[];for(const Z of C){if(Z.length===0)continue;Z!==C[0]&&N.push(B.length/2);const J=this.segments2.prepareSegment(Z.length,this.layoutVertexArray,this.indexArray2),se=J.vertexLength;this.layoutVertexArray.emplaceBack(Z[0].x,Z[0].y),this.indexArray2.emplaceBack(se+Z.length-1,se),B.push(Z[0].x),B.push(Z[0].y);for(let de=1;de<Z.length;de++)this.layoutVertexArray.emplaceBack(Z[de].x,Z[de].y),this.indexArray2.emplaceBack(se+de-1,se+de),B.push(Z[de].x),B.push(Z[de].y);J.vertexLength+=Z.length,J.primitiveLength+=Z.length}const W=ru(B,N);for(let Z=0;Z<W.length;Z+=3)this.indexArray.emplaceBack(z+W[Z],z+W[Z+1],z+W[Z+2]);O.vertexLength+=I,O.primitiveLength+=W.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,w,f)}}let su,ou;qt("FillBucket",th,{omit:["layers","patternFeatures"]});var xf={get paint(){return ou=ou||new Mn({"fill-antialias":new si(le.paint_fill["fill-antialias"]),"fill-opacity":new hi(le.paint_fill["fill-opacity"]),"fill-color":new hi(le.paint_fill["fill-color"]),"fill-outline-color":new hi(le.paint_fill["fill-outline-color"]),"fill-translate":new si(le.paint_fill["fill-translate"]),"fill-translate-anchor":new si(le.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ja(le.paint_fill["fill-pattern"])})},get layout(){return su=su||new Mn({"fill-sort-key":new hi(le.layout_fill["fill-sort-key"])})}};class bf extends ds{constructor(e){super(e,xf)}recalculate(e,r){super.recalculate(e,r);const o=this.paint._values["fill-outline-color"];o.value.kind==="constant"&&o.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(e){return new th(e)}queryRadius(){return mc(this.paint.get("fill-translate"))}queryIntersectsFeature(e,r,o,f,w,C,I){return Bl(gc(e,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),C.angle,I),f)}isTileClipped(){return!0}}const wf=Dr([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),Cf=Dr([{name:"a_centroid",components:2,type:"Int16"}],4),{members:Sf}=wf;var Jo={},Tf=b,au=ul;function ul(i,e,r,o,f){this.properties={},this.extent=r,this.type=0,this._pbf=i,this._geometry=-1,this._keys=o,this._values=f,i.readFields(Ef,this,e)}function Ef(i,e,r){i==1?e.id=r.readVarint():i==2?function(o,f){for(var w=o.readVarint()+o.pos;o.pos<w;){var C=f._keys[o.readVarint()],I=f._values[o.readVarint()];f.properties[C]=I}}(r,e):i==3?e.type=r.readVarint():i==4&&(e._geometry=r.pos)}function If(i){for(var e,r,o=0,f=0,w=i.length,C=w-1;f<w;C=f++)o+=((r=i[C]).x-(e=i[f]).x)*(e.y+r.y);return o}ul.types=["Unknown","Point","LineString","Polygon"],ul.prototype.loadGeometry=function(){var i=this._pbf;i.pos=this._geometry;for(var e,r=i.readVarint()+i.pos,o=1,f=0,w=0,C=0,I=[];i.pos<r;){if(f<=0){var O=i.readVarint();o=7&O,f=O>>3}if(f--,o===1||o===2)w+=i.readSVarint(),C+=i.readSVarint(),o===1&&(e&&I.push(e),e=[]),e.push(new Tf(w,C));else{if(o!==7)throw new Error("unknown command "+o);e&&e.push(e[0].clone())}}return e&&I.push(e),I},ul.prototype.bbox=function(){var i=this._pbf;i.pos=this._geometry;for(var e=i.readVarint()+i.pos,r=1,o=0,f=0,w=0,C=1/0,I=-1/0,O=1/0,z=-1/0;i.pos<e;){if(o<=0){var B=i.readVarint();r=7&B,o=B>>3}if(o--,r===1||r===2)(f+=i.readSVarint())<C&&(C=f),f>I&&(I=f),(w+=i.readSVarint())<O&&(O=w),w>z&&(z=w);else if(r!==7)throw new Error("unknown command "+r)}return[C,O,I,z]},ul.prototype.toGeoJSON=function(i,e,r){var o,f,w=this.extent*Math.pow(2,r),C=this.extent*i,I=this.extent*e,O=this.loadGeometry(),z=ul.types[this.type];function B(Z){for(var J=0;J<Z.length;J++){var se=Z[J];Z[J]=[360*(se.x+C)/w-180,360/Math.PI*Math.atan(Math.exp((180-360*(se.y+I)/w)*Math.PI/180))-90]}}switch(this.type){case 1:var N=[];for(o=0;o<O.length;o++)N[o]=O[o][0];B(O=N);break;case 2:for(o=0;o<O.length;o++)B(O[o]);break;case 3:for(O=function(Z){var J=Z.length;if(J<=1)return[Z];for(var se,de,Ce=[],Ve=0;Ve<J;Ve++){var Se=If(Z[Ve]);Se!==0&&(de===void 0&&(de=Se<0),de===Se<0?(se&&Ce.push(se),se=[Z[Ve]]):se.push(Z[Ve]))}return se&&Ce.push(se),Ce}(O),o=0;o<O.length;o++)for(f=0;f<O[o].length;f++)B(O[o][f])}O.length===1?O=O[0]:z="Multi"+z;var W={type:"Feature",geometry:{type:z,coordinates:O},properties:this.properties};return"id"in this&&(W.id=this.id),W};var Pf=au,lu=cu;function cu(i,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=i,this._keys=[],this._values=[],this._features=[],i.readFields(Af,this,e),this.length=this._features.length}function Af(i,e,r){i===15?e.version=r.readVarint():i===1?e.name=r.readString():i===5?e.extent=r.readVarint():i===2?e._features.push(r.pos):i===3?e._keys.push(r.readString()):i===4&&e._values.push(function(o){for(var f=null,w=o.readVarint()+o.pos;o.pos<w;){var C=o.readVarint()>>3;f=C===1?o.readString():C===2?o.readFloat():C===3?o.readDouble():C===4?o.readVarint64():C===5?o.readVarint():C===6?o.readSVarint():C===7?o.readBoolean():null}return f}(r))}cu.prototype.feature=function(i){if(i<0||i>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[i];var e=this._pbf.readVarint()+this._pbf.pos;return new Pf(this._pbf,e,this.extent,this._keys,this._values)};var Mf=lu;function kf(i,e,r){if(i===3){var o=new Mf(r,r.readVarint()+r.pos);o.length&&(e[o.name]=o)}}Jo.VectorTile=function(i,e){this.layers=i.readFields(kf,{},e)},Jo.VectorTileFeature=au,Jo.VectorTileLayer=lu;const Of=Jo.VectorTileFeature.types,ih=Math.pow(2,13);function $l(i,e,r,o,f,w,C,I){i.emplaceBack(e,r,2*Math.floor(o*ih)+C,f*ih*2,w*ih*2,Math.round(I))}class rh{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new ce,this.centroidVertexArray=new G,this.indexArray=new rt,this.programConfigurations=new xr(e.layers,e.zoom),this.segments=new zt,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,o){this.features=[],this.hasPattern=Qc("fill-extrusion",this.layers,r);for(const{feature:f,id:w,index:C,sourceLayerIndex:I}of e){const O=this.layers[0]._featureFilter.needGeometry,z=So(f,O);if(!this.layers[0]._featureFilter.filter(new fr(this.zoom),z,o))continue;const B={id:w,sourceLayerIndex:I,index:C,geometry:O?z.geometry:Co(f),properties:f.properties,type:f.type,patterns:{}};this.hasPattern?this.features.push(eh("fill-extrusion",this.layers,B,this.zoom,r)):this.addFeature(B,B.geometry,C,o,{}),r.featureIndex.insert(f,B.geometry,C,I,this.index,!0)}}addFeatures(e,r,o){for(const f of this.features){const{geometry:w}=f;this.addFeature(f,w,f.index,r,o)}}update(e,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,o)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Sf),this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,Cf.members,!0),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(e,r,o,f,w){const C={x:0,y:0,vertexCount:0};for(const I of Jc(r,500)){let O=0;for(const J of I)O+=J.length;let z=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);for(const J of I){if(J.length===0||Lf(J))continue;let se=0;for(let de=0;de<J.length;de++){const Ce=J[de];if(de>=1){const Ve=J[de-1];if(!Df(Ce,Ve)){z.vertexLength+4>zt.MAX_VERTEX_ARRAY_LENGTH&&(z=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const Se=Ce.sub(Ve)._perp()._unit(),De=Ve.dist(Ce);se+De>32768&&(se=0),$l(this.layoutVertexArray,Ce.x,Ce.y,Se.x,Se.y,0,0,se),$l(this.layoutVertexArray,Ce.x,Ce.y,Se.x,Se.y,0,1,se),C.x+=2*Ce.x,C.y+=2*Ce.y,C.vertexCount+=2,se+=De,$l(this.layoutVertexArray,Ve.x,Ve.y,Se.x,Se.y,0,0,se),$l(this.layoutVertexArray,Ve.x,Ve.y,Se.x,Se.y,0,1,se),C.x+=2*Ve.x,C.y+=2*Ve.y,C.vertexCount+=2;const ht=z.vertexLength;this.indexArray.emplaceBack(ht,ht+2,ht+1),this.indexArray.emplaceBack(ht+1,ht+2,ht+3),z.vertexLength+=4,z.primitiveLength+=2}}}}if(z.vertexLength+O>zt.MAX_VERTEX_ARRAY_LENGTH&&(z=this.segments.prepareSegment(O,this.layoutVertexArray,this.indexArray)),Of[e.type]!=="Polygon")continue;const B=[],N=[],W=z.vertexLength;for(const J of I)if(J.length!==0){J!==I[0]&&N.push(B.length/2);for(let se=0;se<J.length;se++){const de=J[se];$l(this.layoutVertexArray,de.x,de.y,0,0,1,1,0),C.x+=de.x,C.y+=de.y,C.vertexCount+=1,B.push(de.x),B.push(de.y)}}const Z=ru(B,N);for(let J=0;J<Z.length;J+=3)this.indexArray.emplaceBack(W+Z[J],W+Z[J+2],W+Z[J+1]);z.primitiveLength+=Z.length/3,z.vertexLength+=O}for(let I=0;I<C.vertexCount;I++)this.centroidVertexArray.emplaceBack(Math.floor(C.x/C.vertexCount),Math.floor(C.y/C.vertexCount));this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,w,f)}}function Df(i,e){return i.x===e.x&&(i.x<0||i.x>Mr)||i.y===e.y&&(i.y<0||i.y>Mr)}function Lf(i){return i.every(e=>e.x<0)||i.every(e=>e.x>Mr)||i.every(e=>e.y<0)||i.every(e=>e.y>Mr)}let hu;qt("FillExtrusionBucket",rh,{omit:["layers","features"]});var zf={get paint(){return hu=hu||new Mn({"fill-extrusion-opacity":new si(le["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new hi(le["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new si(le["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new si(le["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ja(le["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new hi(le["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new hi(le["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new si(le["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class Ff extends ds{constructor(e){super(e,zf)}createBucket(e){return new rh(e)}queryRadius(){return mc(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature(e,r,o,f,w,C,I,O){const z=gc(e,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),C.angle,I),B=this.paint.get("fill-extrusion-height").evaluate(r,o),N=this.paint.get("fill-extrusion-base").evaluate(r,o),W=function(J,se,de,Ce){const Ve=[];for(const Se of J){const De=[Se.x,Se.y,0,1];_c(De,De,se),Ve.push(new a(De[0]/De[3],De[1]/De[3]))}return Ve}(z,O),Z=function(J,se,de,Ce){const Ve=[],Se=[],De=Ce[8]*se,ht=Ce[9]*se,gt=Ce[10]*se,$t=Ce[11]*se,ei=Ce[8]*de,Xt=Ce[9]*de,Ut=Ce[10]*de,Lt=Ce[11]*de;for(const Kt of J){const jt=[],St=[];for(const ci of Kt){const ni=ci.x,ki=ci.y,hr=Ce[0]*ni+Ce[4]*ki+Ce[12],mr=Ce[1]*ni+Ce[5]*ki+Ce[13],$r=Ce[2]*ni+Ce[6]*ki+Ce[14],rs=Ce[3]*ni+Ce[7]*ki+Ce[15],On=$r+gt,jr=rs+$t,un=hr+ei,pn=mr+Xt,Dn=$r+Ut,Ln=rs+Lt,Yr=new a((hr+De)/jr,(mr+ht)/jr);Yr.z=On/jr,jt.push(Yr);const Zr=new a(un/Ln,pn/Ln);Zr.z=Dn/Ln,St.push(Zr)}Ve.push(jt),Se.push(St)}return[Ve,Se]}(f,N,B,O);return function(J,se,de){let Ce=1/0;Bl(de,se)&&(Ce=uu(de,se[0]));for(let Ve=0;Ve<se.length;Ve++){const Se=se[Ve],De=J[Ve];for(let ht=0;ht<Se.length-1;ht++){const gt=Se[ht],$t=[gt,Se[ht+1],De[ht+1],De[ht],gt];Rl(de,$t)&&(Ce=Math.min(Ce,uu(de,$t)))}}return Ce!==1/0&&Ce}(Z[0],Z[1],W)}}function Yl(i,e){return i.x*e.x+i.y*e.y}function uu(i,e){if(i.length===1){let r=0;const o=e[r++];let f;for(;!f||o.equals(f);)if(f=e[r++],!f)return 1/0;for(;r<e.length;r++){const w=e[r],C=i[0],I=f.sub(o),O=w.sub(o),z=C.sub(o),B=Yl(I,I),N=Yl(I,O),W=Yl(O,O),Z=Yl(z,I),J=Yl(z,O),se=B*W-N*N,de=(W*Z-N*J)/se,Ce=(B*J-N*Z)/se,Ve=o.z*(1-de-Ce)+f.z*de+w.z*Ce;if(isFinite(Ve))return Ve}return 1/0}{let r=1/0;for(const o of e)r=Math.min(r,o.z);return r}}const Rf=Dr([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:Bf}=Rf,jf=Dr([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:Nf}=jf,Vf=Jo.VectorTileFeature.types,Uf=Math.cos(Math.PI/180*37.5),du=Math.pow(2,14)/.5;class nh{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(r=>{this.gradients[r.id]={}}),this.layoutVertexArray=new fe,this.layoutVertexArray2=new ne,this.indexArray=new rt,this.programConfigurations=new xr(e.layers,e.zoom),this.segments=new zt,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,o){this.hasPattern=Qc("line",this.layers,r);const f=this.layers[0].layout.get("line-sort-key"),w=!f.isConstant(),C=[];for(const{feature:I,id:O,index:z,sourceLayerIndex:B}of e){const N=this.layers[0]._featureFilter.needGeometry,W=So(I,N);if(!this.layers[0]._featureFilter.filter(new fr(this.zoom),W,o))continue;const Z=w?f.evaluate(W,{},o):void 0,J={id:O,properties:I.properties,type:I.type,sourceLayerIndex:B,index:z,geometry:N?W.geometry:Co(I),patterns:{},sortKey:Z};C.push(J)}w&&C.sort((I,O)=>I.sortKey-O.sortKey);for(const I of C){const{geometry:O,index:z,sourceLayerIndex:B}=I;if(this.hasPattern){const N=eh("line",this.layers,I,this.zoom,r);this.patternFeatures.push(N)}else this.addFeature(I,O,z,o,{});r.featureIndex.insert(e[z].feature,O,z,B,this.index)}}update(e,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,o)}addFeatures(e,r,o){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,r,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,Nf)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Bf),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&Object.prototype.hasOwnProperty.call(e.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(e.properties,"mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,r,o,f,w){const C=this.layers[0].layout,I=C.get("line-join").evaluate(e,{}),O=C.get("line-cap"),z=C.get("line-miter-limit"),B=C.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const N of r)this.addLine(N,e,I,O,z,B);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,w,f)}addLine(e,r,o,f,w,C){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Ce=0;Ce<e.length-1;Ce++)this.totalDistance+=e[Ce].dist(e[Ce+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const I=Vf[r.type]==="Polygon";let O=e.length;for(;O>=2&&e[O-1].equals(e[O-2]);)O--;let z=0;for(;z<O-1&&e[z].equals(e[z+1]);)z++;if(O<(I?3:2))return;o==="bevel"&&(w=1.05);const B=this.overscaling<=16?15*Mr/(512*this.overscaling):0,N=this.segments.prepareSegment(10*O,this.layoutVertexArray,this.indexArray);let W,Z,J,se,de;this.e1=this.e2=-1,I&&(W=e[O-2],de=e[z].sub(W)._unit()._perp());for(let Ce=z;Ce<O;Ce++){if(J=Ce===O-1?I?e[z+1]:void 0:e[Ce+1],J&&e[Ce].equals(J))continue;de&&(se=de),W&&(Z=W),W=e[Ce],de=J?J.sub(W)._unit()._perp():se,se=se||de;let Ve=se.add(de);Ve.x===0&&Ve.y===0||Ve._unit();const Se=se.x*de.x+se.y*de.y,De=Ve.x*de.x+Ve.y*de.y,ht=De!==0?1/De:1/0,gt=2*Math.sqrt(2-2*De),$t=De<Uf&&Z&&J,ei=se.x*de.y-se.y*de.x>0;if($t&&Ce>z){const Lt=W.dist(Z);if(Lt>2*B){const Kt=W.sub(W.sub(Z)._mult(B/Lt)._round());this.updateDistance(Z,Kt),this.addCurrentVertex(Kt,se,0,0,N),Z=Kt}}const Xt=Z&&J;let Ut=Xt?o:I?"butt":f;if(Xt&&Ut==="round"&&(ht<C?Ut="miter":ht<=2&&(Ut="fakeround")),Ut==="miter"&&ht>w&&(Ut="bevel"),Ut==="bevel"&&(ht>2&&(Ut="flipbevel"),ht<w&&(Ut="miter")),Z&&this.updateDistance(Z,W),Ut==="miter")Ve._mult(ht),this.addCurrentVertex(W,Ve,0,0,N);else if(Ut==="flipbevel"){if(ht>100)Ve=de.mult(-1);else{const Lt=ht*se.add(de).mag()/se.sub(de).mag();Ve._perp()._mult(Lt*(ei?-1:1))}this.addCurrentVertex(W,Ve,0,0,N),this.addCurrentVertex(W,Ve.mult(-1),0,0,N)}else if(Ut==="bevel"||Ut==="fakeround"){const Lt=-Math.sqrt(ht*ht-1),Kt=ei?Lt:0,jt=ei?0:Lt;if(Z&&this.addCurrentVertex(W,se,Kt,jt,N),Ut==="fakeround"){const St=Math.round(180*gt/Math.PI/20);for(let ci=1;ci<St;ci++){let ni=ci/St;if(ni!==.5){const hr=ni-.5;ni+=ni*hr*(ni-1)*((1.0904+Se*(Se*(3.55645-1.43519*Se)-3.2452))*hr*hr+(.848013+Se*(.215638*Se-1.06021)))}const ki=de.sub(se)._mult(ni)._add(se)._unit()._mult(ei?-1:1);this.addHalfVertex(W,ki.x,ki.y,!1,ei,0,N)}}J&&this.addCurrentVertex(W,de,-Kt,-jt,N)}else if(Ut==="butt")this.addCurrentVertex(W,Ve,0,0,N);else if(Ut==="square"){const Lt=Z?1:-1;this.addCurrentVertex(W,Ve,Lt,Lt,N)}else Ut==="round"&&(Z&&(this.addCurrentVertex(W,se,0,0,N),this.addCurrentVertex(W,se,1,1,N,!0)),J&&(this.addCurrentVertex(W,de,-1,-1,N,!0),this.addCurrentVertex(W,de,0,0,N)));if($t&&Ce<O-1){const Lt=W.dist(J);if(Lt>2*B){const Kt=W.add(J.sub(W)._mult(B/Lt)._round());this.updateDistance(W,Kt),this.addCurrentVertex(Kt,de,0,0,N),W=Kt}}}}addCurrentVertex(e,r,o,f,w,C=!1){const I=r.y*f-r.x,O=-r.y-r.x*f;this.addHalfVertex(e,r.x+r.y*o,r.y-r.x*o,C,!1,o,w),this.addHalfVertex(e,I,O,C,!0,-f,w),this.distance>du/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(e,r,o,f,w,C))}addHalfVertex({x:e,y:r},o,f,w,C,I,O){const z=.5*(this.lineClips?this.scaledDistance*(du-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((e<<1)+(w?1:0),(r<<1)+(C?1:0),Math.round(63*o)+128,Math.round(63*f)+128,1+(I===0?0:I<0?-1:1)|(63&z)<<2,z>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const B=O.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,B),O.primitiveLength++),C?this.e2=B:this.e1=B}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(e,r){this.distance+=e.dist(r),this.updateScaledDistance()}}let fu,pu;qt("LineBucket",nh,{omit:["layers","patternFeatures"]});var mu={get paint(){return pu=pu||new Mn({"line-opacity":new hi(le.paint_line["line-opacity"]),"line-color":new hi(le.paint_line["line-color"]),"line-translate":new si(le.paint_line["line-translate"]),"line-translate-anchor":new si(le.paint_line["line-translate-anchor"]),"line-width":new hi(le.paint_line["line-width"]),"line-gap-width":new hi(le.paint_line["line-gap-width"]),"line-offset":new hi(le.paint_line["line-offset"]),"line-blur":new hi(le.paint_line["line-blur"]),"line-dasharray":new Ta(le.paint_line["line-dasharray"]),"line-pattern":new Ja(le.paint_line["line-pattern"]),"line-gradient":new Il(le.paint_line["line-gradient"])})},get layout(){return fu=fu||new Mn({"line-cap":new si(le.layout_line["line-cap"]),"line-join":new hi(le.layout_line["line-join"]),"line-miter-limit":new si(le.layout_line["line-miter-limit"]),"line-round-limit":new si(le.layout_line["line-round-limit"]),"line-sort-key":new hi(le.layout_line["line-sort-key"])})}};class Gf extends hi{possiblyEvaluate(e,r){return r=new fr(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,zoomHistory:r.zoomHistory,transition:r.transition}),super.possiblyEvaluate(e,r)}evaluate(e,r,o,f){return r=ie({},r,{zoom:Math.floor(r.zoom)}),super.evaluate(e,r,o,f)}}let wc;class Hf extends ds{constructor(e){super(e,mu),this.gradientVersion=0,wc||(wc=new Gf(mu.paint.properties["line-width"].specification),wc.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(e){if(e==="line-gradient"){const r=this.gradientExpression();this.stepInterpolant=!!function(o){return o._styleExpression!==void 0}(r)&&r._styleExpression.expression instanceof Xs,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(e,r){super.recalculate(e,r),this.paint._values["line-floorwidth"]=wc.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e)}createBucket(e){return new nh(e)}queryRadius(e){const r=e,o=gu(Vl("line-width",this,r),Vl("line-gap-width",this,r)),f=Vl("line-offset",this,r);return o/2+Math.abs(f)+mc(this.paint.get("line-translate"))}queryIntersectsFeature(e,r,o,f,w,C,I){const O=gc(e,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),C.angle,I),z=I/2*gu(this.paint.get("line-width").evaluate(r,o),this.paint.get("line-gap-width").evaluate(r,o)),B=this.paint.get("line-offset").evaluate(r,o);return B&&(f=function(N,W){const Z=[];for(let J=0;J<N.length;J++){const se=N[J],de=[];for(let Ce=0;Ce<se.length;Ce++){const Ve=se[Ce-1],Se=se[Ce],De=se[Ce+1],ht=Ce===0?new a(0,0):Se.sub(Ve)._unit()._perp(),gt=Ce===se.length-1?new a(0,0):De.sub(Se)._unit()._perp(),$t=ht._add(gt)._unit(),ei=$t.x*gt.x+$t.y*gt.y;ei!==0&&$t._mult(1/ei),de.push($t._mult(W)._add(Se))}Z.push(de)}return Z}(f,B*I)),function(N,W,Z){for(let J=0;J<W.length;J++){const se=W[J];if(N.length>=3){for(let de=0;de<se.length;de++)if(ll(N,se[de]))return!0}if(jl(N,se,Z))return!0}return!1}(O,f,z)}isTileClipped(){return!0}}function gu(i,e){return e>0?e+2*i:i}const Wf=Dr([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Xf=Dr([{name:"a_projected_pos",components:3,type:"Float32"}],4);Dr([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const qf=Dr([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]);Dr([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const _u=Dr([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),$f=Dr([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function Yf(i,e,r){return i.sections.forEach(o=>{o.text=function(f,w,C){const I=w.layout.get("text-transform").evaluate(C,{});return I==="uppercase"?f=f.toLocaleUpperCase():I==="lowercase"&&(f=f.toLocaleLowerCase()),Qs.applyArabicShaping&&(f=Qs.applyArabicShaping(f)),f}(o.text,e,r)}),i}Dr([{name:"triangle",components:3,type:"Uint16"}]),Dr([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),Dr([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),Dr([{type:"Float32",name:"offsetX"}]),Dr([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),Dr([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);const Zl={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"};var qr=24,yu=ir,vu=function(i,e,r,o,f){var w,C,I=8*f-o-1,O=(1<<I)-1,z=O>>1,B=-7,N=r?f-1:0,W=r?-1:1,Z=i[e+N];for(N+=W,w=Z&(1<<-B)-1,Z>>=-B,B+=I;B>0;w=256*w+i[e+N],N+=W,B-=8);for(C=w&(1<<-B)-1,w>>=-B,B+=o;B>0;C=256*C+i[e+N],N+=W,B-=8);if(w===0)w=1-z;else{if(w===O)return C?NaN:1/0*(Z?-1:1);C+=Math.pow(2,o),w-=z}return(Z?-1:1)*C*Math.pow(2,w-o)},xu=function(i,e,r,o,f,w){var C,I,O,z=8*w-f-1,B=(1<<z)-1,N=B>>1,W=f===23?Math.pow(2,-24)-Math.pow(2,-77):0,Z=o?0:w-1,J=o?1:-1,se=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(I=isNaN(e)?1:0,C=B):(C=Math.floor(Math.log(e)/Math.LN2),e*(O=Math.pow(2,-C))<1&&(C--,O*=2),(e+=C+N>=1?W/O:W*Math.pow(2,1-N))*O>=2&&(C++,O/=2),C+N>=B?(I=0,C=B):C+N>=1?(I=(e*O-1)*Math.pow(2,f),C+=N):(I=e*Math.pow(2,N-1)*Math.pow(2,f),C=0));f>=8;i[r+Z]=255&I,Z+=J,I/=256,f-=8);for(C=C<<f|I,z+=f;z>0;i[r+Z]=255&C,Z+=J,C/=256,z-=8);i[r+Z-J]|=128*se};function ir(i){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(i)?i:new Uint8Array(i||0),this.pos=0,this.type=0,this.length=this.buf.length}ir.Varint=0,ir.Fixed64=1,ir.Bytes=2,ir.Fixed32=5;var sh=4294967296,bu=1/sh,wu=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function To(i){return i.type===ir.Bytes?i.readVarint()+i.pos:i.pos+1}function dl(i,e,r){return r?4294967296*e+(i>>>0):4294967296*(e>>>0)+(i>>>0)}function Cu(i,e,r){var o=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));r.realloc(o);for(var f=r.pos-1;f>=i;f--)r.buf[f+o]=r.buf[f]}function Zf(i,e){for(var r=0;r<i.length;r++)e.writeVarint(i[r])}function Kf(i,e){for(var r=0;r<i.length;r++)e.writeSVarint(i[r])}function Jf(i,e){for(var r=0;r<i.length;r++)e.writeFloat(i[r])}function Qf(i,e){for(var r=0;r<i.length;r++)e.writeDouble(i[r])}function ep(i,e){for(var r=0;r<i.length;r++)e.writeBoolean(i[r])}function tp(i,e){for(var r=0;r<i.length;r++)e.writeFixed32(i[r])}function ip(i,e){for(var r=0;r<i.length;r++)e.writeSFixed32(i[r])}function rp(i,e){for(var r=0;r<i.length;r++)e.writeFixed64(i[r])}function np(i,e){for(var r=0;r<i.length;r++)e.writeSFixed64(i[r])}function Cc(i,e){return(i[e]|i[e+1]<<8|i[e+2]<<16)+16777216*i[e+3]}function fl(i,e,r){i[r]=e,i[r+1]=e>>>8,i[r+2]=e>>>16,i[r+3]=e>>>24}function Su(i,e){return(i[e]|i[e+1]<<8|i[e+2]<<16)+(i[e+3]<<24)}ir.prototype={destroy:function(){this.buf=null},readFields:function(i,e,r){for(r=r||this.length;this.pos<r;){var o=this.readVarint(),f=o>>3,w=this.pos;this.type=7&o,i(f,e,this),this.pos===w&&this.skip(o)}return e},readMessage:function(i,e){return this.readFields(i,e,this.readVarint()+this.pos)},readFixed32:function(){var i=Cc(this.buf,this.pos);return this.pos+=4,i},readSFixed32:function(){var i=Su(this.buf,this.pos);return this.pos+=4,i},readFixed64:function(){var i=Cc(this.buf,this.pos)+Cc(this.buf,this.pos+4)*sh;return this.pos+=8,i},readSFixed64:function(){var i=Cc(this.buf,this.pos)+Su(this.buf,this.pos+4)*sh;return this.pos+=8,i},readFloat:function(){var i=vu(this.buf,this.pos,!0,23,4);return this.pos+=4,i},readDouble:function(){var i=vu(this.buf,this.pos,!0,52,8);return this.pos+=8,i},readVarint:function(i){var e,r,o=this.buf;return e=127&(r=o[this.pos++]),r<128?e:(e|=(127&(r=o[this.pos++]))<<7,r<128?e:(e|=(127&(r=o[this.pos++]))<<14,r<128?e:(e|=(127&(r=o[this.pos++]))<<21,r<128?e:function(f,w,C){var I,O,z=C.buf;if(I=(112&(O=z[C.pos++]))>>4,O<128||(I|=(127&(O=z[C.pos++]))<<3,O<128)||(I|=(127&(O=z[C.pos++]))<<10,O<128)||(I|=(127&(O=z[C.pos++]))<<17,O<128)||(I|=(127&(O=z[C.pos++]))<<24,O<128)||(I|=(1&(O=z[C.pos++]))<<31,O<128))return dl(f,I,w);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(r=o[this.pos]))<<28,i,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var i=this.readVarint();return i%2==1?(i+1)/-2:i/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var i=this.readVarint()+this.pos,e=this.pos;return this.pos=i,i-e>=12&&wu?function(r,o,f){return wu.decode(r.subarray(o,f))}(this.buf,e,i):function(r,o,f){for(var w="",C=o;C<f;){var I,O,z,B=r[C],N=null,W=B>239?4:B>223?3:B>191?2:1;if(C+W>f)break;W===1?B<128&&(N=B):W===2?(192&(I=r[C+1]))==128&&(N=(31&B)<<6|63&I)<=127&&(N=null):W===3?(O=r[C+2],(192&(I=r[C+1]))==128&&(192&O)==128&&((N=(15&B)<<12|(63&I)<<6|63&O)<=2047||N>=55296&&N<=57343)&&(N=null)):W===4&&(O=r[C+2],z=r[C+3],(192&(I=r[C+1]))==128&&(192&O)==128&&(192&z)==128&&((N=(15&B)<<18|(63&I)<<12|(63&O)<<6|63&z)<=65535||N>=1114112)&&(N=null)),N===null?(N=65533,W=1):N>65535&&(N-=65536,w+=String.fromCharCode(N>>>10&1023|55296),N=56320|1023&N),w+=String.fromCharCode(N),C+=W}return w}(this.buf,e,i)},readBytes:function(){var i=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,i);return this.pos=i,e},readPackedVarint:function(i,e){if(this.type!==ir.Bytes)return i.push(this.readVarint(e));var r=To(this);for(i=i||[];this.pos<r;)i.push(this.readVarint(e));return i},readPackedSVarint:function(i){if(this.type!==ir.Bytes)return i.push(this.readSVarint());var e=To(this);for(i=i||[];this.pos<e;)i.push(this.readSVarint());return i},readPackedBoolean:function(i){if(this.type!==ir.Bytes)return i.push(this.readBoolean());var e=To(this);for(i=i||[];this.pos<e;)i.push(this.readBoolean());return i},readPackedFloat:function(i){if(this.type!==ir.Bytes)return i.push(this.readFloat());var e=To(this);for(i=i||[];this.pos<e;)i.push(this.readFloat());return i},readPackedDouble:function(i){if(this.type!==ir.Bytes)return i.push(this.readDouble());var e=To(this);for(i=i||[];this.pos<e;)i.push(this.readDouble());return i},readPackedFixed32:function(i){if(this.type!==ir.Bytes)return i.push(this.readFixed32());var e=To(this);for(i=i||[];this.pos<e;)i.push(this.readFixed32());return i},readPackedSFixed32:function(i){if(this.type!==ir.Bytes)return i.push(this.readSFixed32());var e=To(this);for(i=i||[];this.pos<e;)i.push(this.readSFixed32());return i},readPackedFixed64:function(i){if(this.type!==ir.Bytes)return i.push(this.readFixed64());var e=To(this);for(i=i||[];this.pos<e;)i.push(this.readFixed64());return i},readPackedSFixed64:function(i){if(this.type!==ir.Bytes)return i.push(this.readSFixed64());var e=To(this);for(i=i||[];this.pos<e;)i.push(this.readSFixed64());return i},skip:function(i){var e=7&i;if(e===ir.Varint)for(;this.buf[this.pos++]>127;);else if(e===ir.Bytes)this.pos=this.readVarint()+this.pos;else if(e===ir.Fixed32)this.pos+=4;else{if(e!==ir.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(i,e){this.writeVarint(i<<3|e)},realloc:function(i){for(var e=this.length||16;e<this.pos+i;)e*=2;if(e!==this.length){var r=new Uint8Array(e);r.set(this.buf),this.buf=r,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(i){this.realloc(4),fl(this.buf,i,this.pos),this.pos+=4},writeSFixed32:function(i){this.realloc(4),fl(this.buf,i,this.pos),this.pos+=4},writeFixed64:function(i){this.realloc(8),fl(this.buf,-1&i,this.pos),fl(this.buf,Math.floor(i*bu),this.pos+4),this.pos+=8},writeSFixed64:function(i){this.realloc(8),fl(this.buf,-1&i,this.pos),fl(this.buf,Math.floor(i*bu),this.pos+4),this.pos+=8},writeVarint:function(i){(i=+i||0)>268435455||i<0?function(e,r){var o,f;if(e>=0?(o=e%4294967296|0,f=e/4294967296|0):(f=~(-e/4294967296),4294967295^(o=~(-e%4294967296))?o=o+1|0:(o=0,f=f+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");r.realloc(10),function(w,C,I){I.buf[I.pos++]=127&w|128,w>>>=7,I.buf[I.pos++]=127&w|128,w>>>=7,I.buf[I.pos++]=127&w|128,w>>>=7,I.buf[I.pos++]=127&w|128,I.buf[I.pos]=127&(w>>>=7)}(o,0,r),function(w,C){var I=(7&w)<<4;C.buf[C.pos++]|=I|((w>>>=3)?128:0),w&&(C.buf[C.pos++]=127&w|((w>>>=7)?128:0),w&&(C.buf[C.pos++]=127&w|((w>>>=7)?128:0),w&&(C.buf[C.pos++]=127&w|((w>>>=7)?128:0),w&&(C.buf[C.pos++]=127&w|((w>>>=7)?128:0),w&&(C.buf[C.pos++]=127&w)))))}(f,r)}(i,this):(this.realloc(4),this.buf[this.pos++]=127&i|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=i>>>7&127))))},writeSVarint:function(i){this.writeVarint(i<0?2*-i-1:2*i)},writeBoolean:function(i){this.writeVarint(!!i)},writeString:function(i){i=String(i),this.realloc(4*i.length),this.pos++;var e=this.pos;this.pos=function(o,f,w){for(var C,I,O=0;O<f.length;O++){if((C=f.charCodeAt(O))>55295&&C<57344){if(!I){C>56319||O+1===f.length?(o[w++]=239,o[w++]=191,o[w++]=189):I=C;continue}if(C<56320){o[w++]=239,o[w++]=191,o[w++]=189,I=C;continue}C=I-55296<<10|C-56320|65536,I=null}else I&&(o[w++]=239,o[w++]=191,o[w++]=189,I=null);C<128?o[w++]=C:(C<2048?o[w++]=C>>6|192:(C<65536?o[w++]=C>>12|224:(o[w++]=C>>18|240,o[w++]=C>>12&63|128),o[w++]=C>>6&63|128),o[w++]=63&C|128)}return w}(this.buf,i,this.pos);var r=this.pos-e;r>=128&&Cu(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r},writeFloat:function(i){this.realloc(4),xu(this.buf,i,this.pos,!0,23,4),this.pos+=4},writeDouble:function(i){this.realloc(8),xu(this.buf,i,this.pos,!0,52,8),this.pos+=8},writeBytes:function(i){var e=i.length;this.writeVarint(e),this.realloc(e);for(var r=0;r<e;r++)this.buf[this.pos++]=i[r]},writeRawMessage:function(i,e){this.pos++;var r=this.pos;i(e,this);var o=this.pos-r;o>=128&&Cu(r,o,this),this.pos=r-1,this.writeVarint(o),this.pos+=o},writeMessage:function(i,e,r){this.writeTag(i,ir.Bytes),this.writeRawMessage(e,r)},writePackedVarint:function(i,e){e.length&&this.writeMessage(i,Zf,e)},writePackedSVarint:function(i,e){e.length&&this.writeMessage(i,Kf,e)},writePackedBoolean:function(i,e){e.length&&this.writeMessage(i,ep,e)},writePackedFloat:function(i,e){e.length&&this.writeMessage(i,Jf,e)},writePackedDouble:function(i,e){e.length&&this.writeMessage(i,Qf,e)},writePackedFixed32:function(i,e){e.length&&this.writeMessage(i,tp,e)},writePackedSFixed32:function(i,e){e.length&&this.writeMessage(i,ip,e)},writePackedFixed64:function(i,e){e.length&&this.writeMessage(i,rp,e)},writePackedSFixed64:function(i,e){e.length&&this.writeMessage(i,np,e)},writeBytesField:function(i,e){this.writeTag(i,ir.Bytes),this.writeBytes(e)},writeFixed32Field:function(i,e){this.writeTag(i,ir.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(i,e){this.writeTag(i,ir.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(i,e){this.writeTag(i,ir.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(i,e){this.writeTag(i,ir.Fixed64),this.writeSFixed64(e)},writeVarintField:function(i,e){this.writeTag(i,ir.Varint),this.writeVarint(e)},writeSVarintField:function(i,e){this.writeTag(i,ir.Varint),this.writeSVarint(e)},writeStringField:function(i,e){this.writeTag(i,ir.Bytes),this.writeString(e)},writeFloatField:function(i,e){this.writeTag(i,ir.Fixed32),this.writeFloat(e)},writeDoubleField:function(i,e){this.writeTag(i,ir.Fixed64),this.writeDouble(e)},writeBooleanField:function(i,e){this.writeVarintField(i,!!e)}};var oh=p(yu);const ah=3;function sp(i,e,r){i===1&&r.readMessage(op,e)}function op(i,e,r){if(i===3){const{id:o,bitmap:f,width:w,height:C,left:I,top:O,advance:z}=r.readMessage(ap,{});e.push({id:o,bitmap:new Gl({width:w+2*ah,height:C+2*ah},f),metrics:{width:w,height:C,left:I,top:O,advance:z}})}}function ap(i,e,r){i===1?e.id=r.readVarint():i===2?e.bitmap=r.readBytes():i===3?e.width=r.readVarint():i===4?e.height=r.readVarint():i===5?e.left=r.readSVarint():i===6?e.top=r.readSVarint():i===7&&(e.advance=r.readVarint())}const Tu=ah;function Eu(i){let e=0,r=0;for(const C of i)e+=C.w*C.h,r=Math.max(r,C.w);i.sort((C,I)=>I.h-C.h);const o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),r),h:1/0}];let f=0,w=0;for(const C of i)for(let I=o.length-1;I>=0;I--){const O=o[I];if(!(C.w>O.w||C.h>O.h)){if(C.x=O.x,C.y=O.y,w=Math.max(w,C.y+C.h),f=Math.max(f,C.x+C.w),C.w===O.w&&C.h===O.h){const z=o.pop();I<o.length&&(o[I]=z)}else C.h===O.h?(O.x+=C.w,O.w-=C.w):C.w===O.w?(O.y+=C.h,O.h-=C.h):(o.push({x:O.x+C.w,y:O.y,w:O.w-C.w,h:C.h}),O.y+=C.h,O.h-=C.h);break}}return{w:f,h:w,fill:e/(f*w)||0}}const Gn=1;class lh{constructor(e,{pixelRatio:r,version:o,stretchX:f,stretchY:w,content:C}){this.paddedRect=e,this.pixelRatio=r,this.stretchX=f,this.stretchY=w,this.content=C,this.version=o}get tl(){return[this.paddedRect.x+Gn,this.paddedRect.y+Gn]}get br(){return[this.paddedRect.x+this.paddedRect.w-Gn,this.paddedRect.y+this.paddedRect.h-Gn]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2*Gn)/this.pixelRatio,(this.paddedRect.h-2*Gn)/this.pixelRatio]}}class Iu{constructor(e,r){const o={},f={};this.haveRenderCallbacks=[];const w=[];this.addImages(e,o,w),this.addImages(r,f,w);const{w:C,h:I}=Eu(w),O=new fs({width:C||1,height:I||1});for(const z in e){const B=e[z],N=o[z].paddedRect;fs.copy(B.data,O,{x:0,y:0},{x:N.x+Gn,y:N.y+Gn},B.data)}for(const z in r){const B=r[z],N=f[z].paddedRect,W=N.x+Gn,Z=N.y+Gn,J=B.data.width,se=B.data.height;fs.copy(B.data,O,{x:0,y:0},{x:W,y:Z},B.data),fs.copy(B.data,O,{x:0,y:se-1},{x:W,y:Z-1},{width:J,height:1}),fs.copy(B.data,O,{x:0,y:0},{x:W,y:Z+se},{width:J,height:1}),fs.copy(B.data,O,{x:J-1,y:0},{x:W-1,y:Z},{width:1,height:se}),fs.copy(B.data,O,{x:0,y:0},{x:W+J,y:Z},{width:1,height:se})}this.image=O,this.iconPositions=o,this.patternPositions=f}addImages(e,r,o){for(const f in e){const w=e[f],C={x:0,y:0,w:w.data.width+2*Gn,h:w.data.height+2*Gn};o.push(C),r[f]=new lh(C,w),w.hasRenderCallback&&this.haveRenderCallbacks.push(f)}}patchUpdatedImages(e,r){e.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const o in e.updatedImages)this.patchUpdatedImage(this.iconPositions[o],e.getImage(o),r),this.patchUpdatedImage(this.patternPositions[o],e.getImage(o),r)}patchUpdatedImage(e,r,o){if(!e||!r||e.version===r.version)return;e.version=r.version;const[f,w]=e.tl;o.update(r.data,void 0,{x:f,y:w})}}var Qo;qt("ImagePosition",lh),qt("ImageAtlas",Iu),j.ah=void 0,(Qo=j.ah||(j.ah={}))[Qo.none=0]="none",Qo[Qo.horizontal=1]="horizontal",Qo[Qo.vertical=2]="vertical",Qo[Qo.horizontalOnly=3]="horizontalOnly";const Kl=-17;class Jl{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(e,r){const o=new Jl;return o.scale=e||1,o.fontStack=r,o}static forImage(e){const r=new Jl;return r.imageName=e,r}}class pl{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,r){const o=new pl;for(let f=0;f<e.sections.length;f++){const w=e.sections[f];w.image?o.addImageSection(w):o.addTextSection(w,r)}return o}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSectionIndex(e){return this.sectionIndex[e]}getCharCode(e){return this.text.charCodeAt(e)}verticalizePunctuation(){this.text=function(e){let r="";for(let o=0;o<e.length;o++){const f=e.charCodeAt(o+1)||null,w=e.charCodeAt(o-1)||null;r+=f&&Js(f)&&!Zl[e[o+1]]||w&&Js(w)&&!Zl[e[o-1]]||!Zl[e[o]]?e[o]:Zl[e[o]]}return r}(this.text)}trim(){let e=0;for(let o=0;o<this.text.length&&Tc[this.text.charCodeAt(o)];o++)e++;let r=this.text.length;for(let o=this.text.length-1;o>=0&&o>=e&&Tc[this.text.charCodeAt(o)];o--)r--;this.text=this.text.substring(e,r),this.sectionIndex=this.sectionIndex.slice(e,r)}substring(e,r){const o=new pl;return o.text=this.text.substring(e,r),o.sectionIndex=this.sectionIndex.slice(e,r),o.sections=this.sections,o}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,r)=>Math.max(e,this.sections[r].scale),0)}addTextSection(e,r){this.text+=e.text,this.sections.push(Jl.forText(e.scale,e.fontStack||r));const o=this.sections.length-1;for(let f=0;f<e.text.length;++f)this.sectionIndex.push(o)}addImageSection(e){const r=e.image?e.image.name:"";if(r.length===0)return void ct("Can't add FormattedSection with an empty image.");const o=this.getNextImageSectionCharCode();o?(this.text+=String.fromCharCode(o),this.sections.push(Jl.forImage(r)),this.sectionIndex.push(this.sections.length-1)):ct("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Sc(i,e,r,o,f,w,C,I,O,z,B,N,W,Z,J,se){const de=pl.fromFeature(i,f);let Ce;N===j.ah.vertical&&de.verticalizePunctuation();const{processBidirectionalText:Ve,processStyledBidirectionalText:Se}=Qs;if(Ve&&de.sections.length===1){Ce=[];const gt=Ve(de.toString(),ch(de,z,w,e,o,Z,J));for(const $t of gt){const ei=new pl;ei.text=$t,ei.sections=de.sections;for(let Xt=0;Xt<$t.length;Xt++)ei.sectionIndex.push(0);Ce.push(ei)}}else if(Se){Ce=[];const gt=Se(de.text,de.sectionIndex,ch(de,z,w,e,o,Z,J));for(const $t of gt){const ei=new pl;ei.text=$t[0],ei.sectionIndex=$t[1],ei.sections=de.sections,Ce.push(ei)}}else Ce=function(gt,$t){const ei=[],Xt=gt.text;let Ut=0;for(const Lt of $t)ei.push(gt.substring(Ut,Lt)),Ut=Lt;return Ut<Xt.length&&ei.push(gt.substring(Ut,Xt.length)),ei}(de,ch(de,z,w,e,o,Z,J));const De=[],ht={positionedLines:De,text:de.toString(),top:B[1],bottom:B[1],left:B[0],right:B[0],writingMode:N,iconsInText:!1,verticalizable:!1};return function(gt,$t,ei,Xt,Ut,Lt,Kt,jt,St,ci,ni,ki){let hr=0,mr=Kl,$r=0,rs=0;const On=jt==="right"?1:jt==="left"?0:.5;let jr=0;for(const Yr of Ut){Yr.trim();const Zr=Yr.getMaxScale(),vn=(Zr-1)*qr,zn={positionedGlyphs:[],lineOffset:0};gt.positionedLines[jr]=zn;const xn=zn.positionedGlyphs;let Hn=0;if(!Yr.length()){mr+=Lt,++jr;continue}for(let Kr=0;Kr<Yr.length();Kr++){const Li=Yr.getSection(Kr),bn=Yr.getSectionIndex(Kr),mn=Yr.getCharCode(Kr);let Jr=0,Is=null,Vs=null,Us=null,Eo=qr;const Ps=!(St===j.ah.horizontal||!ni&&!xo(mn)||ni&&(Tc[mn]||(un=mn,Vt.Arabic(un)||Vt["Arabic Supplement"](un)||Vt["Arabic Extended-A"](un)||Vt["Arabic Presentation Forms-A"](un)||Vt["Arabic Presentation Forms-B"](un))));if(Li.imageName){const ms=Xt[Li.imageName];if(!ms)continue;Us=Li.imageName,gt.iconsInText=gt.iconsInText||!0,Vs=ms.paddedRect;const Xn=ms.displaySize;Li.scale=Li.scale*qr/ki,Is={width:Xn[0],height:Xn[1],left:Gn,top:-Tu,advance:Ps?Xn[1]:Xn[0]},Jr=vn+(qr-Xn[1]*Li.scale),Eo=Is.advance;const Io=Ps?Xn[0]*Li.scale-qr*Zr:Xn[1]*Li.scale-qr*Zr;Io>0&&Io>Hn&&(Hn=Io)}else{const ms=ei[Li.fontStack],Xn=ms&&ms[mn];if(Xn&&Xn.rect)Vs=Xn.rect,Is=Xn.metrics;else{const Io=$t[Li.fontStack],rc=Io&&Io[mn];if(!rc)continue;Is=rc.metrics}Jr=(Zr-Li.scale)*qr}Ps?(gt.verticalizable=!0,xn.push({glyph:mn,imageName:Us,x:hr,y:mr+Jr,vertical:Ps,scale:Li.scale,fontStack:Li.fontStack,sectionIndex:bn,metrics:Is,rect:Vs}),hr+=Eo*Li.scale+ci):(xn.push({glyph:mn,imageName:Us,x:hr,y:mr+Jr,vertical:Ps,scale:Li.scale,fontStack:Li.fontStack,sectionIndex:bn,metrics:Is,rect:Vs}),hr+=Is.advance*Li.scale+ci)}xn.length!==0&&($r=Math.max(hr-ci,$r),hp(xn,0,xn.length-1,On,Hn)),hr=0;const Wn=Lt*Zr+Hn;zn.lineOffset=Math.max(Hn,vn),mr+=Wn,rs=Math.max(Wn,rs),++jr}var un;const pn=mr-Kl,{horizontalAlign:Dn,verticalAlign:Ln}=hh(Kt);(function(Yr,Zr,vn,zn,xn,Hn,Wn,Kr,Li){const bn=(Zr-vn)*xn;let mn=0;mn=Hn!==Wn?-Kr*zn-Kl:(-zn*Li+.5)*Wn;for(const Jr of Yr)for(const Is of Jr.positionedGlyphs)Is.x+=bn,Is.y+=mn})(gt.positionedLines,On,Dn,Ln,$r,rs,Lt,pn,Ut.length),gt.top+=-Ln*pn,gt.bottom=gt.top+pn,gt.left+=-Dn*$r,gt.right=gt.left+$r}(ht,e,r,o,Ce,C,I,O,N,z,W,se),!function(gt){for(const $t of gt)if($t.positionedGlyphs.length!==0)return!1;return!0}(De)&&ht}const Tc={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},lp={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Pu(i,e,r,o,f,w){if(e.imageName){const C=o[e.imageName];return C?C.displaySize[0]*e.scale*qr/w+f:0}{const C=r[e.fontStack],I=C&&C[i];return I?I.metrics.advance*e.scale+f:0}}function Au(i,e,r,o){const f=Math.pow(i-e,2);return o?i<e?f/2:2*f:f+Math.abs(r)*r}function cp(i,e,r){let o=0;return i===10&&(o-=1e4),r&&(o+=150),i!==40&&i!==65288||(o+=50),e!==41&&e!==65289||(o+=50),o}function Mu(i,e,r,o,f,w){let C=null,I=Au(e,r,f,w);for(const O of o){const z=Au(e-O.x,r,f,w)+O.badness;z<=I&&(C=O,I=z)}return{index:i,x:e,priorBreak:C,badness:I}}function ku(i){return i?ku(i.priorBreak).concat(i.index):[]}function ch(i,e,r,o,f,w,C){if(w!=="point")return[];if(!i)return[];const I=[],O=function(W,Z,J,se,de,Ce){let Ve=0;for(let Se=0;Se<W.length();Se++){const De=W.getSection(Se);Ve+=Pu(W.getCharCode(Se),De,se,de,Z,Ce)}return Ve/Math.max(1,Math.ceil(Ve/J))}(i,e,r,o,f,C),z=i.text.indexOf("​")>=0;let B=0;for(let W=0;W<i.length();W++){const Z=i.getSection(W),J=i.getCharCode(W);if(Tc[J]||(B+=Pu(J,Z,o,f,e,C)),W<i.length()-1){const se=!((N=J)<11904||!(Vt["Bopomofo Extended"](N)||Vt.Bopomofo(N)||Vt["CJK Compatibility Forms"](N)||Vt["CJK Compatibility Ideographs"](N)||Vt["CJK Compatibility"](N)||Vt["CJK Radicals Supplement"](N)||Vt["CJK Strokes"](N)||Vt["CJK Symbols and Punctuation"](N)||Vt["CJK Unified Ideographs Extension A"](N)||Vt["CJK Unified Ideographs"](N)||Vt["Enclosed CJK Letters and Months"](N)||Vt["Halfwidth and Fullwidth Forms"](N)||Vt.Hiragana(N)||Vt["Ideographic Description Characters"](N)||Vt["Kangxi Radicals"](N)||Vt["Katakana Phonetic Extensions"](N)||Vt.Katakana(N)||Vt["Vertical Forms"](N)||Vt["Yi Radicals"](N)||Vt["Yi Syllables"](N)));(lp[J]||se||Z.imageName)&&I.push(Mu(W+1,B,O,I,cp(J,i.getCharCode(W+1),se&&z),!1))}}var N;return ku(Mu(i.length(),B,O,I,0,!0))}function hh(i){let e=.5,r=.5;switch(i){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(i){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:e,verticalAlign:r}}function hp(i,e,r,o,f){if(!o&&!f)return;const w=i[r],C=(i[r].x+w.metrics.advance*w.scale)*o;for(let I=e;I<=r;I++)i[I].x-=C,i[I].y+=f}function up(i,e,r){const{horizontalAlign:o,verticalAlign:f}=hh(r),w=e[0]-i.displaySize[0]*o,C=e[1]-i.displaySize[1]*f;return{image:i,top:C,bottom:C+i.displaySize[1],left:w,right:w+i.displaySize[0]}}function Ou(i,e,r,o,f,w){const C=i.image;let I;if(C.content){const de=C.content,Ce=C.pixelRatio||1;I=[de[0]/Ce,de[1]/Ce,C.displaySize[0]-de[2]/Ce,C.displaySize[1]-de[3]/Ce]}const O=e.left*w,z=e.right*w;let B,N,W,Z;r==="width"||r==="both"?(Z=f[0]+O-o[3],N=f[0]+z+o[1]):(Z=f[0]+(O+z-C.displaySize[0])/2,N=Z+C.displaySize[0]);const J=e.top*w,se=e.bottom*w;return r==="height"||r==="both"?(B=f[1]+J-o[0],W=f[1]+se+o[2]):(B=f[1]+(J+se-C.displaySize[1])/2,W=B+C.displaySize[1]),{image:C,top:B,right:N,bottom:W,left:Z,collisionPadding:I}}const Ql=255,ro=128,ea=Ql*ro;function Du(i,e){const{expression:r}=e;if(r.kind==="constant")return{kind:"constant",layoutSize:r.evaluate(new fr(i+1))};if(r.kind==="source")return{kind:"source"};{const{zoomStops:o,interpolationType:f}=r;let w=0;for(;w<o.length&&o[w]<=i;)w++;w=Math.max(0,w-1);let C=w;for(;C<o.length&&o[C]<i+1;)C++;C=Math.min(o.length-1,C);const I=o[w],O=o[C];return r.kind==="composite"?{kind:"composite",minZoom:I,maxZoom:O,interpolationType:f}:{kind:"camera",minZoom:I,maxZoom:O,minSize:r.evaluate(new fr(I)),maxSize:r.evaluate(new fr(O)),interpolationType:f}}}function uh(i,e,r){let o="never";const f=i.get(e);return f?o=f:i.get(r)&&(o="always"),o}const dp=Jo.VectorTileFeature.types,fp=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Ec(i,e,r,o,f,w,C,I,O,z,B,N,W){const Z=I?Math.min(ea,Math.round(I[0])):0,J=I?Math.min(ea,Math.round(I[1])):0;i.emplaceBack(e,r,Math.round(32*o),Math.round(32*f),w,C,(Z<<1)+(O?1:0),J,16*z,16*B,256*N,256*W)}function dh(i,e,r){i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r)}function pp(i){for(const e of i.sections)if(Gc(e.text))return!0;return!1}class fh{constructor(e){this.layoutVertexArray=new We,this.indexArray=new rt,this.programConfigurations=e,this.segments=new zt,this.dynamicLayoutVertexArray=new xe,this.opacityVertexArray=new ze,this.hasVisibleVertices=!1,this.placedSymbolArray=new n}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(e,r,o,f){this.isEmpty()||(o&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Wf.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,r),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,Xf.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,fp,!0),this.opacityVertexBuffer.itemSize=1),(o||f)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}qt("SymbolBuffers",fh);class ph{constructor(e,r,o){this.layoutVertexArray=new e,this.layoutAttributes=r,this.indexArray=new o,this.segments=new zt,this.collisionVertexArray=new Ke}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,qf.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}qt("CollisionBuffers",ph);class ml{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(C=>C.id),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Wc([]),this.placementViewportMatrix=Wc([]);const r=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Du(this.zoom,r["text-size"]),this.iconSizeData=Du(this.zoom,r["icon-size"]);const o=this.layers[0].layout,f=o.get("symbol-sort-key"),w=o.get("symbol-z-order");this.canOverlap=uh(o,"text-overlap","text-allow-overlap")!=="never"||uh(o,"icon-overlap","icon-allow-overlap")!=="never"||o.get("text-ignore-placement")||o.get("icon-ignore-placement"),this.sortFeaturesByKey=w!=="viewport-y"&&!f.isConstant(),this.sortFeaturesByY=(w==="viewport-y"||w==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,o.get("symbol-placement")==="point"&&(this.writingModes=o.get("text-writing-mode").map(C=>j.ah[C])),this.stateDependentLayerIds=this.layers.filter(C=>C.isStateDependent()).map(C=>C.id),this.sourceID=e.sourceID}createArrays(){this.text=new fh(new xr(this.layers,this.zoom,e=>/^text/.test(e))),this.icon=new fh(new xr(this.layers,this.zoom,e=>/^icon/.test(e))),this.glyphOffsetArray=new y,this.lineVertexArray=new P,this.symbolInstances=new d,this.textAnchorOffsets=new L}calculateGlyphDependencies(e,r,o,f,w){for(let C=0;C<e.length;C++)if(r[e.charCodeAt(C)]=!0,(o||f)&&w){const I=Zl[e.charAt(C)];I&&(r[I.charCodeAt(0)]=!0)}}populate(e,r,o){const f=this.layers[0],w=f.layout,C=w.get("text-font"),I=w.get("text-field"),O=w.get("icon-image"),z=(I.value.kind!=="constant"||I.value.value instanceof dn&&!I.value.value.isEmpty()||I.value.value.toString().length>0)&&(C.value.kind!=="constant"||C.value.value.length>0),B=O.value.kind!=="constant"||!!O.value.value||Object.keys(O.parameters).length>0,N=w.get("symbol-sort-key");if(this.features=[],!z&&!B)return;const W=r.iconDependencies,Z=r.glyphDependencies,J=r.availableImages,se=new fr(this.zoom);for(const{feature:de,id:Ce,index:Ve,sourceLayerIndex:Se}of e){const De=f._featureFilter.needGeometry,ht=So(de,De);if(!f._featureFilter.filter(se,ht,o))continue;let gt,$t;if(De||(ht.geometry=Co(de)),z){const Xt=f.getValueAndResolveTokens("text-field",ht,o,J),Ut=dn.factory(Xt),Lt=this.hasRTLText=this.hasRTLText||pp(Ut);(!Lt||Qs.getRTLTextPluginStatus()==="unavailable"||Lt&&Qs.isParsed())&&(gt=Yf(Ut,f,ht))}if(B){const Xt=f.getValueAndResolveTokens("icon-image",ht,o,J);$t=Xt instanceof on?Xt:on.fromString(Xt)}if(!gt&&!$t)continue;const ei=this.sortFeaturesByKey?N.evaluate(ht,{},o):void 0;if(this.features.push({id:Ce,text:gt,icon:$t,index:Ve,sourceLayerIndex:Se,geometry:ht.geometry,properties:de.properties,type:dp[de.type],sortKey:ei}),$t&&(W[$t.name]=!0),gt){const Xt=C.evaluate(ht,{},o).join(","),Ut=w.get("text-rotation-alignment")!=="viewport"&&w.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(j.ah.vertical)>=0;for(const Lt of gt.sections)if(Lt.image)W[Lt.image.name]=!0;else{const Kt=Ss(gt.toString()),jt=Lt.fontStack||Xt,St=Z[jt]=Z[jt]||{};this.calculateGlyphDependencies(Lt.text,St,Ut,this.allowVerticalPlacement,Kt)}}}w.get("symbol-placement")==="line"&&(this.features=function(de){const Ce={},Ve={},Se=[];let De=0;function ht(Xt){Se.push(de[Xt]),De++}function gt(Xt,Ut,Lt){const Kt=Ve[Xt];return delete Ve[Xt],Ve[Ut]=Kt,Se[Kt].geometry[0].pop(),Se[Kt].geometry[0]=Se[Kt].geometry[0].concat(Lt[0]),Kt}function $t(Xt,Ut,Lt){const Kt=Ce[Ut];return delete Ce[Ut],Ce[Xt]=Kt,Se[Kt].geometry[0].shift(),Se[Kt].geometry[0]=Lt[0].concat(Se[Kt].geometry[0]),Kt}function ei(Xt,Ut,Lt){const Kt=Lt?Ut[0][Ut[0].length-1]:Ut[0][0];return`${Xt}:${Kt.x}:${Kt.y}`}for(let Xt=0;Xt<de.length;Xt++){const Ut=de[Xt],Lt=Ut.geometry,Kt=Ut.text?Ut.text.toString():null;if(!Kt){ht(Xt);continue}const jt=ei(Kt,Lt),St=ei(Kt,Lt,!0);if(jt in Ve&&St in Ce&&Ve[jt]!==Ce[St]){const ci=$t(jt,St,Lt),ni=gt(jt,St,Se[ci].geometry);delete Ce[jt],delete Ve[St],Ve[ei(Kt,Se[ni].geometry,!0)]=ni,Se[ci].geometry=null}else jt in Ve?gt(jt,St,Lt):St in Ce?$t(jt,St,Lt):(ht(Xt),Ce[jt]=De-1,Ve[St]=De-1)}return Se.filter(Xt=>Xt.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((de,Ce)=>de.sortKey-Ce.sortKey)}update(e,r,o){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(e,r,this.layers,o),this.icon.programConfigurations.updatePaintArrays(e,r,this.layers,o))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,r){const o=this.lineVertexArray.length;if(e.segment!==void 0){let f=e.dist(r[e.segment+1]),w=e.dist(r[e.segment]);const C={};for(let I=e.segment+1;I<r.length;I++)C[I]={x:r[I].x,y:r[I].y,tileUnitDistanceFromAnchor:f},I<r.length-1&&(f+=r[I+1].dist(r[I]));for(let I=e.segment||0;I>=0;I--)C[I]={x:r[I].x,y:r[I].y,tileUnitDistanceFromAnchor:w},I>0&&(w+=r[I-1].dist(r[I]));for(let I=0;I<r.length;I++){const O=C[I];this.lineVertexArray.emplaceBack(O.x,O.y,O.tileUnitDistanceFromAnchor)}}return{lineStartIndex:o,lineLength:this.lineVertexArray.length-o}}addSymbols(e,r,o,f,w,C,I,O,z,B,N,W){const Z=e.indexArray,J=e.layoutVertexArray,se=e.segments.prepareSegment(4*r.length,J,Z,this.canOverlap?C.sortKey:void 0),de=this.glyphOffsetArray.length,Ce=se.vertexLength,Ve=this.allowVerticalPlacement&&I===j.ah.vertical?Math.PI/2:0,Se=C.text&&C.text.sections;for(let De=0;De<r.length;De++){const{tl:ht,tr:gt,bl:$t,br:ei,tex:Xt,pixelOffsetTL:Ut,pixelOffsetBR:Lt,minFontScaleX:Kt,minFontScaleY:jt,glyphOffset:St,isSDF:ci,sectionIndex:ni}=r[De],ki=se.vertexLength,hr=St[1];Ec(J,O.x,O.y,ht.x,hr+ht.y,Xt.x,Xt.y,o,ci,Ut.x,Ut.y,Kt,jt),Ec(J,O.x,O.y,gt.x,hr+gt.y,Xt.x+Xt.w,Xt.y,o,ci,Lt.x,Ut.y,Kt,jt),Ec(J,O.x,O.y,$t.x,hr+$t.y,Xt.x,Xt.y+Xt.h,o,ci,Ut.x,Lt.y,Kt,jt),Ec(J,O.x,O.y,ei.x,hr+ei.y,Xt.x+Xt.w,Xt.y+Xt.h,o,ci,Lt.x,Lt.y,Kt,jt),dh(e.dynamicLayoutVertexArray,O,Ve),Z.emplaceBack(ki,ki+1,ki+2),Z.emplaceBack(ki+1,ki+2,ki+3),se.vertexLength+=4,se.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(St[0]),De!==r.length-1&&ni===r[De+1].sectionIndex||e.programConfigurations.populatePaintArrays(J.length,C,C.index,{},W,Se&&Se[ni])}e.placedSymbolArray.emplaceBack(O.x,O.y,de,this.glyphOffsetArray.length-de,Ce,z,B,O.segment,o?o[0]:0,o?o[1]:0,f[0],f[1],I,0,!1,0,N)}_addCollisionDebugVertex(e,r,o,f,w,C){return r.emplaceBack(0,0),e.emplaceBack(o.x,o.y,f,w,Math.round(C.x),Math.round(C.y))}addCollisionDebugVertices(e,r,o,f,w,C,I){const O=w.segments.prepareSegment(4,w.layoutVertexArray,w.indexArray),z=O.vertexLength,B=w.layoutVertexArray,N=w.collisionVertexArray,W=I.anchorX,Z=I.anchorY;this._addCollisionDebugVertex(B,N,C,W,Z,new a(e,r)),this._addCollisionDebugVertex(B,N,C,W,Z,new a(o,r)),this._addCollisionDebugVertex(B,N,C,W,Z,new a(o,f)),this._addCollisionDebugVertex(B,N,C,W,Z,new a(e,f)),O.vertexLength+=4;const J=w.indexArray;J.emplaceBack(z,z+1),J.emplaceBack(z+1,z+2),J.emplaceBack(z+2,z+3),J.emplaceBack(z+3,z),O.primitiveLength+=4}addDebugCollisionBoxes(e,r,o,f){for(let w=e;w<r;w++){const C=this.collisionBoxArray.get(w);this.addCollisionDebugVertices(C.x1,C.y1,C.x2,C.y2,f?this.textCollisionBox:this.iconCollisionBox,C.anchorPoint,o)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new ph($e,_u.members,xt),this.iconCollisionBox=new ph($e,_u.members,xt);for(let e=0;e<this.symbolInstances.length;e++){const r=this.symbolInstances.get(e);this.addDebugCollisionBoxes(r.textBoxStartIndex,r.textBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.verticalTextBoxStartIndex,r.verticalTextBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.iconBoxStartIndex,r.iconBoxEndIndex,r,!1),this.addDebugCollisionBoxes(r.verticalIconBoxStartIndex,r.verticalIconBoxEndIndex,r,!1)}}_deserializeCollisionBoxesForSymbol(e,r,o,f,w,C,I,O,z){const B={};for(let N=r;N<o;N++){const W=e.get(N);B.textBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,anchorPointX:W.anchorPointX,anchorPointY:W.anchorPointY},B.textFeatureIndex=W.featureIndex;break}for(let N=f;N<w;N++){const W=e.get(N);B.verticalTextBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,anchorPointX:W.anchorPointX,anchorPointY:W.anchorPointY},B.verticalTextFeatureIndex=W.featureIndex;break}for(let N=C;N<I;N++){const W=e.get(N);B.iconBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,anchorPointX:W.anchorPointX,anchorPointY:W.anchorPointY},B.iconFeatureIndex=W.featureIndex;break}for(let N=O;N<z;N++){const W=e.get(N);B.verticalIconBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,anchorPointX:W.anchorPointX,anchorPointY:W.anchorPointY},B.verticalIconFeatureIndex=W.featureIndex;break}return B}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let r=0;r<this.symbolInstances.length;r++){const o=this.symbolInstances.get(r);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,o.textBoxStartIndex,o.textBoxEndIndex,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o.iconBoxStartIndex,o.iconBoxEndIndex,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(e,r){const o=e.placedSymbolArray.get(r),f=o.vertexStartIndex+4*o.numGlyphs;for(let w=o.vertexStartIndex;w<f;w+=4)e.indexArray.emplaceBack(w,w+1,w+2),e.indexArray.emplaceBack(w+1,w+2,w+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const r=Math.sin(e),o=Math.cos(e),f=[],w=[],C=[];for(let I=0;I<this.symbolInstances.length;++I){C.push(I);const O=this.symbolInstances.get(I);f.push(0|Math.round(r*O.anchorX+o*O.anchorY)),w.push(O.featureIndex)}return C.sort((I,O)=>f[I]-f[O]||w[O]-w[I]),C}addToSortKeyRanges(e,r){const o=this.sortKeyRanges[this.sortKeyRanges.length-1];o&&o.sortKey===r?o.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:r,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const r of this.symbolInstanceIndexes){const o=this.symbolInstances.get(r);this.featureSortOrder.push(o.featureIndex),[o.rightJustifiedTextSymbolIndex,o.centerJustifiedTextSymbolIndex,o.leftJustifiedTextSymbolIndex].forEach((f,w,C)=>{f>=0&&C.indexOf(f)===w&&this.addIndicesForPlacedSymbol(this.text,f)}),o.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,o.verticalPlacedTextSymbolIndex),o.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,o.placedIconSymbolIndex),o.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,o.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Lu,zu;qt("SymbolBucket",ml,{omit:["layers","collisionBoxArray","features","compareText"]}),ml.MAX_GLYPHS=65535,ml.addDynamicAttributes=dh;var mh={get paint(){return zu=zu||new Mn({"icon-opacity":new hi(le.paint_symbol["icon-opacity"]),"icon-color":new hi(le.paint_symbol["icon-color"]),"icon-halo-color":new hi(le.paint_symbol["icon-halo-color"]),"icon-halo-width":new hi(le.paint_symbol["icon-halo-width"]),"icon-halo-blur":new hi(le.paint_symbol["icon-halo-blur"]),"icon-translate":new si(le.paint_symbol["icon-translate"]),"icon-translate-anchor":new si(le.paint_symbol["icon-translate-anchor"]),"text-opacity":new hi(le.paint_symbol["text-opacity"]),"text-color":new hi(le.paint_symbol["text-color"],{runtimeType:Hi,getOverride:i=>i.textColor,hasOverride:i=>!!i.textColor}),"text-halo-color":new hi(le.paint_symbol["text-halo-color"]),"text-halo-width":new hi(le.paint_symbol["text-halo-width"]),"text-halo-blur":new hi(le.paint_symbol["text-halo-blur"]),"text-translate":new si(le.paint_symbol["text-translate"]),"text-translate-anchor":new si(le.paint_symbol["text-translate-anchor"])})},get layout(){return Lu=Lu||new Mn({"symbol-placement":new si(le.layout_symbol["symbol-placement"]),"symbol-spacing":new si(le.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new si(le.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new hi(le.layout_symbol["symbol-sort-key"]),"symbol-z-order":new si(le.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new si(le.layout_symbol["icon-allow-overlap"]),"icon-overlap":new si(le.layout_symbol["icon-overlap"]),"icon-ignore-placement":new si(le.layout_symbol["icon-ignore-placement"]),"icon-optional":new si(le.layout_symbol["icon-optional"]),"icon-rotation-alignment":new si(le.layout_symbol["icon-rotation-alignment"]),"icon-size":new hi(le.layout_symbol["icon-size"]),"icon-text-fit":new si(le.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new si(le.layout_symbol["icon-text-fit-padding"]),"icon-image":new hi(le.layout_symbol["icon-image"]),"icon-rotate":new hi(le.layout_symbol["icon-rotate"]),"icon-padding":new hi(le.layout_symbol["icon-padding"]),"icon-keep-upright":new si(le.layout_symbol["icon-keep-upright"]),"icon-offset":new hi(le.layout_symbol["icon-offset"]),"icon-anchor":new hi(le.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new si(le.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new si(le.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new si(le.layout_symbol["text-rotation-alignment"]),"text-field":new hi(le.layout_symbol["text-field"]),"text-font":new hi(le.layout_symbol["text-font"]),"text-size":new hi(le.layout_symbol["text-size"]),"text-max-width":new hi(le.layout_symbol["text-max-width"]),"text-line-height":new si(le.layout_symbol["text-line-height"]),"text-letter-spacing":new hi(le.layout_symbol["text-letter-spacing"]),"text-justify":new hi(le.layout_symbol["text-justify"]),"text-radial-offset":new hi(le.layout_symbol["text-radial-offset"]),"text-variable-anchor":new si(le.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new hi(le.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new hi(le.layout_symbol["text-anchor"]),"text-max-angle":new si(le.layout_symbol["text-max-angle"]),"text-writing-mode":new si(le.layout_symbol["text-writing-mode"]),"text-rotate":new hi(le.layout_symbol["text-rotate"]),"text-padding":new si(le.layout_symbol["text-padding"]),"text-keep-upright":new si(le.layout_symbol["text-keep-upright"]),"text-transform":new hi(le.layout_symbol["text-transform"]),"text-offset":new hi(le.layout_symbol["text-offset"]),"text-allow-overlap":new si(le.layout_symbol["text-allow-overlap"]),"text-overlap":new si(le.layout_symbol["text-overlap"]),"text-ignore-placement":new si(le.layout_symbol["text-ignore-placement"]),"text-optional":new si(le.layout_symbol["text-optional"])})}};class Fu{constructor(e){if(e.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=e.property.overrides?e.property.overrides.runtimeType:Qi,this.defaultValue=e}evaluate(e){if(e.formattedSection){const r=this.defaultValue.property.overrides;if(r&&r.hasOverride(e.formattedSection))return r.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}qt("FormatSectionOverride",Fu,{omit:["defaultValue"]});class Ic extends ds{constructor(e){super(e,mh)}recalculate(e,r){if(super.recalculate(e,r),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const o=this.layout.get("text-writing-mode");if(o){const f=[];for(const w of o)f.indexOf(w)<0&&f.push(w);this.layout._values["text-writing-mode"]=f}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(e,r,o,f){const w=this.layout.get(e).evaluate(r,{},o,f),C=this._unevaluatedLayout._values[e];return C.isDataDriven()||Ki(C.value)||!w?w:function(I,O){return O.replace(/{([^{}]+)}/g,(z,B)=>I&&B in I?String(I[B]):"")}(r.properties,w)}createBucket(e){return new ml(e)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const e of mh.paint.overridableProperties){if(!Ic.hasPaintOverride(this.layout,e))continue;const r=this.paint.get(e),o=new Fu(r),f=new Ni(o,r.property.specification);let w=null;w=r.value.kind==="constant"||r.value.kind==="source"?new ws("source",f):new Go("composite",f,r.value.zoomStops),this.paint._values[e]=new us(r.property,w,r.parameters)}}_handleOverridablePaintPropertyUpdate(e,r,o){return!(!this.layout||r.isDataDriven()||o.isDataDriven())&&Ic.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,r){const o=e.get("text-field"),f=mh.paint.properties[r];let w=!1;const C=I=>{for(const O of I)if(f.overrides&&f.overrides.hasOverride(O))return void(w=!0)};if(o.value.kind==="constant"&&o.value.value instanceof dn)C(o.value.value.sections);else if(o.value.kind==="source"){const I=z=>{w||(z instanceof vs&&Sr(z.value)===$i?C(z.value.sections):z instanceof Bo?C(z.sections):z.eachChild(I))},O=o.value;O._styleExpression&&I(O._styleExpression.expression)}return w}}let Ru;var mp={get paint(){return Ru=Ru||new Mn({"background-color":new si(le.paint_background["background-color"]),"background-pattern":new Ta(le.paint_background["background-pattern"]),"background-opacity":new si(le.paint_background["background-opacity"])})}};class gp extends ds{constructor(e){super(e,mp)}}let Bu;var _p={get paint(){return Bu=Bu||new Mn({"raster-opacity":new si(le.paint_raster["raster-opacity"]),"raster-hue-rotate":new si(le.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new si(le.paint_raster["raster-brightness-min"]),"raster-brightness-max":new si(le.paint_raster["raster-brightness-max"]),"raster-saturation":new si(le.paint_raster["raster-saturation"]),"raster-contrast":new si(le.paint_raster["raster-contrast"]),"raster-resampling":new si(le.paint_raster["raster-resampling"]),"raster-fade-duration":new si(le.paint_raster["raster-fade-duration"])})}};class yp extends ds{constructor(e){super(e,_p)}}class vp extends ds{constructor(e){super(e,{}),this.onAdd=r=>{this.implementation.onAdd&&this.implementation.onAdd(r,r.painter.context.gl)},this.onRemove=r=>{this.implementation.onRemove&&this.implementation.onRemove(r,r.painter.context.gl)},this.implementation=e}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class xp{constructor(e){this._methodToThrottle=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._methodToThrottle()},0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const gh=63710088e-1;class ta{constructor(e,r){if(isNaN(e)||isNaN(r))throw new Error(`Invalid LngLat object: (${e}, ${r})`);if(this.lng=+e,this.lat=+r,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new ta(X(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const r=Math.PI/180,o=this.lat*r,f=e.lat*r,w=Math.sin(o)*Math.sin(f)+Math.cos(o)*Math.cos(f)*Math.cos((e.lng-this.lng)*r);return gh*Math.acos(Math.min(w,1))}static convert(e){if(e instanceof ta)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new ta(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new ta(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const ju=2*Math.PI*gh;function Nu(i){return ju*Math.cos(i*Math.PI/180)}function Vu(i){return(180+i)/360}function Uu(i){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i*Math.PI/360)))/360}function Gu(i,e){return i/Nu(e)}function _h(i){return 360/Math.PI*Math.atan(Math.exp((180-360*i)*Math.PI/180))-90}class Pc{constructor(e,r,o=0){this.x=+e,this.y=+r,this.z=+o}static fromLngLat(e,r=0){const o=ta.convert(e);return new Pc(Vu(o.lng),Uu(o.lat),Gu(r,o.lat))}toLngLat(){return new ta(360*this.x-180,_h(this.y))}toAltitude(){return this.z*Nu(_h(this.y))}meterInMercatorCoordinateUnits(){return 1/ju*(e=_h(this.y),1/Math.cos(e*Math.PI/180));var e}}function Hu(i,e,r){var o=2*Math.PI*6378137/256/Math.pow(2,r);return[i*o-2*Math.PI*6378137/2,e*o-2*Math.PI*6378137/2]}class yh{constructor(e,r,o){if(e<0||e>25||o<0||o>=Math.pow(2,e)||r<0||r>=Math.pow(2,e))throw new Error(`x=${r}, y=${o}, z=${e} outside of bounds. 0<=x<${Math.pow(2,e)}, 0<=y<${Math.pow(2,e)} 0<=z<=25 `);this.z=e,this.x=r,this.y=o,this.key=ec(0,e,e,r,o)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,r,o){const f=(C=this.y,I=this.z,O=Hu(256*(w=this.x),256*(C=Math.pow(2,I)-C-1),I),z=Hu(256*(w+1),256*(C+1),I),O[0]+","+O[1]+","+z[0]+","+z[1]);var w,C,I,O,z;const B=function(N,W,Z){let J,se="";for(let de=N;de>0;de--)J=1<<de-1,se+=(W&J?1:0)+(Z&J?2:0);return se}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(o==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,r>1?"@2x":"").replace(/{quadkey}/g,B).replace(/{bbox-epsg-3857}/g,f)}isChildOf(e){const r=this.z-e.z;return r>0&&e.x===this.x>>r&&e.y===this.y>>r}getTilePoint(e){const r=Math.pow(2,this.z);return new a((e.x*r-this.x)*Mr,(e.y*r-this.y)*Mr)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Wu{constructor(e,r){this.wrap=e,this.canonical=r,this.key=ec(e,r.z,r.z,r.x,r.y)}}class ps{constructor(e,r,o,f,w){if(e<o)throw new Error(`overscaledZ should be >= z; overscaledZ = ${e}; z = ${o}`);this.overscaledZ=e,this.wrap=r,this.canonical=new yh(o,+f,+w),this.key=ec(r,e,o,f,w)}clone(){return new ps(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){if(e>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${e}; overscaledZ = ${this.overscaledZ}`);const r=this.canonical.z-e;return e>this.canonical.z?new ps(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new ps(e,this.wrap,e,this.canonical.x>>r,this.canonical.y>>r)}calculateScaledKey(e,r){if(e>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${e}; overscaledZ = ${this.overscaledZ}`);const o=this.canonical.z-e;return e>this.canonical.z?ec(this.wrap*+r,e,this.canonical.z,this.canonical.x,this.canonical.y):ec(this.wrap*+r,e,e,this.canonical.x>>o,this.canonical.y>>o)}isChildOf(e){if(e.wrap!==this.wrap)return!1;const r=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.x===this.canonical.x>>r&&e.canonical.y===this.canonical.y>>r}children(e){if(this.overscaledZ>=e)return[new ps(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const r=this.canonical.z+1,o=2*this.canonical.x,f=2*this.canonical.y;return[new ps(r,this.wrap,r,o,f),new ps(r,this.wrap,r,o+1,f),new ps(r,this.wrap,r,o,f+1),new ps(r,this.wrap,r,o+1,f+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new ps(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new ps(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Wu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(e){return this.canonical.getTilePoint(new Pc(e.x-this.wrap,e.y))}}function ec(i,e,r,o,f){(i*=2)<0&&(i=-1*i-1);const w=1<<r;return(w*w*i+w*f+o).toString(36)+r.toString(36)+e.toString(36)}qt("CanonicalTileID",yh),qt("OverscaledTileID",ps,{omit:["posMatrix"]});class Xu{constructor(e,r,o,f=1,w=1,C=1,I=0){if(this.uid=e,r.height!==r.width)throw new RangeError("DEM tiles must be square");if(o&&!["mapbox","terrarium","custom"].includes(o))return void ct(`"${o}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=r.height;const O=this.dim=r.height-2;switch(this.data=new Uint32Array(r.data.buffer),o){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=f,this.greenFactor=w,this.blueFactor=C,this.baseShift=I;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let z=0;z<O;z++)this.data[this._idx(-1,z)]=this.data[this._idx(0,z)],this.data[this._idx(O,z)]=this.data[this._idx(O-1,z)],this.data[this._idx(z,-1)]=this.data[this._idx(z,0)],this.data[this._idx(z,O)]=this.data[this._idx(z,O-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(O,-1)]=this.data[this._idx(O-1,0)],this.data[this._idx(-1,O)]=this.data[this._idx(0,O-1)],this.data[this._idx(O,O)]=this.data[this._idx(O-1,O-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let z=0;z<O;z++)for(let B=0;B<O;B++){const N=this.get(z,B);N>this.max&&(this.max=N),N<this.min&&(this.min=N)}}get(e,r){const o=new Uint8Array(this.data.buffer),f=4*this._idx(e,r);return this.unpack(o[f],o[f+1],o[f+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(e,r){if(e<-1||e>=this.dim+1||r<-1||r>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(r+1)*this.stride+(e+1)}unpack(e,r,o){return e*this.redFactor+r*this.greenFactor+o*this.blueFactor-this.baseShift}getPixels(){return new fs({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(e,r,o){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let f=r*this.dim,w=r*this.dim+this.dim,C=o*this.dim,I=o*this.dim+this.dim;switch(r){case-1:f=w-1;break;case 1:w=f+1}switch(o){case-1:C=I-1;break;case 1:I=C+1}const O=-r*this.dim,z=-o*this.dim;for(let B=C;B<I;B++)for(let N=f;N<w;N++)this.data[this._idx(N,B)]=e.data[this._idx(N+O,B+z)]}}qt("DEMData",Xu);class qu{constructor(e){this._stringToNumber={},this._numberToString=[];for(let r=0;r<e.length;r++){const o=e[r];this._stringToNumber[o]=r,this._numberToString[r]=o}}encode(e){return this._stringToNumber[e]}decode(e){if(e>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${e} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[e]}}class $u{constructor(e,r,o,f,w){this.type="Feature",this._vectorTileFeature=e,e._z=r,e._x=o,e._y=f,this.properties=e.properties,this.id=w}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={geometry:this.geometry};for(const r in this)r!=="_geometry"&&r!=="_vectorTileFeature"&&(e[r]=this[r]);return e}}class Yu{constructor(e,r){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new yn(Mr,16,0),this.grid3D=new yn(Mr,16,0),this.featureIndexArray=new U,this.promoteId=r}insert(e,r,o,f,w,C){const I=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(o,f,w);const O=C?this.grid3D:this.grid;for(let z=0;z<r.length;z++){const B=r[z],N=[1/0,1/0,-1/0,-1/0];for(let W=0;W<B.length;W++){const Z=B[W];N[0]=Math.min(N[0],Z.x),N[1]=Math.min(N[1],Z.y),N[2]=Math.max(N[2],Z.x),N[3]=Math.max(N[3],Z.y)}N[0]<Mr&&N[1]<Mr&&N[2]>=0&&N[3]>=0&&O.insert(I,N[0],N[1],N[2],N[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new Jo.VectorTile(new oh(this.rawTileData)).layers,this.sourceLayerCoder=new qu(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(e,r,o,f){this.loadVTLayers();const w=e.params||{},C=Mr/e.tileSize/e.scale,I=Ls(w.filter),O=e.queryGeometry,z=e.queryPadding*C,B=Ku(O),N=this.grid.query(B.minX-z,B.minY-z,B.maxX+z,B.maxY+z),W=Ku(e.cameraQueryGeometry),Z=this.grid3D.query(W.minX-z,W.minY-z,W.maxX+z,W.maxY+z,(de,Ce,Ve,Se)=>function(De,ht,gt,$t,ei){for(const Ut of De)if(ht<=Ut.x&&gt<=Ut.y&&$t>=Ut.x&&ei>=Ut.y)return!0;const Xt=[new a(ht,gt),new a(ht,ei),new a($t,ei),new a($t,gt)];if(De.length>2){for(const Ut of Xt)if(ll(De,Ut))return!0}for(let Ut=0;Ut<De.length-1;Ut++)if(Kd(De[Ut],De[Ut+1],Xt))return!0;return!1}(e.cameraQueryGeometry,de-z,Ce-z,Ve+z,Se+z));for(const de of Z)N.push(de);N.sort(bp);const J={};let se;for(let de=0;de<N.length;de++){const Ce=N[de];if(Ce===se)continue;se=Ce;const Ve=this.featureIndexArray.get(Ce);let Se=null;this.loadMatchingFeature(J,Ve.bucketIndex,Ve.sourceLayerIndex,Ve.featureIndex,I,w.layers,w.availableImages,r,o,f,(De,ht,gt)=>(Se||(Se=Co(De)),ht.queryIntersectsFeature(O,De,gt,Se,this.z,e.transform,C,e.pixelPosMatrix)))}return J}loadMatchingFeature(e,r,o,f,w,C,I,O,z,B,N){const W=this.bucketLayerIDs[r];if(C&&!function(de,Ce){for(let Ve=0;Ve<de.length;Ve++)if(Ce.indexOf(de[Ve])>=0)return!0;return!1}(C,W))return;const Z=this.sourceLayerCoder.decode(o),J=this.vtLayers[Z].feature(f);if(w.needGeometry){const de=So(J,!0);if(!w.filter(new fr(this.tileID.overscaledZ),de,this.tileID.canonical))return}else if(!w.filter(new fr(this.tileID.overscaledZ),J))return;const se=this.getId(J,Z);for(let de=0;de<W.length;de++){const Ce=W[de];if(C&&C.indexOf(Ce)<0)continue;const Ve=O[Ce];if(!Ve)continue;let Se={};se&&B&&(Se=B.getState(Ve.sourceLayer||"_geojsonTileLayer",se));const De=ie({},z[Ce]);De.paint=Zu(De.paint,Ve.paint,J,Se,I),De.layout=Zu(De.layout,Ve.layout,J,Se,I);const ht=!N||N(J,Ve,Se);if(!ht)continue;const gt=new $u(J,this.z,this.x,this.y,se);gt.layer=De;let $t=e[Ce];$t===void 0&&($t=e[Ce]=[]),$t.push({featureIndex:f,feature:gt,intersectionZ:ht})}}lookupSymbolFeatures(e,r,o,f,w,C,I,O){const z={};this.loadVTLayers();const B=Ls(w);for(const N of e)this.loadMatchingFeature(z,o,f,N,B,C,I,O,r);return z}hasLayer(e){for(const r of this.bucketLayerIDs)for(const o of r)if(e===o)return!0;return!1}getId(e,r){let o=e.id;return this.promoteId&&(o=e.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[r]],typeof o=="boolean"&&(o=Number(o))),o}}function Zu(i,e,r,o,f){return Fe(i,(w,C)=>{const I=e instanceof Sa?e.get(C):null;return I&&I.evaluate?I.evaluate(r,o,f):I})}function Ku(i){let e=1/0,r=1/0,o=-1/0,f=-1/0;for(const w of i)e=Math.min(e,w.x),r=Math.min(r,w.y),o=Math.max(o,w.x),f=Math.max(f,w.y);return{minX:e,minY:r,maxX:o,maxY:f}}function bp(i,e){return e-i}function Ju(i,e,r,o,f){const w=[];for(let C=0;C<i.length;C++){const I=i[C];let O;for(let z=0;z<I.length-1;z++){let B=I[z],N=I[z+1];B.x<e&&N.x<e||(B.x<e?B=new a(e,B.y+(e-B.x)/(N.x-B.x)*(N.y-B.y))._round():N.x<e&&(N=new a(e,B.y+(e-B.x)/(N.x-B.x)*(N.y-B.y))._round()),B.y<r&&N.y<r||(B.y<r?B=new a(B.x+(r-B.y)/(N.y-B.y)*(N.x-B.x),r)._round():N.y<r&&(N=new a(B.x+(r-B.y)/(N.y-B.y)*(N.x-B.x),r)._round()),B.x>=o&&N.x>=o||(B.x>=o?B=new a(o,B.y+(o-B.x)/(N.x-B.x)*(N.y-B.y))._round():N.x>=o&&(N=new a(o,B.y+(o-B.x)/(N.x-B.x)*(N.y-B.y))._round()),B.y>=f&&N.y>=f||(B.y>=f?B=new a(B.x+(f-B.y)/(N.y-B.y)*(N.x-B.x),f)._round():N.y>=f&&(N=new a(B.x+(f-B.y)/(N.y-B.y)*(N.x-B.x),f)._round()),O&&B.equals(O[O.length-1])||(O=[B],w.push(O)),O.push(N)))))}}return w}qt("FeatureIndex",Yu,{omit:["rawTileData","sourceLayerCoder"]});class ia extends a{constructor(e,r,o,f){super(e,r),this.angle=o,f!==void 0&&(this.segment=f)}clone(){return new ia(this.x,this.y,this.angle,this.segment)}}function Qu(i,e,r,o,f){if(e.segment===void 0||r===0)return!0;let w=e,C=e.segment+1,I=0;for(;I>-r/2;){if(C--,C<0)return!1;I-=i[C].dist(w),w=i[C]}I+=i[C].dist(i[C+1]),C++;const O=[];let z=0;for(;I<r/2;){const B=i[C],N=i[C+1];if(!N)return!1;let W=i[C-1].angleTo(B)-B.angleTo(N);for(W=Math.abs((W+3*Math.PI)%(2*Math.PI)-Math.PI),O.push({distance:I,angleDelta:W}),z+=W;I-O[0].distance>o;)z-=O.shift().angleDelta;if(z>f)return!1;C++,I+=B.dist(N)}return!0}function ed(i){let e=0;for(let r=0;r<i.length-1;r++)e+=i[r].dist(i[r+1]);return e}function td(i,e,r){return i?.6*e*r:0}function id(i,e){return Math.max(i?i.right-i.left:0,e?e.right-e.left:0)}function wp(i,e,r,o,f,w){const C=td(r,f,w),I=id(r,o)*w;let O=0;const z=ed(i)/2;for(let B=0;B<i.length-1;B++){const N=i[B],W=i[B+1],Z=N.dist(W);if(O+Z>z){const J=(z-O)/Z,se=Qr.number(N.x,W.x,J),de=Qr.number(N.y,W.y,J),Ce=new ia(se,de,W.angleTo(N),B);return Ce._round(),!C||Qu(i,Ce,I,C,e)?Ce:void 0}O+=Z}}function Cp(i,e,r,o,f,w,C,I,O){const z=td(o,w,C),B=id(o,f),N=B*C,W=i[0].x===0||i[0].x===O||i[0].y===0||i[0].y===O;return e-N<e/4&&(e=N+e/4),rd(i,W?e/2*I%e:(B/2+2*w)*C*I%e,e,z,r,N,W,!1,O)}function rd(i,e,r,o,f,w,C,I,O){const z=w/2,B=ed(i);let N=0,W=e-r,Z=[];for(let J=0;J<i.length-1;J++){const se=i[J],de=i[J+1],Ce=se.dist(de),Ve=de.angleTo(se);for(;W+r<N+Ce;){W+=r;const Se=(W-N)/Ce,De=Qr.number(se.x,de.x,Se),ht=Qr.number(se.y,de.y,Se);if(De>=0&&De<O&&ht>=0&&ht<O&&W-z>=0&&W+z<=B){const gt=new ia(De,ht,Ve,J);gt._round(),o&&!Qu(i,gt,w,o,f)||Z.push(gt)}}N+=Ce}return I||Z.length||C||(Z=rd(i,N/2,r,o,f,w,C,!0,O)),Z}qt("Anchor",ia);const gl=Gn;function nd(i,e,r,o){const f=[],w=i.image,C=w.pixelRatio,I=w.paddedRect.w-2*gl,O=w.paddedRect.h-2*gl,z=i.right-i.left,B=i.bottom-i.top,N=w.stretchX||[[0,I]],W=w.stretchY||[[0,O]],Z=(Lt,Kt)=>Lt+Kt[1]-Kt[0],J=N.reduce(Z,0),se=W.reduce(Z,0),de=I-J,Ce=O-se;let Ve=0,Se=J,De=0,ht=se,gt=0,$t=de,ei=0,Xt=Ce;if(w.content&&o){const Lt=w.content;Ve=Ac(N,0,Lt[0]),De=Ac(W,0,Lt[1]),Se=Ac(N,Lt[0],Lt[2]),ht=Ac(W,Lt[1],Lt[3]),gt=Lt[0]-Ve,ei=Lt[1]-De,$t=Lt[2]-Lt[0]-Se,Xt=Lt[3]-Lt[1]-ht}const Ut=(Lt,Kt,jt,St)=>{const ci=Mc(Lt.stretch-Ve,Se,z,i.left),ni=kc(Lt.fixed-gt,$t,Lt.stretch,J),ki=Mc(Kt.stretch-De,ht,B,i.top),hr=kc(Kt.fixed-ei,Xt,Kt.stretch,se),mr=Mc(jt.stretch-Ve,Se,z,i.left),$r=kc(jt.fixed-gt,$t,jt.stretch,J),rs=Mc(St.stretch-De,ht,B,i.top),On=kc(St.fixed-ei,Xt,St.stretch,se),jr=new a(ci,ki),un=new a(mr,ki),pn=new a(mr,rs),Dn=new a(ci,rs),Ln=new a(ni/C,hr/C),Yr=new a($r/C,On/C),Zr=e*Math.PI/180;if(Zr){const xn=Math.sin(Zr),Hn=Math.cos(Zr),Wn=[Hn,-xn,xn,Hn];jr._matMult(Wn),un._matMult(Wn),Dn._matMult(Wn),pn._matMult(Wn)}const vn=Lt.stretch+Lt.fixed,zn=Kt.stretch+Kt.fixed;return{tl:jr,tr:un,bl:Dn,br:pn,tex:{x:w.paddedRect.x+gl+vn,y:w.paddedRect.y+gl+zn,w:jt.stretch+jt.fixed-vn,h:St.stretch+St.fixed-zn},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Ln,pixelOffsetBR:Yr,minFontScaleX:$t/C/z,minFontScaleY:Xt/C/B,isSDF:r}};if(o&&(w.stretchX||w.stretchY)){const Lt=sd(N,de,J),Kt=sd(W,Ce,se);for(let jt=0;jt<Lt.length-1;jt++){const St=Lt[jt],ci=Lt[jt+1];for(let ni=0;ni<Kt.length-1;ni++)f.push(Ut(St,Kt[ni],ci,Kt[ni+1]))}}else f.push(Ut({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:I+1},{fixed:0,stretch:O+1}));return f}function Ac(i,e,r){let o=0;for(const f of i)o+=Math.max(e,Math.min(r,f[1]))-Math.max(e,Math.min(r,f[0]));return o}function sd(i,e,r){const o=[{fixed:-gl,stretch:0}];for(const[f,w]of i){const C=o[o.length-1];o.push({fixed:f-C.stretch,stretch:C.stretch}),o.push({fixed:f-C.stretch,stretch:C.stretch+(w-f)})}return o.push({fixed:e+gl,stretch:r}),o}function Mc(i,e,r,o){return i/e*r+o}function kc(i,e,r,o){return i-e*r/o}class Oc{constructor(e,r,o,f,w,C,I,O,z,B){if(this.boxStartIndex=e.length,z){let N=C.top,W=C.bottom;const Z=C.collisionPadding;Z&&(N-=Z[1],W+=Z[3]);let J=W-N;J>0&&(J=Math.max(10,J),this.circleDiameter=J)}else{let N=C.top*I-O[0],W=C.bottom*I+O[2],Z=C.left*I-O[3],J=C.right*I+O[1];const se=C.collisionPadding;if(se&&(Z-=se[0]*I,N-=se[1]*I,J+=se[2]*I,W+=se[3]*I),B){const de=new a(Z,N),Ce=new a(J,N),Ve=new a(Z,W),Se=new a(J,W),De=B*Math.PI/180;de._rotate(De),Ce._rotate(De),Ve._rotate(De),Se._rotate(De),Z=Math.min(de.x,Ce.x,Ve.x,Se.x),J=Math.max(de.x,Ce.x,Ve.x,Se.x),N=Math.min(de.y,Ce.y,Ve.y,Se.y),W=Math.max(de.y,Ce.y,Ve.y,Se.y)}e.emplaceBack(r.x,r.y,Z,N,J,W,o,f,w)}this.boxEndIndex=e.length}}class Sp{constructor(e=[],r=Tp){if(this.data=e,this.length=this.data.length,this.compare=r,this.length>0)for(let o=(this.length>>1)-1;o>=0;o--)this._down(o)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const e=this.data[0],r=this.data.pop();return this.length--,this.length>0&&(this.data[0]=r,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:r,compare:o}=this,f=r[e];for(;e>0;){const w=e-1>>1,C=r[w];if(o(f,C)>=0)break;r[e]=C,e=w}r[e]=f}_down(e){const{data:r,compare:o}=this,f=this.length>>1,w=r[e];for(;e<f;){let C=1+(e<<1),I=r[C];const O=C+1;if(O<this.length&&o(r[O],I)<0&&(C=O,I=r[O]),o(I,w)>=0)break;r[e]=I,e=C}r[e]=w}}function Tp(i,e){return i<e?-1:i>e?1:0}function Ep(i,e=1,r=!1){let o=1/0,f=1/0,w=-1/0,C=-1/0;const I=i[0];for(let Z=0;Z<I.length;Z++){const J=I[Z];(!Z||J.x<o)&&(o=J.x),(!Z||J.y<f)&&(f=J.y),(!Z||J.x>w)&&(w=J.x),(!Z||J.y>C)&&(C=J.y)}const O=Math.min(w-o,C-f);let z=O/2;const B=new Sp([],Ip);if(O===0)return new a(o,f);for(let Z=o;Z<w;Z+=O)for(let J=f;J<C;J+=O)B.push(new _l(Z+z,J+z,z,i));let N=function(Z){let J=0,se=0,de=0;const Ce=Z[0];for(let Ve=0,Se=Ce.length,De=Se-1;Ve<Se;De=Ve++){const ht=Ce[Ve],gt=Ce[De],$t=ht.x*gt.y-gt.x*ht.y;se+=(ht.x+gt.x)*$t,de+=(ht.y+gt.y)*$t,J+=3*$t}return new _l(se/J,de/J,0,Z)}(i),W=B.length;for(;B.length;){const Z=B.pop();(Z.d>N.d||!N.d)&&(N=Z,r&&console.log("found best %d after %d probes",Math.round(1e4*Z.d)/1e4,W)),Z.max-N.d<=e||(z=Z.h/2,B.push(new _l(Z.p.x-z,Z.p.y-z,z,i)),B.push(new _l(Z.p.x+z,Z.p.y-z,z,i)),B.push(new _l(Z.p.x-z,Z.p.y+z,z,i)),B.push(new _l(Z.p.x+z,Z.p.y+z,z,i)),W+=4)}return r&&(console.log(`num probes: ${W}`),console.log(`best distance: ${N.d}`)),N.p}function Ip(i,e){return e.max-i.max}function _l(i,e,r,o){this.p=new a(i,e),this.h=r,this.d=function(f,w){let C=!1,I=1/0;for(let O=0;O<w.length;O++){const z=w[O];for(let B=0,N=z.length,W=N-1;B<N;W=B++){const Z=z[B],J=z[W];Z.y>f.y!=J.y>f.y&&f.x<(J.x-Z.x)*(f.y-Z.y)/(J.y-Z.y)+Z.x&&(C=!C),I=Math.min(I,Uh(f,Z,J))}}return(C?1:-1)*Math.sqrt(I)}(this.p,o),this.max=this.d+this.h*Math.SQRT2}var fn;j.ap=void 0,(fn=j.ap||(j.ap={}))[fn.center=1]="center",fn[fn.left=2]="left",fn[fn.right=3]="right",fn[fn.top=4]="top",fn[fn.bottom=5]="bottom",fn[fn["top-left"]=6]="top-left",fn[fn["top-right"]=7]="top-right",fn[fn["bottom-left"]=8]="bottom-left",fn[fn["bottom-right"]=9]="bottom-right";const ra=7,vh=Number.POSITIVE_INFINITY;function od(i,e){return e[1]!==vh?function(r,o,f){let w=0,C=0;switch(o=Math.abs(o),f=Math.abs(f),r){case"top-right":case"top-left":case"top":C=f-ra;break;case"bottom-right":case"bottom-left":case"bottom":C=-f+ra}switch(r){case"top-right":case"bottom-right":case"right":w=-o;break;case"top-left":case"bottom-left":case"left":w=o}return[w,C]}(i,e[0],e[1]):function(r,o){let f=0,w=0;o<0&&(o=0);const C=o/Math.SQRT2;switch(r){case"top-right":case"top-left":w=C-ra;break;case"bottom-right":case"bottom-left":w=-C+ra;break;case"bottom":w=-o+ra;break;case"top":w=o-ra}switch(r){case"top-right":case"bottom-right":f=-C;break;case"top-left":case"bottom-left":f=C;break;case"left":f=o;break;case"right":f=-o}return[f,w]}(i,e[0])}function ad(i,e,r){var o;const f=i.layout,w=(o=f.get("text-variable-anchor-offset"))===null||o===void 0?void 0:o.evaluate(e,{},r);if(w){const I=w.values,O=[];for(let z=0;z<I.length;z+=2){const B=O[z]=I[z],N=I[z+1].map(W=>W*qr);B.startsWith("top")?N[1]-=ra:B.startsWith("bottom")&&(N[1]+=ra),O[z+1]=N}return new Cr(O)}const C=f.get("text-variable-anchor");if(C){let I;I=i._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[f.get("text-radial-offset").evaluate(e,{},r)*qr,vh]:f.get("text-offset").evaluate(e,{},r).map(z=>z*qr);const O=[];for(const z of C)O.push(z,od(z,I));return new Cr(O)}return null}function xh(i){switch(i){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Pp(i,e,r,o,f,w,C,I,O,z,B){let N=w.textMaxSize.evaluate(e,{});N===void 0&&(N=C);const W=i.layers[0].layout,Z=W.get("icon-offset").evaluate(e,{},B),J=cd(r.horizontal),se=C/24,de=i.tilePixelRatio*se,Ce=i.tilePixelRatio*N/24,Ve=i.tilePixelRatio*I,Se=i.tilePixelRatio*W.get("symbol-spacing"),De=W.get("text-padding")*i.tilePixelRatio,ht=function(St,ci,ni,ki=1){const hr=St.get("icon-padding").evaluate(ci,{},ni),mr=hr&&hr.values;return[mr[0]*ki,mr[1]*ki,mr[2]*ki,mr[3]*ki]}(W,e,B,i.tilePixelRatio),gt=W.get("text-max-angle")/180*Math.PI,$t=W.get("text-rotation-alignment")!=="viewport"&&W.get("symbol-placement")!=="point",ei=W.get("icon-rotation-alignment")==="map"&&W.get("symbol-placement")!=="point",Xt=W.get("symbol-placement"),Ut=Se/2,Lt=W.get("icon-text-fit");let Kt;o&&Lt!=="none"&&(i.allowVerticalPlacement&&r.vertical&&(Kt=Ou(o,r.vertical,Lt,W.get("icon-text-fit-padding"),Z,se)),J&&(o=Ou(o,J,Lt,W.get("icon-text-fit-padding"),Z,se)));const jt=(St,ci)=>{ci.x<0||ci.x>=Mr||ci.y<0||ci.y>=Mr||function(ni,ki,hr,mr,$r,rs,On,jr,un,pn,Dn,Ln,Yr,Zr,vn,zn,xn,Hn,Wn,Kr,Li,bn,mn,Jr,Is){const Vs=ni.addToLineVertexArray(ki,hr);let Us,Eo,Ps,ms,Xn=0,Io=0,rc=0,fd=0,Ph=-1,Ah=-1;const Po={};let pd=Ir("");if(ni.allowVerticalPlacement&&mr.vertical){const wn=jr.layout.get("text-rotate").evaluate(Li,{},Jr)+90;Ps=new Oc(un,ki,pn,Dn,Ln,mr.vertical,Yr,Zr,vn,wn),On&&(ms=new Oc(un,ki,pn,Dn,Ln,On,xn,Hn,vn,wn))}if($r){const wn=jr.layout.get("icon-rotate").evaluate(Li,{}),gs=jr.layout.get("icon-text-fit")!=="none",Da=nd($r,wn,mn,gs),Hs=On?nd(On,wn,mn,gs):void 0;Eo=new Oc(un,ki,pn,Dn,Ln,$r,xn,Hn,!1,wn),Xn=4*Da.length;const La=ni.iconSizeData;let no=null;La.kind==="source"?(no=[ro*jr.layout.get("icon-size").evaluate(Li,{})],no[0]>ea&&ct(`${ni.layerIds[0]}: Value for "icon-size" is >= ${Ql}. Reduce your "icon-size".`)):La.kind==="composite"&&(no=[ro*bn.compositeIconSizes[0].evaluate(Li,{},Jr),ro*bn.compositeIconSizes[1].evaluate(Li,{},Jr)],(no[0]>ea||no[1]>ea)&&ct(`${ni.layerIds[0]}: Value for "icon-size" is >= ${Ql}. Reduce your "icon-size".`)),ni.addSymbols(ni.icon,Da,no,Kr,Wn,Li,j.ah.none,ki,Vs.lineStartIndex,Vs.lineLength,-1,Jr),Ph=ni.icon.placedSymbolArray.length-1,Hs&&(Io=4*Hs.length,ni.addSymbols(ni.icon,Hs,no,Kr,Wn,Li,j.ah.vertical,ki,Vs.lineStartIndex,Vs.lineLength,-1,Jr),Ah=ni.icon.placedSymbolArray.length-1)}const md=Object.keys(mr.horizontal);for(const wn of md){const gs=mr.horizontal[wn];if(!Us){pd=Ir(gs.text);const Hs=jr.layout.get("text-rotate").evaluate(Li,{},Jr);Us=new Oc(un,ki,pn,Dn,Ln,gs,Yr,Zr,vn,Hs)}const Da=gs.positionedLines.length===1;if(rc+=ld(ni,ki,gs,rs,jr,vn,Li,zn,Vs,mr.vertical?j.ah.horizontal:j.ah.horizontalOnly,Da?md:[wn],Po,Ph,bn,Jr),Da)break}mr.vertical&&(fd+=ld(ni,ki,mr.vertical,rs,jr,vn,Li,zn,Vs,j.ah.vertical,["vertical"],Po,Ah,bn,Jr));const kp=Us?Us.boxStartIndex:ni.collisionBoxArray.length,Op=Us?Us.boxEndIndex:ni.collisionBoxArray.length,Dp=Ps?Ps.boxStartIndex:ni.collisionBoxArray.length,Lp=Ps?Ps.boxEndIndex:ni.collisionBoxArray.length,zp=Eo?Eo.boxStartIndex:ni.collisionBoxArray.length,Fp=Eo?Eo.boxEndIndex:ni.collisionBoxArray.length,Rp=ms?ms.boxStartIndex:ni.collisionBoxArray.length,Bp=ms?ms.boxEndIndex:ni.collisionBoxArray.length;let Gs=-1;const Lc=(wn,gs)=>wn&&wn.circleDiameter?Math.max(wn.circleDiameter,gs):gs;Gs=Lc(Us,Gs),Gs=Lc(Ps,Gs),Gs=Lc(Eo,Gs),Gs=Lc(ms,Gs);const gd=Gs>-1?1:0;gd&&(Gs*=Is/qr),ni.glyphOffsetArray.length>=ml.MAX_GLYPHS&&ct("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Li.sortKey!==void 0&&ni.addToSortKeyRanges(ni.symbolInstances.length,Li.sortKey);const jp=ad(jr,Li,Jr),[Np,Vp]=function(wn,gs){const Da=wn.length,Hs=gs==null?void 0:gs.values;if((Hs==null?void 0:Hs.length)>0)for(let La=0;La<Hs.length;La+=2){const no=Hs[La+1];wn.emplaceBack(j.ap[Hs[La]],no[0],no[1])}return[Da,wn.length]}(ni.textAnchorOffsets,jp);ni.symbolInstances.emplaceBack(ki.x,ki.y,Po.right>=0?Po.right:-1,Po.center>=0?Po.center:-1,Po.left>=0?Po.left:-1,Po.vertical||-1,Ph,Ah,pd,kp,Op,Dp,Lp,zp,Fp,Rp,Bp,pn,rc,fd,Xn,Io,gd,0,Yr,Gs,Np,Vp)}(i,ci,St,r,o,f,Kt,i.layers[0],i.collisionBoxArray,e.index,e.sourceLayerIndex,i.index,de,[De,De,De,De],$t,O,Ve,ht,ei,Z,e,w,z,B,C)};if(Xt==="line")for(const St of Ju(e.geometry,0,0,Mr,Mr)){const ci=Cp(St,Se,gt,r.vertical||J,o,24,Ce,i.overscaling,Mr);for(const ni of ci)J&&Ap(i,J.text,Ut,ni)||jt(St,ni)}else if(Xt==="line-center"){for(const St of e.geometry)if(St.length>1){const ci=wp(St,gt,r.vertical||J,o,24,Ce);ci&&jt(St,ci)}}else if(e.type==="Polygon")for(const St of Jc(e.geometry,0)){const ci=Ep(St,16);jt(St[0],new ia(ci.x,ci.y,0))}else if(e.type==="LineString")for(const St of e.geometry)jt(St,new ia(St[0].x,St[0].y,0));else if(e.type==="Point")for(const St of e.geometry)for(const ci of St)jt([ci],new ia(ci.x,ci.y,0))}function ld(i,e,r,o,f,w,C,I,O,z,B,N,W,Z,J){const se=function(Ve,Se,De,ht,gt,$t,ei,Xt){const Ut=ht.layout.get("text-rotate").evaluate($t,{})*Math.PI/180,Lt=[];for(const Kt of Se.positionedLines)for(const jt of Kt.positionedGlyphs){if(!jt.rect)continue;const St=jt.rect||{};let ci=Tu+1,ni=!0,ki=1,hr=0;const mr=(gt||Xt)&&jt.vertical,$r=jt.metrics.advance*jt.scale/2;if(Xt&&Se.verticalizable&&(hr=Kt.lineOffset/2-(jt.imageName?-(qr-jt.metrics.width*jt.scale)/2:(jt.scale-1)*qr)),jt.imageName){const Kr=ei[jt.imageName];ni=Kr.sdf,ki=Kr.pixelRatio,ci=Gn/ki}const rs=gt?[jt.x+$r,jt.y]:[0,0];let On=gt?[0,0]:[jt.x+$r+De[0],jt.y+De[1]-hr],jr=[0,0];mr&&(jr=On,On=[0,0]);const un=jt.metrics.isDoubleResolution?2:1,pn=(jt.metrics.left-ci)*jt.scale-$r+On[0],Dn=(-jt.metrics.top-ci)*jt.scale+On[1],Ln=pn+St.w/un*jt.scale/ki,Yr=Dn+St.h/un*jt.scale/ki,Zr=new a(pn,Dn),vn=new a(Ln,Dn),zn=new a(pn,Yr),xn=new a(Ln,Yr);if(mr){const Kr=new a(-$r,$r-Kl),Li=-Math.PI/2,bn=qr/2-$r,mn=new a(5-Kl-bn,-(jt.imageName?bn:0)),Jr=new a(...jr);Zr._rotateAround(Li,Kr)._add(mn)._add(Jr),vn._rotateAround(Li,Kr)._add(mn)._add(Jr),zn._rotateAround(Li,Kr)._add(mn)._add(Jr),xn._rotateAround(Li,Kr)._add(mn)._add(Jr)}if(Ut){const Kr=Math.sin(Ut),Li=Math.cos(Ut),bn=[Li,-Kr,Kr,Li];Zr._matMult(bn),vn._matMult(bn),zn._matMult(bn),xn._matMult(bn)}const Hn=new a(0,0),Wn=new a(0,0);Lt.push({tl:Zr,tr:vn,bl:zn,br:xn,tex:St,writingMode:Se.writingMode,glyphOffset:rs,sectionIndex:jt.sectionIndex,isSDF:ni,pixelOffsetTL:Hn,pixelOffsetBR:Wn,minFontScaleX:0,minFontScaleY:0})}return Lt}(0,r,I,f,w,C,o,i.allowVerticalPlacement),de=i.textSizeData;let Ce=null;de.kind==="source"?(Ce=[ro*f.layout.get("text-size").evaluate(C,{})],Ce[0]>ea&&ct(`${i.layerIds[0]}: Value for "text-size" is >= ${Ql}. Reduce your "text-size".`)):de.kind==="composite"&&(Ce=[ro*Z.compositeTextSizes[0].evaluate(C,{},J),ro*Z.compositeTextSizes[1].evaluate(C,{},J)],(Ce[0]>ea||Ce[1]>ea)&&ct(`${i.layerIds[0]}: Value for "text-size" is >= ${Ql}. Reduce your "text-size".`)),i.addSymbols(i.text,se,Ce,I,w,C,z,e,O.lineStartIndex,O.lineLength,W,J);for(const Ve of B)N[Ve]=i.text.placedSymbolArray.length-1;return 4*se.length}function cd(i){for(const e in i)return i[e];return null}function Ap(i,e,r,o){const f=i.compareText;if(e in f){const w=f[e];for(let C=w.length-1;C>=0;C--)if(o.dist(w[C])<r)return!0}else f[e]=[];return f[e].push(o),!1}const hd=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class bh{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[r,o]=new Uint8Array(e,0,2);if(r!==219)throw new Error("Data does not appear to be in a KDBush format.");const f=o>>4;if(f!==1)throw new Error(`Got v${f} data when expected v1.`);const w=hd[15&o];if(!w)throw new Error("Unrecognized array type.");const[C]=new Uint16Array(e,2,1),[I]=new Uint32Array(e,4,1);return new bh(I,C,w,e)}constructor(e,r=64,o=Float64Array,f){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+r,2),65535),this.ArrayType=o,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const w=hd.indexOf(this.ArrayType),C=2*e*this.ArrayType.BYTES_PER_ELEMENT,I=e*this.IndexArrayType.BYTES_PER_ELEMENT,O=(8-I%8)%8;if(w<0)throw new Error(`Unexpected typed array class: ${o}.`);f&&f instanceof ArrayBuffer?(this.data=f,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+I+O,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+C+I+O),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+I+O,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+w]),new Uint16Array(this.data,2,1)[0]=r,new Uint32Array(this.data,4,1)[0]=e)}add(e,r){const o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=e,this.coords[this._pos++]=r,o}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return wh(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,r,o,f){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:w,coords:C,nodeSize:I}=this,O=[0,w.length-1,0],z=[];for(;O.length;){const B=O.pop()||0,N=O.pop()||0,W=O.pop()||0;if(N-W<=I){for(let de=W;de<=N;de++){const Ce=C[2*de],Ve=C[2*de+1];Ce>=e&&Ce<=o&&Ve>=r&&Ve<=f&&z.push(w[de])}continue}const Z=W+N>>1,J=C[2*Z],se=C[2*Z+1];J>=e&&J<=o&&se>=r&&se<=f&&z.push(w[Z]),(B===0?e<=J:r<=se)&&(O.push(W),O.push(Z-1),O.push(1-B)),(B===0?o>=J:f>=se)&&(O.push(Z+1),O.push(N),O.push(1-B))}return z}within(e,r,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:f,coords:w,nodeSize:C}=this,I=[0,f.length-1,0],O=[],z=o*o;for(;I.length;){const B=I.pop()||0,N=I.pop()||0,W=I.pop()||0;if(N-W<=C){for(let de=W;de<=N;de++)dd(w[2*de],w[2*de+1],e,r)<=z&&O.push(f[de]);continue}const Z=W+N>>1,J=w[2*Z],se=w[2*Z+1];dd(J,se,e,r)<=z&&O.push(f[Z]),(B===0?e-o<=J:r-o<=se)&&(I.push(W),I.push(Z-1),I.push(1-B)),(B===0?e+o>=J:r+o>=se)&&(I.push(Z+1),I.push(N),I.push(1-B))}return O}}function wh(i,e,r,o,f,w){if(f-o<=r)return;const C=o+f>>1;ud(i,e,C,o,f,w),wh(i,e,r,o,C-1,1-w),wh(i,e,r,C+1,f,1-w)}function ud(i,e,r,o,f,w){for(;f>o;){if(f-o>600){const z=f-o+1,B=r-o+1,N=Math.log(z),W=.5*Math.exp(2*N/3),Z=.5*Math.sqrt(N*W*(z-W)/z)*(B-z/2<0?-1:1);ud(i,e,r,Math.max(o,Math.floor(r-B*W/z+Z)),Math.min(f,Math.floor(r+(z-B)*W/z+Z)),w)}const C=e[2*r+w];let I=o,O=f;for(tc(i,e,o,r),e[2*f+w]>C&&tc(i,e,o,f);I<O;){for(tc(i,e,I,O),I++,O--;e[2*I+w]<C;)I++;for(;e[2*O+w]>C;)O--}e[2*o+w]===C?tc(i,e,o,O):(O++,tc(i,e,O,f)),O<=r&&(o=O+1),r<=O&&(f=O-1)}}function tc(i,e,r,o){Ch(i,r,o),Ch(e,2*r,2*o),Ch(e,2*r+1,2*o+1)}function Ch(i,e,r){const o=i[e];i[e]=i[r],i[r]=o}function dd(i,e,r,o){const f=i-r,w=e-o;return f*f+w*w}var Sh;j.bd=void 0,(Sh=j.bd||(j.bd={})).create="create",Sh.load="load",Sh.fullLoad="fullLoad";let Dc=null,ic=[];const Th=1e3/60,Eh="loadTime",Ih="fullLoadTime",Mp={mark(i){performance.mark(i)},frame(i){const e=i;Dc!=null&&ic.push(e-Dc),Dc=e},clearMetrics(){Dc=null,ic=[],performance.clearMeasures(Eh),performance.clearMeasures(Ih);for(const i in j.bd)performance.clearMarks(j.bd[i])},getPerformanceMetrics(){performance.measure(Eh,j.bd.create,j.bd.load),performance.measure(Ih,j.bd.create,j.bd.fullLoad);const i=performance.getEntriesByName(Eh)[0].duration,e=performance.getEntriesByName(Ih)[0].duration,r=ic.length,o=1/(ic.reduce((w,C)=>w+C,0)/r/1e3),f=ic.filter(w=>w>Th).reduce((w,C)=>w+(C-Th)/Th,0);return{loadTime:i,fullLoadTime:e,fps:o,percentDroppedFrames:f/(r+f)*100,totalFrames:r}}};j.$=zt,j.A=cl,j.B=function(i){if(st==null){const e=i.navigator?i.navigator.userAgent:null;st=!!i.safari||!(!e||!(/\b(iPad|iPhone|iPod)\b/.test(e)||e.match("Safari")&&!e.match("Chrome")))}return st},j.C=class{constructor(i,e){this.target=i,this.mapId=e,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new xp(()=>this.process()),this.subscription=function(r,o,f,w){return r.addEventListener(o,f,!1),{unsubscribe:()=>{r.removeEventListener(o,f,!1)}}}(this.target,"message",r=>this.receive(r)),this.globalScope=Mt(self)?i:window}registerMessageHandler(i,e){this.messageHandlers[i]=e}sendAsync(i,e){return new Promise((r,o)=>{const f=Math.round(1e18*Math.random()).toString(36).substring(0,10);this.resolveRejects[f]={resolve:r,reject:o},e&&e.signal.addEventListener("abort",()=>{delete this.resolveRejects[f];const I={id:f,type:"<cancel>",origin:location.origin,targetMapId:i.targetMapId,sourceMapId:this.mapId};this.target.postMessage(I)},{once:!0});const w=[],C=Object.assign(Object.assign({},i),{id:f,sourceMapId:this.mapId,origin:location.origin,data:Nn(i.data,w)});this.target.postMessage(C,{transfer:w})})}receive(i){const e=i.data,r=e.id;if(!(e.origin!=="file://"&&location.origin!=="file://"&&e.origin!==location.origin||e.targetMapId&&this.mapId!==e.targetMapId)){if(e.type==="<cancel>"){delete this.tasks[r];const o=this.abortControllers[r];return delete this.abortControllers[r],void(o&&o.abort())}if(Mt(self)||e.mustQueue)return this.tasks[r]=e,this.taskQueue.push(r),void this.invoker.trigger();this.processTask(r,e)}}process(){if(this.taskQueue.length===0)return;const i=this.taskQueue.shift(),e=this.tasks[i];delete this.tasks[i],this.taskQueue.length>0&&this.invoker.trigger(),e&&this.processTask(i,e)}processTask(i,e){return s(this,void 0,void 0,function*(){if(e.type==="<response>"){const f=this.resolveRejects[i];return delete this.resolveRejects[i],f?void(e.error?f.reject(An(e.error)):f.resolve(An(e.data))):void 0}if(!this.messageHandlers[e.type])return void this.completeTask(i,new Error(`Could not find a registered handler for ${e.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const r=An(e.data),o=new AbortController;this.abortControllers[i]=o;try{const f=yield this.messageHandlers[e.type](e.sourceMapId,r,o);this.completeTask(i,null,f)}catch(f){this.completeTask(i,f)}})}completeTask(i,e,r){const o=[];delete this.abortControllers[i];const f={id:i,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:e?Nn(e):null,data:Nn(r,o)};this.target.postMessage(f,{transfer:o})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},j.D=si,j.E=qe,j.F=function(){var i=new cl(16);return cl!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i},j.G=Ne,j.H=function(i,e,r){var o,f,w,C,I,O,z,B,N,W,Z,J,se=r[0],de=r[1],Ce=r[2];return e===i?(i[12]=e[0]*se+e[4]*de+e[8]*Ce+e[12],i[13]=e[1]*se+e[5]*de+e[9]*Ce+e[13],i[14]=e[2]*se+e[6]*de+e[10]*Ce+e[14],i[15]=e[3]*se+e[7]*de+e[11]*Ce+e[15]):(f=e[1],w=e[2],C=e[3],I=e[4],O=e[5],z=e[6],B=e[7],N=e[8],W=e[9],Z=e[10],J=e[11],i[0]=o=e[0],i[1]=f,i[2]=w,i[3]=C,i[4]=I,i[5]=O,i[6]=z,i[7]=B,i[8]=N,i[9]=W,i[10]=Z,i[11]=J,i[12]=o*se+I*de+N*Ce+e[12],i[13]=f*se+O*de+W*Ce+e[13],i[14]=w*se+z*de+Z*Ce+e[14],i[15]=C*se+B*de+J*Ce+e[15]),i},j.I=lh,j.J=function(i,e,r){var o=r[0],f=r[1],w=r[2];return i[0]=e[0]*o,i[1]=e[1]*o,i[2]=e[2]*o,i[3]=e[3]*o,i[4]=e[4]*f,i[5]=e[5]*f,i[6]=e[6]*f,i[7]=e[7]*f,i[8]=e[8]*w,i[9]=e[9]*w,i[10]=e[10]*w,i[11]=e[11]*w,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i},j.K=Xh,j.L=function(i,e){const r={};for(let o=0;o<e.length;o++){const f=e[o];f in i&&(r[f]=i[f])}return r},j.M=ta,j.N=Vu,j.O=Uu,j.P=a,j.Q=ps,j.R=fs,j.S=x,j.T=El,j.U=T,j.V=be,j.W=Mr,j.X=Dr,j.Y=Pc,j.Z=class extends Al{},j._=s,j.a=te,j.a$=function(i,e,r){return i[0]=e[0]*r[0],i[1]=e[1]*r[1],i[2]=e[2]*r[2],i[3]=e[3]*r[3],i},j.a0=yh,j.a1=ut,j.a2=i=>{const e=window.document.createElement("video");return e.muted=!0,new Promise(r=>{e.onloadstart=()=>{r(e)};for(const o of i){const f=window.document.createElement("source");_t(o)||(e.crossOrigin="Anonymous"),f.src=o,e.appendChild(f)}})},j.a3=function(){return ve++},j.a4=g,j.a5=ml,j.a6=Ls,j.a7=So,j.a8=fr,j.a9=$u,j.aA=Ze,j.aB=function(i,e){if(!i)return[{command:"setStyle",args:[e]}];let r=[];try{if(!Tt(i.version,e.version))return[{command:"setStyle",args:[e]}];Tt(i.center,e.center)||r.push({command:"setCenter",args:[e.center]}),Tt(i.zoom,e.zoom)||r.push({command:"setZoom",args:[e.zoom]}),Tt(i.bearing,e.bearing)||r.push({command:"setBearing",args:[e.bearing]}),Tt(i.pitch,e.pitch)||r.push({command:"setPitch",args:[e.pitch]}),Tt(i.sprite,e.sprite)||r.push({command:"setSprite",args:[e.sprite]}),Tt(i.glyphs,e.glyphs)||r.push({command:"setGlyphs",args:[e.glyphs]}),Tt(i.transition,e.transition)||r.push({command:"setTransition",args:[e.transition]}),Tt(i.light,e.light)||r.push({command:"setLight",args:[e.light]}),Tt(i.terrain,e.terrain)||r.push({command:"setTerrain",args:[e.terrain]}),Tt(i.sky,e.sky)||r.push({command:"setSky",args:[e.sky]});const o={},f=[];(function(C,I,O,z){let B;for(B in I=I||{},C=C||{})Object.prototype.hasOwnProperty.call(C,B)&&(Object.prototype.hasOwnProperty.call(I,B)||wt(B,O,z));for(B in I)Object.prototype.hasOwnProperty.call(I,B)&&(Object.prototype.hasOwnProperty.call(C,B)?Tt(C[B],I[B])||(C[B].type==="geojson"&&I[B].type==="geojson"&&fi(C,I,B)?Nt(O,{command:"setGeoJSONSourceData",args:[B,I[B].data]}):Yt(B,I,O,z)):lt(B,I,O))})(i.sources,e.sources,f,o);const w=[];i.layers&&i.layers.forEach(C=>{"source"in C&&o[C.source]?r.push({command:"removeLayer",args:[C.id]}):w.push(C)}),r=r.concat(f),function(C,I,O){I=I||[];const z=(C=C||[]).map(yi),B=I.map(yi),N=C.reduce(bi,{}),W=I.reduce(bi,{}),Z=z.slice(),J=Object.create(null);let se,de,Ce,Ve,Se;for(let De=0,ht=0;De<z.length;De++)se=z[De],Object.prototype.hasOwnProperty.call(W,se)?ht++:(Nt(O,{command:"removeLayer",args:[se]}),Z.splice(Z.indexOf(se,ht),1));for(let De=0,ht=0;De<B.length;De++)se=B[B.length-1-De],Z[Z.length-1-De]!==se&&(Object.prototype.hasOwnProperty.call(N,se)?(Nt(O,{command:"removeLayer",args:[se]}),Z.splice(Z.lastIndexOf(se,Z.length-ht),1)):ht++,Ve=Z[Z.length-De],Nt(O,{command:"addLayer",args:[W[se],Ve]}),Z.splice(Z.length-De,0,se),J[se]=!0);for(let De=0;De<B.length;De++)if(se=B[De],de=N[se],Ce=W[se],!J[se]&&!Tt(de,Ce))if(Tt(de.source,Ce.source)&&Tt(de["source-layer"],Ce["source-layer"])&&Tt(de.type,Ce.type)){for(Se in mi(de.layout,Ce.layout,O,se,null,"setLayoutProperty"),mi(de.paint,Ce.paint,O,se,null,"setPaintProperty"),Tt(de.filter,Ce.filter)||Nt(O,{command:"setFilter",args:[se,Ce.filter]}),Tt(de.minzoom,Ce.minzoom)&&Tt(de.maxzoom,Ce.maxzoom)||Nt(O,{command:"setLayerZoomRange",args:[se,Ce.minzoom,Ce.maxzoom]}),de)Object.prototype.hasOwnProperty.call(de,Se)&&Se!=="layout"&&Se!=="paint"&&Se!=="filter"&&Se!=="metadata"&&Se!=="minzoom"&&Se!=="maxzoom"&&(Se.indexOf("paint.")===0?mi(de[Se],Ce[Se],O,se,Se.slice(6),"setPaintProperty"):Tt(de[Se],Ce[Se])||Nt(O,{command:"setLayerProperty",args:[se,Se,Ce[Se]]}));for(Se in Ce)Object.prototype.hasOwnProperty.call(Ce,Se)&&!Object.prototype.hasOwnProperty.call(de,Se)&&Se!=="layout"&&Se!=="paint"&&Se!=="filter"&&Se!=="metadata"&&Se!=="minzoom"&&Se!=="maxzoom"&&(Se.indexOf("paint.")===0?mi(de[Se],Ce[Se],O,se,Se.slice(6),"setPaintProperty"):Tt(de[Se],Ce[Se])||Nt(O,{command:"setLayerProperty",args:[se,Se,Ce[Se]]}))}else Nt(O,{command:"removeLayer",args:[se]}),Ve=Z[Z.lastIndexOf(se)+1],Nt(O,{command:"addLayer",args:[Ce,Ve]})}(w,e.layers,r)}catch(o){console.warn("Unable to compute style diff:",o),r=[{command:"setStyle",args:[e]}]}return r},j.aC=function(i){const e=[],r=i.id;return r===void 0&&e.push({message:`layers.${r}: missing required property "id"`}),i.render===void 0&&e.push({message:`layers.${r}: missing required method "render"`}),i.renderingMode&&i.renderingMode!=="2d"&&i.renderingMode!=="3d"&&e.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),e},j.aD=function i(e,r){if(Array.isArray(e)){if(!Array.isArray(r)||e.length!==r.length)return!1;for(let o=0;o<e.length;o++)if(!i(e[o],r[o]))return!1;return!0}if(typeof e=="object"&&e!==null&&r!==null){if(typeof r!="object"||Object.keys(e).length!==Object.keys(r).length)return!1;for(const o in e)if(!i(e[o],r[o]))return!1;return!0}return e===r},j.aE=Fe,j.aF=Ye,j.aG=class extends Xr{constructor(i,e){super(i,e),this.current=0}set(i){this.current!==i&&(this.current=i,this.gl.uniform1i(this.location,i))}},j.aH=Un,j.aI=class extends Xr{constructor(i,e){super(i,e),this.current=ka}set(i){if(i[12]!==this.current[12]||i[0]!==this.current[0])return this.current=i,void this.gl.uniformMatrix4fv(this.location,!1,i);for(let e=1;e<16;e++)if(i[e]!==this.current[e]){this.current=i,this.gl.uniformMatrix4fv(this.location,!1,i);break}}},j.aJ=Ts,j.aK=class extends Xr{constructor(i,e){super(i,e),this.current=[0,0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]&&i[2]===this.current[2]||(this.current=i,this.gl.uniform3f(this.location,i[0],i[1],i[2]))}},j.aL=class extends Xr{constructor(i,e){super(i,e),this.current=[0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]||(this.current=i,this.gl.uniform2f(this.location,i[0],i[1]))}},j.aM=eo,j.aN=function(i,e,r,o,f,w,C){var I=1/(e-r),O=1/(o-f),z=1/(w-C);return i[0]=-2*I,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*O,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*z,i[11]=0,i[12]=(e+r)*I,i[13]=(f+o)*O,i[14]=(C+w)*z,i[15]=1,i},j.aO=Vi,j.aP=Qd,j.aQ=class extends tl{},j.aR=$f,j.aS=class extends il{},j.aT=function(i){return i<=1?1:Math.pow(2,Math.ceil(Math.log(i)/Math.LN2))},j.aU=Kh,j.aV=G,j.aW=class extends zl{},j.aX=rt,j.aY=function(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]&&i[3]===e[3]&&i[4]===e[4]&&i[5]===e[5]&&i[6]===e[6]&&i[7]===e[7]&&i[8]===e[8]&&i[9]===e[9]&&i[10]===e[10]&&i[11]===e[11]&&i[12]===e[12]&&i[13]===e[13]&&i[14]===e[14]&&i[15]===e[15]},j.aZ=function(i,e){var r=i[0],o=i[1],f=i[2],w=i[3],C=i[4],I=i[5],O=i[6],z=i[7],B=i[8],N=i[9],W=i[10],Z=i[11],J=i[12],se=i[13],de=i[14],Ce=i[15],Ve=e[0],Se=e[1],De=e[2],ht=e[3],gt=e[4],$t=e[5],ei=e[6],Xt=e[7],Ut=e[8],Lt=e[9],Kt=e[10],jt=e[11],St=e[12],ci=e[13],ni=e[14],ki=e[15];return Math.abs(r-Ve)<=kn*Math.max(1,Math.abs(r),Math.abs(Ve))&&Math.abs(o-Se)<=kn*Math.max(1,Math.abs(o),Math.abs(Se))&&Math.abs(f-De)<=kn*Math.max(1,Math.abs(f),Math.abs(De))&&Math.abs(w-ht)<=kn*Math.max(1,Math.abs(w),Math.abs(ht))&&Math.abs(C-gt)<=kn*Math.max(1,Math.abs(C),Math.abs(gt))&&Math.abs(I-$t)<=kn*Math.max(1,Math.abs(I),Math.abs($t))&&Math.abs(O-ei)<=kn*Math.max(1,Math.abs(O),Math.abs(ei))&&Math.abs(z-Xt)<=kn*Math.max(1,Math.abs(z),Math.abs(Xt))&&Math.abs(B-Ut)<=kn*Math.max(1,Math.abs(B),Math.abs(Ut))&&Math.abs(N-Lt)<=kn*Math.max(1,Math.abs(N),Math.abs(Lt))&&Math.abs(W-Kt)<=kn*Math.max(1,Math.abs(W),Math.abs(Kt))&&Math.abs(Z-jt)<=kn*Math.max(1,Math.abs(Z),Math.abs(jt))&&Math.abs(J-St)<=kn*Math.max(1,Math.abs(J),Math.abs(St))&&Math.abs(se-ci)<=kn*Math.max(1,Math.abs(se),Math.abs(ci))&&Math.abs(de-ni)<=kn*Math.max(1,Math.abs(de),Math.abs(ni))&&Math.abs(Ce-ki)<=kn*Math.max(1,Math.abs(Ce),Math.abs(ki))},j.a_=function(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i},j.aa=function(i){const e={};if(i.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,o,f,w)=>{const C=f||w;return e[o]=!C||C.toLowerCase(),""}),e["max-age"]){const r=parseInt(e["max-age"],10);isNaN(r)?delete e["max-age"]:e["max-age"]=r}return e},j.ab=function(i,e){const r=[];for(const o in i)o in e||r.push(o);return r},j.ac=V,j.ad=function(i,e,r){var o=Math.sin(r),f=Math.cos(r),w=e[0],C=e[1],I=e[2],O=e[3],z=e[4],B=e[5],N=e[6],W=e[7];return e!==i&&(i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=w*f+z*o,i[1]=C*f+B*o,i[2]=I*f+N*o,i[3]=O*f+W*o,i[4]=z*f-w*o,i[5]=B*f-C*o,i[6]=N*f-I*o,i[7]=W*f-O*o,i},j.ae=function(i){var e=new cl(16);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],e},j.af=_c,j.ag=function(i,e){let r=0,o=0;if(i.kind==="constant")o=i.layoutSize;else if(i.kind!=="source"){const{interpolationType:f,minZoom:w,maxZoom:C}=i,I=f?V(Vr.interpolationFactor(f,e,w,C),0,1):0;i.kind==="camera"?o=Qr.number(i.minSize,i.maxSize,I):r=I}return{uSizeT:r,uSize:o}},j.ai=function(i,{uSize:e,uSizeT:r},{lowerSize:o,upperSize:f}){return i.kind==="source"?o/ro:i.kind==="composite"?Qr.number(o/ro,f/ro,r):e},j.aj=dh,j.ak=function(i,e,r,o){const f=e.y-i.y,w=e.x-i.x,C=o.y-r.y,I=o.x-r.x,O=C*w-I*f;if(O===0)return null;const z=(I*(i.y-r.y)-C*(i.x-r.x))/O;return new a(i.x+z*w,i.y+z*f)},j.al=Ju,j.am=Rl,j.an=Wc,j.ao=qr,j.aq=uh,j.ar=function(i,e){var r=e[0],o=e[1],f=e[2],w=e[3],C=e[4],I=e[5],O=e[6],z=e[7],B=e[8],N=e[9],W=e[10],Z=e[11],J=e[12],se=e[13],de=e[14],Ce=e[15],Ve=r*I-o*C,Se=r*O-f*C,De=r*z-w*C,ht=o*O-f*I,gt=o*z-w*I,$t=f*z-w*O,ei=B*se-N*J,Xt=B*de-W*J,Ut=B*Ce-Z*J,Lt=N*de-W*se,Kt=N*Ce-Z*se,jt=W*Ce-Z*de,St=Ve*jt-Se*Kt+De*Lt+ht*Ut-gt*Xt+$t*ei;return St?(i[0]=(I*jt-O*Kt+z*Lt)*(St=1/St),i[1]=(f*Kt-o*jt-w*Lt)*St,i[2]=(se*$t-de*gt+Ce*ht)*St,i[3]=(W*gt-N*$t-Z*ht)*St,i[4]=(O*Ut-C*jt-z*Xt)*St,i[5]=(r*jt-f*Ut+w*Xt)*St,i[6]=(de*De-J*$t-Ce*Se)*St,i[7]=(B*$t-W*De+Z*Se)*St,i[8]=(C*Kt-I*Ut+z*ei)*St,i[9]=(o*Ut-r*Kt-w*ei)*St,i[10]=(J*gt-se*De+Ce*Ve)*St,i[11]=(N*De-B*gt-Z*Ve)*St,i[12]=(I*Xt-C*Lt-O*ei)*St,i[13]=(r*Lt-o*Xt+f*ei)*St,i[14]=(se*Se-J*ht-de*Ve)*St,i[15]=(B*ht-N*Se+W*Ve)*St,i):null},j.as=xh,j.at=hh,j.au=bh,j.av=function(){const i={},e=le.$version;for(const r in le.$root){const o=le.$root[r];if(o.required){let f=null;f=r==="version"?e:o.type==="array"?[]:{},f!=null&&(i[r]=f)}}return i},j.aw=wa,j.ax=He,j.ay=function(i){i=i.slice();const e=Object.create(null);for(let r=0;r<i.length;r++)e[i[r].id]=i[r];for(let r=0;r<i.length;r++)"ref"in i[r]&&(i[r]=Pt(i[r],e[i[r].ref]));return i},j.az=function(i){if(i.type==="custom")return new vp(i);switch(i.type){case"background":return new gp(i);case"circle":return new ef(i);case"fill":return new bf(i);case"fill-extrusion":return new Ff(i);case"heatmap":return new rf(i);case"hillshade":return new sf(i);case"line":return new Hf(i);case"raster":return new yp(i);case"symbol":return new Ic(i)}},j.b=bt,j.b0=function(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]+i[3]*e[3]},j.b1=X,j.b2=Wu,j.b3=Gu,j.b4=function(i,e,r,o,f){var w,C=1/Math.tan(e/2);return i[0]=C/r,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=C,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,f!=null&&f!==1/0?(i[10]=(f+o)*(w=1/(o-f)),i[14]=2*f*o*w):(i[10]=-1,i[14]=-2*o),i},j.b5=function(i,e,r){var o=Math.sin(r),f=Math.cos(r),w=e[4],C=e[5],I=e[6],O=e[7],z=e[8],B=e[9],N=e[10],W=e[11];return e!==i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[4]=w*f+z*o,i[5]=C*f+B*o,i[6]=I*f+N*o,i[7]=O*f+W*o,i[8]=z*f-w*o,i[9]=B*f-C*o,i[10]=N*f-I*o,i[11]=W*f-O*o,i},j.b6=A,j.b7=D,j.b8=function(i){return i*Math.PI/180},j.b9=function(i,e){return i[0]=e[0],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e[1],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=e[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},j.bA=Qs,j.ba=class extends js{},j.bb=gh,j.bc=Mp,j.be=et,j.bf=function(i,e){te.REGISTERED_PROTOCOLS[i]=e},j.bg=function(i){delete te.REGISTERED_PROTOCOLS[i]},j.bh=function(i,e){const r={};for(let f=0;f<i.length;f++){const w=e&&e[i[f].id]||va(i[f]);e&&(e[i[f].id]=w);let C=r[w];C||(C=r[w]=[]),C.push(i[f])}const o=[];for(const f in r)o.push(r[f]);return o},j.bi=qt,j.bj=qu,j.bk=Yu,j.bl=Iu,j.bm=function(i){i.bucket.createArrays(),i.bucket.tilePixelRatio=Mr/(512*i.bucket.overscaling),i.bucket.compareText={},i.bucket.iconsNeedLinear=!1;const e=i.bucket.layers[0],r=e.layout,o=e._unevaluatedLayout._values,f={layoutIconSize:o["icon-size"].possiblyEvaluate(new fr(i.bucket.zoom+1),i.canonical),layoutTextSize:o["text-size"].possiblyEvaluate(new fr(i.bucket.zoom+1),i.canonical),textMaxSize:o["text-size"].possiblyEvaluate(new fr(18))};if(i.bucket.textSizeData.kind==="composite"){const{minZoom:z,maxZoom:B}=i.bucket.textSizeData;f.compositeTextSizes=[o["text-size"].possiblyEvaluate(new fr(z),i.canonical),o["text-size"].possiblyEvaluate(new fr(B),i.canonical)]}if(i.bucket.iconSizeData.kind==="composite"){const{minZoom:z,maxZoom:B}=i.bucket.iconSizeData;f.compositeIconSizes=[o["icon-size"].possiblyEvaluate(new fr(z),i.canonical),o["icon-size"].possiblyEvaluate(new fr(B),i.canonical)]}const w=r.get("text-line-height")*qr,C=r.get("text-rotation-alignment")!=="viewport"&&r.get("symbol-placement")!=="point",I=r.get("text-keep-upright"),O=r.get("text-size");for(const z of i.bucket.features){const B=r.get("text-font").evaluate(z,{},i.canonical).join(","),N=O.evaluate(z,{},i.canonical),W=f.layoutTextSize.evaluate(z,{},i.canonical),Z=f.layoutIconSize.evaluate(z,{},i.canonical),J={horizontal:{},vertical:void 0},se=z.text;let de,Ce=[0,0];if(se){const De=se.toString(),ht=r.get("text-letter-spacing").evaluate(z,{},i.canonical)*qr,gt=yo(De)?ht:0,$t=r.get("text-anchor").evaluate(z,{},i.canonical),ei=ad(e,z,i.canonical);if(!ei){const jt=r.get("text-radial-offset").evaluate(z,{},i.canonical);Ce=jt?od($t,[jt*qr,vh]):r.get("text-offset").evaluate(z,{},i.canonical).map(St=>St*qr)}let Xt=C?"center":r.get("text-justify").evaluate(z,{},i.canonical);const Ut=r.get("symbol-placement"),Lt=Ut==="point"?r.get("text-max-width").evaluate(z,{},i.canonical)*qr:0,Kt=()=>{i.bucket.allowVerticalPlacement&&Ss(De)&&(J.vertical=Sc(se,i.glyphMap,i.glyphPositions,i.imagePositions,B,Lt,w,$t,"left",gt,Ce,j.ah.vertical,!0,Ut,W,N))};if(!C&&ei){const jt=new Set;if(Xt==="auto")for(let ci=0;ci<ei.values.length;ci+=2)jt.add(xh(ei.values[ci]));else jt.add(Xt);let St=!1;for(const ci of jt)if(!J.horizontal[ci])if(St)J.horizontal[ci]=J.horizontal[0];else{const ni=Sc(se,i.glyphMap,i.glyphPositions,i.imagePositions,B,Lt,w,"center",ci,gt,Ce,j.ah.horizontal,!1,Ut,W,N);ni&&(J.horizontal[ci]=ni,St=ni.positionedLines.length===1)}Kt()}else{Xt==="auto"&&(Xt=xh($t));const jt=Sc(se,i.glyphMap,i.glyphPositions,i.imagePositions,B,Lt,w,$t,Xt,gt,Ce,j.ah.horizontal,!1,Ut,W,N);jt&&(J.horizontal[Xt]=jt),Kt(),Ss(De)&&C&&I&&(J.vertical=Sc(se,i.glyphMap,i.glyphPositions,i.imagePositions,B,Lt,w,$t,Xt,gt,Ce,j.ah.vertical,!1,Ut,W,N))}}let Ve=!1;if(z.icon&&z.icon.name){const De=i.imageMap[z.icon.name];De&&(de=up(i.imagePositions[z.icon.name],r.get("icon-offset").evaluate(z,{},i.canonical),r.get("icon-anchor").evaluate(z,{},i.canonical)),Ve=!!De.sdf,i.bucket.sdfIcons===void 0?i.bucket.sdfIcons=Ve:i.bucket.sdfIcons!==Ve&&ct("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(De.pixelRatio!==i.bucket.pixelRatio||r.get("icon-rotate").constantOr(1)!==0)&&(i.bucket.iconsNeedLinear=!0))}const Se=cd(J.horizontal)||J.vertical;i.bucket.iconsInText=!!Se&&Se.iconsInText,(Se||de)&&Pp(i.bucket,z,J,de,i.imageMap,f,W,Z,Ce,Ve,i.canonical)}i.showCollisionBoxes&&i.bucket.generateCollisionDebugBuffers()},j.bn=nh,j.bo=th,j.bp=rh,j.bq=Jo,j.br=oh,j.bs=class{constructor(i){this._marks={start:[i.url,"start"].join("#"),end:[i.url,"end"].join("#"),measure:i.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let i=performance.getEntriesByName(this._marks.measure);return i.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),i=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),i}},j.bt=function(i,e,r,o,f){return s(this,void 0,void 0,function*(){if(T())try{return yield be(i,e,r,o,f)}catch{}return function(w,C,I,O,z){const B=w.width,N=w.height;me&&ge||(me=new OffscreenCanvas(B,N),ge=me.getContext("2d",{willReadFrequently:!0})),me.width=B,me.height=N,ge.drawImage(w,0,0,B,N);const W=ge.getImageData(C,I,O,z);return ge.clearRect(0,0,B,N),W.data}(i,e,r,o,f)})},j.bu=Xu,j.bv=p,j.bw=b,j.bx=yu,j.by=Zn,j.bz=function(i){return i.message===je},j.c=_e,j.d=i=>s(void 0,void 0,void 0,function*(){if(i.byteLength===0)return createImageBitmap(new ImageData(1,1));const e=new Blob([new Uint8Array(i)],{type:"image/png"});try{return createImageBitmap(e)}catch(r){throw new Error(`Could not load image because of ${r.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}}),j.e=ie,j.f=i=>new Promise((e,r)=>{const o=new Image;o.onload=()=>{e(o),URL.revokeObjectURL(o.src),o.onload=null,window.requestAnimationFrame(()=>{o.src=ee})},o.onerror=()=>r(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const f=new Blob([new Uint8Array(i)],{type:"image/png"});o.src=i.byteLength?URL.createObjectURL(f):ee}),j.g=Pe,j.h=(i,e)=>Ge(ie(i,{type:"json"}),e),j.i=Mt,j.j=ot,j.k=Oe,j.l=(i,e)=>Ge(ie(i,{type:"arrayBuffer"}),e),j.m=Ge,j.n=function(i){return new oh(i).readFields(sp,[])},j.o=Gl,j.p=Eu,j.q=Mn,j.r=Zo,j.s=_t,j.t=Gr,j.u=Vt,j.v=le,j.w=ct,j.x=Bi,j.y=function([i,e,r]){return e+=90,e*=Math.PI/180,r*=Math.PI/180,{x:i*Math.cos(e)*Math.sin(r),y:i*Math.sin(e)*Math.sin(r),z:i*Math.cos(r)}},j.z=Qr}),ue("worker",["./shared"],function(j){class s{constructor(H){this.keyCache={},H&&this.replace(H)}replace(H){this._layerConfigs={},this._layers={},this.update(H,[])}update(H,q){for(const oe of H){this._layerConfigs[oe.id]=oe;const Ae=this._layers[oe.id]=j.az(oe);Ae._featureFilter=j.a6(Ae.filter),this.keyCache[oe.id]&&delete this.keyCache[oe.id]}for(const oe of q)delete this.keyCache[oe],delete this._layerConfigs[oe],delete this._layers[oe];this.familiesBySource={};const Q=j.bh(Object.values(this._layerConfigs),this.keyCache);for(const oe of Q){const Ae=oe.map(Qe=>this._layers[Qe.id]),ke=Ae[0];if(ke.visibility==="none")continue;const Le=ke.source||"";let we=this.familiesBySource[Le];we||(we=this.familiesBySource[Le]={});const Ue=ke.sourceLayer||"_geojsonTileLayer";let pt=we[Ue];pt||(pt=we[Ue]=[]),pt.push(Ae)}}}class p{constructor(H){const q={},Q=[];for(const Le in H){const we=H[Le],Ue=q[Le]={};for(const pt in we){const Qe=we[+pt];if(!Qe||Qe.bitmap.width===0||Qe.bitmap.height===0)continue;const at={x:0,y:0,w:Qe.bitmap.width+2,h:Qe.bitmap.height+2};Q.push(at),Ue[pt]={rect:at,metrics:Qe.metrics}}}const{w:oe,h:Ae}=j.p(Q),ke=new j.o({width:oe||1,height:Ae||1});for(const Le in H){const we=H[Le];for(const Ue in we){const pt=we[+Ue];if(!pt||pt.bitmap.width===0||pt.bitmap.height===0)continue;const Qe=q[Le][Ue].rect;j.o.copy(pt.bitmap,ke,{x:0,y:0},{x:Qe.x+1,y:Qe.y+1},pt.bitmap)}}this.image=ke,this.positions=q}}j.bi("GlyphAtlas",p);class b{constructor(H){this.tileID=new j.Q(H.tileID.overscaledZ,H.tileID.wrap,H.tileID.canonical.z,H.tileID.canonical.x,H.tileID.canonical.y),this.uid=H.uid,this.zoom=H.zoom,this.pixelRatio=H.pixelRatio,this.tileSize=H.tileSize,this.source=H.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=H.showCollisionBoxes,this.collectResourceTiming=!!H.collectResourceTiming,this.returnDependencies=!!H.returnDependencies,this.promoteId=H.promoteId,this.inFlightDependencies=[]}parse(H,q,Q,oe){return j._(this,void 0,void 0,function*(){this.status="parsing",this.data=H,this.collisionBoxArray=new j.a4;const Ae=new j.bj(Object.keys(H.layers).sort()),ke=new j.bk(this.tileID,this.promoteId);ke.bucketLayerIDs=[];const Le={},we={featureIndex:ke,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:Q},Ue=q.familiesBySource[this.source];for(const li in Ue){const ur=H.layers[li];if(!ur)continue;ur.version===1&&j.w(`Vector tile source "${this.source}" layer "${li}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const kr=Ae.encode(li),rn=[];for(let nn=0;nn<ur.length;nn++){const zr=ur.feature(nn),Tn=ke.getId(zr,li);rn.push({feature:zr,id:Tn,index:nn,sourceLayerIndex:kr})}for(const nn of Ue[li]){const zr=nn[0];zr.source!==this.source&&j.w(`layer.source = ${zr.source} does not equal this.source = ${this.source}`),zr.minzoom&&this.zoom<Math.floor(zr.minzoom)||zr.maxzoom&&this.zoom>=zr.maxzoom||zr.visibility!=="none"&&(v(nn,this.zoom,Q),(Le[zr.id]=zr.createBucket({index:ke.bucketLayerIDs.length,layers:nn,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:kr,sourceID:this.source})).populate(rn,we,this.tileID.canonical),ke.bucketLayerIDs.push(nn.map(Tn=>Tn.id)))}}const pt=j.aE(we.glyphDependencies,li=>Object.keys(li).map(Number));this.inFlightDependencies.forEach(li=>li==null?void 0:li.abort()),this.inFlightDependencies=[];let Qe=Promise.resolve({});if(Object.keys(pt).length){const li=new AbortController;this.inFlightDependencies.push(li),Qe=oe.sendAsync({type:"GG",data:{stacks:pt,source:this.source,tileID:this.tileID,type:"glyphs"}},li)}const at=Object.keys(we.iconDependencies);let Jt=Promise.resolve({});if(at.length){const li=new AbortController;this.inFlightDependencies.push(li),Jt=oe.sendAsync({type:"GI",data:{icons:at,source:this.source,tileID:this.tileID,type:"icons"}},li)}const ri=Object.keys(we.patternDependencies);let ui=Promise.resolve({});if(ri.length){const li=new AbortController;this.inFlightDependencies.push(li),ui=oe.sendAsync({type:"GI",data:{icons:ri,source:this.source,tileID:this.tileID,type:"patterns"}},li)}const[pi,wi,Ri]=yield Promise.all([Qe,Jt,ui]),nr=new p(pi),Pr=new j.bl(wi,Ri);for(const li in Le){const ur=Le[li];ur instanceof j.a5?(v(ur.layers,this.zoom,Q),j.bm({bucket:ur,glyphMap:pi,glyphPositions:nr.positions,imageMap:wi,imagePositions:Pr.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical})):ur.hasPattern&&(ur instanceof j.bn||ur instanceof j.bo||ur instanceof j.bp)&&(v(ur.layers,this.zoom,Q),ur.addFeatures(we,this.tileID.canonical,Pr.patternPositions))}return this.status="done",{buckets:Object.values(Le).filter(li=>!li.isEmpty()),featureIndex:ke,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:nr.image,imageAtlas:Pr,glyphMap:this.returnDependencies?pi:null,iconMap:this.returnDependencies?wi:null,glyphPositions:this.returnDependencies?nr.positions:null}})}}function v(ae,H,q){const Q=new j.a8(H);for(const oe of ae)oe.recalculate(Q,q)}class a{constructor(H,q,Q){this.actor=H,this.layerIndex=q,this.availableImages=Q,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(H,q){return j._(this,void 0,void 0,function*(){const Q=yield j.l(H.request,q);try{return{vectorTile:new j.bq.VectorTile(new j.br(Q.data)),rawData:Q.data,cacheControl:Q.cacheControl,expires:Q.expires}}catch(oe){const Ae=new Uint8Array(Q.data);let ke=`Unable to parse the tile at ${H.request.url}, `;throw ke+=Ae[0]===31&&Ae[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${oe.messge}`,new Error(ke)}})}loadTile(H){return j._(this,void 0,void 0,function*(){const q=H.uid,Q=!!(H&&H.request&&H.request.collectResourceTiming)&&new j.bs(H.request),oe=new b(H);this.loading[q]=oe;const Ae=new AbortController;oe.abort=Ae;try{const ke=yield this.loadVectorTile(H,Ae);if(delete this.loading[q],!ke)return null;const Le=ke.rawData,we={};ke.expires&&(we.expires=ke.expires),ke.cacheControl&&(we.cacheControl=ke.cacheControl);const Ue={};if(Q){const Qe=Q.finish();Qe&&(Ue.resourceTiming=JSON.parse(JSON.stringify(Qe)))}oe.vectorTile=ke.vectorTile;const pt=oe.parse(ke.vectorTile,this.layerIndex,this.availableImages,this.actor);this.loaded[q]=oe,this.fetching[q]={rawTileData:Le,cacheControl:we,resourceTiming:Ue};try{const Qe=yield pt;return j.e({rawTileData:Le.slice(0)},Qe,we,Ue)}finally{delete this.fetching[q]}}catch(ke){throw delete this.loading[q],oe.status="done",this.loaded[q]=oe,ke}})}reloadTile(H){return j._(this,void 0,void 0,function*(){const q=H.uid;if(!this.loaded||!this.loaded[q])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const Q=this.loaded[q];if(Q.showCollisionBoxes=H.showCollisionBoxes,Q.status==="parsing"){const oe=yield Q.parse(Q.vectorTile,this.layerIndex,this.availableImages,this.actor);let Ae;if(this.fetching[q]){const{rawTileData:ke,cacheControl:Le,resourceTiming:we}=this.fetching[q];delete this.fetching[q],Ae=j.e({rawTileData:ke.slice(0)},oe,Le,we)}else Ae=oe;return Ae}if(Q.status==="done"&&Q.vectorTile)return Q.parse(Q.vectorTile,this.layerIndex,this.availableImages,this.actor)})}abortTile(H){return j._(this,void 0,void 0,function*(){const q=this.loading,Q=H.uid;q&&q[Q]&&q[Q].abort&&(q[Q].abort.abort(),delete q[Q])})}removeTile(H){return j._(this,void 0,void 0,function*(){this.loaded&&this.loaded[H.uid]&&delete this.loaded[H.uid]})}}class l{constructor(){this.loaded={}}loadTile(H){return j._(this,void 0,void 0,function*(){const{uid:q,encoding:Q,rawImageData:oe,redFactor:Ae,greenFactor:ke,blueFactor:Le,baseShift:we}=H,Ue=oe.width+2,pt=oe.height+2,Qe=j.b(oe)?new j.R({width:Ue,height:pt},yield j.bt(oe,-1,-1,Ue,pt)):oe,at=new j.bu(q,Qe,Q,Ae,ke,Le,we);return this.loaded=this.loaded||{},this.loaded[q]=at,at})}removeTile(H){const q=this.loaded,Q=H.uid;q&&q[Q]&&delete q[Q]}}function h(ae,H){if(ae.length!==0){m(ae[0],H);for(var q=1;q<ae.length;q++)m(ae[q],!H)}}function m(ae,H){for(var q=0,Q=0,oe=0,Ae=ae.length,ke=Ae-1;oe<Ae;ke=oe++){var Le=(ae[oe][0]-ae[ke][0])*(ae[ke][1]+ae[oe][1]),we=q+Le;Q+=Math.abs(q)>=Math.abs(Le)?q-we+Le:Le-we+q,q=we}q+Q>=0!=!!H&&ae.reverse()}var _=j.bv(function ae(H,q){var Q,oe=H&&H.type;if(oe==="FeatureCollection")for(Q=0;Q<H.features.length;Q++)ae(H.features[Q],q);else if(oe==="GeometryCollection")for(Q=0;Q<H.geometries.length;Q++)ae(H.geometries[Q],q);else if(oe==="Feature")ae(H.geometry,q);else if(oe==="Polygon")h(H.coordinates,q);else if(oe==="MultiPolygon")for(Q=0;Q<H.coordinates.length;Q++)h(H.coordinates[Q],q);return H});const u=j.bq.VectorTileFeature.prototype.toGeoJSON;var x={exports:{}},T=j.bw,A=j.bq.VectorTileFeature,D=V;function V(ae,H){this.options=H||{},this.features=ae,this.length=ae.length}function X(ae,H){this.id=typeof ae.id=="number"?ae.id:void 0,this.type=ae.type,this.rawGeometry=ae.type===1?[ae.geometry]:ae.geometry,this.properties=ae.tags,this.extent=H||4096}V.prototype.feature=function(ae){return new X(this.features[ae],this.options.extent)},X.prototype.loadGeometry=function(){var ae=this.rawGeometry;this.geometry=[];for(var H=0;H<ae.length;H++){for(var q=ae[H],Q=[],oe=0;oe<q.length;oe++)Q.push(new T(q[oe][0],q[oe][1]));this.geometry.push(Q)}return this.geometry},X.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var ae=this.geometry,H=1/0,q=-1/0,Q=1/0,oe=-1/0,Ae=0;Ae<ae.length;Ae++)for(var ke=ae[Ae],Le=0;Le<ke.length;Le++){var we=ke[Le];H=Math.min(H,we.x),q=Math.max(q,we.x),Q=Math.min(Q,we.y),oe=Math.max(oe,we.y)}return[H,Q,q,oe]},X.prototype.toGeoJSON=A.prototype.toGeoJSON;var ie=j.bx,ve=D;function Fe(ae){var H=new ie;return function(q,Q){for(var oe in q.layers)Q.writeMessage(3,Ye,q.layers[oe])}(ae,H),H.finish()}function Ye(ae,H){var q;H.writeVarintField(15,ae.version||1),H.writeStringField(1,ae.name||""),H.writeVarintField(5,ae.extent||4096);var Q={keys:[],values:[],keycache:{},valuecache:{}};for(q=0;q<ae.length;q++)Q.feature=ae.feature(q),H.writeMessage(2,Ze,Q);var oe=Q.keys;for(q=0;q<oe.length;q++)H.writeStringField(3,oe[q]);var Ae=Q.values;for(q=0;q<Ae.length;q++)H.writeMessage(4,Mt,Ae[q])}function Ze(ae,H){var q=ae.feature;q.id!==void 0&&H.writeVarintField(1,q.id),H.writeMessage(2,Je,ae),H.writeVarintField(3,q.type),H.writeMessage(4,vt,q)}function Je(ae,H){var q=ae.feature,Q=ae.keys,oe=ae.values,Ae=ae.keycache,ke=ae.valuecache;for(var Le in q.properties){var we=q.properties[Le],Ue=Ae[Le];if(we!==null){Ue===void 0&&(Q.push(Le),Ae[Le]=Ue=Q.length-1),H.writeVarint(Ue);var pt=typeof we;pt!=="string"&&pt!=="boolean"&&pt!=="number"&&(we=JSON.stringify(we));var Qe=pt+":"+we,at=ke[Qe];at===void 0&&(oe.push(we),ke[Qe]=at=oe.length-1),H.writeVarint(at)}}}function ct(ae,H){return(H<<3)+(7&ae)}function nt(ae){return ae<<1^ae>>31}function vt(ae,H){for(var q=ae.loadGeometry(),Q=ae.type,oe=0,Ae=0,ke=q.length,Le=0;Le<ke;Le++){var we=q[Le],Ue=1;Q===1&&(Ue=we.length),H.writeVarint(ct(1,Ue));for(var pt=Q===3?we.length-1:we.length,Qe=0;Qe<pt;Qe++){Qe===1&&Q!==1&&H.writeVarint(ct(2,pt-1));var at=we[Qe].x-oe,Jt=we[Qe].y-Ae;H.writeVarint(nt(at)),H.writeVarint(nt(Jt)),oe+=at,Ae+=Jt}Q===3&&H.writeVarint(ct(7,1))}}function Mt(ae,H){var q=typeof ae;q==="string"?H.writeStringField(1,ae):q==="boolean"?H.writeBooleanField(7,ae):q==="number"&&(ae%1!=0?H.writeDoubleField(3,ae):ae<0?H.writeSVarintField(6,ae):H.writeVarintField(5,ae))}x.exports=Fe,x.exports.fromVectorTileJs=Fe,x.exports.fromGeojsonVt=function(ae,H){H=H||{};var q={};for(var Q in ae)q[Q]=new ve(ae[Q].features,H),q[Q].name=Q,q[Q].version=H.version,q[Q].extent=H.extent;return Fe({layers:q})},x.exports.GeoJSONWrapper=ve;var st=j.bv(x.exports);const bt={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:ae=>ae},ee=Math.fround||(be=new Float32Array(1),ae=>(be[0]=+ae,be[0]));var be;const me=3,ge=5,je=6;class _e{constructor(H){this.options=Object.assign(Object.create(bt),H),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(H){const{log:q,minZoom:Q,maxZoom:oe}=this.options;q&&console.time("total time");const Ae=`prepare ${H.length} points`;q&&console.time(Ae),this.points=H;const ke=[];for(let we=0;we<H.length;we++){const Ue=H[we];if(!Ue.geometry)continue;const[pt,Qe]=Ue.geometry.coordinates,at=ee(Ne(pt)),Jt=ee(et(Qe));ke.push(at,Jt,1/0,we,-1,1),this.options.reduce&&ke.push(0)}let Le=this.trees[oe+1]=this._createTree(ke);q&&console.timeEnd(Ae);for(let we=oe;we>=Q;we--){const Ue=+Date.now();Le=this.trees[we]=this._createTree(this._cluster(Le,we)),q&&console.log("z%d: %d clusters in %dms",we,Le.numItems,+Date.now()-Ue)}return q&&console.timeEnd("total time"),this}getClusters(H,q){let Q=((H[0]+180)%360+360)%360-180;const oe=Math.max(-90,Math.min(90,H[1]));let Ae=H[2]===180?180:((H[2]+180)%360+360)%360-180;const ke=Math.max(-90,Math.min(90,H[3]));if(H[2]-H[0]>=360)Q=-180,Ae=180;else if(Q>Ae){const Qe=this.getClusters([Q,oe,180,ke],q),at=this.getClusters([-180,oe,Ae,ke],q);return Qe.concat(at)}const Le=this.trees[this._limitZoom(q)],we=Le.range(Ne(Q),et(ke),Ne(Ae),et(oe)),Ue=Le.data,pt=[];for(const Qe of we){const at=this.stride*Qe;pt.push(Ue[at+ge]>1?te(Ue,at,this.clusterProps):this.points[Ue[at+me]])}return pt}getChildren(H){const q=this._getOriginId(H),Q=this._getOriginZoom(H),oe="No cluster with the specified id.",Ae=this.trees[Q];if(!Ae)throw new Error(oe);const ke=Ae.data;if(q*this.stride>=ke.length)throw new Error(oe);const Le=this.options.radius/(this.options.extent*Math.pow(2,Q-1)),we=Ae.within(ke[q*this.stride],ke[q*this.stride+1],Le),Ue=[];for(const pt of we){const Qe=pt*this.stride;ke[Qe+4]===H&&Ue.push(ke[Qe+ge]>1?te(ke,Qe,this.clusterProps):this.points[ke[Qe+me]])}if(Ue.length===0)throw new Error(oe);return Ue}getLeaves(H,q,Q){const oe=[];return this._appendLeaves(oe,H,q=q||10,Q=Q||0,0),oe}getTile(H,q,Q){const oe=this.trees[this._limitZoom(H)],Ae=Math.pow(2,H),{extent:ke,radius:Le}=this.options,we=Le/ke,Ue=(Q-we)/Ae,pt=(Q+1+we)/Ae,Qe={features:[]};return this._addTileFeatures(oe.range((q-we)/Ae,Ue,(q+1+we)/Ae,pt),oe.data,q,Q,Ae,Qe),q===0&&this._addTileFeatures(oe.range(1-we/Ae,Ue,1,pt),oe.data,Ae,Q,Ae,Qe),q===Ae-1&&this._addTileFeatures(oe.range(0,Ue,we/Ae,pt),oe.data,-1,Q,Ae,Qe),Qe.features.length?Qe:null}getClusterExpansionZoom(H){let q=this._getOriginZoom(H)-1;for(;q<=this.options.maxZoom;){const Q=this.getChildren(H);if(q++,Q.length!==1)break;H=Q[0].properties.cluster_id}return q}_appendLeaves(H,q,Q,oe,Ae){const ke=this.getChildren(q);for(const Le of ke){const we=Le.properties;if(we&&we.cluster?Ae+we.point_count<=oe?Ae+=we.point_count:Ae=this._appendLeaves(H,we.cluster_id,Q,oe,Ae):Ae<oe?Ae++:H.push(Le),H.length===Q)break}return Ae}_createTree(H){const q=new j.au(H.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Q=0;Q<H.length;Q+=this.stride)q.add(H[Q],H[Q+1]);return q.finish(),q.data=H,q}_addTileFeatures(H,q,Q,oe,Ae,ke){for(const Le of H){const we=Le*this.stride,Ue=q[we+ge]>1;let pt,Qe,at;if(Ue)pt=Pe(q,we,this.clusterProps),Qe=q[we],at=q[we+1];else{const ui=this.points[q[we+me]];pt=ui.properties;const[pi,wi]=ui.geometry.coordinates;Qe=Ne(pi),at=et(wi)}const Jt={type:1,geometry:[[Math.round(this.options.extent*(Qe*Ae-Q)),Math.round(this.options.extent*(at*Ae-oe))]],tags:pt};let ri;ri=Ue||this.options.generateId?q[we+me]:this.points[q[we+me]].id,ri!==void 0&&(Jt.id=ri),ke.features.push(Jt)}}_limitZoom(H){return Math.max(this.options.minZoom,Math.min(Math.floor(+H),this.options.maxZoom+1))}_cluster(H,q){const{radius:Q,extent:oe,reduce:Ae,minPoints:ke}=this.options,Le=Q/(oe*Math.pow(2,q)),we=H.data,Ue=[],pt=this.stride;for(let Qe=0;Qe<we.length;Qe+=pt){if(we[Qe+2]<=q)continue;we[Qe+2]=q;const at=we[Qe],Jt=we[Qe+1],ri=H.within(we[Qe],we[Qe+1],Le),ui=we[Qe+ge];let pi=ui;for(const wi of ri){const Ri=wi*pt;we[Ri+2]>q&&(pi+=we[Ri+ge])}if(pi>ui&&pi>=ke){let wi,Ri=at*ui,nr=Jt*ui,Pr=-1;const li=((Qe/pt|0)<<5)+(q+1)+this.points.length;for(const ur of ri){const kr=ur*pt;if(we[kr+2]<=q)continue;we[kr+2]=q;const rn=we[kr+ge];Ri+=we[kr]*rn,nr+=we[kr+1]*rn,we[kr+4]=li,Ae&&(wi||(wi=this._map(we,Qe,!0),Pr=this.clusterProps.length,this.clusterProps.push(wi)),Ae(wi,this._map(we,kr)))}we[Qe+4]=li,Ue.push(Ri/pi,nr/pi,1/0,li,-1,pi),Ae&&Ue.push(Pr)}else{for(let wi=0;wi<pt;wi++)Ue.push(we[Qe+wi]);if(pi>1)for(const wi of ri){const Ri=wi*pt;if(!(we[Ri+2]<=q)){we[Ri+2]=q;for(let nr=0;nr<pt;nr++)Ue.push(we[Ri+nr])}}}}return Ue}_getOriginId(H){return H-this.points.length>>5}_getOriginZoom(H){return(H-this.points.length)%32}_map(H,q,Q){if(H[q+ge]>1){const ke=this.clusterProps[H[q+je]];return Q?Object.assign({},ke):ke}const oe=this.points[H[q+me]].properties,Ae=this.options.map(oe);return Q&&Ae===oe?Object.assign({},Ae):Ae}}function te(ae,H,q){return{type:"Feature",id:ae[H+me],properties:Pe(ae,H,q),geometry:{type:"Point",coordinates:[(Q=ae[H],360*(Q-.5)),He(ae[H+1])]}};var Q}function Pe(ae,H,q){const Q=ae[H+ge],oe=Q>=1e4?`${Math.round(Q/1e3)}k`:Q>=1e3?Math.round(Q/100)/10+"k":Q,Ae=ae[H+je],ke=Ae===-1?{}:Object.assign({},q[Ae]);return Object.assign(ke,{cluster:!0,cluster_id:ae[H+me],point_count:Q,point_count_abbreviated:oe})}function Ne(ae){return ae/360+.5}function et(ae){const H=Math.sin(ae*Math.PI/180),q=.5-.25*Math.log((1+H)/(1-H))/Math.PI;return q<0?0:q>1?1:q}function He(ae){const H=(180-360*ae)*Math.PI/180;return 360*Math.atan(Math.exp(H))/Math.PI-90}function Ge(ae,H,q,Q){for(var oe,Ae=Q,ke=q-H>>1,Le=q-H,we=ae[H],Ue=ae[H+1],pt=ae[q],Qe=ae[q+1],at=H+3;at<q;at+=3){var Jt=_t(ae[at],ae[at+1],we,Ue,pt,Qe);if(Jt>Ae)oe=at,Ae=Jt;else if(Jt===Ae){var ri=Math.abs(at-ke);ri<Le&&(oe=at,Le=ri)}}Ae>Q&&(oe-H>3&&Ge(ae,H,oe,Q),ae[oe+2]=Ae,q-oe>3&&Ge(ae,oe,q,Q))}function _t(ae,H,q,Q,oe,Ae){var ke=oe-q,Le=Ae-Q;if(ke!==0||Le!==0){var we=((ae-q)*ke+(H-Q)*Le)/(ke*ke+Le*Le);we>1?(q=oe,Q=Ae):we>0&&(q+=ke*we,Q+=Le*we)}return(ke=ae-q)*ke+(Le=H-Q)*Le}function It(ae,H,q,Q){var oe={id:ae===void 0?null:ae,type:H,geometry:q,tags:Q,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(Ae){var ke=Ae.geometry,Le=Ae.type;if(Le==="Point"||Le==="MultiPoint"||Le==="LineString")Xe(Ae,ke);else if(Le==="Polygon"||Le==="MultiLineString")for(var we=0;we<ke.length;we++)Xe(Ae,ke[we]);else if(Le==="MultiPolygon")for(we=0;we<ke.length;we++)for(var Ue=0;Ue<ke[we].length;Ue++)Xe(Ae,ke[we][Ue])}(oe),oe}function Xe(ae,H){for(var q=0;q<H.length;q+=3)ae.minX=Math.min(ae.minX,H[q]),ae.minY=Math.min(ae.minY,H[q+1]),ae.maxX=Math.max(ae.maxX,H[q]),ae.maxY=Math.max(ae.maxY,H[q+1])}function Oe(ae,H,q,Q){if(H.geometry){var oe=H.geometry.coordinates,Ae=H.geometry.type,ke=Math.pow(q.tolerance/((1<<q.maxZoom)*q.extent),2),Le=[],we=H.id;if(q.promoteId?we=H.properties[q.promoteId]:q.generateId&&(we=Q||0),Ae==="Point")ot(oe,Le);else if(Ae==="MultiPoint")for(var Ue=0;Ue<oe.length;Ue++)ot(oe[Ue],Le);else if(Ae==="LineString")qe(oe,Le,ke,!1);else if(Ae==="MultiLineString"){if(q.lineMetrics){for(Ue=0;Ue<oe.length;Ue++)qe(oe[Ue],Le=[],ke,!1),ae.push(It(we,"LineString",Le,H.properties));return}le(oe,Le,ke,!1)}else if(Ae==="Polygon")le(oe,Le,ke,!0);else{if(Ae!=="MultiPolygon"){if(Ae==="GeometryCollection"){for(Ue=0;Ue<H.geometry.geometries.length;Ue++)Oe(ae,{id:we,geometry:H.geometry.geometries[Ue],properties:H.properties},q,Q);return}throw new Error("Input data is not a valid GeoJSON object.")}for(Ue=0;Ue<oe.length;Ue++){var pt=[];le(oe[Ue],pt,ke,!0),Le.push(pt)}}ae.push(It(we,Ae,Le,H.properties))}}function ot(ae,H){H.push(ft(ae[0])),H.push(Pt(ae[1])),H.push(0)}function qe(ae,H,q,Q){for(var oe,Ae,ke=0,Le=0;Le<ae.length;Le++){var we=ft(ae[Le][0]),Ue=Pt(ae[Le][1]);H.push(we),H.push(Ue),H.push(0),Le>0&&(ke+=Q?(oe*Ue-we*Ae)/2:Math.sqrt(Math.pow(we-oe,2)+Math.pow(Ue-Ae,2))),oe=we,Ae=Ue}var pt=H.length-3;H[2]=1,Ge(H,0,pt,q),H[pt+2]=1,H.size=Math.abs(ke),H.start=0,H.end=H.size}function le(ae,H,q,Q){for(var oe=0;oe<ae.length;oe++){var Ae=[];qe(ae[oe],Ae,q,Q),H.push(Ae)}}function ft(ae){return ae/360+.5}function Pt(ae){var H=Math.sin(ae*Math.PI/180),q=.5-.25*Math.log((1+H)/(1-H))/Math.PI;return q<0?0:q>1?1:q}function Tt(ae,H,q,Q,oe,Ae,ke,Le){if(Q/=H,Ae>=(q/=H)&&ke<Q)return ae;if(ke<q||Ae>=Q)return null;for(var we=[],Ue=0;Ue<ae.length;Ue++){var pt=ae[Ue],Qe=pt.geometry,at=pt.type,Jt=oe===0?pt.minX:pt.minY,ri=oe===0?pt.maxX:pt.maxY;if(Jt>=q&&ri<Q)we.push(pt);else if(!(ri<q||Jt>=Q)){var ui=[];if(at==="Point"||at==="MultiPoint")Nt(Qe,ui,q,Q,oe);else if(at==="LineString")lt(Qe,ui,q,Q,oe,!1,Le.lineMetrics);else if(at==="MultiLineString")Yt(Qe,ui,q,Q,oe,!1);else if(at==="Polygon")Yt(Qe,ui,q,Q,oe,!0);else if(at==="MultiPolygon")for(var pi=0;pi<Qe.length;pi++){var wi=[];Yt(Qe[pi],wi,q,Q,oe,!0),wi.length&&ui.push(wi)}if(ui.length){if(Le.lineMetrics&&at==="LineString"){for(pi=0;pi<ui.length;pi++)we.push(It(pt.id,at,ui[pi],pt.tags));continue}at!=="LineString"&&at!=="MultiLineString"||(ui.length===1?(at="LineString",ui=ui[0]):at="MultiLineString"),at!=="Point"&&at!=="MultiPoint"||(at=ui.length===3?"Point":"MultiPoint"),we.push(It(pt.id,at,ui,pt.tags))}}}return we.length?we:null}function Nt(ae,H,q,Q,oe){for(var Ae=0;Ae<ae.length;Ae+=3){var ke=ae[Ae+oe];ke>=q&&ke<=Q&&(H.push(ae[Ae]),H.push(ae[Ae+1]),H.push(ae[Ae+2]))}}function lt(ae,H,q,Q,oe,Ae,ke){for(var Le,we,Ue=wt(ae),pt=oe===0?mi:yi,Qe=ae.start,at=0;at<ae.length-3;at+=3){var Jt=ae[at],ri=ae[at+1],ui=ae[at+2],pi=ae[at+3],wi=ae[at+4],Ri=oe===0?Jt:ri,nr=oe===0?pi:wi,Pr=!1;ke&&(Le=Math.sqrt(Math.pow(Jt-pi,2)+Math.pow(ri-wi,2))),Ri<q?nr>q&&(we=pt(Ue,Jt,ri,pi,wi,q),ke&&(Ue.start=Qe+Le*we)):Ri>Q?nr<Q&&(we=pt(Ue,Jt,ri,pi,wi,Q),ke&&(Ue.start=Qe+Le*we)):fi(Ue,Jt,ri,ui),nr<q&&Ri>=q&&(we=pt(Ue,Jt,ri,pi,wi,q),Pr=!0),nr>Q&&Ri<=Q&&(we=pt(Ue,Jt,ri,pi,wi,Q),Pr=!0),!Ae&&Pr&&(ke&&(Ue.end=Qe+Le*we),H.push(Ue),Ue=wt(ae)),ke&&(Qe+=Le)}var li=ae.length-3;Jt=ae[li],ri=ae[li+1],ui=ae[li+2],(Ri=oe===0?Jt:ri)>=q&&Ri<=Q&&fi(Ue,Jt,ri,ui),li=Ue.length-3,Ae&&li>=3&&(Ue[li]!==Ue[0]||Ue[li+1]!==Ue[1])&&fi(Ue,Ue[0],Ue[1],Ue[2]),Ue.length&&H.push(Ue)}function wt(ae){var H=[];return H.size=ae.size,H.start=ae.start,H.end=ae.end,H}function Yt(ae,H,q,Q,oe,Ae){for(var ke=0;ke<ae.length;ke++)lt(ae[ke],H,q,Q,oe,Ae,!1)}function fi(ae,H,q,Q){ae.push(H),ae.push(q),ae.push(Q)}function mi(ae,H,q,Q,oe,Ae){var ke=(Ae-H)/(Q-H);return ae.push(Ae),ae.push(q+(oe-q)*ke),ae.push(1),ke}function yi(ae,H,q,Q,oe,Ae){var ke=(Ae-q)/(oe-q);return ae.push(H+(Q-H)*ke),ae.push(Ae),ae.push(1),ke}function bi(ae,H){for(var q=[],Q=0;Q<ae.length;Q++){var oe,Ae=ae[Q],ke=Ae.type;if(ke==="Point"||ke==="MultiPoint"||ke==="LineString")oe=ut(Ae.geometry,H);else if(ke==="MultiLineString"||ke==="Polygon"){oe=[];for(var Le=0;Le<Ae.geometry.length;Le++)oe.push(ut(Ae.geometry[Le],H))}else if(ke==="MultiPolygon")for(oe=[],Le=0;Le<Ae.geometry.length;Le++){for(var we=[],Ue=0;Ue<Ae.geometry[Le].length;Ue++)we.push(ut(Ae.geometry[Le][Ue],H));oe.push(we)}q.push(It(Ae.id,ke,oe,Ae.tags))}return q}function ut(ae,H){var q=[];q.size=ae.size,ae.start!==void 0&&(q.start=ae.start,q.end=ae.end);for(var Q=0;Q<ae.length;Q+=3)q.push(ae[Q]+H,ae[Q+1],ae[Q+2]);return q}function Gi(ae,H){if(ae.transformed)return ae;var q,Q,oe,Ae=1<<ae.z,ke=ae.x,Le=ae.y;for(q=0;q<ae.features.length;q++){var we=ae.features[q],Ue=we.geometry,pt=we.type;if(we.geometry=[],pt===1)for(Q=0;Q<Ue.length;Q+=2)we.geometry.push(Xi(Ue[Q],Ue[Q+1],H,Ae,ke,Le));else for(Q=0;Q<Ue.length;Q++){var Qe=[];for(oe=0;oe<Ue[Q].length;oe+=2)Qe.push(Xi(Ue[Q][oe],Ue[Q][oe+1],H,Ae,ke,Le));we.geometry.push(Qe)}}return ae.transformed=!0,ae}function Xi(ae,H,q,Q,oe,Ae){return[Math.round(q*(ae*Q-oe)),Math.round(q*(H*Q-Ae))]}function rr(ae,H,q,Q,oe){for(var Ae=H===oe.maxZoom?0:oe.tolerance/((1<<H)*oe.extent),ke={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:q,y:Q,z:H,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},Le=0;Le<ae.length;Le++){ke.numFeatures++,Qi(ke,ae[Le],Ae,oe);var we=ae[Le].minX,Ue=ae[Le].minY,pt=ae[Le].maxX,Qe=ae[Le].maxY;we<ke.minX&&(ke.minX=we),Ue<ke.minY&&(ke.minY=Ue),pt>ke.maxX&&(ke.maxX=pt),Qe>ke.maxY&&(ke.maxY=Qe)}return ke}function Qi(ae,H,q,Q){var oe=H.geometry,Ae=H.type,ke=[];if(Ae==="Point"||Ae==="MultiPoint")for(var Le=0;Le<oe.length;Le+=3)ke.push(oe[Le]),ke.push(oe[Le+1]),ae.numPoints++,ae.numSimplified++;else if(Ae==="LineString")Et(ke,oe,ae,q,!1,!1);else if(Ae==="MultiLineString"||Ae==="Polygon")for(Le=0;Le<oe.length;Le++)Et(ke,oe[Le],ae,q,Ae==="Polygon",Le===0);else if(Ae==="MultiPolygon")for(var we=0;we<oe.length;we++){var Ue=oe[we];for(Le=0;Le<Ue.length;Le++)Et(ke,Ue[Le],ae,q,!0,Le===0)}if(ke.length){var pt=H.tags||null;if(Ae==="LineString"&&Q.lineMetrics){for(var Qe in pt={},H.tags)pt[Qe]=H.tags[Qe];pt.mapbox_clip_start=oe.start/oe.size,pt.mapbox_clip_end=oe.end/oe.size}var at={geometry:ke,type:Ae==="Polygon"||Ae==="MultiPolygon"?3:Ae==="LineString"||Ae==="MultiLineString"?2:1,tags:pt};H.id!==null&&(at.id=H.id),ae.features.push(at)}}function Et(ae,H,q,Q,oe,Ae){var ke=Q*Q;if(Q>0&&H.size<(oe?ke:Q))q.numPoints+=H.length/3;else{for(var Le=[],we=0;we<H.length;we+=3)(Q===0||H[we+2]>ke)&&(q.numSimplified++,Le.push(H[we]),Le.push(H[we+1])),q.numPoints++;oe&&function(Ue,pt){for(var Qe=0,at=0,Jt=Ue.length,ri=Jt-2;at<Jt;ri=at,at+=2)Qe+=(Ue[at]-Ue[ri])*(Ue[at+1]+Ue[ri+1]);if(Qe>0===pt)for(at=0,Jt=Ue.length;at<Jt/2;at+=2){var ui=Ue[at],pi=Ue[at+1];Ue[at]=Ue[Jt-2-at],Ue[at+1]=Ue[Jt-1-at],Ue[Jt-2-at]=ui,Ue[Jt-1-at]=pi}}(Le,Ae),ae.push(Le)}}function ii(ae,H){var q=(H=this.options=function(oe,Ae){for(var ke in Ae)oe[ke]=Ae[ke];return oe}(Object.create(this.options),H)).debug;if(q&&console.time("preprocess data"),H.maxZoom<0||H.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(H.promoteId&&H.generateId)throw new Error("promoteId and generateId cannot be used together.");var Q=function(oe,Ae){var ke=[];if(oe.type==="FeatureCollection")for(var Le=0;Le<oe.features.length;Le++)Oe(ke,oe.features[Le],Ae,Le);else Oe(ke,oe.type==="Feature"?oe:{geometry:oe},Ae);return ke}(ae,H);this.tiles={},this.tileCoords=[],q&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",H.indexMaxZoom,H.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Q=function(oe,Ae){var ke=Ae.buffer/Ae.extent,Le=oe,we=Tt(oe,1,-1-ke,ke,0,-1,2,Ae),Ue=Tt(oe,1,1-ke,2+ke,0,-1,2,Ae);return(we||Ue)&&(Le=Tt(oe,1,-ke,1+ke,0,-1,2,Ae)||[],we&&(Le=bi(we,1).concat(Le)),Ue&&(Le=Le.concat(bi(Ue,-1)))),Le}(Q,H),Q.length&&this.splitTile(Q,0,0,0),q&&(Q.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function ai(ae,H,q){return 32*((1<<ae)*q+H)+ae}function Hi(ae,H){return H?ae.properties[H]:ae.id}function qi(ae,H){if(ae==null)return!0;if(ae.type==="Feature")return Hi(ae,H)!=null;if(ae.type==="FeatureCollection"){const q=new Set;for(const Q of ae.features){const oe=Hi(Q,H);if(oe==null||q.has(oe))return!1;q.add(oe)}return!0}return!1}function Zt(ae,H){const q=new Map;if(ae!=null)if(ae.type==="Feature")q.set(Hi(ae,H),ae);else for(const Q of ae.features)q.set(Hi(Q,H),Q);return q}ii.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},ii.prototype.splitTile=function(ae,H,q,Q,oe,Ae,ke){for(var Le=[ae,H,q,Q],we=this.options,Ue=we.debug;Le.length;){Q=Le.pop(),q=Le.pop(),H=Le.pop(),ae=Le.pop();var pt=1<<H,Qe=ai(H,q,Q),at=this.tiles[Qe];if(!at&&(Ue>1&&console.time("creation"),at=this.tiles[Qe]=rr(ae,H,q,Q,we),this.tileCoords.push({z:H,x:q,y:Q}),Ue)){Ue>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",H,q,Q,at.numFeatures,at.numPoints,at.numSimplified),console.timeEnd("creation"));var Jt="z"+H;this.stats[Jt]=(this.stats[Jt]||0)+1,this.total++}if(at.source=ae,oe){if(H===we.maxZoom||H===oe)continue;var ri=1<<oe-H;if(q!==Math.floor(Ae/ri)||Q!==Math.floor(ke/ri))continue}else if(H===we.indexMaxZoom||at.numPoints<=we.indexMaxPoints)continue;if(at.source=null,ae.length!==0){Ue>1&&console.time("clipping");var ui,pi,wi,Ri,nr,Pr,li=.5*we.buffer/we.extent,ur=.5-li,kr=.5+li,rn=1+li;ui=pi=wi=Ri=null,nr=Tt(ae,pt,q-li,q+kr,0,at.minX,at.maxX,we),Pr=Tt(ae,pt,q+ur,q+rn,0,at.minX,at.maxX,we),ae=null,nr&&(ui=Tt(nr,pt,Q-li,Q+kr,1,at.minY,at.maxY,we),pi=Tt(nr,pt,Q+ur,Q+rn,1,at.minY,at.maxY,we),nr=null),Pr&&(wi=Tt(Pr,pt,Q-li,Q+kr,1,at.minY,at.maxY,we),Ri=Tt(Pr,pt,Q+ur,Q+rn,1,at.minY,at.maxY,we),Pr=null),Ue>1&&console.timeEnd("clipping"),Le.push(ui||[],H+1,2*q,2*Q),Le.push(pi||[],H+1,2*q,2*Q+1),Le.push(wi||[],H+1,2*q+1,2*Q),Le.push(Ri||[],H+1,2*q+1,2*Q+1)}}},ii.prototype.getTile=function(ae,H,q){var Q=this.options,oe=Q.extent,Ae=Q.debug;if(ae<0||ae>24)return null;var ke=1<<ae,Le=ai(ae,H=(H%ke+ke)%ke,q);if(this.tiles[Le])return Gi(this.tiles[Le],oe);Ae>1&&console.log("drilling down to z%d-%d-%d",ae,H,q);for(var we,Ue=ae,pt=H,Qe=q;!we&&Ue>0;)Ue--,pt=Math.floor(pt/2),Qe=Math.floor(Qe/2),we=this.tiles[ai(Ue,pt,Qe)];return we&&we.source?(Ae>1&&console.log("found parent tile z%d-%d-%d",Ue,pt,Qe),Ae>1&&console.time("drilling down"),this.splitTile(we.source,Ue,pt,Qe,ae,H,q),Ae>1&&console.timeEnd("drilling down"),this.tiles[Le]?Gi(this.tiles[Le],oe):null):null};class Zi extends a{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(H,q){return j._(this,void 0,void 0,function*(){const Q=H.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const oe=this._geoJSONIndex.getTile(Q.z,Q.x,Q.y);if(!oe)return null;const Ae=new class{constructor(Le){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=j.W,this.length=Le.length,this._features=Le}feature(Le){return new class{constructor(we){this._feature=we,this.extent=j.W,this.type=we.type,this.properties=we.tags,"id"in we&&!isNaN(we.id)&&(this.id=parseInt(we.id,10))}loadGeometry(){if(this._feature.type===1){const we=[];for(const Ue of this._feature.geometry)we.push([new j.P(Ue[0],Ue[1])]);return we}{const we=[];for(const Ue of this._feature.geometry){const pt=[];for(const Qe of Ue)pt.push(new j.P(Qe[0],Qe[1]));we.push(pt)}return we}}toGeoJSON(we,Ue,pt){return u.call(this,we,Ue,pt)}}(this._features[Le])}}(oe.features);let ke=st(Ae);return ke.byteOffset===0&&ke.byteLength===ke.buffer.byteLength||(ke=new Uint8Array(ke)),{vectorTile:Ae,rawData:ke.buffer}})}loadData(H){return j._(this,void 0,void 0,function*(){var q;(q=this._pendingRequest)===null||q===void 0||q.abort();const Q=!!(H&&H.request&&H.request.collectResourceTiming)&&new j.bs(H.request);this._pendingRequest=new AbortController;try{let oe=yield this.loadGeoJSON(H,this._pendingRequest);if(delete this._pendingRequest,typeof oe!="object")throw new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`);if(_(oe,!0),H.filter){const ke=j.by(H.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(ke.result==="error")throw new Error(ke.value.map(we=>`${we.key}: ${we.message}`).join(", "));oe={type:"FeatureCollection",features:oe.features.filter(we=>ke.value.evaluate({zoom:0},we))}}this._geoJSONIndex=H.cluster?new _e(function({superclusterOptions:ke,clusterProperties:Le}){if(!Le||!ke)return ke;const we={},Ue={},pt={accumulated:null,zoom:0},Qe={properties:null},at=Object.keys(Le);for(const Jt of at){const[ri,ui]=Le[Jt],pi=j.by(ui),wi=j.by(typeof ri=="string"?[ri,["accumulated"],["get",Jt]]:ri);we[Jt]=pi.value,Ue[Jt]=wi.value}return ke.map=Jt=>{Qe.properties=Jt;const ri={};for(const ui of at)ri[ui]=we[ui].evaluate(pt,Qe);return ri},ke.reduce=(Jt,ri)=>{Qe.properties=ri;for(const ui of at)pt.accumulated=Jt[ui],Jt[ui]=Ue[ui].evaluate(pt,Qe)},ke}(H)).load(oe.features):function(ke,Le){return new ii(ke,Le)}(oe,H.geojsonVtOptions),this.loaded={};const Ae={};if(Q){const ke=Q.finish();ke&&(Ae.resourceTiming={},Ae.resourceTiming[H.source]=JSON.parse(JSON.stringify(ke)))}return Ae}catch(oe){if(delete this._pendingRequest,j.bz(oe))return{abandoned:!0};throw oe}})}reloadTile(H){const q=this.loaded;return q&&q[H.uid]?super.reloadTile(H):this.loadTile(H)}loadGeoJSON(H,q){return j._(this,void 0,void 0,function*(){const{promoteId:Q}=H;if(H.request){const oe=yield j.h(H.request,q);return this._dataUpdateable=qi(oe.data,Q)?Zt(oe.data,Q):void 0,oe.data}if(typeof H.data=="string")try{const oe=JSON.parse(H.data);return this._dataUpdateable=qi(oe,Q)?Zt(oe,Q):void 0,oe}catch{throw new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`)}if(!H.dataDiff)throw new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${H.source}`);return function(oe,Ae,ke){var Le,we,Ue,pt;if(Ae.removeAll&&oe.clear(),Ae.remove)for(const Qe of Ae.remove)oe.delete(Qe);if(Ae.add)for(const Qe of Ae.add){const at=Hi(Qe,ke);at!=null&&oe.set(at,Qe)}if(Ae.update)for(const Qe of Ae.update){let at=oe.get(Qe.id);if(at==null)continue;const Jt=!Qe.removeAllProperties&&(((Le=Qe.removeProperties)===null||Le===void 0?void 0:Le.length)>0||((we=Qe.addOrUpdateProperties)===null||we===void 0?void 0:we.length)>0);if((Qe.newGeometry||Qe.removeAllProperties||Jt)&&(at=Object.assign({},at),oe.set(Qe.id,at),Jt&&(at.properties=Object.assign({},at.properties))),Qe.newGeometry&&(at.geometry=Qe.newGeometry),Qe.removeAllProperties)at.properties={};else if(((Ue=Qe.removeProperties)===null||Ue===void 0?void 0:Ue.length)>0)for(const ri of Qe.removeProperties)Object.prototype.hasOwnProperty.call(at.properties,ri)&&delete at.properties[ri];if(((pt=Qe.addOrUpdateProperties)===null||pt===void 0?void 0:pt.length)>0)for(const{key:ri,value:ui}of Qe.addOrUpdateProperties)at.properties[ri]=ui}}(this._dataUpdateable,H.dataDiff,Q),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}})}removeSource(H){return j._(this,void 0,void 0,function*(){this._pendingRequest&&this._pendingRequest.abort()})}getClusterExpansionZoom(H){return this._geoJSONIndex.getClusterExpansionZoom(H.clusterId)}getClusterChildren(H){return this._geoJSONIndex.getChildren(H.clusterId)}getClusterLeaves(H){return this._geoJSONIndex.getLeaves(H.clusterId,H.limit,H.offset)}}class $i{constructor(H){this.self=H,this.actor=new j.C(H),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(q,Q)=>{if(this.externalWorkerSourceTypes[q])throw new Error(`Worker source with name "${q}" already registered.`);this.externalWorkerSourceTypes[q]=Q},this.self.addProtocol=j.bf,this.self.removeProtocol=j.bg,this.self.registerRTLTextPlugin=q=>{if(j.bA.isParsed())throw new Error("RTL text plugin already registered.");j.bA.setMethods(q)},this.actor.registerMessageHandler("LDT",(q,Q)=>this._getDEMWorkerSource(q,Q.source).loadTile(Q)),this.actor.registerMessageHandler("RDT",(q,Q)=>j._(this,void 0,void 0,function*(){this._getDEMWorkerSource(q,Q.source).removeTile(Q)})),this.actor.registerMessageHandler("GCEZ",(q,Q)=>j._(this,void 0,void 0,function*(){return this._getWorkerSource(q,Q.type,Q.source).getClusterExpansionZoom(Q)})),this.actor.registerMessageHandler("GCC",(q,Q)=>j._(this,void 0,void 0,function*(){return this._getWorkerSource(q,Q.type,Q.source).getClusterChildren(Q)})),this.actor.registerMessageHandler("GCL",(q,Q)=>j._(this,void 0,void 0,function*(){return this._getWorkerSource(q,Q.type,Q.source).getClusterLeaves(Q)})),this.actor.registerMessageHandler("LD",(q,Q)=>this._getWorkerSource(q,Q.type,Q.source).loadData(Q)),this.actor.registerMessageHandler("LT",(q,Q)=>this._getWorkerSource(q,Q.type,Q.source).loadTile(Q)),this.actor.registerMessageHandler("RT",(q,Q)=>this._getWorkerSource(q,Q.type,Q.source).reloadTile(Q)),this.actor.registerMessageHandler("AT",(q,Q)=>this._getWorkerSource(q,Q.type,Q.source).abortTile(Q)),this.actor.registerMessageHandler("RMT",(q,Q)=>this._getWorkerSource(q,Q.type,Q.source).removeTile(Q)),this.actor.registerMessageHandler("RS",(q,Q)=>j._(this,void 0,void 0,function*(){if(!this.workerSources[q]||!this.workerSources[q][Q.type]||!this.workerSources[q][Q.type][Q.source])return;const oe=this.workerSources[q][Q.type][Q.source];delete this.workerSources[q][Q.type][Q.source],oe.removeSource!==void 0&&oe.removeSource(Q)})),this.actor.registerMessageHandler("RM",q=>j._(this,void 0,void 0,function*(){delete this.layerIndexes[q],delete this.availableImages[q],delete this.workerSources[q],delete this.demWorkerSources[q]})),this.actor.registerMessageHandler("SR",(q,Q)=>j._(this,void 0,void 0,function*(){this.referrer=Q})),this.actor.registerMessageHandler("SRPS",(q,Q)=>this._syncRTLPluginState(q,Q)),this.actor.registerMessageHandler("IS",(q,Q)=>j._(this,void 0,void 0,function*(){this.self.importScripts(Q)})),this.actor.registerMessageHandler("SI",(q,Q)=>this._setImages(q,Q)),this.actor.registerMessageHandler("UL",(q,Q)=>j._(this,void 0,void 0,function*(){this._getLayerIndex(q).update(Q.layers,Q.removedIds)})),this.actor.registerMessageHandler("SL",(q,Q)=>j._(this,void 0,void 0,function*(){this._getLayerIndex(q).replace(Q)}))}_setImages(H,q){return j._(this,void 0,void 0,function*(){this.availableImages[H]=q;for(const Q in this.workerSources[H]){const oe=this.workerSources[H][Q];for(const Ae in oe)oe[Ae].availableImages=q}})}_syncRTLPluginState(H,q){return j._(this,void 0,void 0,function*(){if(j.bA.isParsed())return j.bA.getState();if(q.pluginStatus!=="loading")return j.bA.setState(q),q;const Q=q.pluginURL;if(this.self.importScripts(Q),j.bA.isParsed()){const oe={pluginStatus:"loaded",pluginURL:Q};return j.bA.setState(oe),oe}throw j.bA.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${Q}`)})}_getAvailableImages(H){let q=this.availableImages[H];return q||(q=[]),q}_getLayerIndex(H){let q=this.layerIndexes[H];return q||(q=this.layerIndexes[H]=new s),q}_getWorkerSource(H,q,Q){if(this.workerSources[H]||(this.workerSources[H]={}),this.workerSources[H][q]||(this.workerSources[H][q]={}),!this.workerSources[H][q][Q]){const oe={sendAsync:(Ae,ke)=>(Ae.targetMapId=H,this.actor.sendAsync(Ae,ke))};switch(q){case"vector":this.workerSources[H][q][Q]=new a(oe,this._getLayerIndex(H),this._getAvailableImages(H));break;case"geojson":this.workerSources[H][q][Q]=new Zi(oe,this._getLayerIndex(H),this._getAvailableImages(H));break;default:this.workerSources[H][q][Q]=new this.externalWorkerSourceTypes[q](oe,this._getLayerIndex(H),this._getAvailableImages(H))}}return this.workerSources[H][q][Q]}_getDEMWorkerSource(H,q){return this.demWorkerSources[H]||(this.demWorkerSources[H]={}),this.demWorkerSources[H][q]||(this.demWorkerSources[H][q]=new l),this.demWorkerSources[H][q]}}return j.i(self)&&(self.worker=new $i(self)),$i}),ue("index",["exports","./shared"],function(j,s){var p="4.1.3";let b,v;const a={now:typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frameAsync:g=>new Promise((t,n)=>{const c=requestAnimationFrame(t);g.signal.addEventListener("abort",()=>{cancelAnimationFrame(c),n(s.c())})}),getImageData(g,t=0){return this.getImageCanvasContext(g).getImageData(-t,-t,g.width+2*t,g.height+2*t)},getImageCanvasContext(g){const t=window.document.createElement("canvas"),n=t.getContext("2d",{willReadFrequently:!0});if(!n)throw new Error("failed to create canvas 2d context");return t.width=g.width,t.height=g.height,n.drawImage(g,0,0,g.width,g.height),n},resolveURL:g=>(b||(b=document.createElement("a")),b.href=g,b.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(v==null&&(v=matchMedia("(prefers-reduced-motion: reduce)")),v.matches)}};class l{static testProp(t){if(!l.docStyle)return t[0];for(let n=0;n<t.length;n++)if(t[n]in l.docStyle)return t[n];return t[0]}static create(t,n,c){const d=window.document.createElement(t);return n!==void 0&&(d.className=n),c&&c.appendChild(d),d}static createNS(t,n){return window.document.createElementNS(t,n)}static disableDrag(){l.docStyle&&l.selectProp&&(l.userSelect=l.docStyle[l.selectProp],l.docStyle[l.selectProp]="none")}static enableDrag(){l.docStyle&&l.selectProp&&(l.docStyle[l.selectProp]=l.userSelect)}static setTransform(t,n){t.style[l.transformProp]=n}static addEventListener(t,n,c,d={}){t.addEventListener(n,c,"passive"in d?d:d.capture)}static removeEventListener(t,n,c,d={}){t.removeEventListener(n,c,"passive"in d?d:d.capture)}static suppressClickInternal(t){t.preventDefault(),t.stopPropagation(),window.removeEventListener("click",l.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",l.suppressClickInternal,!0),window.setTimeout(()=>{window.removeEventListener("click",l.suppressClickInternal,!0)},0)}static getScale(t){const n=t.getBoundingClientRect();return{x:n.width/t.offsetWidth||1,y:n.height/t.offsetHeight||1,boundingClientRect:n}}static getPoint(t,n,c){const d=n.boundingClientRect;return new s.P((c.clientX-d.left)/n.x-t.clientLeft,(c.clientY-d.top)/n.y-t.clientTop)}static mousePos(t,n){const c=l.getScale(t);return l.getPoint(t,c,n)}static touchPos(t,n){const c=[],d=l.getScale(t);for(let y=0;y<n.length;y++)c.push(l.getPoint(t,d,n[y]));return c}static mouseButton(t){return t.button}static remove(t){t.parentNode&&t.parentNode.removeChild(t)}}l.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,l.selectProp=l.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),l.transformProp=l.testProp(["transform","WebkitTransform"]);const h={supported:!1,testSupport:function(g){!u&&_&&(x?T(g):m=g)}};let m,_,u=!1,x=!1;function T(g){const t=g.createTexture();g.bindTexture(g.TEXTURE_2D,t);try{if(g.texImage2D(g.TEXTURE_2D,0,g.RGBA,g.RGBA,g.UNSIGNED_BYTE,_),g.isContextLost())return;h.supported=!0}catch{}g.deleteTexture(t),u=!0}var A;typeof document<"u"&&(_=document.createElement("img"),_.onload=function(){m&&T(m),m=null,x=!0},_.onerror=function(){u=!0,m=null},_.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(g){let t,n,c,d;g.resetRequestQueue=()=>{t=[],n=0,c=0,d={}},g.addThrottleControl=L=>{const R=c++;return d[R]=L,R},g.removeThrottleControl=L=>{delete d[L],P()},g.getImage=(L,R,U=!0)=>new Promise((G,K)=>{h.supported&&(L.headers||(L.headers={}),L.headers.accept="image/webp,*/*"),s.e(L,{type:"image"}),t.push({abortController:R,requestParameters:L,supportImageRefresh:U,state:"queued",onError:he=>{K(he)},onSuccess:he=>{G(he)}}),P()});const y=L=>s._(this,void 0,void 0,function*(){L.state="running";const{requestParameters:R,supportImageRefresh:U,onError:G,onSuccess:K,abortController:he}=L,ce=U===!1&&!s.i(self)&&!s.g(R.url)&&(!R.headers||Object.keys(R.headers).reduce((Te,We)=>Te&&We==="accept",!0));n++;const fe=ce?k(R,he):s.m(R,he);try{const Te=yield fe;delete L.abortController,L.state="completed",Te.data instanceof HTMLImageElement||s.b(Te.data)?K(Te):Te.data&&K({data:yield(ne=Te.data,typeof createImageBitmap=="function"?s.d(ne):s.f(ne)),cacheControl:Te.cacheControl,expires:Te.expires})}catch(Te){delete L.abortController,G(Te)}finally{n--,P()}var ne}),P=()=>{const L=(()=>{for(const R of Object.keys(d))if(d[R]())return!0;return!1})()?s.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:s.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let R=n;R<L&&t.length>0;R++){const U=t.shift();U.abortController.signal.aborted?R--:y(U)}},k=(L,R)=>new Promise((U,G)=>{const K=new Image,he=L.url,ce=L.credentials;ce&&ce==="include"?K.crossOrigin="use-credentials":(ce&&ce==="same-origin"||!s.s(he))&&(K.crossOrigin="anonymous"),R.signal.addEventListener("abort",()=>{K.src="",G(s.c())}),K.fetchPriority="high",K.onload=()=>{K.onerror=K.onload=null,U({data:K})},K.onerror=()=>{K.onerror=K.onload=null,R.signal.aborted||G(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},K.src=he})}(A||(A={})),A.resetRequestQueue();class D{constructor(t){this._transformRequestFn=t}transformRequest(t,n){return this._transformRequestFn&&this._transformRequestFn(t,n)||{url:t}}normalizeSpriteURL(t,n,c){const d=function(y){const P=y.match(V);if(!P)throw new Error(`Unable to parse URL "${y}"`);return{protocol:P[1],authority:P[2],path:P[3]||"/",params:P[4]?P[4].split("&"):[]}}(t);return d.path+=`${n}${c}`,function(y){const P=y.params.length?`?${y.params.join("&")}`:"";return`${y.protocol}://${y.authority}${y.path}${P}`}(d)}setTransformRequest(t){this._transformRequestFn=t}}const V=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function X(g){var t=new s.A(3);return t[0]=g[0],t[1]=g[1],t[2]=g[2],t}var ie,ve=function(g,t,n){return g[0]=t[0]-n[0],g[1]=t[1]-n[1],g[2]=t[2]-n[2],g};ie=new s.A(3),s.A!=Float32Array&&(ie[0]=0,ie[1]=0,ie[2]=0);var Fe=function(g){var t=g[0],n=g[1];return t*t+n*n};function Ye(g){const t=[];if(typeof g=="string")t.push({id:"default",url:g});else if(g&&g.length>0){const n=[];for(const{id:c,url:d}of g){const y=`${c}${d}`;n.indexOf(y)===-1&&(n.push(y),t.push({id:c,url:d}))}}return t}(function(){var g=new s.A(2);s.A!=Float32Array&&(g[0]=0,g[1]=0)})();class Ze{constructor(t,n,c,d){this.context=t,this.format=c,this.texture=t.gl.createTexture(),this.update(n,d)}update(t,n,c){const{width:d,height:y}=t,P=!(this.size&&this.size[0]===d&&this.size[1]===y||c),{context:k}=this,{gl:L}=k;if(this.useMipmap=!!(n&&n.useMipmap),L.bindTexture(L.TEXTURE_2D,this.texture),k.pixelStoreUnpackFlipY.set(!1),k.pixelStoreUnpack.set(1),k.pixelStoreUnpackPremultiplyAlpha.set(this.format===L.RGBA&&(!n||n.premultiply!==!1)),P)this.size=[d,y],t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||s.b(t)?L.texImage2D(L.TEXTURE_2D,0,this.format,this.format,L.UNSIGNED_BYTE,t):L.texImage2D(L.TEXTURE_2D,0,this.format,d,y,0,this.format,L.UNSIGNED_BYTE,t.data);else{const{x:R,y:U}=c||{x:0,y:0};t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||s.b(t)?L.texSubImage2D(L.TEXTURE_2D,0,R,U,L.RGBA,L.UNSIGNED_BYTE,t):L.texSubImage2D(L.TEXTURE_2D,0,R,U,d,y,L.RGBA,L.UNSIGNED_BYTE,t.data)}this.useMipmap&&this.isSizePowerOfTwo()&&L.generateMipmap(L.TEXTURE_2D)}bind(t,n,c){const{context:d}=this,{gl:y}=d;y.bindTexture(y.TEXTURE_2D,this.texture),c!==y.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(c=y.LINEAR),t!==this.filter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,t),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,c||t),this.filter=t),n!==this.wrap&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,n),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,n),this.wrap=n)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}function Je(g){const{userImage:t}=g;return!!(t&&t.render&&t.render())&&(g.data.replace(new Uint8Array(t.data.buffer)),!0)}class ct extends s.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new s.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(t){if(this.loaded!==t&&(this.loaded=t,t)){for(const{ids:n,promiseResolve:c}of this.requestors)c(this._getImagesForIds(n));this.requestors=[]}}getImage(t){const n=this.images[t];if(n&&!n.data&&n.spriteData){const c=n.spriteData;n.data=new s.R({width:c.width,height:c.height},c.context.getImageData(c.x,c.y,c.width,c.height).data),n.spriteData=null}return n}addImage(t,n){if(this.images[t])throw new Error(`Image id ${t} already exist, use updateImage instead`);this._validate(t,n)&&(this.images[t]=n)}_validate(t,n){let c=!0;const d=n.data||n.spriteData;return this._validateStretch(n.stretchX,d&&d.width)||(this.fire(new s.j(new Error(`Image "${t}" has invalid "stretchX" value`))),c=!1),this._validateStretch(n.stretchY,d&&d.height)||(this.fire(new s.j(new Error(`Image "${t}" has invalid "stretchY" value`))),c=!1),this._validateContent(n.content,n)||(this.fire(new s.j(new Error(`Image "${t}" has invalid "content" value`))),c=!1),c}_validateStretch(t,n){if(!t)return!0;let c=0;for(const d of t){if(d[0]<c||d[1]<d[0]||n<d[1])return!1;c=d[1]}return!0}_validateContent(t,n){if(!t)return!0;if(t.length!==4)return!1;const c=n.spriteData,d=c&&c.width||n.data.width,y=c&&c.height||n.data.height;return!(t[0]<0||d<t[0]||t[1]<0||y<t[1]||t[2]<0||d<t[2]||t[3]<0||y<t[3]||t[2]<t[0]||t[3]<t[1])}updateImage(t,n,c=!0){const d=this.getImage(t);if(c&&(d.data.width!==n.data.width||d.data.height!==n.data.height))throw new Error(`size mismatch between old image (${d.data.width}x${d.data.height}) and new image (${n.data.width}x${n.data.height}).`);n.version=d.version+1,this.images[t]=n,this.updatedImages[t]=!0}removeImage(t){const n=this.images[t];delete this.images[t],delete this.patterns[t],n.userImage&&n.userImage.onRemove&&n.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(t){return new Promise((n,c)=>{let d=!0;if(!this.isLoaded())for(const y of t)this.images[y]||(d=!1);this.isLoaded()||d?n(this._getImagesForIds(t)):this.requestors.push({ids:t,promiseResolve:n})})}_getImagesForIds(t){const n={};for(const c of t){let d=this.getImage(c);d||(this.fire(new s.k("styleimagemissing",{id:c})),d=this.getImage(c)),d?n[c]={data:d.data.clone(),pixelRatio:d.pixelRatio,sdf:d.sdf,version:d.version,stretchX:d.stretchX,stretchY:d.stretchY,content:d.content,hasRenderCallback:!!(d.userImage&&d.userImage.render)}:s.w(`Image "${c}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return n}getPixelSize(){const{width:t,height:n}=this.atlasImage;return{width:t,height:n}}getPattern(t){const n=this.patterns[t],c=this.getImage(t);if(!c)return null;if(n&&n.position.version===c.version)return n.position;if(n)n.position.version=c.version;else{const d={w:c.data.width+2,h:c.data.height+2,x:0,y:0},y=new s.I(d,c);this.patterns[t]={bin:d,position:y}}return this._updatePatternAtlas(),this.patterns[t].position}bind(t){const n=t.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new Ze(t,this.atlasImage,n.RGBA),this.atlasTexture.bind(n.LINEAR,n.CLAMP_TO_EDGE)}_updatePatternAtlas(){const t=[];for(const y in this.patterns)t.push(this.patterns[y].bin);const{w:n,h:c}=s.p(t),d=this.atlasImage;d.resize({width:n||1,height:c||1});for(const y in this.patterns){const{bin:P}=this.patterns[y],k=P.x+1,L=P.y+1,R=this.getImage(y).data,U=R.width,G=R.height;s.R.copy(R,d,{x:0,y:0},{x:k,y:L},{width:U,height:G}),s.R.copy(R,d,{x:0,y:G-1},{x:k,y:L-1},{width:U,height:1}),s.R.copy(R,d,{x:0,y:0},{x:k,y:L+G},{width:U,height:1}),s.R.copy(R,d,{x:U-1,y:0},{x:k-1,y:L},{width:1,height:G}),s.R.copy(R,d,{x:0,y:0},{x:k+U,y:L},{width:1,height:G})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(t){for(const n of t){if(this.callbackDispatchedThisFrame[n])continue;this.callbackDispatchedThisFrame[n]=!0;const c=this.getImage(n);c||s.w(`Image with ID: "${n}" was not found`),Je(c)&&this.updateImage(n,c)}}}const nt=1e20;function vt(g,t,n,c,d,y,P,k,L){for(let R=t;R<t+c;R++)Mt(g,n*y+R,y,d,P,k,L);for(let R=n;R<n+d;R++)Mt(g,R*y+t,1,c,P,k,L)}function Mt(g,t,n,c,d,y,P){y[0]=0,P[0]=-nt,P[1]=nt,d[0]=g[t];for(let k=1,L=0,R=0;k<c;k++){d[k]=g[t+k*n];const U=k*k;do{const G=y[L];R=(d[k]-d[G]+U-G*G)/(k-G)/2}while(R<=P[L]&&--L>-1);L++,y[L]=k,P[L]=R,P[L+1]=nt}for(let k=0,L=0;k<c;k++){for(;P[L+1]<k;)L++;const R=y[L],U=k-R;g[t+k*n]=d[R]+U*U}}class st{constructor(t,n){this.requestManager=t,this.localIdeographFontFamily=n,this.entries={}}setURL(t){this.url=t}getGlyphs(t){return s._(this,void 0,void 0,function*(){const n=[];for(const y in t)for(const P of t[y])n.push(this._getAndCacheGlyphsPromise(y,P));const c=yield Promise.all(n),d={};for(const{stack:y,id:P,glyph:k}of c)d[y]||(d[y]={}),d[y][P]=k&&{id:k.id,bitmap:k.bitmap.clone(),metrics:k.metrics};return d})}_getAndCacheGlyphsPromise(t,n){return s._(this,void 0,void 0,function*(){let c=this.entries[t];c||(c=this.entries[t]={glyphs:{},requests:{},ranges:{}});let d=c.glyphs[n];if(d!==void 0)return{stack:t,id:n,glyph:d};if(d=this._tinySDF(c,t,n),d)return c.glyphs[n]=d,{stack:t,id:n,glyph:d};const y=Math.floor(n/256);if(256*y>65535)throw new Error("glyphs > 65535 not supported");if(c.ranges[y])return{stack:t,id:n,glyph:d};if(!this.url)throw new Error("glyphsUrl is not set");if(!c.requests[y]){const k=st.loadGlyphRange(t,y,this.url,this.requestManager);c.requests[y]=k}const P=yield c.requests[y];for(const k in P)this._doesCharSupportLocalGlyph(+k)||(c.glyphs[+k]=P[+k]);return c.ranges[y]=!0,{stack:t,id:n,glyph:P[n]||null}})}_doesCharSupportLocalGlyph(t){return!!this.localIdeographFontFamily&&(s.u["CJK Unified Ideographs"](t)||s.u["Hangul Syllables"](t)||s.u.Hiragana(t)||s.u.Katakana(t))}_tinySDF(t,n,c){const d=this.localIdeographFontFamily;if(!d||!this._doesCharSupportLocalGlyph(c))return;let y=t.tinySDF;if(!y){let k="400";/bold/i.test(n)?k="900":/medium/i.test(n)?k="500":/light/i.test(n)&&(k="200"),y=t.tinySDF=new st.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:d,fontWeight:k})}const P=y.draw(String.fromCharCode(c));return{id:c,bitmap:new s.o({width:P.width||60,height:P.height||60},P.data),metrics:{width:P.glyphWidth/2||24,height:P.glyphHeight/2||24,left:P.glyphLeft/2+.5||0,top:P.glyphTop/2-27.5||-8,advance:P.glyphAdvance/2||24,isDoubleResolution:!0}}}}st.loadGlyphRange=function(g,t,n,c){return s._(this,void 0,void 0,function*(){const d=256*t,y=d+255,P=c.transformRequest(n.replace("{fontstack}",g).replace("{range}",`${d}-${y}`),"Glyphs"),k=yield s.l(P,new AbortController);if(!k||!k.data)throw new Error(`Could not load glyph range. range: ${t}, ${d}-${y}`);const L={};for(const R of s.n(k.data))L[R.id]=R;return L})},st.TinySDF=class{constructor({fontSize:g=24,buffer:t=3,radius:n=8,cutoff:c=.25,fontFamily:d="sans-serif",fontWeight:y="normal",fontStyle:P="normal"}={}){this.buffer=t,this.cutoff=c,this.radius=n;const k=this.size=g+4*t,L=this._createCanvas(k),R=this.ctx=L.getContext("2d",{willReadFrequently:!0});R.font=`${P} ${y} ${g}px ${d}`,R.textBaseline="alphabetic",R.textAlign="left",R.fillStyle="black",this.gridOuter=new Float64Array(k*k),this.gridInner=new Float64Array(k*k),this.f=new Float64Array(k),this.z=new Float64Array(k+1),this.v=new Uint16Array(k)}_createCanvas(g){const t=document.createElement("canvas");return t.width=t.height=g,t}draw(g){const{width:t,actualBoundingBoxAscent:n,actualBoundingBoxDescent:c,actualBoundingBoxLeft:d,actualBoundingBoxRight:y}=this.ctx.measureText(g),P=Math.ceil(n),k=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(y-d))),L=Math.min(this.size-this.buffer,P+Math.ceil(c)),R=k+2*this.buffer,U=L+2*this.buffer,G=Math.max(R*U,0),K=new Uint8ClampedArray(G),he={data:K,width:R,height:U,glyphWidth:k,glyphHeight:L,glyphTop:P,glyphLeft:0,glyphAdvance:t};if(k===0||L===0)return he;const{ctx:ce,buffer:fe,gridInner:ne,gridOuter:Te}=this;ce.clearRect(fe,fe,k,L),ce.fillText(g,fe,fe+P);const We=ce.getImageData(fe,fe,k,L);Te.fill(nt,0,G),ne.fill(0,0,G);for(let xe=0;xe<L;xe++)for(let ze=0;ze<k;ze++){const $e=We.data[4*(xe*k+ze)+3]/255;if($e===0)continue;const Ke=(xe+fe)*R+ze+fe;if($e===1)Te[Ke]=0,ne[Ke]=nt;else{const rt=.5-$e;Te[Ke]=rt>0?rt*rt:0,ne[Ke]=rt<0?rt*rt:0}}vt(Te,0,0,R,U,R,this.f,this.v,this.z),vt(ne,fe,fe,k,L,R,this.f,this.v,this.z);for(let xe=0;xe<G;xe++){const ze=Math.sqrt(Te[xe])-Math.sqrt(ne[xe]);K[xe]=Math.round(255-255*(ze/this.radius+this.cutoff))}return he}};class bt{constructor(){this.specification=s.v.light.position}possiblyEvaluate(t,n){return s.y(t.expression.evaluate(n))}interpolate(t,n,c){return{x:s.z.number(t.x,n.x,c),y:s.z.number(t.y,n.y,c),z:s.z.number(t.z,n.z,c)}}}let ee;class be extends s.E{constructor(t){super(),ee=ee||new s.q({anchor:new s.D(s.v.light.anchor),position:new bt,color:new s.D(s.v.light.color),intensity:new s.D(s.v.light.intensity)}),this._transitionable=new s.T(ee),this.setLight(t),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,n={}){if(!this._validate(s.r,t,n))for(const c in t){const d=t[c];c.endsWith("-transition")?this._transitionable.setTransition(c.slice(0,-11),d):this._transitionable.setValue(c,d)}}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||c.validate!==!1)&&s.t(this,t.call(s.x,{value:n,style:{glyphs:!0,sprite:!0},styleSpec:s.v}))}}class me{constructor(t,n){this.width=t,this.height=n,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(t,n){const c=t.join(",")+String(n);return this.dashEntry[c]||(this.dashEntry[c]=this.addDash(t,n)),this.dashEntry[c]}getDashRanges(t,n,c){const d=[];let y=t.length%2==1?-t[t.length-1]*c:0,P=t[0]*c,k=!0;d.push({left:y,right:P,isDash:k,zeroLength:t[0]===0});let L=t[0];for(let R=1;R<t.length;R++){k=!k;const U=t[R];y=L*c,L+=U,P=L*c,d.push({left:y,right:P,isDash:k,zeroLength:U===0})}return d}addRoundDash(t,n,c){const d=n/2;for(let y=-c;y<=c;y++){const P=this.width*(this.nextRow+c+y);let k=0,L=t[k];for(let R=0;R<this.width;R++){R/L.right>1&&(L=t[++k]);const U=Math.abs(R-L.left),G=Math.abs(R-L.right),K=Math.min(U,G);let he;const ce=y/c*(d+1);if(L.isDash){const fe=d-Math.abs(ce);he=Math.sqrt(K*K+fe*fe)}else he=d-Math.sqrt(K*K+ce*ce);this.data[P+R]=Math.max(0,Math.min(255,he+128))}}}addRegularDash(t){for(let k=t.length-1;k>=0;--k){const L=t[k],R=t[k+1];L.zeroLength?t.splice(k,1):R&&R.isDash===L.isDash&&(R.left=L.left,t.splice(k,1))}const n=t[0],c=t[t.length-1];n.isDash===c.isDash&&(n.left=c.left-this.width,c.right=n.right+this.width);const d=this.width*this.nextRow;let y=0,P=t[y];for(let k=0;k<this.width;k++){k/P.right>1&&(P=t[++y]);const L=Math.abs(k-P.left),R=Math.abs(k-P.right),U=Math.min(L,R);this.data[d+k]=Math.max(0,Math.min(255,(P.isDash?U:-U)+128))}}addDash(t,n){const c=n?7:0,d=2*c+1;if(this.nextRow+d>this.height)return s.w("LineAtlas out of space"),null;let y=0;for(let k=0;k<t.length;k++)y+=t[k];if(y!==0){const k=this.width/y,L=this.getDashRanges(t,this.width,k);n?this.addRoundDash(L,k,c):this.addRegularDash(L)}const P={y:(this.nextRow+c+.5)/this.height,height:2*c/this.height,width:y};return this.nextRow+=d,this.dirty=!0,P}bind(t){const n=t.gl;this.texture?(n.bindTexture(n.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,n.texSubImage2D(n.TEXTURE_2D,0,0,0,this.width,this.height,n.ALPHA,n.UNSIGNED_BYTE,this.data))):(this.texture=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this.texture),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texImage2D(n.TEXTURE_2D,0,n.ALPHA,this.width,this.height,0,n.ALPHA,n.UNSIGNED_BYTE,this.data))}}const ge="maplibre_preloaded_worker_pool";class je{constructor(){this.active={}}acquire(t){if(!this.workers)for(this.workers=[];this.workers.length<je.workerCount;)this.workers.push(new Worker(s.a.WORKER_URL));return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],this.numActive()===0&&(this.workers.forEach(n=>{n.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[ge]}numActive(){return Object.keys(this.active).length}}const _e=Math.floor(a.hardwareConcurrency/2);let te,Pe;function Ne(){return te||(te=new je),te}je.workerCount=s.B(globalThis)?Math.max(Math.min(_e,3),1):1;class et{constructor(t,n){this.workerPool=t,this.actors=[],this.currentActor=0,this.id=n;const c=this.workerPool.acquire(n);for(let d=0;d<c.length;d++){const y=new s.C(c[d],n);y.name=`Worker ${d}`,this.actors.push(y)}if(!this.actors.length)throw new Error("No actors found")}broadcast(t,n){const c=[];for(const d of this.actors)c.push(d.sendAsync({type:t,data:n}));return Promise.all(c)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(t=!0){this.actors.forEach(n=>{n.remove()}),this.actors=[],t&&this.workerPool.release(this.id)}registerMessageHandler(t,n){for(const c of this.actors)c.registerMessageHandler(t,n)}}function He(){return Pe||(Pe=new et(Ne(),s.G),Pe.registerMessageHandler("GR",(g,t,n)=>s.m(t,n))),Pe}function Ge(g,t){const n=s.F();return s.H(n,n,[1,1,0]),s.J(n,n,[.5*g.width,.5*g.height,1]),s.K(n,n,g.calculatePosMatrix(t.toUnwrapped()))}function _t(g,t,n,c,d,y){const P=function(G,K,he){if(G)for(const ce of G){const fe=K[ce];if(fe&&fe.source===he&&fe.type==="fill-extrusion")return!0}else for(const ce in K){const fe=K[ce];if(fe.source===he&&fe.type==="fill-extrusion")return!0}return!1}(d&&d.layers,t,g.id),k=y.maxPitchScaleFactor(),L=g.tilesIn(c,k,P);L.sort(It);const R=[];for(const G of L)R.push({wrappedTileID:G.tileID.wrapped().key,queryResults:G.tile.queryRenderedFeatures(t,n,g._state,G.queryGeometry,G.cameraQueryGeometry,G.scale,d,y,k,Ge(g.transform,G.tileID))});const U=function(G){const K={},he={};for(const ce of G){const fe=ce.queryResults,ne=ce.wrappedTileID,Te=he[ne]=he[ne]||{};for(const We in fe){const xe=fe[We],ze=Te[We]=Te[We]||{},$e=K[We]=K[We]||[];for(const Ke of xe)ze[Ke.featureIndex]||(ze[Ke.featureIndex]=!0,$e.push(Ke))}}return K}(R);for(const G in U)U[G].forEach(K=>{const he=K.feature,ce=g.getFeatureState(he.layer["source-layer"],he.id);he.source=he.layer.source,he.layer["source-layer"]&&(he.sourceLayer=he.layer["source-layer"]),he.state=ce});return U}function It(g,t){const n=g.tileID,c=t.tileID;return n.overscaledZ-c.overscaledZ||n.canonical.y-c.canonical.y||n.wrap-c.wrap||n.canonical.x-c.canonical.x}function Xe(g,t,n){return s._(this,void 0,void 0,function*(){let c=g;if(g.url?c=(yield s.h(t.transformRequest(g.url,"Source"),n)).data:yield a.frameAsync(n),!c)return null;const d=s.L(s.e(c,g),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in c&&c.vector_layers&&(d.vectorLayerIds=c.vector_layers.map(y=>y.id)),d})}class Oe{constructor(t,n){t&&(n?this.setSouthWest(t).setNorthEast(n):Array.isArray(t)&&(t.length===4?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1])))}setNorthEast(t){return this._ne=t instanceof s.M?new s.M(t.lng,t.lat):s.M.convert(t),this}setSouthWest(t){return this._sw=t instanceof s.M?new s.M(t.lng,t.lat):s.M.convert(t),this}extend(t){const n=this._sw,c=this._ne;let d,y;if(t instanceof s.M)d=t,y=t;else{if(!(t instanceof Oe))return Array.isArray(t)?t.length===4||t.every(Array.isArray)?this.extend(Oe.convert(t)):this.extend(s.M.convert(t)):t&&("lng"in t||"lon"in t)&&"lat"in t?this.extend(s.M.convert(t)):this;if(d=t._sw,y=t._ne,!d||!y)return this}return n||c?(n.lng=Math.min(d.lng,n.lng),n.lat=Math.min(d.lat,n.lat),c.lng=Math.max(y.lng,c.lng),c.lat=Math.max(y.lat,c.lat)):(this._sw=new s.M(d.lng,d.lat),this._ne=new s.M(y.lng,y.lat)),this}getCenter(){return new s.M((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new s.M(this.getWest(),this.getNorth())}getSouthEast(){return new s.M(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:n,lat:c}=s.M.convert(t);let d=this._sw.lng<=n&&n<=this._ne.lng;return this._sw.lng>this._ne.lng&&(d=this._sw.lng>=n&&n>=this._ne.lng),this._sw.lat<=c&&c<=this._ne.lat&&d}static convert(t){return t instanceof Oe?t:t&&new Oe(t)}static fromLngLat(t,n=0){const c=360*n/40075017,d=c/Math.cos(Math.PI/180*t.lat);return new Oe(new s.M(t.lng-d,t.lat-c),new s.M(t.lng+d,t.lat+c))}}class ot{constructor(t,n,c){this.bounds=Oe.convert(this.validateBounds(t)),this.minzoom=n||0,this.maxzoom=c||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(t){const n=Math.pow(2,t.z),c=Math.floor(s.N(this.bounds.getWest())*n),d=Math.floor(s.O(this.bounds.getNorth())*n),y=Math.ceil(s.N(this.bounds.getEast())*n),P=Math.ceil(s.O(this.bounds.getSouth())*n);return t.x>=c&&t.x<y&&t.y>=d&&t.y<P}}class qe extends s.E{constructor(t,n,c,d){if(super(),this.id=t,this.dispatcher=c,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,s.e(this,s.L(n,["url","scheme","tileSize","promoteId"])),this._options=s.e({type:"vector"},n),this._collectResourceTiming=n.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(d)}load(){return s._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new s.k("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const t=yield Xe(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),t&&(s.e(this,t),t.bounds&&(this.tileBounds=new ot(t.bounds,this.minzoom,this.maxzoom)),this.fire(new s.k("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.k("data",{dataType:"source",sourceDataType:"content"})))}catch(t){this._tileJSONRequest=null,this.fire(new s.j(t))}})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}setSourceProperty(t){this._tileJSONRequest&&this._tileJSONRequest.abort(),t(),this.load()}setTiles(t){return this.setSourceProperty(()=>{this._options.tiles=t}),this}setUrl(t){return this.setSourceProperty(()=>{this.url=t,this._options.url=t}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return s.e({},this._options)}loadTile(t){return s._(this,void 0,void 0,function*(){const n=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),c={request:this.map._requestManager.transformRequest(n,"Tile"),uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};c.request.collectResourceTiming=this._collectResourceTiming;let d="RT";if(t.actor&&t.state!=="expired"){if(t.state==="loading")return new Promise((y,P)=>{t.reloadPromise={resolve:y,reject:P}})}else t.actor=this.dispatcher.getActor(),d="LT";t.abortController=new AbortController;try{const y=yield t.actor.sendAsync({type:d,data:c},t.abortController);if(delete t.abortController,t.aborted)return;this._afterTileLoadWorkerResponse(t,y)}catch(y){if(delete t.abortController,t.aborted)return;if(y&&y.status!==404)throw y;this._afterTileLoadWorkerResponse(t,null)}})}_afterTileLoadWorkerResponse(t,n){if(n&&n.resourceTiming&&(t.resourceTiming=n.resourceTiming),n&&this.map._refreshExpiredTiles&&t.setExpiryData(n),t.loadVectorData(n,this.map.painter),t.reloadPromise){const c=t.reloadPromise;t.reloadPromise=null,this.loadTile(t).then(c.resolve).catch(c.reject)}}abortTile(t){return s._(this,void 0,void 0,function*(){t.abortController&&(t.abortController.abort(),delete t.abortController),t.actor&&(yield t.actor.sendAsync({type:"AT",data:{uid:t.uid,type:this.type,source:this.id}}))})}unloadTile(t){return s._(this,void 0,void 0,function*(){t.unloadVectorData(),t.actor&&(yield t.actor.sendAsync({type:"RMT",data:{uid:t.uid,type:this.type,source:this.id}}))})}hasTransition(){return!1}}class le extends s.E{constructor(t,n,c,d){super(),this.id=t,this.dispatcher=c,this.setEventedParent(d),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=s.e({type:"raster"},n),s.e(this,s.L(n,["url","scheme","tileSize"]))}load(){return s._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new s.k("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const t=yield Xe(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,t&&(s.e(this,t),t.bounds&&(this.tileBounds=new ot(t.bounds,this.minzoom,this.maxzoom)),this.fire(new s.k("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.k("data",{dataType:"source",sourceDataType:"content"})))}catch(t){this._tileJSONRequest=null,this.fire(new s.j(t))}})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(t){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),t(),this.load()}setTiles(t){return this.setSourceProperty(()=>{this._options.tiles=t}),this}setUrl(t){return this.setSourceProperty(()=>{this.url=t,this._options.url=t}),this}serialize(){return s.e({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t){return s._(this,void 0,void 0,function*(){const n=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);t.abortController=new AbortController;try{const c=yield A.getImage(this.map._requestManager.transformRequest(n,"Tile"),t.abortController,this.map._refreshExpiredTiles);if(delete t.abortController,t.aborted)return void(t.state="unloaded");if(c&&c.data){this.map._refreshExpiredTiles&&c.cacheControl&&c.expires&&t.setExpiryData({cacheControl:c.cacheControl,expires:c.expires});const d=this.map.painter.context,y=d.gl,P=c.data;t.texture=this.map.painter.getTileTexture(P.width),t.texture?t.texture.update(P,{useMipmap:!0}):(t.texture=new Ze(d,P,y.RGBA,{useMipmap:!0}),t.texture.bind(y.LINEAR,y.CLAMP_TO_EDGE,y.LINEAR_MIPMAP_NEAREST),d.extTextureFilterAnisotropic&&y.texParameterf(y.TEXTURE_2D,d.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,d.extTextureFilterAnisotropicMax)),t.state="loaded"}}catch(c){if(delete t.abortController,t.aborted)t.state="unloaded";else if(c)throw t.state="errored",c}})}abortTile(t){return s._(this,void 0,void 0,function*(){t.abortController&&(t.abortController.abort(),delete t.abortController)})}unloadTile(t){return s._(this,void 0,void 0,function*(){t.texture&&this.map.painter.saveTileTexture(t.texture)})}hasTransition(){return!1}}class ft extends le{constructor(t,n,c,d){super(t,n,c,d),this.type="raster-dem",this.maxzoom=22,this._options=s.e({type:"raster-dem"},n),this.encoding=n.encoding||"mapbox",this.redFactor=n.redFactor,this.greenFactor=n.greenFactor,this.blueFactor=n.blueFactor,this.baseShift=n.baseShift}loadTile(t){return s._(this,void 0,void 0,function*(){const n=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),c=this.map._requestManager.transformRequest(n,"Tile");t.neighboringTiles=this._getNeighboringTiles(t.tileID),t.abortController=new AbortController;try{const d=yield A.getImage(c,t.abortController,this.map._refreshExpiredTiles);if(delete t.abortController,t.aborted)return void(t.state="unloaded");if(d&&d.data){const y=d.data;this.map._refreshExpiredTiles&&d.cacheControl&&d.expires&&t.setExpiryData({cacheControl:d.cacheControl,expires:d.expires});const P=s.b(y)&&s.S()?y:yield this.readImageNow(y),k={type:this.type,uid:t.uid,source:this.id,rawImageData:P,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!t.actor||t.state==="expired"){t.actor=this.dispatcher.getActor();const L=yield t.actor.sendAsync({type:"LDT",data:k});t.dem=L,t.needsHillshadePrepare=!0,t.needsTerrainPrepare=!0,t.state="loaded"}}}catch(d){if(delete t.abortController,t.aborted)t.state="unloaded";else if(d)throw t.state="errored",d}})}readImageNow(t){return s._(this,void 0,void 0,function*(){if(typeof VideoFrame<"u"&&s.U()){const n=t.width+2,c=t.height+2;try{return new s.R({width:n,height:c},yield s.V(t,-1,-1,n,c))}catch{}}return a.getImageData(t,1)})}_getNeighboringTiles(t){const n=t.canonical,c=Math.pow(2,n.z),d=(n.x-1+c)%c,y=n.x===0?t.wrap-1:t.wrap,P=(n.x+1+c)%c,k=n.x+1===c?t.wrap+1:t.wrap,L={};return L[new s.Q(t.overscaledZ,y,n.z,d,n.y).key]={backfilled:!1},L[new s.Q(t.overscaledZ,k,n.z,P,n.y).key]={backfilled:!1},n.y>0&&(L[new s.Q(t.overscaledZ,y,n.z,d,n.y-1).key]={backfilled:!1},L[new s.Q(t.overscaledZ,t.wrap,n.z,n.x,n.y-1).key]={backfilled:!1},L[new s.Q(t.overscaledZ,k,n.z,P,n.y-1).key]={backfilled:!1}),n.y+1<c&&(L[new s.Q(t.overscaledZ,y,n.z,d,n.y+1).key]={backfilled:!1},L[new s.Q(t.overscaledZ,t.wrap,n.z,n.x,n.y+1).key]={backfilled:!1},L[new s.Q(t.overscaledZ,k,n.z,P,n.y+1).key]={backfilled:!1}),L}unloadTile(t){return s._(this,void 0,void 0,function*(){t.demTexture&&this.map.painter.saveTileTexture(t.demTexture),t.fbo&&(t.fbo.destroy(),delete t.fbo),t.dem&&delete t.dem,delete t.neighboringTiles,t.state="unloaded",t.actor&&(yield t.actor.sendAsync({type:"RDT",data:{type:this.type,uid:t.uid,source:this.id}}))})}}class Pt extends s.E{constructor(t,n,c,d){super(),this.id=t,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=c.getActor(),this.setEventedParent(d),this._data=n.data,this._options=s.e({},n),this._collectResourceTiming=n.collectResourceTiming,n.maxzoom!==void 0&&(this.maxzoom=n.maxzoom),n.type&&(this.type=n.type),n.attribution&&(this.attribution=n.attribution),this.promoteId=n.promoteId;const y=s.W/this.tileSize;this.workerOptions=s.e({source:this.id,cluster:n.cluster||!1,geojsonVtOptions:{buffer:(n.buffer!==void 0?n.buffer:128)*y,tolerance:(n.tolerance!==void 0?n.tolerance:.375)*y,extent:s.W,maxZoom:this.maxzoom,lineMetrics:n.lineMetrics||!1,generateId:n.generateId||!1},superclusterOptions:{maxZoom:n.clusterMaxZoom!==void 0?n.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,n.clusterMinPoints||2),extent:s.W,radius:(n.clusterRadius||50)*y,log:!1,generateId:n.generateId||!1},clusterProperties:n.clusterProperties,filter:n.filter},n.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}load(){return s._(this,void 0,void 0,function*(){yield this._updateWorkerData()})}onAdd(t){this.map=t,this.load()}setData(t){return this._data=t,this._updateWorkerData(),this}updateData(t){return this._updateWorkerData(t),this}setClusterOptions(t){return this.workerOptions.cluster=t.cluster,t&&(t.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=t.clusterRadius),t.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=t.clusterMaxZoom)),this._updateWorkerData(),this}getClusterExpansionZoom(t){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:t,source:this.id}})}getClusterChildren(t){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:t,source:this.id}})}getClusterLeaves(t,n,c){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:t,limit:n,offset:c}})}_updateWorkerData(t){return s._(this,void 0,void 0,function*(){const n=s.e({type:this.type},this.workerOptions);t?n.dataDiff=t:typeof this._data=="string"?(n.request=this.map._requestManager.transformRequest(a.resolveURL(this._data),"Source"),n.request.collectResourceTiming=this._collectResourceTiming):n.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new s.k("dataloading",{dataType:"source"}));try{const c=yield this.actor.sendAsync({type:"LD",data:n});if(this._pendingLoads--,this._removed||c.abandoned)return void this.fire(new s.k("dataabort",{dataType:"source"}));let d=null;c.resourceTiming&&c.resourceTiming[this.id]&&(d=c.resourceTiming[this.id].slice(0));const y={dataType:"source"};this._collectResourceTiming&&d&&d.length>0&&s.e(y,{resourceTiming:d}),this.fire(new s.k("data",Object.assign(Object.assign({},y),{sourceDataType:"metadata"}))),this.fire(new s.k("data",Object.assign(Object.assign({},y),{sourceDataType:"content"})))}catch(c){if(this._pendingLoads--,this._removed)return void this.fire(new s.k("dataabort",{dataType:"source"}));this.fire(new s.j(c))}})}loaded(){return this._pendingLoads===0}loadTile(t){return s._(this,void 0,void 0,function*(){const n=t.actor?"RT":"LT";t.actor=this.actor;const c={type:this.type,uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};t.abortController=new AbortController;const d=yield this.actor.sendAsync({type:n,data:c},t.abortController);delete t.abortController,t.unloadVectorData(),t.aborted||t.loadVectorData(d,this.map.painter,n==="RT")})}abortTile(t){return s._(this,void 0,void 0,function*(){t.abortController&&(t.abortController.abort(),delete t.abortController),t.aborted=!0})}unloadTile(t){return s._(this,void 0,void 0,function*(){t.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:t.uid,type:this.type,source:this.id}})})}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return s.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}var Tt=s.X([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class Nt extends s.E{constructor(t,n,c,d){super(),this.id=t,this.dispatcher=c,this.coordinates=n.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(d),this.options=n}load(t){return s._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new s.k("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const n=yield A.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,n&&n.data&&(this.image=n.data,t&&(this.coordinates=t),this._finishLoading())}catch(n){this._request=null,this._loaded=!0,this.fire(new s.j(n))}})}loaded(){return this._loaded}updateImage(t){return t.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=t.url,this.load(t.coordinates).finally(()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new s.k("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(t){this.coordinates=t;const n=t.map(s.Y.fromLngLat);this.tileID=function(d){let y=1/0,P=1/0,k=-1/0,L=-1/0;for(const K of d)y=Math.min(y,K.x),P=Math.min(P,K.y),k=Math.max(k,K.x),L=Math.max(L,K.y);const R=Math.max(k-y,L-P),U=Math.max(0,Math.floor(-Math.log(R)/Math.LN2)),G=Math.pow(2,U);return new s.a0(U,Math.floor((y+k)/2*G),Math.floor((P+L)/2*G))}(n),this.minzoom=this.maxzoom=this.tileID.z;const c=n.map(d=>this.tileID.getTilePoint(d)._round());return this._boundsArray=new s.Z,this._boundsArray.emplaceBack(c[0].x,c[0].y,0,0),this._boundsArray.emplaceBack(c[1].x,c[1].y,s.W,0),this._boundsArray.emplaceBack(c[3].x,c[3].y,0,s.W),this._boundsArray.emplaceBack(c[2].x,c[2].y,s.W,s.W),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this.fire(new s.k("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const t=this.map.painter.context,n=t.gl;this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,Tt.members)),this.boundsSegments||(this.boundsSegments=s.$.simpleSegment(0,0,4,2)),this.texture||(this.texture=new Ze(t,this.image,n.RGBA),this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE));let c=!1;for(const d in this.tiles){const y=this.tiles[d];y.state!=="loaded"&&(y.state="loaded",y.texture=this.texture,c=!0)}c&&this.fire(new s.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(t){return s._(this,void 0,void 0,function*(){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={}):t.state="errored"})}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class lt extends Nt{constructor(t,n,c,d){super(t,n,c,d),this.roundZoom=!0,this.type="video",this.options=n}load(){return s._(this,void 0,void 0,function*(){this._loaded=!1;const t=this.options;this.urls=[];for(const n of t.urls)this.urls.push(this.map._requestManager.transformRequest(n,"Source").url);try{const n=yield s.a2(this.urls);if(this._loaded=!0,!n)return;this.video=n,this.video.loop=!0,this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading()}catch(n){this.fire(new s.j(n))}})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(t){if(this.video){const n=this.video.seekable;t<n.start(0)||t>n.end(0)?this.fire(new s.j(new s.a1(`sources.${this.id}`,null,`Playback for this video can be set only between the ${n.start(0)} and ${n.end(0)}-second mark.`))):this.video.currentTime=t}}getVideo(){return this.video}onAdd(t){this.map||(this.map=t,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const t=this.map.painter.context,n=t.gl;this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,Tt.members)),this.boundsSegments||(this.boundsSegments=s.$.simpleSegment(0,0,4,2)),this.texture?this.video.paused||(this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE),n.texSubImage2D(n.TEXTURE_2D,0,0,0,n.RGBA,n.UNSIGNED_BYTE,this.video)):(this.texture=new Ze(t,this.video,n.RGBA),this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE));let c=!1;for(const d in this.tiles){const y=this.tiles[d];y.state!=="loaded"&&(y.state="loaded",y.texture=this.texture,c=!0)}c&&this.fire(new s.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class wt extends Nt{constructor(t,n,c,d){super(t,n,c,d),n.coordinates?Array.isArray(n.coordinates)&&n.coordinates.length===4&&!n.coordinates.some(y=>!Array.isArray(y)||y.length!==2||y.some(P=>typeof P!="number"))||this.fire(new s.j(new s.a1(`sources.${t}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.j(new s.a1(`sources.${t}`,null,'missing required property "coordinates"'))),n.animate&&typeof n.animate!="boolean"&&this.fire(new s.j(new s.a1(`sources.${t}`,null,'optional "animate" property must be a boolean value'))),n.canvas?typeof n.canvas=="string"||n.canvas instanceof HTMLCanvasElement||this.fire(new s.j(new s.a1(`sources.${t}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.j(new s.a1(`sources.${t}`,null,'missing required property "canvas"'))),this.options=n,this.animate=n.animate===void 0||n.animate}load(){return s._(this,void 0,void 0,function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.j(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())})}getCanvas(){return this.canvas}onAdd(t){this.map=t,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let t=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,t=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,t=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const n=this.map.painter.context,c=n.gl;this.boundsBuffer||(this.boundsBuffer=n.createVertexBuffer(this._boundsArray,Tt.members)),this.boundsSegments||(this.boundsSegments=s.$.simpleSegment(0,0,4,2)),this.texture?(t||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new Ze(n,this.canvas,c.RGBA,{premultiply:!0});let d=!1;for(const y in this.tiles){const P=this.tiles[y];P.state!=="loaded"&&(P.state="loaded",P.texture=this.texture,d=!0)}d&&this.fire(new s.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const t of[this.canvas.width,this.canvas.height])if(isNaN(t)||t<=0)return!0;return!1}}const Yt={},fi=g=>{switch(g){case"geojson":return Pt;case"image":return Nt;case"raster":return le;case"raster-dem":return ft;case"vector":return qe;case"video":return lt;case"canvas":return wt}return Yt[g]},mi="RTLPluginLoaded";class yi extends s.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=He()}_syncState(t){return this.status=t,this.dispatcher.broadcast("SRPS",{pluginStatus:t,pluginURL:this.url}).catch(n=>{throw this.status="error",n})}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(t){return s._(this,arguments,void 0,function*(n,c=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=a.resolveURL(n),!this.url)throw new Error(`requested url ${n} is invalid`);if(this.status==="unavailable"){if(!c)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()})}_requestImport(){return s._(this,void 0,void 0,function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new s.k(mi))})}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let bi=null;function ut(){return bi||(bi=new yi),bi}class Gi{constructor(t,n){this.timeAdded=0,this.fadeEndTime=0,this.tileID=t,this.uid=s.a3(),this.uses=0,this.tileSize=n,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(t){const n=t+this.timeAdded;n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(t){this.demTexture&&t.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(t,n,c){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(d,y){const P={};if(!y)return P;for(const k of d){const L=k.layerIds.map(R=>y.getLayer(R)).filter(Boolean);if(L.length!==0){k.layers=L,k.stateDependentLayerIds&&(k.stateDependentLayers=k.stateDependentLayerIds.map(R=>L.filter(U=>U.id===R)[0]));for(const R of L)P[R.id]=k}}return P}(t.buckets,n.style),this.hasSymbolBuckets=!1;for(const d in this.buckets){const y=this.buckets[d];if(y instanceof s.a5){if(this.hasSymbolBuckets=!0,!c)break;y.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const d in this.buckets){const y=this.buckets[d];if(y instanceof s.a5&&y.hasRTLText){this.hasRTLText=!0,ut().lazyLoad();break}}this.queryPadding=0;for(const d in this.buckets){const y=this.buckets[d];this.queryPadding=Math.max(this.queryPadding,n.style.getLayer(d).queryRadius(y))}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage)}else this.collisionBoxArray=new s.a4}unloadVectorData(){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(t){return this.buckets[t.id]}upload(t){for(const c in this.buckets){const d=this.buckets[c];d.uploadPending()&&d.upload(t)}const n=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new Ze(t,this.imageAtlas.image,n.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new Ze(t,this.glyphAtlasImage,n.ALPHA),this.glyphAtlasImage=null)}prepare(t){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture)}queryRenderedFeatures(t,n,c,d,y,P,k,L,R,U){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:d,cameraQueryGeometry:y,scale:P,tileSize:this.tileSize,pixelPosMatrix:U,transform:L,params:k,queryPadding:this.queryPadding*R},t,n,c):{}}querySourceFeatures(t,n){const c=this.latestFeatureIndex;if(!c||!c.rawTileData)return;const d=c.loadVTLayers(),y=n&&n.sourceLayer?n.sourceLayer:"",P=d._geojsonTileLayer||d[y];if(!P)return;const k=s.a6(n&&n.filter),{z:L,x:R,y:U}=this.tileID.canonical,G={z:L,x:R,y:U};for(let K=0;K<P.length;K++){const he=P.feature(K);if(k.needGeometry){const ne=s.a7(he,!0);if(!k.filter(new s.a8(this.tileID.overscaledZ),ne,this.tileID.canonical))continue}else if(!k.filter(new s.a8(this.tileID.overscaledZ),he))continue;const ce=c.getId(he,y),fe=new s.a9(he,L,R,U,ce);fe.tile=G,t.push(fe)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const n=this.expirationTime;if(t.cacheControl){const c=s.aa(t.cacheControl);c["max-age"]&&(this.expirationTime=Date.now()+1e3*c["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const c=Date.now();let d=!1;if(this.expirationTime>c)d=!1;else if(n)if(this.expirationTime<n)d=!0;else{const y=this.expirationTime-n;y?this.expirationTime=c+Math.max(y,3e4):d=!0}else d=!0;d?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(t,n){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(t).length===0)return;const c=this.latestFeatureIndex.loadVTLayers();for(const d in this.buckets){if(!n.style.hasLayer(d))continue;const y=this.buckets[d],P=y.layers[0].sourceLayer||"_geojsonTileLayer",k=c[P],L=t[P];if(!k||!L||Object.keys(L).length===0)continue;y.update(L,k,this.imageAtlas&&this.imageAtlas.patternPositions||{});const R=n&&n.style&&n.style.getLayer(d);R&&(this.queryPadding=Math.max(this.queryPadding,R.queryRadius(y)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<a.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=a.now()+t}setDependencies(t,n){const c={};for(const d of n)c[d]=!0;this.dependencies[t]=c}hasDependency(t,n){for(const c of t){const d=this.dependencies[c];if(d){for(const y of n)if(d[y])return!0}}return!1}}class Xi{constructor(t,n){this.max=t,this.onRemove=n,this.reset()}reset(){for(const t in this.data)for(const n of this.data[t])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(t,n,c){const d=t.wrapped().key;this.data[d]===void 0&&(this.data[d]=[]);const y={value:n,timeout:void 0};if(c!==void 0&&(y.timeout=setTimeout(()=>{this.remove(t,y)},c)),this.data[d].push(y),this.order.push(d),this.order.length>this.max){const P=this._getAndRemoveByKey(this.order[0]);P&&this.onRemove(P)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const n=this.data[t].shift();return n.timeout&&clearTimeout(n.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),n.value}getByKey(t){const n=this.data[t];return n?n[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,n){if(!this.has(t))return this;const c=t.wrapped().key,d=n===void 0?0:this.data[c].indexOf(n),y=this.data[c][d];return this.data[c].splice(d,1),y.timeout&&clearTimeout(y.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(y.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(t){const n=[];for(const c in this.data)for(const d of this.data[c])t(d.value)||n.push(d);for(const c of n)this.remove(c.value.tileID,c)}}class rr{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,n,c){const d=String(n);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][d]=this.stateChanges[t][d]||{},s.e(this.stateChanges[t][d],c),this.deletedStates[t]===null){this.deletedStates[t]={};for(const y in this.state[t])y!==d&&(this.deletedStates[t][y]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][d]===null){this.deletedStates[t][d]={};for(const y in this.state[t][d])c[y]||(this.deletedStates[t][d][y]=null)}else for(const y in c)this.deletedStates[t]&&this.deletedStates[t][d]&&this.deletedStates[t][d][y]===null&&delete this.deletedStates[t][d][y]}removeFeatureState(t,n,c){if(this.deletedStates[t]===null)return;const d=String(n);if(this.deletedStates[t]=this.deletedStates[t]||{},c&&n!==void 0)this.deletedStates[t][d]!==null&&(this.deletedStates[t][d]=this.deletedStates[t][d]||{},this.deletedStates[t][d][c]=null);else if(n!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][d])for(c in this.deletedStates[t][d]={},this.stateChanges[t][d])this.deletedStates[t][d][c]=null;else this.deletedStates[t][d]=null;else this.deletedStates[t]=null}getState(t,n){const c=String(n),d=s.e({},(this.state[t]||{})[c],(this.stateChanges[t]||{})[c]);if(this.deletedStates[t]===null)return{};if(this.deletedStates[t]){const y=this.deletedStates[t][n];if(y===null)return{};for(const P in y)delete d[P]}return d}initializeTileState(t,n){t.setFeatureState(this.state,n)}coalesceChanges(t,n){const c={};for(const d in this.stateChanges){this.state[d]=this.state[d]||{};const y={};for(const P in this.stateChanges[d])this.state[d][P]||(this.state[d][P]={}),s.e(this.state[d][P],this.stateChanges[d][P]),y[P]=this.state[d][P];c[d]=y}for(const d in this.deletedStates){this.state[d]=this.state[d]||{};const y={};if(this.deletedStates[d]===null)for(const P in this.state[d])y[P]={},this.state[d][P]={};else for(const P in this.deletedStates[d]){if(this.deletedStates[d][P]===null)this.state[d][P]={};else for(const k of Object.keys(this.deletedStates[d][P]))delete this.state[d][P][k];y[P]=this.state[d][P]}c[d]=c[d]||{},s.e(c[d],y)}if(this.stateChanges={},this.deletedStates={},Object.keys(c).length!==0)for(const d in t)t[d].setFeatureState(c,n)}}class Qi extends s.E{constructor(t,n,c){super(),this.id=t,this.dispatcher=c,this.on("data",d=>this._dataHandler(d)),this.on("dataloading",()=>{this._sourceErrored=!1}),this.on("error",()=>{this._sourceErrored=this._source.loaded()}),this._source=((d,y,P,k)=>{const L=new(fi(y.type))(d,y,P,k);if(L.id!==d)throw new Error(`Expected Source id to be ${d} instead of ${L.id}`);return L})(t,n,c,this),this._tiles={},this._cache=new Xi(0,d=>this._unloadTile(d)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new rr,this._didEmitContent=!1,this._updated=!1}onAdd(t){this.map=t,this._maxTileCacheSize=t?t._maxTileCacheSize:null,this._maxTileCacheZoomLevels=t?t._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(t)}onRemove(t){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(t)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const t in this._tiles){const n=this._tiles[t];if(n.state!=="loaded"&&n.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(t,n,c){return s._(this,void 0,void 0,function*(){try{yield this._source.loadTile(t),this._tileLoaded(t,n,c)}catch(d){t.state="errored",d.status!==404?this._source.fire(new s.j(d,{tile:t})):this.update(this.transform,this.terrain)}})}_unloadTile(t){this._source.unloadTile&&this._source.unloadTile(t)}_abortTile(t){this._source.abortTile&&this._source.abortTile(t),this._source.fire(new s.k("dataabort",{tile:t,coord:t.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const c=this._tiles[n];c.upload(t),c.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(Et).map(t=>t.key)}getRenderableIds(t){const n=[];for(const c in this._tiles)this._isIdRenderable(c,t)&&n.push(this._tiles[c]);return t?n.sort((c,d)=>{const y=c.tileID,P=d.tileID,k=new s.P(y.canonical.x,y.canonical.y)._rotate(this.transform.angle),L=new s.P(P.canonical.x,P.canonical.y)._rotate(this.transform.angle);return y.overscaledZ-P.overscaledZ||L.y-k.y||L.x-k.x}).map(c=>c.tileID.key):n.map(c=>c.tileID).sort(Et).map(c=>c.key)}hasRenderableParent(t){const n=this.findLoadedParent(t,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(t,n){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(n||!this._tiles[t].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(t,"reloading")}}_reloadTile(t,n){return s._(this,void 0,void 0,function*(){const c=this._tiles[t];c&&(c.state!=="loading"&&(c.state=n),yield this._loadTile(c,t,n))})}_tileLoaded(t,n,c){t.timeAdded=a.now(),c==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(n,t),this.getSource().type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),t.aborted||this._source.fire(new s.k("data",{dataType:"source",tile:t,coord:t.tileID}))}_backfillDEM(t){const n=this.getRenderableIds();for(let d=0;d<n.length;d++){const y=n[d];if(t.neighboringTiles&&t.neighboringTiles[y]){const P=this.getTileByID(y);c(t,P),c(P,t)}}function c(d,y){d.needsHillshadePrepare=!0,d.needsTerrainPrepare=!0;let P=y.tileID.canonical.x-d.tileID.canonical.x;const k=y.tileID.canonical.y-d.tileID.canonical.y,L=Math.pow(2,d.tileID.canonical.z),R=y.tileID.key;P===0&&k===0||Math.abs(k)>1||(Math.abs(P)>1&&(Math.abs(P+L)===1?P+=L:Math.abs(P-L)===1&&(P-=L)),y.dem&&d.dem&&(d.dem.backfillBorder(y.dem,P,k),d.neighboringTiles&&d.neighboringTiles[R]&&(d.neighboringTiles[R].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,n,c,d){for(const y in this._tiles){let P=this._tiles[y];if(d[y]||!P.hasData()||P.tileID.overscaledZ<=n||P.tileID.overscaledZ>c)continue;let k=P.tileID;for(;P&&P.tileID.overscaledZ>n+1;){const R=P.tileID.scaledTo(P.tileID.overscaledZ-1);P=this._tiles[R.key],P&&P.hasData()&&(k=R)}let L=k;for(;L.overscaledZ>n;)if(L=L.scaledTo(L.overscaledZ-1),t[L.key]){d[k.key]=k;break}}}findLoadedParent(t,n){if(t.key in this._loadedParentTiles){const c=this._loadedParentTiles[t.key];return c&&c.tileID.overscaledZ>=n?c:null}for(let c=t.overscaledZ-1;c>=n;c--){const d=t.scaledTo(c),y=this._getLoadedTile(d);if(y)return y}}_getLoadedTile(t){const n=this._tiles[t.key];return n&&n.hasData()?n:this._cache.getByKey(t.wrapped().key)}updateCacheSize(t){const n=Math.ceil(t.width/this._source.tileSize)+1,c=Math.ceil(t.height/this._source.tileSize)+1,d=Math.floor(n*c*(this._maxTileCacheZoomLevels===null?s.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),y=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,d):d;this._cache.setMaxSize(y)}handleWrapJump(t){const n=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,n){const c={};for(const d in this._tiles){const y=this._tiles[d];y.tileID=y.tileID.unwrapTo(y.tileID.wrap+n),c[y.tileID.key]=y}this._tiles=c;for(const d in this._timers)clearTimeout(this._timers[d]),delete this._timers[d];for(const d in this._tiles)this._setTileReloadTimer(d,this._tiles[d])}}update(t,n){if(!this._sourceLoaded||this._paused)return;let c;this.transform=t,this.terrain=n,this.updateCacheSize(t),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?c=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(U=>new s.Q(U.canonical.z,U.wrap,U.canonical.z,U.canonical.x,U.canonical.y)):(c=t.coveringTiles({tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:n}),this._source.hasTile&&(c=c.filter(U=>this._source.hasTile(U)))):c=[];const d=t.coveringZoomLevel(this._source),y=Math.max(d-Qi.maxOverzooming,this._source.minzoom),P=Math.max(d+Qi.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const U={};for(const G of c)if(G.canonical.z>this._source.minzoom){const K=G.scaledTo(G.canonical.z-1);U[K.key]=K;const he=G.scaledTo(Math.max(this._source.minzoom,Math.min(G.canonical.z,5)));U[he.key]=he}c=c.concat(Object.values(U))}const k=c.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,k&&this.fire(new s.k("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const L=this._updateRetainedTiles(c,d);if(ii(this._source.type)){const U={},G={},K=Object.keys(L),he=a.now();for(const ce of K){const fe=L[ce],ne=this._tiles[ce];if(!ne||ne.fadeEndTime!==0&&ne.fadeEndTime<=he)continue;const Te=this.findLoadedParent(fe,y);Te&&(this._addTile(Te.tileID),U[Te.tileID.key]=Te.tileID),G[ce]=fe}this._retainLoadedChildren(G,d,P,L);for(const ce in U)L[ce]||(this._coveredTiles[ce]=!0,L[ce]=U[ce]);if(n){const ce={},fe={};for(const ne of c)this._tiles[ne.key].hasData()?ce[ne.key]=ne:fe[ne.key]=ne;for(const ne in fe){const Te=fe[ne].children(this._source.maxzoom);this._tiles[Te[0].key]&&this._tiles[Te[1].key]&&this._tiles[Te[2].key]&&this._tiles[Te[3].key]&&(ce[Te[0].key]=L[Te[0].key]=Te[0],ce[Te[1].key]=L[Te[1].key]=Te[1],ce[Te[2].key]=L[Te[2].key]=Te[2],ce[Te[3].key]=L[Te[3].key]=Te[3],delete fe[ne])}for(const ne in fe){const Te=this.findLoadedParent(fe[ne],this._source.minzoom);if(Te){ce[Te.tileID.key]=L[Te.tileID.key]=Te.tileID;for(const We in ce)ce[We].isChildOf(Te.tileID)&&delete ce[We]}}for(const ne in this._tiles)ce[ne]||(this._coveredTiles[ne]=!0)}}for(const U in L)this._tiles[U].clearFadeHold();const R=s.ab(this._tiles,L);for(const U of R){const G=this._tiles[U];G.hasSymbolBuckets&&!G.holdingForFade()?G.setHoldDuration(this.map._fadeDuration):G.hasSymbolBuckets&&!G.symbolFadeFinished()||this._removeTile(U)}this._updateLoadedParentTileCache()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(t)}_updateRetainedTiles(t,n){const c={},d={},y=Math.max(n-Qi.maxOverzooming,this._source.minzoom),P=Math.max(n+Qi.maxUnderzooming,this._source.minzoom),k={};for(const L of t){const R=this._addTile(L);c[L.key]=L,R.hasData()||n<this._source.maxzoom&&(k[L.key]=L)}this._retainLoadedChildren(k,n,P,c);for(const L of t){let R=this._tiles[L.key];if(R.hasData())continue;if(n+1>this._source.maxzoom){const G=L.children(this._source.maxzoom)[0],K=this.getTile(G);if(K&&K.hasData()){c[G.key]=G;continue}}else{const G=L.children(this._source.maxzoom);if(c[G[0].key]&&c[G[1].key]&&c[G[2].key]&&c[G[3].key])continue}let U=R.wasRequested();for(let G=L.overscaledZ-1;G>=y;--G){const K=L.scaledTo(G);if(d[K.key])break;if(d[K.key]=!0,R=this.getTile(K),!R&&U&&(R=this._addTile(K)),R){const he=R.hasData();if((U||he)&&(c[K.key]=K),U=R.wasRequested(),he)break}}}return c}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const n=[];let c,d=this._tiles[t].tileID;for(;d.overscaledZ>0;){if(d.key in this._loadedParentTiles){c=this._loadedParentTiles[d.key];break}n.push(d.key);const y=d.scaledTo(d.overscaledZ-1);if(c=this._getLoadedTile(y),c)break;d=y}for(const y of n)this._loadedParentTiles[y]=c}}_addTile(t){let n=this._tiles[t.key];if(n)return n;n=this._cache.getAndRemove(t),n&&(this._setTileReloadTimer(t.key,n),n.tileID=t,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,n)));const c=n;return n||(n=new Gi(t,this._source.tileSize*t.overscaleFactor()),this._loadTile(n,t.key,n.state)),n.uses++,this._tiles[t.key]=n,c||this._source.fire(new s.k("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n}_setTileReloadTimer(t,n){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const c=n.getExpiryTimeout();c&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},c))}_removeTile(t){const n=this._tiles[t];n&&(n.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),n.uses>0||(n.hasData()&&n.state!=="reloading"?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}_dataHandler(t){const n=t.sourceDataType;t.dataType==="source"&&n==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&t.dataType==="source"&&n==="content"&&(this.reload(),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(t);this._cache.reset()}tilesIn(t,n,c){const d=[],y=this.transform;if(!y)return d;const P=c?y.getCameraQueryGeometry(t):t,k=t.map(ce=>y.pointCoordinate(ce,this.terrain)),L=P.map(ce=>y.pointCoordinate(ce,this.terrain)),R=this.getIds();let U=1/0,G=1/0,K=-1/0,he=-1/0;for(const ce of L)U=Math.min(U,ce.x),G=Math.min(G,ce.y),K=Math.max(K,ce.x),he=Math.max(he,ce.y);for(let ce=0;ce<R.length;ce++){const fe=this._tiles[R[ce]];if(fe.holdingForFade())continue;const ne=fe.tileID,Te=Math.pow(2,y.zoom-fe.tileID.overscaledZ),We=n*fe.queryPadding*s.W/fe.tileSize/Te,xe=[ne.getTilePoint(new s.Y(U,G)),ne.getTilePoint(new s.Y(K,he))];if(xe[0].x-We<s.W&&xe[0].y-We<s.W&&xe[1].x+We>=0&&xe[1].y+We>=0){const ze=k.map(Ke=>ne.getTilePoint(Ke)),$e=L.map(Ke=>ne.getTilePoint(Ke));d.push({tile:fe,tileID:ne,queryGeometry:ze,cameraQueryGeometry:$e,scale:Te})}}return d}getVisibleCoordinates(t){const n=this.getRenderableIds(t).map(c=>this._tiles[c].tileID);for(const c of n)c.posMatrix=this.transform.calculatePosMatrix(c.toUnwrapped());return n}hasTransition(){if(this._source.hasTransition())return!0;if(ii(this._source.type)){const t=a.now();for(const n in this._tiles)if(this._tiles[n].fadeEndTime>=t)return!0}return!1}setFeatureState(t,n,c){this._state.updateState(t=t||"_geojsonTileLayer",n,c)}removeFeatureState(t,n,c){this._state.removeFeatureState(t=t||"_geojsonTileLayer",n,c)}getFeatureState(t,n){return this._state.getState(t=t||"_geojsonTileLayer",n)}setDependencies(t,n,c){const d=this._tiles[t];d&&d.setDependencies(n,c)}reloadTilesForDependencies(t,n){for(const c in this._tiles)this._tiles[c].hasDependency(t,n)&&this._reloadTile(c,"reloading");this._cache.filter(c=>!c.hasDependency(t,n))}}function Et(g,t){const n=Math.abs(2*g.wrap)-+(g.wrap<0),c=Math.abs(2*t.wrap)-+(t.wrap<0);return g.overscaledZ-t.overscaledZ||c-n||t.canonical.y-g.canonical.y||t.canonical.x-g.canonical.x}function ii(g){return g==="raster"||g==="image"||g==="video"}Qi.maxOverzooming=10,Qi.maxUnderzooming=3;class ai{constructor(t,n){this.reset(t,n)}reset(t,n){this.points=t||[],this._distances=[0];for(let c=1;c<this.points.length;c++)this._distances[c]=this._distances[c-1]+this.points[c].dist(this.points[c-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(n||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=s.ac(t,0,1);let n=1,c=this._distances[n];const d=t*this.paddedLength+this.padding;for(;c<d&&n<this._distances.length;)c=this._distances[++n];const y=n-1,P=this._distances[y],k=c-P,L=k>0?(d-P)/k:0;return this.points[y].mult(1-L).add(this.points[n].mult(L))}}function Hi(g,t){let n=!0;return g==="always"||g!=="never"&&t!=="never"||(n=!1),n}class qi{constructor(t,n,c){const d=this.boxCells=[],y=this.circleCells=[];this.xCellCount=Math.ceil(t/c),this.yCellCount=Math.ceil(n/c);for(let P=0;P<this.xCellCount*this.yCellCount;P++)d.push([]),y.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=n,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/n,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,n,c,d,y){this._forEachCell(n,c,d,y,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(n),this.bboxes.push(c),this.bboxes.push(d),this.bboxes.push(y)}insertCircle(t,n,c,d){this._forEachCell(n-d,c-d,n+d,c+d,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(n),this.circles.push(c),this.circles.push(d)}_insertBoxCell(t,n,c,d,y,P){this.boxCells[y].push(P)}_insertCircleCell(t,n,c,d,y,P){this.circleCells[y].push(P)}_query(t,n,c,d,y,P,k){if(c<0||t>this.width||d<0||n>this.height)return[];const L=[];if(t<=0&&n<=0&&this.width<=c&&this.height<=d){if(y)return[{key:null,x1:t,y1:n,x2:c,y2:d}];for(let R=0;R<this.boxKeys.length;R++)L.push({key:this.boxKeys[R],x1:this.bboxes[4*R],y1:this.bboxes[4*R+1],x2:this.bboxes[4*R+2],y2:this.bboxes[4*R+3]});for(let R=0;R<this.circleKeys.length;R++){const U=this.circles[3*R],G=this.circles[3*R+1],K=this.circles[3*R+2];L.push({key:this.circleKeys[R],x1:U-K,y1:G-K,x2:U+K,y2:G+K})}}else this._forEachCell(t,n,c,d,this._queryCell,L,{hitTest:y,overlapMode:P,seenUids:{box:{},circle:{}}},k);return L}query(t,n,c,d){return this._query(t,n,c,d,!1,null)}hitTest(t,n,c,d,y,P){return this._query(t,n,c,d,!0,y,P).length>0}hitTestCircle(t,n,c,d,y){const P=t-c,k=t+c,L=n-c,R=n+c;if(k<0||P>this.width||R<0||L>this.height)return!1;const U=[];return this._forEachCell(P,L,k,R,this._queryCellCircle,U,{hitTest:!0,overlapMode:d,circle:{x:t,y:n,radius:c},seenUids:{box:{},circle:{}}},y),U.length>0}_queryCell(t,n,c,d,y,P,k,L){const{seenUids:R,hitTest:U,overlapMode:G}=k,K=this.boxCells[y];if(K!==null){const ce=this.bboxes;for(const fe of K)if(!R.box[fe]){R.box[fe]=!0;const ne=4*fe,Te=this.boxKeys[fe];if(t<=ce[ne+2]&&n<=ce[ne+3]&&c>=ce[ne+0]&&d>=ce[ne+1]&&(!L||L(Te))&&(!U||!Hi(G,Te.overlapMode))&&(P.push({key:Te,x1:ce[ne],y1:ce[ne+1],x2:ce[ne+2],y2:ce[ne+3]}),U))return!0}}const he=this.circleCells[y];if(he!==null){const ce=this.circles;for(const fe of he)if(!R.circle[fe]){R.circle[fe]=!0;const ne=3*fe,Te=this.circleKeys[fe];if(this._circleAndRectCollide(ce[ne],ce[ne+1],ce[ne+2],t,n,c,d)&&(!L||L(Te))&&(!U||!Hi(G,Te.overlapMode))){const We=ce[ne],xe=ce[ne+1],ze=ce[ne+2];if(P.push({key:Te,x1:We-ze,y1:xe-ze,x2:We+ze,y2:xe+ze}),U)return!0}}}return!1}_queryCellCircle(t,n,c,d,y,P,k,L){const{circle:R,seenUids:U,overlapMode:G}=k,K=this.boxCells[y];if(K!==null){const ce=this.bboxes;for(const fe of K)if(!U.box[fe]){U.box[fe]=!0;const ne=4*fe,Te=this.boxKeys[fe];if(this._circleAndRectCollide(R.x,R.y,R.radius,ce[ne+0],ce[ne+1],ce[ne+2],ce[ne+3])&&(!L||L(Te))&&!Hi(G,Te.overlapMode))return P.push(!0),!0}}const he=this.circleCells[y];if(he!==null){const ce=this.circles;for(const fe of he)if(!U.circle[fe]){U.circle[fe]=!0;const ne=3*fe,Te=this.circleKeys[fe];if(this._circlesCollide(ce[ne],ce[ne+1],ce[ne+2],R.x,R.y,R.radius)&&(!L||L(Te))&&!Hi(G,Te.overlapMode))return P.push(!0),!0}}}_forEachCell(t,n,c,d,y,P,k,L){const R=this._convertToXCellCoord(t),U=this._convertToYCellCoord(n),G=this._convertToXCellCoord(c),K=this._convertToYCellCoord(d);for(let he=R;he<=G;he++)for(let ce=U;ce<=K;ce++)if(y.call(this,t,n,c,d,this.xCellCount*ce+he,P,k,L))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,n,c,d,y,P){const k=d-t,L=y-n,R=c+P;return R*R>k*k+L*L}_circleAndRectCollide(t,n,c,d,y,P,k){const L=(P-d)/2,R=Math.abs(t-(d+L));if(R>L+c)return!1;const U=(k-y)/2,G=Math.abs(n-(y+U));if(G>U+c)return!1;if(R<=L||G<=U)return!0;const K=R-L,he=G-U;return K*K+he*he<=c*c}}function Zt(g,t,n,c,d){const y=s.F();return t?(s.J(y,y,[1/d,1/d,1]),n||s.ad(y,y,c.angle)):s.K(y,c.labelPlaneMatrix,g),y}function Zi(g,t,n,c,d){if(t){const y=s.ae(g);return s.J(y,y,[d,d,1]),n||s.ad(y,y,-c.angle),y}return c.glCoordMatrix}function $i(g,t,n){let c;n?(c=[g.x,g.y,n(g.x,g.y),1],s.af(c,c,t)):(c=[g.x,g.y,0,1],Jt(c,c,t));const d=c[3];return{point:new s.P(c[0]/d,c[1]/d),signedDistanceFromCamera:d}}function ae(g,t){return .5+g/t*.5}function H(g,t){const n=g[0]/g[3],c=g[1]/g[3];return n>=-t[0]&&n<=t[0]&&c>=-t[1]&&c<=t[1]}function q(g,t,n,c,d,y,P,k,L,R){const U=c?g.textSizeData:g.iconSizeData,G=s.ag(U,n.transform.zoom),K=[256/n.width*2+1,256/n.height*2+1],he=c?g.text.dynamicLayoutVertexArray:g.icon.dynamicLayoutVertexArray;he.clear();const ce=g.lineVertexArray,fe=c?g.text.placedSymbolArray:g.icon.placedSymbolArray,ne=n.transform.width/n.transform.height;let Te=!1;for(let We=0;We<fe.length;We++){const xe=fe.get(We);if(xe.hidden||xe.writingMode===s.ah.vertical&&!Te){at(xe.numGlyphs,he);continue}let ze;if(Te=!1,R?(ze=[xe.anchorX,xe.anchorY,R(xe.anchorX,xe.anchorY),1],s.af(ze,ze,t)):(ze=[xe.anchorX,xe.anchorY,0,1],Jt(ze,ze,t)),!H(ze,K)){at(xe.numGlyphs,he);continue}const $e=ae(n.transform.cameraToCenterDistance,ze[3]),Ke=s.ai(U,G,xe),rt=P?Ke/$e:Ke*$e,xt=new s.P(xe.anchorX,xe.anchorY),yt=$i(xt,d,R).point,At={projections:{},offsets:{}},zt=Ae(xe,rt,!1,k,t,d,y,g.glyphOffsetArray,ce,he,yt,xt,At,ne,L,R);Te=zt.useVertical,(zt.notEnoughRoom||Te||zt.needsFlipping&&Ae(xe,rt,!0,k,t,d,y,g.glyphOffsetArray,ce,he,yt,xt,At,ne,L,R).notEnoughRoom)&&at(xe.numGlyphs,he)}c?g.text.dynamicLayoutVertexBuffer.updateData(he):g.icon.dynamicLayoutVertexBuffer.updateData(he)}function Q(g,t,n,c,d,y,P,k,L,R,U,G,K){const he=k.glyphStartIndex+k.numGlyphs,ce=k.lineStartIndex,fe=k.lineStartIndex+k.lineLength,ne=t.getoffsetX(k.glyphStartIndex),Te=t.getoffsetX(he-1),We=pt(g*ne,n,c,d,y,P,k.segment,ce,fe,L,R,U,G,K);if(!We)return null;const xe=pt(g*Te,n,c,d,y,P,k.segment,ce,fe,L,R,U,G,K);return xe?{first:We,last:xe}:null}function oe(g,t,n,c){return g===s.ah.horizontal&&Math.abs(n.y-t.y)>Math.abs(n.x-t.x)*c?{useVertical:!0}:(g===s.ah.vertical?t.y<n.y:t.x>n.x)?{needsFlipping:!0}:null}function Ae(g,t,n,c,d,y,P,k,L,R,U,G,K,he,ce,fe){const ne=t/24,Te=g.lineOffsetX*ne,We=g.lineOffsetY*ne;let xe;if(g.numGlyphs>1){const ze=g.glyphStartIndex+g.numGlyphs,$e=g.lineStartIndex,Ke=g.lineStartIndex+g.lineLength,rt=Q(ne,k,Te,We,n,U,G,g,L,y,K,ce,fe);if(!rt)return{notEnoughRoom:!0};const xt=$i(rt.first.point,P,fe).point,yt=$i(rt.last.point,P,fe).point;if(c&&!n){const At=oe(g.writingMode,xt,yt,he);if(At)return At}xe=[rt.first];for(let At=g.glyphStartIndex+1;At<ze-1;At++)xe.push(pt(ne*k.getoffsetX(At),Te,We,n,U,G,g.segment,$e,Ke,L,y,K,ce,fe));xe.push(rt.last)}else{if(c&&!n){const $e=$i(G,d,fe).point,Ke=g.lineStartIndex+g.segment+1,rt=new s.P(L.getx(Ke),L.gety(Ke)),xt=$i(rt,d,fe),yt=xt.signedDistanceFromCamera>0?xt.point:ke(G,rt,$e,1,d,fe),At=oe(g.writingMode,$e,yt,he);if(At)return At}const ze=pt(ne*k.getoffsetX(g.glyphStartIndex),Te,We,n,U,G,g.segment,g.lineStartIndex,g.lineStartIndex+g.lineLength,L,y,K,ce,fe);if(!ze)return{notEnoughRoom:!0};xe=[ze]}for(const ze of xe)s.aj(R,ze.point,ze.angle);return{}}function ke(g,t,n,c,d,y){const P=$i(g.add(g.sub(t)._unit()),d,y).point,k=n.sub(P);return n.add(k._mult(c/k.mag()))}function Le(g,t){const{projectionCache:n,lineVertexArray:c,labelPlaneMatrix:d,tileAnchorPoint:y,distanceFromAnchor:P,getElevation:k,previousVertex:L,direction:R,absOffsetX:U}=t;if(n.projections[g])return n.projections[g];const G=new s.P(c.getx(g),c.gety(g)),K=$i(G,d,k);if(K.signedDistanceFromCamera>0)return n.projections[g]=K.point,K.point;const he=g-R;return ke(P===0?y:new s.P(c.getx(he),c.gety(he)),G,L,U-P+1,d,k)}function we(g,t,n){return g._unit()._perp()._mult(t*n)}function Ue(g,t,n,c,d,y,P,k){const{projectionCache:L,direction:R}=k;if(L.offsets[g])return L.offsets[g];const U=n.add(t);if(g+R<c||g+R>=d)return L.offsets[g]=U,U;const G=Le(g+R,k),K=we(G.sub(n),P,R),he=n.add(K),ce=G.add(K);return L.offsets[g]=s.ak(y,U,he,ce)||U,L.offsets[g]}function pt(g,t,n,c,d,y,P,k,L,R,U,G,K,he){const ce=c?g-t:g+t;let fe=ce>0?1:-1,ne=0;c&&(fe*=-1,ne=Math.PI),fe<0&&(ne+=Math.PI);let Te,We,xe=fe>0?k+P:k+P+1,ze=d,$e=d,Ke=0,rt=0;const xt=Math.abs(ce),yt=[];let At;for(;Ke+rt<=xt;){if(xe+=fe,xe<k||xe>=L)return null;Ke+=rt,$e=ze,We=Te;const Bt={projectionCache:G,lineVertexArray:R,labelPlaneMatrix:U,tileAnchorPoint:y,distanceFromAnchor:Ke,getElevation:he,previousVertex:$e,direction:fe,absOffsetX:xt};if(ze=Le(xe,Bt),n===0)yt.push($e),At=ze.sub($e);else{let di;const Si=ze.sub($e);di=Si.mag()===0?we(Le(xe+fe,Bt).sub(ze),n,fe):we(Si,n,fe),We||(We=$e.add(di)),Te=Ue(xe,di,ze,k,L,We,n,Bt),yt.push(We),At=Te.sub(We)}rt=At.mag()}const zt=At._mult((xt-Ke)/rt)._add(We||$e),Ci=ne+Math.atan2(ze.y-$e.y,ze.x-$e.x);return yt.push(zt),{point:zt,angle:K?Ci:0,path:yt}}const Qe=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function at(g,t){for(let n=0;n<g;n++){const c=t.length;t.resize(c+4),t.float32.set(Qe,3*c)}}function Jt(g,t,n){const c=t[0],d=t[1];return g[0]=n[0]*c+n[4]*d+n[12],g[1]=n[1]*c+n[5]*d+n[13],g[3]=n[3]*c+n[7]*d+n[15],g}const ri=100;class ui{constructor(t,n=new qi(t.width+200,t.height+200,25),c=new qi(t.width+200,t.height+200,25)){this.transform=t,this.grid=n,this.ignoredGrid=c,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+ri,this.screenBottomBoundary=t.height+ri,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(t,n,c,d,y,P){const k=this.projectAndGetPerspectiveRatio(d,t.anchorPointX,t.anchorPointY,P),L=c*k.perspectiveRatio,R=t.x1*L+k.point.x,U=t.y1*L+k.point.y,G=t.x2*L+k.point.x,K=t.y2*L+k.point.y;return!this.isInsideGrid(R,U,G,K)||n!=="always"&&this.grid.hitTest(R,U,G,K,n,y)||k.perspectiveRatio<this.perspectiveRatioCutoff?{box:[],offscreen:!1}:{box:[R,U,G,K],offscreen:this.isOffscreen(R,U,G,K)}}placeCollisionCircles(t,n,c,d,y,P,k,L,R,U,G,K,he,ce){const fe=[],ne=new s.P(n.anchorX,n.anchorY),Te=$i(ne,P,ce),We=ae(this.transform.cameraToCenterDistance,Te.signedDistanceFromCamera),xe=(U?y/We:y*We)/s.ao,ze=$i(ne,k,ce).point,$e=Q(xe,d,n.lineOffsetX*xe,n.lineOffsetY*xe,!1,ze,ne,n,c,k,{projections:{},offsets:{}},!1,ce);let Ke=!1,rt=!1,xt=!0;if($e){const yt=.5*K*We+he,At=new s.P(-100,-100),zt=new s.P(this.screenRightBoundary,this.screenBottomBoundary),Ci=new ai,Bt=$e.first,di=$e.last;let Si=[];for(let Ei=Bt.path.length-1;Ei>=1;Ei--)Si.push(Bt.path[Ei]);for(let Ei=1;Ei<di.path.length;Ei++)Si.push(di.path[Ei]);const Fi=2.5*yt;if(L){const Ei=Si.map(Mi=>$i(Mi,L,ce));Si=Ei.some(Mi=>Mi.signedDistanceFromCamera<=0)?[]:Ei.map(Mi=>Mi.point)}let gi=[];if(Si.length>0){const Ei=Si[0].clone(),Mi=Si[0].clone();for(let Ir=1;Ir<Si.length;Ir++)Ei.x=Math.min(Ei.x,Si[Ir].x),Ei.y=Math.min(Ei.y,Si[Ir].y),Mi.x=Math.max(Mi.x,Si[Ir].x),Mi.y=Math.max(Mi.y,Si[Ir].y);gi=Ei.x>=At.x&&Mi.x<=zt.x&&Ei.y>=At.y&&Mi.y<=zt.y?[Si]:Mi.x<At.x||Ei.x>zt.x||Mi.y<At.y||Ei.y>zt.y?[]:s.al([Si],At.x,At.y,zt.x,zt.y)}for(const Ei of gi){Ci.reset(Ei,.25*yt);let Mi=0;Mi=Ci.length<=.5*yt?1:Math.ceil(Ci.paddedLength/Fi)+1;for(let Ir=0;Ir<Mi;Ir++){const Ji=Ir/Math.max(Mi-1,1),Vn=Ci.lerp(Ji),Wr=Vn.x+ri,yr=Vn.y+ri;fe.push(Wr,yr,yt,0);const Xr=Wr-yt,Un=yr-yt,Ts=Wr+yt,eo=yr+yt;if(xt=xt&&this.isOffscreen(Xr,Un,Ts,eo),rt=rt||this.isInsideGrid(Xr,Un,Ts,eo),t!=="always"&&this.grid.hitTestCircle(Wr,yr,yt,t,G)&&(Ke=!0,!R))return{circles:[],offscreen:!1,collisionDetected:Ke}}}}return{circles:!R&&Ke||!rt||We<this.perspectiveRatioCutoff?[]:fe,offscreen:xt,collisionDetected:Ke}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const n=[];let c=1/0,d=1/0,y=-1/0,P=-1/0;for(const U of t){const G=new s.P(U.x+ri,U.y+ri);c=Math.min(c,G.x),d=Math.min(d,G.y),y=Math.max(y,G.x),P=Math.max(P,G.y),n.push(G)}const k=this.grid.query(c,d,y,P).concat(this.ignoredGrid.query(c,d,y,P)),L={},R={};for(const U of k){const G=U.key;if(L[G.bucketInstanceId]===void 0&&(L[G.bucketInstanceId]={}),L[G.bucketInstanceId][G.featureIndex])continue;const K=[new s.P(U.x1,U.y1),new s.P(U.x2,U.y1),new s.P(U.x2,U.y2),new s.P(U.x1,U.y2)];s.am(n,K)&&(L[G.bucketInstanceId][G.featureIndex]=!0,R[G.bucketInstanceId]===void 0&&(R[G.bucketInstanceId]=[]),R[G.bucketInstanceId].push(G.featureIndex))}return R}insertCollisionBox(t,n,c,d,y,P){(c?this.ignoredGrid:this.grid).insert({bucketInstanceId:d,featureIndex:y,collisionGroupID:P,overlapMode:n},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,n,c,d,y,P){const k=c?this.ignoredGrid:this.grid,L={bucketInstanceId:d,featureIndex:y,collisionGroupID:P,overlapMode:n};for(let R=0;R<t.length;R+=4)k.insertCircle(L,t[R],t[R+1],t[R+2])}projectAndGetPerspectiveRatio(t,n,c,d){let y;return d?(y=[n,c,d(n,c),1],s.af(y,y,t)):(y=[n,c,0,1],Jt(y,y,t)),{point:new s.P((y[0]/y[3]+1)/2*this.transform.width+ri,(-y[1]/y[3]+1)/2*this.transform.height+ri),perspectiveRatio:.5+this.transform.cameraToCenterDistance/y[3]*.5}}isOffscreen(t,n,c,d){return c<ri||t>=this.screenRightBoundary||d<ri||n>this.screenBottomBoundary}isInsideGrid(t,n,c,d){return c>=0&&t<this.gridRightBoundary&&d>=0&&n<this.gridBottomBoundary}getViewportMatrix(){const t=s.an([]);return s.H(t,t,[-100,-100,0]),t}}function pi(g,t,n){return t*(s.W/(g.tileSize*Math.pow(2,n-g.tileID.overscaledZ)))}class wi{constructor(t,n,c,d){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?n:-n))):d&&c?1:0,this.placed=c}isHidden(){return this.opacity===0&&!this.placed}}class Ri{constructor(t,n,c,d,y){this.text=new wi(t?t.text:null,n,c,y),this.icon=new wi(t?t.icon:null,n,d,y)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class nr{constructor(t,n,c){this.text=t,this.icon=n,this.skipFade=c}}class Pr{constructor(){this.invProjMatrix=s.F(),this.viewportMatrix=s.F(),this.circles=[]}}class li{constructor(t,n,c,d,y){this.bucketInstanceId=t,this.featureIndex=n,this.sourceLayerIndex=c,this.bucketIndex=d,this.tileID=y}}class ur{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const n=++this.maxGroupID;this.collisionGroups[t]={ID:n,predicate:c=>c.collisionGroupID===n}}return this.collisionGroups[t]}}function kr(g,t,n,c,d){const{horizontalAlign:y,verticalAlign:P}=s.at(g);return new s.P(-(y-.5)*t+c[0]*d,-(P-.5)*n+c[1]*d)}function rn(g,t,n,c,d,y){const{x1:P,x2:k,y1:L,y2:R,anchorPointX:U,anchorPointY:G}=g,K=new s.P(t,n);return c&&K._rotate(d?y:-y),{x1:P+K.x,y1:L+K.y,x2:k+K.x,y2:R+K.y,anchorPointX:U,anchorPointY:G}}class nn{constructor(t,n,c,d,y){this.transform=t.clone(),this.terrain=n,this.collisionIndex=new ui(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=c,this.retainedQueryData={},this.collisionGroups=new ur(d),this.collisionCircleArrays={},this.prevPlacement=y,y&&(y.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,n,c,d){const y=c.getBucket(n),P=c.latestFeatureIndex;if(!y||!P||n.id!==y.layerIds[0])return;const k=c.collisionBoxArray,L=y.layers[0].layout,R=Math.pow(2,this.transform.zoom-c.tileID.overscaledZ),U=c.tileSize/s.W,G=this.transform.calculatePosMatrix(c.tileID.toUnwrapped()),K=L.get("text-pitch-alignment")==="map",he=L.get("text-rotation-alignment")==="map",ce=pi(c,1,this.transform.zoom),fe=Zt(G,K,he,this.transform,ce);let ne=null;if(K){const We=Zi(G,K,he,this.transform,ce);ne=s.K([],this.transform.labelPlaneMatrix,We)}this.retainedQueryData[y.bucketInstanceId]=new li(y.bucketInstanceId,P,y.sourceLayerIndex,y.index,c.tileID);const Te={bucket:y,layout:L,posMatrix:G,textLabelPlaneMatrix:fe,labelToScreenMatrix:ne,scale:R,textPixelRatio:U,holdingForFade:c.holdingForFade(),collisionBoxArray:k,partiallyEvaluatedTextSize:s.ag(y.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(y.sourceID)};if(d)for(const We of y.sortKeyRanges){const{sortKey:xe,symbolInstanceStart:ze,symbolInstanceEnd:$e}=We;t.push({sortKey:xe,symbolInstanceStart:ze,symbolInstanceEnd:$e,parameters:Te})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:y.symbolInstances.length,parameters:Te})}attemptAnchorPlacement(t,n,c,d,y,P,k,L,R,U,G,K,he,ce,fe,ne){const Te=s.ap[t.textAnchor],We=[t.textOffset0,t.textOffset1],xe=kr(Te,c,d,We,y),ze=this.collisionIndex.placeCollisionBox(rn(n,xe.x,xe.y,P,k,this.transform.angle),G,L,R,U.predicate,ne);if((!fe||this.collisionIndex.placeCollisionBox(rn(fe,xe.x,xe.y,P,k,this.transform.angle),G,L,R,U.predicate,ne).box.length!==0)&&ze.box.length>0){let $e;if(this.prevPlacement&&this.prevPlacement.variableOffsets[K.crossTileID]&&this.prevPlacement.placements[K.crossTileID]&&this.prevPlacement.placements[K.crossTileID].text&&($e=this.prevPlacement.variableOffsets[K.crossTileID].anchor),K.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[K.crossTileID]={textOffset:We,width:c,height:d,anchor:Te,textBoxScale:y,prevAnchor:$e},this.markUsedJustification(he,Te,K,ce),he.allowVerticalPlacement&&(this.markUsedOrientation(he,ce,K),this.placedOrientations[K.crossTileID]=ce),{shift:xe,placedGlyphBoxes:ze}}}placeLayerBucketPart(t,n,c){const{bucket:d,layout:y,posMatrix:P,textLabelPlaneMatrix:k,labelToScreenMatrix:L,textPixelRatio:R,holdingForFade:U,collisionBoxArray:G,partiallyEvaluatedTextSize:K,collisionGroup:he}=t.parameters,ce=y.get("text-optional"),fe=y.get("icon-optional"),ne=s.aq(y,"text-overlap","text-allow-overlap"),Te=ne==="always",We=s.aq(y,"icon-overlap","icon-allow-overlap"),xe=We==="always",ze=y.get("text-rotation-alignment")==="map",$e=y.get("text-pitch-alignment")==="map",Ke=y.get("icon-text-fit")!=="none",rt=y.get("symbol-z-order")==="viewport-y",xt=Te&&(xe||!d.hasIconData()||fe),yt=xe&&(Te||!d.hasTextData()||ce);!d.collisionArrays&&G&&d.deserializeCollisionBoxes(G);const At=this.retainedQueryData[d.bucketInstanceId].tileID,zt=this.terrain?(Bt,di)=>this.terrain.getElevation(At,Bt,di):null,Ci=(Bt,di)=>{var Si,Fi;if(n[Bt.crossTileID])return;if(U)return void(this.placements[Bt.crossTileID]=new nr(!1,!1,!1));let gi=!1,Ei=!1,Mi=!0,Ir=null,Ji={box:null,offscreen:null},Vn={box:null,offscreen:null},Wr=null,yr=null,Xr=null,Un=0,Ts=0,eo=0;di.textFeatureIndex?Un=di.textFeatureIndex:Bt.useRuntimeCollisionCircles&&(Un=Bt.featureIndex),di.verticalTextFeatureIndex&&(Ts=di.verticalTextFeatureIndex);const ka=di.textBox;if(ka){const Fr=Rr=>{let xr=s.ah.horizontal;if(d.allowVerticalPlacement&&!Rr&&this.prevPlacement){const is=this.prevPlacement.placedOrientations[Bt.crossTileID];is&&(this.placedOrientations[Bt.crossTileID]=is,xr=is,this.markUsedOrientation(d,xr,Bt))}return xr},vr=(Rr,xr)=>{if(d.allowVerticalPlacement&&Bt.numVerticalGlyphVertices>0&&di.verticalTextBox){for(const is of d.writingModes)if(is===s.ah.vertical?(Ji=xr(),Vn=Ji):Ji=Rr(),Ji&&Ji.box&&Ji.box.length)break}else Ji=Rr()},pr=Bt.textAnchorOffsetStartIndex,ts=Bt.textAnchorOffsetEndIndex;if(ts===pr){const Rr=(xr,is)=>{const Br=this.collisionIndex.placeCollisionBox(xr,ne,R,P,he.predicate,zt);return Br&&Br.box&&Br.box.length&&(this.markUsedOrientation(d,is,Bt),this.placedOrientations[Bt.crossTileID]=is),Br};vr(()=>Rr(ka,s.ah.horizontal),()=>{const xr=di.verticalTextBox;return d.allowVerticalPlacement&&Bt.numVerticalGlyphVertices>0&&xr?Rr(xr,s.ah.vertical):{box:null,offscreen:null}}),Fr(Ji&&Ji.box&&Ji.box.length)}else{let Rr=s.ap[(Fi=(Si=this.prevPlacement)===null||Si===void 0?void 0:Si.variableOffsets[Bt.crossTileID])===null||Fi===void 0?void 0:Fi.anchor];const xr=(Br,Mr,Fl)=>{const fc=Br.x2-Br.x1,Co=Br.y2-Br.y1,So=Bt.textBoxScale,ol=Ke&&We==="never"?Mr:null;let io={box:[],offscreen:!1},Rl=ne==="never"?1:2,pc="never";Rr&&Rl++;for(let Bl=0;Bl<Rl;Bl++){for(let jl=pr;jl<ts;jl++){const al=d.textAnchorOffsets.get(jl);if(Rr&&al.textAnchor!==Rr)continue;const Nl=this.attemptAnchorPlacement(al,Br,fc,Co,So,ze,$e,R,P,he,pc,Bt,d,Fl,ol,zt);if(Nl&&(io=Nl.placedGlyphBoxes,io&&io.box&&io.box.length))return gi=!0,Ir=Nl.shift,io}Rr?Rr=null:pc=ne}return io};vr(()=>xr(ka,di.iconBox,s.ah.horizontal),()=>{const Br=di.verticalTextBox;return d.allowVerticalPlacement&&!(Ji&&Ji.box&&Ji.box.length)&&Bt.numVerticalGlyphVertices>0&&Br?xr(Br,di.verticalIconBox,s.ah.vertical):{box:null,offscreen:null}}),Ji&&(gi=Ji.box,Mi=Ji.offscreen);const is=Fr(Ji&&Ji.box);if(!gi&&this.prevPlacement){const Br=this.prevPlacement.variableOffsets[Bt.crossTileID];Br&&(this.variableOffsets[Bt.crossTileID]=Br,this.markUsedJustification(d,Br.anchor,Bt,is))}}}if(Wr=Ji,gi=Wr&&Wr.box&&Wr.box.length>0,Mi=Wr&&Wr.offscreen,Bt.useRuntimeCollisionCircles){const Fr=d.text.placedSymbolArray.get(Bt.centerJustifiedTextSymbolIndex),vr=s.ai(d.textSizeData,K,Fr),pr=y.get("text-padding");yr=this.collisionIndex.placeCollisionCircles(ne,Fr,d.lineVertexArray,d.glyphOffsetArray,vr,P,k,L,c,$e,he.predicate,Bt.collisionCircleDiameter,pr,zt),yr.circles.length&&yr.collisionDetected&&!c&&s.w("Collisions detected, but collision boxes are not shown"),gi=Te||yr.circles.length>0&&!yr.collisionDetected,Mi=Mi&&yr.offscreen}if(di.iconFeatureIndex&&(eo=di.iconFeatureIndex),di.iconBox){const Fr=vr=>{const pr=Ke&&Ir?rn(vr,Ir.x,Ir.y,ze,$e,this.transform.angle):vr;return this.collisionIndex.placeCollisionBox(pr,We,R,P,he.predicate,zt)};Vn&&Vn.box&&Vn.box.length&&di.verticalIconBox?(Xr=Fr(di.verticalIconBox),Ei=Xr.box.length>0):(Xr=Fr(di.iconBox),Ei=Xr.box.length>0),Mi=Mi&&Xr.offscreen}const to=ce||Bt.numHorizontalGlyphVertices===0&&Bt.numVerticalGlyphVertices===0,Es=fe||Bt.numIconVertices===0;if(to||Es?Es?to||(Ei=Ei&&gi):gi=Ei&&gi:Ei=gi=Ei&&gi,gi&&Wr&&Wr.box&&this.collisionIndex.insertCollisionBox(Wr.box,ne,y.get("text-ignore-placement"),d.bucketInstanceId,Vn&&Vn.box&&Ts?Ts:Un,he.ID),Ei&&Xr&&this.collisionIndex.insertCollisionBox(Xr.box,We,y.get("icon-ignore-placement"),d.bucketInstanceId,eo,he.ID),yr&&(gi&&this.collisionIndex.insertCollisionCircles(yr.circles,ne,y.get("text-ignore-placement"),d.bucketInstanceId,Un,he.ID),c)){const Fr=d.bucketInstanceId;let vr=this.collisionCircleArrays[Fr];vr===void 0&&(vr=this.collisionCircleArrays[Fr]=new Pr);for(let pr=0;pr<yr.circles.length;pr+=4)vr.circles.push(yr.circles[pr+0]),vr.circles.push(yr.circles[pr+1]),vr.circles.push(yr.circles[pr+2]),vr.circles.push(yr.collisionDetected?1:0)}if(Bt.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(d.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[Bt.crossTileID]=new nr(gi||xt,Ei||yt,Mi||d.justReloaded),n[Bt.crossTileID]=!0};if(rt){if(t.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const Bt=d.getSortedSymbolIndexes(this.transform.angle);for(let di=Bt.length-1;di>=0;--di){const Si=Bt[di];Ci(d.symbolInstances.get(Si),d.collisionArrays[Si])}}else for(let Bt=t.symbolInstanceStart;Bt<t.symbolInstanceEnd;Bt++)Ci(d.symbolInstances.get(Bt),d.collisionArrays[Bt]);if(c&&d.bucketInstanceId in this.collisionCircleArrays){const Bt=this.collisionCircleArrays[d.bucketInstanceId];s.ar(Bt.invProjMatrix,P),Bt.viewportMatrix=this.collisionIndex.getViewportMatrix()}d.justReloaded=!1}markUsedJustification(t,n,c,d){let y;y=d===s.ah.vertical?c.verticalPlacedTextSymbolIndex:{left:c.leftJustifiedTextSymbolIndex,center:c.centerJustifiedTextSymbolIndex,right:c.rightJustifiedTextSymbolIndex}[s.as(n)];const P=[c.leftJustifiedTextSymbolIndex,c.centerJustifiedTextSymbolIndex,c.rightJustifiedTextSymbolIndex,c.verticalPlacedTextSymbolIndex];for(const k of P)k>=0&&(t.text.placedSymbolArray.get(k).crossTileID=y>=0&&k!==y?0:c.crossTileID)}markUsedOrientation(t,n,c){const d=n===s.ah.horizontal||n===s.ah.horizontalOnly?n:0,y=n===s.ah.vertical?n:0,P=[c.leftJustifiedTextSymbolIndex,c.centerJustifiedTextSymbolIndex,c.rightJustifiedTextSymbolIndex];for(const k of P)t.text.placedSymbolArray.get(k).placedOrientation=d;c.verticalPlacedTextSymbolIndex&&(t.text.placedSymbolArray.get(c.verticalPlacedTextSymbolIndex).placedOrientation=y)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const n=this.prevPlacement;let c=!1;this.prevZoomAdjustment=n?n.zoomAdjustment(this.transform.zoom):0;const d=n?n.symbolFadeChange(t):1,y=n?n.opacities:{},P=n?n.variableOffsets:{},k=n?n.placedOrientations:{};for(const L in this.placements){const R=this.placements[L],U=y[L];U?(this.opacities[L]=new Ri(U,d,R.text,R.icon),c=c||R.text!==U.text.placed||R.icon!==U.icon.placed):(this.opacities[L]=new Ri(null,d,R.text,R.icon,R.skipFade),c=c||R.text||R.icon)}for(const L in y){const R=y[L];if(!this.opacities[L]){const U=new Ri(R,d,!1,!1);U.isHidden()||(this.opacities[L]=U,c=c||R.text.placed||R.icon.placed)}}for(const L in P)this.variableOffsets[L]||!this.opacities[L]||this.opacities[L].isHidden()||(this.variableOffsets[L]=P[L]);for(const L in k)this.placedOrientations[L]||!this.opacities[L]||this.opacities[L].isHidden()||(this.placedOrientations[L]=k[L]);if(n&&n.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");c?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=n?n.lastPlacementChangeTime:t)}updateLayerOpacities(t,n){const c={};for(const d of n){const y=d.getBucket(t);y&&d.latestFeatureIndex&&t.id===y.layerIds[0]&&this.updateBucketOpacities(y,c,d.collisionBoxArray)}}updateBucketOpacities(t,n,c){t.hasTextData()&&(t.text.opacityVertexArray.clear(),t.text.hasVisibleVertices=!1),t.hasIconData()&&(t.icon.opacityVertexArray.clear(),t.icon.hasVisibleVertices=!1),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const d=t.layers[0],y=d.layout,P=new Ri(null,0,!1,!1,!0),k=y.get("text-allow-overlap"),L=y.get("icon-allow-overlap"),R=d._unevaluatedLayout.hasValue("text-variable-anchor")||d._unevaluatedLayout.hasValue("text-variable-anchor-offset"),U=y.get("text-rotation-alignment")==="map",G=y.get("text-pitch-alignment")==="map",K=y.get("icon-text-fit")!=="none",he=new Ri(null,0,k&&(L||!t.hasIconData()||y.get("icon-optional")),L&&(k||!t.hasTextData()||y.get("text-optional")),!0);!t.collisionArrays&&c&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(c);const ce=(fe,ne,Te)=>{for(let We=0;We<ne/4;We++)fe.opacityVertexArray.emplaceBack(Te);fe.hasVisibleVertices=fe.hasVisibleVertices||Te!==En};for(let fe=0;fe<t.symbolInstances.length;fe++){const ne=t.symbolInstances.get(fe),{numHorizontalGlyphVertices:Te,numVerticalGlyphVertices:We,crossTileID:xe}=ne;let ze=this.opacities[xe];n[xe]?ze=P:ze||(ze=he,this.opacities[xe]=ze),n[xe]=!0;const $e=ne.numIconVertices>0,Ke=this.placedOrientations[ne.crossTileID],rt=Ke===s.ah.vertical,xt=Ke===s.ah.horizontal||Ke===s.ah.horizontalOnly;if(Te>0||We>0){const yt=sn(ze.text);ce(t.text,Te,rt?En:yt),ce(t.text,We,xt?En:yt);const At=ze.text.isHidden();[ne.rightJustifiedTextSymbolIndex,ne.centerJustifiedTextSymbolIndex,ne.leftJustifiedTextSymbolIndex].forEach(Bt=>{Bt>=0&&(t.text.placedSymbolArray.get(Bt).hidden=At||rt?1:0)}),ne.verticalPlacedTextSymbolIndex>=0&&(t.text.placedSymbolArray.get(ne.verticalPlacedTextSymbolIndex).hidden=At||xt?1:0);const zt=this.variableOffsets[ne.crossTileID];zt&&this.markUsedJustification(t,zt.anchor,ne,Ke);const Ci=this.placedOrientations[ne.crossTileID];Ci&&(this.markUsedJustification(t,"left",ne,Ci),this.markUsedOrientation(t,Ci,ne))}if($e){const yt=sn(ze.icon),At=!(K&&ne.verticalPlacedIconSymbolIndex&&rt);ne.placedIconSymbolIndex>=0&&(ce(t.icon,ne.numIconVertices,At?yt:En),t.icon.placedSymbolArray.get(ne.placedIconSymbolIndex).hidden=ze.icon.isHidden()),ne.verticalPlacedIconSymbolIndex>=0&&(ce(t.icon,ne.numVerticalIconVertices,At?En:yt),t.icon.placedSymbolArray.get(ne.verticalPlacedIconSymbolIndex).hidden=ze.icon.isHidden())}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const yt=t.collisionArrays[fe];if(yt){let At=new s.P(0,0);if(yt.textBox||yt.verticalTextBox){let Ci=!0;if(R){const Bt=this.variableOffsets[xe];Bt?(At=kr(Bt.anchor,Bt.width,Bt.height,Bt.textOffset,Bt.textBoxScale),U&&At._rotate(G?this.transform.angle:-this.transform.angle)):Ci=!1}yt.textBox&&zr(t.textCollisionBox.collisionVertexArray,ze.text.placed,!Ci||rt,At.x,At.y),yt.verticalTextBox&&zr(t.textCollisionBox.collisionVertexArray,ze.text.placed,!Ci||xt,At.x,At.y)}const zt=!!(!xt&&yt.verticalIconBox);yt.iconBox&&zr(t.iconCollisionBox.collisionVertexArray,ze.icon.placed,zt,K?At.x:0,K?At.y:0),yt.verticalIconBox&&zr(t.iconCollisionBox.collisionVertexArray,ze.icon.placed,!zt,K?At.x:0,K?At.y:0)}}}if(t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.text.opacityVertexArray.length!==t.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${t.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${t.text.layoutVertexArray.length}) / 4`);if(t.icon.opacityVertexArray.length!==t.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${t.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${t.icon.layoutVertexArray.length}) / 4`);if(t.bucketInstanceId in this.collisionCircleArrays){const fe=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=fe.invProjMatrix,t.placementViewportMatrix=fe.viewportMatrix,t.collisionCircleArray=fe.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,n){const c=this.zoomAtLastRecencyCheck===n?1-this.zoomAdjustment(n):1;return this.zoomAtLastRecencyCheck=n,this.commitTime+this.fadeDuration*c>t}setStale(){this.stale=!0}}function zr(g,t,n,c,d){g.emplaceBack(t?1:0,n?1:0,c||0,d||0),g.emplaceBack(t?1:0,n?1:0,c||0,d||0),g.emplaceBack(t?1:0,n?1:0,c||0,d||0),g.emplaceBack(t?1:0,n?1:0,c||0,d||0)}const Tn=Math.pow(2,25),Ga=Math.pow(2,24),Ao=Math.pow(2,17),Vi=Math.pow(2,16),co=Math.pow(2,9),wr=Math.pow(2,8),dn=Math.pow(2,1);function sn(g){if(g.opacity===0&&!g.placed)return 0;if(g.opacity===1&&g.placed)return 4294967295;const t=g.placed?1:0,n=Math.floor(127*g.opacity);return n*Tn+t*Ga+n*Ao+t*Vi+n*co+t*wr+n*dn+t}const En=0;class Cr{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&!t.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(t,n,c,d,y){const P=this._bucketParts;for(;this._currentTileIndex<t.length;)if(n.getBucketParts(P,d,t[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,y())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,P.sort((k,L)=>k.sortKey-L.sortKey));this._currentPartIndex<P.length;)if(n.placeLayerBucketPart(P[this._currentPartIndex],this._seenCrossTileIDs,c),this._currentPartIndex++,y())return!0;return!1}}class on{constructor(t,n,c,d,y,P,k,L){this.placement=new nn(t,n,P,k,L),this._currentPlacementIndex=c.length-1,this._forceFullPlacement=d,this._showCollisionBoxes=y,this._done=!1}isDone(){return this._done}continuePlacement(t,n,c){const d=a.now(),y=()=>!this._forceFullPlacement&&a.now()-d>2;for(;this._currentPlacementIndex>=0;){const P=n[t[this._currentPlacementIndex]],k=this.placement.collisionIndex.transform.zoom;if(P.type==="symbol"&&(!P.minzoom||P.minzoom<=k)&&(!P.maxzoom||P.maxzoom>k)){if(this._inProgressLayer||(this._inProgressLayer=new Cr(P)),this._inProgressLayer.continuePlacement(c[P.source],this.placement,this._showCollisionBoxes,P,y))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const In=512/s.W/2;class $n{constructor(t,n,c){this.tileID=t,this.bucketInstanceId=c,this._symbolsByKey={};const d=new Map;for(let y=0;y<n.length;y++){const P=n.get(y),k=P.key,L=d.get(k);L?L.push(P):d.set(k,[P])}for(const[y,P]of d){const k={positions:P.map(L=>({x:Math.floor(L.anchorX*In),y:Math.floor(L.anchorY*In)})),crossTileIDs:P.map(L=>L.crossTileID)};if(k.positions.length>128){const L=new s.au(k.positions.length,16,Uint16Array);for(const{x:R,y:U}of k.positions)L.add(R,U);L.finish(),delete k.positions,k.index=L}this._symbolsByKey[y]=k}}getScaledCoordinates(t,n){const{x:c,y:d,z:y}=this.tileID.canonical,{x:P,y:k,z:L}=n.canonical,R=In/Math.pow(2,L-y),U=(k*s.W+t.anchorY)*R,G=d*s.W*In;return{x:Math.floor((P*s.W+t.anchorX)*R-c*s.W*In),y:Math.floor(U-G)}}findMatches(t,n,c){const d=this.tileID.canonical.z<n.canonical.z?1:Math.pow(2,this.tileID.canonical.z-n.canonical.z);for(let y=0;y<t.length;y++){const P=t.get(y);if(P.crossTileID)continue;const k=this._symbolsByKey[P.key];if(!k)continue;const L=this.getScaledCoordinates(P,n);if(k.index){const R=k.index.range(L.x-d,L.y-d,L.x+d,L.y+d).sort();for(const U of R){const G=k.crossTileIDs[U];if(!c[G]){c[G]=!0,P.crossTileID=G;break}}}else if(k.positions)for(let R=0;R<k.positions.length;R++){const U=k.positions[R],G=k.crossTileIDs[R];if(Math.abs(U.x-L.x)<=d&&Math.abs(U.y-L.y)<=d&&!c[G]){c[G]=!0,P.crossTileID=G;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map(({crossTileIDs:t})=>t)}}class Sr{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class ho{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const n=Math.round((t-this.lng)/360);if(n!==0)for(const c in this.indexes){const d=this.indexes[c],y={};for(const P in d){const k=d[P];k.tileID=k.tileID.unwrapTo(k.tileID.wrap+n),y[k.tileID.key]=k}this.indexes[c]=y}this.lng=t}addBucket(t,n,c){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===n.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let y=0;y<n.symbolInstances.length;y++)n.symbolInstances.get(y).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]={});const d=this.usedCrossTileIDs[t.overscaledZ];for(const y in this.indexes){const P=this.indexes[y];if(Number(y)>t.overscaledZ)for(const k in P){const L=P[k];L.tileID.isChildOf(t)&&L.findMatches(n.symbolInstances,t,d)}else{const k=P[t.scaledTo(Number(y)).key];k&&k.findMatches(n.symbolInstances,t,d)}}for(let y=0;y<n.symbolInstances.length;y++){const P=n.symbolInstances.get(y);P.crossTileID||(P.crossTileID=c.generate(),d[P.crossTileID]=!0)}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new $n(t,n.symbolInstances,n.bucketInstanceId),!0}removeBucketCrossTileIDs(t,n){for(const c of n.getCrossTileIDsLists())for(const d of c)delete this.usedCrossTileIDs[t][d]}removeStaleBuckets(t){let n=!1;for(const c in this.indexes){const d=this.indexes[c];for(const y in d)t[d[y].bucketInstanceId]||(this.removeBucketCrossTileIDs(c,d[y]),delete d[y],n=!0)}return n}}class vs{constructor(){this.layerIndexes={},this.crossTileIDs=new Sr,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,n,c){let d=this.layerIndexes[t.id];d===void 0&&(d=this.layerIndexes[t.id]=new ho);let y=!1;const P={};d.handleWrapJump(c);for(const k of n){const L=k.getBucket(t);L&&t.id===L.layerIds[0]&&(L.bucketInstanceId||(L.bucketInstanceId=++this.maxBucketInstanceId),d.addBucket(k.tileID,L,this.crossTileIDs)&&(y=!0),P[L.bucketInstanceId]=!0)}return d.removeStaleBuckets(P)&&(y=!0),y}pruneUnusedLayers(t){const n={};t.forEach(c=>{n[c]=!0});for(const c in this.layerIndexes)n[c]||delete this.layerIndexes[c]}}const or=(g,t)=>s.t(g,t&&t.filter(n=>n.identifier!=="source.canvas")),uo=s.av();class an extends s.E{constructor(t,n={}){super(),this._rtlPluginLoaded=()=>{for(const c in this.sourceCaches){const d=this.sourceCaches[c].getSource().type;d!=="vector"&&d!=="geojson"||this.sourceCaches[c].reload()}},this.map=t,this.dispatcher=new et(Ne(),t._getMapId()),this.dispatcher.registerMessageHandler("GG",(c,d)=>this.getGlyphs(c,d)),this.dispatcher.registerMessageHandler("GI",(c,d)=>this.getImages(c,d)),this.imageManager=new ct,this.imageManager.setEventedParent(this),this.glyphManager=new st(t._requestManager,n.localIdeographFontFamily),this.lineAtlas=new me(256,512),this.crossTileSymbolIndex=new vs,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new s.aw,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("SR",s.ax()),ut().on(mi,this._rtlPluginLoaded),this.on("data",c=>{if(c.dataType!=="source"||c.sourceDataType!=="metadata")return;const d=this.sourceCaches[c.sourceId];if(!d)return;const y=d.getSource();if(y&&y.vectorLayerIds)for(const P in this._layers){const k=this._layers[P];k.source===y.id&&this._validateLayer(k)}})}loadURL(t,n={},c){this.fire(new s.k("dataloading",{dataType:"style"})),n.validate=typeof n.validate!="boolean"||n.validate;const d=this.map._requestManager.transformRequest(t,"Style");this._loadStyleRequest=new AbortController,s.h(d,this._loadStyleRequest).then(y=>{this._loadStyleRequest=null,this._load(y.data,n,c)}).catch(y=>{this._loadStyleRequest=null,y&&this.fire(new s.j(y))})}loadJSON(t,n={},c){this.fire(new s.k("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,a.frameAsync(this._frameRequest).then(()=>{this._frameRequest=null,n.validate=n.validate!==!1,this._load(t,n,c)}).catch(()=>{})}loadEmpty(){this.fire(new s.k("dataloading",{dataType:"style"})),this._load(uo,{validate:!1})}_load(t,n,c){var d;const y=n.transformStyle?n.transformStyle(c,t):t;if(!n.validate||!or(this,s.x(y))){this._loaded=!0,this.stylesheet=y;for(const P in y.sources)this.addSource(P,y.sources[P],{validate:!1});y.sprite?this._loadSprite(y.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(y.glyphs),this._createLayers(),this.light=new be(this.stylesheet.light),this.map.setTerrain((d=this.stylesheet.terrain)!==null&&d!==void 0?d:null),this.fire(new s.k("data",{dataType:"style"})),this.fire(new s.k("style.load"))}}_createLayers(){const t=s.ay(this.stylesheet.layers);this.dispatcher.broadcast("SL",t),this._order=t.map(n=>n.id),this._layers={},this._serializedLayers=null;for(const n of t){const c=s.az(n);c.setEventedParent(this,{layer:{id:n.id}}),this._layers[n.id]=c}}_loadSprite(t,n=!1,c=void 0){let d;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,function(y,P,k,L){return s._(this,void 0,void 0,function*(){const R=Ye(y),U=k>1?"@2x":"",G={},K={};for(const{id:he,url:ce}of R){const fe=P.transformRequest(P.normalizeSpriteURL(ce,U,".json"),"SpriteJSON");G[he]=s.h(fe,L);const ne=P.transformRequest(P.normalizeSpriteURL(ce,U,".png"),"SpriteImage");K[he]=A.getImage(ne,L)}return yield Promise.all([...Object.values(G),...Object.values(K)]),function(he,ce){return s._(this,void 0,void 0,function*(){const fe={};for(const ne in he){fe[ne]={};const Te=a.getImageCanvasContext((yield ce[ne]).data),We=(yield he[ne]).data;for(const xe in We){const{width:ze,height:$e,x:Ke,y:rt,sdf:xt,pixelRatio:yt,stretchX:At,stretchY:zt,content:Ci}=We[xe];fe[ne][xe]={data:null,pixelRatio:yt,sdf:xt,stretchX:At,stretchY:zt,content:Ci,spriteData:{width:ze,height:$e,x:Ke,y:rt,context:Te}}}}return fe})}(G,K)})}(t,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then(y=>{if(this._spriteRequest=null,y)for(const P in y){this._spritesImagesIds[P]=[];const k=this._spritesImagesIds[P]?this._spritesImagesIds[P].filter(L=>!(L in y)):[];for(const L of k)this.imageManager.removeImage(L),this._changedImages[L]=!0;for(const L in y[P]){const R=P==="default"?L:`${P}:${L}`;this._spritesImagesIds[P].push(R),R in this.imageManager.images?this.imageManager.updateImage(R,y[P][L],!1):this.imageManager.addImage(R,y[P][L]),n&&(this._changedImages[R]=!0)}}}).catch(y=>{this._spriteRequest=null,d=y,this.fire(new s.j(d))}).finally(()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),n&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.k("data",{dataType:"style"})),c&&c(d)})}_unloadSprite(){for(const t of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(t),this._changedImages[t]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.k("data",{dataType:"style"}))}_validateLayer(t){const n=this.sourceCaches[t.source];if(!n)return;const c=t.sourceLayer;if(!c)return;const d=n.getSource();(d.type==="geojson"||d.vectorLayerIds&&d.vectorLayerIds.indexOf(c)===-1)&&this.fire(new s.j(new Error(`Source layer "${c}" does not exist on source "${d.id}" as specified by style layer "${t.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const t in this.sourceCaches)if(!this.sourceCaches[t].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(t){const n=this._serializedAllLayers();if(!t||t.length===0)return Object.values(n);const c=[];for(const d of t)n[d]&&c.push(n[d]);return c}_serializedAllLayers(){let t=this._serializedLayers;if(t)return t;t=this._serializedLayers={};const n=Object.keys(this._layers);for(const c of n){const d=this._layers[c];d.type!=="custom"&&(t[c]=d.serialize())}return t}hasTransitions(){if(this.light&&this.light.hasTransition())return!0;for(const t in this.sourceCaches)if(this.sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(t){if(!this._loaded)return;const n=this._changed;if(n){const d=Object.keys(this._updatedLayers),y=Object.keys(this._removedLayers);(d.length||y.length)&&this._updateWorkerLayers(d,y);for(const P in this._updatedSources){const k=this._updatedSources[P];if(k==="reload")this._reloadSource(P);else{if(k!=="clear")throw new Error(`Invalid action ${k}`);this._clearSource(P)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const P in this._updatedPaintProps)this._layers[P].updateTransitions(t);this.light.updateTransitions(t),this._resetUpdates()}const c={};for(const d in this.sourceCaches){const y=this.sourceCaches[d];c[d]=y.used,y.used=!1}for(const d of this._order){const y=this._layers[d];y.recalculate(t,this._availableImages),!y.isHidden(t.zoom)&&y.source&&(this.sourceCaches[y.source].used=!0)}for(const d in c){const y=this.sourceCaches[d];!!c[d]!=!!y.used&&y.fire(new s.k("data",{sourceDataType:"visibility",dataType:"source",sourceId:d}))}this.light.recalculate(t),this.z=t.zoom,n&&this.fire(new s.k("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=Object.keys(this._changedImages);if(t.length){for(const n in this.sourceCaches)this.sourceCaches[n].reloadTilesForDependencies(["icons","patterns"],t);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const t in this.sourceCaches)this.sourceCaches[t].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(t,n){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(t),removedIds:n})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(t,n={}){var c;this._checkLoaded();const d=this.serialize();if(t=n.transformStyle?n.transformStyle(d,t):t,((c=n.validate)===null||c===void 0||c)&&or(this,s.x(t)))return!1;(t=s.aA(t)).layers=s.ay(t.layers);const y=s.aB(d,t),P=this._getOperationsToPerform(y);if(P.unimplemented.length>0)throw new Error(`Unimplemented: ${P.unimplemented.join(", ")}.`);if(P.operations.length===0)return!1;for(const k of P.operations)k();return this.stylesheet=t,this._serializedLayers=null,!0}_getOperationsToPerform(t){const n=[],c=[];for(const d of t)switch(d.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":continue;case"addLayer":n.push(()=>this.addLayer.apply(this,d.args));break;case"removeLayer":n.push(()=>this.removeLayer.apply(this,d.args));break;case"setPaintProperty":n.push(()=>this.setPaintProperty.apply(this,d.args));break;case"setLayoutProperty":n.push(()=>this.setLayoutProperty.apply(this,d.args));break;case"setFilter":n.push(()=>this.setFilter.apply(this,d.args));break;case"addSource":n.push(()=>this.addSource.apply(this,d.args));break;case"removeSource":n.push(()=>this.removeSource.apply(this,d.args));break;case"setLayerZoomRange":n.push(()=>this.setLayerZoomRange.apply(this,d.args));break;case"setLight":n.push(()=>this.setLight.apply(this,d.args));break;case"setGeoJSONSourceData":n.push(()=>this.setGeoJSONSourceData.apply(this,d.args));break;case"setGlyphs":n.push(()=>this.setGlyphs.apply(this,d.args));break;case"setSprite":n.push(()=>this.setSprite.apply(this,d.args));break;case"setTerrain":n.push(()=>this.map.setTerrain.apply(this,d.args));break;case"setTransition":n.push(()=>{});break;default:c.push(d.command)}return{operations:n,unimplemented:c}}addImage(t,n){if(this.getImage(t))return this.fire(new s.j(new Error(`An image named "${t}" already exists.`)));this.imageManager.addImage(t,n),this._afterImageUpdated(t)}updateImage(t,n){this.imageManager.updateImage(t,n)}getImage(t){return this.imageManager.getImage(t)}removeImage(t){if(!this.getImage(t))return this.fire(new s.j(new Error(`An image named "${t}" does not exist.`)));this.imageManager.removeImage(t),this._afterImageUpdated(t)}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(),this._changedImages[t]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.k("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(t,n,c={}){if(this._checkLoaded(),this.sourceCaches[t]!==void 0)throw new Error(`Source "${t}" already exists.`);if(!n.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(n).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(n.type)>=0&&this._validate(s.x.source,`sources.${t}`,n,null,c))return;this.map&&this.map._collectResourceTiming&&(n.collectResourceTiming=!0);const d=this.sourceCaches[t]=new Qi(t,n,this.dispatcher);d.style=this,d.setEventedParent(this,()=>({isSourceLoaded:d.loaded(),source:d.serialize(),sourceId:t})),d.onAdd(this.map),this._changed=!0}removeSource(t){if(this._checkLoaded(),this.sourceCaches[t]===void 0)throw new Error("There is no source with this ID");for(const c in this._layers)if(this._layers[c].source===t)return this.fire(new s.j(new Error(`Source "${t}" cannot be removed while layer "${c}" is using it.`)));const n=this.sourceCaches[t];delete this.sourceCaches[t],delete this._updatedSources[t],n.fire(new s.k("data",{sourceDataType:"metadata",dataType:"source",sourceId:t})),n.setEventedParent(null),n.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(t,n){if(this._checkLoaded(),this.sourceCaches[t]===void 0)throw new Error(`There is no source with this ID=${t}`);const c=this.sourceCaches[t].getSource();if(c.type!=="geojson")throw new Error(`geojsonSource.type is ${c.type}, which is !== 'geojson`);c.setData(n),this._changed=!0}getSource(t){return this.sourceCaches[t]&&this.sourceCaches[t].getSource()}addLayer(t,n,c={}){this._checkLoaded();const d=t.id;if(this.getLayer(d))return void this.fire(new s.j(new Error(`Layer "${d}" already exists on this map.`)));let y;if(t.type==="custom"){if(or(this,s.aC(t)))return;y=s.az(t)}else{if("source"in t&&typeof t.source=="object"&&(this.addSource(d,t.source),t=s.aA(t),t=s.e(t,{source:d})),this._validate(s.x.layer,`layers.${d}`,t,{arrayIndex:-1},c))return;y=s.az(t),this._validateLayer(y),y.setEventedParent(this,{layer:{id:d}})}const P=n?this._order.indexOf(n):this._order.length;if(n&&P===-1)this.fire(new s.j(new Error(`Cannot add layer "${d}" before non-existing layer "${n}".`)));else{if(this._order.splice(P,0,d),this._layerOrderChanged=!0,this._layers[d]=y,this._removedLayers[d]&&y.source&&y.type!=="custom"){const k=this._removedLayers[d];delete this._removedLayers[d],k.type!==y.type?this._updatedSources[y.source]="clear":(this._updatedSources[y.source]="reload",this.sourceCaches[y.source].pause())}this._updateLayer(y),y.onAdd&&y.onAdd(this.map)}}moveLayer(t,n){if(this._checkLoaded(),this._changed=!0,!this._layers[t])return void this.fire(new s.j(new Error(`The layer '${t}' does not exist in the map's style and cannot be moved.`)));if(t===n)return;const c=this._order.indexOf(t);this._order.splice(c,1);const d=n?this._order.indexOf(n):this._order.length;n&&d===-1?this.fire(new s.j(new Error(`Cannot move layer "${t}" before non-existing layer "${n}".`))):(this._order.splice(d,0,t),this._layerOrderChanged=!0)}removeLayer(t){this._checkLoaded();const n=this._layers[t];if(!n)return void this.fire(new s.j(new Error(`Cannot remove non-existing layer "${t}".`)));n.setEventedParent(null);const c=this._order.indexOf(t);this._order.splice(c,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[t]=n,delete this._layers[t],this._serializedLayers&&delete this._serializedLayers[t],delete this._updatedLayers[t],delete this._updatedPaintProps[t],n.onRemove&&n.onRemove(this.map)}getLayer(t){return this._layers[t]}getLayersOrder(){return[...this._order]}hasLayer(t){return t in this._layers}setLayerZoomRange(t,n,c){this._checkLoaded();const d=this.getLayer(t);d?d.minzoom===n&&d.maxzoom===c||(n!=null&&(d.minzoom=n),c!=null&&(d.maxzoom=c),this._updateLayer(d)):this.fire(new s.j(new Error(`Cannot set the zoom range of non-existing layer "${t}".`)))}setFilter(t,n,c={}){this._checkLoaded();const d=this.getLayer(t);if(d){if(!s.aD(d.filter,n))return n==null?(d.filter=void 0,void this._updateLayer(d)):void(this._validate(s.x.filter,`layers.${d.id}.filter`,n,null,c)||(d.filter=s.aA(n),this._updateLayer(d)))}else this.fire(new s.j(new Error(`Cannot filter non-existing layer "${t}".`)))}getFilter(t){return s.aA(this.getLayer(t).filter)}setLayoutProperty(t,n,c,d={}){this._checkLoaded();const y=this.getLayer(t);y?s.aD(y.getLayoutProperty(n),c)||(y.setLayoutProperty(n,c,d),this._updateLayer(y)):this.fire(new s.j(new Error(`Cannot style non-existing layer "${t}".`)))}getLayoutProperty(t,n){const c=this.getLayer(t);if(c)return c.getLayoutProperty(n);this.fire(new s.j(new Error(`Cannot get style of non-existing layer "${t}".`)))}setPaintProperty(t,n,c,d={}){this._checkLoaded();const y=this.getLayer(t);y?s.aD(y.getPaintProperty(n),c)||(y.setPaintProperty(n,c,d)&&this._updateLayer(y),this._changed=!0,this._updatedPaintProps[t]=!0,this._serializedLayers=null):this.fire(new s.j(new Error(`Cannot style non-existing layer "${t}".`)))}getPaintProperty(t,n){return this.getLayer(t).getPaintProperty(n)}setFeatureState(t,n){this._checkLoaded();const c=t.source,d=t.sourceLayer,y=this.sourceCaches[c];if(y===void 0)return void this.fire(new s.j(new Error(`The source '${c}' does not exist in the map's style.`)));const P=y.getSource().type;P==="geojson"&&d?this.fire(new s.j(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):P!=="vector"||d?(t.id===void 0&&this.fire(new s.j(new Error("The feature id parameter must be provided."))),y.setFeatureState(d,t.id,n)):this.fire(new s.j(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(t,n){this._checkLoaded();const c=t.source,d=this.sourceCaches[c];if(d===void 0)return void this.fire(new s.j(new Error(`The source '${c}' does not exist in the map's style.`)));const y=d.getSource().type,P=y==="vector"?t.sourceLayer:void 0;y!=="vector"||P?n&&typeof t.id!="string"&&typeof t.id!="number"?this.fire(new s.j(new Error("A feature id is required to remove its specific state property."))):d.removeFeatureState(P,t.id,n):this.fire(new s.j(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(t){this._checkLoaded();const n=t.source,c=t.sourceLayer,d=this.sourceCaches[n];if(d!==void 0)return d.getSource().type!=="vector"||c?(t.id===void 0&&this.fire(new s.j(new Error("The feature id parameter must be provided."))),d.getFeatureState(c,t.id)):void this.fire(new s.j(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new s.j(new Error(`The source '${n}' does not exist in the map's style.`)))}getTransition(){return s.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const t=s.aE(this.sourceCaches,y=>y.serialize()),n=this._serializeByIds(this._order),c=this.map.getTerrain()||void 0,d=this.stylesheet;return s.aF({version:d.version,name:d.name,metadata:d.metadata,light:d.light,center:d.center,zoom:d.zoom,bearing:d.bearing,pitch:d.pitch,sprite:d.sprite,glyphs:d.glyphs,transition:d.transition,sources:t,layers:n,terrain:c},y=>y!==void 0)}_updateLayer(t){this._updatedLayers[t.id]=!0,t.source&&!this._updatedSources[t.source]&&this.sourceCaches[t.source].getSource().type!=="raster"&&(this._updatedSources[t.source]="reload",this.sourceCaches[t.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(t){const n=P=>this._layers[P].type==="fill-extrusion",c={},d=[];for(let P=this._order.length-1;P>=0;P--){const k=this._order[P];if(n(k)){c[k]=P;for(const L of t){const R=L[k];if(R)for(const U of R)d.push(U)}}}d.sort((P,k)=>k.intersectionZ-P.intersectionZ);const y=[];for(let P=this._order.length-1;P>=0;P--){const k=this._order[P];if(n(k))for(let L=d.length-1;L>=0;L--){const R=d[L].feature;if(c[R.layer.id]<P)break;y.push(R),d.pop()}else for(const L of t){const R=L[k];if(R)for(const U of R)y.push(U.feature)}}return y}queryRenderedFeatures(t,n,c){n&&n.filter&&this._validate(s.x.filter,"queryRenderedFeatures.filter",n.filter,null,n);const d={};if(n&&n.layers){if(!Array.isArray(n.layers))return this.fire(new s.j(new Error("parameters.layers must be an Array."))),[];for(const k of n.layers){const L=this._layers[k];if(!L)return this.fire(new s.j(new Error(`The layer '${k}' does not exist in the map's style and cannot be queried for features.`))),[];d[L.source]=!0}}const y=[];n.availableImages=this._availableImages;const P=this._serializedAllLayers();for(const k in this.sourceCaches)n.layers&&!d[k]||y.push(_t(this.sourceCaches[k],this._layers,P,t,n,c));return this.placement&&y.push(function(k,L,R,U,G,K,he){const ce={},fe=K.queryRenderedSymbols(U),ne=[];for(const Te of Object.keys(fe).map(Number))ne.push(he[Te]);ne.sort(It);for(const Te of ne){const We=Te.featureIndex.lookupSymbolFeatures(fe[Te.bucketInstanceId],L,Te.bucketIndex,Te.sourceLayerIndex,G.filter,G.layers,G.availableImages,k);for(const xe in We){const ze=ce[xe]=ce[xe]||[],$e=We[xe];$e.sort((Ke,rt)=>{const xt=Te.featureSortOrder;if(xt){const yt=xt.indexOf(Ke.featureIndex);return xt.indexOf(rt.featureIndex)-yt}return rt.featureIndex-Ke.featureIndex});for(const Ke of $e)ze.push(Ke)}}for(const Te in ce)ce[Te].forEach(We=>{const xe=We.feature,ze=R[k[Te].source].getFeatureState(xe.layer["source-layer"],xe.id);xe.source=xe.layer.source,xe.layer["source-layer"]&&(xe.sourceLayer=xe.layer["source-layer"]),xe.state=ze});return ce}(this._layers,P,this.sourceCaches,t,n,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(y)}querySourceFeatures(t,n){n&&n.filter&&this._validate(s.x.filter,"querySourceFeatures.filter",n.filter,null,n);const c=this.sourceCaches[t];return c?function(d,y){const P=d.getRenderableIds().map(R=>d.getTileByID(R)),k=[],L={};for(let R=0;R<P.length;R++){const U=P[R],G=U.tileID.canonical.key;L[G]||(L[G]=!0,U.querySourceFeatures(k,y))}return k}(c,n):[]}getLight(){return this.light.getLight()}setLight(t,n={}){this._checkLoaded();const c=this.light.getLight();let d=!1;for(const P in t)if(!s.aD(t[P],c[P])){d=!0;break}if(!d)return;const y={now:a.now(),transition:s.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(t,n),this.light.updateTransitions(y)}_validate(t,n,c,d,y={}){return(!y||y.validate!==!1)&&or(this,t.call(s.x,s.e({key:n,style:this.serialize(),value:c,styleSpec:s.v},d)))}_remove(t=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),ut().off(mi,this._rtlPluginLoaded);for(const n in this._layers)this._layers[n].setEventedParent(null);for(const n in this.sourceCaches){const c=this.sourceCaches[n];c.setEventedParent(null),c.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),t&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(t)}_clearSource(t){this.sourceCaches[t].clearTiles()}_reloadSource(t){this.sourceCaches[t].resume(),this.sourceCaches[t].reload()}_updateSources(t){for(const n in this.sourceCaches)this.sourceCaches[n].update(t,this.map.terrain)}_generateCollisionBoxes(){for(const t in this.sourceCaches)this._reloadSource(t)}_updatePlacement(t,n,c,d,y=!1){let P=!1,k=!1;const L={};for(const R of this._order){const U=this._layers[R];if(U.type!=="symbol")continue;if(!L[U.source]){const K=this.sourceCaches[U.source];L[U.source]=K.getRenderableIds(!0).map(he=>K.getTileByID(he)).sort((he,ce)=>ce.tileID.overscaledZ-he.tileID.overscaledZ||(he.tileID.isLessThan(ce.tileID)?-1:1))}const G=this.crossTileSymbolIndex.addLayer(U,L[U.source],t.center.lng);P=P||G}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((y=y||this._layerOrderChanged||c===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(a.now(),t.zoom))&&(this.pauseablePlacement=new on(t,this.map.terrain,this._order,y,n,c,d,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,L),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(a.now()),k=!0),P&&this.pauseablePlacement.placement.setStale()),k||P)for(const R of this._order){const U=this._layers[R];U.type==="symbol"&&this.placement.updateLayerOpacities(U,L[U.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(a.now())}_releaseSymbolFadeTiles(){for(const t in this.sourceCaches)this.sourceCaches[t].releaseSymbolFadeTiles()}getImages(t,n){return s._(this,void 0,void 0,function*(){const c=yield this.imageManager.getImages(n.icons);this._updateTilesForChangedImages();const d=this.sourceCaches[n.source];return d&&d.setDependencies(n.tileID.key,n.type,n.icons),c})}getGlyphs(t,n){return s._(this,void 0,void 0,function*(){const c=yield this.glyphManager.getGlyphs(n.stacks),d=this.sourceCaches[n.source];return d&&d.setDependencies(n.tileID.key,n.type,[""]),c})}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(t,n={}){this._checkLoaded(),t&&this._validate(s.x.glyphs,"glyphs",t,null,n)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=t,this.glyphManager.entries={},this.glyphManager.setURL(t))}addSprite(t,n,c={},d){this._checkLoaded();const y=[{id:t,url:n}],P=[...Ye(this.stylesheet.sprite),...y];this._validate(s.x.sprite,"sprite",P,null,c)||(this.stylesheet.sprite=P,this._loadSprite(y,!0,d))}removeSprite(t){this._checkLoaded();const n=Ye(this.stylesheet.sprite);if(n.find(c=>c.id===t)){if(this._spritesImagesIds[t])for(const c of this._spritesImagesIds[t])this.imageManager.removeImage(c),this._changedImages[c]=!0;n.splice(n.findIndex(c=>c.id===t),1),this.stylesheet.sprite=n.length>0?n:void 0,delete this._spritesImagesIds[t],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.k("data",{dataType:"style"}))}else this.fire(new s.j(new Error(`Sprite "${t}" doesn't exists on this map.`)))}getSprite(){return Ye(this.stylesheet.sprite)}setSprite(t,n={},c){this._checkLoaded(),t&&this._validate(s.x.sprite,"sprite",t,null,n)||(this.stylesheet.sprite=t,t?this._loadSprite(t,!0,c):(this._unloadSprite(),c&&c(null)))}}var fo=s.X([{name:"a_pos",type:"Int16",components:2}]),Rn="attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform float u_ele_delta;varying vec2 v_texture_pos;varying float v_depth;void main() {float extent=8192.0;float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/extent;gl_Position=u_matrix*vec4(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta,1.0);v_depth=gl_Position.z/gl_Position.w;}";const po={prelude:Wi(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture2D(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture2D(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}`),background:Wi(`uniform vec4 u_color;uniform float u_opacity;void main() {gl_FragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),backgroundPattern:Wi(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:Wi(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));gl_FragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);float ele=get_elevation(circle_center);v_visibility=calculate_visibility(u_matrix*vec4(circle_center,ele,1.0));if (u_pitch_with_map) {vec2 corner_position=circle_center;if (u_scale_with_map) {corner_position+=extrude*(radius+stroke_width)*u_extrude_scale;} else {vec4 projected_center=u_matrix*vec4(circle_center,0,1);corner_position+=extrude*(radius+stroke_width)*u_extrude_scale*(projected_center.w/u_camera_to_center_distance);}gl_Position=u_matrix*vec4(corner_position,ele,1);} else {gl_Position=u_matrix*vec4(circle_center,ele,1);if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:Wi("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Wi(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec4 pos=vec4(floor(a_pos*0.5)+extrude,0,1);gl_Position=u_matrix*pos;}`),heatmapTexture:Wi(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:Wi("varying float v_placed;varying float v_notUsed;void main() {float alpha=0.5;gl_FragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {gl_FragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {gl_FragColor*=.1;}}","attribute vec2 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_anchor_pos,0,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);gl_Position=u_matrix*vec4(a_pos,get_elevation(a_pos),1.0);gl_Position.xy+=(a_extrude+a_shift)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Wi("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Wi("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,get_elevation(a_pos),1);}"),fill:Wi(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_FragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);}`),fillOutline:Wi(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=outline_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillOutlinePattern:Wi(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillPattern:Wi(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:Wi(`varying vec4 v_color;void main() {gl_FragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t > 0.0 ? height : base,1);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:Wi(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);gl_FragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float z=t > 0.0 ? height : base;gl_Position=u_matrix*vec4(a_pos,z,1);vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:Wi(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Wi(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;
#define PI 3.141592653589793
void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;}"),line:Wi(`uniform lowp float u_device_pixel_ratio;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp float v_linesofar;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:Wi(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture2D(u_image,v_uv);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_uv_x;attribute float a_split_index;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:Wi(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);gl_FragColor=color*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:Wi(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture2D(u_image,v_tex_a).a;float sdfdist_b=texture2D(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}`),raster:Wi(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);gl_FragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos0=(((a_texture_pos/8192.0)-0.5)/u_buffer_scale )+0.5;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}"),symbolIcon:Wi(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0),z,1.0);v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:Wi(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset),z,1.0);float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:Wi(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale),z,1.0);float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:Wi("uniform sampler2D u_texture;varying vec2 v_texture_pos;void main() {gl_FragColor=texture2D(u_texture,v_texture_pos);}",Rn),terrainDepth:Wi("varying float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {gl_FragColor=pack(v_depth);}",Rn),terrainCoords:Wi("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;varying vec2 v_texture_pos;void main() {vec4 rgba=texture2D(u_texture,v_texture_pos);gl_FragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}",Rn)};function Wi(g,t){const n=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,c=t.match(/attribute ([\w]+) ([\w]+)/g),d=g.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),y=t.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),P=y?y.concat(d):d,k={};return{fragmentSource:g=g.replace(n,(L,R,U,G,K)=>(k[K]=!0,R==="define"?`
#ifndef HAS_UNIFORM_u_${K}
varying ${U} ${G} ${K};
#else
uniform ${U} ${G} u_${K};
#endif
`:`
#ifdef HAS_UNIFORM_u_${K}
    ${U} ${G} ${K} = u_${K};
#endif
`)),vertexSource:t=t.replace(n,(L,R,U,G,K)=>{const he=G==="float"?"vec2":"vec4",ce=K.match(/color/)?"color":he;return k[K]?R==="define"?`
#ifndef HAS_UNIFORM_u_${K}
uniform lowp float u_${K}_t;
attribute ${U} ${he} a_${K};
varying ${U} ${G} ${K};
#else
uniform ${U} ${G} u_${K};
#endif
`:ce==="vec4"?`
#ifndef HAS_UNIFORM_u_${K}
    ${K} = a_${K};
#else
    ${U} ${G} ${K} = u_${K};
#endif
`:`
#ifndef HAS_UNIFORM_u_${K}
    ${K} = unpack_mix_${ce}(a_${K}, u_${K}_t);
#else
    ${U} ${G} ${K} = u_${K};
#endif
`:R==="define"?`
#ifndef HAS_UNIFORM_u_${K}
uniform lowp float u_${K}_t;
attribute ${U} ${he} a_${K};
#else
uniform ${U} ${G} u_${K};
#endif
`:ce==="vec4"?`
#ifndef HAS_UNIFORM_u_${K}
    ${U} ${G} ${K} = a_${K};
#else
    ${U} ${G} ${K} = u_${K};
#endif
`:`
#ifndef HAS_UNIFORM_u_${K}
    ${U} ${G} ${K} = unpack_mix_${ce}(a_${K}, u_${K}_t);
#else
    ${U} ${G} ${K} = u_${K};
#endif
`}),staticAttributes:c,staticUniforms:P}}class Mo{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(t,n,c,d,y,P,k,L,R){this.context=t;let U=this.boundPaintVertexBuffers.length!==d.length;for(let G=0;!U&&G<d.length;G++)this.boundPaintVertexBuffers[G]!==d[G]&&(U=!0);!this.vao||this.boundProgram!==n||this.boundLayoutVertexBuffer!==c||U||this.boundIndexBuffer!==y||this.boundVertexOffset!==P||this.boundDynamicVertexBuffer!==k||this.boundDynamicVertexBuffer2!==L||this.boundDynamicVertexBuffer3!==R?this.freshBind(n,c,d,y,P,k,L,R):(t.bindVertexArray.set(this.vao),k&&k.bind(),y&&y.dynamicDraw&&y.bind(),L&&L.bind(),R&&R.bind())}freshBind(t,n,c,d,y,P,k,L){const R=t.numAttributes,U=this.context,G=U.gl;this.vao&&this.destroy(),this.vao=U.createVertexArray(),U.bindVertexArray.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=n,this.boundPaintVertexBuffers=c,this.boundIndexBuffer=d,this.boundVertexOffset=y,this.boundDynamicVertexBuffer=P,this.boundDynamicVertexBuffer2=k,this.boundDynamicVertexBuffer3=L,n.enableAttributes(G,t);for(const K of c)K.enableAttributes(G,t);P&&P.enableAttributes(G,t),k&&k.enableAttributes(G,t),L&&L.enableAttributes(G,t),n.bind(),n.setVertexAttribPointers(G,t,y);for(const K of c)K.bind(),K.setVertexAttribPointers(G,t,y);P&&(P.bind(),P.setVertexAttribPointers(G,t,y)),d&&d.bind(),k&&(k.bind(),k.setVertexAttribPointers(G,t,y)),L&&(L.bind(),L.setVertexAttribPointers(G,t,y)),U.currentNumAttributes=R}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}function ss(g){const t=[];for(let n=0;n<g.length;n++){if(g[n]===null)continue;const c=g[n].split(" ");t.push(c.pop())}return t}class E{constructor(t,n,c,d,y,P){const k=t.gl;this.program=k.createProgram();const L=ss(n.staticAttributes),R=c?c.getBinderAttributes():[],U=L.concat(R),G=po.prelude.staticUniforms?ss(po.prelude.staticUniforms):[],K=n.staticUniforms?ss(n.staticUniforms):[],he=c?c.getBinderUniforms():[],ce=G.concat(K).concat(he),fe=[];for(const Ke of ce)fe.indexOf(Ke)<0&&fe.push(Ke);const ne=c?c.defines():[];y&&ne.push("#define OVERDRAW_INSPECTOR;"),P&&ne.push("#define TERRAIN3D;");const Te=ne.concat(po.prelude.fragmentSource,n.fragmentSource).join(`
`),We=ne.concat(po.prelude.vertexSource,n.vertexSource).join(`
`),xe=k.createShader(k.FRAGMENT_SHADER);if(k.isContextLost())return void(this.failedToCreate=!0);if(k.shaderSource(xe,Te),k.compileShader(xe),!k.getShaderParameter(xe,k.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${k.getShaderInfoLog(xe)}`);k.attachShader(this.program,xe);const ze=k.createShader(k.VERTEX_SHADER);if(k.isContextLost())return void(this.failedToCreate=!0);if(k.shaderSource(ze,We),k.compileShader(ze),!k.getShaderParameter(ze,k.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${k.getShaderInfoLog(ze)}`);k.attachShader(this.program,ze),this.attributes={};const $e={};this.numAttributes=U.length;for(let Ke=0;Ke<this.numAttributes;Ke++)U[Ke]&&(k.bindAttribLocation(this.program,Ke,U[Ke]),this.attributes[U[Ke]]=Ke);if(k.linkProgram(this.program),!k.getProgramParameter(this.program,k.LINK_STATUS))throw new Error(`Program failed to link: ${k.getProgramInfoLog(this.program)}`);k.deleteShader(ze),k.deleteShader(xe);for(let Ke=0;Ke<fe.length;Ke++){const rt=fe[Ke];if(rt&&!$e[rt]){const xt=k.getUniformLocation(this.program,rt);xt&&($e[rt]=xt)}}this.fixedUniforms=d(t,$e),this.terrainUniforms=((Ke,rt)=>({u_depth:new s.aG(Ke,rt.u_depth),u_terrain:new s.aG(Ke,rt.u_terrain),u_terrain_dim:new s.aH(Ke,rt.u_terrain_dim),u_terrain_matrix:new s.aI(Ke,rt.u_terrain_matrix),u_terrain_unpack:new s.aJ(Ke,rt.u_terrain_unpack),u_terrain_exaggeration:new s.aH(Ke,rt.u_terrain_exaggeration)}))(t,$e),this.binderUniforms=c?c.getUniforms(t,$e):[]}draw(t,n,c,d,y,P,k,L,R,U,G,K,he,ce,fe,ne,Te,We){const xe=t.gl;if(this.failedToCreate)return;if(t.program.set(this.program),t.setDepthMode(c),t.setStencilMode(d),t.setColorMode(y),t.setCullFace(P),L){t.activeTexture.set(xe.TEXTURE2),xe.bindTexture(xe.TEXTURE_2D,L.depthTexture),t.activeTexture.set(xe.TEXTURE3),xe.bindTexture(xe.TEXTURE_2D,L.texture);for(const $e in this.terrainUniforms)this.terrainUniforms[$e].set(L[$e])}for(const $e in this.fixedUniforms)this.fixedUniforms[$e].set(k[$e]);fe&&fe.setUniforms(t,this.binderUniforms,he,{zoom:ce});let ze=0;switch(n){case xe.LINES:ze=2;break;case xe.TRIANGLES:ze=3;break;case xe.LINE_STRIP:ze=1}for(const $e of K.get()){const Ke=$e.vaos||($e.vaos={});(Ke[R]||(Ke[R]=new Mo)).bind(t,this,U,fe?fe.getPaintVertexBuffers():[],G,$e.vertexOffset,ne,Te,We),xe.drawElements(n,$e.primitiveLength*ze,xe.UNSIGNED_SHORT,$e.primitiveOffset*ze*2)}}}function F(g,t,n){const c=1/pi(n,1,t.transform.tileZoom),d=Math.pow(2,n.tileID.overscaledZ),y=n.tileSize*Math.pow(2,t.transform.tileZoom)/d,P=y*(n.tileID.canonical.x+n.tileID.wrap*d),k=y*n.tileID.canonical.y;return{u_image:0,u_texsize:n.imageAtlasTexture.size,u_scale:[c,g.fromScale,g.toScale],u_fade:g.t,u_pixel_coord_upper:[P>>16,k>>16],u_pixel_coord_lower:[65535&P,65535&k]}}const Y=(g,t,n,c)=>{const d=t.style.light,y=d.properties.get("position"),P=[y.x,y.y,y.z],k=function(){var R=new s.A(9);return s.A!=Float32Array&&(R[1]=0,R[2]=0,R[3]=0,R[5]=0,R[6]=0,R[7]=0),R[0]=1,R[4]=1,R[8]=1,R}();d.properties.get("anchor")==="viewport"&&function(R,U){var G=Math.sin(U),K=Math.cos(U);R[0]=K,R[1]=G,R[2]=0,R[3]=-G,R[4]=K,R[5]=0,R[6]=0,R[7]=0,R[8]=1}(k,-t.transform.angle),function(R,U,G){var K=U[0],he=U[1],ce=U[2];R[0]=K*G[0]+he*G[3]+ce*G[6],R[1]=K*G[1]+he*G[4]+ce*G[7],R[2]=K*G[2]+he*G[5]+ce*G[8]}(P,P,k);const L=d.properties.get("color");return{u_matrix:g,u_lightpos:P,u_lightintensity:d.properties.get("intensity"),u_lightcolor:[L.r,L.g,L.b],u_vertical_gradient:+n,u_opacity:c}},ye=(g,t,n,c,d,y,P)=>s.e(Y(g,t,n,c),F(y,t,P),{u_height_factor:-Math.pow(2,d.overscaledZ)/P.tileSize/8}),Ee=g=>({u_matrix:g}),Me=(g,t,n,c)=>s.e(Ee(g),F(n,t,c)),Re=(g,t)=>({u_matrix:g,u_world:t}),Ct=(g,t,n,c,d)=>s.e(Me(g,t,n,c),{u_world:d}),kt=(g,t,n,c)=>{const d=g.transform;let y,P;if(c.paint.get("circle-pitch-alignment")==="map"){const k=pi(n,1,d.zoom);y=!0,P=[k,k]}else y=!1,P=d.pixelsToGLUnits;return{u_camera_to_center_distance:d.cameraToCenterDistance,u_scale_with_map:+(c.paint.get("circle-pitch-scale")==="map"),u_matrix:g.translatePosMatrix(t.posMatrix,n,c.paint.get("circle-translate"),c.paint.get("circle-translate-anchor")),u_pitch_with_map:+y,u_device_pixel_ratio:g.pixelRatio,u_extrude_scale:P}},Ht=(g,t,n)=>{const c=pi(n,1,t.zoom),d=Math.pow(2,t.zoom-n.tileID.overscaledZ),y=n.tileID.overscaleFactor();return{u_matrix:g,u_camera_to_center_distance:t.cameraToCenterDistance,u_pixels_to_tile_units:c,u_extrude_scale:[t.pixelsToGLUnits[0]/(c*d),t.pixelsToGLUnits[1]/(c*d)],u_overscale_factor:y}},Wt=(g,t,n=1)=>({u_matrix:g,u_color:t,u_overlay:0,u_overlay_scale:n}),Ft=g=>({u_matrix:g}),vi=(g,t,n,c)=>({u_matrix:g,u_extrude_scale:pi(t,1,n),u_intensity:c});function ar(g,t){const n=Math.pow(2,t.canonical.z),c=t.canonical.y;return[new s.Y(0,c/n).toLngLat().lat,new s.Y(0,(c+1)/n).toLngLat().lat]}const xi=(g,t,n,c)=>{const d=g.transform;return{u_matrix:gr(g,t,n,c),u_ratio:1/pi(t,1,d.zoom),u_device_pixel_ratio:g.pixelRatio,u_units_to_pixels:[1/d.pixelsToGLUnits[0],1/d.pixelsToGLUnits[1]]}},Tr=(g,t,n,c,d)=>s.e(xi(g,t,n,d),{u_image:0,u_image_height:c}),mt=(g,t,n,c,d)=>{const y=g.transform,P=Ai(t,y);return{u_matrix:gr(g,t,n,d),u_texsize:t.imageAtlasTexture.size,u_ratio:1/pi(t,1,y.zoom),u_device_pixel_ratio:g.pixelRatio,u_image:0,u_scale:[P,c.fromScale,c.toScale],u_fade:c.t,u_units_to_pixels:[1/y.pixelsToGLUnits[0],1/y.pixelsToGLUnits[1]]}},Qt=(g,t,n,c,d,y)=>{const P=g.lineAtlas,k=Ai(t,g.transform),L=n.layout.get("line-cap")==="round",R=P.getDash(c.from,L),U=P.getDash(c.to,L),G=R.width*d.fromScale,K=U.width*d.toScale;return s.e(xi(g,t,n,y),{u_patternscale_a:[k/G,-R.height/2],u_patternscale_b:[k/K,-U.height/2],u_sdfgamma:P.width/(256*Math.min(G,K)*g.pixelRatio)/2,u_image:0,u_tex_y_a:R.y,u_tex_y_b:U.y,u_mix:d.t})};function Ai(g,t){return 1/pi(g,1,t.tileZoom)}function gr(g,t,n,c){return g.translatePosMatrix(c?c.posMatrix:t.tileID.posMatrix,t,n.paint.get("line-translate"),n.paint.get("line-translate-anchor"))}const dr=(g,t,n,c,d)=>{return{u_matrix:g,u_tl_parent:t,u_scale_parent:n,u_buffer_scale:1,u_fade_t:c.mix,u_opacity:c.opacity*d.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:d.paint.get("raster-brightness-min"),u_brightness_high:d.paint.get("raster-brightness-max"),u_saturation_factor:(P=d.paint.get("raster-saturation"),P>0?1-1/(1.001-P):-P),u_contrast_factor:(y=d.paint.get("raster-contrast"),y>0?1/(1-y):1+y),u_spin_weights:Ms(d.paint.get("raster-hue-rotate"))};var y,P};function Ms(g){g*=Math.PI/180;const t=Math.sin(g),n=Math.cos(g);return[(2*n+1)/3,(-Math.sqrt(3)*t-n+1)/3,(Math.sqrt(3)*t-n+1)/3]}const mo=(g,t,n,c,d,y,P,k,L,R)=>{const U=d.transform;return{u_is_size_zoom_constant:+(g==="constant"||g==="source"),u_is_size_feature_constant:+(g==="constant"||g==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:U.cameraToCenterDistance,u_pitch:U.pitch/360*2*Math.PI,u_rotate_symbol:+n,u_aspect_ratio:U.width/U.height,u_fade_change:d.options.fadeDuration?d.symbolFadeChange:1,u_matrix:y,u_label_plane_matrix:P,u_coord_matrix:k,u_is_text:+L,u_pitch_with_map:+c,u_texsize:R,u_texture:0}},Yi=(g,t,n,c,d,y,P,k,L,R,U)=>{const G=d.transform;return s.e(mo(g,t,n,c,d,y,P,k,L,R),{u_gamma_scale:c?Math.cos(G._pitch)*G.cameraToCenterDistance:1,u_device_pixel_ratio:d.pixelRatio,u_is_halo:+U})},Xs=(g,t,n,c,d,y,P,k,L,R)=>s.e(Yi(g,t,n,c,d,y,P,k,!0,L,!0),{u_texsize_icon:R,u_texture_icon:1}),Cl=(g,t,n)=>({u_matrix:g,u_opacity:t,u_color:n}),os=(g,t,n,c,d,y)=>s.e(function(P,k,L,R){const U=L.imageManager.getPattern(P.from.toString()),G=L.imageManager.getPattern(P.to.toString()),{width:K,height:he}=L.imageManager.getPixelSize(),ce=Math.pow(2,R.tileID.overscaledZ),fe=R.tileSize*Math.pow(2,L.transform.tileZoom)/ce,ne=fe*(R.tileID.canonical.x+R.tileID.wrap*ce),Te=fe*R.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:U.tl,u_pattern_br_a:U.br,u_pattern_tl_b:G.tl,u_pattern_br_b:G.br,u_texsize:[K,he],u_mix:k.t,u_pattern_size_a:U.displaySize,u_pattern_size_b:G.displaySize,u_scale_a:k.fromScale,u_scale_b:k.toScale,u_tile_units_to_pixels:1/pi(R,1,L.transform.tileZoom),u_pixel_coord_upper:[ne>>16,Te>>16],u_pixel_coord_lower:[65535&ne,65535&Te]}}(c,y,n,d),{u_matrix:g,u_opacity:t}),ca={fillExtrusion:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_lightpos:new s.aK(g,t.u_lightpos),u_lightintensity:new s.aH(g,t.u_lightintensity),u_lightcolor:new s.aK(g,t.u_lightcolor),u_vertical_gradient:new s.aH(g,t.u_vertical_gradient),u_opacity:new s.aH(g,t.u_opacity)}),fillExtrusionPattern:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_lightpos:new s.aK(g,t.u_lightpos),u_lightintensity:new s.aH(g,t.u_lightintensity),u_lightcolor:new s.aK(g,t.u_lightcolor),u_vertical_gradient:new s.aH(g,t.u_vertical_gradient),u_height_factor:new s.aH(g,t.u_height_factor),u_image:new s.aG(g,t.u_image),u_texsize:new s.aL(g,t.u_texsize),u_pixel_coord_upper:new s.aL(g,t.u_pixel_coord_upper),u_pixel_coord_lower:new s.aL(g,t.u_pixel_coord_lower),u_scale:new s.aK(g,t.u_scale),u_fade:new s.aH(g,t.u_fade),u_opacity:new s.aH(g,t.u_opacity)}),fill:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix)}),fillPattern:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_image:new s.aG(g,t.u_image),u_texsize:new s.aL(g,t.u_texsize),u_pixel_coord_upper:new s.aL(g,t.u_pixel_coord_upper),u_pixel_coord_lower:new s.aL(g,t.u_pixel_coord_lower),u_scale:new s.aK(g,t.u_scale),u_fade:new s.aH(g,t.u_fade)}),fillOutline:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_world:new s.aL(g,t.u_world)}),fillOutlinePattern:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_world:new s.aL(g,t.u_world),u_image:new s.aG(g,t.u_image),u_texsize:new s.aL(g,t.u_texsize),u_pixel_coord_upper:new s.aL(g,t.u_pixel_coord_upper),u_pixel_coord_lower:new s.aL(g,t.u_pixel_coord_lower),u_scale:new s.aK(g,t.u_scale),u_fade:new s.aH(g,t.u_fade)}),circle:(g,t)=>({u_camera_to_center_distance:new s.aH(g,t.u_camera_to_center_distance),u_scale_with_map:new s.aG(g,t.u_scale_with_map),u_pitch_with_map:new s.aG(g,t.u_pitch_with_map),u_extrude_scale:new s.aL(g,t.u_extrude_scale),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_matrix:new s.aI(g,t.u_matrix)}),collisionBox:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_camera_to_center_distance:new s.aH(g,t.u_camera_to_center_distance),u_pixels_to_tile_units:new s.aH(g,t.u_pixels_to_tile_units),u_extrude_scale:new s.aL(g,t.u_extrude_scale),u_overscale_factor:new s.aH(g,t.u_overscale_factor)}),collisionCircle:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_inv_matrix:new s.aI(g,t.u_inv_matrix),u_camera_to_center_distance:new s.aH(g,t.u_camera_to_center_distance),u_viewport_size:new s.aL(g,t.u_viewport_size)}),debug:(g,t)=>({u_color:new s.aM(g,t.u_color),u_matrix:new s.aI(g,t.u_matrix),u_overlay:new s.aG(g,t.u_overlay),u_overlay_scale:new s.aH(g,t.u_overlay_scale)}),clippingMask:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix)}),heatmap:(g,t)=>({u_extrude_scale:new s.aH(g,t.u_extrude_scale),u_intensity:new s.aH(g,t.u_intensity),u_matrix:new s.aI(g,t.u_matrix)}),heatmapTexture:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_world:new s.aL(g,t.u_world),u_image:new s.aG(g,t.u_image),u_color_ramp:new s.aG(g,t.u_color_ramp),u_opacity:new s.aH(g,t.u_opacity)}),hillshade:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_image:new s.aG(g,t.u_image),u_latrange:new s.aL(g,t.u_latrange),u_light:new s.aL(g,t.u_light),u_shadow:new s.aM(g,t.u_shadow),u_highlight:new s.aM(g,t.u_highlight),u_accent:new s.aM(g,t.u_accent)}),hillshadePrepare:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_image:new s.aG(g,t.u_image),u_dimension:new s.aL(g,t.u_dimension),u_zoom:new s.aH(g,t.u_zoom),u_unpack:new s.aJ(g,t.u_unpack)}),line:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_ratio:new s.aH(g,t.u_ratio),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_units_to_pixels:new s.aL(g,t.u_units_to_pixels)}),lineGradient:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_ratio:new s.aH(g,t.u_ratio),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_units_to_pixels:new s.aL(g,t.u_units_to_pixels),u_image:new s.aG(g,t.u_image),u_image_height:new s.aH(g,t.u_image_height)}),linePattern:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_texsize:new s.aL(g,t.u_texsize),u_ratio:new s.aH(g,t.u_ratio),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_image:new s.aG(g,t.u_image),u_units_to_pixels:new s.aL(g,t.u_units_to_pixels),u_scale:new s.aK(g,t.u_scale),u_fade:new s.aH(g,t.u_fade)}),lineSDF:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_ratio:new s.aH(g,t.u_ratio),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_units_to_pixels:new s.aL(g,t.u_units_to_pixels),u_patternscale_a:new s.aL(g,t.u_patternscale_a),u_patternscale_b:new s.aL(g,t.u_patternscale_b),u_sdfgamma:new s.aH(g,t.u_sdfgamma),u_image:new s.aG(g,t.u_image),u_tex_y_a:new s.aH(g,t.u_tex_y_a),u_tex_y_b:new s.aH(g,t.u_tex_y_b),u_mix:new s.aH(g,t.u_mix)}),raster:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_tl_parent:new s.aL(g,t.u_tl_parent),u_scale_parent:new s.aH(g,t.u_scale_parent),u_buffer_scale:new s.aH(g,t.u_buffer_scale),u_fade_t:new s.aH(g,t.u_fade_t),u_opacity:new s.aH(g,t.u_opacity),u_image0:new s.aG(g,t.u_image0),u_image1:new s.aG(g,t.u_image1),u_brightness_low:new s.aH(g,t.u_brightness_low),u_brightness_high:new s.aH(g,t.u_brightness_high),u_saturation_factor:new s.aH(g,t.u_saturation_factor),u_contrast_factor:new s.aH(g,t.u_contrast_factor),u_spin_weights:new s.aK(g,t.u_spin_weights)}),symbolIcon:(g,t)=>({u_is_size_zoom_constant:new s.aG(g,t.u_is_size_zoom_constant),u_is_size_feature_constant:new s.aG(g,t.u_is_size_feature_constant),u_size_t:new s.aH(g,t.u_size_t),u_size:new s.aH(g,t.u_size),u_camera_to_center_distance:new s.aH(g,t.u_camera_to_center_distance),u_pitch:new s.aH(g,t.u_pitch),u_rotate_symbol:new s.aG(g,t.u_rotate_symbol),u_aspect_ratio:new s.aH(g,t.u_aspect_ratio),u_fade_change:new s.aH(g,t.u_fade_change),u_matrix:new s.aI(g,t.u_matrix),u_label_plane_matrix:new s.aI(g,t.u_label_plane_matrix),u_coord_matrix:new s.aI(g,t.u_coord_matrix),u_is_text:new s.aG(g,t.u_is_text),u_pitch_with_map:new s.aG(g,t.u_pitch_with_map),u_texsize:new s.aL(g,t.u_texsize),u_texture:new s.aG(g,t.u_texture)}),symbolSDF:(g,t)=>({u_is_size_zoom_constant:new s.aG(g,t.u_is_size_zoom_constant),u_is_size_feature_constant:new s.aG(g,t.u_is_size_feature_constant),u_size_t:new s.aH(g,t.u_size_t),u_size:new s.aH(g,t.u_size),u_camera_to_center_distance:new s.aH(g,t.u_camera_to_center_distance),u_pitch:new s.aH(g,t.u_pitch),u_rotate_symbol:new s.aG(g,t.u_rotate_symbol),u_aspect_ratio:new s.aH(g,t.u_aspect_ratio),u_fade_change:new s.aH(g,t.u_fade_change),u_matrix:new s.aI(g,t.u_matrix),u_label_plane_matrix:new s.aI(g,t.u_label_plane_matrix),u_coord_matrix:new s.aI(g,t.u_coord_matrix),u_is_text:new s.aG(g,t.u_is_text),u_pitch_with_map:new s.aG(g,t.u_pitch_with_map),u_texsize:new s.aL(g,t.u_texsize),u_texture:new s.aG(g,t.u_texture),u_gamma_scale:new s.aH(g,t.u_gamma_scale),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_is_halo:new s.aG(g,t.u_is_halo)}),symbolTextAndIcon:(g,t)=>({u_is_size_zoom_constant:new s.aG(g,t.u_is_size_zoom_constant),u_is_size_feature_constant:new s.aG(g,t.u_is_size_feature_constant),u_size_t:new s.aH(g,t.u_size_t),u_size:new s.aH(g,t.u_size),u_camera_to_center_distance:new s.aH(g,t.u_camera_to_center_distance),u_pitch:new s.aH(g,t.u_pitch),u_rotate_symbol:new s.aG(g,t.u_rotate_symbol),u_aspect_ratio:new s.aH(g,t.u_aspect_ratio),u_fade_change:new s.aH(g,t.u_fade_change),u_matrix:new s.aI(g,t.u_matrix),u_label_plane_matrix:new s.aI(g,t.u_label_plane_matrix),u_coord_matrix:new s.aI(g,t.u_coord_matrix),u_is_text:new s.aG(g,t.u_is_text),u_pitch_with_map:new s.aG(g,t.u_pitch_with_map),u_texsize:new s.aL(g,t.u_texsize),u_texsize_icon:new s.aL(g,t.u_texsize_icon),u_texture:new s.aG(g,t.u_texture),u_texture_icon:new s.aG(g,t.u_texture_icon),u_gamma_scale:new s.aH(g,t.u_gamma_scale),u_device_pixel_ratio:new s.aH(g,t.u_device_pixel_ratio),u_is_halo:new s.aG(g,t.u_is_halo)}),background:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_opacity:new s.aH(g,t.u_opacity),u_color:new s.aM(g,t.u_color)}),backgroundPattern:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_opacity:new s.aH(g,t.u_opacity),u_image:new s.aG(g,t.u_image),u_pattern_tl_a:new s.aL(g,t.u_pattern_tl_a),u_pattern_br_a:new s.aL(g,t.u_pattern_br_a),u_pattern_tl_b:new s.aL(g,t.u_pattern_tl_b),u_pattern_br_b:new s.aL(g,t.u_pattern_br_b),u_texsize:new s.aL(g,t.u_texsize),u_mix:new s.aH(g,t.u_mix),u_pattern_size_a:new s.aL(g,t.u_pattern_size_a),u_pattern_size_b:new s.aL(g,t.u_pattern_size_b),u_scale_a:new s.aH(g,t.u_scale_a),u_scale_b:new s.aH(g,t.u_scale_b),u_pixel_coord_upper:new s.aL(g,t.u_pixel_coord_upper),u_pixel_coord_lower:new s.aL(g,t.u_pixel_coord_lower),u_tile_units_to_pixels:new s.aH(g,t.u_tile_units_to_pixels)}),terrain:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_texture:new s.aG(g,t.u_texture),u_ele_delta:new s.aH(g,t.u_ele_delta)}),terrainDepth:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_ele_delta:new s.aH(g,t.u_ele_delta)}),terrainCoords:(g,t)=>({u_matrix:new s.aI(g,t.u_matrix),u_texture:new s.aG(g,t.u_texture),u_terrain_coords_id:new s.aH(g,t.u_terrain_coords_id),u_ele_delta:new s.aH(g,t.u_ele_delta)})};class Ha{constructor(t,n,c){this.context=t;const d=t.gl;this.buffer=d.createBuffer(),this.dynamicDraw=!!c,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),d.bufferData(d.ELEMENT_ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?d.DYNAMIC_DRAW:d.STATIC_DRAW),this.dynamicDraw||delete n.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){const n=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const xs={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class qs{constructor(t,n,c,d){this.length=n.length,this.attributes=c,this.itemSize=n.bytesPerElement,this.dynamicDraw=d,this.context=t;const y=t.gl;this.buffer=y.createBuffer(),t.bindVertexBuffer.set(this.buffer),y.bufferData(y.ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?y.DYNAMIC_DRAW:y.STATIC_DRAW),this.dynamicDraw||delete n.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){if(t.length!==this.length)throw new Error(`Length of new data is ${t.length}, which doesn't match current length of ${this.length}`);const n=this.context.gl;this.bind(),n.bufferSubData(n.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,n){for(let c=0;c<this.attributes.length;c++){const d=n.attributes[this.attributes[c].name];d!==void 0&&t.enableVertexAttribArray(d)}}setVertexAttribPointers(t,n,c){for(let d=0;d<this.attributes.length;d++){const y=this.attributes[d],P=n.attributes[y.name];P!==void 0&&t.vertexAttribPointer(P,y.components,t[xs[y.type]],!1,this.itemSize,y.offset+this.itemSize*(c||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Qr=new WeakMap;function Vr(g){var t;if(Qr.has(g))return Qr.get(g);{const n=(t=g.getParameter(g.VERSION))===null||t===void 0?void 0:t.startsWith("WebGL 2.0");return Qr.set(g,n),n}}class ji{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class ko extends ji{getDefault(){return s.aO.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Oo extends ji{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Do extends ji{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Lo extends ji{getDefault(){return[!0,!0,!0,!0]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class go extends ji{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class ha extends ji{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class ua extends ji{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const n=this.current;(t.func!==n.func||t.ref!==n.ref||t.mask!==n.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class ks extends ji{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class zo extends ji{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.current=t,this.dirty=!1}}class da extends ji{getDefault(){return[0,1]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class ln extends ji{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.current=t,this.dirty=!1}}class Wa extends ji{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class Xa extends ji{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.BLEND):n.disable(n.BLEND),this.current=t,this.dirty=!1}}class Sl extends ji{getDefault(){const t=this.gl;return[t.ONE,t.ZERO]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.blendFunc(t[0],t[1]),this.current=t,this.dirty=!1)}}class qa extends ji{getDefault(){return s.aO.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Fo extends ji{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquation(t),this.current=t,this.dirty=!1)}}class $a extends ji{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this.current=t,this.dirty=!1}}class Ro extends ji{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Bo extends ji{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}class as extends ji{getDefault(){return null}set(t){(t!==this.current||this.dirty)&&(this.gl.useProgram(t),this.current=t,this.dirty=!1)}}class jo extends ji{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class $s extends ji{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Ya extends ji{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class No extends ji{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Os extends ji{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindTexture(n.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class ls extends ji{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Vo extends ji{getDefault(){return null}set(t){const n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class bs extends ji{getDefault(){return null}set(t){var n;if(t===this.current&&!this.dirty)return;const c=this.gl;Vr(c)?c.bindVertexArray(t):(n=c.getExtension("OES_vertex_array_object"))===null||n===void 0||n.bindVertexArrayOES(t),this.current=t,this.dirty=!1}}class Yn extends ji{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class Za extends ji{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class fa extends ji{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class zi extends ji{constructor(t,n){super(t),this.context=t,this.parent=n}getDefault(){return null}}class Uo extends zi{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Tl extends zi{set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class pa extends zi{set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Ds{constructor(t,n,c,d,y){this.context=t,this.width=n,this.height=c;const P=t.gl,k=this.framebuffer=P.createFramebuffer();if(this.colorAttachment=new Uo(t,k),d)this.depthAttachment=y?new pa(t,k):new Tl(t,k);else if(y)throw new Error("Stencil cannot be set without depth");if(P.checkFramebufferStatus(P.FRAMEBUFFER)!==P.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer is not complete")}destroy(){const t=this.context.gl,n=this.colorAttachment.get();if(n&&t.deleteTexture(n),this.depthAttachment){const c=this.depthAttachment.get();c&&t.deleteRenderbuffer(c)}t.deleteFramebuffer(this.framebuffer)}}class er{constructor(t,n,c){this.blendFunction=t,this.blendColor=n,this.mask=c}}er.Replace=[1,0],er.disabled=new er(er.Replace,s.aO.transparent,[!1,!1,!1,!1]),er.unblended=new er(er.Replace,s.aO.transparent,[!0,!0,!0,!0]),er.alphaBlended=new er([1,771],s.aO.transparent,[!0,!0,!0,!0]);class cs{constructor(t){var n,c;if(this.gl=t,this.clearColor=new ko(this),this.clearDepth=new Oo(this),this.clearStencil=new Do(this),this.colorMask=new Lo(this),this.depthMask=new go(this),this.stencilMask=new ha(this),this.stencilFunc=new ua(this),this.stencilOp=new ks(this),this.stencilTest=new zo(this),this.depthRange=new da(this),this.depthTest=new ln(this),this.depthFunc=new Wa(this),this.blend=new Xa(this),this.blendFunc=new Sl(this),this.blendColor=new qa(this),this.blendEquation=new Fo(this),this.cullFace=new $a(this),this.cullFaceSide=new Ro(this),this.frontFace=new Bo(this),this.program=new as(this),this.activeTexture=new jo(this),this.viewport=new $s(this),this.bindFramebuffer=new Ya(this),this.bindRenderbuffer=new No(this),this.bindTexture=new Os(this),this.bindVertexBuffer=new ls(this),this.bindElementBuffer=new Vo(this),this.bindVertexArray=new bs(this),this.pixelStoreUnpack=new Yn(this),this.pixelStoreUnpackPremultiplyAlpha=new Za(this),this.pixelStoreUnpackFlipY=new fa(this),this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),Vr(t)){this.HALF_FLOAT=t.HALF_FLOAT;const d=t.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(n=t.RGBA16F)!==null&&n!==void 0?n:d==null?void 0:d.RGBA16F_EXT,this.RGB16F=(c=t.RGB16F)!==null&&c!==void 0?c:d==null?void 0:d.RGB16F_EXT,t.getExtension("EXT_color_buffer_float")}else{t.getExtension("EXT_color_buffer_half_float"),t.getExtension("OES_texture_half_float_linear");const d=t.getExtension("OES_texture_half_float");this.HALF_FLOAT=d==null?void 0:d.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,n){return new Ha(this,t,n)}createVertexBuffer(t,n,c){return new qs(this,t,n,c)}createRenderbuffer(t,n,c){const d=this.gl,y=d.createRenderbuffer();return this.bindRenderbuffer.set(y),d.renderbufferStorage(d.RENDERBUFFER,t,n,c),this.bindRenderbuffer.set(null),y}createFramebuffer(t,n,c,d){return new Ds(this,t,n,c,d)}clear({color:t,depth:n,stencil:c}){const d=this.gl;let y=0;t&&(y|=d.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set([!0,!0,!0,!0])),n!==void 0&&(y|=d.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(n),this.depthMask.set(!0)),c!==void 0&&(y|=d.STENCIL_BUFFER_BIT,this.clearStencil.set(c),this.stencilMask.set(255)),d.clear(y)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){s.aD(t.blendFunction,er.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor)),this.colorMask.set(t.mask)}createVertexArray(){var t;return Vr(this.gl)?this.gl.createVertexArray():(t=this.gl.getExtension("OES_vertex_array_object"))===null||t===void 0?void 0:t.createVertexArrayOES()}deleteVertexArray(t){var n;return Vr(this.gl)?this.gl.deleteVertexArray(t):(n=this.gl.getExtension("OES_vertex_array_object"))===null||n===void 0?void 0:n.deleteVertexArrayOES(t)}unbindVAO(){this.bindVertexArray.set(null)}}class Ti{constructor(t,n,c){this.func=t,this.mask=n,this.range=c}}Ti.ReadOnly=!1,Ti.ReadWrite=!0,Ti.disabled=new Ti(519,Ti.ReadOnly,[0,1]);const Ys=7680;class Ni{constructor(t,n,c,d,y,P){this.test=t,this.ref=n,this.mask=c,this.fail=d,this.depthFail=y,this.pass=P}}Ni.disabled=new Ni({func:519,mask:0},0,0,Ys,Ys,Ys);class Ki{constructor(t,n,c){this.enable=t,this.mode=n,this.frontFace=c}}let Zn;function ws(g,t,n,c,d,y,P){const k=g.context,L=k.gl,R=g.useProgram("collisionBox"),U=[];let G=0,K=0;for(let xe=0;xe<c.length;xe++){const ze=c[xe],$e=t.getTile(ze),Ke=$e.getBucket(n);if(!Ke)continue;let rt=ze.posMatrix;d[0]===0&&d[1]===0||(rt=g.translatePosMatrix(ze.posMatrix,$e,d,y));const xt=P?Ke.textCollisionBox:Ke.iconCollisionBox,yt=Ke.collisionCircleArray;if(yt.length>0){const At=s.F(),zt=rt;s.aP(At,Ke.placementInvProjMatrix,g.transform.glCoordMatrix),s.aP(At,At,Ke.placementViewportMatrix),U.push({circleArray:yt,circleOffset:K,transform:zt,invTransform:At,coord:ze}),G+=yt.length/4,K=G}xt&&R.draw(k,L.LINES,Ti.disabled,Ni.disabled,g.colorModeForRenderPass(),Ki.disabled,Ht(rt,g.transform,$e),g.style.map.terrain&&g.style.map.terrain.getTerrainData(ze),n.id,xt.layoutVertexBuffer,xt.indexBuffer,xt.segments,null,g.transform.zoom,null,null,xt.collisionVertexBuffer)}if(!P||!U.length)return;const he=g.useProgram("collisionCircle"),ce=new s.aQ;ce.resize(4*G),ce._trim();let fe=0;for(const xe of U)for(let ze=0;ze<xe.circleArray.length/4;ze++){const $e=4*ze,Ke=xe.circleArray[$e+0],rt=xe.circleArray[$e+1],xt=xe.circleArray[$e+2],yt=xe.circleArray[$e+3];ce.emplace(fe++,Ke,rt,xt,yt,0),ce.emplace(fe++,Ke,rt,xt,yt,1),ce.emplace(fe++,Ke,rt,xt,yt,2),ce.emplace(fe++,Ke,rt,xt,yt,3)}(!Zn||Zn.length<2*G)&&(Zn=function(xe){const ze=2*xe,$e=new s.aS;$e.resize(ze),$e._trim();for(let Ke=0;Ke<ze;Ke++){const rt=6*Ke;$e.uint16[rt+0]=4*Ke+0,$e.uint16[rt+1]=4*Ke+1,$e.uint16[rt+2]=4*Ke+2,$e.uint16[rt+3]=4*Ke+2,$e.uint16[rt+4]=4*Ke+3,$e.uint16[rt+5]=4*Ke+0}return $e}(G));const ne=k.createIndexBuffer(Zn,!0),Te=k.createVertexBuffer(ce,s.aR.members,!0);for(const xe of U){const ze={u_matrix:xe.transform,u_inv_matrix:xe.invTransform,u_camera_to_center_distance:(We=g.transform).cameraToCenterDistance,u_viewport_size:[We.width,We.height]};he.draw(k,L.TRIANGLES,Ti.disabled,Ni.disabled,g.colorModeForRenderPass(),Ki.disabled,ze,g.style.map.terrain&&g.style.map.terrain.getTerrainData(xe.coord),n.id,Te,ne,s.$.simpleSegment(0,2*xe.circleOffset,xe.circleArray.length,xe.circleArray.length/2),null,g.transform.zoom,null,null,null)}var We;Te.destroy(),ne.destroy()}Ki.disabled=new Ki(!1,1029,2305),Ki.backCCW=new Ki(!0,1029,2305);const Go=s.an(new Float32Array(16));function ma(g,t,n,c,d,y){const{horizontalAlign:P,verticalAlign:k}=s.at(g);return new s.P((-(P-.5)*t/d+c[0])*y,(-(k-.5)*n/d+c[1])*y)}function Ho(g,t,n,c,d,y,P,k,L,R,U){const G=g.text.placedSymbolArray,K=g.text.dynamicLayoutVertexArray,he=g.icon.dynamicLayoutVertexArray,ce={};K.clear();for(let fe=0;fe<G.length;fe++){const ne=G.get(fe),Te=ne.hidden||!ne.crossTileID||g.allowVerticalPlacement&&!ne.placedOrientation?null:c[ne.crossTileID];if(Te){const We=new s.P(ne.anchorX,ne.anchorY),xe=$i(We,n?P:y,U),ze=ae(d.cameraToCenterDistance,xe.signedDistanceFromCamera);let $e=s.ai(g.textSizeData,L,ne)*ze/s.ao;n&&($e*=g.tilePixelRatio/k);const{width:Ke,height:rt,anchor:xt,textOffset:yt,textBoxScale:At}=Te,zt=ma(xt,Ke,rt,yt,At,$e),Ci=n?$i(We.add(zt),y,U).point:xe.point.add(t?zt.rotate(-d.angle):zt),Bt=g.allowVerticalPlacement&&ne.placedOrientation===s.ah.vertical?Math.PI/2:0;for(let di=0;di<ne.numGlyphs;di++)s.aj(K,Ci,Bt);R&&ne.associatedIconIndex>=0&&(ce[ne.associatedIconIndex]={shiftedAnchor:Ci,angle:Bt})}else at(ne.numGlyphs,K)}if(R){he.clear();const fe=g.icon.placedSymbolArray;for(let ne=0;ne<fe.length;ne++){const Te=fe.get(ne);if(Te.hidden)at(Te.numGlyphs,he);else{const We=ce[ne];if(We)for(let xe=0;xe<Te.numGlyphs;xe++)s.aj(he,We.shiftedAnchor,We.angle);else at(Te.numGlyphs,he)}}g.icon.dynamicLayoutVertexBuffer.updateData(he)}g.text.dynamicLayoutVertexBuffer.updateData(K)}function Wo(g,t,n){return n.iconsInText&&t?"symbolTextAndIcon":g?"symbolSDF":"symbolIcon"}function _o(g,t,n,c,d,y,P,k,L,R,U,G){const K=g.context,he=K.gl,ce=g.transform,fe=k==="map",ne=L==="map",Te=k!=="viewport"&&n.layout.get("symbol-placement")!=="point",We=fe&&!ne&&!Te,xe=!n.layout.get("symbol-sort-key").isConstant();let ze=!1;const $e=g.depthModeForSublayer(0,Ti.ReadOnly),Ke=n._unevaluatedLayout.hasValue("text-variable-anchor")||n._unevaluatedLayout.hasValue("text-variable-anchor-offset"),rt=[];for(const xt of c){const yt=t.getTile(xt),At=yt.getBucket(n);if(!At)continue;const zt=d?At.text:At.icon;if(!zt||!zt.segments.get().length||!zt.hasVisibleVertices)continue;const Ci=zt.programConfigurations.get(n.id),Bt=d||At.sdfIcons,di=d?At.textSizeData:At.iconSizeData,Si=ne||ce.pitch!==0,Fi=g.useProgram(Wo(Bt,d,At),Ci),gi=s.ag(di,ce.zoom),Ei=g.style.map.terrain&&g.style.map.terrain.getTerrainData(xt);let Mi,Ir,Ji,Vn,Wr=[0,0],yr=null;if(d)Ir=yt.glyphAtlasTexture,Ji=he.LINEAR,Mi=yt.glyphAtlasTexture.size,At.iconsInText&&(Wr=yt.imageAtlasTexture.size,yr=yt.imageAtlasTexture,Vn=Si||g.options.rotating||g.options.zooming||di.kind==="composite"||di.kind==="camera"?he.LINEAR:he.NEAREST);else{const Rr=n.layout.get("icon-size").constantOr(0)!==1||At.iconsNeedLinear;Ir=yt.imageAtlasTexture,Ji=Bt||g.options.rotating||g.options.zooming||Rr||Si?he.LINEAR:he.NEAREST,Mi=yt.imageAtlasTexture.size}const Xr=pi(yt,1,g.transform.zoom),Un=Zt(xt.posMatrix,ne,fe,g.transform,Xr),Ts=Zi(xt.posMatrix,ne,fe,g.transform,Xr),eo=Ke&&At.hasTextData(),ka=n.layout.get("icon-text-fit")!=="none"&&eo&&At.hasIconData();if(Te){const Rr=g.style.map.terrain?(is,Br)=>g.style.map.terrain.getElevation(xt,is,Br):null,xr=n.layout.get("text-rotation-alignment")==="map";q(At,xt.posMatrix,g,d,Un,Ts,ne,R,xr,Rr)}const to=g.translatePosMatrix(xt.posMatrix,yt,y,P),Es=Te||d&&Ke||ka?Go:Un,Fr=g.translatePosMatrix(Ts,yt,y,P,!0),vr=Bt&&n.paint.get(d?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let pr;pr=Bt?At.iconsInText?Xs(di.kind,gi,We,ne,g,to,Es,Fr,Mi,Wr):Yi(di.kind,gi,We,ne,g,to,Es,Fr,d,Mi,!0):mo(di.kind,gi,We,ne,g,to,Es,Fr,d,Mi);const ts={program:Fi,buffers:zt,uniformValues:pr,atlasTexture:Ir,atlasTextureIcon:yr,atlasInterpolation:Ji,atlasInterpolationIcon:Vn,isSDF:Bt,hasHalo:vr};if(xe&&At.canOverlap){ze=!0;const Rr=zt.segments.get();for(const xr of Rr)rt.push({segments:new s.$([xr]),sortKey:xr.sortKey,state:ts,terrainData:Ei})}else rt.push({segments:zt.segments,sortKey:0,state:ts,terrainData:Ei})}ze&&rt.sort((xt,yt)=>xt.sortKey-yt.sortKey);for(const xt of rt){const yt=xt.state;if(K.activeTexture.set(he.TEXTURE0),yt.atlasTexture.bind(yt.atlasInterpolation,he.CLAMP_TO_EDGE),yt.atlasTextureIcon&&(K.activeTexture.set(he.TEXTURE1),yt.atlasTextureIcon&&yt.atlasTextureIcon.bind(yt.atlasInterpolationIcon,he.CLAMP_TO_EDGE)),yt.isSDF){const At=yt.uniformValues;yt.hasHalo&&(At.u_is_halo=1,ga(yt.buffers,xt.segments,n,g,yt.program,$e,U,G,At,xt.terrainData)),At.u_is_halo=0}ga(yt.buffers,xt.segments,n,g,yt.program,$e,U,G,yt.uniformValues,xt.terrainData)}}function ga(g,t,n,c,d,y,P,k,L,R){const U=c.context;d.draw(U,U.gl.TRIANGLES,y,P,k,Ki.disabled,L,R,n.id,g.layoutVertexBuffer,g.indexBuffer,t,n.paint,c.transform.zoom,g.programConfigurations.get(n.id),g.dynamicLayoutVertexBuffer,g.opacityVertexBuffer)}function Ls(g,t,n,c,d){if(!n||!c||!c.imageAtlas)return;const y=c.imageAtlas.patternPositions;let P=y[n.to.toString()],k=y[n.from.toString()];if(!P&&k&&(P=k),!k&&P&&(k=P),!P||!k){const L=d.getPaintProperty(t);P=y[L],k=y[L]}P&&k&&g.setConstantPatternPositions(P,k)}function zs(g,t,n,c,d,y,P){const k=g.context.gl,L="fill-pattern",R=n.paint.get(L),U=R&&R.constantOr(1),G=n.getCrossfadeParameters();let K,he,ce,fe,ne;P?(he=U&&!n.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",K=k.LINES):(he=U?"fillPattern":"fill",K=k.TRIANGLES);const Te=R.constantOr(null);for(const We of c){const xe=t.getTile(We);if(U&&!xe.patternsLoaded())continue;const ze=xe.getBucket(n);if(!ze)continue;const $e=ze.programConfigurations.get(n.id),Ke=g.useProgram(he,$e),rt=g.style.map.terrain&&g.style.map.terrain.getTerrainData(We);U&&(g.context.activeTexture.set(k.TEXTURE0),xe.imageAtlasTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE),$e.updatePaintBuffers(G)),Ls($e,L,Te,xe,n);const xt=rt?We:null,yt=g.translatePosMatrix(xt?xt.posMatrix:We.posMatrix,xe,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor"));if(P){fe=ze.indexBuffer2,ne=ze.segments2;const At=[k.drawingBufferWidth,k.drawingBufferHeight];ce=he==="fillOutlinePattern"&&U?Ct(yt,g,G,xe,At):Re(yt,At)}else fe=ze.indexBuffer,ne=ze.segments,ce=U?Me(yt,g,G,xe):Ee(yt);Ke.draw(g.context,K,d,g.stencilModeForClipping(We),y,Ki.disabled,ce,rt,n.id,ze.layoutVertexBuffer,fe,ne,n.paint,g.transform.zoom,$e)}}function Xo(g,t,n,c,d,y,P){const k=g.context,L=k.gl,R="fill-extrusion-pattern",U=n.paint.get(R),G=U.constantOr(1),K=n.getCrossfadeParameters(),he=n.paint.get("fill-extrusion-opacity"),ce=U.constantOr(null);for(const fe of c){const ne=t.getTile(fe),Te=ne.getBucket(n);if(!Te)continue;const We=g.style.map.terrain&&g.style.map.terrain.getTerrainData(fe),xe=Te.programConfigurations.get(n.id),ze=g.useProgram(G?"fillExtrusionPattern":"fillExtrusion",xe);G&&(g.context.activeTexture.set(L.TEXTURE0),ne.imageAtlasTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),xe.updatePaintBuffers(K)),Ls(xe,R,ce,ne,n);const $e=g.translatePosMatrix(fe.posMatrix,ne,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),Ke=n.paint.get("fill-extrusion-vertical-gradient"),rt=G?ye($e,g,Ke,he,fe,K,ne):Y($e,g,Ke,he);ze.draw(k,k.gl.TRIANGLES,d,y,P,Ki.backCCW,rt,We,n.id,Te.layoutVertexBuffer,Te.indexBuffer,Te.segments,n.paint,g.transform.zoom,xe,g.style.map.terrain&&Te.centroidVertexBuffer)}}function Bn(g,t,n,c,d,y,P){const k=g.context,L=k.gl,R=n.fbo;if(!R)return;const U=g.useProgram("hillshade"),G=g.style.map.terrain&&g.style.map.terrain.getTerrainData(t);k.activeTexture.set(L.TEXTURE0),L.bindTexture(L.TEXTURE_2D,R.colorAttachment.get()),U.draw(k,L.TRIANGLES,d,y,P,Ki.disabled,((K,he,ce,fe)=>{const ne=ce.paint.get("hillshade-shadow-color"),Te=ce.paint.get("hillshade-highlight-color"),We=ce.paint.get("hillshade-accent-color");let xe=ce.paint.get("hillshade-illumination-direction")*(Math.PI/180);ce.paint.get("hillshade-illumination-anchor")==="viewport"&&(xe-=K.transform.angle);const ze=!K.options.moving;return{u_matrix:fe?fe.posMatrix:K.transform.calculatePosMatrix(he.tileID.toUnwrapped(),ze),u_image:0,u_latrange:ar(0,he.tileID),u_light:[ce.paint.get("hillshade-exaggeration"),xe],u_shadow:ne,u_highlight:Te,u_accent:We}})(g,n,c,G?t:null),G,c.id,g.rasterBoundsBuffer,g.quadTriangleIndexBuffer,g.rasterBoundsSegments)}function _a(g,t,n,c,d,y){const P=g.context,k=P.gl,L=t.dem;if(L&&L.data){const R=L.dim,U=L.stride,G=L.getPixels();if(P.activeTexture.set(k.TEXTURE1),P.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||g.getTileTexture(U),t.demTexture){const he=t.demTexture;he.update(G,{premultiply:!1}),he.bind(k.NEAREST,k.CLAMP_TO_EDGE)}else t.demTexture=new Ze(P,G,k.RGBA,{premultiply:!1}),t.demTexture.bind(k.NEAREST,k.CLAMP_TO_EDGE);P.activeTexture.set(k.TEXTURE0);let K=t.fbo;if(!K){const he=new Ze(P,{width:R,height:R,data:null},k.RGBA);he.bind(k.LINEAR,k.CLAMP_TO_EDGE),K=t.fbo=P.createFramebuffer(R,R,!0,!1),K.colorAttachment.set(he.texture)}P.bindFramebuffer.set(K.framebuffer),P.viewport.set([0,0,R,R]),g.useProgram("hillshadePrepare").draw(P,k.TRIANGLES,c,d,y,Ki.disabled,((he,ce)=>{const fe=ce.stride,ne=s.F();return s.aN(ne,0,s.W,-s.W,0,0,1),s.H(ne,ne,[0,-s.W,0]),{u_matrix:ne,u_image:1,u_dimension:[fe,fe],u_zoom:he.overscaledZ,u_unpack:ce.getUnpackVector()}})(t.tileID,L),null,n.id,g.rasterBoundsBuffer,g.quadTriangleIndexBuffer,g.rasterBoundsSegments),t.needsHillshadePrepare=!1}}function Cs(g,t,n,c,d,y){const P=c.paint.get("raster-fade-duration");if(!y&&P>0){const k=a.now(),L=(k-g.timeAdded)/P,R=t?(k-t.timeAdded)/P:-1,U=n.getSource(),G=d.coveringZoomLevel({tileSize:U.tileSize,roundZoom:U.roundZoom}),K=!t||Math.abs(t.tileID.overscaledZ-G)>Math.abs(g.tileID.overscaledZ-G),he=K&&g.refreshedUponExpiration?1:s.ac(K?L:1-R,0,1);return g.refreshedUponExpiration&&L>=1&&(g.refreshedUponExpiration=!1),t?{opacity:1,mix:1-he}:{opacity:he,mix:0}}return{opacity:1,mix:0}}const ya=new s.aO(1,0,0,1),qo=new s.aO(0,1,0,1),Zs=new s.aO(0,0,1,1),va=new s.aO(1,0,1,1),xa=new s.aO(0,1,1,1);function lr(g,t,n,c){Or(g,0,t+n/2,g.transform.width,n,c)}function hs(g,t,n,c){Or(g,t-n/2,0,n,g.transform.height,c)}function Or(g,t,n,c,d,y){const P=g.context,k=P.gl;k.enable(k.SCISSOR_TEST),k.scissor(t*g.pixelRatio,n*g.pixelRatio,c*g.pixelRatio,d*g.pixelRatio),P.clear({color:y}),k.disable(k.SCISSOR_TEST)}function $o(g,t,n){const c=g.context,d=c.gl,y=n.posMatrix,P=g.useProgram("debug"),k=Ti.disabled,L=Ni.disabled,R=g.colorModeForRenderPass(),U="$debug",G=g.style.map.terrain&&g.style.map.terrain.getTerrainData(n);c.activeTexture.set(d.TEXTURE0);const K=t.getTileByID(n.key).latestRawTileData,he=Math.floor((K&&K.byteLength||0)/1024),ce=t.getTile(n).tileSize,fe=512/Math.min(ce,512)*(n.overscaledZ/g.transform.zoom)*.5;let ne=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(ne+=` => ${n.overscaledZ}`),function(Te,We){Te.initDebugOverlayCanvas();const xe=Te.debugOverlayCanvas,ze=Te.context.gl,$e=Te.debugOverlayCanvas.getContext("2d");$e.clearRect(0,0,xe.width,xe.height),$e.shadowColor="white",$e.shadowBlur=2,$e.lineWidth=1.5,$e.strokeStyle="white",$e.textBaseline="top",$e.font="bold 36px Open Sans, sans-serif",$e.fillText(We,5,5),$e.strokeText(We,5,5),Te.debugOverlayTexture.update(xe),Te.debugOverlayTexture.bind(ze.LINEAR,ze.CLAMP_TO_EDGE)}(g,`${ne} ${he}kB`),P.draw(c,d.TRIANGLES,k,L,er.alphaBlended,Ki.disabled,Wt(y,s.aO.transparent,fe),null,U,g.debugBuffer,g.quadTriangleIndexBuffer,g.debugSegments),P.draw(c,d.LINE_STRIP,k,L,R,Ki.disabled,Wt(y,s.aO.red),G,U,g.debugBuffer,g.tileBorderIndexBuffer,g.debugSegments)}function Yo(g,t,n){const c=g.context,d=c.gl,y=g.colorModeForRenderPass(),P=new Ti(d.LEQUAL,Ti.ReadWrite,g.depthRangeFor3D),k=g.useProgram("terrain"),L=t.getTerrainMesh();c.bindFramebuffer.set(null),c.viewport.set([0,0,g.width,g.height]);for(const R of n){const U=g.renderToTexture.getTexture(R),G=t.getTerrainData(R.tileID);c.activeTexture.set(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,U.texture);const K={u_matrix:g.transform.calculatePosMatrix(R.tileID.toUnwrapped()),u_texture:0,u_ele_delta:t.getMeshFrameDelta(g.transform.zoom)};k.draw(c,d.TRIANGLES,P,Ni.disabled,y,Ki.backCCW,K,G,"terrain",L.vertexBuffer,L.indexBuffer,L.segments)}}class Be{constructor(t,n){this.context=new cs(t),this.transform=n,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:s.an(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=Qi.maxUnderzooming+Qi.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new vs}resize(t,n,c){if(this.width=Math.floor(t*c),this.height=Math.floor(n*c),this.pixelRatio=c,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const d of this.style._order)this.style._layers[d].resize()}setup(){const t=this.context,n=new s.aV;n.emplaceBack(0,0),n.emplaceBack(s.W,0),n.emplaceBack(0,s.W),n.emplaceBack(s.W,s.W),this.tileExtentBuffer=t.createVertexBuffer(n,fo.members),this.tileExtentSegments=s.$.simpleSegment(0,0,4,2);const c=new s.aV;c.emplaceBack(0,0),c.emplaceBack(s.W,0),c.emplaceBack(0,s.W),c.emplaceBack(s.W,s.W),this.debugBuffer=t.createVertexBuffer(c,fo.members),this.debugSegments=s.$.simpleSegment(0,0,4,5);const d=new s.Z;d.emplaceBack(0,0,0,0),d.emplaceBack(s.W,0,s.W,0),d.emplaceBack(0,s.W,0,s.W),d.emplaceBack(s.W,s.W,s.W,s.W),this.rasterBoundsBuffer=t.createVertexBuffer(d,Tt.members),this.rasterBoundsSegments=s.$.simpleSegment(0,0,4,2);const y=new s.aV;y.emplaceBack(0,0),y.emplaceBack(1,0),y.emplaceBack(0,1),y.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(y,fo.members),this.viewportSegments=s.$.simpleSegment(0,0,4,2);const P=new s.aW;P.emplaceBack(0),P.emplaceBack(1),P.emplaceBack(3),P.emplaceBack(2),P.emplaceBack(0),this.tileBorderIndexBuffer=t.createIndexBuffer(P);const k=new s.aX;k.emplaceBack(0,1,2),k.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(k);const L=this.context.gl;this.stencilClearMode=new Ni({func:L.ALWAYS,mask:0},0,255,L.ZERO,L.ZERO,L.ZERO)}clearStencil(){const t=this.context,n=t.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const c=s.F();s.aN(c,0,this.width,this.height,0,0,1),s.J(c,c,[n.drawingBufferWidth,n.drawingBufferHeight,0]),this.useProgram("clippingMask").draw(t,n.TRIANGLES,Ti.disabled,this.stencilClearMode,er.disabled,Ki.disabled,Ft(c),null,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(t,n){if(this.currentStencilSource===t.source||!t.isTileClipped()||!n||!n.length)return;this.currentStencilSource=t.source;const c=this.context,d=c.gl;this.nextStencilID+n.length>256&&this.clearStencil(),c.setColorMode(er.disabled),c.setDepthMode(Ti.disabled);const y=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const P of n){const k=this._tileClippingMaskIDs[P.key]=this.nextStencilID++,L=this.style.map.terrain&&this.style.map.terrain.getTerrainData(P);y.draw(c,d.TRIANGLES,Ti.disabled,new Ni({func:d.ALWAYS,mask:0},k,255,d.KEEP,d.KEEP,d.REPLACE),er.disabled,Ki.disabled,Ft(P.posMatrix),L,"$clipping",this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,n=this.context.gl;return new Ni({func:n.NOTEQUAL,mask:255},t,255,n.KEEP,n.KEEP,n.REPLACE)}stencilModeForClipping(t){const n=this.context.gl;return new Ni({func:n.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,n.KEEP,n.KEEP,n.REPLACE)}stencilConfigForOverlap(t){const n=this.context.gl,c=t.sort((P,k)=>k.overscaledZ-P.overscaledZ),d=c[c.length-1].overscaledZ,y=c[0].overscaledZ-d+1;if(y>1){this.currentStencilSource=void 0,this.nextStencilID+y>256&&this.clearStencil();const P={};for(let k=0;k<y;k++)P[k+d]=new Ni({func:n.GEQUAL,mask:255},k+this.nextStencilID,255,n.KEEP,n.KEEP,n.REPLACE);return this.nextStencilID+=y,[P,c]}return[{[d]:Ni.disabled},c]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new er([t.CONSTANT_COLOR,t.ONE],new s.aO(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?er.unblended:er.alphaBlended}depthModeForSublayer(t,n,c){if(!this.opaquePassEnabledForLayer())return Ti.disabled;const d=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new Ti(c||this.context.gl.LEQUAL,n,[d,d])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(t,n){this.style=t,this.options=n,this.lineAtlas=t.lineAtlas,this.imageManager=t.imageManager,this.glyphManager=t.glyphManager,this.symbolFadeChange=t.placement.symbolFadeChange(a.now()),this.imageManager.beginFrame();const c=this.style._order,d=this.style.sourceCaches,y={},P={},k={};for(const L in d){const R=d[L];R.used&&R.prepare(this.context),y[L]=R.getVisibleCoordinates(),P[L]=y[L].slice().reverse(),k[L]=R.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let L=0;L<c.length;L++)if(this.style._layers[c[L]].is3D()){this.opaquePassCutoff=L;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const L of c){const R=this.style._layers[L];if(!R.hasOffscreenPass()||R.isHidden(this.transform.zoom))continue;const U=P[R.source];(R.type==="custom"||U.length)&&this.renderLayer(this,d[R.source],R,U)}if(this.context.bindFramebuffer.set(null),this.context.clear({color:n.showOverdrawInspector?s.aO.black:s.aO.transparent,depth:1}),this.clearStencil(),this._showOverdrawInspector=n.showOverdrawInspector,this.depthRangeFor3D=[0,1-(t._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=c.length-1;this.currentLayer>=0;this.currentLayer--){const L=this.style._layers[c[this.currentLayer]],R=d[L.source],U=y[L.source];this._renderTileClippingMasks(L,U),this.renderLayer(this,R,L,U)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<c.length;this.currentLayer++){const L=this.style._layers[c[this.currentLayer]],R=d[L.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(L))continue;const U=(L.type==="symbol"?k:P)[L.source];this._renderTileClippingMasks(L,y[L.source]),this.renderLayer(this,R,L,U)}if(this.options.showTileBoundaries){const L=function(R,U){let G=null;const K=Object.values(R._layers).flatMap(ne=>ne.source&&!ne.isHidden(U)?[R.sourceCaches[ne.source]]:[]),he=K.filter(ne=>ne.getSource().type==="vector"),ce=K.filter(ne=>ne.getSource().type!=="vector"),fe=ne=>{(!G||G.getSource().maxzoom<ne.getSource().maxzoom)&&(G=ne)};return he.forEach(ne=>fe(ne)),G||ce.forEach(ne=>fe(ne)),G}(this.style,this.transform.zoom);L&&function(R,U,G){for(let K=0;K<G.length;K++)$o(R,U,G[K])}(this,L,L.getVisibleCoordinates())}this.options.showPadding&&function(L){const R=L.transform.padding;lr(L,L.transform.height-(R.top||0),3,ya),lr(L,R.bottom||0,3,qo),hs(L,R.left||0,3,Zs),hs(L,L.transform.width-(R.right||0),3,va);const U=L.transform.centerPoint;(function(G,K,he,ce){Or(G,K-1,he-10,2,20,ce),Or(G,K-10,he-1,20,2,ce)})(L,U.x,L.transform.height-U.y,xa)}(this),this.context.setDefault()}maybeDrawDepthAndCoords(t){if(!this.style||!this.style.map||!this.style.map.terrain)return;const n=this.terrainFacilitator.matrix,c=this.transform.projMatrix;let d=this.terrainFacilitator.dirty;d||(d=t?!s.aY(n,c):!s.aZ(n,c)),d||(d=this.style.map.terrain.sourceCache.tilesAfterTime(this.terrainFacilitator.renderTime).length>0),d&&(s.a_(n,c),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(y,P){const k=y.context,L=k.gl,R=er.unblended,U=new Ti(L.LEQUAL,Ti.ReadWrite,[0,1]),G=P.getTerrainMesh(),K=P.sourceCache.getRenderableTiles(),he=y.useProgram("terrainDepth");k.bindFramebuffer.set(P.getFramebuffer("depth").framebuffer),k.viewport.set([0,0,y.width/devicePixelRatio,y.height/devicePixelRatio]),k.clear({color:s.aO.transparent,depth:1});for(const ce of K){const fe=P.getTerrainData(ce.tileID),ne={u_matrix:y.transform.calculatePosMatrix(ce.tileID.toUnwrapped()),u_ele_delta:P.getMeshFrameDelta(y.transform.zoom)};he.draw(k,L.TRIANGLES,U,Ni.disabled,R,Ki.backCCW,ne,fe,"terrain",G.vertexBuffer,G.indexBuffer,G.segments)}k.bindFramebuffer.set(null),k.viewport.set([0,0,y.width,y.height])}(this,this.style.map.terrain),function(y,P){const k=y.context,L=k.gl,R=er.unblended,U=new Ti(L.LEQUAL,Ti.ReadWrite,[0,1]),G=P.getTerrainMesh(),K=P.getCoordsTexture(),he=P.sourceCache.getRenderableTiles(),ce=y.useProgram("terrainCoords");k.bindFramebuffer.set(P.getFramebuffer("coords").framebuffer),k.viewport.set([0,0,y.width/devicePixelRatio,y.height/devicePixelRatio]),k.clear({color:s.aO.transparent,depth:1}),P.coordsIndex=[];for(const fe of he){const ne=P.getTerrainData(fe.tileID);k.activeTexture.set(L.TEXTURE0),L.bindTexture(L.TEXTURE_2D,K.texture);const Te={u_matrix:y.transform.calculatePosMatrix(fe.tileID.toUnwrapped()),u_terrain_coords_id:(255-P.coordsIndex.length)/255,u_texture:0,u_ele_delta:P.getMeshFrameDelta(y.transform.zoom)};ce.draw(k,L.TRIANGLES,U,Ni.disabled,R,Ki.backCCW,Te,ne,"terrain",G.vertexBuffer,G.indexBuffer,G.segments),P.coordsIndex.push(fe.tileID.key)}k.bindFramebuffer.set(null),k.viewport.set([0,0,y.width,y.height])}(this,this.style.map.terrain))}renderLayer(t,n,c,d){if(!c.isHidden(this.transform.zoom)&&(c.type==="background"||c.type==="custom"||(d||[]).length))switch(this.id=c.id,c.type){case"symbol":(function(y,P,k,L,R){if(y.renderPass!=="translucent")return;const U=Ni.disabled,G=y.colorModeForRenderPass();(k._unevaluatedLayout.hasValue("text-variable-anchor")||k._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(K,he,ce,fe,ne,Te,We){const xe=he.transform,ze=ne==="map",$e=Te==="map";for(const Ke of K){const rt=fe.getTile(Ke),xt=rt.getBucket(ce);if(!xt||!xt.text||!xt.text.segments.get().length)continue;const yt=s.ag(xt.textSizeData,xe.zoom),At=pi(rt,1,he.transform.zoom),zt=Zt(Ke.posMatrix,$e,ze,he.transform,At),Ci=ce.layout.get("icon-text-fit")!=="none"&&xt.hasIconData();if(yt){const Bt=Math.pow(2,xe.zoom-rt.tileID.overscaledZ);Ho(xt,ze,$e,We,xe,zt,Ke.posMatrix,Bt,yt,Ci,he.style.map.terrain?(di,Si)=>he.style.map.terrain.getElevation(Ke,di,Si):null)}}}(L,y,k,P,k.layout.get("text-rotation-alignment"),k.layout.get("text-pitch-alignment"),R),k.paint.get("icon-opacity").constantOr(1)!==0&&_o(y,P,k,L,!1,k.paint.get("icon-translate"),k.paint.get("icon-translate-anchor"),k.layout.get("icon-rotation-alignment"),k.layout.get("icon-pitch-alignment"),k.layout.get("icon-keep-upright"),U,G),k.paint.get("text-opacity").constantOr(1)!==0&&_o(y,P,k,L,!0,k.paint.get("text-translate"),k.paint.get("text-translate-anchor"),k.layout.get("text-rotation-alignment"),k.layout.get("text-pitch-alignment"),k.layout.get("text-keep-upright"),U,G),P.map.showCollisionBoxes&&(ws(y,P,k,L,k.paint.get("text-translate"),k.paint.get("text-translate-anchor"),!0),ws(y,P,k,L,k.paint.get("icon-translate"),k.paint.get("icon-translate-anchor"),!1))})(t,n,c,d,this.style.placement.variableOffsets);break;case"circle":(function(y,P,k,L){if(y.renderPass!=="translucent")return;const R=k.paint.get("circle-opacity"),U=k.paint.get("circle-stroke-width"),G=k.paint.get("circle-stroke-opacity"),K=!k.layout.get("circle-sort-key").isConstant();if(R.constantOr(1)===0&&(U.constantOr(1)===0||G.constantOr(1)===0))return;const he=y.context,ce=he.gl,fe=y.depthModeForSublayer(0,Ti.ReadOnly),ne=Ni.disabled,Te=y.colorModeForRenderPass(),We=[];for(let xe=0;xe<L.length;xe++){const ze=L[xe],$e=P.getTile(ze),Ke=$e.getBucket(k);if(!Ke)continue;const rt=Ke.programConfigurations.get(k.id),xt=y.useProgram("circle",rt),yt=Ke.layoutVertexBuffer,At=Ke.indexBuffer,zt=y.style.map.terrain&&y.style.map.terrain.getTerrainData(ze),Ci={programConfiguration:rt,program:xt,layoutVertexBuffer:yt,indexBuffer:At,uniformValues:kt(y,ze,$e,k),terrainData:zt};if(K){const Bt=Ke.segments.get();for(const di of Bt)We.push({segments:new s.$([di]),sortKey:di.sortKey,state:Ci})}else We.push({segments:Ke.segments,sortKey:0,state:Ci})}K&&We.sort((xe,ze)=>xe.sortKey-ze.sortKey);for(const xe of We){const{programConfiguration:ze,program:$e,layoutVertexBuffer:Ke,indexBuffer:rt,uniformValues:xt,terrainData:yt}=xe.state;$e.draw(he,ce.TRIANGLES,fe,ne,Te,Ki.disabled,xt,yt,k.id,Ke,rt,xe.segments,k.paint,y.transform.zoom,ze)}})(t,n,c,d);break;case"heatmap":(function(y,P,k,L){if(k.paint.get("heatmap-opacity")!==0)if(y.renderPass==="offscreen"){const R=y.context,U=R.gl,G=Ni.disabled,K=new er([U.ONE,U.ONE],s.aO.transparent,[!0,!0,!0,!0]);(function(he,ce,fe){const ne=he.gl;he.activeTexture.set(ne.TEXTURE1),he.viewport.set([0,0,ce.width/4,ce.height/4]);let Te=fe.heatmapFbo;if(Te)ne.bindTexture(ne.TEXTURE_2D,Te.colorAttachment.get()),he.bindFramebuffer.set(Te.framebuffer);else{const We=ne.createTexture();ne.bindTexture(ne.TEXTURE_2D,We),ne.texParameteri(ne.TEXTURE_2D,ne.TEXTURE_WRAP_S,ne.CLAMP_TO_EDGE),ne.texParameteri(ne.TEXTURE_2D,ne.TEXTURE_WRAP_T,ne.CLAMP_TO_EDGE),ne.texParameteri(ne.TEXTURE_2D,ne.TEXTURE_MIN_FILTER,ne.LINEAR),ne.texParameteri(ne.TEXTURE_2D,ne.TEXTURE_MAG_FILTER,ne.LINEAR),Te=fe.heatmapFbo=he.createFramebuffer(ce.width/4,ce.height/4,!1,!1),function(xe,ze,$e,Ke){var rt,xt;const yt=xe.gl,At=(rt=xe.HALF_FLOAT)!==null&&rt!==void 0?rt:yt.UNSIGNED_BYTE,zt=(xt=xe.RGBA16F)!==null&&xt!==void 0?xt:yt.RGBA;yt.texImage2D(yt.TEXTURE_2D,0,zt,ze.width/4,ze.height/4,0,yt.RGBA,At,null),Ke.colorAttachment.set($e)}(he,ce,We,Te)}})(R,y,k),R.clear({color:s.aO.transparent});for(let he=0;he<L.length;he++){const ce=L[he];if(P.hasRenderableParent(ce))continue;const fe=P.getTile(ce),ne=fe.getBucket(k);if(!ne)continue;const Te=ne.programConfigurations.get(k.id),We=y.useProgram("heatmap",Te),{zoom:xe}=y.transform;We.draw(R,U.TRIANGLES,Ti.disabled,G,K,Ki.disabled,vi(ce.posMatrix,fe,xe,k.paint.get("heatmap-intensity")),null,k.id,ne.layoutVertexBuffer,ne.indexBuffer,ne.segments,k.paint,y.transform.zoom,Te)}R.viewport.set([0,0,y.width,y.height])}else y.renderPass==="translucent"&&(y.context.setColorMode(y.colorModeForRenderPass()),function(R,U){const G=R.context,K=G.gl,he=U.heatmapFbo;if(!he)return;G.activeTexture.set(K.TEXTURE0),K.bindTexture(K.TEXTURE_2D,he.colorAttachment.get()),G.activeTexture.set(K.TEXTURE1);let ce=U.colorRampTexture;ce||(ce=U.colorRampTexture=new Ze(G,U.colorRamp,K.RGBA)),ce.bind(K.LINEAR,K.CLAMP_TO_EDGE),R.useProgram("heatmapTexture").draw(G,K.TRIANGLES,Ti.disabled,Ni.disabled,R.colorModeForRenderPass(),Ki.disabled,((fe,ne,Te,We)=>{const xe=s.F();s.aN(xe,0,fe.width,fe.height,0,0,1);const ze=fe.context.gl;return{u_matrix:xe,u_world:[ze.drawingBufferWidth,ze.drawingBufferHeight],u_image:0,u_color_ramp:1,u_opacity:ne.paint.get("heatmap-opacity")}})(R,U),null,U.id,R.viewportBuffer,R.quadTriangleIndexBuffer,R.viewportSegments,U.paint,R.transform.zoom)}(y,k))})(t,n,c,d);break;case"line":(function(y,P,k,L){if(y.renderPass!=="translucent")return;const R=k.paint.get("line-opacity"),U=k.paint.get("line-width");if(R.constantOr(1)===0||U.constantOr(1)===0)return;const G=y.depthModeForSublayer(0,Ti.ReadOnly),K=y.colorModeForRenderPass(),he=k.paint.get("line-dasharray"),ce=k.paint.get("line-pattern"),fe=ce.constantOr(1),ne=k.paint.get("line-gradient"),Te=k.getCrossfadeParameters(),We=fe?"linePattern":he?"lineSDF":ne?"lineGradient":"line",xe=y.context,ze=xe.gl;let $e=!0;for(const Ke of L){const rt=P.getTile(Ke);if(fe&&!rt.patternsLoaded())continue;const xt=rt.getBucket(k);if(!xt)continue;const yt=xt.programConfigurations.get(k.id),At=y.context.program.get(),zt=y.useProgram(We,yt),Ci=$e||zt.program!==At,Bt=y.style.map.terrain&&y.style.map.terrain.getTerrainData(Ke),di=ce.constantOr(null);if(di&&rt.imageAtlas){const gi=rt.imageAtlas,Ei=gi.patternPositions[di.to.toString()],Mi=gi.patternPositions[di.from.toString()];Ei&&Mi&&yt.setConstantPatternPositions(Ei,Mi)}const Si=Bt?Ke:null,Fi=fe?mt(y,rt,k,Te,Si):he?Qt(y,rt,k,he,Te,Si):ne?Tr(y,rt,k,xt.lineClipsArray.length,Si):xi(y,rt,k,Si);if(fe)xe.activeTexture.set(ze.TEXTURE0),rt.imageAtlasTexture.bind(ze.LINEAR,ze.CLAMP_TO_EDGE),yt.updatePaintBuffers(Te);else if(he&&(Ci||y.lineAtlas.dirty))xe.activeTexture.set(ze.TEXTURE0),y.lineAtlas.bind(xe);else if(ne){const gi=xt.gradients[k.id];let Ei=gi.texture;if(k.gradientVersion!==gi.version){let Mi=256;if(k.stepInterpolant){const Ir=P.getSource().maxzoom,Ji=Ke.canonical.z===Ir?Math.ceil(1<<y.transform.maxZoom-Ke.canonical.z):1;Mi=s.ac(s.aT(xt.maxLineLength/s.W*1024*Ji),256,xe.maxTextureSize)}gi.gradient=s.aU({expression:k.gradientExpression(),evaluationKey:"lineProgress",resolution:Mi,image:gi.gradient||void 0,clips:xt.lineClipsArray}),gi.texture?gi.texture.update(gi.gradient):gi.texture=new Ze(xe,gi.gradient,ze.RGBA),gi.version=k.gradientVersion,Ei=gi.texture}xe.activeTexture.set(ze.TEXTURE0),Ei.bind(k.stepInterpolant?ze.NEAREST:ze.LINEAR,ze.CLAMP_TO_EDGE)}zt.draw(xe,ze.TRIANGLES,G,y.stencilModeForClipping(Ke),K,Ki.disabled,Fi,Bt,k.id,xt.layoutVertexBuffer,xt.indexBuffer,xt.segments,k.paint,y.transform.zoom,yt,xt.layoutVertexBuffer2),$e=!1}})(t,n,c,d);break;case"fill":(function(y,P,k,L){const R=k.paint.get("fill-color"),U=k.paint.get("fill-opacity");if(U.constantOr(1)===0)return;const G=y.colorModeForRenderPass(),K=k.paint.get("fill-pattern"),he=y.opaquePassEnabledForLayer()&&!K.constantOr(1)&&R.constantOr(s.aO.transparent).a===1&&U.constantOr(0)===1?"opaque":"translucent";if(y.renderPass===he){const ce=y.depthModeForSublayer(1,y.renderPass==="opaque"?Ti.ReadWrite:Ti.ReadOnly);zs(y,P,k,L,ce,G,!1)}if(y.renderPass==="translucent"&&k.paint.get("fill-antialias")){const ce=y.depthModeForSublayer(k.getPaintProperty("fill-outline-color")?2:0,Ti.ReadOnly);zs(y,P,k,L,ce,G,!0)}})(t,n,c,d);break;case"fill-extrusion":(function(y,P,k,L){const R=k.paint.get("fill-extrusion-opacity");if(R!==0&&y.renderPass==="translucent"){const U=new Ti(y.context.gl.LEQUAL,Ti.ReadWrite,y.depthRangeFor3D);if(R!==1||k.paint.get("fill-extrusion-pattern").constantOr(1))Xo(y,P,k,L,U,Ni.disabled,er.disabled),Xo(y,P,k,L,U,y.stencilModeFor3D(),y.colorModeForRenderPass());else{const G=y.colorModeForRenderPass();Xo(y,P,k,L,U,Ni.disabled,G)}}})(t,n,c,d);break;case"hillshade":(function(y,P,k,L){if(y.renderPass!=="offscreen"&&y.renderPass!=="translucent")return;const R=y.context,U=y.depthModeForSublayer(0,Ti.ReadOnly),G=y.colorModeForRenderPass(),[K,he]=y.renderPass==="translucent"?y.stencilConfigForOverlap(L):[{},L];for(const ce of he){const fe=P.getTile(ce);fe.needsHillshadePrepare!==void 0&&fe.needsHillshadePrepare&&y.renderPass==="offscreen"?_a(y,fe,k,U,Ni.disabled,G):y.renderPass==="translucent"&&Bn(y,ce,fe,k,U,K[ce.overscaledZ],G)}R.viewport.set([0,0,y.width,y.height])})(t,n,c,d);break;case"raster":(function(y,P,k,L){if(y.renderPass!=="translucent"||k.paint.get("raster-opacity")===0||!L.length)return;const R=y.context,U=R.gl,G=P.getSource(),K=y.useProgram("raster"),he=y.colorModeForRenderPass(),[ce,fe]=G instanceof Nt?[{},L]:y.stencilConfigForOverlap(L),ne=fe[fe.length-1].overscaledZ,Te=!y.options.moving;for(const We of fe){const xe=y.depthModeForSublayer(We.overscaledZ-ne,k.paint.get("raster-opacity")===1?Ti.ReadWrite:Ti.ReadOnly,U.LESS),ze=P.getTile(We);ze.registerFadeDuration(k.paint.get("raster-fade-duration"));const $e=P.findLoadedParent(We,0),Ke=Cs(ze,$e,P,k,y.transform,y.style.map.terrain);let rt,xt;const yt=k.paint.get("raster-resampling")==="nearest"?U.NEAREST:U.LINEAR;R.activeTexture.set(U.TEXTURE0),ze.texture.bind(yt,U.CLAMP_TO_EDGE,U.LINEAR_MIPMAP_NEAREST),R.activeTexture.set(U.TEXTURE1),$e?($e.texture.bind(yt,U.CLAMP_TO_EDGE,U.LINEAR_MIPMAP_NEAREST),rt=Math.pow(2,$e.tileID.overscaledZ-ze.tileID.overscaledZ),xt=[ze.tileID.canonical.x*rt%1,ze.tileID.canonical.y*rt%1]):ze.texture.bind(yt,U.CLAMP_TO_EDGE,U.LINEAR_MIPMAP_NEAREST);const At=y.style.map.terrain&&y.style.map.terrain.getTerrainData(We),zt=At?We:null,Ci=zt?zt.posMatrix:y.transform.calculatePosMatrix(We.toUnwrapped(),Te),Bt=dr(Ci,xt||[0,0],rt||1,Ke,k);G instanceof Nt?K.draw(R,U.TRIANGLES,xe,Ni.disabled,he,Ki.disabled,Bt,At,k.id,G.boundsBuffer,y.quadTriangleIndexBuffer,G.boundsSegments):K.draw(R,U.TRIANGLES,xe,ce[We.overscaledZ],he,Ki.disabled,Bt,At,k.id,y.rasterBoundsBuffer,y.quadTriangleIndexBuffer,y.rasterBoundsSegments)}})(t,n,c,d);break;case"background":(function(y,P,k,L){const R=k.paint.get("background-color"),U=k.paint.get("background-opacity");if(U===0)return;const G=y.context,K=G.gl,he=y.transform,ce=he.tileSize,fe=k.paint.get("background-pattern");if(y.isPatternMissing(fe))return;const ne=!fe&&R.a===1&&U===1&&y.opaquePassEnabledForLayer()?"opaque":"translucent";if(y.renderPass!==ne)return;const Te=Ni.disabled,We=y.depthModeForSublayer(0,ne==="opaque"?Ti.ReadWrite:Ti.ReadOnly),xe=y.colorModeForRenderPass(),ze=y.useProgram(fe?"backgroundPattern":"background"),$e=L||he.coveringTiles({tileSize:ce,terrain:y.style.map.terrain});fe&&(G.activeTexture.set(K.TEXTURE0),y.imageManager.bind(y.context));const Ke=k.getCrossfadeParameters();for(const rt of $e){const xt=L?rt.posMatrix:y.transform.calculatePosMatrix(rt.toUnwrapped()),yt=fe?os(xt,U,y,fe,{tileID:rt,tileSize:ce},Ke):Cl(xt,U,R),At=y.style.map.terrain&&y.style.map.terrain.getTerrainData(rt);ze.draw(G,K.TRIANGLES,We,Te,xe,Ki.disabled,yt,At,k.id,y.tileExtentBuffer,y.quadTriangleIndexBuffer,y.tileExtentSegments)}})(t,0,c,d);break;case"custom":(function(y,P,k){const L=y.context,R=k.implementation;if(y.renderPass==="offscreen"){const U=R.prerender;U&&(y.setCustomLayerDefaults(),L.setColorMode(y.colorModeForRenderPass()),U.call(R,L.gl,y.transform.customLayerMatrix()),L.setDirty(),y.setBaseState())}else if(y.renderPass==="translucent"){y.setCustomLayerDefaults(),L.setColorMode(y.colorModeForRenderPass()),L.setStencilMode(Ni.disabled);const U=R.renderingMode==="3d"?new Ti(y.context.gl.LEQUAL,Ti.ReadWrite,y.depthRangeFor3D):y.depthModeForSublayer(0,Ti.ReadOnly);L.setDepthMode(U),R.render(L.gl,y.transform.customLayerMatrix()),L.setDirty(),y.setBaseState(),L.bindFramebuffer.set(null)}})(t,0,c)}}translatePosMatrix(t,n,c,d,y){if(!c[0]&&!c[1])return t;const P=y?d==="map"?this.transform.angle:0:d==="viewport"?-this.transform.angle:0;if(P){const R=Math.sin(P),U=Math.cos(P);c=[c[0]*U-c[1]*R,c[0]*R+c[1]*U]}const k=[y?c[0]:pi(n,c[0],this.transform.zoom),y?c[1]:pi(n,c[1],this.transform.zoom),0],L=new Float32Array(16);return s.H(L,t,k),L}saveTileTexture(t){const n=this._tileTextures[t.size[0]];n?n.push(t):this._tileTextures[t.size[0]]=[t]}getTileTexture(t){const n=this._tileTextures[t];return n&&n.length>0?n.pop():null}isPatternMissing(t){if(!t)return!1;if(!t.from||!t.to)return!0;const n=this.imageManager.getPattern(t.from.toString()),c=this.imageManager.getPattern(t.to.toString());return!n||!c}useProgram(t,n){this.cache=this.cache||{};const c=t+(n?n.cacheKey:"")+(this._showOverdrawInspector?"/overdraw":"")+(this.style.map.terrain?"/terrain":"");return this.cache[c]||(this.cache[c]=new E(this.context,po[t],n,ca[t],this._showOverdrawInspector,this.style.map.terrain)),this.cache[c]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new Ze(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){const{drawingBufferWidth:t,drawingBufferHeight:n}=this.context.gl;return this.width!==t||this.height!==n}}class tt{constructor(t,n){this.points=t,this.planes=n}static fromInvProjectionMatrix(t,n,c){const d=Math.pow(2,c),y=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(k=>{const L=1/(k=s.af([],k,t))[3]/n*d;return s.a$(k,k,[L,L,1/k[3],L])}),P=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(k=>{const L=function(K,he){var ce=he[0],fe=he[1],ne=he[2],Te=ce*ce+fe*fe+ne*ne;return Te>0&&(Te=1/Math.sqrt(Te)),K[0]=he[0]*Te,K[1]=he[1]*Te,K[2]=he[2]*Te,K}([],function(K,he,ce){var fe=he[0],ne=he[1],Te=he[2],We=ce[0],xe=ce[1],ze=ce[2];return K[0]=ne*ze-Te*xe,K[1]=Te*We-fe*ze,K[2]=fe*xe-ne*We,K}([],ve([],y[k[0]],y[k[1]]),ve([],y[k[2]],y[k[1]]))),R=-((U=L)[0]*(G=y[k[1]])[0]+U[1]*G[1]+U[2]*G[2]);var U,G;return L.concat(R)});return new tt(y,P)}}class Rt{constructor(t,n){this.min=t,this.max=n,this.center=function(c,d,y){return c[0]=.5*d[0],c[1]=.5*d[1],c[2]=.5*d[2],c}([],function(c,d,y){return c[0]=d[0]+y[0],c[1]=d[1]+y[1],c[2]=d[2]+y[2],c}([],this.min,this.max))}quadrant(t){const n=[t%2==0,t<2],c=X(this.min),d=X(this.max);for(let y=0;y<n.length;y++)c[y]=n[y]?this.min[y]:this.center[y],d[y]=n[y]?this.center[y]:this.max[y];return d[2]=this.max[2],new Rt(c,d)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}intersects(t){const n=[[this.min[0],this.min[1],this.min[2],1],[this.max[0],this.min[1],this.min[2],1],[this.max[0],this.max[1],this.min[2],1],[this.min[0],this.max[1],this.min[2],1],[this.min[0],this.min[1],this.max[2],1],[this.max[0],this.min[1],this.max[2],1],[this.max[0],this.max[1],this.max[2],1],[this.min[0],this.max[1],this.max[2],1]];let c=!0;for(let d=0;d<t.planes.length;d++){const y=t.planes[d];let P=0;for(let k=0;k<n.length;k++)s.b0(y,n[k])>=0&&P++;if(P===0)return 0;P!==n.length&&(c=!1)}if(c)return 2;for(let d=0;d<3;d++){let y=Number.MAX_VALUE,P=-Number.MAX_VALUE;for(let k=0;k<t.points.length;k++){const L=t.points[k][d]-this.min[d];y=Math.min(y,L),P=Math.max(P,L)}if(P<0||y>this.max[d]-this.min[d])return 0}return 1}}class oi{constructor(t=0,n=0,c=0,d=0){if(isNaN(t)||t<0||isNaN(n)||n<0||isNaN(c)||c<0||isNaN(d)||d<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=n,this.left=c,this.right=d}interpolate(t,n,c){return n.top!=null&&t.top!=null&&(this.top=s.z.number(t.top,n.top,c)),n.bottom!=null&&t.bottom!=null&&(this.bottom=s.z.number(t.bottom,n.bottom,c)),n.left!=null&&t.left!=null&&(this.left=s.z.number(t.left,n.left,c)),n.right!=null&&t.right!=null&&(this.right=s.z.number(t.right,n.right,c)),this}getCenter(t,n){const c=s.ac((this.left+t-this.right)/2,0,t),d=s.ac((this.top+n-this.bottom)/2,0,n);return new s.P(c,d)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new oi(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const tr=85.051129;class Oi{constructor(t,n,c,d,y){this.tileSize=512,this._renderWorldCopies=y===void 0||!!y,this._minZoom=t||0,this._maxZoom=n||22,this._minPitch=c??0,this._maxPitch=d??60,this.setMaxBounds(),this.width=0,this.height=0,this._center=new s.M(0,0),this._elevation=0,this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._unmodified=!0,this._edgeInsets=new oi,this._posMatrixCache={},this._alignedPosMatrixCache={},this.minElevationForCurrentTile=0}clone(){const t=new Oi(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return t.apply(this),t}apply(t){this.tileSize=t.tileSize,this.latRange=t.latRange,this.width=t.width,this.height=t.height,this._center=t._center,this._elevation=t._elevation,this.minElevationForCurrentTile=t.minElevationForCurrentTile,this.zoom=t.zoom,this.angle=t.angle,this._fov=t._fov,this._pitch=t._pitch,this._unmodified=t._unmodified,this._edgeInsets=t._edgeInsets.clone(),this._calcMatrices()}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this.width,this.height)}get bearing(){return-this.angle/Math.PI*180}set bearing(t){const n=-s.b1(t,-180,180)*Math.PI/180;this.angle!==n&&(this._unmodified=!1,this.angle=n,this._calcMatrices(),this.rotationMatrix=function(){var c=new s.A(4);return s.A!=Float32Array&&(c[1]=0,c[2]=0),c[0]=1,c[3]=1,c}(),function(c,d,y){var P=d[0],k=d[1],L=d[2],R=d[3],U=Math.sin(y),G=Math.cos(y);c[0]=P*G+L*U,c[1]=k*G+R*U,c[2]=P*-U+L*G,c[3]=k*-U+R*G}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const n=s.ac(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==n&&(this._unmodified=!1,this._pitch=n,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=t/180*Math.PI,this._calcMatrices())}get zoom(){return this._zoom}set zoom(t){const n=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==n&&(this._unmodified=!1,this._zoom=n,this.tileZoom=Math.max(0,Math.floor(n)),this.scale=this.zoomScale(n),this._constrain(),this._calcMatrices())}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}set elevation(t){t!==this._elevation&&(this._elevation=t,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,n,c){this._unmodified=!1,this._edgeInsets.interpolate(t,n,c),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const n=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,n)}getVisibleUnwrappedCoordinates(t){const n=[new s.b2(0,t)];if(this._renderWorldCopies){const c=this.pointCoordinate(new s.P(0,0)),d=this.pointCoordinate(new s.P(this.width,0)),y=this.pointCoordinate(new s.P(this.width,this.height)),P=this.pointCoordinate(new s.P(0,this.height)),k=Math.floor(Math.min(c.x,d.x,y.x,P.x)),L=Math.floor(Math.max(c.x,d.x,y.x,P.x)),R=1;for(let U=k-R;U<=L+R;U++)U!==0&&n.push(new s.b2(U,t))}return n}coveringTiles(t){var n,c;let d=this.coveringZoomLevel(t);const y=d;if(t.minzoom!==void 0&&d<t.minzoom)return[];t.maxzoom!==void 0&&d>t.maxzoom&&(d=t.maxzoom);const P=this.pointCoordinate(this.getCameraPoint()),k=s.Y.fromLngLat(this.center),L=Math.pow(2,d),R=[L*P.x,L*P.y,0],U=[L*k.x,L*k.y,0],G=tt.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,d);let K=t.minzoom||0;!t.terrain&&this.pitch<=60&&this._edgeInsets.top<.1&&(K=d);const he=t.terrain?2/Math.min(this.tileSize,t.tileSize)*this.tileSize:3,ce=xe=>({aabb:new Rt([xe*L,0,0],[(xe+1)*L,L,0]),zoom:0,x:0,y:0,wrap:xe,fullyVisible:!1}),fe=[],ne=[],Te=d,We=t.reparseOverscaled?y:d;if(this._renderWorldCopies)for(let xe=1;xe<=3;xe++)fe.push(ce(-xe)),fe.push(ce(xe));for(fe.push(ce(0));fe.length>0;){const xe=fe.pop(),ze=xe.x,$e=xe.y;let Ke=xe.fullyVisible;if(!Ke){const zt=xe.aabb.intersects(G);if(zt===0)continue;Ke=zt===2}const rt=t.terrain?R:U,xt=xe.aabb.distanceX(rt),yt=xe.aabb.distanceY(rt),At=Math.max(Math.abs(xt),Math.abs(yt));if(xe.zoom===Te||At>he+(1<<Te-xe.zoom)-2&&xe.zoom>=K){const zt=Te-xe.zoom,Ci=R[0]-.5-(ze<<zt),Bt=R[1]-.5-($e<<zt);ne.push({tileID:new s.Q(xe.zoom===Te?We:xe.zoom,xe.wrap,xe.zoom,ze,$e),distanceSq:Fe([U[0]-.5-ze,U[1]-.5-$e]),tileDistanceToCamera:Math.sqrt(Ci*Ci+Bt*Bt)})}else for(let zt=0;zt<4;zt++){const Ci=(ze<<1)+zt%2,Bt=($e<<1)+(zt>>1),di=xe.zoom+1;let Si=xe.aabb.quadrant(zt);if(t.terrain){const Fi=new s.Q(di,xe.wrap,di,Ci,Bt),gi=t.terrain.getMinMaxElevation(Fi),Ei=(n=gi.minElevation)!==null&&n!==void 0?n:this.elevation,Mi=(c=gi.maxElevation)!==null&&c!==void 0?c:this.elevation;Si=new Rt([Si.min[0],Si.min[1],Ei],[Si.max[0],Si.max[1],Mi])}fe.push({aabb:Si,zoom:di,x:Ci,y:Bt,wrap:xe.wrap,fullyVisible:Ke})}}return ne.sort((xe,ze)=>xe.distanceSq-ze.distanceSq).map(xe=>xe.tileID)}resize(t,n){this.width=t,this.height=n,this.pixelsToGLUnits=[2/t,-2/n],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const n=s.ac(t.lat,-85.051129,tr);return new s.P(s.N(t.lng)*this.worldSize,s.O(n)*this.worldSize)}unproject(t){return new s.Y(t.x/this.worldSize,t.y/this.worldSize).toLngLat()}get point(){return this.project(this.center)}getCameraPosition(){return{lngLat:this.pointLocation(this.getCameraPoint()),altitude:Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter+this.elevation}}recalculateZoom(t){const n=this.elevation,c=Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter,d=this.pointLocation(this.centerPoint,t),y=t.getElevationForLngLatZoom(d,this.tileZoom);if(!(this.elevation-y))return;const P=c+n-y,k=Math.cos(this._pitch)*this.cameraToCenterDistance/P/s.b3(1,d.lat),L=this.scaleZoom(k/this.tileSize);this._elevation=y,this._center=d,this.zoom=L}setLocationAtPoint(t,n){const c=this.pointCoordinate(n),d=this.pointCoordinate(this.centerPoint),y=this.locationCoordinate(t),P=new s.Y(y.x-(c.x-d.x),y.y-(c.y-d.y));this.center=this.coordinateLocation(P),this._renderWorldCopies&&(this.center=this.center.wrap())}locationPoint(t,n){return n?this.coordinatePoint(this.locationCoordinate(t),n.getElevationForLngLatZoom(t,this.tileZoom),this.pixelMatrix3D):this.coordinatePoint(this.locationCoordinate(t))}pointLocation(t,n){return this.coordinateLocation(this.pointCoordinate(t,n))}locationCoordinate(t){return s.Y.fromLngLat(t)}coordinateLocation(t){return t&&t.toLngLat()}pointCoordinate(t,n){if(n){const K=n.pointCoordinate(t);if(K!=null)return K}const c=[t.x,t.y,0,1],d=[t.x,t.y,1,1];s.af(c,c,this.pixelMatrixInverse),s.af(d,d,this.pixelMatrixInverse);const y=c[3],P=d[3],k=c[1]/y,L=d[1]/P,R=c[2]/y,U=d[2]/P,G=R===U?0:(0-R)/(U-R);return new s.Y(s.z.number(c[0]/y,d[0]/P,G)/this.worldSize,s.z.number(k,L,G)/this.worldSize)}coordinatePoint(t,n=0,c=this.pixelMatrix){const d=[t.x*this.worldSize,t.y*this.worldSize,n,1];return s.af(d,d,c),new s.P(d[0]/d[3],d[1]/d[3])}getBounds(){const t=Math.max(0,this.height/2-this.getHorizon());return new Oe().extend(this.pointLocation(new s.P(0,t))).extend(this.pointLocation(new s.P(this.width,t))).extend(this.pointLocation(new s.P(this.width,this.height))).extend(this.pointLocation(new s.P(0,this.height)))}getMaxBounds(){return this.latRange&&this.latRange.length===2&&this.lngRange&&this.lngRange.length===2?new Oe([this.lngRange[0],this.latRange[0]],[this.lngRange[1],this.latRange[1]]):null}getHorizon(){return Math.tan(Math.PI/2-this._pitch)*this.cameraToCenterDistance*.85}setMaxBounds(t){t?(this.lngRange=[t.getWest(),t.getEast()],this.latRange=[t.getSouth(),t.getNorth()],this._constrain()):(this.lngRange=null,this.latRange=[-85.051129,tr])}calculatePosMatrix(t,n=!1){const c=t.key,d=n?this._alignedPosMatrixCache:this._posMatrixCache;if(d[c])return d[c];const y=t.canonical,P=this.worldSize/this.zoomScale(y.z),k=y.x+Math.pow(2,y.z)*t.wrap,L=s.an(new Float64Array(16));return s.H(L,L,[k*P,y.y*P,0]),s.J(L,L,[P/s.W,P/s.W,1]),s.K(L,n?this.alignedProjMatrix:this.projMatrix,L),d[c]=new Float32Array(L),d[c]}customLayerMatrix(){return this.mercatorMatrix.slice()}getConstrained(t,n){n=s.ac(+n,this.minZoom,this.maxZoom);const c={center:new s.M(t.lng,t.lat),zoom:n};let d=this.lngRange;if(!this._renderWorldCopies&&d===null){const xe=179.9999999999;d=[-xe,xe]}const y=this.tileSize*this.zoomScale(c.zoom);let P=0,k=y,L=0,R=y,U=0,G=0;const{x:K,y:he}=this.size;if(this.latRange){const xe=this.latRange;P=s.O(xe[1])*y,k=s.O(xe[0])*y,k-P<he&&(U=he/(k-P))}d&&(L=s.b1(s.N(d[0])*y,0,y),R=s.b1(s.N(d[1])*y,0,y),R<L&&(R+=y),R-L<K&&(G=K/(R-L)));const{x:ce,y:fe}=this.project.call({worldSize:y},t);let ne,Te;const We=Math.max(G||0,U||0);if(We){const xe=new s.P(G?(R+L)/2:ce,U?(k+P)/2:fe);return c.center=this.unproject.call({worldSize:y},xe).wrap(),c.zoom+=this.scaleZoom(We),c}if(this.latRange){const xe=he/2;fe-xe<P&&(Te=P+xe),fe+xe>k&&(Te=k-xe)}if(d){const xe=(L+R)/2;let ze=ce;this._renderWorldCopies&&(ze=s.b1(ce,xe-y/2,xe+y/2));const $e=K/2;ze-$e<L&&(ne=L+$e),ze+$e>R&&(ne=R-$e)}if(ne!==void 0||Te!==void 0){const xe=new s.P(ne??ce,Te??fe);c.center=this.unproject.call({worldSize:y},xe).wrap()}return c}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this._unmodified,{center:n,zoom:c}=this.getConstrained(this.center,this.zoom);this.center=n,this.zoom=c,this._unmodified=t,this._constraining=!1}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,n=this.point.x,c=this.point.y;this.cameraToCenterDistance=.5/Math.tan(this._fov/2)*this.height,this._pixelPerMeter=s.b3(1,this.center.lat)*this.worldSize;let d=s.an(new Float64Array(16));s.J(d,d,[this.width/2,-this.height/2,1]),s.H(d,d,[1,-1,0]),this.labelPlaneMatrix=d,d=s.an(new Float64Array(16)),s.J(d,d,[1,-1,1]),s.H(d,d,[-1,-1,0]),s.J(d,d,[2/this.width,2/this.height,1]),this.glCoordMatrix=d;const y=this.cameraToCenterDistance+this._elevation*this._pixelPerMeter/Math.cos(this._pitch),P=Math.min(this.elevation,this.minElevationForCurrentTile),k=y-P*this._pixelPerMeter/Math.cos(this._pitch),L=P<0?k:y,R=Math.PI/2+this._pitch,U=this._fov*(.5+t.y/this.height),G=Math.sin(U)*L/Math.sin(s.ac(Math.PI-R-U,.01,Math.PI-.01)),K=this.getHorizon(),he=2*Math.atan(K/this.cameraToCenterDistance)*(.5+t.y/(2*K)),ce=Math.sin(he)*L/Math.sin(s.ac(Math.PI-R-he,.01,Math.PI-.01)),fe=Math.min(G,ce),ne=1.01*(Math.cos(Math.PI/2-this._pitch)*fe+L),Te=this.height/50;d=new Float64Array(16),s.b4(d,this._fov,this.width/this.height,Te,ne),d[8]=2*-t.x/this.width,d[9]=2*t.y/this.height,s.J(d,d,[1,-1,1]),s.H(d,d,[0,0,-this.cameraToCenterDistance]),s.b5(d,d,this._pitch),s.ad(d,d,this.angle),s.H(d,d,[-n,-c,0]),this.mercatorMatrix=s.J([],d,[this.worldSize,this.worldSize,this.worldSize]),s.J(d,d,[1,1,this._pixelPerMeter]),this.pixelMatrix=s.K(new Float64Array(16),this.labelPlaneMatrix,d),s.H(d,d,[0,0,-this.elevation]),this.projMatrix=d,this.invProjMatrix=s.ar([],d),this.pixelMatrix3D=s.K(new Float64Array(16),this.labelPlaneMatrix,d);const We=this.width%2/2,xe=this.height%2/2,ze=Math.cos(this.angle),$e=Math.sin(this.angle),Ke=n-Math.round(n)+ze*We+$e*xe,rt=c-Math.round(c)+ze*xe+$e*We,xt=new Float64Array(d);if(s.H(xt,xt,[Ke>.5?Ke-1:Ke,rt>.5?rt-1:rt,0]),this.alignedProjMatrix=xt,d=s.ar(new Float64Array(16),this.pixelMatrix),!d)throw new Error("failed to invert matrix");this.pixelMatrixInverse=d,this._posMatrixCache={},this._alignedPosMatrixCache={}}maxPitchScaleFactor(){if(!this.pixelMatrixInverse)return 1;const t=this.pointCoordinate(new s.P(0,0)),n=[t.x*this.worldSize,t.y*this.worldSize,0,1];return s.af(n,n,this.pixelMatrix)[3]/this.cameraToCenterDistance}getCameraPoint(){const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(0,t))}getCameraQueryGeometry(t){const n=this.getCameraPoint();if(t.length===1)return[t[0],n];{let c=n.x,d=n.y,y=n.x,P=n.y;for(const k of t)c=Math.min(c,k.x),d=Math.min(d,k.y),y=Math.max(y,k.x),P=Math.max(P,k.y);return[new s.P(c,d),new s.P(y,d),new s.P(y,P),new s.P(c,P),new s.P(c,d)]}}lngLatToCameraDepth(t,n){const c=this.locationCoordinate(t),d=[c.x*this.worldSize,c.y*this.worldSize,n,1];return s.af(d,d,this.projMatrix),d[2]/d[3]}}function cr(g,t){let n,c=!1,d=null,y=null;const P=()=>{d=null,c&&(g.apply(y,n),d=setTimeout(P,t),c=!1)};return(...k)=>(c=!0,y=this,n=k,d||P(),d)}class _r{constructor(t){this._getCurrentHash=()=>{const n=window.location.hash.replace("#","");if(this._hashName){let c;return n.split("&").map(d=>d.split("=")).forEach(d=>{d[0]===this._hashName&&(c=d)}),(c&&c[1]||"").split("/")}return n.split("/")},this._onHashChange=()=>{const n=this._getCurrentHash();if(n.length>=3&&!n.some(c=>isNaN(c))){const c=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(n[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+n[2],+n[1]],zoom:+n[0],bearing:c,pitch:+(n[4]||0)}),!0}return!1},this._updateHashUnthrottled=()=>{const n=window.location.href.replace(/(#.+)?$/,this.getHashString());try{window.history.replaceState(window.history.state,null,n)}catch{}},this._updateHash=cr(this._updateHashUnthrottled,300),this._hashName=t&&encodeURIComponent(t)}addTo(t){return this._map=t,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),delete this._map,this}getHashString(t){const n=this._map.getCenter(),c=Math.round(100*this._map.getZoom())/100,d=Math.ceil((c*Math.LN2+Math.log(512/360/.5))/Math.LN10),y=Math.pow(10,d),P=Math.round(n.lng*y)/y,k=Math.round(n.lat*y)/y,L=this._map.getBearing(),R=this._map.getPitch();let U="";if(U+=t?`/${P}/${k}/${c}`:`${c}/${k}/${P}`,(L||R)&&(U+="/"+Math.round(10*L)/10),R&&(U+=`/${Math.round(R)}`),this._hashName){const G=this._hashName;let K=!1;const he=window.location.hash.slice(1).split("&").map(ce=>{const fe=ce.split("=")[0];return fe===G?(K=!0,`${fe}=${U}`):ce}).filter(ce=>ce);return K||he.push(`${G}=${U}`),`#${he.join("&")}`}return`#${U}`}}const cn={linearity:.3,easing:s.b6(0,0,.3,1)},sr=s.e({deceleration:2500,maxSpeed:1400},cn),Ar=s.e({deceleration:20,maxSpeed:1400},cn),jn=s.e({deceleration:1e3,maxSpeed:360},cn),Kn=s.e({deceleration:1e3,maxSpeed:90},cn);class en{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:a.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,n=a.now();for(;t.length>0&&n-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const n={zoom:0,bearing:0,pitch:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:y}of this._inertiaBuffer)n.zoom+=y.zoomDelta||0,n.bearing+=y.bearingDelta||0,n.pitch+=y.pitchDelta||0,y.panDelta&&n.pan._add(y.panDelta),y.around&&(n.around=y.around),y.pinchAround&&(n.pinchAround=y.pinchAround);const c=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,d={};if(n.pan.mag()){const y=Jn(n.pan.mag(),c,s.e({},sr,t||{}));d.offset=n.pan.mult(y.amount/n.pan.mag()),d.center=this._map.transform.center,_n(d,y)}if(n.zoom){const y=Jn(n.zoom,c,Ar);d.zoom=this._map.transform.zoom+y.amount,_n(d,y)}if(n.bearing){const y=Jn(n.bearing,c,jn);d.bearing=this._map.transform.bearing+s.ac(y.amount,-179,179),_n(d,y)}if(n.pitch){const y=Jn(n.pitch,c,Kn);d.pitch=this._map.transform.pitch+y.amount,_n(d,y)}if(d.zoom||d.bearing){const y=n.pinchAround===void 0?n.around:n.pinchAround;d.around=y?this._map.unproject(y):this._map.getCenter()}return this.clear(),s.e(d,{noMoveStart:!0})}}function _n(g,t){(!g.duration||g.duration<t.duration)&&(g.duration=t.duration,g.easing=t.easing)}function Jn(g,t,n){const{maxSpeed:c,linearity:d,deceleration:y}=n,P=s.ac(g*d/(t/1e3),-c,c),k=Math.abs(P)/(y*d);return{easing:n.easing,duration:1e3*k,amount:P*(k/2)}}class Ur extends s.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c,d={}){const y=l.mousePos(n.getCanvas(),c),P=n.unproject(y);super(t,s.e({point:y,lngLat:P,originalEvent:c},d)),this._defaultPrevented=!1,this.target=n}}class hn extends s.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c){const d=t==="touchend"?c.changedTouches:c.touches,y=l.touchPos(n.getCanvasContainer(),d),P=y.map(L=>n.unproject(L)),k=y.reduce((L,R,U,G)=>L.add(R.div(G.length)),new s.P(0,0));super(t,{points:y,point:k,lngLats:P,lngLat:n.unproject(k),originalEvent:c}),this._defaultPrevented=!1}}class Fs extends s.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c){super(t,{originalEvent:c}),this._defaultPrevented=!1}}class Pn{constructor(t,n){this._map=t,this._clickTolerance=n.clickTolerance}reset(){delete this._mousedownPos}wheel(t){return this._firePreventable(new Fs(t.type,this._map,t))}mousedown(t,n){return this._mousedownPos=n,this._firePreventable(new Ur(t.type,this._map,t))}mouseup(t){this._map.fire(new Ur(t.type,this._map,t))}click(t,n){this._mousedownPos&&this._mousedownPos.dist(n)>=this._clickTolerance||this._map.fire(new Ur(t.type,this._map,t))}dblclick(t){return this._firePreventable(new Ur(t.type,this._map,t))}mouseover(t){this._map.fire(new Ur(t.type,this._map,t))}mouseout(t){this._map.fire(new Ur(t.type,this._map,t))}touchstart(t){return this._firePreventable(new hn(t.type,this._map,t))}touchmove(t){this._map.fire(new hn(t.type,this._map,t))}touchend(t){this._map.fire(new hn(t.type,this._map,t))}touchcancel(t){this._map.fire(new hn(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Qn{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(t){this._map.fire(new Ur(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Ur("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._ignoreContextMenu||this._map.fire(new Ur(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ks{constructor(t){this._map=t}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(t){return this.transform.pointLocation(s.P.convert(t),this._map.terrain)}}class Di{constructor(t,n){this._map=t,this._tr=new Ks(t),this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=n.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,n){this.isEnabled()&&t.shiftKey&&t.button===0&&(l.disableDrag(),this._startPos=this._lastPos=n,this._active=!0)}mousemoveWindow(t,n){if(!this._active)return;const c=n;if(this._lastPos.equals(c)||!this._box&&c.dist(this._startPos)<this._clickTolerance)return;const d=this._startPos;this._lastPos=c,this._box||(this._box=l.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",t));const y=Math.min(d.x,c.x),P=Math.max(d.x,c.x),k=Math.min(d.y,c.y),L=Math.max(d.y,c.y);l.setTransform(this._box,`translate(${y}px,${k}px)`),this._box.style.width=P-y+"px",this._box.style.height=L-k+"px"}mouseupWindow(t,n){if(!this._active||t.button!==0)return;const c=this._startPos,d=n;if(this.reset(),l.suppressClick(),c.x!==d.x||c.y!==d.y)return this._map.fire(new s.k("boxzoomend",{originalEvent:t})),{cameraAnimation:y=>y.fitScreenCoordinates(c,d,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",t)}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(l.remove(this._box),this._box=null),l.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(t,n){return this._map.fire(new s.k(t,{originalEvent:n}))}}function Bi(g,t){if(g.length!==t.length)throw new Error(`The number of touches and points are not equal - touches ${g.length}, points ${t.length}`);const n={};for(let c=0;c<g.length;c++)n[g[c].identifier]=t[c];return n}class Zo{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(t,n,c){(this.centroid||c.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=t.timeStamp),c.length===this.numTouches&&(this.centroid=function(d){const y=new s.P(0,0);for(const P of d)y._add(P);return y.div(d.length)}(n),this.touches=Bi(c,n)))}touchmove(t,n,c){if(this.aborted||!this.centroid)return;const d=Bi(c,n);for(const y in this.touches){const P=d[y];(!P||P.dist(this.touches[y])>30)&&(this.aborted=!0)}}touchend(t,n,c){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),c.length===0){const d=!this.aborted&&this.centroid;if(this.reset(),d)return d}}}class es{constructor(t){this.singleTap=new Zo(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(t,n,c){this.singleTap.touchstart(t,n,c)}touchmove(t,n,c){this.singleTap.touchmove(t,n,c)}touchend(t,n,c){const d=this.singleTap.touchend(t,n,c);if(d){const y=t.timeStamp-this.lastTime<500,P=!this.lastTap||this.lastTap.dist(d)<30;if(y&&P||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=d,this.count===this.numTaps)return this.reset(),d}}}class ba{constructor(t){this._tr=new Ks(t),this._zoomIn=new es({numTouches:1,numTaps:2}),this._zoomOut=new es({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,n,c){this._zoomIn.touchstart(t,n,c),this._zoomOut.touchstart(t,n,c)}touchmove(t,n,c){this._zoomIn.touchmove(t,n,c),this._zoomOut.touchmove(t,n,c)}touchend(t,n,c){const d=this._zoomIn.touchend(t,n,c),y=this._zoomOut.touchend(t,n,c),P=this._tr;return d?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:k=>k.easeTo({duration:300,zoom:P.zoom+1,around:P.unproject(d)},{originalEvent:t})}):y?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:k=>k.easeTo({duration:300,zoom:P.zoom-1,around:P.unproject(y)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Gr{constructor(t){this._enabled=!!t.enable,this._moveStateManager=t.moveStateManager,this._clickTolerance=t.clickTolerance||1,this._moveFunction=t.move,this._activateOnStart=!!t.activateOnStart,t.assignEvents(this),this.reset()}reset(t){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(t)}_move(...t){const n=this._moveFunction(...t);if(n.bearingDelta||n.pitchDelta||n.around||n.panDelta)return this._active=!0,n}dragStart(t,n){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(t)&&(this._moveStateManager.startMove(t),this._lastPoint=n.length?n[0]:n,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(t,n){if(!this.isEnabled())return;const c=this._lastPoint;if(!c)return;if(t.preventDefault(),!this._moveStateManager.isValidMoveEvent(t))return void this.reset(t);const d=n.length?n[0]:n;return!this._moved&&d.dist(c)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=d,this._move(c,d))}dragEnd(t){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(t)&&(this._moved&&l.suppressClick(),this.reset(t))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const yn={0:1,2:2};class Hr{constructor(t){this._correctEvent=t.checkCorrectEvent}startMove(t){const n=l.mouseButton(t);this._eventButton=n}endMove(t){delete this._eventButton}isValidStartEvent(t){return this._correctEvent(t)}isValidMoveEvent(t){return!function(n,c){const d=yn[c];return n.buttons===void 0||(n.buttons&d)!==d}(t,this._eventButton)}isValidEndEvent(t){return l.mouseButton(t)===this._eventButton}}class qt{constructor(){this._firstTouch=void 0}_isOneFingerTouch(t){return t.targetTouches.length===1}_isSameTouchEvent(t){return t.targetTouches[0].identifier===this._firstTouch}startMove(t){this._firstTouch=t.targetTouches[0].identifier}endMove(t){delete this._firstTouch}isValidStartEvent(t){return this._isOneFingerTouch(t)}isValidMoveEvent(t){return this._isOneFingerTouch(t)&&this._isSameTouchEvent(t)}isValidEndEvent(t){return this._isOneFingerTouch(t)&&this._isSameTouchEvent(t)}}const Rs=g=>{g.mousedown=g.dragStart,g.mousemoveWindow=g.dragMove,g.mouseup=g.dragEnd,g.contextmenu=function(t){t.preventDefault()}},Nn=({enable:g,clickTolerance:t,bearingDegreesPerPixelMoved:n=.8})=>{const c=new Hr({checkCorrectEvent:d=>l.mouseButton(d)===0&&d.ctrlKey||l.mouseButton(d)===2});return new Gr({clickTolerance:t,move:(d,y)=>({bearingDelta:(y.x-d.x)*n}),moveStateManager:c,enable:g,assignEvents:Rs})},An=({enable:g,clickTolerance:t,pitchDegreesPerPixelMoved:n=-.5})=>{const c=new Hr({checkCorrectEvent:d=>l.mouseButton(d)===0&&d.ctrlKey||l.mouseButton(d)===2});return new Gr({clickTolerance:t,move:(d,y)=>({pitchDelta:(y.y-d.y)*n}),moveStateManager:c,enable:g,assignEvents:Rs})};class wa{constructor(t,n){this._clickTolerance=t.clickTolerance||1,this._map=n,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}minTouchs(){return this._map.cooperativeGestures.isEnabled()?2:1}touchstart(t,n,c){return this._calculateTransform(t,n,c)}touchmove(t,n,c){if(this._active&&!(c.length<this.minTouchs()))return t.preventDefault(),this._calculateTransform(t,n,c)}touchend(t,n,c){this._calculateTransform(t,n,c),this._active&&c.length<this.minTouchs()&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,n,c){c.length>0&&(this._active=!0);const d=Bi(c,n),y=new s.P(0,0),P=new s.P(0,0);let k=0;for(const R in d){const U=d[R],G=this._touches[R];G&&(y._add(U),P._add(U.sub(G)),k++,d[R]=U)}if(this._touches=d,k<this.minTouchs()||!P.mag())return;const L=P.div(k);return this._sum._add(L),this._sum.mag()<this._clickTolerance?void 0:{around:y.div(k),panDelta:L}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Vt{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(t,n,c){this._firstTwoTouches||c.length<2||(this._firstTwoTouches=[c[0].identifier,c[1].identifier],this._start([n[0],n[1]]))}touchmove(t,n,c){if(!this._firstTwoTouches)return;t.preventDefault();const[d,y]=this._firstTwoTouches,P=Ss(c,n,d),k=Ss(c,n,y);if(!P||!k)return;const L=this._aroundCenter?null:P.add(k).div(2);return this._move([P,k],L,t)}touchend(t,n,c){if(!this._firstTwoTouches)return;const[d,y]=this._firstTwoTouches,P=Ss(c,n,d),k=Ss(c,n,y);P&&k||(this._active&&l.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function Ss(g,t,n){for(let c=0;c<g.length;c++)if(g[c].identifier===n)return t[c]}function yo(g,t){return Math.log(g/t)/Math.LN2}class vo extends Vt{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,n){const c=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(yo(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:yo(this._distance,c),pinchAround:n}}}function xo(g,t){return 180*g.angleWith(t)/Math.PI}class Js extends Vt{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,n,c){const d=this._vector;if(this._vector=t[0].sub(t[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:xo(this._vector,d),pinchAround:n}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const n=25/(Math.PI*this._minDiameter)*360,c=xo(t,this._startVector);return Math.abs(c)<n}}function Bs(g){return Math.abs(g.y)>Math.abs(g.x)}class oc extends Vt{constructor(t){super(),this._currentTouchCount=0,this._map=t}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(t,n,c){super.touchstart(t,n,c),this._currentTouchCount=c.length}_start(t){this._lastPoints=t,Bs(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,n,c){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const d=t[0].sub(this._lastPoints[0]),y=t[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(d,y,c.timeStamp),this._valid?(this._lastPoints=t,this._active=!0,{pitchDelta:(d.y+y.y)/2*-.5}):void 0}gestureBeginsVertically(t,n,c){if(this._valid!==void 0)return this._valid;const d=t.mag()>=2,y=n.mag()>=2;if(!d&&!y)return;if(!d||!y)return this._firstMove===void 0&&(this._firstMove=c),c-this._firstMove<100&&void 0;const P=t.y>0==n.y>0;return Bs(t)&&Bs(n)&&P}}const Gc={panStep:100,bearingStep:15,pitchStep:10};class Qs{constructor(t){this._tr=new Ks(t);const n=Gc;this._panStep=n.panStep,this._bearingStep=n.bearingStep,this._pitchStep=n.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let n=0,c=0,d=0,y=0,P=0;switch(t.keyCode){case 61:case 107:case 171:case 187:n=1;break;case 189:case 109:case 173:n=-1;break;case 37:t.shiftKey?c=-1:(t.preventDefault(),y=-1);break;case 39:t.shiftKey?c=1:(t.preventDefault(),y=1);break;case 38:t.shiftKey?d=1:(t.preventDefault(),P=-1);break;case 40:t.shiftKey?d=-1:(t.preventDefault(),P=1);break;default:return}return this._rotationDisabled&&(c=0,d=0),{cameraAnimation:k=>{const L=this._tr;k.easeTo({duration:300,easeId:"keyboardHandler",easing:fr,zoom:n?Math.round(L.zoom)+n*(t.shiftKey?2:1):L.zoom,bearing:L.bearing+c*this._bearingStep,pitch:L.pitch+d*this._pitchStep,offset:[-y*this._panStep,-P*this._panStep],center:L.center},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function fr(g){return g*(2-g)}const Ca=4.000244140625;class Ka{constructor(t,n){this._onTimeout=c=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(c)},this._map=t,this._tr=new Ks(t),this._triggerRenderFrame=n,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}wheel(t){if(!this.isEnabled()||this._map.cooperativeGestures.isEnabled()&&!t[this._map.cooperativeGestures._bypassKey])return;let n=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const c=a.now(),d=c-(this._lastWheelEventTime||0);this._lastWheelEventTime=c,n!==0&&n%Ca==0?this._type="wheel":n!==0&&Math.abs(n)<4?this._type="trackpad":d>400?(this._type=null,this._lastValue=n,this._timeout=setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(d*n)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,n+=this._lastValue)),t.shiftKey&&n&&(n/=4),this._type&&(this._lastWheelEvent=t,this._delta-=n,this._active||this._start(t)),t.preventDefault()}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const n=l.mousePos(this._map.getCanvas(),t),c=this._tr;this._around=n.y>c.transform.height/2-c.transform.getHorizon()?s.M.convert(this._aroundCenter?c.center:c.unproject(n)):s.M.convert(c.center),this._aroundPoint=c.transform.locationPoint(this._around),this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._tr.transform;if(this._delta!==0){const k=this._type==="wheel"&&Math.abs(this._delta)>Ca?this._wheelZoomRate:this._defaultZoomRate;let L=2/(1+Math.exp(-Math.abs(this._delta*k)));this._delta<0&&L!==0&&(L=1/L);const R=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):t.scale;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(R*L))),this._type==="wheel"&&(this._startZoom=t.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const n=typeof this._targetZoom=="number"?this._targetZoom:t.zoom,c=this._startZoom,d=this._easing;let y,P=!1;if(this._type==="wheel"&&c&&d){const k=Math.min((a.now()-this._lastWheelEventTime)/200,1),L=d(k);y=s.z.number(c,n,L),k<1?this._frameId||(this._frameId=!0):P=!0}else y=n,P=!0;return this._active=!0,P&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!P,zoomDelta:y-t.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let n=s.b7;if(this._prevEase){const c=this._prevEase,d=(a.now()-c.start)/c.duration,y=c.easing(d+.01)-c.easing(d),P=.27/Math.sqrt(y*y+1e-4)*.01,k=Math.sqrt(.0729-P*P);n=s.b6(P,k,.25,1)}return this._prevEase={start:a.now(),duration:t,easing:n},n}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class El{constructor(t,n){this._clickZoom=t,this._tapZoom=n}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class ac{constructor(t){this._tr=new Ks(t),this.reset()}reset(){this._active=!1}dblclick(t,n){return t.preventDefault(),{cameraAnimation:c=>{c.easeTo({duration:300,zoom:this._tr.zoom+(t.shiftKey?-1:1),around:this._tr.unproject(n)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class lc{constructor(){this._tap=new es({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(t,n,c){if(!this._swipePoint)if(this._tapTime){const d=n[0],y=t.timeStamp-this._tapTime<500,P=this._tapPoint.dist(d)<30;y&&P?c.length>0&&(this._swipePoint=d,this._swipeTouch=c[0].identifier):this.reset()}else this._tap.touchstart(t,n,c)}touchmove(t,n,c){if(this._tapTime){if(this._swipePoint){if(c[0].identifier!==this._swipeTouch)return;const d=n[0],y=d.y-this._swipePoint.y;return this._swipePoint=d,t.preventDefault(),this._active=!0,{zoomDelta:y/128}}}else this._tap.touchmove(t,n,c)}touchend(t,n,c){if(this._tapTime)this._swipePoint&&c.length===0&&this.reset();else{const d=this._tap.touchend(t,n,c);d&&(this._tapTime=t.timeStamp,this._tapPoint=d)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class cc{constructor(t,n,c){this._el=t,this._mousePan=n,this._touchPan=c}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class us{constructor(t,n,c){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=n,this._mousePitch=c}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Sa{constructor(t,n,c,d){this._el=t,this._touchZoom=n,this._touchRotate=c,this._tapDragZoom=d,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class si{constructor(t,n){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=t,this._options=n,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const t=this._map.getCanvasContainer();t.classList.add("maplibregl-cooperative-gestures"),this._container=l.create("div","maplibregl-cooperative-gesture-screen",t);let n=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(n=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const c=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),d=document.createElement("div");d.className="maplibregl-desktop-message",d.textContent=n,this._container.appendChild(d);const y=document.createElement("div");y.className="maplibregl-mobile-message",y.textContent=c,this._container.appendChild(y),this._container.setAttribute("aria-hidden","true")}_destoryUI(){this._container&&(l.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destoryUI()}isEnabled(){return this._enabled}touchmove(t){this._onCooperativeGesture(t.touches.length===1)}wheel(t){this._map.scrollZoom.isEnabled()&&this._onCooperativeGesture(!t[this._bypassKey])}_onCooperativeGesture(t){this._enabled&&t&&(this._container.classList.add("maplibregl-show"),setTimeout(()=>{this._container.classList.remove("maplibregl-show")},100))}}const hi=g=>g.zoom||g.drag||g.pitch||g.rotate;class Ja extends s.k{}function Ta(g){return g.panDelta&&g.panDelta.mag()||g.zoomDelta||g.bearingDelta||g.pitchDelta}class Il{constructor(t,n){this.handleWindowEvent=d=>{this.handleEvent(d,`${d.type}Window`)},this.handleEvent=(d,y)=>{if(d.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const P=d.type==="renderFrame"?void 0:d,k={needsRenderFrame:!1},L={},R={},U=d.touches,G=U?this._getMapTouches(U):void 0,K=G?l.touchPos(this._map.getCanvas(),G):l.mousePos(this._map.getCanvas(),d);for(const{handlerName:fe,handler:ne,allowed:Te}of this._handlers){if(!ne.isEnabled())continue;let We;this._blockedByActive(R,Te,fe)?ne.reset():ne[y||d.type]&&(We=ne[y||d.type](d,K,G),this.mergeHandlerResult(k,L,We,fe,P),We&&We.needsRenderFrame&&this._triggerRenderFrame()),(We||ne.isActive())&&(R[fe]=ne)}const he={};for(const fe in this._previousActiveHandlers)R[fe]||(he[fe]=P);this._previousActiveHandlers=R,(Object.keys(he).length||Ta(k))&&(this._changes.push([k,L,he]),this._triggerRenderFrame()),(Object.keys(R).length||Ta(k))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:ce}=k;ce&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],ce(this._map))},this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new en(t),this._bearingSnap=n.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(n);const c=this._el;this._listeners=[[c,"touchstart",{passive:!0}],[c,"touchmove",{passive:!1}],[c,"touchend",void 0],[c,"touchcancel",void 0],[c,"mousedown",void 0],[c,"mousemove",void 0],[c,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[c,"mouseover",void 0],[c,"mouseout",void 0],[c,"dblclick",void 0],[c,"click",void 0],[c,"keydown",{capture:!1}],[c,"keyup",void 0],[c,"wheel",{passive:!1}],[c,"contextmenu",void 0],[window,"blur",void 0]];for(const[d,y,P]of this._listeners)l.addEventListener(d,y,d===document?this.handleWindowEvent:this.handleEvent,P)}destroy(){for(const[t,n,c]of this._listeners)l.removeEventListener(t,n,t===document?this.handleWindowEvent:this.handleEvent,c)}_addDefaultHandlers(t){const n=this._map,c=n.getCanvasContainer();this._add("mapEvent",new Pn(n,t));const d=n.boxZoom=new Di(n,t);this._add("boxZoom",d),t.interactive&&t.boxZoom&&d.enable();const y=n.cooperativeGestures=new si(n,t.cooperativeGestures);this._add("cooperativeGestures",y),t.cooperativeGestures&&y.enable();const P=new ba(n),k=new ac(n);n.doubleClickZoom=new El(k,P),this._add("tapZoom",P),this._add("clickZoom",k),t.interactive&&t.doubleClickZoom&&n.doubleClickZoom.enable();const L=new lc;this._add("tapDragZoom",L);const R=n.touchPitch=new oc(n);this._add("touchPitch",R),t.interactive&&t.touchPitch&&n.touchPitch.enable(t.touchPitch);const U=Nn(t),G=An(t);n.dragRotate=new us(t,U,G),this._add("mouseRotate",U,["mousePitch"]),this._add("mousePitch",G,["mouseRotate"]),t.interactive&&t.dragRotate&&n.dragRotate.enable();const K=(({enable:We,clickTolerance:xe})=>{const ze=new Hr({checkCorrectEvent:$e=>l.mouseButton($e)===0&&!$e.ctrlKey});return new Gr({clickTolerance:xe,move:($e,Ke)=>({around:Ke,panDelta:Ke.sub($e)}),activateOnStart:!0,moveStateManager:ze,enable:We,assignEvents:Rs})})(t),he=new wa(t,n);n.dragPan=new cc(c,K,he),this._add("mousePan",K),this._add("touchPan",he,["touchZoom","touchRotate"]),t.interactive&&t.dragPan&&n.dragPan.enable(t.dragPan);const ce=new Js,fe=new vo;n.touchZoomRotate=new Sa(c,fe,ce,L),this._add("touchRotate",ce,["touchPan","touchZoom"]),this._add("touchZoom",fe,["touchPan","touchRotate"]),t.interactive&&t.touchZoomRotate&&n.touchZoomRotate.enable(t.touchZoomRotate);const ne=n.scrollZoom=new Ka(n,()=>this._triggerRenderFrame());this._add("scrollZoom",ne,["mousePan"]),t.interactive&&t.scrollZoom&&n.scrollZoom.enable(t.scrollZoom);const Te=n.keyboard=new Qs(n);this._add("keyboard",Te),t.interactive&&t.keyboard&&n.keyboard.enable(),this._add("blockableMapEvent",new Qn(n))}_add(t,n,c){this._handlers.push({handlerName:t,handler:n,allowed:c}),this._handlersById[t]=n}stop(t){if(!this._updatingCamera){for(const{handler:n}of this._handlers)n.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[]}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!hi(this._eventsInProgress)||this.isZooming()}_blockedByActive(t,n,c){for(const d in t)if(d!==c&&(!n||n.indexOf(d)<0))return!0;return!1}_getMapTouches(t){const n=[];for(const c of t)this._el.contains(c.target)&&n.push(c);return n}mergeHandlerResult(t,n,c,d,y){if(!c)return;s.e(t,c);const P={handlerName:d,originalEvent:c.originalEvent||y};c.zoomDelta!==void 0&&(n.zoom=P),c.panDelta!==void 0&&(n.drag=P),c.pitchDelta!==void 0&&(n.pitch=P),c.bearingDelta!==void 0&&(n.rotate=P)}_applyChanges(){const t={},n={},c={};for(const[d,y,P]of this._changes)d.panDelta&&(t.panDelta=(t.panDelta||new s.P(0,0))._add(d.panDelta)),d.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+d.zoomDelta),d.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+d.bearingDelta),d.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+d.pitchDelta),d.around!==void 0&&(t.around=d.around),d.pinchAround!==void 0&&(t.pinchAround=d.pinchAround),d.noInertia&&(t.noInertia=d.noInertia),s.e(n,y),s.e(c,P);this._updateMapTransform(t,n,c),this._changes=[]}_updateMapTransform(t,n,c){const d=this._map,y=d._getTransformForUpdate(),P=d.terrain;if(!(Ta(t)||P&&this._terrainMovement))return this._fireEvents(n,c,!0);let{panDelta:k,zoomDelta:L,bearingDelta:R,pitchDelta:U,around:G,pinchAround:K}=t;K!==void 0&&(G=K),d._stop(!0),G=G||d.transform.centerPoint;const he=y.pointLocation(k?G.sub(k):G);R&&(y.bearing+=R),U&&(y.pitch+=U),L&&(y.zoom+=L),P?this._terrainMovement||!n.drag&&!n.zoom?n.drag&&this._terrainMovement?y.center=y.pointLocation(y.centerPoint.sub(k)):y.setLocationAtPoint(he,G):(this._terrainMovement=!0,this._map._elevationFreeze=!0,y.setLocationAtPoint(he,G),this._map.once("moveend",()=>{this._map._elevationFreeze=!1,this._terrainMovement=!1,y.recalculateZoom(d.terrain)})):y.setLocationAtPoint(he,G),d._applyUpdatedTransform(y),this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(n,c,!0)}_fireEvents(t,n,c){const d=hi(this._eventsInProgress),y=hi(t),P={};for(const U in t){const{originalEvent:G}=t[U];this._eventsInProgress[U]||(P[`${U}start`]=G),this._eventsInProgress[U]=t[U]}!d&&y&&this._fireEvent("movestart",y.originalEvent);for(const U in P)this._fireEvent(U,P[U]);y&&this._fireEvent("move",y.originalEvent);for(const U in t){const{originalEvent:G}=t[U];this._fireEvent(U,G)}const k={};let L;for(const U in this._eventsInProgress){const{handlerName:G,originalEvent:K}=this._eventsInProgress[U];this._handlersById[G].isActive()||(delete this._eventsInProgress[U],L=n[G]||K,k[`${U}end`]=L)}for(const U in k)this._fireEvent(U,k[U]);const R=hi(this._eventsInProgress);if(c&&(d||y)&&!R){this._updatingCamera=!0;const U=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),G=K=>K!==0&&-this._bearingSnap<K&&K<this._bearingSnap;!U||!U.essential&&a.prefersReducedMotion?(this._map.fire(new s.k("moveend",{originalEvent:L})),G(this._map.getBearing())&&this._map.resetNorth()):(G(U.bearing||this._map.getBearing())&&(U.bearing=0),U.freezeElevation=!0,this._map.easeTo(U,{originalEvent:L})),this._updatingCamera=!1}}_fireEvent(t,n){this._map.fire(new s.k(t,n?{originalEvent:n}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{delete this._frameId,this.handleEvent(new Ja("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class Mn extends s.E{constructor(t,n){super(),this._renderFrameCallback=()=>{const c=Math.min((a.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(c)),c<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=n.bearingSnap,this.on("moveend",()=>{delete this._requestedCameraState})}getCenter(){return new s.M(this.transform.center.lng,this.transform.center.lat)}setCenter(t,n){return this.jumpTo({center:t},n)}panBy(t,n,c){return t=s.P.convert(t).mult(-1),this.panTo(this.transform.center,s.e({offset:t},n),c)}panTo(t,n,c){return this.easeTo(s.e({center:t},n),c)}getZoom(){return this.transform.zoom}setZoom(t,n){return this.jumpTo({zoom:t},n),this}zoomTo(t,n,c){return this.easeTo(s.e({zoom:t},n),c)}zoomIn(t,n){return this.zoomTo(this.getZoom()+1,t,n),this}zoomOut(t,n){return this.zoomTo(this.getZoom()-1,t,n),this}getBearing(){return this.transform.bearing}setBearing(t,n){return this.jumpTo({bearing:t},n),this}getPadding(){return this.transform.padding}setPadding(t,n){return this.jumpTo({padding:t},n),this}rotateTo(t,n,c){return this.easeTo(s.e({bearing:t},n),c)}resetNorth(t,n){return this.rotateTo(0,s.e({duration:1e3},t),n),this}resetNorthPitch(t,n){return this.easeTo(s.e({bearing:0,pitch:0,duration:1e3},t),n),this}snapToNorth(t,n){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,n):this}getPitch(){return this.transform.pitch}setPitch(t,n){return this.jumpTo({pitch:t},n),this}cameraForBounds(t,n){t=Oe.convert(t);const c=n&&n.bearing||0;return this._cameraForBoxAndBearing(t.getNorthWest(),t.getSouthEast(),c,n)}_cameraForBoxAndBearing(t,n,c,d){const y={top:0,bottom:0,right:0,left:0};if(typeof(d=s.e({padding:y,offset:[0,0],maxZoom:this.transform.maxZoom},d)).padding=="number"){const zt=d.padding;d.padding={top:zt,bottom:zt,right:zt,left:zt}}d.padding=s.e(y,d.padding);const P=this.transform,k=P.padding,L=new Oe(t,n),R=P.project(L.getNorthWest()),U=P.project(L.getNorthEast()),G=P.project(L.getSouthEast()),K=P.project(L.getSouthWest()),he=s.b8(-c),ce=R.rotate(he),fe=U.rotate(he),ne=G.rotate(he),Te=K.rotate(he),We=new s.P(Math.max(ce.x,fe.x,Te.x,ne.x),Math.max(ce.y,fe.y,Te.y,ne.y)),xe=new s.P(Math.min(ce.x,fe.x,Te.x,ne.x),Math.min(ce.y,fe.y,Te.y,ne.y)),ze=We.sub(xe),$e=(P.width-(k.left+k.right+d.padding.left+d.padding.right))/ze.x,Ke=(P.height-(k.top+k.bottom+d.padding.top+d.padding.bottom))/ze.y;if(Ke<0||$e<0)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const rt=Math.min(P.scaleZoom(P.scale*Math.min($e,Ke)),d.maxZoom),xt=s.P.convert(d.offset),yt=new s.P((d.padding.left-d.padding.right)/2,(d.padding.top-d.padding.bottom)/2).rotate(s.b8(c)),At=xt.add(yt).mult(P.scale/P.zoomScale(rt));return{center:P.unproject(R.add(G).div(2).sub(At)),zoom:rt,bearing:c}}fitBounds(t,n,c){return this._fitInternal(this.cameraForBounds(t,n),n,c)}fitScreenCoordinates(t,n,c,d,y){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.pointLocation(s.P.convert(t)),this.transform.pointLocation(s.P.convert(n)),c,d),d,y)}_fitInternal(t,n,c){return t?(delete(n=s.e(t,n)).padding,n.linear?this.easeTo(n,c):this.flyTo(n,c)):this}jumpTo(t,n){this.stop();const c=this._getTransformForUpdate();let d=!1,y=!1,P=!1;return"zoom"in t&&c.zoom!==+t.zoom&&(d=!0,c.zoom=+t.zoom),t.center!==void 0&&(c.center=s.M.convert(t.center)),"bearing"in t&&c.bearing!==+t.bearing&&(y=!0,c.bearing=+t.bearing),"pitch"in t&&c.pitch!==+t.pitch&&(P=!0,c.pitch=+t.pitch),t.padding==null||c.isPaddingEqual(t.padding)||(c.padding=t.padding),this._applyUpdatedTransform(c),this.fire(new s.k("movestart",n)).fire(new s.k("move",n)),d&&this.fire(new s.k("zoomstart",n)).fire(new s.k("zoom",n)).fire(new s.k("zoomend",n)),y&&this.fire(new s.k("rotatestart",n)).fire(new s.k("rotate",n)).fire(new s.k("rotateend",n)),P&&this.fire(new s.k("pitchstart",n)).fire(new s.k("pitch",n)).fire(new s.k("pitchend",n)),this.fire(new s.k("moveend",n))}calculateCameraOptionsFromTo(t,n,c,d=0){const y=s.Y.fromLngLat(t,n),P=s.Y.fromLngLat(c,d),k=P.x-y.x,L=P.y-y.y,R=P.z-y.z,U=Math.hypot(k,L,R);if(U===0)throw new Error("Can't calculate camera options with same From and To");const G=Math.hypot(k,L),K=this.transform.scaleZoom(this.transform.cameraToCenterDistance/U/this.transform.tileSize),he=180*Math.atan2(k,-L)/Math.PI;let ce=180*Math.acos(G/U)/Math.PI;return ce=R<0?90-ce:90+ce,{center:P.toLngLat(),zoom:K,pitch:ce,bearing:he}}easeTo(t,n){var c;this._stop(!1,t.easeId),((t=s.e({offset:[0,0],duration:500,easing:s.b7},t)).animate===!1||!t.essential&&a.prefersReducedMotion)&&(t.duration=0);const d=this._getTransformForUpdate(),y=this.getZoom(),P=this.getBearing(),k=this.getPitch(),L=this.getPadding(),R="bearing"in t?this._normalizeBearing(t.bearing,P):P,U="pitch"in t?+t.pitch:k,G="padding"in t?t.padding:d.padding,K=s.P.convert(t.offset);let he=d.centerPoint.add(K);const ce=d.pointLocation(he),{center:fe,zoom:ne}=d.getConstrained(s.M.convert(t.center||ce),(c=t.zoom)!==null&&c!==void 0?c:y);this._normalizeCenter(fe);const Te=d.project(ce),We=d.project(fe).sub(Te),xe=d.zoomScale(ne-y);let ze,$e;t.around&&(ze=s.M.convert(t.around),$e=d.locationPoint(ze));const Ke={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=this._zooming||ne!==y,this._rotating=this._rotating||P!==R,this._pitching=this._pitching||U!==k,this._padding=!d.isPaddingEqual(G),this._easeId=t.easeId,this._prepareEase(n,t.noMoveStart,Ke),this.terrain&&this._prepareElevation(fe),this._ease(rt=>{if(this._zooming&&(d.zoom=s.z.number(y,ne,rt)),this._rotating&&(d.bearing=s.z.number(P,R,rt)),this._pitching&&(d.pitch=s.z.number(k,U,rt)),this._padding&&(d.interpolatePadding(L,G,rt),he=d.centerPoint.add(K)),this.terrain&&!t.freezeElevation&&this._updateElevation(rt),ze)d.setLocationAtPoint(ze,$e);else{const xt=d.zoomScale(d.zoom-y),yt=ne>y?Math.min(2,xe):Math.max(.5,xe),At=Math.pow(yt,1-rt),zt=d.unproject(Te.add(We.mult(rt*At)).mult(xt));d.setLocationAtPoint(d.renderWorldCopies?zt.wrap():zt,he)}this._applyUpdatedTransform(d),this._fireMoveEvents(n)},rt=>{this.terrain&&this._finalizeElevation(),this._afterEase(n,rt)},t),this}_prepareEase(t,n,c={}){this._moving=!0,n||c.moving||this.fire(new s.k("movestart",t)),this._zooming&&!c.zooming&&this.fire(new s.k("zoomstart",t)),this._rotating&&!c.rotating&&this.fire(new s.k("rotatestart",t)),this._pitching&&!c.pitching&&this.fire(new s.k("pitchstart",t))}_prepareElevation(t){this._elevationCenter=t,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(t,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(t){this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);const n=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(t<1&&n!==this._elevationTarget){const c=this._elevationTarget-this._elevationStart;this._elevationStart+=t*(c-(n-(c*t+this._elevationStart))/(1-t)),this._elevationTarget=n}this.transform.elevation=s.z.number(this._elevationStart,this._elevationTarget,t)}_finalizeElevation(){this._elevationFreeze=!1,this.transform.recalculateZoom(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_applyUpdatedTransform(t){if(!this.transformCameraUpdate)return;const n=t.clone(),{center:c,zoom:d,pitch:y,bearing:P,elevation:k}=this.transformCameraUpdate(n);c&&(n.center=c),d!==void 0&&(n.zoom=d),y!==void 0&&(n.pitch=y),P!==void 0&&(n.bearing=P),k!==void 0&&(n.elevation=k),this.transform.apply(n)}_fireMoveEvents(t){this.fire(new s.k("move",t)),this._zooming&&this.fire(new s.k("zoom",t)),this._rotating&&this.fire(new s.k("rotate",t)),this._pitching&&this.fire(new s.k("pitch",t))}_afterEase(t,n){if(this._easeId&&n&&this._easeId===n)return;delete this._easeId;const c=this._zooming,d=this._rotating,y=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,c&&this.fire(new s.k("zoomend",t)),d&&this.fire(new s.k("rotateend",t)),y&&this.fire(new s.k("pitchend",t)),this.fire(new s.k("moveend",t))}flyTo(t,n){var c;if(!t.essential&&a.prefersReducedMotion){const Fi=s.L(t,["center","zoom","bearing","pitch","around"]);return this.jumpTo(Fi,n)}this.stop(),t=s.e({offset:[0,0],speed:1.2,curve:1.42,easing:s.b7},t);const d=this._getTransformForUpdate(),y=this.getZoom(),P=this.getBearing(),k=this.getPitch(),L=this.getPadding(),R="bearing"in t?this._normalizeBearing(t.bearing,P):P,U="pitch"in t?+t.pitch:k,G="padding"in t?t.padding:d.padding,K=s.P.convert(t.offset);let he=d.centerPoint.add(K);const ce=d.pointLocation(he),{center:fe,zoom:ne}=d.getConstrained(s.M.convert(t.center||ce),(c=t.zoom)!==null&&c!==void 0?c:y);this._normalizeCenter(fe);const Te=d.zoomScale(ne-y),We=d.project(ce),xe=d.project(fe).sub(We);let ze=t.curve;const $e=Math.max(d.width,d.height),Ke=$e/Te,rt=xe.mag();if("minZoom"in t){const Fi=s.ac(Math.min(t.minZoom,y,ne),d.minZoom,d.maxZoom),gi=$e/d.zoomScale(Fi-y);ze=Math.sqrt(gi/rt*2)}const xt=ze*ze;function yt(Fi){const gi=(Ke*Ke-$e*$e+(Fi?-1:1)*xt*xt*rt*rt)/(2*(Fi?Ke:$e)*xt*rt);return Math.log(Math.sqrt(gi*gi+1)-gi)}function At(Fi){return(Math.exp(Fi)-Math.exp(-Fi))/2}function zt(Fi){return(Math.exp(Fi)+Math.exp(-Fi))/2}const Ci=yt(!1);let Bt=function(Fi){return zt(Ci)/zt(Ci+ze*Fi)},di=function(Fi){return $e*((zt(Ci)*(At(gi=Ci+ze*Fi)/zt(gi))-At(Ci))/xt)/rt;var gi},Si=(yt(!0)-Ci)/ze;if(Math.abs(rt)<1e-6||!isFinite(Si)){if(Math.abs($e-Ke)<1e-6)return this.easeTo(t,n);const Fi=Ke<$e?-1:1;Si=Math.abs(Math.log(Ke/$e))/ze,di=function(){return 0},Bt=function(gi){return Math.exp(Fi*ze*gi)}}return t.duration="duration"in t?+t.duration:1e3*Si/("screenSpeed"in t?+t.screenSpeed/ze:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0),this._zooming=!0,this._rotating=P!==R,this._pitching=U!==k,this._padding=!d.isPaddingEqual(G),this._prepareEase(n,!1),this.terrain&&this._prepareElevation(fe),this._ease(Fi=>{const gi=Fi*Si,Ei=1/Bt(gi);d.zoom=Fi===1?ne:y+d.scaleZoom(Ei),this._rotating&&(d.bearing=s.z.number(P,R,Fi)),this._pitching&&(d.pitch=s.z.number(k,U,Fi)),this._padding&&(d.interpolatePadding(L,G,Fi),he=d.centerPoint.add(K)),this.terrain&&!t.freezeElevation&&this._updateElevation(Fi);const Mi=Fi===1?fe:d.unproject(We.add(xe.mult(di(gi))).mult(Ei));d.setLocationAtPoint(d.renderWorldCopies?Mi.wrap():Mi,he),this._applyUpdatedTransform(d),this._fireMoveEvents(n)},()=>{this.terrain&&this._finalizeElevation(),this._afterEase(n)},t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(t,n){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const c=this._onEaseEnd;delete this._onEaseEnd,c.call(this,n)}if(!t){const c=this.handlers;c&&c.stop(!1)}return this}_ease(t,n,c){c.animate===!1||c.duration===0?(t(1),n()):(this._easeStart=a.now(),this._easeOptions=c,this._onEaseFrame=t,this._onEaseEnd=n,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(t,n){t=s.b1(t,-180,180);const c=Math.abs(t-n);return Math.abs(t-360-n)<c&&(t-=360),Math.abs(t+360-n)<c&&(t+=360),t}_normalizeCenter(t){const n=this.transform;if(!n.renderWorldCopies||n.lngRange)return;const c=t.lng-n.center.lng;t.lng+=c>180?-360:c<-180?360:0}queryTerrainElevation(t){return this.terrain?this.terrain.getElevationForLngLatZoom(s.M.convert(t),this.transform.tileZoom)-this.transform.elevation:null}}const Pl={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class ds{constructor(t=Pl){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=n=>{!n||n.sourceDataType!=="metadata"&&n.sourceDataType!=="visibility"&&n.dataType!=="style"&&n.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=t}getDefaultPosition(){return"bottom-right"}onAdd(t){return this._map=t,this._compact=this.options.compact,this._container=l.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=l.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=l.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){l.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(t,n){const c=this._map._getUIString(`AttributionControl.${n}`);t.title=c,t.setAttribute("aria-label",c)}_updateAttributions(){if(!this._map.style)return;let t=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=t.concat(this.options.customAttribution.map(d=>typeof d!="string"?"":d)):typeof this.options.customAttribution=="string"&&t.push(this.options.customAttribution)),this._map.style.stylesheet){const d=this._map.style.stylesheet;this.styleOwner=d.owner,this.styleId=d.id}const n=this._map.style.sourceCaches;for(const d in n){const y=n[d];if(y.used||y.usedForTerrain){const P=y.getSource();P.attribution&&t.indexOf(P.attribution)<0&&t.push(P.attribution)}}t=t.filter(d=>String(d).trim()),t.sort((d,y)=>d.length-y.length),t=t.filter((d,y)=>{for(let P=y+1;P<t.length;P++)if(t[P].indexOf(d)>=0)return!1;return!0});const c=t.join(" | ");c!==this._attribHTML&&(this._attribHTML=c,t.length?(this._innerContainer.innerHTML=c,this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class hc{constructor(t={}){this._updateCompact=()=>{const n=this._container.children;if(n.length){const c=n[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&c.classList.add("maplibregl-compact"):c.classList.remove("maplibregl-compact")}},this.options=t}getDefaultPosition(){return"bottom-left"}onAdd(t){this._map=t,this._compact=this.options&&this.options.compact,this._container=l.create("div","maplibregl-ctrl");const n=l.create("a","maplibregl-ctrl-logo");return n.target="_blank",n.rel="noopener nofollow",n.href="https://maplibre.org/",n.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),n.setAttribute("rel","noopener nofollow"),this._container.appendChild(n),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){l.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class Ea{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const n=++this._id;return this._queue.push({callback:t,id:n,cancelled:!1}),n}remove(t){const n=this._currentlyRunning,c=n?this._queue.concat(n):this._queue;for(const d of c)if(d.id===t)return void(d.cancelled=!0)}run(t=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const n=this._currentlyRunning=this._queue;this._queue=[];for(const c of n)if(!c.cancelled&&(c.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var Er=s.X([{name:"a_pos3d",type:"Int16",components:3}]);class Dr extends s.E{constructor(t){super(),this.sourceCache=t,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.deltaZoom=1,t.usedForTerrain=!0,t.tileSize=this.tileSize*2**this.deltaZoom}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(t,n){this.sourceCache.update(t,n),this._renderableTilesKeys=[];const c={};for(const d of t.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:n}))c[d.key]=!0,this._renderableTilesKeys.push(d.key),this._tiles[d.key]||(d.posMatrix=new Float64Array(16),s.aN(d.posMatrix,0,s.W,0,s.W,0,1),this._tiles[d.key]=new Gi(d,this.tileSize));for(const d in this._tiles)c[d]||delete this._tiles[d]}freeRtt(t){for(const n in this._tiles){const c=this._tiles[n];(!t||c.tileID.equals(t)||c.tileID.isChildOf(t)||t.isChildOf(c.tileID))&&(c.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map(t=>this.getTileByID(t))}getTileByID(t){return this._tiles[t]}getTerrainCoords(t){const n={};for(const c of this._renderableTilesKeys){const d=this._tiles[c].tileID;if(d.canonical.equals(t.canonical)){const y=t.clone();y.posMatrix=new Float64Array(16),s.aN(y.posMatrix,0,s.W,0,s.W,0,1),n[c]=y}else if(d.canonical.isChildOf(t.canonical)){const y=t.clone();y.posMatrix=new Float64Array(16);const P=d.canonical.z-t.canonical.z,k=d.canonical.x-(d.canonical.x>>P<<P),L=d.canonical.y-(d.canonical.y>>P<<P),R=s.W>>P;s.aN(y.posMatrix,0,R,0,R,0,1),s.H(y.posMatrix,y.posMatrix,[-k*R,-L*R,0]),n[c]=y}else if(t.canonical.isChildOf(d.canonical)){const y=t.clone();y.posMatrix=new Float64Array(16);const P=t.canonical.z-d.canonical.z,k=t.canonical.x-(t.canonical.x>>P<<P),L=t.canonical.y-(t.canonical.y>>P<<P),R=s.W>>P;s.aN(y.posMatrix,0,s.W,0,s.W,0,1),s.H(y.posMatrix,y.posMatrix,[k*R,L*R,0]),s.J(y.posMatrix,y.posMatrix,[1/2**P,1/2**P,0]),n[c]=y}}return n}getSourceTile(t,n){const c=this.sourceCache._source;let d=t.overscaledZ-this.deltaZoom;if(d>c.maxzoom&&(d=c.maxzoom),d<c.minzoom)return null;this._sourceTileCache[t.key]||(this._sourceTileCache[t.key]=t.scaledTo(d).key);let y=this.sourceCache.getTileByID(this._sourceTileCache[t.key]);if((!y||!y.dem)&&n)for(;d>=c.minzoom&&(!y||!y.dem);)y=this.sourceCache.getTileByID(t.scaledTo(d--).key);return y}tilesAfterTime(t=Date.now()){return Object.values(this._tiles).filter(n=>n.timeAdded>=t)}}class uc{constructor(t,n,c){this.painter=t,this.sourceCache=new Dr(n),this.options=c,this.exaggeration=typeof c.exaggeration=="number"?c.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(t,n,c,d=s.W){var y;if(!(n>=0&&n<d&&c>=0&&c<d))return 0;const P=this.getTerrainData(t),k=(y=P.tile)===null||y===void 0?void 0:y.dem;if(!k)return 0;const L=function(ce,fe,ne){var Te=fe[0],We=fe[1];return ce[0]=ne[0]*Te+ne[4]*We+ne[12],ce[1]=ne[1]*Te+ne[5]*We+ne[13],ce}([],[n/d*s.W,c/d*s.W],P.u_terrain_matrix),R=[L[0]*k.dim,L[1]*k.dim],U=Math.floor(R[0]),G=Math.floor(R[1]),K=R[0]-U,he=R[1]-G;return k.get(U,G)*(1-K)*(1-he)+k.get(U+1,G)*K*(1-he)+k.get(U,G+1)*(1-K)*he+k.get(U+1,G+1)*K*he}getElevationForLngLatZoom(t,n){const{tileID:c,mercatorX:d,mercatorY:y}=this._getOverscaledTileIDFromLngLatZoom(t,n);return this.getElevation(c,d%s.W,y%s.W,s.W)}getElevation(t,n,c,d=s.W){return this.getDEMElevation(t,n,c,d)*this.exaggeration}getTerrainData(t){if(!this._emptyDemTexture){const d=this.painter.context,y=new s.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new Ze(d,y,d.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new Ze(d,new s.R({width:1,height:1}),d.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(d.gl.NEAREST,d.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=s.an([])}const n=this.sourceCache.getSourceTile(t,!0);if(n&&n.dem&&(!n.demTexture||n.needsTerrainPrepare)){const d=this.painter.context;n.demTexture=this.painter.getTileTexture(n.dem.stride),n.demTexture?n.demTexture.update(n.dem.getPixels(),{premultiply:!1}):n.demTexture=new Ze(d,n.dem.getPixels(),d.gl.RGBA,{premultiply:!1}),n.demTexture.bind(d.gl.NEAREST,d.gl.CLAMP_TO_EDGE),n.needsTerrainPrepare=!1}const c=n&&n+n.tileID.key+t.key;if(c&&!this._demMatrixCache[c]){const d=this.sourceCache.sourceCache._source.maxzoom;let y=t.canonical.z-n.tileID.canonical.z;t.overscaledZ>t.canonical.z&&(t.canonical.z>=d?y=t.canonical.z-d:s.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const P=t.canonical.x-(t.canonical.x>>y<<y),k=t.canonical.y-(t.canonical.y>>y<<y),L=s.b9(new Float64Array(16),[1/(s.W<<y),1/(s.W<<y),0]);s.H(L,L,[P*s.W,k*s.W,0]),this._demMatrixCache[t.key]={matrix:L,coord:t}}return{u_depth:2,u_terrain:3,u_terrain_dim:n&&n.dem&&n.dem.dim||1,u_terrain_matrix:c?this._demMatrixCache[t.key].matrix:this._emptyDemMatrix,u_terrain_unpack:n&&n.dem&&n.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(n&&n.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:n}}getFramebuffer(t){const n=this.painter,c=n.width/devicePixelRatio,d=n.height/devicePixelRatio;return!this._fbo||this._fbo.width===c&&this._fbo.height===d||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new Ze(n.context,{width:c,height:d,data:null},n.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(n.context.gl.NEAREST,n.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new Ze(n.context,{width:c,height:d,data:null},n.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(n.context.gl.NEAREST,n.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=n.context.createFramebuffer(c,d,!0,!1),this._fbo.depthAttachment.set(n.context.createRenderbuffer(n.context.gl.DEPTH_COMPONENT16,c,d))),this._fbo.colorAttachment.set(t==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const t=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const n=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let y=0,P=0;y<this._coordsTextureSize;y++)for(let k=0;k<this._coordsTextureSize;k++,P+=4)n[P+0]=255&k,n[P+1]=255&y,n[P+2]=k>>8<<4|y>>8,n[P+3]=0;const c=new s.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(n.buffer)),d=new Ze(t,c,t.gl.RGBA,{premultiply:!1});return d.bind(t.gl.NEAREST,t.gl.CLAMP_TO_EDGE),this._coordsTexture=d,d}pointCoordinate(t){this.painter.maybeDrawDepthAndCoords(!0);const n=new Uint8Array(4),c=this.painter.context,d=c.gl,y=Math.round(t.x*this.painter.pixelRatio/devicePixelRatio),P=Math.round(t.y*this.painter.pixelRatio/devicePixelRatio),k=Math.round(this.painter.height/devicePixelRatio);c.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),d.readPixels(y,k-P-1,1,1,d.RGBA,d.UNSIGNED_BYTE,n),c.bindFramebuffer.set(null);const L=n[0]+(n[2]>>4<<8),R=n[1]+((15&n[2])<<8),U=this.coordsIndex[255-n[3]],G=U&&this.sourceCache.getTileByID(U);if(!G)return null;const K=this._coordsTextureSize,he=(1<<G.tileID.canonical.z)*K;return new s.Y((G.tileID.canonical.x*K+L)/he+G.tileID.wrap,(G.tileID.canonical.y*K+R)/he,this.getElevation(G.tileID,L,R,K))}depthAtPoint(t){const n=new Uint8Array(4),c=this.painter.context,d=c.gl;return c.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),d.readPixels(t.x,this.painter.height/devicePixelRatio-t.y-1,1,1,d.RGBA,d.UNSIGNED_BYTE,n),c.bindFramebuffer.set(null),(n[0]/16777216+n[1]/65536+n[2]/256+n[3])/256}getTerrainMesh(){if(this._mesh)return this._mesh;const t=this.painter.context,n=new s.ba,c=new s.aX,d=this.meshSize,y=s.W/d,P=d*d;for(let G=0;G<=d;G++)for(let K=0;K<=d;K++)n.emplaceBack(K*y,G*y,0);for(let G=0;G<P;G+=d+1)for(let K=0;K<d;K++)c.emplaceBack(K+G,d+K+G+1,d+K+G+2),c.emplaceBack(K+G,d+K+G+2,K+G+1);const k=n.length,L=k+2*(d+1);for(const G of[0,1])for(let K=0;K<=d;K++)for(const he of[0,1])n.emplaceBack(K*y,G*s.W,he);for(let G=0;G<2*d;G+=2)c.emplaceBack(L+G,L+G+1,L+G+3),c.emplaceBack(L+G,L+G+3,L+G+2),c.emplaceBack(k+G,k+G+3,k+G+1),c.emplaceBack(k+G,k+G+2,k+G+3);const R=n.length,U=R+2*(d+1);for(const G of[0,1])for(let K=0;K<=d;K++)for(const he of[0,1])n.emplaceBack(G*s.W,K*y,he);for(let G=0;G<2*d;G+=2)c.emplaceBack(R+G,R+G+1,R+G+3),c.emplaceBack(R+G,R+G+3,R+G+2),c.emplaceBack(U+G,U+G+3,U+G+1),c.emplaceBack(U+G,U+G+2,U+G+3);return this._mesh={indexBuffer:t.createIndexBuffer(c),vertexBuffer:t.createVertexBuffer(n,Er.members),segments:s.$.simpleSegment(0,0,n.length,c.length)},this._mesh}getMeshFrameDelta(t){return 2*Math.PI*s.bb/Math.pow(2,t)/5}getMinTileElevationForLngLatZoom(t,n){var c;const{tileID:d}=this._getOverscaledTileIDFromLngLatZoom(t,n);return(c=this.getMinMaxElevation(d).minElevation)!==null&&c!==void 0?c:0}getMinMaxElevation(t){const n=this.getTerrainData(t).tile,c={minElevation:null,maxElevation:null};return n&&n.dem&&(c.minElevation=n.dem.min*this.exaggeration,c.maxElevation=n.dem.max*this.exaggeration),c}_getOverscaledTileIDFromLngLatZoom(t,n){const c=s.Y.fromLngLat(t.wrap()),d=(1<<n)*s.W,y=c.x*d,P=c.y*d,k=Math.floor(y/s.W),L=Math.floor(P/s.W);return{tileID:new s.Q(n,0,n,k,L),mercatorX:y,mercatorY:P}}}class Ia{constructor(t,n,c){this._context=t,this._size=n,this._tileSize=c,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const t of this._objects)t.texture.destroy(),t.fbo.destroy()}_createObject(t){const n=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),c=new Ze(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return c.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),n.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),n.colorAttachment.set(c.texture),{id:t,fbo:n,texture:c,stamp:-1,inUse:!1}}getObjectForId(t){return this._objects[t]}useObject(t){t.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter(n=>t.id!==n),this._recentlyUsed.push(t.id)}stampObject(t){t.stamp=++this._stamp}getOrCreateFreeObject(){for(const n of this._recentlyUsed)if(!this._objects[n].inUse)return this._objects[n];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const t=this._createObject(this._objects.length);return this._objects.push(t),t}freeObject(t){t.inUse=!1}freeAllObjects(){for(const t of this._objects)this.freeObject(t)}isFull(){return!(this._objects.length<this._size)&&this._objects.some(t=>!t.inUse)===!1}}const js={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0};class Al{constructor(t,n){this.painter=t,this.terrain=n,this.pool=new Ia(t.context,30,n.sourceCache.tileSize*n.qualityFactor)}destruct(){this.pool.destruct()}getTexture(t){return this.pool.getObjectForId(t.rtt[this._stacks.length-1].id).texture}prepareForRender(t,n){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=t._order.filter(c=>!t._layers[c].isHidden(n)),this._coordsDescendingInv={};for(const c in t.sourceCaches){this._coordsDescendingInv[c]={};const d=t.sourceCaches[c].getVisibleCoordinates();for(const y of d){const P=this.terrain.sourceCache.getTerrainCoords(y);for(const k in P)this._coordsDescendingInv[c][k]||(this._coordsDescendingInv[c][k]=[]),this._coordsDescendingInv[c][k].push(P[k])}}this._coordsDescendingInvStr={};for(const c of t._order){const d=t._layers[c],y=d.source;if(js[d.type]&&!this._coordsDescendingInvStr[y]){this._coordsDescendingInvStr[y]={};for(const P in this._coordsDescendingInv[y])this._coordsDescendingInvStr[y][P]=this._coordsDescendingInv[y][P].map(k=>k.key).sort().join()}}for(const c of this._renderableTiles)for(const d in this._coordsDescendingInvStr){const y=this._coordsDescendingInvStr[d][c.tileID.key];y&&y!==c.rttCoords[d]&&(c.rtt=[])}}renderLayer(t){if(t.isHidden(this.painter.transform.zoom))return!1;const n=t.type,c=this.painter,d=this._renderableLayerIds[this._renderableLayerIds.length-1]===t.id;if(js[n]&&(this._prevType&&js[this._prevType]||this._stacks.push([]),this._prevType=n,this._stacks[this._stacks.length-1].push(t.id),!d))return!0;if(js[this._prevType]||js[n]&&d){this._prevType=n;const y=this._stacks.length-1,P=this._stacks[y]||[];for(const k of this._renderableTiles){if(this.pool.isFull()&&(Yo(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(k),k.rtt[y]){const R=this.pool.getObjectForId(k.rtt[y].id);if(R.stamp===k.rtt[y].stamp){this.pool.useObject(R);continue}}const L=this.pool.getOrCreateFreeObject();this.pool.useObject(L),this.pool.stampObject(L),k.rtt[y]={id:L.id,stamp:L.stamp},c.context.bindFramebuffer.set(L.fbo.framebuffer),c.context.clear({color:s.aO.transparent,stencil:0}),c.currentStencilSource=void 0;for(let R=0;R<P.length;R++){const U=c.style._layers[P[R]],G=U.source?this._coordsDescendingInv[U.source][k.tileID.key]:[k.tileID];c.context.viewport.set([0,0,L.fbo.width,L.fbo.height]),c._renderTileClippingMasks(U,G),c.renderLayer(c,c.style.sourceCaches[U.source],U,G),U.source&&(k.rttCoords[U.source]=this._coordsDescendingInvStr[U.source][k.tileID.key])}}return Yo(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects(),js[n]}return!1}}const Ml={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use ⌘ + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},kl=p,Pa={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:Pl,maplibreLogo:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:s.a.MAX_TILE_CACHE_ZOOM_LEVELS,localIdeographFontFamily:"sans-serif",transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,validateStyle:!0,maxCanvasSize:[4096,4096]},Qa=g=>{g.touchstart=g.dragStart,g.touchmoveWindow=g.dragMove,g.touchend=g.dragEnd},Ol={showCompass:!0,showZoom:!0,visualizePitch:!1};class Dl{constructor(t,n,c=!1){this.mousedown=P=>{this.startMouse(s.e({},P,{ctrlKey:!0,preventDefault:()=>P.preventDefault()}),l.mousePos(this.element,P)),l.addEventListener(window,"mousemove",this.mousemove),l.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=P=>{this.moveMouse(P,l.mousePos(this.element,P))},this.mouseup=P=>{this.mouseRotate.dragEnd(P),this.mousePitch&&this.mousePitch.dragEnd(P),this.offTemp()},this.touchstart=P=>{P.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=l.touchPos(this.element,P.targetTouches)[0],this.startTouch(P,this._startPos),l.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),l.addEventListener(window,"touchend",this.touchend))},this.touchmove=P=>{P.targetTouches.length!==1?this.reset():(this._lastPos=l.touchPos(this.element,P.targetTouches)[0],this.moveTouch(P,this._lastPos))},this.touchend=P=>{P.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),this.touchRotate.reset(),this.touchPitch&&this.touchPitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10;const d=t.dragRotate._mouseRotate.getClickTolerance(),y=t.dragRotate._mousePitch.getClickTolerance();this.element=n,this.mouseRotate=Nn({clickTolerance:d,enable:!0}),this.touchRotate=(({enable:P,clickTolerance:k,bearingDegreesPerPixelMoved:L=.8})=>{const R=new qt;return new Gr({clickTolerance:k,move:(U,G)=>({bearingDelta:(G.x-U.x)*L}),moveStateManager:R,enable:P,assignEvents:Qa})})({clickTolerance:d,enable:!0}),this.map=t,c&&(this.mousePitch=An({clickTolerance:y,enable:!0}),this.touchPitch=(({enable:P,clickTolerance:k,pitchDegreesPerPixelMoved:L=-.5})=>{const R=new qt;return new Gr({clickTolerance:k,move:(U,G)=>({pitchDelta:(G.y-U.y)*L}),moveStateManager:R,enable:P,assignEvents:Qa})})({clickTolerance:y,enable:!0})),l.addEventListener(n,"mousedown",this.mousedown),l.addEventListener(n,"touchstart",this.touchstart,{passive:!1}),l.addEventListener(n,"touchcancel",this.reset)}startMouse(t,n){this.mouseRotate.dragStart(t,n),this.mousePitch&&this.mousePitch.dragStart(t,n),l.disableDrag()}startTouch(t,n){this.touchRotate.dragStart(t,n),this.touchPitch&&this.touchPitch.dragStart(t,n),l.disableDrag()}moveMouse(t,n){const c=this.map,{bearingDelta:d}=this.mouseRotate.dragMove(t,n)||{};if(d&&c.setBearing(c.getBearing()+d),this.mousePitch){const{pitchDelta:y}=this.mousePitch.dragMove(t,n)||{};y&&c.setPitch(c.getPitch()+y)}}moveTouch(t,n){const c=this.map,{bearingDelta:d}=this.touchRotate.dragMove(t,n)||{};if(d&&c.setBearing(c.getBearing()+d),this.touchPitch){const{pitchDelta:y}=this.touchPitch.dragMove(t,n)||{};y&&c.setPitch(c.getPitch()+y)}}off(){const t=this.element;l.removeEventListener(t,"mousedown",this.mousedown),l.removeEventListener(t,"touchstart",this.touchstart,{passive:!1}),l.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),l.removeEventListener(window,"touchend",this.touchend),l.removeEventListener(t,"touchcancel",this.reset),this.offTemp()}offTemp(){l.enableDrag(),l.removeEventListener(window,"mousemove",this.mousemove),l.removeEventListener(window,"mouseup",this.mouseup),l.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),l.removeEventListener(window,"touchend",this.touchend)}}let Ns;function el(g,t,n){const c=new s.M(g.lng,g.lat);if(g=new s.M(g.lng,g.lat),t){const d=new s.M(g.lng-360,g.lat),y=new s.M(g.lng+360,g.lat),P=n.locationPoint(g).distSqr(t);n.locationPoint(d).distSqr(t)<P?g=d:n.locationPoint(y).distSqr(t)<P&&(g=y)}for(;Math.abs(g.lng-n.center.lng)>180;){const d=n.locationPoint(g);if(d.x>=0&&d.y>=0&&d.x<=n.width&&d.y<=n.height)break;g.lng>n.center.lng?g.lng-=360:g.lng+=360}return g.lng!==c.lng&&n.locationPoint(g).y>n.height/2-n.getHorizon()?g:c}const Aa={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function tl(g,t,n){const c=g.classList;for(const d in Aa)c.remove(`maplibregl-${n}-anchor-${d}`);c.add(`maplibregl-${n}-anchor-${t}`)}class Ma extends s.E{constructor(t){if(super(),this._onKeyPress=n=>{const c=n.code,d=n.charCode||n.keyCode;c!=="Space"&&c!=="Enter"&&d!==32&&d!==13||this.togglePopup()},this._onMapClick=n=>{const c=n.originalEvent.target,d=this._element;this._popup&&(c===d||d.contains(c))&&this.togglePopup()},this._update=n=>{var c;if(!this._map)return;const d=this._map.loaded()&&!this._map.isMoving();((n==null?void 0:n.type)==="terrain"||(n==null?void 0:n.type)==="render"&&!d)&&this._map.once("render",this._update),this._lngLat=this._map.transform.renderWorldCopies?el(this._lngLat,this._flatPos,this._map.transform):(c=this._lngLat)===null||c===void 0?void 0:c.wrap(),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationPoint(this._lngLat)._add(this._offset));let y="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?y=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(y=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let P="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?P="rotateX(0deg)":this._pitchAlignment==="map"&&(P=`rotateX(${this._map.getPitch()}deg)`),n&&n.type!=="moveend"||(this._pos=this._pos.round()),l.setTransform(this._element,`${Aa[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${P} ${y}`),a.frameAsync(new AbortController).then(()=>{this._updateOpacity(n&&n.type==="moveend")}).catch(()=>{})},this._onMove=n=>{if(!this._isDragging){const c=this._clickTolerance||this._map._clickTolerance;this._isDragging=n.point.dist(this._pointerdownPos)>=c}this._isDragging&&(this._pos=n.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.k("dragstart"))),this.fire(new s.k("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new s.k("dragend")),this._state="inactive"},this._addDragHandler=n=>{this._element.contains(n.originalEvent.target)&&(n.preventDefault(),this._positionDelta=n.point.sub(this._pos).add(this._offset),this._pointerdownPos=n.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&t.pitchAlignment!=="auto"?t.pitchAlignment:this._rotationAlignment,this.setOpacity(),this.setOpacity(t==null?void 0:t.opacity,t==null?void 0:t.opacityWhenCovered),t&&t.element)this._element=t.element,this._offset=s.P.convert(t&&t.offset||[0,0]);else{this._defaultMarker=!0,this._element=l.create("div"),this._element.setAttribute("aria-label","Map marker");const n=l.createNS("http://www.w3.org/2000/svg","svg"),c=41,d=27;n.setAttributeNS(null,"display","block"),n.setAttributeNS(null,"height",`${c}px`),n.setAttributeNS(null,"width",`${d}px`),n.setAttributeNS(null,"viewBox",`0 0 ${d} ${c}`);const y=l.createNS("http://www.w3.org/2000/svg","g");y.setAttributeNS(null,"stroke","none"),y.setAttributeNS(null,"stroke-width","1"),y.setAttributeNS(null,"fill","none"),y.setAttributeNS(null,"fill-rule","evenodd");const P=l.createNS("http://www.w3.org/2000/svg","g");P.setAttributeNS(null,"fill-rule","nonzero");const k=l.createNS("http://www.w3.org/2000/svg","g");k.setAttributeNS(null,"transform","translate(3.0, 29.0)"),k.setAttributeNS(null,"fill","#000000");const L=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const Te of L){const We=l.createNS("http://www.w3.org/2000/svg","ellipse");We.setAttributeNS(null,"opacity","0.04"),We.setAttributeNS(null,"cx","10.5"),We.setAttributeNS(null,"cy","5.80029008"),We.setAttributeNS(null,"rx",Te.rx),We.setAttributeNS(null,"ry",Te.ry),k.appendChild(We)}const R=l.createNS("http://www.w3.org/2000/svg","g");R.setAttributeNS(null,"fill",this._color);const U=l.createNS("http://www.w3.org/2000/svg","path");U.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),R.appendChild(U);const G=l.createNS("http://www.w3.org/2000/svg","g");G.setAttributeNS(null,"opacity","0.25"),G.setAttributeNS(null,"fill","#000000");const K=l.createNS("http://www.w3.org/2000/svg","path");K.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),G.appendChild(K);const he=l.createNS("http://www.w3.org/2000/svg","g");he.setAttributeNS(null,"transform","translate(6.0, 7.0)"),he.setAttributeNS(null,"fill","#FFFFFF");const ce=l.createNS("http://www.w3.org/2000/svg","g");ce.setAttributeNS(null,"transform","translate(8.0, 8.0)");const fe=l.createNS("http://www.w3.org/2000/svg","circle");fe.setAttributeNS(null,"fill","#000000"),fe.setAttributeNS(null,"opacity","0.25"),fe.setAttributeNS(null,"cx","5.5"),fe.setAttributeNS(null,"cy","5.5"),fe.setAttributeNS(null,"r","5.4999962");const ne=l.createNS("http://www.w3.org/2000/svg","circle");ne.setAttributeNS(null,"fill","#FFFFFF"),ne.setAttributeNS(null,"cx","5.5"),ne.setAttributeNS(null,"cy","5.5"),ne.setAttributeNS(null,"r","5.4999962"),ce.appendChild(fe),ce.appendChild(ne),P.appendChild(k),P.appendChild(R),P.appendChild(G),P.appendChild(he),P.appendChild(ce),n.appendChild(P),n.setAttributeNS(null,"height",c*this._scale+"px"),n.setAttributeNS(null,"width",d*this._scale+"px"),this._element.appendChild(n),this._offset=s.P.convert(t&&t.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",n=>{n.preventDefault()}),this._element.addEventListener("mousedown",n=>{n.preventDefault()}),tl(this._element,this._anchor,"marker"),t&&t.className)for(const n of t.className.split(" "))this._element.classList.add(n);this._popup=null}addTo(t){return this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._update),t.on("moveend",this._update),t.on("terrain",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),l.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=s.M.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const d=Math.abs(13.5)/Math.SQRT2;t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[d,-1*(38.1-13.5+d)],"bottom-right":[-d,-1*(38.1-13.5+d)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}getPopup(){return this._popup}togglePopup(){const t=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:t?(t.isOpen()?t.remove():(t.setLngLat(this._lngLat),t.addTo(this._map)),this):this}_updateOpacity(t=!1){var n,c;if(!(!((n=this._map)===null||n===void 0)&&n.terrain))return void(this._element.style.opacity!==this._opacity&&(this._element.style.opacity=this._opacity));if(t)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout(()=>{this._opacityTimeout=null},100)}const d=this._map,y=d.terrain.depthAtPoint(this._pos),P=d.terrain.getElevationForLngLatZoom(this._lngLat,d.transform.tileZoom);if(d.transform.lngLatToCameraDepth(this._lngLat,P)-y<.006)return void(this._element.style.opacity=this._opacity);const k=-this._offset.y/d.transform._pixelPerMeter,L=Math.sin(d.getPitch()*Math.PI/180)*k,R=d.terrain.depthAtPoint(new s.P(this._pos.x,this._pos.y-this._offset.y)),U=d.transform.lngLatToCameraDepth(this._lngLat,P+L)-R>.006;!((c=this._popup)===null||c===void 0)&&c.isOpen()&&U&&this._popup.remove(),this._element.style.opacity=U?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(t){return this._offset=s.P.convert(t),this._update(),this}addClassName(t){this._element.classList.add(t)}removeClassName(t){this._element.classList.remove(t)}toggleClassName(t){return this._element.classList.toggle(t)}setDraggable(t){return this._draggable=!!t,this._map&&(t?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t&&t!=="auto"?t:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(t,n){return t===void 0&&n===void 0&&(this._opacity="1",this._opacityWhenCovered="0.2"),t!==void 0&&(this._opacity=t),n!==void 0&&(this._opacityWhenCovered=n),this._map&&this._updateOpacity(!0),this}}const il={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let Ko=0,bo=!1;const rl={maxWidth:100,unit:"metric"};function nl(g,t,n){const c=n&&n.maxWidth||100,d=g._container.clientHeight/2,y=g.unproject([0,d]),P=g.unproject([c,d]),k=y.distanceTo(P);if(n&&n.unit==="imperial"){const L=3.2808*k;L>5280?wo(t,c,L/5280,g._getUIString("ScaleControl.Miles")):wo(t,c,L,g._getUIString("ScaleControl.Feet"))}else n&&n.unit==="nautical"?wo(t,c,k/1852,g._getUIString("ScaleControl.NauticalMiles")):k>=1e3?wo(t,c,k/1e3,g._getUIString("ScaleControl.Kilometers")):wo(t,c,k,g._getUIString("ScaleControl.Meters"))}function wo(g,t,n,c){const d=function(y){const P=Math.pow(10,`${Math.floor(y)}`.length-1);let k=y/P;return k=k>=10?10:k>=5?5:k>=3?3:k>=2?2:k>=1?1:function(L){const R=Math.pow(10,Math.ceil(-Math.log(L)/Math.LN10));return Math.round(L*R)/R}(k),P*k}(n);g.style.width=t*(d/n)+"px",g.innerHTML=`${d}&nbsp;${c}`}const Ll={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1},zl=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function sl(g){if(g){if(typeof g=="number"){const t=Math.round(Math.abs(g)/Math.SQRT2);return{center:new s.P(0,0),top:new s.P(0,g),"top-left":new s.P(t,t),"top-right":new s.P(-t,t),bottom:new s.P(0,-g),"bottom-left":new s.P(t,-t),"bottom-right":new s.P(-t,-t),left:new s.P(g,0),right:new s.P(-g,0)}}if(g instanceof s.P||Array.isArray(g)){const t=s.P.convert(g);return{center:t,top:t,"top-left":t,"top-right":t,bottom:t,"bottom-left":t,"bottom-right":t,left:t,right:t}}return{center:s.P.convert(g.center||[0,0]),top:s.P.convert(g.top||[0,0]),"top-left":s.P.convert(g["top-left"]||[0,0]),"top-right":s.P.convert(g["top-right"]||[0,0]),bottom:s.P.convert(g.bottom||[0,0]),"bottom-left":s.P.convert(g["bottom-left"]||[0,0]),"bottom-right":s.P.convert(g["bottom-right"]||[0,0]),left:s.P.convert(g.left||[0,0]),right:s.P.convert(g.right||[0,0])}}return sl(new s.P(0,0))}const dc=p;j.AJAXError=s.be,j.Evented=s.E,j.LngLat=s.M,j.MercatorCoordinate=s.Y,j.Point=s.P,j.addProtocol=s.bf,j.config=s.a,j.removeProtocol=s.bg,j.AttributionControl=ds,j.BoxZoomHandler=Di,j.CanvasSource=wt,j.CooperativeGesturesHandler=si,j.DoubleClickZoomHandler=El,j.DragPanHandler=cc,j.DragRotateHandler=us,j.EdgeInsets=oi,j.FullscreenControl=class extends s.E{constructor(g={}){super(),this._onFullscreenChange=()=>{var t;let n=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((t=n==null?void 0:n.shadowRoot)===null||t===void 0)&&t.fullscreenElement;)n=n.shadowRoot.fullscreenElement;n===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,g&&g.container&&(g.container instanceof HTMLElement?this._container=g.container:s.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(g){return this._map=g,this._container||(this._container=this._map.getContainer()),this._controlContainer=l.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){l.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const g=this._fullscreenButton=l.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);l.create("span","maplibregl-ctrl-icon",g).setAttribute("aria-hidden","true"),g.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const g=this._getTitle();this._fullscreenButton.setAttribute("aria-label",g),this._fullscreenButton.title=g}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new s.k("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new s.k("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},j.GeoJSONSource=Pt,j.GeolocateControl=class extends s.E{constructor(g){super(),this._onSuccess=t=>{if(this._map){if(this._isOutOfMapMaxBounds(t))return this._setErrorState(),this.fire(new s.k("outofmaxbounds",t)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=t,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(t),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(t),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new s.k("geolocate",t)),this._finish()}},this._updateCamera=t=>{const n=new s.M(t.coords.longitude,t.coords.latitude),c=t.coords.accuracy,d=this._map.getBearing(),y=s.e({bearing:d},this.options.fitBoundsOptions),P=Oe.fromLngLat(n,c);this._map.fitBounds(P,y,{geolocateSource:!0})},this._updateMarker=t=>{if(t){const n=new s.M(t.coords.longitude,t.coords.latitude);this._accuracyCircleMarker.setLngLat(n).addTo(this._map),this._userLocationDotMarker.setLngLat(n).addTo(this._map),this._accuracy=t.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=t=>{if(this._map){if(this.options.trackUserLocation)if(t.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const n=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=n,this._geolocateButton.setAttribute("aria-label",n),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(t.code===3&&bo)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new s.k("error",t)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=t=>{if(this._map){if(this._container.addEventListener("contextmenu",n=>n.preventDefault()),this._geolocateButton=l.create("button","maplibregl-ctrl-geolocate",this._container),l.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",t===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const n=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=n,this._geolocateButton.setAttribute("aria-label",n)}else{const n=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.title=n,this._geolocateButton.setAttribute("aria-label",n)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=l.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new Ma({element:this._dotElement}),this._circleElement=l.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Ma({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",()=>this.trigger()),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",n=>{n.geolocateSource||this._watchState!=="ACTIVE_LOCK"||n.originalEvent&&n.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new s.k("trackuserlocationend")))})}},this.options=s.e({},il,g)}onAdd(g){return this._map=g,this._container=l.create("div","maplibregl-ctrl maplibregl-ctrl-group"),function(){return s._(this,arguments,void 0,function*(t=!1){if(Ns!==void 0&&!t)return Ns;if(window.navigator.permissions===void 0)return Ns=!!window.navigator.geolocation,Ns;try{Ns=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{Ns=!!window.navigator.geolocation}return Ns})}().then(t=>this._setupUI(t)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),l.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,Ko=0,bo=!1}_isOutOfMapMaxBounds(g){const t=this._map.getMaxBounds(),n=g.coords;return t&&(n.longitude<t.getWest()||n.longitude>t.getEast()||n.latitude<t.getSouth()||n.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const g=this._map.getBounds(),t=g.getSouthEast(),n=g.getNorthEast(),c=t.distanceTo(n),d=Math.ceil(this._accuracy/(c/this._map._container.clientHeight)*2);this._circleElement.style.width=`${d}px`,this._circleElement.style.height=`${d}px`}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.k("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Ko--,bo=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new s.k("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.k("trackuserlocationstart"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let g;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Ko++,Ko>1?(g={maximumAge:6e5,timeout:0},bo=!0):(g=this.options.positionOptions,bo=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,g)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},j.Hash=_r,j.ImageSource=Nt,j.KeyboardHandler=Qs,j.LngLatBounds=Oe,j.LogoControl=hc,j.Map=class extends Mn{constructor(g){if(s.bc.mark(s.bd.create),(g=s.e({},Pa,g)).minZoom!=null&&g.maxZoom!=null&&g.minZoom>g.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(g.minPitch!=null&&g.maxPitch!=null&&g.minPitch>g.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(g.minPitch!=null&&g.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(g.maxPitch!=null&&g.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(super(new Oi(g.minZoom,g.maxZoom,g.minPitch,g.maxPitch,g.renderWorldCopies),{bearingSnap:g.bearingSnap}),this._contextLost=t=>{t.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new s.k("webglcontextlost",{originalEvent:t}))},this._contextRestored=t=>{this._setupPainter(),this.resize(),this._update(),this.fire(new s.k("webglcontextrestored",{originalEvent:t}))},this._onMapScroll=t=>{if(t.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=g.interactive,this._maxTileCacheSize=g.maxTileCacheSize,this._maxTileCacheZoomLevels=g.maxTileCacheZoomLevels,this._failIfMajorPerformanceCaveat=g.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=g.preserveDrawingBuffer,this._antialias=g.antialias,this._trackResize=g.trackResize,this._bearingSnap=g.bearingSnap,this._refreshExpiredTiles=g.refreshExpiredTiles,this._fadeDuration=g.fadeDuration,this._crossSourceCollisions=g.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=g.collectResourceTiming,this._renderTaskQueue=new Ea,this._controls=[],this._mapId=s.a3(),this._locale=s.e({},Ml,g.locale),this._clickTolerance=g.clickTolerance,this._overridePixelRatio=g.pixelRatio,this._maxCanvasSize=g.maxCanvasSize,this.transformCameraUpdate=g.transformCameraUpdate,this._imageQueueHandle=A.addThrottleControl(()=>this.isMoving()),this._requestManager=new D(g.transformRequest),typeof g.container=="string"){if(this._container=document.getElementById(g.container),!this._container)throw new Error(`Container '${g.container}' not found.`)}else{if(!(g.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=g.container}if(g.maxBounds&&this.setMaxBounds(g.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this.on("terrain",()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)}),this.once("idle",()=>{this._idleTriggered=!0}),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let t=!1;const n=cr(c=>{this._trackResize&&!this._removed&&this.resize(c)._update()},50);this._resizeObserver=new ResizeObserver(c=>{t?n(c):t=!0}),this._resizeObserver.observe(this._container)}this.handlers=new Il(this,g),this._hash=g.hash&&new _r(typeof g.hash=="string"&&g.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:g.center,zoom:g.zoom,bearing:g.bearing,pitch:g.pitch}),g.bounds&&(this.resize(),this.fitBounds(g.bounds,s.e({},g.fitBoundsOptions,{duration:0})))),this.resize(),this._localIdeographFontFamily=g.localIdeographFontFamily,this._validateStyle=g.validateStyle,g.style&&this.setStyle(g.style,{localIdeographFontFamily:g.localIdeographFontFamily}),g.attributionControl&&this.addControl(new ds(typeof g.attributionControl=="boolean"?void 0:g.attributionControl)),g.maplibreLogo&&this.addControl(new hc,g.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",t=>{this._update(t.dataType==="style"),this.fire(new s.k(`${t.dataType}data`,t))}),this.on("dataloading",t=>{this.fire(new s.k(`${t.dataType}dataloading`,t))}),this.on("dataabort",t=>{this.fire(new s.k("sourcedataabort",t))})}_getMapId(){return this._mapId}addControl(g,t){if(t===void 0&&(t=g.getDefaultPosition?g.getDefaultPosition():"top-right"),!g||!g.onAdd)return this.fire(new s.j(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=g.onAdd(this);this._controls.push(g);const c=this._controlPositions[t];return t.indexOf("bottom")!==-1?c.insertBefore(n,c.firstChild):c.appendChild(n),this}removeControl(g){if(!g||!g.onRemove)return this.fire(new s.j(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(g);return t>-1&&this._controls.splice(t,1),g.onRemove(this),this}hasControl(g){return this._controls.indexOf(g)>-1}calculateCameraOptionsFromTo(g,t,n,c){return c==null&&this.terrain&&(c=this.terrain.getElevationForLngLatZoom(n,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(g,t,n,c)}resize(g){var t;const n=this._containerDimensions(),c=n[0],d=n[1],y=this._getClampedPixelRatio(c,d);if(this._resizeCanvas(c,d,y),this.painter.resize(c,d,y),this.painter.overLimit()){const k=this.painter.context.gl;this._maxCanvasSize=[k.drawingBufferWidth,k.drawingBufferHeight];const L=this._getClampedPixelRatio(c,d);this._resizeCanvas(c,d,L),this.painter.resize(c,d,L)}this.transform.resize(c,d),(t=this._requestedCameraState)===null||t===void 0||t.resize(c,d);const P=!this._moving;return P&&(this.stop(),this.fire(new s.k("movestart",g)).fire(new s.k("move",g))),this.fire(new s.k("resize",g)),P&&this.fire(new s.k("moveend",g)),this}_getClampedPixelRatio(g,t){const{0:n,1:c}=this._maxCanvasSize,d=this.getPixelRatio(),y=g*d,P=t*d;return Math.min(y>n?n/y:1,P>c?c/P:1)*d}getPixelRatio(){var g;return(g=this._overridePixelRatio)!==null&&g!==void 0?g:devicePixelRatio}setPixelRatio(g){this._overridePixelRatio=g,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(g){return this.transform.setMaxBounds(Oe.convert(g)),this._update()}setMinZoom(g){if((g=g??-2)>=-2&&g<=this.transform.maxZoom)return this.transform.minZoom=g,this._update(),this.getZoom()<g&&this.setZoom(g),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(g){if((g=g??22)>=this.transform.minZoom)return this.transform.maxZoom=g,this._update(),this.getZoom()>g&&this.setZoom(g),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(g){if((g=g??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(g>=0&&g<=this.transform.maxPitch)return this.transform.minPitch=g,this._update(),this.getPitch()<g&&this.setPitch(g),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(g){if((g=g??60)>85)throw new Error("maxPitch must be less than or equal to 85");if(g>=this.transform.minPitch)return this.transform.maxPitch=g,this._update(),this.getPitch()>g&&this.setPitch(g),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(g){return this.transform.renderWorldCopies=g,this._update()}project(g){return this.transform.locationPoint(s.M.convert(g),this.style&&this.terrain)}unproject(g){return this.transform.pointLocation(s.P.convert(g),this.terrain)}isMoving(){var g;return this._moving||((g=this.handlers)===null||g===void 0?void 0:g.isMoving())}isZooming(){var g;return this._zooming||((g=this.handlers)===null||g===void 0?void 0:g.isZooming())}isRotating(){var g;return this._rotating||((g=this.handlers)===null||g===void 0?void 0:g.isRotating())}_createDelegatedListener(g,t,n){if(g==="mouseenter"||g==="mouseover"){let c=!1;return{layer:t,listener:n,delegates:{mousemove:y=>{const P=this.getLayer(t)?this.queryRenderedFeatures(y.point,{layers:[t]}):[];P.length?c||(c=!0,n.call(this,new Ur(g,this,y.originalEvent,{features:P}))):c=!1},mouseout:()=>{c=!1}}}}if(g==="mouseleave"||g==="mouseout"){let c=!1;return{layer:t,listener:n,delegates:{mousemove:P=>{(this.getLayer(t)?this.queryRenderedFeatures(P.point,{layers:[t]}):[]).length?c=!0:c&&(c=!1,n.call(this,new Ur(g,this,P.originalEvent)))},mouseout:P=>{c&&(c=!1,n.call(this,new Ur(g,this,P.originalEvent)))}}}}{const c=d=>{const y=this.getLayer(t)?this.queryRenderedFeatures(d.point,{layers:[t]}):[];y.length&&(d.features=y,n.call(this,d),delete d.features)};return{layer:t,listener:n,delegates:{[g]:c}}}}on(g,t,n){if(n===void 0)return super.on(g,t);const c=this._createDelegatedListener(g,t,n);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[g]=this._delegatedListeners[g]||[],this._delegatedListeners[g].push(c);for(const d in c.delegates)this.on(d,c.delegates[d]);return this}once(g,t,n){if(n===void 0)return super.once(g,t);const c=this._createDelegatedListener(g,t,n);for(const d in c.delegates)this.once(d,c.delegates[d]);return this}off(g,t,n){return n===void 0?super.off(g,t):(this._delegatedListeners&&this._delegatedListeners[g]&&(c=>{const d=this._delegatedListeners[g];for(let y=0;y<d.length;y++){const P=d[y];if(P.layer===t&&P.listener===n){for(const k in P.delegates)this.off(k,P.delegates[k]);return d.splice(y,1),this}}})(),this)}queryRenderedFeatures(g,t){if(!this.style)return[];let n;const c=g instanceof s.P||Array.isArray(g),d=c?g:[[0,0],[this.transform.width,this.transform.height]];if(t=t||(c?{}:g)||{},d instanceof s.P||typeof d[0]=="number")n=[s.P.convert(d)];else{const y=s.P.convert(d[0]),P=s.P.convert(d[1]);n=[y,new s.P(P.x,y.y),P,new s.P(y.x,P.y),y]}return this.style.queryRenderedFeatures(n,t,this.transform)}querySourceFeatures(g,t){return this.style.querySourceFeatures(g,t)}setStyle(g,t){return(t=s.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},t)).diff!==!1&&t.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&g?(this._diffStyle(g,t),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._updateStyle(g,t))}setTransformRequest(g){return this._requestManager.setTransformRequest(g),this}_getUIString(g){const t=this._locale[g];if(t==null)throw new Error(`Missing UI string '${g}'`);return t}_updateStyle(g,t){if(t.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",()=>this._updateStyle(g,t));const n=this.style&&t.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!g)),g?(this.style=new an(this,t||{}),this.style.setEventedParent(this,{style:this.style}),typeof g=="string"?this.style.loadURL(g,t,n):this.style.loadJSON(g,t,n),this):(delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new an(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(g,t){if(typeof g=="string"){const n=this._requestManager.transformRequest(g,"Style");s.h(n,new AbortController).then(c=>{this._updateDiff(c.data,t)}).catch(c=>{c&&this.fire(new s.j(c))})}else typeof g=="object"&&this._updateDiff(g,t)}_updateDiff(g,t){try{this.style.setState(g,t)&&this._update(!0)}catch(n){s.w(`Unable to perform style diff: ${n.message||n.error||n}.  Rebuilding the style from scratch.`),this._updateStyle(g,t)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():s.w("There is no style added to the map.")}addSource(g,t){return this._lazyInitEmptyStyle(),this.style.addSource(g,t),this._update(!0)}isSourceLoaded(g){const t=this.style&&this.style.sourceCaches[g];if(t!==void 0)return t.loaded();this.fire(new s.j(new Error(`There is no source with ID '${g}'`)))}setTerrain(g){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),g){const t=this.style.sourceCaches[g.source];if(!t)throw new Error(`cannot load terrain, because there exists no source with ID: ${g.source}`);this.terrain===null&&t.reload();for(const n in this.style._layers){const c=this.style._layers[n];c.type==="hillshade"&&c.source===g.source&&s.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new uc(this.painter,t,g),this.painter.renderToTexture=new Al(this.painter,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._terrainDataCallback=n=>{n.dataType==="style"?this.terrain.sourceCache.freeRtt():n.dataType==="source"&&n.tile&&(n.sourceId!==g.source||this._elevationFreeze||(this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.terrain.sourceCache.freeRtt(n.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.minElevationForCurrentTile=0,this.transform.elevation=0;return this.fire(new s.k("terrain",{terrain:g})),this}getTerrain(){var g,t;return(t=(g=this.terrain)===null||g===void 0?void 0:g.options)!==null&&t!==void 0?t:null}areTilesLoaded(){const g=this.style&&this.style.sourceCaches;for(const t in g){const n=g[t]._tiles;for(const c in n){const d=n[c];if(d.state!=="loaded"&&d.state!=="errored")return!1}}return!0}removeSource(g){return this.style.removeSource(g),this._update(!0)}getSource(g){return this.style.getSource(g)}addImage(g,t,n={}){const{pixelRatio:c=1,sdf:d=!1,stretchX:y,stretchY:P,content:k}=n;if(this._lazyInitEmptyStyle(),!(t instanceof HTMLImageElement||s.b(t))){if(t.width===void 0||t.height===void 0)return this.fire(new s.j(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:L,height:R,data:U}=t,G=t;return this.style.addImage(g,{data:new s.R({width:L,height:R},new Uint8Array(U)),pixelRatio:c,stretchX:y,stretchY:P,content:k,sdf:d,version:0,userImage:G}),G.onAdd&&G.onAdd(this,g),this}}{const{width:L,height:R,data:U}=a.getImageData(t);this.style.addImage(g,{data:new s.R({width:L,height:R},U),pixelRatio:c,stretchX:y,stretchY:P,content:k,sdf:d,version:0})}}updateImage(g,t){const n=this.style.getImage(g);if(!n)return this.fire(new s.j(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const c=t instanceof HTMLImageElement||s.b(t)?a.getImageData(t):t,{width:d,height:y,data:P}=c;if(d===void 0||y===void 0)return this.fire(new s.j(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(d!==n.data.width||y!==n.data.height)return this.fire(new s.j(new Error("The width and height of the updated image must be that same as the previous version of the image")));const k=!(t instanceof HTMLImageElement||s.b(t));return n.data.replace(P,k),this.style.updateImage(g,n),this}getImage(g){return this.style.getImage(g)}hasImage(g){return g?!!this.style.getImage(g):(this.fire(new s.j(new Error("Missing required image id"))),!1)}removeImage(g){this.style.removeImage(g)}loadImage(g){return A.getImage(this._requestManager.transformRequest(g,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(g,t){return this._lazyInitEmptyStyle(),this.style.addLayer(g,t),this._update(!0)}moveLayer(g,t){return this.style.moveLayer(g,t),this._update(!0)}removeLayer(g){return this.style.removeLayer(g),this._update(!0)}getLayer(g){return this.style.getLayer(g)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(g,t,n){return this.style.setLayerZoomRange(g,t,n),this._update(!0)}setFilter(g,t,n={}){return this.style.setFilter(g,t,n),this._update(!0)}getFilter(g){return this.style.getFilter(g)}setPaintProperty(g,t,n,c={}){return this.style.setPaintProperty(g,t,n,c),this._update(!0)}getPaintProperty(g,t){return this.style.getPaintProperty(g,t)}setLayoutProperty(g,t,n,c={}){return this.style.setLayoutProperty(g,t,n,c),this._update(!0)}getLayoutProperty(g,t){return this.style.getLayoutProperty(g,t)}setGlyphs(g,t={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(g,t),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(g,t,n={}){return this._lazyInitEmptyStyle(),this.style.addSprite(g,t,n,c=>{c||this._update(!0)}),this}removeSprite(g){return this._lazyInitEmptyStyle(),this.style.removeSprite(g),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(g,t={}){return this._lazyInitEmptyStyle(),this.style.setSprite(g,t,n=>{n||this._update(!0)}),this}setLight(g,t={}){return this._lazyInitEmptyStyle(),this.style.setLight(g,t),this._update(!0)}getLight(){return this.style.getLight()}setFeatureState(g,t){return this.style.setFeatureState(g,t),this._update()}removeFeatureState(g,t){return this.style.removeFeatureState(g,t),this._update()}getFeatureState(g){return this.style.getFeatureState(g)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let g=0,t=0;return this._container&&(g=this._container.clientWidth||400,t=this._container.clientHeight||300),[g,t]}_setupContainer(){const g=this._container;g.classList.add("maplibregl-map");const t=this._canvasContainer=l.create("div","maplibregl-canvas-container",g);this._interactive&&t.classList.add("maplibregl-interactive"),this._canvas=l.create("canvas","maplibregl-canvas",t),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map"),this._canvas.setAttribute("role","region");const n=this._containerDimensions(),c=this._getClampedPixelRatio(n[0],n[1]);this._resizeCanvas(n[0],n[1],c);const d=this._controlContainer=l.create("div","maplibregl-control-container",g),y=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(P=>{y[P]=l.create("div",`maplibregl-ctrl-${P} `,d)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(g,t,n){this._canvas.width=Math.floor(n*g),this._canvas.height=Math.floor(n*t),this._canvas.style.width=`${g}px`,this._canvas.style.height=`${t}px`}_setupPainter(){const g={alpha:!0,stencil:!0,depth:!0,failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1};let t=null;this._canvas.addEventListener("webglcontextcreationerror",c=>{t={requestedAttributes:g},c&&(t.statusMessage=c.statusMessage,t.type=c.type)},{once:!0});const n=this._canvas.getContext("webgl2",g)||this._canvas.getContext("webgl",g);if(!n){const c="Failed to initialize WebGL";throw t?(t.message=c,new Error(JSON.stringify(t))):new Error(c)}this.painter=new Be(n,this.transform),h.testSupport(n)}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(g){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||g,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(g){return this._update(),this._renderTaskQueue.add(g)}_cancelRenderFrame(g){this._renderTaskQueue.remove(g)}_render(g){const t=this._idleTriggered?this._fadeDuration:0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(g),this._removed)return;let n=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const d=this.transform.zoom,y=a.now();this.style.zoomHistory.update(d,y);const P=new s.a8(d,{now:y,fadeDuration:t,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),k=P.crossFadingFactor();k===1&&k===this._crossFadingFactor||(n=!0,this._crossFadingFactor=k),this.style.update(P)}this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._elevationFreeze||(this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.minElevationForCurrentTile=0,this.transform.elevation=0),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,t,this._crossSourceCollisions),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:t,showPadding:this.showPadding}),this.fire(new s.k("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,s.bc.mark(s.bd.load),this.fire(new s.k("load"))),this.style&&(this.style.hasTransitions()||n)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const c=this._sourcesDirty||this._styleDirty||this._placementDirty;return c||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new s.k("idle")),!this._loaded||this._fullyLoaded||c||(this._fullyLoaded=!0,s.bc.mark(s.bd.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var g;this._hash&&this._hash.remove();for(const n of this._controls)n.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),A.removeThrottleControl(this._imageQueueHandle),(g=this._resizeObserver)===null||g===void 0||g.disconnect();const t=this.painter.context.gl.getExtension("WEBGL_lose_context");t&&t.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),l.remove(this._canvasContainer),l.remove(this._controlContainer),this._container.classList.remove("maplibregl-map"),s.bc.clearMetrics(),this._removed=!0,this.fire(new s.k("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,a.frameAsync(this._frameRequest).then(g=>{s.bc.frame(g),this._frameRequest=null,this._render(g)}).catch(()=>{}))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(g){this._showTileBoundaries!==g&&(this._showTileBoundaries=g,this._update())}get showPadding(){return!!this._showPadding}set showPadding(g){this._showPadding!==g&&(this._showPadding=g,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(g){this._showCollisionBoxes!==g&&(this._showCollisionBoxes=g,g?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(g){this._showOverdrawInspector!==g&&(this._showOverdrawInspector=g,this._update())}get repaint(){return!!this._repaint}set repaint(g){this._repaint!==g&&(this._repaint=g,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(g){this._vertices=g,this._update()}get version(){return kl}getCameraTargetElevation(){return this.transform.elevation}},j.MapMouseEvent=Ur,j.MapTouchEvent=hn,j.MapWheelEvent=Fs,j.Marker=Ma,j.NavigationControl=class{constructor(g){this._updateZoomButtons=()=>{const t=this._map.getZoom(),n=t===this._map.getMaxZoom(),c=t===this._map.getMinZoom();this._zoomInButton.disabled=n,this._zoomOutButton.disabled=c,this._zoomInButton.setAttribute("aria-disabled",n.toString()),this._zoomOutButton.setAttribute("aria-disabled",c.toString())},this._rotateCompassArrow=()=>{const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._compassIcon.style.transform=t},this._setButtonTitle=(t,n)=>{const c=this._map._getUIString(`NavigationControl.${n}`);t.title=c,t.setAttribute("aria-label",c)},this.options=s.e({},Ol,g),this._container=l.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",t=>this._map.zoomIn({},{originalEvent:t})),l.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",t=>this._map.zoomOut({},{originalEvent:t})),l.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",t=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:t}):this._map.resetNorth({},{originalEvent:t})}),this._compassIcon=l.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(g){return this._map=g,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Dl(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){l.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(g,t){const n=l.create("button",g,this._container);return n.type="button",n.addEventListener("click",t),n}},j.Popup=class extends s.E{constructor(g){super(),this.remove=()=>(this._content&&l.remove(this._content),this._container&&(l.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new s.k("close"))),this),this._onMouseUp=t=>{this._update(t.point)},this._onMouseMove=t=>{this._update(t.point)},this._onDrag=t=>{this._update(t.point)},this._update=t=>{var n;if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=l.create("div","maplibregl-popup",this._map.getContainer()),this._tip=l.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const k of this.options.className.split(" "))this._container.classList.add(k);this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=this._map.transform.renderWorldCopies&&!this._trackPointer?el(this._lngLat,this._flatPos,this._map.transform):(n=this._lngLat)===null||n===void 0?void 0:n.wrap(),this._trackPointer&&!t)return;const c=this._flatPos=this._pos=this._trackPointer&&t?t:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&t?t:this._map.transform.locationPoint(this._lngLat));let d=this.options.anchor;const y=sl(this.options.offset);if(!d){const k=this._container.offsetWidth,L=this._container.offsetHeight;let R;R=c.y+y.bottom.y<L?["top"]:c.y>this._map.transform.height-L?["bottom"]:[],c.x<k/2?R.push("left"):c.x>this._map.transform.width-k/2&&R.push("right"),d=R.length===0?"bottom":R.join("-")}let P=c.add(y[d]);this.options.subpixelPositioning||(P=P.round()),l.setTransform(this._container,`${Aa[d]} translate(${P.x}px,${P.y}px)`),tl(this._container,d,"popup")},this._onClose=()=>{this.remove()},this.options=s.e(Object.create(Ll),g)}addTo(g){return this._map&&this.remove(),this._map=g,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new s.k("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(g){return this._lngLat=s.M.convert(g),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(g){return this.setDOMContent(document.createTextNode(g))}setHTML(g){const t=document.createDocumentFragment(),n=document.createElement("body");let c;for(n.innerHTML=g;c=n.firstChild,c;)t.appendChild(c);return this.setDOMContent(t)}getMaxWidth(){var g;return(g=this._container)===null||g===void 0?void 0:g.style.maxWidth}setMaxWidth(g){return this.options.maxWidth=g,this._update(),this}setDOMContent(g){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=l.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(g),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(g){this._container&&this._container.classList.add(g)}removeClassName(g){this._container&&this._container.classList.remove(g)}setOffset(g){return this.options.offset=g,this._update(),this}toggleClassName(g){if(this._container)return this._container.classList.toggle(g)}setSubpixelPositioning(g){this.options.subpixelPositioning=g}_createCloseButton(){this.options.closeButton&&(this._closeButton=l.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.setAttribute("aria-label","Close popup"),this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const g=this._container.querySelector(zl);g&&g.focus()}},j.RasterDEMTileSource=ft,j.RasterTileSource=le,j.ScaleControl=class{constructor(g){this._onMove=()=>{nl(this._map,this._container,this.options)},this.setUnit=t=>{this.options.unit=t,nl(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},rl),g)}getDefaultPosition(){return"bottom-left"}onAdd(g){return this._map=g,this._container=l.create("div","maplibregl-ctrl maplibregl-ctrl-scale",g.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){l.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},j.ScrollZoomHandler=Ka,j.Style=an,j.TerrainControl=class{constructor(g){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=g}onAdd(g){return this._map=g,this._container=l.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=l.create("button","maplibregl-ctrl-terrain",this._container),l.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){l.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},j.TwoFingersTouchPitchHandler=oc,j.TwoFingersTouchRotateHandler=Js,j.TwoFingersTouchZoomHandler=vo,j.TwoFingersTouchZoomRotateHandler=Sa,j.VectorTileSource=qe,j.VideoSource=lt,j.addSourceType=(g,t)=>s._(void 0,void 0,void 0,function*(){if(fi(g))throw new Error(`A source type called "${g}" already exists.`);((n,c)=>{Yt[n]=c})(g,t)}),j.clearPrewarmedResources=function(){const g=te;g&&(g.isPreloaded()&&g.numActive()===1?(g.release(ge),te=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},j.getMaxParallelImageRequests=function(){return s.a.MAX_PARALLEL_IMAGE_REQUESTS},j.getRTLTextPluginStatus=function(){return ut().getRTLTextPluginStatus()},j.getVersion=function(){return dc},j.getWorkerCount=function(){return je.workerCount},j.getWorkerUrl=function(){return s.a.WORKER_URL},j.importScriptInWorkers=function(g){return He().broadcast("IS",g)},j.prewarm=function(){Ne().acquire(ge)},j.setMaxParallelImageRequests=function(g){s.a.MAX_PARALLEL_IMAGE_REQUESTS=g},j.setRTLTextPlugin=function(g,t){return ut().setRTLTextPlugin(g,t)},j.setWorkerCount=function(g){je.workerCount=g},j.setWorkerUrl=function(g){s.a.WORKER_URL=g}});var Ie=re;return Ie})})(Dd);var zd=Dd.exports;const xd=Od(zd);var Fd={exports:{}};(function($,S){(function(re,pe){$.exports=pe()})(yl,function(){var re=function(E,F){var Y={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},ye={on:function(Me,Re,Ct){if(Y[Me]===void 0)throw new Error("Invalid event type: "+Me);Y[Me].push({selector:Re,fn:Ct})},render:function(Me){F.store.featureChanged(Me)}},Ee=function(Me,Re){for(var Ct=Y[Me],kt=Ct.length;kt--;){var Ht=Ct[kt];if(Ht.selector(Re)){Ht.fn.call(ye,Re)||F.store.render(),F.ui.updateMapClasses();break}}};return E.start.call(ye),{render:E.render,stop:function(){E.stop&&E.stop()},trash:function(){E.trash&&(E.trash(),F.store.render())},combineFeatures:function(){E.combineFeatures&&E.combineFeatures()},uncombineFeatures:function(){E.uncombineFeatures&&E.uncombineFeatures()},drag:function(Me){Ee("drag",Me)},click:function(Me){Ee("click",Me)},mousemove:function(Me){Ee("mousemove",Me)},mousedown:function(Me){Ee("mousedown",Me)},mouseup:function(Me){Ee("mouseup",Me)},mouseout:function(Me){Ee("mouseout",Me)},keydown:function(Me){Ee("keydown",Me)},keyup:function(Me){Ee("keyup",Me)},touchstart:function(Me){Ee("touchstart",Me)},touchmove:function(Me){Ee("touchmove",Me)},touchend:function(Me){Ee("touchend",Me)},tap:function(Me){Ee("tap",Me)}}};function pe(E){return E&&E.__esModule&&Object.prototype.hasOwnProperty.call(E,"default")?E.default:E}function ue(E){if(E.__esModule)return E;var F=E.default;if(typeof F=="function"){var Y=function ye(){if(this instanceof ye){var Ee=[null];Ee.push.apply(Ee,arguments);var Me=Function.bind.apply(F,Ee);return new Me}return F.apply(this,arguments)};Y.prototype=F.prototype}else Y={};return Object.defineProperty(Y,"__esModule",{value:!0}),Object.keys(E).forEach(function(ye){var Ee=Object.getOwnPropertyDescriptor(E,ye);Object.defineProperty(Y,ye,Ee.get?Ee:{enumerable:!0,get:function(){return E[ye]}})}),Y}var Ie={},j={RADIUS:6378137,FLATTENING:1/298.257223563,POLAR_RADIUS:63567523142e-4},s=j;function p(E){var F=0;if(E&&E.length>0){F+=Math.abs(b(E[0]));for(var Y=1;Y<E.length;Y++)F-=Math.abs(b(E[Y]))}return F}function b(E){var F,Y,ye,Ee,Me,Re,Ct=0,kt=E.length;if(kt>2){for(Re=0;Re<kt;Re++)Re===kt-2?(ye=kt-2,Ee=kt-1,Me=0):Re===kt-1?(ye=kt-1,Ee=0,Me=1):(ye=Re,Ee=Re+1,Me=Re+2),F=E[ye],Y=E[Ee],Ct+=(v(E[Me][0])-v(F[0]))*Math.sin(v(Y[1]));Ct=Ct*s.RADIUS*s.RADIUS/2}return Ct}function v(E){return E*Math.PI/180}Ie.geometry=function E(F){var Y,ye=0;switch(F.type){case"Polygon":return p(F.coordinates);case"MultiPolygon":for(Y=0;Y<F.coordinates.length;Y++)ye+=p(F.coordinates[Y]);return ye;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(Y=0;Y<F.geometries.length;Y++)ye+=E(F.geometries[Y]);return ye}},Ie.ring=b;var a={CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},l={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},h={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},m={POLYGON:"polygon",LINE:"line_string",POINT:"point"},_={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},u={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select",STATIC:"static"},x={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},T={MOVE:"move",CHANGE_COORDINATES:"change_coordinates"},A={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},D={ACTIVE:"true",INACTIVE:"false"},V=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],X=-85,ie=Object.freeze({__proto__:null,classes:a,sources:l,cursors:h,types:m,geojsonTypes:_,modes:u,events:x,updateActions:T,meta:A,activeStates:D,interactions:V,LAT_MIN:-90,LAT_RENDERED_MIN:X,LAT_MAX:90,LAT_RENDERED_MAX:85,LNG_MIN:-270,LNG_MAX:270}),ve={Point:0,LineString:1,MultiLineString:1,Polygon:2};function Fe(E,F){var Y=ve[E.geometry.type]-ve[F.geometry.type];return Y===0&&E.geometry.type===_.POLYGON?E.area-F.area:Y}function Ye(E){return E.map(function(F){return F.geometry.type===_.POLYGON&&(F.area=Ie.geometry({type:_.FEATURE,property:{},geometry:F.geometry})),F}).sort(Fe).map(function(F){return delete F.area,F})}function Ze(E,F){return F===void 0&&(F=0),[[E.point.x-F,E.point.y-F],[E.point.x+F,E.point.y+F]]}function Je(E){if(this._items={},this._nums={},this._length=E?E.length:0,E)for(var F=0,Y=E.length;F<Y;F++)this.add(E[F]),E[F]!==void 0&&(typeof E[F]=="string"?this._items[E[F]]=F:this._nums[E[F]]=F)}Je.prototype.add=function(E){return this.has(E)||(this._length++,typeof E=="string"?this._items[E]=this._length:this._nums[E]=this._length),this},Je.prototype.delete=function(E){return this.has(E)===!1||(this._length--,delete this._items[E],delete this._nums[E]),this},Je.prototype.has=function(E){return(typeof E=="string"||typeof E=="number")&&(this._items[E]!==void 0||this._nums[E]!==void 0)},Je.prototype.values=function(){var E=this,F=[];return Object.keys(this._items).forEach(function(Y){F.push({k:Y,v:E._items[Y]})}),Object.keys(this._nums).forEach(function(Y){F.push({k:JSON.parse(Y),v:E._nums[Y]})}),F.sort(function(Y,ye){return Y.v-ye.v}).map(function(Y){return Y.k})},Je.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};var ct=[A.FEATURE,A.MIDPOINT,A.VERTEX],nt={click:function(E,F,Y){return vt(E,F,Y,Y.options.clickBuffer)},touch:function(E,F,Y){return vt(E,F,Y,Y.options.touchBuffer)}};function vt(E,F,Y,ye){if(Y.map===null)return[];var Ee=E?Ze(E,ye):F,Me={};Y.options.styles&&(Me.layers=Y.options.styles.map(function(Ht){return Ht.id}).filter(function(Ht){return Y.map.getLayer(Ht)!=null}));var Re=Y.map.queryRenderedFeatures(Ee,Me).filter(function(Ht){return ct.indexOf(Ht.properties.meta)!==-1}),Ct=new Je,kt=[];return Re.forEach(function(Ht){var Wt=Ht.properties.id;Ct.has(Wt)||(Ct.add(Wt),kt.push(Ht))}),Ye(kt)}function Mt(E,F){var Y=nt.click(E,null,F),ye={mouse:h.NONE};return Y[0]&&(ye.mouse=Y[0].properties.active===D.ACTIVE?h.MOVE:h.POINTER,ye.feature=Y[0].properties.meta),F.events.currentModeName().indexOf("draw")!==-1&&(ye.mouse=h.ADD),F.ui.queueMapClasses(ye),F.ui.updateMapClasses(),Y[0]}function st(E,F){var Y=E.x-F.x,ye=E.y-F.y;return Math.sqrt(Y*Y+ye*ye)}function bt(E,F,Y){Y===void 0&&(Y={});var ye=Y.fineTolerance!=null?Y.fineTolerance:4,Ee=Y.grossTolerance!=null?Y.grossTolerance:12,Me=Y.interval!=null?Y.interval:500;E.point=E.point||F.point,E.time=E.time||F.time;var Re=st(E.point,F.point);return Re<ye||Re<Ee&&F.time-E.time<Me}function ee(E,F,Y){Y===void 0&&(Y={});var ye=Y.tolerance!=null?Y.tolerance:25,Ee=Y.interval!=null?Y.interval:250;return E.point=E.point||F.point,E.time=E.time||F.time,st(E.point,F.point)<ye&&F.time-E.time<Ee}var be={exports:{}},me=be.exports=function(E,F){if(F||(F=16),E===void 0&&(E=128),E<=0)return"0";for(var Y=Math.log(Math.pow(2,E))/Math.log(F),ye=2;Y===1/0;ye*=2)Y=Math.log(Math.pow(2,E/ye))/Math.log(F)*ye;var Ee=Y-Math.floor(Y),Me="";for(ye=0;ye<Math.floor(Y);ye++)Me=Math.floor(Math.random()*F).toString(F)+Me;if(Ee){var Re=Math.pow(F,Ee);Me=Math.floor(Math.random()*Re).toString(F)+Me}var Ct=parseInt(Me,F);return Ct!==1/0&&Ct>=Math.pow(2,E)?me(E,F):Me};me.rack=function(E,F,Y){var ye=function(Me){var Re=0;do{if(Re++>10){if(!Y)throw new Error("too many ID collisions, use more bits");E+=Y}var Ct=me(E,F)}while(Object.hasOwnProperty.call(Ee,Ct));return Ee[Ct]=Me,Ct},Ee=ye.hats={};return ye.get=function(Me){return ye.hats[Me]},ye.set=function(Me,Re){return ye.hats[Me]=Re,ye},ye.bits=E||128,ye.base=F||16,ye};var ge=pe(be.exports),je=function(E,F){this.ctx=E,this.properties=F.properties||{},this.coordinates=F.geometry.coordinates,this.id=F.id||ge(),this.type=F.geometry.type};je.prototype.changed=function(){this.ctx.store.featureChanged(this.id)},je.prototype.incomingCoords=function(E){this.setCoordinates(E)},je.prototype.setCoordinates=function(E){this.coordinates=E,this.changed()},je.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))},je.prototype.setProperty=function(E,F){this.properties[E]=F},je.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:_.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))},je.prototype.internal=function(E){var F={id:this.id,meta:A.FEATURE,"meta:type":this.type,active:D.INACTIVE,mode:E};if(this.ctx.options.userProperties)for(var Y in this.properties)F["user_"+Y]=this.properties[Y];return{type:_.FEATURE,properties:F,geometry:{coordinates:this.getCoordinates(),type:this.type}}};var _e=function(E,F){je.call(this,E,F)};(_e.prototype=Object.create(je.prototype)).isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"},_e.prototype.updateCoordinate=function(E,F,Y){this.coordinates=arguments.length===3?[F,Y]:[E,F],this.changed()},_e.prototype.getCoordinate=function(){return this.getCoordinates()};var te=function(E,F){je.call(this,E,F)};(te.prototype=Object.create(je.prototype)).isValid=function(){return this.coordinates.length>1},te.prototype.addCoordinate=function(E,F,Y){this.changed();var ye=parseInt(E,10);this.coordinates.splice(ye,0,[F,Y])},te.prototype.getCoordinate=function(E){var F=parseInt(E,10);return JSON.parse(JSON.stringify(this.coordinates[F]))},te.prototype.removeCoordinate=function(E){this.changed(),this.coordinates.splice(parseInt(E,10),1)},te.prototype.updateCoordinate=function(E,F,Y){var ye=parseInt(E,10);this.coordinates[ye]=[F,Y],this.changed()};var Pe=function(E,F){je.call(this,E,F),this.coordinates=this.coordinates.map(function(Y){return Y.slice(0,-1)})};(Pe.prototype=Object.create(je.prototype)).isValid=function(){return this.coordinates.length!==0&&this.coordinates.every(function(E){return E.length>2})},Pe.prototype.incomingCoords=function(E){this.coordinates=E.map(function(F){return F.slice(0,-1)}),this.changed()},Pe.prototype.setCoordinates=function(E){this.coordinates=E,this.changed()},Pe.prototype.addCoordinate=function(E,F,Y){this.changed();var ye=E.split(".").map(function(Ee){return parseInt(Ee,10)});this.coordinates[ye[0]].splice(ye[1],0,[F,Y])},Pe.prototype.removeCoordinate=function(E){this.changed();var F=E.split(".").map(function(ye){return parseInt(ye,10)}),Y=this.coordinates[F[0]];Y&&(Y.splice(F[1],1),Y.length<3&&this.coordinates.splice(F[0],1))},Pe.prototype.getCoordinate=function(E){var F=E.split(".").map(function(ye){return parseInt(ye,10)}),Y=this.coordinates[F[0]];return JSON.parse(JSON.stringify(Y[F[1]]))},Pe.prototype.getCoordinates=function(){return this.coordinates.map(function(E){return E.concat([E[0]])})},Pe.prototype.updateCoordinate=function(E,F,Y){this.changed();var ye=E.split("."),Ee=parseInt(ye[0],10),Me=parseInt(ye[1],10);this.coordinates[Ee]===void 0&&(this.coordinates[Ee]=[]),this.coordinates[Ee][Me]=[F,Y]};var Ne={MultiPoint:_e,MultiLineString:te,MultiPolygon:Pe},et=function(E,F,Y,ye,Ee){var Me=Y.split("."),Re=parseInt(Me[0],10),Ct=Me[1]?Me.slice(1).join("."):null;return E[Re][F](Ct,ye,Ee)},He=function(E,F){if(je.call(this,E,F),delete this.coordinates,this.model=Ne[F.geometry.type],this.model===void 0)throw new TypeError(F.geometry.type+" is not a valid type");this.features=this._coordinatesToFeatures(F.geometry.coordinates)};function Ge(E){this.map=E.map,this.drawConfig=JSON.parse(JSON.stringify(E.options||{})),this._ctx=E}(He.prototype=Object.create(je.prototype))._coordinatesToFeatures=function(E){var F=this,Y=this.model.bind(this);return E.map(function(ye){return new Y(F.ctx,{id:ge(),type:_.FEATURE,properties:{},geometry:{coordinates:ye,type:F.type.replace("Multi","")}})})},He.prototype.isValid=function(){return this.features.every(function(E){return E.isValid()})},He.prototype.setCoordinates=function(E){this.features=this._coordinatesToFeatures(E),this.changed()},He.prototype.getCoordinate=function(E){return et(this.features,"getCoordinate",E)},He.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(function(E){return E.type===_.POLYGON?E.getCoordinates():E.coordinates})))},He.prototype.updateCoordinate=function(E,F,Y){et(this.features,"updateCoordinate",E,F,Y),this.changed()},He.prototype.addCoordinate=function(E,F,Y){et(this.features,"addCoordinate",E,F,Y),this.changed()},He.prototype.removeCoordinate=function(E){et(this.features,"removeCoordinate",E),this.changed()},He.prototype.getFeatures=function(){return this.features},Ge.prototype.setSelected=function(E){return this._ctx.store.setSelected(E)},Ge.prototype.setSelectedCoordinates=function(E){var F=this;this._ctx.store.setSelectedCoordinates(E),E.reduce(function(Y,ye){return Y[ye.feature_id]===void 0&&(Y[ye.feature_id]=!0,F._ctx.store.get(ye.feature_id).changed()),Y},{})},Ge.prototype.getSelected=function(){return this._ctx.store.getSelected()},Ge.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()},Ge.prototype.isSelected=function(E){return this._ctx.store.isSelected(E)},Ge.prototype.getFeature=function(E){return this._ctx.store.get(E)},Ge.prototype.select=function(E){return this._ctx.store.select(E)},Ge.prototype.deselect=function(E){return this._ctx.store.deselect(E)},Ge.prototype.deleteFeature=function(E,F){return F===void 0&&(F={}),this._ctx.store.delete(E,F)},Ge.prototype.addFeature=function(E){return this._ctx.store.add(E)},Ge.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()},Ge.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()},Ge.prototype.setActionableState=function(E){E===void 0&&(E={});var F={trash:E.trash||!1,combineFeatures:E.combineFeatures||!1,uncombineFeatures:E.uncombineFeatures||!1};return this._ctx.events.actionable(F)},Ge.prototype.changeMode=function(E,F,Y){return F===void 0&&(F={}),Y===void 0&&(Y={}),this._ctx.events.changeMode(E,F,Y)},Ge.prototype.updateUIClasses=function(E){return this._ctx.ui.queueMapClasses(E)},Ge.prototype.activateUIButton=function(E){return this._ctx.ui.setActiveButton(E)},Ge.prototype.featuresAt=function(E,F,Y){if(Y===void 0&&(Y="click"),Y!=="click"&&Y!=="touch")throw new Error("invalid buffer type");return nt[Y](E,F,this._ctx)},Ge.prototype.newFeature=function(E){var F=E.geometry.type;return F===_.POINT?new _e(this._ctx,E):F===_.LINE_STRING?new te(this._ctx,E):F===_.POLYGON?new Pe(this._ctx,E):new He(this._ctx,E)},Ge.prototype.isInstanceOf=function(E,F){if(E===_.POINT)return F instanceof _e;if(E===_.LINE_STRING)return F instanceof te;if(E===_.POLYGON)return F instanceof Pe;if(E==="MultiFeature")return F instanceof He;throw new Error("Unknown feature class: "+E)},Ge.prototype.doRender=function(E){return this._ctx.store.featureChanged(E)},Ge.prototype.onSetup=function(){},Ge.prototype.onDrag=function(){},Ge.prototype.onClick=function(){},Ge.prototype.onMouseMove=function(){},Ge.prototype.onMouseDown=function(){},Ge.prototype.onMouseUp=function(){},Ge.prototype.onMouseOut=function(){},Ge.prototype.onKeyUp=function(){},Ge.prototype.onKeyDown=function(){},Ge.prototype.onTouchStart=function(){},Ge.prototype.onTouchMove=function(){},Ge.prototype.onTouchEnd=function(){},Ge.prototype.onTap=function(){},Ge.prototype.onStop=function(){},Ge.prototype.onTrash=function(){},Ge.prototype.onCombineFeature=function(){},Ge.prototype.onUncombineFeature=function(){},Ge.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};var _t={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},It=Object.keys(_t);function Xe(E){var F=Object.keys(E);return function(Y,ye){ye===void 0&&(ye={});var Ee={},Me=F.reduce(function(Re,Ct){return Re[Ct]=E[Ct],Re},new Ge(Y));return{start:function(){var Re=this;Ee=Me.onSetup(ye),It.forEach(function(Ct){var kt,Ht=_t[Ct],Wt=function(){return!1};E[Ht]&&(Wt=function(){return!0}),Re.on(Ct,Wt,(kt=Ht,function(Ft){return Me[kt](Ee,Ft)}))})},stop:function(){Me.onStop(Ee)},trash:function(){Me.onTrash(Ee)},combineFeatures:function(){Me.onCombineFeatures(Ee)},uncombineFeatures:function(){Me.onUncombineFeatures(Ee)},render:function(Re,Ct){Me.toDisplayFeatures(Ee,Re,Ct)}}}}function Oe(E){return[].concat(E).filter(function(F){return F!==void 0})}function ot(){var E=this;if(!(E.ctx.map&&E.ctx.map.getSource(l.HOT)!==void 0))return kt();var F=E.ctx.events.currentModeName();E.ctx.ui.queueMapClasses({mode:F});var Y=[],ye=[];E.isDirty?ye=E.getAllIds():(Y=E.getChangedIds().filter(function(Ht){return E.get(Ht)!==void 0}),ye=E.sources.hot.filter(function(Ht){return Ht.properties.id&&Y.indexOf(Ht.properties.id)===-1&&E.get(Ht.properties.id)!==void 0}).map(function(Ht){return Ht.properties.id})),E.sources.hot=[];var Ee=E.sources.cold.length;E.sources.cold=E.isDirty?[]:E.sources.cold.filter(function(Ht){var Wt=Ht.properties.id||Ht.properties.parent;return Y.indexOf(Wt)===-1});var Me=Ee!==E.sources.cold.length||ye.length>0;function Re(Ht,Wt){var Ft=E.get(Ht).internal(F);E.ctx.events.currentModeRender(Ft,function(vi){E.sources[Wt].push(vi)})}if(Y.forEach(function(Ht){return Re(Ht,"hot")}),ye.forEach(function(Ht){return Re(Ht,"cold")}),Me&&E.ctx.map.getSource(l.COLD).setData({type:_.FEATURE_COLLECTION,features:E.sources.cold}),E.ctx.map.getSource(l.HOT).setData({type:_.FEATURE_COLLECTION,features:E.sources.hot}),E._emitSelectionChange&&(E.ctx.map.fire(x.SELECTION_CHANGE,{features:E.getSelected().map(function(Ht){return Ht.toGeoJSON()}),points:E.getSelectedCoordinates().map(function(Ht){return{type:_.FEATURE,properties:{},geometry:{type:_.POINT,coordinates:Ht.coordinates}}})}),E._emitSelectionChange=!1),E._deletedFeaturesToEmit.length){var Ct=E._deletedFeaturesToEmit.map(function(Ht){return Ht.toGeoJSON()});E._deletedFeaturesToEmit=[],E.ctx.map.fire(x.DELETE,{features:Ct})}function kt(){E.isDirty=!1,E.clearChangedIds()}kt(),E.ctx.map.fire(x.RENDER,{})}function qe(E){var F,Y=this;this._features={},this._featureIds=new Je,this._selectedFeatureIds=new Je,this._selectedCoordinates=[],this._changedFeatureIds=new Je,this._deletedFeaturesToEmit=[],this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=E,this.sources={hot:[],cold:[]},this.render=function(){F||(F=requestAnimationFrame(function(){F=null,ot.call(Y)}))},this.isDirty=!1}function le(E,F){var Y=E._selectedCoordinates.filter(function(ye){return E._selectedFeatureIds.has(ye.feature_id)});E._selectedCoordinates.length===Y.length||F.silent||(E._emitSelectionChange=!0),E._selectedCoordinates=Y}qe.prototype.createRenderBatch=function(){var E=this,F=this.render,Y=0;return this.render=function(){Y++},function(){E.render=F,Y>0&&E.render()}},qe.prototype.setDirty=function(){return this.isDirty=!0,this},qe.prototype.featureChanged=function(E){return this._changedFeatureIds.add(E),this},qe.prototype.getChangedIds=function(){return this._changedFeatureIds.values()},qe.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this},qe.prototype.getAllIds=function(){return this._featureIds.values()},qe.prototype.add=function(E){return this.featureChanged(E.id),this._features[E.id]=E,this._featureIds.add(E.id),this},qe.prototype.delete=function(E,F){var Y=this;return F===void 0&&(F={}),Oe(E).forEach(function(ye){Y._featureIds.has(ye)&&(Y._featureIds.delete(ye),Y._selectedFeatureIds.delete(ye),F.silent||Y._deletedFeaturesToEmit.indexOf(Y._features[ye])===-1&&Y._deletedFeaturesToEmit.push(Y._features[ye]),delete Y._features[ye],Y.isDirty=!0)}),le(this,F),this},qe.prototype.get=function(E){return this._features[E]},qe.prototype.getAll=function(){var E=this;return Object.keys(this._features).map(function(F){return E._features[F]})},qe.prototype.select=function(E,F){var Y=this;return F===void 0&&(F={}),Oe(E).forEach(function(ye){Y._selectedFeatureIds.has(ye)||(Y._selectedFeatureIds.add(ye),Y._changedFeatureIds.add(ye),F.silent||(Y._emitSelectionChange=!0))}),this},qe.prototype.deselect=function(E,F){var Y=this;return F===void 0&&(F={}),Oe(E).forEach(function(ye){Y._selectedFeatureIds.has(ye)&&(Y._selectedFeatureIds.delete(ye),Y._changedFeatureIds.add(ye),F.silent||(Y._emitSelectionChange=!0))}),le(this,F),this},qe.prototype.clearSelected=function(E){return E===void 0&&(E={}),this.deselect(this._selectedFeatureIds.values(),{silent:E.silent}),this},qe.prototype.setSelected=function(E,F){var Y=this;return F===void 0&&(F={}),E=Oe(E),this.deselect(this._selectedFeatureIds.values().filter(function(ye){return E.indexOf(ye)===-1}),{silent:F.silent}),this.select(E.filter(function(ye){return!Y._selectedFeatureIds.has(ye)}),{silent:F.silent}),this},qe.prototype.setSelectedCoordinates=function(E){return this._selectedCoordinates=E,this._emitSelectionChange=!0,this},qe.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this},qe.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()},qe.prototype.getSelected=function(){var E=this;return this._selectedFeatureIds.values().map(function(F){return E.get(F)})},qe.prototype.getSelectedCoordinates=function(){var E=this;return this._selectedCoordinates.map(function(F){return{coordinates:E.get(F.feature_id).getCoordinate(F.coord_path)}})},qe.prototype.isSelected=function(E){return this._selectedFeatureIds.has(E)},qe.prototype.setFeatureProperty=function(E,F,Y){this.get(E).setProperty(F,Y),this.featureChanged(E)},qe.prototype.storeMapConfig=function(){var E=this;V.forEach(function(F){E.ctx.map[F]&&(E._mapInitialConfig[F]=E.ctx.map[F].isEnabled())})},qe.prototype.restoreMapConfig=function(){var E=this;Object.keys(this._mapInitialConfig).forEach(function(F){E._mapInitialConfig[F]?E.ctx.map[F].enable():E.ctx.map[F].disable()})},qe.prototype.getInitialConfigValue=function(E){return this._mapInitialConfig[E]===void 0||this._mapInitialConfig[E]};var ft=function(){for(var E=arguments,F={},Y=0;Y<arguments.length;Y++){var ye=E[Y];for(var Ee in ye)Pt.call(ye,Ee)&&(F[Ee]=ye[Ee])}return F},Pt=Object.prototype.hasOwnProperty,Tt=pe(ft),Nt=["mode","feature","mouse"];function lt(E){var F=null,Y=null,ye={onRemove:function(){return E.map.off("load",ye.connect),clearInterval(Y),ye.removeLayers(),E.store.restoreMapConfig(),E.ui.removeButtons(),E.events.removeEventListeners(),E.ui.clearMapClasses(),E.boxZoomInitial&&E.map.boxZoom.enable(),E.map=null,E.container=null,E.store=null,F&&F.parentNode&&F.parentNode.removeChild(F),F=null,this},connect:function(){E.map.off("load",ye.connect),clearInterval(Y),ye.addLayers(),E.store.storeMapConfig(),E.events.addEventListeners()},onAdd:function(Ee){var Me=Ee.fire;return Ee.fire=function(Re,Ct){var kt=arguments;return Me.length===1&&arguments.length!==1&&(kt=[Tt({},{type:Re},Ct)]),Me.apply(Ee,kt)},E.map=Ee,E.events=function(Re){var Ct=Object.keys(Re.options.modes).reduce(function(mt,Qt){return mt[Qt]=Xe(Re.options.modes[Qt]),mt},{}),kt={},Ht={},Wt={},Ft=null,vi=null;Wt.drag=function(mt,Qt){Qt({point:mt.point,time:new Date().getTime()})?(Re.ui.queueMapClasses({mouse:h.DRAG}),vi.drag(mt)):mt.originalEvent.stopPropagation()},Wt.mousedrag=function(mt){Wt.drag(mt,function(Qt){return!bt(kt,Qt)})},Wt.touchdrag=function(mt){Wt.drag(mt,function(Qt){return!ee(Ht,Qt)})},Wt.mousemove=function(mt){if((mt.originalEvent.buttons!==void 0?mt.originalEvent.buttons:mt.originalEvent.which)===1)return Wt.mousedrag(mt);var Qt=Mt(mt,Re);mt.featureTarget=Qt,vi.mousemove(mt)},Wt.mousedown=function(mt){kt={time:new Date().getTime(),point:mt.point};var Qt=Mt(mt,Re);mt.featureTarget=Qt,vi.mousedown(mt)},Wt.mouseup=function(mt){var Qt=Mt(mt,Re);mt.featureTarget=Qt,bt(kt,{point:mt.point,time:new Date().getTime()})?vi.click(mt):vi.mouseup(mt)},Wt.mouseout=function(mt){vi.mouseout(mt)},Wt.touchstart=function(mt){if(Re.options.touchEnabled){Ht={time:new Date().getTime(),point:mt.point};var Qt=nt.touch(mt,null,Re)[0];mt.featureTarget=Qt,vi.touchstart(mt)}},Wt.touchmove=function(mt){if(Re.options.touchEnabled)return vi.touchmove(mt),Wt.touchdrag(mt)},Wt.touchend=function(mt){if(mt.originalEvent.preventDefault(),Re.options.touchEnabled){var Qt=nt.touch(mt,null,Re)[0];mt.featureTarget=Qt,ee(Ht,{time:new Date().getTime(),point:mt.point})?vi.tap(mt):vi.touchend(mt)}};var ar=function(mt){return!(mt===8||mt===46||mt>=48&&mt<=57)};function xi(mt,Qt,Ai){Ai===void 0&&(Ai={}),vi.stop();var gr=Ct[mt];if(gr===void 0)throw new Error(mt+" is not valid");Ft=mt;var dr=gr(Re,Qt);vi=re(dr,Re),Ai.silent||Re.map.fire(x.MODE_CHANGE,{mode:mt}),Re.store.setDirty(),Re.store.render()}Wt.keydown=function(mt){(mt.srcElement||mt.target).classList.contains("mapboxgl-canvas")&&(mt.keyCode!==8&&mt.keyCode!==46||!Re.options.controls.trash?ar(mt.keyCode)?vi.keydown(mt):mt.keyCode===49&&Re.options.controls.point?xi(u.DRAW_POINT):mt.keyCode===50&&Re.options.controls.line_string?xi(u.DRAW_LINE_STRING):mt.keyCode===51&&Re.options.controls.polygon&&xi(u.DRAW_POLYGON):(mt.preventDefault(),vi.trash()))},Wt.keyup=function(mt){ar(mt.keyCode)&&vi.keyup(mt)},Wt.zoomend=function(){Re.store.changeZoom()},Wt.data=function(mt){if(mt.dataType==="style"){var Qt=Re.setup,Ai=Re.map,gr=Re.options,dr=Re.store;gr.styles.some(function(Ms){return Ai.getLayer(Ms.id)})||(Qt.addLayers(),dr.setDirty(),dr.render())}};var Tr={trash:!1,combineFeatures:!1,uncombineFeatures:!1};return{start:function(){Ft=Re.options.defaultMode,vi=re(Ct[Ft](Re),Re)},changeMode:xi,actionable:function(mt){var Qt=!1;Object.keys(mt).forEach(function(Ai){if(Tr[Ai]===void 0)throw new Error("Invalid action type");Tr[Ai]!==mt[Ai]&&(Qt=!0),Tr[Ai]=mt[Ai]}),Qt&&Re.map.fire(x.ACTIONABLE,{actions:Tr})},currentModeName:function(){return Ft},currentModeRender:function(mt,Qt){return vi.render(mt,Qt)},fire:function(mt,Qt){Wt[mt]&&Wt[mt](Qt)},addEventListeners:function(){Re.map.on("mousemove",Wt.mousemove),Re.map.on("mousedown",Wt.mousedown),Re.map.on("mouseup",Wt.mouseup),Re.map.on("data",Wt.data),Re.map.on("touchmove",Wt.touchmove),Re.map.on("touchstart",Wt.touchstart),Re.map.on("touchend",Wt.touchend),Re.container.addEventListener("mouseout",Wt.mouseout),Re.options.keybindings&&(Re.container.addEventListener("keydown",Wt.keydown),Re.container.addEventListener("keyup",Wt.keyup))},removeEventListeners:function(){Re.map.off("mousemove",Wt.mousemove),Re.map.off("mousedown",Wt.mousedown),Re.map.off("mouseup",Wt.mouseup),Re.map.off("data",Wt.data),Re.map.off("touchmove",Wt.touchmove),Re.map.off("touchstart",Wt.touchstart),Re.map.off("touchend",Wt.touchend),Re.container.removeEventListener("mouseout",Wt.mouseout),Re.options.keybindings&&(Re.container.removeEventListener("keydown",Wt.keydown),Re.container.removeEventListener("keyup",Wt.keyup))},trash:function(mt){vi.trash(mt)},combineFeatures:function(){vi.combineFeatures()},uncombineFeatures:function(){vi.uncombineFeatures()},getMode:function(){return Ft}}}(E),E.ui=function(Re){var Ct={},kt=null,Ht={mode:null,feature:null,mouse:null},Wt={mode:null,feature:null,mouse:null};function Ft(mt){Wt=Tt(Wt,mt)}function vi(){var mt,Qt;if(Re.container){var Ai=[],gr=[];Nt.forEach(function(dr){Wt[dr]!==Ht[dr]&&(Ai.push(dr+"-"+Ht[dr]),Wt[dr]!==null&&gr.push(dr+"-"+Wt[dr]))}),Ai.length>0&&(mt=Re.container.classList).remove.apply(mt,Ai),gr.length>0&&(Qt=Re.container.classList).add.apply(Qt,gr),Ht=Tt(Ht,Wt)}}function ar(mt,Qt){Qt===void 0&&(Qt={});var Ai=document.createElement("button");return Ai.className=a.CONTROL_BUTTON+" "+Qt.className,Ai.setAttribute("title",Qt.title),Qt.container.appendChild(Ai),Ai.addEventListener("click",function(gr){if(gr.preventDefault(),gr.stopPropagation(),gr.target===kt)return xi(),void Qt.onDeactivate();Tr(mt),Qt.onActivate()},!0),Ai}function xi(){kt&&(kt.classList.remove(a.ACTIVE_BUTTON),kt=null)}function Tr(mt){xi();var Qt=Ct[mt];Qt&&Qt&&mt!=="trash"&&(Qt.classList.add(a.ACTIVE_BUTTON),kt=Qt)}return{setActiveButton:Tr,queueMapClasses:Ft,updateMapClasses:vi,clearMapClasses:function(){Ft({mode:null,feature:null,mouse:null}),vi()},addButtons:function(){var mt=Re.options.controls,Qt=document.createElement("div");return Qt.className=a.CONTROL_GROUP+" "+a.CONTROL_BASE,mt&&(mt[m.LINE]&&(Ct[m.LINE]=ar(m.LINE,{container:Qt,className:a.CONTROL_BUTTON_LINE,title:"LineString tool "+(Re.options.keybindings?"(l)":""),onActivate:function(){return Re.events.changeMode(u.DRAW_LINE_STRING)},onDeactivate:function(){return Re.events.trash()}})),mt[m.POLYGON]&&(Ct[m.POLYGON]=ar(m.POLYGON,{container:Qt,className:a.CONTROL_BUTTON_POLYGON,title:"Polygon tool "+(Re.options.keybindings?"(p)":""),onActivate:function(){return Re.events.changeMode(u.DRAW_POLYGON)},onDeactivate:function(){return Re.events.trash()}})),mt[m.POINT]&&(Ct[m.POINT]=ar(m.POINT,{container:Qt,className:a.CONTROL_BUTTON_POINT,title:"Marker tool "+(Re.options.keybindings?"(m)":""),onActivate:function(){return Re.events.changeMode(u.DRAW_POINT)},onDeactivate:function(){return Re.events.trash()}})),mt.trash&&(Ct.trash=ar("trash",{container:Qt,className:a.CONTROL_BUTTON_TRASH,title:"Delete",onActivate:function(){Re.events.trash()}})),mt.combine_features&&(Ct.combine_features=ar("combineFeatures",{container:Qt,className:a.CONTROL_BUTTON_COMBINE_FEATURES,title:"Combine",onActivate:function(){Re.events.combineFeatures()}})),mt.uncombine_features&&(Ct.uncombine_features=ar("uncombineFeatures",{container:Qt,className:a.CONTROL_BUTTON_UNCOMBINE_FEATURES,title:"Uncombine",onActivate:function(){Re.events.uncombineFeatures()}}))),Qt},removeButtons:function(){Object.keys(Ct).forEach(function(mt){var Qt=Ct[mt];Qt.parentNode&&Qt.parentNode.removeChild(Qt),delete Ct[mt]})}}}(E),E.container=Ee.getContainer(),E.store=new qe(E),F=E.ui.addButtons(),E.options.boxSelect&&(E.boxZoomInitial=Ee.boxZoom.isEnabled(),Ee.boxZoom.disable(),Ee.dragPan.disable(),Ee.dragPan.enable()),Ee.loaded()?ye.connect():(Ee.on("load",ye.connect),Y=setInterval(function(){Ee.loaded()&&ye.connect()},16)),E.events.start(),F},addLayers:function(){E.map.addSource(l.COLD,{data:{type:_.FEATURE_COLLECTION,features:[]},type:"geojson"}),E.map.addSource(l.HOT,{data:{type:_.FEATURE_COLLECTION,features:[]},type:"geojson"}),E.options.styles.forEach(function(Ee){E.map.addLayer(Ee)}),E.store.setDirty(!0),E.store.render()},removeLayers:function(){E.options.styles.forEach(function(Ee){E.map.getLayer(Ee.id)&&E.map.removeLayer(Ee.id)}),E.map.getSource(l.COLD)&&E.map.removeSource(l.COLD),E.map.getSource(l.HOT)&&E.map.removeSource(l.HOT)}};return E.setup=ye,ye}var wt=[{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":"#3bb2d0","fill-outline-color":"#3bb2d0","fill-opacity":.1}},{id:"gl-draw-polygon-fill-active",type:"fill",filter:["all",["==","active","true"],["==","$type","Polygon"]],paint:{"fill-color":"#fbb03b","fill-outline-color":"#fbb03b","fill-opacity":.1}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","active","true"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-line-active",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-stroke-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-color":"#fff"}},{id:"gl-draw-polygon-and-line-vertex-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-point-point-stroke-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-opacity":1,"circle-color":"#fff"}},{id:"gl-draw-point-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#3bb2d0"}},{id:"gl-draw-point-stroke-active",type:"circle",filter:["all",["==","$type","Point"],["==","active","true"],["!=","meta","midpoint"]],paint:{"circle-radius":7,"circle-color":"#fff"}},{id:"gl-draw-point-active",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","true"]],paint:{"circle-radius":5,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-fill-static",type:"fill",filter:["all",["==","mode","static"],["==","$type","Polygon"]],paint:{"fill-color":"#404040","fill-outline-color":"#404040","fill-opacity":.1}},{id:"gl-draw-polygon-stroke-static",type:"line",filter:["all",["==","mode","static"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-line-static",type:"line",filter:["all",["==","mode","static"],["==","$type","LineString"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-point-static",type:"circle",filter:["all",["==","mode","static"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"#404040"}}];function Yt(E){return function(F){var Y=F.featureTarget;return!!Y&&!!Y.properties&&Y.properties.meta===E}}function fi(E){return!!E.originalEvent&&!!E.originalEvent.shiftKey&&E.originalEvent.button===0}function mi(E){return!!E.featureTarget&&!!E.featureTarget.properties&&E.featureTarget.properties.active===D.ACTIVE&&E.featureTarget.properties.meta===A.FEATURE}function yi(E){return!!E.featureTarget&&!!E.featureTarget.properties&&E.featureTarget.properties.active===D.INACTIVE&&E.featureTarget.properties.meta===A.FEATURE}function bi(E){return E.featureTarget===void 0}function ut(E){return!!E.featureTarget&&!!E.featureTarget.properties&&E.featureTarget.properties.meta===A.FEATURE}function Gi(E){var F=E.featureTarget;return!!F&&!!F.properties&&F.properties.meta===A.VERTEX}function Xi(E){return!!E.originalEvent&&E.originalEvent.shiftKey===!0}function rr(E){return E.keyCode===27}function Qi(E){return E.keyCode===13}var Et=Object.freeze({__proto__:null,isOfMetaType:Yt,isShiftMousedown:fi,isActiveFeature:mi,isInactiveFeature:yi,noTarget:bi,isFeature:ut,isVertex:Gi,isShiftDown:Xi,isEscapeKey:rr,isEnterKey:Qi,isTrue:function(){return!0}}),ii=ai;function ai(E,F){this.x=E,this.y=F}ai.prototype={clone:function(){return new ai(this.x,this.y)},add:function(E){return this.clone()._add(E)},sub:function(E){return this.clone()._sub(E)},multByPoint:function(E){return this.clone()._multByPoint(E)},divByPoint:function(E){return this.clone()._divByPoint(E)},mult:function(E){return this.clone()._mult(E)},div:function(E){return this.clone()._div(E)},rotate:function(E){return this.clone()._rotate(E)},rotateAround:function(E,F){return this.clone()._rotateAround(E,F)},matMult:function(E){return this.clone()._matMult(E)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(E){return this.x===E.x&&this.y===E.y},dist:function(E){return Math.sqrt(this.distSqr(E))},distSqr:function(E){var F=E.x-this.x,Y=E.y-this.y;return F*F+Y*Y},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(E){return Math.atan2(this.y-E.y,this.x-E.x)},angleWith:function(E){return this.angleWithSep(E.x,E.y)},angleWithSep:function(E,F){return Math.atan2(this.x*F-this.y*E,this.x*E+this.y*F)},_matMult:function(E){var F=E[0]*this.x+E[1]*this.y,Y=E[2]*this.x+E[3]*this.y;return this.x=F,this.y=Y,this},_add:function(E){return this.x+=E.x,this.y+=E.y,this},_sub:function(E){return this.x-=E.x,this.y-=E.y,this},_mult:function(E){return this.x*=E,this.y*=E,this},_div:function(E){return this.x/=E,this.y/=E,this},_multByPoint:function(E){return this.x*=E.x,this.y*=E.y,this},_divByPoint:function(E){return this.x/=E.x,this.y/=E.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var E=this.y;return this.y=this.x,this.x=-E,this},_rotate:function(E){var F=Math.cos(E),Y=Math.sin(E),ye=F*this.x-Y*this.y,Ee=Y*this.x+F*this.y;return this.x=ye,this.y=Ee,this},_rotateAround:function(E,F){var Y=Math.cos(E),ye=Math.sin(E),Ee=F.x+Y*(this.x-F.x)-ye*(this.y-F.y),Me=F.y+ye*(this.x-F.x)+Y*(this.y-F.y);return this.x=Ee,this.y=Me,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},ai.convert=function(E){return E instanceof ai?E:Array.isArray(E)?new ai(E[0],E[1]):E};var Hi=pe(ii);function qi(E,F){var Y=F.getBoundingClientRect();return new Hi(E.clientX-Y.left-(F.clientLeft||0),E.clientY-Y.top-(F.clientTop||0))}function Zt(E,F,Y,ye){return{type:_.FEATURE,properties:{meta:A.VERTEX,parent:E,coord_path:Y,active:ye?D.ACTIVE:D.INACTIVE},geometry:{type:_.POINT,coordinates:F}}}function Zi(E,F,Y){var ye=F.geometry.coordinates,Ee=Y.geometry.coordinates;if(ye[1]>85||ye[1]<X||Ee[1]>85||Ee[1]<X)return null;var Me={lng:(ye[0]+Ee[0])/2,lat:(ye[1]+Ee[1])/2};return{type:_.FEATURE,properties:{meta:A.MIDPOINT,parent:E,lng:Me.lng,lat:Me.lat,coord_path:Y.properties.coord_path},geometry:{type:_.POINT,coordinates:[Me.lng,Me.lat]}}}function $i(E,F,Y){F===void 0&&(F={}),Y===void 0&&(Y=null);var ye,Ee=E.geometry,Me=Ee.type,Re=Ee.coordinates,Ct=E.properties&&E.properties.id,kt=[];function Ht(Ft,vi){var ar="",xi=null;Ft.forEach(function(Tr,mt){var Qt=vi!=null?vi+"."+mt:String(mt),Ai=Zt(Ct,Tr,Qt,Wt(Qt));if(F.midpoints&&xi){var gr=Zi(Ct,xi,Ai);gr&&kt.push(gr)}xi=Ai;var dr=JSON.stringify(Tr);ar!==dr&&kt.push(Ai),mt===0&&(ar=dr)})}function Wt(Ft){return!!F.selectedPaths&&F.selectedPaths.indexOf(Ft)!==-1}return Me===_.POINT?kt.push(Zt(Ct,Re,Y,Wt(Y))):Me===_.POLYGON?Re.forEach(function(Ft,vi){Ht(Ft,Y!==null?Y+"."+vi:String(vi))}):Me===_.LINE_STRING?Ht(Re,Y):Me.indexOf(_.MULTI_PREFIX)===0&&(ye=Me.replace(_.MULTI_PREFIX,""),Re.forEach(function(Ft,vi){var ar={type:_.FEATURE,properties:E.properties,geometry:{type:ye,coordinates:Ft}};kt=kt.concat($i(ar,F,vi))})),kt}var ae={enable:function(E){setTimeout(function(){E.map&&E.map.doubleClickZoom&&E._ctx&&E._ctx.store&&E._ctx.store.getInitialConfigValue&&E._ctx.store.getInitialConfigValue("doubleClickZoom")&&E.map.doubleClickZoom.enable()},0)},disable:function(E){setTimeout(function(){E.map&&E.map.doubleClickZoom&&E.map.doubleClickZoom.disable()},0)}},H={exports:{}},q=function(E){if(!E||!E.type)return null;var F=Q[E.type];if(!F)return null;if(F==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:E}]};if(F==="feature")return{type:"FeatureCollection",features:[E]};if(F==="featurecollection")return E},Q={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"},oe=pe(q),Ae=Object.freeze({__proto__:null,default:function E(F){switch(F&&F.type||null){case"FeatureCollection":return F.features=F.features.reduce(function(Y,ye){return Y.concat(E(ye))},[]),F;case"Feature":return F.geometry?E(F.geometry).map(function(Y){var ye={type:"Feature",properties:JSON.parse(JSON.stringify(F.properties)),geometry:Y};return F.id!==void 0&&(ye.id=F.id),ye}):[F];case"MultiPoint":return F.coordinates.map(function(Y){return{type:"Point",coordinates:Y}});case"MultiPolygon":return F.coordinates.map(function(Y){return{type:"Polygon",coordinates:Y}});case"MultiLineString":return F.coordinates.map(function(Y){return{type:"LineString",coordinates:Y}});case"GeometryCollection":return F.geometries.map(E).reduce(function(Y,ye){return Y.concat(ye)},[]);case"Point":case"Polygon":case"LineString":return[F]}}}),ke=q,Le=ue(Ae),we=function(E){return function F(Y){return Array.isArray(Y)&&Y.length&&typeof Y[0]=="number"?[Y]:Y.reduce(function(ye,Ee){return Array.isArray(Ee)&&Array.isArray(Ee[0])?ye.concat(F(Ee)):(ye.push(Ee),ye)},[])}(E)};Le instanceof Function||(Le=Le.default);var Ue={exports:{}},pt=Ue.exports=function(E){return new Qe(E)};function Qe(E){this.value=E}function at(E,F,Y){var ye=[],Ee=[],Me=!0;return function Re(Ct){var kt=Y?Jt(Ct):Ct,Ht={},Wt=!0,Ft={node:kt,node_:Ct,path:[].concat(ye),parent:Ee[Ee.length-1],parents:Ee,key:ye.slice(-1)[0],isRoot:ye.length===0,level:ye.length,circular:null,update:function(xi,Tr){Ft.isRoot||(Ft.parent.node[Ft.key]=xi),Ft.node=xi,Tr&&(Wt=!1)},delete:function(xi){delete Ft.parent.node[Ft.key],xi&&(Wt=!1)},remove:function(xi){pi(Ft.parent.node)?Ft.parent.node.splice(Ft.key,1):delete Ft.parent.node[Ft.key],xi&&(Wt=!1)},keys:null,before:function(xi){Ht.before=xi},after:function(xi){Ht.after=xi},pre:function(xi){Ht.pre=xi},post:function(xi){Ht.post=xi},stop:function(){Me=!1},block:function(){Wt=!1}};if(!Me)return Ft;function vi(){if(typeof Ft.node=="object"&&Ft.node!==null){Ft.keys&&Ft.node_===Ft.node||(Ft.keys=ri(Ft.node)),Ft.isLeaf=Ft.keys.length==0;for(var xi=0;xi<Ee.length;xi++)if(Ee[xi].node_===Ct){Ft.circular=Ee[xi];break}}else Ft.isLeaf=!0,Ft.keys=null;Ft.notLeaf=!Ft.isLeaf,Ft.notRoot=!Ft.isRoot}vi();var ar=F.call(Ft,Ft.node);return ar!==void 0&&Ft.update&&Ft.update(ar),Ht.before&&Ht.before.call(Ft,Ft.node),Wt&&(typeof Ft.node!="object"||Ft.node===null||Ft.circular||(Ee.push(Ft),vi(),wi(Ft.keys,function(xi,Tr){ye.push(xi),Ht.pre&&Ht.pre.call(Ft,Ft.node[xi],xi);var mt=Re(Ft.node[xi]);Y&&Ri.call(Ft.node,xi)&&(Ft.node[xi]=mt.node),mt.isLast=Tr==Ft.keys.length-1,mt.isFirst=Tr==0,Ht.post&&Ht.post.call(Ft,mt),ye.pop()}),Ee.pop()),Ht.after&&Ht.after.call(Ft,Ft.node)),Ft}(E).node}function Jt(E){if(typeof E=="object"&&E!==null){var F;if(pi(E))F=[];else if(ui(E)==="[object Date]")F=new Date(E.getTime?E.getTime():E);else if(function(Ee){return ui(Ee)==="[object RegExp]"}(E))F=new RegExp(E);else if(function(Ee){return ui(Ee)==="[object Error]"}(E))F={message:E.message};else if(function(Ee){return ui(Ee)==="[object Boolean]"}(E))F=new Boolean(E);else if(function(Ee){return ui(Ee)==="[object Number]"}(E))F=new Number(E);else if(function(Ee){return ui(Ee)==="[object String]"}(E))F=new String(E);else if(Object.create&&Object.getPrototypeOf)F=Object.create(Object.getPrototypeOf(E));else if(E.constructor===Object)F={};else{var Y=E.constructor&&E.constructor.prototype||E.__proto__||{},ye=function(){};ye.prototype=Y,F=new ye}return wi(ri(E),function(Ee){F[Ee]=E[Ee]}),F}return E}Qe.prototype.get=function(E){for(var F=this.value,Y=0;Y<E.length;Y++){var ye=E[Y];if(!F||!Ri.call(F,ye)){F=void 0;break}F=F[ye]}return F},Qe.prototype.has=function(E){for(var F=this.value,Y=0;Y<E.length;Y++){var ye=E[Y];if(!F||!Ri.call(F,ye))return!1;F=F[ye]}return!0},Qe.prototype.set=function(E,F){for(var Y=this.value,ye=0;ye<E.length-1;ye++){var Ee=E[ye];Ri.call(Y,Ee)||(Y[Ee]={}),Y=Y[Ee]}return Y[E[ye]]=F,F},Qe.prototype.map=function(E){return at(this.value,E,!0)},Qe.prototype.forEach=function(E){return this.value=at(this.value,E,!1),this.value},Qe.prototype.reduce=function(E,F){var Y=arguments.length===1,ye=Y?this.value:F;return this.forEach(function(Ee){this.isRoot&&Y||(ye=E.call(this,ye,Ee))}),ye},Qe.prototype.paths=function(){var E=[];return this.forEach(function(F){E.push(this.path)}),E},Qe.prototype.nodes=function(){var E=[];return this.forEach(function(F){E.push(this.node)}),E},Qe.prototype.clone=function(){var E=[],F=[];return function Y(ye){for(var Ee=0;Ee<E.length;Ee++)if(E[Ee]===ye)return F[Ee];if(typeof ye=="object"&&ye!==null){var Me=Jt(ye);return E.push(ye),F.push(Me),wi(ri(ye),function(Re){Me[Re]=Y(ye[Re])}),E.pop(),F.pop(),Me}return ye}(this.value)};var ri=Object.keys||function(E){var F=[];for(var Y in E)F.push(Y);return F};function ui(E){return Object.prototype.toString.call(E)}var pi=Array.isArray||function(E){return Object.prototype.toString.call(E)==="[object Array]"},wi=function(E,F){if(E.forEach)return E.forEach(F);for(var Y=0;Y<E.length;Y++)F(E[Y],Y,E)};wi(ri(Qe.prototype),function(E){pt[E]=function(F){var Y=[].slice.call(arguments,1),ye=new Qe(F);return ye[E].apply(ye,Y)}});var Ri=Object.hasOwnProperty||function(E,F){return F in E},nr=Ue.exports,Pr=li;function li(E){if(!(this instanceof li))return new li(E);this._bbox=E||[1/0,1/0,-1/0,-1/0],this._valid=!!E}li.prototype.include=function(E){return this._valid=!0,this._bbox[0]=Math.min(this._bbox[0],E[0]),this._bbox[1]=Math.min(this._bbox[1],E[1]),this._bbox[2]=Math.max(this._bbox[2],E[0]),this._bbox[3]=Math.max(this._bbox[3],E[1]),this},li.prototype.equals=function(E){var F;return F=E instanceof li?E.bbox():E,this._bbox[0]==F[0]&&this._bbox[1]==F[1]&&this._bbox[2]==F[2]&&this._bbox[3]==F[3]},li.prototype.center=function(E){return this._valid?[(this._bbox[0]+this._bbox[2])/2,(this._bbox[1]+this._bbox[3])/2]:null},li.prototype.union=function(E){var F;return this._valid=!0,F=E instanceof li?E.bbox():E,this._bbox[0]=Math.min(this._bbox[0],F[0]),this._bbox[1]=Math.min(this._bbox[1],F[1]),this._bbox[2]=Math.max(this._bbox[2],F[2]),this._bbox[3]=Math.max(this._bbox[3],F[3]),this},li.prototype.bbox=function(){return this._valid?this._bbox:null},li.prototype.contains=function(E){if(!E)return this._fastContains();if(!this._valid)return null;var F=E[0],Y=E[1];return this._bbox[0]<=F&&this._bbox[1]<=Y&&this._bbox[2]>=F&&this._bbox[3]>=Y},li.prototype.intersect=function(E){return this._valid?(F=E instanceof li?E.bbox():E,!(this._bbox[0]>F[2]||this._bbox[2]<F[0]||this._bbox[3]<F[1]||this._bbox[1]>F[3])):null;var F},li.prototype._fastContains=function(){if(!this._valid)return new Function("return null;");var E="return "+this._bbox[0]+"<= ll[0] &&"+this._bbox[1]+"<= ll[1] &&"+this._bbox[2]+">= ll[0] &&"+this._bbox[3]+">= ll[1]";return new Function("ll",E)},li.prototype.polygon=function(){return this._valid?{type:"Polygon",coordinates:[[[this._bbox[0],this._bbox[1]],[this._bbox[2],this._bbox[1]],[this._bbox[2],this._bbox[3]],[this._bbox[0],this._bbox[3]],[this._bbox[0],this._bbox[1]]]]}:null};var ur=function(E){if(!E)return[];var F=Le(ke(E)),Y=[];return F.features.forEach(function(ye){ye.geometry&&(Y=Y.concat(we(ye.geometry.coordinates)))}),Y},kr=nr,rn=Pr,nn={features:["FeatureCollection"],coordinates:["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],geometry:["Feature"],geometries:["GeometryCollection"]},zr=Object.keys(nn);function Tn(E){for(var F=rn(),Y=ur(E),ye=0;ye<Y.length;ye++)F.include(Y[ye]);return F}H.exports=function(E){return Tn(E).bbox()},H.exports.polygon=function(E){return Tn(E).polygon()},H.exports.bboxify=function(E){return kr(E).map(function(F){F&&zr.some(function(Y){return!!F[Y]&&nn[Y].indexOf(F.type)!==-1})&&(F.bbox=Tn(F).bbox(),this.update(F))})};var Ga=pe(H.exports),Ao=-90;function Vi(E,F){var Y=Ao,ye=90,Ee=Ao,Me=90,Re=270,Ct=-270;E.forEach(function(Ht){var Wt=Ga(Ht),Ft=Wt[1],vi=Wt[3],ar=Wt[0],xi=Wt[2];Ft>Y&&(Y=Ft),vi<ye&&(ye=vi),vi>Ee&&(Ee=vi),Ft<Me&&(Me=Ft),ar<Re&&(Re=ar),xi>Ct&&(Ct=xi)});var kt=F;return Y+kt.lat>85&&(kt.lat=85-Y),Ee+kt.lat>90&&(kt.lat=90-Ee),ye+kt.lat<-85&&(kt.lat=-85-ye),Me+kt.lat<Ao&&(kt.lat=Ao-Me),Re+kt.lng<=-270&&(kt.lng+=360*Math.ceil(Math.abs(kt.lng)/360)),Ct+kt.lng>=270&&(kt.lng-=360*Math.ceil(Math.abs(kt.lng)/360)),kt}function co(E,F){var Y=Vi(E.map(function(ye){return ye.toGeoJSON()}),F);E.forEach(function(ye){var Ee,Me=ye.getCoordinates(),Re=function(kt){var Ht={lng:kt[0]+Y.lng,lat:kt[1]+Y.lat};return[Ht.lng,Ht.lat]},Ct=function(kt){return kt.map(function(Ht){return Re(Ht)})};ye.type===_.POINT?Ee=Re(Me):ye.type===_.LINE_STRING||ye.type===_.MULTI_POINT?Ee=Me.map(Re):ye.type===_.POLYGON||ye.type===_.MULTI_LINE_STRING?Ee=Me.map(Ct):ye.type===_.MULTI_POLYGON&&(Ee=Me.map(function(kt){return kt.map(function(Ht){return Ct(Ht)})})),ye.incomingCoords(Ee)})}var wr={onSetup:function(E){var F=this,Y={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initiallySelectedFeatureIds:E.featureIds||[]};return this.setSelected(Y.initiallySelectedFeatureIds.filter(function(ye){return F.getFeature(ye)!==void 0})),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),Y},fireUpdate:function(){this.map.fire(x.UPDATE,{action:T.MOVE,features:this.getSelected().map(function(E){return E.toGeoJSON()})})},fireActionable:function(){var E=this,F=this.getSelected(),Y=F.filter(function(Ct){return E.isInstanceOf("MultiFeature",Ct)}),ye=!1;if(F.length>1){ye=!0;var Ee=F[0].type.replace("Multi","");F.forEach(function(Ct){Ct.type.replace("Multi","")!==Ee&&(ye=!1)})}var Me=Y.length>0,Re=F.length>0;this.setActionableState({combineFeatures:ye,uncombineFeatures:Me,trash:Re})},getUniqueIds:function(E){return E.length?E.map(function(F){return F.properties.id}).filter(function(F){return F!==void 0}).reduce(function(F,Y){return F.add(Y),F},new Je).values():[]},stopExtendedInteractions:function(E){E.boxSelectElement&&(E.boxSelectElement.parentNode&&E.boxSelectElement.parentNode.removeChild(E.boxSelectElement),E.boxSelectElement=null),this.map.dragPan.enable(),E.boxSelecting=!1,E.canBoxSelect=!1,E.dragMoving=!1,E.canDragMove=!1},onStop:function(){ae.enable(this)},onMouseMove:function(E,F){return ut(F)&&E.dragMoving&&this.fireUpdate(),this.stopExtendedInteractions(E),!0},onMouseOut:function(E){return!E.dragMoving||this.fireUpdate()}};wr.onTap=wr.onClick=function(E,F){return bi(F)?this.clickAnywhere(E,F):Yt(A.VERTEX)(F)?this.clickOnVertex(E,F):ut(F)?this.clickOnFeature(E,F):void 0},wr.clickAnywhere=function(E){var F=this,Y=this.getSelectedIds();Y.length&&(this.clearSelectedFeatures(),Y.forEach(function(ye){return F.doRender(ye)})),ae.enable(this),this.stopExtendedInteractions(E)},wr.clickOnVertex=function(E,F){this.changeMode(u.DIRECT_SELECT,{featureId:F.featureTarget.properties.parent,coordPath:F.featureTarget.properties.coord_path,startPos:F.lngLat}),this.updateUIClasses({mouse:h.MOVE})},wr.startOnActiveFeature=function(E,F){this.stopExtendedInteractions(E),this.map.dragPan.disable(),this.doRender(F.featureTarget.properties.id),E.canDragMove=!0,E.dragMoveLocation=F.lngLat},wr.clickOnFeature=function(E,F){var Y=this;ae.disable(this),this.stopExtendedInteractions(E);var ye=Xi(F),Ee=this.getSelectedIds(),Me=F.featureTarget.properties.id,Re=this.isSelected(Me);if(!ye&&Re&&this.getFeature(Me).type!==_.POINT)return this.changeMode(u.DIRECT_SELECT,{featureId:Me});Re&&ye?(this.deselect(Me),this.updateUIClasses({mouse:h.POINTER}),Ee.length===1&&ae.enable(this)):!Re&&ye?(this.select(Me),this.updateUIClasses({mouse:h.MOVE})):Re||ye||(Ee.forEach(function(Ct){return Y.doRender(Ct)}),this.setSelected(Me),this.updateUIClasses({mouse:h.MOVE})),this.doRender(Me)},wr.onMouseDown=function(E,F){return mi(F)?this.startOnActiveFeature(E,F):this.drawConfig.boxSelect&&fi(F)?this.startBoxSelect(E,F):void 0},wr.startBoxSelect=function(E,F){this.stopExtendedInteractions(E),this.map.dragPan.disable(),E.boxSelectStartLocation=qi(F.originalEvent,this.map.getContainer()),E.canBoxSelect=!0},wr.onTouchStart=function(E,F){if(mi(F))return this.startOnActiveFeature(E,F)},wr.onDrag=function(E,F){return E.canDragMove?this.dragMove(E,F):this.drawConfig.boxSelect&&E.canBoxSelect?this.whileBoxSelect(E,F):void 0},wr.whileBoxSelect=function(E,F){E.boxSelecting=!0,this.updateUIClasses({mouse:h.ADD}),E.boxSelectElement||(E.boxSelectElement=document.createElement("div"),E.boxSelectElement.classList.add(a.BOX_SELECT),this.map.getContainer().appendChild(E.boxSelectElement));var Y=qi(F.originalEvent,this.map.getContainer()),ye=Math.min(E.boxSelectStartLocation.x,Y.x),Ee=Math.max(E.boxSelectStartLocation.x,Y.x),Me=Math.min(E.boxSelectStartLocation.y,Y.y),Re=Math.max(E.boxSelectStartLocation.y,Y.y),Ct="translate("+ye+"px, "+Me+"px)";E.boxSelectElement.style.transform=Ct,E.boxSelectElement.style.WebkitTransform=Ct,E.boxSelectElement.style.width=Ee-ye+"px",E.boxSelectElement.style.height=Re-Me+"px"},wr.dragMove=function(E,F){E.dragMoving=!0,F.originalEvent.stopPropagation();var Y={lng:F.lngLat.lng-E.dragMoveLocation.lng,lat:F.lngLat.lat-E.dragMoveLocation.lat};co(this.getSelected(),Y),E.dragMoveLocation=F.lngLat},wr.onTouchEnd=wr.onMouseUp=function(E,F){var Y=this;if(E.dragMoving)this.fireUpdate();else if(E.boxSelecting){var ye=[E.boxSelectStartLocation,qi(F.originalEvent,this.map.getContainer())],Ee=this.featuresAt(null,ye,"click"),Me=this.getUniqueIds(Ee).filter(function(Re){return!Y.isSelected(Re)});Me.length&&(this.select(Me),Me.forEach(function(Re){return Y.doRender(Re)}),this.updateUIClasses({mouse:h.MOVE}))}this.stopExtendedInteractions(E)},wr.toDisplayFeatures=function(E,F,Y){F.properties.active=this.isSelected(F.properties.id)?D.ACTIVE:D.INACTIVE,Y(F),this.fireActionable(),F.properties.active===D.ACTIVE&&F.geometry.type!==_.POINT&&$i(F).forEach(Y)},wr.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()},wr.onCombineFeatures=function(){var E=this.getSelected();if(!(E.length===0||E.length<2)){for(var F=[],Y=[],ye=E[0].type.replace("Multi",""),Ee=0;Ee<E.length;Ee++){var Me=E[Ee];if(Me.type.replace("Multi","")!==ye)return;Me.type.includes("Multi")?Me.getCoordinates().forEach(function(Ct){F.push(Ct)}):F.push(Me.getCoordinates()),Y.push(Me.toGeoJSON())}if(Y.length>1){var Re=this.newFeature({type:_.FEATURE,properties:Y[0].properties,geometry:{type:"Multi"+ye,coordinates:F}});this.addFeature(Re),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([Re.id]),this.map.fire(x.COMBINE_FEATURES,{createdFeatures:[Re.toGeoJSON()],deletedFeatures:Y})}this.fireActionable()}},wr.onUncombineFeatures=function(){var E=this,F=this.getSelected();if(F.length!==0){for(var Y=[],ye=[],Ee=function(Re){var Ct=F[Re];E.isInstanceOf("MultiFeature",Ct)&&(Ct.getFeatures().forEach(function(kt){E.addFeature(kt),kt.properties=Ct.properties,Y.push(kt.toGeoJSON()),E.select([kt.id])}),E.deleteFeature(Ct.id,{silent:!0}),ye.push(Ct.toGeoJSON()))},Me=0;Me<F.length;Me++)Ee(Me);Y.length>1&&this.map.fire(x.UNCOMBINE_FEATURES,{createdFeatures:Y,deletedFeatures:ye}),this.fireActionable()}};var dn=Yt(A.VERTEX),sn=Yt(A.MIDPOINT),En={fireUpdate:function(){this.map.fire(x.UPDATE,{action:T.CHANGE_COORDINATES,features:this.getSelected().map(function(E){return E.toGeoJSON()})})},fireActionable:function(E){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:E.selectedCoordPaths.length>0})},startDragging:function(E,F){this.map.dragPan.disable(),E.canDragMove=!0,E.dragMoveLocation=F.lngLat},stopDragging:function(E){this.map.dragPan.enable(),E.dragMoving=!1,E.canDragMove=!1,E.dragMoveLocation=null},onVertex:function(E,F){this.startDragging(E,F);var Y=F.featureTarget.properties,ye=E.selectedCoordPaths.indexOf(Y.coord_path);Xi(F)||ye!==-1?Xi(F)&&ye===-1&&E.selectedCoordPaths.push(Y.coord_path):E.selectedCoordPaths=[Y.coord_path];var Ee=this.pathsToCoordinates(E.featureId,E.selectedCoordPaths);this.setSelectedCoordinates(Ee)},onMidpoint:function(E,F){this.startDragging(E,F);var Y=F.featureTarget.properties;E.feature.addCoordinate(Y.coord_path,Y.lng,Y.lat),this.fireUpdate(),E.selectedCoordPaths=[Y.coord_path]},pathsToCoordinates:function(E,F){return F.map(function(Y){return{feature_id:E,coord_path:Y}})},onFeature:function(E,F){E.selectedCoordPaths.length===0?this.startDragging(E,F):this.stopDragging(E)},dragFeature:function(E,F,Y){co(this.getSelected(),Y),E.dragMoveLocation=F.lngLat},dragVertex:function(E,F,Y){for(var ye=E.selectedCoordPaths.map(function(Ct){return E.feature.getCoordinate(Ct)}),Ee=Vi(ye.map(function(Ct){return{type:_.FEATURE,properties:{},geometry:{type:_.POINT,coordinates:Ct}}}),Y),Me=0;Me<ye.length;Me++){var Re=ye[Me];E.feature.updateCoordinate(E.selectedCoordPaths[Me],Re[0]+Ee.lng,Re[1]+Ee.lat)}},clickNoTarget:function(){this.changeMode(u.SIMPLE_SELECT)},clickInactive:function(){this.changeMode(u.SIMPLE_SELECT)},clickActiveFeature:function(E){E.selectedCoordPaths=[],this.clearSelectedCoordinates(),E.feature.changed()},onSetup:function(E){var F=E.featureId,Y=this.getFeature(F);if(!Y)throw new Error("You must provide a featureId to enter direct_select mode");if(Y.type===_.POINT)throw new TypeError("direct_select mode doesn't handle point features");var ye={featureId:F,feature:Y,dragMoveLocation:E.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:E.coordPath?[E.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(F,ye.selectedCoordPaths)),this.setSelected(F),ae.disable(this),this.setActionableState({trash:!0}),ye},onStop:function(){ae.enable(this),this.clearSelectedCoordinates()},toDisplayFeatures:function(E,F,Y){E.featureId===F.properties.id?(F.properties.active=D.ACTIVE,Y(F),$i(F,{map:this.map,midpoints:!0,selectedPaths:E.selectedCoordPaths}).forEach(Y)):(F.properties.active=D.INACTIVE,Y(F)),this.fireActionable(E)},onTrash:function(E){E.selectedCoordPaths.sort(function(F,Y){return Y.localeCompare(F,"en",{numeric:!0})}).forEach(function(F){return E.feature.removeCoordinate(F)}),this.fireUpdate(),E.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(E),E.feature.isValid()===!1&&(this.deleteFeature([E.featureId]),this.changeMode(u.SIMPLE_SELECT,{}))},onMouseMove:function(E,F){var Y=mi(F),ye=dn(F),Ee=sn(F),Me=E.selectedCoordPaths.length===0;return Y&&Me||ye&&!Me?this.updateUIClasses({mouse:h.MOVE}):this.updateUIClasses({mouse:h.NONE}),(ye||Y||Ee)&&E.dragMoving&&this.fireUpdate(),this.stopDragging(E),!0},onMouseOut:function(E){return E.dragMoving&&this.fireUpdate(),!0}};En.onTouchStart=En.onMouseDown=function(E,F){return dn(F)?this.onVertex(E,F):mi(F)?this.onFeature(E,F):sn(F)?this.onMidpoint(E,F):void 0},En.onDrag=function(E,F){if(E.canDragMove===!0){E.dragMoving=!0,F.originalEvent.stopPropagation();var Y={lng:F.lngLat.lng-E.dragMoveLocation.lng,lat:F.lngLat.lat-E.dragMoveLocation.lat};E.selectedCoordPaths.length>0?this.dragVertex(E,F,Y):this.dragFeature(E,F,Y),E.dragMoveLocation=F.lngLat}},En.onClick=function(E,F){return bi(F)?this.clickNoTarget(E,F):mi(F)?this.clickActiveFeature(E,F):yi(F)?this.clickInactive(E,F):void this.stopDragging(E)},En.onTap=function(E,F){return bi(F)?this.clickNoTarget(E,F):mi(F)?this.clickActiveFeature(E,F):yi(F)?this.clickInactive(E,F):void 0},En.onTouchEnd=En.onMouseUp=function(E){E.dragMoving&&this.fireUpdate(),this.stopDragging(E)};var Cr={};function on(E,F){return!!E.lngLat&&E.lngLat.lng===F[0]&&E.lngLat.lat===F[1]}Cr.onSetup=function(){var E=this.newFeature({type:_.FEATURE,properties:{},geometry:{type:_.POINT,coordinates:[]}});return this.addFeature(E),this.clearSelectedFeatures(),this.updateUIClasses({mouse:h.ADD}),this.activateUIButton(m.POINT),this.setActionableState({trash:!0}),{point:E}},Cr.stopDrawingAndRemove=function(E){this.deleteFeature([E.point.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT)},Cr.onTap=Cr.onClick=function(E,F){this.updateUIClasses({mouse:h.MOVE}),E.point.updateCoordinate("",F.lngLat.lng,F.lngLat.lat),this.map.fire(x.CREATE,{features:[E.point.toGeoJSON()]}),this.changeMode(u.SIMPLE_SELECT,{featureIds:[E.point.id]})},Cr.onStop=function(E){this.activateUIButton(),E.point.getCoordinate().length||this.deleteFeature([E.point.id],{silent:!0})},Cr.toDisplayFeatures=function(E,F,Y){var ye=F.properties.id===E.point.id;if(F.properties.active=ye?D.ACTIVE:D.INACTIVE,!ye)return Y(F)},Cr.onTrash=Cr.stopDrawingAndRemove,Cr.onKeyUp=function(E,F){if(rr(F)||Qi(F))return this.stopDrawingAndRemove(E,F)};var In={onSetup:function(){var E=this.newFeature({type:_.FEATURE,properties:{},geometry:{type:_.POLYGON,coordinates:[[]]}});return this.addFeature(E),this.clearSelectedFeatures(),ae.disable(this),this.updateUIClasses({mouse:h.ADD}),this.activateUIButton(m.POLYGON),this.setActionableState({trash:!0}),{polygon:E,currentVertexPosition:0}},clickAnywhere:function(E,F){if(E.currentVertexPosition>0&&on(F,E.polygon.coordinates[0][E.currentVertexPosition-1]))return this.changeMode(u.SIMPLE_SELECT,{featureIds:[E.polygon.id]});this.updateUIClasses({mouse:h.ADD}),E.polygon.updateCoordinate("0."+E.currentVertexPosition,F.lngLat.lng,F.lngLat.lat),E.currentVertexPosition++,E.polygon.updateCoordinate("0."+E.currentVertexPosition,F.lngLat.lng,F.lngLat.lat)},clickOnVertex:function(E){return this.changeMode(u.SIMPLE_SELECT,{featureIds:[E.polygon.id]})},onMouseMove:function(E,F){E.polygon.updateCoordinate("0."+E.currentVertexPosition,F.lngLat.lng,F.lngLat.lat),Gi(F)&&this.updateUIClasses({mouse:h.POINTER})}};In.onTap=In.onClick=function(E,F){return Gi(F)?this.clickOnVertex(E,F):this.clickAnywhere(E,F)},In.onKeyUp=function(E,F){rr(F)?(this.deleteFeature([E.polygon.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT)):Qi(F)&&this.changeMode(u.SIMPLE_SELECT,{featureIds:[E.polygon.id]})},In.onStop=function(E){this.updateUIClasses({mouse:h.NONE}),ae.enable(this),this.activateUIButton(),this.getFeature(E.polygon.id)!==void 0&&(E.polygon.removeCoordinate("0."+E.currentVertexPosition),E.polygon.isValid()?this.map.fire(x.CREATE,{features:[E.polygon.toGeoJSON()]}):(this.deleteFeature([E.polygon.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT,{},{silent:!0})))},In.toDisplayFeatures=function(E,F,Y){var ye=F.properties.id===E.polygon.id;if(F.properties.active=ye?D.ACTIVE:D.INACTIVE,!ye)return Y(F);if(F.geometry.coordinates.length!==0){var Ee=F.geometry.coordinates[0].length;if(!(Ee<3)){if(F.properties.meta=A.FEATURE,Y(Zt(E.polygon.id,F.geometry.coordinates[0][0],"0.0",!1)),Ee>3){var Me=F.geometry.coordinates[0].length-3;Y(Zt(E.polygon.id,F.geometry.coordinates[0][Me],"0."+Me,!1))}if(Ee<=4){var Re=[[F.geometry.coordinates[0][0][0],F.geometry.coordinates[0][0][1]],[F.geometry.coordinates[0][1][0],F.geometry.coordinates[0][1][1]]];if(Y({type:_.FEATURE,properties:F.properties,geometry:{coordinates:Re,type:_.LINE_STRING}}),Ee===3)return}return Y(F)}}},In.onTrash=function(E){this.deleteFeature([E.polygon.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT)};var $n={onSetup:function(E){var F,Y,ye=(E=E||{}).featureId,Ee="forward";if(ye){if(!(F=this.getFeature(ye)))throw new Error("Could not find a feature with the provided featureId");var Me=E.from;if(Me&&Me.type==="Feature"&&Me.geometry&&Me.geometry.type==="Point"&&(Me=Me.geometry),Me&&Me.type==="Point"&&Me.coordinates&&Me.coordinates.length===2&&(Me=Me.coordinates),!Me||!Array.isArray(Me))throw new Error("Please use the `from` property to indicate which point to continue the line from");var Re=F.coordinates.length-1;if(F.coordinates[Re][0]===Me[0]&&F.coordinates[Re][1]===Me[1])Y=Re+1,F.addCoordinate.apply(F,[Y].concat(F.coordinates[Re]));else{if(F.coordinates[0][0]!==Me[0]||F.coordinates[0][1]!==Me[1])throw new Error("`from` should match the point at either the start or the end of the provided LineString");Ee="backwards",Y=0,F.addCoordinate.apply(F,[Y].concat(F.coordinates[0]))}}else F=this.newFeature({type:_.FEATURE,properties:{},geometry:{type:_.LINE_STRING,coordinates:[]}}),Y=0,this.addFeature(F);return this.clearSelectedFeatures(),ae.disable(this),this.updateUIClasses({mouse:h.ADD}),this.activateUIButton(m.LINE),this.setActionableState({trash:!0}),{line:F,currentVertexPosition:Y,direction:Ee}},clickAnywhere:function(E,F){if(E.currentVertexPosition>0&&on(F,E.line.coordinates[E.currentVertexPosition-1])||E.direction==="backwards"&&on(F,E.line.coordinates[E.currentVertexPosition+1]))return this.changeMode(u.SIMPLE_SELECT,{featureIds:[E.line.id]});this.updateUIClasses({mouse:h.ADD}),E.line.updateCoordinate(E.currentVertexPosition,F.lngLat.lng,F.lngLat.lat),E.direction==="forward"?(E.currentVertexPosition++,E.line.updateCoordinate(E.currentVertexPosition,F.lngLat.lng,F.lngLat.lat)):E.line.addCoordinate(0,F.lngLat.lng,F.lngLat.lat)},clickOnVertex:function(E){return this.changeMode(u.SIMPLE_SELECT,{featureIds:[E.line.id]})},onMouseMove:function(E,F){E.line.updateCoordinate(E.currentVertexPosition,F.lngLat.lng,F.lngLat.lat),Gi(F)&&this.updateUIClasses({mouse:h.POINTER})}};$n.onTap=$n.onClick=function(E,F){if(Gi(F))return this.clickOnVertex(E,F);this.clickAnywhere(E,F)},$n.onKeyUp=function(E,F){Qi(F)?this.changeMode(u.SIMPLE_SELECT,{featureIds:[E.line.id]}):rr(F)&&(this.deleteFeature([E.line.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT))},$n.onStop=function(E){ae.enable(this),this.activateUIButton(),this.getFeature(E.line.id)!==void 0&&(E.line.removeCoordinate(""+E.currentVertexPosition),E.line.isValid()?this.map.fire(x.CREATE,{features:[E.line.toGeoJSON()]}):(this.deleteFeature([E.line.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT,{},{silent:!0})))},$n.onTrash=function(E){this.deleteFeature([E.line.id],{silent:!0}),this.changeMode(u.SIMPLE_SELECT)},$n.toDisplayFeatures=function(E,F,Y){var ye=F.properties.id===E.line.id;if(F.properties.active=ye?D.ACTIVE:D.INACTIVE,!ye)return Y(F);F.geometry.coordinates.length<2||(F.properties.meta=A.FEATURE,Y(Zt(E.line.id,F.geometry.coordinates[E.direction==="forward"?F.geometry.coordinates.length-2:1],""+(E.direction==="forward"?F.geometry.coordinates.length-2:1),!1)),Y(F))};var Sr={simple_select:wr,direct_select:En,draw_point:Cr,draw_polygon:In,draw_line_string:$n},ho={defaultMode:u.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:wt,modes:Sr,controls:{},userProperties:!1},vs={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},or={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function uo(E,F){return E.map(function(Y){return Y.source?Y:Tt(Y,{id:Y.id+"."+F,source:F==="hot"?l.HOT:l.COLD})})}var an={exports:{}};(function(E,F){var Y="__lodash_hash_undefined__",ye=9007199254740991,Ee="[object Arguments]",Me="[object Array]",Re="[object Boolean]",Ct="[object Date]",kt="[object Error]",Ht="[object Function]",Wt="[object Map]",Ft="[object Number]",vi="[object Object]",ar="[object Promise]",xi="[object RegExp]",Tr="[object Set]",mt="[object String]",Qt="[object Symbol]",Ai="[object WeakMap]",gr="[object ArrayBuffer]",dr="[object DataView]",Ms=/^\[object .+?Constructor\]$/,mo=/^(?:0|[1-9]\d*)$/,Yi={};Yi["[object Float32Array]"]=Yi["[object Float64Array]"]=Yi["[object Int8Array]"]=Yi["[object Int16Array]"]=Yi["[object Int32Array]"]=Yi["[object Uint8Array]"]=Yi["[object Uint8ClampedArray]"]=Yi["[object Uint16Array]"]=Yi["[object Uint32Array]"]=!0,Yi[Ee]=Yi[Me]=Yi[gr]=Yi[Re]=Yi[dr]=Yi[Ct]=Yi[kt]=Yi[Ht]=Yi[Wt]=Yi[Ft]=Yi[vi]=Yi[xi]=Yi[Tr]=Yi[mt]=Yi[Ai]=!1;var Xs=typeof yl=="object"&&yl&&yl.Object===Object&&yl,Cl=typeof self=="object"&&self&&self.Object===Object&&self,os=Xs||Cl||Function("return this")(),ca=F&&!F.nodeType&&F,Ha=ca&&E&&!E.nodeType&&E,xs=Ha&&Ha.exports===ca,qs=xs&&Xs.process,Qr=function(){try{return qs&&qs.binding&&qs.binding("util")}catch{}}(),Vr=Qr&&Qr.isTypedArray;function ji(Be,tt){for(var Rt=-1,oi=Be==null?0:Be.length;++Rt<oi;)if(tt(Be[Rt],Rt,Be))return!0;return!1}function ko(Be){var tt=-1,Rt=Array(Be.size);return Be.forEach(function(oi,tr){Rt[++tt]=[tr,oi]}),Rt}function Oo(Be){var tt=-1,Rt=Array(Be.size);return Be.forEach(function(oi){Rt[++tt]=oi}),Rt}var Do,Lo,go,ha=Array.prototype,ua=Function.prototype,ks=Object.prototype,zo=os["__core-js_shared__"],da=ua.toString,ln=ks.hasOwnProperty,Wa=(Do=/[^.]+$/.exec(zo&&zo.keys&&zo.keys.IE_PROTO||""))?"Symbol(src)_1."+Do:"",Xa=ks.toString,Sl=RegExp("^"+da.call(ln).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),qa=xs?os.Buffer:void 0,Fo=os.Symbol,$a=os.Uint8Array,Ro=ks.propertyIsEnumerable,Bo=ha.splice,as=Fo?Fo.toStringTag:void 0,jo=Object.getOwnPropertySymbols,$s=qa?qa.isBuffer:void 0,Ya=(Lo=Object.keys,go=Object,function(Be){return Lo(go(Be))}),No=zs(os,"DataView"),Os=zs(os,"Map"),ls=zs(os,"Promise"),Vo=zs(os,"Set"),bs=zs(os,"WeakMap"),Yn=zs(Object,"create"),Za=Cs(No),fa=Cs(Os),zi=Cs(ls),Uo=Cs(Vo),Tl=Cs(bs),pa=Fo?Fo.prototype:void 0,Ds=pa?pa.valueOf:void 0;function er(Be){var tt=-1,Rt=Be==null?0:Be.length;for(this.clear();++tt<Rt;){var oi=Be[tt];this.set(oi[0],oi[1])}}function cs(Be){var tt=-1,Rt=Be==null?0:Be.length;for(this.clear();++tt<Rt;){var oi=Be[tt];this.set(oi[0],oi[1])}}function Ti(Be){var tt=-1,Rt=Be==null?0:Be.length;for(this.clear();++tt<Rt;){var oi=Be[tt];this.set(oi[0],oi[1])}}function Ys(Be){var tt=-1,Rt=Be==null?0:Be.length;for(this.__data__=new Ti;++tt<Rt;)this.add(Be[tt])}function Ni(Be){var tt=this.__data__=new cs(Be);this.size=tt.size}function Ki(Be,tt){var Rt=Zs(Be),oi=!Rt&&qo(Be),tr=!Rt&&!oi&&va(Be),Oi=!Rt&&!oi&&!tr&&$o(Be),cr=Rt||oi||tr||Oi,_r=cr?function(Ar,jn){for(var Kn=-1,en=Array(Ar);++Kn<Ar;)en[Kn]=jn(Kn);return en}(Be.length,String):[],cn=_r.length;for(var sr in Be)!tt&&!ln.call(Be,sr)||cr&&(sr=="length"||tr&&(sr=="offset"||sr=="parent")||Oi&&(sr=="buffer"||sr=="byteLength"||sr=="byteOffset")||_a(sr,cn))||_r.push(sr);return _r}function Zn(Be,tt){for(var Rt=Be.length;Rt--;)if(ya(Be[Rt][0],tt))return Rt;return-1}function ws(Be){return Be==null?Be===void 0?"[object Undefined]":"[object Null]":as&&as in Object(Be)?function(tt){var Rt=ln.call(tt,as),oi=tt[as];try{tt[as]=void 0;var tr=!0}catch{}var Oi=Xa.call(tt);return tr&&(Rt?tt[as]=oi:delete tt[as]),Oi}(Be):function(tt){return Xa.call(tt)}(Be)}function Go(Be){return Or(Be)&&ws(Be)==Ee}function ma(Be,tt,Rt,oi,tr){return Be===tt||(Be==null||tt==null||!Or(Be)&&!Or(tt)?Be!=Be&&tt!=tt:function(Oi,cr,_r,cn,sr,Ar){var jn=Zs(Oi),Kn=Zs(cr),en=jn?Me:Bn(Oi),_n=Kn?Me:Bn(cr),Jn=(en=en==Ee?vi:en)==vi,Ur=(_n=_n==Ee?vi:_n)==vi,hn=en==_n;if(hn&&va(Oi)){if(!va(cr))return!1;jn=!0,Jn=!1}if(hn&&!Jn)return Ar||(Ar=new Ni),jn||$o(Oi)?_o(Oi,cr,_r,cn,sr,Ar):function(Di,Bi,Zo,es,ba,Gr,yn){switch(Zo){case dr:if(Di.byteLength!=Bi.byteLength||Di.byteOffset!=Bi.byteOffset)return!1;Di=Di.buffer,Bi=Bi.buffer;case gr:return!(Di.byteLength!=Bi.byteLength||!Gr(new $a(Di),new $a(Bi)));case Re:case Ct:case Ft:return ya(+Di,+Bi);case kt:return Di.name==Bi.name&&Di.message==Bi.message;case xi:case mt:return Di==Bi+"";case Wt:var Hr=ko;case Tr:var qt=1&es;if(Hr||(Hr=Oo),Di.size!=Bi.size&&!qt)return!1;var Rs=yn.get(Di);if(Rs)return Rs==Bi;es|=2,yn.set(Di,Bi);var Nn=_o(Hr(Di),Hr(Bi),es,ba,Gr,yn);return yn.delete(Di),Nn;case Qt:if(Ds)return Ds.call(Di)==Ds.call(Bi)}return!1}(Oi,cr,en,_r,cn,sr,Ar);if(!(1&_r)){var Fs=Jn&&ln.call(Oi,"__wrapped__"),Pn=Ur&&ln.call(cr,"__wrapped__");if(Fs||Pn){var Qn=Fs?Oi.value():Oi,Ks=Pn?cr.value():cr;return Ar||(Ar=new Ni),sr(Qn,Ks,_r,cn,Ar)}}return hn?(Ar||(Ar=new Ni),function(Di,Bi,Zo,es,ba,Gr){var yn=1&Zo,Hr=ga(Di),qt=Hr.length,Rs=ga(Bi).length;if(qt!=Rs&&!yn)return!1;for(var Nn=qt;Nn--;){var An=Hr[Nn];if(!(yn?An in Bi:ln.call(Bi,An)))return!1}var wa=Gr.get(Di);if(wa&&Gr.get(Bi))return wa==Bi;var Vt=!0;Gr.set(Di,Bi),Gr.set(Bi,Di);for(var Ss=yn;++Nn<qt;){var yo=Di[An=Hr[Nn]],vo=Bi[An];if(es)var xo=yn?es(vo,yo,An,Bi,Di,Gr):es(yo,vo,An,Di,Bi,Gr);if(!(xo===void 0?yo===vo||ba(yo,vo,Zo,es,Gr):xo)){Vt=!1;break}Ss||(Ss=An=="constructor")}if(Vt&&!Ss){var Js=Di.constructor,Bs=Bi.constructor;Js==Bs||!("constructor"in Di)||!("constructor"in Bi)||typeof Js=="function"&&Js instanceof Js&&typeof Bs=="function"&&Bs instanceof Bs||(Vt=!1)}return Gr.delete(Di),Gr.delete(Bi),Vt}(Oi,cr,_r,cn,sr,Ar)):!1}(Be,tt,Rt,oi,ma,tr))}function Ho(Be){return!(!hs(Be)||function(tt){return!!Wa&&Wa in tt}(Be))&&(xa(Be)?Sl:Ms).test(Cs(Be))}function Wo(Be){if(Rt=(tt=Be)&&tt.constructor,oi=typeof Rt=="function"&&Rt.prototype||ks,tt!==oi)return Ya(Be);var tt,Rt,oi,tr=[];for(var Oi in Object(Be))ln.call(Be,Oi)&&Oi!="constructor"&&tr.push(Oi);return tr}function _o(Be,tt,Rt,oi,tr,Oi){var cr=1&Rt,_r=Be.length,cn=tt.length;if(_r!=cn&&!(cr&&cn>_r))return!1;var sr=Oi.get(Be);if(sr&&Oi.get(tt))return sr==tt;var Ar=-1,jn=!0,Kn=2&Rt?new Ys:void 0;for(Oi.set(Be,tt),Oi.set(tt,Be);++Ar<_r;){var en=Be[Ar],_n=tt[Ar];if(oi)var Jn=cr?oi(_n,en,Ar,tt,Be,Oi):oi(en,_n,Ar,Be,tt,Oi);if(Jn!==void 0){if(Jn)continue;jn=!1;break}if(Kn){if(!ji(tt,function(Ur,hn){if(Fs=hn,!Kn.has(Fs)&&(en===Ur||tr(en,Ur,Rt,oi,Oi)))return Kn.push(hn);var Fs})){jn=!1;break}}else if(en!==_n&&!tr(en,_n,Rt,oi,Oi)){jn=!1;break}}return Oi.delete(Be),Oi.delete(tt),jn}function ga(Be){return function(tt,Rt,oi){var tr=Rt(tt);return Zs(tt)?tr:function(Oi,cr){for(var _r=-1,cn=cr.length,sr=Oi.length;++_r<cn;)Oi[sr+_r]=cr[_r];return Oi}(tr,oi(tt))}(Be,Yo,Xo)}function Ls(Be,tt){var Rt,oi,tr=Be.__data__;return((oi=typeof(Rt=tt))=="string"||oi=="number"||oi=="symbol"||oi=="boolean"?Rt!=="__proto__":Rt===null)?tr[typeof tt=="string"?"string":"hash"]:tr.map}function zs(Be,tt){var Rt=function(oi,tr){return oi==null?void 0:oi[tr]}(Be,tt);return Ho(Rt)?Rt:void 0}er.prototype.clear=function(){this.__data__=Yn?Yn(null):{},this.size=0},er.prototype.delete=function(Be){var tt=this.has(Be)&&delete this.__data__[Be];return this.size-=tt?1:0,tt},er.prototype.get=function(Be){var tt=this.__data__;if(Yn){var Rt=tt[Be];return Rt===Y?void 0:Rt}return ln.call(tt,Be)?tt[Be]:void 0},er.prototype.has=function(Be){var tt=this.__data__;return Yn?tt[Be]!==void 0:ln.call(tt,Be)},er.prototype.set=function(Be,tt){var Rt=this.__data__;return this.size+=this.has(Be)?0:1,Rt[Be]=Yn&&tt===void 0?Y:tt,this},cs.prototype.clear=function(){this.__data__=[],this.size=0},cs.prototype.delete=function(Be){var tt=this.__data__,Rt=Zn(tt,Be);return!(Rt<0)&&(Rt==tt.length-1?tt.pop():Bo.call(tt,Rt,1),--this.size,!0)},cs.prototype.get=function(Be){var tt=this.__data__,Rt=Zn(tt,Be);return Rt<0?void 0:tt[Rt][1]},cs.prototype.has=function(Be){return Zn(this.__data__,Be)>-1},cs.prototype.set=function(Be,tt){var Rt=this.__data__,oi=Zn(Rt,Be);return oi<0?(++this.size,Rt.push([Be,tt])):Rt[oi][1]=tt,this},Ti.prototype.clear=function(){this.size=0,this.__data__={hash:new er,map:new(Os||cs),string:new er}},Ti.prototype.delete=function(Be){var tt=Ls(this,Be).delete(Be);return this.size-=tt?1:0,tt},Ti.prototype.get=function(Be){return Ls(this,Be).get(Be)},Ti.prototype.has=function(Be){return Ls(this,Be).has(Be)},Ti.prototype.set=function(Be,tt){var Rt=Ls(this,Be),oi=Rt.size;return Rt.set(Be,tt),this.size+=Rt.size==oi?0:1,this},Ys.prototype.add=Ys.prototype.push=function(Be){return this.__data__.set(Be,Y),this},Ys.prototype.has=function(Be){return this.__data__.has(Be)},Ni.prototype.clear=function(){this.__data__=new cs,this.size=0},Ni.prototype.delete=function(Be){var tt=this.__data__,Rt=tt.delete(Be);return this.size=tt.size,Rt},Ni.prototype.get=function(Be){return this.__data__.get(Be)},Ni.prototype.has=function(Be){return this.__data__.has(Be)},Ni.prototype.set=function(Be,tt){var Rt=this.__data__;if(Rt instanceof cs){var oi=Rt.__data__;if(!Os||oi.length<199)return oi.push([Be,tt]),this.size=++Rt.size,this;Rt=this.__data__=new Ti(oi)}return Rt.set(Be,tt),this.size=Rt.size,this};var Xo=jo?function(Be){return Be==null?[]:(Be=Object(Be),function(tt,Rt){for(var oi=-1,tr=tt==null?0:tt.length,Oi=0,cr=[];++oi<tr;){var _r=tt[oi];Rt(_r,oi,tt)&&(cr[Oi++]=_r)}return cr}(jo(Be),function(tt){return Ro.call(Be,tt)}))}:function(){return[]},Bn=ws;function _a(Be,tt){return!!(tt=tt??ye)&&(typeof Be=="number"||mo.test(Be))&&Be>-1&&Be%1==0&&Be<tt}function Cs(Be){if(Be!=null){try{return da.call(Be)}catch{}try{return Be+""}catch{}}return""}function ya(Be,tt){return Be===tt||Be!=Be&&tt!=tt}(No&&Bn(new No(new ArrayBuffer(1)))!=dr||Os&&Bn(new Os)!=Wt||ls&&Bn(ls.resolve())!=ar||Vo&&Bn(new Vo)!=Tr||bs&&Bn(new bs)!=Ai)&&(Bn=function(Be){var tt=ws(Be),Rt=tt==vi?Be.constructor:void 0,oi=Rt?Cs(Rt):"";if(oi)switch(oi){case Za:return dr;case fa:return Wt;case zi:return ar;case Uo:return Tr;case Tl:return Ai}return tt});var qo=Go(function(){return arguments}())?Go:function(Be){return Or(Be)&&ln.call(Be,"callee")&&!Ro.call(Be,"callee")},Zs=Array.isArray,va=$s||function(){return!1};function xa(Be){if(!hs(Be))return!1;var tt=ws(Be);return tt==Ht||tt=="[object GeneratorFunction]"||tt=="[object AsyncFunction]"||tt=="[object Proxy]"}function lr(Be){return typeof Be=="number"&&Be>-1&&Be%1==0&&Be<=ye}function hs(Be){var tt=typeof Be;return Be!=null&&(tt=="object"||tt=="function")}function Or(Be){return Be!=null&&typeof Be=="object"}var $o=Vr?function(Be){return function(tt){return Be(tt)}}(Vr):function(Be){return Or(Be)&&lr(Be.length)&&!!Yi[ws(Be)]};function Yo(Be){return(tt=Be)!=null&&lr(tt.length)&&!xa(tt)?Ki(Be):Wo(Be);var tt}E.exports=function(Be,tt){return ma(Be,tt)}})(an,an.exports);var fo=pe(an.exports);function Rn(E,F){return E.length===F.length&&JSON.stringify(E.map(function(Y){return Y}).sort())===JSON.stringify(F.map(function(Y){return Y}).sort())}var po={Polygon:Pe,LineString:te,Point:_e,MultiPolygon:He,MultiLineString:He,MultiPoint:He},Wi=Object.freeze({__proto__:null,CommonSelectors:Et,constrainFeatureMovement:Vi,createMidPoint:Zi,createSupplementaryPoints:$i,createVertex:Zt,doubleClickZoom:ae,euclideanDistance:st,featuresAt:nt,getFeatureAtAndSetCursors:Mt,isClick:bt,isEventAtCoordinates:on,isTap:ee,mapEventToBoundingBox:Ze,ModeHandler:re,moveFeatures:co,sortFeatures:Ye,stringSetsAreEqual:Rn,StringSet:Je,theme:wt,toDenseArray:Oe}),Mo=function(E,F){var Y={options:E=function(Ee){Ee===void 0&&(Ee={});var Me=Tt(Ee);return Ee.controls||(Me.controls={}),Ee.displayControlsDefault===!1?Me.controls=Tt(or,Ee.controls):Me.controls=Tt(vs,Ee.controls),(Me=Tt(ho,Me)).styles=uo(Me.styles,"cold").concat(uo(Me.styles,"hot")),Me}(E)};F=function(Ee,Me){return Me.modes=u,Me.getFeatureIdsAt=function(Re){return nt.click({point:Re},null,Ee).map(function(Ct){return Ct.properties.id})},Me.getSelectedIds=function(){return Ee.store.getSelectedIds()},Me.getSelected=function(){return{type:_.FEATURE_COLLECTION,features:Ee.store.getSelectedIds().map(function(Re){return Ee.store.get(Re)}).map(function(Re){return Re.toGeoJSON()})}},Me.getSelectedPoints=function(){return{type:_.FEATURE_COLLECTION,features:Ee.store.getSelectedCoordinates().map(function(Re){return{type:_.FEATURE,properties:{},geometry:{type:_.POINT,coordinates:Re.coordinates}}})}},Me.set=function(Re){if(Re.type===void 0||Re.type!==_.FEATURE_COLLECTION||!Array.isArray(Re.features))throw new Error("Invalid FeatureCollection");var Ct=Ee.store.createRenderBatch(),kt=Ee.store.getAllIds().slice(),Ht=Me.add(Re),Wt=new Je(Ht);return(kt=kt.filter(function(Ft){return!Wt.has(Ft)})).length&&Me.delete(kt),Ct(),Ht},Me.add=function(Re){var Ct=JSON.parse(JSON.stringify(oe(Re))).features.map(function(kt){if(kt.id=kt.id||ge(),kt.geometry===null)throw new Error("Invalid geometry: null");if(Ee.store.get(kt.id)===void 0||Ee.store.get(kt.id).type!==kt.geometry.type){var Ht=po[kt.geometry.type];if(Ht===void 0)throw new Error("Invalid geometry type: "+kt.geometry.type+".");var Wt=new Ht(Ee,kt);Ee.store.add(Wt)}else{var Ft=Ee.store.get(kt.id);Ft.properties=kt.properties,fo(Ft.properties,kt.properties)||Ee.store.featureChanged(Ft.id),fo(Ft.getCoordinates(),kt.geometry.coordinates)||Ft.incomingCoords(kt.geometry.coordinates)}return kt.id});return Ee.store.render(),Ct},Me.get=function(Re){var Ct=Ee.store.get(Re);if(Ct)return Ct.toGeoJSON()},Me.getAll=function(){return{type:_.FEATURE_COLLECTION,features:Ee.store.getAll().map(function(Re){return Re.toGeoJSON()})}},Me.delete=function(Re){return Ee.store.delete(Re,{silent:!0}),Me.getMode()!==u.DIRECT_SELECT||Ee.store.getSelectedIds().length?Ee.store.render():Ee.events.changeMode(u.SIMPLE_SELECT,void 0,{silent:!0}),Me},Me.deleteAll=function(){return Ee.store.delete(Ee.store.getAllIds(),{silent:!0}),Me.getMode()===u.DIRECT_SELECT?Ee.events.changeMode(u.SIMPLE_SELECT,void 0,{silent:!0}):Ee.store.render(),Me},Me.changeMode=function(Re,Ct){return Ct===void 0&&(Ct={}),Re===u.SIMPLE_SELECT&&Me.getMode()===u.SIMPLE_SELECT?(Rn(Ct.featureIds||[],Ee.store.getSelectedIds())||(Ee.store.setSelected(Ct.featureIds,{silent:!0}),Ee.store.render()),Me):(Re===u.DIRECT_SELECT&&Me.getMode()===u.DIRECT_SELECT&&Ct.featureId===Ee.store.getSelectedIds()[0]||Ee.events.changeMode(Re,Ct,{silent:!0}),Me)},Me.getMode=function(){return Ee.events.getMode()},Me.trash=function(){return Ee.events.trash({silent:!0}),Me},Me.combineFeatures=function(){return Ee.events.combineFeatures({silent:!0}),Me},Me.uncombineFeatures=function(){return Ee.events.uncombineFeatures({silent:!0}),Me},Me.setFeatureProperty=function(Re,Ct,kt){return Ee.store.setFeatureProperty(Re,Ct,kt),Me},Me}(Y,F),Y.api=F;var ye=lt(Y);return F.onAdd=ye.onAdd,F.onRemove=ye.onRemove,F.types=m,F.options=E,F};function ss(E){Mo(E,this)}return ss.modes=Sr,ss.constants=ie,ss.lib=Wi,ss})})(Fd);var Yp=Fd.exports;const kh=Od(Yp),nc="rgb(127, 127, 127)",Zp=[{id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","true"]],paint:{"fill-color":["case",["==",["get","user_color_rgb_str"],null],nc,["get","user_color_rgb_str"]],"fill-outline-color":"rgb(0, 0, 0)","fill-opacity":.5}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","$type","Polygon"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(178, 204, 255)","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-halo-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-polygon-and-line-vertex-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"]],paint:{"circle-radius":3,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","$type","LineString"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-width":3}},{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","false"]],paint:{"fill-color":["case",["==",["get","user_color_rgb_str"],null],nc,["get","user_color_rgb_str"]],"fill-outline-color":"rgb(0, 0, 0)","fill-opacity":.25}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","$type","Polygon"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-width":3}}];function Kp($,S){return $.lngLat?$.lngLat.lng===S[0]&&$.lngLat.lat===S[1]:!1}const zh=kh.modes.draw_polygon;zh.maxVertices=4;zh.clickAnywhere=function($,S){if($.currentVertexPosition>0&&Kp(S,$.polygon.coordinates[0][$.currentVertexPosition-1]))return this.changeMode("simple_select",{featureIds:[$.polygon.id]});if(this.updateUIClasses({mouse:"add"}),$.polygon.updateCoordinate(`0.${$.currentVertexPosition}`,S.lngLat.lng,S.lngLat.lat),$.currentVertexPosition++,$.polygon.updateCoordinate(`0.${$.currentVertexPosition}`,S.lngLat.lng,S.lngLat.lat),$.currentVertexPosition>this.maxVertices-1)return this.updateUIClasses({mouse:"none"}),this.changeMode("simple_select",{featuresId:$.polygon.id})};var Jp={exports:{}};(function($){(function(S){S.version="0.5.0",S.defaults={doThrows:{invalidGeometry:!1}};function re(){var _=1<=arguments.length?[].slice.call(arguments,0):[],u=_.shift(),x=_.shift();Error.apply(this,_),this.message=this.message||"Invalid Geometry: item: "+JSON.stringify(u)+", params: "+JSON.stringify(x)}re.prototype=Error,S.errors={InvalidGeometryError:re},S.isGeometryValid=function(_){return!_||!Object.keys(_).length?!1:!!_.type&&!!_.coordinates&&Array.isArray(_.coordinates)&&!!_.coordinates.length},S.parse=function(_,u,x){var T,A=Ie(u,this.defaults),D;if(ue.length=0,p(A),D=h(A),Array.isArray(_)?(T={type:"FeatureCollection",features:[]},_.forEach(function(V){T.features.push(v({item:V,params:A,propFunc:D}))}),j(T,A)):(T=v({item:_,params:A,propFunc:D}),j(T,A)),x&&typeof x=="function")x(T);else return T};var pe=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","GeoJSON"],ue=[];function Ie(_,u){var x=_||{};for(var T in u)u.hasOwnProperty(T)&&!x[T]&&(x[T]=u[T]);return x}function j(_,u){if(u.crs&&s(u.crs)&&(u.isPostgres?_.geometry.crs=u.crs:_.crs=u.crs),u.bbox&&(_.bbox=u.bbox),u.extraGlobal){_.properties={};for(var x in u.extraGlobal)_.properties[x]=u.extraGlobal[x]}}function s(_){if(_.type==="name"){if(_.properties&&_.properties.name)return!0;throw new Error('Invalid CRS. Properties must contain "name" key')}else if(_.type==="link"){if(_.properties&&_.properties.href&&_.properties.type)return!0;throw new Error('Invalid CRS. Properties must contain "href" and "type" key')}else throw new Error('Invald CRS. Type attribute must be "name" or "link"')}function p(_){_.geom={};for(var u in _)_.hasOwnProperty(u)&&pe.indexOf(u)!==-1&&(_.geom[u]=_[u],delete _[u]);b(_.geom)}function b(_){for(var u in _)_.hasOwnProperty(u)&&(typeof _[u]=="string"?ue.push(_[u]):typeof _[u]=="object"&&(ue.push(_[u][0]),ue.push(_[u][1])));if(ue.length===0)throw new Error("No geometry attributes specified")}function v(_){var u=_.item,x=_.params,T=_.propFunc,A={type:"Feature"};return A.geometry=l(u,x),A.properties=T.call(u),A}function a(_){return/^.+\..+$/.test(_)}function l(_,u){var x={};for(var T in u.geom){var A=u.geom[T];if(typeof A=="string"&&_.hasOwnProperty(A))T==="GeoJSON"?x=_[A]:(x.type=T,x.coordinates=_[A]);else if(typeof A=="object"&&!Array.isArray(A)){var D=Object.keys(A).map(function(Ye){var Ze=A[Ye],Je=_[Ye];return l(Je,{geom:{Point:Ze}})});x.type=T,x.coordinates=[].concat(D.map(function(Ye){return Ye.coordinates}))}else if(Array.isArray(A)&&_.hasOwnProperty(A[0])&&_.hasOwnProperty(A[1]))x.type=T,x.coordinates=[Number(_[A[1]]),Number(_[A[0]])];else if(Array.isArray(A)&&a(A[0])&&a(A[1])){for(var V=[],X=0;X<A.length;X++){for(var ie=A[X].split("."),ve=_,Fe=0;Fe<ie.length;Fe++){if(!ve.hasOwnProperty(ie[Fe]))return!1;ve=ve[ie[Fe]]}V[X]=ve}x.type=T,x.coordinates=[Number(V[1]),Number(V[0])]}}if(u.doThrows&&u.doThrows.invalidGeometry&&!S.isGeometryValid(x))throw new re(_,u);return x}function h(_){var u;return!_.exclude&&!_.include?u=function(x){for(var T in this)this.hasOwnProperty(T)&&ue.indexOf(T)===-1&&(x[T]=this[T])}:_.include?u=function(x){_.include.forEach(function(T){x[T]=this[T]},this)}:_.exclude&&(u=function(x){for(var T in this)this.hasOwnProperty(T)&&ue.indexOf(T)===-1&&_.exclude.indexOf(T)===-1&&(x[T]=this[T])}),function(){var x={};return u.call(this,x),_.extra&&m(x,_.extra),x}}function m(_,u){for(var x in u)u.hasOwnProperty(x)&&(_[x]=u[x]);return _}})($.exports)})(Jp);const Rd={name:"delete_zone",onSetup:function(){return{}},onClick:function($,S){var re;if(S.featureTarget){const pe=S.featureTarget,ue=(re=pe==null?void 0:pe.properties)==null?void 0:re.id;if(!ue)return;this.deleteFeature(ue),this.changeMode("simple_select")}},toDisplayFeatures:function($,S,re){re(S)}},Oh=qn(),Fh=qn(new kh({userProperties:!0,displayControlsDefault:!1,controls:{polygon:!1,trash:!1},modes:Object.assign({draw_restricted_polygon:zh,delete_zone:Rd},kh.modes),styles:Zp}));var Ui=($=>($[$.AddingZoneCanvas=1]="AddingZoneCanvas",$[$.AddingZoneMap=2]="AddingZoneMap",$[$.Waiting=3]="Waiting",$[$.EditingZone=4]="EditingZone",$[$.DeletingZoneCanvas=5]="DeletingZoneCanvas",$[$.DeletingZoneMap=6]="DeletingZoneMap",$[$.PickPolygon=7]="PickPolygon",$))(Ui||{}),Bc=($=>($.Init="init",$.ReInit="re-init",$))(Bc||{});const jc=qn(),tn=qn(Ui.Waiting),xl=qn(!1),vl=qn(!1),Qp="http",em="localhost",tm=42001,im=window.location.href,Rh=new URL(im),Bh=Rh.protocol.replace(/:/g,"")||Qp,Bd=Rh.hostname||em,jd=parseInt(Rh.port)||(Bh==="https:"?443:80)||tm;class rm{constructor(S=qn(Bh),re=qn(Bd),pe=qn(jd)){this.schema=S,this.host=re,this.port=pe}get apiURL(){return qp([this.schema,this.host,this.port],([S,re,pe])=>`${S}://${re}:${pe}`)}}const Nc=new rm,jh=qn(`${Bh}://${Bd}:${jd}`);class nm{constructor(S=qn("https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL"),re=qn("https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL")){this.uri=S,this.accepted_uri=re}}const Vc=new nm;qn(Vc.accepted_uri);const ao=qn(new Map);function sm($){ao.update(S=>{const re=new Map(S),pe={type:$.type,id:$.id,properties:{road_lane_direction:$.properties.road_lane_direction,road_lane_num:$.properties.road_lane_num,coordinates:$.properties.coordinates,color_rgb:$.properties.color_rgb,virtual_line:$.properties.virtual_line,ds_id:$.id,spatial_object_id:`spatial-${$.id}`,color_rgb_str:`rgb(${$.properties.color_rgb[0]},${$.properties.color_rgb[1]},${$.properties.color_rgb[2]})`},geometry:{type:$.geometry.type,coordinates:$.geometry.coordinates}};return re.set($.id,pe),re})}function Ua($,S){ao.update(re=>{const pe=new Map(re);return pe.set($,S),pe})}function om($){ao.update(S=>{const re=new Map(S);return re.delete($),re})}function am(){ao.update($=>{const S=new Map($);return S.clear(),S})}const lm=($,S,re)=>{const pe=$.get(re);if(!pe)return;if(!pe.properties.spatial_object_id){console.error(`ID '${pe.id}' should have 'spatial_object_id' in properties, but it has not`);return}const ue=S.get(pe.properties.spatial_object_id);ue&&(S.add(ue),S.setFeatureProperty(ue.id,"color_rgb_str",nc))},Nd=($,S)=>{const re=$.get(S);re&&(re.properties.spatial_object_id=void 0,re.properties.road_lane_direction=-1,re.properties.road_lane_num=-1,re.geometry.coordinates=[[],[],[],[],[]],Ua(S,re))};function cm($){let S,re,pe;return{c(){S=Ot("div"),re=Ot("div"),this.h()},l(ue){S=Dt(ue,"DIV",{class:!0});var Ie=ti(S);re=Dt(Ie,"DIV",{class:!0,id:!0}),ti(re).forEach(Gt),Ie.forEach(Gt),this.h()},h(){dt(re,"class","map"),dt(re,"id","map"),dt(S,"class",pe="map-wrap "+$[0])},m(ue,Ie){gn(ue,S,Ie),it(S,re),$[5](re)},p(ue,[Ie]){Ie&1&&pe!==(pe="map-wrap "+ue[0])&&dt(S,"class",pe)},i:ys,o:ys,d(ue){ue&&Gt(S),$[5](null)}}}function hm($){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent($)}`}function um($,S,re){let pe,ue,Ie,j;Nr($,Fh,x=>re(7,pe=x)),Nr($,ao,x=>re(8,ue=x)),Nr($,Oh,x=>re(9,Ie=x));let{klass:s=""}=S,p;const{accepted_uri:b}=Vc;Nr($,b,x=>re(10,j=x));let v=j;const a=x=>`<svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="${x}"><path d="M480.276-96Q401-96 331-126q-70-30-122.5-82.5T126-330.958q-30-69.959-30-149.5Q96-560 126-629.5t82.5-122Q261-804 330.958-834q69.959-30 149.5-30Q560-864 629.5-834t122 82.5Q804-699 834-629.276q30 69.725 30 149Q864-401 834-331q-30 70-82.5 122.5T629.276-126q-69.725 30-149 30ZM480-168q130 0 221-91t91-221q0-130-91-221t-221-91q-130 0-221 91t-91 221q0 130 91 221t221 91Zm0 0q-130 0-221-91t-91-221q0-130 91-221t221-91q130 0 221 91t91 221q0 130-91 221t-221 91Z"/></svg>`,l=b.subscribe(x=>{v!==x&&(Ie.setStyle(x),v=j)});sc(()=>{console.log("Mounted map component");const x={lng:0,lat:0,zoom:5};Oh.set(new zd.Map({container:p,style:v,center:[x.lng,x.lat],zoom:x.zoom})),Ie.on("load",()=>{Ie.resize()}),Ie.on("click","gl-draw-polygon-fill-inactive.cold",function(T){var Fe,Ye,Ze,Je;const A=pe.get((Fe=T.features)==null?void 0:Fe[0].properties.id);if(!A)return;const D=Array.from(ue.values()).map((ct,nt)=>{const vt=ct.properties.color_rgb_str;return`<option value="${ct.id}" data-icon="${hm(a(vt))}">${ct.id}</option>`}),V=(Ye=[...ue].find(ct=>ct[1].properties.spatial_object_id===A.id))==null?void 0:Ye[1],X=`
                <div id="custom-popup">
                    <div class="row">
                        <div class="input-field col s12">
                            <select id="select-canvas">
                                <option value="" disabled selected>Pick up polygon</option>
                                ${D.join(`
`)}
                            </select>
                            <label>Attach canvas polygons</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input value="${V?(Ze=V.properties)==null?void 0:Ze.road_lane_direction:-1}" id="lane-direction" type="number" class="validate">
                            <label class="active" for="lane-direction">Direction value</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input value="${V?(Je=V.properties)==null?void 0:Je.road_lane_num:-1}" id="lane-number" type="number" class="validate">
                            <label class="active" for="lane-number">Lane</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12">
                            <button id="attach-canvas-btn" class="btn-small waves-effect waves-light" type="submit" name="action" onclick>Save
                                <i class="material-icons right">save</i>
                            </button>
                        </div>
                    </div>
                </div>
            `;new xd.Popup({className:"custom-popup"}).setLngLat(T.lngLat).setHTML(X).addTo(Ie);const ie=document.getElementById("select-canvas");if(!ie)return;Array.from(ue.values()).some(ct=>{if(ct.properties.spatial_object_id===A.id)return ie.value=ct.id??"No canvas ID",!0}),M.FormSelect.init(ie,{});const ve=document.getElementById("attach-canvas-btn");if(!ve){console.error("No container 'attach-canvas-btn'");return}ve.addEventListener("click",ct=>{const nt=document.getElementById("lane-direction"),vt=document.getElementById("lane-number");_(A,ie.value,{road_lane_direction:nt?parseInt(nt.value):-1,road_lane_num:vt?parseInt(vt.value):-1})})})}),Dh(()=>{l(),Ie.remove()});function h(x){Ie.addControl(x)}const m=(x,T)=>{if(T.forEach(V=>{const X={...V,properties:{color_rgb_str:V.properties.color_rgb_str},id:V.properties.spatial_object_id};x.add(X)}),T.size===0)return;const A=Array.from(T.values())[0].geometry.coordinates;let D=new xd.LngLatBounds(A[0]);for(const V of A)D.extend(V);Ie.fitBounds(D,{maxZoom:18,padding:100})},_=(x,T,A={road_lane_direction:-1,road_lane_num:-1})=>{var Fe;if(T===""||T===null||T===void 0||!x.properties||!x.id)return;const D=ue.get(T);if(!D){console.error(`ID '${T}' not found in datastorage`);return}const V=x.id,X=D.properties.spatial_object_id;if(X){const Ye=pe.get(X);Ye&&(pe.add(Ye),pe.setFeatureProperty(X,"color_rgb_str",nc))}const ie=(Fe=[...ue].find(Ye=>Ye[1].id!==T&&Ye[1].properties.spatial_object_id===V))==null?void 0:Fe[1];ie&&Nd(ue,ie.id),D.properties.spatial_object_id=V,D.properties.road_lane_direction=A.road_lane_direction,D.properties.road_lane_num=A.road_lane_num;const ve=x.geometry;D.geometry.coordinates=ve.coordinates,Ua(T,D),pe.add(x),pe.setFeatureProperty(V,"color_rgb_str",D.properties.color_rgb_str)};function u(x){Md[x?"unshift":"push"](()=>{p=x,re(1,p)})}return $.$$set=x=>{"klass"in x&&re(0,s=x.klass)},[s,p,b,h,m,u]}class dm extends oa{constructor(S){super(),aa(this,S,um,cm,sa,{klass:0,attachDraw:3,drawGeoPolygons:4})}get attachDraw(){return this.$$.ctx[3]}get drawGeoPolygons(){return this.$$.ctx[4]}}function fm($){let S,re,pe,ue,Ie=".",j,s,p=".",b,v,a=".";return{c(){S=Ot("div"),re=Cn($[0]),pe=Ii(),ue=Ot("span"),ue.textContent=Ie,j=Ii(),s=Ot("span"),s.textContent=p,b=Ii(),v=Ot("span"),v.textContent=a,this.h()},l(l){S=Dt(l,"DIV",{class:!0});var h=ti(S);re=Sn(h,$[0]),pe=Pi(h),ue=Dt(h,"SPAN",{class:!0,"data-svelte-h":!0}),br(ue)!=="svelte-980x4v"&&(ue.textContent=Ie),j=Pi(h),s=Dt(h,"SPAN",{class:!0,"data-svelte-h":!0}),br(s)!=="svelte-1xw9n6t"&&(s.textContent=p),b=Pi(h),v=Dt(h,"SPAN",{class:!0,"data-svelte-h":!0}),br(v)!=="svelte-17zz11c"&&(v.textContent=a),h.forEach(Gt),this.h()},h(){dt(ue,"class","first-dot svelte-4rj70q"),dt(s,"class","second-dot svelte-4rj70q"),dt(v,"class","third-dot svelte-4rj70q"),dt(S,"class","three-dot-loader")},m(l,h){gn(l,S,h),it(S,re),it(S,pe),it(S,ue),it(S,j),it(S,s),it(S,b),it(S,v)},p(l,[h]){h&1&&Ws(re,l[0])},i:ys,o:ys,d(l){l&&Gt(S)}}}function pm($,S,re){let{msgText:pe="Loading"}=S;return $.$$set=ue=>{"msgText"in ue&&re(0,pe=ue.msgText)},[pe]}class mm extends oa{constructor(S){super(),aa(this,S,pm,fm,sa,{msgText:0})}}var _i={};const gm={},_m=Object.freeze(Object.defineProperty({__proto__:null,default:gm},Symbol.toStringTag,{value:"Module"})),Mh=Xp(_m);(function($){/*! Fabric.js Copyright 2008-2015, Printio (Juriy Zaytsev, Maxim Chernyak) */var S=S||{version:"5.3.0"};if($.fabric=S,typeof document<"u"&&typeof window<"u")document instanceof(typeof HTMLDocument<"u"?HTMLDocument:Document)?S.document=document:S.document=document.implementation.createHTMLDocument(""),S.window=window;else{var re=Mh,pe=new re.JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;S.document=pe.document,S.jsdomImplForWrapper=Mh.implForWrapper,S.nodeCanvas=Mh.Canvas,S.window=pe,DOMParser=S.window.DOMParser}S.isTouchSupported="ontouchstart"in S.window||"ontouchstart"in S.document||S.window&&S.window.navigator&&S.window.navigator.maxTouchPoints>0,S.isLikelyNode=typeof Buffer<"u"&&typeof window>"u",S.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],S.DPI=96,S.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",S.commaWsp="(?:\\s+,?\\s*|,\\s*)",S.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/ig,S.reNonWord=/[ \n\.,;!\?\-]/,S.fontPaths={},S.iMatrix=[1,0,0,1,0,0],S.svgNS="http://www.w3.org/2000/svg",S.perfLimitSizeTotal=2097152,S.maxCacheSideLimit=4096,S.minCacheSideLimit=256,S.charWidthsCache={},S.textureSize=2048,S.disableStyleCopyPaste=!1,S.enableGLFiltering=!0,S.devicePixelRatio=S.window.devicePixelRatio||S.window.webkitDevicePixelRatio||S.window.mozDevicePixelRatio||1,S.browserShadowBlurConstant=1,S.arcToSegmentsCache={},S.boundsOfCurveCache={},S.cachesBoundsOfCurve=!0,S.forceGLPutImageData=!1,S.initFilterBackend=function(){if(S.enableGLFiltering&&S.isWebglSupported&&S.isWebglSupported(S.textureSize))return console.log("max texture size: "+S.maxTextureSize),new S.WebglFilterBackend({tileSize:S.textureSize});if(S.Canvas2dFilterBackend)return new S.Canvas2dFilterBackend},typeof document<"u"&&typeof window<"u"&&(window.fabric=S),function(){function s(h,m){if(this.__eventListeners[h]){var _=this.__eventListeners[h];m?_[_.indexOf(m)]=!1:S.util.array.fill(_,!1)}}function p(h,m){if(this.__eventListeners||(this.__eventListeners={}),arguments.length===1)for(var _ in h)this.on(_,h[_]);else this.__eventListeners[h]||(this.__eventListeners[h]=[]),this.__eventListeners[h].push(m);return this}function b(h,m){var _=(function(){m.apply(this,arguments),this.off(h,_)}).bind(this);this.on(h,_)}function v(h,m){if(arguments.length===1)for(var _ in h)b.call(this,_,h[_]);else b.call(this,h,m);return this}function a(h,m){if(!this.__eventListeners)return this;if(arguments.length===0)for(h in this.__eventListeners)s.call(this,h);else if(arguments.length===1&&typeof arguments[0]=="object")for(var _ in h)s.call(this,_,h[_]);else s.call(this,h,m);return this}function l(h,m){if(!this.__eventListeners)return this;var _=this.__eventListeners[h];if(!_)return this;for(var u=0,x=_.length;u<x;u++)_[u]&&_[u].call(this,m||{});return this.__eventListeners[h]=_.filter(function(T){return T!==!1}),this}S.Observable={fire:l,on:p,once:v,off:a}}(),S.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var s=0,p=arguments.length;s<p;s++)this._onObjectAdded(arguments[s]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(s,p,b){var v=this._objects;return b?v[p]=s:v.splice(p,0,s),this._onObjectAdded&&this._onObjectAdded(s),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var s=this._objects,p,b=!1,v=0,a=arguments.length;v<a;v++)p=s.indexOf(arguments[v]),p!==-1&&(b=!0,s.splice(p,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[v]));return this.renderOnAddRemove&&b&&this.requestRenderAll(),this},forEachObject:function(s,p){for(var b=this.getObjects(),v=0,a=b.length;v<a;v++)s.call(p,b[v],v,b);return this},getObjects:function(s){return typeof s>"u"?this._objects.concat():this._objects.filter(function(p){return p.type===s})},item:function(s){return this._objects[s]},isEmpty:function(){return this._objects.length===0},size:function(){return this._objects.length},contains:function(s,p){return this._objects.indexOf(s)>-1?!0:p?this._objects.some(function(b){return typeof b.contains=="function"&&b.contains(s,!0)}):!1},complexity:function(){return this._objects.reduce(function(s,p){return s+=p.complexity?p.complexity():0,s},0)}},S.CommonMethods={_setOptions:function(s){for(var p in s)this.set(p,s[p])},_initGradient:function(s,p){s&&s.colorStops&&!(s instanceof S.Gradient)&&this.set(p,new S.Gradient(s))},_initPattern:function(s,p,b){s&&s.source&&!(s instanceof S.Pattern)?this.set(p,new S.Pattern(s,b)):b&&b()},_setObject:function(s){for(var p in s)this._set(p,s[p])},set:function(s,p){return typeof s=="object"?this._setObject(s):this._set(s,p),this},_set:function(s,p){this[s]=p},toggle:function(s){var p=this.get(s);return typeof p=="boolean"&&this.set(s,!p),this},get:function(s){return this[s]}},function(s){var p=Math.sqrt,b=Math.atan2,v=Math.pow,a=Math.PI/180,l=Math.PI/2;S.util={cos:function(h){if(h===0)return 1;h<0&&(h=-h);var m=h/l;switch(m){case 1:case 3:return 0;case 2:return-1}return Math.cos(h)},sin:function(h){if(h===0)return 0;var m=h/l,_=1;switch(h<0&&(_=-1),m){case 1:return _;case 2:return 0;case 3:return-_}return Math.sin(h)},removeFromArray:function(h,m){var _=h.indexOf(m);return _!==-1&&h.splice(_,1),h},getRandomInt:function(h,m){return Math.floor(Math.random()*(m-h+1))+h},degreesToRadians:function(h){return h*a},radiansToDegrees:function(h){return h/a},rotatePoint:function(h,m,_){var u=new S.Point(h.x-m.x,h.y-m.y),x=S.util.rotateVector(u,_);return new S.Point(x.x,x.y).addEquals(m)},rotateVector:function(h,m){var _=S.util.sin(m),u=S.util.cos(m),x=h.x*u-h.y*_,T=h.x*_+h.y*u;return{x,y:T}},createVector:function(h,m){return new S.Point(m.x-h.x,m.y-h.y)},calcAngleBetweenVectors:function(h,m){return Math.acos((h.x*m.x+h.y*m.y)/(Math.hypot(h.x,h.y)*Math.hypot(m.x,m.y)))},getHatVector:function(h){return new S.Point(h.x,h.y).multiply(1/Math.hypot(h.x,h.y))},getBisector:function(h,m,_){var u=S.util.createVector(h,m),x=S.util.createVector(h,_),T=S.util.calcAngleBetweenVectors(u,x),A=S.util.calcAngleBetweenVectors(S.util.rotateVector(u,T),x),D=T*(A===0?1:-1)/2;return{vector:S.util.getHatVector(S.util.rotateVector(u,D)),angle:T}},projectStrokeOnPoints:function(h,m,_){var u=[],x=m.strokeWidth/2,T=m.strokeUniform?new S.Point(1/m.scaleX,1/m.scaleY):new S.Point(1,1),A=function(D){var V=x/Math.hypot(D.x,D.y);return new S.Point(D.x*V*T.x,D.y*V*T.y)};return h.length<=1||h.forEach(function(D,V){var X=new S.Point(D.x,D.y),ie,ve;V===0?(ve=h[V+1],ie=_?A(S.util.createVector(ve,X)).addEquals(X):h[h.length-1]):V===h.length-1?(ie=h[V-1],ve=_?A(S.util.createVector(ie,X)).addEquals(X):h[0]):(ie=h[V-1],ve=h[V+1]);var Fe=S.util.getBisector(X,ie,ve),Ye=Fe.vector,Ze=Fe.angle,Je,ct;if(m.strokeLineJoin==="miter"&&(Je=-x/Math.sin(Ze/2),ct=new S.Point(Ye.x*Je*T.x,Ye.y*Je*T.y),Math.hypot(ct.x,ct.y)/x<=m.strokeMiterLimit)){u.push(X.add(ct)),u.push(X.subtract(ct));return}Je=-x*Math.SQRT2,ct=new S.Point(Ye.x*Je*T.x,Ye.y*Je*T.y),u.push(X.add(ct)),u.push(X.subtract(ct))}),u},transformPoint:function(h,m,_){return _?new S.Point(m[0]*h.x+m[2]*h.y,m[1]*h.x+m[3]*h.y):new S.Point(m[0]*h.x+m[2]*h.y+m[4],m[1]*h.x+m[3]*h.y+m[5])},makeBoundingBoxFromPoints:function(h,m){if(m)for(var _=0;_<h.length;_++)h[_]=S.util.transformPoint(h[_],m);var u=[h[0].x,h[1].x,h[2].x,h[3].x],x=S.util.array.min(u),T=S.util.array.max(u),A=T-x,D=[h[0].y,h[1].y,h[2].y,h[3].y],V=S.util.array.min(D),X=S.util.array.max(D),ie=X-V;return{left:x,top:V,width:A,height:ie}},invertTransform:function(h){var m=1/(h[0]*h[3]-h[1]*h[2]),_=[m*h[3],-m*h[1],-m*h[2],m*h[0]],u=S.util.transformPoint({x:h[4],y:h[5]},_,!0);return _[4]=-u.x,_[5]=-u.y,_},toFixed:function(h,m){return parseFloat(Number(h).toFixed(m))},parseUnit:function(h,m){var _=/\D{0,2}$/.exec(h),u=parseFloat(h);switch(m||(m=S.Text.DEFAULT_SVG_FONT_SIZE),_[0]){case"mm":return u*S.DPI/25.4;case"cm":return u*S.DPI/2.54;case"in":return u*S.DPI;case"pt":return u*S.DPI/72;case"pc":return u*S.DPI/72*12;case"em":return u*m;default:return u}},falseFunction:function(){return!1},getKlass:function(h,m){return h=S.util.string.camelize(h.charAt(0).toUpperCase()+h.slice(1)),S.util.resolveNamespace(m)[h]},getSvgAttributes:function(h){var m=["instantiated_by_use","style","id","class"];switch(h){case"linearGradient":m=m.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":m=m.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":m=m.concat(["offset","stop-color","stop-opacity"]);break}return m},resolveNamespace:function(h){if(!h)return S;var m=h.split("."),_=m.length,u,x=s||S.window;for(u=0;u<_;++u)x=x[m[u]];return x},loadImage:function(h,m,_,u){if(!h){m&&m.call(_,h);return}var x=S.util.createImage(),T=function(){m&&m.call(_,x,!1),x=x.onload=x.onerror=null};x.onload=T,x.onerror=function(){S.log("Error loading "+x.src),m&&m.call(_,null,!0),x=x.onload=x.onerror=null},h.indexOf("data")!==0&&u!==void 0&&u!==null&&(x.crossOrigin=u),h.substring(0,14)==="data:image/svg"&&(x.onload=null,S.util.loadImageInDom(x,T)),x.src=h},loadImageInDom:function(h,m){var _=S.document.createElement("div");_.style.width=_.style.height="1px",_.style.left=_.style.top="-100%",_.style.position="absolute",_.appendChild(h),S.document.querySelector("body").appendChild(_),h.onload=function(){m(),_.parentNode.removeChild(_),_=null}},enlivenObjects:function(h,m,_,u){h=h||[];var x=[],T=0,A=h.length;function D(){++T===A&&m&&m(x.filter(function(V){return V}))}if(!A){m&&m(x);return}h.forEach(function(V,X){if(!V||!V.type){D();return}var ie=S.util.getKlass(V.type,_);ie.fromObject(V,function(ve,Fe){Fe||(x[X]=ve),u&&u(V,ve,Fe),D()})})},enlivenObjectEnlivables:function(h,m,_){var u=S.Object.ENLIVEN_PROPS.filter(function(x){return!!h[x]});S.util.enlivenObjects(u.map(function(x){return h[x]}),function(x){var T={};u.forEach(function(A,D){T[A]=x[D],m&&(m[A]=x[D])}),_&&_(T)})},enlivenPatterns:function(h,m){h=h||[];function _(){++x===T&&m&&m(u)}var u=[],x=0,T=h.length;if(!T){m&&m(u);return}h.forEach(function(A,D){A&&A.source?new S.Pattern(A,function(V){u[D]=V,_()}):(u[D]=A,_())})},groupSVGElements:function(h,m,_){var u;return h&&h.length===1?(typeof _<"u"&&(h[0].sourcePath=_),h[0]):(m&&(m.width&&m.height?m.centerPoint={x:m.width/2,y:m.height/2}:(delete m.width,delete m.height)),u=new S.Group(h,m),typeof _<"u"&&(u.sourcePath=_),u)},populateWithProperties:function(h,m,_){if(_&&Array.isArray(_))for(var u=0,x=_.length;u<x;u++)_[u]in h&&(m[_[u]]=h[_[u]])},createCanvasElement:function(){return S.document.createElement("canvas")},copyCanvasElement:function(h){var m=S.util.createCanvasElement();return m.width=h.width,m.height=h.height,m.getContext("2d").drawImage(h,0,0),m},toDataURL:function(h,m,_){return h.toDataURL("image/"+m,_)},createImage:function(){return S.document.createElement("img")},multiplyTransformMatrices:function(h,m,_){return[h[0]*m[0]+h[2]*m[1],h[1]*m[0]+h[3]*m[1],h[0]*m[2]+h[2]*m[3],h[1]*m[2]+h[3]*m[3],_?0:h[0]*m[4]+h[2]*m[5]+h[4],_?0:h[1]*m[4]+h[3]*m[5]+h[5]]},qrDecompose:function(h){var m=b(h[1],h[0]),_=v(h[0],2)+v(h[1],2),u=p(_),x=(h[0]*h[3]-h[2]*h[1])/u,T=b(h[0]*h[2]+h[1]*h[3],_);return{angle:m/a,scaleX:u,scaleY:x,skewX:T/a,skewY:0,translateX:h[4],translateY:h[5]}},calcRotateMatrix:function(h){if(!h.angle)return S.iMatrix.concat();var m=S.util.degreesToRadians(h.angle),_=S.util.cos(m),u=S.util.sin(m);return[_,u,-u,_,0,0]},calcDimensionsMatrix:function(h){var m=typeof h.scaleX>"u"?1:h.scaleX,_=typeof h.scaleY>"u"?1:h.scaleY,u=[h.flipX?-m:m,0,0,h.flipY?-_:_,0,0],x=S.util.multiplyTransformMatrices,T=S.util.degreesToRadians;return h.skewX&&(u=x(u,[1,0,Math.tan(T(h.skewX)),1],!0)),h.skewY&&(u=x(u,[1,Math.tan(T(h.skewY)),0,1],!0)),u},composeMatrix:function(h){var m=[1,0,0,1,h.translateX||0,h.translateY||0],_=S.util.multiplyTransformMatrices;return h.angle&&(m=_(m,S.util.calcRotateMatrix(h))),(h.scaleX!==1||h.scaleY!==1||h.skewX||h.skewY||h.flipX||h.flipY)&&(m=_(m,S.util.calcDimensionsMatrix(h))),m},resetObjectTransform:function(h){h.scaleX=1,h.scaleY=1,h.skewX=0,h.skewY=0,h.flipX=!1,h.flipY=!1,h.rotate(0)},saveObjectTransform:function(h){return{scaleX:h.scaleX,scaleY:h.scaleY,skewX:h.skewX,skewY:h.skewY,angle:h.angle,left:h.left,flipX:h.flipX,flipY:h.flipY,top:h.top}},isTransparent:function(h,m,_,u){u>0&&(m>u?m-=u:m=0,_>u?_-=u:_=0);var x=!0,T,A,D=h.getImageData(m,_,u*2||1,u*2||1),V=D.data.length;for(T=3;T<V&&(A=D.data[T],x=A<=0,x!==!1);T+=4);return D=null,x},parsePreserveAspectRatioAttribute:function(h){var m="meet",_="Mid",u="Mid",x=h.split(" "),T;return x&&x.length&&(m=x.pop(),m!=="meet"&&m!=="slice"?(T=m,m="meet"):x.length&&(T=x.pop())),_=T!=="none"?T.slice(1,4):"none",u=T!=="none"?T.slice(5,8):"none",{meetOrSlice:m,alignX:_,alignY:u}},clearFabricFontCache:function(h){h=(h||"").toLowerCase(),h?S.charWidthsCache[h]&&delete S.charWidthsCache[h]:S.charWidthsCache={}},limitDimsByArea:function(h,m){var _=Math.sqrt(m*h),u=Math.floor(m/_);return{x:Math.floor(_),y:u}},capValue:function(h,m,_){return Math.max(h,Math.min(m,_))},findScaleToFit:function(h,m){return Math.min(m.width/h.width,m.height/h.height)},findScaleToCover:function(h,m){return Math.max(m.width/h.width,m.height/h.height)},matrixToSVG:function(h){return"matrix("+h.map(function(m){return S.util.toFixed(m,S.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(h,m){var _=S.util.invertTransform(m),u=S.util.multiplyTransformMatrices(_,h.calcOwnMatrix());S.util.applyTransformToObject(h,u)},addTransformToObject:function(h,m){S.util.applyTransformToObject(h,S.util.multiplyTransformMatrices(m,h.calcOwnMatrix()))},applyTransformToObject:function(h,m){var _=S.util.qrDecompose(m),u=new S.Point(_.translateX,_.translateY);h.flipX=!1,h.flipY=!1,h.set("scaleX",_.scaleX),h.set("scaleY",_.scaleY),h.skewX=_.skewX,h.skewY=_.skewY,h.angle=_.angle,h.setPositionByOrigin(u,"center","center")},sizeAfterTransform:function(h,m,_){var u=h/2,x=m/2,T=[{x:-u,y:-x},{x:u,y:-x},{x:-u,y:x},{x:u,y:x}],A=S.util.calcDimensionsMatrix(_),D=S.util.makeBoundingBoxFromPoints(T,A);return{x:D.width,y:D.height}},mergeClipPaths:function(h,m){var _=h,u=m;_.inverted&&!u.inverted&&(_=m,u=h),S.util.applyTransformToObject(u,S.util.multiplyTransformMatrices(S.util.invertTransform(_.calcTransformMatrix()),u.calcTransformMatrix()));var x=_.inverted&&u.inverted;return x&&(_.inverted=u.inverted=!1),new S.Group([_],{clipPath:u,inverted:x})},hasStyleChanged:function(h,m,_){return _=_||!1,h.fill!==m.fill||h.stroke!==m.stroke||h.strokeWidth!==m.strokeWidth||h.fontSize!==m.fontSize||h.fontFamily!==m.fontFamily||h.fontWeight!==m.fontWeight||h.fontStyle!==m.fontStyle||h.textBackgroundColor!==m.textBackgroundColor||h.deltaY!==m.deltaY||_&&(h.overline!==m.overline||h.underline!==m.underline||h.linethrough!==m.linethrough)},stylesToArray:function(_,m){for(var _=S.util.object.clone(_,!0),u=m.split(`
`),x=-1,T={},A=[],D=0;D<u.length;D++){if(!_[D]){x+=u[D].length;continue}for(var V=0;V<u[D].length;V++){x++;var X=_[D][V];if(X&&Object.keys(X).length>0){var ie=S.util.hasStyleChanged(T,X,!0);ie?A.push({start:x,end:x+1,style:X}):A[A.length-1].end++}T=X||{}}}return A},stylesFromArray:function(h,m){if(!Array.isArray(h))return h;for(var _=m.split(`
`),u=-1,x=0,T={},A=0;A<_.length;A++)for(var D=0;D<_[A].length;D++)u++,h[x]&&h[x].start<=u&&u<h[x].end&&(T[A]=T[A]||{},T[A][D]=Object.assign({},h[x].style),u===h[x].end-1&&x++);return T}}}($),function(){var s=Array.prototype.join,p={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},b={m:"l",M:"L"};function v(ee,be,me,ge,je,_e,te,Pe,Ne,et,He){var Ge=S.util.cos(ee),_t=S.util.sin(ee),It=S.util.cos(be),Xe=S.util.sin(be),Oe=me*je*It-ge*_e*Xe+te,ot=ge*je*It+me*_e*Xe+Pe,qe=et+Ne*(-me*je*_t-ge*_e*Ge),le=He+Ne*(-ge*je*_t+me*_e*Ge),ft=Oe+Ne*(me*je*Xe+ge*_e*It),Pt=ot+Ne*(ge*je*Xe-me*_e*It);return["C",qe,le,ft,Pt,Oe,ot]}function a(ee,be,me,ge,je,_e,te){var Pe=Math.PI,Ne=te*Pe/180,et=S.util.sin(Ne),He=S.util.cos(Ne),Ge=0,_t=0;me=Math.abs(me),ge=Math.abs(ge);var It=-He*ee*.5-et*be*.5,Xe=-He*be*.5+et*ee*.5,Oe=me*me,ot=ge*ge,qe=Xe*Xe,le=It*It,ft=Oe*ot-Oe*qe-ot*le,Pt=0;if(ft<0){var Tt=Math.sqrt(1-ft/(Oe*ot));me*=Tt,ge*=Tt}else Pt=(je===_e?-1:1)*Math.sqrt(ft/(Oe*qe+ot*le));var Nt=Pt*me*Xe/ge,lt=-Pt*ge*It/me,wt=He*Nt-et*lt+ee*.5,Yt=et*Nt+He*lt+be*.5,fi=l(1,0,(It-Nt)/me,(Xe-lt)/ge),mi=l((It-Nt)/me,(Xe-lt)/ge,(-It-Nt)/me,(-Xe-lt)/ge);_e===0&&mi>0?mi-=2*Pe:_e===1&&mi<0&&(mi+=2*Pe);for(var yi=Math.ceil(Math.abs(mi/Pe*2)),bi=[],ut=mi/yi,Gi=8/3*Math.sin(ut/4)*Math.sin(ut/4)/Math.sin(ut/2),Xi=fi+ut,rr=0;rr<yi;rr++)bi[rr]=v(fi,Xi,He,et,me,ge,wt,Yt,Gi,Ge,_t),Ge=bi[rr][5],_t=bi[rr][6],fi=Xi,Xi+=ut;return bi}function l(ee,be,me,ge){var je=Math.atan2(be,ee),_e=Math.atan2(ge,me);return _e>=je?_e-je:2*Math.PI-(je-_e)}function h(ee,be,me,ge,je,_e,te,Pe){var Ne;if(S.cachesBoundsOfCurve&&(Ne=s.call(arguments),S.boundsOfCurveCache[Ne]))return S.boundsOfCurveCache[Ne];var et=Math.sqrt,He=Math.min,Ge=Math.max,_t=Math.abs,It=[],Xe=[[],[]],Oe,ot,qe,le,ft,Pt,Tt,Nt;ot=6*ee-12*me+6*je,Oe=-3*ee+9*me-9*je+3*te,qe=3*me-3*ee;for(var lt=0;lt<2;++lt){if(lt>0&&(ot=6*be-12*ge+6*_e,Oe=-3*be+9*ge-9*_e+3*Pe,qe=3*ge-3*be),_t(Oe)<1e-12){if(_t(ot)<1e-12)continue;le=-qe/ot,0<le&&le<1&&It.push(le);continue}Tt=ot*ot-4*qe*Oe,!(Tt<0)&&(Nt=et(Tt),ft=(-ot+Nt)/(2*Oe),0<ft&&ft<1&&It.push(ft),Pt=(-ot-Nt)/(2*Oe),0<Pt&&Pt<1&&It.push(Pt))}for(var wt,Yt,fi=It.length,mi=fi,yi;fi--;)le=It[fi],yi=1-le,wt=yi*yi*yi*ee+3*yi*yi*le*me+3*yi*le*le*je+le*le*le*te,Xe[0][fi]=wt,Yt=yi*yi*yi*be+3*yi*yi*le*ge+3*yi*le*le*_e+le*le*le*Pe,Xe[1][fi]=Yt;Xe[0][mi]=ee,Xe[1][mi]=be,Xe[0][mi+1]=te,Xe[1][mi+1]=Pe;var bi=[{x:He.apply(null,Xe[0]),y:He.apply(null,Xe[1])},{x:Ge.apply(null,Xe[0]),y:Ge.apply(null,Xe[1])}];return S.cachesBoundsOfCurve&&(S.boundsOfCurveCache[Ne]=bi),bi}function m(ee,be,me){for(var ge=me[1],je=me[2],_e=me[3],te=me[4],Pe=me[5],Ne=me[6],et=me[7],He=a(Ne-ee,et-be,ge,je,te,Pe,_e),Ge=0,_t=He.length;Ge<_t;Ge++)He[Ge][1]+=ee,He[Ge][2]+=be,He[Ge][3]+=ee,He[Ge][4]+=be,He[Ge][5]+=ee,He[Ge][6]+=be;return He}function _(ee){var be=0,me=0,ge=ee.length,je=0,_e=0,te,Pe,Ne,et=[],He,Ge,_t;for(Pe=0;Pe<ge;++Pe){switch(Ne=!1,te=ee[Pe].slice(0),te[0]){case"l":te[0]="L",te[1]+=be,te[2]+=me;case"L":be=te[1],me=te[2];break;case"h":te[1]+=be;case"H":te[0]="L",te[2]=me,be=te[1];break;case"v":te[1]+=me;case"V":te[0]="L",me=te[1],te[1]=be,te[2]=me;break;case"m":te[0]="M",te[1]+=be,te[2]+=me;case"M":be=te[1],me=te[2],je=te[1],_e=te[2];break;case"c":te[0]="C",te[1]+=be,te[2]+=me,te[3]+=be,te[4]+=me,te[5]+=be,te[6]+=me;case"C":Ge=te[3],_t=te[4],be=te[5],me=te[6];break;case"s":te[0]="S",te[1]+=be,te[2]+=me,te[3]+=be,te[4]+=me;case"S":He==="C"?(Ge=2*be-Ge,_t=2*me-_t):(Ge=be,_t=me),be=te[3],me=te[4],te[0]="C",te[5]=te[3],te[6]=te[4],te[3]=te[1],te[4]=te[2],te[1]=Ge,te[2]=_t,Ge=te[3],_t=te[4];break;case"q":te[0]="Q",te[1]+=be,te[2]+=me,te[3]+=be,te[4]+=me;case"Q":Ge=te[1],_t=te[2],be=te[3],me=te[4];break;case"t":te[0]="T",te[1]+=be,te[2]+=me;case"T":He==="Q"?(Ge=2*be-Ge,_t=2*me-_t):(Ge=be,_t=me),te[0]="Q",be=te[1],me=te[2],te[1]=Ge,te[2]=_t,te[3]=be,te[4]=me;break;case"a":te[0]="A",te[6]+=be,te[7]+=me;case"A":Ne=!0,et=et.concat(m(be,me,te)),be=te[6],me=te[7];break;case"z":case"Z":be=je,me=_e;break}Ne||et.push(te),He=te[0]}return et}function u(ee,be,me,ge){return Math.sqrt((me-ee)*(me-ee)+(ge-be)*(ge-be))}function x(ee){return ee*ee*ee}function T(ee){return 3*ee*ee*(1-ee)}function A(ee){return 3*ee*(1-ee)*(1-ee)}function D(ee){return(1-ee)*(1-ee)*(1-ee)}function V(ee,be,me,ge,je,_e,te,Pe){return function(Ne){var et=x(Ne),He=T(Ne),Ge=A(Ne),_t=D(Ne);return{x:te*et+je*He+me*Ge+ee*_t,y:Pe*et+_e*He+ge*Ge+be*_t}}}function X(ee,be,me,ge,je,_e,te,Pe){return function(Ne){var et=1-Ne,He=3*et*et*(me-ee)+6*et*Ne*(je-me)+3*Ne*Ne*(te-je),Ge=3*et*et*(ge-be)+6*et*Ne*(_e-ge)+3*Ne*Ne*(Pe-_e);return Math.atan2(Ge,He)}}function ie(ee){return ee*ee}function ve(ee){return 2*ee*(1-ee)}function Fe(ee){return(1-ee)*(1-ee)}function Ye(ee,be,me,ge,je,_e){return function(te){var Pe=ie(te),Ne=ve(te),et=Fe(te);return{x:je*Pe+me*Ne+ee*et,y:_e*Pe+ge*Ne+be*et}}}function Ze(ee,be,me,ge,je,_e){return function(te){var Pe=1-te,Ne=2*Pe*(me-ee)+2*te*(je-me),et=2*Pe*(ge-be)+2*te*(_e-ge);return Math.atan2(et,Ne)}}function Je(ee,be,me){var ge={x:be,y:me},je,_e=0,te;for(te=1;te<=100;te+=1)je=ee(te/100),_e+=u(ge.x,ge.y,je.x,je.y),ge=je;return _e}function ct(ee,be){for(var me=0,ge=0,je=ee.iterator,_e={x:ee.x,y:ee.y},te,Pe,Ne=.01,et=ee.angleFinder,He;ge<be&&Ne>1e-4;)te=je(me),He=me,Pe=u(_e.x,_e.y,te.x,te.y),Pe+ge>be?(me-=Ne,Ne/=2):(_e=te,me+=Ne,ge+=Pe);return te.angle=et(He),te}function nt(ee){for(var be=0,me=ee.length,ge,je=0,_e=0,te=0,Pe=0,Ne=[],et,He,Ge,_t=0;_t<me;_t++){switch(ge=ee[_t],He={x:je,y:_e,command:ge[0]},ge[0]){case"M":He.length=0,te=je=ge[1],Pe=_e=ge[2];break;case"L":He.length=u(je,_e,ge[1],ge[2]),je=ge[1],_e=ge[2];break;case"C":et=V(je,_e,ge[1],ge[2],ge[3],ge[4],ge[5],ge[6]),Ge=X(je,_e,ge[1],ge[2],ge[3],ge[4],ge[5],ge[6]),He.iterator=et,He.angleFinder=Ge,He.length=Je(et,je,_e),je=ge[5],_e=ge[6];break;case"Q":et=Ye(je,_e,ge[1],ge[2],ge[3],ge[4]),Ge=Ze(je,_e,ge[1],ge[2],ge[3],ge[4]),He.iterator=et,He.angleFinder=Ge,He.length=Je(et,je,_e),je=ge[3],_e=ge[4];break;case"Z":case"z":He.destX=te,He.destY=Pe,He.length=u(je,_e,te,Pe),je=te,_e=Pe;break}be+=He.length,Ne.push(He)}return Ne.push({length:be,x:je,y:_e}),Ne}function vt(ee,be,me){me||(me=nt(ee));for(var ge=0;be-me[ge].length>0&&ge<me.length-2;)be-=me[ge].length,ge++;var je=me[ge],_e=be/je.length,te=je.command,Pe=ee[ge],Ne;switch(te){case"M":return{x:je.x,y:je.y,angle:0};case"Z":case"z":return Ne=new S.Point(je.x,je.y).lerp(new S.Point(je.destX,je.destY),_e),Ne.angle=Math.atan2(je.destY-je.y,je.destX-je.x),Ne;case"L":return Ne=new S.Point(je.x,je.y).lerp(new S.Point(Pe[1],Pe[2]),_e),Ne.angle=Math.atan2(Pe[2]-je.y,Pe[1]-je.x),Ne;case"C":return ct(je,be);case"Q":return ct(je,be)}}function Mt(ee){var be=[],me=[],ge,je,_e=S.rePathCommand,te="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",Pe="("+te+")"+S.commaWsp,Ne="([01])"+S.commaWsp+"?",et=Pe+"?"+Pe+"?"+Pe+Ne+Ne+Pe+"?("+te+")",He=new RegExp(et,"g"),Ge,_t,It;if(!ee||!ee.match)return be;It=ee.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi);for(var Xe=0,Oe,ot=It.length;Xe<ot;Xe++){ge=It[Xe],_t=ge.slice(1).trim(),me.length=0;var qe=ge.charAt(0);if(Oe=[qe],qe.toLowerCase()==="a")for(var le;le=He.exec(_t);)for(var ft=1;ft<le.length;ft++)me.push(le[ft]);else for(;Ge=_e.exec(_t);)me.push(Ge[0]);for(var ft=0,Pt=me.length;ft<Pt;ft++)je=parseFloat(me[ft]),isNaN(je)||Oe.push(je);var Tt=p[qe.toLowerCase()],Nt=b[qe]||qe;if(Oe.length-1>Tt)for(var lt=1,wt=Oe.length;lt<wt;lt+=Tt)be.push([qe].concat(Oe.slice(lt,lt+Tt))),qe=Nt;else be.push(Oe)}return be}function st(ee,be){var me=[],ge,je=new S.Point(ee[0].x,ee[0].y),_e=new S.Point(ee[1].x,ee[1].y),te=ee.length,Pe=1,Ne=0,et=te>2;for(be=be||0,et&&(Pe=ee[2].x<_e.x?-1:ee[2].x===_e.x?0:1,Ne=ee[2].y<_e.y?-1:ee[2].y===_e.y?0:1),me.push(["M",je.x-Pe*be,je.y-Ne*be]),ge=1;ge<te;ge++){if(!je.eq(_e)){var He=je.midPointFrom(_e);me.push(["Q",je.x,je.y,He.x,He.y])}je=ee[ge],ge+1<ee.length&&(_e=ee[ge+1])}return et&&(Pe=je.x>ee[ge-2].x?1:je.x===ee[ge-2].x?0:-1,Ne=je.y>ee[ge-2].y?1:je.y===ee[ge-2].y?0:-1),me.push(["L",je.x+Pe*be,je.y+Ne*be]),me}function bt(ee,be,me){return me&&(be=S.util.multiplyTransformMatrices(be,[1,0,0,1,-me.x,-me.y])),ee.map(function(ge){for(var je=ge.slice(0),_e={},te=1;te<ge.length-1;te+=2)_e.x=ge[te],_e.y=ge[te+1],_e=S.util.transformPoint(_e,be),je[te]=_e.x,je[te+1]=_e.y;return je})}S.util.joinPath=function(ee){return ee.map(function(be){return be.join(" ")}).join(" ")},S.util.parsePath=Mt,S.util.makePathSimpler=_,S.util.getSmoothPathFromPoints=st,S.util.getPathSegmentsInfo=nt,S.util.getBoundsOfCurve=h,S.util.getPointOnPath=vt,S.util.transformPath=bt}(),function(){var s=Array.prototype.slice;function p(h,m){for(var _=s.call(arguments,2),u=[],x=0,T=h.length;x<T;x++)u[x]=_.length?h[x][m].apply(h[x],_):h[x][m].call(h[x]);return u}function b(h,m){return l(h,m,function(_,u){return _>=u})}function v(h,m){return l(h,m,function(_,u){return _<u})}function a(h,m){for(var _=h.length;_--;)h[_]=m;return h}function l(h,m,_){if(!(!h||h.length===0)){var u=h.length-1,x=m?h[u][m]:h[u];if(m)for(;u--;)_(h[u][m],x)&&(x=h[u][m]);else for(;u--;)_(h[u],x)&&(x=h[u]);return x}}S.util.array={fill:a,invoke:p,min:v,max:b}}(),function(){function s(b,v,a){if(a)if(!S.isLikelyNode&&v instanceof Element)b=v;else if(v instanceof Array){b=[];for(var l=0,h=v.length;l<h;l++)b[l]=s({},v[l],a)}else if(v&&typeof v=="object")for(var m in v)m==="canvas"||m==="group"?b[m]=null:v.hasOwnProperty(m)&&(b[m]=s({},v[m],a));else b=v;else for(var m in v)b[m]=v[m];return b}function p(b,v){return s({},b,v)}S.util.object={extend:s,clone:p},S.util.object.extend(S.util,S.Observable)}(),function(){function s(l){return l.replace(/-+(.)?/g,function(h,m){return m?m.toUpperCase():""})}function p(l,h){return l.charAt(0).toUpperCase()+(h?l.slice(1):l.slice(1).toLowerCase())}function b(l){return l.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function v(l){var h=0,m,_=[];for(h=0,m;h<l.length;h++)(m=a(l,h))!==!1&&_.push(m);return _}function a(l,h){var m=l.charCodeAt(h);if(isNaN(m))return"";if(m<55296||m>57343)return l.charAt(h);if(55296<=m&&m<=56319){if(l.length<=h+1)throw"High surrogate without following low surrogate";var _=l.charCodeAt(h+1);if(56320>_||_>57343)throw"High surrogate without following low surrogate";return l.charAt(h)+l.charAt(h+1)}if(h===0)throw"Low surrogate without preceding high surrogate";var u=l.charCodeAt(h-1);if(55296>u||u>56319)throw"Low surrogate without preceding high surrogate";return!1}S.util.string={camelize:s,capitalize:p,escapeXml:b,graphemeSplit:v}}(),function(){var s=Array.prototype.slice,p=function(){},b=function(){for(var m in{toString:1})if(m==="toString")return!1;return!0}(),v=function(m,_,u){for(var x in _)x in m.prototype&&typeof m.prototype[x]=="function"&&(_[x]+"").indexOf("callSuper")>-1?m.prototype[x]=function(T){return function(){var A=this.constructor.superclass;this.constructor.superclass=u;var D=_[T].apply(this,arguments);if(this.constructor.superclass=A,T!=="initialize")return D}}(x):m.prototype[x]=_[x],b&&(_.toString!==Object.prototype.toString&&(m.prototype.toString=_.toString),_.valueOf!==Object.prototype.valueOf&&(m.prototype.valueOf=_.valueOf))};function a(){}function l(m){for(var _=null,u=this;u.constructor.superclass;){var x=u.constructor.superclass.prototype[m];if(u[m]!==x){_=x;break}u=u.constructor.superclass.prototype}return _?arguments.length>1?_.apply(this,s.call(arguments,1)):_.call(this):console.log("tried to callSuper "+m+", method not found in prototype chain",this)}function h(){var m=null,_=s.call(arguments,0);typeof _[0]=="function"&&(m=_.shift());function u(){this.initialize.apply(this,arguments)}u.superclass=m,u.subclasses=[],m&&(a.prototype=m.prototype,u.prototype=new a,m.subclasses.push(u));for(var x=0,T=_.length;x<T;x++)v(u,_[x],m);return u.prototype.initialize||(u.prototype.initialize=p),u.prototype.constructor=u,u.prototype.callSuper=l,u}S.util.createClass=h}(),function(){var s=!!S.document.createElement("div").attachEvent,p=["touchstart","touchmove","touchend"];S.util.addListener=function(v,a,l,h){v&&v.addEventListener(a,l,s?!1:h)},S.util.removeListener=function(v,a,l,h){v&&v.removeEventListener(a,l,s?!1:h)};function b(v){var a=v.changedTouches;return a&&a[0]?a[0]:v}S.util.getPointer=function(v){var a=v.target,l=S.util.getScrollLeftTop(a),h=b(v);return{x:h.clientX+l.left,y:h.clientY+l.top}},S.util.isTouchEvent=function(v){return p.indexOf(v.type)>-1||v.pointerType==="touch"}}(),function(){function s(h,m){var _=h.style;if(!_)return h;if(typeof m=="string")return h.style.cssText+=";"+m,m.indexOf("opacity")>-1?l(h,m.match(/opacity:\s*(\d?\.?\d*)/)[1]):h;for(var u in m)if(u==="opacity")l(h,m[u]);else{var x=u==="float"||u==="cssFloat"?typeof _.styleFloat>"u"?"cssFloat":"styleFloat":u;_.setProperty(x,m[u])}return h}var p=S.document.createElement("div"),b=typeof p.style.opacity=="string",v=typeof p.style.filter=="string",a=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,l=function(h){return h};b?l=function(h,m){return h.style.opacity=m,h}:v&&(l=function(h,m){var _=h.style;return h.currentStyle&&!h.currentStyle.hasLayout&&(_.zoom=1),a.test(_.filter)?(m=m>=.9999?"":"alpha(opacity="+m*100+")",_.filter=_.filter.replace(a,m)):_.filter+=" alpha(opacity="+m*100+")",h}),S.util.setStyle=s}(),function(){var s=Array.prototype.slice;function p(D){return typeof D=="string"?S.document.getElementById(D):D}var b,v=function(D){return s.call(D,0)};try{b=v(S.document.childNodes)instanceof Array}catch{}b||(v=function(D){for(var V=new Array(D.length),X=D.length;X--;)V[X]=D[X];return V});function a(D,V){var X=S.document.createElement(D);for(var ie in V)ie==="class"?X.className=V[ie]:ie==="for"?X.htmlFor=V[ie]:X.setAttribute(ie,V[ie]);return X}function l(D,V){D&&(" "+D.className+" ").indexOf(" "+V+" ")===-1&&(D.className+=(D.className?" ":"")+V)}function h(D,V,X){return typeof V=="string"&&(V=a(V,X)),D.parentNode&&D.parentNode.replaceChild(V,D),V.appendChild(D),V}function m(D){for(var V=0,X=0,ie=S.document.documentElement,ve=S.document.body||{scrollLeft:0,scrollTop:0};D&&(D.parentNode||D.host)&&(D=D.parentNode||D.host,D===S.document?(V=ve.scrollLeft||ie.scrollLeft||0,X=ve.scrollTop||ie.scrollTop||0):(V+=D.scrollLeft||0,X+=D.scrollTop||0),!(D.nodeType===1&&D.style.position==="fixed")););return{left:V,top:X}}function _(D){var V,X=D&&D.ownerDocument,ie={left:0,top:0},ve={left:0,top:0},Fe,Ye={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!X)return ve;for(var Ze in Ye)ve[Ye[Ze]]+=parseInt(u(D,Ze),10)||0;return V=X.documentElement,typeof D.getBoundingClientRect<"u"&&(ie=D.getBoundingClientRect()),Fe=m(D),{left:ie.left+Fe.left-(V.clientLeft||0)+ve.left,top:ie.top+Fe.top-(V.clientTop||0)+ve.top}}var u;S.document.defaultView&&S.document.defaultView.getComputedStyle?u=function(D,V){var X=S.document.defaultView.getComputedStyle(D,null);return X?X[V]:void 0}:u=function(D,V){var X=D.style[V];return!X&&D.currentStyle&&(X=D.currentStyle[V]),X},function(){var D=S.document.documentElement.style,V="userSelect"in D?"userSelect":"MozUserSelect"in D?"MozUserSelect":"WebkitUserSelect"in D?"WebkitUserSelect":"KhtmlUserSelect"in D?"KhtmlUserSelect":"";function X(ve){return typeof ve.onselectstart<"u"&&(ve.onselectstart=S.util.falseFunction),V?ve.style[V]="none":typeof ve.unselectable=="string"&&(ve.unselectable="on"),ve}function ie(ve){return typeof ve.onselectstart<"u"&&(ve.onselectstart=null),V?ve.style[V]="":typeof ve.unselectable=="string"&&(ve.unselectable=""),ve}S.util.makeElementUnselectable=X,S.util.makeElementSelectable=ie}();function x(D){var V=S.jsdomImplForWrapper(D);return V._canvas||V._image}function T(D){if(S.isLikelyNode){var V=S.jsdomImplForWrapper(D);V&&(V._image=null,V._canvas=null,V._currentSrc=null,V._attributes=null,V._classList=null)}}function A(D,V){D.imageSmoothingEnabled=D.imageSmoothingEnabled||D.webkitImageSmoothingEnabled||D.mozImageSmoothingEnabled||D.msImageSmoothingEnabled||D.oImageSmoothingEnabled,D.imageSmoothingEnabled=V}S.util.setImageSmoothing=A,S.util.getById=p,S.util.toArray=v,S.util.addClass=l,S.util.makeElement=a,S.util.wrapElement=h,S.util.getScrollLeftTop=m,S.util.getElementOffset=_,S.util.getNodeCanvas=x,S.util.cleanUpJsdomNode=T}(),function(){function s(v,a){return v+(/\?/.test(v)?"&":"?")+a}function p(){}function b(v,a){a||(a={});var l=a.method?a.method.toUpperCase():"GET",h=a.onComplete||function(){},m=new S.window.XMLHttpRequest,_=a.body||a.parameters;return m.onreadystatechange=function(){m.readyState===4&&(h(m),m.onreadystatechange=p)},l==="GET"&&(_=null,typeof a.parameters=="string"&&(v=s(v,a.parameters))),m.open(l,v,!0),(l==="POST"||l==="PUT")&&m.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),m.send(_),m}S.util.request=b}(),S.log=console.log,S.warn=console.warn,function(){var s=S.util.object.extend,p=S.util.object.clone,b=[];S.util.object.extend(b,{cancelAll:function(){var x=this.splice(0);return x.forEach(function(T){T.cancel()}),x},cancelByCanvas:function(x){if(!x)return[];var T=this.filter(function(A){return typeof A.target=="object"&&A.target.canvas===x});return T.forEach(function(A){A.cancel()}),T},cancelByTarget:function(x){var T=this.findAnimationsByTarget(x);return T.forEach(function(A){A.cancel()}),T},findAnimationIndex:function(x){return this.indexOf(this.findAnimation(x))},findAnimation:function(x){return this.find(function(T){return T.cancel===x})},findAnimationsByTarget:function(x){return x?this.filter(function(T){return T.target===x}):[]}});function v(){return!1}function a(x,T,A,D){return-A*Math.cos(x/D*(Math.PI/2))+A+T}function l(x){x||(x={});var T=!1,A,D=function(){var V=S.runningAnimations.indexOf(A);return V>-1&&S.runningAnimations.splice(V,1)[0]};return A=s(p(x),{cancel:function(){return T=!0,D()},currentValue:"startValue"in x?x.startValue:0,completionRate:0,durationRate:0}),S.runningAnimations.push(A),_(function(V){var X=V||+new Date,ie=x.duration||500,ve=X+ie,Fe,Ye=x.onChange||v,Ze=x.abort||v,Je=x.onComplete||v,ct=x.easing||a,nt="startValue"in x?x.startValue.length>0:!1,vt="startValue"in x?x.startValue:0,Mt="endValue"in x?x.endValue:100,st=x.byValue||(nt?vt.map(function(bt,ee){return Mt[ee]-vt[ee]}):Mt-vt);x.onStart&&x.onStart(),function bt(ee){Fe=ee||+new Date;var be=Fe>ve?ie:Fe-X,me=be/ie,ge=nt?vt.map(function(_e,te){return ct(be,vt[te],st[te],ie)}):ct(be,vt,st,ie),je=Math.abs(nt?(ge[0]-vt[0])/st[0]:(ge-vt)/st);if(A.currentValue=nt?ge.slice():ge,A.completionRate=je,A.durationRate=me,!T){if(Ze(ge,je,me)){D();return}if(Fe>ve){A.currentValue=nt?Mt.slice():Mt,A.completionRate=1,A.durationRate=1,Ye(nt?Mt.slice():Mt,1,1),Je(Mt,1,1),D();return}else Ye(ge,je,me),_(bt)}}(X)}),A.cancel}var h=S.window.requestAnimationFrame||S.window.webkitRequestAnimationFrame||S.window.mozRequestAnimationFrame||S.window.oRequestAnimationFrame||S.window.msRequestAnimationFrame||function(x){return S.window.setTimeout(x,1e3/60)},m=S.window.cancelAnimationFrame||S.window.clearTimeout;function _(){return h.apply(S.window,arguments)}function u(){return m.apply(S.window,arguments)}S.util.animate=l,S.util.requestAnimFrame=_,S.util.cancelAnimFrame=u,S.runningAnimations=b}(),function(){function s(b,v,a){var l="rgba("+parseInt(b[0]+a*(v[0]-b[0]),10)+","+parseInt(b[1]+a*(v[1]-b[1]),10)+","+parseInt(b[2]+a*(v[2]-b[2]),10);return l+=","+(b&&v?parseFloat(b[3]+a*(v[3]-b[3])):1),l+=")",l}function p(b,v,a,l){var h=new S.Color(b).getSource(),m=new S.Color(v).getSource(),_=l.onComplete,u=l.onChange;return l=l||{},S.util.animate(S.util.object.extend(l,{duration:a||500,startValue:h,endValue:m,byValue:m,easing:function(x,T,A,D){var V=l.colorEasing?l.colorEasing(x,D):1-Math.cos(x/D*(Math.PI/2));return s(T,A,V)},onComplete:function(x,T,A){if(_)return _(s(m,m,0),T,A)},onChange:function(x,T,A){if(u){if(Array.isArray(x))return u(s(x,x,0),T,A);u(x,T,A)}}}))}S.util.animateColor=p}(),function(){function s(ee,be,me,ge){return ee<Math.abs(be)?(ee=be,ge=me/4):be===0&&ee===0?ge=me/(2*Math.PI)*Math.asin(1):ge=me/(2*Math.PI)*Math.asin(be/ee),{a:ee,c:be,p:me,s:ge}}function p(ee,be,me){return ee.a*Math.pow(2,10*(be-=1))*Math.sin((be*me-ee.s)*(2*Math.PI)/ee.p)}function b(ee,be,me,ge){return me*((ee=ee/ge-1)*ee*ee+1)+be}function v(ee,be,me,ge){return ee/=ge/2,ee<1?me/2*ee*ee*ee+be:me/2*((ee-=2)*ee*ee+2)+be}function a(ee,be,me,ge){return me*(ee/=ge)*ee*ee*ee+be}function l(ee,be,me,ge){return-me*((ee=ee/ge-1)*ee*ee*ee-1)+be}function h(ee,be,me,ge){return ee/=ge/2,ee<1?me/2*ee*ee*ee*ee+be:-me/2*((ee-=2)*ee*ee*ee-2)+be}function m(ee,be,me,ge){return me*(ee/=ge)*ee*ee*ee*ee+be}function _(ee,be,me,ge){return me*((ee=ee/ge-1)*ee*ee*ee*ee+1)+be}function u(ee,be,me,ge){return ee/=ge/2,ee<1?me/2*ee*ee*ee*ee*ee+be:me/2*((ee-=2)*ee*ee*ee*ee+2)+be}function x(ee,be,me,ge){return-me*Math.cos(ee/ge*(Math.PI/2))+me+be}function T(ee,be,me,ge){return me*Math.sin(ee/ge*(Math.PI/2))+be}function A(ee,be,me,ge){return-me/2*(Math.cos(Math.PI*ee/ge)-1)+be}function D(ee,be,me,ge){return ee===0?be:me*Math.pow(2,10*(ee/ge-1))+be}function V(ee,be,me,ge){return ee===ge?be+me:me*(-Math.pow(2,-10*ee/ge)+1)+be}function X(ee,be,me,ge){return ee===0?be:ee===ge?be+me:(ee/=ge/2,ee<1?me/2*Math.pow(2,10*(ee-1))+be:me/2*(-Math.pow(2,-10*--ee)+2)+be)}function ie(ee,be,me,ge){return-me*(Math.sqrt(1-(ee/=ge)*ee)-1)+be}function ve(ee,be,me,ge){return me*Math.sqrt(1-(ee=ee/ge-1)*ee)+be}function Fe(ee,be,me,ge){return ee/=ge/2,ee<1?-me/2*(Math.sqrt(1-ee*ee)-1)+be:me/2*(Math.sqrt(1-(ee-=2)*ee)+1)+be}function Ye(ee,be,me,ge){var je=1.70158,_e=0,te=me;if(ee===0)return be;if(ee/=ge,ee===1)return be+me;_e||(_e=ge*.3);var Pe=s(te,me,_e,je);return-p(Pe,ee,ge)+be}function Ze(ee,be,me,ge){var je=1.70158,_e=0,te=me;if(ee===0)return be;if(ee/=ge,ee===1)return be+me;_e||(_e=ge*.3);var Pe=s(te,me,_e,je);return Pe.a*Math.pow(2,-10*ee)*Math.sin((ee*ge-Pe.s)*(2*Math.PI)/Pe.p)+Pe.c+be}function Je(ee,be,me,ge){var je=1.70158,_e=0,te=me;if(ee===0)return be;if(ee/=ge/2,ee===2)return be+me;_e||(_e=ge*(.3*1.5));var Pe=s(te,me,_e,je);return ee<1?-.5*p(Pe,ee,ge)+be:Pe.a*Math.pow(2,-10*(ee-=1))*Math.sin((ee*ge-Pe.s)*(2*Math.PI)/Pe.p)*.5+Pe.c+be}function ct(ee,be,me,ge,je){return je===void 0&&(je=1.70158),me*(ee/=ge)*ee*((je+1)*ee-je)+be}function nt(ee,be,me,ge,je){return je===void 0&&(je=1.70158),me*((ee=ee/ge-1)*ee*((je+1)*ee+je)+1)+be}function vt(ee,be,me,ge,je){return je===void 0&&(je=1.70158),ee/=ge/2,ee<1?me/2*(ee*ee*(((je*=1.525)+1)*ee-je))+be:me/2*((ee-=2)*ee*(((je*=1.525)+1)*ee+je)+2)+be}function Mt(ee,be,me,ge){return me-st(ge-ee,0,me,ge)+be}function st(ee,be,me,ge){return(ee/=ge)<1/2.75?me*(7.5625*ee*ee)+be:ee<2/2.75?me*(7.5625*(ee-=1.5/2.75)*ee+.75)+be:ee<2.5/2.75?me*(7.5625*(ee-=2.25/2.75)*ee+.9375)+be:me*(7.5625*(ee-=2.625/2.75)*ee+.984375)+be}function bt(ee,be,me,ge){return ee<ge/2?Mt(ee*2,0,me,ge)*.5+be:st(ee*2-ge,0,me,ge)*.5+me*.5+be}S.util.ease={easeInQuad:function(ee,be,me,ge){return me*(ee/=ge)*ee+be},easeOutQuad:function(ee,be,me,ge){return-me*(ee/=ge)*(ee-2)+be},easeInOutQuad:function(ee,be,me,ge){return ee/=ge/2,ee<1?me/2*ee*ee+be:-me/2*(--ee*(ee-2)-1)+be},easeInCubic:function(ee,be,me,ge){return me*(ee/=ge)*ee*ee+be},easeOutCubic:b,easeInOutCubic:v,easeInQuart:a,easeOutQuart:l,easeInOutQuart:h,easeInQuint:m,easeOutQuint:_,easeInOutQuint:u,easeInSine:x,easeOutSine:T,easeInOutSine:A,easeInExpo:D,easeOutExpo:V,easeInOutExpo:X,easeInCirc:ie,easeOutCirc:ve,easeInOutCirc:Fe,easeInElastic:Ye,easeOutElastic:Ze,easeInOutElastic:Je,easeInBack:ct,easeOutBack:nt,easeInOutBack:vt,easeInBounce:Mt,easeOutBounce:st,easeInOutBounce:bt}}(),function(s){var p=s.fabric||(s.fabric={}),b=p.util.object.extend,v=p.util.object.clone,a=p.util.toFixed,l=p.util.parseUnit,h=p.util.multiplyTransformMatrices,m=["path","circle","polygon","polyline","ellipse","rect","line","image","text"],_=["symbol","image","marker","pattern","view","svg"],u=["pattern","defs","symbol","metadata","clipPath","mask","desc"],x=["symbol","g","a","svg","clipPath","defs"],T={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},A={stroke:"strokeOpacity",fill:"fillOpacity"},D="font-size",V="clip-path";p.svgValidTagNamesRegEx=ve(m),p.svgViewBoxElementsRegEx=ve(_),p.svgInvalidAncestorsRegEx=ve(u),p.svgValidParentsRegEx=ve(x),p.cssRules={},p.gradientDefs={},p.clipPaths={};function X(_e){return _e in T?T[_e]:_e}function ie(_e,te,Pe,Ne){var et=Array.isArray(te),He;if((_e==="fill"||_e==="stroke")&&te==="none")te="";else{if(_e==="strokeUniform")return te==="non-scaling-stroke";if(_e==="strokeDashArray")te==="none"?te=null:te=te.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(_e==="transformMatrix")Pe&&Pe.transformMatrix?te=h(Pe.transformMatrix,p.parseTransformAttribute(te)):te=p.parseTransformAttribute(te);else if(_e==="visible")te=te!=="none"&&te!=="hidden",Pe&&Pe.visible===!1&&(te=!1);else if(_e==="opacity")te=parseFloat(te),Pe&&typeof Pe.opacity<"u"&&(te*=Pe.opacity);else if(_e==="textAnchor")te=te==="start"?"left":te==="end"?"right":"center";else if(_e==="charSpacing")He=l(te,Ne)/Ne*1e3;else if(_e==="paintFirst"){var Ge=te.indexOf("fill"),_t=te.indexOf("stroke"),te="fill";(Ge>-1&&_t>-1&&_t<Ge||Ge===-1&&_t>-1)&&(te="stroke")}else{if(_e==="href"||_e==="xlink:href"||_e==="font")return te;if(_e==="imageSmoothing")return te==="optimizeQuality";He=et?te.map(l):l(te,Ne)}}return!et&&isNaN(He)?te:He}function ve(_e){return new RegExp("^("+_e.join("|")+")\\b","i")}function Fe(_e){for(var te in A)if(!(typeof _e[A[te]]>"u"||_e[te]==="")){if(typeof _e[te]>"u"){if(!p.Object.prototype[te])continue;_e[te]=p.Object.prototype[te]}if(_e[te].indexOf("url(")!==0){var Pe=new p.Color(_e[te]);_e[te]=Pe.setAlpha(a(Pe.getAlpha()*_e[A[te]],2)).toRgba()}}return _e}function Ye(_e,te){var Pe,Ne=[],et,He,Ge;for(He=0,Ge=te.length;He<Ge;He++)Pe=te[He],et=_e.getElementsByTagName(Pe),Ne=Ne.concat(Array.prototype.slice.call(et));return Ne}p.parseTransformAttribute=function(){function _e(lt,wt){var Yt=p.util.cos(wt[0]),fi=p.util.sin(wt[0]),mi=0,yi=0;wt.length===3&&(mi=wt[1],yi=wt[2]),lt[0]=Yt,lt[1]=fi,lt[2]=-fi,lt[3]=Yt,lt[4]=mi-(Yt*mi-fi*yi),lt[5]=yi-(fi*mi+Yt*yi)}function te(lt,wt){var Yt=wt[0],fi=wt.length===2?wt[1]:wt[0];lt[0]=Yt,lt[3]=fi}function Pe(lt,wt,Yt){lt[Yt]=Math.tan(p.util.degreesToRadians(wt[0]))}function Ne(lt,wt){lt[4]=wt[0],wt.length===2&&(lt[5]=wt[1])}var et=p.iMatrix,He=p.reNum,Ge=p.commaWsp,_t="(?:(skewX)\\s*\\(\\s*("+He+")\\s*\\))",It="(?:(skewY)\\s*\\(\\s*("+He+")\\s*\\))",Xe="(?:(rotate)\\s*\\(\\s*("+He+")(?:"+Ge+"("+He+")"+Ge+"("+He+"))?\\s*\\))",Oe="(?:(scale)\\s*\\(\\s*("+He+")(?:"+Ge+"("+He+"))?\\s*\\))",ot="(?:(translate)\\s*\\(\\s*("+He+")(?:"+Ge+"("+He+"))?\\s*\\))",qe="(?:(matrix)\\s*\\(\\s*("+He+")"+Ge+"("+He+")"+Ge+"("+He+")"+Ge+"("+He+")"+Ge+"("+He+")"+Ge+"("+He+")\\s*\\))",le="(?:"+qe+"|"+ot+"|"+Oe+"|"+Xe+"|"+_t+"|"+It+")",ft="(?:"+le+"(?:"+Ge+"*"+le+")*)",Pt="^\\s*(?:"+ft+"?)\\s*$",Tt=new RegExp(Pt),Nt=new RegExp(le,"g");return function(lt){var wt=et.concat(),Yt=[];if(!lt||lt&&!Tt.test(lt))return wt;lt.replace(Nt,function(mi){var yi=new RegExp(le).exec(mi).filter(function(Gi){return!!Gi}),bi=yi[1],ut=yi.slice(2).map(parseFloat);switch(bi){case"translate":Ne(wt,ut);break;case"rotate":ut[0]=p.util.degreesToRadians(ut[0]),_e(wt,ut);break;case"scale":te(wt,ut);break;case"skewX":Pe(wt,ut,2);break;case"skewY":Pe(wt,ut,1);break;case"matrix":wt=ut;break}Yt.push(wt.concat()),wt=et.concat()});for(var fi=Yt[0];Yt.length>1;)Yt.shift(),fi=p.util.multiplyTransformMatrices(fi,Yt[0]);return fi}}();function Ze(_e,te){var Pe,Ne;_e.replace(/;\s*$/,"").split(";").forEach(function(et){var He=et.split(":");Pe=He[0].trim().toLowerCase(),Ne=He[1].trim(),te[Pe]=Ne})}function Je(_e,te){var Pe,Ne;for(var et in _e)typeof _e[et]>"u"||(Pe=et.toLowerCase(),Ne=_e[et],te[Pe]=Ne)}function ct(_e,te){var Pe={};for(var Ne in p.cssRules[te])if(nt(_e,Ne.split(" ")))for(var et in p.cssRules[te][Ne])Pe[et]=p.cssRules[te][Ne][et];return Pe}function nt(_e,te){var Pe,Ne=!0;return Pe=Mt(_e,te.pop()),Pe&&te.length&&(Ne=vt(_e,te)),Pe&&Ne&&te.length===0}function vt(_e,te){for(var Pe,Ne=!0;_e.parentNode&&_e.parentNode.nodeType===1&&te.length;)Ne&&(Pe=te.pop()),_e=_e.parentNode,Ne=Mt(_e,Pe);return te.length===0}function Mt(_e,te){var Pe=_e.nodeName,Ne=_e.getAttribute("class"),et=_e.getAttribute("id"),He,Ge;if(He=new RegExp("^"+Pe,"i"),te=te.replace(He,""),et&&te.length&&(He=new RegExp("#"+et+"(?![a-zA-Z\\-]+)","i"),te=te.replace(He,"")),Ne&&te.length)for(Ne=Ne.split(" "),Ge=Ne.length;Ge--;)He=new RegExp("\\."+Ne[Ge]+"(?![a-zA-Z\\-]+)","i"),te=te.replace(He,"");return te.length===0}function st(_e,te){var Pe;if(_e.getElementById&&(Pe=_e.getElementById(te)),Pe)return Pe;var Ne,et,He,Ge=_e.getElementsByTagName("*");for(et=0,He=Ge.length;et<He;et++)if(Ne=Ge[et],te===Ne.getAttribute("id"))return Ne}function bt(_e){for(var te=Ye(_e,["use","svg:use"]),Pe=0;te.length&&Pe<te.length;){var Ne=te[Pe],et=Ne.getAttribute("xlink:href")||Ne.getAttribute("href");if(et===null)return;var He=et.slice(1),Ge=Ne.getAttribute("x")||0,_t=Ne.getAttribute("y")||0,It=st(_e,He).cloneNode(!0),Xe=(It.getAttribute("transform")||"")+" translate("+Ge+", "+_t+")",Oe,ot=te.length,qe,le,ft,Pt,Tt=p.svgNS;if(be(It),/^svg$/i.test(It.nodeName)){var Nt=It.ownerDocument.createElementNS(Tt,"g");for(le=0,ft=It.attributes,Pt=ft.length;le<Pt;le++)qe=ft.item(le),Nt.setAttributeNS(Tt,qe.nodeName,qe.nodeValue);for(;It.firstChild;)Nt.appendChild(It.firstChild);It=Nt}for(le=0,ft=Ne.attributes,Pt=ft.length;le<Pt;le++)qe=ft.item(le),!(qe.nodeName==="x"||qe.nodeName==="y"||qe.nodeName==="xlink:href"||qe.nodeName==="href")&&(qe.nodeName==="transform"?Xe=qe.nodeValue+" "+Xe:It.setAttribute(qe.nodeName,qe.nodeValue));It.setAttribute("transform",Xe),It.setAttribute("instantiated_by_use","1"),It.removeAttribute("id"),Oe=Ne.parentNode,Oe.replaceChild(It,Ne),te.length===ot&&Pe++}}var ee=new RegExp("^\\s*("+p.reNum+"+)\\s*,?\\s*("+p.reNum+"+)\\s*,?\\s*("+p.reNum+"+)\\s*,?\\s*("+p.reNum+"+)\\s*$");function be(_e){if(!p.svgViewBoxElementsRegEx.test(_e.nodeName))return{};var te=_e.getAttribute("viewBox"),Pe=1,Ne=1,et=0,He=0,Ge,_t,It,Xe,Oe=_e.getAttribute("width"),ot=_e.getAttribute("height"),qe=_e.getAttribute("x")||0,le=_e.getAttribute("y")||0,ft=_e.getAttribute("preserveAspectRatio")||"",Pt=!te||!(te=te.match(ee)),Tt=!Oe||!ot||Oe==="100%"||ot==="100%",Nt=Pt&&Tt,lt={},wt="",Yt=0,fi=0;if(lt.width=0,lt.height=0,lt.toBeParsed=Nt,Pt&&(qe||le)&&_e.parentNode&&_e.parentNode.nodeName!=="#document"&&(wt=" translate("+l(qe)+" "+l(le)+") ",It=(_e.getAttribute("transform")||"")+wt,_e.setAttribute("transform",It),_e.removeAttribute("x"),_e.removeAttribute("y")),Nt)return lt;if(Pt)return lt.width=l(Oe),lt.height=l(ot),lt;if(et=-parseFloat(te[1]),He=-parseFloat(te[2]),Ge=parseFloat(te[3]),_t=parseFloat(te[4]),lt.minX=et,lt.minY=He,lt.viewBoxWidth=Ge,lt.viewBoxHeight=_t,Tt?(lt.width=Ge,lt.height=_t):(lt.width=l(Oe),lt.height=l(ot),Pe=lt.width/Ge,Ne=lt.height/_t),ft=p.util.parsePreserveAspectRatioAttribute(ft),ft.alignX!=="none"&&(ft.meetOrSlice==="meet"&&(Ne=Pe=Pe>Ne?Ne:Pe),ft.meetOrSlice==="slice"&&(Ne=Pe=Pe>Ne?Pe:Ne),Yt=lt.width-Ge*Pe,fi=lt.height-_t*Pe,ft.alignX==="Mid"&&(Yt/=2),ft.alignY==="Mid"&&(fi/=2),ft.alignX==="Min"&&(Yt=0),ft.alignY==="Min"&&(fi=0)),Pe===1&&Ne===1&&et===0&&He===0&&qe===0&&le===0)return lt;if((qe||le)&&_e.parentNode.nodeName!=="#document"&&(wt=" translate("+l(qe)+" "+l(le)+") "),It=wt+" matrix("+Pe+" 0 0 "+Ne+" "+(et*Pe+Yt)+" "+(He*Ne+fi)+") ",_e.nodeName==="svg"){for(Xe=_e.ownerDocument.createElementNS(p.svgNS,"g");_e.firstChild;)Xe.appendChild(_e.firstChild);_e.appendChild(Xe)}else Xe=_e,Xe.removeAttribute("x"),Xe.removeAttribute("y"),It=Xe.getAttribute("transform")+It;return Xe.setAttribute("transform",It),lt}function me(_e,te){for(;_e&&(_e=_e.parentNode);)if(_e.nodeName&&te.test(_e.nodeName.replace("svg:",""))&&!_e.getAttribute("instantiated_by_use"))return!0;return!1}p.parseSVGDocument=function(_e,te,Pe,Ne){if(_e){bt(_e);var et=p.Object.__uid++,He,Ge,_t=be(_e),It=p.util.toArray(_e.getElementsByTagName("*"));if(_t.crossOrigin=Ne&&Ne.crossOrigin,_t.svgUid=et,It.length===0&&p.isLikelyNode){It=_e.selectNodes('//*[name(.)!="svg"]');var Xe=[];for(He=0,Ge=It.length;He<Ge;He++)Xe[He]=It[He];It=Xe}var Oe=It.filter(function(qe){return be(qe),p.svgValidTagNamesRegEx.test(qe.nodeName.replace("svg:",""))&&!me(qe,p.svgInvalidAncestorsRegEx)});if(!Oe||Oe&&!Oe.length){te&&te([],{});return}var ot={};It.filter(function(qe){return qe.nodeName.replace("svg:","")==="clipPath"}).forEach(function(qe){var le=qe.getAttribute("id");ot[le]=p.util.toArray(qe.getElementsByTagName("*")).filter(function(ft){return p.svgValidTagNamesRegEx.test(ft.nodeName.replace("svg:",""))})}),p.gradientDefs[et]=p.getGradientDefs(_e),p.cssRules[et]=p.getCSSRules(_e),p.clipPaths[et]=ot,p.parseElements(Oe,function(qe,le){te&&(te(qe,_t,le,It),delete p.gradientDefs[et],delete p.cssRules[et],delete p.clipPaths[et])},v(_t),Pe,Ne)}};function ge(_e,te){var Pe=["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"],Ne="xlink:href",et=te.getAttribute(Ne).slice(1),He=st(_e,et);if(He&&He.getAttribute(Ne)&&ge(_e,He),Pe.forEach(function(_t){He&&!te.hasAttribute(_t)&&He.hasAttribute(_t)&&te.setAttribute(_t,He.getAttribute(_t))}),!te.children.length)for(var Ge=He.cloneNode(!0);Ge.firstChild;)te.appendChild(Ge.firstChild);te.removeAttribute(Ne)}var je=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+p.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+p.reNum+"))?\\s+(.*)");b(p,{parseFontDeclaration:function(_e,te){var Pe=_e.match(je);if(Pe){var Ne=Pe[1],et=Pe[3],He=Pe[4],Ge=Pe[5],_t=Pe[6];Ne&&(te.fontStyle=Ne),et&&(te.fontWeight=isNaN(parseFloat(et))?et:parseFloat(et)),He&&(te.fontSize=l(He)),_t&&(te.fontFamily=_t),Ge&&(te.lineHeight=Ge==="normal"?1:Ge)}},getGradientDefs:function(_e){var te=["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"],Pe=Ye(_e,te),Ne,et=0,He={};for(et=Pe.length;et--;)Ne=Pe[et],Ne.getAttribute("xlink:href")&&ge(_e,Ne),He[Ne.getAttribute("id")]=Ne;return He},parseAttributes:function(_e,te,Pe){if(_e){var Ne,et={},He,Ge;typeof Pe>"u"&&(Pe=_e.getAttribute("svgUid")),_e.parentNode&&p.svgValidParentsRegEx.test(_e.parentNode.nodeName)&&(et=p.parseAttributes(_e.parentNode,te,Pe));var _t=te.reduce(function(ft,Pt){return Ne=_e.getAttribute(Pt),Ne&&(ft[Pt]=Ne),ft},{}),It=b(ct(_e,Pe),p.parseStyleAttribute(_e));_t=b(_t,It),It[V]&&_e.setAttribute(V,It[V]),He=Ge=et.fontSize||p.Text.DEFAULT_SVG_FONT_SIZE,_t[D]&&(_t[D]=He=l(_t[D],Ge));var Xe,Oe,ot={};for(var qe in _t)Xe=X(qe),Oe=ie(Xe,_t[qe],et,He),ot[Xe]=Oe;ot&&ot.font&&p.parseFontDeclaration(ot.font,ot);var le=b(et,ot);return p.svgValidParentsRegEx.test(_e.nodeName)?le:Fe(le)}},parseElements:function(_e,te,Pe,Ne,et){new p.ElementsParser(_e,te,Pe,Ne,et).parse()},parseStyleAttribute:function(_e){var te={},Pe=_e.getAttribute("style");return Pe&&(typeof Pe=="string"?Ze(Pe,te):Je(Pe,te)),te},parsePointsAttribute:function(_e){if(!_e)return null;_e=_e.replace(/,/g," ").trim(),_e=_e.split(/\s+/);var te=[],Pe,Ne;for(Pe=0,Ne=_e.length;Pe<Ne;Pe+=2)te.push({x:parseFloat(_e[Pe]),y:parseFloat(_e[Pe+1])});return te},getCSSRules:function(_e){var te=_e.getElementsByTagName("style"),Pe,Ne,et={},He;for(Pe=0,Ne=te.length;Pe<Ne;Pe++){var Ge=te[Pe].textContent;Ge=Ge.replace(/\/\*[\s\S]*?\*\//g,""),Ge.trim()!==""&&(He=Ge.split("}"),He=He.filter(function(_t){return _t.trim()}),He.forEach(function(_t){var It=_t.split("{"),Xe={},Oe=It[1].trim(),ot=Oe.split(";").filter(function(Pt){return Pt.trim()});for(Pe=0,Ne=ot.length;Pe<Ne;Pe++){var qe=ot[Pe].split(":"),le=qe[0].trim(),ft=qe[1].trim();Xe[le]=ft}_t=It[0].trim(),_t.split(",").forEach(function(Pt){Pt=Pt.replace(/^svg/i,"").trim(),Pt!==""&&(et[Pt]?p.util.object.extend(et[Pt],Xe):et[Pt]=p.util.object.clone(Xe))})}))}return et},loadSVGFromURL:function(_e,te,Pe,Ne){_e=_e.replace(/^\n\s*/,"").trim(),new p.util.request(_e,{method:"get",onComplete:et});function et(He){var Ge=He.responseXML;if(!Ge||!Ge.documentElement)return te&&te(null),!1;p.parseSVGDocument(Ge.documentElement,function(_t,It,Xe,Oe){te&&te(_t,It,Xe,Oe)},Pe,Ne)}},loadSVGFromString:function(_e,te,Pe,Ne){var et=new p.window.DOMParser,He=et.parseFromString(_e.trim(),"text/xml");p.parseSVGDocument(He.documentElement,function(Ge,_t,It,Xe){te(Ge,_t,It,Xe)},Pe,Ne)}})}($),S.ElementsParser=function(s,p,b,v,a,l){this.elements=s,this.callback=p,this.options=b,this.reviver=v,this.svgUid=b&&b.svgUid||0,this.parsingOptions=a,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=l},function(s){s.parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},s.createObjects=function(){var p=this;this.elements.forEach(function(b,v){b.setAttribute("svgUid",p.svgUid),p.createObject(b,v)})},s.findTag=function(p){return S[S.util.string.capitalize(p.tagName.replace("svg:",""))]},s.createObject=function(p,b){var v=this.findTag(p);if(v&&v.fromElement)try{v.fromElement(p,this.createCallback(b,p),this.options)}catch(a){S.log(a)}else this.checkIfDone()},s.createCallback=function(p,b){var v=this;return function(a){var l;v.resolveGradient(a,b,"fill"),v.resolveGradient(a,b,"stroke"),a instanceof S.Image&&a._originalElement&&(l=a.parsePreserveAspectRatioAttribute(b)),a._removeTransformMatrix(l),v.resolveClipPath(a,b),v.reviver&&v.reviver(b,a),v.instances[p]=a,v.checkIfDone()}},s.extractPropertyDefinition=function(p,b,v){var a=p[b],l=this.regexUrl;if(l.test(a)){l.lastIndex=0;var h=l.exec(a)[1];return l.lastIndex=0,S[v][this.svgUid][h]}},s.resolveGradient=function(p,b,v){var a=this.extractPropertyDefinition(p,v,"gradientDefs");if(a){var l=b.getAttribute(v+"-opacity"),h=S.Gradient.fromElement(a,p,l,this.options);p.set(v,h)}},s.createClipPathCallback=function(p,b){return function(v){v._removeTransformMatrix(),v.fillRule=v.clipRule,b.push(v)}},s.resolveClipPath=function(p,b){var v=this.extractPropertyDefinition(p,"clipPath","clipPaths"),a,l,h,m,_,u;if(v){m=[],h=S.util.invertTransform(p.calcTransformMatrix());for(var x=v[0].parentNode,T=b;T.parentNode&&T.getAttribute("clip-path")!==p.clipPath;)T=T.parentNode;T.parentNode.appendChild(x);for(var A=0;A<v.length;A++)a=v[A],l=this.findTag(a),l.fromElement(a,this.createClipPathCallback(p,m),this.options);m.length===1?v=m[0]:v=new S.Group(m),_=S.util.multiplyTransformMatrices(h,v.calcTransformMatrix()),v.clipPath&&this.resolveClipPath(v,T);var u=S.util.qrDecompose(_);v.flipX=!1,v.flipY=!1,v.set("scaleX",u.scaleX),v.set("scaleY",u.scaleY),v.angle=u.angle,v.skewX=u.skewX,v.skewY=0,v.setPositionByOrigin({x:u.translateX,y:u.translateY},"center","center"),p.clipPath=v}else delete p.clipPath},s.checkIfDone=function(){--this.numElements===0&&(this.instances=this.instances.filter(function(p){return p!=null}),this.callback(this.instances,this.elements))}}(S.ElementsParser.prototype),function(s){var p=s.fabric||(s.fabric={});if(p.Point){p.warn("fabric.Point is already defined");return}p.Point=b;function b(v,a){this.x=v,this.y=a}b.prototype={type:"point",constructor:b,add:function(v){return new b(this.x+v.x,this.y+v.y)},addEquals:function(v){return this.x+=v.x,this.y+=v.y,this},scalarAdd:function(v){return new b(this.x+v,this.y+v)},scalarAddEquals:function(v){return this.x+=v,this.y+=v,this},subtract:function(v){return new b(this.x-v.x,this.y-v.y)},subtractEquals:function(v){return this.x-=v.x,this.y-=v.y,this},scalarSubtract:function(v){return new b(this.x-v,this.y-v)},scalarSubtractEquals:function(v){return this.x-=v,this.y-=v,this},multiply:function(v){return new b(this.x*v,this.y*v)},multiplyEquals:function(v){return this.x*=v,this.y*=v,this},divide:function(v){return new b(this.x/v,this.y/v)},divideEquals:function(v){return this.x/=v,this.y/=v,this},eq:function(v){return this.x===v.x&&this.y===v.y},lt:function(v){return this.x<v.x&&this.y<v.y},lte:function(v){return this.x<=v.x&&this.y<=v.y},gt:function(v){return this.x>v.x&&this.y>v.y},gte:function(v){return this.x>=v.x&&this.y>=v.y},lerp:function(v,a){return typeof a>"u"&&(a=.5),a=Math.max(Math.min(1,a),0),new b(this.x+(v.x-this.x)*a,this.y+(v.y-this.y)*a)},distanceFrom:function(v){var a=this.x-v.x,l=this.y-v.y;return Math.sqrt(a*a+l*l)},midPointFrom:function(v){return this.lerp(v)},min:function(v){return new b(Math.min(this.x,v.x),Math.min(this.y,v.y))},max:function(v){return new b(Math.max(this.x,v.x),Math.max(this.y,v.y))},toString:function(){return this.x+","+this.y},setXY:function(v,a){return this.x=v,this.y=a,this},setX:function(v){return this.x=v,this},setY:function(v){return this.y=v,this},setFromPoint:function(v){return this.x=v.x,this.y=v.y,this},swap:function(v){var a=this.x,l=this.y;this.x=v.x,this.y=v.y,v.x=a,v.y=l},clone:function(){return new b(this.x,this.y)}}}($),function(s){var p=s.fabric||(s.fabric={});if(p.Intersection){p.warn("fabric.Intersection is already defined");return}function b(v){this.status=v,this.points=[]}p.Intersection=b,p.Intersection.prototype={constructor:b,appendPoint:function(v){return this.points.push(v),this},appendPoints:function(v){return this.points=this.points.concat(v),this}},p.Intersection.intersectLineLine=function(v,a,l,h){var m,_=(h.x-l.x)*(v.y-l.y)-(h.y-l.y)*(v.x-l.x),u=(a.x-v.x)*(v.y-l.y)-(a.y-v.y)*(v.x-l.x),x=(h.y-l.y)*(a.x-v.x)-(h.x-l.x)*(a.y-v.y);if(x!==0){var T=_/x,A=u/x;0<=T&&T<=1&&0<=A&&A<=1?(m=new b("Intersection"),m.appendPoint(new p.Point(v.x+T*(a.x-v.x),v.y+T*(a.y-v.y)))):m=new b}else _===0||u===0?m=new b("Coincident"):m=new b("Parallel");return m},p.Intersection.intersectLinePolygon=function(v,a,l){var h=new b,m=l.length,_,u,x,T;for(T=0;T<m;T++)_=l[T],u=l[(T+1)%m],x=b.intersectLineLine(v,a,_,u),h.appendPoints(x.points);return h.points.length>0&&(h.status="Intersection"),h},p.Intersection.intersectPolygonPolygon=function(v,a){var l=new b,h=v.length,m;for(m=0;m<h;m++){var _=v[m],u=v[(m+1)%h],x=b.intersectLinePolygon(_,u,a);l.appendPoints(x.points)}return l.points.length>0&&(l.status="Intersection"),l},p.Intersection.intersectPolygonRectangle=function(v,a,l){var h=a.min(l),m=a.max(l),_=new p.Point(m.x,h.y),u=new p.Point(h.x,m.y),x=b.intersectLinePolygon(h,_,v),T=b.intersectLinePolygon(_,m,v),A=b.intersectLinePolygon(m,u,v),D=b.intersectLinePolygon(u,h,v),V=new b;return V.appendPoints(x.points),V.appendPoints(T.points),V.appendPoints(A.points),V.appendPoints(D.points),V.points.length>0&&(V.status="Intersection"),V}}($),function(s){var p=s.fabric||(s.fabric={});if(p.Color){p.warn("fabric.Color is already defined.");return}function b(a){a?this._tryParsingColor(a):this.setSource([0,0,0,1])}p.Color=b,p.Color.prototype={_tryParsingColor:function(a){var l;a in b.colorNameMap&&(a=b.colorNameMap[a]),a==="transparent"&&(l=[255,255,255,0]),l||(l=b.sourceFromHex(a)),l||(l=b.sourceFromRgb(a)),l||(l=b.sourceFromHsl(a)),l||(l=[0,0,0,1]),l&&this.setSource(l)},_rgbToHsl:function(a,l,h){a/=255,l/=255,h/=255;var m,_,u,x=p.util.array.max([a,l,h]),T=p.util.array.min([a,l,h]);if(u=(x+T)/2,x===T)m=_=0;else{var A=x-T;switch(_=u>.5?A/(2-x-T):A/(x+T),x){case a:m=(l-h)/A+(l<h?6:0);break;case l:m=(h-a)/A+2;break;case h:m=(a-l)/A+4;break}m/=6}return[Math.round(m*360),Math.round(_*100),Math.round(u*100)]},getSource:function(){return this._source},setSource:function(a){this._source=a},toRgb:function(){var a=this.getSource();return"rgb("+a[0]+","+a[1]+","+a[2]+")"},toRgba:function(){var a=this.getSource();return"rgba("+a[0]+","+a[1]+","+a[2]+","+a[3]+")"},toHsl:function(){var a=this.getSource(),l=this._rgbToHsl(a[0],a[1],a[2]);return"hsl("+l[0]+","+l[1]+"%,"+l[2]+"%)"},toHsla:function(){var a=this.getSource(),l=this._rgbToHsl(a[0],a[1],a[2]);return"hsla("+l[0]+","+l[1]+"%,"+l[2]+"%,"+a[3]+")"},toHex:function(){var a=this.getSource(),l,h,m;return l=a[0].toString(16),l=l.length===1?"0"+l:l,h=a[1].toString(16),h=h.length===1?"0"+h:h,m=a[2].toString(16),m=m.length===1?"0"+m:m,l.toUpperCase()+h.toUpperCase()+m.toUpperCase()},toHexa:function(){var a=this.getSource(),l;return l=Math.round(a[3]*255),l=l.toString(16),l=l.length===1?"0"+l:l,this.toHex()+l.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(a){var l=this.getSource();return l[3]=a,this.setSource(l),this},toGrayscale:function(){var a=this.getSource(),l=parseInt((a[0]*.3+a[1]*.59+a[2]*.11).toFixed(0),10),h=a[3];return this.setSource([l,l,l,h]),this},toBlackWhite:function(a){var l=this.getSource(),h=(l[0]*.3+l[1]*.59+l[2]*.11).toFixed(0),m=l[3];return a=a||127,h=Number(h)<Number(a)?0:255,this.setSource([h,h,h,m]),this},overlayWith:function(a){a instanceof b||(a=new b(a));var l=[],h=this.getAlpha(),m=.5,_=this.getSource(),u=a.getSource(),x;for(x=0;x<3;x++)l.push(Math.round(_[x]*(1-m)+u[x]*m));return l[3]=h,this.setSource(l),this}},p.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,p.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,p.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,p.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"};function v(a,l,h){return h<0&&(h+=1),h>1&&(h-=1),h<1/6?a+(l-a)*6*h:h<1/2?l:h<2/3?a+(l-a)*(2/3-h)*6:a}p.Color.fromRgb=function(a){return b.fromSource(b.sourceFromRgb(a))},p.Color.sourceFromRgb=function(a){var l=a.match(b.reRGBa);if(l){var h=parseInt(l[1],10)/(/%$/.test(l[1])?100:1)*(/%$/.test(l[1])?255:1),m=parseInt(l[2],10)/(/%$/.test(l[2])?100:1)*(/%$/.test(l[2])?255:1),_=parseInt(l[3],10)/(/%$/.test(l[3])?100:1)*(/%$/.test(l[3])?255:1);return[parseInt(h,10),parseInt(m,10),parseInt(_,10),l[4]?parseFloat(l[4]):1]}},p.Color.fromRgba=b.fromRgb,p.Color.fromHsl=function(a){return b.fromSource(b.sourceFromHsl(a))},p.Color.sourceFromHsl=function(a){var l=a.match(b.reHSLa);if(l){var h=(parseFloat(l[1])%360+360)%360/360,m=parseFloat(l[2])/(/%$/.test(l[2])?100:1),_=parseFloat(l[3])/(/%$/.test(l[3])?100:1),u,x,T;if(m===0)u=x=T=_;else{var A=_<=.5?_*(m+1):_+m-_*m,D=_*2-A;u=v(D,A,h+1/3),x=v(D,A,h),T=v(D,A,h-1/3)}return[Math.round(u*255),Math.round(x*255),Math.round(T*255),l[4]?parseFloat(l[4]):1]}},p.Color.fromHsla=b.fromHsl,p.Color.fromHex=function(a){return b.fromSource(b.sourceFromHex(a))},p.Color.sourceFromHex=function(a){if(a.match(b.reHex)){var l=a.slice(a.indexOf("#")+1),h=l.length===3||l.length===4,m=l.length===8||l.length===4,_=h?l.charAt(0)+l.charAt(0):l.substring(0,2),u=h?l.charAt(1)+l.charAt(1):l.substring(2,4),x=h?l.charAt(2)+l.charAt(2):l.substring(4,6),T=m?h?l.charAt(3)+l.charAt(3):l.substring(6,8):"FF";return[parseInt(_,16),parseInt(u,16),parseInt(x,16),parseFloat((parseInt(T,16)/255).toFixed(2))]}},p.Color.fromSource=function(a){var l=new b;return l.setSource(a),l}}($),function(s){var p=s.fabric||(s.fabric={}),b=["e","se","s","sw","w","nw","n","ne","e"],v=["ns","nesw","ew","nwse"],a={},l="left",h="top",m="right",_="bottom",u="center",x={top:_,bottom:h,left:m,right:l,center:u},T=p.util.radiansToDegrees,A=Math.sign||function(Xe){return(Xe>0)-(Xe<0)||+Xe};function D(Xe,Oe){var ot=Xe.angle+T(Math.atan2(Oe.y,Oe.x))+360;return Math.round(ot%360/45)}function V(Xe,Oe){var ot=Oe.transform.target,qe=ot.canvas,le=p.util.object.clone(Oe);le.target=ot,qe&&qe.fire("object:"+Xe,le),ot.fire(Xe,Oe)}function X(Xe,Oe){var ot=Oe.canvas,qe=ot.uniScaleKey,le=Xe[qe];return ot.uniformScaling&&!le||!ot.uniformScaling&&le}function ie(Xe){return Xe.originX===u&&Xe.originY===u}function ve(Xe,Oe,ot){var qe=Xe.lockScalingX,le=Xe.lockScalingY;return!!(qe&&le||!Oe&&(qe||le)&&ot||qe&&Oe==="x"||le&&Oe==="y")}function Fe(Xe,Oe,ot){var qe="not-allowed",le=X(Xe,ot),ft="";if(Oe.x!==0&&Oe.y===0?ft="x":Oe.x===0&&Oe.y!==0&&(ft="y"),ve(ot,ft,le))return qe;var Pt=D(ot,Oe);return b[Pt]+"-resize"}function Ye(Xe,Oe,ot){var qe="not-allowed";if(Oe.x!==0&&ot.lockSkewingY||Oe.y!==0&&ot.lockSkewingX)return qe;var le=D(ot,Oe)%4;return v[le]+"-resize"}function Ze(Xe,Oe,ot){return Xe[ot.canvas.altActionKey]?a.skewCursorStyleHandler(Xe,Oe,ot):a.scaleCursorStyleHandler(Xe,Oe,ot)}function Je(Xe,Oe,ot){var qe=Xe[ot.canvas.altActionKey];if(Oe.x===0)return qe?"skewX":"scaleY";if(Oe.y===0)return qe?"skewY":"scaleX"}function ct(Xe,Oe,ot){return ot.lockRotation?"not-allowed":Oe.cursorStyle}function nt(Xe,Oe,ot,qe){return{e:Xe,transform:Oe,pointer:{x:ot,y:qe}}}function vt(Xe){return function(Oe,ot,qe,le){var ft=ot.target,Pt=ft.getCenterPoint(),Tt=ft.translateToOriginPoint(Pt,ot.originX,ot.originY),Nt=Xe(Oe,ot,qe,le);return ft.setPositionByOrigin(Tt,ot.originX,ot.originY),Nt}}function Mt(Xe,Oe){return function(ot,qe,le,ft){var Pt=Oe(ot,qe,le,ft);return Pt&&V(Xe,nt(ot,qe,le,ft)),Pt}}function st(Xe,Oe,ot,qe,le){var ft=Xe.target,Pt=ft.controls[Xe.corner],Tt=ft.canvas.getZoom(),Nt=ft.padding/Tt,lt=ft.toLocalPoint(new p.Point(qe,le),Oe,ot);return lt.x>=Nt&&(lt.x-=Nt),lt.x<=-Nt&&(lt.x+=Nt),lt.y>=Nt&&(lt.y-=Nt),lt.y<=Nt&&(lt.y+=Nt),lt.x-=Pt.offsetX,lt.y-=Pt.offsetY,lt}function bt(Xe){return Xe.flipX!==Xe.flipY}function ee(Xe,Oe,ot,qe,le){if(Xe[Oe]!==0){var ft=Xe._getTransformedDimensions()[qe],Pt=le/ft*Xe[ot];Xe.set(ot,Pt)}}function be(Xe,Oe,ot,qe){var le=Oe.target,ft=le._getTransformedDimensions(0,le.skewY),Pt=st(Oe,Oe.originX,Oe.originY,ot,qe),Tt=Math.abs(Pt.x*2)-ft.x,Nt=le.skewX,lt;Tt<2?lt=0:(lt=T(Math.atan2(Tt/le.scaleX,ft.y/le.scaleY)),Oe.originX===l&&Oe.originY===_&&(lt=-lt),Oe.originX===m&&Oe.originY===h&&(lt=-lt),bt(le)&&(lt=-lt));var wt=Nt!==lt;if(wt){var Yt=le._getTransformedDimensions().y;le.set("skewX",lt),ee(le,"skewY","scaleY","y",Yt)}return wt}function me(Xe,Oe,ot,qe){var le=Oe.target,ft=le._getTransformedDimensions(le.skewX,0),Pt=st(Oe,Oe.originX,Oe.originY,ot,qe),Tt=Math.abs(Pt.y*2)-ft.y,Nt=le.skewY,lt;Tt<2?lt=0:(lt=T(Math.atan2(Tt/le.scaleY,ft.x/le.scaleX)),Oe.originX===l&&Oe.originY===_&&(lt=-lt),Oe.originX===m&&Oe.originY===h&&(lt=-lt),bt(le)&&(lt=-lt));var wt=Nt!==lt;if(wt){var Yt=le._getTransformedDimensions().x;le.set("skewY",lt),ee(le,"skewX","scaleX","x",Yt)}return wt}function ge(Xe,Oe,ot,qe){var le=Oe.target,ft=le.skewX,Pt,Tt=Oe.originY;if(le.lockSkewingX)return!1;if(ft===0){var Nt=st(Oe,u,u,ot,qe);Nt.x>0?Pt=l:Pt=m}else ft>0&&(Pt=Tt===h?l:m),ft<0&&(Pt=Tt===h?m:l),bt(le)&&(Pt=Pt===l?m:l);Oe.originX=Pt;var lt=Mt("skewing",vt(be));return lt(Xe,Oe,ot,qe)}function je(Xe,Oe,ot,qe){var le=Oe.target,ft=le.skewY,Pt,Tt=Oe.originX;if(le.lockSkewingY)return!1;if(ft===0){var Nt=st(Oe,u,u,ot,qe);Nt.y>0?Pt=h:Pt=_}else ft>0&&(Pt=Tt===l?h:_),ft<0&&(Pt=Tt===l?_:h),bt(le)&&(Pt=Pt===h?_:h);Oe.originY=Pt;var lt=Mt("skewing",vt(me));return lt(Xe,Oe,ot,qe)}function _e(Xe,Oe,ot,qe){var le=Oe,ft=le.target,Pt=ft.translateToOriginPoint(ft.getCenterPoint(),le.originX,le.originY);if(ft.lockRotation)return!1;var Tt=Math.atan2(le.ey-Pt.y,le.ex-Pt.x),Nt=Math.atan2(qe-Pt.y,ot-Pt.x),lt=T(Nt-Tt+le.theta),wt=!0;if(ft.snapAngle>0){var Yt=ft.snapAngle,fi=ft.snapThreshold||Yt,mi=Math.ceil(lt/Yt)*Yt,yi=Math.floor(lt/Yt)*Yt;Math.abs(lt-yi)<fi?lt=yi:Math.abs(lt-mi)<fi&&(lt=mi)}return lt<0&&(lt=360+lt),lt%=360,wt=ft.angle!==lt,ft.angle=lt,wt}function te(Xe,Oe,ot,qe,le){le=le||{};var ft=Oe.target,Pt=ft.lockScalingX,Tt=ft.lockScalingY,Nt=le.by,lt,wt,Yt,fi,mi=X(Xe,ft),yi=ve(ft,Nt,mi),bi,ut,Gi=Oe.gestureScale;if(yi)return!1;if(Gi)wt=Oe.scaleX*Gi,Yt=Oe.scaleY*Gi;else{if(lt=st(Oe,Oe.originX,Oe.originY,ot,qe),bi=Nt!=="y"?A(lt.x):1,ut=Nt!=="x"?A(lt.y):1,Oe.signX||(Oe.signX=bi),Oe.signY||(Oe.signY=ut),ft.lockScalingFlip&&(Oe.signX!==bi||Oe.signY!==ut))return!1;if(fi=ft._getTransformedDimensions(),mi&&!Nt){var Xi=Math.abs(lt.x)+Math.abs(lt.y),rr=Oe.original,Qi=Math.abs(fi.x*rr.scaleX/ft.scaleX)+Math.abs(fi.y*rr.scaleY/ft.scaleY),Et=Xi/Qi;wt=rr.scaleX*Et,Yt=rr.scaleY*Et}else wt=Math.abs(lt.x*ft.scaleX/fi.x),Yt=Math.abs(lt.y*ft.scaleY/fi.y);ie(Oe)&&(wt*=2,Yt*=2),Oe.signX!==bi&&Nt!=="y"&&(Oe.originX=x[Oe.originX],wt*=-1,Oe.signX=bi),Oe.signY!==ut&&Nt!=="x"&&(Oe.originY=x[Oe.originY],Yt*=-1,Oe.signY=ut)}var ii=ft.scaleX,ai=ft.scaleY;return Nt?(Nt==="x"&&ft.set("scaleX",wt),Nt==="y"&&ft.set("scaleY",Yt)):(!Pt&&ft.set("scaleX",wt),!Tt&&ft.set("scaleY",Yt)),ii!==ft.scaleX||ai!==ft.scaleY}function Pe(Xe,Oe,ot,qe){return te(Xe,Oe,ot,qe)}function Ne(Xe,Oe,ot,qe){return te(Xe,Oe,ot,qe,{by:"x"})}function et(Xe,Oe,ot,qe){return te(Xe,Oe,ot,qe,{by:"y"})}function He(Xe,Oe,ot,qe){return Xe[Oe.target.canvas.altActionKey]?a.skewHandlerX(Xe,Oe,ot,qe):a.scalingY(Xe,Oe,ot,qe)}function Ge(Xe,Oe,ot,qe){return Xe[Oe.target.canvas.altActionKey]?a.skewHandlerY(Xe,Oe,ot,qe):a.scalingX(Xe,Oe,ot,qe)}function _t(Xe,Oe,ot,qe){var le=Oe.target,ft=st(Oe,Oe.originX,Oe.originY,ot,qe),Pt=le.strokeWidth/(le.strokeUniform?le.scaleX:1),Tt=ie(Oe)?2:1,Nt=le.width,lt=Math.abs(ft.x*Tt/le.scaleX)-Pt;return le.set("width",Math.max(lt,0)),Nt!==lt}function It(Xe,Oe,ot,qe){var le=Oe.target,ft=ot-Oe.offsetX,Pt=qe-Oe.offsetY,Tt=!le.get("lockMovementX")&&le.left!==ft,Nt=!le.get("lockMovementY")&&le.top!==Pt;return Tt&&le.set("left",ft),Nt&&le.set("top",Pt),(Tt||Nt)&&V("moving",nt(Xe,Oe,ot,qe)),Tt||Nt}a.scaleCursorStyleHandler=Fe,a.skewCursorStyleHandler=Ye,a.scaleSkewCursorStyleHandler=Ze,a.rotationWithSnapping=Mt("rotating",vt(_e)),a.scalingEqually=Mt("scaling",vt(Pe)),a.scalingX=Mt("scaling",vt(Ne)),a.scalingY=Mt("scaling",vt(et)),a.scalingYOrSkewingX=He,a.scalingXOrSkewingY=Ge,a.changeWidth=Mt("resizing",vt(_t)),a.skewHandlerX=ge,a.skewHandlerY=je,a.dragHandler=It,a.scaleOrSkewActionName=Je,a.rotationStyleHandler=ct,a.fireEvent=V,a.wrapWithFixedAnchor=vt,a.wrapWithFireEvent=Mt,a.getLocalPoint=st,p.controlsUtils=a}($),function(s){var p=s.fabric||(s.fabric={}),b=p.util.degreesToRadians,v=p.controlsUtils;function a(h,m,_,u,x){u=u||{};var T=this.sizeX||u.cornerSize||x.cornerSize,A=this.sizeY||u.cornerSize||x.cornerSize,D=typeof u.transparentCorners<"u"?u.transparentCorners:x.transparentCorners,V=D?"stroke":"fill",X=!D&&(u.cornerStrokeColor||x.cornerStrokeColor),ie=m,ve=_,Fe;h.save(),h.fillStyle=u.cornerColor||x.cornerColor,h.strokeStyle=u.cornerStrokeColor||x.cornerStrokeColor,T>A?(Fe=T,h.scale(1,A/T),ve=_*T/A):A>T?(Fe=A,h.scale(T/A,1),ie=m*A/T):Fe=T,h.lineWidth=1,h.beginPath(),h.arc(ie,ve,Fe/2,0,2*Math.PI,!1),h[V](),X&&h.stroke(),h.restore()}function l(h,m,_,u,x){u=u||{};var T=this.sizeX||u.cornerSize||x.cornerSize,A=this.sizeY||u.cornerSize||x.cornerSize,D=typeof u.transparentCorners<"u"?u.transparentCorners:x.transparentCorners,V=D?"stroke":"fill",X=!D&&(u.cornerStrokeColor||x.cornerStrokeColor),ie=T/2,ve=A/2;h.save(),h.fillStyle=u.cornerColor||x.cornerColor,h.strokeStyle=u.cornerStrokeColor||x.cornerStrokeColor,h.lineWidth=1,h.translate(m,_),h.rotate(b(x.angle)),h[V+"Rect"](-ie,-ve,T,A),X&&h.strokeRect(-ie,-ve,T,A),h.restore()}v.renderCircleControl=a,v.renderSquareControl=l}($),function(s){var p=s.fabric||(s.fabric={});function b(v){for(var a in v)this[a]=v[a]}p.Control=b,p.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(v,a){return a.cursorStyle},getActionName:function(v,a){return a.actionName},getVisibility:function(v,a){var l=v._controlsVisibility;return l&&typeof l[a]<"u"?l[a]:this.visible},setVisibility:function(v){this.visible=v},positionHandler:function(v,a){var l=p.util.transformPoint({x:this.x*v.x+this.offsetX,y:this.y*v.y+this.offsetY},a);return l},calcCornerCoords:function(v,a,l,h,m){var _,u,x,T,A=m?this.touchSizeX:this.sizeX,D=m?this.touchSizeY:this.sizeY;if(A&&D&&A!==D){var V=Math.atan2(D,A),X=Math.sqrt(A*A+D*D)/2,ie=V-p.util.degreesToRadians(v),ve=Math.PI/2-V-p.util.degreesToRadians(v);_=X*p.util.cos(ie),u=X*p.util.sin(ie),x=X*p.util.cos(ve),T=X*p.util.sin(ve)}else{var Fe=A&&D?A:a;X=Fe*.7071067812;var ie=p.util.degreesToRadians(45-v);_=x=X*p.util.cos(ie),u=T=X*p.util.sin(ie)}return{tl:{x:l-T,y:h-x},tr:{x:l+_,y:h-u},bl:{x:l-_,y:h+u},br:{x:l+T,y:h+x}}},render:function(v,a,l,h,m){switch(h=h||{},h.cornerStyle||m.cornerStyle){case"circle":p.controlsUtils.renderCircleControl.call(this,v,a,l,h,m);break;default:p.controlsUtils.renderSquareControl.call(this,v,a,l,h,m)}}}}($),function(){function s(l,h){var m=l.getAttribute("style"),_=l.getAttribute("offset")||0,u,x,T,A;if(_=parseFloat(_)/(/%$/.test(_)?100:1),_=_<0?0:_>1?1:_,m){var D=m.split(/\s*;\s*/);for(D[D.length-1]===""&&D.pop(),A=D.length;A--;){var V=D[A].split(/\s*:\s*/),X=V[0].trim(),ie=V[1].trim();X==="stop-color"?u=ie:X==="stop-opacity"&&(T=ie)}}return u||(u=l.getAttribute("stop-color")||"rgb(0,0,0)"),T||(T=l.getAttribute("stop-opacity")),u=new S.Color(u),x=u.getAlpha(),T=isNaN(parseFloat(T))?1:parseFloat(T),T*=x*h,{offset:_,color:u.toRgb(),opacity:T}}function p(l){return{x1:l.getAttribute("x1")||0,y1:l.getAttribute("y1")||0,x2:l.getAttribute("x2")||"100%",y2:l.getAttribute("y2")||0}}function b(l){return{x1:l.getAttribute("fx")||l.getAttribute("cx")||"50%",y1:l.getAttribute("fy")||l.getAttribute("cy")||"50%",r1:0,x2:l.getAttribute("cx")||"50%",y2:l.getAttribute("cy")||"50%",r2:l.getAttribute("r")||"50%"}}var v=S.util.object.clone;S.Gradient=S.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(l){l||(l={}),l.coords||(l.coords={});var h,m=this;Object.keys(l).forEach(function(_){m[_]=l[_]}),this.id?this.id+="_"+S.Object.__uid++:this.id=S.Object.__uid++,h={x1:l.coords.x1||0,y1:l.coords.y1||0,x2:l.coords.x2||0,y2:l.coords.y2||0},this.type==="radial"&&(h.r1=l.coords.r1||0,h.r2=l.coords.r2||0),this.coords=h,this.colorStops=l.colorStops.slice()},addColorStop:function(l){for(var h in l){var m=new S.Color(l[h]);this.colorStops.push({offset:parseFloat(h),color:m.toRgb(),opacity:m.getAlpha()})}return this},toObject:function(l){var h={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return S.util.populateWithProperties(this,h,l),h},toSVG:function(l,x){var m=v(this.coords,!0),_,u,x=x||{},T,A,D=v(this.colorStops,!0),V=m.r1>m.r2,X=this.gradientTransform?this.gradientTransform.concat():S.iMatrix.concat(),ie=-this.offsetX,ve=-this.offsetY,Fe=!!x.additionalTransform,Ye=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox";if(D.sort(function(vt,Mt){return vt.offset-Mt.offset}),Ye==="objectBoundingBox"?(ie/=l.width,ve/=l.height):(ie+=l.width/2,ve+=l.height/2),l.type==="path"&&this.gradientUnits!=="percentage"&&(ie-=l.pathOffset.x,ve-=l.pathOffset.y),X[4]-=ie,X[5]-=ve,A='id="SVGID_'+this.id+'" gradientUnits="'+Ye+'"',A+=' gradientTransform="'+(Fe?x.additionalTransform+" ":"")+S.util.matrixToSVG(X)+'" ',this.type==="linear"?T=["<linearGradient ",A,' x1="',m.x1,'" y1="',m.y1,'" x2="',m.x2,'" y2="',m.y2,`">
`]:this.type==="radial"&&(T=["<radialGradient ",A,' cx="',V?m.x1:m.x2,'" cy="',V?m.y1:m.y2,'" r="',V?m.r1:m.r2,'" fx="',V?m.x2:m.x1,'" fy="',V?m.y2:m.y1,`">
`]),this.type==="radial"){if(V)for(D=D.concat(),D.reverse(),_=0,u=D.length;_<u;_++)D[_].offset=1-D[_].offset;var Ze=Math.min(m.r1,m.r2);if(Ze>0){var Je=Math.max(m.r1,m.r2),ct=Ze/Je;for(_=0,u=D.length;_<u;_++)D[_].offset+=ct*(1-D[_].offset)}}for(_=0,u=D.length;_<u;_++){var nt=D[_];T.push("<stop ",'offset="',nt.offset*100+"%",'" style="stop-color:',nt.color,typeof nt.opacity<"u"?";stop-opacity: "+nt.opacity:";",`"/>
`)}return T.push(this.type==="linear"?`</linearGradient>
`:`</radialGradient>
`),T.join("")},toLive:function(l){var h,m=S.util.object.clone(this.coords),_,u;if(this.type){for(this.type==="linear"?h=l.createLinearGradient(m.x1,m.y1,m.x2,m.y2):this.type==="radial"&&(h=l.createRadialGradient(m.x1,m.y1,m.r1,m.x2,m.y2,m.r2)),_=0,u=this.colorStops.length;_<u;_++){var x=this.colorStops[_].color,T=this.colorStops[_].opacity,A=this.colorStops[_].offset;typeof T<"u"&&(x=new S.Color(x).setAlpha(T).toRgba()),h.addColorStop(A,x)}return h}}}),S.util.object.extend(S.Gradient,{fromElement:function(l,h,m,_){var u=parseFloat(m)/(/%$/.test(m)?100:1);u=u<0?0:u>1?1:u,isNaN(u)&&(u=1);var x=l.getElementsByTagName("stop"),T,A=l.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage",D=l.getAttribute("gradientTransform")||"",V=[],X,ie,ve=0,Fe=0,Ye;for(l.nodeName==="linearGradient"||l.nodeName==="LINEARGRADIENT"?(T="linear",X=p(l)):(T="radial",X=b(l)),ie=x.length;ie--;)V.push(s(x[ie],u));Ye=S.parseTransformAttribute(D),a(h,X,_,A),A==="pixels"&&(ve=-h.left,Fe=-h.top);var Ze=new S.Gradient({id:l.getAttribute("id"),type:T,coords:X,colorStops:V,gradientUnits:A,gradientTransform:Ye,offsetX:ve,offsetY:Fe});return Ze}});function a(l,h,m,_){var u,x;Object.keys(h).forEach(function(T){u=h[T],u==="Infinity"?x=1:u==="-Infinity"?x=0:(x=parseFloat(h[T],10),typeof u=="string"&&/^(\d+\.\d+)%|(\d+)%$/.test(u)&&(x*=.01,_==="pixels"&&((T==="x1"||T==="x2"||T==="r2")&&(x*=m.viewBoxWidth||m.width),(T==="y1"||T==="y2")&&(x*=m.viewBoxHeight||m.height)))),h[T]=x})}}(),function(){var s=S.util.toFixed;S.Pattern=S.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(p,b){if(p||(p={}),this.id=S.Object.__uid++,this.setOptions(p),!p.source||p.source&&typeof p.source!="string"){b&&b(this);return}else{var v=this;this.source=S.util.createImage(),S.util.loadImage(p.source,function(a,l){v.source=a,b&&b(v,l)},null,this.crossOrigin)}},toObject:function(p){var b=S.Object.NUM_FRACTION_DIGITS,v,a;return typeof this.source.src=="string"?v=this.source.src:typeof this.source=="object"&&this.source.toDataURL&&(v=this.source.toDataURL()),a={type:"pattern",source:v,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:s(this.offsetX,b),offsetY:s(this.offsetY,b),patternTransform:this.patternTransform?this.patternTransform.concat():null},S.util.populateWithProperties(this,a,p),a},toSVG:function(p){var b=typeof this.source=="function"?this.source():this.source,v=b.width/p.width,a=b.height/p.height,l=this.offsetX/p.width,h=this.offsetY/p.height,m="";return(this.repeat==="repeat-x"||this.repeat==="no-repeat")&&(a=1,h&&(a+=Math.abs(h))),(this.repeat==="repeat-y"||this.repeat==="no-repeat")&&(v=1,l&&(v+=Math.abs(l))),b.src?m=b.src:b.toDataURL&&(m=b.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+l+'" y="'+h+'" width="'+v+'" height="'+a+`">
<image x="0" y="0" width="`+b.width+'" height="'+b.height+'" xlink:href="'+m+`"></image>
</pattern>
`},setOptions:function(p){for(var b in p)this[b]=p[b]},toLive:function(p){var b=this.source;return!b||typeof b.src<"u"&&(!b.complete||b.naturalWidth===0||b.naturalHeight===0)?"":p.createPattern(b,this.repeat)}})}(),function(s){var p=s.fabric||(s.fabric={}),b=p.util.toFixed;if(p.Shadow){p.warn("fabric.Shadow is already defined.");return}p.Shadow=p.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(v){typeof v=="string"&&(v=this._parseShadow(v));for(var a in v)this[a]=v[a];this.id=p.Object.__uid++},_parseShadow:function(v){var a=v.trim(),l=p.Shadow.reOffsetsAndBlur.exec(a)||[],h=a.replace(p.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)";return{color:h.trim(),offsetX:parseFloat(l[1],10)||0,offsetY:parseFloat(l[2],10)||0,blur:parseFloat(l[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(v){var a=40,l=40,h=p.Object.NUM_FRACTION_DIGITS,m=p.util.rotateVector({x:this.offsetX,y:this.offsetY},p.util.degreesToRadians(-v.angle)),_=20,u=new p.Color(this.color);return v.width&&v.height&&(a=b((Math.abs(m.x)+this.blur)/v.width,h)*100+_,l=b((Math.abs(m.y)+this.blur)/v.height,h)*100+_),v.flipX&&(m.x*=-1),v.flipY&&(m.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+l+'%" height="'+(100+2*l)+'%" x="-'+a+'%" width="'+(100+2*a)+`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`+b(this.blur?this.blur/2:0,h)+`"></feGaussianBlur>
	<feOffset dx="`+b(m.x,h)+'" dy="'+b(m.y,h)+`" result="oBlur" ></feOffset>
	<feFlood flood-color="`+u.toRgb()+'" flood-opacity="'+u.getAlpha()+`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var v={},a=p.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(l){this[l]!==a[l]&&(v[l]=this[l])},this),v}}),p.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/}($),function(){if(S.StaticCanvas){S.warn("fabric.StaticCanvas is already defined.");return}var s=S.util.object.extend,p=S.util.getElementOffset,b=S.util.removeFromArray,v=S.util.toFixed,a=S.util.transformPoint,l=S.util.invertTransform,h=S.util.getNodeCanvas,m=S.util.createCanvasElement,_=new Error("Could not initialize `canvas` element");S.StaticCanvas=S.util.createClass(S.CommonMethods,{initialize:function(u,x){x||(x={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(u,x)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:S.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(u,x){var T=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(u),this._initOptions(x),this.interactive||this._initRetinaScaling(),x.overlayImage&&this.setOverlayImage(x.overlayImage,T),x.backgroundImage&&this.setBackgroundImage(x.backgroundImage,T),x.backgroundColor&&this.setBackgroundColor(x.backgroundColor,T),x.overlayColor&&this.setOverlayColor(x.overlayColor,T),this.calcOffset()},_isRetinaScaling:function(){return S.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,S.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var u=S.devicePixelRatio;this.__initRetinaScaling(u,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(u,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(u,x,T){x.setAttribute("width",this.width*u),x.setAttribute("height",this.height*u),T.scale(u,u)},calcOffset:function(){return this._offset=p(this.lowerCanvasEl),this},setOverlayImage:function(u,x,T){return this.__setBgOverlayImage("overlayImage",u,x,T)},setBackgroundImage:function(u,x,T){return this.__setBgOverlayImage("backgroundImage",u,x,T)},setOverlayColor:function(u,x){return this.__setBgOverlayColor("overlayColor",u,x)},setBackgroundColor:function(u,x){return this.__setBgOverlayColor("backgroundColor",u,x)},__setBgOverlayImage:function(u,x,T,A){return typeof x=="string"?S.util.loadImage(x,function(D,V){if(D){var X=new S.Image(D,A);this[u]=X,X.canvas=this}T&&T(D,V)},this,A&&A.crossOrigin):(A&&x.setOptions(A),this[u]=x,x&&(x.canvas=this),T&&T(x,!1)),this},__setBgOverlayColor:function(u,x,T){return this[u]=x,this._initGradient(x,u),this._initPattern(x,u,T),this},_createCanvasElement:function(){var u=m();if(!u||(u.style||(u.style={}),typeof u.getContext>"u"))throw _;return u},_initOptions:function(u){var x=this.lowerCanvasEl;this._setOptions(u),this.width=this.width||parseInt(x.width,10)||0,this.height=this.height||parseInt(x.height,10)||0,this.lowerCanvasEl.style&&(x.width=this.width,x.height=this.height,x.style.width=this.width+"px",x.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(u){u&&u.getContext?this.lowerCanvasEl=u:this.lowerCanvasEl=S.util.getById(u)||this._createCanvasElement(),S.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(u,x){return this.setDimensions({width:u},x)},setHeight:function(u,x){return this.setDimensions({height:u},x)},setDimensions:function(u,x){var T;x=x||{};for(var A in u)T=u[A],x.cssOnly||(this._setBackstoreDimension(A,u[A]),T+="px",this.hasLostContext=!0),x.backstoreOnly||this._setCssDimension(A,T);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),x.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(u,x){return this.lowerCanvasEl[u]=x,this.upperCanvasEl&&(this.upperCanvasEl[u]=x),this.cacheCanvasEl&&(this.cacheCanvasEl[u]=x),this[u]=x,this},_setCssDimension:function(u,x){return this.lowerCanvasEl.style[u]=x,this.upperCanvasEl&&(this.upperCanvasEl.style[u]=x),this.wrapperEl&&(this.wrapperEl.style[u]=x),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(u){var x=this._activeObject,T=this.backgroundImage,A=this.overlayImage,D,V,X;for(this.viewportTransform=u,V=0,X=this._objects.length;V<X;V++)D=this._objects[V],D.group||D.setCoords(!0);return x&&x.setCoords(),T&&T.setCoords(!0),A&&A.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(u,x){var T=u,A=this.viewportTransform.slice(0);u=a(u,l(this.viewportTransform)),A[0]=x,A[3]=x;var D=a(u,A);return A[4]+=T.x-D.x,A[5]+=T.y-D.y,this.setViewportTransform(A)},setZoom:function(u){return this.zoomToPoint(new S.Point(0,0),u),this},absolutePan:function(u){var x=this.viewportTransform.slice(0);return x[4]=-u.x,x[5]=-u.y,this.setViewportTransform(x)},relativePan:function(u){return this.absolutePan(new S.Point(-u.x-this.viewportTransform[4],-u.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(u){this.stateful&&u.setupState(),u._set("canvas",this),u.setCoords(),this.fire("object:added",{target:u}),u.fire("added")},_onObjectRemoved:function(u){this.fire("object:removed",{target:u}),u.fire("removed"),delete u.canvas},clearContext:function(u){return u.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var u=this.contextContainer;return this.renderCanvas(u,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=S.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var u={},x=this.width,T=this.height,A=l(this.viewportTransform);return u.tl=a({x:0,y:0},A),u.br=a({x,y:T},A),u.tr=new S.Point(u.br.x,u.tl.y),u.bl=new S.Point(u.tl.x,u.br.y),this.vptCoords=u,u},cancelRequestedRender:function(){this.isRendering&&(S.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(u,x){var T=this.viewportTransform,A=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(u),S.util.setImageSmoothing(u,this.imageSmoothingEnabled),this.fire("before:render",{ctx:u}),this._renderBackground(u),u.save(),u.transform(T[0],T[1],T[2],T[3],T[4],T[5]),this._renderObjects(u,x),u.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(u),A&&(A.canvas=this,A.shouldCache(),A._transformDone=!0,A.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(u)),this._renderOverlay(u),this.controlsAboveOverlay&&this.interactive&&this.drawControls(u),this.fire("after:render",{ctx:u})},drawClipPathOnCanvas:function(u){var x=this.viewportTransform,T=this.clipPath;u.save(),u.transform(x[0],x[1],x[2],x[3],x[4],x[5]),u.globalCompositeOperation="destination-in",T.transform(u),u.scale(1/T.zoomX,1/T.zoomY),u.drawImage(T._cacheCanvas,-T.cacheTranslationX,-T.cacheTranslationY),u.restore()},_renderObjects:function(u,x){var T,A;for(T=0,A=x.length;T<A;++T)x[T]&&x[T].render(u)},_renderBackgroundOrOverlay:function(u,x){var T=this[x+"Color"],A=this[x+"Image"],D=this.viewportTransform,V=this[x+"Vpt"];if(!(!T&&!A)){if(T){u.save(),u.beginPath(),u.moveTo(0,0),u.lineTo(this.width,0),u.lineTo(this.width,this.height),u.lineTo(0,this.height),u.closePath(),u.fillStyle=T.toLive?T.toLive(u,this):T,V&&u.transform(D[0],D[1],D[2],D[3],D[4],D[5]),u.transform(1,0,0,1,T.offsetX||0,T.offsetY||0);var X=T.gradientTransform||T.patternTransform;X&&u.transform(X[0],X[1],X[2],X[3],X[4],X[5]),u.fill(),u.restore()}A&&(u.save(),V&&u.transform(D[0],D[1],D[2],D[3],D[4],D[5]),A.render(u),u.restore())}},_renderBackground:function(u){this._renderBackgroundOrOverlay(u,"background")},_renderOverlay:function(u){this._renderBackgroundOrOverlay(u,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new S.Point(this.width/2,this.height/2)},centerObjectH:function(u){return this._centerObject(u,new S.Point(this.getCenterPoint().x,u.getCenterPoint().y))},centerObjectV:function(u){return this._centerObject(u,new S.Point(u.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(u){var x=this.getCenterPoint();return this._centerObject(u,x)},viewportCenterObject:function(u){var x=this.getVpCenter();return this._centerObject(u,x)},viewportCenterObjectH:function(u){var x=this.getVpCenter();return this._centerObject(u,new S.Point(x.x,u.getCenterPoint().y)),this},viewportCenterObjectV:function(u){var x=this.getVpCenter();return this._centerObject(u,new S.Point(u.getCenterPoint().x,x.y))},getVpCenter:function(){var u=this.getCenterPoint(),x=l(this.viewportTransform);return a(u,x)},_centerObject:function(u,x){return u.setPositionByOrigin(x,"center","center"),u.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(u){return this.toDatalessObject(u)},toObject:function(u){return this._toObjectMethod("toObject",u)},toDatalessObject:function(u){return this._toObjectMethod("toDatalessObject",u)},_toObjectMethod:function(u,x){var T=this.clipPath,A={version:S.version,objects:this._toObjects(u,x)};return T&&!T.excludeFromExport&&(A.clipPath=this._toObject(this.clipPath,u,x)),s(A,this.__serializeBgOverlay(u,x)),S.util.populateWithProperties(this,A,x),A},_toObjects:function(u,x){return this._objects.filter(function(T){return!T.excludeFromExport}).map(function(T){return this._toObject(T,u,x)},this)},_toObject:function(u,x,T){var A;this.includeDefaultValues||(A=u.includeDefaultValues,u.includeDefaultValues=!1);var D=u[x](T);return this.includeDefaultValues||(u.includeDefaultValues=A),D},__serializeBgOverlay:function(u,x){var T={},A=this.backgroundImage,D=this.overlayImage,V=this.backgroundColor,X=this.overlayColor;return V&&V.toObject?V.excludeFromExport||(T.background=V.toObject(x)):V&&(T.background=V),X&&X.toObject?X.excludeFromExport||(T.overlay=X.toObject(x)):X&&(T.overlay=X),A&&!A.excludeFromExport&&(T.backgroundImage=this._toObject(A,u,x)),D&&!D.excludeFromExport&&(T.overlayImage=this._toObject(D,u,x)),T},svgViewportTransformation:!0,toSVG:function(u,x){u||(u={}),u.reviver=x;var T=[];return this._setSVGPreamble(T,u),this._setSVGHeader(T,u),this.clipPath&&T.push('<g clip-path="url(#'+this.clipPath.clipPathId+`)" >
`),this._setSVGBgOverlayColor(T,"background"),this._setSVGBgOverlayImage(T,"backgroundImage",x),this._setSVGObjects(T,x),this.clipPath&&T.push(`</g>
`),this._setSVGBgOverlayColor(T,"overlay"),this._setSVGBgOverlayImage(T,"overlayImage",x),T.push("</svg>"),T.join("")},_setSVGPreamble:function(u,x){x.suppressPreamble||u.push('<?xml version="1.0" encoding="',x.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)},_setSVGHeader:function(u,x){var T=x.width||this.width,A=x.height||this.height,D,V='viewBox="0 0 '+this.width+" "+this.height+'" ',X=S.Object.NUM_FRACTION_DIGITS;x.viewBox?V='viewBox="'+x.viewBox.x+" "+x.viewBox.y+" "+x.viewBox.width+" "+x.viewBox.height+'" ':this.svgViewportTransformation&&(D=this.viewportTransform,V='viewBox="'+v(-D[4]/D[0],X)+" "+v(-D[5]/D[3],X)+" "+v(this.width/D[0],X)+" "+v(this.height/D[3],X)+'" '),u.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',T,'" ','height="',A,'" ',V,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",S.version,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(x),`</defs>
`)},createSVGClipPathMarkup:function(u){var x=this.clipPath;return x?(x.clipPathId="CLIPPATH_"+S.Object.__uid++,'<clipPath id="'+x.clipPathId+`" >
`+this.clipPath.toClipPathSVG(u.reviver)+`</clipPath>
`):""},createSVGRefElementsMarkup:function(){var u=this,x=["background","overlay"].map(function(T){var A=u[T+"Color"];if(A&&A.toLive){var D=u[T+"Vpt"],V=u.viewportTransform,X={width:u.width/(D?V[0]:1),height:u.height/(D?V[3]:1)};return A.toSVG(X,{additionalTransform:D?S.util.matrixToSVG(V):""})}});return x.join("")},createSVGFontFacesMarkup:function(){var u="",x={},T,A,D,V,X,ie,ve,Fe,Ye,Ze=S.fontPaths,Je=[];for(this._objects.forEach(function nt(vt){Je.push(vt),vt._objects&&vt._objects.forEach(nt)}),Fe=0,Ye=Je.length;Fe<Ye;Fe++)if(T=Je[Fe],A=T.fontFamily,!(T.type.indexOf("text")===-1||x[A]||!Ze[A])&&(x[A]=!0,!!T.styles)){D=T.styles;for(X in D){V=D[X];for(ve in V)ie=V[ve],A=ie.fontFamily,!x[A]&&Ze[A]&&(x[A]=!0)}}for(var ct in x)u+=[`		@font-face {
`,"			font-family: '",ct,`';
`,"			src: url('",Ze[ct],`');
`,`		}
`].join("");return u&&(u=['	<style type="text/css">',`<![CDATA[
`,u,"]]>",`</style>
`].join("")),u},_setSVGObjects:function(u,x){var T,A,D,V=this._objects;for(A=0,D=V.length;A<D;A++)T=V[A],!T.excludeFromExport&&this._setSVGObject(u,T,x)},_setSVGObject:function(u,x,T){u.push(x.toSVG(T))},_setSVGBgOverlayImage:function(u,x,T){this[x]&&!this[x].excludeFromExport&&this[x].toSVG&&u.push(this[x].toSVG(T))},_setSVGBgOverlayColor:function(u,x){var T=this[x+"Color"],A=this.viewportTransform,D=this.width,V=this.height;if(T)if(T.toLive){var X=T.repeat,ie=S.util.invertTransform(A),ve=this[x+"Vpt"],Fe=ve?S.util.matrixToSVG(ie):"";u.push('<rect transform="'+Fe+" translate(",D/2,",",V/2,')"',' x="',T.offsetX-D/2,'" y="',T.offsetY-V/2,'" ','width="',X==="repeat-y"||X==="no-repeat"?T.source.width:D,'" height="',X==="repeat-x"||X==="no-repeat"?T.source.height:V,'" fill="url(#SVGID_'+T.id+')"',`></rect>
`)}else u.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',T,'"',`></rect>
`)},sendToBack:function(u){if(!u)return this;var x=this._activeObject,T,A,D;if(u===x&&u.type==="activeSelection")for(D=x._objects,T=D.length;T--;)A=D[T],b(this._objects,A),this._objects.unshift(A);else b(this._objects,u),this._objects.unshift(u);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(u){if(!u)return this;var x=this._activeObject,T,A,D;if(u===x&&u.type==="activeSelection")for(D=x._objects,T=0;T<D.length;T++)A=D[T],b(this._objects,A),this._objects.push(A);else b(this._objects,u),this._objects.push(u);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(u,x){if(!u)return this;var T=this._activeObject,A,D,V,X,ie,ve=0;if(u===T&&u.type==="activeSelection")for(ie=T._objects,A=0;A<ie.length;A++)D=ie[A],V=this._objects.indexOf(D),V>0+ve&&(X=V-1,b(this._objects,D),this._objects.splice(X,0,D)),ve++;else V=this._objects.indexOf(u),V!==0&&(X=this._findNewLowerIndex(u,V,x),b(this._objects,u),this._objects.splice(X,0,u));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(u,x,T){var A,D;if(T)for(A=x,D=x-1;D>=0;--D){var V=u.intersectsWithObject(this._objects[D])||u.isContainedWithinObject(this._objects[D])||this._objects[D].isContainedWithinObject(u);if(V){A=D;break}}else A=x-1;return A},bringForward:function(u,x){if(!u)return this;var T=this._activeObject,A,D,V,X,ie,ve=0;if(u===T&&u.type==="activeSelection")for(ie=T._objects,A=ie.length;A--;)D=ie[A],V=this._objects.indexOf(D),V<this._objects.length-1-ve&&(X=V+1,b(this._objects,D),this._objects.splice(X,0,D)),ve++;else V=this._objects.indexOf(u),V!==this._objects.length-1&&(X=this._findNewUpperIndex(u,V,x),b(this._objects,u),this._objects.splice(X,0,u));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(u,x,T){var A,D,V;if(T)for(A=x,D=x+1,V=this._objects.length;D<V;++D){var X=u.intersectsWithObject(this._objects[D])||u.isContainedWithinObject(this._objects[D])||this._objects[D].isContainedWithinObject(u);if(X){A=D;break}}else A=x+1;return A},moveTo:function(u,x){return b(this._objects,u),this._objects.splice(x,0,u),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(S.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(u){u.dispose&&u.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),S.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),S.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),s(S.StaticCanvas.prototype,S.Observable),s(S.StaticCanvas.prototype,S.Collection),s(S.StaticCanvas.prototype,S.DataURLExporter),s(S.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(u){var x=m();if(!x||!x.getContext)return null;var T=x.getContext("2d");if(!T)return null;switch(u){case"setLineDash":return typeof T.setLineDash<"u";default:return null}}}),S.StaticCanvas.prototype.toJSON=S.StaticCanvas.prototype.toObject,S.isLikelyNode&&(S.StaticCanvas.prototype.createPNGStream=function(){var u=h(this.lowerCanvasEl);return u&&u.createPNGStream()},S.StaticCanvas.prototype.createJPEGStream=function(u){var x=h(this.lowerCanvasEl);return x&&x.createJPEGStream(u)})}(),S.BaseBrush=S.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(s){s.strokeStyle=this.color,s.lineWidth=this.width,s.lineCap=this.strokeLineCap,s.miterLimit=this.strokeMiterLimit,s.lineJoin=this.strokeLineJoin,s.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(s){var p=this.canvas.viewportTransform;s.save(),s.transform(p[0],p[1],p[2],p[3],p[4],p[5])},_setShadow:function(){if(this.shadow){var s=this.canvas,p=this.shadow,b=s.contextTop,v=s.getZoom();s&&s._isRetinaScaling()&&(v*=S.devicePixelRatio),b.shadowColor=p.color,b.shadowBlur=p.blur*v,b.shadowOffsetX=p.offsetX*v,b.shadowOffsetY=p.offsetY*v}},needsFullRender:function(){var s=new S.Color(this.color);return s.getAlpha()<1||!!this.shadow},_resetShadow:function(){var s=this.canvas.contextTop;s.shadowColor="",s.shadowBlur=s.shadowOffsetX=s.shadowOffsetY=0},_isOutSideCanvas:function(s){return s.x<0||s.x>this.canvas.getWidth()||s.y<0||s.y>this.canvas.getHeight()}}),function(){S.PencilBrush=S.util.createClass(S.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(s){this.canvas=s,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(s,p,b){var v=p.midPointFrom(b);return s.quadraticCurveTo(p.x,p.y,v.x,v.y),v},onMouseDown:function(s,p){this.canvas._isMainEvent(p.e)&&(this.drawStraightLine=p.e[this.straightLineKey],this._prepareForDrawing(s),this._captureDrawingPath(s),this._render())},onMouseMove:function(s,p){if(this.canvas._isMainEvent(p.e)&&(this.drawStraightLine=p.e[this.straightLineKey],!(this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s))&&this._captureDrawingPath(s)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var b=this._points,v=b.length,a=this.canvas.contextTop;this._saveAndTransform(a),this.oldEnd&&(a.beginPath(),a.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(a,b[v-2],b[v-1],!0),a.stroke(),a.restore()}},onMouseUp:function(s){return this.canvas._isMainEvent(s.e)?(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1):!0},_prepareForDrawing:function(s){var p=new S.Point(s.x,s.y);this._reset(),this._addPoint(p),this.canvas.contextTop.moveTo(p.x,p.y)},_addPoint:function(s){return this._points.length>1&&s.eq(this._points[this._points.length-1])?!1:(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(s),!0)},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(s){var p=new S.Point(s.x,s.y);return this._addPoint(p)},_render:function(s){var p,b,v=this._points[0],a=this._points[1];if(s=s||this.canvas.contextTop,this._saveAndTransform(s),s.beginPath(),this._points.length===2&&v.x===a.x&&v.y===a.y){var l=this.width/1e3;v=new S.Point(v.x,v.y),a=new S.Point(a.x,a.y),v.x-=l,a.x+=l}for(s.moveTo(v.x,v.y),p=1,b=this._points.length;p<b;p++)this._drawSegment(s,v,a),v=this._points[p],a=this._points[p+1];s.lineTo(v.x,v.y),s.stroke(),s.restore()},convertPointsToSVGPath:function(s){var p=this.width/1e3;return S.util.getSmoothPathFromPoints(s,p)},_isEmptySVGPath:function(s){var p=S.util.joinPath(s);return p==="M 0 0 Q 0 0 0 0 L 0 0"},createPath:function(s){var p=new S.Path(s,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,p.shadow=new S.Shadow(this.shadow)),p},decimatePoints:function(s,p){if(s.length<=2)return s;var b=this.canvas.getZoom(),v=Math.pow(p/b,2),a,l=s.length-1,h=s[0],m=[h],_;for(a=1;a<l-1;a++)_=Math.pow(h.x-s[a].x,2)+Math.pow(h.y-s[a].y,2),_>=v&&(h=s[a],m.push(h));return m.push(s[l]),m},_finalizeAndAddPath:function(){var s=this.canvas.contextTop;s.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var p=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(p)){this.canvas.requestRenderAll();return}var b=this.createPath(p);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:b}),this.canvas.add(b),this.canvas.requestRenderAll(),b.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:b})}})}(),S.CircleBrush=S.util.createClass(S.BaseBrush,{width:10,initialize:function(s){this.canvas=s,this.points=[]},drawDot:function(s){var p=this.addPoint(s),b=this.canvas.contextTop;this._saveAndTransform(b),this.dot(b,p),b.restore()},dot:function(s,p){s.fillStyle=p.fill,s.beginPath(),s.arc(p.x,p.y,p.radius,0,Math.PI*2,!1),s.closePath(),s.fill()},onMouseDown:function(s){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(s)},_render:function(){var s=this.canvas.contextTop,p,b,v=this.points;for(this._saveAndTransform(s),p=0,b=v.length;p<b;p++)this.dot(s,v[p]);s.restore()},onMouseMove:function(s){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(s),this._render()):this.drawDot(s))},onMouseUp:function(){var s=this.canvas.renderOnAddRemove,p,b;this.canvas.renderOnAddRemove=!1;var v=[];for(p=0,b=this.points.length;p<b;p++){var a=this.points[p],l=new S.Circle({radius:a.radius,left:a.x,top:a.y,originX:"center",originY:"center",fill:a.fill});this.shadow&&(l.shadow=new S.Shadow(this.shadow)),v.push(l)}var h=new S.Group(v);h.canvas=this.canvas,this.canvas.fire("before:path:created",{path:h}),this.canvas.add(h),this.canvas.fire("path:created",{path:h}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=s,this.canvas.requestRenderAll()},addPoint:function(s){var p=new S.Point(s.x,s.y),b=S.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,v=new S.Color(this.color).setAlpha(S.util.getRandomInt(0,100)/100).toRgba();return p.radius=b,p.fill=v,this.points.push(p),p}}),S.SprayBrush=S.util.createClass(S.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(s){this.canvas=s,this.sprayChunks=[]},onMouseDown:function(s){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(s),this.render(this.sprayChunkPoints)},onMouseMove:function(s){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s)||(this.addSprayChunk(s),this.render(this.sprayChunkPoints))},onMouseUp:function(){var s=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var p=[],b=0,v=this.sprayChunks.length;b<v;b++)for(var a=this.sprayChunks[b],l=0,h=a.length;l<h;l++){var m=new S.Rect({width:a[l].width,height:a[l].width,left:a[l].x+1,top:a[l].y+1,originX:"center",originY:"center",fill:this.color});p.push(m)}this.optimizeOverlapping&&(p=this._getOptimizedRects(p));var _=new S.Group(p);this.shadow&&_.set("shadow",new S.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:_}),this.canvas.add(_),this.canvas.fire("path:created",{path:_}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=s,this.canvas.requestRenderAll()},_getOptimizedRects:function(s){var p={},b,v,a;for(v=0,a=s.length;v<a;v++)b=s[v].left+""+s[v].top,p[b]||(p[b]=s[v]);var l=[];for(b in p)l.push(p[b]);return l},render:function(s){var p=this.canvas.contextTop,b,v;for(p.fillStyle=this.color,this._saveAndTransform(p),b=0,v=s.length;b<v;b++){var a=s[b];typeof a.opacity<"u"&&(p.globalAlpha=a.opacity),p.fillRect(a.x,a.y,a.width,a.width)}p.restore()},_render:function(){var s=this.canvas.contextTop,p,b;for(s.fillStyle=this.color,this._saveAndTransform(s),p=0,b=this.sprayChunks.length;p<b;p++)this.render(this.sprayChunks[p]);s.restore()},addSprayChunk:function(s){this.sprayChunkPoints=[];var p,b,v,a=this.width/2,l;for(l=0;l<this.density;l++){p=S.util.getRandomInt(s.x-a,s.x+a),b=S.util.getRandomInt(s.y-a,s.y+a),this.dotWidthVariance?v=S.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):v=this.dotWidth;var h=new S.Point(p,b);h.width=v,this.randomOpacity&&(h.opacity=S.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(h)}this.sprayChunks.push(this.sprayChunkPoints)}}),S.PatternBrush=S.util.createClass(S.PencilBrush,{getPatternSrc:function(){var s=20,p=5,b=S.util.createCanvasElement(),v=b.getContext("2d");return b.width=b.height=s+p,v.fillStyle=this.color,v.beginPath(),v.arc(s/2,s/2,s/2,0,Math.PI*2,!1),v.closePath(),v.fill(),b},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(s){return s.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(s){this.callSuper("_setBrushStyles",s),s.strokeStyle=this.getPattern(s)},createPath:function(s){var p=this.callSuper("createPath",s),b=p._getLeftTopCoords().scalarAdd(p.strokeWidth/2);return p.stroke=new S.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-b.x,offsetY:-b.y}),p}}),function(){var s=S.util.getPointer,p=S.util.degreesToRadians,b=S.util.isTouchEvent;S.Canvas=S.util.createClass(S.StaticCanvas,{initialize:function(a,l){l||(l={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(a,l),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=S.PencilBrush&&new S.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var a=this.getActiveObjects(),l,h,m;if(a.length>0&&!this.preserveObjectStacking){h=[],m=[];for(var _=0,u=this._objects.length;_<u;_++)l=this._objects[_],a.indexOf(l)===-1?h.push(l):m.push(l);a.length>1&&(this._activeObject._objects=m),h.push.apply(h,m)}else h=this._objects;return h},renderAll:function(){this.contextTopDirty&&!this._groupSelector&&!this.isDrawingMode&&(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var a=this.contextContainer;return this.renderCanvas(a,this._chooseObjectsToRender()),this},renderTopLayer:function(a){a.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(a),this.contextTopDirty=!0),a.restore()},renderTop:function(){var a=this.contextTop;return this.clearContext(a),this.renderTopLayer(a),this.fire("after:render"),this},_normalizePointer:function(a,l){var h=a.calcTransformMatrix(),m=S.util.invertTransform(h),_=this.restorePointerVpt(l);return S.util.transformPoint(_,m)},isTargetTransparent:function(a,l,h){if(a.shouldCache()&&a._cacheCanvas&&a!==this._activeObject){var m=this._normalizePointer(a,{x:l,y:h}),_=Math.max(a.cacheTranslationX+m.x*a.zoomX,0),u=Math.max(a.cacheTranslationY+m.y*a.zoomY,0),D=S.util.isTransparent(a._cacheContext,Math.round(_),Math.round(u),this.targetFindTolerance);return D}var x=this.contextCache,T=a.selectionBackgroundColor,A=this.viewportTransform;a.selectionBackgroundColor="",this.clearContext(x),x.save(),x.transform(A[0],A[1],A[2],A[3],A[4],A[5]),a.render(x),x.restore(),a.selectionBackgroundColor=T;var D=S.util.isTransparent(x,l,h,this.targetFindTolerance);return D},_isSelectionKeyPressed:function(a){var l=!1;return Array.isArray(this.selectionKey)?l=!!this.selectionKey.find(function(h){return a[h]===!0}):l=a[this.selectionKey],l},_shouldClearSelection:function(a,l){var h=this.getActiveObjects(),m=this._activeObject;return!l||l&&m&&h.length>1&&h.indexOf(l)===-1&&m!==l&&!this._isSelectionKeyPressed(a)||l&&!l.evented||l&&!l.selectable&&m&&m!==l},_shouldCenterTransform:function(a,l,h){if(a){var m;return l==="scale"||l==="scaleX"||l==="scaleY"||l==="resizing"?m=this.centeredScaling||a.centeredScaling:l==="rotate"&&(m=this.centeredRotation||a.centeredRotation),m?!h:h}},_getOriginFromCorner:function(a,l){var h={x:a.originX,y:a.originY};return l==="ml"||l==="tl"||l==="bl"?h.x="right":(l==="mr"||l==="tr"||l==="br")&&(h.x="left"),l==="tl"||l==="mt"||l==="tr"?h.y="bottom":(l==="bl"||l==="mb"||l==="br")&&(h.y="top"),h},_getActionFromCorner:function(a,l,h,m){if(!l||!a)return"drag";var _=m.controls[l];return _.getActionName(h,_,m)},_setupCurrentTransform:function(a,l,h){if(l){var m=this.getPointer(a),_=l.__corner,u=l.controls[_],x=h&&_?u.getActionHandler(a,l,u):S.controlsUtils.dragHandler,T=this._getActionFromCorner(h,_,a,l),A=this._getOriginFromCorner(l,_),D=a[this.centeredKey],V={target:l,action:T,actionHandler:x,corner:_,scaleX:l.scaleX,scaleY:l.scaleY,skewX:l.skewX,skewY:l.skewY,offsetX:m.x-l.left,offsetY:m.y-l.top,originX:A.x,originY:A.y,ex:m.x,ey:m.y,lastX:m.x,lastY:m.y,theta:p(l.angle),width:l.width*l.scaleX,shiftKey:a.shiftKey,altKey:D,original:S.util.saveObjectTransform(l)};this._shouldCenterTransform(l,T,D)&&(V.originX="center",V.originY="center"),V.original.originX=A.x,V.original.originY=A.y,this._currentTransform=V,this._beforeTransform(a)}},setCursor:function(a){this.upperCanvasEl.style.cursor=a},_drawSelection:function(a){var l=this._groupSelector,h=new S.Point(l.ex,l.ey),m=S.util.transformPoint(h,this.viewportTransform),_=new S.Point(l.ex+l.left,l.ey+l.top),u=S.util.transformPoint(_,this.viewportTransform),x=Math.min(m.x,u.x),T=Math.min(m.y,u.y),A=Math.max(m.x,u.x),D=Math.max(m.y,u.y),V=this.selectionLineWidth/2;this.selectionColor&&(a.fillStyle=this.selectionColor,a.fillRect(x,T,A-x,D-T)),!(!this.selectionLineWidth||!this.selectionBorderColor)&&(a.lineWidth=this.selectionLineWidth,a.strokeStyle=this.selectionBorderColor,x+=V,T+=V,A-=V,D-=V,S.Object.prototype._setLineDash.call(this,a,this.selectionDashArray),a.strokeRect(x,T,A-x,D-T))},findTarget:function(a,l){if(!this.skipTargetFind){var h=!0,m=this.getPointer(a,h),_=this._activeObject,u=this.getActiveObjects(),x,T,A=b(a),D=u.length>1&&!l||u.length===1;if(this.targets=[],D&&_._findTargetCorner(m,A)||u.length>1&&!l&&_===this._searchPossibleTargets([_],m))return _;if(u.length===1&&_===this._searchPossibleTargets([_],m))if(this.preserveObjectStacking)x=_,T=this.targets,this.targets=[];else return _;var V=this._searchPossibleTargets(this._objects,m);return a[this.altSelectionKey]&&V&&x&&V!==x&&(V=x,this.targets=T),V}},_checkTarget:function(a,l,h){if(l&&l.visible&&l.evented&&l.containsPoint(a))if((this.perPixelTargetFind||l.perPixelTargetFind)&&!l.isEditing){var m=this.isTargetTransparent(l,h.x,h.y);if(!m)return!0}else return!0},_searchPossibleTargets:function(a,l){for(var h,m=a.length,_;m--;){var u=a[m],x=u.group?this._normalizePointer(u.group,l):l;if(this._checkTarget(x,u,l)){h=a[m],h.subTargetCheck&&h instanceof S.Group&&(_=this._searchPossibleTargets(h._objects,l),_&&this.targets.push(_));break}}return h},restorePointerVpt:function(a){return S.util.transformPoint(a,S.util.invertTransform(this.viewportTransform))},getPointer:function(a,l){if(this._absolutePointer&&!l)return this._absolutePointer;if(this._pointer&&l)return this._pointer;var h=s(a),m=this.upperCanvasEl,_=m.getBoundingClientRect(),u=_.width||0,x=_.height||0,T;(!u||!x)&&("top"in _&&"bottom"in _&&(x=Math.abs(_.top-_.bottom)),"right"in _&&"left"in _&&(u=Math.abs(_.right-_.left))),this.calcOffset(),h.x=h.x-this._offset.left,h.y=h.y-this._offset.top,l||(h=this.restorePointerVpt(h));var A=this.getRetinaScaling();return A!==1&&(h.x/=A,h.y/=A),u===0||x===0?T={width:1,height:1}:T={width:m.width/u,height:m.height/x},{x:h.x*T.width,y:h.y*T.height}},_createUpperCanvas:function(){var a=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),l=this.lowerCanvasEl,h=this.upperCanvasEl;h?h.className="":(h=this._createCanvasElement(),this.upperCanvasEl=h),S.util.addClass(h,"upper-canvas "+a),this.wrapperEl.appendChild(h),this._copyCanvasStyle(l,h),this._applyCanvasStyle(h),this.contextTop=h.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=S.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),S.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),S.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(a){var l=this.width||a.width,h=this.height||a.height;S.util.setStyle(a,{position:"absolute",width:l+"px",height:h+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),a.width=l,a.height=h,S.util.makeElementUnselectable(a)},_copyCanvasStyle:function(a,l){l.style.cssText=a.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var a=this._activeObject;return a?a.type==="activeSelection"&&a._objects?a._objects.slice(0):[a]:[]},_onObjectRemoved:function(a){a===this._activeObject&&(this.fire("before:selection:cleared",{target:a}),this._discardActiveObject(),this.fire("selection:cleared",{target:a}),a.fire("deselected")),a===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",a)},_fireSelectionEvents:function(a,l){var h=!1,m=this.getActiveObjects(),_=[],u=[];a.forEach(function(x){m.indexOf(x)===-1&&(h=!0,x.fire("deselected",{e:l,target:x}),u.push(x))}),m.forEach(function(x){a.indexOf(x)===-1&&(h=!0,x.fire("selected",{e:l,target:x}),_.push(x))}),a.length>0&&m.length>0?h&&this.fire("selection:updated",{e:l,selected:_,deselected:u}):m.length>0?this.fire("selection:created",{e:l,selected:_}):a.length>0&&this.fire("selection:cleared",{e:l,deselected:u})},setActiveObject:function(a,l){var h=this.getActiveObjects();return this._setActiveObject(a,l),this._fireSelectionEvents(h,l),this},_setActiveObject:function(a,l){return this._activeObject===a||!this._discardActiveObject(l,a)||a.onSelect({e:l})?!1:(this._activeObject=a,!0)},_discardActiveObject:function(a,l){var h=this._activeObject;if(h){if(h.onDeselect({e:a,object:l}))return!1;this._activeObject=null}return!0},discardActiveObject:function(a){var l=this.getActiveObjects(),h=this.getActiveObject();return l.length&&this.fire("before:selection:cleared",{target:h,e:a}),this._discardActiveObject(a),this._fireSelectionEvents(l,a),this},dispose:function(){var a=this.wrapperEl;return this.removeListeners(),a.removeChild(this.upperCanvasEl),a.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach((function(l){S.util.cleanUpJsdomNode(this[l]),this[l]=void 0}).bind(this)),a.parentNode&&a.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,S.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(a){var l=this._activeObject;l&&l._renderControls(a)},_toObject:function(a,l,h){var m=this._realizeGroupTransformOnObject(a),_=this.callSuper("_toObject",a,l,h);return this._unwindGroupTransformOnObject(a,m),_},_realizeGroupTransformOnObject:function(a){if(a.group&&a.group.type==="activeSelection"&&this._activeObject===a.group){var l=["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"],h={};return l.forEach(function(m){h[m]=a[m]}),S.util.addTransformToObject(a,this._activeObject.calcOwnMatrix()),h}else return null},_unwindGroupTransformOnObject:function(a,l){l&&a.set(l)},_setSVGObject:function(a,l,h){var m=this._realizeGroupTransformOnObject(l);this.callSuper("_setSVGObject",a,l,h),this._unwindGroupTransformOnObject(l,m)},setViewportTransform:function(a){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),S.StaticCanvas.prototype.setViewportTransform.call(this,a)}});for(var v in S.StaticCanvas)v!=="prototype"&&(S.Canvas[v]=S.StaticCanvas[v])}(),function(){var s=S.util.addListener,p=S.util.removeListener,b=3,v=2,a=1,l={passive:!1};function h(m,_){return m.button&&m.button===_-1}S.util.object.extend(S.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(s,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(m,_){var u=this.upperCanvasEl,x=this._getEventPrefix();m(S.window,"resize",this._onResize),m(u,x+"down",this._onMouseDown),m(u,x+"move",this._onMouseMove,l),m(u,x+"out",this._onMouseOut),m(u,x+"enter",this._onMouseEnter),m(u,"wheel",this._onMouseWheel),m(u,"contextmenu",this._onContextMenu),m(u,"dblclick",this._onDoubleClick),m(u,"dragover",this._onDragOver),m(u,"dragenter",this._onDragEnter),m(u,"dragleave",this._onDragLeave),m(u,"drop",this._onDrop),this.enablePointerEvents||m(u,"touchstart",this._onTouchStart,l),typeof eventjs<"u"&&_ in eventjs&&(eventjs[_](u,"gesture",this._onGesture),eventjs[_](u,"drag",this._onDrag),eventjs[_](u,"orientation",this._onOrientationChange),eventjs[_](u,"shake",this._onShake),eventjs[_](u,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(p,"remove");var m=this._getEventPrefix();p(S.document,m+"up",this._onMouseUp),p(S.document,"touchend",this._onTouchEnd,l),p(S.document,m+"move",this._onMouseMove,l),p(S.document,"touchmove",this._onMouseMove,l)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(m,_){this.__onTransformGesture&&this.__onTransformGesture(m,_)},_onDrag:function(m,_){this.__onDrag&&this.__onDrag(m,_)},_onMouseWheel:function(m){this.__onMouseWheel(m)},_onMouseOut:function(m){var _=this._hoveredTarget;this.fire("mouse:out",{target:_,e:m}),this._hoveredTarget=null,_&&_.fire("mouseout",{e:m});var u=this;this._hoveredTargets.forEach(function(x){u.fire("mouse:out",{target:_,e:m}),x&&_.fire("mouseout",{e:m})}),this._hoveredTargets=[]},_onMouseEnter:function(m){!this._currentTransform&&!this.findTarget(m)&&(this.fire("mouse:over",{target:null,e:m}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(m,_){this.__onOrientationChange&&this.__onOrientationChange(m,_)},_onShake:function(m,_){this.__onShake&&this.__onShake(m,_)},_onLongPress:function(m,_){this.__onLongPress&&this.__onLongPress(m,_)},_onDragOver:function(m){m.preventDefault();var _=this._simpleEventHandler("dragover",m);this._fireEnterLeaveEvents(_,m)},_onDrop:function(m){return this._simpleEventHandler("drop:before",m),this._simpleEventHandler("drop",m)},_onContextMenu:function(m){return this.stopContextMenu&&(m.stopPropagation(),m.preventDefault()),!1},_onDoubleClick:function(m){this._cacheTransformEventData(m),this._handleEvent(m,"dblclick"),this._resetTransformEventData(m)},getPointerId:function(m){var _=m.changedTouches;return _?_[0]&&_[0].identifier:this.enablePointerEvents?m.pointerId:-1},_isMainEvent:function(m){return m.isPrimary===!0?!0:m.isPrimary===!1?!1:m.type==="touchend"&&m.touches.length===0?!0:m.changedTouches?m.changedTouches[0].identifier===this.mainTouchId:!0},_onTouchStart:function(m){m.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(m)),this.__onMouseDown(m),this._resetTransformEventData();var _=this.upperCanvasEl,u=this._getEventPrefix();s(S.document,"touchend",this._onTouchEnd,l),s(S.document,"touchmove",this._onMouseMove,l),p(_,u+"down",this._onMouseDown)},_onMouseDown:function(m){this.__onMouseDown(m),this._resetTransformEventData();var _=this.upperCanvasEl,u=this._getEventPrefix();p(_,u+"move",this._onMouseMove,l),s(S.document,u+"up",this._onMouseUp),s(S.document,u+"move",this._onMouseMove,l)},_onTouchEnd:function(m){if(!(m.touches.length>0)){this.__onMouseUp(m),this._resetTransformEventData(),this.mainTouchId=null;var _=this._getEventPrefix();p(S.document,"touchend",this._onTouchEnd,l),p(S.document,"touchmove",this._onMouseMove,l);var u=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){s(u.upperCanvasEl,_+"down",u._onMouseDown),u._willAddMouseDown=0},400)}},_onMouseUp:function(m){this.__onMouseUp(m),this._resetTransformEventData();var _=this.upperCanvasEl,u=this._getEventPrefix();this._isMainEvent(m)&&(p(S.document,u+"up",this._onMouseUp),p(S.document,u+"move",this._onMouseMove,l),s(_,u+"move",this._onMouseMove,l))},_onMouseMove:function(m){!this.allowTouchScrolling&&m.preventDefault&&m.preventDefault(),this.__onMouseMove(m)},_onResize:function(){this.calcOffset()},_shouldRender:function(m){var _=this._activeObject;return!!_!=!!m||_&&m&&_!==m?!0:(_&&_.isEditing,!1)},__onMouseUp:function(m){var _,u=this._currentTransform,x=this._groupSelector,T=!1,A=!x||x.left===0&&x.top===0;if(this._cacheTransformEventData(m),_=this._target,this._handleEvent(m,"up:before"),h(m,b)){this.fireRightClick&&this._handleEvent(m,"up",b,A);return}if(h(m,v)){this.fireMiddleClick&&this._handleEvent(m,"up",v,A),this._resetTransformEventData();return}if(this.isDrawingMode&&this._isCurrentlyDrawing){this._onMouseUpInDrawingMode(m);return}if(this._isMainEvent(m)){if(u&&(this._finalizeCurrentTransform(m),T=u.actionPerformed),!A){var D=_===this._activeObject;this._maybeGroupObjects(m),T||(T=this._shouldRender(_)||!D&&_===this._activeObject)}var V,X;if(_){if(V=_._findTargetCorner(this.getPointer(m,!0),S.util.isTouchEvent(m)),_.selectable&&_!==this._activeObject&&_.activeOn==="up")this.setActiveObject(_,m),T=!0;else{var ie=_.controls[V],ve=ie&&ie.getMouseUpHandler(m,_,ie);ve&&(X=this.getPointer(m),ve(m,u,X.x,X.y))}_.isMoving=!1}if(u&&(u.target!==_||u.corner!==V)){var Fe=u.target&&u.target.controls[u.corner],Ye=Fe&&Fe.getMouseUpHandler(m,_,ie);X=X||this.getPointer(m),Ye&&Ye(m,u,X.x,X.y)}this._setCursorFromEvent(m,_),this._handleEvent(m,"up",a,A),this._groupSelector=null,this._currentTransform=null,_&&(_.__corner=0),T?this.requestRenderAll():A||this.renderTop()}},_simpleEventHandler:function(m,_){var u=this.findTarget(_),x=this.targets,T={e:_,target:u,subTargets:x};if(this.fire(m,T),u&&u.fire(m,T),!x)return u;for(var A=0;A<x.length;A++)x[A].fire(m,T);return u},_handleEvent:function(m,_,u,x){var T=this._target,A=this.targets||[],D={e:m,target:T,subTargets:A,button:u||a,isClick:x||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};_==="up"&&(D.currentTarget=this.findTarget(m),D.currentSubTargets=this.targets),this.fire("mouse:"+_,D),T&&T.fire("mouse"+_,D);for(var V=0;V<A.length;V++)A[V].fire("mouse"+_,D)},_finalizeCurrentTransform:function(m){var _=this._currentTransform,u=_.target,x={e:m,target:u,transform:_,action:_.action};u._scaling&&(u._scaling=!1),u.setCoords(),(_.actionPerformed||this.stateful&&u.hasStateChanged())&&this._fire("modified",x)},_onMouseDownInDrawingMode:function(m){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(m).requestRenderAll();var _=this.getPointer(m);this.freeDrawingBrush.onMouseDown(_,{e:m,pointer:_}),this._handleEvent(m,"down")},_onMouseMoveInDrawingMode:function(m){if(this._isCurrentlyDrawing){var _=this.getPointer(m);this.freeDrawingBrush.onMouseMove(_,{e:m,pointer:_})}this.setCursor(this.freeDrawingCursor),this._handleEvent(m,"move")},_onMouseUpInDrawingMode:function(m){var _=this.getPointer(m);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:m,pointer:_}),this._handleEvent(m,"up")},__onMouseDown:function(m){this._cacheTransformEventData(m),this._handleEvent(m,"down:before");var _=this._target;if(h(m,b)){this.fireRightClick&&this._handleEvent(m,"down",b);return}if(h(m,v)){this.fireMiddleClick&&this._handleEvent(m,"down",v);return}if(this.isDrawingMode){this._onMouseDownInDrawingMode(m);return}if(this._isMainEvent(m)&&!this._currentTransform){var u=this._pointer;this._previousPointer=u;var x=this._shouldRender(_),T=this._shouldGroup(m,_);if(this._shouldClearSelection(m,_)?this.discardActiveObject(m):T&&(this._handleGrouping(m,_),_=this._activeObject),this.selection&&(!_||!_.selectable&&!_.isEditing&&_!==this._activeObject)&&(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),_){var A=_===this._activeObject;_.selectable&&_.activeOn==="down"&&this.setActiveObject(_,m);var D=_._findTargetCorner(this.getPointer(m,!0),S.util.isTouchEvent(m));if(_.__corner=D,_===this._activeObject&&(D||!T)){this._setupCurrentTransform(m,_,A);var V=_.controls[D],u=this.getPointer(m),X=V&&V.getMouseDownHandler(m,_,V);X&&X(m,this._currentTransform,u.x,u.y)}}this._handleEvent(m,"down"),(x||T)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(m){this._resetTransformEventData(),this._pointer=this.getPointer(m,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(m)||null},_beforeTransform:function(m){var _=this._currentTransform;this.stateful&&_.target.saveState(),this.fire("before:transform",{e:m,transform:_})},__onMouseMove:function(m){this._handleEvent(m,"move:before"),this._cacheTransformEventData(m);var _,u;if(this.isDrawingMode){this._onMouseMoveInDrawingMode(m);return}if(this._isMainEvent(m)){var x=this._groupSelector;x?(u=this._absolutePointer,x.left=u.x-x.ex,x.top=u.y-x.ey,this.renderTop()):this._currentTransform?this._transformObject(m):(_=this.findTarget(m)||null,this._setCursorFromEvent(m,_),this._fireOverOutEvents(_,m)),this._handleEvent(m,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(m,_){var u=this._hoveredTarget,x=this._hoveredTargets,T=this.targets,A=Math.max(x.length,T.length);this.fireSyntheticInOutEvents(m,_,{oldTarget:u,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var D=0;D<A;D++)this.fireSyntheticInOutEvents(T[D],_,{oldTarget:x[D],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=m,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(m,_){var u=this._draggedoverTarget,x=this._hoveredTargets,T=this.targets,A=Math.max(x.length,T.length);this.fireSyntheticInOutEvents(m,_,{oldTarget:u,evtOut:"dragleave",evtIn:"dragenter"});for(var D=0;D<A;D++)this.fireSyntheticInOutEvents(T[D],_,{oldTarget:x[D],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=m},fireSyntheticInOutEvents:function(m,_,u){var x,T,A=u.oldTarget,D,V,X=A!==m,ie=u.canvasEvtIn,ve=u.canvasEvtOut;X&&(x={e:_,target:m,previousTarget:A},T={e:_,target:A,nextTarget:m}),V=m&&X,D=A&&X,D&&(ve&&this.fire(ve,T),A.fire(u.evtOut,T)),V&&(ie&&this.fire(ie,x),m.fire(u.evtIn,x))},__onMouseWheel:function(m){this._cacheTransformEventData(m),this._handleEvent(m,"wheel"),this._resetTransformEventData()},_transformObject:function(m){var _=this.getPointer(m),u=this._currentTransform;u.reset=!1,u.shiftKey=m.shiftKey,u.altKey=m[this.centeredKey],this._performTransformAction(m,u,_),u.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(m,_,u){var x=u.x,T=u.y,A=_.action,D=!1,V=_.actionHandler;V&&(D=V(m,_,x,T)),A==="drag"&&D&&(_.target.isMoving=!0,this.setCursor(_.target.moveCursor||this.moveCursor)),_.actionPerformed=_.actionPerformed||D},_fire:S.controlsUtils.fireEvent,_setCursorFromEvent:function(m,_){if(!_)return this.setCursor(this.defaultCursor),!1;var u=_.hoverCursor||this.hoverCursor,x=this._activeObject&&this._activeObject.type==="activeSelection"?this._activeObject:null,T=(!x||!x.contains(_))&&_._findTargetCorner(this.getPointer(m,!0));T?this.setCursor(this.getCornerCursor(T,_,m)):(_.subTargetCheck&&this.targets.concat().reverse().map(function(A){u=A.hoverCursor||u}),this.setCursor(u))},getCornerCursor:function(m,_,u){var x=_.controls[m];return x.cursorStyleHandler(u,x,_)}})}(),function(){var s=Math.min,p=Math.max;S.util.object.extend(S.Canvas.prototype,{_shouldGroup:function(b,v){var a=this._activeObject;return a&&this._isSelectionKeyPressed(b)&&v&&v.selectable&&this.selection&&(a!==v||a.type==="activeSelection")&&!v.onSelect({e:b})},_handleGrouping:function(b,v){var a=this._activeObject;a.__corner||v===a&&(v=this.findTarget(b,!0),!v||!v.selectable)||(a&&a.type==="activeSelection"?this._updateActiveSelection(v,b):this._createActiveSelection(v,b))},_updateActiveSelection:function(b,v){var a=this._activeObject,l=a._objects.slice(0);a.contains(b)?(a.removeWithUpdate(b),this._hoveredTarget=b,this._hoveredTargets=this.targets.concat(),a.size()===1&&this._setActiveObject(a.item(0),v)):(a.addWithUpdate(b),this._hoveredTarget=a,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(l,v)},_createActiveSelection:function(b,v){var a=this.getActiveObjects(),l=this._createGroup(b);this._hoveredTarget=l,this._setActiveObject(l,v),this._fireSelectionEvents(a,v)},_createGroup:function(b){var v=this._objects,a=v.indexOf(this._activeObject)<v.indexOf(b),l=a?[this._activeObject,b]:[b,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new S.ActiveSelection(l,{canvas:this})},_groupSelectedObjects:function(b){var v=this._collectObjects(b),a;v.length===1?this.setActiveObject(v[0],b):v.length>1&&(a=new S.ActiveSelection(v.reverse(),{canvas:this}),this.setActiveObject(a,b))},_collectObjects:function(b){for(var v=[],a,l=this._groupSelector.ex,h=this._groupSelector.ey,m=l+this._groupSelector.left,_=h+this._groupSelector.top,u=new S.Point(s(l,m),s(h,_)),x=new S.Point(p(l,m),p(h,_)),T=!this.selectionFullyContained,A=l===m&&h===_,D=this._objects.length;D--&&(a=this._objects[D],!(!(!a||!a.selectable||!a.visible)&&(T&&a.intersectsWithRect(u,x,!0)||a.isContainedWithinRect(u,x,!0)||T&&a.containsPoint(u,null,!0)||T&&a.containsPoint(x,null,!0))&&(v.push(a),A))););return v.length>1&&(v=v.filter(function(V){return!V.onSelect({e:b})})),v},_maybeGroupObjects:function(b){this.selection&&this._groupSelector&&this._groupSelectedObjects(b),this.setCursor(this.defaultCursor),this._groupSelector=null}})}(),function(){S.util.object.extend(S.StaticCanvas.prototype,{toDataURL:function(s){s||(s={});var p=s.format||"png",b=s.quality||1,v=(s.multiplier||1)*(s.enableRetinaScaling?this.getRetinaScaling():1),a=this.toCanvasElement(v,s);return S.util.toDataURL(a,p,b)},toCanvasElement:function(s,p){s=s||1,p=p||{};var b=(p.width||this.width)*s,v=(p.height||this.height)*s,a=this.getZoom(),l=this.width,h=this.height,m=a*s,_=this.viewportTransform,u=(_[4]-(p.left||0))*s,x=(_[5]-(p.top||0))*s,T=this.interactive,A=[m,0,0,m,u,x],D=this.enableRetinaScaling,V=S.util.createCanvasElement(),X=this.contextTop;return V.width=b,V.height=v,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=A,this.width=b,this.height=v,this.calcViewportBoundaries(),this.renderCanvas(V.getContext("2d"),this._objects),this.viewportTransform=_,this.width=l,this.height=h,this.calcViewportBoundaries(),this.interactive=T,this.enableRetinaScaling=D,this.contextTop=X,V}})}(),S.util.object.extend(S.StaticCanvas.prototype,{loadFromJSON:function(s,p,b){if(s){var v=typeof s=="string"?JSON.parse(s):S.util.object.clone(s),a=this,l=v.clipPath,h=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete v.clipPath,this._enlivenObjects(v.objects,function(m){a.clear(),a._setBgOverlay(v,function(){l?a._enlivenObjects([l],function(_){a.clipPath=_[0],a.__setupCanvas.call(a,v,m,h,p)}):a.__setupCanvas.call(a,v,m,h,p)})},b),this}},__setupCanvas:function(s,p,b,v){var a=this;p.forEach(function(l,h){a.insertAt(l,h)}),this.renderOnAddRemove=b,delete s.objects,delete s.backgroundImage,delete s.overlayImage,delete s.background,delete s.overlay,this._setOptions(s),this.renderAll(),v&&v()},_setBgOverlay:function(s,p){var b={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(!s.backgroundImage&&!s.overlayImage&&!s.background&&!s.overlay){p&&p();return}var v=function(){b.backgroundImage&&b.overlayImage&&b.backgroundColor&&b.overlayColor&&p&&p()};this.__setBgOverlay("backgroundImage",s.backgroundImage,b,v),this.__setBgOverlay("overlayImage",s.overlayImage,b,v),this.__setBgOverlay("backgroundColor",s.background,b,v),this.__setBgOverlay("overlayColor",s.overlay,b,v)},__setBgOverlay:function(s,p,b,v){var a=this;if(!p){b[s]=!0,v&&v();return}s==="backgroundImage"||s==="overlayImage"?S.util.enlivenObjects([p],function(l){a[s]=l[0],b[s]=!0,v&&v()}):this["set"+S.util.string.capitalize(s,!0)](p,function(){b[s]=!0,v&&v()})},_enlivenObjects:function(s,p,b){if(!s||s.length===0){p&&p([]);return}S.util.enlivenObjects(s,function(v){p&&p(v)},null,b)},_toDataURL:function(s,p){this.clone(function(b){p(b.toDataURL(s))})},_toDataURLWithMultiplier:function(s,p,b){this.clone(function(v){b(v.toDataURLWithMultiplier(s,p))})},clone:function(s,p){var b=JSON.stringify(this.toJSON(p));this.cloneWithoutData(function(v){v.loadFromJSON(b,function(){s&&s(v)})})},cloneWithoutData:function(s){var p=S.util.createCanvasElement();p.width=this.width,p.height=this.height;var b=new S.Canvas(p);this.backgroundImage?(b.setBackgroundImage(this.backgroundImage.src,function(){b.renderAll(),s&&s(b)}),b.backgroundImageOpacity=this.backgroundImageOpacity,b.backgroundImageStretch=this.backgroundImageStretch):s&&s(b)}}),function(s){var p=s.fabric||(s.fabric={}),b=p.util.object.extend,v=p.util.object.clone,a=p.util.toFixed,l=p.util.string.capitalize,h=p.util.degreesToRadians,m=!p.isLikelyNode,_=2;p.Object||(p.Object=p.util.createClass(p.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:m,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(u){u&&this.setOptions(u)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=p.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(u){var x=p.perfLimitSizeTotal,T=u.width,A=u.height,D=p.maxCacheSideLimit,V=p.minCacheSideLimit;if(T<=D&&A<=D&&T*A<=x)return T<V&&(u.width=V),A<V&&(u.height=V),u;var X=T/A,ie=p.util.limitDimsByArea(X,x),ve=p.util.capValue,Fe=ve(V,ie.x,D),Ye=ve(V,ie.y,D);return T>Fe&&(u.zoomX/=T/Fe,u.width=Fe,u.capped=!0),A>Ye&&(u.zoomY/=A/Ye,u.height=Ye,u.capped=!0),u},_getCacheCanvasDimensions:function(){var u=this.getTotalObjectScaling(),x=this._getTransformedDimensions(0,0),T=x.x*u.scaleX/this.scaleX,A=x.y*u.scaleY/this.scaleY;return{width:T+_,height:A+_,zoomX:u.scaleX,zoomY:u.scaleY,x:T,y:A}},_updateCacheCanvas:function(){var u=this.canvas;if(this.noScaleCache&&u&&u._currentTransform){var x=u._currentTransform.target,T=u._currentTransform.action;if(this===x&&T.slice&&T.slice(0,5)==="scale")return!1}var A=this._cacheCanvas,D=this._limitCacheSize(this._getCacheCanvasDimensions()),V=p.minCacheSideLimit,X=D.width,ie=D.height,ve,Fe,Ye=D.zoomX,Ze=D.zoomY,Je=X!==this.cacheWidth||ie!==this.cacheHeight,ct=this.zoomX!==Ye||this.zoomY!==Ze,nt=Je||ct,vt=0,Mt=0,st=!1;if(Je){var bt=this._cacheCanvas.width,ee=this._cacheCanvas.height,be=X>bt||ie>ee,me=(X<bt*.9||ie<ee*.9)&&bt>V&&ee>V;st=be||me,be&&!D.capped&&(X>V||ie>V)&&(vt=X*.1,Mt=ie*.1)}return this instanceof p.Text&&this.path&&(nt=!0,st=!0,vt+=this.getHeightOfLine(0)*this.zoomX,Mt+=this.getHeightOfLine(0)*this.zoomY),nt?(st?(A.width=Math.ceil(X+vt),A.height=Math.ceil(ie+Mt)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,A.width,A.height)),ve=D.x/2,Fe=D.y/2,this.cacheTranslationX=Math.round(A.width/2-ve)+ve,this.cacheTranslationY=Math.round(A.height/2-Fe)+Fe,this.cacheWidth=X,this.cacheHeight=ie,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(Ye,Ze),this.zoomX=Ye,this.zoomY=Ze,!0):!1},setOptions:function(u){this._setOptions(u),this._initGradient(u.fill,"fill"),this._initGradient(u.stroke,"stroke"),this._initPattern(u.fill,"fill"),this._initPattern(u.stroke,"stroke")},transform:function(u){var x=this.group&&!this.group._transformDone||this.group&&this.canvas&&u===this.canvas.contextTop,T=this.calcTransformMatrix(!x);u.transform(T[0],T[1],T[2],T[3],T[4],T[5])},toObject:function(u){var x=p.Object.NUM_FRACTION_DIGITS,T={type:this.type,version:p.version,originX:this.originX,originY:this.originY,left:a(this.left,x),top:a(this.top,x),width:a(this.width,x),height:a(this.height,x),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:a(this.strokeWidth,x),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:a(this.strokeMiterLimit,x),scaleX:a(this.scaleX,x),scaleY:a(this.scaleY,x),angle:a(this.angle,x),flipX:this.flipX,flipY:this.flipY,opacity:a(this.opacity,x),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:a(this.skewX,x),skewY:a(this.skewY,x)};return this.clipPath&&!this.clipPath.excludeFromExport&&(T.clipPath=this.clipPath.toObject(u),T.clipPath.inverted=this.clipPath.inverted,T.clipPath.absolutePositioned=this.clipPath.absolutePositioned),p.util.populateWithProperties(this,T,u),this.includeDefaultValues||(T=this._removeDefaultValues(T)),T},toDatalessObject:function(u){return this.toObject(u)},_removeDefaultValues:function(u){var x=p.util.getKlass(u.type).prototype,T=x.stateProperties;return T.forEach(function(A){A==="left"||A==="top"||(u[A]===x[A]&&delete u[A],Array.isArray(u[A])&&Array.isArray(x[A])&&u[A].length===0&&x[A].length===0&&delete u[A])}),u},toString:function(){return"#<fabric."+l(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var u=p.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(u.scaleX),scaleY:Math.abs(u.scaleY)}},getTotalObjectScaling:function(){var u=this.getObjectScaling(),x=u.scaleX,T=u.scaleY;if(this.canvas){var A=this.canvas.getZoom(),D=this.canvas.getRetinaScaling();x*=A*D,T*=A*D}return{scaleX:x,scaleY:T}},getObjectOpacity:function(){var u=this.opacity;return this.group&&(u*=this.group.getObjectOpacity()),u},_set:function(u,x){var T=u==="scaleX"||u==="scaleY",A=this[u]!==x,D=!1;return T&&(x=this._constrainScale(x)),u==="scaleX"&&x<0?(this.flipX=!this.flipX,x*=-1):u==="scaleY"&&x<0?(this.flipY=!this.flipY,x*=-1):u==="shadow"&&x&&!(x instanceof p.Shadow)?x=new p.Shadow(x):u==="dirty"&&this.group&&this.group.set("dirty",x),this[u]=x,A&&(D=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(u)>-1?(this.dirty=!0,D&&this.group.set("dirty",!0)):D&&this.stateProperties.indexOf(u)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:p.iMatrix.concat()},isNotVisible:function(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible},render:function(u){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(u.save(),this._setupCompositeOperation(u),this.drawSelectionBackground(u),this.transform(u),this._setOpacity(u),this._setShadow(u,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(u)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(u),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),u.restore())},renderCache:function(u){u=u||{},(!this._cacheCanvas||!this._cacheContext)&&this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,u.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0},hasFill:function(){return this.fill&&this.fill!=="transparent"},needsItsOwnCache:function(){return!!(this.paintFirst==="stroke"&&this.hasFill()&&this.hasStroke()&&typeof this.shadow=="object"||this.clipPath)},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)},drawClipPathOnCache:function(u,x){if(u.save(),x.inverted?u.globalCompositeOperation="destination-out":u.globalCompositeOperation="destination-in",x.absolutePositioned){var T=p.util.invertTransform(this.calcTransformMatrix());u.transform(T[0],T[1],T[2],T[3],T[4],T[5])}x.transform(u),u.scale(1/x.zoomX,1/x.zoomY),u.drawImage(x._cacheCanvas,-x.cacheTranslationX,-x.cacheTranslationY),u.restore()},drawObject:function(u,x){var T=this.fill,A=this.stroke;x?(this.fill="black",this.stroke="",this._setClippingProperties(u)):this._renderBackground(u),this._render(u),this._drawClipPath(u,this.clipPath),this.fill=T,this.stroke=A},_drawClipPath:function(u,x){x&&(x.canvas=this.canvas,x.shouldCache(),x._transformDone=!0,x.renderCache({forClipping:!0}),this.drawClipPathOnCache(u,x))},drawCacheOnCanvas:function(u){u.scale(1/this.zoomX,1/this.zoomY),u.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(u){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!u&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!u){var x=this.cacheWidth/this.zoomX,T=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-x/2,-T/2,x,T)}return!0}return!1},_renderBackground:function(u){if(this.backgroundColor){var x=this._getNonTransformedDimensions();u.fillStyle=this.backgroundColor,u.fillRect(-x.x/2,-x.y/2,x.x,x.y),this._removeShadow(u)}},_setOpacity:function(u){this.group&&!this.group._transformDone?u.globalAlpha=this.getObjectOpacity():u.globalAlpha*=this.opacity},_setStrokeStyles:function(u,x){var T=x.stroke;T&&(u.lineWidth=x.strokeWidth,u.lineCap=x.strokeLineCap,u.lineDashOffset=x.strokeDashOffset,u.lineJoin=x.strokeLineJoin,u.miterLimit=x.strokeMiterLimit,T.toLive?T.gradientUnits==="percentage"||T.gradientTransform||T.patternTransform?this._applyPatternForTransformedGradient(u,T):(u.strokeStyle=T.toLive(u,this),this._applyPatternGradientTransform(u,T)):u.strokeStyle=x.stroke)},_setFillStyles:function(u,x){var T=x.fill;T&&(T.toLive?(u.fillStyle=T.toLive(u,this),this._applyPatternGradientTransform(u,x.fill)):u.fillStyle=T)},_setClippingProperties:function(u){u.globalAlpha=1,u.strokeStyle="transparent",u.fillStyle="#000000"},_setLineDash:function(u,x){!x||x.length===0||(1&x.length&&x.push.apply(x,x),u.setLineDash(x))},_renderControls:function(u,x){var T=this.getViewportTransform(),A=this.calcTransformMatrix(),D,V,X;x=x||{},V=typeof x.hasBorders<"u"?x.hasBorders:this.hasBorders,X=typeof x.hasControls<"u"?x.hasControls:this.hasControls,A=p.util.multiplyTransformMatrices(T,A),D=p.util.qrDecompose(A),u.save(),u.translate(D.translateX,D.translateY),u.lineWidth=1*this.borderScaleFactor,this.group||(u.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(D.angle-=180),u.rotate(h(this.group?D.angle:this.angle)),x.forActiveSelection||this.group?V&&this.drawBordersInGroup(u,D,x):V&&this.drawBorders(u,x),X&&this.drawControls(u,x),u.restore()},_setShadow:function(u){if(this.shadow){var x=this.shadow,T=this.canvas,A,D=T&&T.viewportTransform[0]||1,V=T&&T.viewportTransform[3]||1;x.nonScaling?A={scaleX:1,scaleY:1}:A=this.getObjectScaling(),T&&T._isRetinaScaling()&&(D*=p.devicePixelRatio,V*=p.devicePixelRatio),u.shadowColor=x.color,u.shadowBlur=x.blur*p.browserShadowBlurConstant*(D+V)*(A.scaleX+A.scaleY)/4,u.shadowOffsetX=x.offsetX*D*A.scaleX,u.shadowOffsetY=x.offsetY*V*A.scaleY}},_removeShadow:function(u){this.shadow&&(u.shadowColor="",u.shadowBlur=u.shadowOffsetX=u.shadowOffsetY=0)},_applyPatternGradientTransform:function(u,x){if(!x||!x.toLive)return{offsetX:0,offsetY:0};var T=x.gradientTransform||x.patternTransform,A=-this.width/2+x.offsetX||0,D=-this.height/2+x.offsetY||0;return x.gradientUnits==="percentage"?u.transform(this.width,0,0,this.height,A,D):u.transform(1,0,0,1,A,D),T&&u.transform(T[0],T[1],T[2],T[3],T[4],T[5]),{offsetX:A,offsetY:D}},_renderPaintInOrder:function(u){this.paintFirst==="stroke"?(this._renderStroke(u),this._renderFill(u)):(this._renderFill(u),this._renderStroke(u))},_render:function(){},_renderFill:function(u){this.fill&&(u.save(),this._setFillStyles(u,this),this.fillRule==="evenodd"?u.fill("evenodd"):u.fill(),u.restore())},_renderStroke:function(u){if(!(!this.stroke||this.strokeWidth===0)){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(u),u.save(),this.strokeUniform&&this.group){var x=this.getObjectScaling();u.scale(1/x.scaleX,1/x.scaleY)}else this.strokeUniform&&u.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(u,this.strokeDashArray),this._setStrokeStyles(u,this),u.stroke(),u.restore()}},_applyPatternForTransformedGradient:function(u,x){var T=this._limitCacheSize(this._getCacheCanvasDimensions()),A=p.util.createCanvasElement(),D,V=this.canvas.getRetinaScaling(),X=T.x/this.scaleX/V,ie=T.y/this.scaleY/V;A.width=X,A.height=ie,D=A.getContext("2d"),D.beginPath(),D.moveTo(0,0),D.lineTo(X,0),D.lineTo(X,ie),D.lineTo(0,ie),D.closePath(),D.translate(X/2,ie/2),D.scale(T.zoomX/this.scaleX/V,T.zoomY/this.scaleY/V),this._applyPatternGradientTransform(D,x),D.fillStyle=x.toLive(u),D.fill(),u.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),u.scale(V*this.scaleX/T.zoomX,V*this.scaleY/T.zoomY),u.strokeStyle=D.createPattern(A,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var u=p.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",u.scaleX),this.set("scaleY",u.scaleY),this.angle=u.angle,this.skewX=u.skewX,this.skewY=0}},_removeTransformMatrix:function(u){var x=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),x=p.util.transformPoint(x,this.transformMatrix)),this.transformMatrix=null,u&&(this.scaleX*=u.scaleX,this.scaleY*=u.scaleY,this.cropX=u.cropX,this.cropY=u.cropY,x.x+=u.offsetLeft,x.y+=u.offsetTop,this.width=u.width,this.height=u.height),this.setPositionByOrigin(x,"center","center")},clone:function(u,x){var T=this.toObject(x);this.constructor.fromObject?this.constructor.fromObject(T,u):p.Object._fromObject("Object",T,u)},cloneAsImage:function(u,x){var T=this.toCanvasElement(x);return u&&u(new p.Image(T)),this},toCanvasElement:function(u){u||(u={});var x=p.util,T=x.saveObjectTransform(this),A=this.group,D=this.shadow,V=Math.abs,X=(u.multiplier||1)*(u.enableRetinaScaling?p.devicePixelRatio:1);delete this.group,u.withoutTransform&&x.resetObjectTransform(this),u.withoutShadow&&(this.shadow=null);var ie=p.util.createCanvasElement(),ve=this.getBoundingRect(!0,!0),Fe=this.shadow,Ye,Ze={x:0,y:0},Je,ct,nt;Fe&&(Je=Fe.blur,Fe.nonScaling?Ye={scaleX:1,scaleY:1}:Ye=this.getObjectScaling(),Ze.x=2*Math.round(V(Fe.offsetX)+Je)*V(Ye.scaleX),Ze.y=2*Math.round(V(Fe.offsetY)+Je)*V(Ye.scaleY)),ct=ve.width+Ze.x,nt=ve.height+Ze.y,ie.width=Math.ceil(ct),ie.height=Math.ceil(nt);var vt=new p.StaticCanvas(ie,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});u.format==="jpeg"&&(vt.backgroundColor="#fff"),this.setPositionByOrigin(new p.Point(vt.width/2,vt.height/2),"center","center");var Mt=this.canvas;vt.add(this);var st=vt.toCanvasElement(X||1,u);return this.shadow=D,this.set("canvas",Mt),A&&(this.group=A),this.set(T).setCoords(),vt._objects=[],vt.dispose(),vt=null,st},toDataURL:function(u){return u||(u={}),p.util.toDataURL(this.toCanvasElement(u),u.format||"png",u.quality||1)},isType:function(u){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===u},complexity:function(){return 1},toJSON:function(u){return this.toObject(u)},rotate:function(u){var x=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;return x&&this._setOriginToCenter(),this.set("angle",u),x&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(u,x){x=x||this.canvas.getPointer(u);var T=new p.Point(x.x,x.y),A=this._getLeftTopCoords();return this.angle&&(T=p.util.rotatePoint(T,A,h(-this.angle))),{x:T.x-A.x,y:T.y-A.y}},_setupCompositeOperation:function(u){this.globalCompositeOperation&&(u.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){p.runningAnimations&&p.runningAnimations.cancelByTarget(this)}}),p.util.createAccessors&&p.util.createAccessors(p.Object),b(p.Object.prototype,p.Observable),p.Object.NUM_FRACTION_DIGITS=2,p.Object.ENLIVEN_PROPS=["clipPath"],p.Object._fromObject=function(u,x,T,A){var D=p[u];x=v(x,!0),p.util.enlivenPatterns([x.fill,x.stroke],function(V){typeof V[0]<"u"&&(x.fill=V[0]),typeof V[1]<"u"&&(x.stroke=V[1]),p.util.enlivenObjectEnlivables(x,x,function(){var X=A?new D(x[A],x):new D(x);T&&T(X)})})},p.Object.__uid=0)}($),function(){var s=S.util.degreesToRadians,p={left:-.5,center:0,right:.5},b={top:-.5,center:0,bottom:.5};S.util.object.extend(S.Object.prototype,{translateToGivenOrigin:function(v,a,l,h,m){var _=v.x,u=v.y,x,T,A;return typeof a=="string"?a=p[a]:a-=.5,typeof h=="string"?h=p[h]:h-=.5,x=h-a,typeof l=="string"?l=b[l]:l-=.5,typeof m=="string"?m=b[m]:m-=.5,T=m-l,(x||T)&&(A=this._getTransformedDimensions(),_=v.x+x*A.x,u=v.y+T*A.y),new S.Point(_,u)},translateToCenterPoint:function(v,a,l){var h=this.translateToGivenOrigin(v,a,l,"center","center");return this.angle?S.util.rotatePoint(h,v,s(this.angle)):h},translateToOriginPoint:function(v,a,l){var h=this.translateToGivenOrigin(v,"center","center",a,l);return this.angle?S.util.rotatePoint(h,v,s(this.angle)):h},getCenterPoint:function(){var v=new S.Point(this.left,this.top);return this.translateToCenterPoint(v,this.originX,this.originY)},getPointByOrigin:function(v,a){var l=this.getCenterPoint();return this.translateToOriginPoint(l,v,a)},toLocalPoint:function(v,a,l){var h=this.getCenterPoint(),m,_;return typeof a<"u"&&typeof l<"u"?m=this.translateToGivenOrigin(h,"center","center",a,l):m=new S.Point(this.left,this.top),_=new S.Point(v.x,v.y),this.angle&&(_=S.util.rotatePoint(_,h,-s(this.angle))),_.subtractEquals(m)},setPositionByOrigin:function(v,a,l){var h=this.translateToCenterPoint(v,a,l),m=this.translateToOriginPoint(h,this.originX,this.originY);this.set("left",m.x),this.set("top",m.y)},adjustPosition:function(v){var a=s(this.angle),l=this.getScaledWidth(),h=S.util.cos(a)*l,m=S.util.sin(a)*l,_,u;typeof this.originX=="string"?_=p[this.originX]:_=this.originX-.5,typeof v=="string"?u=p[v]:u=v-.5,this.left+=h*(u-_),this.top+=m*(u-_),this.setCoords(),this.originX=v},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var v=this.getCenterPoint();this.originX="center",this.originY="center",this.left=v.x,this.top=v.y},_resetOrigin:function(){var v=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=v.x,this.top=v.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}})}(),function(){function s(l){return[new S.Point(l.tl.x,l.tl.y),new S.Point(l.tr.x,l.tr.y),new S.Point(l.br.x,l.br.y),new S.Point(l.bl.x,l.bl.y)]}var p=S.util,b=p.degreesToRadians,v=p.multiplyTransformMatrices,a=p.transformPoint;p.object.extend(S.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(l,h){return h?l?this.calcACoords():this.calcLineCoords():((!this.aCoords||!this.lineCoords)&&this.setCoords(!0),l?this.aCoords:this.lineCoords)},getCoords:function(l,h){return s(this._getCoords(l,h))},intersectsWithRect:function(l,h,m,_){var u=this.getCoords(m,_),x=S.Intersection.intersectPolygonRectangle(u,l,h);return x.status==="Intersection"},intersectsWithObject:function(l,h,m){var _=S.Intersection.intersectPolygonPolygon(this.getCoords(h,m),l.getCoords(h,m));return _.status==="Intersection"||l.isContainedWithinObject(this,h,m)||this.isContainedWithinObject(l,h,m)},isContainedWithinObject:function(l,h,m){for(var _=this.getCoords(h,m),u=h?l.aCoords:l.lineCoords,x=0,T=l._getImageLines(u);x<4;x++)if(!l.containsPoint(_[x],T))return!1;return!0},isContainedWithinRect:function(l,h,m,_){var u=this.getBoundingRect(m,_);return u.left>=l.x&&u.left+u.width<=h.x&&u.top>=l.y&&u.top+u.height<=h.y},containsPoint:function(l,x,m,_){var u=this._getCoords(m,_),x=x||this._getImageLines(u),T=this._findCrossPoints(l,x);return T!==0&&T%2===1},isOnScreen:function(l){if(!this.canvas)return!1;var h=this.canvas.vptCoords.tl,m=this.canvas.vptCoords.br,_=this.getCoords(!0,l);return _.some(function(u){return u.x<=m.x&&u.x>=h.x&&u.y<=m.y&&u.y>=h.y})||this.intersectsWithRect(h,m,!0,l)?!0:this._containsCenterOfCanvas(h,m,l)},_containsCenterOfCanvas:function(l,h,m){var _={x:(l.x+h.x)/2,y:(l.y+h.y)/2};return!!this.containsPoint(_,null,!0,m)},isPartiallyOnScreen:function(l){if(!this.canvas)return!1;var h=this.canvas.vptCoords.tl,m=this.canvas.vptCoords.br;if(this.intersectsWithRect(h,m,!0,l))return!0;var _=this.getCoords(!0,l).every(function(u){return(u.x>=m.x||u.x<=h.x)&&(u.y>=m.y||u.y<=h.y)});return _&&this._containsCenterOfCanvas(h,m,l)},_getImageLines:function(l){var h={topline:{o:l.tl,d:l.tr},rightline:{o:l.tr,d:l.br},bottomline:{o:l.br,d:l.bl},leftline:{o:l.bl,d:l.tl}};return h},_findCrossPoints:function(l,h){var m,_,u,x,T,A=0,D;for(var V in h)if(D=h[V],!(D.o.y<l.y&&D.d.y<l.y)&&!(D.o.y>=l.y&&D.d.y>=l.y)&&(D.o.x===D.d.x&&D.o.x>=l.x?T=D.o.x:(m=0,_=(D.d.y-D.o.y)/(D.d.x-D.o.x),u=l.y-m*l.x,x=D.o.y-_*D.o.x,T=-(u-x)/(m-_)),T>=l.x&&(A+=1),A===2))break;return A},getBoundingRect:function(l,h){var m=this.getCoords(l,h);return p.makeBoundingBoxFromPoints(m)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(l){return Math.abs(l)<this.minScaleLimit?l<0?-this.minScaleLimit:this.minScaleLimit:l===0?1e-4:l},scale:function(l){return this._set("scaleX",l),this._set("scaleY",l),this.setCoords()},scaleToWidth:function(l,h){var m=this.getBoundingRect(h).width/this.getScaledWidth();return this.scale(l/this.width/m)},scaleToHeight:function(l,h){var m=this.getBoundingRect(h).height/this.getScaledHeight();return this.scale(l/this.height/m)},calcLineCoords:function(){var l=this.getViewportTransform(),h=this.padding,m=b(this.angle),_=p.cos(m),u=p.sin(m),x=_*h,T=u*h,A=x+T,D=x-T,V=this.calcACoords(),X={tl:a(V.tl,l),tr:a(V.tr,l),bl:a(V.bl,l),br:a(V.br,l)};return h&&(X.tl.x-=D,X.tl.y-=A,X.tr.x+=A,X.tr.y-=D,X.bl.x-=A,X.bl.y+=D,X.br.x+=D,X.br.y+=A),X},calcOCoords:function(){var l=this._calcRotateMatrix(),h=this._calcTranslateMatrix(),m=this.getViewportTransform(),_=v(m,h),u=v(_,l),u=v(u,[1/m[0],0,0,1/m[3],0,0]),x=this._calculateCurrentDimensions(),T={};return this.forEachControl(function(A,D,V){T[D]=A.positionHandler(x,u,V)}),T},calcACoords:function(){var l=this._calcRotateMatrix(),h=this._calcTranslateMatrix(),m=v(h,l),_=this._getTransformedDimensions(),u=_.x/2,x=_.y/2;return{tl:a({x:-u,y:-x},m),tr:a({x:u,y:-x},m),bl:a({x:-u,y:x},m),br:a({x:u,y:x},m)}},setCoords:function(l){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),l?this:(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords(),this)},_calcRotateMatrix:function(){return p.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var l=this.getCenterPoint();return[1,0,0,1,l.x,l.y]},transformMatrixKey:function(l){var h="_",m="";return!l&&this.group&&(m=this.group.transformMatrixKey(l)+h),m+this.top+h+this.left+h+this.scaleX+h+this.scaleY+h+this.skewX+h+this.skewY+h+this.angle+h+this.originX+h+this.originY+h+this.width+h+this.height+h+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(l){var h=this.calcOwnMatrix();if(l||!this.group)return h;var m=this.transformMatrixKey(l),_=this.matrixCache||(this.matrixCache={});return _.key===m?_.value:(this.group&&(h=v(this.group.calcTransformMatrix(!1),h)),_.key=m,_.value=h,h)},calcOwnMatrix:function(){var l=this.transformMatrixKey(!0),h=this.ownMatrixCache||(this.ownMatrixCache={});if(h.key===l)return h.value;var m=this._calcTranslateMatrix(),_={angle:this.angle,translateX:m[4],translateY:m[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return h.key=l,h.value=p.composeMatrix(_),h.value},_getNonTransformedDimensions:function(){var l=this.strokeWidth,h=this.width+l,m=this.height+l;return{x:h,y:m}},_getTransformedDimensions:function(l,h){typeof l>"u"&&(l=this.skewX),typeof h>"u"&&(h=this.skewY);var m,_,u,x=l===0&&h===0;if(this.strokeUniform?(_=this.width,u=this.height):(m=this._getNonTransformedDimensions(),_=m.x,u=m.y),x)return this._finalizeDimensions(_*this.scaleX,u*this.scaleY);var T=p.sizeAfterTransform(_,u,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:l,skewY:h});return this._finalizeDimensions(T.x,T.y)},_finalizeDimensions:function(l,h){return this.strokeUniform?{x:l+this.strokeWidth,y:h+this.strokeWidth}:{x:l,y:h}},_calculateCurrentDimensions:function(){var l=this.getViewportTransform(),h=this._getTransformedDimensions(),m=a(h,l,!0);return m.scalarAdd(2*this.padding)}})}(),S.util.object.extend(S.Object.prototype,{sendToBack:function(){return this.group?S.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?S.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(s){return this.group?S.StaticCanvas.prototype.sendBackwards.call(this.group,this,s):this.canvas&&this.canvas.sendBackwards(this,s),this},bringForward:function(s){return this.group?S.StaticCanvas.prototype.bringForward.call(this.group,this,s):this.canvas&&this.canvas.bringForward(this,s),this},moveTo:function(s){return this.group&&this.group.type!=="activeSelection"?S.StaticCanvas.prototype.moveTo.call(this.group,this,s):this.canvas&&this.canvas.moveTo(this,s),this}}),function(){function s(b,v){if(v){if(v.toLive)return b+": url(#SVGID_"+v.id+"); ";var a=new S.Color(v),l=b+": "+a.toRgb()+"; ",h=a.getAlpha();return h!==1&&(l+=b+"-opacity: "+h.toString()+"; "),l}else return b+": none; "}var p=S.util.toFixed;S.util.object.extend(S.Object.prototype,{getSvgStyles:function(b){var v=this.fillRule?this.fillRule:"nonzero",a=this.strokeWidth?this.strokeWidth:"0",l=this.strokeDashArray?this.strokeDashArray.join(" "):"none",h=this.strokeDashOffset?this.strokeDashOffset:"0",m=this.strokeLineCap?this.strokeLineCap:"butt",_=this.strokeLineJoin?this.strokeLineJoin:"miter",u=this.strokeMiterLimit?this.strokeMiterLimit:"4",x=typeof this.opacity<"u"?this.opacity:"1",T=this.visible?"":" visibility: hidden;",A=b?"":this.getSvgFilter(),D=s("fill",this.fill),V=s("stroke",this.stroke);return[V,"stroke-width: ",a,"; ","stroke-dasharray: ",l,"; ","stroke-linecap: ",m,"; ","stroke-dashoffset: ",h,"; ","stroke-linejoin: ",_,"; ","stroke-miterlimit: ",u,"; ",D,"fill-rule: ",v,"; ","opacity: ",x,";",A,T].join("")},getSvgSpanStyles:function(b,v){var a="; ",h=b.fontFamily?"font-family: "+(b.fontFamily.indexOf("'")===-1&&b.fontFamily.indexOf('"')===-1?"'"+b.fontFamily+"'":b.fontFamily)+a:"",l=b.strokeWidth?"stroke-width: "+b.strokeWidth+a:"",h=h,m=b.fontSize?"font-size: "+b.fontSize+"px"+a:"",_=b.fontStyle?"font-style: "+b.fontStyle+a:"",u=b.fontWeight?"font-weight: "+b.fontWeight+a:"",x=b.fill?s("fill",b.fill):"",T=b.stroke?s("stroke",b.stroke):"",A=this.getSvgTextDecoration(b),D=b.deltaY?"baseline-shift: "+-b.deltaY+"; ":"";return A&&(A="text-decoration: "+A+a),[T,l,h,m,_,u,A,x,D,v?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(b){return["overline","underline","line-through"].filter(function(v){return b[v.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(b,v){var a=b?this.calcTransformMatrix():this.calcOwnMatrix(),l='transform="'+S.util.matrixToSVG(a);return l+(v||"")+'" '},_setSVGBg:function(b){if(this.backgroundColor){var v=S.Object.NUM_FRACTION_DIGITS;b.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',p(-this.width/2,v),'" y="',p(-this.height/2,v),'" width="',p(this.width,v),'" height="',p(this.height,v),`"></rect>
`)}},toSVG:function(b){return this._createBaseSVGMarkup(this._toSVG(b),{reviver:b})},toClipPathSVG:function(b){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(b),{reviver:b})},_createBaseClipPathSVGMarkup:function(b,v){v=v||{};var a=v.reviver,l=v.additionalTransform||"",h=[this.getSvgTransform(!0,l),this.getSvgCommons()].join(""),m=b.indexOf("COMMON_PARTS");return b[m]=h,a?a(b.join("")):b.join("")},_createBaseSVGMarkup:function(b,v){v=v||{};var a=v.noStyle,l=v.reviver,h=a?"":'style="'+this.getSvgStyles()+'" ',m=v.withShadow?'style="'+this.getSvgFilter()+'" ':"",_=this.clipPath,u=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",x=_&&_.absolutePositioned,T=this.stroke,A=this.fill,D=this.shadow,V,X=[],ie,ve=b.indexOf("COMMON_PARTS"),Fe=v.additionalTransform;return _&&(_.clipPathId="CLIPPATH_"+S.Object.__uid++,ie='<clipPath id="'+_.clipPathId+`" >
`+_.toClipPathSVG(l)+`</clipPath>
`),x&&X.push("<g ",m,this.getSvgCommons(),` >
`),X.push("<g ",this.getSvgTransform(!1),x?"":m+this.getSvgCommons(),` >
`),V=[h,u,a?"":this.addPaintOrder()," ",Fe?'transform="'+Fe+'" ':""].join(""),b[ve]=V,A&&A.toLive&&X.push(A.toSVG(this)),T&&T.toLive&&X.push(T.toSVG(this)),D&&X.push(D.toSVG(this)),_&&X.push(ie),X.push(b.join("")),X.push(`</g>
`),x&&X.push(`</g>
`),l?l(X.join("")):X.join("")},addPaintOrder:function(){return this.paintFirst!=="fill"?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var s=S.util.object.extend,p="stateProperties";function b(a,l,h){var m={},_=!0;h.forEach(function(u){m[u]=a[u]}),s(a[l],m,_)}function v(a,l,h){if(a===l)return!0;if(Array.isArray(a)){if(!Array.isArray(l)||a.length!==l.length)return!1;for(var m=0,_=a.length;m<_;m++)if(!v(a[m],l[m]))return!1;return!0}else if(a&&typeof a=="object"){var u=Object.keys(a),x;if(!l||typeof l!="object"||!h&&u.length!==Object.keys(l).length)return!1;for(var m=0,_=u.length;m<_;m++)if(x=u[m],!(x==="canvas"||x==="group")&&!v(a[x],l[x]))return!1;return!0}}S.util.object.extend(S.Object.prototype,{hasStateChanged:function(a){a=a||p;var l="_"+a;return Object.keys(this[l]).length<this[a].length?!0:!v(this[l],this,!0)},saveState:function(a){var l=a&&a.propertySet||p,h="_"+l;return this[h]?(b(this,h,this[l]),a&&a.stateProperties&&b(this,h,a.stateProperties),this):this.setupState(a)},setupState:function(a){a=a||{};var l=a.propertySet||p;return a.propertySet=l,this["_"+l]={},this.saveState(a),this}})}(),function(){var s=S.util.degreesToRadians;S.util.object.extend(S.Object.prototype,{_findTargetCorner:function(p,b){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var v=p.x,a=p.y,l,h,m=Object.keys(this.oCoords),_=m.length-1,u;for(this.__corner=0;_>=0;_--)if(u=m[_],!!this.isControlVisible(u)&&(h=this._getImageLines(b?this.oCoords[u].touchCorner:this.oCoords[u].corner),l=this._findCrossPoints({x:v,y:a},h),l!==0&&l%2===1))return this.__corner=u,u;return!1},forEachControl:function(p){for(var b in this.controls)p(this.controls[b],b,this)},_setCornerCoords:function(){var p=this.oCoords;for(var b in p){var v=this.controls[b];p[b].corner=v.calcCornerCoords(this.angle,this.cornerSize,p[b].x,p[b].y,!1),p[b].touchCorner=v.calcCornerCoords(this.angle,this.touchCornerSize,p[b].x,p[b].y,!0)}},drawSelectionBackground:function(p){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;p.save();var b=this.getCenterPoint(),v=this._calculateCurrentDimensions(),a=this.canvas.viewportTransform;return p.translate(b.x,b.y),p.scale(1/a[0],1/a[3]),p.rotate(s(this.angle)),p.fillStyle=this.selectionBackgroundColor,p.fillRect(-v.x/2,-v.y/2,v.x,v.y),p.restore(),this},drawBorders:function(p,b){b=b||{};var v=this._calculateCurrentDimensions(),a=this.borderScaleFactor,l=v.x+a,h=v.y+a,m=typeof b.hasControls<"u"?b.hasControls:this.hasControls,_=!1;return p.save(),p.strokeStyle=b.borderColor||this.borderColor,this._setLineDash(p,b.borderDashArray||this.borderDashArray),p.strokeRect(-l/2,-h/2,l,h),m&&(p.beginPath(),this.forEachControl(function(u,x,T){u.withConnection&&u.getVisibility(T,x)&&(_=!0,p.moveTo(u.x*l,u.y*h),p.lineTo(u.x*l+u.offsetX,u.y*h+u.offsetY))}),_&&p.stroke()),p.restore(),this},drawBordersInGroup:function(p,b,v){v=v||{};var a=S.util.sizeAfterTransform(this.width,this.height,b),l=this.strokeWidth,h=this.strokeUniform,m=this.borderScaleFactor,_=a.x+l*(h?this.canvas.getZoom():b.scaleX)+m,u=a.y+l*(h?this.canvas.getZoom():b.scaleY)+m;return p.save(),this._setLineDash(p,v.borderDashArray||this.borderDashArray),p.strokeStyle=v.borderColor||this.borderColor,p.strokeRect(-_/2,-u/2,_,u),p.restore(),this},drawControls:function(p,b){b=b||{},p.save();var v=this.canvas.getRetinaScaling(),a,l;return p.setTransform(v,0,0,v,0,0),p.strokeStyle=p.fillStyle=b.cornerColor||this.cornerColor,this.transparentCorners||(p.strokeStyle=b.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(p,b.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(a=this.group.calcTransformMatrix()),this.forEachControl(function(h,m,_){l=_.oCoords[m],h.getVisibility(_,m)&&(a&&(l=S.util.transformPoint(l,a)),h.render(p,l.x,l.y,b,_))}),p.restore(),this},isControlVisible:function(p){return this.controls[p]&&this.controls[p].getVisibility(this,p)},setControlVisible:function(p,b){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[p]=b,this},setControlsVisibility:function(p){p||(p={});for(var b in p)this.setControlVisible(b,p[b]);return this},onDeselect:function(){},onSelect:function(){}})}(),S.util.object.extend(S.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(s,p){p=p||{};var b=function(){},v=p.onComplete||b,a=p.onChange||b,l=this;return S.util.animate({target:this,startValue:s.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(h){s.set("left",h),l.requestRenderAll(),a()},onComplete:function(){s.setCoords(),v()}})},fxCenterObjectV:function(s,p){p=p||{};var b=function(){},v=p.onComplete||b,a=p.onChange||b,l=this;return S.util.animate({target:this,startValue:s.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(h){s.set("top",h),l.requestRenderAll(),a()},onComplete:function(){s.setCoords(),v()}})},fxRemove:function(s,p){p=p||{};var b=function(){},v=p.onComplete||b,a=p.onChange||b,l=this;return S.util.animate({target:this,startValue:s.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(h){s.set("opacity",h),l.requestRenderAll(),a()},onComplete:function(){l.remove(s),v()}})}}),S.util.object.extend(S.Object.prototype,{animate:function(){if(arguments[0]&&typeof arguments[0]=="object"){var s=[],p,b,v=[];for(p in arguments[0])s.push(p);for(var a=0,l=s.length;a<l;a++)p=s[a],b=a!==l-1,v.push(this._animate(p,arguments[0][p],arguments[1],b));return v}else return this._animate.apply(this,arguments)},_animate:function(s,p,b,v){var a=this,l;p=p.toString(),b?b=S.util.object.clone(b):b={},~s.indexOf(".")&&(l=s.split("."));var h=a.colorProperties.indexOf(s)>-1||l&&a.colorProperties.indexOf(l[1])>-1,m=l?this.get(l[0])[l[1]]:this.get(s);"from"in b||(b.from=m),h||(~p.indexOf("=")?p=m+parseFloat(p.replace("=","")):p=parseFloat(p));var _={target:this,startValue:b.from,endValue:p,byValue:b.by,easing:b.easing,duration:b.duration,abort:b.abort&&function(u,x,T){return b.abort.call(a,u,x,T)},onChange:function(u,x,T){l?a[l[0]][l[1]]=u:a.set(s,u),!v&&b.onChange&&b.onChange(u,x,T)},onComplete:function(u,x,T){v||(a.setCoords(),b.onComplete&&b.onComplete(u,x,T))}};return h?S.util.animateColor(_.startValue,_.endValue,_.duration,_):S.util.animate(_)}}),function(s){var p=s.fabric||(s.fabric={}),b=p.util.object.extend,v=p.util.object.clone,a={x1:1,x2:1,y1:1,y2:1};if(p.Line){p.warn("fabric.Line is already defined");return}p.Line=p.util.createClass(p.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:p.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(h,m){h||(h=[0,0,0,0]),this.callSuper("initialize",m),this.set("x1",h[0]),this.set("y1",h[1]),this.set("x2",h[2]),this.set("y2",h[3]),this._setWidthHeight(m)},_setWidthHeight:function(h){h||(h={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in h?h.left:this._getLeftToOriginX(),this.top="top"in h?h.top:this._getTopToOriginY()},_set:function(h,m){return this.callSuper("_set",h,m),typeof a[h]<"u"&&this._setWidthHeight(),this},_getLeftToOriginX:l({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:l({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(h){h.beginPath();var m=this.calcLinePoints();h.moveTo(m.x1,m.y1),h.lineTo(m.x2,m.y2),h.lineWidth=this.strokeWidth;var _=h.strokeStyle;h.strokeStyle=this.stroke||h.fillStyle,this.stroke&&this._renderStroke(h),h.strokeStyle=_},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(h){return b(this.callSuper("toObject",h),this.calcLinePoints())},_getNonTransformedDimensions:function(){var h=this.callSuper("_getNonTransformedDimensions");return this.strokeLineCap==="butt"&&(this.width===0&&(h.y-=this.strokeWidth),this.height===0&&(h.x-=this.strokeWidth)),h},calcLinePoints:function(){var h=this.x1<=this.x2?-1:1,m=this.y1<=this.y2?-1:1,_=h*this.width*.5,u=m*this.height*.5,x=h*this.width*-.5,T=m*this.height*-.5;return{x1:_,x2:x,y1:u,y2:T}},_toSVG:function(){var h=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',h.x1,'" y1="',h.y1,'" x2="',h.x2,'" y2="',h.y2,`" />
`]}}),p.Line.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),p.Line.fromElement=function(h,m,_){_=_||{};var u=p.parseAttributes(h,p.Line.ATTRIBUTE_NAMES),x=[u.x1||0,u.y1||0,u.x2||0,u.y2||0];m(new p.Line(x,b(u,_)))},p.Line.fromObject=function(h,m){function _(x){delete x.points,m&&m(x)}var u=v(h,!0);u.points=[h.x1,h.y1,h.x2,h.y2],p.Object._fromObject("Line",u,_,"points")};function l(h,m){var _=h.origin,u=h.axis1,x=h.axis2,T=h.dimension,A=m.nearest,D=m.center,V=m.farthest;return function(){switch(this.get(_)){case A:return Math.min(this.get(u),this.get(x));case D:return Math.min(this.get(u),this.get(x))+.5*this.get(T);case V:return Math.max(this.get(u),this.get(x))}}}}($),function(s){var p=s.fabric||(s.fabric={}),b=p.util.degreesToRadians;if(p.Circle){p.warn("fabric.Circle is already defined.");return}p.Circle=p.util.createClass(p.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:p.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(a,l){return this.callSuper("_set",a,l),a==="radius"&&this.setRadius(l),this},toObject:function(a){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(a))},_toSVG:function(){var a,l=0,h=0,m=(this.endAngle-this.startAngle)%360;if(m===0)a=["<circle ","COMMON_PARTS",'cx="'+l+'" cy="'+h+'" ','r="',this.radius,`" />
`];else{var _=b(this.startAngle),u=b(this.endAngle),x=this.radius,T=p.util.cos(_)*x,A=p.util.sin(_)*x,D=p.util.cos(u)*x,V=p.util.sin(u)*x,X=m>180?"1":"0";a=['<path d="M '+T+" "+A," A "+x+" "+x," 0 ",+X+" 1"," "+D+" "+V,'" ',"COMMON_PARTS",` />
`]}return a},_render:function(a){a.beginPath(),a.arc(0,0,this.radius,b(this.startAngle),b(this.endAngle),!1),this._renderPaintInOrder(a)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(a){return this.radius=a,this.set("width",a*2).set("height",a*2)}}),p.Circle.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),p.Circle.fromElement=function(a,l){var h=p.parseAttributes(a,p.Circle.ATTRIBUTE_NAMES);if(!v(h))throw new Error("value of `r` attribute is required and can not be negative");h.left=(h.left||0)-h.radius,h.top=(h.top||0)-h.radius,l(new p.Circle(h))};function v(a){return"radius"in a&&a.radius>=0}p.Circle.fromObject=function(a,l){p.Object._fromObject("Circle",a,l)}}($),function(s){var p=s.fabric||(s.fabric={});if(p.Triangle){p.warn("fabric.Triangle is already defined");return}p.Triangle=p.util.createClass(p.Object,{type:"triangle",width:100,height:100,_render:function(b){var v=this.width/2,a=this.height/2;b.beginPath(),b.moveTo(-v,a),b.lineTo(0,-a),b.lineTo(v,a),b.closePath(),this._renderPaintInOrder(b)},_toSVG:function(){var b=this.width/2,v=this.height/2,a=[-b+" "+v,"0 "+-v,b+" "+v].join(",");return["<polygon ","COMMON_PARTS",'points="',a,'" />']}}),p.Triangle.fromObject=function(b,v){return p.Object._fromObject("Triangle",b,v)}}($),function(s){var p=s.fabric||(s.fabric={}),b=Math.PI*2;if(p.Ellipse){p.warn("fabric.Ellipse is already defined.");return}p.Ellipse=p.util.createClass(p.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:p.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(v){this.callSuper("initialize",v),this.set("rx",v&&v.rx||0),this.set("ry",v&&v.ry||0)},_set:function(v,a){switch(this.callSuper("_set",v,a),v){case"rx":this.rx=a,this.set("width",a*2);break;case"ry":this.ry=a,this.set("height",a*2);break}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(v){return this.callSuper("toObject",["rx","ry"].concat(v))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,`" />
`]},_render:function(v){v.beginPath(),v.save(),v.transform(1,0,0,this.ry/this.rx,0,0),v.arc(0,0,this.rx,0,b,!1),v.restore(),this._renderPaintInOrder(v)}}),p.Ellipse.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),p.Ellipse.fromElement=function(v,a){var l=p.parseAttributes(v,p.Ellipse.ATTRIBUTE_NAMES);l.left=(l.left||0)-l.rx,l.top=(l.top||0)-l.ry,a(new p.Ellipse(l))},p.Ellipse.fromObject=function(v,a){p.Object._fromObject("Ellipse",v,a)}}($),function(s){var p=s.fabric||(s.fabric={}),b=p.util.object.extend;if(p.Rect){p.warn("fabric.Rect is already defined");return}p.Rect=p.util.createClass(p.Object,{stateProperties:p.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:p.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(v){this.callSuper("initialize",v),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(v){var a=this.rx?Math.min(this.rx,this.width/2):0,l=this.ry?Math.min(this.ry,this.height/2):0,h=this.width,m=this.height,_=-this.width/2,u=-this.height/2,x=a!==0||l!==0,T=1-.5522847498;v.beginPath(),v.moveTo(_+a,u),v.lineTo(_+h-a,u),x&&v.bezierCurveTo(_+h-T*a,u,_+h,u+T*l,_+h,u+l),v.lineTo(_+h,u+m-l),x&&v.bezierCurveTo(_+h,u+m-T*l,_+h-T*a,u+m,_+h-a,u+m),v.lineTo(_+a,u+m),x&&v.bezierCurveTo(_+T*a,u+m,_,u+m-T*l,_,u+m-l),v.lineTo(_,u+l),x&&v.bezierCurveTo(_,u+T*l,_+T*a,u,_+a,u),v.closePath(),this._renderPaintInOrder(v)},toObject:function(v){return this.callSuper("toObject",["rx","ry"].concat(v))},_toSVG:function(){var v=-this.width/2,a=-this.height/2;return["<rect ","COMMON_PARTS",'x="',v,'" y="',a,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,`" />
`]}}),p.Rect.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),p.Rect.fromElement=function(v,a,l){if(!v)return a(null);l=l||{};var h=p.parseAttributes(v,p.Rect.ATTRIBUTE_NAMES);h.left=h.left||0,h.top=h.top||0,h.height=h.height||0,h.width=h.width||0;var m=new p.Rect(b(l?p.util.object.clone(l):{},h));m.visible=m.visible&&m.width>0&&m.height>0,a(m)},p.Rect.fromObject=function(v,a){return p.Object._fromObject("Rect",v,a)}}($),function(s){var p=s.fabric||(s.fabric={}),b=p.util.object.extend,v=p.util.array.min,a=p.util.array.max,l=p.util.toFixed,h=p.util.projectStrokeOnPoints;if(p.Polyline){p.warn("fabric.Polyline is already defined");return}p.Polyline=p.util.createClass(p.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:p.Object.prototype.cacheProperties.concat("points"),initialize:function(m,_){_=_||{},this.points=m||[],this.callSuper("initialize",_),this._setPositionDimensions(_)},_projectStrokeOnPoints:function(){return h(this.points,this,!0)},_setPositionDimensions:function(m){var _=this._calcDimensions(m),u,x=this.exactBoundingBox?this.strokeWidth:0;this.width=_.width-x,this.height=_.height-x,m.fromSVG||(u=this.translateToGivenOrigin({x:_.left-this.strokeWidth/2+x/2,y:_.top-this.strokeWidth/2+x/2},"left","top",this.originX,this.originY)),typeof m.left>"u"&&(this.left=m.fromSVG?_.left:u.x),typeof m.top>"u"&&(this.top=m.fromSVG?_.top:u.y),this.pathOffset={x:_.left+this.width/2+x/2,y:_.top+this.height/2+x/2}},_calcDimensions:function(){var m=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,_=v(m,"x")||0,u=v(m,"y")||0,x=a(m,"x")||0,T=a(m,"y")||0,A=x-_,D=T-u;return{left:_,top:u,width:A,height:D}},toObject:function(m){return b(this.callSuper("toObject",m),{points:this.points.concat()})},_toSVG:function(){for(var m=[],_=this.pathOffset.x,u=this.pathOffset.y,x=p.Object.NUM_FRACTION_DIGITS,T=0,A=this.points.length;T<A;T++)m.push(l(this.points[T].x-_,x),",",l(this.points[T].y-u,x)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',m.join(""),`" />
`]},commonRender:function(m){var _,u=this.points.length,x=this.pathOffset.x,T=this.pathOffset.y;if(!u||isNaN(this.points[u-1].y))return!1;m.beginPath(),m.moveTo(this.points[0].x-x,this.points[0].y-T);for(var A=0;A<u;A++)_=this.points[A],m.lineTo(_.x-x,_.y-T);return!0},_render:function(m){this.commonRender(m)&&this._renderPaintInOrder(m)},complexity:function(){return this.get("points").length}}),p.Polyline.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat(),p.Polyline.fromElementGenerator=function(m){return function(_,u,x){if(!_)return u(null);x||(x={});var T=p.parsePointsAttribute(_.getAttribute("points")),A=p.parseAttributes(_,p[m].ATTRIBUTE_NAMES);A.fromSVG=!0,u(new p[m](T,b(A,x)))}},p.Polyline.fromElement=p.Polyline.fromElementGenerator("Polyline"),p.Polyline.fromObject=function(m,_){return p.Object._fromObject("Polyline",m,_,"points")}}($),function(s){var p=s.fabric||(s.fabric={}),b=p.util.projectStrokeOnPoints;if(p.Polygon){p.warn("fabric.Polygon is already defined");return}p.Polygon=p.util.createClass(p.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return b(this.points,this)},_render:function(v){this.commonRender(v)&&(v.closePath(),this._renderPaintInOrder(v))}}),p.Polygon.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat(),p.Polygon.fromElement=p.Polyline.fromElementGenerator("Polygon"),p.Polygon.fromObject=function(v,a){p.Object._fromObject("Polygon",v,a,"points")}}($),function(s){var p=s.fabric||(s.fabric={}),b=p.util.array.min,v=p.util.array.max,a=p.util.object.extend,l=p.util.object.clone,h=p.util.toFixed;if(p.Path){p.warn("fabric.Path is already defined");return}p.Path=p.util.createClass(p.Object,{type:"path",path:null,cacheProperties:p.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:p.Object.prototype.stateProperties.concat("path"),initialize:function(m,_){_=l(_||{}),delete _.path,this.callSuper("initialize",_),this._setPath(m||[],_)},_setPath:function(m,_){this.path=p.util.makePathSimpler(Array.isArray(m)?m:p.util.parsePath(m)),p.Polyline.prototype._setPositionDimensions.call(this,_||{})},_renderPathCommands:function(m){var _,u=0,x=0,T=0,A=0,D=0,V=0,X=-this.pathOffset.x,ie=-this.pathOffset.y;m.beginPath();for(var ve=0,Fe=this.path.length;ve<Fe;++ve)switch(_=this.path[ve],_[0]){case"L":T=_[1],A=_[2],m.lineTo(T+X,A+ie);break;case"M":T=_[1],A=_[2],u=T,x=A,m.moveTo(T+X,A+ie);break;case"C":T=_[5],A=_[6],D=_[3],V=_[4],m.bezierCurveTo(_[1]+X,_[2]+ie,D+X,V+ie,T+X,A+ie);break;case"Q":m.quadraticCurveTo(_[1]+X,_[2]+ie,_[3]+X,_[4]+ie),T=_[3],A=_[4],D=_[1],V=_[2];break;case"z":case"Z":T=u,A=x,m.closePath();break}},_render:function(m){this._renderPathCommands(m),this._renderPaintInOrder(m)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(m){return a(this.callSuper("toObject",m),{path:this.path.map(function(_){return _.slice()})})},toDatalessObject:function(m){var _=this.toObject(["sourcePath"].concat(m));return _.sourcePath&&delete _.path,_},_toSVG:function(){var m=p.util.joinPath(this.path);return["<path ","COMMON_PARTS",'d="',m,'" stroke-linecap="round" ',`/>
`]},_getOffsetTransform:function(){var m=p.Object.NUM_FRACTION_DIGITS;return" translate("+h(-this.pathOffset.x,m)+", "+h(-this.pathOffset.y,m)+")"},toClipPathSVG:function(m){var _=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:m,additionalTransform:_})},toSVG:function(m){var _=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:m,additionalTransform:_})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var m=[],_=[],u,x=0,T=0,A=0,D=0,V,X=0,ie=this.path.length;X<ie;++X){switch(u=this.path[X],u[0]){case"L":A=u[1],D=u[2],V=[];break;case"M":A=u[1],D=u[2],x=A,T=D,V=[];break;case"C":V=p.util.getBoundsOfCurve(A,D,u[1],u[2],u[3],u[4],u[5],u[6]),A=u[5],D=u[6];break;case"Q":V=p.util.getBoundsOfCurve(A,D,u[1],u[2],u[1],u[2],u[3],u[4]),A=u[3],D=u[4];break;case"z":case"Z":A=x,D=T;break}V.forEach(function(nt){m.push(nt.x),_.push(nt.y)}),m.push(A),_.push(D)}var ve=b(m)||0,Fe=b(_)||0,Ye=v(m)||0,Ze=v(_)||0,Je=Ye-ve,ct=Ze-Fe;return{left:ve,top:Fe,width:Je,height:ct}}}),p.Path.fromObject=function(m,_){if(typeof m.sourcePath=="string"){var u=m.sourcePath;p.loadSVGFromURL(u,function(x){var T=x[0];T.setOptions(m),m.clipPath?p.util.enlivenObjects([m.clipPath],function(A){T.clipPath=A[0],_&&_(T)}):_&&_(T)})}else p.Object._fromObject("Path",m,_,"path")},p.Path.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat(["d"]),p.Path.fromElement=function(m,_,u){var x=p.parseAttributes(m,p.Path.ATTRIBUTE_NAMES);x.fromSVG=!0,_(new p.Path(x.d,a(x,u)))}}($),function(s){var p=s.fabric||(s.fabric={}),b=p.util.array.min,v=p.util.array.max;p.Group||(p.Group=p.util.createClass(p.Object,p.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(a,l,h){l=l||{},this._objects=[],h&&this.callSuper("initialize",l),this._objects=a||[];for(var m=this._objects.length;m--;)this._objects[m].group=this;if(h)this._updateObjectsACoords();else{var _=l&&l.centerPoint;l.originX!==void 0&&(this.originX=l.originX),l.originY!==void 0&&(this.originY=l.originY),_||this._calcBounds(),this._updateObjectsCoords(_),delete l.centerPoint,this.callSuper("initialize",l)}this.setCoords()},_updateObjectsACoords:function(){for(var a=!0,l=this._objects.length;l--;)this._objects[l].setCoords(a)},_updateObjectsCoords:function(l){for(var l=l||this.getCenterPoint(),h=this._objects.length;h--;)this._updateObjectCoords(this._objects[h],l)},_updateObjectCoords:function(a,l){var h=a.left,m=a.top,_=!0;a.set({left:h-l.x,top:m-l.y}),a.group=this,a.setCoords(_)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(a){var l=!!this.group;return this._restoreObjectsState(),p.util.resetObjectTransform(this),a&&(l&&p.util.removeTransformFromObject(a,this.group.calcTransformMatrix()),this._objects.push(a),a.group=this,a._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,l?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(a){return this._restoreObjectsState(),p.util.resetObjectTransform(this),this.remove(a),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(a){this.dirty=!0,a.group=this,a._set("canvas",this.canvas)},_onObjectRemoved:function(a){this.dirty=!0,delete a.group},_set:function(a,l){var h=this._objects.length;if(this.useSetOnGroup)for(;h--;)this._objects[h].setOnGroup(a,l);if(a==="canvas")for(;h--;)this._objects[h]._set(a,l);p.Object.prototype._set.call(this,a,l)},toObject:function(a){var l=this.includeDefaultValues,h=this._objects.filter(function(_){return!_.excludeFromExport}).map(function(_){var u=_.includeDefaultValues;_.includeDefaultValues=l;var x=_.toObject(a);return _.includeDefaultValues=u,x}),m=p.Object.prototype.toObject.call(this,a);return m.objects=h,m},toDatalessObject:function(a){var l,h=this.sourcePath;if(h)l=h;else{var m=this.includeDefaultValues;l=this._objects.map(function(u){var x=u.includeDefaultValues;u.includeDefaultValues=m;var T=u.toDatalessObject(a);return u.includeDefaultValues=x,T})}var _=p.Object.prototype.toDatalessObject.call(this,a);return _.objects=l,_},render:function(a){this._transformDone=!0,this.callSuper("render",a),this._transformDone=!1},shouldCache:function(){var a=p.Object.prototype.shouldCache.call(this);if(a){for(var l=0,h=this._objects.length;l<h;l++)if(this._objects[l].willDrawShadow())return this.ownCaching=!1,!1}return a},willDrawShadow:function(){if(p.Object.prototype.willDrawShadow.call(this))return!0;for(var a=0,l=this._objects.length;a<l;a++)if(this._objects[a].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(a){for(var l=0,h=this._objects.length;l<h;l++)this._objects[l].render(a);this._drawClipPath(a,this.clipPath)},isCacheDirty:function(a){if(this.callSuper("isCacheDirty",a))return!0;if(!this.statefullCache)return!1;for(var l=0,h=this._objects.length;l<h;l++)if(this._objects[l].isCacheDirty(!0)){if(this._cacheCanvas){var m=this.cacheWidth/this.zoomX,_=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-m/2,-_/2,m,_)}return!0}return!1},_restoreObjectsState:function(){var a=this.calcOwnMatrix();return this._objects.forEach(function(l){p.util.addTransformToObject(l,a),delete l.group,l.setCoords()}),this},destroy:function(){return this._objects.forEach(function(a){a.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(a){a.dispose&&a.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var a=this._objects,l=this.canvas;this._objects=[];var h=this.toObject();delete h.objects;var m=new p.ActiveSelection([]);return m.set(h),m.type="activeSelection",l.remove(this),a.forEach(function(_){_.group=m,_.dirty=!0,l.add(_)}),m.canvas=l,m._objects=a,l._activeObject=m,m.setCoords(),m}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){var a=!0;return this.forEachObject(function(l){l.setCoords(a)}),this},_calcBounds:function(a){for(var l=[],h=[],m,_,u,x=["tr","br","bl","tl"],T=0,A=this._objects.length,D,V=x.length;T<A;++T){for(m=this._objects[T],u=m.calcACoords(),D=0;D<V;D++)_=x[D],l.push(u[_].x),h.push(u[_].y);m.aCoords=u}this._getBounds(l,h,a)},_getBounds:function(a,l,h){var m=new p.Point(b(a),b(l)),_=new p.Point(v(a),v(l)),u=m.y||0,x=m.x||0,T=_.x-m.x||0,A=_.y-m.y||0;this.width=T,this.height=A,h||this.setPositionByOrigin({x,y:u},"left","top")},_toSVG:function(a){for(var l=["<g ","COMMON_PARTS",` >
`],h=0,m=this._objects.length;h<m;h++)l.push("		",this._objects[h].toSVG(a));return l.push(`</g>
`),l},getSvgStyles:function(){var a=typeof this.opacity<"u"&&this.opacity!==1?"opacity: "+this.opacity+";":"",l=this.visible?"":" visibility: hidden;";return[a,this.getSvgFilter(),l].join("")},toClipPathSVG:function(a){for(var l=[],h=0,m=this._objects.length;h<m;h++)l.push("	",this._objects[h].toClipPathSVG(a));return this._createBaseClipPathSVGMarkup(l,{reviver:a})}}),p.Group.fromObject=function(a,l){var h=a.objects,m=p.util.object.clone(a,!0);if(delete m.objects,typeof h=="string"){p.loadSVGFromURL(h,function(_){var u=p.util.groupSVGElements(_,a,h),x=m.clipPath;delete m.clipPath,u.set(m),x?p.util.enlivenObjects([x],function(T){u.clipPath=T[0],l&&l(u)}):l&&l(u)});return}p.util.enlivenObjects(h,function(_){p.util.enlivenObjectEnlivables(a,m,function(){l&&l(new p.Group(_,m,!0))})})})}($),function(s){var p=s.fabric||(s.fabric={});p.ActiveSelection||(p.ActiveSelection=p.util.createClass(p.Group,{type:"activeSelection",initialize:function(b,v){v=v||{},this._objects=b||[];for(var a=this._objects.length;a--;)this._objects[a].group=this;v.originX&&(this.originX=v.originX),v.originY&&(this.originY=v.originY),this._calcBounds(),this._updateObjectsCoords(),p.Object.prototype.initialize.call(this,v),this.setCoords()},toGroup:function(){var b=this._objects.concat();this._objects=[];var v=p.Object.prototype.toObject.call(this),a=new p.Group([]);if(delete v.type,a.set(v),b.forEach(function(h){h.canvas.remove(h),h.group=a}),a._objects=b,!this.canvas)return a;var l=this.canvas;return l.add(a),l._activeObject=a,a.setCoords(),a},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(b,v,a){b.save(),b.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",b,v),a=a||{},typeof a.hasControls>"u"&&(a.hasControls=!1),a.forActiveSelection=!0;for(var l=0,h=this._objects.length;l<h;l++)this._objects[l]._renderControls(b,a);b.restore()}}),p.ActiveSelection.fromObject=function(b,v){p.util.enlivenObjects(b.objects,function(a){delete b.objects,v&&v(new p.ActiveSelection(a,b,!0))})})}($),function(s){var p=S.util.object.extend;if(s.fabric||(s.fabric={}),s.fabric.Image){S.warn("fabric.Image is already defined.");return}S.Image=S.util.createClass(S.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:S.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:S.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(b,v){v||(v={}),this.filters=[],this.cacheKey="texture"+S.Object.__uid++,this.callSuper("initialize",v),this._initElement(b,v)},getElement:function(){return this._element||{}},setElement:function(b,v){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=b,this._originalElement=b,this._initConfig(v),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(b){var v=S.filterBackend;v&&v.evictCachesForKey&&v.evictCachesForKey(b)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((function(b){S.util.cleanUpJsdomNode(this[b]),this[b]=void 0}).bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var b=this.getElement();return{width:b.naturalWidth||b.width,height:b.naturalHeight||b.height}},_stroke:function(b){if(!(!this.stroke||this.strokeWidth===0)){var v=this.width/2,a=this.height/2;b.beginPath(),b.moveTo(-v,-a),b.lineTo(v,-a),b.lineTo(v,a),b.lineTo(-v,a),b.lineTo(-v,-a),b.closePath()}},toObject:function(b){var v=[];this.filters.forEach(function(l){l&&v.push(l.toObject())});var a=p(this.callSuper("toObject",["cropX","cropY"].concat(b)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:v});return this.resizeFilter&&(a.resizeFilter=this.resizeFilter.toObject()),a},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var b=[],v=[],a,l=this._element,h=-this.width/2,m=-this.height/2,_="",u="";if(!l)return[];if(this.hasCrop()){var x=S.Object.__uid++;b.push('<clipPath id="imageCrop_'+x+`">
`,'	<rect x="'+h+'" y="'+m+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),_=' clip-path="url(#imageCrop_'+x+')" '}if(this.imageSmoothing||(u='" image-rendering="optimizeSpeed'),v.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',h-this.cropX,'" y="',m-this.cropY,'" width="',l.width||l.naturalWidth,'" height="',l.height||l.height,u,'"',_,`></image>
`),this.stroke||this.strokeDashArray){var T=this.fill;this.fill=null,a=["	<rect ",'x="',h,'" y="',m,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),`"/>
`],this.fill=T}return this.paintFirst!=="fill"?b=b.concat(a,v):b=b.concat(v,a),b},getSrc:function(b){var v=b?this._element:this._originalElement;return v?v.toDataURL?v.toDataURL():this.srcFromAttribute?v.getAttribute("src"):v.src:this.src||""},setSrc:function(b,v,a){return S.util.loadImage(b,function(l,h){this.setElement(l,a),this._setWidthHeight(),v&&v(this,h)},this,a&&a.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var b=this.resizeFilter,v=this.minimumScaleTrigger,a=this.getTotalObjectScaling(),l=a.scaleX,h=a.scaleY,m=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!b||l>v&&h>v){this._element=m,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=l,this._lastScaleY=h;return}S.filterBackend||(S.filterBackend=S.initFilterBackend());var _=S.util.createCanvasElement(),u=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,x=m.width,T=m.height;_.width=x,_.height=T,this._element=_,this._lastScaleX=b.scaleX=l,this._lastScaleY=b.scaleY=h,S.filterBackend.applyFilters([b],m,x,T,this._element,u),this._filterScalingX=_.width/this._originalElement.width,this._filterScalingY=_.height/this._originalElement.height},applyFilters:function(b){if(b=b||this.filters||[],b=b.filter(function(m){return m&&!m.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),b.length===0)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var v=this._originalElement,a=v.naturalWidth||v.width,l=v.naturalHeight||v.height;if(this._element===this._originalElement){var h=S.util.createCanvasElement();h.width=a,h.height=l,this._element=h,this._filteredEl=h}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,a,l),this._lastScaleX=1,this._lastScaleY=1;return S.filterBackend||(S.filterBackend=S.initFilterBackend()),S.filterBackend.applyFilters(b,this._originalElement,a,l,this._element,this.cacheKey),(this._originalElement.width!==this._element.width||this._originalElement.height!==this._element.height)&&(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(b){S.util.setImageSmoothing(b,this.imageSmoothing),this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(b),this._renderPaintInOrder(b)},drawCacheOnCanvas:function(b){S.util.setImageSmoothing(b,this.imageSmoothing),S.Object.prototype.drawCacheOnCanvas.call(this,b)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(b){var v=this._element;if(v){var a=this._filterScalingX,l=this._filterScalingY,h=this.width,m=this.height,_=Math.min,u=Math.max,x=u(this.cropX,0),T=u(this.cropY,0),A=v.naturalWidth||v.width,D=v.naturalHeight||v.height,V=x*a,X=T*l,ie=_(h*a,A-V),ve=_(m*l,D-X),Fe=-h/2,Ye=-m/2,Ze=_(h,A/a-x),Je=_(m,D/l-T);v&&b.drawImage(v,V,X,ie,ve,Fe,Ye,Ze,Je)}},_needsResize:function(){var b=this.getTotalObjectScaling();return b.scaleX!==this._lastScaleX||b.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(b,v){this.setElement(S.util.getById(b),v),S.util.addClass(this.getElement(),S.Image.CSS_CANVAS)},_initConfig:function(b){b||(b={}),this.setOptions(b),this._setWidthHeight(b)},_initFilters:function(b,v){b&&b.length?S.util.enlivenObjects(b,function(a){v&&v(a)},"fabric.Image.filters"):v&&v()},_setWidthHeight:function(b){b||(b={});var v=this.getElement();this.width=b.width||v.naturalWidth||v.width||0,this.height=b.height||v.naturalHeight||v.height||0},parsePreserveAspectRatioAttribute:function(){var b=S.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),v=this._element.width,a=this._element.height,l=1,h=1,m=0,_=0,u=0,x=0,T,A=this.width,D=this.height,V={width:A,height:D};return b&&(b.alignX!=="none"||b.alignY!=="none")?(b.meetOrSlice==="meet"&&(l=h=S.util.findScaleToFit(this._element,V),T=(A-v*l)/2,b.alignX==="Min"&&(m=-T),b.alignX==="Max"&&(m=T),T=(D-a*h)/2,b.alignY==="Min"&&(_=-T),b.alignY==="Max"&&(_=T)),b.meetOrSlice==="slice"&&(l=h=S.util.findScaleToCover(this._element,V),T=v-A/l,b.alignX==="Mid"&&(u=T/2),b.alignX==="Max"&&(u=T),T=a-D/h,b.alignY==="Mid"&&(x=T/2),b.alignY==="Max"&&(x=T),v=A/l,a=D/h)):(l=A/v,h=D/a),{width:v,height:a,scaleX:l,scaleY:h,offsetLeft:m,offsetTop:_,cropX:u,cropY:x}}}),S.Image.CSS_CANVAS="canvas-img",S.Image.prototype.getSvgSrc=S.Image.prototype.getSrc,S.Image.fromObject=function(b,v){var a=S.util.object.clone(b);S.util.loadImage(a.src,function(l,h){if(h){v&&v(null,!0);return}S.Image.prototype._initFilters.call(a,a.filters,function(m){a.filters=m||[],S.Image.prototype._initFilters.call(a,[a.resizeFilter],function(_){a.resizeFilter=_[0],S.util.enlivenObjectEnlivables(a,a,function(){var u=new S.Image(l,a);v(u,!1)})})})},null,a.crossOrigin)},S.Image.fromURL=function(b,v,a){S.util.loadImage(b,function(l,h){v&&v(new S.Image(l,a),h)},null,a&&a.crossOrigin)},S.Image.ATTRIBUTE_NAMES=S.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),S.Image.fromElement=function(b,v,a){var l=S.parseAttributes(b,S.Image.ATTRIBUTE_NAMES);S.Image.fromURL(l["xlink:href"],v,p(a?S.util.object.clone(a):{},l))}}($),S.util.object.extend(S.Object.prototype,{_getAngleValueForStraighten:function(){var s=this.angle%360;return s>0?Math.round((s-1)/90)*90:Math.round(s/90)*90},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(s){s=s||{};var p=function(){},b=s.onComplete||p,v=s.onChange||p,a=this;return S.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(l){a.rotate(l),v()},onComplete:function(){a.setCoords(),b()}})}}),S.util.object.extend(S.StaticCanvas.prototype,{straightenObject:function(s){return s.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(s){return s.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){function s(b,v){var a="precision "+v+` float;
void main(){}`,l=b.createShader(b.FRAGMENT_SHADER);return b.shaderSource(l,a),b.compileShader(l),!!b.getShaderParameter(l,b.COMPILE_STATUS)}S.isWebglSupported=function(b){if(S.isLikelyNode)return!1;b=b||S.WebglFilterBackend.prototype.tileSize;var v=document.createElement("canvas"),a=v.getContext("webgl")||v.getContext("experimental-webgl"),l=!1;if(a){S.maxTextureSize=a.getParameter(a.MAX_TEXTURE_SIZE),l=S.maxTextureSize>=b;for(var h=["highp","mediump","lowp"],m=0;m<3;m++)if(s(a,h[m])){S.webGlPrecision=h[m];break}}return this.isSupported=l,l},S.WebglFilterBackend=p;function p(b){b&&b.tileSize&&(this.tileSize=b.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}p.prototype={tileSize:2048,resources:{},setupGLContext:function(b,v){this.dispose(),this.createWebGLCanvas(b,v),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(b,v)},chooseFastestCopyGLTo2DMethod:function(b,v){var a=typeof window.performance<"u",l;try{new ImageData(1,1),l=!0}catch{l=!1}var h=typeof ArrayBuffer<"u",m=typeof Uint8ClampedArray<"u";if(a&&l&&h&&m){var _=S.util.createCanvasElement(),u=new ArrayBuffer(b*v*4);if(S.forceGLPutImageData){this.imageBuffer=u,this.copyGLTo2D=j;return}var x={imageBuffer:u,destinationWidth:b,destinationHeight:v,targetCanvas:_},T,A,D;_.width=b,_.height=v,T=window.performance.now(),Ie.call(x,this.gl,x),A=window.performance.now()-T,T=window.performance.now(),j.call(x,this.gl,x),D=window.performance.now()-T,A>D?(this.imageBuffer=u,this.copyGLTo2D=j):this.copyGLTo2D=Ie}},createWebGLCanvas:function(b,v){var a=S.util.createCanvasElement();a.width=b,a.height=v;var l={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},h=a.getContext("webgl",l);h||(h=a.getContext("experimental-webgl",l)),h&&(h.clearColor(0,0,0,0),this.canvas=a,this.gl=h)},applyFilters:function(b,v,a,l,h,m){var _=this.gl,u;m&&(u=this.getCachedTexture(m,v));var x={originalWidth:v.width||v.originalWidth,originalHeight:v.height||v.originalHeight,sourceWidth:a,sourceHeight:l,destinationWidth:a,destinationHeight:l,context:_,sourceTexture:this.createTexture(_,a,l,!u&&v),targetTexture:this.createTexture(_,a,l),originalTexture:u||this.createTexture(_,a,l,!u&&v),passes:b.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:h},T=_.createFramebuffer();return _.bindFramebuffer(_.FRAMEBUFFER,T),b.forEach(function(A){A&&A.applyTo(x)}),ue(x),this.copyGLTo2D(_,x),_.bindTexture(_.TEXTURE_2D,null),_.deleteTexture(x.sourceTexture),_.deleteTexture(x.targetTexture),_.deleteFramebuffer(T),h.getContext("2d").setTransform(1,0,0,1,0,0),x},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(b,v,a,l,h){var m=b.createTexture();return b.bindTexture(b.TEXTURE_2D,m),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,h||b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,h||b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),l?b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,l):b.texImage2D(b.TEXTURE_2D,0,b.RGBA,v,a,0,b.RGBA,b.UNSIGNED_BYTE,null),m},getCachedTexture:function(b,v){if(this.textureCache[b])return this.textureCache[b];var a=this.createTexture(this.gl,v.width,v.height,v);return this.textureCache[b]=a,a},evictCachesForKey:function(b){this.textureCache[b]&&(this.gl.deleteTexture(this.textureCache[b]),delete this.textureCache[b])},copyGLTo2D:Ie,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var b=this.gl,v={renderer:"",vendor:""};if(!b)return v;var a=b.getExtension("WEBGL_debug_renderer_info");if(a){var l=b.getParameter(a.UNMASKED_RENDERER_WEBGL),h=b.getParameter(a.UNMASKED_VENDOR_WEBGL);l&&(v.renderer=l.toLowerCase()),h&&(v.vendor=h.toLowerCase())}return this.gpuInfo=v,v}}}();function ue(s){var p=s.targetCanvas,b=p.width,v=p.height,a=s.destinationWidth,l=s.destinationHeight;(b!==a||v!==l)&&(p.width=a,p.height=l)}function Ie(s,p){var b=s.canvas,v=p.targetCanvas,a=v.getContext("2d");a.translate(0,v.height),a.scale(1,-1);var l=b.height-v.height;a.drawImage(b,0,l,v.width,v.height,0,0,v.width,v.height)}function j(s,p){var b=p.targetCanvas,v=b.getContext("2d"),a=p.destinationWidth,l=p.destinationHeight,h=a*l*4,m=new Uint8Array(this.imageBuffer,0,h),_=new Uint8ClampedArray(this.imageBuffer,0,h);s.readPixels(0,0,a,l,s.RGBA,s.UNSIGNED_BYTE,m);var u=new ImageData(_,a,l);v.putImageData(u,0,0)}(function(){var s=function(){};S.Canvas2dFilterBackend=p;function p(){}p.prototype={evictCachesForKey:s,dispose:s,clearWebGLCaches:s,resources:{},applyFilters:function(b,v,a,l,h){var m=h.getContext("2d");m.drawImage(v,0,0,a,l);var _=m.getImageData(0,0,a,l),u=m.getImageData(0,0,a,l),x={sourceWidth:a,sourceHeight:l,imageData:_,originalEl:v,originalImageData:u,canvasEl:h,ctx:m,filterBackend:this};return b.forEach(function(T){T.applyTo(x)}),(x.imageData.width!==a||x.imageData.height!==l)&&(h.width=x.imageData.width,h.height=x.imageData.height),m.putImageData(x.imageData,0,0),x}}})(),S.Image=S.Image||{},S.Image.filters=S.Image.filters||{},S.Image.filters.BaseFilter=S.util.createClass({type:"BaseFilter",vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
void main() {
vTexCoord = aPosition;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:`precision highp float;
varying vec2 vTexCoord;
uniform sampler2D uTexture;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
}`,initialize:function(s){s&&this.setOptions(s)},setOptions:function(s){for(var p in s)this[p]=s[p]},createProgram:function(s,p,b){p=p||this.fragmentSource,b=b||this.vertexSource,S.webGlPrecision!=="highp"&&(p=p.replace(/precision highp float/g,"precision "+S.webGlPrecision+" float"));var v=s.createShader(s.VERTEX_SHADER);if(s.shaderSource(v,b),s.compileShader(v),!s.getShaderParameter(v,s.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+s.getShaderInfoLog(v));var a=s.createShader(s.FRAGMENT_SHADER);if(s.shaderSource(a,p),s.compileShader(a),!s.getShaderParameter(a,s.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+s.getShaderInfoLog(a));var l=s.createProgram();if(s.attachShader(l,v),s.attachShader(l,a),s.linkProgram(l),!s.getProgramParameter(l,s.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+s.getProgramInfoLog(l));var h=this.getAttributeLocations(s,l),m=this.getUniformLocations(s,l)||{};return m.uStepW=s.getUniformLocation(l,"uStepW"),m.uStepH=s.getUniformLocation(l,"uStepH"),{program:l,attributeLocations:h,uniformLocations:m}},getAttributeLocations:function(s,p){return{aPosition:s.getAttribLocation(p,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(s,p,b){var v=p.aPosition,a=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,a),s.enableVertexAttribArray(v),s.vertexAttribPointer(v,2,s.FLOAT,!1,0,0),s.bufferData(s.ARRAY_BUFFER,b,s.STATIC_DRAW)},_setupFrameBuffer:function(s){var p=s.context,b,v;s.passes>1?(b=s.destinationWidth,v=s.destinationHeight,(s.sourceWidth!==b||s.sourceHeight!==v)&&(p.deleteTexture(s.targetTexture),s.targetTexture=s.filterBackend.createTexture(p,b,v)),p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,s.targetTexture,0)):(p.bindFramebuffer(p.FRAMEBUFFER,null),p.finish())},_swapTextures:function(s){s.passes--,s.pass++;var p=s.targetTexture;s.targetTexture=s.sourceTexture,s.sourceTexture=p},isNeutralState:function(){var s=this.mainParameter,p=S.Image.filters[this.type].prototype;if(s)if(Array.isArray(p[s])){for(var b=p[s].length;b--;)if(this[s][b]!==p[s][b])return!1;return!0}else return p[s]===this[s];else return!1},applyTo:function(s){s.webgl?(this._setupFrameBuffer(s),this.applyToWebGL(s),this._swapTextures(s)):this.applyTo2d(s)},retrieveShader:function(s){return s.programCache.hasOwnProperty(this.type)||(s.programCache[this.type]=this.createProgram(s.context)),s.programCache[this.type]},applyToWebGL:function(s){var p=s.context,b=this.retrieveShader(s);s.pass===0&&s.originalTexture?p.bindTexture(p.TEXTURE_2D,s.originalTexture):p.bindTexture(p.TEXTURE_2D,s.sourceTexture),p.useProgram(b.program),this.sendAttributeData(p,b.attributeLocations,s.aPosition),p.uniform1f(b.uniformLocations.uStepW,1/s.sourceWidth),p.uniform1f(b.uniformLocations.uStepH,1/s.sourceHeight),this.sendUniformData(p,b.uniformLocations),p.viewport(0,0,s.destinationWidth,s.destinationHeight),p.drawArrays(p.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(s,p,b){s.activeTexture(b),s.bindTexture(s.TEXTURE_2D,p),s.activeTexture(s.TEXTURE0)},unbindAdditionalTexture:function(s,p){s.activeTexture(p),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(s){this[this.mainParameter]=s},sendUniformData:function(){},createHelpLayer:function(s){if(!s.helpLayer){var p=document.createElement("canvas");p.width=s.sourceWidth,p.height=s.sourceHeight,s.helpLayer=p}},toObject:function(){var s={type:this.type},p=this.mainParameter;return p&&(s[p]=this[p]),s},toJSON:function(){return this.toObject()}}),S.Image.filters.BaseFilter.fromObject=function(s,p){var b=new S.Image.filters[s.type](s);return p&&p(b),b},function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass;b.ColorMatrix=v(b.BaseFilter,{type:"ColorMatrix",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
uniform mat4 uColorMatrix;
uniform vec4 uConstants;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color *= uColorMatrix;
color += uConstants;
gl_FragColor = color;
}`,matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(a){this.callSuper("initialize",a),this.matrix=this.matrix.slice(0)},applyTo2d:function(a){var l=a.imageData,h=l.data,m=h.length,_=this.matrix,u,x,T,A,D,V=this.colorsOnly;for(D=0;D<m;D+=4)u=h[D],x=h[D+1],T=h[D+2],V?(h[D]=u*_[0]+x*_[1]+T*_[2]+_[4]*255,h[D+1]=u*_[5]+x*_[6]+T*_[7]+_[9]*255,h[D+2]=u*_[10]+x*_[11]+T*_[12]+_[14]*255):(A=h[D+3],h[D]=u*_[0]+x*_[1]+T*_[2]+A*_[3]+_[4]*255,h[D+1]=u*_[5]+x*_[6]+T*_[7]+A*_[8]+_[9]*255,h[D+2]=u*_[10]+x*_[11]+T*_[12]+A*_[13]+_[14]*255,h[D+3]=u*_[15]+x*_[16]+T*_[17]+A*_[18]+_[19]*255)},getUniformLocations:function(a,l){return{uColorMatrix:a.getUniformLocation(l,"uColorMatrix"),uConstants:a.getUniformLocation(l,"uConstants")}},sendUniformData:function(a,l){var h=this.matrix,m=[h[0],h[1],h[2],h[3],h[5],h[6],h[7],h[8],h[10],h[11],h[12],h[13],h[15],h[16],h[17],h[18]],_=[h[4],h[9],h[14],h[19]];a.uniformMatrix4fv(l.uColorMatrix,!1,m),a.uniform4fv(l.uConstants,_)}}),p.Image.filters.ColorMatrix.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass;b.Brightness=v(b.BaseFilter,{type:"Brightness",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBrightness;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += uBrightness;
gl_FragColor = color;
}`,brightness:0,mainParameter:"brightness",applyTo2d:function(a){if(this.brightness!==0){var l=a.imageData,h=l.data,m,_=h.length,u=Math.round(this.brightness*255);for(m=0;m<_;m+=4)h[m]=h[m]+u,h[m+1]=h[m+1]+u,h[m+2]=h[m+2]+u}},getUniformLocations:function(a,l){return{uBrightness:a.getUniformLocation(l,"uBrightness")}},sendUniformData:function(a,l){a.uniform1f(l.uBrightness,this.brightness)}}),p.Image.filters.Brightness.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.util.object.extend,v=p.Image.filters,a=p.util.createClass;v.Convolute=a(v.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_3_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_5_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_5_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_7_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_7_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_9_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_9_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`},retrieveShader:function(l){var h=Math.sqrt(this.matrix.length),m=this.type+"_"+h+"_"+(this.opaque?1:0),_=this.fragmentSource[m];return l.programCache.hasOwnProperty(m)||(l.programCache[m]=this.createProgram(l.context,_)),l.programCache[m]},applyTo2d:function(l){var h=l.imageData,m=h.data,_=this.matrix,u=Math.round(Math.sqrt(_.length)),x=Math.floor(u/2),T=h.width,A=h.height,D=l.ctx.createImageData(T,A),V=D.data,X=this.opaque?1:0,ie,ve,Fe,Ye,Ze,Je,ct,nt,vt,Mt,st,bt,ee;for(st=0;st<A;st++)for(Mt=0;Mt<T;Mt++){for(Ze=(st*T+Mt)*4,ie=0,ve=0,Fe=0,Ye=0,ee=0;ee<u;ee++)for(bt=0;bt<u;bt++)ct=st+ee-x,Je=Mt+bt-x,!(ct<0||ct>=A||Je<0||Je>=T)&&(nt=(ct*T+Je)*4,vt=_[ee*u+bt],ie+=m[nt]*vt,ve+=m[nt+1]*vt,Fe+=m[nt+2]*vt,X||(Ye+=m[nt+3]*vt));V[Ze]=ie,V[Ze+1]=ve,V[Ze+2]=Fe,X?V[Ze+3]=m[Ze+3]:V[Ze+3]=Ye}l.imageData=D},getUniformLocations:function(l,h){return{uMatrix:l.getUniformLocation(h,"uMatrix"),uOpaque:l.getUniformLocation(h,"uOpaque"),uHalfSize:l.getUniformLocation(h,"uHalfSize"),uSize:l.getUniformLocation(h,"uSize")}},sendUniformData:function(l,h){l.uniform1fv(h.uMatrix,this.matrix)},toObject:function(){return b(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),p.Image.filters.Convolute.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass;b.Grayscale=v(b.BaseFilter,{type:"Grayscale",fragmentSource:{average:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float average = (color.r + color.b + color.g) / 3.0;
gl_FragColor = vec4(average, average, average, color.a);
}`,lightness:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
gl_FragColor = vec4(average, average, average, col.a);
}`,luminosity:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
gl_FragColor = vec4(average, average, average, col.a);
}`},mode:"average",mainParameter:"mode",applyTo2d:function(a){var l=a.imageData,h=l.data,m,_=h.length,u,x=this.mode;for(m=0;m<_;m+=4)x==="average"?u=(h[m]+h[m+1]+h[m+2])/3:x==="lightness"?u=(Math.min(h[m],h[m+1],h[m+2])+Math.max(h[m],h[m+1],h[m+2]))/2:x==="luminosity"&&(u=.21*h[m]+.72*h[m+1]+.07*h[m+2]),h[m]=u,h[m+1]=u,h[m+2]=u},retrieveShader:function(a){var l=this.type+"_"+this.mode;if(!a.programCache.hasOwnProperty(l)){var h=this.fragmentSource[this.mode];a.programCache[l]=this.createProgram(a.context,h)}return a.programCache[l]},getUniformLocations:function(a,l){return{uMode:a.getUniformLocation(l,"uMode")}},sendUniformData:function(a,l){var h=1;a.uniform1i(l.uMode,h)},isNeutralState:function(){return!1}}),p.Image.filters.Grayscale.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass;b.Invert=v(b.BaseFilter,{type:"Invert",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform int uInvert;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
if (uInvert == 1) {
gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
} else {
gl_FragColor = color;
}
}`,invert:!0,mainParameter:"invert",applyTo2d:function(a){var l=a.imageData,h=l.data,m,_=h.length;for(m=0;m<_;m+=4)h[m]=255-h[m],h[m+1]=255-h[m+1],h[m+2]=255-h[m+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(a,l){return{uInvert:a.getUniformLocation(l,"uInvert")}},sendUniformData:function(a,l){a.uniform1i(l.uInvert,this.invert)}}),p.Image.filters.Invert.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.util.object.extend,v=p.Image.filters,a=p.util.createClass;v.Noise=a(v.BaseFilter,{type:"Noise",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uStepH;
uniform float uNoise;
uniform float uSeed;
varying vec2 vTexCoord;
float rand(vec2 co, float seed, float vScale) {
return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
}
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
gl_FragColor = color;
}`,mainParameter:"noise",noise:0,applyTo2d:function(l){if(this.noise!==0){var h=l.imageData,m=h.data,_,u=m.length,x=this.noise,T;for(_=0,u=m.length;_<u;_+=4)T=(.5-Math.random())*x,m[_]+=T,m[_+1]+=T,m[_+2]+=T}},getUniformLocations:function(l,h){return{uNoise:l.getUniformLocation(h,"uNoise"),uSeed:l.getUniformLocation(h,"uSeed")}},sendUniformData:function(l,h){l.uniform1f(h.uNoise,this.noise/255),l.uniform1f(h.uSeed,Math.random())},toObject:function(){return b(this.callSuper("toObject"),{noise:this.noise})}}),p.Image.filters.Noise.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass;b.Pixelate=v(b.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBlocksize;
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
float blockW = uBlocksize * uStepW;
float blockH = uBlocksize * uStepW;
int posX = int(vTexCoord.x / blockW);
int posY = int(vTexCoord.y / blockH);
float fposX = float(posX);
float fposY = float(posY);
vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
vec4 color = texture2D(uTexture, squareCoords);
gl_FragColor = color;
}`,applyTo2d:function(a){var l=a.imageData,h=l.data,m=l.height,_=l.width,u,x,T,A,D,V,X,ie,ve,Fe,Ye;for(x=0;x<m;x+=this.blocksize)for(T=0;T<_;T+=this.blocksize)for(u=x*4*_+T*4,A=h[u],D=h[u+1],V=h[u+2],X=h[u+3],Fe=Math.min(x+this.blocksize,m),Ye=Math.min(T+this.blocksize,_),ie=x;ie<Fe;ie++)for(ve=T;ve<Ye;ve++)u=ie*4*_+ve*4,h[u]=A,h[u+1]=D,h[u+2]=V,h[u+3]=X},isNeutralState:function(){return this.blocksize===1},getUniformLocations:function(a,l){return{uBlocksize:a.getUniformLocation(l,"uBlocksize"),uStepW:a.getUniformLocation(l,"uStepW"),uStepH:a.getUniformLocation(l,"uStepH")}},sendUniformData:function(a,l){a.uniform1f(l.uBlocksize,this.blocksize)}}),p.Image.filters.Pixelate.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.util.object.extend,v=p.Image.filters,a=p.util.createClass;v.RemoveColor=a(v.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
gl_FragColor.a = 0.0;
}
}`,distance:.02,useAlpha:!1,applyTo2d:function(l){var h=l.imageData,m=h.data,_,u=this.distance*255,x,T,A,D=new p.Color(this.color).getSource(),V=[D[0]-u,D[1]-u,D[2]-u],X=[D[0]+u,D[1]+u,D[2]+u];for(_=0;_<m.length;_+=4)x=m[_],T=m[_+1],A=m[_+2],x>V[0]&&T>V[1]&&A>V[2]&&x<X[0]&&T<X[1]&&A<X[2]&&(m[_+3]=0)},getUniformLocations:function(l,h){return{uLow:l.getUniformLocation(h,"uLow"),uHigh:l.getUniformLocation(h,"uHigh")}},sendUniformData:function(l,h){var m=new p.Color(this.color).getSource(),_=parseFloat(this.distance),u=[0+m[0]/255-_,0+m[1]/255-_,0+m[2]/255-_,1],x=[m[0]/255+_,m[1]/255+_,m[2]/255+_,1];l.uniform4fv(h.uLow,u),l.uniform4fv(h.uHigh,x)},toObject:function(){return b(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),p.Image.filters.RemoveColor.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass,a={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var l in a)b[l]=v(b.ColorMatrix,{type:l,matrix:a[l],mainParameter:!1,colorsOnly:!0}),p.Image.filters[l].fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric,b=p.Image.filters,v=p.util.createClass;b.BlendColor=v(b.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,diff:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`if (uColor.r < 0.5) {
gl_FragColor.r *= 2.0 * uColor.r;
} else {
gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
}
if (uColor.g < 0.5) {
gl_FragColor.g *= 2.0 * uColor.g;
} else {
gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
}
if (uColor.b < 0.5) {
gl_FragColor.b *= 2.0 * uColor.b;
} else {
gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
}
`,tint:`gl_FragColor.rgb *= (1.0 - uColor.a);
gl_FragColor.rgb += uColor.rgb;
`},buildSource:function(a){return`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uColor;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
gl_FragColor = color;
if (color.a > 0.0) {
`+this.fragmentSource[a]+`}
}`},retrieveShader:function(a){var l=this.type+"_"+this.mode,h;return a.programCache.hasOwnProperty(l)||(h=this.buildSource(this.mode),a.programCache[l]=this.createProgram(a.context,h)),a.programCache[l]},applyTo2d:function(a){var l=a.imageData,h=l.data,m=h.length,_,u,x,T,A,D,V,X=1-this.alpha;V=new p.Color(this.color).getSource(),_=V[0]*this.alpha,u=V[1]*this.alpha,x=V[2]*this.alpha;for(var ie=0;ie<m;ie+=4)switch(T=h[ie],A=h[ie+1],D=h[ie+2],this.mode){case"multiply":h[ie]=T*_/255,h[ie+1]=A*u/255,h[ie+2]=D*x/255;break;case"screen":h[ie]=255-(255-T)*(255-_)/255,h[ie+1]=255-(255-A)*(255-u)/255,h[ie+2]=255-(255-D)*(255-x)/255;break;case"add":h[ie]=T+_,h[ie+1]=A+u,h[ie+2]=D+x;break;case"diff":case"difference":h[ie]=Math.abs(T-_),h[ie+1]=Math.abs(A-u),h[ie+2]=Math.abs(D-x);break;case"subtract":h[ie]=T-_,h[ie+1]=A-u,h[ie+2]=D-x;break;case"darken":h[ie]=Math.min(T,_),h[ie+1]=Math.min(A,u),h[ie+2]=Math.min(D,x);break;case"lighten":h[ie]=Math.max(T,_),h[ie+1]=Math.max(A,u),h[ie+2]=Math.max(D,x);break;case"overlay":h[ie]=_<128?2*T*_/255:255-2*(255-T)*(255-_)/255,h[ie+1]=u<128?2*A*u/255:255-2*(255-A)*(255-u)/255,h[ie+2]=x<128?2*D*x/255:255-2*(255-D)*(255-x)/255;break;case"exclusion":h[ie]=_+T-2*_*T/255,h[ie+1]=u+A-2*u*A/255,h[ie+2]=x+D-2*x*D/255;break;case"tint":h[ie]=_+T*X,h[ie+1]=u+A*X,h[ie+2]=x+D*X}},getUniformLocations:function(a,l){return{uColor:a.getUniformLocation(l,"uColor")}},sendUniformData:function(a,l){var h=new p.Color(this.color).getSource();h[0]=this.alpha*h[0]/255,h[1]=this.alpha*h[1]/255,h[2]=this.alpha*h[2]/255,h[3]=this.alpha,a.uniform4fv(l.uColor,h)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),p.Image.filters.BlendColor.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric,b=p.Image.filters,v=p.util.createClass;b.BlendImage=v(b.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
uniform mat3 uTransformMatrix;
void main() {
vTexCoord = aPosition;
vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:{multiply:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.rgba *= color2.rgba;
gl_FragColor = color;
}`,mask:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.a = color2.a;
gl_FragColor = color;
}`},retrieveShader:function(a){var l=this.type+"_"+this.mode,h=this.fragmentSource[this.mode];return a.programCache.hasOwnProperty(l)||(a.programCache[l]=this.createProgram(a.context,h)),a.programCache[l]},applyToWebGL:function(a){var l=a.context,h=this.createTexture(a.filterBackend,this.image);this.bindAdditionalTexture(l,h,l.TEXTURE1),this.callSuper("applyToWebGL",a),this.unbindAdditionalTexture(l,l.TEXTURE1)},createTexture:function(a,l){return a.getCachedTexture(l.cacheKey,l._element)},calculateMatrix:function(){var a=this.image,l=a._element.width,h=a._element.height;return[1/a.scaleX,0,0,0,1/a.scaleY,0,-a.left/l,-a.top/h,1]},applyTo2d:function(a){var l=a.imageData,h=a.filterBackend.resources,m=l.data,_=m.length,u=l.width,x=l.height,T,A,D,V,X,ie,ve,Fe,Ye,Ze,Je=this.image,ct;h.blendImage||(h.blendImage=p.util.createCanvasElement()),Ye=h.blendImage,Ze=Ye.getContext("2d"),Ye.width!==u||Ye.height!==x?(Ye.width=u,Ye.height=x):Ze.clearRect(0,0,u,x),Ze.setTransform(Je.scaleX,0,0,Je.scaleY,Je.left,Je.top),Ze.drawImage(Je._element,0,0,u,x),ct=Ze.getImageData(0,0,u,x).data;for(var nt=0;nt<_;nt+=4)switch(X=m[nt],ie=m[nt+1],ve=m[nt+2],Fe=m[nt+3],T=ct[nt],A=ct[nt+1],D=ct[nt+2],V=ct[nt+3],this.mode){case"multiply":m[nt]=X*T/255,m[nt+1]=ie*A/255,m[nt+2]=ve*D/255,m[nt+3]=Fe*V/255;break;case"mask":m[nt+3]=V;break}},getUniformLocations:function(a,l){return{uTransformMatrix:a.getUniformLocation(l,"uTransformMatrix"),uImage:a.getUniformLocation(l,"uImage")}},sendUniformData:function(a,l){var h=this.calculateMatrix();a.uniform1i(l.uImage,1),a.uniformMatrix3fv(l.uTransformMatrix,!1,h)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),p.Image.filters.BlendImage.fromObject=function(a,l){p.Image.fromObject(a.image,function(h){var m=p.util.object.clone(a);m.image=h,l(new p.Image.filters.BlendImage(m))})}}($),function(s){var p=s.fabric||(s.fabric={}),b=Math.pow,v=Math.floor,a=Math.sqrt,l=Math.abs,h=Math.round,m=Math.sin,_=Math.ceil,u=p.Image.filters,x=p.util.createClass;u.Resize=x(u.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(T,A){return{uDelta:T.getUniformLocation(A,"uDelta"),uTaps:T.getUniformLocation(A,"uTaps")}},sendUniformData:function(T,A){T.uniform2fv(A.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),T.uniform1fv(A.uTaps,this.taps)},retrieveShader:function(T){var A=this.getFilterWindow(),D=this.type+"_"+A;if(!T.programCache.hasOwnProperty(D)){var V=this.generateShader(A);T.programCache[D]=this.createProgram(T.context,V)}return T.programCache[D]},getFilterWindow:function(){var T=this.tempScale;return Math.ceil(this.lanczosLobes/T)},getTaps:function(){for(var T=this.lanczosCreate(this.lanczosLobes),A=this.tempScale,D=this.getFilterWindow(),V=new Array(D),X=1;X<=D;X++)V[X-1]=T(X*A);return V},generateShader:function(V){for(var A=new Array(V),D=this.fragmentSourceTOP,V,X=1;X<=V;X++)A[X-1]=X+".0 * uDelta";return D+="uniform float uTaps["+V+`];
`,D+=`void main() {
`,D+=`  vec4 color = texture2D(uTexture, vTexCoord);
`,D+=`  float sum = 1.0;
`,A.forEach(function(ie,ve){D+="  color += texture2D(uTexture, vTexCoord + "+ie+") * uTaps["+ve+`];
`,D+="  color += texture2D(uTexture, vTexCoord - "+ie+") * uTaps["+ve+`];
`,D+="  sum += 2.0 * uTaps["+ve+`];
`}),D+=`  gl_FragColor = color / sum;
`,D+="}",D},fragmentSourceTOP:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
`,applyTo:function(T){T.webgl?(T.passes++,this.width=T.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=T.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),T.destinationWidth=this.dW,this._setupFrameBuffer(T),this.applyToWebGL(T),this._swapTextures(T),T.sourceWidth=T.destinationWidth,this.height=T.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),T.destinationHeight=this.dH,this._setupFrameBuffer(T),this.applyToWebGL(T),this._swapTextures(T),T.sourceHeight=T.destinationHeight):this.applyTo2d(T)},isNeutralState:function(){return this.scaleX===1&&this.scaleY===1},lanczosCreate:function(T){return function(A){if(A>=T||A<=-T)return 0;if(A<11920929e-14&&A>-11920929e-14)return 1;A*=Math.PI;var D=A/T;return m(A)/A*m(D)/D}},applyTo2d:function(T){var A=T.imageData,D=this.scaleX,V=this.scaleY;this.rcpScaleX=1/D,this.rcpScaleY=1/V;var X=A.width,ie=A.height,ve=h(X*D),Fe=h(ie*V),Ye;this.resizeType==="sliceHack"?Ye=this.sliceByTwo(T,X,ie,ve,Fe):this.resizeType==="hermite"?Ye=this.hermiteFastResize(T,X,ie,ve,Fe):this.resizeType==="bilinear"?Ye=this.bilinearFiltering(T,X,ie,ve,Fe):this.resizeType==="lanczos"&&(Ye=this.lanczosResize(T,X,ie,ve,Fe)),T.imageData=Ye},sliceByTwo:function(T,A,D,V,X){var ie=T.imageData,ve=.5,Fe=!1,Ye=!1,Ze=A*ve,Je=D*ve,ct=p.filterBackend.resources,nt,vt,Mt=0,st=0,bt=A,ee=0;for(ct.sliceByTwo||(ct.sliceByTwo=document.createElement("canvas")),nt=ct.sliceByTwo,(nt.width<A*1.5||nt.height<D)&&(nt.width=A*1.5,nt.height=D),vt=nt.getContext("2d"),vt.clearRect(0,0,A*1.5,D),vt.putImageData(ie,0,0),V=v(V),X=v(X);!Fe||!Ye;)A=Ze,D=Je,V<v(Ze*ve)?Ze=v(Ze*ve):(Ze=V,Fe=!0),X<v(Je*ve)?Je=v(Je*ve):(Je=X,Ye=!0),vt.drawImage(nt,Mt,st,A,D,bt,ee,Ze,Je),Mt=bt,st=ee,ee+=Je;return vt.getImageData(Mt,st,V,X)},lanczosResize:function(T,A,D,V,X){function ie(me){var ge,je,_e,te,Pe,Ne,et,He,Ge,_t,It;for(ee.x=(me+.5)*Je,be.x=v(ee.x),ge=0;ge<X;ge++){for(ee.y=(ge+.5)*ct,be.y=v(ee.y),Pe=0,Ne=0,et=0,He=0,Ge=0,je=be.x-Mt;je<=be.x+Mt;je++)if(!(je<0||je>=A)){_t=v(1e3*l(je-ee.x)),bt[_t]||(bt[_t]={});for(var Xe=be.y-st;Xe<=be.y+st;Xe++)Xe<0||Xe>=D||(It=v(1e3*l(Xe-ee.y)),bt[_t][It]||(bt[_t][It]=Ze(a(b(_t*nt,2)+b(It*vt,2))/1e3)),_e=bt[_t][It],_e>0&&(te=(Xe*A+je)*4,Pe+=_e,Ne+=_e*ve[te],et+=_e*ve[te+1],He+=_e*ve[te+2],Ge+=_e*ve[te+3]))}te=(ge*V+me)*4,Ye[te]=Ne/Pe,Ye[te+1]=et/Pe,Ye[te+2]=He/Pe,Ye[te+3]=Ge/Pe}return++me<V?ie(me):Fe}var ve=T.imageData.data,Fe=T.ctx.createImageData(V,X),Ye=Fe.data,Ze=this.lanczosCreate(this.lanczosLobes),Je=this.rcpScaleX,ct=this.rcpScaleY,nt=2/this.rcpScaleX,vt=2/this.rcpScaleY,Mt=_(Je*this.lanczosLobes/2),st=_(ct*this.lanczosLobes/2),bt={},ee={},be={};return ie(0)},bilinearFiltering:function(T,A,D,V,X){var ie,ve,Fe,Ye,Ze,Je,ct,nt,vt,Mt,st,bt,ee=0,be,me=this.rcpScaleX,ge=this.rcpScaleY,je=4*(A-1),_e=T.imageData,te=_e.data,Pe=T.ctx.createImageData(V,X),Ne=Pe.data;for(ct=0;ct<X;ct++)for(nt=0;nt<V;nt++)for(Ze=v(me*nt),Je=v(ge*ct),vt=me*nt-Ze,Mt=ge*ct-Je,be=4*(Je*A+Ze),st=0;st<4;st++)ie=te[be+st],ve=te[be+4+st],Fe=te[be+je+st],Ye=te[be+je+4+st],bt=ie*(1-vt)*(1-Mt)+ve*vt*(1-Mt)+Fe*Mt*(1-vt)+Ye*vt*Mt,Ne[ee++]=bt;return Pe},hermiteFastResize:function(T,A,D,V,X){for(var ie=this.rcpScaleX,ve=this.rcpScaleY,Fe=_(ie/2),Ye=_(ve/2),Ze=T.imageData,Je=Ze.data,ct=T.ctx.createImageData(V,X),nt=ct.data,vt=0;vt<X;vt++)for(var Mt=0;Mt<V;Mt++){for(var st=(Mt+vt*V)*4,bt=0,ee=0,be=0,me=0,ge=0,je=0,_e=0,te=(vt+.5)*ve,Pe=v(vt*ve);Pe<(vt+1)*ve;Pe++)for(var Ne=l(te-(Pe+.5))/Ye,et=(Mt+.5)*ie,He=Ne*Ne,Ge=v(Mt*ie);Ge<(Mt+1)*ie;Ge++){var _t=l(et-(Ge+.5))/Fe,It=a(He+_t*_t);It>1&&It<-1||(bt=2*It*It*It-3*It*It+1,bt>0&&(_t=4*(Ge+Pe*A),_e+=bt*Je[_t+3],be+=bt,Je[_t+3]<255&&(bt=bt*Je[_t+3]/250),me+=bt*Je[_t],ge+=bt*Je[_t+1],je+=bt*Je[_t+2],ee+=bt))}nt[st]=me/ee,nt[st+1]=ge/ee,nt[st+2]=je/ee,nt[st+3]=_e/be}return ct},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),p.Image.filters.Resize.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass;b.Contrast=v(b.BaseFilter,{type:"Contrast",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uContrast;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
gl_FragColor = color;
}`,contrast:0,mainParameter:"contrast",applyTo2d:function(a){if(this.contrast!==0){var l=a.imageData,h,_,m=l.data,_=m.length,u=Math.floor(this.contrast*255),x=259*(u+255)/(255*(259-u));for(h=0;h<_;h+=4)m[h]=x*(m[h]-128)+128,m[h+1]=x*(m[h+1]-128)+128,m[h+2]=x*(m[h+2]-128)+128}},getUniformLocations:function(a,l){return{uContrast:a.getUniformLocation(l,"uContrast")}},sendUniformData:function(a,l){a.uniform1f(l.uContrast,this.contrast)}}),p.Image.filters.Contrast.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass;b.Saturation=v(b.BaseFilter,{type:"Saturation",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uSaturation;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float rgMax = max(color.r, color.g);
float rgbMax = max(rgMax, color.b);
color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
gl_FragColor = color;
}`,saturation:0,mainParameter:"saturation",applyTo2d:function(a){if(this.saturation!==0){var l=a.imageData,h=l.data,m=h.length,_=-this.saturation,u,x;for(u=0;u<m;u+=4)x=Math.max(h[u],h[u+1],h[u+2]),h[u]+=x!==h[u]?(x-h[u])*_:0,h[u+1]+=x!==h[u+1]?(x-h[u+1])*_:0,h[u+2]+=x!==h[u+2]?(x-h[u+2])*_:0}},getUniformLocations:function(a,l){return{uSaturation:a.getUniformLocation(l,"uSaturation")}},sendUniformData:function(a,l){a.uniform1f(l.uSaturation,-this.saturation)}}),p.Image.filters.Saturation.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass;b.Vibrance=v(b.BaseFilter,{type:"Vibrance",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uVibrance;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float max = max(color.r, max(color.g, color.b));
float avg = (color.r + color.g + color.b) / 3.0;
float amt = (abs(max - avg) * 2.0) * uVibrance;
color.r += max != color.r ? (max - color.r) * amt : 0.00;
color.g += max != color.g ? (max - color.g) * amt : 0.00;
color.b += max != color.b ? (max - color.b) * amt : 0.00;
gl_FragColor = color;
}`,vibrance:0,mainParameter:"vibrance",applyTo2d:function(a){if(this.vibrance!==0){var l=a.imageData,h=l.data,m=h.length,_=-this.vibrance,u,x,T,A;for(u=0;u<m;u+=4)x=Math.max(h[u],h[u+1],h[u+2]),T=(h[u]+h[u+1]+h[u+2])/3,A=Math.abs(x-T)*2/255*_,h[u]+=x!==h[u]?(x-h[u])*A:0,h[u+1]+=x!==h[u+1]?(x-h[u+1])*A:0,h[u+2]+=x!==h[u+2]?(x-h[u+2])*A:0}},getUniformLocations:function(a,l){return{uVibrance:a.getUniformLocation(l,"uVibrance")}},sendUniformData:function(a,l){a.uniform1f(l.uVibrance,-this.vibrance)}}),p.Image.filters.Vibrance.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass;b.Blur=v(b.BaseFilter,{type:"Blur",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
const float nSamples = 15.0;
vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
float random(vec3 scale) {
return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
}
void main() {
vec4 color = vec4(0.0);
float total = 0.0;
float offset = random(v3offset);
for (float t = -nSamples; t <= nSamples; t++) {
float percent = (t + offset - 0.5) / nSamples;
float weight = 1.0 - abs(percent);
color += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;
total += weight;
}
gl_FragColor = color / total;
}`,blur:0,mainParameter:"blur",applyTo:function(a){a.webgl?(this.aspectRatio=a.sourceWidth/a.sourceHeight,a.passes++,this._setupFrameBuffer(a),this.horizontal=!0,this.applyToWebGL(a),this._swapTextures(a),this._setupFrameBuffer(a),this.horizontal=!1,this.applyToWebGL(a),this._swapTextures(a)):this.applyTo2d(a)},applyTo2d:function(a){a.imageData=this.simpleBlur(a)},simpleBlur:function(a){var l=a.filterBackend.resources,h,m,_=a.imageData.width,u=a.imageData.height;l.blurLayer1||(l.blurLayer1=p.util.createCanvasElement(),l.blurLayer2=p.util.createCanvasElement()),h=l.blurLayer1,m=l.blurLayer2,(h.width!==_||h.height!==u)&&(m.width=h.width=_,m.height=h.height=u);var x=h.getContext("2d"),T=m.getContext("2d"),A=15,D,V,X,ie,ve=this.blur*.06*.5;for(x.putImageData(a.imageData,0,0),T.clearRect(0,0,_,u),ie=-A;ie<=A;ie++)D=(Math.random()-.5)/4,V=ie/A,X=ve*V*_+D,T.globalAlpha=1-Math.abs(V),T.drawImage(h,X,D),x.drawImage(m,0,0),T.globalAlpha=1,T.clearRect(0,0,m.width,m.height);for(ie=-A;ie<=A;ie++)D=(Math.random()-.5)/4,V=ie/A,X=ve*V*u+D,T.globalAlpha=1-Math.abs(V),T.drawImage(h,D,X),x.drawImage(m,0,0),T.globalAlpha=1,T.clearRect(0,0,m.width,m.height);a.ctx.drawImage(h,0,0);var Fe=a.ctx.getImageData(0,0,h.width,h.height);return x.globalAlpha=1,x.clearRect(0,0,h.width,h.height),Fe},getUniformLocations:function(a,l){return{delta:a.getUniformLocation(l,"uDelta")}},sendUniformData:function(a,l){var h=this.chooseRightDelta();a.uniform2fv(l.delta,h)},chooseRightDelta:function(){var a=1,l=[0,0],h;return this.horizontal?this.aspectRatio>1&&(a=1/this.aspectRatio):this.aspectRatio<1&&(a=this.aspectRatio),h=a*this.blur*.12,this.horizontal?l[0]=h:l[1]=h,l}}),b.Blur.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass;b.Gamma=v(b.BaseFilter,{type:"Gamma",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec3 uGamma;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec3 correction = (1.0 / uGamma);
color.r = pow(color.r, correction.r);
color.g = pow(color.g, correction.g);
color.b = pow(color.b, correction.b);
gl_FragColor = color;
gl_FragColor.rgb *= color.a;
}`,gamma:[1,1,1],mainParameter:"gamma",initialize:function(a){this.gamma=[1,1,1],b.BaseFilter.prototype.initialize.call(this,a)},applyTo2d:function(a){var l=a.imageData,h=l.data,m=this.gamma,_=h.length,u=1/m[0],x=1/m[1],T=1/m[2],A;for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),A=0,_=256;A<_;A++)this.rVals[A]=Math.pow(A/255,u)*255,this.gVals[A]=Math.pow(A/255,x)*255,this.bVals[A]=Math.pow(A/255,T)*255;for(A=0,_=h.length;A<_;A+=4)h[A]=this.rVals[h[A]],h[A+1]=this.gVals[h[A+1]],h[A+2]=this.bVals[h[A+2]]},getUniformLocations:function(a,l){return{uGamma:a.getUniformLocation(l,"uGamma")}},sendUniformData:function(a,l){a.uniform3fv(l.uGamma,this.gamma)}}),p.Image.filters.Gamma.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass;b.Composed=v(b.BaseFilter,{type:"Composed",subFilters:[],initialize:function(a){this.callSuper("initialize",a),this.subFilters=this.subFilters.slice(0)},applyTo:function(a){a.passes+=this.subFilters.length-1,this.subFilters.forEach(function(l){l.applyTo(a)})},toObject:function(){return p.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(a){return a.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(a){return!a.isNeutralState()})}}),p.Image.filters.Composed.fromObject=function(a,l){var h=a.subFilters||[],m=h.map(function(u){return new p.Image.filters[u.type](u)}),_=new p.Image.filters.Composed({subFilters:m});return l&&l(_),_}}($),function(s){var p=s.fabric||(s.fabric={}),b=p.Image.filters,v=p.util.createClass;b.HueRotation=v(b.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var a=this.rotation*Math.PI,l=p.util.cos(a),h=p.util.sin(a),m=1/3,_=Math.sqrt(m)*h,u=1-l;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=l+u/3,this.matrix[1]=m*u-_,this.matrix[2]=m*u+_,this.matrix[5]=m*u+_,this.matrix[6]=l+m*u,this.matrix[7]=m*u-_,this.matrix[10]=m*u-_,this.matrix[11]=m*u+_,this.matrix[12]=l+m*u},isNeutralState:function(a){return this.calculateMatrix(),b.BaseFilter.prototype.isNeutralState.call(this,a)},applyTo:function(a){this.calculateMatrix(),b.BaseFilter.prototype.applyTo.call(this,a)}}),p.Image.filters.HueRotation.fromObject=p.Image.filters.BaseFilter.fromObject}($),function(s){var p=s.fabric||(s.fabric={}),b=p.util.object.clone;if(p.Text){p.warn("fabric.Text is already defined");return}var v="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");p.Text=p.util.createClass(p.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:p.Object.prototype.stateProperties.concat(v),cacheProperties:p.Object.prototype.cacheProperties.concat(v),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(a,l){this.styles=l?l.styles||{}:{},this.text=a,this.__skipDimension=!0,this.callSuper("initialize",l),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var a=this.path;a&&(a.segmentsInfo=p.util.getPathSegmentsInfo(a.path))},getMeasuringContext:function(){return p._measuringContext||(p._measuringContext=this.canvas&&this.canvas.contextCache||p.util.createCanvasElement().getContext("2d")),p._measuringContext},_splitText:function(){var a=this._splitTextIntoLines(this.text);return this.textLines=a.lines,this._textLines=a.graphemeLines,this._unwrappedTextLines=a._unwrappedLines,this._text=a.graphemeText,a},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var a,l,h,m,_,u,x,T=0,A=this._textLines.length;T<A;T++)if(!(this.textAlign!=="justify"&&(T===A-1||this.isEndOfWrapping(T)))&&(m=0,_=this._textLines[T],l=this.getLineWidth(T),l<this.width&&(x=this.textLines[T].match(this._reSpacesAndTabs)))){h=x.length,a=(this.width-l)/h;for(var D=0,V=_.length;D<=V;D++)u=this.__charBounds[T][D],this._reSpaceAndTab.test(_[D])?(u.width+=a,u.kernedWidth+=a,u.left+=m,m+=a):u.left+=m}},isEndOfWrapping:function(a){return a===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var a=this.callSuper("_getCacheCanvasDimensions"),l=this.fontSize;return a.width+=l*a.zoomX,a.height+=l*a.zoomY,a},_render:function(a){var l=this.path;l&&!l.isNotVisible()&&l._render(a),this._setTextStyles(a),this._renderTextLinesBackground(a),this._renderTextDecoration(a,"underline"),this._renderText(a),this._renderTextDecoration(a,"overline"),this._renderTextDecoration(a,"linethrough")},_renderText:function(a){this.paintFirst==="stroke"?(this._renderTextStroke(a),this._renderTextFill(a)):(this._renderTextFill(a),this._renderTextStroke(a))},_setTextStyles:function(a,l,h){if(a.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":a.textBaseline="middle";break;case"ascender":a.textBaseline="top";break;case"descender":a.textBaseline="bottom";break}a.font=this._getFontDeclaration(l,h)},calcTextWidth:function(){for(var a=this.getLineWidth(0),l=1,h=this._textLines.length;l<h;l++){var m=this.getLineWidth(l);m>a&&(a=m)}return a},_renderTextLine:function(a,l,h,m,_,u){this._renderChars(a,l,h,m,_,u)},_renderTextLinesBackground:function(a){if(!(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))){for(var l,h,m=a.fillStyle,_,u,x=this._getLeftOffset(),T=this._getTopOffset(),A=0,D=0,V,X,ie=this.path,ve,Fe=0,Ye=this._textLines.length;Fe<Ye;Fe++){if(l=this.getHeightOfLine(Fe),!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",Fe)){T+=l;continue}_=this._textLines[Fe],h=this._getLineLeftOffset(Fe),D=0,A=0,u=this.getValueOfPropertyAt(Fe,0,"textBackgroundColor");for(var Ze=0,Je=_.length;Ze<Je;Ze++)V=this.__charBounds[Fe][Ze],X=this.getValueOfPropertyAt(Fe,Ze,"textBackgroundColor"),ie?(a.save(),a.translate(V.renderLeft,V.renderTop),a.rotate(V.angle),a.fillStyle=X,X&&a.fillRect(-V.width/2,-l/this.lineHeight*(1-this._fontSizeFraction),V.width,l/this.lineHeight),a.restore()):X!==u?(ve=x+h+A,this.direction==="rtl"&&(ve=this.width-ve-D),a.fillStyle=u,u&&a.fillRect(ve,T,D,l/this.lineHeight),A=V.left,D=V.width,u=X):D+=V.kernedWidth;X&&!ie&&(ve=x+h+A,this.direction==="rtl"&&(ve=this.width-ve-D),a.fillStyle=X,a.fillRect(ve,T,D,l/this.lineHeight)),T+=l}a.fillStyle=m,this._removeShadow(a)}},getFontCache:function(a){var l=a.fontFamily.toLowerCase();p.charWidthsCache[l]||(p.charWidthsCache[l]={});var h=p.charWidthsCache[l],m=a.fontStyle.toLowerCase()+"_"+(a.fontWeight+"").toLowerCase();return h[m]||(h[m]={}),h[m]},_measureChar:function(a,l,h,m){var _=this.getFontCache(l),u=this._getFontDeclaration(l),x=this._getFontDeclaration(m),T=h+a,A=u===x,D,V,X,ie=l.fontSize/this.CACHE_FONT_SIZE,ve;if(h&&_[h]!==void 0&&(X=_[h]),_[a]!==void 0&&(ve=D=_[a]),A&&_[T]!==void 0&&(V=_[T],ve=V-X),D===void 0||X===void 0||V===void 0){var Fe=this.getMeasuringContext();this._setTextStyles(Fe,l,!0)}return D===void 0&&(ve=D=Fe.measureText(a).width,_[a]=D),X===void 0&&A&&h&&(X=Fe.measureText(h).width,_[h]=X),A&&V===void 0&&(V=Fe.measureText(T).width,_[T]=V,ve=V-X),{width:D*ie,kernedWidth:ve*ie}},getHeightOfChar:function(a,l){return this.getValueOfPropertyAt(a,l,"fontSize")},measureLine:function(a){var l=this._measureLine(a);return this.charSpacing!==0&&(l.width-=this._getWidthOfCharSpacing()),l.width<0&&(l.width=0),l},_measureLine:function(a){var l=0,h,m,_=this._textLines[a],u,x,T=0,A=new Array(_.length),D=0,V,X,ie=this.path,ve=this.pathSide==="right";for(this.__charBounds[a]=A,h=0;h<_.length;h++)m=_[h],x=this._getGraphemeBox(m,a,h,u),A[h]=x,l+=x.kernedWidth,u=m;if(A[h]={left:x?x.left+x.width:0,width:0,kernedWidth:0,height:this.fontSize},ie){switch(X=ie.segmentsInfo[ie.segmentsInfo.length-1].length,V=p.util.getPointOnPath(ie.path,0,ie.segmentsInfo),V.x+=ie.pathOffset.x,V.y+=ie.pathOffset.y,this.textAlign){case"left":D=ve?X-l:0;break;case"center":D=(X-l)/2;break;case"right":D=ve?0:X-l;break}for(D+=this.pathStartOffset*(ve?-1:1),h=ve?_.length-1:0;ve?h>=0:h<_.length;ve?h--:h++)x=A[h],D>X?D%=X:D<0&&(D+=X),this._setGraphemeOnPath(D,x,V),D+=x.kernedWidth}return{width:l,numOfSpaces:T}},_setGraphemeOnPath:function(a,l,h){var m=a+l.kernedWidth/2,_=this.path,u=p.util.getPointOnPath(_.path,m,_.segmentsInfo);l.renderLeft=u.x-h.x,l.renderTop=u.y-h.y,l.angle=u.angle+(this.pathSide==="right"?Math.PI:0)},_getGraphemeBox:function(a,l,h,m,_){var u=this.getCompleteStyleDeclaration(l,h),x=m?this.getCompleteStyleDeclaration(l,h-1):{},T=this._measureChar(a,u,m,x),A=T.kernedWidth,D=T.width,V;this.charSpacing!==0&&(V=this._getWidthOfCharSpacing(),D+=V,A+=V);var X={width:D,left:0,height:u.fontSize,kernedWidth:A,deltaY:u.deltaY};if(h>0&&!_){var ie=this.__charBounds[l][h-1];X.left=ie.left+ie.width+T.kernedWidth-T.width}return X},getHeightOfLine:function(a){if(this.__lineHeights[a])return this.__lineHeights[a];for(var l=this._textLines[a],h=this.getHeightOfChar(a,0),m=1,_=l.length;m<_;m++)h=Math.max(this.getHeightOfChar(a,m),h);return this.__lineHeights[a]=h*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var a,l=0,h=0,m=this._textLines.length;h<m;h++)a=this.getHeightOfLine(h),l+=h===m-1?a/this.lineHeight:a;return l},_getLeftOffset:function(){return this.direction==="ltr"?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(a,l){a.save();for(var h=0,m=this._getLeftOffset(),_=this._getTopOffset(),u=0,x=this._textLines.length;u<x;u++){var T=this.getHeightOfLine(u),A=T/this.lineHeight,D=this._getLineLeftOffset(u);this._renderTextLine(l,a,this._textLines[u],m+D,_+h+A,u),h+=T}a.restore()},_renderTextFill:function(a){!this.fill&&!this.styleHas("fill")||this._renderTextCommon(a,"fillText")},_renderTextStroke:function(a){(!this.stroke||this.strokeWidth===0)&&this.isEmptyStyles()||(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(a),a.save(),this._setLineDash(a,this.strokeDashArray),a.beginPath(),this._renderTextCommon(a,"strokeText"),a.closePath(),a.restore())},_renderChars:function(a,l,h,m,_,u){var x=this.getHeightOfLine(u),T=this.textAlign.indexOf("justify")!==-1,A,D,V="",X,ie=0,ve,Fe=this.path,Ye=!T&&this.charSpacing===0&&this.isEmptyStyles(u)&&!Fe,Ze=this.direction==="ltr",Je=this.direction==="ltr"?1:-1,ct,nt=l.canvas.getAttribute("dir");if(l.save(),nt!==this.direction&&(l.canvas.setAttribute("dir",Ze?"ltr":"rtl"),l.direction=Ze?"ltr":"rtl",l.textAlign=Ze?"left":"right"),_-=x*this._fontSizeFraction/this.lineHeight,Ye){this._renderChar(a,l,u,0,h.join(""),m,_,x),l.restore();return}for(var vt=0,Mt=h.length-1;vt<=Mt;vt++)ve=vt===Mt||this.charSpacing||Fe,V+=h[vt],X=this.__charBounds[u][vt],ie===0?(m+=Je*(X.kernedWidth-X.width),ie+=X.width):ie+=X.kernedWidth,T&&!ve&&this._reSpaceAndTab.test(h[vt])&&(ve=!0),ve||(A=A||this.getCompleteStyleDeclaration(u,vt),D=this.getCompleteStyleDeclaration(u,vt+1),ve=p.util.hasStyleChanged(A,D,!1)),ve&&(Fe?(l.save(),l.translate(X.renderLeft,X.renderTop),l.rotate(X.angle),this._renderChar(a,l,u,vt,V,-ie/2,0,x),l.restore()):(ct=m,this._renderChar(a,l,u,vt,V,ct,_,x)),V="",A=D,m+=Je*ie,ie=0);l.restore()},_applyPatternGradientTransformText:function(a){var l=p.util.createCanvasElement(),h,m=this.width+this.strokeWidth,_=this.height+this.strokeWidth;return l.width=m,l.height=_,h=l.getContext("2d"),h.beginPath(),h.moveTo(0,0),h.lineTo(m,0),h.lineTo(m,_),h.lineTo(0,_),h.closePath(),h.translate(m/2,_/2),h.fillStyle=a.toLive(h),this._applyPatternGradientTransform(h,a),h.fill(),h.createPattern(l,"no-repeat")},handleFiller:function(a,l,h){var m,_;return h.toLive?h.gradientUnits==="percentage"||h.gradientTransform||h.patternTransform?(m=-this.width/2,_=-this.height/2,a.translate(m,_),a[l]=this._applyPatternGradientTransformText(h),{offsetX:m,offsetY:_}):(a[l]=h.toLive(a,this),this._applyPatternGradientTransform(a,h)):(a[l]=h,{offsetX:0,offsetY:0})},_setStrokeStyles:function(a,l){return a.lineWidth=l.strokeWidth,a.lineCap=this.strokeLineCap,a.lineDashOffset=this.strokeDashOffset,a.lineJoin=this.strokeLineJoin,a.miterLimit=this.strokeMiterLimit,this.handleFiller(a,"strokeStyle",l.stroke)},_setFillStyles:function(a,l){return this.handleFiller(a,"fillStyle",l.fill)},_renderChar:function(a,l,h,m,_,u,x){var T=this._getStyleDeclaration(h,m),A=this.getCompleteStyleDeclaration(h,m),D=a==="fillText"&&A.fill,V=a==="strokeText"&&A.stroke&&A.strokeWidth,X,ie;!V&&!D||(l.save(),D&&(X=this._setFillStyles(l,A)),V&&(ie=this._setStrokeStyles(l,A)),l.font=this._getFontDeclaration(A),T&&T.textBackgroundColor&&this._removeShadow(l),T&&T.deltaY&&(x+=T.deltaY),D&&l.fillText(_,u-X.offsetX,x-X.offsetY),V&&l.strokeText(_,u-ie.offsetX,x-ie.offsetY),l.restore())},setSuperscript:function(a,l){return this._setScript(a,l,this.superscript)},setSubscript:function(a,l){return this._setScript(a,l,this.subscript)},_setScript:function(a,l,h){var m=this.get2DCursorLocation(a,!0),_=this.getValueOfPropertyAt(m.lineIndex,m.charIndex,"fontSize"),u=this.getValueOfPropertyAt(m.lineIndex,m.charIndex,"deltaY"),x={fontSize:_*h.size,deltaY:u+_*h.baseline};return this.setSelectionStyles(x,a,l),this},_getLineLeftOffset:function(a){var l=this.getLineWidth(a),h=this.width-l,m=this.textAlign,_=this.direction,x,u=0,x=this.isEndOfWrapping(a);return m==="justify"||m==="justify-center"&&!x||m==="justify-right"&&!x||m==="justify-left"&&!x?0:(m==="center"&&(u=h/2),m==="right"&&(u=h),m==="justify-center"&&(u=h/2),m==="justify-right"&&(u=h),_==="rtl"&&(u-=h),u)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var a=this._forceClearCache;return a||(a=this.hasStateChanged("_dimensionAffectingProps")),a&&(this.dirty=!0,this._forceClearCache=!1),a},getLineWidth:function(a){if(this.__lineWidths[a]!==void 0)return this.__lineWidths[a];var l=this.measureLine(a),h=l.width;return this.__lineWidths[a]=h,h},_getWidthOfCharSpacing:function(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(a,l,h){var m=this._getStyleDeclaration(a,l);return m&&typeof m[h]<"u"?m[h]:this[h]},_renderTextDecoration:function(a,l){if(!(!this[l]&&!this.styleHas(l))){for(var h,m,_,u,x,T,A,D,V=this._getLeftOffset(),X=this._getTopOffset(),ie,ve,Fe,Ye,Ze,Je,ct,nt,vt=this.path,Mt=this._getWidthOfCharSpacing(),st=this.offsets[l],bt=0,ee=this._textLines.length;bt<ee;bt++){if(h=this.getHeightOfLine(bt),!this[l]&&!this.styleHas(l,bt)){X+=h;continue}A=this._textLines[bt],Je=h/this.lineHeight,u=this._getLineLeftOffset(bt),ve=0,Fe=0,D=this.getValueOfPropertyAt(bt,0,l),nt=this.getValueOfPropertyAt(bt,0,"fill"),ie=X+Je*(1-this._fontSizeFraction),m=this.getHeightOfChar(bt,0),x=this.getValueOfPropertyAt(bt,0,"deltaY");for(var be=0,me=A.length;be<me;be++)if(Ye=this.__charBounds[bt][be],Ze=this.getValueOfPropertyAt(bt,be,l),ct=this.getValueOfPropertyAt(bt,be,"fill"),_=this.getHeightOfChar(bt,be),T=this.getValueOfPropertyAt(bt,be,"deltaY"),vt&&Ze&&ct)a.save(),a.fillStyle=nt,a.translate(Ye.renderLeft,Ye.renderTop),a.rotate(Ye.angle),a.fillRect(-Ye.kernedWidth/2,st*_+T,Ye.kernedWidth,this.fontSize/15),a.restore();else if((Ze!==D||ct!==nt||_!==m||T!==x)&&Fe>0){var ge=V+u+ve;this.direction==="rtl"&&(ge=this.width-ge-Fe),D&&nt&&(a.fillStyle=nt,a.fillRect(ge,ie+st*m+x,Fe,this.fontSize/15)),ve=Ye.left,Fe=Ye.width,D=Ze,nt=ct,m=_,x=T}else Fe+=Ye.kernedWidth;var ge=V+u+ve;this.direction==="rtl"&&(ge=this.width-ge-Fe),a.fillStyle=ct,Ze&&ct&&a.fillRect(ge,ie+st*m+x,Fe-Mt,this.fontSize/15),X+=h}this._removeShadow(a)}},_getFontDeclaration:function(a,l){var h=a||this,m=this.fontFamily,_=p.Text.genericFonts.indexOf(m.toLowerCase())>-1,u=m===void 0||m.indexOf("'")>-1||m.indexOf(",")>-1||m.indexOf('"')>-1||_?h.fontFamily:'"'+h.fontFamily+'"';return[p.isLikelyNode?h.fontWeight:h.fontStyle,p.isLikelyNode?h.fontStyle:h.fontWeight,l?this.CACHE_FONT_SIZE+"px":h.fontSize+"px",u].join(" ")},render:function(a){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",a)))},_splitTextIntoLines:function(a){for(var l=a.split(this._reNewline),h=new Array(l.length),m=[`
`],_=[],u=0;u<l.length;u++)h[u]=p.util.string.graphemeSplit(l[u]),_=_.concat(h[u],m);return _.pop(),{_unwrappedLines:h,lines:l,graphemeText:_,graphemeLines:h}},toObject:function(a){var l=v.concat(a),h=this.callSuper("toObject",l);return h.styles=p.util.stylesToArray(this.styles,this.text),h.path&&(h.path=this.path.toObject()),h},set:function(a,l){this.callSuper("set",a,l);var h=!1,m=!1;if(typeof a=="object")for(var _ in a)_==="path"&&this.setPathInfo(),h=h||this._dimensionAffectingProps.indexOf(_)!==-1,m=m||_==="path";else h=this._dimensionAffectingProps.indexOf(a)!==-1,m=a==="path";return m&&this.setPathInfo(),h&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),p.Text.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),p.Text.DEFAULT_SVG_FONT_SIZE=16,p.Text.fromElement=function(a,l,h){if(!a)return l(null);var m=p.parseAttributes(a,p.Text.ATTRIBUTE_NAMES),_=m.textAnchor||"left";if(h=p.util.object.extend(h?b(h):{},m),h.top=h.top||0,h.left=h.left||0,m.textDecoration){var u=m.textDecoration;u.indexOf("underline")!==-1&&(h.underline=!0),u.indexOf("overline")!==-1&&(h.overline=!0),u.indexOf("line-through")!==-1&&(h.linethrough=!0),delete h.textDecoration}"dx"in m&&(h.left+=m.dx),"dy"in m&&(h.top+=m.dy),"fontSize"in h||(h.fontSize=p.Text.DEFAULT_SVG_FONT_SIZE);var x="";"textContent"in a?x=a.textContent:"firstChild"in a&&a.firstChild!==null&&"data"in a.firstChild&&a.firstChild.data!==null&&(x=a.firstChild.data),x=x.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var T=h.strokeWidth;h.strokeWidth=0;var A=new p.Text(x,h),D=A.getScaledHeight()/A.height,V=(A.height+A.strokeWidth)*A.lineHeight-A.height,X=V*D,ie=A.getScaledHeight()+X,ve=0;_==="center"&&(ve=A.getScaledWidth()/2),_==="right"&&(ve=A.getScaledWidth()),A.set({left:A.left-ve,top:A.top-(ie-A.fontSize*(.07+A._fontSizeFraction))/A.lineHeight,strokeWidth:typeof T<"u"?T:1}),l(A)},p.Text.fromObject=function(a,l){var h=b(a),m=a.path;return delete h.path,p.Object._fromObject("Text",h,function(_){_.styles=p.util.stylesFromArray(a.styles,a.text),m?p.Object._fromObject("Path",m,function(u){_.set("path",u),l(_)},"path"):l(_)},"text")},p.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],p.util.createAccessors&&p.util.createAccessors(p.Text)}($),function(){S.util.object.extend(S.Text.prototype,{isEmptyStyles:function(s){if(!this.styles||typeof s<"u"&&!this.styles[s])return!0;var p=typeof s>"u"?this.styles:{line:this.styles[s]};for(var b in p)for(var v in p[b])for(var a in p[b][v])return!1;return!0},styleHas:function(s,p){if(!this.styles||!s||s===""||typeof p<"u"&&!this.styles[p])return!1;var b=typeof p>"u"?this.styles:{0:this.styles[p]};for(var v in b)for(var a in b[v])if(typeof b[v][a][s]<"u")return!0;return!1},cleanStyle:function(s){if(!this.styles||!s||s==="")return!1;var p=this.styles,b=0,v,a,l=!0,h=0,m;for(var _ in p){v=0;for(var u in p[_]){var m=p[_][u],x=m.hasOwnProperty(s);b++,x?(a?m[s]!==a&&(l=!1):a=m[s],m[s]===this[s]&&delete m[s]):l=!1,Object.keys(m).length!==0?v++:delete p[_][u]}v===0&&delete p[_]}for(var T=0;T<this._textLines.length;T++)h+=this._textLines[T].length;l&&b===h&&(this[s]=a,this.removeStyle(s))},removeStyle:function(s){if(!(!this.styles||!s||s==="")){var p=this.styles,b,v,a;for(v in p){b=p[v];for(a in b)delete b[a][s],Object.keys(b[a]).length===0&&delete b[a];Object.keys(b).length===0&&delete p[v]}}},_extendStyles:function(s,p){var b=this.get2DCursorLocation(s);this._getLineStyle(b.lineIndex)||this._setLineStyle(b.lineIndex),this._getStyleDeclaration(b.lineIndex,b.charIndex)||this._setStyleDeclaration(b.lineIndex,b.charIndex,{}),S.util.object.extend(this._getStyleDeclaration(b.lineIndex,b.charIndex),p)},get2DCursorLocation:function(s,p){typeof s>"u"&&(s=this.selectionStart);for(var b=p?this._unwrappedTextLines:this._textLines,v=b.length,a=0;a<v;a++){if(s<=b[a].length)return{lineIndex:a,charIndex:s};s-=b[a].length+this.missingNewlineOffset(a)}return{lineIndex:a-1,charIndex:b[a-1].length<s?b[a-1].length:s}},getSelectionStyles:function(s,p,b){typeof s>"u"&&(s=this.selectionStart||0),typeof p>"u"&&(p=this.selectionEnd||s);for(var v=[],a=s;a<p;a++)v.push(this.getStyleAtPosition(a,b));return v},getStyleAtPosition:function(s,p){var b=this.get2DCursorLocation(s),v=p?this.getCompleteStyleDeclaration(b.lineIndex,b.charIndex):this._getStyleDeclaration(b.lineIndex,b.charIndex);return v||{}},setSelectionStyles:function(s,p,b){typeof p>"u"&&(p=this.selectionStart||0),typeof b>"u"&&(b=this.selectionEnd||p);for(var v=p;v<b;v++)this._extendStyles(v,s);return this._forceClearCache=!0,this},_getStyleDeclaration:function(s,p){var b=this.styles&&this.styles[s];return b?b[p]:null},getCompleteStyleDeclaration:function(s,p){for(var b=this._getStyleDeclaration(s,p)||{},v={},a,l=0;l<this._styleProperties.length;l++)a=this._styleProperties[l],v[a]=typeof b[a]>"u"?this[a]:b[a];return v},_setStyleDeclaration:function(s,p,b){this.styles[s][p]=b},_deleteStyleDeclaration:function(s,p){delete this.styles[s][p]},_getLineStyle:function(s){return!!this.styles[s]},_setLineStyle:function(s){this.styles[s]={}},_deleteLineStyle:function(s){delete this.styles[s]}})}(),function(){function s(p){p.textDecoration&&(p.textDecoration.indexOf("underline")>-1&&(p.underline=!0),p.textDecoration.indexOf("line-through")>-1&&(p.linethrough=!0),p.textDecoration.indexOf("overline")>-1&&(p.overline=!0),delete p.textDecoration)}S.IText=S.util.createClass(S.Text,S.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(p,b){this.callSuper("initialize",p,b),this.initBehavior()},setSelectionStart:function(p){p=Math.max(p,0),this._updateAndFire("selectionStart",p)},setSelectionEnd:function(p){p=Math.min(p,this.text.length),this._updateAndFire("selectionEnd",p)},_updateAndFire:function(p,b){this[p]!==b&&(this._fireSelectionChanged(),this[p]=b),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(p){this.clearContextTop(),this.callSuper("render",p),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(p){this.callSuper("_render",p)},clearContextTop:function(p){if(!(!this.isEditing||!this.canvas||!this.canvas.contextTop)){var b=this.canvas.contextTop,v=this.canvas.viewportTransform;b.save(),b.transform(v[0],v[1],v[2],v[3],v[4],v[5]),this.transform(b),this._clearTextArea(b),p||b.restore()}},renderCursorOrSelection:function(){if(!(!this.isEditing||!this.canvas||!this.canvas.contextTop)){var p=this._getCursorBoundaries(),b=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(p,b):this.renderSelection(p,b),b.restore()}},_clearTextArea:function(p){var b=this.width+4,v=this.height+4;p.clearRect(-b/2,-v/2,b,v)},_getCursorBoundaries:function(p){typeof p>"u"&&(p=this.selectionStart);var b=this._getLeftOffset(),v=this._getTopOffset(),a=this._getCursorBoundariesOffsets(p);return{left:b,top:v,leftOffset:a.left,topOffset:a.top}},_getCursorBoundariesOffsets:function(p){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var b,v,a,l=0,h=0,m,_=this.get2DCursorLocation(p);a=_.charIndex,v=_.lineIndex;for(var u=0;u<v;u++)l+=this.getHeightOfLine(u);b=this._getLineLeftOffset(v);var x=this.__charBounds[v][a];return x&&(h=x.left),this.charSpacing!==0&&a===this._textLines[v].length&&(h-=this._getWidthOfCharSpacing()),m={top:l,left:b+(h>0?h:0)},this.direction==="rtl"&&(m.left*=-1),this.cursorOffsetCache=m,this.cursorOffsetCache},renderCursor:function(p,b){var v=this.get2DCursorLocation(),a=v.lineIndex,l=v.charIndex>0?v.charIndex-1:0,h=this.getValueOfPropertyAt(a,l,"fontSize"),m=this.scaleX*this.canvas.getZoom(),_=this.cursorWidth/m,u=p.topOffset,x=this.getValueOfPropertyAt(a,l,"deltaY");u+=(1-this._fontSizeFraction)*this.getHeightOfLine(a)/this.lineHeight-h*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(p,b),b.fillStyle=this.cursorColor||this.getValueOfPropertyAt(a,l,"fill"),b.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,b.fillRect(p.left+p.leftOffset-_/2,u+p.top+x,_,h)},renderSelection:function(p,b){for(var v=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,a=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,l=this.textAlign.indexOf("justify")!==-1,h=this.get2DCursorLocation(v),m=this.get2DCursorLocation(a),_=h.lineIndex,u=m.lineIndex,x=h.charIndex<0?0:h.charIndex,T=m.charIndex<0?0:m.charIndex,A=_;A<=u;A++){var D=this._getLineLeftOffset(A)||0,V=this.getHeightOfLine(A),X=0,ie=0,ve=0;if(A===_&&(ie=this.__charBounds[_][x].left),A>=_&&A<u)ve=l&&!this.isEndOfWrapping(A)?this.width:this.getLineWidth(A)||5;else if(A===u)if(T===0)ve=this.__charBounds[u][T].left;else{var Fe=this._getWidthOfCharSpacing();ve=this.__charBounds[u][T-1].left+this.__charBounds[u][T-1].width-Fe}X=V,(this.lineHeight<1||A===u&&this.lineHeight>1)&&(V/=this.lineHeight);var Ye=p.left+D+ie,Ze=ve-ie,Je=V,ct=0;this.inCompositionMode?(b.fillStyle=this.compositionColor||"black",Je=1,ct=V):b.fillStyle=this.selectionColor,this.direction==="rtl"&&(Ye=this.width-Ye-Ze),b.fillRect(Ye,p.top+p.topOffset+ct,Ze,Je),p.topOffset+=X}},getCurrentCharFontSize:function(){var p=this._getCurrentCharIndex();return this.getValueOfPropertyAt(p.l,p.c,"fontSize")},getCurrentCharColor:function(){var p=this._getCurrentCharIndex();return this.getValueOfPropertyAt(p.l,p.c,"fill")},_getCurrentCharIndex:function(){var p=this.get2DCursorLocation(this.selectionStart,!0),b=p.charIndex>0?p.charIndex-1:0;return{l:p.lineIndex,c:b}}}),S.IText.fromObject=function(p,b){var v=S.util.stylesFromArray(p.styles,p.text),a=Object.assign({},p,{styles:v});if(s(a),a.styles)for(var l in a.styles)for(var h in a.styles[l])s(a.styles[l][h]);S.Object._fromObject("IText",a,b,"text")}}(),function(){var s=S.util.object.clone;S.util.object.extend(S.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var p=this;this.on("added",function(){var b=p.canvas;b&&(b._hasITextHandlers||(b._hasITextHandlers=!0,p._initCanvasHandlers(b)),b._iTextInstances=b._iTextInstances||[],b._iTextInstances.push(p))})},initRemovedHandler:function(){var p=this;this.on("removed",function(){var b=p.canvas;b&&(b._iTextInstances=b._iTextInstances||[],S.util.removeFromArray(b._iTextInstances,p),b._iTextInstances.length===0&&(b._hasITextHandlers=!1,p._removeCanvasHandlers(b)))})},_initCanvasHandlers:function(p){p._mouseUpITextHandler=function(){p._iTextInstances&&p._iTextInstances.forEach(function(b){b.__isMousedown=!1})},p.on("mouse:up",p._mouseUpITextHandler)},_removeCanvasHandlers:function(p){p.off("mouse:up",p._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(p,b,v,a){var l;return l={isAborted:!1,abort:function(){this.isAborted=!0}},p.animate("_currentCursorOpacity",b,{duration:v,onComplete:function(){l.isAborted||p[a]()},onChange:function(){p.canvas&&p.selectionStart===p.selectionEnd&&p.renderCursorOrSelection()},abort:function(){return l.isAborted}}),l},_onTickComplete:function(){var p=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){p._currentTickCompleteState=p._animateCursor(p,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(p){var b=this,v=p?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){b._tick()},v)},abortCursorAnimation:function(){var p=this._currentTickState||this._currentTickCompleteState,b=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,p&&b&&b.clearContext(b.contextTop||b.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(p){var b=0,v=p-1;if(this._reSpace.test(this._text[v]))for(;this._reSpace.test(this._text[v]);)b++,v--;for(;/\S/.test(this._text[v])&&v>-1;)b++,v--;return p-b},findWordBoundaryRight:function(p){var b=0,v=p;if(this._reSpace.test(this._text[v]))for(;this._reSpace.test(this._text[v]);)b++,v++;for(;/\S/.test(this._text[v])&&v<this._text.length;)b++,v++;return p+b},findLineBoundaryLeft:function(p){for(var b=0,v=p-1;!/\n/.test(this._text[v])&&v>-1;)b++,v--;return p-b},findLineBoundaryRight:function(p){for(var b=0,v=p;!/\n/.test(this._text[v])&&v<this._text.length;)b++,v++;return p+b},searchWordBoundary:function(p,b){for(var v=this._text,a=this._reSpace.test(v[p])?p-1:p,l=v[a],h=S.reNonWord;!h.test(l)&&a>0&&a<v.length;)a+=b,l=v[a];return h.test(l)&&(a+=b===1?0:1),a},selectWord:function(p){p=p||this.selectionStart;var b=this.searchWordBoundary(p,-1),v=this.searchWordBoundary(p,1);this.selectionStart=b,this.selectionEnd=v,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(p){p=p||this.selectionStart;var b=this.findLineBoundaryLeft(p),v=this.findLineBoundaryRight(p);return this.selectionStart=b,this.selectionEnd=v,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(p){if(!(this.isEditing||!this.editable))return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(p),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(p){p._iTextInstances&&p._iTextInstances.forEach(function(b){b.selected=!1,b.isEditing&&b.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(p){if(!(!this.__isMousedown||!this.isEditing)){document.activeElement!==this.hiddenTextarea&&this.hiddenTextarea.focus();var b=this.getSelectionStartFromPointer(p.e),v=this.selectionStart,a=this.selectionEnd;(b!==this.__selectionStartOnMouseDown||v===a)&&(v===b||a===b)||(b>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=b):(this.selectionStart=b,this.selectionEnd=this.__selectionStartOnMouseDown),(this.selectionStart!==v||this.selectionEnd!==a)&&(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(p,b,v){var a=v.slice(0,p),l=S.util.string.graphemeSplit(a).length;if(p===b)return{selectionStart:l,selectionEnd:l};var h=v.slice(p,b),m=S.util.string.graphemeSplit(h).length;return{selectionStart:l,selectionEnd:l+m}},fromGraphemeToStringSelection:function(p,b,v){var a=v.slice(0,p),l=a.join("").length;if(p===b)return{selectionStart:l,selectionEnd:l};var h=v.slice(p,b),m=h.join("").length;return{selectionStart:l,selectionEnd:l+m}},_updateTextarea:function(){if(this.cursorOffsetCache={},!!this.hiddenTextarea){if(!this.inCompositionMode){var p=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=p.selectionStart,this.hiddenTextarea.selectionEnd=p.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var p=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=p.selectionEnd,this.inCompositionMode||(this.selectionStart=p.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var p=this._calcTextareaPosition();this.hiddenTextarea.style.left=p.left,this.hiddenTextarea.style.top=p.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var p=this.inCompositionMode?this.compositionStart:this.selectionStart,b=this._getCursorBoundaries(p),v=this.get2DCursorLocation(p),a=v.lineIndex,l=v.charIndex,h=this.getValueOfPropertyAt(a,l,"fontSize")*this.lineHeight,m=b.leftOffset,_=this.calcTransformMatrix(),u={x:b.left+m,y:b.top+b.topOffset+h},x=this.canvas.getRetinaScaling(),T=this.canvas.upperCanvasEl,A=T.width/x,D=T.height/x,V=A-h,X=D-h,ie=T.clientWidth/A,ve=T.clientHeight/D;return u=S.util.transformPoint(u,_),u=S.util.transformPoint(u,this.canvas.viewportTransform),u.x*=ie,u.y*=ve,u.x<0&&(u.x=0),u.x>V&&(u.x=V),u.y<0&&(u.y=0),u.y>X&&(u.y=X),u.x+=this.canvas._offset.left,u.y+=this.canvas._offset.top,{left:u.x+"px",top:u.y+"px",fontSize:h+"px",charHeight:h}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var p=this._textBeforeEdit!==this.text,b=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,b&&(b.blur&&b.blur(),b.parentNode&&b.parentNode.removeChild(b)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),p&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),p&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var p in this.styles)this._textLines[p]||delete this.styles[p]},removeStyleFromTo:function(p,b){var v=this.get2DCursorLocation(p,!0),a=this.get2DCursorLocation(b,!0),l=v.lineIndex,h=v.charIndex,m=a.lineIndex,_=a.charIndex,u,x;if(l!==m){if(this.styles[l])for(u=h;u<this._unwrappedTextLines[l].length;u++)delete this.styles[l][u];if(this.styles[m])for(u=_;u<this._unwrappedTextLines[m].length;u++)x=this.styles[m][u],x&&(this.styles[l]||(this.styles[l]={}),this.styles[l][h+u-_]=x);for(u=l+1;u<=m;u++)delete this.styles[u];this.shiftLineStyles(m,l-m)}else if(this.styles[l]){x=this.styles[l];var T=_-h,A,D;for(u=h;u<_;u++)delete x[u];for(D in this.styles[l])A=parseInt(D,10),A>=_&&(x[A-T]=x[D],delete x[D])}},shiftLineStyles:function(p,b){var v=s(this.styles);for(var a in this.styles){var l=parseInt(a,10);l>p&&(this.styles[l+b]=v[l],v[l-b]||delete this.styles[l])}},restartCursorIfNeeded:function(){(!this._currentTickState||this._currentTickState.isAborted||!this._currentTickCompleteState||this._currentTickCompleteState.isAborted)&&this.initDelayedCursor()},insertNewlineStyleObject:function(p,b,v,a){var l,h={},m=!1,_=this._unwrappedTextLines[p].length===b;v||(v=1),this.shiftLineStyles(p,v),this.styles[p]&&(l=this.styles[p][b===0?b:b-1]);for(var u in this.styles[p]){var x=parseInt(u,10);x>=b&&(m=!0,h[x-b]=this.styles[p][u],_&&b===0||delete this.styles[p][u])}var T=!1;for(m&&!_&&(this.styles[p+v]=h,T=!0),T&&v--;v>0;)a&&a[v-1]?this.styles[p+v]={0:s(a[v-1])}:l?this.styles[p+v]={0:s(l)}:delete this.styles[p+v],v--;this._forceClearCache=!0},insertCharStyleObject:function(p,b,v,a){this.styles||(this.styles={});var l=this.styles[p],h=l?s(l):{};v||(v=1);for(var m in h){var _=parseInt(m,10);_>=b&&(l[_+v]=h[_],h[_-v]||delete l[_])}if(this._forceClearCache=!0,a){for(;v--;)Object.keys(a[v]).length&&(this.styles[p]||(this.styles[p]={}),this.styles[p][b+v]=s(a[v]));return}if(l)for(var u=l[b?b-1:1];u&&v--;)this.styles[p][b+v]=s(u)},insertNewStyleBlock:function(p,b,v){for(var a=this.get2DCursorLocation(b,!0),l=[0],h=0,m=0;m<p.length;m++)p[m]===`
`?(h++,l[h]=0):l[h]++;l[0]>0&&(this.insertCharStyleObject(a.lineIndex,a.charIndex,l[0],v),v=v&&v.slice(l[0]+1)),h&&this.insertNewlineStyleObject(a.lineIndex,a.charIndex+l[0],h);for(var m=1;m<h;m++)l[m]>0?this.insertCharStyleObject(a.lineIndex+m,0,l[m],v):v&&this.styles[a.lineIndex+m]&&v[0]&&(this.styles[a.lineIndex+m][0]=v[0]),v=v&&v.slice(l[m]+1);l[m]>0&&this.insertCharStyleObject(a.lineIndex+m,0,l[m],v)},setSelectionStartEndWithShift:function(p,b,v){v<=p?(b===p?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=p),this.selectionStart=v):v>p&&v<b?this._selectionDirection==="right"?this.selectionEnd=v:this.selectionStart=v:(b===p?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=b),this.selectionEnd=v)},setSelectionInBoundaries:function(){var p=this.text.length;this.selectionStart>p?this.selectionStart=p:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>p?this.selectionEnd=p:this.selectionEnd<0&&(this.selectionEnd=0)}})}(),S.util.object.extend(S.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(s){if(this.canvas){this.__newClickTime=+new Date;var p=s.pointer;this.isTripleClick(p)&&(this.fire("tripleclick",s),this._stopEvent(s.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=p,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(s){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===s.x&&this.__lastPointer.y===s.y},_stopEvent:function(s){s.preventDefault&&s.preventDefault(),s.stopPropagation&&s.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(s){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(s.e))},tripleClickHandler:function(s){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(s.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(s){!this.canvas||!this.editable||s.e.button&&s.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(s.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(s){!this.canvas||!this.editable||s.e.button&&s.e.button!==1||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(s){if(this.__isMousedown=!1,!(!this.editable||this.group||s.transform&&s.transform.actionPerformed||s.e.button&&s.e.button!==1)){if(this.canvas){var p=this.canvas._activeObject;if(p&&p!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(s.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(s){var p=this.getSelectionStartFromPointer(s),b=this.selectionStart,v=this.selectionEnd;s.shiftKey?this.setSelectionStartEndWithShift(b,v,p):(this.selectionStart=p,this.selectionEnd=p),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(s){for(var p=this.getLocalPointer(s),b=0,v=0,a=0,l=0,h=0,m,_,u=0,x=this._textLines.length;u<x&&a<=p.y;u++)a+=this.getHeightOfLine(u)*this.scaleY,h=u,u>0&&(l+=this._textLines[u-1].length+this.missingNewlineOffset(u-1));m=this._getLineLeftOffset(h),v=m*this.scaleX,_=this._textLines[h],this.direction==="rtl"&&(p.x=this.width*this.scaleX-p.x+v);for(var T=0,A=_.length;T<A&&(b=v,v+=this.__charBounds[h][T].kernedWidth*this.scaleX,v<=p.x);T++)l++;return this._getNewSelectionStartFromOffset(p,b,v,l,A)},_getNewSelectionStartFromOffset:function(s,p,b,v,a){var l=s.x-p,h=b-s.x,m=h>l||h<0?0:1,_=v+m;return this.flipX&&(_=a-_),_>this._text.length&&(_=this._text.length),_}}),S.util.object.extend(S.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=S.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var s=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+s.top+"; left: "+s.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding-top: "+s.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):S.document.body.appendChild(this.hiddenTextarea),S.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),S.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),S.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),S.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),S.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),S.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),S.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),S.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),S.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(S.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(s){if(this.isEditing){var p=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(s.keyCode in p)this[p[s.keyCode]](s);else if(s.keyCode in this.ctrlKeysMapDown&&(s.ctrlKey||s.metaKey))this[this.ctrlKeysMapDown[s.keyCode]](s);else return;s.stopImmediatePropagation(),s.preventDefault(),s.keyCode>=33&&s.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(s){if(!this.isEditing||this._copyDone||this.inCompositionMode){this._copyDone=!1;return}if(s.keyCode in this.ctrlKeysMapUp&&(s.ctrlKey||s.metaKey))this[this.ctrlKeysMapUp[s.keyCode]](s);else return;s.stopImmediatePropagation(),s.preventDefault(),this.canvas&&this.canvas.requestRenderAll()},onInput:function(s){var p=this.fromPaste;if(this.fromPaste=!1,s&&s.stopPropagation(),!!this.isEditing){var b=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,v=this._text.length,a=b.length,l,h,m=a-v,_=this.selectionStart,u=this.selectionEnd,x=_!==u,T,A,D;if(this.hiddenTextarea.value===""){this.styles={},this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll());return}var V=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),X=_>V.selectionStart;x?(l=this._text.slice(_,u),m+=u-_):a<v&&(X?l=this._text.slice(u+m,u):l=this._text.slice(_,_-m)),h=b.slice(V.selectionEnd-m,V.selectionEnd),l&&l.length&&(h.length&&(T=this.getSelectionStyles(_,_+1,!1),T=h.map(function(){return T[0]})),x?(A=_,D=u):X?(A=u-l.length,D=u):(A=u,D=u+l.length),this.removeStyleFromTo(A,D)),h.length&&(p&&h.join("")===S.copiedText&&!S.disableStyleCopyPaste&&(T=S.copiedTextStyle),this.insertNewStyleBlock(h,_,T)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(s){this.compositionStart=s.target.selectionStart,this.compositionEnd=s.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(S.copiedText=this.getSelectedText(),S.disableStyleCopyPaste?S.copiedTextStyle=null:S.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(s){return s&&s.clipboardData||S.window.clipboardData},_getWidthBeforeCursor:function(s,p){var b=this._getLineLeftOffset(s),v;return p>0&&(v=this.__charBounds[s][p-1],b+=v.left+v.width),b},getDownCursorOffset:function(s,p){var b=this._getSelectionForOffset(s,p),v=this.get2DCursorLocation(b),a=v.lineIndex;if(a===this._textLines.length-1||s.metaKey||s.keyCode===34)return this._text.length-b;var l=v.charIndex,h=this._getWidthBeforeCursor(a,l),m=this._getIndexOnLine(a+1,h),_=this._textLines[a].slice(l);return _.length+m+1+this.missingNewlineOffset(a)},_getSelectionForOffset:function(s,p){return s.shiftKey&&this.selectionStart!==this.selectionEnd&&p?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(s,p){var b=this._getSelectionForOffset(s,p),v=this.get2DCursorLocation(b),a=v.lineIndex;if(a===0||s.metaKey||s.keyCode===33)return-b;var l=v.charIndex,h=this._getWidthBeforeCursor(a,l),m=this._getIndexOnLine(a-1,h),_=this._textLines[a].slice(0,l),u=this.missingNewlineOffset(a-1);return-this._textLines[a-1].length+m-_.length+(1-u)},_getIndexOnLine:function(s,p){for(var b=this._textLines[s],v=this._getLineLeftOffset(s),a=v,l=0,h,m,_=0,u=b.length;_<u;_++)if(h=this.__charBounds[s][_].width,a+=h,a>p){m=!0;var x=a-h,T=a,A=Math.abs(x-p),D=Math.abs(T-p);l=D<A?_:_-1;break}return m||(l=b.length-1),l},moveCursorDown:function(s){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",s)},moveCursorUp:function(s){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",s)},_moveCursorUpOrDown:function(s,p){var b="get"+s+"CursorOffset",v=this[b](p,this._selectionDirection==="right");p.shiftKey?this.moveCursorWithShift(v):this.moveCursorWithoutShift(v),v!==0&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(s){var p=this._selectionDirection==="left"?this.selectionStart+s:this.selectionEnd+s;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,p),s!==0},moveCursorWithoutShift:function(s){return s<0?(this.selectionStart+=s,this.selectionEnd=this.selectionStart):(this.selectionEnd+=s,this.selectionStart=this.selectionEnd),s!==0},moveCursorLeft:function(s){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",s)},_move:function(s,p,b){var v;if(s.altKey)v=this["findWordBoundary"+b](this[p]);else if(s.metaKey||s.keyCode===35||s.keyCode===36)v=this["findLineBoundary"+b](this[p]);else return this[p]+=b==="Left"?-1:1,!0;if(typeof v<"u"&&this[p]!==v)return this[p]=v,!0},_moveLeft:function(s,p){return this._move(s,p,"Left")},_moveRight:function(s,p){return this._move(s,p,"Right")},moveCursorLeftWithoutShift:function(s){var p=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(p=this._moveLeft(s,"selectionStart")),this.selectionEnd=this.selectionStart,p},moveCursorLeftWithShift:function(s){if(this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd)return this._moveLeft(s,"selectionEnd");if(this.selectionStart!==0)return this._selectionDirection="left",this._moveLeft(s,"selectionStart")},moveCursorRight:function(s){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",s)},_moveCursorLeftOrRight:function(s,p){var b="moveCursor"+s+"With";this._currentCursorOpacity=1,p.shiftKey?b+="Shift":b+="outShift",this[b](p)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(s){if(this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd)return this._moveRight(s,"selectionStart");if(this.selectionEnd!==this._text.length)return this._selectionDirection="right",this._moveRight(s,"selectionEnd")},moveCursorRightWithoutShift:function(s){var p=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(p=this._moveRight(s,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,p},removeChars:function(s,p){typeof p>"u"&&(p=s+1),this.removeStyleFromTo(s,p),this._text.splice(s,p-s),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(s,p,b,v){typeof v>"u"&&(v=b),v>b&&this.removeStyleFromTo(b,v);var a=S.util.string.graphemeSplit(s);this.insertNewStyleBlock(a,b,p),this._text=[].concat(this._text.slice(0,b),a,this._text.slice(v)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var s=S.util.toFixed,p=/  +/g;S.util.object.extend(S.Text.prototype,{_toSVG:function(){var b=this._getSVGLeftTopOffsets(),v=this._getSVGTextAndBg(b.textTop,b.textLeft);return this._wrapSVGTextAndBg(v)},toSVG:function(b){return this._createBaseSVGMarkup(this._toSVG(),{reviver:b,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(b){var v=!0,a=this.getSvgTextDecoration(this);return[b.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",a?'text-decoration="'+a+'" ':"",'style="',this.getSvgStyles(v),'"',this.addPaintOrder()," >",b.textSpans.join(""),`</text>
`]},_getSVGTextAndBg:function(b,v){var a=[],l=[],h=b,m;this._setSVGBg(l);for(var _=0,u=this._textLines.length;_<u;_++)m=this._getLineLeftOffset(_),(this.textBackgroundColor||this.styleHas("textBackgroundColor",_))&&this._setSVGTextLineBg(l,_,v+m,h),this._setSVGTextLineText(a,_,v+m,h),h+=this.getHeightOfLine(_);return{textSpans:a,textBgRects:l}},_createTextCharSpan:function(b,v,a,l){var h=b!==b.trim()||b.match(p),m=this.getSvgSpanStyles(v,h),_=m?'style="'+m+'"':"",u=v.deltaY,x="",T=S.Object.NUM_FRACTION_DIGITS;return u&&(x=' dy="'+s(u,T)+'" '),['<tspan x="',s(a,T),'" y="',s(l,T),'" ',x,_,">",S.util.string.escapeXml(b),"</tspan>"].join("")},_setSVGTextLineText:function(b,v,a,l){var h=this.getHeightOfLine(v),m=this.textAlign.indexOf("justify")!==-1,_,u,x="",T,A,D=0,V=this._textLines[v],X;l+=h*(1-this._fontSizeFraction)/this.lineHeight;for(var ie=0,ve=V.length-1;ie<=ve;ie++)X=ie===ve||this.charSpacing,x+=V[ie],T=this.__charBounds[v][ie],D===0?(a+=T.kernedWidth-T.width,D+=T.width):D+=T.kernedWidth,m&&!X&&this._reSpaceAndTab.test(V[ie])&&(X=!0),X||(_=_||this.getCompleteStyleDeclaration(v,ie),u=this.getCompleteStyleDeclaration(v,ie+1),X=S.util.hasStyleChanged(_,u,!0)),X&&(A=this._getStyleDeclaration(v,ie)||{},b.push(this._createTextCharSpan(x,A,a,l)),x="",_=u,a+=D,D=0)},_pushTextBgRect:function(b,v,a,l,h,m){var _=S.Object.NUM_FRACTION_DIGITS;b.push("		<rect ",this._getFillAttributes(v),' x="',s(a,_),'" y="',s(l,_),'" width="',s(h,_),'" height="',s(m,_),`"></rect>
`)},_setSVGTextLineBg:function(b,v,a,l){for(var h=this._textLines[v],m=this.getHeightOfLine(v)/this.lineHeight,_=0,u=0,x,T,A=this.getValueOfPropertyAt(v,0,"textBackgroundColor"),D=0,V=h.length;D<V;D++)x=this.__charBounds[v][D],T=this.getValueOfPropertyAt(v,D,"textBackgroundColor"),T!==A?(A&&this._pushTextBgRect(b,A,a+u,l,_,m),u=x.left,_=x.width,A=T):_+=x.kernedWidth;T&&this._pushTextBgRect(b,T,a+u,l,_,m)},_getFillAttributes:function(b){var v=b&&typeof b=="string"?new S.Color(b):"";return!v||!v.getSource()||v.getAlpha()===1?'fill="'+b+'"':'opacity="'+v.getAlpha()+'" fill="'+v.setAlpha(1).toRgb()+'"'},_getSVGLineTopOffset:function(b){for(var v=0,a=0,l=0;l<b;l++)v+=this.getHeightOfLine(l);return a=this.getHeightOfLine(l),{lineTop:v,offset:(this._fontSizeMult-this._fontSizeFraction)*a/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(b){var v=S.Object.prototype.getSvgStyles.call(this,b);return v+" white-space: pre;"}})}(),function(s){var p=s.fabric||(s.fabric={});p.Textbox=p.util.createClass(p.IText,p.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:p.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(b){for(var v=0,a=0,l=0,h={},m=0;m<b.graphemeLines.length;m++)b.graphemeText[l]===`
`&&m>0?(a=0,l++,v++):!this.splitByGrapheme&&this._reSpaceAndTab.test(b.graphemeText[l])&&m>0&&(a++,l++),h[m]={line:v,offset:a},l+=b.graphemeLines[m].length,a+=b.graphemeLines[m].length;return h},styleHas:function(b,v){if(this._styleMap&&!this.isWrapping){var a=this._styleMap[v];a&&(v=a.line)}return p.Text.prototype.styleHas.call(this,b,v)},isEmptyStyles:function(b){if(!this.styles)return!0;var v=0,a=b+1,l,h,m=!1,_=this._styleMap[b],u=this._styleMap[b+1];_&&(b=_.line,v=_.offset),u&&(a=u.line,m=a===b,l=u.offset),h=typeof b>"u"?this.styles:{line:this.styles[b]};for(var x in h)for(var T in h[x])if(T>=v&&(!m||T<l))for(var A in h[x][T])return!1;return!0},_getStyleDeclaration:function(b,v){if(this._styleMap&&!this.isWrapping){var a=this._styleMap[b];if(!a)return null;b=a.line,v=a.offset+v}return this.callSuper("_getStyleDeclaration",b,v)},_setStyleDeclaration:function(b,v,a){var l=this._styleMap[b];b=l.line,v=l.offset+v,this.styles[b][v]=a},_deleteStyleDeclaration:function(b,v){var a=this._styleMap[b];b=a.line,v=a.offset+v,delete this.styles[b][v]},_getLineStyle:function(b){var v=this._styleMap[b];return!!this.styles[v.line]},_setLineStyle:function(b){var v=this._styleMap[b];this.styles[v.line]={}},_wrapText:function(b,v){var a=[],l;for(this.isWrapping=!0,l=0;l<b.length;l++)a=a.concat(this._wrapLine(b[l],l,v));return this.isWrapping=!1,a},_measureWord:function(b,v,a){var l=0,h,m=!0;a=a||0;for(var _=0,u=b.length;_<u;_++){var x=this._getGraphemeBox(b[_],v,_+a,h,m);l+=x.kernedWidth,h=b[_]}return l},_wrapLine:function(b,v,a,Ye){var h=0,m=this.splitByGrapheme,_=[],u=[],x=m?p.util.string.graphemeSplit(b):b.split(this._wordJoiners),T="",A=0,D=m?"":" ",V=0,X=0,ie=0,ve=!0,Fe=this._getWidthOfCharSpacing(),Ye=Ye||0;x.length===0&&x.push([]),a-=Ye;for(var Ze=0;Ze<x.length;Ze++)T=m?x[Ze]:p.util.string.graphemeSplit(x[Ze]),V=this._measureWord(T,v,A),A+=T.length,h+=X+V-Fe,h>a&&!ve?(_.push(u),u=[],h=V,ve=!0):h+=Fe,!ve&&!m&&u.push(D),u=u.concat(T),X=m?0:this._measureWord([D],v,A),A++,ve=!1,V>ie&&(ie=V);return Ze&&_.push(u),ie+Ye>this.dynamicMinWidth&&(this.dynamicMinWidth=ie-Fe+Ye),_},isEndOfWrapping:function(b){return!this._styleMap[b+1]||this._styleMap[b+1].line!==this._styleMap[b].line},missingNewlineOffset:function(b){return this.splitByGrapheme?this.isEndOfWrapping(b)?1:0:1},_splitTextIntoLines:function(b){for(var v=p.Text.prototype._splitTextIntoLines.call(this,b),a=this._wrapText(v.lines,this.width),l=new Array(a.length),h=0;h<a.length;h++)l[h]=a[h].join("");return v.lines=l,v.graphemeLines=a,v},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var b={};for(var v in this._styleMap)this._textLines[v]&&(b[this._styleMap[v].line]=1);for(var v in this.styles)b[v]||delete this.styles[v]},toObject:function(b){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(b))}}),p.Textbox.fromObject=function(b,v){var a=p.util.stylesFromArray(b.styles,b.text),l=Object.assign({},b,{styles:a});return p.Object._fromObject("Textbox",l,v,"text")}}($),function(){var s=S.controlsUtils,p=s.scaleSkewCursorStyleHandler,b=s.scaleCursorStyleHandler,v=s.scalingEqually,a=s.scalingYOrSkewingX,l=s.scalingXOrSkewingY,h=s.scaleOrSkewActionName,m=S.Object.prototype.controls;if(m.ml=new S.Control({x:-.5,y:0,cursorStyleHandler:p,actionHandler:l,getActionName:h}),m.mr=new S.Control({x:.5,y:0,cursorStyleHandler:p,actionHandler:l,getActionName:h}),m.mb=new S.Control({x:0,y:.5,cursorStyleHandler:p,actionHandler:a,getActionName:h}),m.mt=new S.Control({x:0,y:-.5,cursorStyleHandler:p,actionHandler:a,getActionName:h}),m.tl=new S.Control({x:-.5,y:-.5,cursorStyleHandler:b,actionHandler:v}),m.tr=new S.Control({x:.5,y:-.5,cursorStyleHandler:b,actionHandler:v}),m.bl=new S.Control({x:-.5,y:.5,cursorStyleHandler:b,actionHandler:v}),m.br=new S.Control({x:.5,y:.5,cursorStyleHandler:b,actionHandler:v}),m.mtr=new S.Control({x:0,y:-.5,actionHandler:s.rotationWithSnapping,cursorStyleHandler:s.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),S.Textbox){var _=S.Textbox.prototype.controls={};_.mtr=m.mtr,_.tr=m.tr,_.br=m.br,_.tl=m.tl,_.bl=m.bl,_.mt=m.mt,_.mb=m.mb,_.mr=new S.Control({x:.5,y:0,actionHandler:s.changeWidth,cursorStyleHandler:p,actionName:"resizing"}),_.ml=new S.Control({x:-.5,y:0,actionHandler:s.changeWidth,cursorStyleHandler:p,actionName:"resizing"})}}()})(_i);function Vd(){const $=Math.round(16777215*Math.random()),S=$>>16,re=$>>8&255,pe=$&255;return"rgb("+S+", "+re+", "+pe+")"}const Nh=$=>{if(!$)return[0,0,0];const S=$.match(/rgba?\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)?(?:, ?(\d(?:\.\d?))\))?/);return S?[parseInt(S[1]),parseInt(S[2]),parseInt(S[3])]:[0,0,0]},bd=($,S)=>{const re=$._offset.left,pe=$._offset.top,ue=S.e.pageX-re,Ie=S.e.pageY-pe;return{x:ue,y:Ie}},ym=$=>Math.abs(Math.min.apply(Math,$.map(function(S){return S.y}))),vm=$=>Math.abs(Math.min.apply(Math,$.map(function(S){return S.x}))),Ud=$=>{let S=new _i.fabric.Point($.strokeUniform?1/$.scaleX:1,$.strokeUniform?1/$.scaleY:1).multiply($.strokeWidth);return new _i.fabric.Point($.width+S.x,$.height+S.y)};class xm{generateNumber(S){return S*Math.random()|0}generateX(){return this.generateNumber(16).toString(16)}generateXes(S){let re="";for(let pe=0;pe<S;++pe)re+=this.generateX();return re}generateVariant(){return(this.generateNumber(16)&3|8).toString(16)}generate(){return this.generateXes(8)+"-"+this.generateXes(4)+"-4"+this.generateXes(3)+"-"+this.generateVariant()+this.generateXes(3)+"-"+this.generateXes(12)}}const wd=($,S,re)=>{const pe=$.x,ue=$.y,Ie=S.x,j=S.y,s=re/Math.hypot(Ie-pe,j-ue),p=Ie+(Ie-pe)*s,b=j+(j-ue)*s;return new _i.fabric.Point(p,b)},Uc=($,S,re,pe,ue)=>{$.x<S&&($.x=S),$.y<re&&($.y=re),$.x>pe&&($.x=pe),$.y>ue&&($.y=ue)},Cd=($,S,re)=>new _i.fabric.Point(Math.floor($.x/S),Math.floor($.y/re));var ns=($=>($.LeftRightTopBottom="lrtb",$.RightLeftBottomTop="rlbt",$))(ns||{});const bm=new Map([["lrtb","→↓"],["rlbt","←↑"]]),wm=new Map([["lrtb","Left->Right or Top->Bottom"],["rlbt","Right->Left or Bottom->Top"]]),Cm=new Map([["→↓","lrtb"],["←↑","rlbt"]]);($=>{function S(ue){return bm.get(ue)??"err"}$.toString=S;function re(ue){return wm.get(ue)??"err"}$.toHumanString=re;function pe(ue){return Cm.get(ue)}$.parse=pe})(ns||(ns={}));var lo=($=>($.LINE_CONTROL="lineControl",$.CHANGE_DIRECTION_CONTROL="changeDirectionControl",$.DELETE_VIRTUAL_LINE_CONTROL="deleteVirtualLineControl",$))(lo||{});const Sm="TYPE_VIRTUAL_LINE_GROUP";class Sd extends _i.fabric.Line{constructor(S,re){super(S,re)}calcCurrentPoints(){var s,p;const S=this.calcLinePoints(),re=this.calcTransformMatrix(),pe=((s=this.canvas)==null?void 0:s.getWidth())??10,ue=((p=this.canvas)==null?void 0:p.getHeight())??10,Ie=_i.fabric.util.transformPoint(new _i.fabric.Point(S.x1,S.y1),re);Uc(Ie,0,0,pe,ue);const j=_i.fabric.util.transformPoint(new _i.fabric.Point(S.x2,S.y2),re);return Uc(j,0,0,pe,ue),[Ie,j]}}class oo extends _i.fabric.Group{constructor(re,pe,ue){super(re,pe,ue);Fn(this,"segment_object_idx");Fn(this,"direction");Fn(this,"current_points");Fn(this,"color_rgb");Fn(this,"parentContour");this.segment_object_idx=0,this.direction=ns.LeftRightTopBottom,this.current_points=[[0,0],[0,0]],this.color_rgb=[0,0,0],this.type=Sm}}function Gd($,S,re){const pe=$.canvas;if(!pe)return console.error("Empty target canvas for preparing virtual line"),!1;const ue=new _i.fabric.Point(re.geometry[0][0],re.geometry[0][1]),Ie=new _i.fabric.Point(re.geometry[1][0],re.geometry[1][1]),j=new _i.fabric.Shadow({color:"rgba(0, 0, 0, 1)",affectStroke:!0,blur:30}),s=S?new _i.fabric.Point(Math.floor(ue.x*pe.scaleWidth),Math.floor(ue.y*pe.scaleHeight)):new _i.fabric.Point(Math.floor(ue.x/pe.scaleWidth),Math.floor(ue.y/pe.scaleHeight)),p=S?new _i.fabric.Point(Math.floor(Ie.x*pe.scaleWidth),Math.floor(Ie.y*pe.scaleHeight)):new _i.fabric.Point(Math.floor(Ie.x/pe.scaleWidth),Math.floor(Ie.y/pe.scaleHeight)),b=S?s:ue,v=S?p:Ie,a=new Sd([b.x,b.y,v.x,v.y],{stroke:$.stroke,strokeWidth:5,strokeDashArray:[5],strokeUniform:!0,objectCaching:!1,shadow:j}),l={fontWeight:"bold",fontSize:42},h=new _i.fabric.Point((b.x+v.x)/2,(b.y+v.y)/2),m=new _i.fabric.IText(ns.toString(re.direction),{left:h.x-20,top:h.y,fontSize:18,fontFamily:"Roboto",fill:$.stroke,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9,objectCaching:!1,styles:{0:{0:l,1:l}}}),_=new _i.fabric.Text("L1",{left:b.x-5,top:b.y+10,fontSize:18,fontFamily:"Roboto",fill:$.stroke,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9,objectCaching:!1}),u=new _i.fabric.Text("L2",{left:v.x-5,top:v.y+10,fontSize:18,fontFamily:"Roboto",fill:$.stroke,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9,objectCaching:!1}),x=new oo([a,m,_,u],{strokeUniform:!0,objectCaching:!1});x.current_points=S?[[ue.x,ue.y],[Ie.x,Ie.y]]:[[s.x,s.y],[p.x,p.y]],x.color_rgb=Nh(a.stroke),x.direction=re.direction,x.segment_object_idx=0,x.setControlsVisibility({bl:!1,br:!1,mb:!1,ml:!0,mr:!0,mt:!1,tl:!1,tr:!1,mtr:!0}),x.setControlVisible(lo.LINE_CONTROL,!1),x.setControlVisible(lo.CHANGE_DIRECTION_CONTROL,!0),x.setControlVisible(lo.DELETE_VIRTUAL_LINE_CONTROL,!0),x.on("scaling",function(T){const A=T.transform;if(!A){console.error("Empty transform event for group object on line group. Event: modified. Options:",T);return}const D=A.target;if(!D){console.error("Empty target group object on line group. Event: scaling. Options:",T);return}if(!(D instanceof oo)){console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: scaling. Options:",T);return}const V=1/(D.scaleX??1),X=1/(D.scaleY??1);D.getObjects("text").forEach(Fe=>{Fe.set("scaleX",V),Fe.set("scaleY",X)}),D.getObjects("i-text").forEach(Fe=>{Fe.set("scaleX",V),Fe.set("scaleY",X)})}),x.on("rotating",function(T){const A=T.transform;if(!A){console.error("Empty transform event for group object on line group. Event: modified. Options:",T);return}const D=A.target;if(!D){console.error("Empty target group object on line group. Event: scaling. Options:",T);return}if(!(D instanceof oo)){console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: scaling. Options:",T);return}const V=360-(D.angle??0);D.getObjects("text").forEach(ve=>{ve.rotate(V)}),D.getObjects("i-text").forEach(ve=>{ve.rotate(V)})}),x.on("modified",T=>{const A=T.target;if(!A){console.error("Empty target group object on line group. Event: modified. Options:",T);return}if(!(A instanceof oo)){console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: modified. Options:",T);return}const D=A.canvas;if(!D){console.error("Empty target canvas on line group. Event: modified. Options:",T);return}const V=A.getObjects()[A.segment_object_idx];if(!(V instanceof Sd)){console.error("Unhandled type. Only CustomLime on top of fabric.Object has been implemented. Event: modified. Options:",T);return}const X=V.calcCurrentPoints(),ie=Cd(X[0],D.scaleWidth,D.scaleHeight),ve=Cd(X[1],D.scaleWidth,D.scaleHeight);A.current_points[0][0]=ie.x,A.current_points[0][1]=ie.y,A.current_points[1][0]=ve.x,A.current_points[1][1]=ve.y,$.fire("virtial_line:modified",{target:$})}),x.on("mouseover",function(T){const A=T.target;if(!A){console.error("Empty target group object on line group. Event: mouseover. Options:",T);return}const D=A.canvas;if(!D){console.error("Empty target canvas on line group. Event: mouseover. Options:",T);return}if(!(A instanceof oo))return;A.getObjects().forEach(X=>{var nt,vt;const ie=(nt=X.shadow)==null?void 0:nt.valueOf();if(!(ie&&ie instanceof _i.fabric.Shadow))return;const Fe=ie;Fe.color="rgba(255, 255, 255, 1)",Fe.blur=30;const Ze=(vt=$.shadow)==null?void 0:vt.valueOf();if(!(Ze&&Ze instanceof _i.fabric.Shadow))return;const ct=Ze;ct.color="rgba(255, 255, 255, 1)",ct.blur=30}),D.renderAll()}),x.on("mouseout",function(T){const A=T.target;if(!A){console.error("Empty target object on line group. Event: mouseout. Options:",T);return}const D=A.canvas;if(!D){console.error("Empty target canvas on line group. Event: mouseout. Options:",T);return}if(!(A instanceof oo))return;A.getObjects().forEach(X=>{var nt,vt;const ie=(nt=X.shadow)==null?void 0:nt.valueOf();if(!(ie&&ie instanceof _i.fabric.Shadow))return;const Fe=ie;Fe.color="rgba(0, 0, 0, 1)",Fe.blur=30;const Ye=$,Ze=(vt=Ye.shadow)==null?void 0:vt.valueOf();if(!(Ze&&Ze instanceof _i.fabric.Shadow))return;const ct=Ze;ct.color=Ye.stroke,ct.blur=0}),D.renderAll()}),x.on("removed",function(T){x.parentContour&&x.parentContour.fire("virtial_line:removed",{target:$})}),$.virtual_line=x,$.fire("virtial_line:created",{target:$}),x.parentContour=$,pe.add(x)}class Tm extends _i.fabric.Canvas{constructor(re,pe){super(re,pe);Fn(this,"scaleWidth");Fn(this,"scaleHeight");Fn(this,"contourTemporary");Fn(this,"contourNotationTemporary");Fn(this,"contourFinalized");this.scaleWidth=1,this.scaleHeight=1,this.contourTemporary=new Array,this.contourNotationTemporary=new Array,this.contourFinalized=new Array}editContour(re){var pe,ue;if(this.setActiveObject(re),re.edit=!re.edit,re.edit){let Ie=((pe=re==null?void 0:re.points)==null?void 0:pe.length)-1;re.cornerStyle="circle",re.cornerSize=15,re.cornerColor="rgba(0, 0, 255, 1.0)",re.controls=(ue=re==null?void 0:re.points)==null?void 0:ue.reduce(function(j,s,p){return j["p"+p]=new _i.fabric.Control({positionHandler:Im,actionHandler:Em(p>0?p-1:Ie,Pm),actionName:"modifyPolygon",pointIndex:p}),j},{})}else re.cornerColor="rgb(178, 204, 255)",re.cornerStyle="rect",re.controls=_i.fabric.Object.prototype.controls;re.hasBorders=!re.edit,this.requestRenderAll()}}const Em=function($,S){return function(re,pe,ue,Ie){let j=pe.target;const s=new _i.fabric.Point(j.points[$].x-j.pathOffset.x,j.points[$].y-j.pathOffset.y);let p=_i.fabric.util.transformPoint(s,j.calcTransformMatrix()),b=S(re,pe,ue,Ie);j._setPositionDimensions({});let v=Ud(j),a=(j.points[$].x-j.pathOffset.x)/v.x,l=(j.points[$].y-j.pathOffset.y)/v.y;return j.setPositionByOrigin(p,a+.5,l+.5),b}},Im=function($,S,re){let pe=re.points[this.pointIndex].x-re.pathOffset.x,ue=re.points[this.pointIndex].y-re.pathOffset.y;const Ie=new _i.fabric.Point(pe,ue);return _i.fabric.util.transformPoint(Ie,_i.fabric.util.multiplyTransformMatrices(re.canvas.viewportTransform,re.calcTransformMatrix()))},Pm=function($,S,re,pe){let ue=S.target,Ie=ue.controls[ue.__corner],j=ue.toLocalPoint(new _i.fabric.Point(re,pe),"center","center"),s=Ud(ue),p=ue._getTransformedDimensions(0,0),b={x:j.x*s.x/p.x+ue.pathOffset.x,y:j.y*s.y/p.y+ue.pathOffset.y};return ue.points[Ie.pointIndex]=b,!0};class la extends _i.fabric.Polygon{constructor(re,pe){super(re,pe);Fn(this,"inner");Fn(this,"unid");Fn(this,"notation");Fn(this,"current_points");Fn(this,"virtual_line");this.unid="",this.notation=[],this.inner=this,this.current_points=[],this.virtual_line=void 0}}const Hd=["A","B","C","D"],Am=($,S=Vd())=>{let re=vm($),pe=ym($);const ue=new _i.fabric.Shadow({color:S,affectStroke:!0,blur:0});let Ie=new la($,{fill:"rgba(0,0,0,0)",stroke:S,strokeWidth:3,objectCaching:!1,shadow:ue});Ie.set({left:re,top:pe});const j=new Array;return $.forEach((s,p)=>{const b=new _i.fabric.Text(Hd[p],{left:s.x,top:s.y,fontSize:24,fontFamily:"Roboto",fill:S,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9,selectable:!1});j.push(b)}),Ie.current_points=Ie.points,Ie.unid="00000000-0000-0000-0000-000000000000",Ie.notation=j,Ie};function Wd($,S,re,pe,ue="",Ie=Vd(),j=!0){const s=Am($,Ie);return s.setControlVisible(lo.LINE_CONTROL,!0),s.setControlVisible(lo.CHANGE_DIRECTION_CONTROL,!1),s.setControlVisible(lo.DELETE_VIRTUAL_LINE_CONTROL,!1),s.inner.on("mousedown",Mm(S,re,pe)),s.inner.on("modified",km(re,pe)),j&&(s.inner.on("virtial_line:created",Vh(re,pe)),s.inner.on("virtial_line:modified",Xd(re,pe)),s.inner.on("virtial_line:removed",qd(re,pe))),s.inner.on("mouseover",function(p){var m;const b=p.target;if(!b){console.error("Empty target contour on mouseover. Options:",p);return}const v=b.canvas;if(!v){console.error("Empty target canvas on mouseover. Options:",p);return}b.set("fill","rgba(0, 0, 0, 0.1)");const a=(m=b.shadow)==null?void 0:m.valueOf();if(!(a&&a instanceof _i.fabric.Shadow))return;const h=a;h.blur=30,v.renderAll()}),s.inner.on("mouseout",function(p){var m;const b=p.target;if(!b){console.error("Empty target contour on mouseout. Options:",p);return}const v=b.canvas;if(!v){console.error("Empty target canvas on mouseout. Options:",p);return}b.set("fill","rgba(0, 0, 0, 0)");const a=(m=b.shadow)==null?void 0:m.valueOf();if(!(a&&a instanceof _i.fabric.Shadow))return;const h=a;h.blur=0,v.renderAll()}),ue!==""?s.unid=ue:s.unid=new xm().generate(),s.notation.forEach((p,b)=>{s.notation[b].text_id=s.unid}),s}function Vh($,S){return function(re){const pe=re.target;if(!pe){console.error("Empty target contour on virtual_line:created. Options:",re);return}if(!(pe instanceof la)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: virtual_line:created. Options:",re);return}const ue=pe,Ie=ue.virtual_line;if(!Ie){console.error("Empty virtual line. Event: virtual_line:created. Options:",re);return}let j=wl($).get(ue.unid);if(!j){console.error("No contour in datastorage. Event: virtual_line:created. Options:",re);return}j.properties.virtual_line={geometry:Ie.current_points,color_rgb:Ie.color_rgb,direction:Ie.direction},S(ue.unid,j)}}function Xd($,S){return Vh($,S)}function qd($,S){return function(re){const pe=re.target;if(!pe){console.error("Empty target contour on virtual_line:removed. Options:",re);return}if(!(pe instanceof la)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: virtual_line:removed. Options:",re);return}pe.virtual_line=void 0;let ue=wl($).get(pe.unid);if(!ue){console.warn("No contour in datastorage. Event: virtual_line:removed. Options:",re);return}ue.properties.virtual_line=void 0,S(pe.unid,ue)}}function Mm($,S,re){return function(pe){const ue=pe.target;if(!ue){console.error("Empty target contour on mouse:down. Options:",pe);return}if(!(ue instanceof la)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: mouse:down. Options:",pe);return}const Ie=ue,j=ue.canvas;if(!j){console.error("Empty target canvas on mouse:down. Options:",pe);return}if(pe.e.preventDefault(),pe.e.stopPropagation(),pe.button===3){if(wl($)!=Ui.EditingZone)$.set(Ui.EditingZone);else{$.set(Ui.Waiting);let p=wl(S).get(Ie.unid);if(!p){console.error("No contour in datastorage. Event: mouse:down. Options:",pe);return}if(!Ie.current_points){console.error("No current points in target polygon. Event: mouse:down. Options:",pe);return}p.properties.coordinates=Ie.current_points.map(b=>[Math.floor(b.x/j.scaleWidth),Math.floor(b.y/j.scaleHeight)]),re(Ie.unid,p)}j.editContour(Ie)}}}function km($,S){return function(re){const pe=re.target;if(!pe){console.error("Empty target contour on modified. Options:",re);return}if(!(pe instanceof la)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: modified. Options:",re);return}const ue=pe,Ie=pe.canvas;if(!Ie){console.error("Empty target canvas on modified. Options:",re);return}const j=ue.inner.calcTransformMatrix();if(!ue.inner.points){console.error("No points in fabric.Polygon. Event: modified. Options:",re);return}const s=ue.inner.points.map(function(b){return new _i.fabric.Point(b.x-ue.inner.pathOffset.x,b.y-ue.inner.pathOffset.y)}).map(function(b){return _i.fabric.util.transformPoint(b,j)});ue.current_points=s,ue.notation.forEach((b,v)=>{var l;const a=(l=ue.current_points)==null?void 0:l[v];if(!a){console.error(`No vertex at pos #${v} in target polygon. Event: modified`,"Options:",re);return}b.set({left:a.x,top:a.y})});let p=wl($).get(ue.unid);if(!p){console.error("No contour in datastorage. Event: modified. Options:",re);return}p.properties.coordinates=ue.current_points.map(b=>[Math.floor(b.x/Ie.scaleWidth),Math.floor(b.y/Ie.scaleHeight)]),S(ue.unid,p)}}const Td=($,S,re,pe)=>{wl(re).forEach(ue=>{const Ie=ue.properties.coordinates.map(s=>({x:s[0]*$.scaleWidth,y:s[1]*$.scaleHeight})),j=Wd(Ie,S,re,pe,ue.id,`rgb(${ue.properties.color_rgb[0]},${ue.properties.color_rgb[1]},${ue.properties.color_rgb[2]})`,!1);$.add(j.inner),ue.properties.virtual_line&&Gd(j,!0,ue.properties.virtual_line),j.inner.on("virtial_line:created",Vh(re,pe)),j.inner.on("virtial_line:modified",Xd(re,pe)),j.inner.on("virtial_line:removed",qd(re,pe)),j.notation.forEach(s=>{$.add(s)}),$.renderAll()})},bl=32,Om="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1.2rem' height='1.2rem' viewBox='0 0 24 24'%3E %3Crect width='100%25' height='100%25' stroke='rgba(0, 0, 0, 1)' stroke-width='2px' fill='rgba(255, 255, 255, 0.3)' %2F%3E %3Cpath fill='red' stroke='%234b4b4b' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 18a2 2 0 1 0 4 0a2 2 0 1 0-4 0M16 6a2 2 0 1 0 4 0a2 2 0 1 0-4 0M7.5 16.5l9-9'/%3E%3C/svg%3E",$d=document.createElement("img");$d.src=Om;const Dm=($,S,re,pe)=>{var u;const ue=S.target;if(!ue)return console.error("Empty target contour on control click. Transform data:",S),!1;if(!(ue instanceof la))return console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: control click. Transform data:",S),!1;if(ue.virtual_line)return console.warn("Target contour already has virtual line. Ignoring. Transform data:",S),!1;const Ie=ue.canvas;if(!Ie)return console.error("Empty target canvas on control click. transform Data:",S),!1;const j=(u=ue.current_points)==null?void 0:u.slice();if(!j)return console.error("Empty target canvas points on control click. transform Data:",S),!1;if(j.length!==4)return console.error("Target canvas points should have 4 points exactly on control click. transform Data:",S),!1;const s=j[0],p=j[1],b=j[2],v=j[3],a=30,l=Ie.getWidth()-10,h=Ie.getHeight()-10,m=wd(v,s,a);Uc(m,0,0,l,h);const _=wd(b,p,a);return Uc(_,0,0,l,h),Gd(ue,!1,{geometry:[[m.x,m.y],[_.x,_.y]],color_rgb:Nh(ue.stroke),direction:ns.LeftRightTopBottom}),!0},Lm=($,S,re,pe,ue)=>{ue instanceof la&&($.save(),$.translate(S,re),ue.angle&&$.rotate(_i.fabric.util.degreesToRadians(ue.angle)),$.drawImage($d,-bl/2,-bl/2,bl,bl),$.restore())},zm=new _i.fabric.Control({x:.5,y:-.5,offsetY:-16,offsetX:16,cursorStyle:"pointer",mouseUpHandler:Dm,render:Lm,sizeX:bl,sizeY:bl}),As=32,Fm="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1.2rem' height='1.2rem' viewBox='0 0 24 24'%3E%3Crect width='100%25' height='100%25' stroke='rgba(0, 0, 0, 1)' stroke-width='2px' fill='rgba(255, 255, 255, 0.3)'/%3E%3Cpath fill='none' stroke='%23ff0000' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.75' d='M17 20V8m0 12l-3.5-3.5M17 20l3.5-3.5M7 17V4m0 0L3.5 7.5M7 4l3.5 3.5'/%3E%3C/svg%3E",Yd=document.createElement("img");Yd.src=Fm;const Rm=($,S,re,pe)=>{var j;const ue=S.target;if(!ue)return console.error("Empty target. Event: change_direction_control. Transform data:",S),!1;if(!(ue instanceof oo))return console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: change_direction_control. Transform data:",S),!1;if(!ue.parentContour)return console.error("Empty parent contour. Event: change_direction_control. Transform data:",S),!1;ue.direction=ue.direction===ns.LeftRightTopBottom?ns.RightLeftBottomTop:ns.LeftRightTopBottom;const Ie=ue.getObjects()[1];return Ie instanceof _i.fabric.IText?(Ie.set("text",ns.toString(ue.direction)),ue.parentContour.fire("virtial_line:modified",{target:ue.parentContour}),(j=ue.canvas)==null||j.renderAll(),!0):(console.error("Unhandled object. Should be fabric.IText at position #1 Event: change_direction_control. Transform data:",S),!1)},Bm=($,S,re,pe,ue)=>{ue instanceof oo&&($.save(),$.translate(S,re),ue.angle&&$.rotate(_i.fabric.util.degreesToRadians(ue.angle)),$.drawImage(Yd,-As/2,-As/2,As,As),$.restore())},jm=new _i.fabric.Control({x:.5,y:-.5,offsetY:-16,offsetX:-16,cursorStyle:"pointer",mouseUpHandler:Rm,render:Bm,sizeX:As,sizeY:As}),Nm="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1.2rem' height='1.2rem' viewBox='0 0 24 24'%3E%3Crect width='100%25' height='100%25' stroke='rgba(0, 0, 0, 1)' stroke-width='2px' fill='rgba(255, 255, 255, 0.3)'/%3E%3Cpath fill='%23ff0000' d='M12 2a10 10 0 0 1 10 10a10 10 0 0 1-10 10A10 10 0 0 1 2 12A10 10 0 0 1 12 2m0 2a8 8 0 0 0-8 8a8 8 0 0 0 8 8a8 8 0 0 0 8-8a8 8 0 0 0-8-8m4 6v7a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-7zm-2.5-4l1 1H17v2H7V7h2.5l1-1z'/%3E%3C/svg%3E",Zd=document.createElement("img");Zd.src=Nm;const Vm=($,S,re,pe)=>{var Ie;const ue=S.target;return ue?ue instanceof oo?ue.parentContour?((Ie=ue.canvas)==null||Ie.remove(ue),!0):(console.error("Empty parent contour. Event: delete_virtual_line_control. Transform data:",S),!1):(console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: delete_virtual_line_control. Transform data:",S),!1):(console.error("Empty target. Event: delete_virtual_line_control. Transform data:",S),!1)},Um=($,S,re,pe,ue)=>{ue instanceof oo&&($.save(),$.translate(S,re),ue.angle&&$.rotate(_i.fabric.util.degreesToRadians(ue.angle)),$.drawImage(Zd,-As/2,-As/2,As,As),$.restore())},Gm=new _i.fabric.Control({x:.5,y:-.5,offsetY:-16,offsetX:16,cursorStyle:"pointer",mouseUpHandler:Vm,render:Um,sizeX:As,sizeY:As});function Hm($){let S,re,pe,ue,Ie,j,s,p,b,v,a,l,h,m,_;return b=new mm({props:{msgText:"Please wait until image is loaded"}}),{c(){S=Ot("div"),re=Ot("img"),ue=Ii(),Ie=Ot("canvas"),j=Ii(),s=Ot("div"),p=Ot("div"),Fa(b.$$.fragment),this.h()},l(u){S=Dt(u,"DIV",{id:!0,class:!0});var x=ti(S);re=Dt(x,"IMG",{id:!0,src:!0,width:!0,height:!0,class:!0}),ue=Pi(x),Ie=Dt(x,"CANVAS",{id:!0,class:!0}),ti(Ie).forEach(Gt),j=Pi(x),s=Dt(x,"DIV",{id:!0,class:!0});var T=ti(s);p=Dt(T,"DIV",{class:!0});var A=ti(p);Ra(b.$$.fragment,A),A.forEach(Gt),T.forEach(Gt),x.forEach(Gt),this.h()},h(){dt(re,"id","fit_img"),_d(re.src,pe=$[1]+"/live_streaming")||dt(re,"src",pe),dt(re,"width","500"),dt(re,"height","500"),dt(re,"class","svelte-ao3ads"),dt(Ie,"id","fit_canvas"),dt(Ie,"class","svelte-ao3ads"),dt(p,"class",v=so($[2]?"d-none":"loading d-block")+" svelte-ao3ads"),dt(s,"id","loading-message"),dt(s,"class",a=so($[2]?"d-none":"d-block")+" svelte-ao3ads"),dt(S,"id","mjpeg"),dt(S,"class",l=so("mjpeg-canvas "+$[0])+" svelte-ao3ads")},m(u,x){gn(u,S,x),it(S,re),it(S,ue),it(S,Ie),it(S,j),it(S,s),it(s,p),Ba(b,p,null),h=!0,m||(_=_s(re,"load",$[5]),m=!0)},p(u,[x]){(!h||x&2&&!_d(re.src,pe=u[1]+"/live_streaming"))&&dt(re,"src",pe),(!h||x&4&&v!==(v=so(u[2]?"d-none":"loading d-block")+" svelte-ao3ads"))&&dt(p,"class",v),(!h||x&4&&a!==(a=so(u[2]?"d-none":"d-block")+" svelte-ao3ads"))&&dt(s,"class",a),(!h||x&1&&l!==(l=so("mjpeg-canvas "+u[0])+" svelte-ao3ads"))&&dt(S,"class",l)},i(u){h||(ja(b.$$.fragment,u),h=!0)},o(u){Na(b.$$.fragment,u),h=!1},d(u){u&&Gt(S),Va(b),m=!1,_()}}}function Wm($,S,re){let pe,ue,Ie,j,s;Nr($,Fh,x=>re(8,pe=x)),Nr($,ao,x=>re(9,ue=x)),Nr($,jc,x=>re(10,Ie=x));let{klass:p=""}=S;const{apiURL:b}=Nc;Nr($,b,x=>re(11,j=x));let v=`${j}`,a;tn.subscribe(x=>a=x);let l=qn(!1);Nr($,l,x=>re(2,s=x));const h=()=>{if(console.log("Image source reloaded"),Ie==null){console.log("Prepare canvas on first initialization");const x=u();jc.set(x)}l.set(!0),xl.set(!0)},m=jh.subscribe(x=>{v!==x&&(console.log(`Need to change API URL for MJPEG: '${j}'`),re(1,v=x),l.set(!1))});sc(()=>{console.log("Mounted canvas component")}),Dh(()=>{xl.set(!1),Ie==null||Ie.getObjects().forEach(x=>{Ie.remove(x)}),m(),jc.set(void 0)});const _=(x,T)=>{x.getObjects().forEach(A=>{A instanceof la&&A.unid===T&&(A.virtual_line&&x.remove(A.virtual_line),A.notation.forEach(D=>{x.remove(D)}),x.remove(A))}),lm(ue,pe,T),om(T)},u=()=>{const x=document.getElementById("fit_canvas"),T=document.getElementById("fit_img");x.width=T.clientWidth,x.height=T.clientHeight;const A=new Tm("fit_canvas",{containerClass:"custom-container-canvas",fireRightClick:!0,fireMiddleClick:!0,stopContextMenu:!0});A.scaleWidth=T.clientWidth/T.naturalWidth,A.scaleHeight=T.clientHeight/T.naturalHeight,_i.fabric.Object.prototype.controls[lo.LINE_CONTROL]=zm,_i.fabric.Object.prototype.controls[lo.CHANGE_DIRECTION_CONTROL]=jm,_i.fabric.Object.prototype.controls[lo.DELETE_VIRTUAL_LINE_CONTROL]=Gm;const D=document.getElementsByClassName("custom-container-canvas")[0];return D.id="fbcanvas",A.on("selection:created",V=>{a===Ui.DeletingZoneCanvas&&(_(A,V.selected[0].unid),tn.set(Ui.Waiting))}),A.on("selection:updated",V=>{a===Ui.DeletingZoneCanvas&&(_(A,V.selected[0].unid),tn.set(Ui.Waiting))}),A.on("mouse:move",V=>{if(A.contourTemporary[0]!==null&&A.contourTemporary[0]!==void 0&&a===Ui.AddingZoneCanvas){const X=bd(A,V);A.contourTemporary[A.contourTemporary.length-1].set({x2:X.x,y2:X.y}),A.renderAll()}}),A.on("mouse:down",V=>{if(a!==Ui.AddingZoneCanvas)return;A.selection=!1;const X=bd(A,V);A.contourFinalized.push({x:X.x,y:X.y});const ie=[X.x,X.y,X.x,X.y],ve=new _i.fabric.Line(ie,{strokeWidth:3,selectable:!1,stroke:"purple"}),Fe=new _i.fabric.Text(Hd[A.contourFinalized.length-1],{left:X.x,top:X.y,fontSize:24,fontFamily:"Roboto",fill:"purple",shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9});if(A.contourNotationTemporary.push(Fe),A.contourTemporary.push(ve),A.add(ve),A.add(Fe),A.on("mouse:up",function(Je){A.selection=!0}),A.contourFinalized.length<=3)return;A.contourTemporary.forEach(Je=>{A.remove(Je)}),A.contourNotationTemporary.forEach(Je=>{A.remove(Je)});const Ye=Wd(A.contourFinalized,tn,ao,Ua),Ze={type:"Feature",id:Ye.unid,properties:{color_rgb:Nh(Ye.inner.stroke),color_rgb_str:Ye.inner.stroke?Ye.inner.stroke:"rgb(0, 0, 0)",coordinates:Ye.inner.current_points.map(Je=>[Math.floor(Je.x/A.scaleWidth),Math.floor(Je.y/A.scaleHeight)]),road_lane_direction:-1,road_lane_num:-1,spatial_object_id:void 0},geometry:{type:"Polygon",coordinates:[[[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1]]]}};Ua(Ye.unid,Ze),A.add(Ye.inner),Ye.notation.forEach(Je=>{A.add(Je)}),A.renderAll(),A.contourTemporary=[],A.contourNotationTemporary=[],A.contourFinalized=[],tn.set(Ui.Waiting),pe.changeMode("simple_select")}),A};return $.$$set=x=>{"klass"in x&&re(0,p=x.klass)},[p,v,s,b,l,h]}class Xm extends oa{constructor(S){super(),aa(this,S,Wm,Hm,sa,{klass:0})}}function qm($){let S,re,pe,ue,Ie,j,s,p,b="Protocol schema type",v,a,l,h,m,_,u="Address or explicit IP",x,T,A,D,V,X,ie="Port",ve,Fe,Ye="Switch",Ze,Je;return{c(){S=Ot("div"),re=Ot("form"),pe=Ot("div"),ue=Ot("div"),Ie=Ot("div"),j=Ot("input"),s=Ii(),p=Ot("label"),p.textContent=b,v=Ii(),a=Ot("div"),l=Ot("div"),h=Ot("input"),m=Ii(),_=Ot("label"),_.textContent=u,x=Ii(),T=Ot("div"),A=Ot("div"),D=Ot("input"),V=Ii(),X=Ot("label"),X.textContent=ie,ve=Ii(),Fe=Ot("button"),Fe.textContent=Ye,this.h()},l(ct){S=Dt(ct,"DIV",{class:!0});var nt=ti(S);re=Dt(nt,"FORM",{autocomplete:!0});var vt=ti(re);pe=Dt(vt,"DIV",{class:!0});var Mt=ti(pe);ue=Dt(Mt,"DIV",{class:!0});var st=ti(ue);Ie=Dt(st,"DIV",{class:!0});var bt=ti(Ie);j=Dt(bt,"INPUT",{id:!0,type:!0,class:!0}),s=Pi(bt),p=Dt(bt,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),br(p)!=="svelte-4i6s19"&&(p.textContent=b),bt.forEach(Gt),st.forEach(Gt),v=Pi(Mt),a=Dt(Mt,"DIV",{class:!0});var ee=ti(a);l=Dt(ee,"DIV",{class:!0});var be=ti(l);h=Dt(be,"INPUT",{id:!0,type:!0,class:!0}),m=Pi(be),_=Dt(be,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),br(_)!=="svelte-1tjbdse"&&(_.textContent=u),be.forEach(Gt),ee.forEach(Gt),x=Pi(Mt),T=Dt(Mt,"DIV",{class:!0});var me=ti(T);A=Dt(me,"DIV",{class:!0});var ge=ti(A);D=Dt(ge,"INPUT",{id:!0,type:!0,class:!0}),V=Pi(ge),X=Dt(ge,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),br(X)!=="svelte-1gcg7vj"&&(X.textContent=ie),ge.forEach(Gt),me.forEach(Gt),Mt.forEach(Gt),vt.forEach(Gt),ve=Pi(nt),Fe=Dt(nt,"BUTTON",{class:!0,type:!0,name:!0,"data-svelte-h":!0}),br(Fe)!=="svelte-14v6gij"&&(Fe.textContent=Ye),nt.forEach(Gt),this.h()},h(){dt(j,"id","input_protocol"),dt(j,"type","text"),dt(j,"class","validate"),dt(p,"class","active"),dt(p,"for","input_protocol"),dt(Ie,"class","input-field"),dt(ue,"class","addr-part row svelte-142324r"),dt(h,"id","input_protocol"),dt(h,"type","text"),dt(h,"class","validate"),dt(_,"class","active"),dt(_,"for","input_protocol"),dt(l,"class","input-field"),dt(a,"class","addr-part row svelte-142324r"),dt(D,"id","input_protocol"),dt(D,"type","number"),dt(D,"class","validate"),dt(X,"class","active"),dt(X,"for","input_protocol"),dt(A,"class","input-field"),dt(T,"class","addr-part row svelte-142324r"),dt(pe,"class","addr-form svelte-142324r"),dt(re,"autocomplete","off"),dt(Fe,"class","btn waves-effect waves-light btn-small red"),dt(Fe,"type","submit"),dt(Fe,"name","action"),dt(S,"class","addr-container svelte-142324r")},m(ct,nt){gn(ct,S,nt),it(S,re),it(re,pe),it(pe,ue),it(ue,Ie),it(Ie,j),na(j,$[0]),it(Ie,s),it(Ie,p),it(pe,v),it(pe,a),it(a,l),it(l,h),na(h,$[1]),it(l,m),it(l,_),it(pe,x),it(pe,T),it(T,A),it(A,D),na(D,$[2]),it(A,V),it(A,X),it(S,ve),it(S,Fe),Ze||(Je=[_s(j,"input",$[8]),_s(h,"input",$[9]),_s(D,"input",$[10]),_s(Fe,"click",$[7])],Ze=!0)},p(ct,[nt]){nt&1&&j.value!==ct[0]&&na(j,ct[0]),nt&2&&h.value!==ct[1]&&na(h,ct[1]),nt&4&&kd(D.value)!==ct[2]&&na(D,ct[2])},i:ys,o:ys,d(ct){ct&&Gt(S),Ze=!1,Lh(Je)}}}function $m($,S,re){let pe,ue,Ie,j;const{schema:s,host:p,port:b}=Nc;Nr($,s,u=>re(0,ue=u)),Nr($,p,u=>re(1,Ie=u)),Nr($,b,u=>re(2,j=u));const{apiURL:v}=Nc;Nr($,v,u=>re(12,pe=u));let a=pe;const l=()=>{a!==pe&&(jh.set(pe),a=pe)};sc(()=>{console.log(`Mount IP form. Initial address: '${pe}'`)});function h(){ue=this.value,s.set(ue)}function m(){Ie=this.value,p.set(Ie)}function _(){j=kd(this.value),b.set(j)}return[ue,Ie,j,s,p,b,v,l,h,m,_]}class Ym extends oa{constructor(S){super(),aa(this,S,$m,qm,sa,{})}}function Zm($){let S,re,pe,ue,Ie,j,s,p,b="URI for Maptiler styles JSON",v,a,l="Switch",h,m;return{c(){S=Ot("div"),re=Ot("form"),pe=Ot("div"),ue=Ot("div"),Ie=Ot("div"),j=Ot("input"),s=Ii(),p=Ot("label"),p.textContent=b,v=Ii(),a=Ot("button"),a.textContent=l,this.h()},l(_){S=Dt(_,"DIV",{class:!0});var u=ti(S);re=Dt(u,"FORM",{autocomplete:!0});var x=ti(re);pe=Dt(x,"DIV",{class:!0});var T=ti(pe);ue=Dt(T,"DIV",{class:!0});var A=ti(ue);Ie=Dt(A,"DIV",{class:!0});var D=ti(Ie);j=Dt(D,"INPUT",{id:!0,type:!0,class:!0}),s=Pi(D),p=Dt(D,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),br(p)!=="svelte-1xx2eh2"&&(p.textContent=b),D.forEach(Gt),A.forEach(Gt),T.forEach(Gt),x.forEach(Gt),v=Pi(u),a=Dt(u,"BUTTON",{class:!0,type:!0,name:!0,"data-svelte-h":!0}),br(a)!=="svelte-1zwpv7"&&(a.textContent=l),u.forEach(Gt),this.h()},h(){dt(j,"id","input_protocol"),dt(j,"type","text"),dt(j,"class","validate"),dt(p,"class","active"),dt(p,"for","input_style_url"),dt(Ie,"class","input-field"),dt(ue,"class","styles-switch-part row svelte-4gm7qr"),dt(pe,"class","styles-switch-form svelte-4gm7qr"),dt(re,"autocomplete","off"),dt(a,"class","btn waves-effect waves-light btn-small red"),dt(a,"type","submit"),dt(a,"name","action"),dt(S,"class","styles-switch-container svelte-4gm7qr")},m(_,u){gn(_,S,u),it(S,re),it(re,pe),it(pe,ue),it(ue,Ie),it(Ie,j),na(j,$[0]),it(Ie,s),it(Ie,p),it(S,v),it(S,a),h||(m=[_s(j,"input",$[3]),_s(a,"click",$[2])],h=!0)},p(_,[u]){u&1&&j.value!==_[0]&&na(j,_[0])},i:ys,o:ys,d(_){_&&Gt(S),h=!1,Lh(m)}}}function Km($,S,re){let pe;const{uri:ue}=Vc;Nr($,ue,p=>re(0,pe=p));let Ie=pe;const j=()=>{Ie!==pe&&(Ie=pe,Vc.accepted_uri.update(()=>Ie))};sc(()=>{console.log(`Mount styles form. Initial styles URL: '${pe}'`)});function s(){pe=this.value,ue.set(pe)}return[pe,ue,j,s]}class Jm extends oa{constructor(S){super(),aa(this,S,Km,Zm,sa,{})}}function Qm($){let S,re,pe,ue,Ie,j;return re=new Ym({}),ue=new Jm({}),{c(){S=Ot("div"),Fa(re.$$.fragment),pe=Ii(),Fa(ue.$$.fragment),this.h()},l(s){S=Dt(s,"DIV",{class:!0});var p=ti(S);Ra(re.$$.fragment,p),pe=Pi(p),Ra(ue.$$.fragment,p),p.forEach(Gt),this.h()},h(){dt(S,"class",Ie=so("switcher-container "+$[0])+" svelte-19pygco")},m(s,p){gn(s,S,p),Ba(re,S,null),it(S,pe),Ba(ue,S,null),j=!0},p(s,[p]){(!j||p&1&&Ie!==(Ie=so("switcher-container "+s[0])+" svelte-19pygco"))&&dt(S,"class",Ie)},i(s){j||(ja(re.$$.fragment,s),ja(ue.$$.fragment,s),j=!0)},o(s){Na(re.$$.fragment,s),Na(ue.$$.fragment,s),j=!1},d(s){s&&Gt(S),Va(re),Va(ue)}}}function eg($,S,re){let{klass:pe=""}=S;return $.$$set=ue=>{"klass"in ue&&re(0,pe=ue.klass)},[pe]}class tg extends oa{constructor(S){super(),aa(this,S,eg,Qm,sa,{klass:0})}}function Ed($,S,re){const pe=$.slice();return pe[4]=S[re][0],pe[5]=S[re][1],pe}function Id($){let S,re=vd($[2]),pe=[];for(let ue=0;ue<re.length;ue+=1)pe[ue]=Pd(Ed($,re,ue));return{c(){for(let ue=0;ue<pe.length;ue+=1)pe[ue].c();S=yd()},l(ue){for(let Ie=0;Ie<pe.length;Ie+=1)pe[Ie].l(ue);S=yd()},m(ue,Ie){for(let j=0;j<pe.length;j+=1)pe[j]&&pe[j].m(ue,Ie);gn(ue,S,Ie)},p(ue,Ie){if(Ie&4){re=vd(ue[2]);let j;for(j=0;j<re.length;j+=1){const s=Ed(ue,re,j);pe[j]?pe[j].p(s,Ie):(pe[j]=Pd(s),pe[j].c(),pe[j].m(S.parentNode,S))}for(;j<pe.length;j+=1)pe[j].d(1);pe.length=re.length}},d(ue){ue&&Gt(S),Wp(pe,ue)}}}function ig($){let S,re="None";return{c(){S=Ot("span"),S.textContent=re,this.h()},l(pe){S=Dt(pe,"SPAN",{style:!0,"data-svelte-h":!0}),br(S)!=="svelte-6frfcq"&&(S.textContent=re),this.h()},h(){za(S,"font-weight","bold")},m(pe,ue){gn(pe,S,ue)},p:ys,d(pe){pe&&Gt(S)}}}function rg($){let S,re=ns.toHumanString($[5].properties.virtual_line.direction)+"",pe;return{c(){S=Ot("span"),pe=Cn(re)},l(ue){S=Dt(ue,"SPAN",{});var Ie=ti(S);pe=Sn(Ie,re),Ie.forEach(Gt)},m(ue,Ie){gn(ue,S,Ie),it(S,pe)},p(ue,Ie){Ie&4&&re!==(re=ns.toHumanString(ue[5].properties.virtual_line.direction)+"")&&Ws(pe,re)},d(ue){ue&&Gt(S)}}}function ng($){let S,re='<td>Virtual line</td> <td><span style="font-weight: bold;">None</span></td>';return{c(){S=Ot("tr"),S.innerHTML=re},l(pe){S=Dt(pe,"TR",{"data-svelte-h":!0}),br(S)!=="svelte-1un2uac"&&(S.innerHTML=re)},m(pe,ue){gn(pe,S,ue)},p:ys,d(pe){pe&&Gt(S)}}}function sg($){let S,re,pe="Virtual line direction",ue,Ie,j,s=ns.toHumanString($[5].properties.virtual_line.direction)+"",p,b,v,a,l="Virtual line coordinates",h,m,_=JSON.stringify($[5].properties.virtual_line.geometry)+"",u;return{c(){S=Ot("tr"),re=Ot("td"),re.textContent=pe,ue=Ii(),Ie=Ot("td"),j=Ot("span"),p=Cn(s),b=Ii(),v=Ot("tr"),a=Ot("td"),a.textContent=l,h=Ii(),m=Ot("td"),u=Cn(_)},l(x){S=Dt(x,"TR",{});var T=ti(S);re=Dt(T,"TD",{"data-svelte-h":!0}),br(re)!=="svelte-1p9a9lk"&&(re.textContent=pe),ue=Pi(T),Ie=Dt(T,"TD",{});var A=ti(Ie);j=Dt(A,"SPAN",{});var D=ti(j);p=Sn(D,s),D.forEach(Gt),A.forEach(Gt),T.forEach(Gt),b=Pi(x),v=Dt(x,"TR",{});var V=ti(v);a=Dt(V,"TD",{"data-svelte-h":!0}),br(a)!=="svelte-11bq1zi"&&(a.textContent=l),h=Pi(V),m=Dt(V,"TD",{});var X=ti(m);u=Sn(X,_),X.forEach(Gt),V.forEach(Gt)},m(x,T){gn(x,S,T),it(S,re),it(S,ue),it(S,Ie),it(Ie,j),it(j,p),gn(x,b,T),gn(x,v,T),it(v,a),it(v,h),it(v,m),it(m,u)},p(x,T){T&4&&s!==(s=ns.toHumanString(x[5].properties.virtual_line.direction)+"")&&Ws(p,s),T&4&&_!==(_=JSON.stringify(x[5].properties.virtual_line.geometry)+"")&&Ws(u,_)},d(x){x&&(Gt(S),Gt(b),Gt(v))}}}function Pd($){let S,re,pe,ue,Ie,j,s,p,b,v,a,l=$[5].id+"",h,m,_,u,x,T,A,D="Virtual line:",V,X,ie,ve,Fe,Ye="<tr><th>Attirubute</th> <th>Value</th></tr>",Ze,Je,ct,nt,vt="Road lane direction",Mt,st,bt=$[5].properties.road_lane_direction+"",ee,be,me,ge,je="Road lane number",_e,te,Pe=$[5].properties.road_lane_num+"",Ne,et,He,Ge,_t="Color",It,Xe,Oe,ot,qe,le,ft="Canvas coordinates",Pt,Tt,Nt=JSON.stringify($[5].properties.coordinates)+"",lt,wt,Yt,fi,mi="Spatial coordinates",yi,bi,ut=JSON.stringify($[5].geometry.coordinates)+"",Gi,Xi,rr;function Qi(Zt,Zi){return Zt[5].properties.virtual_line?rg:ig}let Et=Qi($),ii=Et($);function ai(Zt,Zi){return Zt[5].properties.virtual_line?sg:ng}let Hi=ai($),qi=Hi($);return{c(){S=Ot("li"),re=Ot("div"),pe=Ot("div"),ue=zc("svg"),Ie=zc("g"),j=zc("path"),s=zc("path"),b=Ii(),v=Ot("span"),a=Cn("Zone identifier: "),h=Cn(l),m=Ii(),_=Ot("div"),u=Ii(),x=Ot("div"),T=Ot("div"),A=Ot("span"),A.textContent=D,V=Ii(),ii.c(),X=Ii(),ie=Ot("div"),ve=Ot("table"),Fe=Ot("thead"),Fe.innerHTML=Ye,Ze=Ii(),Je=Ot("tbody"),ct=Ot("tr"),nt=Ot("td"),nt.textContent=vt,Mt=Ii(),st=Ot("td"),ee=Cn(bt),be=Ii(),me=Ot("tr"),ge=Ot("td"),ge.textContent=je,_e=Ii(),te=Ot("td"),Ne=Cn(Pe),et=Ii(),He=Ot("tr"),Ge=Ot("td"),Ge.textContent=_t,It=Ii(),Xe=Ot("td"),Oe=Ot("div"),ot=Ii(),qe=Ot("tr"),le=Ot("td"),le.textContent=ft,Pt=Ii(),Tt=Ot("td"),lt=Cn(Nt),wt=Ii(),Yt=Ot("tr"),fi=Ot("td"),fi.textContent=mi,yi=Ii(),bi=Ot("td"),Gi=Cn(ut),Xi=Ii(),qi.c(),rr=Ii(),this.h()},l(Zt){S=Dt(Zt,"LI",{class:!0});var Zi=ti(S);re=Dt(Zi,"DIV",{class:!0});var $i=ti(re);pe=Dt($i,"DIV",{class:!0});var ae=ti(pe);ue=Fc(ae,"svg",{xmlns:!0,width:!0,height:!0,viewBox:!0});var H=ti(ue);Ie=Fc(H,"g",{fill:!0});var q=ti(Ie);j=Fc(q,"path",{d:!0,opacity:!0}),ti(j).forEach(Gt),s=Fc(q,"path",{d:!0}),ti(s).forEach(Gt),q.forEach(Gt),H.forEach(Gt),b=Pi(ae),v=Dt(ae,"SPAN",{style:!0});var Q=ti(v);a=Sn(Q,"Zone identifier: "),h=Sn(Q,l),Q.forEach(Gt),ae.forEach(Gt),m=Pi($i),_=Dt($i,"DIV",{class:!0}),ti(_).forEach(Gt),u=Pi($i),x=Dt($i,"DIV",{class:!0});var oe=ti(x);T=Dt(oe,"DIV",{});var Ae=ti(T);A=Dt(Ae,"SPAN",{"data-svelte-h":!0}),br(A)!=="svelte-epbrqr"&&(A.textContent=D),V=Pi(Ae),ii.l(Ae),Ae.forEach(Gt),oe.forEach(Gt),$i.forEach(Gt),X=Pi(Zi),ie=Dt(Zi,"DIV",{class:!0});var ke=ti(ie);ve=Dt(ke,"TABLE",{class:!0});var Le=ti(ve);Fe=Dt(Le,"THEAD",{"data-svelte-h":!0}),br(Fe)!=="svelte-12gwnin"&&(Fe.innerHTML=Ye),Ze=Pi(Le),Je=Dt(Le,"TBODY",{});var we=ti(Je);ct=Dt(we,"TR",{});var Ue=ti(ct);nt=Dt(Ue,"TD",{"data-svelte-h":!0}),br(nt)!=="svelte-t6zzid"&&(nt.textContent=vt),Mt=Pi(Ue),st=Dt(Ue,"TD",{});var pt=ti(st);ee=Sn(pt,bt),pt.forEach(Gt),Ue.forEach(Gt),be=Pi(we),me=Dt(we,"TR",{});var Qe=ti(me);ge=Dt(Qe,"TD",{"data-svelte-h":!0}),br(ge)!=="svelte-5n5jo3"&&(ge.textContent=je),_e=Pi(Qe),te=Dt(Qe,"TD",{});var at=ti(te);Ne=Sn(at,Pe),at.forEach(Gt),Qe.forEach(Gt),et=Pi(we),He=Dt(we,"TR",{});var Jt=ti(He);Ge=Dt(Jt,"TD",{"data-svelte-h":!0}),br(Ge)!=="svelte-1ghfwjz"&&(Ge.textContent=_t),It=Pi(Jt),Xe=Dt(Jt,"TD",{});var ri=ti(Xe);Oe=Dt(ri,"DIV",{style:!0}),ti(Oe).forEach(Gt),ri.forEach(Gt),Jt.forEach(Gt),ot=Pi(we),qe=Dt(we,"TR",{});var ui=ti(qe);le=Dt(ui,"TD",{"data-svelte-h":!0}),br(le)!=="svelte-n6p0xp"&&(le.textContent=ft),Pt=Pi(ui),Tt=Dt(ui,"TD",{});var pi=ti(Tt);lt=Sn(pi,Nt),pi.forEach(Gt),ui.forEach(Gt),wt=Pi(we),Yt=Dt(we,"TR",{});var wi=ti(Yt);fi=Dt(wi,"TD",{"data-svelte-h":!0}),br(fi)!=="svelte-1ypus8v"&&(fi.textContent=mi),yi=Pi(wi),bi=Dt(wi,"TD",{});var Ri=ti(bi);Gi=Sn(Ri,ut),Ri.forEach(Gt),wi.forEach(Gt),Xi=Pi(we),qi.l(we),we.forEach(Gt),Le.forEach(Gt),ke.forEach(Gt),rr=Pi(Zi),Zi.forEach(Gt),this.h()},h(){dt(j,"d","M137 65a24 24 0 1 1 0-34a24 24 0 0 1 0 34M23 103a24 24 0 1 0 34 0a24 24 0 0 0-34 0m120 88a24 24 0 1 0 34 0a24 24 0 0 0-34 0m82-136a24 24 0 1 0 0 34a24 24 0 0 0 0-34"),dt(j,"opacity","0.2"),dt(s,"d","M230.64 49.36a32 32 0 0 0-45.26 0a32 32 0 0 0-5.16 6.76L152 48.42a32 32 0 0 0-54.63-23.06a32.06 32.06 0 0 0-5.76 37.41L57.67 93.32a32.05 32.05 0 0 0-40.31 4.05a32 32 0 0 0 42.89 47.41l70 51.36a32 32 0 1 0 47.57-14.69l27.39-77.59q1.38.12 2.76.12a32 32 0 0 0 22.63-54.62Zm-122-12.69a16 16 0 1 1 0 22.64a16 16 0 0 1 .04-22.64Zm-80 94.65a16 16 0 0 1 0-22.64a16 16 0 1 1 0 22.64m142.65 88a16 16 0 0 1-22.63-22.63a16 16 0 1 1 22.63 22.63m-8.55-43.18a32 32 0 0 0-23 7.08l-70-51.36a32.17 32.17 0 0 0-1.34-26.65l33.95-30.55a32 32 0 0 0 45.47-10.81L176 71.56a32 32 0 0 0 14.12 27ZM219.3 83.3a16 16 0 1 1-22.6-22.62a16 16 0 0 1 22.63 22.63Z"),dt(Ie,"fill",p=$[5].properties.color_rgb_str),dt(ue,"xmlns","http://www.w3.org/2000/svg"),dt(ue,"width","1.6rem"),dt(ue,"height","1.6rem"),dt(ue,"viewBox","0 0 256 256"),za(v,"padding-left","0.5rem"),dt(pe,"class","collapbisle-header-zone svelte-iuhs3p"),dt(_,"class","collapbisle-header-divider svelte-iuhs3p"),dt(x,"class","collapbisle-header-zone svelte-iuhs3p"),dt(re,"class","collapsible-header collapsible-header-content svelte-iuhs3p"),za(Oe,"background-color",$[5].properties.color_rgb_str),za(Oe,"width","32px"),za(Oe,"height","16px"),za(Oe,"border","1px solid #000000"),dt(ve,"class","collapsible-table svelte-iuhs3p"),dt(ie,"class","collapsible-body svelte-iuhs3p"),dt(S,"class","svelte-iuhs3p")},m(Zt,Zi){gn(Zt,S,Zi),it(S,re),it(re,pe),it(pe,ue),it(ue,Ie),it(Ie,j),it(Ie,s),it(pe,b),it(pe,v),it(v,a),it(v,h),it(re,m),it(re,_),it(re,u),it(re,x),it(x,T),it(T,A),it(T,V),ii.m(T,null),it(S,X),it(S,ie),it(ie,ve),it(ve,Fe),it(ve,Ze),it(ve,Je),it(Je,ct),it(ct,nt),it(ct,Mt),it(ct,st),it(st,ee),it(Je,be),it(Je,me),it(me,ge),it(me,_e),it(me,te),it(te,Ne),it(Je,et),it(Je,He),it(He,Ge),it(He,It),it(He,Xe),it(Xe,Oe),it(Je,ot),it(Je,qe),it(qe,le),it(qe,Pt),it(qe,Tt),it(Tt,lt),it(Je,wt),it(Je,Yt),it(Yt,fi),it(Yt,yi),it(Yt,bi),it(bi,Gi),it(Je,Xi),qi.m(Je,null),it(S,rr)},p(Zt,Zi){Zi&4&&p!==(p=Zt[5].properties.color_rgb_str)&&dt(Ie,"fill",p),Zi&4&&l!==(l=Zt[5].id+"")&&Ws(h,l),Et===(Et=Qi(Zt))&&ii?ii.p(Zt,Zi):(ii.d(1),ii=Et(Zt),ii&&(ii.c(),ii.m(T,null))),Zi&4&&bt!==(bt=Zt[5].properties.road_lane_direction+"")&&Ws(ee,bt),Zi&4&&Pe!==(Pe=Zt[5].properties.road_lane_num+"")&&Ws(Ne,Pe),Zi&4&&za(Oe,"background-color",Zt[5].properties.color_rgb_str),Zi&4&&Nt!==(Nt=JSON.stringify(Zt[5].properties.coordinates)+"")&&Ws(lt,Nt),Zi&4&&ut!==(ut=JSON.stringify(Zt[5].geometry.coordinates)+"")&&Ws(Gi,ut),Hi===(Hi=ai(Zt))&&qi?qi.p(Zt,Zi):(qi.d(1),qi=Hi(Zt),qi&&(qi.c(),qi.m(Je,null)))},d(Zt){Zt&&Gt(S),ii.d(),qi.d()}}}function og($){let S,re,pe,ue,Ie=$[3]===!0&&Id($);return{c(){S=Ot("div"),re=Ot("div"),pe=Ot("ul"),Ie&&Ie.c(),this.h()},l(j){S=Dt(j,"DIV",{id:!0,class:!0});var s=ti(S);re=Dt(s,"DIV",{id:!0});var p=ti(re);pe=Dt(p,"UL",{id:!0,class:!0});var b=ti(pe);Ie&&Ie.l(b),b.forEach(Gt),p.forEach(Gt),s.forEach(Gt),this.h()},h(){dt(pe,"id","collapsible-data"),dt(pe,"class","collapsible svelte-iuhs3p"),dt(re,"id","configuration-content"),dt(S,"id","configuration"),dt(S,"class",ue=so($[0])+" svelte-iuhs3p")},m(j,s){gn(j,S,s),it(S,re),it(re,pe),Ie&&Ie.m(pe,null)},p(j,[s]){j[3]===!0?Ie?Ie.p(j,s):(Ie=Id(j),Ie.c(),Ie.m(pe,null)):Ie&&(Ie.d(1),Ie=null),s&1&&ue!==(ue=so(j[0])+" svelte-iuhs3p")&&dt(S,"class",ue)},i:ys,o:ys,d(j){j&&Gt(S),Ie&&Ie.d()}}}function ag($,S,re){let pe,ue=ys,Ie=()=>(ue(),ue=Hp(s,b=>re(3,pe=b)),s);$.$$.on_destroy.push(()=>ue());let{klass:j=""}=S,{dataReady:s}=S;Ie();let{data:p}=S;return $.$$set=b=>{"klass"in b&&re(0,j=b.klass),"dataReady"in b&&Ie(re(1,s=b.dataReady)),"data"in b&&re(2,p=b.data)},[j,s,p,pe]}class lg extends oa{constructor(S){super(),aa(this,S,ag,og,sa,{klass:0,dataReady:1,data:2})}}const cg=($,S)=>{const re={data:S.map(ue=>{const Ie=ue[1];return{lane_number:Ie.properties.road_lane_num,lane_direction:Ie.properties.road_lane_direction,color_rgb:Ie.properties.color_rgb,pixel_points:Ie.properties.coordinates,spatial_points:[...Ie.geometry.coordinates[0].slice(0,-1)],virtual_line:Ie.properties.virtual_line?{geometry:Ie.properties.virtual_line.geometry,color_rgb:Ie.properties.virtual_line.color_rgb,direction:Ie.properties.virtual_line.direction}:null}})};console.log("Replacing data");const pe=`${$}/api/mutations/replace_all`;fetch(`${pe}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(re)}).then(ue=>ue.json()).then(ue=>{const Ie=`${$}/api/mutations/save_toml`;console.log("Replacing configuration with polygons:",ue),fetch(`${Ie}`,{method:"GET"}).then(j=>j.json()).then(j=>{console.log("Configuration has been updated. Reply from server:",j)}).catch(j=>{console.log("Error on updating configuration:",j)})}).catch(ue=>{console.log("Error on replacing data",ue)})};function hg($){let S,re,pe,ue,Ie,j,s,p='<i class="material-icons">edit</i>',b,v,a,l,h='<i class="material-icons">add</i>',m,_,u,x='<i class="material-icons">delete</i>',T,A,D,V='<i class="material-icons">add_location</i>',X,ie,ve,Fe='<i class="material-icons">location_off</i>',Ye,Ze,Je,ct='<i class="material-icons">save</i>',nt,vt,Mt,st,bt,ee,be,me,ge,je,_e,te=($[2]!==void 0?$[2]:Rc)+"",Pe,Ne,et,He,Ge,_t,It,Xe,Oe,ot=($[2]!==void 0?$[2]:Rc)+"",qe,le,ft,Pt,Tt,Nt;vt=new tg({props:{klass:$[5]||$[4]?"blurred noselect":""}}),ee=new Xm({props:{klass:!$[5]&&$[4]?"blurred noselect":""}}),me=new lg({props:{dataReady:vl,data:$[3],klass:!$[6]||$[5]||$[4]?"blurred noselect":""}});let lt={klass:!$[6]||$[5]&&!$[4]?"blurred noselect":""};return _t=new dm({props:lt}),$[16](_t),{c(){S=Ot("sveltekit:head"),re=Ot("title"),pe=Cn(Ad),ue=Ii(),Ie=Ot("div"),j=Ot("div"),s=Ot("a"),s.innerHTML=p,b=Ii(),v=Ot("ul"),a=Ot("li"),l=Ot("a"),l.innerHTML=h,m=Ii(),_=Ot("li"),u=Ot("a"),u.innerHTML=x,T=Ii(),A=Ot("li"),D=Ot("a"),D.innerHTML=V,X=Ii(),ie=Ot("li"),ve=Ot("a"),ve.innerHTML=Fe,Ye=Ii(),Ze=Ot("li"),Je=Ot("a"),Je.innerHTML=ct,nt=Ii(),Fa(vt.$$.fragment),Mt=Ii(),st=Ot("div"),bt=Ot("div"),Fa(ee.$$.fragment),be=Ii(),Fa(me.$$.fragment),ge=Ii(),je=Ot("div"),_e=Cn("Press ESC to cancel '"),Pe=Cn(te),Ne=Cn("' mode"),He=Ii(),Ge=Ot("div"),Fa(_t.$$.fragment),It=Ii(),Xe=Ot("div"),Oe=Cn("Press ESC to cancel '"),qe=Cn(ot),le=Cn("' mode"),this.h()},l(wt){S=Dt(wt,"SVELTEKIT:HEAD",{});var Yt=ti(S);re=Dt(Yt,"TITLE",{});var fi=ti(re);pe=Sn(fi,Ad),fi.forEach(Gt),Yt.forEach(Gt),ue=Pi(wt),Ie=Dt(wt,"DIV",{id:!0});var mi=ti(Ie);j=Dt(mi,"DIV",{class:!0});var yi=ti(j);s=Dt(yi,"A",{class:!0,"data-svelte-h":!0}),br(s)!=="svelte-1f8sujf"&&(s.innerHTML=p),b=Pi(yi),v=Dt(yi,"UL",{});var bi=ti(v);a=Dt(bi,"LI",{});var ut=ti(a);l=Dt(ut,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),br(l)!=="svelte-1iozari"&&(l.innerHTML=h),ut.forEach(Gt),m=Pi(bi),_=Dt(bi,"LI",{});var Gi=ti(_);u=Dt(Gi,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),br(u)!=="svelte-1wbicqg"&&(u.innerHTML=x),Gi.forEach(Gt),T=Pi(bi),A=Dt(bi,"LI",{});var Xi=ti(A);D=Dt(Xi,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),br(D)!=="svelte-1t3kq67"&&(D.innerHTML=V),Xi.forEach(Gt),X=Pi(bi),ie=Dt(bi,"LI",{});var rr=ti(ie);ve=Dt(rr,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),br(ve)!=="svelte-1in2wxm"&&(ve.innerHTML=Fe),rr.forEach(Gt),Ye=Pi(bi),Ze=Dt(bi,"LI",{});var Qi=ti(Ze);Je=Dt(Qi,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),br(Je)!=="svelte-93o42s"&&(Je.innerHTML=ct),Qi.forEach(Gt),bi.forEach(Gt),yi.forEach(Gt),nt=Pi(mi),Ra(vt.$$.fragment,mi),Mt=Pi(mi),st=Dt(mi,"DIV",{id:!0});var Et=ti(st);bt=Dt(Et,"DIV",{id:!0});var ii=ti(bt);Ra(ee.$$.fragment,ii),be=Pi(ii),Ra(me.$$.fragment,ii),ge=Pi(ii),je=Dt(ii,"DIV",{class:!0,style:!0});var ai=ti(je);_e=Sn(ai,"Press ESC to cancel '"),Pe=Sn(ai,te),Ne=Sn(ai,"' mode"),ai.forEach(Gt),ii.forEach(Gt),He=Pi(Et),Ge=Dt(Et,"DIV",{id:!0});var Hi=ti(Ge);Ra(_t.$$.fragment,Hi),It=Pi(Hi),Xe=Dt(Hi,"DIV",{class:!0,style:!0});var qi=ti(Xe);Oe=Sn(qi,"Press ESC to cancel '"),qe=Sn(qi,ot),le=Sn(qi,"' mode"),qi.forEach(Gt),Hi.forEach(Gt),Et.forEach(Gt),mi.forEach(Gt),this.h()},h(){dt(s,"class","btn-floating btn-large red"),dt(l,"id","add-btn"),dt(l,"class","btn-floating green"),dt(l,"title","Add zone to the canvas"),dt(l,"aria-label","Add zone to the canvas"),dt(l,"role","button"),dt(l,"tabindex","0"),dt(u,"id","del-btn"),dt(u,"class","btn-floating blue"),dt(u,"title","Delete zone from the canvas"),dt(u,"aria-label","Delete zone from the canvas"),dt(u,"role","button"),dt(u,"tabindex","0"),dt(D,"id","add-btn"),dt(D,"class","btn-floating orange"),dt(D,"title","Add zone to the map"),dt(D,"aria-label","Add zone to the map"),dt(D,"role","button"),dt(D,"tabindex","0"),dt(ve,"id","del-btn"),dt(ve,"class","btn-floating blue"),dt(ve,"title","Delete zone from the map"),dt(ve,"aria-label","Delete zone from the map"),dt(ve,"role","button"),dt(ve,"tabindex","0"),dt(Je,"id","save-btn"),dt(Je,"class","btn-floating grey"),dt(Je,"title","Apply and save changes"),dt(Je,"aria-label","Apply and save changes"),dt(Je,"role","button"),dt(Je,"tabindex","0"),dt(j,"class","fixed-action-btn horizontal click-to-toggle spin-close"),dt(je,"class","overlay"),dt(je,"style",et=!$[5]&&$[4]?"display: block;":"display: none;"),dt(bt,"id","left_workspace"),dt(Xe,"class","overlay"),dt(Xe,"style",ft=$[5]&&!$[4]?"display: block;":"display: none;"),dt(Ge,"id","right_workspace"),dt(st,"id","main_workspace"),dt(Ie,"id","main-app")},m(wt,Yt){gn(wt,S,Yt),it(S,re),it(re,pe),gn(wt,ue,Yt),gn(wt,Ie,Yt),it(Ie,j),it(j,s),it(j,b),it(j,v),it(v,a),it(a,l),it(v,m),it(v,_),it(_,u),it(v,T),it(v,A),it(A,D),it(v,X),it(v,ie),it(ie,ve),it(v,Ye),it(v,Ze),it(Ze,Je),it(Ie,nt),Ba(vt,Ie,null),it(Ie,Mt),it(Ie,st),it(st,bt),Ba(ee,bt,null),it(bt,be),Ba(me,bt,null),it(bt,ge),it(bt,je),it(je,_e),it(je,Pe),it(je,Ne),it(st,He),it(st,Ge),Ba(_t,Ge,null),it(Ge,It),it(Ge,Xe),it(Xe,Oe),it(Xe,qe),it(Xe,le),Pt=!0,Tt||(Nt=[_s(window,"keydown",$[8]),_s(l,"click",$[9]),_s(u,"click",$[11]),_s(D,"click",$[10]),_s(ve,"click",$[12]),_s(Je,"click",$[15])],Tt=!0)},p(wt,[Yt]){const fi={};Yt&48&&(fi.klass=wt[5]||wt[4]?"blurred noselect":""),vt.$set(fi);const mi={};Yt&48&&(mi.klass=!wt[5]&&wt[4]?"blurred noselect":""),ee.$set(mi);const yi={};Yt&8&&(yi.data=wt[3]),Yt&112&&(yi.klass=!wt[6]||wt[5]||wt[4]?"blurred noselect":""),me.$set(yi),(!Pt||Yt&4)&&te!==(te=(wt[2]!==void 0?wt[2]:Rc)+"")&&Ws(Pe,te),(!Pt||Yt&48&&et!==(et=!wt[5]&&wt[4]?"display: block;":"display: none;"))&&dt(je,"style",et);const bi={};Yt&112&&(bi.klass=!wt[6]||wt[5]&&!wt[4]?"blurred noselect":""),_t.$set(bi),(!Pt||Yt&4)&&ot!==(ot=(wt[2]!==void 0?wt[2]:Rc)+"")&&Ws(qe,ot),(!Pt||Yt&48&&ft!==(ft=wt[5]&&!wt[4]?"display: block;":"display: none;"))&&dt(Xe,"style",ft)},i(wt){Pt||(ja(vt.$$.fragment,wt),ja(ee.$$.fragment,wt),ja(me.$$.fragment,wt),ja(_t.$$.fragment,wt),Pt=!0)},o(wt){Na(vt.$$.fragment,wt),Na(ee.$$.fragment,wt),Na(me.$$.fragment,wt),Na(_t.$$.fragment,wt),Pt=!1},d(wt){wt&&(Gt(S),Gt(ue),Gt(Ie)),Va(vt),Va(ee),Va(me),$[16](null),Va(_t),Tt=!1,Lh(Nt)}}}const Ad="Rust Road Traffic UI",Rc="Unexpected action";function ug($,S,re){let pe,ue,Ie,j,s,p,b,v,a,l,h,m;Nr($,Fh,st=>re(21,s=st)),Nr($,jc,st=>re(22,p=st)),Nr($,ao,st=>re(13,b=st)),Nr($,Oh,st=>re(23,v=st)),Nr($,xl,st=>re(6,l=st)),Nr($,vl,st=>re(25,h=st)),Nr($,tn,st=>re(14,m=st));const{apiURL:_}=Nc;Nr($,_,st=>re(24,a=st));let u=a,x;tn.subscribe(st=>x=st);let T,A,D;const V=new Map([[Ui.AddingZoneCanvas,"Adding zone to the canvas"],[Ui.DeletingZoneCanvas,"Deleting zone from the canvas"],[Ui.AddingZoneMap,"Adding zone to the map"],[Ui.DeletingZoneMap,"Deleting zone from the map"]]),X=st=>{A=xl.subscribe(ee=>{ee===!0&&h==!0&&(console.log(`MJPEG is loaded after geo data: ${st}`),Td(p,tn,ao,Ua))}),D=vl.subscribe(ee=>{ee===!0&&l==!0&&(console.log(`MJPEG is loaded before geo data: '${st}'`),Td(p,tn,ao,Ua))});const bt=`${u}/api/polygons/geojson`;fetch(`${bt}`).then(ee=>ee.json()).then(ee=>{ee.features.forEach(be=>{sm(be)}),st===Bc.ReInit?T.drawGeoPolygons(s,b):v.on("load",()=>{T.drawGeoPolygons(s,b)}),vl.set(!0)}).catch(ee=>{console.log(`Error on loading polygons ['${st}']`,ee)})},ie=jh.subscribe(st=>{u!==st&&(console.log(`Need to change API URL for Data: '${a}'`),re(0,u=st),xl.set(!1),vl.set(!1),A(),D(),am(),p!==void 0&&p!=null&&p.getObjects().forEach(bt=>{p.remove(bt)}),s.deleteAll(),X(Bc.ReInit))});sc(()=>{console.log("Mounted page"),Fe(),X(Bc.Init),Rd.onClick=(st,bt)=>{var ee;if(bt.featureTarget&&x===Ui.DeletingZoneMap){const me=bt.featureTarget.properties.id;tn.set(Ui.Waiting);let ge=(ee=[...b].find(je=>je[1].properties.spatial_object_id===me))==null?void 0:ee[1];if(!ge){console.warn(`Spatial ID '${me}' not found in datastorage. Just removing from the spatial map...`),s.delete(me),s.changeMode("simple_select");return}Nd(b,ge.id),s.delete(me),s.changeMode("simple_select")}},T.attachDraw(s),v.on("draw.create",function(st){st.features[0].properties={color_rgb_str:nc},s.add(st.features[0]),tn.set(Ui.Waiting)}),v.on("draw.update",function(st){var ge;const bt=st.features[0],ee=bt.id;let be=(ge=[...b].find(je=>je[1].properties.spatial_object_id===ee))==null?void 0:ge[1];if(!be){console.warn(`Spatial ID '${ee}' not found in datastorage. Ignoring...`);return}const me=bt.geometry;be.geometry.coordinates=me.coordinates,Ua(be.id,be)})}),Dh(()=>{console.log("Destroyed"),xl.set(!1),vl.set(!1),A(),D(),ie()});function ve(st){st.key==="Escape"&&(Ye(p),s.changeMode("simple_select"),tn.set(Ui.Waiting))}const Fe=()=>{const st=document.querySelectorAll(".fixed-action-btn");M.FloatingActionButton.init(st,{direction:"left",hoverEnabled:!1});const bt=document.getElementById("collapsible-data");M.Collapsible.init(bt,{})},Ye=st=>{st.contourTemporary.forEach(bt=>{st.remove(bt)}),st.contourNotationTemporary.forEach(bt=>{st.remove(bt)}),st.contourTemporary=[],st.contourNotationTemporary=[],st.contourFinalized=[]},Ze=()=>{x!==Ui.AddingZoneCanvas?(tn.set(Ui.AddingZoneCanvas),s.changeMode("draw_restricted_polygon")):(tn.set(Ui.Waiting),s.changeMode("simple_select"))},Je=()=>{x!==Ui.AddingZoneMap?(tn.set(Ui.AddingZoneMap),s.changeMode("draw_restricted_polygon")):(tn.set(Ui.Waiting),s.changeMode("simple_select"))},ct=()=>{x!==Ui.DeletingZoneCanvas?tn.set(Ui.DeletingZoneCanvas):tn.set(Ui.Waiting)},nt=()=>{x!==Ui.DeletingZoneMap?(tn.set(Ui.DeletingZoneMap),s.changeMode("delete_zone")):(tn.set(Ui.Waiting),s.changeMode("simple_select"))},vt=()=>cg(u,Ie);function Mt(st){Md[st?"unshift":"push"](()=>{T=st,re(1,T)})}return $.$$.update=()=>{$.$$.dirty&16384&&re(5,pe=m===Ui.AddingZoneCanvas||m===Ui.DeletingZoneCanvas),$.$$.dirty&16384&&re(4,ue=m===Ui.AddingZoneMap||m===Ui.DeletingZoneMap),$.$$.dirty&8192&&re(3,Ie=[...b].filter(st=>st[1].id&&st[1].properties.spatial_object_id)),$.$$.dirty&16384&&re(2,j=V.get(m))},[u,T,j,Ie,ue,pe,l,_,ve,Ze,Je,ct,nt,b,m,vt,Mt]}class yg extends oa{constructor(S){super(),aa(this,S,ug,hg,sa,{})}}export{yg as component,_g as universal};
