var vm=Object.defineProperty;var xm=(Z,S,st)=>S in Z?vm(Z,S,{enumerable:!0,configurable:!0,writable:!0,value:st}):Z[S]=st;var An=(Z,S,st)=>xm(Z,typeof S!="symbol"?S+"":S,st);import{s as pa,n as cs,c as Nr,o as mc,y as Qh,d as of,z as Tl,A as Hd,B as ao,r as tu,a as bm}from"../chunks/scheduler.D-x6b7vF.js";import{S as ma,i as ga,e as Ae,c as Me,a as ni,d as Re,o as fe,g as dn,h as re,t as xn,s as Ai,b as bn,f as Mi,y as Sr,j as Bs,u as Ga,v as Xa,w as Wa,z as ls,n as Ha,l as qa,x as $a,A as fa,B as af,k as qd,C as wm,D as Zc,E as Kc,p as Ua}from"../chunks/index.DO0EHsye.js";import{c as bl,g as lf,a as Cm}from"../chunks/_commonjsHelpers.BosuxZz1.js";import{w as Bn,d as Sm}from"../chunks/index.DZQZCYML.js";function $d(Z){return(Z==null?void 0:Z.length)!==void 0?Z:Array.from(Z)}const Tm=!1,$g=Object.freeze(Object.defineProperty({__proto__:null,ssr:Tm},Symbol.toStringTag,{value:"Module"}));var cf={exports:{}};/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v4.5.2/LICENSE.txt
 */(function(Z,S){(function(st,ft){Z.exports=ft()})(bl,function(){var st={},ft={};function lt(N,s,p){if(ft[N]=p,N==="index"){var C="var sharedModule = {}; ("+ft.shared+")(sharedModule); ("+ft.worker+")(sharedModule);",b={};return ft.shared(b),ft.index(st,b),typeof window<"u"&&st.setWorkerUrl(window.URL.createObjectURL(new Blob([C],{type:"text/javascript"}))),st}}lt("shared",["exports"],function(N){function s(i,t,r,o){return new(r||(r=Promise))(function(f,v){function x(D){try{A(o.next(D))}catch(B){v(B)}}function T(D){try{A(o.throw(D))}catch(B){v(B)}}function A(D){var B;D.done?f(D.value):(B=D.value,B instanceof r?B:new r(function(j){j(B)})).then(x,T)}A((o=o.apply(i,t||[])).next())})}function p(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}typeof SuppressedError=="function"&&SuppressedError;var C=b;function b(i,t){this.x=i,this.y=t}b.prototype={clone:function(){return new b(this.x,this.y)},add:function(i){return this.clone()._add(i)},sub:function(i){return this.clone()._sub(i)},multByPoint:function(i){return this.clone()._multByPoint(i)},divByPoint:function(i){return this.clone()._divByPoint(i)},mult:function(i){return this.clone()._mult(i)},div:function(i){return this.clone()._div(i)},rotate:function(i){return this.clone()._rotate(i)},rotateAround:function(i,t){return this.clone()._rotateAround(i,t)},matMult:function(i){return this.clone()._matMult(i)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(i){return this.x===i.x&&this.y===i.y},dist:function(i){return Math.sqrt(this.distSqr(i))},distSqr:function(i){var t=i.x-this.x,r=i.y-this.y;return t*t+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(i){return Math.atan2(this.y-i.y,this.x-i.x)},angleWith:function(i){return this.angleWithSep(i.x,i.y)},angleWithSep:function(i,t){return Math.atan2(this.x*t-this.y*i,this.x*i+this.y*t)},_matMult:function(i){var t=i[2]*this.x+i[3]*this.y;return this.x=i[0]*this.x+i[1]*this.y,this.y=t,this},_add:function(i){return this.x+=i.x,this.y+=i.y,this},_sub:function(i){return this.x-=i.x,this.y-=i.y,this},_mult:function(i){return this.x*=i,this.y*=i,this},_div:function(i){return this.x/=i,this.y/=i,this},_multByPoint:function(i){return this.x*=i.x,this.y*=i.y,this},_divByPoint:function(i){return this.x/=i.x,this.y/=i.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var i=this.y;return this.y=this.x,this.x=-i,this},_rotate:function(i){var t=Math.cos(i),r=Math.sin(i),o=r*this.x+t*this.y;return this.x=t*this.x-r*this.y,this.y=o,this},_rotateAround:function(i,t){var r=Math.cos(i),o=Math.sin(i),f=t.y+o*(this.x-t.x)+r*(this.y-t.y);return this.x=t.x+r*(this.x-t.x)-o*(this.y-t.y),this.y=f,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},b.convert=function(i){return i instanceof b?i:Array.isArray(i)?new b(i[0],i[1]):i};var l=p(C),c=h;function h(i,t,r,o){this.cx=3*i,this.bx=3*(r-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(o-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=t,this.p2x=r,this.p2y=o}h.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,t){if(t===void 0&&(t=1e-6),i<0)return 0;if(i>1)return 1;for(var r=i,o=0;o<8;o++){var f=this.sampleCurveX(r)-i;if(Math.abs(f)<t)return r;var v=this.sampleCurveDerivativeX(r);if(Math.abs(v)<1e-6)break;r-=f/v}var x=0,T=1;for(r=i,o=0;o<20&&(f=this.sampleCurveX(r),!(Math.abs(f-i)<t));o++)i>f?x=r:T=r,r=.5*(T-x)+x;return r},solve:function(i,t){return this.sampleCurveY(this.solveCurveX(i,t))}};var m=p(c);let g,d;function w(){return g==null&&(g=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),g}function E(){if(d==null&&(d=!1,w())){const t=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(t){for(let o=0;o<5*5;o++){const f=4*o;t.fillStyle=`rgb(${f},${f+1},${f+2})`,t.fillRect(o%5,Math.floor(o/5),1,1)}const r=t.getImageData(0,0,5,5).data;for(let o=0;o<5*5*4;o++)if(o%4!=3&&r[o]!==o){d=!0;break}}}return d||!1}function O(i,t,r,o){const f=new m(i,t,r,o);return v=>f.solve(v)}const L=O(.25,.1,.25,1);function U(i,t,r){return Math.min(r,Math.max(t,i))}function $(i,t,r){const o=r-t,f=((i-t)%o+o)%o+t;return f===t?r:f}function nt(i,...t){for(const r of t)for(const o in r)i[o]=r[o];return i}let xt=1;function Ft(i,t,r){const o={};for(const f in i)o[f]=t.call(this,i[f],f,i);return o}function Kt(i,t,r){const o={};for(const f in i)t.call(this,i[f],f,i)&&(o[f]=i[f]);return o}function Jt(i){return Array.isArray(i)?i.map(Jt):typeof i=="object"&&i?Ft(i,Jt):i}const Qt={};function he(i){Qt[i]||(typeof console<"u"&&console.warn(i),Qt[i]=!0)}function ne(i,t,r){return(r.y-i.y)*(t.x-i.x)>(t.y-i.y)*(r.x-i.x)}function me(i){return typeof WorkerGlobalScope<"u"&&i!==void 0&&i instanceof WorkerGlobalScope}let Oe=null;function se(i){return typeof ImageBitmap<"u"&&i instanceof ImageBitmap}const be="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function Q(i,t,r,o,f){return s(this,void 0,void 0,function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const v=new VideoFrame(i,{timestamp:0});try{const x=v==null?void 0:v.format;if(!x||!x.startsWith("BGR")&&!x.startsWith("RGB"))throw new Error(`Unrecognized format ${x}`);const T=x.startsWith("BGR"),A=new Uint8ClampedArray(o*f*4);if(yield v.copyTo(A,function(D,B,j,X,q){const J=4*Math.max(-B,0),it=(Math.max(0,j)-j)*X*4+J,dt=4*X,Ct=Math.max(0,B),Gt=Math.max(0,j);return{rect:{x:Ct,y:Gt,width:Math.min(D.width,B+X)-Ct,height:Math.min(D.height,j+q)-Gt},layout:[{offset:it,stride:dt}]}}(i,t,r,o,f)),T)for(let D=0;D<A.length;D+=4){const B=A[D];A[D]=A[D+2],A[D+2]=B}return A}finally{v.close()}})}let wt,gt;const vt="AbortError";function Vt(){return new Error(vt)}const pt={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function rt(i){return pt.REGISTERED_PROTOCOLS[i.substring(0,i.indexOf("://"))]}const Mt="global-dispatcher";class jt extends Error{constructor(t,r,o,f){super(`AJAXError: ${r} (${t}): ${o}`),this.status=t,this.statusText=r,this.url=o,this.body=f}}const te=()=>me(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,Wt=function(i,t){if(/:\/\//.test(i.url)&&!/^https?:|^file:/.test(i.url)){const o=rt(i.url);if(o)return o(i,t);if(me(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:i,targetMapId:Mt},t)}if(!(/^file:/.test(r=i.url)||/^file:/.test(te())&&!/^\w+:/.test(r))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(o,f){return s(this,void 0,void 0,function*(){const v=new Request(o.url,{method:o.method||"GET",body:o.body,credentials:o.credentials,headers:o.headers,cache:o.cache,referrer:te(),signal:f.signal});o.type!=="json"||v.headers.has("Accept")||v.headers.set("Accept","application/json");const x=yield fetch(v);if(!x.ok){const D=yield x.blob();throw new jt(x.status,x.statusText,o.url,D)}let T;T=o.type==="arrayBuffer"||o.type==="image"?x.arrayBuffer():o.type==="json"?x.json():x.text();const A=yield T;if(f.signal.aborted)throw Vt();return{data:A,cacheControl:x.headers.get("Cache-Control"),expires:x.headers.get("Expires")}})}(i,t);if(me(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:i,mustQueue:!0,targetMapId:Mt},t)}var r;return function(o,f){return new Promise((v,x)=>{var T;const A=new XMLHttpRequest;A.open(o.method||"GET",o.url,!0),o.type!=="arrayBuffer"&&o.type!=="image"||(A.responseType="arraybuffer");for(const D in o.headers)A.setRequestHeader(D,o.headers[D]);o.type==="json"&&(A.responseType="text",!((T=o.headers)===null||T===void 0)&&T.Accept||A.setRequestHeader("Accept","application/json")),A.withCredentials=o.credentials==="include",A.onerror=()=>{x(new Error(A.statusText))},A.onload=()=>{if(!f.signal.aborted)if((A.status>=200&&A.status<300||A.status===0)&&A.response!==null){let D=A.response;if(o.type==="json")try{D=JSON.parse(A.response)}catch(B){return void x(B)}v({data:D,cacheControl:A.getResponseHeader("Cache-Control"),expires:A.getResponseHeader("Expires")})}else{const D=new Blob([A.response],{type:A.getResponseHeader("Content-Type")});x(new jt(A.status,A.statusText,o.url,D))}},f.signal.addEventListener("abort",()=>{A.abort(),x(Vt())}),A.send(o.body)})}(i,t)};function Xt(i){if(!i||i.indexOf("://")<=0||i.indexOf("data:image/")===0||i.indexOf("blob:")===0)return!0;const t=new URL(i),r=window.location;return t.protocol===r.protocol&&t.host===r.host}function ye(i,t,r){r[i]&&r[i].indexOf(t)!==-1||(r[i]=r[i]||[],r[i].push(t))}function Te(i,t,r){if(r&&r[i]){const o=r[i].indexOf(t);o!==-1&&r[i].splice(o,1)}}class qt{constructor(t,r={}){nt(this,r),this.type=t}}class Lt extends qt{constructor(t,r={}){super("error",nt({error:t},r))}}class ae{on(t,r){return this._listeners=this._listeners||{},ye(t,r,this._listeners),this}off(t,r){return Te(t,r,this._listeners),Te(t,r,this._oneTimeListeners),this}once(t,r){return r?(this._oneTimeListeners=this._oneTimeListeners||{},ye(t,r,this._oneTimeListeners),this):new Promise(o=>this.once(t,o))}fire(t,r){typeof t=="string"&&(t=new qt(t,r||{}));const o=t.type;if(this.listens(o)){t.target=this;const f=this._listeners&&this._listeners[o]?this._listeners[o].slice():[];for(const T of f)T.call(this,t);const v=this._oneTimeListeners&&this._oneTimeListeners[o]?this._oneTimeListeners[o].slice():[];for(const T of v)Te(o,T,this._oneTimeListeners),T.call(this,t);const x=this._eventedParent;x&&(nt(t,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),x.fire(t))}else t instanceof Lt&&console.error(t.error);return this}listens(t){return this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t)}setEventedParent(t,r){return this._eventedParent=t,this._eventedParentData=r,this}}var at={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"enum",default:"mercator",values:{mercator:{},globe:{}}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const Zt=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function pe(i,t){const r={};for(const o in i)o!=="ref"&&(r[o]=i[o]);return Zt.forEach(o=>{o in t&&(r[o]=t[o])}),r}function ue(i,t){if(Array.isArray(i)){if(!Array.isArray(t)||i.length!==t.length)return!1;for(let r=0;r<i.length;r++)if(!ue(i[r],t[r]))return!1;return!0}if(typeof i=="object"&&i!==null&&t!==null){if(typeof t!="object"||Object.keys(i).length!==Object.keys(t).length)return!1;for(const r in i)if(!ue(i[r],t[r]))return!1;return!0}return i===t}function Fe(i,t){i.push(t)}function Ke(i,t,r){Fe(r,{command:"addSource",args:[i,t[i]]})}function oe(i,t,r){Fe(t,{command:"removeSource",args:[i]}),r[i]=!0}function ve(i,t,r,o){oe(i,r,o),Ke(i,t,r)}function He(i,t,r){let o;for(o in i[r])if(Object.prototype.hasOwnProperty.call(i[r],o)&&o!=="data"&&!ue(i[r][o],t[r][o]))return!1;for(o in t[r])if(Object.prototype.hasOwnProperty.call(t[r],o)&&o!=="data"&&!ue(i[r][o],t[r][o]))return!1;return!0}function ci(i,t,r,o,f,v){i=i||{},t=t||{};for(const x in i)Object.prototype.hasOwnProperty.call(i,x)&&(ue(i[x],t[x])||r.push({command:v,args:[o,x,t[x],f]}));for(const x in t)Object.prototype.hasOwnProperty.call(t,x)&&!Object.prototype.hasOwnProperty.call(i,x)&&(ue(i[x],t[x])||r.push({command:v,args:[o,x,t[x],f]}))}function wi(i){return i.id}function vi(i,t){return i[t.id]=t,i}class ce{constructor(t,r,o,f){this.message=(t?`${t}: `:"")+o,f&&(this.identifier=f),r!=null&&r.__line__&&(this.line=r.__line__)}}function Ti(i,...t){for(const r of t)for(const o in r)i[o]=r[o];return i}class zi extends Error{constructor(t,r){super(r),this.message=r,this.key=t}}class nr{constructor(t,r=[]){this.parent=t,this.bindings={};for(const[o,f]of r)this.bindings[o]=f}concat(t){return new nr(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}const Yi={kind:"null"},Ee={kind:"number"},ui={kind:"string"},$e={kind:"boolean"},Zi={kind:"color"},Tr={kind:"object"},ii={kind:"value"},Oi={kind:"collator"},Wi={kind:"formatted"},Rr={kind:"padding"},cr={kind:"resolvedImage"},_t={kind:"variableAnchorOffsetCollection"};function W(i,t){return{kind:"array",itemType:i,N:t}}function H(i){if(i.kind==="array"){const t=H(i.itemType);return typeof i.N=="number"?`array<${t}, ${i.N}>`:i.itemType.kind==="value"?"array":`array<${t}>`}return i.kind}const et=[Yi,Ee,ui,$e,Zi,Wi,Tr,W(ii),Rr,cr,_t];function ct(i,t){if(t.kind==="error")return null;if(i.kind==="array"){if(t.kind==="array"&&(t.N===0&&t.itemType.kind==="value"||!ct(i.itemType,t.itemType))&&(typeof i.N!="number"||i.N===t.N))return null}else{if(i.kind===t.kind)return null;if(i.kind==="value"){for(const r of et)if(!ct(r,t))return null}}return`Expected ${H(i)} but found ${H(t)} instead.`}function Et(i,t){return t.some(r=>r.kind===i.kind)}function Ot(i,t){return t.some(r=>r==="null"?i===null:r==="array"?Array.isArray(i):r==="object"?i&&!Array.isArray(i)&&typeof i=="object":r===typeof i)}function zt(i,t){return i.kind==="array"&&t.kind==="array"?i.itemType.kind===t.itemType.kind&&typeof i.N=="number":i.kind===t.kind}const St=.96422,ee=.82521,le=4/29,Yt=6/29,Pe=3*Yt*Yt,Qe=Yt*Yt*Yt,ei=Math.PI/180,_i=180/Math.PI;function Ei(i){return(i%=360)<0&&(i+=360),i}function gi([i,t,r,o]){let f,v;const x=xr((.2225045*(i=tr(i))+.7168786*(t=tr(t))+.0606169*(r=tr(r)))/1);i===t&&t===r?f=v=x:(f=xr((.4360747*i+.3850649*t+.1430804*r)/St),v=xr((.0139322*i+.0971045*t+.7141733*r)/ee));const T=116*x-16;return[T<0?0:T,500*(f-x),200*(x-v),o]}function tr(i){return i<=.04045?i/12.92:Math.pow((i+.055)/1.055,2.4)}function xr(i){return i>Qe?Math.pow(i,1/3):i/Pe+le}function Fi([i,t,r,o]){let f=(i+16)/116,v=isNaN(t)?f:f+t/500,x=isNaN(r)?f:f-r/200;return f=1*Hi(f),v=St*Hi(v),x=ee*Hi(x),[ki(3.1338561*v-1.6168667*f-.4906146*x),ki(-.9787684*v+1.9161415*f+.033454*x),ki(.0719453*v-.2289914*f+1.4052427*x),o]}function ki(i){return(i=i<=.00304?12.92*i:1.055*Math.pow(i,1/2.4)-.055)<0?0:i>1?1:i}function Hi(i){return i>Yt?i*i*i:Pe*(i-le)}function hr(i){return parseInt(i.padEnd(2,i),16)/255}function Ar(i,t){return Wr(t?i/100:i,0,1)}function Wr(i,t,r){return Math.min(Math.max(t,i),r)}function Br(i){return!i.some(Number.isNaN)}const uo={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};class Ri{constructor(t,r,o,f=1,v=!0){this.r=t,this.g=r,this.b=o,this.a=f,v||(this.r*=f,this.g*=f,this.b*=f,f||this.overwriteGetter("rgb",[t,r,o,f]))}static parse(t){if(t instanceof Ri)return t;if(typeof t!="string")return;const r=function(o){if((o=o.toLowerCase().trim())==="transparent")return[0,0,0,0];const f=uo[o];if(f){const[x,T,A]=f;return[x/255,T/255,A/255,1]}if(o.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(o)){const x=o.length<6?1:2;let T=1;return[hr(o.slice(T,T+=x)),hr(o.slice(T,T+=x)),hr(o.slice(T,T+=x)),hr(o.slice(T,T+x)||"ff")]}if(o.startsWith("rgb")){const x=o.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(x){const[T,A,D,B,j,X,q,J,it,dt,Ct,Gt]=x,At=[B||" ",q||" ",dt].join("");if(At==="  "||At==="  /"||At===",,"||At===",,,"){const Nt=[D,X,it].join(""),ie=Nt==="%%%"?100:Nt===""?255:0;if(ie){const we=[Wr(+A/ie,0,1),Wr(+j/ie,0,1),Wr(+J/ie,0,1),Ct?Ar(+Ct,Gt):1];if(Br(we))return we}}return}}const v=o.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(v){const[x,T,A,D,B,j,X,q,J]=v,it=[A||" ",B||" ",X].join("");if(it==="  "||it==="  /"||it===",,"||it===",,,"){const dt=[+T,Wr(+D,0,100),Wr(+j,0,100),q?Ar(+q,J):1];if(Br(dt))return function([Ct,Gt,At,Nt]){function ie(we){const We=(we+Ct/30)%12,fi=Gt*Math.min(At,1-At);return At-fi*Math.max(-1,Math.min(We-3,9-We,1))}return Ct=Ei(Ct),Gt/=100,At/=100,[ie(0),ie(8),ie(4),Nt]}(dt)}}}(t);return r?new Ri(...r,!1):void 0}get rgb(){const{r:t,g:r,b:o,a:f}=this,v=f||1/0;return this.overwriteGetter("rgb",[t/v,r/v,o/v,f])}get hcl(){return this.overwriteGetter("hcl",function(t){const[r,o,f,v]=gi(t),x=Math.sqrt(o*o+f*f);return[Math.round(1e4*x)?Ei(Math.atan2(f,o)*_i):NaN,x,r,v]}(this.rgb))}get lab(){return this.overwriteGetter("lab",gi(this.rgb))}overwriteGetter(t,r){return Object.defineProperty(this,t,{value:r}),r}toString(){const[t,r,o,f]=this.rgb;return`rgba(${[t,r,o].map(v=>Math.round(255*v)).join(",")},${f})`}}Ri.black=new Ri(0,0,0,1),Ri.white=new Ri(1,1,1,1),Ri.transparent=new Ri(0,0,0,0),Ri.red=new Ri(1,0,0,1);class fo{constructor(t,r,o){this.sensitivity=t?r?"variant":"case":r?"accent":"base",this.locale=o,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,r){return this.collator.compare(t,r)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class po{constructor(t,r,o,f,v){this.text=t,this.image=r,this.scale=o,this.fontStack=f,this.textColor=v}}class Xi{constructor(t){this.sections=t}static fromString(t){return new Xi([new po(t,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(t=>t.text.length!==0||t.image&&t.image.name.length!==0)}static factory(t){return t instanceof Xi?t:Xi.fromString(t)}toString(){return this.sections.length===0?"":this.sections.map(t=>t.text).join("")}}class tn{constructor(t){this.values=t.slice()}static parse(t){if(t instanceof tn)return t;if(typeof t=="number")return new tn([t,t,t,t]);if(Array.isArray(t)&&!(t.length<1||t.length>4)){for(const r of t)if(typeof r!="number")return;switch(t.length){case 1:t=[t[0],t[0],t[0],t[0]];break;case 2:t=[t[0],t[1],t[0],t[1]];break;case 3:t=[t[0],t[1],t[2],t[1]]}return new tn(t)}}toString(){return JSON.stringify(this.values)}}const Za=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class Mr{constructor(t){this.values=t.slice()}static parse(t){if(t instanceof Mr)return t;if(Array.isArray(t)&&!(t.length<1)&&t.length%2==0){for(let r=0;r<t.length;r+=2){const o=t[r],f=t[r+1];if(typeof o!="string"||!Za.has(o)||!Array.isArray(f)||f.length!==2||typeof f[0]!="number"||typeof f[1]!="number")return}return new Mr(t)}}toString(){return JSON.stringify(this.values)}}class ur{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new ur({name:t,available:!1}):null}}function Cs(i,t,r,o){return typeof i=="number"&&i>=0&&i<=255&&typeof t=="number"&&t>=0&&t<=255&&typeof r=="number"&&r>=0&&r<=255?o===void 0||typeof o=="number"&&o>=0&&o<=1?null:`Invalid rgba value [${[i,t,r,o].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof o=="number"?[i,t,r,o]:[i,t,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Mn(i){if(i===null||typeof i=="string"||typeof i=="boolean"||typeof i=="number"||i instanceof Ri||i instanceof fo||i instanceof Xi||i instanceof tn||i instanceof Mr||i instanceof ur)return!0;if(Array.isArray(i)){for(const t of i)if(!Mn(t))return!1;return!0}if(typeof i=="object"){for(const t in i)if(!Mn(i[t]))return!1;return!0}return!1}function sr(i){if(i===null)return Yi;if(typeof i=="string")return ui;if(typeof i=="boolean")return $e;if(typeof i=="number")return Ee;if(i instanceof Ri)return Zi;if(i instanceof fo)return Oi;if(i instanceof Xi)return Wi;if(i instanceof tn)return Rr;if(i instanceof Mr)return _t;if(i instanceof ur)return cr;if(Array.isArray(i)){const t=i.length;let r;for(const o of i){const f=sr(o);if(r){if(r===f)continue;r=ii;break}r=f}return W(r||ii,t)}return Tr}function jn(i){const t=typeof i;return i===null?"":t==="string"||t==="number"||t==="boolean"?String(i):i instanceof Ri||i instanceof Xi||i instanceof tn||i instanceof Mr||i instanceof ur?i.toString():JSON.stringify(i)}class Ss{constructor(t,r){this.type=t,this.value=r}static parse(t,r){if(t.length!==2)return r.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!Mn(t[1]))return r.error("invalid value");const o=t[1];let f=sr(o);const v=r.expectedType;return f.kind!=="array"||f.N!==0||!v||v.kind!=="array"||typeof v.N=="number"&&v.N!==0||(f=v),new Ss(f,o)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}class Er{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}}const jo={string:ui,number:Ee,boolean:$e,object:Tr};class fn{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");let o,f=1;const v=t[0];if(v==="array"){let T,A;if(t.length>2){const D=t[1];if(typeof D!="string"||!(D in jo)||D==="object")return r.error('The item type argument of "array" must be one of string, number, boolean',1);T=jo[D],f++}else T=ii;if(t.length>3){if(t[2]!==null&&(typeof t[2]!="number"||t[2]<0||t[2]!==Math.floor(t[2])))return r.error('The length argument to "array" must be a positive integer literal',2);A=t[2],f++}o=W(T,A)}else{if(!jo[v])throw new Error(`Types doesn't contain name = ${v}`);o=jo[v]}const x=[];for(;f<t.length;f++){const T=r.parse(t[f],f,ii);if(!T)return null;x.push(T)}return new fn(o,x)}evaluate(t){for(let r=0;r<this.args.length;r++){const o=this.args[r].evaluate(t);if(!ct(this.type,sr(o)))return o;if(r===this.args.length-1)throw new Er(`Expected value to be of type ${H(this.type)}, but found ${H(sr(o))} instead.`)}throw new Error}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}}const Ts={"to-boolean":$e,"to-color":Zi,"to-number":Ee,"to-string":ui};class $n{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");const o=t[0];if(!Ts[o])throw new Error(`Can't parse ${o} as it is not part of the known types`);if((o==="to-boolean"||o==="to-string")&&t.length!==2)return r.error("Expected one argument.");const f=Ts[o],v=[];for(let x=1;x<t.length;x++){const T=r.parse(t[x],x,ii);if(!T)return null;v.push(T)}return new $n(f,v)}evaluate(t){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(t);case"color":{let r,o;for(const f of this.args){if(r=f.evaluate(t),o=null,r instanceof Ri)return r;if(typeof r=="string"){const v=t.parseColor(r);if(v)return v}else if(Array.isArray(r)&&(o=r.length<3||r.length>4?`Invalid rbga value ${JSON.stringify(r)}: expected an array containing either three or four numeric values.`:Cs(r[0],r[1],r[2],r[3]),!o))return new Ri(r[0]/255,r[1]/255,r[2]/255,r[3])}throw new Er(o||`Could not parse color from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"padding":{let r;for(const o of this.args){r=o.evaluate(t);const f=tn.parse(r);if(f)return f}throw new Er(`Could not parse padding from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"variableAnchorOffsetCollection":{let r;for(const o of this.args){r=o.evaluate(t);const f=Mr.parse(r);if(f)return f}throw new Er(`Could not parse variableAnchorOffsetCollection from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"number":{let r=null;for(const o of this.args){if(r=o.evaluate(t),r===null)return 0;const f=Number(r);if(!isNaN(f))return f}throw new Er(`Could not convert ${JSON.stringify(r)} to number.`)}case"formatted":return Xi.fromString(jn(this.args[0].evaluate(t)));case"resolvedImage":return ur.fromString(jn(this.args[0].evaluate(t)));default:return jn(this.args[0].evaluate(t))}}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}}const No=["Unknown","Point","LineString","Polygon"];class mo{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?No[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(t){let r=this._parseColorCache[t];return r||(r=this._parseColorCache[t]=Ri.parse(t)),r}}class hs{constructor(t,r,o=[],f,v=new nr,x=[]){this.registry=t,this.path=o,this.key=o.map(T=>`[${T}]`).join(""),this.scope=v,this.errors=x,this.expectedType=f,this._isConstant=r}parse(t,r,o,f,v={}){return r?this.concat(r,o,f)._parse(t,v):this._parse(t,v)}_parse(t,r){function o(f,v,x){return x==="assert"?new fn(v,[f]):x==="coerce"?new $n(v,[f]):f}if(t!==null&&typeof t!="string"&&typeof t!="boolean"&&typeof t!="number"||(t=["literal",t]),Array.isArray(t)){if(t.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const f=t[0];if(typeof f!="string")return this.error(`Expression name must be a string, but found ${typeof f} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const v=this.registry[f];if(v){let x=v.parse(t,this);if(!x)return null;if(this.expectedType){const T=this.expectedType,A=x.type;if(T.kind!=="string"&&T.kind!=="number"&&T.kind!=="boolean"&&T.kind!=="object"&&T.kind!=="array"||A.kind!=="value")if(T.kind!=="color"&&T.kind!=="formatted"&&T.kind!=="resolvedImage"||A.kind!=="value"&&A.kind!=="string")if(T.kind!=="padding"||A.kind!=="value"&&A.kind!=="number"&&A.kind!=="array")if(T.kind!=="variableAnchorOffsetCollection"||A.kind!=="value"&&A.kind!=="array"){if(this.checkSubtype(T,A))return null}else x=o(x,T,r.typeAnnotation||"coerce");else x=o(x,T,r.typeAnnotation||"coerce");else x=o(x,T,r.typeAnnotation||"coerce");else x=o(x,T,r.typeAnnotation||"assert")}if(!(x instanceof Ss)&&x.type.kind!=="resolvedImage"&&this._isConstant(x)){const T=new mo;try{x=new Ss(x.type,x.evaluate(T))}catch(A){return this.error(A.message),null}}return x}return this.error(`Unknown expression "${f}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(t===void 0?"'undefined' value invalid. Use null instead.":typeof t=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,r,o){const f=typeof t=="number"?this.path.concat(t):this.path,v=o?this.scope.concat(o):this.scope;return new hs(this.registry,this._isConstant,f,r||null,v,this.errors)}error(t,...r){const o=`${this.key}${r.map(f=>`[${f}]`).join("")}`;this.errors.push(new zi(o,t))}checkSubtype(t,r){const o=ct(t,r);return o&&this.error(o),o}}class Bi{constructor(t,r){this.type=r.type,this.bindings=[].concat(t),this.result=r}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const r of this.bindings)t(r[1]);t(this.result)}static parse(t,r){if(t.length<4)return r.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const o=[];for(let v=1;v<t.length-1;v+=2){const x=t[v];if(typeof x!="string")return r.error(`Expected string, but found ${typeof x} instead.`,v);if(/[^a-zA-Z0-9_]/.test(x))return r.error("Variable names must contain only alphanumeric characters or '_'.",v);const T=r.parse(t[v+1],v+1);if(!T)return null;o.push([x,T])}const f=r.parse(t[t.length-1],t.length-1,r.expectedType,o);return f?new Bi(o,f):null}outputDefined(){return this.result.outputDefined()}}class Es{constructor(t,r){this.type=r.type,this.name=t,this.boundExpression=r}static parse(t,r){if(t.length!==2||typeof t[1]!="string")return r.error("'var' expression requires exactly one string literal argument.");const o=t[1];return r.scope.has(o)?new Es(o,r.scope.get(o)):r.error(`Unknown variable "${o}". Make sure "${o}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}}class P{constructor(t,r,o){this.type=t,this.index=r,this.input=o}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const o=r.parse(t[1],1,Ee),f=r.parse(t[2],2,W(r.expectedType||ii));return o&&f?new P(f.type.itemType,o,f):null}evaluate(t){const r=this.index.evaluate(t),o=this.input.evaluate(t);if(r<0)throw new Er(`Array index out of bounds: ${r} < 0.`);if(r>=o.length)throw new Er(`Array index out of bounds: ${r} > ${o.length-1}.`);if(r!==Math.floor(r))throw new Er(`Array index must be an integer, but found ${r} instead.`);return o[r]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}}class F{constructor(t,r){this.type=$e,this.needle=t,this.haystack=r}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const o=r.parse(t[1],1,ii),f=r.parse(t[2],2,ii);return o&&f?Et(o.type,[$e,ui,Ee,Yi,ii])?new F(o,f):r.error(`Expected first argument to be of type boolean, string, number or null, but found ${H(o.type)} instead`):null}evaluate(t){const r=this.needle.evaluate(t),o=this.haystack.evaluate(t);if(!o)return!1;if(!Ot(r,["boolean","string","number","null"]))throw new Er(`Expected first argument to be of type boolean, string, number or null, but found ${H(sr(r))} instead.`);if(!Ot(o,["string","array"]))throw new Er(`Expected second argument to be of type array or string, but found ${H(sr(o))} instead.`);return o.indexOf(r)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}}class K{constructor(t,r,o){this.type=Ee,this.needle=t,this.haystack=r,this.fromIndex=o}static parse(t,r){if(t.length<=2||t.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const o=r.parse(t[1],1,ii),f=r.parse(t[2],2,ii);if(!o||!f)return null;if(!Et(o.type,[$e,ui,Ee,Yi,ii]))return r.error(`Expected first argument to be of type boolean, string, number or null, but found ${H(o.type)} instead`);if(t.length===4){const v=r.parse(t[3],3,Ee);return v?new K(o,f,v):null}return new K(o,f)}evaluate(t){const r=this.needle.evaluate(t),o=this.haystack.evaluate(t);if(!Ot(r,["boolean","string","number","null"]))throw new Er(`Expected first argument to be of type boolean, string, number or null, but found ${H(sr(r))} instead.`);if(!Ot(o,["string","array"]))throw new Er(`Expected second argument to be of type array or string, but found ${H(sr(o))} instead.`);if(this.fromIndex){const f=this.fromIndex.evaluate(t);return o.indexOf(r,f)}return o.indexOf(r)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}}class yt{constructor(t,r,o,f,v,x){this.inputType=t,this.type=r,this.input=o,this.cases=f,this.outputs=v,this.otherwise=x}static parse(t,r){if(t.length<5)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return r.error("Expected an even number of arguments.");let o,f;r.expectedType&&r.expectedType.kind!=="value"&&(f=r.expectedType);const v={},x=[];for(let D=2;D<t.length-1;D+=2){let B=t[D];const j=t[D+1];Array.isArray(B)||(B=[B]);const X=r.concat(D);if(B.length===0)return X.error("Expected at least one branch label.");for(const J of B){if(typeof J!="number"&&typeof J!="string")return X.error("Branch labels must be numbers or strings.");if(typeof J=="number"&&Math.abs(J)>Number.MAX_SAFE_INTEGER)return X.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof J=="number"&&Math.floor(J)!==J)return X.error("Numeric branch labels must be integer values.");if(o){if(X.checkSubtype(o,sr(J)))return null}else o=sr(J);if(v[String(J)]!==void 0)return X.error("Branch labels must be unique.");v[String(J)]=x.length}const q=r.parse(j,D,f);if(!q)return null;f=f||q.type,x.push(q)}const T=r.parse(t[1],1,ii);if(!T)return null;const A=r.parse(t[t.length-1],t.length-1,f);return A?T.type.kind!=="value"&&r.concat(1).checkSubtype(o,T.type)?null:new yt(o,f,T,v,x,A):null}evaluate(t){const r=this.input.evaluate(t);return(sr(r)===this.inputType&&this.outputs[this.cases[r]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}}class Tt{constructor(t,r,o){this.type=t,this.branches=r,this.otherwise=o}static parse(t,r){if(t.length<4)return r.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return r.error("Expected an odd number of arguments.");let o;r.expectedType&&r.expectedType.kind!=="value"&&(o=r.expectedType);const f=[];for(let x=1;x<t.length-1;x+=2){const T=r.parse(t[x],x,$e);if(!T)return null;const A=r.parse(t[x+1],x+1,o);if(!A)return null;f.push([T,A]),o=o||A.type}const v=r.parse(t[t.length-1],t.length-1,o);if(!v)return null;if(!o)throw new Error("Can't infer output type");return new Tt(o,f,v)}evaluate(t){for(const[r,o]of this.branches)if(r.evaluate(t))return o.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[r,o]of this.branches)t(r),t(o);t(this.otherwise)}outputDefined(){return this.branches.every(([t,r])=>r.outputDefined())&&this.otherwise.outputDefined()}}class kt{constructor(t,r,o,f){this.type=t,this.input=r,this.beginIndex=o,this.endIndex=f}static parse(t,r){if(t.length<=2||t.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const o=r.parse(t[1],1,ii),f=r.parse(t[2],2,Ee);if(!o||!f)return null;if(!Et(o.type,[W(ii),ui,ii]))return r.error(`Expected first argument to be of type array or string, but found ${H(o.type)} instead`);if(t.length===4){const v=r.parse(t[3],3,Ee);return v?new kt(o.type,o,f,v):null}return new kt(o.type,o,f)}evaluate(t){const r=this.input.evaluate(t),o=this.beginIndex.evaluate(t);if(!Ot(r,["string","array"]))throw new Er(`Expected first argument to be of type array or string, but found ${H(sr(r))} instead.`);if(this.endIndex){const f=this.endIndex.evaluate(t);return r.slice(o,f)}return r.slice(o)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}}function Rt(i,t){const r=i.length-1;let o,f,v=0,x=r,T=0;for(;v<=x;)if(T=Math.floor((v+x)/2),o=i[T],f=i[T+1],o<=t){if(T===r||t<f)return T;v=T+1}else{if(!(o>t))throw new Er("Input is not a number.");x=T-1}return 0}class xe{constructor(t,r,o){this.type=t,this.input=r,this.labels=[],this.outputs=[];for(const[f,v]of o)this.labels.push(f),this.outputs.push(v)}static parse(t,r){if(t.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return r.error("Expected an even number of arguments.");const o=r.parse(t[1],1,Ee);if(!o)return null;const f=[];let v=null;r.expectedType&&r.expectedType.kind!=="value"&&(v=r.expectedType);for(let x=1;x<t.length;x+=2){const T=x===1?-1/0:t[x],A=t[x+1],D=x,B=x+1;if(typeof T!="number")return r.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',D);if(f.length&&f[f.length-1][0]>=T)return r.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',D);const j=r.parse(A,B,v);if(!j)return null;v=v||j.type,f.push([T,j])}return new xe(v,o,f)}evaluate(t){const r=this.labels,o=this.outputs;if(r.length===1)return o[0].evaluate(t);const f=this.input.evaluate(t);if(f<=r[0])return o[0].evaluate(t);const v=r.length;return f>=r[v-1]?o[v-1].evaluate(t):o[Rt(r,f)].evaluate(t)}eachChild(t){t(this.input);for(const r of this.outputs)t(r)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}}function Ie(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var Ne=je;function je(i,t,r,o){this.cx=3*i,this.bx=3*(r-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(o-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=t,this.p2x=r,this.p2y=o}je.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,t){if(t===void 0&&(t=1e-6),i<0)return 0;if(i>1)return 1;for(var r=i,o=0;o<8;o++){var f=this.sampleCurveX(r)-i;if(Math.abs(f)<t)return r;var v=this.sampleCurveDerivativeX(r);if(Math.abs(v)<1e-6)break;r-=f/v}var x=0,T=1;for(r=i,o=0;o<20&&(f=this.sampleCurveX(r),!(Math.abs(f-i)<t));o++)i>f?x=r:T=r,r=.5*(T-x)+x;return r},solve:function(i,t){return this.sampleCurveY(this.solveCurveX(i,t))}};var De=Ie(Ne);function pi(i,t,r){return i+r*(t-i)}function er(i,t,r){return i.map((o,f)=>pi(o,t[f],r))}const di={number:pi,color:function(i,t,r,o="rgb"){switch(o){case"rgb":{const[f,v,x,T]=er(i.rgb,t.rgb,r);return new Ri(f,v,x,T,!1)}case"hcl":{const[f,v,x,T]=i.hcl,[A,D,B,j]=t.hcl;let X,q;if(isNaN(f)||isNaN(A))isNaN(f)?isNaN(A)?X=NaN:(X=A,x!==1&&x!==0||(q=D)):(X=f,B!==1&&B!==0||(q=v));else{let Gt=A-f;A>f&&Gt>180?Gt-=360:A<f&&f-A>180&&(Gt+=360),X=f+r*Gt}const[J,it,dt,Ct]=function([Gt,At,Nt,ie]){return Gt=isNaN(Gt)?0:Gt*ei,Fi([Nt,Math.cos(Gt)*At,Math.sin(Gt)*At,ie])}([X,q??pi(v,D,r),pi(x,B,r),pi(T,j,r)]);return new Ri(J,it,dt,Ct,!1)}case"lab":{const[f,v,x,T]=Fi(er(i.lab,t.lab,r));return new Ri(f,v,x,T,!1)}}},array:er,padding:function(i,t,r){return new tn(er(i.values,t.values,r))},variableAnchorOffsetCollection:function(i,t,r){const o=i.values,f=t.values;if(o.length!==f.length)throw new Er(`Cannot interpolate values of different length. from: ${i.toString()}, to: ${t.toString()}`);const v=[];for(let x=0;x<o.length;x+=2){if(o[x]!==f[x])throw new Er(`Cannot interpolate values containing mismatched anchors. from[${x}]: ${o[x]}, to[${x}]: ${f[x]}`);v.push(o[x]);const[T,A]=o[x+1],[D,B]=f[x+1];v.push([pi(T,D,r),pi(A,B,r)])}return new Mr(v)}};class Ni{constructor(t,r,o,f,v){this.type=t,this.operator=r,this.interpolation=o,this.input=f,this.labels=[],this.outputs=[];for(const[x,T]of v)this.labels.push(x),this.outputs.push(T)}static interpolationFactor(t,r,o,f){let v=0;if(t.name==="exponential")v=ge(r,t.base,o,f);else if(t.name==="linear")v=ge(r,1,o,f);else if(t.name==="cubic-bezier"){const x=t.controlPoints;v=new De(x[0],x[1],x[2],x[3]).solve(ge(r,1,o,f))}return v}static parse(t,r){let[o,f,v,...x]=t;if(!Array.isArray(f)||f.length===0)return r.error("Expected an interpolation type expression.",1);if(f[0]==="linear")f={name:"linear"};else if(f[0]==="exponential"){const D=f[1];if(typeof D!="number")return r.error("Exponential interpolation requires a numeric base.",1,1);f={name:"exponential",base:D}}else{if(f[0]!=="cubic-bezier")return r.error(`Unknown interpolation type ${String(f[0])}`,1,0);{const D=f.slice(1);if(D.length!==4||D.some(B=>typeof B!="number"||B<0||B>1))return r.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);f={name:"cubic-bezier",controlPoints:D}}}if(t.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return r.error("Expected an even number of arguments.");if(v=r.parse(v,2,Ee),!v)return null;const T=[];let A=null;o==="interpolate-hcl"||o==="interpolate-lab"?A=Zi:r.expectedType&&r.expectedType.kind!=="value"&&(A=r.expectedType);for(let D=0;D<x.length;D+=2){const B=x[D],j=x[D+1],X=D+3,q=D+4;if(typeof B!="number")return r.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',X);if(T.length&&T[T.length-1][0]>=B)return r.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',X);const J=r.parse(j,q,A);if(!J)return null;A=A||J.type,T.push([B,J])}return zt(A,Ee)||zt(A,Zi)||zt(A,Rr)||zt(A,_t)||zt(A,W(Ee))?new Ni(A,o,f,v,T):r.error(`Type ${H(A)} is not interpolatable.`)}evaluate(t){const r=this.labels,o=this.outputs;if(r.length===1)return o[0].evaluate(t);const f=this.input.evaluate(t);if(f<=r[0])return o[0].evaluate(t);const v=r.length;if(f>=r[v-1])return o[v-1].evaluate(t);const x=Rt(r,f),T=Ni.interpolationFactor(this.interpolation,f,r[x],r[x+1]),A=o[x].evaluate(t),D=o[x+1].evaluate(t);switch(this.operator){case"interpolate":return di[this.type.kind](A,D,T);case"interpolate-hcl":return di.color(A,D,T,"hcl");case"interpolate-lab":return di.color(A,D,T,"lab")}}eachChild(t){t(this.input);for(const r of this.outputs)t(r)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}}function ge(i,t,r,o){const f=o-r,v=i-r;return f===0?0:t===1?v/f:(Math.pow(t,v)-1)/(Math.pow(t,f)-1)}class ri{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expectected at least one argument.");let o=null;const f=r.expectedType;f&&f.kind!=="value"&&(o=f);const v=[];for(const T of t.slice(1)){const A=r.parse(T,1+v.length,o,void 0,{typeAnnotation:"omit"});if(!A)return null;o=o||A.type,v.push(A)}if(!o)throw new Error("No output type");const x=f&&v.some(T=>ct(f,T.type));return new ri(x?ii:o,v)}evaluate(t){let r,o=null,f=0;for(const v of this.args)if(f++,o=v.evaluate(t),o&&o instanceof ur&&!o.available&&(r||(r=o.name),o=null,f===this.args.length&&(o=r)),o!==null)break;return o}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}}function qi(i,t){return i==="=="||i==="!="?t.kind==="boolean"||t.kind==="string"||t.kind==="number"||t.kind==="null"||t.kind==="value":t.kind==="string"||t.kind==="number"||t.kind==="value"}function zr(i,t,r,o){return o.compare(t,r)===0}function or(i,t,r){const o=i!=="=="&&i!=="!=";return class hf{constructor(v,x,T){this.type=$e,this.lhs=v,this.rhs=x,this.collator=T,this.hasUntypedArgument=v.type.kind==="value"||x.type.kind==="value"}static parse(v,x){if(v.length!==3&&v.length!==4)return x.error("Expected two or three arguments.");const T=v[0];let A=x.parse(v[1],1,ii);if(!A)return null;if(!qi(T,A.type))return x.concat(1).error(`"${T}" comparisons are not supported for type '${H(A.type)}'.`);let D=x.parse(v[2],2,ii);if(!D)return null;if(!qi(T,D.type))return x.concat(2).error(`"${T}" comparisons are not supported for type '${H(D.type)}'.`);if(A.type.kind!==D.type.kind&&A.type.kind!=="value"&&D.type.kind!=="value")return x.error(`Cannot compare types '${H(A.type)}' and '${H(D.type)}'.`);o&&(A.type.kind==="value"&&D.type.kind!=="value"?A=new fn(D.type,[A]):A.type.kind!=="value"&&D.type.kind==="value"&&(D=new fn(A.type,[D])));let B=null;if(v.length===4){if(A.type.kind!=="string"&&D.type.kind!=="string"&&A.type.kind!=="value"&&D.type.kind!=="value")return x.error("Cannot use collator to compare non-string types.");if(B=x.parse(v[3],3,Oi),!B)return null}return new hf(A,D,B)}evaluate(v){const x=this.lhs.evaluate(v),T=this.rhs.evaluate(v);if(o&&this.hasUntypedArgument){const A=sr(x),D=sr(T);if(A.kind!==D.kind||A.kind!=="string"&&A.kind!=="number")throw new Er(`Expected arguments for "${i}" to be (string, string) or (number, number), but found (${A.kind}, ${D.kind}) instead.`)}if(this.collator&&!o&&this.hasUntypedArgument){const A=sr(x),D=sr(T);if(A.kind!=="string"||D.kind!=="string")return t(v,x,T)}return this.collator?r(v,x,T,this.collator.evaluate(v)):t(v,x,T)}eachChild(v){v(this.lhs),v(this.rhs),this.collator&&v(this.collator)}outputDefined(){return!0}}}const Vo=or("==",function(i,t,r){return t===r},zr),El=or("!=",function(i,t,r){return t!==r},function(i,t,r,o){return!zr(0,t,r,o)}),dr=or("<",function(i,t,r){return t<r},function(i,t,r,o){return o.compare(t,r)<0}),ya=or(">",function(i,t,r){return t>r},function(i,t,r,o){return o.compare(t,r)>0}),Ka=or("<=",function(i,t,r){return t<=r},function(i,t,r,o){return o.compare(t,r)<=0}),Yn=or(">=",function(i,t,r){return t>=r},function(i,t,r,o){return o.compare(t,r)>=0});class go{constructor(t,r,o){this.type=Oi,this.locale=o,this.caseSensitive=t,this.diacriticSensitive=r}static parse(t,r){if(t.length!==2)return r.error("Expected one argument.");const o=t[1];if(typeof o!="object"||Array.isArray(o))return r.error("Collator options argument must be an object.");const f=r.parse(o["case-sensitive"]!==void 0&&o["case-sensitive"],1,$e);if(!f)return null;const v=r.parse(o["diacritic-sensitive"]!==void 0&&o["diacritic-sensitive"],1,$e);if(!v)return null;let x=null;return o.locale&&(x=r.parse(o.locale,1,ui),!x)?null:new go(f,v,x)}evaluate(t){return new fo(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}}class Uo{constructor(t,r,o,f,v){this.type=ui,this.number=t,this.locale=r,this.currency=o,this.minFractionDigits=f,this.maxFractionDigits=v}static parse(t,r){if(t.length!==3)return r.error("Expected two arguments.");const o=r.parse(t[1],1,Ee);if(!o)return null;const f=t[2];if(typeof f!="object"||Array.isArray(f))return r.error("NumberFormat options argument must be an object.");let v=null;if(f.locale&&(v=r.parse(f.locale,1,ui),!v))return null;let x=null;if(f.currency&&(x=r.parse(f.currency,1,ui),!x))return null;let T=null;if(f["min-fraction-digits"]&&(T=r.parse(f["min-fraction-digits"],1,Ee),!T))return null;let A=null;return f["max-fraction-digits"]&&(A=r.parse(f["max-fraction-digits"],1,Ee),!A)?null:new Uo(o,v,x,T,A)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}}class _o{constructor(t){this.type=Wi,this.sections=t}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");const o=t[1];if(!Array.isArray(o)&&typeof o=="object")return r.error("First argument must be an image or text section.");const f=[];let v=!1;for(let x=1;x<=t.length-1;++x){const T=t[x];if(v&&typeof T=="object"&&!Array.isArray(T)){v=!1;let A=null;if(T["font-scale"]&&(A=r.parse(T["font-scale"],1,Ee),!A))return null;let D=null;if(T["text-font"]&&(D=r.parse(T["text-font"],1,W(ui)),!D))return null;let B=null;if(T["text-color"]&&(B=r.parse(T["text-color"],1,Zi),!B))return null;const j=f[f.length-1];j.scale=A,j.font=D,j.textColor=B}else{const A=r.parse(t[x],1,ii);if(!A)return null;const D=A.type.kind;if(D!=="string"&&D!=="value"&&D!=="null"&&D!=="resolvedImage")return r.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");v=!0,f.push({content:A,scale:null,font:null,textColor:null})}}return new _o(f)}evaluate(t){return new Xi(this.sections.map(r=>{const o=r.content.evaluate(t);return sr(o)===cr?new po("",o,null,null,null):new po(jn(o),null,r.scale?r.scale.evaluate(t):null,r.font?r.font.evaluate(t).join(","):null,r.textColor?r.textColor.evaluate(t):null)}))}eachChild(t){for(const r of this.sections)t(r.content),r.scale&&t(r.scale),r.font&&t(r.font),r.textColor&&t(r.textColor)}outputDefined(){return!1}}class yo{constructor(t){this.type=cr,this.input=t}static parse(t,r){if(t.length!==2)return r.error("Expected two arguments.");const o=r.parse(t[1],1,ui);return o?new yo(o):r.error("No image name provided.")}evaluate(t){const r=this.input.evaluate(t),o=ur.fromString(r);return o&&t.availableImages&&(o.available=t.availableImages.indexOf(r)>-1),o}eachChild(t){t(this.input)}outputDefined(){return!1}}class Go{constructor(t){this.type=Ee,this.input=t}static parse(t,r){if(t.length!==2)return r.error(`Expected 1 argument, but found ${t.length-1} instead.`);const o=r.parse(t[1],1);return o?o.type.kind!=="array"&&o.type.kind!=="string"&&o.type.kind!=="value"?r.error(`Expected argument of type string or array, but found ${H(o.type)} instead.`):new Go(o):null}evaluate(t){const r=this.input.evaluate(t);if(typeof r=="string"||Array.isArray(r))return r.length;throw new Er(`Expected value to be of type string or array, but found ${H(sr(r))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}}const kn=8192;function va(i,t){const r=(180+i[0])/360,o=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i[1]*Math.PI/360)))/360,f=Math.pow(2,t.z);return[Math.round(r*f*kn),Math.round(o*f*kn)]}function js(i,t){const r=Math.pow(2,t.z);return[(f=(i[0]/kn+t.x)/r,360*f-180),(o=(i[1]/kn+t.y)/r,360/Math.PI*Math.atan(Math.exp((180-360*o)*Math.PI/180))-90)];var o,f}function Li(i,t){i[0]=Math.min(i[0],t[0]),i[1]=Math.min(i[1],t[1]),i[2]=Math.max(i[2],t[0]),i[3]=Math.max(i[3],t[1])}function Ns(i,t){return!(i[0]<=t[0]||i[2]>=t[2]||i[1]<=t[1]||i[3]>=t[3])}function Ja(i,t,r){const o=i[0]-t[0],f=i[1]-t[1],v=i[0]-r[0],x=i[1]-r[1];return o*x-v*f==0&&o*v<=0&&f*x<=0}function vo(i,t,r,o){return(f=[o[0]-r[0],o[1]-r[1]])[0]*(v=[t[0]-i[0],t[1]-i[1]])[1]-f[1]*v[0]!=0&&!(!On(i,t,r,o)||!On(r,o,i,t));var f,v}function Pl(i,t,r){for(const o of r)for(let f=0;f<o.length-1;++f)if(vo(i,t,o[f],o[f+1]))return!0;return!1}function Vs(i,t,r=!1){let o=!1;for(const T of t)for(let A=0;A<T.length-1;A++){if(Ja(i,T[A],T[A+1]))return r;(v=T[A])[1]>(f=i)[1]!=(x=T[A+1])[1]>f[1]&&f[0]<(x[0]-v[0])*(f[1]-v[1])/(x[1]-v[1])+v[0]&&(o=!o)}var f,v,x;return o}function Xo(i,t){for(const r of t)if(Vs(i,r))return!0;return!1}function Wo(i,t){for(const r of i)if(!Vs(r,t))return!1;for(let r=0;r<i.length-1;++r)if(Pl(i[r],i[r+1],t))return!1;return!0}function Qa(i,t){for(const r of t)if(Wo(i,r))return!0;return!1}function On(i,t,r,o){const f=o[0]-r[0],v=o[1]-r[1],x=(i[0]-r[0])*v-f*(i[1]-r[1]),T=(t[0]-r[0])*v-f*(t[1]-r[1]);return x>0&&T<0||x<0&&T>0}function Ho(i,t,r){const o=[];for(let f=0;f<i.length;f++){const v=[];for(let x=0;x<i[f].length;x++){const T=va(i[f][x],r);Li(t,T),v.push(T)}o.push(v)}return o}function xa(i,t,r){const o=[];for(let f=0;f<i.length;f++){const v=Ho(i[f],t,r);o.push(v)}return o}function tl(i,t,r,o){if(i[0]<r[0]||i[0]>r[2]){const f=.5*o;let v=i[0]-r[0]>f?-o:r[0]-i[0]>f?o:0;v===0&&(v=i[0]-r[2]>f?-o:r[2]-i[0]>f?o:0),i[0]+=v}Li(t,i)}function ba(i,t,r,o){const f=Math.pow(2,o.z)*kn,v=[o.x*kn,o.y*kn],x=[];for(const T of i)for(const A of T){const D=[A.x+v[0],A.y+v[1]];tl(D,t,r,f),x.push(D)}return x}function xo(i,t,r,o){const f=Math.pow(2,o.z)*kn,v=[o.x*kn,o.y*kn],x=[];for(const A of i){const D=[];for(const B of A){const j=[B.x+v[0],B.y+v[1]];Li(t,j),D.push(j)}x.push(D)}if(t[2]-t[0]<=f/2){(T=t)[0]=T[1]=1/0,T[2]=T[3]=-1/0;for(const A of x)for(const D of A)tl(D,t,r,f)}var T;return x}class us{constructor(t,r){this.type=$e,this.geojson=t,this.geometries=r}static parse(t,r){if(t.length!==2)return r.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Mn(t[1])){const o=t[1];if(o.type==="FeatureCollection"){const f=[];for(const v of o.features){const{type:x,coordinates:T}=v.geometry;x==="Polygon"&&f.push(T),x==="MultiPolygon"&&f.push(...T)}if(f.length)return new us(o,{type:"MultiPolygon",coordinates:f})}else if(o.type==="Feature"){const f=o.geometry.type;if(f==="Polygon"||f==="MultiPolygon")return new us(o,o.geometry)}else if(o.type==="Polygon"||o.type==="MultiPolygon")return new us(o,o)}return r.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(r,o){const f=[1/0,1/0,-1/0,-1/0],v=[1/0,1/0,-1/0,-1/0],x=r.canonicalID();if(o.type==="Polygon"){const T=Ho(o.coordinates,v,x),A=ba(r.geometry(),f,v,x);if(!Ns(f,v))return!1;for(const D of A)if(!Vs(D,T))return!1}if(o.type==="MultiPolygon"){const T=xa(o.coordinates,v,x),A=ba(r.geometry(),f,v,x);if(!Ns(f,v))return!1;for(const D of A)if(!Xo(D,T))return!1}return!0}(t,this.geometries);if(t.geometryType()==="LineString")return function(r,o){const f=[1/0,1/0,-1/0,-1/0],v=[1/0,1/0,-1/0,-1/0],x=r.canonicalID();if(o.type==="Polygon"){const T=Ho(o.coordinates,v,x),A=xo(r.geometry(),f,v,x);if(!Ns(f,v))return!1;for(const D of A)if(!Wo(D,T))return!1}if(o.type==="MultiPolygon"){const T=xa(o.coordinates,v,x),A=xo(r.geometry(),f,v,x);if(!Ns(f,v))return!1;for(const D of A)if(!Qa(D,T))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let wa=class{constructor(i=[],t=Il){if(this.data=i,this.length=this.data.length,this.compare=t,this.length>0)for(let r=(this.length>>1)-1;r>=0;r--)this._down(r)}push(i){this.data.push(i),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const i=this.data[0],t=this.data.pop();return this.length--,this.length>0&&(this.data[0]=t,this._down(0)),i}peek(){return this.data[0]}_up(i){const{data:t,compare:r}=this,o=t[i];for(;i>0;){const f=i-1>>1,v=t[f];if(r(o,v)>=0)break;t[i]=v,i=f}t[i]=o}_down(i){const{data:t,compare:r}=this,o=this.length>>1,f=t[i];for(;i<o;){let v=1+(i<<1),x=t[v];const T=v+1;if(T<this.length&&r(t[T],x)<0&&(v=T,x=t[T]),r(x,f)>=0)break;t[i]=x,i=v}t[i]=f}};function Il(i,t){return i<t?-1:i>t?1:0}function Ps(i,t,r,o,f){Ca(i,t,r,o||i.length-1,f||Al)}function Ca(i,t,r,o,f){for(;o>r;){if(o-r>600){var v=o-r+1,x=t-r+1,T=Math.log(v),A=.5*Math.exp(2*T/3),D=.5*Math.sqrt(T*A*(v-A)/v)*(x-v/2<0?-1:1);Ca(i,t,Math.max(r,Math.floor(t-x*A/v+D)),Math.min(o,Math.floor(t+(v-x)*A/v+D)),f)}var B=i[t],j=r,X=o;for(bo(i,r,t),f(i[o],B)>0&&bo(i,r,o);j<X;){for(bo(i,j,X),j++,X--;f(i[j],B)<0;)j++;for(;f(i[X],B)>0;)X--}f(i[r],B)===0?bo(i,r,X):bo(i,++X,o),X<=t&&(r=X+1),t<=X&&(o=X-1)}}function bo(i,t,r){var o=i[t];i[t]=i[r],i[r]=o}function Al(i,t){return i<t?-1:i>t?1:0}function Us(i,t){if(i.length<=1)return[i];const r=[];let o,f;for(const v of i){const x=Sa(v);x!==0&&(v.area=Math.abs(x),f===void 0&&(f=x<0),f===x<0?(o&&r.push(o),o=[v]):o.push(v))}if(o&&r.push(o),t>1)for(let v=0;v<r.length;v++)r[v].length<=t||(Ps(r[v],t,1,r[v].length-1,wo),r[v]=r[v].slice(0,t));return r}function wo(i,t){return t.area-i.area}function Sa(i){let t=0;for(let r,o,f=0,v=i.length,x=v-1;f<v;x=f++)r=i[f],o=i[x],t+=(o.x-r.x)*(r.y+o.y);return t}const qo=1/298.257223563,$o=qo*(2-qo),Gs=Math.PI/180;class Ta{constructor(t){const r=6378.137*Gs*1e3,o=Math.cos(t*Gs),f=1/(1-$o*(1-o*o)),v=Math.sqrt(f);this.kx=r*v*o,this.ky=r*v*f*(1-$o)}distance(t,r){const o=this.wrap(t[0]-r[0])*this.kx,f=(t[1]-r[1])*this.ky;return Math.sqrt(o*o+f*f)}pointOnLine(t,r){let o,f,v,x,T=1/0;for(let A=0;A<t.length-1;A++){let D=t[A][0],B=t[A][1],j=this.wrap(t[A+1][0]-D)*this.kx,X=(t[A+1][1]-B)*this.ky,q=0;j===0&&X===0||(q=(this.wrap(r[0]-D)*this.kx*j+(r[1]-B)*this.ky*X)/(j*j+X*X),q>1?(D=t[A+1][0],B=t[A+1][1]):q>0&&(D+=j/this.kx*q,B+=X/this.ky*q)),j=this.wrap(r[0]-D)*this.kx,X=(r[1]-B)*this.ky;const J=j*j+X*X;J<T&&(T=J,o=D,f=B,v=A,x=q)}return{point:[o,f],index:v,t:Math.max(0,Math.min(1,x))}}wrap(t){for(;t<-180;)t+=360;for(;t>180;)t-=360;return t}}function el(i,t){return t[0]-i[0]}function Yo(i){return i[1]-i[0]+1}function Zn(i,t){return i[1]>=i[0]&&i[1]<t}function Co(i,t){if(i[0]>i[1])return[null,null];const r=Yo(i);if(t){if(r===2)return[i,null];const f=Math.floor(r/2);return[[i[0],i[0]+f],[i[0]+f,i[1]]]}if(r===1)return[i,null];const o=Math.floor(r/2)-1;return[[i[0],i[0]+o],[i[0]+o+1,i[1]]]}function Zo(i,t){if(!Zn(t,i.length))return[1/0,1/0,-1/0,-1/0];const r=[1/0,1/0,-1/0,-1/0];for(let o=t[0];o<=t[1];++o)Li(r,i[o]);return r}function So(i){const t=[1/0,1/0,-1/0,-1/0];for(const r of i)for(const o of r)Li(t,o);return t}function ds(i){return i[0]!==-1/0&&i[1]!==-1/0&&i[2]!==1/0&&i[3]!==1/0}function Dn(i,t,r){if(!ds(i)||!ds(t))return NaN;let o=0,f=0;return i[2]<t[0]&&(o=t[0]-i[2]),i[0]>t[2]&&(o=i[0]-t[2]),i[1]>t[3]&&(f=i[1]-t[3]),i[3]<t[1]&&(f=t[1]-i[3]),r.distance([0,0],[o,f])}function ji(i,t,r){const o=r.pointOnLine(t,i);return r.distance(i,o.point)}function Xs(i,t,r,o,f){const v=Math.min(ji(i,[r,o],f),ji(t,[r,o],f)),x=Math.min(ji(r,[i,t],f),ji(o,[i,t],f));return Math.min(v,x)}function Si(i,t,r,o,f){if(!Zn(t,i.length)||!Zn(o,r.length))return 1/0;let v=1/0;for(let x=t[0];x<t[1];++x){const T=i[x],A=i[x+1];for(let D=o[0];D<o[1];++D){const B=r[D],j=r[D+1];if(vo(T,A,B,j))return 0;v=Math.min(v,Xs(T,A,B,j,f))}}return v}function Ea(i,t,r,o,f){if(!Zn(t,i.length)||!Zn(o,r.length))return NaN;let v=1/0;for(let x=t[0];x<=t[1];++x)for(let T=o[0];T<=o[1];++T)if(v=Math.min(v,f.distance(i[x],r[T])),v===0)return v;return v}function Qi(i,t,r){if(Vs(i,t,!0))return 0;let o=1/0;for(const f of t){const v=f[0],x=f[f.length-1];if(v!==x&&(o=Math.min(o,ji(i,[x,v],r)),o===0))return o;const T=r.pointOnLine(f,i);if(o=Math.min(o,r.distance(i,T.point)),o===0)return o}return o}function $i(i,t,r,o){if(!Zn(t,i.length))return NaN;for(let v=t[0];v<=t[1];++v)if(Vs(i[v],r,!0))return 0;let f=1/0;for(let v=t[0];v<t[1];++v){const x=i[v],T=i[v+1];for(const A of r)for(let D=0,B=A.length,j=B-1;D<B;j=D++){const X=A[j],q=A[D];if(vo(x,T,X,q))return 0;f=Math.min(f,Xs(x,T,X,q,o))}}return f}function Ws(i,t){for(const r of i)for(const o of r)if(Vs(o,t,!0))return!0;return!1}function Pa(i,t,r,o=1/0){const f=So(i),v=So(t);if(o!==1/0&&Dn(f,v,r)>=o)return o;if(Ns(f,v)){if(Ws(i,t))return 0}else if(Ws(t,i))return 0;let x=1/0;for(const T of i)for(let A=0,D=T.length,B=D-1;A<D;B=A++){const j=T[B],X=T[A];for(const q of t)for(let J=0,it=q.length,dt=it-1;J<it;dt=J++){const Ct=q[dt],Gt=q[J];if(vo(j,X,Ct,Gt))return 0;x=Math.min(x,Xs(j,X,Ct,Gt,r))}}return x}function Ia(i,t,r,o,f,v){if(!v)return;const x=Dn(Zo(o,v),f,r);x<t&&i.push([x,v,[0,0]])}function Ko(i,t,r,o,f,v,x){if(!v||!x)return;const T=Dn(Zo(o,v),Zo(f,x),r);T<t&&i.push([T,v,x])}function To(i,t,r,o,f=1/0){let v=Math.min(o.distance(i[0],r[0][0]),f);if(v===0)return v;const x=new wa([[0,[0,i.length-1],[0,0]]],el),T=So(r);for(;x.length>0;){const A=x.pop();if(A[0]>=v)continue;const D=A[1],B=t?50:100;if(Yo(D)<=B){if(!Zn(D,i.length))return NaN;if(t){const j=$i(i,D,r,o);if(isNaN(j)||j===0)return j;v=Math.min(v,j)}else for(let j=D[0];j<=D[1];++j){const X=Qi(i[j],r,o);if(v=Math.min(v,X),v===0)return 0}}else{const j=Co(D,t);Ia(x,v,o,i,T,j[0]),Ia(x,v,o,i,T,j[1])}}return v}function Eo(i,t,r,o,f,v=1/0){let x=Math.min(v,f.distance(i[0],r[0]));if(x===0)return x;const T=new wa([[0,[0,i.length-1],[0,r.length-1]]],el);for(;T.length>0;){const A=T.pop();if(A[0]>=x)continue;const D=A[1],B=A[2],j=t?50:100,X=o?50:100;if(Yo(D)<=j&&Yo(B)<=X){if(!Zn(D,i.length)&&Zn(B,r.length))return NaN;let q;if(t&&o)q=Si(i,D,r,B,f),x=Math.min(x,q);else if(t&&!o){const J=i.slice(D[0],D[1]+1);for(let it=B[0];it<=B[1];++it)if(q=ji(r[it],J,f),x=Math.min(x,q),x===0)return x}else if(!t&&o){const J=r.slice(B[0],B[1]+1);for(let it=D[0];it<=D[1];++it)if(q=ji(i[it],J,f),x=Math.min(x,q),x===0)return x}else q=Ea(i,D,r,B,f),x=Math.min(x,q)}else{const q=Co(D,t),J=Co(B,o);Ko(T,x,f,i,r,q[0],J[0]),Ko(T,x,f,i,r,q[0],J[1]),Ko(T,x,f,i,r,q[1],J[0]),Ko(T,x,f,i,r,q[1],J[1])}}return x}function Hs(i){return i.type==="MultiPolygon"?i.coordinates.map(t=>({type:"Polygon",coordinates:t})):i.type==="MultiLineString"?i.coordinates.map(t=>({type:"LineString",coordinates:t})):i.type==="MultiPoint"?i.coordinates.map(t=>({type:"Point",coordinates:t})):[i]}class pn{constructor(t,r){this.type=Ee,this.geojson=t,this.geometries=r}static parse(t,r){if(t.length!==2)return r.error(`'distance' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Mn(t[1])){const o=t[1];if(o.type==="FeatureCollection")return new pn(o,o.features.map(f=>Hs(f.geometry)).flat());if(o.type==="Feature")return new pn(o,Hs(o.geometry));if("type"in o&&"coordinates"in o)return new pn(o,Hs(o))}return r.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(r,o){const f=r.geometry(),v=f.flat().map(A=>js([A.x,A.y],r.canonical));if(f.length===0)return NaN;const x=new Ta(v[0][1]);let T=1/0;for(const A of o){switch(A.type){case"Point":T=Math.min(T,Eo(v,!1,[A.coordinates],!1,x,T));break;case"LineString":T=Math.min(T,Eo(v,!1,A.coordinates,!0,x,T));break;case"Polygon":T=Math.min(T,To(v,!1,A.coordinates,x,T))}if(T===0)return T}return T}(t,this.geometries);if(t.geometryType()==="LineString")return function(r,o){const f=r.geometry(),v=f.flat().map(A=>js([A.x,A.y],r.canonical));if(f.length===0)return NaN;const x=new Ta(v[0][1]);let T=1/0;for(const A of o){switch(A.type){case"Point":T=Math.min(T,Eo(v,!0,[A.coordinates],!1,x,T));break;case"LineString":T=Math.min(T,Eo(v,!0,A.coordinates,!0,x,T));break;case"Polygon":T=Math.min(T,To(v,!0,A.coordinates,x,T))}if(T===0)return T}return T}(t,this.geometries);if(t.geometryType()==="Polygon")return function(r,o){const f=r.geometry();if(f.length===0||f[0].length===0)return NaN;const v=Us(f,0).map(A=>A.map(D=>D.map(B=>js([B.x,B.y],r.canonical)))),x=new Ta(v[0][0][0][1]);let T=1/0;for(const A of o)for(const D of v){switch(A.type){case"Point":T=Math.min(T,To([A.coordinates],!1,D,x,T));break;case"LineString":T=Math.min(T,To(A.coordinates,!0,D,x,T));break;case"Polygon":T=Math.min(T,Pa(D,A.coordinates,x,T))}if(T===0)return T}return T}(t,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}const Is={"==":Vo,"!=":El,">":ya,"<":dr,">=":Yn,"<=":Ka,array:fn,at:P,boolean:fn,case:Tt,coalesce:ri,collator:go,format:_o,image:yo,in:F,"index-of":K,interpolate:Ni,"interpolate-hcl":Ni,"interpolate-lab":Ni,length:Go,let:Bi,literal:Ss,match:yt,number:fn,"number-format":Uo,object:fn,slice:kt,step:xe,string:fn,"to-boolean":$n,"to-color":$n,"to-number":$n,"to-string":$n,var:Es,within:us,distance:pn};class kr{constructor(t,r,o,f){this.name=t,this.type=r,this._evaluate=o,this.args=f}evaluate(t){return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}static parse(t,r){const o=t[0],f=kr.definitions[o];if(!f)return r.error(`Unknown expression "${o}". If you wanted a literal array, use ["literal", [...]].`,0);const v=Array.isArray(f)?f[0]:f.type,x=Array.isArray(f)?[[f[1],f[2]]]:f.overloads,T=x.filter(([D])=>!Array.isArray(D)||D.length===t.length-1);let A=null;for(const[D,B]of T){A=new hs(r.registry,Ms,r.path,null,r.scope);const j=[];let X=!1;for(let q=1;q<t.length;q++){const J=t[q],it=Array.isArray(D)?D[q-1]:D.type,dt=A.parse(J,1+j.length,it);if(!dt){X=!0;break}j.push(dt)}if(!X)if(Array.isArray(D)&&D.length!==j.length)A.error(`Expected ${D.length} arguments, but found ${j.length} instead.`);else{for(let q=0;q<j.length;q++){const J=Array.isArray(D)?D[q]:D.type,it=j[q];A.concat(q+1).checkSubtype(J,it.type)}if(A.errors.length===0)return new kr(o,v,B,j)}}if(T.length===1)r.errors.push(...A.errors);else{const D=(T.length?T:x).map(([j])=>{return X=j,Array.isArray(X)?`(${X.map(H).join(", ")})`:`(${H(X.type)}...)`;var X}).join(" | "),B=[];for(let j=1;j<t.length;j++){const X=r.parse(t[j],1+B.length);if(!X)return null;B.push(H(X.type))}r.error(`Expected arguments of type ${D}, but found (${B.join(", ")}) instead.`)}return null}static register(t,r){kr.definitions=r;for(const o in r)t[o]=kr}}function Aa(i,[t,r,o,f]){t=t.evaluate(i),r=r.evaluate(i),o=o.evaluate(i);const v=f?f.evaluate(i):1,x=Cs(t,r,o,v);if(x)throw new Er(x);return new Ri(t/255,r/255,o/255,v,!1)}function Nn(i,t){return i in t}function Jo(i,t){const r=t[i];return r===void 0?null:r}function As(i){return{type:i}}function Ms(i){if(i instanceof Es)return Ms(i.boundExpression);if(i instanceof kr&&i.name==="error"||i instanceof go||i instanceof us||i instanceof pn)return!1;const t=i instanceof $n||i instanceof fn;let r=!0;return i.eachChild(o=>{r=t?r&&Ms(o):r&&o instanceof Ss}),!!r&&qs(i)&&Po(i,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function qs(i){if(i instanceof kr&&(i.name==="get"&&i.args.length===1||i.name==="feature-state"||i.name==="has"&&i.args.length===1||i.name==="properties"||i.name==="geometry-type"||i.name==="id"||/^filter-/.test(i.name))||i instanceof us||i instanceof pn)return!1;let t=!0;return i.eachChild(r=>{t&&!qs(r)&&(t=!1)}),t}function $s(i){if(i instanceof kr&&i.name==="feature-state")return!1;let t=!0;return i.eachChild(r=>{t&&!$s(r)&&(t=!1)}),t}function Po(i,t){if(i instanceof kr&&t.indexOf(i.name)>=0)return!1;let r=!0;return i.eachChild(o=>{r&&!Po(o,t)&&(r=!1)}),r}function Ma(i){return{result:"success",value:i}}function Vn(i){return{result:"error",value:i}}function fs(i){return i["property-type"]==="data-driven"||i["property-type"]==="cross-faded-data-driven"}function ka(i){return!!i.expression&&i.expression.parameters.indexOf("zoom")>-1}function Bt(i){return!!i.expression&&i.expression.interpolated}function Ht(i){return i instanceof Number?"number":i instanceof String?"string":i instanceof Boolean?"boolean":Array.isArray(i)?"array":i===null?"null":typeof i}function Le(i){return typeof i=="object"&&i!==null&&!Array.isArray(i)}function hi(i){return i}function ar(i,t){const r=t.type==="color",o=i.stops&&typeof i.stops[0][0]=="object",f=o||!(o||i.property!==void 0),v=i.type||(Bt(t)?"exponential":"interval");if(r||t.type==="padding"){const B=r?Ri.parse:tn.parse;(i=Ti({},i)).stops&&(i.stops=i.stops.map(j=>[j[0],B(j[1])])),i.default=B(i.default?i.default:t.default)}if(i.colorSpace&&(x=i.colorSpace)!=="rgb"&&x!=="hcl"&&x!=="lab")throw new Error(`Unknown color space: "${i.colorSpace}"`);var x;let T,A,D;if(v==="exponential")T=mn;else if(v==="interval")T=br;else if(v==="categorical"){T=fr,A=Object.create(null);for(const B of i.stops)A[B[0]]=B[1];D=typeof i.stops[0][0]}else{if(v!=="identity")throw new Error(`Unknown function type "${v}"`);T=Pr}if(o){const B={},j=[];for(let J=0;J<i.stops.length;J++){const it=i.stops[J],dt=it[0].zoom;B[dt]===void 0&&(B[dt]={zoom:dt,type:i.type,property:i.property,default:i.default,stops:[]},j.push(dt)),B[dt].stops.push([it[0].value,it[1]])}const X=[];for(const J of j)X.push([B[J].zoom,ar(B[J],t)]);const q={name:"linear"};return{kind:"composite",interpolationType:q,interpolationFactor:Ni.interpolationFactor.bind(void 0,q),zoomStops:X.map(J=>J[0]),evaluate:({zoom:J},it)=>mn({stops:X,base:i.base},t,J).evaluate(J,it)}}if(f){const B=v==="exponential"?{name:"exponential",base:i.base!==void 0?i.base:1}:null;return{kind:"camera",interpolationType:B,interpolationFactor:Ni.interpolationFactor.bind(void 0,B),zoomStops:i.stops.map(j=>j[0]),evaluate:({zoom:j})=>T(i,t,j,A,D)}}return{kind:"source",evaluate(B,j){const X=j&&j.properties?j.properties[i.property]:void 0;return X===void 0?Pi(i.default,t.default):T(i,t,X,A,D)}}}function Pi(i,t,r){return i!==void 0?i:t!==void 0?t:r!==void 0?r:void 0}function fr(i,t,r,o,f){return Pi(typeof r===f?o[r]:void 0,i.default,t.default)}function br(i,t,r){if(Ht(r)!=="number")return Pi(i.default,t.default);const o=i.stops.length;if(o===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[o-1][0])return i.stops[o-1][1];const f=Rt(i.stops.map(v=>v[0]),r);return i.stops[f][1]}function mn(i,t,r){const o=i.base!==void 0?i.base:1;if(Ht(r)!=="number")return Pi(i.default,t.default);const f=i.stops.length;if(f===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[f-1][0])return i.stops[f-1][1];const v=Rt(i.stops.map(B=>B[0]),r),x=function(B,j,X,q){const J=q-X,it=B-X;return J===0?0:j===1?it/J:(Math.pow(j,it)-1)/(Math.pow(j,J)-1)}(r,o,i.stops[v][0],i.stops[v+1][0]),T=i.stops[v][1],A=i.stops[v+1][1],D=di[t.type]||hi;return typeof T.evaluate=="function"?{evaluate(...B){const j=T.evaluate.apply(void 0,B),X=A.evaluate.apply(void 0,B);if(j!==void 0&&X!==void 0)return D(j,X,x,i.colorSpace)}}:D(T,A,x,i.colorSpace)}function Pr(i,t,r){switch(t.type){case"color":r=Ri.parse(r);break;case"formatted":r=Xi.fromString(r.toString());break;case"resolvedImage":r=ur.fromString(r.toString());break;case"padding":r=tn.parse(r);break;default:Ht(r)===t.type||t.type==="enum"&&t.values[r]||(r=void 0)}return Pi(r,i.default,t.default)}kr.register(Is,{error:[{kind:"error"},[ui],(i,[t])=>{throw new Er(t.evaluate(i))}],typeof:[ui,[ii],(i,[t])=>H(sr(t.evaluate(i)))],"to-rgba":[W(Ee,4),[Zi],(i,[t])=>{const[r,o,f,v]=t.evaluate(i).rgb;return[255*r,255*o,255*f,v]}],rgb:[Zi,[Ee,Ee,Ee],Aa],rgba:[Zi,[Ee,Ee,Ee,Ee],Aa],has:{type:$e,overloads:[[[ui],(i,[t])=>Nn(t.evaluate(i),i.properties())],[[ui,Tr],(i,[t,r])=>Nn(t.evaluate(i),r.evaluate(i))]]},get:{type:ii,overloads:[[[ui],(i,[t])=>Jo(t.evaluate(i),i.properties())],[[ui,Tr],(i,[t,r])=>Jo(t.evaluate(i),r.evaluate(i))]]},"feature-state":[ii,[ui],(i,[t])=>Jo(t.evaluate(i),i.featureState||{})],properties:[Tr,[],i=>i.properties()],"geometry-type":[ui,[],i=>i.geometryType()],id:[ii,[],i=>i.id()],zoom:[Ee,[],i=>i.globals.zoom],"heatmap-density":[Ee,[],i=>i.globals.heatmapDensity||0],"line-progress":[Ee,[],i=>i.globals.lineProgress||0],accumulated:[ii,[],i=>i.globals.accumulated===void 0?null:i.globals.accumulated],"+":[Ee,As(Ee),(i,t)=>{let r=0;for(const o of t)r+=o.evaluate(i);return r}],"*":[Ee,As(Ee),(i,t)=>{let r=1;for(const o of t)r*=o.evaluate(i);return r}],"-":{type:Ee,overloads:[[[Ee,Ee],(i,[t,r])=>t.evaluate(i)-r.evaluate(i)],[[Ee],(i,[t])=>-t.evaluate(i)]]},"/":[Ee,[Ee,Ee],(i,[t,r])=>t.evaluate(i)/r.evaluate(i)],"%":[Ee,[Ee,Ee],(i,[t,r])=>t.evaluate(i)%r.evaluate(i)],ln2:[Ee,[],()=>Math.LN2],pi:[Ee,[],()=>Math.PI],e:[Ee,[],()=>Math.E],"^":[Ee,[Ee,Ee],(i,[t,r])=>Math.pow(t.evaluate(i),r.evaluate(i))],sqrt:[Ee,[Ee],(i,[t])=>Math.sqrt(t.evaluate(i))],log10:[Ee,[Ee],(i,[t])=>Math.log(t.evaluate(i))/Math.LN10],ln:[Ee,[Ee],(i,[t])=>Math.log(t.evaluate(i))],log2:[Ee,[Ee],(i,[t])=>Math.log(t.evaluate(i))/Math.LN2],sin:[Ee,[Ee],(i,[t])=>Math.sin(t.evaluate(i))],cos:[Ee,[Ee],(i,[t])=>Math.cos(t.evaluate(i))],tan:[Ee,[Ee],(i,[t])=>Math.tan(t.evaluate(i))],asin:[Ee,[Ee],(i,[t])=>Math.asin(t.evaluate(i))],acos:[Ee,[Ee],(i,[t])=>Math.acos(t.evaluate(i))],atan:[Ee,[Ee],(i,[t])=>Math.atan(t.evaluate(i))],min:[Ee,As(Ee),(i,t)=>Math.min(...t.map(r=>r.evaluate(i)))],max:[Ee,As(Ee),(i,t)=>Math.max(...t.map(r=>r.evaluate(i)))],abs:[Ee,[Ee],(i,[t])=>Math.abs(t.evaluate(i))],round:[Ee,[Ee],(i,[t])=>{const r=t.evaluate(i);return r<0?-Math.round(-r):Math.round(r)}],floor:[Ee,[Ee],(i,[t])=>Math.floor(t.evaluate(i))],ceil:[Ee,[Ee],(i,[t])=>Math.ceil(t.evaluate(i))],"filter-==":[$e,[ui,ii],(i,[t,r])=>i.properties()[t.value]===r.value],"filter-id-==":[$e,[ii],(i,[t])=>i.id()===t.value],"filter-type-==":[$e,[ui],(i,[t])=>i.geometryType()===t.value],"filter-<":[$e,[ui,ii],(i,[t,r])=>{const o=i.properties()[t.value],f=r.value;return typeof o==typeof f&&o<f}],"filter-id-<":[$e,[ii],(i,[t])=>{const r=i.id(),o=t.value;return typeof r==typeof o&&r<o}],"filter->":[$e,[ui,ii],(i,[t,r])=>{const o=i.properties()[t.value],f=r.value;return typeof o==typeof f&&o>f}],"filter-id->":[$e,[ii],(i,[t])=>{const r=i.id(),o=t.value;return typeof r==typeof o&&r>o}],"filter-<=":[$e,[ui,ii],(i,[t,r])=>{const o=i.properties()[t.value],f=r.value;return typeof o==typeof f&&o<=f}],"filter-id-<=":[$e,[ii],(i,[t])=>{const r=i.id(),o=t.value;return typeof r==typeof o&&r<=o}],"filter->=":[$e,[ui,ii],(i,[t,r])=>{const o=i.properties()[t.value],f=r.value;return typeof o==typeof f&&o>=f}],"filter-id->=":[$e,[ii],(i,[t])=>{const r=i.id(),o=t.value;return typeof r==typeof o&&r>=o}],"filter-has":[$e,[ii],(i,[t])=>t.value in i.properties()],"filter-has-id":[$e,[],i=>i.id()!==null&&i.id()!==void 0],"filter-type-in":[$e,[W(ui)],(i,[t])=>t.value.indexOf(i.geometryType())>=0],"filter-id-in":[$e,[W(ii)],(i,[t])=>t.value.indexOf(i.id())>=0],"filter-in-small":[$e,[ui,W(ii)],(i,[t,r])=>r.value.indexOf(i.properties()[t.value])>=0],"filter-in-large":[$e,[ui,W(ii)],(i,[t,r])=>function(o,f,v,x){for(;v<=x;){const T=v+x>>1;if(f[T]===o)return!0;f[T]>o?x=T-1:v=T+1}return!1}(i.properties()[t.value],r.value,0,r.value.length-1)],all:{type:$e,overloads:[[[$e,$e],(i,[t,r])=>t.evaluate(i)&&r.evaluate(i)],[As($e),(i,t)=>{for(const r of t)if(!r.evaluate(i))return!1;return!0}]]},any:{type:$e,overloads:[[[$e,$e],(i,[t,r])=>t.evaluate(i)||r.evaluate(i)],[As($e),(i,t)=>{for(const r of t)if(r.evaluate(i))return!0;return!1}]]},"!":[$e,[$e],(i,[t])=>!t.evaluate(i)],"is-supported-script":[$e,[ui],(i,[t])=>{const r=i.globals&&i.globals.isSupportedScript;return!r||r(t.evaluate(i))}],upcase:[ui,[ui],(i,[t])=>t.evaluate(i).toUpperCase()],downcase:[ui,[ui],(i,[t])=>t.evaluate(i).toLowerCase()],concat:[ui,As(ii),(i,t)=>t.map(r=>jn(r.evaluate(i))).join("")],"resolved-locale":[ui,[Oi],(i,[t])=>t.evaluate(i).resolvedLocale()]});class wr{constructor(t,r){var o;this.expression=t,this._warningHistory={},this._evaluator=new mo,this._defaultValue=r?(o=r).type==="color"&&Le(o.default)?new Ri(0,0,0,0):o.type==="color"?Ri.parse(o.default)||null:o.type==="padding"?tn.parse(o.default)||null:o.type==="variableAnchorOffsetCollection"?Mr.parse(o.default)||null:o.default===void 0?null:o.default:null,this._enumValues=r&&r.type==="enum"?r.values:null}evaluateWithoutErrorHandling(t,r,o,f,v,x){return this._evaluator.globals=t,this._evaluator.feature=r,this._evaluator.featureState=o,this._evaluator.canonical=f,this._evaluator.availableImages=v||null,this._evaluator.formattedSection=x,this.expression.evaluate(this._evaluator)}evaluate(t,r,o,f,v,x){this._evaluator.globals=t,this._evaluator.feature=r||null,this._evaluator.featureState=o||null,this._evaluator.canonical=f,this._evaluator.availableImages=v||null,this._evaluator.formattedSection=x||null;try{const T=this.expression.evaluate(this._evaluator);if(T==null||typeof T=="number"&&T!=T)return this._defaultValue;if(this._enumValues&&!(T in this._enumValues))throw new Er(`Expected value to be one of ${Object.keys(this._enumValues).map(A=>JSON.stringify(A)).join(", ")}, but found ${JSON.stringify(T)} instead.`);return T}catch(T){return this._warningHistory[T.message]||(this._warningHistory[T.message]=!0,typeof console<"u"&&console.warn(T.message)),this._defaultValue}}}function en(i){return Array.isArray(i)&&i.length>0&&typeof i[0]=="string"&&i[0]in Is}function Zr(i,t){const r=new hs(Is,Ms,[],t?function(f){const v={color:Zi,string:ui,number:Ee,enum:ui,boolean:$e,formatted:Wi,padding:Rr,resolvedImage:cr,variableAnchorOffsetCollection:_t};return f.type==="array"?W(v[f.value]||ii,f.length):v[f.type]}(t):void 0),o=r.parse(i,void 0,void 0,void 0,t&&t.type==="string"?{typeAnnotation:"coerce"}:void 0);return o?Ma(new wr(o,t)):Vn(r.errors)}class Vr{constructor(t,r){this.kind=t,this._styleExpression=r,this.isStateDependent=t!=="constant"&&!$s(r.expression)}evaluateWithoutErrorHandling(t,r,o,f,v,x){return this._styleExpression.evaluateWithoutErrorHandling(t,r,o,f,v,x)}evaluate(t,r,o,f,v,x){return this._styleExpression.evaluate(t,r,o,f,v,x)}}class Ln{constructor(t,r,o,f){this.kind=t,this.zoomStops=o,this._styleExpression=r,this.isStateDependent=t!=="camera"&&!$s(r.expression),this.interpolationType=f}evaluateWithoutErrorHandling(t,r,o,f,v,x){return this._styleExpression.evaluateWithoutErrorHandling(t,r,o,f,v,x)}evaluate(t,r,o,f,v,x){return this._styleExpression.evaluate(t,r,o,f,v,x)}interpolationFactor(t,r,o){return this.interpolationType?Ni.interpolationFactor(this.interpolationType,t,r,o):0}}function ks(i,t){const r=Zr(i,t);if(r.result==="error")return r;const o=r.value.expression,f=qs(o);if(!f&&!fs(t))return Vn([new zi("","data expressions not supported")]);const v=Po(o,["zoom"]);if(!v&&!ka(t))return Vn([new zi("","zoom expressions not supported")]);const x=Kn(o);return x||v?x instanceof zi?Vn([x]):x instanceof Ni&&!Bt(t)?Vn([new zi("",'"interpolate" expressions cannot be used with this property')]):Ma(x?new Ln(f?"camera":"composite",r.value,x.labels,x instanceof Ni?x.interpolation:void 0):new Vr(f?"constant":"source",r.value)):Vn([new zi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Os{constructor(t,r){this._parameters=t,this._specification=r,Ti(this,ar(this._parameters,this._specification))}static deserialize(t){return new Os(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function Kn(i){let t=null;if(i instanceof Bi)t=Kn(i.result);else if(i instanceof ri){for(const r of i.args)if(t=Kn(r),t)break}else(i instanceof xe||i instanceof Ni)&&i.input instanceof kr&&i.input.name==="zoom"&&(t=i);return t instanceof zi||i.eachChild(r=>{const o=Kn(r);o instanceof zi?t=o:!t&&o?t=new zi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):t&&o&&t!==o&&(t=new zi("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}function Un(i){if(i===!0||i===!1)return!0;if(!Array.isArray(i)||i.length===0)return!1;switch(i[0]){case"has":return i.length>=2&&i[1]!=="$id"&&i[1]!=="$type";case"in":return i.length>=3&&(typeof i[1]!="string"||Array.isArray(i[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return i.length!==3||Array.isArray(i[1])||Array.isArray(i[2]);case"any":case"all":for(const t of i.slice(1))if(!Un(t)&&typeof t!="boolean")return!1;return!0;default:return!0}}const Io={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function Kr(i){if(i==null)return{filter:()=>!0,needGeometry:!1};Un(i)||(i=Vi(i));const t=Zr(i,Io);if(t.result==="error")throw new Error(t.value.map(r=>`${r.key}: ${r.message}`).join(", "));return{filter:(r,o,f)=>t.value.evaluate(r,o,{},f),needGeometry:Ki(i)}}function Ao(i,t){return i<t?-1:i>t?1:0}function Ki(i){if(!Array.isArray(i))return!1;if(i[0]==="within"||i[0]==="distance")return!0;for(let t=1;t<i.length;t++)if(Ki(i[t]))return!0;return!1}function Vi(i){if(!i)return!0;const t=i[0];return i.length<=1?t!=="any":t==="=="?Ys(i[1],i[2],"=="):t==="!="?Ur(Ys(i[1],i[2],"==")):t==="<"||t===">"||t==="<="||t===">="?Ys(i[1],i[2],t):t==="any"?(r=i.slice(1),["any"].concat(r.map(Vi))):t==="all"?["all"].concat(i.slice(1).map(Vi)):t==="none"?["all"].concat(i.slice(1).map(Vi).map(Ur)):t==="in"?gn(i[1],i.slice(2)):t==="!in"?Ur(gn(i[1],i.slice(2))):t==="has"?Mo(i[1]):t!=="!has"||Ur(Mo(i[1]));var r}function Ys(i,t,r){switch(i){case"$type":return[`filter-type-${r}`,t];case"$id":return[`filter-id-${r}`,t];default:return[`filter-${r}`,i,t]}}function gn(i,t){if(t.length===0)return!1;switch(i){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(r=>typeof r!=typeof t[0])?["filter-in-large",i,["literal",t.sort(Ao)]]:["filter-in-small",i,["literal",t]]}}function Mo(i){switch(i){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",i]}}function Ur(i){return["!",i]}function zn(i){const t=typeof i;if(t==="number"||t==="boolean"||t==="string"||i==null)return JSON.stringify(i);if(Array.isArray(i)){let f="[";for(const v of i)f+=`${zn(v)},`;return`${f}]`}const r=Object.keys(i).sort();let o="{";for(let f=0;f<r.length;f++)o+=`${JSON.stringify(r[f])}:${zn(i[r[f]])},`;return`${o}}`}function Gn(i){let t="";for(const r of Zt)t+=`/${zn(i[r])}`;return t}function Zs(i){const t=i.value;return t?[new ce(i.key,t,"constants have been deprecated as of v8")]:[]}function Ji(i){return i instanceof Number||i instanceof String||i instanceof Boolean?i.valueOf():i}function wn(i){if(Array.isArray(i))return i.map(wn);if(i instanceof Object&&!(i instanceof Number||i instanceof String||i instanceof Boolean)){const t={};for(const r in i)t[r]=wn(i[r]);return t}return Ji(i)}function Or(i){const t=i.key,r=i.value,o=i.valueSpec||{},f=i.objectElementValidators||{},v=i.style,x=i.styleSpec,T=i.validateSpec;let A=[];const D=Ht(r);if(D!=="object")return[new ce(t,r,`object expected, ${D} found`)];for(const B in r){const j=B.split(".")[0],X=o[j]||o["*"];let q;if(f[j])q=f[j];else if(o[j])q=T;else if(f["*"])q=f["*"];else{if(!o["*"]){A.push(new ce(t,r[B],`unknown property "${B}"`));continue}q=T}A=A.concat(q({key:(t&&`${t}.`)+B,value:r[B],valueSpec:X,style:v,styleSpec:x,object:r,objectKey:B,validateSpec:T},r))}for(const B in o)f[B]||o[B].required&&o[B].default===void 0&&r[B]===void 0&&A.push(new ce(t,r,`missing required property "${B}"`));return A}function ko(i){const t=i.value,r=i.valueSpec,o=i.style,f=i.styleSpec,v=i.key,x=i.arrayElementValidator||i.validateSpec;if(Ht(t)!=="array")return[new ce(v,t,`array expected, ${Ht(t)} found`)];if(r.length&&t.length!==r.length)return[new ce(v,t,`array length ${r.length} expected, length ${t.length} found`)];if(r["min-length"]&&t.length<r["min-length"])return[new ce(v,t,`array length at least ${r["min-length"]} expected, length ${t.length} found`)];let T={type:r.value,values:r.values};f.$version<7&&(T.function=r.function),Ht(r.value)==="object"&&(T=r.value);let A=[];for(let D=0;D<t.length;D++)A=A.concat(x({array:t,arrayIndex:D,value:t[D],valueSpec:T,validateSpec:i.validateSpec,style:o,styleSpec:f,key:`${v}[${D}]`}));return A}function ps(i){const t=i.key,r=i.value,o=i.valueSpec;let f=Ht(r);return f==="number"&&r!=r&&(f="NaN"),f!=="number"?[new ce(t,r,`number expected, ${f} found`)]:"minimum"in o&&r<o.minimum?[new ce(t,r,`${r} is less than the minimum value ${o.minimum}`)]:"maximum"in o&&r>o.maximum?[new ce(t,r,`${r} is greater than the maximum value ${o.maximum}`)]:[]}function Oo(i){const t=i.valueSpec,r=Ji(i.value.type);let o,f,v,x={};const T=r!=="categorical"&&i.value.property===void 0,A=!T,D=Ht(i.value.stops)==="array"&&Ht(i.value.stops[0])==="array"&&Ht(i.value.stops[0][0])==="object",B=Or({key:i.key,value:i.value,valueSpec:i.styleSpec.function,validateSpec:i.validateSpec,style:i.style,styleSpec:i.styleSpec,objectElementValidators:{stops:function(q){if(r==="identity")return[new ce(q.key,q.value,'identity function may not have a "stops" property')];let J=[];const it=q.value;return J=J.concat(ko({key:q.key,value:it,valueSpec:q.valueSpec,validateSpec:q.validateSpec,style:q.style,styleSpec:q.styleSpec,arrayElementValidator:j})),Ht(it)==="array"&&it.length===0&&J.push(new ce(q.key,it,"array must have at least one stop")),J},default:function(q){return q.validateSpec({key:q.key,value:q.value,valueSpec:t,validateSpec:q.validateSpec,style:q.style,styleSpec:q.styleSpec})}}});return r==="identity"&&T&&B.push(new ce(i.key,i.value,'missing required property "property"')),r==="identity"||i.value.stops||B.push(new ce(i.key,i.value,'missing required property "stops"')),r==="exponential"&&i.valueSpec.expression&&!Bt(i.valueSpec)&&B.push(new ce(i.key,i.value,"exponential functions not supported")),i.styleSpec.$version>=8&&(A&&!fs(i.valueSpec)?B.push(new ce(i.key,i.value,"property functions not supported")):T&&!ka(i.valueSpec)&&B.push(new ce(i.key,i.value,"zoom functions not supported"))),r!=="categorical"&&!D||i.value.property!==void 0||B.push(new ce(i.key,i.value,'"property" property is required')),B;function j(q){let J=[];const it=q.value,dt=q.key;if(Ht(it)!=="array")return[new ce(dt,it,`array expected, ${Ht(it)} found`)];if(it.length!==2)return[new ce(dt,it,`array length 2 expected, length ${it.length} found`)];if(D){if(Ht(it[0])!=="object")return[new ce(dt,it,`object expected, ${Ht(it[0])} found`)];if(it[0].zoom===void 0)return[new ce(dt,it,"object stop key must have zoom")];if(it[0].value===void 0)return[new ce(dt,it,"object stop key must have value")];if(v&&v>Ji(it[0].zoom))return[new ce(dt,it[0].zoom,"stop zoom values must appear in ascending order")];Ji(it[0].zoom)!==v&&(v=Ji(it[0].zoom),f=void 0,x={}),J=J.concat(Or({key:`${dt}[0]`,value:it[0],valueSpec:{zoom:{}},validateSpec:q.validateSpec,style:q.style,styleSpec:q.styleSpec,objectElementValidators:{zoom:ps,value:X}}))}else J=J.concat(X({key:`${dt}[0]`,value:it[0],valueSpec:{},validateSpec:q.validateSpec,style:q.style,styleSpec:q.styleSpec},it));return en(wn(it[1]))?J.concat([new ce(`${dt}[1]`,it[1],"expressions are not allowed in function stops.")]):J.concat(q.validateSpec({key:`${dt}[1]`,value:it[1],valueSpec:t,validateSpec:q.validateSpec,style:q.style,styleSpec:q.styleSpec}))}function X(q,J){const it=Ht(q.value),dt=Ji(q.value),Ct=q.value!==null?q.value:J;if(o){if(it!==o)return[new ce(q.key,Ct,`${it} stop domain type must match previous stop domain type ${o}`)]}else o=it;if(it!=="number"&&it!=="string"&&it!=="boolean")return[new ce(q.key,Ct,"stop domain value must be a number, string, or boolean")];if(it!=="number"&&r!=="categorical"){let Gt=`number expected, ${it} found`;return fs(t)&&r===void 0&&(Gt+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new ce(q.key,Ct,Gt)]}return r!=="categorical"||it!=="number"||isFinite(dt)&&Math.floor(dt)===dt?r!=="categorical"&&it==="number"&&f!==void 0&&dt<f?[new ce(q.key,Ct,"stop domain values must appear in ascending order")]:(f=dt,r==="categorical"&&dt in x?[new ce(q.key,Ct,"stop domain values must be unique")]:(x[dt]=!0,[])):[new ce(q.key,Ct,`integer expected, found ${dt}`)]}}function Xn(i){const t=(i.expressionContext==="property"?ks:Zr)(wn(i.value),i.valueSpec);if(t.result==="error")return t.value.map(o=>new ce(`${i.key}${o.key}`,i.value,o.message));const r=t.value.expression||t.value._styleExpression.expression;if(i.expressionContext==="property"&&i.propertyKey==="text-font"&&!r.outputDefined())return[new ce(i.key,i.value,`Invalid data expression for "${i.propertyKey}". Output values must be contained as literals within the expression.`)];if(i.expressionContext==="property"&&i.propertyType==="layout"&&!$s(r))return[new ce(i.key,i.value,'"feature-state" data expressions are not supported with layout properties.')];if(i.expressionContext==="filter"&&!$s(r))return[new ce(i.key,i.value,'"feature-state" data expressions are not supported with filters.')];if(i.expressionContext&&i.expressionContext.indexOf("cluster")===0){if(!Po(r,["zoom","feature-state"]))return[new ce(i.key,i.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(i.expressionContext==="cluster-initial"&&!qs(r))return[new ce(i.key,i.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ms(i){const t=i.key,r=i.value,o=i.valueSpec,f=[];return Array.isArray(o.values)?o.values.indexOf(Ji(r))===-1&&f.push(new ce(t,r,`expected one of [${o.values.join(", ")}], ${JSON.stringify(r)} found`)):Object.keys(o.values).indexOf(Ji(r))===-1&&f.push(new ce(t,r,`expected one of [${Object.keys(o.values).join(", ")}], ${JSON.stringify(r)} found`)),f}function Ks(i){return Un(wn(i.value))?Xn(Ti({},i,{expressionContext:"filter",valueSpec:{value:"boolean"}})):gs(i)}function gs(i){const t=i.value,r=i.key;if(Ht(t)!=="array")return[new ce(r,t,`array expected, ${Ht(t)} found`)];const o=i.styleSpec;let f,v=[];if(t.length<1)return[new ce(r,t,"filter array must have at least 1 element")];switch(v=v.concat(ms({key:`${r}[0]`,value:t[0],valueSpec:o.filter_operator,style:i.style,styleSpec:i.styleSpec})),Ji(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&Ji(t[1])==="$type"&&v.push(new ce(r,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&v.push(new ce(r,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(f=Ht(t[1]),f!=="string"&&v.push(new ce(`${r}[1]`,t[1],`string expected, ${f} found`)));for(let x=2;x<t.length;x++)f=Ht(t[x]),Ji(t[1])==="$type"?v=v.concat(ms({key:`${r}[${x}]`,value:t[x],valueSpec:o.geometry_type,style:i.style,styleSpec:i.styleSpec})):f!=="string"&&f!=="number"&&f!=="boolean"&&v.push(new ce(`${r}[${x}]`,t[x],`string, number, or boolean expected, ${f} found`));break;case"any":case"all":case"none":for(let x=1;x<t.length;x++)v=v.concat(gs({key:`${r}[${x}]`,value:t[x],style:i.style,styleSpec:i.styleSpec}));break;case"has":case"!has":f=Ht(t[1]),t.length!==2?v.push(new ce(r,t,`filter array for "${t[0]}" operator must have 2 elements`)):f!=="string"&&v.push(new ce(`${r}[1]`,t[1],`string expected, ${f} found`))}return v}function Js(i,t){const r=i.key,o=i.validateSpec,f=i.style,v=i.styleSpec,x=i.value,T=i.objectKey,A=v[`${t}_${i.layerType}`];if(!A)return[];const D=T.match(/^(.*)-transition$/);if(t==="paint"&&D&&A[D[1]]&&A[D[1]].transition)return o({key:r,value:x,valueSpec:v.transition,style:f,styleSpec:v});const B=i.valueSpec||A[T];if(!B)return[new ce(r,x,`unknown property "${T}"`)];let j;if(Ht(x)==="string"&&fs(B)&&!B.tokens&&(j=/^{([^}]+)}$/.exec(x)))return[new ce(r,x,`"${T}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(j[1])} }\`.`)];const X=[];return i.layerType==="symbol"&&(T==="text-field"&&f&&!f.glyphs&&X.push(new ce(r,x,'use of "text-field" requires a style "glyphs" property')),T==="text-font"&&Le(wn(x))&&Ji(x.type)==="identity"&&X.push(new ce(r,x,'"text-font" does not support identity functions'))),X.concat(o({key:i.key,value:x,valueSpec:B,style:f,styleSpec:v,expressionContext:"property",propertyType:t,propertyKey:T}))}function Ml(i){return Js(i,"paint")}function kl(i){return Js(i,"layout")}function Ol(i){let t=[];const r=i.value,o=i.key,f=i.style,v=i.styleSpec;r.type||r.ref||t.push(new ce(o,r,'either "type" or "ref" is required'));let x=Ji(r.type);const T=Ji(r.ref);if(r.id){const A=Ji(r.id);for(let D=0;D<i.arrayIndex;D++){const B=f.layers[D];Ji(B.id)===A&&t.push(new ce(o,r.id,`duplicate layer id "${r.id}", previously used at line ${B.id.__line__}`))}}if("ref"in r){let A;["type","source","source-layer","filter","layout"].forEach(D=>{D in r&&t.push(new ce(o,r[D],`"${D}" is prohibited for ref layers`))}),f.layers.forEach(D=>{Ji(D.id)===T&&(A=D)}),A?A.ref?t.push(new ce(o,r.ref,"ref cannot reference another ref layer")):x=Ji(A.type):t.push(new ce(o,r.ref,`ref layer "${T}" not found`))}else if(x!=="background")if(r.source){const A=f.sources&&f.sources[r.source],D=A&&Ji(A.type);A?D==="vector"&&x==="raster"?t.push(new ce(o,r.source,`layer "${r.id}" requires a raster source`)):D!=="raster-dem"&&x==="hillshade"?t.push(new ce(o,r.source,`layer "${r.id}" requires a raster-dem source`)):D==="raster"&&x!=="raster"?t.push(new ce(o,r.source,`layer "${r.id}" requires a vector source`)):D!=="vector"||r["source-layer"]?D==="raster-dem"&&x!=="hillshade"?t.push(new ce(o,r.source,"raster-dem source can only be used with layer type 'hillshade'.")):x!=="line"||!r.paint||!r.paint["line-gradient"]||D==="geojson"&&A.lineMetrics||t.push(new ce(o,r,`layer "${r.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new ce(o,r,`layer "${r.id}" must specify a "source-layer"`)):t.push(new ce(o,r.source,`source "${r.source}" not found`))}else t.push(new ce(o,r,'missing required property "source"'));return t=t.concat(Or({key:o,value:r,valueSpec:v.layer,style:i.style,styleSpec:i.styleSpec,validateSpec:i.validateSpec,objectElementValidators:{"*":()=>[],type:()=>i.validateSpec({key:`${o}.type`,value:r.type,valueSpec:v.layer.type,style:i.style,styleSpec:i.styleSpec,validateSpec:i.validateSpec,object:r,objectKey:"type"}),filter:Ks,layout:A=>Or({layer:r,key:A.key,value:A.value,style:A.style,styleSpec:A.styleSpec,validateSpec:A.validateSpec,objectElementValidators:{"*":D=>kl(Ti({layerType:x},D))}}),paint:A=>Or({layer:r,key:A.key,value:A.value,style:A.style,styleSpec:A.styleSpec,validateSpec:A.validateSpec,objectElementValidators:{"*":D=>Ml(Ti({layerType:x},D))}})}})),t}function Ds(i){const t=i.value,r=i.key,o=Ht(t);return o!=="string"?[new ce(r,t,`string expected, ${o} found`)]:[]}const Dl={promoteId:function({key:i,value:t}){if(Ht(t)==="string")return Ds({key:i,value:t});{const r=[];for(const o in t)r.push(...Ds({key:`${i}.${o}`,value:t[o]}));return r}}};function gc(i){const t=i.value,r=i.key,o=i.styleSpec,f=i.style,v=i.validateSpec;if(!t.type)return[new ce(r,t,'"type" is required')];const x=Ji(t.type);let T;switch(x){case"vector":case"raster":return T=Or({key:r,value:t,valueSpec:o[`source_${x.replace("-","_")}`],style:i.style,styleSpec:o,objectElementValidators:Dl,validateSpec:v}),T;case"raster-dem":return T=function(A){var D;const B=(D=A.sourceName)!==null&&D!==void 0?D:"",j=A.value,X=A.styleSpec,q=X.source_raster_dem,J=A.style;let it=[];const dt=Ht(j);if(j===void 0)return it;if(dt!=="object")return it.push(new ce("source_raster_dem",j,`object expected, ${dt} found`)),it;const Ct=Ji(j.encoding)==="custom",Gt=["redFactor","greenFactor","blueFactor","baseShift"],At=A.value.encoding?`"${A.value.encoding}"`:"Default";for(const Nt in j)!Ct&&Gt.includes(Nt)?it.push(new ce(Nt,j[Nt],`In "${B}": "${Nt}" is only valid when "encoding" is set to "custom". ${At} encoding found`)):q[Nt]?it=it.concat(A.validateSpec({key:Nt,value:j[Nt],valueSpec:q[Nt],validateSpec:A.validateSpec,style:J,styleSpec:X})):it.push(new ce(Nt,j[Nt],`unknown property "${Nt}"`));return it}({sourceName:r,value:t,style:i.style,styleSpec:o,validateSpec:v}),T;case"geojson":if(T=Or({key:r,value:t,valueSpec:o.source_geojson,style:f,styleSpec:o,validateSpec:v,objectElementValidators:Dl}),t.cluster)for(const A in t.clusterProperties){const[D,B]=t.clusterProperties[A],j=typeof D=="string"?[D,["accumulated"],["get",A]]:D;T.push(...Xn({key:`${r}.${A}.map`,value:B,validateSpec:v,expressionContext:"cluster-map"})),T.push(...Xn({key:`${r}.${A}.reduce`,value:j,validateSpec:v,expressionContext:"cluster-reduce"}))}return T;case"video":return Or({key:r,value:t,valueSpec:o.source_video,style:f,validateSpec:v,styleSpec:o});case"image":return Or({key:r,value:t,valueSpec:o.source_image,style:f,validateSpec:v,styleSpec:o});case"canvas":return[new ce(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return ms({key:`${r}.type`,value:t.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:f,validateSpec:v,styleSpec:o})}}function Ll(i){const t=i.value,r=i.styleSpec,o=r.light,f=i.style;let v=[];const x=Ht(t);if(t===void 0)return v;if(x!=="object")return v=v.concat([new ce("light",t,`object expected, ${x} found`)]),v;for(const T in t){const A=T.match(/^(.*)-transition$/);v=v.concat(A&&o[A[1]]&&o[A[1]].transition?i.validateSpec({key:T,value:t[T],valueSpec:r.transition,validateSpec:i.validateSpec,style:f,styleSpec:r}):o[T]?i.validateSpec({key:T,value:t[T],valueSpec:o[T],validateSpec:i.validateSpec,style:f,styleSpec:r}):[new ce(T,t[T],`unknown property "${T}"`)])}return v}function _c(i){const t=i.value,r=i.styleSpec,o=r.sky,f=i.style,v=Ht(t);if(t===void 0)return[];if(v!=="object")return[new ce("sky",t,`object expected, ${v} found`)];let x=[];for(const T in t)x=x.concat(o[T]?i.validateSpec({key:T,value:t[T],valueSpec:o[T],style:f,styleSpec:r}):[new ce(T,t[T],`unknown property "${T}"`)]);return x}function zl(i){const t=i.value,r=i.styleSpec,o=r.terrain,f=i.style;let v=[];const x=Ht(t);if(t===void 0)return v;if(x!=="object")return v=v.concat([new ce("terrain",t,`object expected, ${x} found`)]),v;for(const T in t)v=v.concat(o[T]?i.validateSpec({key:T,value:t[T],valueSpec:o[T],validateSpec:i.validateSpec,style:f,styleSpec:r}):[new ce(T,t[T],`unknown property "${T}"`)]);return v}function Fl(i){let t=[];const r=i.value,o=i.key;if(Array.isArray(r)){const f=[],v=[];for(const x in r)r[x].id&&f.includes(r[x].id)&&t.push(new ce(o,r,`all the sprites' ids must be unique, but ${r[x].id} is duplicated`)),f.push(r[x].id),r[x].url&&v.includes(r[x].url)&&t.push(new ce(o,r,`all the sprites' URLs must be unique, but ${r[x].url} is duplicated`)),v.push(r[x].url),t=t.concat(Or({key:`${o}[${x}]`,value:r[x],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:i.validateSpec}));return t}return Ds({key:o,value:r})}const Rl={"*":()=>[],array:ko,boolean:function(i){const t=i.value,r=i.key,o=Ht(t);return o!=="boolean"?[new ce(r,t,`boolean expected, ${o} found`)]:[]},number:ps,color:function(i){const t=i.key,r=i.value,o=Ht(r);return o!=="string"?[new ce(t,r,`color expected, ${o} found`)]:Ri.parse(String(r))?[]:[new ce(t,r,`color expected, "${r}" found`)]},constants:Zs,enum:ms,filter:Ks,function:Oo,layer:Ol,object:Or,source:gc,light:Ll,sky:_c,terrain:zl,projection:function(i){const t=i.value,r=i.styleSpec,o=r.projection,f=i.style,v=Ht(t);if(t===void 0)return[];if(v!=="object")return[new ce("projection",t,`object expected, ${v} found`)];let x=[];for(const T in t)x=x.concat(o[T]?i.validateSpec({key:T,value:t[T],valueSpec:o[T],style:f,styleSpec:r}):[new ce(T,t[T],`unknown property "${T}"`)]);return x},string:Ds,formatted:function(i){return Ds(i).length===0?[]:Xn(i)},resolvedImage:function(i){return Ds(i).length===0?[]:Xn(i)},padding:function(i){const t=i.key,r=i.value;if(Ht(r)==="array"){if(r.length<1||r.length>4)return[new ce(t,r,`padding requires 1 to 4 values; ${r.length} values found`)];const o={type:"number"};let f=[];for(let v=0;v<r.length;v++)f=f.concat(i.validateSpec({key:`${t}[${v}]`,value:r[v],validateSpec:i.validateSpec,valueSpec:o}));return f}return ps({key:t,value:r,valueSpec:{}})},variableAnchorOffsetCollection:function(i){const t=i.key,r=i.value,o=Ht(r),f=i.styleSpec;if(o!=="array"||r.length<1||r.length%2!=0)return[new ce(t,r,"variableAnchorOffsetCollection requires a non-empty array of even length")];let v=[];for(let x=0;x<r.length;x+=2)v=v.concat(ms({key:`${t}[${x}]`,value:r[x],valueSpec:f.layout_symbol["text-anchor"]})),v=v.concat(ko({key:`${t}[${x+1}]`,value:r[x+1],valueSpec:{length:2,value:"number"},validateSpec:i.validateSpec,style:i.style,styleSpec:f}));return v},sprite:Fl};function Oa(i){const t=i.value,r=i.valueSpec,o=i.styleSpec;return i.validateSpec=Oa,r.expression&&Le(Ji(t))?Oo(i):r.expression&&en(wn(t))?Xn(i):r.type&&Rl[r.type]?Rl[r.type](i):Or(Ti({},i,{valueSpec:r.type?o[r.type]:r}))}function yc(i){const t=i.value,r=i.key,o=Ds(i);return o.length||(t.indexOf("{fontstack}")===-1&&o.push(new ce(r,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&o.push(new ce(r,t,'"glyphs" url must include a "{range}" token'))),o}function Wn(i,t=at){let r=[];return r=r.concat(Oa({key:"",value:i,valueSpec:t.$root,styleSpec:t,style:i,validateSpec:Oa,objectElementValidators:{glyphs:yc,"*":()=>[]}})),i.constants&&(r=r.concat(Zs({key:"constants",value:i.constants,style:i,styleSpec:t,validateSpec:Oa}))),Bl(r)}function Jn(i){return function(t){return i({...t,validateSpec:Oa})}}function Bl(i){return[].concat(i).sort((t,r)=>t.line-r.line)}function Qn(i){return function(...t){return Bl(i.apply(this,t))}}Wn.source=Qn(Jn(gc)),Wn.sprite=Qn(Jn(Fl)),Wn.glyphs=Qn(Jn(yc)),Wn.light=Qn(Jn(Ll)),Wn.sky=Qn(Jn(_c)),Wn.terrain=Qn(Jn(zl)),Wn.layer=Qn(Jn(Ol)),Wn.filter=Qn(Jn(Ks)),Wn.paintProperty=Qn(Jn(Ml)),Wn.layoutProperty=Qn(Jn(kl));const Ls=Wn,nh=Ls.light,jl=Ls.sky,sh=Ls.paintProperty,oh=Ls.layoutProperty;function Nl(i,t){let r=!1;if(t&&t.length)for(const o of t)i.fire(new Lt(new Error(o.message))),r=!0;return r}class Qo{constructor(t,r,o){const f=this.cells=[];if(t instanceof ArrayBuffer){this.arrayBuffer=t;const x=new Int32Array(this.arrayBuffer);t=x[0],this.d=(r=x[1])+2*(o=x[2]);for(let A=0;A<this.d*this.d;A++){const D=x[3+A],B=x[3+A+1];f.push(D===B?null:x.subarray(D,B))}const T=x[3+f.length+1];this.keys=x.subarray(x[3+f.length],T),this.bboxes=x.subarray(T),this.insert=this._insertReadonly}else{this.d=r+2*o;for(let x=0;x<this.d*this.d;x++)f.push([]);this.keys=[],this.bboxes=[]}this.n=r,this.extent=t,this.padding=o,this.scale=r/t,this.uid=0;const v=o/r*t;this.min=-v,this.max=t+v}insert(t,r,o,f,v){this._forEachCell(r,o,f,v,this._insertCell,this.uid++,void 0,void 0),this.keys.push(t),this.bboxes.push(r),this.bboxes.push(o),this.bboxes.push(f),this.bboxes.push(v)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(t,r,o,f,v,x){this.cells[v].push(x)}query(t,r,o,f,v){const x=this.min,T=this.max;if(t<=x&&r<=x&&T<=o&&T<=f&&!v)return Array.prototype.slice.call(this.keys);{const A=[];return this._forEachCell(t,r,o,f,this._queryCell,A,{},v),A}}_queryCell(t,r,o,f,v,x,T,A){const D=this.cells[v];if(D!==null){const B=this.keys,j=this.bboxes;for(let X=0;X<D.length;X++){const q=D[X];if(T[q]===void 0){const J=4*q;(A?A(j[J+0],j[J+1],j[J+2],j[J+3]):t<=j[J+2]&&r<=j[J+3]&&o>=j[J+0]&&f>=j[J+1])?(T[q]=!0,x.push(B[q])):T[q]=!1}}}}_forEachCell(t,r,o,f,v,x,T,A){const D=this._convertToCellCoord(t),B=this._convertToCellCoord(r),j=this._convertToCellCoord(o),X=this._convertToCellCoord(f);for(let q=D;q<=j;q++)for(let J=B;J<=X;J++){const it=this.d*J+q;if((!A||A(this._convertFromCellCoord(q),this._convertFromCellCoord(J),this._convertFromCellCoord(q+1),this._convertFromCellCoord(J+1)))&&v.call(this,t,r,o,f,it,x,T,A))return}}_convertFromCellCoord(t){return(t-this.padding)/this.scale}_convertToCellCoord(t){return Math.max(0,Math.min(this.d-1,Math.floor(t*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const t=this.cells,r=3+this.cells.length+1+1;let o=0;for(let x=0;x<this.cells.length;x++)o+=this.cells[x].length;const f=new Int32Array(r+o+this.keys.length+this.bboxes.length);f[0]=this.extent,f[1]=this.n,f[2]=this.padding;let v=r;for(let x=0;x<t.length;x++){const T=t[x];f[3+x]=v,f.set(T,v),v+=T.length}return f[3+t.length]=v,f.set(this.keys,v),v+=this.keys.length,f[3+t.length+1]=v,f.set(this.bboxes,v),v+=this.bboxes.length,f.buffer}static serialize(t,r){const o=t.toArrayBuffer();return r&&r.push(o),{buffer:o}}static deserialize(t){return new Qo(t.buffer)}}const _s={};function Ze(i,t,r={}){if(_s[i])throw new Error(`${i} is already registered.`);Object.defineProperty(t,"_classRegistryKey",{value:i,writeable:!1}),_s[i]={klass:t,omit:r.omit||[],shallow:r.shallow||[]}}Ze("Object",Object),Ze("TransferableGridIndex",Qo),Ze("Color",Ri),Ze("Error",Error),Ze("AJAXError",jt),Ze("ResolvedImage",ur),Ze("StylePropertyFunction",Os),Ze("StyleExpression",wr,{omit:["_evaluator"]}),Ze("ZoomDependentExpression",Ln),Ze("ZoomConstantExpression",Vr),Ze("CompoundExpression",kr,{omit:["_evaluate"]});for(const i in Is)Is[i]._classRegistryKey||Ze(`Expression_${i}`,Is[i]);function vc(i){return i&&typeof ArrayBuffer<"u"&&(i instanceof ArrayBuffer||i.constructor&&i.constructor.name==="ArrayBuffer")}function Vl(i){return i.$name||i.constructor._classRegistryKey}function xc(i){return!function(t){if(t===null||typeof t!="object")return!1;const r=Vl(t);return!(!r||r==="Object")}(i)&&(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||i instanceof Blob||i instanceof Error||vc(i)||se(i)||ArrayBuffer.isView(i)||i instanceof ImageData)}function Da(i,t){if(xc(i))return(vc(i)||se(i))&&t&&t.push(i),ArrayBuffer.isView(i)&&t&&t.push(i.buffer),i instanceof ImageData&&t&&t.push(i.data.buffer),i;if(Array.isArray(i)){const v=[];for(const x of i)v.push(Da(x,t));return v}if(typeof i!="object")throw new Error("can't serialize object of type "+typeof i);const r=Vl(i);if(!r)throw new Error(`can't serialize object of unregistered class ${i.constructor.name}`);if(!_s[r])throw new Error(`${r} is not registered.`);const{klass:o}=_s[r],f=o.serialize?o.serialize(i,t):{};if(o.serialize){if(t&&f===t[t.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const v in i){if(!i.hasOwnProperty(v)||_s[r].omit.indexOf(v)>=0)continue;const x=i[v];f[v]=_s[r].shallow.indexOf(v)>=0?x:Da(x,t)}i instanceof Error&&(f.message=i.message)}if(f.$name)throw new Error("$name property is reserved for worker serialization logic.");return r!=="Object"&&(f.$name=r),f}function ys(i){if(xc(i))return i;if(Array.isArray(i))return i.map(ys);if(typeof i!="object")throw new Error("can't deserialize object of type "+typeof i);const t=Vl(i)||"Object";if(!_s[t])throw new Error(`can't deserialize unregistered class ${t}`);const{klass:r}=_s[t];if(!r)throw new Error(`can't deserialize unregistered class ${t}`);if(r.deserialize)return r.deserialize(i);const o=Object.create(r.prototype);for(const f of Object.keys(i)){if(f==="$name")continue;const v=i[f];o[f]=_s[t].shallow.indexOf(f)>=0?v:ys(v)}return o}class bc{constructor(){this.first=!0}update(t,r){const o=Math.floor(t);return this.first?(this.first=!1,this.lastIntegerZoom=o,this.lastIntegerZoomTime=0,this.lastZoom=t,this.lastFloorZoom=o,!0):(this.lastFloorZoom>o?(this.lastIntegerZoom=o+1,this.lastIntegerZoomTime=r):this.lastFloorZoom<o&&(this.lastIntegerZoom=o,this.lastIntegerZoomTime=r),t!==this.lastZoom&&(this.lastZoom=t,this.lastFloorZoom=o,!0))}}const Ge={"Latin-1 Supplement":i=>i>=128&&i<=255,Arabic:i=>i>=1536&&i<=1791,"Arabic Supplement":i=>i>=1872&&i<=1919,"Arabic Extended-A":i=>i>=2208&&i<=2303,"Hangul Jamo":i=>i>=4352&&i<=4607,"Unified Canadian Aboriginal Syllabics":i=>i>=5120&&i<=5759,Khmer:i=>i>=6016&&i<=6143,"Unified Canadian Aboriginal Syllabics Extended":i=>i>=6320&&i<=6399,"General Punctuation":i=>i>=8192&&i<=8303,"Letterlike Symbols":i=>i>=8448&&i<=8527,"Number Forms":i=>i>=8528&&i<=8591,"Miscellaneous Technical":i=>i>=8960&&i<=9215,"Control Pictures":i=>i>=9216&&i<=9279,"Optical Character Recognition":i=>i>=9280&&i<=9311,"Enclosed Alphanumerics":i=>i>=9312&&i<=9471,"Geometric Shapes":i=>i>=9632&&i<=9727,"Miscellaneous Symbols":i=>i>=9728&&i<=9983,"Miscellaneous Symbols and Arrows":i=>i>=11008&&i<=11263,"CJK Radicals Supplement":i=>i>=11904&&i<=12031,"Kangxi Radicals":i=>i>=12032&&i<=12255,"Ideographic Description Characters":i=>i>=12272&&i<=12287,"CJK Symbols and Punctuation":i=>i>=12288&&i<=12351,Hiragana:i=>i>=12352&&i<=12447,Katakana:i=>i>=12448&&i<=12543,Bopomofo:i=>i>=12544&&i<=12591,"Hangul Compatibility Jamo":i=>i>=12592&&i<=12687,Kanbun:i=>i>=12688&&i<=12703,"Bopomofo Extended":i=>i>=12704&&i<=12735,"CJK Strokes":i=>i>=12736&&i<=12783,"Katakana Phonetic Extensions":i=>i>=12784&&i<=12799,"Enclosed CJK Letters and Months":i=>i>=12800&&i<=13055,"CJK Compatibility":i=>i>=13056&&i<=13311,"CJK Unified Ideographs Extension A":i=>i>=13312&&i<=19903,"Yijing Hexagram Symbols":i=>i>=19904&&i<=19967,"CJK Unified Ideographs":i=>i>=19968&&i<=40959,"Yi Syllables":i=>i>=40960&&i<=42127,"Yi Radicals":i=>i>=42128&&i<=42191,"Hangul Jamo Extended-A":i=>i>=43360&&i<=43391,"Hangul Syllables":i=>i>=44032&&i<=55215,"Hangul Jamo Extended-B":i=>i>=55216&&i<=55295,"Private Use Area":i=>i>=57344&&i<=63743,"CJK Compatibility Ideographs":i=>i>=63744&&i<=64255,"Arabic Presentation Forms-A":i=>i>=64336&&i<=65023,"Vertical Forms":i=>i>=65040&&i<=65055,"CJK Compatibility Forms":i=>i>=65072&&i<=65103,"Small Form Variants":i=>i>=65104&&i<=65135,"Arabic Presentation Forms-B":i=>i>=65136&&i<=65279,"Halfwidth and Fullwidth Forms":i=>i>=65280&&i<=65519};function Ul(i){for(const t of i)if(Gl(t.charCodeAt(0)))return!0;return!1}function ah(i){for(const t of i)if(!wc(t.charCodeAt(0)))return!1;return!0}function wc(i){return!(Ge.Arabic(i)||Ge["Arabic Supplement"](i)||Ge["Arabic Extended-A"](i)||Ge["Arabic Presentation Forms-A"](i)||Ge["Arabic Presentation Forms-B"](i))}function Gl(i){return!(i!==746&&i!==747&&(i<4352||!(Ge["Bopomofo Extended"](i)||Ge.Bopomofo(i)||Ge["CJK Compatibility Forms"](i)&&!(i>=65097&&i<=65103)||Ge["CJK Compatibility Ideographs"](i)||Ge["CJK Compatibility"](i)||Ge["CJK Radicals Supplement"](i)||Ge["CJK Strokes"](i)||!(!Ge["CJK Symbols and Punctuation"](i)||i>=12296&&i<=12305||i>=12308&&i<=12319||i===12336)||Ge["CJK Unified Ideographs Extension A"](i)||Ge["CJK Unified Ideographs"](i)||Ge["Enclosed CJK Letters and Months"](i)||Ge["Hangul Compatibility Jamo"](i)||Ge["Hangul Jamo Extended-A"](i)||Ge["Hangul Jamo Extended-B"](i)||Ge["Hangul Jamo"](i)||Ge["Hangul Syllables"](i)||Ge.Hiragana(i)||Ge["Ideographic Description Characters"](i)||Ge.Kanbun(i)||Ge["Kangxi Radicals"](i)||Ge["Katakana Phonetic Extensions"](i)||Ge.Katakana(i)&&i!==12540||!(!Ge["Halfwidth and Fullwidth Forms"](i)||i===65288||i===65289||i===65293||i>=65306&&i<=65310||i===65339||i===65341||i===65343||i>=65371&&i<=65503||i===65507||i>=65512&&i<=65519)||!(!Ge["Small Form Variants"](i)||i>=65112&&i<=65118||i>=65123&&i<=65126)||Ge["Unified Canadian Aboriginal Syllabics"](i)||Ge["Unified Canadian Aboriginal Syllabics Extended"](i)||Ge["Vertical Forms"](i)||Ge["Yijing Hexagram Symbols"](i)||Ge["Yi Syllables"](i)||Ge["Yi Radicals"](i))))}function Cc(i){return!(Gl(i)||function(t){return!!(Ge["Latin-1 Supplement"](t)&&(t===167||t===169||t===174||t===177||t===188||t===189||t===190||t===215||t===247)||Ge["General Punctuation"](t)&&(t===8214||t===8224||t===8225||t===8240||t===8241||t===8251||t===8252||t===8258||t===8263||t===8264||t===8265||t===8273)||Ge["Letterlike Symbols"](t)||Ge["Number Forms"](t)||Ge["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||t===9003||t>=9085&&t<=9114||t>=9150&&t<=9165||t===9167||t>=9169&&t<=9179||t>=9186&&t<=9215)||Ge["Control Pictures"](t)&&t!==9251||Ge["Optical Character Recognition"](t)||Ge["Enclosed Alphanumerics"](t)||Ge["Geometric Shapes"](t)||Ge["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||Ge["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||Ge["CJK Symbols and Punctuation"](t)||Ge.Katakana(t)||Ge["Private Use Area"](t)||Ge["CJK Compatibility Forms"](t)||Ge["Small Form Variants"](t)||Ge["Halfwidth and Fullwidth Forms"](t)||t===8734||t===8756||t===8757||t>=9984&&t<=10087||t>=10102&&t<=10131||t===65532||t===65533)}(i))}function Qs(i){return i>=1424&&i<=2303||Ge["Arabic Presentation Forms-A"](i)||Ge["Arabic Presentation Forms-B"](i)}function Sc(i,t){return!(!t&&Qs(i)||i>=2304&&i<=3583||i>=3840&&i<=4255||Ge.Khmer(i))}function Xl(i){for(const t of i)if(Qs(t.charCodeAt(0)))return!0;return!1}const to=new class{constructor(){this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null}setState(i){this.pluginStatus=i.pluginStatus,this.pluginURL=i.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(i){this.applyArabicShaping=i.applyArabicShaping,this.processBidirectionalText=i.processBidirectionalText,this.processStyledBidirectionalText=i.processStyledBidirectionalText}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getPluginURL(){return this.pluginURL}getRTLTextPluginStatus(){return this.pluginStatus}};class pr{constructor(t,r){this.zoom=t,r?(this.now=r.now,this.fadeDuration=r.fadeDuration,this.zoomHistory=r.zoomHistory,this.transition=r.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new bc,this.transition={})}isSupportedScript(t){return function(r,o){for(const f of r)if(!Sc(f.charCodeAt(0),o))return!1;return!0}(t,to.getRTLTextPluginStatus()==="loaded")}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const t=this.zoom,r=t-Math.floor(t),o=this.crossFadingFactor();return t>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:r+(1-r)*o}:{fromScale:.5,toScale:1,t:1-(1-o)*r}}}class il{constructor(t,r){this.property=t,this.value=r,this.expression=function(o,f){if(Le(o))return new Os(o,f);if(en(o)){const v=ks(o,f);if(v.result==="error")throw new Error(v.value.map(x=>`${x.key}: ${x.message}`).join(", "));return v.value}{let v=o;return f.type==="color"&&typeof o=="string"?v=Ri.parse(o):f.type!=="padding"||typeof o!="number"&&!Array.isArray(o)?f.type==="variableAnchorOffsetCollection"&&Array.isArray(o)&&(v=Mr.parse(o)):v=tn.parse(o),{kind:"constant",evaluate:()=>v}}}(r===void 0?t.specification.default:r,t.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(t,r,o){return this.property.possiblyEvaluate(this,t,r,o)}}class ta{constructor(t){this.property=t,this.value=new il(t,void 0)}transitioned(t,r){return new Tc(this.property,this.value,r,nt({},t.transition,this.transition),t.now)}untransitioned(){return new Tc(this.property,this.value,null,{},0)}}class ea{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues)}getValue(t){return Jt(this._values[t].value.value)}setValue(t,r){Object.prototype.hasOwnProperty.call(this._values,t)||(this._values[t]=new ta(this._values[t].property)),this._values[t].value=new il(this._values[t].property,r===null?void 0:Jt(r))}getTransition(t){return Jt(this._values[t].transition)}setTransition(t,r){Object.prototype.hasOwnProperty.call(this._values,t)||(this._values[t]=new ta(this._values[t].property)),this._values[t].transition=Jt(r)||void 0}serialize(){const t={};for(const r of Object.keys(this._values)){const o=this.getValue(r);o!==void 0&&(t[r]=o);const f=this.getTransition(r);f!==void 0&&(t[`${r}-transition`]=f)}return t}transitioned(t,r){const o=new Wl(this._properties);for(const f of Object.keys(this._values))o._values[f]=this._values[f].transitioned(t,r._values[f]);return o}untransitioned(){const t=new Wl(this._properties);for(const r of Object.keys(this._values))t._values[r]=this._values[r].untransitioned();return t}}class Tc{constructor(t,r,o,f,v){this.property=t,this.value=r,this.begin=v+f.delay||0,this.end=this.begin+f.duration||0,t.specification.transition&&(f.delay||f.duration)&&(this.prior=o)}possiblyEvaluate(t,r,o){const f=t.now||0,v=this.value.possiblyEvaluate(t,r,o),x=this.prior;if(x){if(f>this.end)return this.prior=null,v;if(this.value.isDataDriven())return this.prior=null,v;if(f<this.begin)return x.possiblyEvaluate(t,r,o);{const T=(f-this.begin)/(this.end-this.begin);return this.property.interpolate(x.possiblyEvaluate(t,r,o),v,function(A){if(A<=0)return 0;if(A>=1)return 1;const D=A*A,B=D*A;return 4*(A<.5?B:3*(A-D)+B-.75)}(T))}}return v}}class Wl{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,r,o){const f=new rl(this._properties);for(const v of Object.keys(this._values))f._values[v]=this._values[v].possiblyEvaluate(t,r,o);return f}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class La{constructor(t){this._properties=t,this._values=Object.create(t.defaultPropertyValues)}hasValue(t){return this._values[t].value!==void 0}getValue(t){return Jt(this._values[t].value)}setValue(t,r){this._values[t]=new il(this._values[t].property,r===null?void 0:Jt(r))}serialize(){const t={};for(const r of Object.keys(this._values)){const o=this.getValue(r);o!==void 0&&(t[r]=o)}return t}possiblyEvaluate(t,r,o){const f=new rl(this._properties);for(const v of Object.keys(this._values))f._values[v]=this._values[v].possiblyEvaluate(t,r,o);return f}}class vs{constructor(t,r,o){this.property=t,this.value=r,this.parameters=o}isConstant(){return this.value.kind==="constant"}constantOr(t){return this.value.kind==="constant"?this.value.value:t}evaluate(t,r,o,f){return this.property.evaluate(this.value,this.parameters,t,r,o,f)}}class rl{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class ai{constructor(t){this.specification=t}possiblyEvaluate(t,r){if(t.isDataDriven())throw new Error("Value should not be data driven");return t.expression.evaluate(r)}interpolate(t,r,o){const f=di[this.specification.type];return f?f(t,r,o):t}}class mi{constructor(t,r){this.specification=t,this.overrides=r}possiblyEvaluate(t,r,o,f){return new vs(this,t.expression.kind==="constant"||t.expression.kind==="camera"?{kind:"constant",value:t.expression.evaluate(r,null,{},o,f)}:t.expression,r)}interpolate(t,r,o){if(t.value.kind!=="constant"||r.value.kind!=="constant")return t;if(t.value.value===void 0||r.value.value===void 0)return new vs(this,{kind:"constant",value:void 0},t.parameters);const f=di[this.specification.type];if(f){const v=f(t.value.value,r.value.value,o);return new vs(this,{kind:"constant",value:v},t.parameters)}return t}evaluate(t,r,o,f,v,x){return t.kind==="constant"?t.value:t.evaluate(r,o,f,v,x)}}class y extends mi{possiblyEvaluate(t,r,o,f){if(t.value===void 0)return new vs(this,{kind:"constant",value:void 0},r);if(t.expression.kind==="constant"){const v=t.expression.evaluate(r,null,{},o,f),x=t.property.specification.type==="resolvedImage"&&typeof v!="string"?v.name:v,T=this._calculate(x,x,x,r);return new vs(this,{kind:"constant",value:T},r)}if(t.expression.kind==="camera"){const v=this._calculate(t.expression.evaluate({zoom:r.zoom-1}),t.expression.evaluate({zoom:r.zoom}),t.expression.evaluate({zoom:r.zoom+1}),r);return new vs(this,{kind:"constant",value:v},r)}return new vs(this,t.expression,r)}evaluate(t,r,o,f,v,x){if(t.kind==="source"){const T=t.evaluate(r,o,f,v,x);return this._calculate(T,T,T,r)}return t.kind==="composite"?this._calculate(t.evaluate({zoom:Math.floor(r.zoom)-1},o,f),t.evaluate({zoom:Math.floor(r.zoom)},o,f),t.evaluate({zoom:Math.floor(r.zoom)+1},o,f),r):t.value}_calculate(t,r,o,f){return f.zoom>f.zoomHistory.lastIntegerZoom?{from:t,to:r}:{from:o,to:r}}interpolate(t){return t}}class e{constructor(t){this.specification=t}possiblyEvaluate(t,r,o,f){if(t.value!==void 0){if(t.expression.kind==="constant"){const v=t.expression.evaluate(r,null,{},o,f);return this._calculate(v,v,v,r)}return this._calculate(t.expression.evaluate(new pr(Math.floor(r.zoom-1),r)),t.expression.evaluate(new pr(Math.floor(r.zoom),r)),t.expression.evaluate(new pr(Math.floor(r.zoom+1),r)),r)}}_calculate(t,r,o,f){return f.zoom>f.zoomHistory.lastIntegerZoom?{from:t,to:r}:{from:o,to:r}}interpolate(t){return t}}class n{constructor(t){this.specification=t}possiblyEvaluate(t,r,o,f){return!!t.expression.evaluate(r,null,{},o,f)}interpolate(){return!1}}class a{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const r in t){const o=t[r];o.specification.overridable&&this.overridableProperties.push(r);const f=this.defaultPropertyValues[r]=new il(o,void 0),v=this.defaultTransitionablePropertyValues[r]=new ta(o);this.defaultTransitioningPropertyValues[r]=v.untransitioned(),this.defaultPossiblyEvaluatedValues[r]=f.possiblyEvaluate({})}}}Ze("DataDrivenProperty",mi),Ze("DataConstantProperty",ai),Ze("CrossFadedDataDrivenProperty",y),Ze("CrossFadedProperty",e),Ze("ColorRampProperty",n);const u="-transition";class _ extends ae{constructor(t,r){if(super(),this.id=t.id,this.type=t.type,this._featureFilter={filter:()=>!0,needGeometry:!1},t.type!=="custom"&&(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,t.type!=="background"&&(this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter),r.layout&&(this._unevaluatedLayout=new La(r.layout)),r.paint)){this._transitionablePaint=new ea(r.paint);for(const o in t.paint)this.setPaintProperty(o,t.paint[o],{validate:!1});for(const o in t.layout)this.setLayoutProperty(o,t.layout[o],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new rl(r.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(t){return t==="visibility"?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,r,o={}){r!=null&&this._validate(oh,`layers.${this.id}.layout.${t}`,t,r,o)||(t!=="visibility"?this._unevaluatedLayout.setValue(t,r):this.visibility=r)}getPaintProperty(t){return t.endsWith(u)?this._transitionablePaint.getTransition(t.slice(0,-11)):this._transitionablePaint.getValue(t)}setPaintProperty(t,r,o={}){if(r!=null&&this._validate(sh,`layers.${this.id}.paint.${t}`,t,r,o))return!1;if(t.endsWith(u))return this._transitionablePaint.setTransition(t.slice(0,-11),r||void 0),!1;{const f=this._transitionablePaint._values[t],v=f.property.specification["property-type"]==="cross-faded-data-driven",x=f.value.isDataDriven(),T=f.value;this._transitionablePaint.setValue(t,r),this._handleSpecialPaintPropertyUpdate(t);const A=this._transitionablePaint._values[t].value;return A.isDataDriven()||x||v||this._handleOverridablePaintPropertyUpdate(t,T,A)}}_handleSpecialPaintPropertyUpdate(t){}_handleOverridablePaintPropertyUpdate(t,r,o){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||this.visibility==="none"}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,r){t.getCrossfadeParameters&&(this._crossfadeParameters=t.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,r)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,r)}serialize(){const t={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(t.layout=t.layout||{},t.layout.visibility=this.visibility),Kt(t,(r,o)=>!(r===void 0||o==="layout"&&!Object.keys(r).length||o==="paint"&&!Object.keys(r).length))}_validate(t,r,o,f,v={}){return(!v||v.validate!==!1)&&Nl(this,t.call(Ls,{key:r,layerType:this.type,objectKey:o,value:f,styleSpec:at,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const t in this.paint._values){const r=this.paint.get(t);if(r instanceof vs&&fs(r.property.specification)&&(r.value.kind==="source"||r.value.kind==="composite")&&r.value.isStateDependent)return!0}return!1}}const I={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class k{constructor(t,r){this._structArray=t,this._pos1=r*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class z{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(t,r){return t._trim(),r&&(t.isTransferred=!0,r.push(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const r=Object.create(this.prototype);return r.arrayBuffer=t.arrayBuffer,r.length=t.length,r.capacity=t.arrayBuffer.byteLength/r.bytesPerElement,r._refreshViews(),r}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const r=this.uint8;this._refreshViews(),r&&this.uint8.set(r)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function R(i,t=1){let r=0,o=0;return{members:i.map(f=>{const v=I[f.type].BYTES_PER_ELEMENT,x=r=V(r,Math.max(t,v)),T=f.components||1;return o=Math.max(o,v),r+=v*T,{name:f.name,type:f.type,components:T,offset:x}}),size:V(r,Math.max(o,t)),alignment:t}}function V(i,t){return Math.ceil(i/t)*t}class G extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,r)}emplace(t,r,o){const f=2*t;return this.int16[f+0]=r,this.int16[f+1]=o,t}}G.prototype.bytesPerElement=4,Ze("StructArrayLayout2i4",G);class Y extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o){const f=this.length;return this.resize(f+1),this.emplace(f,t,r,o)}emplace(t,r,o,f){const v=3*t;return this.int16[v+0]=r,this.int16[v+1]=o,this.int16[v+2]=f,t}}Y.prototype.bytesPerElement=6,Ze("StructArrayLayout3i6",Y);class tt extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o,f){const v=this.length;return this.resize(v+1),this.emplace(v,t,r,o,f)}emplace(t,r,o,f,v){const x=4*t;return this.int16[x+0]=r,this.int16[x+1]=o,this.int16[x+2]=f,this.int16[x+3]=v,t}}tt.prototype.bytesPerElement=8,Ze("StructArrayLayout4i8",tt);class ot extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o,f,v,x){const T=this.length;return this.resize(T+1),this.emplace(T,t,r,o,f,v,x)}emplace(t,r,o,f,v,x,T){const A=6*t;return this.int16[A+0]=r,this.int16[A+1]=o,this.int16[A+2]=f,this.int16[A+3]=v,this.int16[A+4]=x,this.int16[A+5]=T,t}}ot.prototype.bytesPerElement=12,Ze("StructArrayLayout2i4i12",ot);class mt extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o,f,v,x){const T=this.length;return this.resize(T+1),this.emplace(T,t,r,o,f,v,x)}emplace(t,r,o,f,v,x,T){const A=4*t,D=8*t;return this.int16[A+0]=r,this.int16[A+1]=o,this.uint8[D+4]=f,this.uint8[D+5]=v,this.uint8[D+6]=x,this.uint8[D+7]=T,t}}mt.prototype.bytesPerElement=8,Ze("StructArrayLayout2i4ub8",mt);class ut extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,r)}emplace(t,r,o){const f=2*t;return this.float32[f+0]=r,this.float32[f+1]=o,t}}ut.prototype.bytesPerElement=8,Ze("StructArrayLayout2f8",ut);class bt extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,o,f,v,x,T,A,D,B){const j=this.length;return this.resize(j+1),this.emplace(j,t,r,o,f,v,x,T,A,D,B)}emplace(t,r,o,f,v,x,T,A,D,B,j){const X=10*t;return this.uint16[X+0]=r,this.uint16[X+1]=o,this.uint16[X+2]=f,this.uint16[X+3]=v,this.uint16[X+4]=x,this.uint16[X+5]=T,this.uint16[X+6]=A,this.uint16[X+7]=D,this.uint16[X+8]=B,this.uint16[X+9]=j,t}}bt.prototype.bytesPerElement=20,Ze("StructArrayLayout10ui20",bt);class Pt extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,o,f,v,x,T,A,D,B,j,X){const q=this.length;return this.resize(q+1),this.emplace(q,t,r,o,f,v,x,T,A,D,B,j,X)}emplace(t,r,o,f,v,x,T,A,D,B,j,X,q){const J=12*t;return this.int16[J+0]=r,this.int16[J+1]=o,this.int16[J+2]=f,this.int16[J+3]=v,this.uint16[J+4]=x,this.uint16[J+5]=T,this.uint16[J+6]=A,this.uint16[J+7]=D,this.int16[J+8]=B,this.int16[J+9]=j,this.int16[J+10]=X,this.int16[J+11]=q,t}}Pt.prototype.bytesPerElement=24,Ze("StructArrayLayout4i4ui4i24",Pt);class ht extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,o){const f=this.length;return this.resize(f+1),this.emplace(f,t,r,o)}emplace(t,r,o,f){const v=3*t;return this.float32[v+0]=r,this.float32[v+1]=o,this.float32[v+2]=f,t}}ht.prototype.bytesPerElement=12,Ze("StructArrayLayout3f12",ht);class Dt extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint32[1*t+0]=r,t}}Dt.prototype.bytesPerElement=4,Ze("StructArrayLayout1ul4",Dt);class Ut extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,o,f,v,x,T,A,D){const B=this.length;return this.resize(B+1),this.emplace(B,t,r,o,f,v,x,T,A,D)}emplace(t,r,o,f,v,x,T,A,D,B){const j=10*t,X=5*t;return this.int16[j+0]=r,this.int16[j+1]=o,this.int16[j+2]=f,this.int16[j+3]=v,this.int16[j+4]=x,this.int16[j+5]=T,this.uint32[X+3]=A,this.uint16[j+8]=D,this.uint16[j+9]=B,t}}Ut.prototype.bytesPerElement=20,Ze("StructArrayLayout6i1ul2ui20",Ut);class $t extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o,f,v,x){const T=this.length;return this.resize(T+1),this.emplace(T,t,r,o,f,v,x)}emplace(t,r,o,f,v,x,T){const A=6*t;return this.int16[A+0]=r,this.int16[A+1]=o,this.int16[A+2]=f,this.int16[A+3]=v,this.int16[A+4]=x,this.int16[A+5]=T,t}}$t.prototype.bytesPerElement=12,Ze("StructArrayLayout2i2i2i12",$t);class _e extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o,f,v){const x=this.length;return this.resize(x+1),this.emplace(x,t,r,o,f,v)}emplace(t,r,o,f,v,x){const T=4*t,A=8*t;return this.float32[T+0]=r,this.float32[T+1]=o,this.float32[T+2]=f,this.int16[A+6]=v,this.int16[A+7]=x,t}}_e.prototype.bytesPerElement=16,Ze("StructArrayLayout2f1f2i16",_e);class Ce extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o,f,v,x){const T=this.length;return this.resize(T+1),this.emplace(T,t,r,o,f,v,x)}emplace(t,r,o,f,v,x,T){const A=16*t,D=4*t,B=8*t;return this.uint8[A+0]=r,this.uint8[A+1]=o,this.float32[D+1]=f,this.float32[D+2]=v,this.int16[B+6]=x,this.int16[B+7]=T,t}}Ce.prototype.bytesPerElement=16,Ze("StructArrayLayout2ub2f2i16",Ce);class Xe extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,o){const f=this.length;return this.resize(f+1),this.emplace(f,t,r,o)}emplace(t,r,o,f){const v=3*t;return this.uint16[v+0]=r,this.uint16[v+1]=o,this.uint16[v+2]=f,t}}Xe.prototype.bytesPerElement=6,Ze("StructArrayLayout3ui6",Xe);class qe extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,o,f,v,x,T,A,D,B,j,X,q,J,it,dt,Ct){const Gt=this.length;return this.resize(Gt+1),this.emplace(Gt,t,r,o,f,v,x,T,A,D,B,j,X,q,J,it,dt,Ct)}emplace(t,r,o,f,v,x,T,A,D,B,j,X,q,J,it,dt,Ct,Gt){const At=24*t,Nt=12*t,ie=48*t;return this.int16[At+0]=r,this.int16[At+1]=o,this.uint16[At+2]=f,this.uint16[At+3]=v,this.uint32[Nt+2]=x,this.uint32[Nt+3]=T,this.uint32[Nt+4]=A,this.uint16[At+10]=D,this.uint16[At+11]=B,this.uint16[At+12]=j,this.float32[Nt+7]=X,this.float32[Nt+8]=q,this.uint8[ie+36]=J,this.uint8[ie+37]=it,this.uint8[ie+38]=dt,this.uint32[Nt+10]=Ct,this.int16[At+22]=Gt,t}}qe.prototype.bytesPerElement=48,Ze("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",qe);class Se extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,o,f,v,x,T,A,D,B,j,X,q,J,it,dt,Ct,Gt,At,Nt,ie,we,We,fi,Ue,Be,oi,Je){const Ye=this.length;return this.resize(Ye+1),this.emplace(Ye,t,r,o,f,v,x,T,A,D,B,j,X,q,J,it,dt,Ct,Gt,At,Nt,ie,we,We,fi,Ue,Be,oi,Je)}emplace(t,r,o,f,v,x,T,A,D,B,j,X,q,J,it,dt,Ct,Gt,At,Nt,ie,we,We,fi,Ue,Be,oi,Je,Ye){const de=32*t,li=16*t;return this.int16[de+0]=r,this.int16[de+1]=o,this.int16[de+2]=f,this.int16[de+3]=v,this.int16[de+4]=x,this.int16[de+5]=T,this.int16[de+6]=A,this.int16[de+7]=D,this.uint16[de+8]=B,this.uint16[de+9]=j,this.uint16[de+10]=X,this.uint16[de+11]=q,this.uint16[de+12]=J,this.uint16[de+13]=it,this.uint16[de+14]=dt,this.uint16[de+15]=Ct,this.uint16[de+16]=Gt,this.uint16[de+17]=At,this.uint16[de+18]=Nt,this.uint16[de+19]=ie,this.uint16[de+20]=we,this.uint16[de+21]=We,this.uint16[de+22]=fi,this.uint32[li+12]=Ue,this.float32[li+13]=Be,this.float32[li+14]=oi,this.uint16[de+30]=Je,this.uint16[de+31]=Ye,t}}Se.prototype.bytesPerElement=64,Ze("StructArrayLayout8i15ui1ul2f2ui64",Se);class ke extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.float32[1*t+0]=r,t}}ke.prototype.bytesPerElement=4,Ze("StructArrayLayout1f4",ke);class ti extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,o){const f=this.length;return this.resize(f+1),this.emplace(f,t,r,o)}emplace(t,r,o,f){const v=3*t;return this.uint16[6*t+0]=r,this.float32[v+1]=o,this.float32[v+2]=f,t}}ti.prototype.bytesPerElement=12,Ze("StructArrayLayout1ui2f12",ti);class Ci extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,o){const f=this.length;return this.resize(f+1),this.emplace(f,t,r,o)}emplace(t,r,o,f){const v=4*t;return this.uint32[2*t+0]=r,this.uint16[v+2]=o,this.uint16[v+3]=f,t}}Ci.prototype.bytesPerElement=8,Ze("StructArrayLayout1ul2ui8",Ci);class ze extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,r)}emplace(t,r,o){const f=2*t;return this.uint16[f+0]=r,this.uint16[f+1]=o,t}}ze.prototype.bytesPerElement=4,Ze("StructArrayLayout2ui4",ze);class Ve extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint16[1*t+0]=r,t}}Ve.prototype.bytesPerElement=2,Ze("StructArrayLayout1ui2",Ve);class yi extends z{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,o,f){const v=this.length;return this.resize(v+1),this.emplace(v,t,r,o,f)}emplace(t,r,o,f,v){const x=4*t;return this.float32[x+0]=r,this.float32[x+1]=o,this.float32[x+2]=f,this.float32[x+3]=v,t}}yi.prototype.bytesPerElement=16,Ze("StructArrayLayout4f16",yi);class gr extends k{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new l(this.anchorPointX,this.anchorPointY)}}gr.prototype.size=20;class Ii extends Ut{get(t){return new gr(this,t)}}Ze("CollisionBoxArray",Ii);class Di extends k{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(t){this._structArray.uint8[this._pos1+37]=t}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(t){this._structArray.uint8[this._pos1+38]=t}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(t){this._structArray.uint32[this._pos4+10]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}Di.prototype.size=48;class _r extends qe{get(t){return new Di(this,t)}}Ze("PlacedSymbolArray",_r);class rn extends k{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(t){this._structArray.uint32[this._pos4+12]=t}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}rn.prototype.size=64;class ts extends Se{get(t){return new rn(this,t)}}Ze("SymbolInstanceArray",ts);class yr extends ke{getoffsetX(t){return this.float32[1*t+0]}}Ze("GlyphOffsetArray",yr);class Cn extends Y{getx(t){return this.int16[3*t+0]}gety(t){return this.int16[3*t+1]}gettileUnitDistanceFromAnchor(t){return this.int16[3*t+2]}}Ze("SymbolLineVertexArray",Cn);class _n extends k{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}_n.prototype.size=12;class nn extends ti{get(t){return new _n(this,t)}}Ze("TextAnchorOffsetArray",nn);class sn extends k{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}sn.prototype.size=8;class es extends Ci{get(t){return new sn(this,t)}}Ze("FeatureIndexArray",es);class Do extends G{}class nl extends G{}class ia extends G{}class Lo extends ot{}class sl extends mt{}class Hl extends ut{}class Jr extends bt{}class is extends Pt{}class eo extends ht{}class ra extends Dt{}class on extends $t{}class an extends Ce{}class Hr extends Xe{}class Cr extends ze{}const na=R([{name:"a_pos",components:2,type:"Int16"}],4),{members:ql}=na;class Gr{constructor(t=[]){this.segments=t}prepareSegment(t,r,o,f){let v=this.segments[this.segments.length-1];return t>Gr.MAX_VERTEX_ARRAY_LENGTH&&he(`Max vertices per segment is ${Gr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!v||v.vertexLength+t>Gr.MAX_VERTEX_ARRAY_LENGTH||v.sortKey!==f)&&(v={vertexOffset:r.length,primitiveOffset:o.length,vertexLength:0,primitiveLength:0},f!==void 0&&(v.sortKey=f),this.segments.push(v)),v}get(){return this.segments}destroy(){for(const t of this.segments)for(const r in t.vaos)t.vaos[r].destroy()}static simpleSegment(t,r,o,f){return new Gr([{vertexOffset:t,primitiveOffset:r,vertexLength:o,primitiveLength:f,vaos:{},sortKey:0}])}}function Ec(i,t){return 256*(i=U(Math.floor(i),0,255))+U(Math.floor(t),0,255)}Gr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Ze("SegmentVector",Gr);const ol=R([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var al={exports:{}},io={exports:{}};io.exports=function(i,t){var r,o,f,v,x,T,A,D;for(o=i.length-(r=3&i.length),f=t,x=3432918353,T=461845907,D=0;D<o;)A=255&i.charCodeAt(D)|(255&i.charCodeAt(++D))<<8|(255&i.charCodeAt(++D))<<16|(255&i.charCodeAt(++D))<<24,++D,f=27492+(65535&(v=5*(65535&(f=(f^=A=(65535&(A=(A=(65535&A)*x+(((A>>>16)*x&65535)<<16)&4294967295)<<15|A>>>17))*T+(((A>>>16)*T&65535)<<16)&4294967295)<<13|f>>>19))+((5*(f>>>16)&65535)<<16)&4294967295))+((58964+(v>>>16)&65535)<<16);switch(A=0,r){case 3:A^=(255&i.charCodeAt(D+2))<<16;case 2:A^=(255&i.charCodeAt(D+1))<<8;case 1:f^=A=(65535&(A=(A=(65535&(A^=255&i.charCodeAt(D)))*x+(((A>>>16)*x&65535)<<16)&4294967295)<<15|A>>>17))*T+(((A>>>16)*T&65535)<<16)&4294967295}return f^=i.length,f=2246822507*(65535&(f^=f>>>16))+((2246822507*(f>>>16)&65535)<<16)&4294967295,f=3266489909*(65535&(f^=f>>>13))+((3266489909*(f>>>16)&65535)<<16)&4294967295,(f^=f>>>16)>>>0};var Pc=io.exports,$l={exports:{}};$l.exports=function(i,t){for(var r,o=i.length,f=t^o,v=0;o>=4;)r=1540483477*(65535&(r=255&i.charCodeAt(v)|(255&i.charCodeAt(++v))<<8|(255&i.charCodeAt(++v))<<16|(255&i.charCodeAt(++v))<<24))+((1540483477*(r>>>16)&65535)<<16),f=1540483477*(65535&f)+((1540483477*(f>>>16)&65535)<<16)^(r=1540483477*(65535&(r^=r>>>24))+((1540483477*(r>>>16)&65535)<<16)),o-=4,++v;switch(o){case 3:f^=(255&i.charCodeAt(v+2))<<16;case 2:f^=(255&i.charCodeAt(v+1))<<8;case 1:f=1540483477*(65535&(f^=255&i.charCodeAt(v)))+((1540483477*(f>>>16)&65535)<<16)}return f=1540483477*(65535&(f^=f>>>13))+((1540483477*(f>>>16)&65535)<<16),(f^=f>>>15)>>>0};var Yl=Pc,Zl=$l.exports;al.exports=Yl,al.exports.murmur3=Yl,al.exports.murmur2=Zl;var ll=p(al.exports);class sa{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(t,r,o,f){this.ids.push(lu(t)),this.positions.push(r,o,f)}getPositions(t){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const r=lu(t);let o=0,f=this.ids.length-1;for(;o<f;){const x=o+f>>1;this.ids[x]>=r?f=x:o=x+1}const v=[];for(;this.ids[o]===r;)v.push({index:this.positions[3*o],start:this.positions[3*o+1],end:this.positions[3*o+2]}),o++;return v}static serialize(t,r){const o=new Float64Array(t.ids),f=new Uint32Array(t.positions);return lh(o,f,0,o.length-1),r&&r.push(o.buffer,f.buffer),{ids:o,positions:f}}static deserialize(t){const r=new sa;return r.ids=t.ids,r.positions=t.positions,r.indexed=!0,r}}function lu(i){const t=+i;return!isNaN(t)&&t<=Number.MAX_SAFE_INTEGER?t:ll(String(i))}function lh(i,t,r,o){for(;r<o;){const f=i[r+o>>1];let v=r-1,x=o+1;for(;;){do v++;while(i[v]<f);do x--;while(i[x]>f);if(v>=x)break;Ic(i,v,x),Ic(t,3*v,3*x),Ic(t,3*v+1,3*x+1),Ic(t,3*v+2,3*x+2)}x-r<o-x?(lh(i,t,r,x),r=x+1):(lh(i,t,x+1,o),o=x)}}function Ic(i,t,r){const o=i[t];i[t]=i[r],i[r]=o}Ze("FeaturePositionMap",sa);class za{constructor(t,r){this.gl=t.gl,this.location=r}}class Ac extends za{constructor(t,r){super(t,r),this.current=0}set(t){this.current!==t&&(this.current=t,this.gl.uniform1f(this.location,t))}}class cu extends za{constructor(t,r){super(t,r),this.current=[0,0,0,0]}set(t){t[0]===this.current[0]&&t[1]===this.current[1]&&t[2]===this.current[2]&&t[3]===this.current[3]||(this.current=t,this.gl.uniform4f(this.location,t[0],t[1],t[2],t[3]))}}class hu extends za{constructor(t,r){super(t,r),this.current=Ri.transparent}set(t){t.r===this.current.r&&t.g===this.current.g&&t.b===this.current.b&&t.a===this.current.a||(this.current=t,this.gl.uniform4f(this.location,t.r,t.g,t.b,t.a))}}const Pf=new Float32Array(16);function ch(i){return[Ec(255*i.r,255*i.g),Ec(255*i.b,255*i.a)]}class Kl{constructor(t,r,o){this.value=t,this.uniformNames=r.map(f=>`u_${f}`),this.type=o}setUniform(t,r,o){t.set(o.constantOr(this.value))}getBinding(t,r,o){return this.type==="color"?new hu(t,r):new Ac(t,r)}}class cl{constructor(t,r){this.uniformNames=r.map(o=>`u_${o}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(t,r){this.pixelRatioFrom=r.pixelRatio,this.pixelRatioTo=t.pixelRatio,this.patternFrom=r.tlbr,this.patternTo=t.tlbr}setUniform(t,r,o,f){const v=f==="u_pattern_to"?this.patternTo:f==="u_pattern_from"?this.patternFrom:f==="u_pixel_ratio_to"?this.pixelRatioTo:f==="u_pixel_ratio_from"?this.pixelRatioFrom:null;v&&t.set(v)}getBinding(t,r,o){return o.substr(0,9)==="u_pattern"?new cu(t,r):new Ac(t,r)}}class zo{constructor(t,r,o,f){this.expression=t,this.type=o,this.maxValue=0,this.paintVertexAttributes=r.map(v=>({name:`a_${v}`,type:"Float32",components:o==="color"?2:1,offset:0})),this.paintVertexArray=new f}populatePaintArray(t,r,o,f,v){const x=this.paintVertexArray.length,T=this.expression.evaluate(new pr(0),r,{},f,[],v);this.paintVertexArray.resize(t),this._setPaintValue(x,t,T)}updatePaintArray(t,r,o,f){const v=this.expression.evaluate({zoom:0},o,f);this._setPaintValue(t,r,v)}_setPaintValue(t,r,o){if(this.type==="color"){const f=ch(o);for(let v=t;v<r;v++)this.paintVertexArray.emplace(v,f[0],f[1])}else{for(let f=t;f<r;f++)this.paintVertexArray.emplace(f,o);this.maxValue=Math.max(this.maxValue,Math.abs(o))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class zs{constructor(t,r,o,f,v,x){this.expression=t,this.uniformNames=r.map(T=>`u_${T}_t`),this.type=o,this.useIntegerZoom=f,this.zoom=v,this.maxValue=0,this.paintVertexAttributes=r.map(T=>({name:`a_${T}`,type:"Float32",components:o==="color"?4:2,offset:0})),this.paintVertexArray=new x}populatePaintArray(t,r,o,f,v){const x=this.expression.evaluate(new pr(this.zoom),r,{},f,[],v),T=this.expression.evaluate(new pr(this.zoom+1),r,{},f,[],v),A=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(A,t,x,T)}updatePaintArray(t,r,o,f){const v=this.expression.evaluate({zoom:this.zoom},o,f),x=this.expression.evaluate({zoom:this.zoom+1},o,f);this._setPaintValue(t,r,v,x)}_setPaintValue(t,r,o,f){if(this.type==="color"){const v=ch(o),x=ch(f);for(let T=t;T<r;T++)this.paintVertexArray.emplace(T,v[0],v[1],x[0],x[1])}else{for(let v=t;v<r;v++)this.paintVertexArray.emplace(v,o,f);this.maxValue=Math.max(this.maxValue,Math.abs(o),Math.abs(f))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,r){const o=this.useIntegerZoom?Math.floor(r.zoom):r.zoom,f=U(this.expression.interpolationFactor(o,this.zoom,this.zoom+1),0,1);t.set(f)}getBinding(t,r,o){return new Ac(t,r)}}class oa{constructor(t,r,o,f,v,x){this.expression=t,this.type=r,this.useIntegerZoom=o,this.zoom=f,this.layerId=x,this.zoomInPaintVertexArray=new v,this.zoomOutPaintVertexArray=new v}populatePaintArray(t,r,o){const f=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(t),this.zoomOutPaintVertexArray.resize(t),this._setPaintValues(f,t,r.patterns&&r.patterns[this.layerId],o)}updatePaintArray(t,r,o,f,v){this._setPaintValues(t,r,o.patterns&&o.patterns[this.layerId],v)}_setPaintValues(t,r,o,f){if(!f||!o)return;const{min:v,mid:x,max:T}=o,A=f[v],D=f[x],B=f[T];if(A&&D&&B)for(let j=t;j<r;j++)this.zoomInPaintVertexArray.emplace(j,D.tl[0],D.tl[1],D.br[0],D.br[1],A.tl[0],A.tl[1],A.br[0],A.br[1],D.pixelRatio,A.pixelRatio),this.zoomOutPaintVertexArray.emplace(j,D.tl[0],D.tl[1],D.br[0],D.br[1],B.tl[0],B.tl[1],B.br[0],B.br[1],D.pixelRatio,B.pixelRatio)}upload(t){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=t.createVertexBuffer(this.zoomInPaintVertexArray,ol.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=t.createVertexBuffer(this.zoomOutPaintVertexArray,ol.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class uu{constructor(t,r,o){this.binders={},this._buffers=[];const f=[];for(const v in t.paint._values){if(!o(v))continue;const x=t.paint.get(v);if(!(x instanceof vs&&fs(x.property.specification)))continue;const T=If(v,t.type),A=x.value,D=x.property.specification.type,B=x.property.useIntegerZoom,j=x.property.specification["property-type"],X=j==="cross-faded"||j==="cross-faded-data-driven";if(A.kind==="constant")this.binders[v]=X?new cl(A.value,T):new Kl(A.value,T,D),f.push(`/u_${v}`);else if(A.kind==="source"||X){const q=du(v,D,"source");this.binders[v]=X?new oa(A,D,B,r,q,t.id):new zo(A,T,D,q),f.push(`/a_${v}`)}else{const q=du(v,D,"composite");this.binders[v]=new zs(A,T,D,B,r,q),f.push(`/z_${v}`)}}this.cacheKey=f.sort().join("")}getMaxValue(t){const r=this.binders[t];return r instanceof zo||r instanceof zs?r.maxValue:0}populatePaintArrays(t,r,o,f,v){for(const x in this.binders){const T=this.binders[x];(T instanceof zo||T instanceof zs||T instanceof oa)&&T.populatePaintArray(t,r,o,f,v)}}setConstantPatternPositions(t,r){for(const o in this.binders){const f=this.binders[o];f instanceof cl&&f.setConstantPatternPositions(t,r)}}updatePaintArrays(t,r,o,f,v){let x=!1;for(const T in t){const A=r.getPositions(T);for(const D of A){const B=o.feature(D.index);for(const j in this.binders){const X=this.binders[j];if((X instanceof zo||X instanceof zs||X instanceof oa)&&X.expression.isStateDependent===!0){const q=f.paint.get(j);X.expression=q.value,X.updatePaintArray(D.start,D.end,B,t[T],v),x=!0}}}}return x}defines(){const t=[];for(const r in this.binders){const o=this.binders[r];(o instanceof Kl||o instanceof cl)&&t.push(...o.uniformNames.map(f=>`#define HAS_UNIFORM_${f}`))}return t}getBinderAttributes(){const t=[];for(const r in this.binders){const o=this.binders[r];if(o instanceof zo||o instanceof zs)for(let f=0;f<o.paintVertexAttributes.length;f++)t.push(o.paintVertexAttributes[f].name);else if(o instanceof oa)for(let f=0;f<ol.members.length;f++)t.push(ol.members[f].name)}return t}getBinderUniforms(){const t=[];for(const r in this.binders){const o=this.binders[r];if(o instanceof Kl||o instanceof cl||o instanceof zs)for(const f of o.uniformNames)t.push(f)}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t,r){const o=[];for(const f in this.binders){const v=this.binders[f];if(v instanceof Kl||v instanceof cl||v instanceof zs){for(const x of v.uniformNames)if(r[x]){const T=v.getBinding(t,r[x],x);o.push({name:x,property:f,binding:T})}}}return o}setUniforms(t,r,o,f){for(const{name:v,property:x,binding:T}of r)this.binders[x].setUniform(T,f,o.get(x),v)}updatePaintBuffers(t){this._buffers=[];for(const r in this.binders){const o=this.binders[r];if(t&&o instanceof oa){const f=t.fromScale===2?o.zoomInPaintVertexBuffer:o.zoomOutPaintVertexBuffer;f&&this._buffers.push(f)}else(o instanceof zo||o instanceof zs)&&o.paintVertexBuffer&&this._buffers.push(o.paintVertexBuffer)}}upload(t){for(const r in this.binders){const o=this.binders[r];(o instanceof zo||o instanceof zs||o instanceof oa)&&o.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const r=this.binders[t];(r instanceof zo||r instanceof zs||r instanceof oa)&&r.destroy()}}}class Fa{constructor(t,r,o=()=>!0){this.programConfigurations={};for(const f of t)this.programConfigurations[f.id]=new uu(f,r,o);this.needsUpload=!1,this._featureMap=new sa,this._bufferOffset=0}populatePaintArrays(t,r,o,f,v,x){for(const T in this.programConfigurations)this.programConfigurations[T].populatePaintArrays(t,r,f,v,x);r.id!==void 0&&this._featureMap.add(r.id,o,this._bufferOffset,t),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,r,o,f){for(const v of o)this.needsUpload=this.programConfigurations[v.id].updatePaintArrays(t,this._featureMap,r,v,f)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const r in this.programConfigurations)this.programConfigurations[r].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}function If(i,t){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[i]||[i.replace(`${t}-`,"").replace(/-/g,"_")]}function du(i,t,r){const o={color:{source:ut,composite:yi},number:{source:ke,composite:ut}},f=function(v){return{"line-pattern":{source:Jr,composite:Jr},"fill-pattern":{source:Jr,composite:Jr},"fill-extrusion-pattern":{source:Jr,composite:Jr}}[v]}(i);return f&&f[r]||o[t][r]}Ze("ConstantBinder",Kl),Ze("CrossFadedConstantBinder",cl),Ze("SourceExpressionBinder",zo),Ze("CrossFadedCompositeBinder",oa),Ze("CompositeExpressionBinder",zs),Ze("ProgramConfiguration",uu,{omit:["_buffers"]}),Ze("ProgramConfigurationSet",Fa);const jr=8192,hh=Math.pow(2,14)-1,fu=-hh-1;function Ra(i){const t=jr/i.extent,r=i.loadGeometry();for(let o=0;o<r.length;o++){const f=r[o];for(let v=0;v<f.length;v++){const x=f[v],T=Math.round(x.x*t),A=Math.round(x.y*t);x.x=U(T,fu,hh),x.y=U(A,fu,hh),(T<x.x||T>x.x+1||A<x.y||A>x.y+1)&&he("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return r}function Ba(i,t){return{type:i.type,id:i.id,properties:i.properties,geometry:t?Ra(i):[]}}function Mc(i,t,r,o,f){i.emplaceBack(2*t+(o+1)/2,2*r+(f+1)/2)}class uh{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.index=t.index,this.hasPattern=!1,this.layoutVertexArray=new nl,this.indexArray=new Hr,this.segments=new Gr,this.programConfigurations=new Fa(t.layers,t.zoom),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(t,r,o){const f=this.layers[0],v=[];let x=null,T=!1;f.type==="circle"&&(x=f.layout.get("circle-sort-key"),T=!x.isConstant());for(const{feature:A,id:D,index:B,sourceLayerIndex:j}of t){const X=this.layers[0]._featureFilter.needGeometry,q=Ba(A,X);if(!this.layers[0]._featureFilter.filter(new pr(this.zoom),q,o))continue;const J=T?x.evaluate(q,{},o):void 0,it={id:D,properties:A.properties,type:A.type,sourceLayerIndex:j,index:B,geometry:X?q.geometry:Ra(A),patterns:{},sortKey:J};v.push(it)}T&&v.sort((A,D)=>A.sortKey-D.sortKey);for(const A of v){const{geometry:D,index:B,sourceLayerIndex:j}=A,X=t[B].feature;this.addFeature(A,D,B,o),r.featureIndex.insert(X,D,B,j,this.index)}}update(t,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,r,this.stateDependentLayers,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,ql),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,r,o,f){for(const v of r)for(const x of v){const T=x.x,A=x.y;if(T<0||T>=jr||A<0||A>=jr)continue;const D=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),B=D.vertexLength;Mc(this.layoutVertexArray,T,A,-1,-1),Mc(this.layoutVertexArray,T,A,1,-1),Mc(this.layoutVertexArray,T,A,1,1),Mc(this.layoutVertexArray,T,A,-1,1),this.indexArray.emplaceBack(B,B+1,B+2),this.indexArray.emplaceBack(B,B+3,B+2),D.vertexLength+=4,D.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,{},f)}}function pu(i,t){for(let r=0;r<i.length;r++)if(hl(t,i[r]))return!0;for(let r=0;r<t.length;r++)if(hl(i,t[r]))return!0;return!!dh(i,t)}function Af(i,t,r){return!!hl(i,t)||!!fh(t,i,r)}function mu(i,t){if(i.length===1)return _u(t,i[0]);for(let r=0;r<t.length;r++){const o=t[r];for(let f=0;f<o.length;f++)if(hl(i,o[f]))return!0}for(let r=0;r<i.length;r++)if(_u(t,i[r]))return!0;for(let r=0;r<t.length;r++)if(dh(i,t[r]))return!0;return!1}function Mf(i,t,r){if(i.length>1){if(dh(i,t))return!0;for(let o=0;o<t.length;o++)if(fh(t[o],i,r))return!0}for(let o=0;o<i.length;o++)if(fh(i[o],t,r))return!0;return!1}function dh(i,t){if(i.length===0||t.length===0)return!1;for(let r=0;r<i.length-1;r++){const o=i[r],f=i[r+1];for(let v=0;v<t.length-1;v++)if(kf(o,f,t[v],t[v+1]))return!0}return!1}function kf(i,t,r,o){return ne(i,r,o)!==ne(t,r,o)&&ne(i,t,r)!==ne(i,t,o)}function fh(i,t,r){const o=r*r;if(t.length===1)return i.distSqr(t[0])<o;for(let f=1;f<t.length;f++)if(gu(i,t[f-1],t[f])<o)return!0;return!1}function gu(i,t,r){const o=t.distSqr(r);if(o===0)return i.distSqr(t);const f=((i.x-t.x)*(r.x-t.x)+(i.y-t.y)*(r.y-t.y))/o;return i.distSqr(f<0?t:f>1?r:r.sub(t)._mult(f)._add(t))}function _u(i,t){let r,o,f,v=!1;for(let x=0;x<i.length;x++){r=i[x];for(let T=0,A=r.length-1;T<r.length;A=T++)o=r[T],f=r[A],o.y>t.y!=f.y>t.y&&t.x<(f.x-o.x)*(t.y-o.y)/(f.y-o.y)+o.x&&(v=!v)}return v}function hl(i,t){let r=!1;for(let o=0,f=i.length-1;o<i.length;f=o++){const v=i[o],x=i[f];v.y>t.y!=x.y>t.y&&t.x<(x.x-v.x)*(t.y-v.y)/(x.y-v.y)+v.x&&(r=!r)}return r}function Of(i,t,r){const o=r[0],f=r[2];if(i.x<o.x&&t.x<o.x||i.x>f.x&&t.x>f.x||i.y<o.y&&t.y<o.y||i.y>f.y&&t.y>f.y)return!1;const v=ne(i,t,r[0]);return v!==ne(i,t,r[1])||v!==ne(i,t,r[2])||v!==ne(i,t,r[3])}function Jl(i,t,r){const o=t.paint.get(i).value;return o.kind==="constant"?o.value:r.programConfigurations.get(t.id).getMaxValue(i)}function kc(i){return Math.sqrt(i[0]*i[0]+i[1]*i[1])}function Oc(i,t,r,o,f){if(!t[0]&&!t[1])return i;const v=l.convert(t)._mult(f);r==="viewport"&&v._rotate(-o);const x=[];for(let T=0;T<i.length;T++)x.push(i[T].sub(v));return x}let yu,vu;Ze("CircleBucket",uh,{omit:["layers"]});var Df={get paint(){return vu=vu||new a({"circle-radius":new mi(at.paint_circle["circle-radius"]),"circle-color":new mi(at.paint_circle["circle-color"]),"circle-blur":new mi(at.paint_circle["circle-blur"]),"circle-opacity":new mi(at.paint_circle["circle-opacity"]),"circle-translate":new ai(at.paint_circle["circle-translate"]),"circle-translate-anchor":new ai(at.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ai(at.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ai(at.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new mi(at.paint_circle["circle-stroke-width"]),"circle-stroke-color":new mi(at.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new mi(at.paint_circle["circle-stroke-opacity"])})},get layout(){return yu=yu||new a({"circle-sort-key":new mi(at.layout_circle["circle-sort-key"])})}},Sn=1e-6,ul=typeof Float32Array<"u"?Float32Array:Array;function ph(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function xu(i,t,r){var o=t[0],f=t[1],v=t[2],x=t[3],T=t[4],A=t[5],D=t[6],B=t[7],j=t[8],X=t[9],q=t[10],J=t[11],it=t[12],dt=t[13],Ct=t[14],Gt=t[15],At=r[0],Nt=r[1],ie=r[2],we=r[3];return i[0]=At*o+Nt*T+ie*j+we*it,i[1]=At*f+Nt*A+ie*X+we*dt,i[2]=At*v+Nt*D+ie*q+we*Ct,i[3]=At*x+Nt*B+ie*J+we*Gt,i[4]=(At=r[4])*o+(Nt=r[5])*T+(ie=r[6])*j+(we=r[7])*it,i[5]=At*f+Nt*A+ie*X+we*dt,i[6]=At*v+Nt*D+ie*q+we*Ct,i[7]=At*x+Nt*B+ie*J+we*Gt,i[8]=(At=r[8])*o+(Nt=r[9])*T+(ie=r[10])*j+(we=r[11])*it,i[9]=At*f+Nt*A+ie*X+we*dt,i[10]=At*v+Nt*D+ie*q+we*Ct,i[11]=At*x+Nt*B+ie*J+we*Gt,i[12]=(At=r[12])*o+(Nt=r[13])*T+(ie=r[14])*j+(we=r[15])*it,i[13]=At*f+Nt*A+ie*X+we*dt,i[14]=At*v+Nt*D+ie*q+we*Ct,i[15]=At*x+Nt*B+ie*J+we*Gt,i}Math.hypot||(Math.hypot=function(){for(var i=0,t=arguments.length;t--;)i+=arguments[t]*arguments[t];return Math.sqrt(i)});var Ql,Lf=xu;function Dc(i,t,r){var o=t[0],f=t[1],v=t[2],x=t[3];return i[0]=r[0]*o+r[4]*f+r[8]*v+r[12]*x,i[1]=r[1]*o+r[5]*f+r[9]*v+r[13]*x,i[2]=r[2]*o+r[6]*f+r[10]*v+r[14]*x,i[3]=r[3]*o+r[7]*f+r[11]*v+r[15]*x,i}Ql=new ul(4),ul!=Float32Array&&(Ql[0]=0,Ql[1]=0,Ql[2]=0,Ql[3]=0);class zf extends _{constructor(t){super(t,Df)}createBucket(t){return new uh(t)}queryRadius(t){const r=t;return Jl("circle-radius",this,r)+Jl("circle-stroke-width",this,r)+kc(this.paint.get("circle-translate"))}queryIntersectsFeature(t,r,o,f,v,x,T,A){const D=Oc(t,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),x.angle,T),B=this.paint.get("circle-radius").evaluate(r,o)+this.paint.get("circle-stroke-width").evaluate(r,o),j=this.paint.get("circle-pitch-alignment")==="map",X=j?D:function(J,it){return J.map(dt=>bu(dt,it))}(D,A),q=j?B*T:B;for(const J of f)for(const it of J){const dt=j?it:bu(it,A);let Ct=q;const Gt=Dc([],[it.x,it.y,0,1],A);if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"?Ct*=Gt[3]/x.cameraToCenterDistance:this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"&&(Ct*=x.cameraToCenterDistance/Gt[3]),Af(X,dt,Ct))return!0}return!1}}function bu(i,t){const r=Dc([],[i.x,i.y,0,1],t);return new l(r[0]/r[3],r[1]/r[3])}class wu extends uh{}let Cu;Ze("HeatmapBucket",wu,{omit:["layers"]});var Ff={get paint(){return Cu=Cu||new a({"heatmap-radius":new mi(at.paint_heatmap["heatmap-radius"]),"heatmap-weight":new mi(at.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ai(at.paint_heatmap["heatmap-intensity"]),"heatmap-color":new n(at.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ai(at.paint_heatmap["heatmap-opacity"])})}};function mh(i,{width:t,height:r},o,f){if(f){if(f instanceof Uint8ClampedArray)f=new Uint8Array(f.buffer);else if(f.length!==t*r*o)throw new RangeError(`mismatched image size. expected: ${f.length} but got: ${t*r*o}`)}else f=new Uint8Array(t*r*o);return i.width=t,i.height=r,i.data=f,i}function Su(i,{width:t,height:r},o){if(t===i.width&&r===i.height)return;const f=mh({},{width:t,height:r},o);gh(i,f,{x:0,y:0},{x:0,y:0},{width:Math.min(i.width,t),height:Math.min(i.height,r)},o),i.width=t,i.height=r,i.data=f.data}function gh(i,t,r,o,f,v){if(f.width===0||f.height===0)return t;if(f.width>i.width||f.height>i.height||r.x>i.width-f.width||r.y>i.height-f.height)throw new RangeError("out of range source coordinates for image copy");if(f.width>t.width||f.height>t.height||o.x>t.width-f.width||o.y>t.height-f.height)throw new RangeError("out of range destination coordinates for image copy");const x=i.data,T=t.data;if(x===T)throw new Error("srcData equals dstData, so image is already copied");for(let A=0;A<f.height;A++){const D=((r.y+A)*i.width+r.x)*v,B=((o.y+A)*t.width+o.x)*v;for(let j=0;j<f.width*v;j++)T[B+j]=x[D+j]}return t}class tc{constructor(t,r){mh(this,t,1,r)}resize(t){Su(this,t,1)}clone(){return new tc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,r,o,f,v){gh(t,r,o,f,v,1)}}class rs{constructor(t,r){mh(this,t,4,r)}resize(t){Su(this,t,4)}replace(t,r){r?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new rs({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,r,o,f,v){gh(t,r,o,f,v,4)}}function Tu(i){const t={},r=i.resolution||256,o=i.clips?i.clips.length:1,f=i.image||new rs({width:r,height:o});if(Math.log(r)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${r}`);const v=(x,T,A)=>{t[i.evaluationKey]=A;const D=i.expression.evaluate(t);f.data[x+T+0]=Math.floor(255*D.r/D.a),f.data[x+T+1]=Math.floor(255*D.g/D.a),f.data[x+T+2]=Math.floor(255*D.b/D.a),f.data[x+T+3]=Math.floor(255*D.a)};if(i.clips)for(let x=0,T=0;x<o;++x,T+=4*r)for(let A=0,D=0;A<r;A++,D+=4){const B=A/(r-1),{start:j,end:X}=i.clips[x];v(T,D,j*(1-B)+X*B)}else for(let x=0,T=0;x<r;x++,T+=4)v(0,T,x/(r-1));return f}Ze("AlphaImage",tc),Ze("RGBAImage",rs);class Rf extends _{createBucket(t){return new wu(t)}constructor(t){super(t,Ff),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){t==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Tu({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let Eu;var Bf={get paint(){return Eu=Eu||new a({"hillshade-illumination-direction":new ai(at.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ai(at.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ai(at.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ai(at.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ai(at.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ai(at.paint_hillshade["hillshade-accent-color"])})}};class jf extends _{constructor(t){super(t,Bf)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}const Nf=R([{name:"a_pos",components:2,type:"Int16"}],4),{members:Vf}=Nf;function Pu(i,t,r=2){const o=t&&t.length,f=o?t[0]*r:i.length;let v=Iu(i,0,f,r,!0);const x=[];if(!v||v.next===v.prev)return x;let T,A,D;if(o&&(v=function(B,j,X,q){const J=[];for(let it=0,dt=j.length;it<dt;it++){const Ct=Iu(B,j[it]*q,it<dt-1?j[it+1]*q:B.length,q,!1);Ct===Ct.next&&(Ct.steiner=!0),J.push(Yf(Ct))}J.sort(Hf);for(let it=0;it<J.length;it++)X=qf(J[it],X);return X}(i,t,v,r)),i.length>80*r){T=1/0,A=1/0;let B=-1/0,j=-1/0;for(let X=r;X<f;X+=r){const q=i[X],J=i[X+1];q<T&&(T=q),J<A&&(A=J),q>B&&(B=q),J>j&&(j=J)}D=Math.max(B-T,j-A),D=D!==0?32767/D:0}return ec(v,x,r,T,A,D,0),x}function Iu(i,t,r,o,f){let v;if(f===function(x,T,A,D){let B=0;for(let j=T,X=A-D;j<A;j+=D)B+=(x[X]-x[j])*(x[j+1]+x[X+1]),X=j;return B}(i,t,r,o)>0)for(let x=t;x<r;x+=o)v=ku(x/o|0,i[x],i[x+1],v);else for(let x=r-o;x>=t;x-=o)v=ku(x/o|0,i[x],i[x+1],v);return v&&Lc(v,v.next)&&(rc(v),v=v.next),v}function ja(i,t){if(!i)return i;t||(t=i);let r,o=i;do if(r=!1,o.steiner||!Lc(o,o.next)&&Fr(o.prev,o,o.next)!==0)o=o.next;else{if(rc(o),o=t=o.prev,o===o.next)break;r=!0}while(r||o!==t);return t}function ec(i,t,r,o,f,v,x){if(!i)return;!x&&v&&function(A,D,B,j){let X=A;do X.z===0&&(X.z=_h(X.x,X.y,D,B,j)),X.prevZ=X.prev,X.nextZ=X.next,X=X.next;while(X!==A);X.prevZ.nextZ=null,X.prevZ=null,function(q){let J,it=1;do{let dt,Ct=q;q=null;let Gt=null;for(J=0;Ct;){J++;let At=Ct,Nt=0;for(let we=0;we<it&&(Nt++,At=At.nextZ,At);we++);let ie=it;for(;Nt>0||ie>0&&At;)Nt!==0&&(ie===0||!At||Ct.z<=At.z)?(dt=Ct,Ct=Ct.nextZ,Nt--):(dt=At,At=At.nextZ,ie--),Gt?Gt.nextZ=dt:q=dt,dt.prevZ=Gt,Gt=dt;Ct=At}Gt.nextZ=null,it*=2}while(J>1)}(X)}(i,o,f,v);let T=i;for(;i.prev!==i.next;){const A=i.prev,D=i.next;if(v?Gf(i,o,f,v):Uf(i))t.push(A.i,i.i,D.i),rc(i),i=D.next,T=D.next;else if((i=D)===T){x?x===1?ec(i=Xf(ja(i),t),t,r,o,f,v,2):x===2&&Wf(i,t,r,o,f,v):ec(ja(i),t,r,o,f,v,1);break}}}function Uf(i){const t=i.prev,r=i,o=i.next;if(Fr(t,r,o)>=0)return!1;const f=t.x,v=r.x,x=o.x,T=t.y,A=r.y,D=o.y,B=f<v?f<x?f:x:v<x?v:x,j=T<A?T<D?T:D:A<D?A:D,X=f>v?f>x?f:x:v>x?v:x,q=T>A?T>D?T:D:A>D?A:D;let J=o.next;for(;J!==t;){if(J.x>=B&&J.x<=X&&J.y>=j&&J.y<=q&&dl(f,T,v,A,x,D,J.x,J.y)&&Fr(J.prev,J,J.next)>=0)return!1;J=J.next}return!0}function Gf(i,t,r,o){const f=i.prev,v=i,x=i.next;if(Fr(f,v,x)>=0)return!1;const T=f.x,A=v.x,D=x.x,B=f.y,j=v.y,X=x.y,q=T<A?T<D?T:D:A<D?A:D,J=B<j?B<X?B:X:j<X?j:X,it=T>A?T>D?T:D:A>D?A:D,dt=B>j?B>X?B:X:j>X?j:X,Ct=_h(q,J,t,r,o),Gt=_h(it,dt,t,r,o);let At=i.prevZ,Nt=i.nextZ;for(;At&&At.z>=Ct&&Nt&&Nt.z<=Gt;){if(At.x>=q&&At.x<=it&&At.y>=J&&At.y<=dt&&At!==f&&At!==x&&dl(T,B,A,j,D,X,At.x,At.y)&&Fr(At.prev,At,At.next)>=0||(At=At.prevZ,Nt.x>=q&&Nt.x<=it&&Nt.y>=J&&Nt.y<=dt&&Nt!==f&&Nt!==x&&dl(T,B,A,j,D,X,Nt.x,Nt.y)&&Fr(Nt.prev,Nt,Nt.next)>=0))return!1;Nt=Nt.nextZ}for(;At&&At.z>=Ct;){if(At.x>=q&&At.x<=it&&At.y>=J&&At.y<=dt&&At!==f&&At!==x&&dl(T,B,A,j,D,X,At.x,At.y)&&Fr(At.prev,At,At.next)>=0)return!1;At=At.prevZ}for(;Nt&&Nt.z<=Gt;){if(Nt.x>=q&&Nt.x<=it&&Nt.y>=J&&Nt.y<=dt&&Nt!==f&&Nt!==x&&dl(T,B,A,j,D,X,Nt.x,Nt.y)&&Fr(Nt.prev,Nt,Nt.next)>=0)return!1;Nt=Nt.nextZ}return!0}function Xf(i,t){let r=i;do{const o=r.prev,f=r.next.next;!Lc(o,f)&&Au(o,r,r.next,f)&&ic(o,f)&&ic(f,o)&&(t.push(o.i,r.i,f.i),rc(r),rc(r.next),r=i=f),r=r.next}while(r!==i);return ja(r)}function Wf(i,t,r,o,f,v){let x=i;do{let T=x.next.next;for(;T!==x.prev;){if(x.i!==T.i&&Zf(x,T)){let A=Mu(x,T);return x=ja(x,x.next),A=ja(A,A.next),ec(x,t,r,o,f,v,0),void ec(A,t,r,o,f,v,0)}T=T.next}x=x.next}while(x!==i)}function Hf(i,t){return i.x-t.x}function qf(i,t){const r=function(f,v){let x=v;const T=f.x,A=f.y;let D,B=-1/0;do{if(A<=x.y&&A>=x.next.y&&x.next.y!==x.y){const it=x.x+(A-x.y)*(x.next.x-x.x)/(x.next.y-x.y);if(it<=T&&it>B&&(B=it,D=x.x<x.next.x?x:x.next,it===T))return D}x=x.next}while(x!==v);if(!D)return null;const j=D,X=D.x,q=D.y;let J=1/0;x=D;do{if(T>=x.x&&x.x>=X&&T!==x.x&&dl(A<q?T:B,A,X,q,A<q?B:T,A,x.x,x.y)){const it=Math.abs(A-x.y)/(T-x.x);ic(x,f)&&(it<J||it===J&&(x.x>D.x||x.x===D.x&&$f(D,x)))&&(D=x,J=it)}x=x.next}while(x!==j);return D}(i,t);if(!r)return t;const o=Mu(r,i);return ja(o,o.next),ja(r,r.next)}function $f(i,t){return Fr(i.prev,i,t.prev)<0&&Fr(t.next,i,i.next)<0}function _h(i,t,r,o,f){return(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=(i-r)*f|0)|i<<8))|i<<4))|i<<2))|i<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-o)*f|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Yf(i){let t=i,r=i;do(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next;while(t!==i);return r}function dl(i,t,r,o,f,v,x,T){return(f-x)*(t-T)>=(i-x)*(v-T)&&(i-x)*(o-T)>=(r-x)*(t-T)&&(r-x)*(v-T)>=(f-x)*(o-T)}function Zf(i,t){return i.next.i!==t.i&&i.prev.i!==t.i&&!function(r,o){let f=r;do{if(f.i!==r.i&&f.next.i!==r.i&&f.i!==o.i&&f.next.i!==o.i&&Au(f,f.next,r,o))return!0;f=f.next}while(f!==r);return!1}(i,t)&&(ic(i,t)&&ic(t,i)&&function(r,o){let f=r,v=!1;const x=(r.x+o.x)/2,T=(r.y+o.y)/2;do f.y>T!=f.next.y>T&&f.next.y!==f.y&&x<(f.next.x-f.x)*(T-f.y)/(f.next.y-f.y)+f.x&&(v=!v),f=f.next;while(f!==r);return v}(i,t)&&(Fr(i.prev,i,t.prev)||Fr(i,t.prev,t))||Lc(i,t)&&Fr(i.prev,i,i.next)>0&&Fr(t.prev,t,t.next)>0)}function Fr(i,t,r){return(t.y-i.y)*(r.x-t.x)-(t.x-i.x)*(r.y-t.y)}function Lc(i,t){return i.x===t.x&&i.y===t.y}function Au(i,t,r,o){const f=Fc(Fr(i,t,r)),v=Fc(Fr(i,t,o)),x=Fc(Fr(r,o,i)),T=Fc(Fr(r,o,t));return f!==v&&x!==T||!(f!==0||!zc(i,r,t))||!(v!==0||!zc(i,o,t))||!(x!==0||!zc(r,i,o))||!(T!==0||!zc(r,t,o))}function zc(i,t,r){return t.x<=Math.max(i.x,r.x)&&t.x>=Math.min(i.x,r.x)&&t.y<=Math.max(i.y,r.y)&&t.y>=Math.min(i.y,r.y)}function Fc(i){return i>0?1:i<0?-1:0}function ic(i,t){return Fr(i.prev,i,i.next)<0?Fr(i,t,i.next)>=0&&Fr(i,i.prev,t)>=0:Fr(i,t,i.prev)<0||Fr(i,i.next,t)<0}function Mu(i,t){const r=yh(i.i,i.x,i.y),o=yh(t.i,t.x,t.y),f=i.next,v=t.prev;return i.next=t,t.prev=i,r.next=f,f.prev=r,o.next=r,r.prev=o,v.next=o,o.prev=v,o}function ku(i,t,r,o){const f=yh(i,t,r);return o?(f.next=o.next,f.prev=o,o.next.prev=f,o.next=f):(f.prev=f,f.next=f),f}function rc(i){i.next.prev=i.prev,i.prev.next=i.next,i.prevZ&&(i.prevZ.nextZ=i.nextZ),i.nextZ&&(i.nextZ.prevZ=i.prevZ)}function yh(i,t,r){return{i,x:t,y:r,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function vh(i,t,r){const o=r.patternDependencies;let f=!1;for(const v of t){const x=v.paint.get(`${i}-pattern`);x.isConstant()||(f=!0);const T=x.constantOr(null);T&&(f=!0,o[T.to]=!0,o[T.from]=!0)}return f}function xh(i,t,r,o,f){const v=f.patternDependencies;for(const x of t){const T=x.paint.get(`${i}-pattern`).value;if(T.kind!=="constant"){let A=T.evaluate({zoom:o-1},r,{},f.availableImages),D=T.evaluate({zoom:o},r,{},f.availableImages),B=T.evaluate({zoom:o+1},r,{},f.availableImages);A=A&&A.name?A.name:A,D=D&&D.name?D.name:D,B=B&&B.name?B.name:B,v[A]=!0,v[D]=!0,v[B]=!0,r.patterns[x.id]={min:A,mid:D,max:B}}}return r}class bh{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new ia,this.indexArray=new Hr,this.indexArray2=new Cr,this.programConfigurations=new Fa(t.layers,t.zoom),this.segments=new Gr,this.segments2=new Gr,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(t,r,o){this.hasPattern=vh("fill",this.layers,r);const f=this.layers[0].layout.get("fill-sort-key"),v=!f.isConstant(),x=[];for(const{feature:T,id:A,index:D,sourceLayerIndex:B}of t){const j=this.layers[0]._featureFilter.needGeometry,X=Ba(T,j);if(!this.layers[0]._featureFilter.filter(new pr(this.zoom),X,o))continue;const q=v?f.evaluate(X,{},o,r.availableImages):void 0,J={id:A,properties:T.properties,type:T.type,sourceLayerIndex:B,index:D,geometry:j?X.geometry:Ra(T),patterns:{},sortKey:q};x.push(J)}v&&x.sort((T,A)=>T.sortKey-A.sortKey);for(const T of x){const{geometry:A,index:D,sourceLayerIndex:B}=T;if(this.hasPattern){const j=xh("fill",this.layers,T,this.zoom,r);this.patternFeatures.push(j)}else this.addFeature(T,A,D,o,{});r.featureIndex.insert(t[D].feature,A,D,B,this.index)}}update(t,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,r,this.stateDependentLayers,o)}addFeatures(t,r,o){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,r,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Vf),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(t,r,o,f,v){for(const x of Us(r,500)){let T=0;for(const q of x)T+=q.length;const A=this.segments.prepareSegment(T,this.layoutVertexArray,this.indexArray),D=A.vertexLength,B=[],j=[];for(const q of x){if(q.length===0)continue;q!==x[0]&&j.push(B.length/2);const J=this.segments2.prepareSegment(q.length,this.layoutVertexArray,this.indexArray2),it=J.vertexLength;this.layoutVertexArray.emplaceBack(q[0].x,q[0].y),this.indexArray2.emplaceBack(it+q.length-1,it),B.push(q[0].x),B.push(q[0].y);for(let dt=1;dt<q.length;dt++)this.layoutVertexArray.emplaceBack(q[dt].x,q[dt].y),this.indexArray2.emplaceBack(it+dt-1,it+dt),B.push(q[dt].x),B.push(q[dt].y);J.vertexLength+=q.length,J.primitiveLength+=q.length}const X=Pu(B,j);for(let q=0;q<X.length;q+=3)this.indexArray.emplaceBack(D+X[q],D+X[q+1],D+X[q+2]);A.vertexLength+=T,A.primitiveLength+=X.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,v,f)}}let Ou,Du;Ze("FillBucket",bh,{omit:["layers","patternFeatures"]});var Kf={get paint(){return Du=Du||new a({"fill-antialias":new ai(at.paint_fill["fill-antialias"]),"fill-opacity":new mi(at.paint_fill["fill-opacity"]),"fill-color":new mi(at.paint_fill["fill-color"]),"fill-outline-color":new mi(at.paint_fill["fill-outline-color"]),"fill-translate":new ai(at.paint_fill["fill-translate"]),"fill-translate-anchor":new ai(at.paint_fill["fill-translate-anchor"]),"fill-pattern":new y(at.paint_fill["fill-pattern"])})},get layout(){return Ou=Ou||new a({"fill-sort-key":new mi(at.layout_fill["fill-sort-key"])})}};class Jf extends _{constructor(t){super(t,Kf)}recalculate(t,r){super.recalculate(t,r);const o=this.paint._values["fill-outline-color"];o.value.kind==="constant"&&o.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(t){return new bh(t)}queryRadius(){return kc(this.paint.get("fill-translate"))}queryIntersectsFeature(t,r,o,f,v,x,T){return mu(Oc(t,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),x.angle,T),f)}isTileClipped(){return!0}}const Qf=R([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),tp=R([{name:"a_centroid",components:2,type:"Int16"}],4),{members:ep}=Qf;var aa={},ip=C,Lu=fl;function fl(i,t,r,o,f){this.properties={},this.extent=r,this.type=0,this._pbf=i,this._geometry=-1,this._keys=o,this._values=f,i.readFields(rp,this,t)}function rp(i,t,r){i==1?t.id=r.readVarint():i==2?function(o,f){for(var v=o.readVarint()+o.pos;o.pos<v;){var x=f._keys[o.readVarint()],T=f._values[o.readVarint()];f.properties[x]=T}}(r,t):i==3?t.type=r.readVarint():i==4&&(t._geometry=r.pos)}function np(i){for(var t,r,o=0,f=0,v=i.length,x=v-1;f<v;x=f++)o+=((r=i[x]).x-(t=i[f]).x)*(t.y+r.y);return o}fl.types=["Unknown","Point","LineString","Polygon"],fl.prototype.loadGeometry=function(){var i=this._pbf;i.pos=this._geometry;for(var t,r=i.readVarint()+i.pos,o=1,f=0,v=0,x=0,T=[];i.pos<r;){if(f<=0){var A=i.readVarint();o=7&A,f=A>>3}if(f--,o===1||o===2)v+=i.readSVarint(),x+=i.readSVarint(),o===1&&(t&&T.push(t),t=[]),t.push(new ip(v,x));else{if(o!==7)throw new Error("unknown command "+o);t&&t.push(t[0].clone())}}return t&&T.push(t),T},fl.prototype.bbox=function(){var i=this._pbf;i.pos=this._geometry;for(var t=i.readVarint()+i.pos,r=1,o=0,f=0,v=0,x=1/0,T=-1/0,A=1/0,D=-1/0;i.pos<t;){if(o<=0){var B=i.readVarint();r=7&B,o=B>>3}if(o--,r===1||r===2)(f+=i.readSVarint())<x&&(x=f),f>T&&(T=f),(v+=i.readSVarint())<A&&(A=v),v>D&&(D=v);else if(r!==7)throw new Error("unknown command "+r)}return[x,A,T,D]},fl.prototype.toGeoJSON=function(i,t,r){var o,f,v=this.extent*Math.pow(2,r),x=this.extent*i,T=this.extent*t,A=this.loadGeometry(),D=fl.types[this.type];function B(q){for(var J=0;J<q.length;J++){var it=q[J];q[J]=[360*(it.x+x)/v-180,360/Math.PI*Math.atan(Math.exp((180-360*(it.y+T)/v)*Math.PI/180))-90]}}switch(this.type){case 1:var j=[];for(o=0;o<A.length;o++)j[o]=A[o][0];B(A=j);break;case 2:for(o=0;o<A.length;o++)B(A[o]);break;case 3:for(A=function(q){var J=q.length;if(J<=1)return[q];for(var it,dt,Ct=[],Gt=0;Gt<J;Gt++){var At=np(q[Gt]);At!==0&&(dt===void 0&&(dt=At<0),dt===At<0?(it&&Ct.push(it),it=[q[Gt]]):it.push(q[Gt]))}return it&&Ct.push(it),Ct}(A),o=0;o<A.length;o++)for(f=0;f<A[o].length;f++)B(A[o][f])}A.length===1?A=A[0]:D="Multi"+D;var X={type:"Feature",geometry:{type:D,coordinates:A},properties:this.properties};return"id"in this&&(X.id=this.id),X};var sp=Lu,zu=Fu;function Fu(i,t){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=i,this._keys=[],this._values=[],this._features=[],i.readFields(op,this,t),this.length=this._features.length}function op(i,t,r){i===15?t.version=r.readVarint():i===1?t.name=r.readString():i===5?t.extent=r.readVarint():i===2?t._features.push(r.pos):i===3?t._keys.push(r.readString()):i===4&&t._values.push(function(o){for(var f=null,v=o.readVarint()+o.pos;o.pos<v;){var x=o.readVarint()>>3;f=x===1?o.readString():x===2?o.readFloat():x===3?o.readDouble():x===4?o.readVarint64():x===5?o.readVarint():x===6?o.readSVarint():x===7?o.readBoolean():null}return f}(r))}Fu.prototype.feature=function(i){if(i<0||i>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[i];var t=this._pbf.readVarint()+this._pbf.pos;return new sp(this._pbf,t,this.extent,this._keys,this._values)};var ap=zu;function lp(i,t,r){if(i===3){var o=new ap(r,r.readVarint()+r.pos);o.length&&(t[o.name]=o)}}aa.VectorTile=function(i,t){this.layers=i.readFields(lp,{},t)},aa.VectorTileFeature=Lu,aa.VectorTileLayer=zu;const cp=aa.VectorTileFeature.types,wh=Math.pow(2,13);function nc(i,t,r,o,f,v,x,T){i.emplaceBack(t,r,2*Math.floor(o*wh)+x,f*wh*2,v*wh*2,Math.round(T))}class Ch{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.index=t.index,this.hasPattern=!1,this.layoutVertexArray=new Lo,this.centroidVertexArray=new Do,this.indexArray=new Hr,this.programConfigurations=new Fa(t.layers,t.zoom),this.segments=new Gr,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(t,r,o){this.features=[],this.hasPattern=vh("fill-extrusion",this.layers,r);for(const{feature:f,id:v,index:x,sourceLayerIndex:T}of t){const A=this.layers[0]._featureFilter.needGeometry,D=Ba(f,A);if(!this.layers[0]._featureFilter.filter(new pr(this.zoom),D,o))continue;const B={id:v,sourceLayerIndex:T,index:x,geometry:A?D.geometry:Ra(f),properties:f.properties,type:f.type,patterns:{}};this.hasPattern?this.features.push(xh("fill-extrusion",this.layers,B,this.zoom,r)):this.addFeature(B,B.geometry,x,o,{}),r.featureIndex.insert(f,B.geometry,x,T,this.index,!0)}}addFeatures(t,r,o){for(const f of this.features){const{geometry:v}=f;this.addFeature(f,v,f.index,r,o)}}update(t,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,r,this.stateDependentLayers,o)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,ep),this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,tp.members,!0),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(t,r,o,f,v){for(const x of Us(r,500)){const T={x:0,y:0,vertexCount:0};let A=0;for(const J of x)A+=J.length;let D=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);for(const J of x){if(J.length===0||up(J))continue;let it=0;for(let dt=0;dt<J.length;dt++){const Ct=J[dt];if(dt>=1){const Gt=J[dt-1];if(!hp(Ct,Gt)){D.vertexLength+4>Gr.MAX_VERTEX_ARRAY_LENGTH&&(D=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const At=Ct.sub(Gt)._perp()._unit(),Nt=Gt.dist(Ct);it+Nt>32768&&(it=0),nc(this.layoutVertexArray,Ct.x,Ct.y,At.x,At.y,0,0,it),nc(this.layoutVertexArray,Ct.x,Ct.y,At.x,At.y,0,1,it),T.x+=2*Ct.x,T.y+=2*Ct.y,T.vertexCount+=2,it+=Nt,nc(this.layoutVertexArray,Gt.x,Gt.y,At.x,At.y,0,0,it),nc(this.layoutVertexArray,Gt.x,Gt.y,At.x,At.y,0,1,it),T.x+=2*Gt.x,T.y+=2*Gt.y,T.vertexCount+=2;const ie=D.vertexLength;this.indexArray.emplaceBack(ie,ie+2,ie+1),this.indexArray.emplaceBack(ie+1,ie+2,ie+3),D.vertexLength+=4,D.primitiveLength+=2}}}}if(D.vertexLength+A>Gr.MAX_VERTEX_ARRAY_LENGTH&&(D=this.segments.prepareSegment(A,this.layoutVertexArray,this.indexArray)),cp[t.type]!=="Polygon")continue;const B=[],j=[],X=D.vertexLength;for(const J of x)if(J.length!==0){J!==x[0]&&j.push(B.length/2);for(let it=0;it<J.length;it++){const dt=J[it];nc(this.layoutVertexArray,dt.x,dt.y,0,0,1,1,0),T.x+=dt.x,T.y+=dt.y,T.vertexCount+=1,B.push(dt.x),B.push(dt.y)}}const q=Pu(B,j);for(let J=0;J<q.length;J+=3)this.indexArray.emplaceBack(X+q[J],X+q[J+2],X+q[J+1]);D.primitiveLength+=q.length/3,D.vertexLength+=A;for(let J=0;J<T.vertexCount;J++){const it=Math.floor(T.x/T.vertexCount),dt=Math.floor(T.y/T.vertexCount);this.centroidVertexArray.emplaceBack(it,dt)}}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,v,f)}}function hp(i,t){return i.x===t.x&&(i.x<0||i.x>jr)||i.y===t.y&&(i.y<0||i.y>jr)}function up(i){return i.every(t=>t.x<0)||i.every(t=>t.x>jr)||i.every(t=>t.y<0)||i.every(t=>t.y>jr)}let Ru;Ze("FillExtrusionBucket",Ch,{omit:["layers","features"]});var dp={get paint(){return Ru=Ru||new a({"fill-extrusion-opacity":new ai(at["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new mi(at["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ai(at["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ai(at["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new y(at["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new mi(at["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new mi(at["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new ai(at["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class fp extends _{constructor(t){super(t,dp)}createBucket(t){return new Ch(t)}queryRadius(){return kc(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature(t,r,o,f,v,x,T,A){const D=Oc(t,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),x.angle,T),B=this.paint.get("fill-extrusion-height").evaluate(r,o),j=this.paint.get("fill-extrusion-base").evaluate(r,o),X=function(J,it,dt,Ct){const Gt=[];for(const At of J){const Nt=[At.x,At.y,0,1];Dc(Nt,Nt,it),Gt.push(new l(Nt[0]/Nt[3],Nt[1]/Nt[3]))}return Gt}(D,A),q=function(J,it,dt,Ct){const Gt=[],At=[],Nt=Ct[8]*it,ie=Ct[9]*it,we=Ct[10]*it,We=Ct[11]*it,fi=Ct[8]*dt,Ue=Ct[9]*dt,Be=Ct[10]*dt,oi=Ct[11]*dt;for(const Je of J){const Ye=[],de=[];for(const li of Je){const si=li.x,xi=li.y,lr=Ct[0]*si+Ct[4]*xi+Ct[12],rr=Ct[1]*si+Ct[5]*xi+Ct[13],qr=Ct[2]*si+Ct[6]*xi+Ct[14],xs=Ct[3]*si+Ct[7]*xi+Ct[15],cn=qr+we,Dr=xs+We,Tn=lr+fi,En=rr+Ue,Pn=qr+Be,Lr=xs+oi,$r=new l((lr+Nt)/Dr,(rr+ie)/Dr);$r.z=cn/Dr,Ye.push($r);const yn=new l(Tn/Lr,En/Lr);yn.z=Pn/Lr,de.push(yn)}Gt.push(Ye),At.push(de)}return[Gt,At]}(f,j,B,A);return function(J,it,dt){let Ct=1/0;mu(dt,it)&&(Ct=Bu(dt,it[0]));for(let Gt=0;Gt<it.length;Gt++){const At=it[Gt],Nt=J[Gt];for(let ie=0;ie<At.length-1;ie++){const we=At[ie],We=[we,At[ie+1],Nt[ie+1],Nt[ie],we];pu(dt,We)&&(Ct=Math.min(Ct,Bu(dt,We)))}}return Ct!==1/0&&Ct}(q[0],q[1],X)}}function sc(i,t){return i.x*t.x+i.y*t.y}function Bu(i,t){if(i.length===1){let r=0;const o=t[r++];let f;for(;!f||o.equals(f);)if(f=t[r++],!f)return 1/0;for(;r<t.length;r++){const v=t[r],x=i[0],T=f.sub(o),A=v.sub(o),D=x.sub(o),B=sc(T,T),j=sc(T,A),X=sc(A,A),q=sc(D,T),J=sc(D,A),it=B*X-j*j,dt=(X*q-j*J)/it,Ct=(B*J-j*q)/it,Gt=o.z*(1-dt-Ct)+f.z*dt+v.z*Ct;if(isFinite(Gt))return Gt}return 1/0}{let r=1/0;for(const o of t)r=Math.min(r,o.z);return r}}const pp=R([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:mp}=pp,gp=R([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:_p}=gp,yp=aa.VectorTileFeature.types,vp=Math.cos(Math.PI/180*37.5),ju=Math.pow(2,14)/.5;class Sh{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(r=>{this.gradients[r.id]={}}),this.layoutVertexArray=new sl,this.layoutVertexArray2=new Hl,this.indexArray=new Hr,this.programConfigurations=new Fa(t.layers,t.zoom),this.segments=new Gr,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(t,r,o){this.hasPattern=vh("line",this.layers,r);const f=this.layers[0].layout.get("line-sort-key"),v=!f.isConstant(),x=[];for(const{feature:T,id:A,index:D,sourceLayerIndex:B}of t){const j=this.layers[0]._featureFilter.needGeometry,X=Ba(T,j);if(!this.layers[0]._featureFilter.filter(new pr(this.zoom),X,o))continue;const q=v?f.evaluate(X,{},o):void 0,J={id:A,properties:T.properties,type:T.type,sourceLayerIndex:B,index:D,geometry:j?X.geometry:Ra(T),patterns:{},sortKey:q};x.push(J)}v&&x.sort((T,A)=>T.sortKey-A.sortKey);for(const T of x){const{geometry:A,index:D,sourceLayerIndex:B}=T;if(this.hasPattern){const j=xh("line",this.layers,T,this.zoom,r);this.patternFeatures.push(j)}else this.addFeature(T,A,D,o,{});r.featureIndex.insert(t[D].feature,A,D,B,this.index)}}update(t,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,r,this.stateDependentLayers,o)}addFeatures(t,r,o){for(const f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,r,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,_p)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,mp),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t){if(t.properties&&Object.prototype.hasOwnProperty.call(t.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(t.properties,"mapbox_clip_end"))return{start:+t.properties.mapbox_clip_start,end:+t.properties.mapbox_clip_end}}addFeature(t,r,o,f,v){const x=this.layers[0].layout,T=x.get("line-join").evaluate(t,{}),A=x.get("line-cap"),D=x.get("line-miter-limit"),B=x.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(const j of r)this.addLine(j,t,T,A,D,B);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,v,f)}addLine(t,r,o,f,v,x){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Ct=0;Ct<t.length-1;Ct++)this.totalDistance+=t[Ct].dist(t[Ct+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const T=yp[r.type]==="Polygon";let A=t.length;for(;A>=2&&t[A-1].equals(t[A-2]);)A--;let D=0;for(;D<A-1&&t[D].equals(t[D+1]);)D++;if(A<(T?3:2))return;o==="bevel"&&(v=1.05);const B=this.overscaling<=16?15*jr/(512*this.overscaling):0,j=this.segments.prepareSegment(10*A,this.layoutVertexArray,this.indexArray);let X,q,J,it,dt;this.e1=this.e2=-1,T&&(X=t[A-2],dt=t[D].sub(X)._unit()._perp());for(let Ct=D;Ct<A;Ct++){if(J=Ct===A-1?T?t[D+1]:void 0:t[Ct+1],J&&t[Ct].equals(J))continue;dt&&(it=dt),X&&(q=X),X=t[Ct],dt=J?J.sub(X)._unit()._perp():it,it=it||dt;let Gt=it.add(dt);Gt.x===0&&Gt.y===0||Gt._unit();const At=it.x*dt.x+it.y*dt.y,Nt=Gt.x*dt.x+Gt.y*dt.y,ie=Nt!==0?1/Nt:1/0,we=2*Math.sqrt(2-2*Nt),We=Nt<vp&&q&&J,fi=it.x*dt.y-it.y*dt.x>0;if(We&&Ct>D){const oi=X.dist(q);if(oi>2*B){const Je=X.sub(X.sub(q)._mult(B/oi)._round());this.updateDistance(q,Je),this.addCurrentVertex(Je,it,0,0,j),q=Je}}const Ue=q&&J;let Be=Ue?o:T?"butt":f;if(Ue&&Be==="round"&&(ie<x?Be="miter":ie<=2&&(Be="fakeround")),Be==="miter"&&ie>v&&(Be="bevel"),Be==="bevel"&&(ie>2&&(Be="flipbevel"),ie<v&&(Be="miter")),q&&this.updateDistance(q,X),Be==="miter")Gt._mult(ie),this.addCurrentVertex(X,Gt,0,0,j);else if(Be==="flipbevel"){if(ie>100)Gt=dt.mult(-1);else{const oi=ie*it.add(dt).mag()/it.sub(dt).mag();Gt._perp()._mult(oi*(fi?-1:1))}this.addCurrentVertex(X,Gt,0,0,j),this.addCurrentVertex(X,Gt.mult(-1),0,0,j)}else if(Be==="bevel"||Be==="fakeround"){const oi=-Math.sqrt(ie*ie-1),Je=fi?oi:0,Ye=fi?0:oi;if(q&&this.addCurrentVertex(X,it,Je,Ye,j),Be==="fakeround"){const de=Math.round(180*we/Math.PI/20);for(let li=1;li<de;li++){let si=li/de;if(si!==.5){const lr=si-.5;si+=si*lr*(si-1)*((1.0904+At*(At*(3.55645-1.43519*At)-3.2452))*lr*lr+(.848013+At*(.215638*At-1.06021)))}const xi=dt.sub(it)._mult(si)._add(it)._unit()._mult(fi?-1:1);this.addHalfVertex(X,xi.x,xi.y,!1,fi,0,j)}}J&&this.addCurrentVertex(X,dt,-Je,-Ye,j)}else if(Be==="butt")this.addCurrentVertex(X,Gt,0,0,j);else if(Be==="square"){const oi=q?1:-1;this.addCurrentVertex(X,Gt,oi,oi,j)}else Be==="round"&&(q&&(this.addCurrentVertex(X,it,0,0,j),this.addCurrentVertex(X,it,1,1,j,!0)),J&&(this.addCurrentVertex(X,dt,-1,-1,j,!0),this.addCurrentVertex(X,dt,0,0,j)));if(We&&Ct<A-1){const oi=X.dist(J);if(oi>2*B){const Je=X.add(J.sub(X)._mult(B/oi)._round());this.updateDistance(X,Je),this.addCurrentVertex(Je,dt,0,0,j),X=Je}}}}addCurrentVertex(t,r,o,f,v,x=!1){const T=r.y*f-r.x,A=-r.y-r.x*f;this.addHalfVertex(t,r.x+r.y*o,r.y-r.x*o,x,!1,o,v),this.addHalfVertex(t,T,A,x,!0,-f,v),this.distance>ju/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(t,r,o,f,v,x))}addHalfVertex({x:t,y:r},o,f,v,x,T,A){const D=.5*(this.lineClips?this.scaledDistance*(ju-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((t<<1)+(v?1:0),(r<<1)+(x?1:0),Math.round(63*o)+128,Math.round(63*f)+128,1+(T===0?0:T<0?-1:1)|(63&D)<<2,D>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const B=A.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,B),A.primitiveLength++),x?this.e2=B:this.e1=B}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(t,r){this.distance+=t.dist(r),this.updateScaledDistance()}}let Nu,Vu;Ze("LineBucket",Sh,{omit:["layers","patternFeatures"]});var Uu={get paint(){return Vu=Vu||new a({"line-opacity":new mi(at.paint_line["line-opacity"]),"line-color":new mi(at.paint_line["line-color"]),"line-translate":new ai(at.paint_line["line-translate"]),"line-translate-anchor":new ai(at.paint_line["line-translate-anchor"]),"line-width":new mi(at.paint_line["line-width"]),"line-gap-width":new mi(at.paint_line["line-gap-width"]),"line-offset":new mi(at.paint_line["line-offset"]),"line-blur":new mi(at.paint_line["line-blur"]),"line-dasharray":new e(at.paint_line["line-dasharray"]),"line-pattern":new y(at.paint_line["line-pattern"]),"line-gradient":new n(at.paint_line["line-gradient"])})},get layout(){return Nu=Nu||new a({"line-cap":new ai(at.layout_line["line-cap"]),"line-join":new mi(at.layout_line["line-join"]),"line-miter-limit":new ai(at.layout_line["line-miter-limit"]),"line-round-limit":new ai(at.layout_line["line-round-limit"]),"line-sort-key":new mi(at.layout_line["line-sort-key"])})}};class xp extends mi{possiblyEvaluate(t,r){return r=new pr(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,zoomHistory:r.zoomHistory,transition:r.transition}),super.possiblyEvaluate(t,r)}evaluate(t,r,o,f){return r=nt({},r,{zoom:Math.floor(r.zoom)}),super.evaluate(t,r,o,f)}}let Rc;class bp extends _{constructor(t){super(t,Uu),this.gradientVersion=0,Rc||(Rc=new xp(Uu.paint.properties["line-width"].specification),Rc.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(t){if(t==="line-gradient"){const r=this.gradientExpression();this.stepInterpolant=!!function(o){return o._styleExpression!==void 0}(r)&&r._styleExpression.expression instanceof xe,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(t,r){super.recalculate(t,r),this.paint._values["line-floorwidth"]=Rc.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,t)}createBucket(t){return new Sh(t)}queryRadius(t){const r=t,o=Gu(Jl("line-width",this,r),Jl("line-gap-width",this,r)),f=Jl("line-offset",this,r);return o/2+Math.abs(f)+kc(this.paint.get("line-translate"))}queryIntersectsFeature(t,r,o,f,v,x,T){const A=Oc(t,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),x.angle,T),D=T/2*Gu(this.paint.get("line-width").evaluate(r,o),this.paint.get("line-gap-width").evaluate(r,o)),B=this.paint.get("line-offset").evaluate(r,o);return B&&(f=function(j,X){const q=[];for(let J=0;J<j.length;J++){const it=j[J],dt=[];for(let Ct=0;Ct<it.length;Ct++){const Gt=it[Ct-1],At=it[Ct],Nt=it[Ct+1],ie=Ct===0?new l(0,0):At.sub(Gt)._unit()._perp(),we=Ct===it.length-1?new l(0,0):Nt.sub(At)._unit()._perp(),We=ie._add(we)._unit(),fi=We.x*we.x+We.y*we.y;fi!==0&&We._mult(1/fi),dt.push(We._mult(X)._add(At))}q.push(dt)}return q}(f,B*T)),function(j,X,q){for(let J=0;J<X.length;J++){const it=X[J];if(j.length>=3){for(let dt=0;dt<it.length;dt++)if(hl(j,it[dt]))return!0}if(Mf(j,it,q))return!0}return!1}(A,f,D)}isTileClipped(){return!0}}function Gu(i,t){return t>0?t+2*i:i}const wp=R([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Cp=R([{name:"a_projected_pos",components:3,type:"Float32"}],4);R([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Sp=R([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);R([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Xu=R([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Tp=R([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function Ep(i,t,r){return i.sections.forEach(o=>{o.text=function(f,v,x){const T=v.layout.get("text-transform").evaluate(x,{});return T==="uppercase"?f=f.toLocaleUpperCase():T==="lowercase"&&(f=f.toLocaleLowerCase()),to.applyArabicShaping&&(f=to.applyArabicShaping(f)),f}(o.text,t,r)}),i}R([{name:"triangle",components:3,type:"Uint16"}]),R([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),R([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),R([{type:"Float32",name:"offsetX"}]),R([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),R([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);const oc={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};var Xr=24,Wu=ir,Hu=function(i,t,r,o,f){var v,x,T=8*f-o-1,A=(1<<T)-1,D=A>>1,B=-7,j=f-1,X=-1,q=i[t+j];for(j+=X,v=q&(1<<-B)-1,q>>=-B,B+=T;B>0;v=256*v+i[t+j],j+=X,B-=8);for(x=v&(1<<-B)-1,v>>=-B,B+=o;B>0;x=256*x+i[t+j],j+=X,B-=8);if(v===0)v=1-D;else{if(v===A)return x?NaN:1/0*(q?-1:1);x+=Math.pow(2,o),v-=D}return(q?-1:1)*x*Math.pow(2,v-o)},qu=function(i,t,r,o,f,v){var x,T,A,D=8*v-f-1,B=(1<<D)-1,j=B>>1,X=f===23?Math.pow(2,-24)-Math.pow(2,-77):0,q=0,J=1,it=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(T=isNaN(t)?1:0,x=B):(x=Math.floor(Math.log(t)/Math.LN2),t*(A=Math.pow(2,-x))<1&&(x--,A*=2),(t+=x+j>=1?X/A:X*Math.pow(2,1-j))*A>=2&&(x++,A/=2),x+j>=B?(T=0,x=B):x+j>=1?(T=(t*A-1)*Math.pow(2,f),x+=j):(T=t*Math.pow(2,j-1)*Math.pow(2,f),x=0));f>=8;i[r+q]=255&T,q+=J,T/=256,f-=8);for(x=x<<f|T,D+=f;D>0;i[r+q]=255&x,q+=J,x/=256,D-=8);i[r+q-J]|=128*it};function ir(i){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(i)?i:new Uint8Array(i||0),this.pos=0,this.type=0,this.length=this.buf.length}ir.Varint=0,ir.Fixed64=1,ir.Bytes=2,ir.Fixed32=5;var Th=4294967296,$u=1/Th,Yu=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");function Fo(i){return i.type===ir.Bytes?i.readVarint()+i.pos:i.pos+1}function pl(i,t,r){return r?4294967296*t+(i>>>0):4294967296*(t>>>0)+(i>>>0)}function Zu(i,t,r){var o=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));r.realloc(o);for(var f=r.pos-1;f>=i;f--)r.buf[f+o]=r.buf[f]}function Pp(i,t){for(var r=0;r<i.length;r++)t.writeVarint(i[r])}function Ip(i,t){for(var r=0;r<i.length;r++)t.writeSVarint(i[r])}function Ap(i,t){for(var r=0;r<i.length;r++)t.writeFloat(i[r])}function Mp(i,t){for(var r=0;r<i.length;r++)t.writeDouble(i[r])}function kp(i,t){for(var r=0;r<i.length;r++)t.writeBoolean(i[r])}function Op(i,t){for(var r=0;r<i.length;r++)t.writeFixed32(i[r])}function Dp(i,t){for(var r=0;r<i.length;r++)t.writeSFixed32(i[r])}function Lp(i,t){for(var r=0;r<i.length;r++)t.writeFixed64(i[r])}function zp(i,t){for(var r=0;r<i.length;r++)t.writeSFixed64(i[r])}function Bc(i,t){return(i[t]|i[t+1]<<8|i[t+2]<<16)+16777216*i[t+3]}function ml(i,t,r){i[r]=t,i[r+1]=t>>>8,i[r+2]=t>>>16,i[r+3]=t>>>24}function Ku(i,t){return(i[t]|i[t+1]<<8|i[t+2]<<16)+(i[t+3]<<24)}ir.prototype={destroy:function(){this.buf=null},readFields:function(i,t,r){for(r=r||this.length;this.pos<r;){var o=this.readVarint(),f=o>>3,v=this.pos;this.type=7&o,i(f,t,this),this.pos===v&&this.skip(o)}return t},readMessage:function(i,t){return this.readFields(i,t,this.readVarint()+this.pos)},readFixed32:function(){var i=Bc(this.buf,this.pos);return this.pos+=4,i},readSFixed32:function(){var i=Ku(this.buf,this.pos);return this.pos+=4,i},readFixed64:function(){var i=Bc(this.buf,this.pos)+Bc(this.buf,this.pos+4)*Th;return this.pos+=8,i},readSFixed64:function(){var i=Bc(this.buf,this.pos)+Ku(this.buf,this.pos+4)*Th;return this.pos+=8,i},readFloat:function(){var i=Hu(this.buf,this.pos,!0,23,4);return this.pos+=4,i},readDouble:function(){var i=Hu(this.buf,this.pos,!0,52,8);return this.pos+=8,i},readVarint:function(i){var t,r,o=this.buf;return t=127&(r=o[this.pos++]),r<128?t:(t|=(127&(r=o[this.pos++]))<<7,r<128?t:(t|=(127&(r=o[this.pos++]))<<14,r<128?t:(t|=(127&(r=o[this.pos++]))<<21,r<128?t:function(f,v,x){var T,A,D=x.buf;if(T=(112&(A=D[x.pos++]))>>4,A<128||(T|=(127&(A=D[x.pos++]))<<3,A<128)||(T|=(127&(A=D[x.pos++]))<<10,A<128)||(T|=(127&(A=D[x.pos++]))<<17,A<128)||(T|=(127&(A=D[x.pos++]))<<24,A<128)||(T|=(1&(A=D[x.pos++]))<<31,A<128))return pl(f,T,v);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(r=o[this.pos]))<<28,i,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var i=this.readVarint();return i%2==1?(i+1)/-2:i/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var i=this.readVarint()+this.pos,t=this.pos;return this.pos=i,i-t>=12&&Yu?function(r,o,f){return Yu.decode(r.subarray(o,f))}(this.buf,t,i):function(r,o,f){for(var v="",x=o;x<f;){var T,A,D,B=r[x],j=null,X=B>239?4:B>223?3:B>191?2:1;if(x+X>f)break;X===1?B<128&&(j=B):X===2?(192&(T=r[x+1]))==128&&(j=(31&B)<<6|63&T)<=127&&(j=null):X===3?(A=r[x+2],(192&(T=r[x+1]))==128&&(192&A)==128&&((j=(15&B)<<12|(63&T)<<6|63&A)<=2047||j>=55296&&j<=57343)&&(j=null)):X===4&&(A=r[x+2],D=r[x+3],(192&(T=r[x+1]))==128&&(192&A)==128&&(192&D)==128&&((j=(15&B)<<18|(63&T)<<12|(63&A)<<6|63&D)<=65535||j>=1114112)&&(j=null)),j===null?(j=65533,X=1):j>65535&&(j-=65536,v+=String.fromCharCode(j>>>10&1023|55296),j=56320|1023&j),v+=String.fromCharCode(j),x+=X}return v}(this.buf,t,i)},readBytes:function(){var i=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,i);return this.pos=i,t},readPackedVarint:function(i,t){if(this.type!==ir.Bytes)return i.push(this.readVarint(t));var r=Fo(this);for(i=i||[];this.pos<r;)i.push(this.readVarint(t));return i},readPackedSVarint:function(i){if(this.type!==ir.Bytes)return i.push(this.readSVarint());var t=Fo(this);for(i=i||[];this.pos<t;)i.push(this.readSVarint());return i},readPackedBoolean:function(i){if(this.type!==ir.Bytes)return i.push(this.readBoolean());var t=Fo(this);for(i=i||[];this.pos<t;)i.push(this.readBoolean());return i},readPackedFloat:function(i){if(this.type!==ir.Bytes)return i.push(this.readFloat());var t=Fo(this);for(i=i||[];this.pos<t;)i.push(this.readFloat());return i},readPackedDouble:function(i){if(this.type!==ir.Bytes)return i.push(this.readDouble());var t=Fo(this);for(i=i||[];this.pos<t;)i.push(this.readDouble());return i},readPackedFixed32:function(i){if(this.type!==ir.Bytes)return i.push(this.readFixed32());var t=Fo(this);for(i=i||[];this.pos<t;)i.push(this.readFixed32());return i},readPackedSFixed32:function(i){if(this.type!==ir.Bytes)return i.push(this.readSFixed32());var t=Fo(this);for(i=i||[];this.pos<t;)i.push(this.readSFixed32());return i},readPackedFixed64:function(i){if(this.type!==ir.Bytes)return i.push(this.readFixed64());var t=Fo(this);for(i=i||[];this.pos<t;)i.push(this.readFixed64());return i},readPackedSFixed64:function(i){if(this.type!==ir.Bytes)return i.push(this.readSFixed64());var t=Fo(this);for(i=i||[];this.pos<t;)i.push(this.readSFixed64());return i},skip:function(i){var t=7&i;if(t===ir.Varint)for(;this.buf[this.pos++]>127;);else if(t===ir.Bytes)this.pos=this.readVarint()+this.pos;else if(t===ir.Fixed32)this.pos+=4;else{if(t!==ir.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(i,t){this.writeVarint(i<<3|t)},realloc:function(i){for(var t=this.length||16;t<this.pos+i;)t*=2;if(t!==this.length){var r=new Uint8Array(t);r.set(this.buf),this.buf=r,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(i){this.realloc(4),ml(this.buf,i,this.pos),this.pos+=4},writeSFixed32:function(i){this.realloc(4),ml(this.buf,i,this.pos),this.pos+=4},writeFixed64:function(i){this.realloc(8),ml(this.buf,-1&i,this.pos),ml(this.buf,Math.floor(i*$u),this.pos+4),this.pos+=8},writeSFixed64:function(i){this.realloc(8),ml(this.buf,-1&i,this.pos),ml(this.buf,Math.floor(i*$u),this.pos+4),this.pos+=8},writeVarint:function(i){(i=+i||0)>268435455||i<0?function(t,r){var o,f;if(t>=0?(o=t%4294967296|0,f=t/4294967296|0):(f=~(-t/4294967296),4294967295^(o=~(-t%4294967296))?o=o+1|0:(o=0,f=f+1|0)),t>=18446744073709552e3||t<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");r.realloc(10),function(v,x,T){T.buf[T.pos++]=127&v|128,v>>>=7,T.buf[T.pos++]=127&v|128,v>>>=7,T.buf[T.pos++]=127&v|128,v>>>=7,T.buf[T.pos++]=127&v|128,T.buf[T.pos]=127&(v>>>=7)}(o,0,r),function(v,x){var T=(7&v)<<4;x.buf[x.pos++]|=T|((v>>>=3)?128:0),v&&(x.buf[x.pos++]=127&v|((v>>>=7)?128:0),v&&(x.buf[x.pos++]=127&v|((v>>>=7)?128:0),v&&(x.buf[x.pos++]=127&v|((v>>>=7)?128:0),v&&(x.buf[x.pos++]=127&v|((v>>>=7)?128:0),v&&(x.buf[x.pos++]=127&v)))))}(f,r)}(i,this):(this.realloc(4),this.buf[this.pos++]=127&i|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=i>>>7&127))))},writeSVarint:function(i){this.writeVarint(i<0?2*-i-1:2*i)},writeBoolean:function(i){this.writeVarint(!!i)},writeString:function(i){i=String(i),this.realloc(4*i.length),this.pos++;var t=this.pos;this.pos=function(o,f,v){for(var x,T,A=0;A<f.length;A++){if((x=f.charCodeAt(A))>55295&&x<57344){if(!T){x>56319||A+1===f.length?(o[v++]=239,o[v++]=191,o[v++]=189):T=x;continue}if(x<56320){o[v++]=239,o[v++]=191,o[v++]=189,T=x;continue}x=T-55296<<10|x-56320|65536,T=null}else T&&(o[v++]=239,o[v++]=191,o[v++]=189,T=null);x<128?o[v++]=x:(x<2048?o[v++]=x>>6|192:(x<65536?o[v++]=x>>12|224:(o[v++]=x>>18|240,o[v++]=x>>12&63|128),o[v++]=x>>6&63|128),o[v++]=63&x|128)}return v}(this.buf,i,this.pos);var r=this.pos-t;r>=128&&Zu(t,r,this),this.pos=t-1,this.writeVarint(r),this.pos+=r},writeFloat:function(i){this.realloc(4),qu(this.buf,i,this.pos,!0,23,4),this.pos+=4},writeDouble:function(i){this.realloc(8),qu(this.buf,i,this.pos,!0,52,8),this.pos+=8},writeBytes:function(i){var t=i.length;this.writeVarint(t),this.realloc(t);for(var r=0;r<t;r++)this.buf[this.pos++]=i[r]},writeRawMessage:function(i,t){this.pos++;var r=this.pos;i(t,this);var o=this.pos-r;o>=128&&Zu(r,o,this),this.pos=r-1,this.writeVarint(o),this.pos+=o},writeMessage:function(i,t,r){this.writeTag(i,ir.Bytes),this.writeRawMessage(t,r)},writePackedVarint:function(i,t){t.length&&this.writeMessage(i,Pp,t)},writePackedSVarint:function(i,t){t.length&&this.writeMessage(i,Ip,t)},writePackedBoolean:function(i,t){t.length&&this.writeMessage(i,kp,t)},writePackedFloat:function(i,t){t.length&&this.writeMessage(i,Ap,t)},writePackedDouble:function(i,t){t.length&&this.writeMessage(i,Mp,t)},writePackedFixed32:function(i,t){t.length&&this.writeMessage(i,Op,t)},writePackedSFixed32:function(i,t){t.length&&this.writeMessage(i,Dp,t)},writePackedFixed64:function(i,t){t.length&&this.writeMessage(i,Lp,t)},writePackedSFixed64:function(i,t){t.length&&this.writeMessage(i,zp,t)},writeBytesField:function(i,t){this.writeTag(i,ir.Bytes),this.writeBytes(t)},writeFixed32Field:function(i,t){this.writeTag(i,ir.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(i,t){this.writeTag(i,ir.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(i,t){this.writeTag(i,ir.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(i,t){this.writeTag(i,ir.Fixed64),this.writeSFixed64(t)},writeVarintField:function(i,t){this.writeTag(i,ir.Varint),this.writeVarint(t)},writeSVarintField:function(i,t){this.writeTag(i,ir.Varint),this.writeSVarint(t)},writeStringField:function(i,t){this.writeTag(i,ir.Bytes),this.writeString(t)},writeFloatField:function(i,t){this.writeTag(i,ir.Fixed32),this.writeFloat(t)},writeDoubleField:function(i,t){this.writeTag(i,ir.Fixed64),this.writeDouble(t)},writeBooleanField:function(i,t){this.writeVarintField(i,!!t)}};var Eh=p(Wu);const Ph=3;function Fp(i,t,r){i===1&&r.readMessage(Rp,t)}function Rp(i,t,r){if(i===3){const{id:o,bitmap:f,width:v,height:x,left:T,top:A,advance:D}=r.readMessage(Bp,{});t.push({id:o,bitmap:new tc({width:v+2*Ph,height:x+2*Ph},f),metrics:{width:v,height:x,left:T,top:A,advance:D}})}}function Bp(i,t,r){i===1?t.id=r.readVarint():i===2?t.bitmap=r.readBytes():i===3?t.width=r.readVarint():i===4?t.height=r.readVarint():i===5?t.left=r.readSVarint():i===6?t.top=r.readSVarint():i===7&&(t.advance=r.readVarint())}const Ju=Ph;function Qu(i){let t=0,r=0;for(const x of i)t+=x.w*x.h,r=Math.max(r,x.w);i.sort((x,T)=>T.h-x.h);const o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),r),h:1/0}];let f=0,v=0;for(const x of i)for(let T=o.length-1;T>=0;T--){const A=o[T];if(!(x.w>A.w||x.h>A.h)){if(x.x=A.x,x.y=A.y,v=Math.max(v,x.y+x.h),f=Math.max(f,x.x+x.w),x.w===A.w&&x.h===A.h){const D=o.pop();T<o.length&&(o[T]=D)}else x.h===A.h?(A.x+=x.w,A.w-=x.w):x.w===A.w?(A.y+=x.h,A.h-=x.h):(o.push({x:A.x+x.w,y:A.y,w:A.w-x.w,h:x.h}),A.y+=x.h,A.h-=x.h);break}}return{w:f,h:v,fill:t/(f*v)||0}}const Fn=1;class Ih{constructor(t,{pixelRatio:r,version:o,stretchX:f,stretchY:v,content:x,textFitWidth:T,textFitHeight:A}){this.paddedRect=t,this.pixelRatio=r,this.stretchX=f,this.stretchY=v,this.content=x,this.version=o,this.textFitWidth=T,this.textFitHeight=A}get tl(){return[this.paddedRect.x+Fn,this.paddedRect.y+Fn]}get br(){return[this.paddedRect.x+this.paddedRect.w-Fn,this.paddedRect.y+this.paddedRect.h-Fn]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2*Fn)/this.pixelRatio,(this.paddedRect.h-2*Fn)/this.pixelRatio]}}class td{constructor(t,r){const o={},f={};this.haveRenderCallbacks=[];const v=[];this.addImages(t,o,v),this.addImages(r,f,v);const{w:x,h:T}=Qu(v),A=new rs({width:x||1,height:T||1});for(const D in t){const B=t[D],j=o[D].paddedRect;rs.copy(B.data,A,{x:0,y:0},{x:j.x+Fn,y:j.y+Fn},B.data)}for(const D in r){const B=r[D],j=f[D].paddedRect,X=j.x+Fn,q=j.y+Fn,J=B.data.width,it=B.data.height;rs.copy(B.data,A,{x:0,y:0},{x:X,y:q},B.data),rs.copy(B.data,A,{x:0,y:it-1},{x:X,y:q-1},{width:J,height:1}),rs.copy(B.data,A,{x:0,y:0},{x:X,y:q+it},{width:J,height:1}),rs.copy(B.data,A,{x:J-1,y:0},{x:X-1,y:q},{width:1,height:it}),rs.copy(B.data,A,{x:0,y:0},{x:X+J,y:q},{width:1,height:it})}this.image=A,this.iconPositions=o,this.patternPositions=f}addImages(t,r,o){for(const f in t){const v=t[f],x={x:0,y:0,w:v.data.width+2*Fn,h:v.data.height+2*Fn};o.push(x),r[f]=new Ih(x,v),v.hasRenderCallback&&this.haveRenderCallbacks.push(f)}}patchUpdatedImages(t,r){t.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const o in t.updatedImages)this.patchUpdatedImage(this.iconPositions[o],t.getImage(o),r),this.patchUpdatedImage(this.patternPositions[o],t.getImage(o),r)}patchUpdatedImage(t,r,o){if(!t||!r||t.version===r.version)return;t.version=r.version;const[f,v]=t.tl;o.update(r.data,void 0,{x:f,y:v})}}var la;Ze("ImagePosition",Ih),Ze("ImageAtlas",td),N.ai=void 0,(la=N.ai||(N.ai={}))[la.none=0]="none",la[la.horizontal=1]="horizontal",la[la.vertical=2]="vertical",la[la.horizontalOnly=3]="horizontalOnly";const ac=-17;class lc{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(t,r){const o=new lc;return o.scale=t||1,o.fontStack=r,o}static forImage(t){const r=new lc;return r.imageName=t,r}}class gl{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,r){const o=new gl;for(let f=0;f<t.sections.length;f++){const v=t.sections[f];v.image?o.addImageSection(v):o.addTextSection(v,r)}return o}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSectionIndex(t){return this.sectionIndex[t]}getCharCode(t){return this.text.charCodeAt(t)}verticalizePunctuation(){this.text=function(t){let r="";for(let o=0;o<t.length;o++){const f=t.charCodeAt(o+1)||null,v=t.charCodeAt(o-1)||null;r+=f&&Cc(f)&&!oc[t[o+1]]||v&&Cc(v)&&!oc[t[o-1]]||!oc[t[o]]?t[o]:oc[t[o]]}return r}(this.text)}trim(){let t=0;for(let o=0;o<this.text.length&&Nc[this.text.charCodeAt(o)];o++)t++;let r=this.text.length;for(let o=this.text.length-1;o>=0&&o>=t&&Nc[this.text.charCodeAt(o)];o--)r--;this.text=this.text.substring(t,r),this.sectionIndex=this.sectionIndex.slice(t,r)}substring(t,r){const o=new gl;return o.text=this.text.substring(t,r),o.sectionIndex=this.sectionIndex.slice(t,r),o.sections=this.sections,o}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,r)=>Math.max(t,this.sections[r].scale),0)}addTextSection(t,r){this.text+=t.text,this.sections.push(lc.forText(t.scale,t.fontStack||r));const o=this.sections.length-1;for(let f=0;f<t.text.length;++f)this.sectionIndex.push(o)}addImageSection(t){const r=t.image?t.image.name:"";if(r.length===0)return void he("Can't add FormattedSection with an empty image.");const o=this.getNextImageSectionCharCode();o?(this.text+=String.fromCharCode(o),this.sections.push(lc.forImage(r)),this.sectionIndex.push(this.sections.length-1)):he("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function jc(i,t,r,o,f,v,x,T,A,D,B,j,X,q,J){const it=gl.fromFeature(i,f);let dt;j===N.ai.vertical&&it.verticalizePunctuation();const{processBidirectionalText:Ct,processStyledBidirectionalText:Gt}=to;if(Ct&&it.sections.length===1){dt=[];const ie=Ct(it.toString(),Ah(it,D,v,t,o,q));for(const we of ie){const We=new gl;We.text=we,We.sections=it.sections;for(let fi=0;fi<we.length;fi++)We.sectionIndex.push(0);dt.push(We)}}else if(Gt){dt=[];const ie=Gt(it.text,it.sectionIndex,Ah(it,D,v,t,o,q));for(const we of ie){const We=new gl;We.text=we[0],We.sectionIndex=we[1],We.sections=it.sections,dt.push(We)}}else dt=function(ie,we){const We=[],fi=ie.text;let Ue=0;for(const Be of we)We.push(ie.substring(Ue,Be)),Ue=Be;return Ue<fi.length&&We.push(ie.substring(Ue,fi.length)),We}(it,Ah(it,D,v,t,o,q));const At=[],Nt={positionedLines:At,text:it.toString(),top:B[1],bottom:B[1],left:B[0],right:B[0],writingMode:j,iconsInText:!1,verticalizable:!1};return function(ie,we,We,fi,Ue,Be,oi,Je,Ye,de,li,si){let xi=0,lr=ac,rr=0,qr=0;const xs=Je==="right"?1:Je==="left"?0:.5;let cn=0;for(const Lr of Ue){Lr.trim();const $r=Lr.getMaxScale(),yn=($r-1)*Xr,hn={positionedGlyphs:[],lineOffset:0};ie.positionedLines[cn]=hn;const In=hn.positionedGlyphs;let un=0;if(!Lr.length()){lr+=Be,++cn;continue}for(let Rn=0;Rn<Lr.length();Rn++){const Ui=Lr.getSection(Rn),mr=Lr.getSectionIndex(Rn),vr=Lr.getCharCode(Rn);let Hn=0,Ir=null,xl=null,no=null,so=Xr;const bs=!(Ye===N.ai.horizontal||!li&&!Gl(vr)||li&&(Nc[vr]||(Dr=vr,Ge.Arabic(Dr)||Ge["Arabic Supplement"](Dr)||Ge["Arabic Extended-A"](Dr)||Ge["Arabic Presentation Forms-A"](Dr)||Ge["Arabic Presentation Forms-B"](Dr))));if(Ui.imageName){const os=fi[Ui.imageName];if(!os)continue;no=Ui.imageName,ie.iconsInText=ie.iconsInText||!0,xl=os.paddedRect;const Qr=os.displaySize;Ui.scale=Ui.scale*Xr/si,Ir={width:Qr[0],height:Qr[1],left:Fn,top:-Ju,advance:bs?Qr[1]:Qr[0]},Hn=yn+(Xr-Qr[1]*Ui.scale),so=Ir.advance;const Ro=bs?Qr[0]*Ui.scale-Xr*$r:Qr[1]*Ui.scale-Xr*$r;Ro>0&&Ro>un&&(un=Ro)}else{const os=We[Ui.fontStack],Qr=os&&os[vr];if(Qr&&Qr.rect)xl=Qr.rect,Ir=Qr.metrics;else{const Ro=we[Ui.fontStack],fc=Ro&&Ro[vr];if(!fc)continue;Ir=fc.metrics}Hn=($r-Ui.scale)*Xr}bs?(ie.verticalizable=!0,In.push({glyph:vr,imageName:no,x:xi,y:lr+Hn,vertical:bs,scale:Ui.scale,fontStack:Ui.fontStack,sectionIndex:mr,metrics:Ir,rect:xl}),xi+=so*Ui.scale+de):(In.push({glyph:vr,imageName:no,x:xi,y:lr+Hn,vertical:bs,scale:Ui.scale,fontStack:Ui.fontStack,sectionIndex:mr,metrics:Ir,rect:xl}),xi+=Ir.advance*Ui.scale+de)}In.length!==0&&(rr=Math.max(xi-de,rr),Up(In,0,In.length-1,xs,un)),xi=0;const ss=Be*$r+un;hn.lineOffset=Math.max(un,yn),lr+=ss,qr=Math.max(ss,qr),++cn}var Dr;const Tn=lr-ac,{horizontalAlign:En,verticalAlign:Pn}=Mh(oi);(function(Lr,$r,yn,hn,In,un,ss,Rn,Ui){const mr=($r-yn)*In;let vr=0;vr=un!==ss?-Rn*hn-ac:(-hn*Ui+.5)*ss;for(const Hn of Lr)for(const Ir of Hn.positionedGlyphs)Ir.x+=mr,Ir.y+=vr})(ie.positionedLines,xs,En,Pn,rr,qr,Be,Tn,Ue.length),ie.top+=-Pn*Tn,ie.bottom=ie.top+Tn,ie.left+=-En*rr,ie.right=ie.left+rr}(Nt,t,r,o,dt,x,T,A,j,D,X,J),!function(ie){for(const we of ie)if(we.positionedGlyphs.length!==0)return!1;return!0}(At)&&Nt}const Nc={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},jp={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},Np={40:!0};function ed(i,t,r,o,f,v){if(t.imageName){const x=o[t.imageName];return x?x.displaySize[0]*t.scale*Xr/v+f:0}{const x=r[t.fontStack],T=x&&x[i];return T?T.metrics.advance*t.scale+f:0}}function id(i,t,r,o){const f=Math.pow(i-t,2);return o?i<t?f/2:2*f:f+Math.abs(r)*r}function Vp(i,t,r){let o=0;return i===10&&(o-=1e4),r&&(o+=150),i!==40&&i!==65288||(o+=50),t!==41&&t!==65289||(o+=50),o}function rd(i,t,r,o,f,v){let x=null,T=id(t,r,f,v);for(const A of o){const D=id(t-A.x,r,f,v)+A.badness;D<=T&&(x=A,T=D)}return{index:i,x:t,priorBreak:x,badness:T}}function nd(i){return i?nd(i.priorBreak).concat(i.index):[]}function Ah(i,t,r,o,f,v){if(!i)return[];const x=[],T=function(j,X,q,J,it,dt){let Ct=0;for(let Gt=0;Gt<j.length();Gt++){const At=j.getSection(Gt);Ct+=ed(j.getCharCode(Gt),At,J,it,X,dt)}return Ct/Math.max(1,Math.ceil(Ct/q))}(i,t,r,o,f,v),A=i.text.indexOf("")>=0;let D=0;for(let j=0;j<i.length();j++){const X=i.getSection(j),q=i.getCharCode(j);if(Nc[q]||(D+=ed(q,X,o,f,t,v)),j<i.length()-1){const J=!((B=q)<11904||!(Ge["Bopomofo Extended"](B)||Ge.Bopomofo(B)||Ge["CJK Compatibility Forms"](B)||Ge["CJK Compatibility Ideographs"](B)||Ge["CJK Compatibility"](B)||Ge["CJK Radicals Supplement"](B)||Ge["CJK Strokes"](B)||Ge["CJK Symbols and Punctuation"](B)||Ge["CJK Unified Ideographs Extension A"](B)||Ge["CJK Unified Ideographs"](B)||Ge["Enclosed CJK Letters and Months"](B)||Ge["Halfwidth and Fullwidth Forms"](B)||Ge.Hiragana(B)||Ge["Ideographic Description Characters"](B)||Ge["Kangxi Radicals"](B)||Ge["Katakana Phonetic Extensions"](B)||Ge.Katakana(B)||Ge["Vertical Forms"](B)||Ge["Yi Radicals"](B)||Ge["Yi Syllables"](B)));(jp[q]||J||X.imageName||j!==i.length()-2&&Np[i.getCharCode(j+1)])&&x.push(rd(j+1,D,T,x,Vp(q,i.getCharCode(j+1),J&&A),!1))}}var B;return nd(rd(i.length(),D,T,x,0,!0))}function Mh(i){let t=.5,r=.5;switch(i){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(i){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:t,verticalAlign:r}}function Up(i,t,r,o,f){if(!o&&!f)return;const v=i[r],x=(i[r].x+v.metrics.advance*v.scale)*o;for(let T=t;T<=r;T++)i[T].x-=x,i[T].y+=f}function Gp(i,t,r){const{horizontalAlign:o,verticalAlign:f}=Mh(r),v=t[0]-i.displaySize[0]*o,x=t[1]-i.displaySize[1]*f;return{image:i,top:x,bottom:x+i.displaySize[1],left:v,right:v+i.displaySize[0]}}function sd(i){var t,r;let o=i.left,f=i.top,v=i.right-o,x=i.bottom-f;const T=(t=i.image.textFitWidth)!==null&&t!==void 0?t:"stretchOrShrink",A=(r=i.image.textFitHeight)!==null&&r!==void 0?r:"stretchOrShrink",D=(i.image.content[2]-i.image.content[0])/(i.image.content[3]-i.image.content[1]);if(A==="proportional"){if(T==="stretchOnly"&&v/x<D||T==="proportional"){const B=Math.ceil(x*D);o*=B/v,v=B}}else if(T==="proportional"&&A==="stretchOnly"&&D!==0&&v/x>D){const B=Math.ceil(v/D);f*=B/x,x=B}return{x1:o,y1:f,x2:o+v,y2:f+x}}function od(i,t,r,o,f,v){const x=i.image;let T;if(x.content){const dt=x.content,Ct=x.pixelRatio||1;T=[dt[0]/Ct,dt[1]/Ct,x.displaySize[0]-dt[2]/Ct,x.displaySize[1]-dt[3]/Ct]}const A=t.left*v,D=t.right*v;let B,j,X,q;r==="width"||r==="both"?(q=f[0]+A-o[3],j=f[0]+D+o[1]):(q=f[0]+(A+D-x.displaySize[0])/2,j=q+x.displaySize[0]);const J=t.top*v,it=t.bottom*v;return r==="height"||r==="both"?(B=f[1]+J-o[0],X=f[1]+it+o[2]):(B=f[1]+(J+it-x.displaySize[1])/2,X=B+x.displaySize[1]),{image:x,top:B,right:j,bottom:X,left:q,collisionPadding:T}}const cc=255,ro=128,ca=cc*ro;function ad(i,t){const{expression:r}=t;if(r.kind==="constant")return{kind:"constant",layoutSize:r.evaluate(new pr(i+1))};if(r.kind==="source")return{kind:"source"};{const{zoomStops:o,interpolationType:f}=r;let v=0;for(;v<o.length&&o[v]<=i;)v++;v=Math.max(0,v-1);let x=v;for(;x<o.length&&o[x]<i+1;)x++;x=Math.min(o.length-1,x);const T=o[v],A=o[x];return r.kind==="composite"?{kind:"composite",minZoom:T,maxZoom:A,interpolationType:f}:{kind:"camera",minZoom:T,maxZoom:A,minSize:r.evaluate(new pr(T)),maxSize:r.evaluate(new pr(A)),interpolationType:f}}}function kh(i,t,r){let o="never";const f=i.get(t);return f?o=f:i.get(r)&&(o="always"),o}const Xp=aa.VectorTileFeature.types,Wp=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Vc(i,t,r,o,f,v,x,T,A,D,B,j,X){const q=T?Math.min(ca,Math.round(T[0])):0,J=T?Math.min(ca,Math.round(T[1])):0;i.emplaceBack(t,r,Math.round(32*o),Math.round(32*f),v,x,(q<<1)+(A?1:0),J,16*D,16*B,256*j,256*X)}function Oh(i,t,r){i.emplaceBack(t.x,t.y,r),i.emplaceBack(t.x,t.y,r),i.emplaceBack(t.x,t.y,r),i.emplaceBack(t.x,t.y,r)}function Hp(i){for(const t of i.sections)if(Xl(t.text))return!0;return!1}class Dh{constructor(t){this.layoutVertexArray=new is,this.indexArray=new Hr,this.programConfigurations=t,this.segments=new Gr,this.dynamicLayoutVertexArray=new eo,this.opacityVertexArray=new ra,this.hasVisibleVertices=!1,this.placedSymbolArray=new _r}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(t,r,o,f){this.isEmpty()||(o&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,wp.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,r),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,Cp.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,Wp,!0),this.opacityVertexBuffer.itemSize=1),(o||f)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}Ze("SymbolBuffers",Dh);class Lh{constructor(t,r,o){this.layoutVertexArray=new t,this.layoutAttributes=r,this.indexArray=new o,this.segments=new Gr,this.collisionVertexArray=new an}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,Sp.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}Ze("CollisionBuffers",Lh);class _l{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(x=>x.id),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=ph([]),this.placementViewportMatrix=ph([]);const r=this.layers[0]._unevaluatedLayout._values;this.textSizeData=ad(this.zoom,r["text-size"]),this.iconSizeData=ad(this.zoom,r["icon-size"]);const o=this.layers[0].layout,f=o.get("symbol-sort-key"),v=o.get("symbol-z-order");this.canOverlap=kh(o,"text-overlap","text-allow-overlap")!=="never"||kh(o,"icon-overlap","icon-allow-overlap")!=="never"||o.get("text-ignore-placement")||o.get("icon-ignore-placement"),this.sortFeaturesByKey=v!=="viewport-y"&&!f.isConstant(),this.sortFeaturesByY=(v==="viewport-y"||v==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,o.get("symbol-placement")==="point"&&(this.writingModes=o.get("text-writing-mode").map(x=>N.ai[x])),this.stateDependentLayerIds=this.layers.filter(x=>x.isStateDependent()).map(x=>x.id),this.sourceID=t.sourceID}createArrays(){this.text=new Dh(new Fa(this.layers,this.zoom,t=>/^text/.test(t))),this.icon=new Dh(new Fa(this.layers,this.zoom,t=>/^icon/.test(t))),this.glyphOffsetArray=new yr,this.lineVertexArray=new Cn,this.symbolInstances=new ts,this.textAnchorOffsets=new nn}calculateGlyphDependencies(t,r,o,f,v){for(let x=0;x<t.length;x++)if(r[t.charCodeAt(x)]=!0,(o||f)&&v){const T=oc[t.charAt(x)];T&&(r[T.charCodeAt(0)]=!0)}}populate(t,r,o){const f=this.layers[0],v=f.layout,x=v.get("text-font"),T=v.get("text-field"),A=v.get("icon-image"),D=(T.value.kind!=="constant"||T.value.value instanceof Xi&&!T.value.value.isEmpty()||T.value.value.toString().length>0)&&(x.value.kind!=="constant"||x.value.value.length>0),B=A.value.kind!=="constant"||!!A.value.value||Object.keys(A.parameters).length>0,j=v.get("symbol-sort-key");if(this.features=[],!D&&!B)return;const X=r.iconDependencies,q=r.glyphDependencies,J=r.availableImages,it=new pr(this.zoom);for(const{feature:dt,id:Ct,index:Gt,sourceLayerIndex:At}of t){const Nt=f._featureFilter.needGeometry,ie=Ba(dt,Nt);if(!f._featureFilter.filter(it,ie,o))continue;let we,We;if(Nt||(ie.geometry=Ra(dt)),D){const Ue=f.getValueAndResolveTokens("text-field",ie,o,J),Be=Xi.factory(Ue),oi=this.hasRTLText=this.hasRTLText||Hp(Be);(!oi||to.getRTLTextPluginStatus()==="unavailable"||oi&&to.isParsed())&&(we=Ep(Be,f,ie))}if(B){const Ue=f.getValueAndResolveTokens("icon-image",ie,o,J);We=Ue instanceof ur?Ue:ur.fromString(Ue)}if(!we&&!We)continue;const fi=this.sortFeaturesByKey?j.evaluate(ie,{},o):void 0;if(this.features.push({id:Ct,text:we,icon:We,index:Gt,sourceLayerIndex:At,geometry:ie.geometry,properties:dt.properties,type:Xp[dt.type],sortKey:fi}),We&&(X[We.name]=!0),we){const Ue=x.evaluate(ie,{},o).join(","),Be=v.get("text-rotation-alignment")!=="viewport"&&v.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(N.ai.vertical)>=0;for(const oi of we.sections)if(oi.image)X[oi.image.name]=!0;else{const Je=Ul(we.toString()),Ye=oi.fontStack||Ue,de=q[Ye]=q[Ye]||{};this.calculateGlyphDependencies(oi.text,de,Be,this.allowVerticalPlacement,Je)}}}v.get("symbol-placement")==="line"&&(this.features=function(dt){const Ct={},Gt={},At=[];let Nt=0;function ie(Ue){At.push(dt[Ue]),Nt++}function we(Ue,Be,oi){const Je=Gt[Ue];return delete Gt[Ue],Gt[Be]=Je,At[Je].geometry[0].pop(),At[Je].geometry[0]=At[Je].geometry[0].concat(oi[0]),Je}function We(Ue,Be,oi){const Je=Ct[Be];return delete Ct[Be],Ct[Ue]=Je,At[Je].geometry[0].shift(),At[Je].geometry[0]=oi[0].concat(At[Je].geometry[0]),Je}function fi(Ue,Be,oi){const Je=oi?Be[0][Be[0].length-1]:Be[0][0];return`${Ue}:${Je.x}:${Je.y}`}for(let Ue=0;Ue<dt.length;Ue++){const Be=dt[Ue],oi=Be.geometry,Je=Be.text?Be.text.toString():null;if(!Je){ie(Ue);continue}const Ye=fi(Je,oi),de=fi(Je,oi,!0);if(Ye in Gt&&de in Ct&&Gt[Ye]!==Ct[de]){const li=We(Ye,de,oi),si=we(Ye,de,At[li].geometry);delete Ct[Ye],delete Gt[de],Gt[fi(Je,At[si].geometry,!0)]=si,At[li].geometry=null}else Ye in Gt?we(Ye,de,oi):de in Ct?We(Ye,de,oi):(ie(Ue),Ct[Ye]=Nt-1,Gt[de]=Nt-1)}return At.filter(Ue=>Ue.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((dt,Ct)=>dt.sortKey-Ct.sortKey)}update(t,r,o){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(t,r,this.layers,o),this.icon.programConfigurations.updatePaintArrays(t,r,this.layers,o))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,r){const o=this.lineVertexArray.length;if(t.segment!==void 0){let f=t.dist(r[t.segment+1]),v=t.dist(r[t.segment]);const x={};for(let T=t.segment+1;T<r.length;T++)x[T]={x:r[T].x,y:r[T].y,tileUnitDistanceFromAnchor:f},T<r.length-1&&(f+=r[T+1].dist(r[T]));for(let T=t.segment||0;T>=0;T--)x[T]={x:r[T].x,y:r[T].y,tileUnitDistanceFromAnchor:v},T>0&&(v+=r[T-1].dist(r[T]));for(let T=0;T<r.length;T++){const A=x[T];this.lineVertexArray.emplaceBack(A.x,A.y,A.tileUnitDistanceFromAnchor)}}return{lineStartIndex:o,lineLength:this.lineVertexArray.length-o}}addSymbols(t,r,o,f,v,x,T,A,D,B,j,X){const q=t.indexArray,J=t.layoutVertexArray,it=t.segments.prepareSegment(4*r.length,J,q,this.canOverlap?x.sortKey:void 0),dt=this.glyphOffsetArray.length,Ct=it.vertexLength,Gt=this.allowVerticalPlacement&&T===N.ai.vertical?Math.PI/2:0,At=x.text&&x.text.sections;for(let Nt=0;Nt<r.length;Nt++){const{tl:ie,tr:we,bl:We,br:fi,tex:Ue,pixelOffsetTL:Be,pixelOffsetBR:oi,minFontScaleX:Je,minFontScaleY:Ye,glyphOffset:de,isSDF:li,sectionIndex:si}=r[Nt],xi=it.vertexLength,lr=de[1];Vc(J,A.x,A.y,ie.x,lr+ie.y,Ue.x,Ue.y,o,li,Be.x,Be.y,Je,Ye),Vc(J,A.x,A.y,we.x,lr+we.y,Ue.x+Ue.w,Ue.y,o,li,oi.x,Be.y,Je,Ye),Vc(J,A.x,A.y,We.x,lr+We.y,Ue.x,Ue.y+Ue.h,o,li,Be.x,oi.y,Je,Ye),Vc(J,A.x,A.y,fi.x,lr+fi.y,Ue.x+Ue.w,Ue.y+Ue.h,o,li,oi.x,oi.y,Je,Ye),Oh(t.dynamicLayoutVertexArray,A,Gt),q.emplaceBack(xi,xi+1,xi+2),q.emplaceBack(xi+1,xi+2,xi+3),it.vertexLength+=4,it.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(de[0]),Nt!==r.length-1&&si===r[Nt+1].sectionIndex||t.programConfigurations.populatePaintArrays(J.length,x,x.index,{},X,At&&At[si])}t.placedSymbolArray.emplaceBack(A.x,A.y,dt,this.glyphOffsetArray.length-dt,Ct,D,B,A.segment,o?o[0]:0,o?o[1]:0,f[0],f[1],T,0,!1,0,j)}_addCollisionDebugVertex(t,r,o,f,v,x){return r.emplaceBack(0,0),t.emplaceBack(o.x,o.y,f,v,Math.round(x.x),Math.round(x.y))}addCollisionDebugVertices(t,r,o,f,v,x,T){const A=v.segments.prepareSegment(4,v.layoutVertexArray,v.indexArray),D=A.vertexLength,B=v.layoutVertexArray,j=v.collisionVertexArray,X=T.anchorX,q=T.anchorY;this._addCollisionDebugVertex(B,j,x,X,q,new l(t,r)),this._addCollisionDebugVertex(B,j,x,X,q,new l(o,r)),this._addCollisionDebugVertex(B,j,x,X,q,new l(o,f)),this._addCollisionDebugVertex(B,j,x,X,q,new l(t,f)),A.vertexLength+=4;const J=v.indexArray;J.emplaceBack(D,D+1),J.emplaceBack(D+1,D+2),J.emplaceBack(D+2,D+3),J.emplaceBack(D+3,D),A.primitiveLength+=4}addDebugCollisionBoxes(t,r,o,f){for(let v=t;v<r;v++){const x=this.collisionBoxArray.get(v);this.addCollisionDebugVertices(x.x1,x.y1,x.x2,x.y2,f?this.textCollisionBox:this.iconCollisionBox,x.anchorPoint,o)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Lh(on,Xu.members,Cr),this.iconCollisionBox=new Lh(on,Xu.members,Cr);for(let t=0;t<this.symbolInstances.length;t++){const r=this.symbolInstances.get(t);this.addDebugCollisionBoxes(r.textBoxStartIndex,r.textBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.verticalTextBoxStartIndex,r.verticalTextBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.iconBoxStartIndex,r.iconBoxEndIndex,r,!1),this.addDebugCollisionBoxes(r.verticalIconBoxStartIndex,r.verticalIconBoxEndIndex,r,!1)}}_deserializeCollisionBoxesForSymbol(t,r,o,f,v,x,T,A,D){const B={};for(let j=r;j<o;j++){const X=t.get(j);B.textBox={x1:X.x1,y1:X.y1,x2:X.x2,y2:X.y2,anchorPointX:X.anchorPointX,anchorPointY:X.anchorPointY},B.textFeatureIndex=X.featureIndex;break}for(let j=f;j<v;j++){const X=t.get(j);B.verticalTextBox={x1:X.x1,y1:X.y1,x2:X.x2,y2:X.y2,anchorPointX:X.anchorPointX,anchorPointY:X.anchorPointY},B.verticalTextFeatureIndex=X.featureIndex;break}for(let j=x;j<T;j++){const X=t.get(j);B.iconBox={x1:X.x1,y1:X.y1,x2:X.x2,y2:X.y2,anchorPointX:X.anchorPointX,anchorPointY:X.anchorPointY},B.iconFeatureIndex=X.featureIndex;break}for(let j=A;j<D;j++){const X=t.get(j);B.verticalIconBox={x1:X.x1,y1:X.y1,x2:X.x2,y2:X.y2,anchorPointX:X.anchorPointX,anchorPointY:X.anchorPointY},B.verticalIconFeatureIndex=X.featureIndex;break}return B}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let r=0;r<this.symbolInstances.length;r++){const o=this.symbolInstances.get(r);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,o.textBoxStartIndex,o.textBoxEndIndex,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o.iconBoxStartIndex,o.iconBoxEndIndex,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(t,r){const o=t.placedSymbolArray.get(r),f=o.vertexStartIndex+4*o.numGlyphs;for(let v=o.vertexStartIndex;v<f;v+=4)t.indexArray.emplaceBack(v,v+1,v+2),t.indexArray.emplaceBack(v+1,v+2,v+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const r=Math.sin(t),o=Math.cos(t),f=[],v=[],x=[];for(let T=0;T<this.symbolInstances.length;++T){x.push(T);const A=this.symbolInstances.get(T);f.push(0|Math.round(r*A.anchorX+o*A.anchorY)),v.push(A.featureIndex)}return x.sort((T,A)=>f[T]-f[A]||v[A]-v[T]),x}addToSortKeyRanges(t,r){const o=this.sortKeyRanges[this.sortKeyRanges.length-1];o&&o.sortKey===r?o.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:r,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const r of this.symbolInstanceIndexes){const o=this.symbolInstances.get(r);this.featureSortOrder.push(o.featureIndex),[o.rightJustifiedTextSymbolIndex,o.centerJustifiedTextSymbolIndex,o.leftJustifiedTextSymbolIndex].forEach((f,v,x)=>{f>=0&&x.indexOf(f)===v&&this.addIndicesForPlacedSymbol(this.text,f)}),o.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,o.verticalPlacedTextSymbolIndex),o.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,o.placedIconSymbolIndex),o.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,o.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let ld,cd;Ze("SymbolBucket",_l,{omit:["layers","collisionBoxArray","features","compareText"]}),_l.MAX_GLYPHS=65535,_l.addDynamicAttributes=Oh;var zh={get paint(){return cd=cd||new a({"icon-opacity":new mi(at.paint_symbol["icon-opacity"]),"icon-color":new mi(at.paint_symbol["icon-color"]),"icon-halo-color":new mi(at.paint_symbol["icon-halo-color"]),"icon-halo-width":new mi(at.paint_symbol["icon-halo-width"]),"icon-halo-blur":new mi(at.paint_symbol["icon-halo-blur"]),"icon-translate":new ai(at.paint_symbol["icon-translate"]),"icon-translate-anchor":new ai(at.paint_symbol["icon-translate-anchor"]),"text-opacity":new mi(at.paint_symbol["text-opacity"]),"text-color":new mi(at.paint_symbol["text-color"],{runtimeType:Zi,getOverride:i=>i.textColor,hasOverride:i=>!!i.textColor}),"text-halo-color":new mi(at.paint_symbol["text-halo-color"]),"text-halo-width":new mi(at.paint_symbol["text-halo-width"]),"text-halo-blur":new mi(at.paint_symbol["text-halo-blur"]),"text-translate":new ai(at.paint_symbol["text-translate"]),"text-translate-anchor":new ai(at.paint_symbol["text-translate-anchor"])})},get layout(){return ld=ld||new a({"symbol-placement":new ai(at.layout_symbol["symbol-placement"]),"symbol-spacing":new ai(at.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ai(at.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new mi(at.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ai(at.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new ai(at.layout_symbol["icon-allow-overlap"]),"icon-overlap":new ai(at.layout_symbol["icon-overlap"]),"icon-ignore-placement":new ai(at.layout_symbol["icon-ignore-placement"]),"icon-optional":new ai(at.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ai(at.layout_symbol["icon-rotation-alignment"]),"icon-size":new mi(at.layout_symbol["icon-size"]),"icon-text-fit":new ai(at.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new ai(at.layout_symbol["icon-text-fit-padding"]),"icon-image":new mi(at.layout_symbol["icon-image"]),"icon-rotate":new mi(at.layout_symbol["icon-rotate"]),"icon-padding":new mi(at.layout_symbol["icon-padding"]),"icon-keep-upright":new ai(at.layout_symbol["icon-keep-upright"]),"icon-offset":new mi(at.layout_symbol["icon-offset"]),"icon-anchor":new mi(at.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ai(at.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ai(at.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ai(at.layout_symbol["text-rotation-alignment"]),"text-field":new mi(at.layout_symbol["text-field"]),"text-font":new mi(at.layout_symbol["text-font"]),"text-size":new mi(at.layout_symbol["text-size"]),"text-max-width":new mi(at.layout_symbol["text-max-width"]),"text-line-height":new ai(at.layout_symbol["text-line-height"]),"text-letter-spacing":new mi(at.layout_symbol["text-letter-spacing"]),"text-justify":new mi(at.layout_symbol["text-justify"]),"text-radial-offset":new mi(at.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ai(at.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new mi(at.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new mi(at.layout_symbol["text-anchor"]),"text-max-angle":new ai(at.layout_symbol["text-max-angle"]),"text-writing-mode":new ai(at.layout_symbol["text-writing-mode"]),"text-rotate":new mi(at.layout_symbol["text-rotate"]),"text-padding":new ai(at.layout_symbol["text-padding"]),"text-keep-upright":new ai(at.layout_symbol["text-keep-upright"]),"text-transform":new mi(at.layout_symbol["text-transform"]),"text-offset":new mi(at.layout_symbol["text-offset"]),"text-allow-overlap":new ai(at.layout_symbol["text-allow-overlap"]),"text-overlap":new ai(at.layout_symbol["text-overlap"]),"text-ignore-placement":new ai(at.layout_symbol["text-ignore-placement"]),"text-optional":new ai(at.layout_symbol["text-optional"])})}};class hd{constructor(t){if(t.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=t.property.overrides?t.property.overrides.runtimeType:Yi,this.defaultValue=t}evaluate(t){if(t.formattedSection){const r=this.defaultValue.property.overrides;if(r&&r.hasOverride(t.formattedSection))return r.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Ze("FormatSectionOverride",hd,{omit:["defaultValue"]});class Uc extends _{constructor(t){super(t,zh)}recalculate(t,r){if(super.recalculate(t,r),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const o=this.layout.get("text-writing-mode");if(o){const f=[];for(const v of o)f.indexOf(v)<0&&f.push(v);this.layout._values["text-writing-mode"]=f}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(t,r,o,f){const v=this.layout.get(t).evaluate(r,{},o,f),x=this._unevaluatedLayout._values[t];return x.isDataDriven()||en(x.value)||!v?v:function(T,A){return A.replace(/{([^{}]+)}/g,(D,B)=>T&&B in T?String(T[B]):"")}(r.properties,v)}createBucket(t){return new _l(t)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const t of zh.paint.overridableProperties){if(!Uc.hasPaintOverride(this.layout,t))continue;const r=this.paint.get(t),o=new hd(r),f=new wr(o,r.property.specification);let v=null;v=r.value.kind==="constant"||r.value.kind==="source"?new Vr("source",f):new Ln("composite",f,r.value.zoomStops),this.paint._values[t]=new vs(r.property,v,r.parameters)}}_handleOverridablePaintPropertyUpdate(t,r,o){return!(!this.layout||r.isDataDriven()||o.isDataDriven())&&Uc.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,r){const o=t.get("text-field"),f=zh.paint.properties[r];let v=!1;const x=T=>{for(const A of T)if(f.overrides&&f.overrides.hasOverride(A))return void(v=!0)};if(o.value.kind==="constant"&&o.value.value instanceof Xi)x(o.value.value.sections);else if(o.value.kind==="source"){const T=D=>{v||(D instanceof Ss&&sr(D.value)===Wi?x(D.value.sections):D instanceof _o?x(D.sections):D.eachChild(T))},A=o.value;A._styleExpression&&T(A._styleExpression.expression)}return v}}let ud;var qp={get paint(){return ud=ud||new a({"background-color":new ai(at.paint_background["background-color"]),"background-pattern":new e(at.paint_background["background-pattern"]),"background-opacity":new ai(at.paint_background["background-opacity"])})}};class $p extends _{constructor(t){super(t,qp)}}let dd;var Yp={get paint(){return dd=dd||new a({"raster-opacity":new ai(at.paint_raster["raster-opacity"]),"raster-hue-rotate":new ai(at.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ai(at.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ai(at.paint_raster["raster-brightness-max"]),"raster-saturation":new ai(at.paint_raster["raster-saturation"]),"raster-contrast":new ai(at.paint_raster["raster-contrast"]),"raster-resampling":new ai(at.paint_raster["raster-resampling"]),"raster-fade-duration":new ai(at.paint_raster["raster-fade-duration"])})}};class Zp extends _{constructor(t){super(t,Yp)}}class Kp extends _{constructor(t){super(t,{}),this.onAdd=r=>{this.implementation.onAdd&&this.implementation.onAdd(r,r.painter.context.gl)},this.onRemove=r=>{this.implementation.onRemove&&this.implementation.onRemove(r,r.painter.context.gl)},this.implementation=t}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class Jp{constructor(t){this._methodToThrottle=t,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._methodToThrottle()},0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const Fh=63710088e-1;class ha{constructor(t,r){if(isNaN(t)||isNaN(r))throw new Error(`Invalid LngLat object: (${t}, ${r})`);if(this.lng=+t,this.lat=+r,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new ha($(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const r=Math.PI/180,o=this.lat*r,f=t.lat*r,v=Math.sin(o)*Math.sin(f)+Math.cos(o)*Math.cos(f)*Math.cos((t.lng-this.lng)*r);return Fh*Math.acos(Math.min(v,1))}static convert(t){if(t instanceof ha)return t;if(Array.isArray(t)&&(t.length===2||t.length===3))return new ha(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&typeof t=="object"&&t!==null)return new ha(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const fd=2*Math.PI*Fh;function pd(i){return fd*Math.cos(i*Math.PI/180)}function md(i){return(180+i)/360}function gd(i){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i*Math.PI/360)))/360}function _d(i,t){return i/pd(t)}function Rh(i){return 360/Math.PI*Math.atan(Math.exp((180-360*i)*Math.PI/180))-90}class Gc{constructor(t,r,o=0){this.x=+t,this.y=+r,this.z=+o}static fromLngLat(t,r=0){const o=ha.convert(t);return new Gc(md(o.lng),gd(o.lat),_d(r,o.lat))}toLngLat(){return new ha(360*this.x-180,Rh(this.y))}toAltitude(){return this.z*pd(Rh(this.y))}meterInMercatorCoordinateUnits(){return 1/fd*(t=Rh(this.y),1/Math.cos(t*Math.PI/180));var t}}function yd(i,t,r){var o=2*Math.PI*6378137/256/Math.pow(2,r);return[i*o-2*Math.PI*6378137/2,t*o-2*Math.PI*6378137/2]}class Bh{constructor(t,r,o){if(t<0||t>25||o<0||o>=Math.pow(2,t)||r<0||r>=Math.pow(2,t))throw new Error(`x=${r}, y=${o}, z=${t} outside of bounds. 0<=x<${Math.pow(2,t)}, 0<=y<${Math.pow(2,t)} 0<=z<=25 `);this.z=t,this.x=r,this.y=o,this.key=hc(0,t,t,r,o)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}url(t,r,o){const f=(x=this.y,T=this.z,A=yd(256*(v=this.x),256*(x=Math.pow(2,T)-x-1),T),D=yd(256*(v+1),256*(x+1),T),A[0]+","+A[1]+","+D[0]+","+D[1]);var v,x,T,A,D;const B=function(j,X,q){let J,it="";for(let dt=j;dt>0;dt--)J=1<<dt-1,it+=(X&J?1:0)+(q&J?2:0);return it}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(o==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,r>1?"@2x":"").replace(/{quadkey}/g,B).replace(/{bbox-epsg-3857}/g,f)}isChildOf(t){const r=this.z-t.z;return r>0&&t.x===this.x>>r&&t.y===this.y>>r}getTilePoint(t){const r=Math.pow(2,this.z);return new l((t.x*r-this.x)*jr,(t.y*r-this.y)*jr)}toString(){return`${this.z}/${this.x}/${this.y}`}}class vd{constructor(t,r){this.wrap=t,this.canonical=r,this.key=hc(t,r.z,r.z,r.x,r.y)}}class ns{constructor(t,r,o,f,v){if(t<o)throw new Error(`overscaledZ should be >= z; overscaledZ = ${t}; z = ${o}`);this.overscaledZ=t,this.wrap=r,this.canonical=new Bh(o,+f,+v),this.key=hc(r,t,o,f,v)}clone(){return new ns(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){if(t>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${t}; overscaledZ = ${this.overscaledZ}`);const r=this.canonical.z-t;return t>this.canonical.z?new ns(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new ns(t,this.wrap,t,this.canonical.x>>r,this.canonical.y>>r)}calculateScaledKey(t,r){if(t>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${t}; overscaledZ = ${this.overscaledZ}`);const o=this.canonical.z-t;return t>this.canonical.z?hc(this.wrap*+r,t,this.canonical.z,this.canonical.x,this.canonical.y):hc(this.wrap*+r,t,t,this.canonical.x>>o,this.canonical.y>>o)}isChildOf(t){if(t.wrap!==this.wrap)return!1;const r=this.canonical.z-t.canonical.z;return t.overscaledZ===0||t.overscaledZ<this.overscaledZ&&t.canonical.x===this.canonical.x>>r&&t.canonical.y===this.canonical.y>>r}children(t){if(this.overscaledZ>=t)return[new ns(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const r=this.canonical.z+1,o=2*this.canonical.x,f=2*this.canonical.y;return[new ns(r,this.wrap,r,o,f),new ns(r,this.wrap,r,o+1,f),new ns(r,this.wrap,r,o,f+1),new ns(r,this.wrap,r,o+1,f+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new ns(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new ns(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new vd(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(t){return this.canonical.getTilePoint(new Gc(t.x-this.wrap,t.y))}}function hc(i,t,r,o,f){(i*=2)<0&&(i=-1*i-1);const v=1<<r;return(v*v*i+v*f+o).toString(36)+r.toString(36)+t.toString(36)}Ze("CanonicalTileID",Bh),Ze("OverscaledTileID",ns,{omit:["posMatrix"]});class xd{constructor(t,r,o,f=1,v=1,x=1,T=0){if(this.uid=t,r.height!==r.width)throw new RangeError("DEM tiles must be square");if(o&&!["mapbox","terrarium","custom"].includes(o))return void he(`"${o}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=r.height;const A=this.dim=r.height-2;switch(this.data=new Uint32Array(r.data.buffer),o){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=f,this.greenFactor=v,this.blueFactor=x,this.baseShift=T;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let D=0;D<A;D++)this.data[this._idx(-1,D)]=this.data[this._idx(0,D)],this.data[this._idx(A,D)]=this.data[this._idx(A-1,D)],this.data[this._idx(D,-1)]=this.data[this._idx(D,0)],this.data[this._idx(D,A)]=this.data[this._idx(D,A-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(A,-1)]=this.data[this._idx(A-1,0)],this.data[this._idx(-1,A)]=this.data[this._idx(0,A-1)],this.data[this._idx(A,A)]=this.data[this._idx(A-1,A-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let D=0;D<A;D++)for(let B=0;B<A;B++){const j=this.get(D,B);j>this.max&&(this.max=j),j<this.min&&(this.min=j)}}get(t,r){const o=new Uint8Array(this.data.buffer),f=4*this._idx(t,r);return this.unpack(o[f],o[f+1],o[f+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(t,r){if(t<-1||t>=this.dim+1||r<-1||r>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(r+1)*this.stride+(t+1)}unpack(t,r,o){return t*this.redFactor+r*this.greenFactor+o*this.blueFactor-this.baseShift}getPixels(){return new rs({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(t,r,o){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let f=r*this.dim,v=r*this.dim+this.dim,x=o*this.dim,T=o*this.dim+this.dim;switch(r){case-1:f=v-1;break;case 1:v=f+1}switch(o){case-1:x=T-1;break;case 1:T=x+1}const A=-r*this.dim,D=-o*this.dim;for(let B=x;B<T;B++)for(let j=f;j<v;j++)this.data[this._idx(j,B)]=t.data[this._idx(j+A,B+D)]}}Ze("DEMData",xd);class bd{constructor(t){this._stringToNumber={},this._numberToString=[];for(let r=0;r<t.length;r++){const o=t[r];this._stringToNumber[o]=r,this._numberToString[r]=o}}encode(t){return this._stringToNumber[t]}decode(t){if(t>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${t} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[t]}}class wd{constructor(t,r,o,f,v){this.type="Feature",this._vectorTileFeature=t,t._z=r,t._x=o,t._y=f,this.properties=t.properties,this.id=v}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={geometry:this.geometry};for(const r in this)r!=="_geometry"&&r!=="_vectorTileFeature"&&(t[r]=this[r]);return t}}class Cd{constructor(t,r){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new Qo(jr,16,0),this.grid3D=new Qo(jr,16,0),this.featureIndexArray=new es,this.promoteId=r}insert(t,r,o,f,v,x){const T=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(o,f,v);const A=x?this.grid3D:this.grid;for(let D=0;D<r.length;D++){const B=r[D],j=[1/0,1/0,-1/0,-1/0];for(let X=0;X<B.length;X++){const q=B[X];j[0]=Math.min(j[0],q.x),j[1]=Math.min(j[1],q.y),j[2]=Math.max(j[2],q.x),j[3]=Math.max(j[3],q.y)}j[0]<jr&&j[1]<jr&&j[2]>=0&&j[3]>=0&&A.insert(T,j[0],j[1],j[2],j[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new aa.VectorTile(new Eh(this.rawTileData)).layers,this.sourceLayerCoder=new bd(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(t,r,o,f){this.loadVTLayers();const v=t.params||{},x=jr/t.tileSize/t.scale,T=Kr(v.filter),A=t.queryGeometry,D=t.queryPadding*x,B=Td(A),j=this.grid.query(B.minX-D,B.minY-D,B.maxX+D,B.maxY+D),X=Td(t.cameraQueryGeometry),q=this.grid3D.query(X.minX-D,X.minY-D,X.maxX+D,X.maxY+D,(dt,Ct,Gt,At)=>function(Nt,ie,we,We,fi){for(const Be of Nt)if(ie<=Be.x&&we<=Be.y&&We>=Be.x&&fi>=Be.y)return!0;const Ue=[new l(ie,we),new l(ie,fi),new l(We,fi),new l(We,we)];if(Nt.length>2){for(const Be of Ue)if(hl(Nt,Be))return!0}for(let Be=0;Be<Nt.length-1;Be++)if(Of(Nt[Be],Nt[Be+1],Ue))return!0;return!1}(t.cameraQueryGeometry,dt-D,Ct-D,Gt+D,At+D));for(const dt of q)j.push(dt);j.sort(Qp);const J={};let it;for(let dt=0;dt<j.length;dt++){const Ct=j[dt];if(Ct===it)continue;it=Ct;const Gt=this.featureIndexArray.get(Ct);let At=null;this.loadMatchingFeature(J,Gt.bucketIndex,Gt.sourceLayerIndex,Gt.featureIndex,T,v.layers,v.availableImages,r,o,f,(Nt,ie,we)=>(At||(At=Ra(Nt)),ie.queryIntersectsFeature(A,Nt,we,At,this.z,t.transform,x,t.pixelPosMatrix)))}return J}loadMatchingFeature(t,r,o,f,v,x,T,A,D,B,j){const X=this.bucketLayerIDs[r];if(x&&!function(dt,Ct){for(let Gt=0;Gt<dt.length;Gt++)if(Ct.indexOf(dt[Gt])>=0)return!0;return!1}(x,X))return;const q=this.sourceLayerCoder.decode(o),J=this.vtLayers[q].feature(f);if(v.needGeometry){const dt=Ba(J,!0);if(!v.filter(new pr(this.tileID.overscaledZ),dt,this.tileID.canonical))return}else if(!v.filter(new pr(this.tileID.overscaledZ),J))return;const it=this.getId(J,q);for(let dt=0;dt<X.length;dt++){const Ct=X[dt];if(x&&x.indexOf(Ct)<0)continue;const Gt=A[Ct];if(!Gt)continue;let At={};it&&B&&(At=B.getState(Gt.sourceLayer||"_geojsonTileLayer",it));const Nt=nt({},D[Ct]);Nt.paint=Sd(Nt.paint,Gt.paint,J,At,T),Nt.layout=Sd(Nt.layout,Gt.layout,J,At,T);const ie=!j||j(J,Gt,At);if(!ie)continue;const we=new wd(J,this.z,this.x,this.y,it);we.layer=Nt;let We=t[Ct];We===void 0&&(We=t[Ct]=[]),We.push({featureIndex:f,feature:we,intersectionZ:ie})}}lookupSymbolFeatures(t,r,o,f,v,x,T,A){const D={};this.loadVTLayers();const B=Kr(v);for(const j of t)this.loadMatchingFeature(D,o,f,j,B,x,T,A,r);return D}hasLayer(t){for(const r of this.bucketLayerIDs)for(const o of r)if(t===o)return!0;return!1}getId(t,r){let o=t.id;return this.promoteId&&(o=t.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[r]],typeof o=="boolean"&&(o=Number(o))),o}}function Sd(i,t,r,o,f){return Ft(i,(v,x)=>{const T=t instanceof rl?t.get(x):null;return T&&T.evaluate?T.evaluate(r,o,f):T})}function Td(i){let t=1/0,r=1/0,o=-1/0,f=-1/0;for(const v of i)t=Math.min(t,v.x),r=Math.min(r,v.y),o=Math.max(o,v.x),f=Math.max(f,v.y);return{minX:t,minY:r,maxX:o,maxY:f}}function Qp(i,t){return t-i}function Ed(i,t,r,o,f){const v=[];for(let x=0;x<i.length;x++){const T=i[x];let A;for(let D=0;D<T.length-1;D++){let B=T[D],j=T[D+1];B.x<t&&j.x<t||(B.x<t?B=new l(t,B.y+(t-B.x)/(j.x-B.x)*(j.y-B.y))._round():j.x<t&&(j=new l(t,B.y+(t-B.x)/(j.x-B.x)*(j.y-B.y))._round()),B.y<r&&j.y<r||(B.y<r?B=new l(B.x+(r-B.y)/(j.y-B.y)*(j.x-B.x),r)._round():j.y<r&&(j=new l(B.x+(r-B.y)/(j.y-B.y)*(j.x-B.x),r)._round()),B.x>=o&&j.x>=o||(B.x>=o?B=new l(o,B.y+(o-B.x)/(j.x-B.x)*(j.y-B.y))._round():j.x>=o&&(j=new l(o,B.y+(o-B.x)/(j.x-B.x)*(j.y-B.y))._round()),B.y>=f&&j.y>=f||(B.y>=f?B=new l(B.x+(f-B.y)/(j.y-B.y)*(j.x-B.x),f)._round():j.y>=f&&(j=new l(B.x+(f-B.y)/(j.y-B.y)*(j.x-B.x),f)._round()),A&&B.equals(A[A.length-1])||(A=[B],v.push(A)),A.push(j)))))}}return v}Ze("FeatureIndex",Cd,{omit:["rawTileData","sourceLayerCoder"]});class ua extends l{constructor(t,r,o,f){super(t,r),this.angle=o,f!==void 0&&(this.segment=f)}clone(){return new ua(this.x,this.y,this.angle,this.segment)}}function Pd(i,t,r,o,f){if(t.segment===void 0||r===0)return!0;let v=t,x=t.segment+1,T=0;for(;T>-r/2;){if(x--,x<0)return!1;T-=i[x].dist(v),v=i[x]}T+=i[x].dist(i[x+1]),x++;const A=[];let D=0;for(;T<r/2;){const B=i[x],j=i[x+1];if(!j)return!1;let X=i[x-1].angleTo(B)-B.angleTo(j);for(X=Math.abs((X+3*Math.PI)%(2*Math.PI)-Math.PI),A.push({distance:T,angleDelta:X}),D+=X;T-A[0].distance>o;)D-=A.shift().angleDelta;if(D>f)return!1;x++,T+=B.dist(j)}return!0}function Id(i){let t=0;for(let r=0;r<i.length-1;r++)t+=i[r].dist(i[r+1]);return t}function Ad(i,t,r){return i?.6*t*r:0}function Md(i,t){return Math.max(i?i.right-i.left:0,t?t.right-t.left:0)}function tm(i,t,r,o,f,v){const x=Ad(r,f,v),T=Md(r,o)*v;let A=0;const D=Id(i)/2;for(let B=0;B<i.length-1;B++){const j=i[B],X=i[B+1],q=j.dist(X);if(A+q>D){const J=(D-A)/q,it=di.number(j.x,X.x,J),dt=di.number(j.y,X.y,J),Ct=new ua(it,dt,X.angleTo(j),B);return Ct._round(),!x||Pd(i,Ct,T,x,t)?Ct:void 0}A+=q}}function em(i,t,r,o,f,v,x,T,A){const D=Ad(o,v,x),B=Md(o,f),j=B*x,X=i[0].x===0||i[0].x===A||i[0].y===0||i[0].y===A;return t-j<t/4&&(t=j+t/4),kd(i,X?t/2*T%t:(B/2+2*v)*x*T%t,t,D,r,j,X,!1,A)}function kd(i,t,r,o,f,v,x,T,A){const D=v/2,B=Id(i);let j=0,X=t-r,q=[];for(let J=0;J<i.length-1;J++){const it=i[J],dt=i[J+1],Ct=it.dist(dt),Gt=dt.angleTo(it);for(;X+r<j+Ct;){X+=r;const At=(X-j)/Ct,Nt=di.number(it.x,dt.x,At),ie=di.number(it.y,dt.y,At);if(Nt>=0&&Nt<A&&ie>=0&&ie<A&&X-D>=0&&X+D<=B){const we=new ua(Nt,ie,Gt,J);we._round(),o&&!Pd(i,we,v,o,f)||q.push(we)}}j+=Ct}return T||q.length||x||(q=kd(i,j/2,r,o,f,v,x,!0,A)),q}Ze("Anchor",ua);const yl=Fn;function Od(i,t,r,o){const f=[],v=i.image,x=v.pixelRatio,T=v.paddedRect.w-2*yl,A=v.paddedRect.h-2*yl;let D={x1:i.left,y1:i.top,x2:i.right,y2:i.bottom};const B=v.stretchX||[[0,T]],j=v.stretchY||[[0,A]],X=(de,li)=>de+li[1]-li[0],q=B.reduce(X,0),J=j.reduce(X,0),it=T-q,dt=A-J;let Ct=0,Gt=q,At=0,Nt=J,ie=0,we=it,We=0,fi=dt;if(v.content&&o){const de=v.content,li=de[2]-de[0],si=de[3]-de[1];(v.textFitWidth||v.textFitHeight)&&(D=sd(i)),Ct=Xc(B,0,de[0]),At=Xc(j,0,de[1]),Gt=Xc(B,de[0],de[2]),Nt=Xc(j,de[1],de[3]),ie=de[0]-Ct,We=de[1]-At,we=li-Gt,fi=si-Nt}const Ue=D.x1,Be=D.y1,oi=D.x2-Ue,Je=D.y2-Be,Ye=(de,li,si,xi)=>{const lr=Wc(de.stretch-Ct,Gt,oi,Ue),rr=Hc(de.fixed-ie,we,de.stretch,q),qr=Wc(li.stretch-At,Nt,Je,Be),xs=Hc(li.fixed-We,fi,li.stretch,J),cn=Wc(si.stretch-Ct,Gt,oi,Ue),Dr=Hc(si.fixed-ie,we,si.stretch,q),Tn=Wc(xi.stretch-At,Nt,Je,Be),En=Hc(xi.fixed-We,fi,xi.stretch,J),Pn=new l(lr,qr),Lr=new l(cn,qr),$r=new l(cn,Tn),yn=new l(lr,Tn),hn=new l(rr/x,xs/x),In=new l(Dr/x,En/x),un=t*Math.PI/180;if(un){const Ui=Math.sin(un),mr=Math.cos(un),vr=[mr,-Ui,Ui,mr];Pn._matMult(vr),Lr._matMult(vr),yn._matMult(vr),$r._matMult(vr)}const ss=de.stretch+de.fixed,Rn=li.stretch+li.fixed;return{tl:Pn,tr:Lr,bl:yn,br:$r,tex:{x:v.paddedRect.x+yl+ss,y:v.paddedRect.y+yl+Rn,w:si.stretch+si.fixed-ss,h:xi.stretch+xi.fixed-Rn},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:hn,pixelOffsetBR:In,minFontScaleX:we/x/oi,minFontScaleY:fi/x/Je,isSDF:r}};if(o&&(v.stretchX||v.stretchY)){const de=Dd(B,it,q),li=Dd(j,dt,J);for(let si=0;si<de.length-1;si++){const xi=de[si],lr=de[si+1];for(let rr=0;rr<li.length-1;rr++)f.push(Ye(xi,li[rr],lr,li[rr+1]))}}else f.push(Ye({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:T+1},{fixed:0,stretch:A+1}));return f}function Xc(i,t,r){let o=0;for(const f of i)o+=Math.max(t,Math.min(r,f[1]))-Math.max(t,Math.min(r,f[0]));return o}function Dd(i,t,r){const o=[{fixed:-yl,stretch:0}];for(const[f,v]of i){const x=o[o.length-1];o.push({fixed:f-x.stretch,stretch:x.stretch}),o.push({fixed:f-x.stretch,stretch:x.stretch+(v-f)})}return o.push({fixed:t+yl,stretch:r}),o}function Wc(i,t,r,o){return i/t*r+o}function Hc(i,t,r,o){return i-t*r/o}class qc{constructor(t,r,o,f,v,x,T,A,D,B){var j;if(this.boxStartIndex=t.length,D){let X=x.top,q=x.bottom;const J=x.collisionPadding;J&&(X-=J[1],q+=J[3]);let it=q-X;it>0&&(it=Math.max(10,it),this.circleDiameter=it)}else{const X=!((j=x.image)===null||j===void 0)&&j.content&&(x.image.textFitWidth||x.image.textFitHeight)?sd(x):{x1:x.left,y1:x.top,x2:x.right,y2:x.bottom};X.y1=X.y1*T-A[0],X.y2=X.y2*T+A[2],X.x1=X.x1*T-A[3],X.x2=X.x2*T+A[1];const q=x.collisionPadding;if(q&&(X.x1-=q[0]*T,X.y1-=q[1]*T,X.x2+=q[2]*T,X.y2+=q[3]*T),B){const J=new l(X.x1,X.y1),it=new l(X.x2,X.y1),dt=new l(X.x1,X.y2),Ct=new l(X.x2,X.y2),Gt=B*Math.PI/180;J._rotate(Gt),it._rotate(Gt),dt._rotate(Gt),Ct._rotate(Gt),X.x1=Math.min(J.x,it.x,dt.x,Ct.x),X.x2=Math.max(J.x,it.x,dt.x,Ct.x),X.y1=Math.min(J.y,it.y,dt.y,Ct.y),X.y2=Math.max(J.y,it.y,dt.y,Ct.y)}t.emplaceBack(r.x,r.y,X.x1,X.y1,X.x2,X.y2,o,f,v)}this.boxEndIndex=t.length}}class im{constructor(t=[],r=(o,f)=>o<f?-1:o>f?1:0){if(this.data=t,this.length=this.data.length,this.compare=r,this.length>0)for(let o=(this.length>>1)-1;o>=0;o--)this._down(o)}push(t){this.data.push(t),this._up(this.length++)}pop(){if(this.length===0)return;const t=this.data[0],r=this.data.pop();return--this.length>0&&(this.data[0]=r,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:r,compare:o}=this,f=r[t];for(;t>0;){const v=t-1>>1,x=r[v];if(o(f,x)>=0)break;r[t]=x,t=v}r[t]=f}_down(t){const{data:r,compare:o}=this,f=this.length>>1,v=r[t];for(;t<f;){let x=1+(t<<1);const T=x+1;if(T<this.length&&o(r[T],r[x])<0&&(x=T),o(r[x],v)>=0)break;r[t]=r[x],t=x}r[t]=v}}function rm(i,t=1,r=!1){let o=1/0,f=1/0,v=-1/0,x=-1/0;const T=i[0];for(let q=0;q<T.length;q++){const J=T[q];(!q||J.x<o)&&(o=J.x),(!q||J.y<f)&&(f=J.y),(!q||J.x>v)&&(v=J.x),(!q||J.y>x)&&(x=J.y)}const A=Math.min(v-o,x-f);let D=A/2;const B=new im([],nm);if(A===0)return new l(o,f);for(let q=o;q<v;q+=A)for(let J=f;J<x;J+=A)B.push(new vl(q+D,J+D,D,i));let j=function(q){let J=0,it=0,dt=0;const Ct=q[0];for(let Gt=0,At=Ct.length,Nt=At-1;Gt<At;Nt=Gt++){const ie=Ct[Gt],we=Ct[Nt],We=ie.x*we.y-we.x*ie.y;it+=(ie.x+we.x)*We,dt+=(ie.y+we.y)*We,J+=3*We}return new vl(it/J,dt/J,0,q)}(i),X=B.length;for(;B.length;){const q=B.pop();(q.d>j.d||!j.d)&&(j=q,r&&console.log("found best %d after %d probes",Math.round(1e4*q.d)/1e4,X)),q.max-j.d<=t||(D=q.h/2,B.push(new vl(q.p.x-D,q.p.y-D,D,i)),B.push(new vl(q.p.x+D,q.p.y-D,D,i)),B.push(new vl(q.p.x-D,q.p.y+D,D,i)),B.push(new vl(q.p.x+D,q.p.y+D,D,i)),X+=4)}return r&&(console.log(`num probes: ${X}`),console.log(`best distance: ${j.d}`)),j.p}function nm(i,t){return t.max-i.max}function vl(i,t,r,o){this.p=new l(i,t),this.h=r,this.d=function(f,v){let x=!1,T=1/0;for(let A=0;A<v.length;A++){const D=v[A];for(let B=0,j=D.length,X=j-1;B<j;X=B++){const q=D[B],J=D[X];q.y>f.y!=J.y>f.y&&f.x<(J.x-q.x)*(f.y-q.y)/(J.y-q.y)+q.x&&(x=!x),T=Math.min(T,gu(f,q,J))}}return(x?1:-1)*Math.sqrt(T)}(this.p,o),this.max=this.d+this.h*Math.SQRT2}var ln;N.ar=void 0,(ln=N.ar||(N.ar={}))[ln.center=1]="center",ln[ln.left=2]="left",ln[ln.right=3]="right",ln[ln.top=4]="top",ln[ln.bottom=5]="bottom",ln[ln["top-left"]=6]="top-left",ln[ln["top-right"]=7]="top-right",ln[ln["bottom-left"]=8]="bottom-left",ln[ln["bottom-right"]=9]="bottom-right";const da=7,jh=Number.POSITIVE_INFINITY;function Ld(i,t){return t[1]!==jh?function(r,o,f){let v=0,x=0;switch(o=Math.abs(o),f=Math.abs(f),r){case"top-right":case"top-left":case"top":x=f-da;break;case"bottom-right":case"bottom-left":case"bottom":x=-f+da}switch(r){case"top-right":case"bottom-right":case"right":v=-o;break;case"top-left":case"bottom-left":case"left":v=o}return[v,x]}(i,t[0],t[1]):function(r,o){let f=0,v=0;o<0&&(o=0);const x=o/Math.SQRT2;switch(r){case"top-right":case"top-left":v=x-da;break;case"bottom-right":case"bottom-left":v=-x+da;break;case"bottom":v=-o+da;break;case"top":v=o-da}switch(r){case"top-right":case"bottom-right":f=-x;break;case"top-left":case"bottom-left":f=x;break;case"left":f=o;break;case"right":f=-o}return[f,v]}(i,t[0])}function zd(i,t,r){var o;const f=i.layout,v=(o=f.get("text-variable-anchor-offset"))===null||o===void 0?void 0:o.evaluate(t,{},r);if(v){const T=v.values,A=[];for(let D=0;D<T.length;D+=2){const B=A[D]=T[D],j=T[D+1].map(X=>X*Xr);B.startsWith("top")?j[1]-=da:B.startsWith("bottom")&&(j[1]+=da),A[D+1]=j}return new Mr(A)}const x=f.get("text-variable-anchor");if(x){let T;T=i._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[f.get("text-radial-offset").evaluate(t,{},r)*Xr,jh]:f.get("text-offset").evaluate(t,{},r).map(D=>D*Xr);const A=[];for(const D of x)A.push(D,Ld(D,T));return new Mr(A)}return null}function Nh(i){switch(i){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function sm(i,t,r,o,f,v,x,T,A,D,B){let j=v.textMaxSize.evaluate(t,{});j===void 0&&(j=x);const X=i.layers[0].layout,q=X.get("icon-offset").evaluate(t,{},B),J=Rd(r.horizontal),it=x/24,dt=i.tilePixelRatio*it,Ct=i.tilePixelRatio*j/24,Gt=i.tilePixelRatio*T,At=i.tilePixelRatio*X.get("symbol-spacing"),Nt=X.get("text-padding")*i.tilePixelRatio,ie=function(de,li,si,xi=1){const lr=de.get("icon-padding").evaluate(li,{},si),rr=lr&&lr.values;return[rr[0]*xi,rr[1]*xi,rr[2]*xi,rr[3]*xi]}(X,t,B,i.tilePixelRatio),we=X.get("text-max-angle")/180*Math.PI,We=X.get("text-rotation-alignment")!=="viewport"&&X.get("symbol-placement")!=="point",fi=X.get("icon-rotation-alignment")==="map"&&X.get("symbol-placement")!=="point",Ue=X.get("symbol-placement"),Be=At/2,oi=X.get("icon-text-fit");let Je;o&&oi!=="none"&&(i.allowVerticalPlacement&&r.vertical&&(Je=od(o,r.vertical,oi,X.get("icon-text-fit-padding"),q,it)),J&&(o=od(o,J,oi,X.get("icon-text-fit-padding"),q,it)));const Ye=(de,li)=>{li.x<0||li.x>=jr||li.y<0||li.y>=jr||function(si,xi,lr,rr,qr,xs,cn,Dr,Tn,En,Pn,Lr,$r,yn,hn,In,un,ss,Rn,Ui,mr,vr,Hn,Ir,xl){const no=si.addToLineVertexArray(xi,lr);let so,bs,os,Qr,Ro=0,fc=0,Vd=0,Ud=0,$h=-1,Yh=-1;const Bo={};let Gd=ll("");if(si.allowVerticalPlacement&&rr.vertical){const vn=Dr.layout.get("text-rotate").evaluate(mr,{},Ir)+90;os=new qc(Tn,xi,En,Pn,Lr,rr.vertical,$r,yn,hn,vn),cn&&(Qr=new qc(Tn,xi,En,Pn,Lr,cn,un,ss,hn,vn))}if(qr){const vn=Dr.layout.get("icon-rotate").evaluate(mr,{}),as=Dr.layout.get("icon-text-fit")!=="none",Na=Od(qr,vn,Hn,as),Rs=cn?Od(cn,vn,Hn,as):void 0;bs=new qc(Tn,xi,En,Pn,Lr,qr,un,ss,!1,vn),Ro=4*Na.length;const Va=si.iconSizeData;let oo=null;Va.kind==="source"?(oo=[ro*Dr.layout.get("icon-size").evaluate(mr,{})],oo[0]>ca&&he(`${si.layerIds[0]}: Value for "icon-size" is >= ${cc}. Reduce your "icon-size".`)):Va.kind==="composite"&&(oo=[ro*vr.compositeIconSizes[0].evaluate(mr,{},Ir),ro*vr.compositeIconSizes[1].evaluate(mr,{},Ir)],(oo[0]>ca||oo[1]>ca)&&he(`${si.layerIds[0]}: Value for "icon-size" is >= ${cc}. Reduce your "icon-size".`)),si.addSymbols(si.icon,Na,oo,Ui,Rn,mr,N.ai.none,xi,no.lineStartIndex,no.lineLength,-1,Ir),$h=si.icon.placedSymbolArray.length-1,Rs&&(fc=4*Rs.length,si.addSymbols(si.icon,Rs,oo,Ui,Rn,mr,N.ai.vertical,xi,no.lineStartIndex,no.lineLength,-1,Ir),Yh=si.icon.placedSymbolArray.length-1)}const Xd=Object.keys(rr.horizontal);for(const vn of Xd){const as=rr.horizontal[vn];if(!so){Gd=ll(as.text);const Rs=Dr.layout.get("text-rotate").evaluate(mr,{},Ir);so=new qc(Tn,xi,En,Pn,Lr,as,$r,yn,hn,Rs)}const Na=as.positionedLines.length===1;if(Vd+=Fd(si,xi,as,xs,Dr,hn,mr,In,no,rr.vertical?N.ai.horizontal:N.ai.horizontalOnly,Na?Xd:[vn],Bo,$h,vr,Ir),Na)break}rr.vertical&&(Ud+=Fd(si,xi,rr.vertical,xs,Dr,hn,mr,In,no,N.ai.vertical,["vertical"],Bo,Yh,vr,Ir));const lm=so?so.boxStartIndex:si.collisionBoxArray.length,cm=so?so.boxEndIndex:si.collisionBoxArray.length,hm=os?os.boxStartIndex:si.collisionBoxArray.length,um=os?os.boxEndIndex:si.collisionBoxArray.length,dm=bs?bs.boxStartIndex:si.collisionBoxArray.length,fm=bs?bs.boxEndIndex:si.collisionBoxArray.length,pm=Qr?Qr.boxStartIndex:si.collisionBoxArray.length,mm=Qr?Qr.boxEndIndex:si.collisionBoxArray.length;let Fs=-1;const Yc=(vn,as)=>vn&&vn.circleDiameter?Math.max(vn.circleDiameter,as):as;Fs=Yc(so,Fs),Fs=Yc(os,Fs),Fs=Yc(bs,Fs),Fs=Yc(Qr,Fs);const Wd=Fs>-1?1:0;Wd&&(Fs*=xl/Xr),si.glyphOffsetArray.length>=_l.MAX_GLYPHS&&he("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),mr.sortKey!==void 0&&si.addToSortKeyRanges(si.symbolInstances.length,mr.sortKey);const gm=zd(Dr,mr,Ir),[_m,ym]=function(vn,as){const Na=vn.length,Rs=as==null?void 0:as.values;if((Rs==null?void 0:Rs.length)>0)for(let Va=0;Va<Rs.length;Va+=2){const oo=Rs[Va+1];vn.emplaceBack(N.ar[Rs[Va]],oo[0],oo[1])}return[Na,vn.length]}(si.textAnchorOffsets,gm);si.symbolInstances.emplaceBack(xi.x,xi.y,Bo.right>=0?Bo.right:-1,Bo.center>=0?Bo.center:-1,Bo.left>=0?Bo.left:-1,Bo.vertical||-1,$h,Yh,Gd,lm,cm,hm,um,dm,fm,pm,mm,En,Vd,Ud,Ro,fc,Wd,0,$r,Fs,_m,ym)}(i,li,de,r,o,f,Je,i.layers[0],i.collisionBoxArray,t.index,t.sourceLayerIndex,i.index,dt,[Nt,Nt,Nt,Nt],We,A,Gt,ie,fi,q,t,v,D,B,x)};if(Ue==="line")for(const de of Ed(t.geometry,0,0,jr,jr)){const li=em(de,At,we,r.vertical||J,o,24,Ct,i.overscaling,jr);for(const si of li)J&&om(i,J.text,Be,si)||Ye(de,si)}else if(Ue==="line-center"){for(const de of t.geometry)if(de.length>1){const li=tm(de,we,r.vertical||J,o,24,Ct);li&&Ye(de,li)}}else if(t.type==="Polygon")for(const de of Us(t.geometry,0)){const li=rm(de,16);Ye(de[0],new ua(li.x,li.y,0))}else if(t.type==="LineString")for(const de of t.geometry)Ye(de,new ua(de[0].x,de[0].y,0));else if(t.type==="Point")for(const de of t.geometry)for(const li of de)Ye([li],new ua(li.x,li.y,0))}function Fd(i,t,r,o,f,v,x,T,A,D,B,j,X,q,J){const it=function(Gt,At,Nt,ie,we,We,fi,Ue){const Be=ie.layout.get("text-rotate").evaluate(We,{})*Math.PI/180,oi=[];for(const Je of At.positionedLines)for(const Ye of Je.positionedGlyphs){if(!Ye.rect)continue;const de=Ye.rect||{};let li=Ju+1,si=!0,xi=1,lr=0;const rr=(we||Ue)&&Ye.vertical,qr=Ye.metrics.advance*Ye.scale/2;if(Ue&&At.verticalizable&&(lr=Je.lineOffset/2-(Ye.imageName?-(Xr-Ye.metrics.width*Ye.scale)/2:(Ye.scale-1)*Xr)),Ye.imageName){const Ui=fi[Ye.imageName];si=Ui.sdf,xi=Ui.pixelRatio,li=Fn/xi}const xs=we?[Ye.x+qr,Ye.y]:[0,0];let cn=we?[0,0]:[Ye.x+qr+Nt[0],Ye.y+Nt[1]-lr],Dr=[0,0];rr&&(Dr=cn,cn=[0,0]);const Tn=Ye.metrics.isDoubleResolution?2:1,En=(Ye.metrics.left-li)*Ye.scale-qr+cn[0],Pn=(-Ye.metrics.top-li)*Ye.scale+cn[1],Lr=En+de.w/Tn*Ye.scale/xi,$r=Pn+de.h/Tn*Ye.scale/xi,yn=new l(En,Pn),hn=new l(Lr,Pn),In=new l(En,$r),un=new l(Lr,$r);if(rr){const Ui=new l(-qr,qr-ac),mr=-Math.PI/2,vr=Xr/2-qr,Hn=new l(5-ac-vr,-(Ye.imageName?vr:0)),Ir=new l(...Dr);yn._rotateAround(mr,Ui)._add(Hn)._add(Ir),hn._rotateAround(mr,Ui)._add(Hn)._add(Ir),In._rotateAround(mr,Ui)._add(Hn)._add(Ir),un._rotateAround(mr,Ui)._add(Hn)._add(Ir)}if(Be){const Ui=Math.sin(Be),mr=Math.cos(Be),vr=[mr,-Ui,Ui,mr];yn._matMult(vr),hn._matMult(vr),In._matMult(vr),un._matMult(vr)}const ss=new l(0,0),Rn=new l(0,0);oi.push({tl:yn,tr:hn,bl:In,br:un,tex:de,writingMode:At.writingMode,glyphOffset:xs,sectionIndex:Ye.sectionIndex,isSDF:si,pixelOffsetTL:ss,pixelOffsetBR:Rn,minFontScaleX:0,minFontScaleY:0})}return oi}(0,r,T,f,v,x,o,i.allowVerticalPlacement),dt=i.textSizeData;let Ct=null;dt.kind==="source"?(Ct=[ro*f.layout.get("text-size").evaluate(x,{})],Ct[0]>ca&&he(`${i.layerIds[0]}: Value for "text-size" is >= ${cc}. Reduce your "text-size".`)):dt.kind==="composite"&&(Ct=[ro*q.compositeTextSizes[0].evaluate(x,{},J),ro*q.compositeTextSizes[1].evaluate(x,{},J)],(Ct[0]>ca||Ct[1]>ca)&&he(`${i.layerIds[0]}: Value for "text-size" is >= ${cc}. Reduce your "text-size".`)),i.addSymbols(i.text,it,Ct,T,v,x,D,t,A.lineStartIndex,A.lineLength,X,J);for(const Gt of B)j[Gt]=i.text.placedSymbolArray.length-1;return 4*it.length}function Rd(i){for(const t in i)return i[t];return null}function om(i,t,r,o){const f=i.compareText;if(t in f){const v=f[t];for(let x=v.length-1;x>=0;x--)if(o.dist(v[x])<r)return!0}else f[t]=[];return f[t].push(o),!1}const Bd=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Vh{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[r,o]=new Uint8Array(t,0,2);if(r!==219)throw new Error("Data does not appear to be in a KDBush format.");const f=o>>4;if(f!==1)throw new Error(`Got v${f} data when expected v1.`);const v=Bd[15&o];if(!v)throw new Error("Unrecognized array type.");const[x]=new Uint16Array(t,2,1),[T]=new Uint32Array(t,4,1);return new Vh(T,x,v,t)}constructor(t,r=64,o=Float64Array,f){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+r,2),65535),this.ArrayType=o,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const v=Bd.indexOf(this.ArrayType),x=2*t*this.ArrayType.BYTES_PER_ELEMENT,T=t*this.IndexArrayType.BYTES_PER_ELEMENT,A=(8-T%8)%8;if(v<0)throw new Error(`Unexpected typed array class: ${o}.`);f&&f instanceof ArrayBuffer?(this.data=f,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+T+A,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+x+T+A),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+T+A,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+v]),new Uint16Array(this.data,2,1)[0]=r,new Uint32Array(this.data,4,1)[0]=t)}add(t,r){const o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=t,this.coords[this._pos++]=r,o}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return Uh(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,r,o,f){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:v,coords:x,nodeSize:T}=this,A=[0,v.length-1,0],D=[];for(;A.length;){const B=A.pop()||0,j=A.pop()||0,X=A.pop()||0;if(j-X<=T){for(let dt=X;dt<=j;dt++){const Ct=x[2*dt],Gt=x[2*dt+1];Ct>=t&&Ct<=o&&Gt>=r&&Gt<=f&&D.push(v[dt])}continue}const q=X+j>>1,J=x[2*q],it=x[2*q+1];J>=t&&J<=o&&it>=r&&it<=f&&D.push(v[q]),(B===0?t<=J:r<=it)&&(A.push(X),A.push(q-1),A.push(1-B)),(B===0?o>=J:f>=it)&&(A.push(q+1),A.push(j),A.push(1-B))}return D}within(t,r,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:f,coords:v,nodeSize:x}=this,T=[0,f.length-1,0],A=[],D=o*o;for(;T.length;){const B=T.pop()||0,j=T.pop()||0,X=T.pop()||0;if(j-X<=x){for(let dt=X;dt<=j;dt++)Nd(v[2*dt],v[2*dt+1],t,r)<=D&&A.push(f[dt]);continue}const q=X+j>>1,J=v[2*q],it=v[2*q+1];Nd(J,it,t,r)<=D&&A.push(f[q]),(B===0?t-o<=J:r-o<=it)&&(T.push(X),T.push(q-1),T.push(1-B)),(B===0?t+o>=J:r+o>=it)&&(T.push(q+1),T.push(j),T.push(1-B))}return A}}function Uh(i,t,r,o,f,v){if(f-o<=r)return;const x=o+f>>1;jd(i,t,x,o,f,v),Uh(i,t,r,o,x-1,1-v),Uh(i,t,r,x+1,f,1-v)}function jd(i,t,r,o,f,v){for(;f>o;){if(f-o>600){const D=f-o+1,B=r-o+1,j=Math.log(D),X=.5*Math.exp(2*j/3),q=.5*Math.sqrt(j*X*(D-X)/D)*(B-D/2<0?-1:1);jd(i,t,r,Math.max(o,Math.floor(r-B*X/D+q)),Math.min(f,Math.floor(r+(D-B)*X/D+q)),v)}const x=t[2*r+v];let T=o,A=f;for(uc(i,t,o,r),t[2*f+v]>x&&uc(i,t,o,f);T<A;){for(uc(i,t,T,A),T++,A--;t[2*T+v]<x;)T++;for(;t[2*A+v]>x;)A--}t[2*o+v]===x?uc(i,t,o,A):(A++,uc(i,t,A,f)),A<=r&&(o=A+1),r<=A&&(f=A-1)}}function uc(i,t,r,o){Gh(i,r,o),Gh(t,2*r,2*o),Gh(t,2*r+1,2*o+1)}function Gh(i,t,r){const o=i[t];i[t]=i[r],i[r]=o}function Nd(i,t,r,o){const f=i-r,v=t-o;return f*f+v*v}var Xh;N.bf=void 0,(Xh=N.bf||(N.bf={})).create="create",Xh.load="load",Xh.fullLoad="fullLoad";let $c=null,dc=[];const Wh=1e3/60,Hh="loadTime",qh="fullLoadTime",am={mark(i){performance.mark(i)},frame(i){const t=i;$c!=null&&dc.push(t-$c),$c=t},clearMetrics(){$c=null,dc=[],performance.clearMeasures(Hh),performance.clearMeasures(qh);for(const i in N.bf)performance.clearMarks(N.bf[i])},getPerformanceMetrics(){performance.measure(Hh,N.bf.create,N.bf.load),performance.measure(qh,N.bf.create,N.bf.fullLoad);const i=performance.getEntriesByName(Hh)[0].duration,t=performance.getEntriesByName(qh)[0].duration,r=dc.length,o=1/(dc.reduce((v,x)=>v+x,0)/r/1e3),f=dc.filter(v=>v>Wh).reduce((v,x)=>v+(x-Wh)/Wh,0);return{loadTime:i,fullLoadTime:t,fps:o,percentDroppedFrames:f/(r+f)*100,totalFrames:r}}};N.$=class extends tt{},N.A=ul,N.B=jl,N.C=function(i){if(Oe==null){const t=i.navigator?i.navigator.userAgent:null;Oe=!!i.safari||!(!t||!(/\b(iPad|iPhone|iPod)\b/.test(t)||t.match("Safari")&&!t.match("Chrome")))}return Oe},N.D=ai,N.E=ae,N.F=class{constructor(i,t){this.target=i,this.mapId=t,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new Jp(()=>this.process()),this.subscription=function(r,o,f,v){return r.addEventListener(o,f,!1),{unsubscribe:()=>{r.removeEventListener(o,f,!1)}}}(this.target,"message",r=>this.receive(r)),this.globalScope=me(self)?i:window}registerMessageHandler(i,t){this.messageHandlers[i]=t}sendAsync(i,t){return new Promise((r,o)=>{const f=Math.round(1e18*Math.random()).toString(36).substring(0,10);this.resolveRejects[f]={resolve:r,reject:o},t&&t.signal.addEventListener("abort",()=>{delete this.resolveRejects[f];const T={id:f,type:"<cancel>",origin:location.origin,targetMapId:i.targetMapId,sourceMapId:this.mapId};this.target.postMessage(T)},{once:!0});const v=[],x=Object.assign(Object.assign({},i),{id:f,sourceMapId:this.mapId,origin:location.origin,data:Da(i.data,v)});this.target.postMessage(x,{transfer:v})})}receive(i){const t=i.data,r=t.id;if(!(t.origin!=="file://"&&location.origin!=="file://"&&t.origin!=="resource://android"&&location.origin!=="resource://android"&&t.origin!==location.origin||t.targetMapId&&this.mapId!==t.targetMapId)){if(t.type==="<cancel>"){delete this.tasks[r];const o=this.abortControllers[r];return delete this.abortControllers[r],void(o&&o.abort())}if(me(self)||t.mustQueue)return this.tasks[r]=t,this.taskQueue.push(r),void this.invoker.trigger();this.processTask(r,t)}}process(){if(this.taskQueue.length===0)return;const i=this.taskQueue.shift(),t=this.tasks[i];delete this.tasks[i],this.taskQueue.length>0&&this.invoker.trigger(),t&&this.processTask(i,t)}processTask(i,t){return s(this,void 0,void 0,function*(){if(t.type==="<response>"){const f=this.resolveRejects[i];return delete this.resolveRejects[i],f?void(t.error?f.reject(ys(t.error)):f.resolve(ys(t.data))):void 0}if(!this.messageHandlers[t.type])return void this.completeTask(i,new Error(`Could not find a registered handler for ${t.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const r=ys(t.data),o=new AbortController;this.abortControllers[i]=o;try{const f=yield this.messageHandlers[t.type](t.sourceMapId,r,o);this.completeTask(i,null,f)}catch(f){this.completeTask(i,f)}})}completeTask(i,t,r){const o=[];delete this.abortControllers[i];const f={id:i,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:t?Da(t):null,data:Da(r,o)};this.target.postMessage(f,{transfer:o})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},N.G=Mt,N.H=function(){var i=new ul(16);return ul!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i},N.I=Ih,N.J=function(i,t,r){var o,f,v,x,T,A,D,B,j,X,q,J,it=r[0],dt=r[1],Ct=r[2];return t===i?(i[12]=t[0]*it+t[4]*dt+t[8]*Ct+t[12],i[13]=t[1]*it+t[5]*dt+t[9]*Ct+t[13],i[14]=t[2]*it+t[6]*dt+t[10]*Ct+t[14],i[15]=t[3]*it+t[7]*dt+t[11]*Ct+t[15]):(f=t[1],v=t[2],x=t[3],T=t[4],A=t[5],D=t[6],B=t[7],j=t[8],X=t[9],q=t[10],J=t[11],i[0]=o=t[0],i[1]=f,i[2]=v,i[3]=x,i[4]=T,i[5]=A,i[6]=D,i[7]=B,i[8]=j,i[9]=X,i[10]=q,i[11]=J,i[12]=o*it+T*dt+j*Ct+t[12],i[13]=f*it+A*dt+X*Ct+t[13],i[14]=v*it+D*dt+q*Ct+t[14],i[15]=x*it+B*dt+J*Ct+t[15]),i},N.K=function(i,t,r){var o=r[0],f=r[1],v=r[2];return i[0]=t[0]*o,i[1]=t[1]*o,i[2]=t[2]*o,i[3]=t[3]*o,i[4]=t[4]*f,i[5]=t[5]*f,i[6]=t[6]*f,i[7]=t[7]*f,i[8]=t[8]*v,i[9]=t[9]*v,i[10]=t[10]*v,i[11]=t[11]*v,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i},N.L=xu,N.M=function(i,t){const r={};for(let o=0;o<t.length;o++){const f=t[o];f in i&&(r[f]=i[f])}return r},N.N=ha,N.O=md,N.P=l,N.Q=gd,N.R=rs,N.S=ns,N.T=ea,N.U=w,N.V=E,N.W=Q,N.X=jr,N.Y=R,N.Z=Gc,N._=s,N.a=pt,N.a$=function(i,t){var r=i[0],o=i[1],f=i[2],v=i[3],x=i[4],T=i[5],A=i[6],D=i[7],B=i[8],j=i[9],X=i[10],q=i[11],J=i[12],it=i[13],dt=i[14],Ct=i[15],Gt=t[0],At=t[1],Nt=t[2],ie=t[3],we=t[4],We=t[5],fi=t[6],Ue=t[7],Be=t[8],oi=t[9],Je=t[10],Ye=t[11],de=t[12],li=t[13],si=t[14],xi=t[15];return Math.abs(r-Gt)<=Sn*Math.max(1,Math.abs(r),Math.abs(Gt))&&Math.abs(o-At)<=Sn*Math.max(1,Math.abs(o),Math.abs(At))&&Math.abs(f-Nt)<=Sn*Math.max(1,Math.abs(f),Math.abs(Nt))&&Math.abs(v-ie)<=Sn*Math.max(1,Math.abs(v),Math.abs(ie))&&Math.abs(x-we)<=Sn*Math.max(1,Math.abs(x),Math.abs(we))&&Math.abs(T-We)<=Sn*Math.max(1,Math.abs(T),Math.abs(We))&&Math.abs(A-fi)<=Sn*Math.max(1,Math.abs(A),Math.abs(fi))&&Math.abs(D-Ue)<=Sn*Math.max(1,Math.abs(D),Math.abs(Ue))&&Math.abs(B-Be)<=Sn*Math.max(1,Math.abs(B),Math.abs(Be))&&Math.abs(j-oi)<=Sn*Math.max(1,Math.abs(j),Math.abs(oi))&&Math.abs(X-Je)<=Sn*Math.max(1,Math.abs(X),Math.abs(Je))&&Math.abs(q-Ye)<=Sn*Math.max(1,Math.abs(q),Math.abs(Ye))&&Math.abs(J-de)<=Sn*Math.max(1,Math.abs(J),Math.abs(de))&&Math.abs(it-li)<=Sn*Math.max(1,Math.abs(it),Math.abs(li))&&Math.abs(dt-si)<=Sn*Math.max(1,Math.abs(dt),Math.abs(si))&&Math.abs(Ct-xi)<=Sn*Math.max(1,Math.abs(Ct),Math.abs(xi))},N.a0=Gr,N.a1=Bh,N.a2=ce,N.a3=i=>{const t=window.document.createElement("video");return t.muted=!0,new Promise(r=>{t.onloadstart=()=>{r(t)};for(const o of i){const f=window.document.createElement("source");Xt(o)||(t.crossOrigin="Anonymous"),f.src=o,t.appendChild(f)}})},N.a4=function(){return xt++},N.a5=Ii,N.a6=_l,N.a7=Kr,N.a8=Ba,N.a9=pr,N.aA=function(i){i=i.slice();const t=Object.create(null);for(let r=0;r<i.length;r++)t[i[r].id]=i[r];for(let r=0;r<i.length;r++)"ref"in i[r]&&(i[r]=pe(i[r],t[i[r].ref]));return i},N.aB=function(i){if(i.type==="custom")return new Kp(i);switch(i.type){case"background":return new $p(i);case"circle":return new zf(i);case"fill":return new Jf(i);case"fill-extrusion":return new fp(i);case"heatmap":return new Rf(i);case"hillshade":return new jf(i);case"line":return new bp(i);case"raster":return new Zp(i);case"symbol":return new Uc(i)}},N.aC=Jt,N.aD=function(i,t){if(!i)return[{command:"setStyle",args:[t]}];let r=[];try{if(!ue(i.version,t.version))return[{command:"setStyle",args:[t]}];ue(i.center,t.center)||r.push({command:"setCenter",args:[t.center]}),ue(i.zoom,t.zoom)||r.push({command:"setZoom",args:[t.zoom]}),ue(i.bearing,t.bearing)||r.push({command:"setBearing",args:[t.bearing]}),ue(i.pitch,t.pitch)||r.push({command:"setPitch",args:[t.pitch]}),ue(i.sprite,t.sprite)||r.push({command:"setSprite",args:[t.sprite]}),ue(i.glyphs,t.glyphs)||r.push({command:"setGlyphs",args:[t.glyphs]}),ue(i.transition,t.transition)||r.push({command:"setTransition",args:[t.transition]}),ue(i.light,t.light)||r.push({command:"setLight",args:[t.light]}),ue(i.terrain,t.terrain)||r.push({command:"setTerrain",args:[t.terrain]}),ue(i.sky,t.sky)||r.push({command:"setSky",args:[t.sky]}),ue(i.projection,t.projection)||r.push({command:"setProjection",args:[t.projection]});const o={},f=[];(function(x,T,A,D){let B;for(B in T=T||{},x=x||{})Object.prototype.hasOwnProperty.call(x,B)&&(Object.prototype.hasOwnProperty.call(T,B)||oe(B,A,D));for(B in T)Object.prototype.hasOwnProperty.call(T,B)&&(Object.prototype.hasOwnProperty.call(x,B)?ue(x[B],T[B])||(x[B].type==="geojson"&&T[B].type==="geojson"&&He(x,T,B)?Fe(A,{command:"setGeoJSONSourceData",args:[B,T[B].data]}):ve(B,T,A,D)):Ke(B,T,A))})(i.sources,t.sources,f,o);const v=[];i.layers&&i.layers.forEach(x=>{"source"in x&&o[x.source]?r.push({command:"removeLayer",args:[x.id]}):v.push(x)}),r=r.concat(f),function(x,T,A){T=T||[];const D=(x=x||[]).map(wi),B=T.map(wi),j=x.reduce(vi,{}),X=T.reduce(vi,{}),q=D.slice(),J=Object.create(null);let it,dt,Ct,Gt,At;for(let Nt=0,ie=0;Nt<D.length;Nt++)it=D[Nt],Object.prototype.hasOwnProperty.call(X,it)?ie++:(Fe(A,{command:"removeLayer",args:[it]}),q.splice(q.indexOf(it,ie),1));for(let Nt=0,ie=0;Nt<B.length;Nt++)it=B[B.length-1-Nt],q[q.length-1-Nt]!==it&&(Object.prototype.hasOwnProperty.call(j,it)?(Fe(A,{command:"removeLayer",args:[it]}),q.splice(q.lastIndexOf(it,q.length-ie),1)):ie++,Gt=q[q.length-Nt],Fe(A,{command:"addLayer",args:[X[it],Gt]}),q.splice(q.length-Nt,0,it),J[it]=!0);for(let Nt=0;Nt<B.length;Nt++)if(it=B[Nt],dt=j[it],Ct=X[it],!J[it]&&!ue(dt,Ct))if(ue(dt.source,Ct.source)&&ue(dt["source-layer"],Ct["source-layer"])&&ue(dt.type,Ct.type)){for(At in ci(dt.layout,Ct.layout,A,it,null,"setLayoutProperty"),ci(dt.paint,Ct.paint,A,it,null,"setPaintProperty"),ue(dt.filter,Ct.filter)||Fe(A,{command:"setFilter",args:[it,Ct.filter]}),ue(dt.minzoom,Ct.minzoom)&&ue(dt.maxzoom,Ct.maxzoom)||Fe(A,{command:"setLayerZoomRange",args:[it,Ct.minzoom,Ct.maxzoom]}),dt)Object.prototype.hasOwnProperty.call(dt,At)&&At!=="layout"&&At!=="paint"&&At!=="filter"&&At!=="metadata"&&At!=="minzoom"&&At!=="maxzoom"&&(At.indexOf("paint.")===0?ci(dt[At],Ct[At],A,it,At.slice(6),"setPaintProperty"):ue(dt[At],Ct[At])||Fe(A,{command:"setLayerProperty",args:[it,At,Ct[At]]}));for(At in Ct)Object.prototype.hasOwnProperty.call(Ct,At)&&!Object.prototype.hasOwnProperty.call(dt,At)&&At!=="layout"&&At!=="paint"&&At!=="filter"&&At!=="metadata"&&At!=="minzoom"&&At!=="maxzoom"&&(At.indexOf("paint.")===0?ci(dt[At],Ct[At],A,it,At.slice(6),"setPaintProperty"):ue(dt[At],Ct[At])||Fe(A,{command:"setLayerProperty",args:[it,At,Ct[At]]}))}else Fe(A,{command:"removeLayer",args:[it]}),Gt=q[q.lastIndexOf(it)+1],Fe(A,{command:"addLayer",args:[Ct,Gt]})}(v,t.layers,r)}catch(o){console.warn("Unable to compute style diff:",o),r=[{command:"setStyle",args:[t]}]}return r},N.aE=function(i){const t=[],r=i.id;return r===void 0&&t.push({message:`layers.${r}: missing required property "id"`}),i.render===void 0&&t.push({message:`layers.${r}: missing required method "render"`}),i.renderingMode&&i.renderingMode!=="2d"&&i.renderingMode!=="3d"&&t.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),t},N.aF=function i(t,r){if(Array.isArray(t)){if(!Array.isArray(r)||t.length!==r.length)return!1;for(let o=0;o<t.length;o++)if(!i(t[o],r[o]))return!1;return!0}if(typeof t=="object"&&t!==null&&r!==null){if(typeof r!="object"||Object.keys(t).length!==Object.keys(r).length)return!1;for(const o in t)if(!i(t[o],r[o]))return!1;return!0}return t===r},N.aG=Ft,N.aH=Kt,N.aI=class extends za{constructor(i,t){super(i,t),this.current=0}set(i){this.current!==i&&(this.current=i,this.gl.uniform1i(this.location,i))}},N.aJ=Ac,N.aK=class extends za{constructor(i,t){super(i,t),this.current=Pf}set(i){if(i[12]!==this.current[12]||i[0]!==this.current[0])return this.current=i,void this.gl.uniformMatrix4fv(this.location,!1,i);for(let t=1;t<16;t++)if(i[t]!==this.current[t]){this.current=i,this.gl.uniformMatrix4fv(this.location,!1,i);break}}},N.aL=cu,N.aM=hu,N.aN=Ri,N.aO=class extends za{constructor(i,t){super(i,t),this.current=[0,0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]&&i[2]===this.current[2]||(this.current=i,this.gl.uniform3f(this.location,i[0],i[1],i[2]))}},N.aP=class extends za{constructor(i,t){super(i,t),this.current=[0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]||(this.current=i,this.gl.uniform2f(this.location,i[0],i[1]))}},N.aQ=function(i,t,r,o,f,v,x){var T=1/(t-r),A=1/(o-f),D=1/(v-x);return i[0]=-2*T,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*A,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*D,i[11]=0,i[12]=(t+r)*T,i[13]=(f+o)*A,i[14]=(x+v)*D,i[15]=1,i},N.aR=Lf,N.aS=class extends _e{},N.aT=Tp,N.aU=class extends Xe{},N.aV=function(i){return i<=1?1:Math.pow(2,Math.ceil(Math.log(i)/Math.LN2))},N.aW=Tu,N.aX=Do,N.aY=Hr,N.aZ=class extends Ve{},N.a_=function(i,t){return i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2]&&i[3]===t[3]&&i[4]===t[4]&&i[5]===t[5]&&i[6]===t[6]&&i[7]===t[7]&&i[8]===t[8]&&i[9]===t[9]&&i[10]===t[10]&&i[11]===t[11]&&i[12]===t[12]&&i[13]===t[13]&&i[14]===t[14]&&i[15]===t[15]},N.aa=wd,N.ab=function(i){const t={};if(i.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,o,f,v)=>{const x=f||v;return t[o]=!x||x.toLowerCase(),""}),t["max-age"]){const r=parseInt(t["max-age"],10);isNaN(r)?delete t["max-age"]:t["max-age"]=r}return t},N.ac=function(i,t){const r=[];for(const o in i)o in t||r.push(o);return r},N.ad=U,N.ae=function(i,t,r){var o=Math.sin(r),f=Math.cos(r),v=t[0],x=t[1],T=t[2],A=t[3],D=t[4],B=t[5],j=t[6],X=t[7];return t!==i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i[0]=v*f+D*o,i[1]=x*f+B*o,i[2]=T*f+j*o,i[3]=A*f+X*o,i[4]=D*f-v*o,i[5]=B*f-x*o,i[6]=j*f-T*o,i[7]=X*f-A*o,i},N.af=function(i){var t=new ul(16);return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],t},N.ag=Dc,N.ah=function(i,t){let r=0,o=0;if(i.kind==="constant")o=i.layoutSize;else if(i.kind!=="source"){const{interpolationType:f,minZoom:v,maxZoom:x}=i,T=f?U(Ni.interpolationFactor(f,t,v,x),0,1):0;i.kind==="camera"?o=di.number(i.minSize,i.maxSize,T):r=T}return{uSizeT:r,uSize:o}},N.aj=function(i,{uSize:t,uSizeT:r},{lowerSize:o,upperSize:f}){return i.kind==="source"?o/ro:i.kind==="composite"?di.number(o/ro,f/ro,r):t},N.ak=Oh,N.al=function(i,t,r,o){const f=t.y-i.y,v=t.x-i.x,x=o.y-r.y,T=o.x-r.x,A=x*v-T*f;if(A===0)return null;const D=(T*(i.y-r.y)-x*(i.x-r.x))/A;return new l(i.x+D*v,i.y+D*f)},N.am=Ed,N.an=pu,N.ao=ph,N.ap=function(i){let t=1/0,r=1/0,o=-1/0,f=-1/0;for(const v of i)t=Math.min(t,v.x),r=Math.min(r,v.y),o=Math.max(o,v.x),f=Math.max(f,v.y);return[t,r,o,f]},N.aq=Xr,N.as=kh,N.at=function(i,t){var r=t[0],o=t[1],f=t[2],v=t[3],x=t[4],T=t[5],A=t[6],D=t[7],B=t[8],j=t[9],X=t[10],q=t[11],J=t[12],it=t[13],dt=t[14],Ct=t[15],Gt=r*T-o*x,At=r*A-f*x,Nt=r*D-v*x,ie=o*A-f*T,we=o*D-v*T,We=f*D-v*A,fi=B*it-j*J,Ue=B*dt-X*J,Be=B*Ct-q*J,oi=j*dt-X*it,Je=j*Ct-q*it,Ye=X*Ct-q*dt,de=Gt*Ye-At*Je+Nt*oi+ie*Be-we*Ue+We*fi;return de?(i[0]=(T*Ye-A*Je+D*oi)*(de=1/de),i[1]=(f*Je-o*Ye-v*oi)*de,i[2]=(it*We-dt*we+Ct*ie)*de,i[3]=(X*we-j*We-q*ie)*de,i[4]=(A*Be-x*Ye-D*Ue)*de,i[5]=(r*Ye-f*Be+v*Ue)*de,i[6]=(dt*Nt-J*We-Ct*At)*de,i[7]=(B*We-X*Nt+q*At)*de,i[8]=(x*Je-T*Be+D*fi)*de,i[9]=(o*Be-r*Je-v*fi)*de,i[10]=(J*we-it*Nt+Ct*Gt)*de,i[11]=(j*Nt-B*we-q*Gt)*de,i[12]=(T*Ue-x*oi-A*fi)*de,i[13]=(r*oi-o*Ue+f*fi)*de,i[14]=(it*At-J*ie-dt*Gt)*de,i[15]=(B*ie-j*At+X*Gt)*de,i):null},N.au=Nh,N.av=Mh,N.aw=Vh,N.ax=function(){const i={},t=at.$version;for(const r in at.$root){const o=at.$root[r];if(o.required){let f=null;f=r==="version"?t:o.type==="array"?[]:{},f!=null&&(i[r]=f)}}return i},N.ay=bc,N.az=te,N.b=se,N.b0=function(i,t){return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i},N.b1=function(i,t,r){return i[0]=t[0]*r[0],i[1]=t[1]*r[1],i[2]=t[2]*r[2],i[3]=t[3]*r[3],i},N.b2=function(i,t){return i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+i[3]*t[3]},N.b3=$,N.b4=vd,N.b5=_d,N.b6=function(i,t,r,o,f){var v,x=1/Math.tan(t/2);return i[0]=x/r,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=x,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,f!=null&&f!==1/0?(i[10]=(f+o)*(v=1/(o-f)),i[14]=2*f*o*v):(i[10]=-1,i[14]=-2*o),i},N.b7=function(i,t,r){var o=Math.sin(r),f=Math.cos(r),v=t[4],x=t[5],T=t[6],A=t[7],D=t[8],B=t[9],j=t[10],X=t[11];return t!==i&&(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i[4]=v*f+D*o,i[5]=x*f+B*o,i[6]=T*f+j*o,i[7]=A*f+X*o,i[8]=D*f-v*o,i[9]=B*f-x*o,i[10]=j*f-T*o,i[11]=X*f-A*o,i},N.b8=O,N.b9=L,N.bA=function(i){return i.message===vt},N.bB=Zr,N.bC=to,N.ba=function(i){return i*Math.PI/180},N.bb=function(i,t){return i[0]=t[0],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t[1],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=t[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},N.bc=class extends Y{},N.bd=Fh,N.be=am,N.bg=jt,N.bh=function(i,t){pt.REGISTERED_PROTOCOLS[i]=t},N.bi=function(i){delete pt.REGISTERED_PROTOCOLS[i]},N.bj=function(i,t){const r={};for(let f=0;f<i.length;f++){const v=t&&t[i[f].id]||Gn(i[f]);t&&(t[i[f].id]=v);let x=r[v];x||(x=r[v]=[]),x.push(i[f])}const o=[];for(const f in r)o.push(r[f]);return o},N.bk=Ze,N.bl=bd,N.bm=Cd,N.bn=td,N.bo=function(i){i.bucket.createArrays(),i.bucket.tilePixelRatio=jr/(512*i.bucket.overscaling),i.bucket.compareText={},i.bucket.iconsNeedLinear=!1;const t=i.bucket.layers[0],r=t.layout,o=t._unevaluatedLayout._values,f={layoutIconSize:o["icon-size"].possiblyEvaluate(new pr(i.bucket.zoom+1),i.canonical),layoutTextSize:o["text-size"].possiblyEvaluate(new pr(i.bucket.zoom+1),i.canonical),textMaxSize:o["text-size"].possiblyEvaluate(new pr(18))};if(i.bucket.textSizeData.kind==="composite"){const{minZoom:D,maxZoom:B}=i.bucket.textSizeData;f.compositeTextSizes=[o["text-size"].possiblyEvaluate(new pr(D),i.canonical),o["text-size"].possiblyEvaluate(new pr(B),i.canonical)]}if(i.bucket.iconSizeData.kind==="composite"){const{minZoom:D,maxZoom:B}=i.bucket.iconSizeData;f.compositeIconSizes=[o["icon-size"].possiblyEvaluate(new pr(D),i.canonical),o["icon-size"].possiblyEvaluate(new pr(B),i.canonical)]}const v=r.get("text-line-height")*Xr,x=r.get("text-rotation-alignment")!=="viewport"&&r.get("symbol-placement")!=="point",T=r.get("text-keep-upright"),A=r.get("text-size");for(const D of i.bucket.features){const B=r.get("text-font").evaluate(D,{},i.canonical).join(","),j=A.evaluate(D,{},i.canonical),X=f.layoutTextSize.evaluate(D,{},i.canonical),q=f.layoutIconSize.evaluate(D,{},i.canonical),J={horizontal:{},vertical:void 0},it=D.text;let dt,Ct=[0,0];if(it){const Nt=it.toString(),ie=r.get("text-letter-spacing").evaluate(D,{},i.canonical)*Xr,we=ah(Nt)?ie:0,We=r.get("text-anchor").evaluate(D,{},i.canonical),fi=zd(t,D,i.canonical);if(!fi){const Je=r.get("text-radial-offset").evaluate(D,{},i.canonical);Ct=Je?Ld(We,[Je*Xr,jh]):r.get("text-offset").evaluate(D,{},i.canonical).map(Ye=>Ye*Xr)}let Ue=x?"center":r.get("text-justify").evaluate(D,{},i.canonical);const Be=r.get("symbol-placement")==="point"?r.get("text-max-width").evaluate(D,{},i.canonical)*Xr:1/0,oi=()=>{i.bucket.allowVerticalPlacement&&Ul(Nt)&&(J.vertical=jc(it,i.glyphMap,i.glyphPositions,i.imagePositions,B,Be,v,We,"left",we,Ct,N.ai.vertical,!0,X,j))};if(!x&&fi){const Je=new Set;if(Ue==="auto")for(let de=0;de<fi.values.length;de+=2)Je.add(Nh(fi.values[de]));else Je.add(Ue);let Ye=!1;for(const de of Je)if(!J.horizontal[de])if(Ye)J.horizontal[de]=J.horizontal[0];else{const li=jc(it,i.glyphMap,i.glyphPositions,i.imagePositions,B,Be,v,"center",de,we,Ct,N.ai.horizontal,!1,X,j);li&&(J.horizontal[de]=li,Ye=li.positionedLines.length===1)}oi()}else{Ue==="auto"&&(Ue=Nh(We));const Je=jc(it,i.glyphMap,i.glyphPositions,i.imagePositions,B,Be,v,We,Ue,we,Ct,N.ai.horizontal,!1,X,j);Je&&(J.horizontal[Ue]=Je),oi(),Ul(Nt)&&x&&T&&(J.vertical=jc(it,i.glyphMap,i.glyphPositions,i.imagePositions,B,Be,v,We,Ue,we,Ct,N.ai.vertical,!1,X,j))}}let Gt=!1;if(D.icon&&D.icon.name){const Nt=i.imageMap[D.icon.name];Nt&&(dt=Gp(i.imagePositions[D.icon.name],r.get("icon-offset").evaluate(D,{},i.canonical),r.get("icon-anchor").evaluate(D,{},i.canonical)),Gt=!!Nt.sdf,i.bucket.sdfIcons===void 0?i.bucket.sdfIcons=Gt:i.bucket.sdfIcons!==Gt&&he("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Nt.pixelRatio!==i.bucket.pixelRatio||r.get("icon-rotate").constantOr(1)!==0)&&(i.bucket.iconsNeedLinear=!0))}const At=Rd(J.horizontal)||J.vertical;i.bucket.iconsInText=!!At&&At.iconsInText,(At||dt)&&sm(i.bucket,D,J,dt,i.imageMap,f,X,q,Ct,Gt,i.canonical)}i.showCollisionBoxes&&i.bucket.generateCollisionDebugBuffers()},N.bp=Sh,N.bq=bh,N.br=Ch,N.bs=aa,N.bt=Eh,N.bu=class{constructor(i){this._marks={start:[i.url,"start"].join("#"),end:[i.url,"end"].join("#"),measure:i.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let i=performance.getEntriesByName(this._marks.measure);return i.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),i=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),i}},N.bv=function(i,t,r,o,f){return s(this,void 0,void 0,function*(){if(E())try{return yield Q(i,t,r,o,f)}catch{}return function(v,x,T,A,D){const B=v.width,j=v.height;wt&&gt||(wt=new OffscreenCanvas(B,j),gt=wt.getContext("2d",{willReadFrequently:!0})),wt.width=B,wt.height=j,gt.drawImage(v,0,0,B,j);const X=gt.getImageData(x,T,A,D);return gt.clearRect(0,0,B,j),X.data}(i,t,r,o,f)})},N.bw=xd,N.bx=p,N.by=C,N.bz=Wu,N.c=Vt,N.d=i=>s(void 0,void 0,void 0,function*(){if(i.byteLength===0)return createImageBitmap(new ImageData(1,1));const t=new Blob([new Uint8Array(i)],{type:"image/png"});try{return createImageBitmap(t)}catch(r){throw new Error(`Could not load image because of ${r.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}}),N.e=nt,N.f=i=>new Promise((t,r)=>{const o=new Image;o.onload=()=>{t(o),URL.revokeObjectURL(o.src),o.onload=null,window.requestAnimationFrame(()=>{o.src=be})},o.onerror=()=>r(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const f=new Blob([new Uint8Array(i)],{type:"image/png"});o.src=i.byteLength?URL.createObjectURL(f):be}),N.g=rt,N.h=(i,t)=>Wt(nt(i,{type:"json"}),t),N.i=me,N.j=Lt,N.k=qt,N.l=(i,t)=>Wt(nt(i,{type:"arrayBuffer"}),t),N.m=Wt,N.n=function(i){return new Eh(i).readFields(Fp,[])},N.o=tc,N.p=Qu,N.q=a,N.r=nh,N.s=Xt,N.t=Nl,N.u=Ge,N.v=at,N.w=he,N.x=Ls,N.y=function([i,t,r]){return t+=90,t*=Math.PI/180,r*=Math.PI/180,{x:i*Math.cos(t)*Math.sin(r),y:i*Math.sin(t)*Math.sin(r),z:i*Math.cos(r)}},N.z=di}),lt("worker",["./shared"],function(N){class s{constructor(W){this.keyCache={},W&&this.replace(W)}replace(W){this._layerConfigs={},this._layers={},this.update(W,[])}update(W,H){for(const ct of W){this._layerConfigs[ct.id]=ct;const Et=this._layers[ct.id]=N.aB(ct);Et._featureFilter=N.a7(Et.filter),this.keyCache[ct.id]&&delete this.keyCache[ct.id]}for(const ct of H)delete this.keyCache[ct],delete this._layerConfigs[ct],delete this._layers[ct];this.familiesBySource={};const et=N.bj(Object.values(this._layerConfigs),this.keyCache);for(const ct of et){const Et=ct.map(Yt=>this._layers[Yt.id]),Ot=Et[0];if(Ot.visibility==="none")continue;const zt=Ot.source||"";let St=this.familiesBySource[zt];St||(St=this.familiesBySource[zt]={});const ee=Ot.sourceLayer||"_geojsonTileLayer";let le=St[ee];le||(le=St[ee]=[]),le.push(Et)}}}class p{constructor(W){const H={},et=[];for(const zt in W){const St=W[zt],ee=H[zt]={};for(const le in St){const Yt=St[+le];if(!Yt||Yt.bitmap.width===0||Yt.bitmap.height===0)continue;const Pe={x:0,y:0,w:Yt.bitmap.width+2,h:Yt.bitmap.height+2};et.push(Pe),ee[le]={rect:Pe,metrics:Yt.metrics}}}const{w:ct,h:Et}=N.p(et),Ot=new N.o({width:ct||1,height:Et||1});for(const zt in W){const St=W[zt];for(const ee in St){const le=St[+ee];if(!le||le.bitmap.width===0||le.bitmap.height===0)continue;const Yt=H[zt][ee].rect;N.o.copy(le.bitmap,Ot,{x:0,y:0},{x:Yt.x+1,y:Yt.y+1},le.bitmap)}}this.image=Ot,this.positions=H}}N.bk("GlyphAtlas",p);class C{constructor(W){this.tileID=new N.S(W.tileID.overscaledZ,W.tileID.wrap,W.tileID.canonical.z,W.tileID.canonical.x,W.tileID.canonical.y),this.uid=W.uid,this.zoom=W.zoom,this.pixelRatio=W.pixelRatio,this.tileSize=W.tileSize,this.source=W.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=W.showCollisionBoxes,this.collectResourceTiming=!!W.collectResourceTiming,this.returnDependencies=!!W.returnDependencies,this.promoteId=W.promoteId,this.inFlightDependencies=[]}parse(W,H,et,ct){return N._(this,void 0,void 0,function*(){this.status="parsing",this.data=W,this.collisionBoxArray=new N.a5;const Et=new N.bl(Object.keys(W.layers).sort()),Ot=new N.bm(this.tileID,this.promoteId);Ot.bucketLayerIDs=[];const zt={},St={featureIndex:Ot,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:et},ee=H.familiesBySource[this.source];for(const ki in ee){const Hi=W.layers[ki];if(!Hi)continue;Hi.version===1&&N.w(`Vector tile source "${this.source}" layer "${ki}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const hr=Et.encode(ki),Ar=[];for(let Wr=0;Wr<Hi.length;Wr++){const Br=Hi.feature(Wr),uo=Ot.getId(Br,ki);Ar.push({feature:Br,id:uo,index:Wr,sourceLayerIndex:hr})}for(const Wr of ee[ki]){const Br=Wr[0];Br.source!==this.source&&N.w(`layer.source = ${Br.source} does not equal this.source = ${this.source}`),Br.minzoom&&this.zoom<Math.floor(Br.minzoom)||Br.maxzoom&&this.zoom>=Br.maxzoom||Br.visibility!=="none"&&(b(Wr,this.zoom,et),(zt[Br.id]=Br.createBucket({index:Ot.bucketLayerIDs.length,layers:Wr,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:hr,sourceID:this.source})).populate(Ar,St,this.tileID.canonical),Ot.bucketLayerIDs.push(Wr.map(uo=>uo.id)))}}const le=N.aG(St.glyphDependencies,ki=>Object.keys(ki).map(Number));this.inFlightDependencies.forEach(ki=>ki==null?void 0:ki.abort()),this.inFlightDependencies=[];let Yt=Promise.resolve({});if(Object.keys(le).length){const ki=new AbortController;this.inFlightDependencies.push(ki),Yt=ct.sendAsync({type:"GG",data:{stacks:le,source:this.source,tileID:this.tileID,type:"glyphs"}},ki)}const Pe=Object.keys(St.iconDependencies);let Qe=Promise.resolve({});if(Pe.length){const ki=new AbortController;this.inFlightDependencies.push(ki),Qe=ct.sendAsync({type:"GI",data:{icons:Pe,source:this.source,tileID:this.tileID,type:"icons"}},ki)}const ei=Object.keys(St.patternDependencies);let _i=Promise.resolve({});if(ei.length){const ki=new AbortController;this.inFlightDependencies.push(ki),_i=ct.sendAsync({type:"GI",data:{icons:ei,source:this.source,tileID:this.tileID,type:"patterns"}},ki)}const[Ei,gi,tr]=yield Promise.all([Yt,Qe,_i]),xr=new p(Ei),Fi=new N.bn(gi,tr);for(const ki in zt){const Hi=zt[ki];Hi instanceof N.a6?(b(Hi.layers,this.zoom,et),N.bo({bucket:Hi,glyphMap:Ei,glyphPositions:xr.positions,imageMap:gi,imagePositions:Fi.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical})):Hi.hasPattern&&(Hi instanceof N.bp||Hi instanceof N.bq||Hi instanceof N.br)&&(b(Hi.layers,this.zoom,et),Hi.addFeatures(St,this.tileID.canonical,Fi.patternPositions))}return this.status="done",{buckets:Object.values(zt).filter(ki=>!ki.isEmpty()),featureIndex:Ot,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:xr.image,imageAtlas:Fi,glyphMap:this.returnDependencies?Ei:null,iconMap:this.returnDependencies?gi:null,glyphPositions:this.returnDependencies?xr.positions:null}})}}function b(_t,W,H){const et=new N.a9(W);for(const ct of _t)ct.recalculate(et,H)}class l{constructor(W,H,et){this.actor=W,this.layerIndex=H,this.availableImages=et,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(W,H){return N._(this,void 0,void 0,function*(){const et=yield N.l(W.request,H);try{return{vectorTile:new N.bs.VectorTile(new N.bt(et.data)),rawData:et.data,cacheControl:et.cacheControl,expires:et.expires}}catch(ct){const Et=new Uint8Array(et.data);let Ot=`Unable to parse the tile at ${W.request.url}, `;throw Ot+=Et[0]===31&&Et[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${ct.message}`,new Error(Ot)}})}loadTile(W){return N._(this,void 0,void 0,function*(){const H=W.uid,et=!!(W&&W.request&&W.request.collectResourceTiming)&&new N.bu(W.request),ct=new C(W);this.loading[H]=ct;const Et=new AbortController;ct.abort=Et;try{const Ot=yield this.loadVectorTile(W,Et);if(delete this.loading[H],!Ot)return null;const zt=Ot.rawData,St={};Ot.expires&&(St.expires=Ot.expires),Ot.cacheControl&&(St.cacheControl=Ot.cacheControl);const ee={};if(et){const Yt=et.finish();Yt&&(ee.resourceTiming=JSON.parse(JSON.stringify(Yt)))}ct.vectorTile=Ot.vectorTile;const le=ct.parse(Ot.vectorTile,this.layerIndex,this.availableImages,this.actor);this.loaded[H]=ct,this.fetching[H]={rawTileData:zt,cacheControl:St,resourceTiming:ee};try{const Yt=yield le;return N.e({rawTileData:zt.slice(0)},Yt,St,ee)}finally{delete this.fetching[H]}}catch(Ot){throw delete this.loading[H],ct.status="done",this.loaded[H]=ct,Ot}})}reloadTile(W){return N._(this,void 0,void 0,function*(){const H=W.uid;if(!this.loaded||!this.loaded[H])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const et=this.loaded[H];if(et.showCollisionBoxes=W.showCollisionBoxes,et.status==="parsing"){const ct=yield et.parse(et.vectorTile,this.layerIndex,this.availableImages,this.actor);let Et;if(this.fetching[H]){const{rawTileData:Ot,cacheControl:zt,resourceTiming:St}=this.fetching[H];delete this.fetching[H],Et=N.e({rawTileData:Ot.slice(0)},ct,zt,St)}else Et=ct;return Et}if(et.status==="done"&&et.vectorTile)return et.parse(et.vectorTile,this.layerIndex,this.availableImages,this.actor)})}abortTile(W){return N._(this,void 0,void 0,function*(){const H=this.loading,et=W.uid;H&&H[et]&&H[et].abort&&(H[et].abort.abort(),delete H[et])})}removeTile(W){return N._(this,void 0,void 0,function*(){this.loaded&&this.loaded[W.uid]&&delete this.loaded[W.uid]})}}class c{constructor(){this.loaded={}}loadTile(W){return N._(this,void 0,void 0,function*(){const{uid:H,encoding:et,rawImageData:ct,redFactor:Et,greenFactor:Ot,blueFactor:zt,baseShift:St}=W,ee=ct.width+2,le=ct.height+2,Yt=N.b(ct)?new N.R({width:ee,height:le},yield N.bv(ct,-1,-1,ee,le)):ct,Pe=new N.bw(H,Yt,et,Et,Ot,zt,St);return this.loaded=this.loaded||{},this.loaded[H]=Pe,Pe})}removeTile(W){const H=this.loaded,et=W.uid;H&&H[et]&&delete H[et]}}function h(_t,W){if(_t.length!==0){m(_t[0],W);for(var H=1;H<_t.length;H++)m(_t[H],!W)}}function m(_t,W){for(var H=0,et=0,ct=0,Et=_t.length,Ot=Et-1;ct<Et;Ot=ct++){var zt=(_t[ct][0]-_t[Ot][0])*(_t[Ot][1]+_t[ct][1]),St=H+zt;et+=Math.abs(H)>=Math.abs(zt)?H-St+zt:zt-St+H,H=St}H+et>=0!=!!W&&_t.reverse()}var g=N.bx(function _t(W,H){var et,ct=W&&W.type;if(ct==="FeatureCollection")for(et=0;et<W.features.length;et++)_t(W.features[et],H);else if(ct==="GeometryCollection")for(et=0;et<W.geometries.length;et++)_t(W.geometries[et],H);else if(ct==="Feature")_t(W.geometry,H);else if(ct==="Polygon")h(W.coordinates,H);else if(ct==="MultiPolygon")for(et=0;et<W.coordinates.length;et++)h(W.coordinates[et],H);return W});const d=N.bs.VectorTileFeature.prototype.toGeoJSON;var w={exports:{}},E=N.by,O=N.bs.VectorTileFeature,L=U;function U(_t,W){this.options=W||{},this.features=_t,this.length=_t.length}function $(_t,W){this.id=typeof _t.id=="number"?_t.id:void 0,this.type=_t.type,this.rawGeometry=_t.type===1?[_t.geometry]:_t.geometry,this.properties=_t.tags,this.extent=W||4096}U.prototype.feature=function(_t){return new $(this.features[_t],this.options.extent)},$.prototype.loadGeometry=function(){var _t=this.rawGeometry;this.geometry=[];for(var W=0;W<_t.length;W++){for(var H=_t[W],et=[],ct=0;ct<H.length;ct++)et.push(new E(H[ct][0],H[ct][1]));this.geometry.push(et)}return this.geometry},$.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var _t=this.geometry,W=1/0,H=-1/0,et=1/0,ct=-1/0,Et=0;Et<_t.length;Et++)for(var Ot=_t[Et],zt=0;zt<Ot.length;zt++){var St=Ot[zt];W=Math.min(W,St.x),H=Math.max(H,St.x),et=Math.min(et,St.y),ct=Math.max(ct,St.y)}return[W,et,H,ct]},$.prototype.toGeoJSON=O.prototype.toGeoJSON;var nt=N.bz,xt=L;function Ft(_t){var W=new nt;return function(H,et){for(var ct in H.layers)et.writeMessage(3,Kt,H.layers[ct])}(_t,W),W.finish()}function Kt(_t,W){var H;W.writeVarintField(15,_t.version||1),W.writeStringField(1,_t.name||""),W.writeVarintField(5,_t.extent||4096);var et={keys:[],values:[],keycache:{},valuecache:{}};for(H=0;H<_t.length;H++)et.feature=_t.feature(H),W.writeMessage(2,Jt,et);var ct=et.keys;for(H=0;H<ct.length;H++)W.writeStringField(3,ct[H]);var Et=et.values;for(H=0;H<Et.length;H++)W.writeMessage(4,Oe,Et[H])}function Jt(_t,W){var H=_t.feature;H.id!==void 0&&W.writeVarintField(1,H.id),W.writeMessage(2,Qt,_t),W.writeVarintField(3,H.type),W.writeMessage(4,me,H)}function Qt(_t,W){var H=_t.feature,et=_t.keys,ct=_t.values,Et=_t.keycache,Ot=_t.valuecache;for(var zt in H.properties){var St=H.properties[zt],ee=Et[zt];if(St!==null){ee===void 0&&(et.push(zt),Et[zt]=ee=et.length-1),W.writeVarint(ee);var le=typeof St;le!=="string"&&le!=="boolean"&&le!=="number"&&(St=JSON.stringify(St));var Yt=le+":"+St,Pe=Ot[Yt];Pe===void 0&&(ct.push(St),Ot[Yt]=Pe=ct.length-1),W.writeVarint(Pe)}}}function he(_t,W){return(W<<3)+(7&_t)}function ne(_t){return _t<<1^_t>>31}function me(_t,W){for(var H=_t.loadGeometry(),et=_t.type,ct=0,Et=0,Ot=H.length,zt=0;zt<Ot;zt++){var St=H[zt],ee=1;et===1&&(ee=St.length),W.writeVarint(he(1,ee));for(var le=et===3?St.length-1:St.length,Yt=0;Yt<le;Yt++){Yt===1&&et!==1&&W.writeVarint(he(2,le-1));var Pe=St[Yt].x-ct,Qe=St[Yt].y-Et;W.writeVarint(ne(Pe)),W.writeVarint(ne(Qe)),ct+=Pe,Et+=Qe}et===3&&W.writeVarint(he(7,1))}}function Oe(_t,W){var H=typeof _t;H==="string"?W.writeStringField(1,_t):H==="boolean"?W.writeBooleanField(7,_t):H==="number"&&(_t%1!=0?W.writeDoubleField(3,_t):_t<0?W.writeSVarintField(6,_t):W.writeVarintField(5,_t))}w.exports=Ft,w.exports.fromVectorTileJs=Ft,w.exports.fromGeojsonVt=function(_t,W){W=W||{};var H={};for(var et in _t)H[et]=new xt(_t[et].features,W),H[et].name=et,H[et].version=W.version,H[et].extent=W.extent;return Ft({layers:H})},w.exports.GeoJSONWrapper=xt;var se=N.bx(w.exports);const be={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:_t=>_t},Q=Math.fround||(wt=new Float32Array(1),_t=>(wt[0]=+_t,wt[0]));var wt;const gt=3,vt=5,Vt=6;class pt{constructor(W){this.options=Object.assign(Object.create(be),W),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(W){const{log:H,minZoom:et,maxZoom:ct}=this.options;H&&console.time("total time");const Et=`prepare ${W.length} points`;H&&console.time(Et),this.points=W;const Ot=[];for(let St=0;St<W.length;St++){const ee=W[St];if(!ee.geometry)continue;const[le,Yt]=ee.geometry.coordinates,Pe=Q(jt(le)),Qe=Q(te(Yt));Ot.push(Pe,Qe,1/0,St,-1,1),this.options.reduce&&Ot.push(0)}let zt=this.trees[ct+1]=this._createTree(Ot);H&&console.timeEnd(Et);for(let St=ct;St>=et;St--){const ee=+Date.now();zt=this.trees[St]=this._createTree(this._cluster(zt,St)),H&&console.log("z%d: %d clusters in %dms",St,zt.numItems,+Date.now()-ee)}return H&&console.timeEnd("total time"),this}getClusters(W,H){let et=((W[0]+180)%360+360)%360-180;const ct=Math.max(-90,Math.min(90,W[1]));let Et=W[2]===180?180:((W[2]+180)%360+360)%360-180;const Ot=Math.max(-90,Math.min(90,W[3]));if(W[2]-W[0]>=360)et=-180,Et=180;else if(et>Et){const Yt=this.getClusters([et,ct,180,Ot],H),Pe=this.getClusters([-180,ct,Et,Ot],H);return Yt.concat(Pe)}const zt=this.trees[this._limitZoom(H)],St=zt.range(jt(et),te(Ot),jt(Et),te(ct)),ee=zt.data,le=[];for(const Yt of St){const Pe=this.stride*Yt;le.push(ee[Pe+vt]>1?rt(ee,Pe,this.clusterProps):this.points[ee[Pe+gt]])}return le}getChildren(W){const H=this._getOriginId(W),et=this._getOriginZoom(W),ct="No cluster with the specified id.",Et=this.trees[et];if(!Et)throw new Error(ct);const Ot=Et.data;if(H*this.stride>=Ot.length)throw new Error(ct);const zt=this.options.radius/(this.options.extent*Math.pow(2,et-1)),St=Et.within(Ot[H*this.stride],Ot[H*this.stride+1],zt),ee=[];for(const le of St){const Yt=le*this.stride;Ot[Yt+4]===W&&ee.push(Ot[Yt+vt]>1?rt(Ot,Yt,this.clusterProps):this.points[Ot[Yt+gt]])}if(ee.length===0)throw new Error(ct);return ee}getLeaves(W,H,et){const ct=[];return this._appendLeaves(ct,W,H=H||10,et=et||0,0),ct}getTile(W,H,et){const ct=this.trees[this._limitZoom(W)],Et=Math.pow(2,W),{extent:Ot,radius:zt}=this.options,St=zt/Ot,ee=(et-St)/Et,le=(et+1+St)/Et,Yt={features:[]};return this._addTileFeatures(ct.range((H-St)/Et,ee,(H+1+St)/Et,le),ct.data,H,et,Et,Yt),H===0&&this._addTileFeatures(ct.range(1-St/Et,ee,1,le),ct.data,Et,et,Et,Yt),H===Et-1&&this._addTileFeatures(ct.range(0,ee,St/Et,le),ct.data,-1,et,Et,Yt),Yt.features.length?Yt:null}getClusterExpansionZoom(W){let H=this._getOriginZoom(W)-1;for(;H<=this.options.maxZoom;){const et=this.getChildren(W);if(H++,et.length!==1)break;W=et[0].properties.cluster_id}return H}_appendLeaves(W,H,et,ct,Et){const Ot=this.getChildren(H);for(const zt of Ot){const St=zt.properties;if(St&&St.cluster?Et+St.point_count<=ct?Et+=St.point_count:Et=this._appendLeaves(W,St.cluster_id,et,ct,Et):Et<ct?Et++:W.push(zt),W.length===et)break}return Et}_createTree(W){const H=new N.aw(W.length/this.stride|0,this.options.nodeSize,Float32Array);for(let et=0;et<W.length;et+=this.stride)H.add(W[et],W[et+1]);return H.finish(),H.data=W,H}_addTileFeatures(W,H,et,ct,Et,Ot){for(const zt of W){const St=zt*this.stride,ee=H[St+vt]>1;let le,Yt,Pe;if(ee)le=Mt(H,St,this.clusterProps),Yt=H[St],Pe=H[St+1];else{const _i=this.points[H[St+gt]];le=_i.properties;const[Ei,gi]=_i.geometry.coordinates;Yt=jt(Ei),Pe=te(gi)}const Qe={type:1,geometry:[[Math.round(this.options.extent*(Yt*Et-et)),Math.round(this.options.extent*(Pe*Et-ct))]],tags:le};let ei;ei=ee||this.options.generateId?H[St+gt]:this.points[H[St+gt]].id,ei!==void 0&&(Qe.id=ei),Ot.features.push(Qe)}}_limitZoom(W){return Math.max(this.options.minZoom,Math.min(Math.floor(+W),this.options.maxZoom+1))}_cluster(W,H){const{radius:et,extent:ct,reduce:Et,minPoints:Ot}=this.options,zt=et/(ct*Math.pow(2,H)),St=W.data,ee=[],le=this.stride;for(let Yt=0;Yt<St.length;Yt+=le){if(St[Yt+2]<=H)continue;St[Yt+2]=H;const Pe=St[Yt],Qe=St[Yt+1],ei=W.within(St[Yt],St[Yt+1],zt),_i=St[Yt+vt];let Ei=_i;for(const gi of ei){const tr=gi*le;St[tr+2]>H&&(Ei+=St[tr+vt])}if(Ei>_i&&Ei>=Ot){let gi,tr=Pe*_i,xr=Qe*_i,Fi=-1;const ki=((Yt/le|0)<<5)+(H+1)+this.points.length;for(const Hi of ei){const hr=Hi*le;if(St[hr+2]<=H)continue;St[hr+2]=H;const Ar=St[hr+vt];tr+=St[hr]*Ar,xr+=St[hr+1]*Ar,St[hr+4]=ki,Et&&(gi||(gi=this._map(St,Yt,!0),Fi=this.clusterProps.length,this.clusterProps.push(gi)),Et(gi,this._map(St,hr)))}St[Yt+4]=ki,ee.push(tr/Ei,xr/Ei,1/0,ki,-1,Ei),Et&&ee.push(Fi)}else{for(let gi=0;gi<le;gi++)ee.push(St[Yt+gi]);if(Ei>1)for(const gi of ei){const tr=gi*le;if(!(St[tr+2]<=H)){St[tr+2]=H;for(let xr=0;xr<le;xr++)ee.push(St[tr+xr])}}}}return ee}_getOriginId(W){return W-this.points.length>>5}_getOriginZoom(W){return(W-this.points.length)%32}_map(W,H,et){if(W[H+vt]>1){const Ot=this.clusterProps[W[H+Vt]];return et?Object.assign({},Ot):Ot}const ct=this.points[W[H+gt]].properties,Et=this.options.map(ct);return et&&Et===ct?Object.assign({},Et):Et}}function rt(_t,W,H){return{type:"Feature",id:_t[W+gt],properties:Mt(_t,W,H),geometry:{type:"Point",coordinates:[(et=_t[W],360*(et-.5)),Wt(_t[W+1])]}};var et}function Mt(_t,W,H){const et=_t[W+vt],ct=et>=1e4?`${Math.round(et/1e3)}k`:et>=1e3?Math.round(et/100)/10+"k":et,Et=_t[W+Vt],Ot=Et===-1?{}:Object.assign({},H[Et]);return Object.assign(Ot,{cluster:!0,cluster_id:_t[W+gt],point_count:et,point_count_abbreviated:ct})}function jt(_t){return _t/360+.5}function te(_t){const W=Math.sin(_t*Math.PI/180),H=.5-.25*Math.log((1+W)/(1-W))/Math.PI;return H<0?0:H>1?1:H}function Wt(_t){const W=(180-360*_t)*Math.PI/180;return 360*Math.atan(Math.exp(W))/Math.PI-90}function Xt(_t,W,H,et){let ct=et;const Et=W+(H-W>>1);let Ot,zt=H-W;const St=_t[W],ee=_t[W+1],le=_t[H],Yt=_t[H+1];for(let Pe=W+3;Pe<H;Pe+=3){const Qe=ye(_t[Pe],_t[Pe+1],St,ee,le,Yt);if(Qe>ct)Ot=Pe,ct=Qe;else if(Qe===ct){const ei=Math.abs(Pe-Et);ei<zt&&(Ot=Pe,zt=ei)}}ct>et&&(Ot-W>3&&Xt(_t,W,Ot,et),_t[Ot+2]=ct,H-Ot>3&&Xt(_t,Ot,H,et))}function ye(_t,W,H,et,ct,Et){let Ot=ct-H,zt=Et-et;if(Ot!==0||zt!==0){const St=((_t-H)*Ot+(W-et)*zt)/(Ot*Ot+zt*zt);St>1?(H=ct,et=Et):St>0&&(H+=Ot*St,et+=zt*St)}return Ot=_t-H,zt=W-et,Ot*Ot+zt*zt}function Te(_t,W,H,et){const ct={id:_t??null,type:W,geometry:H,tags:et,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(W==="Point"||W==="MultiPoint"||W==="LineString")qt(ct,H);else if(W==="Polygon")qt(ct,H[0]);else if(W==="MultiLineString")for(const Et of H)qt(ct,Et);else if(W==="MultiPolygon")for(const Et of H)qt(ct,Et[0]);return ct}function qt(_t,W){for(let H=0;H<W.length;H+=3)_t.minX=Math.min(_t.minX,W[H]),_t.minY=Math.min(_t.minY,W[H+1]),_t.maxX=Math.max(_t.maxX,W[H]),_t.maxY=Math.max(_t.maxY,W[H+1])}function Lt(_t,W,H,et){if(!W.geometry)return;const ct=W.geometry.coordinates;if(ct&&ct.length===0)return;const Et=W.geometry.type,Ot=Math.pow(H.tolerance/((1<<H.maxZoom)*H.extent),2);let zt=[],St=W.id;if(H.promoteId?St=W.properties[H.promoteId]:H.generateId&&(St=et||0),Et==="Point")ae(ct,zt);else if(Et==="MultiPoint")for(const ee of ct)ae(ee,zt);else if(Et==="LineString")at(ct,zt,Ot,!1);else if(Et==="MultiLineString"){if(H.lineMetrics){for(const ee of ct)zt=[],at(ee,zt,Ot,!1),_t.push(Te(St,"LineString",zt,W.properties));return}Zt(ct,zt,Ot,!1)}else if(Et==="Polygon")Zt(ct,zt,Ot,!0);else{if(Et!=="MultiPolygon"){if(Et==="GeometryCollection"){for(const ee of W.geometry.geometries)Lt(_t,{id:St,geometry:ee,properties:W.properties},H,et);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const ee of ct){const le=[];Zt(ee,le,Ot,!0),zt.push(le)}}_t.push(Te(St,Et,zt,W.properties))}function ae(_t,W){W.push(pe(_t[0]),ue(_t[1]),0)}function at(_t,W,H,et){let ct,Et,Ot=0;for(let St=0;St<_t.length;St++){const ee=pe(_t[St][0]),le=ue(_t[St][1]);W.push(ee,le,0),St>0&&(Ot+=et?(ct*le-ee*Et)/2:Math.sqrt(Math.pow(ee-ct,2)+Math.pow(le-Et,2))),ct=ee,Et=le}const zt=W.length-3;W[2]=1,Xt(W,0,zt,H),W[zt+2]=1,W.size=Math.abs(Ot),W.start=0,W.end=W.size}function Zt(_t,W,H,et){for(let ct=0;ct<_t.length;ct++){const Et=[];at(_t[ct],Et,H,et),W.push(Et)}}function pe(_t){return _t/360+.5}function ue(_t){const W=Math.sin(_t*Math.PI/180),H=.5-.25*Math.log((1+W)/(1-W))/Math.PI;return H<0?0:H>1?1:H}function Fe(_t,W,H,et,ct,Et,Ot,zt){if(et/=W,Et>=(H/=W)&&Ot<et)return _t;if(Ot<H||Et>=et)return null;const St=[];for(const ee of _t){const le=ee.geometry;let Yt=ee.type;const Pe=ct===0?ee.minX:ee.minY,Qe=ct===0?ee.maxX:ee.maxY;if(Pe>=H&&Qe<et){St.push(ee);continue}if(Qe<H||Pe>=et)continue;let ei=[];if(Yt==="Point"||Yt==="MultiPoint")Ke(le,ei,H,et,ct);else if(Yt==="LineString")oe(le,ei,H,et,ct,!1,zt.lineMetrics);else if(Yt==="MultiLineString")He(le,ei,H,et,ct,!1);else if(Yt==="Polygon")He(le,ei,H,et,ct,!0);else if(Yt==="MultiPolygon")for(const _i of le){const Ei=[];He(_i,Ei,H,et,ct,!0),Ei.length&&ei.push(Ei)}if(ei.length){if(zt.lineMetrics&&Yt==="LineString"){for(const _i of ei)St.push(Te(ee.id,Yt,_i,ee.tags));continue}Yt!=="LineString"&&Yt!=="MultiLineString"||(ei.length===1?(Yt="LineString",ei=ei[0]):Yt="MultiLineString"),Yt!=="Point"&&Yt!=="MultiPoint"||(Yt=ei.length===3?"Point":"MultiPoint"),St.push(Te(ee.id,Yt,ei,ee.tags))}}return St.length?St:null}function Ke(_t,W,H,et,ct){for(let Et=0;Et<_t.length;Et+=3){const Ot=_t[Et+ct];Ot>=H&&Ot<=et&&ci(W,_t[Et],_t[Et+1],_t[Et+2])}}function oe(_t,W,H,et,ct,Et,Ot){let zt=ve(_t);const St=ct===0?wi:vi;let ee,le,Yt=_t.start;for(let Ei=0;Ei<_t.length-3;Ei+=3){const gi=_t[Ei],tr=_t[Ei+1],xr=_t[Ei+2],Fi=_t[Ei+3],ki=_t[Ei+4],Hi=ct===0?gi:tr,hr=ct===0?Fi:ki;let Ar=!1;Ot&&(ee=Math.sqrt(Math.pow(gi-Fi,2)+Math.pow(tr-ki,2))),Hi<H?hr>H&&(le=St(zt,gi,tr,Fi,ki,H),Ot&&(zt.start=Yt+ee*le)):Hi>et?hr<et&&(le=St(zt,gi,tr,Fi,ki,et),Ot&&(zt.start=Yt+ee*le)):ci(zt,gi,tr,xr),hr<H&&Hi>=H&&(le=St(zt,gi,tr,Fi,ki,H),Ar=!0),hr>et&&Hi<=et&&(le=St(zt,gi,tr,Fi,ki,et),Ar=!0),!Et&&Ar&&(Ot&&(zt.end=Yt+ee*le),W.push(zt),zt=ve(_t)),Ot&&(Yt+=ee)}let Pe=_t.length-3;const Qe=_t[Pe],ei=_t[Pe+1],_i=ct===0?Qe:ei;_i>=H&&_i<=et&&ci(zt,Qe,ei,_t[Pe+2]),Pe=zt.length-3,Et&&Pe>=3&&(zt[Pe]!==zt[0]||zt[Pe+1]!==zt[1])&&ci(zt,zt[0],zt[1],zt[2]),zt.length&&W.push(zt)}function ve(_t){const W=[];return W.size=_t.size,W.start=_t.start,W.end=_t.end,W}function He(_t,W,H,et,ct,Et){for(const Ot of _t)oe(Ot,W,H,et,ct,Et,!1)}function ci(_t,W,H,et){_t.push(W,H,et)}function wi(_t,W,H,et,ct,Et){const Ot=(Et-W)/(et-W);return ci(_t,Et,H+(ct-H)*Ot,1),Ot}function vi(_t,W,H,et,ct,Et){const Ot=(Et-H)/(ct-H);return ci(_t,W+(et-W)*Ot,Et,1),Ot}function ce(_t,W){const H=[];for(let et=0;et<_t.length;et++){const ct=_t[et],Et=ct.type;let Ot;if(Et==="Point"||Et==="MultiPoint"||Et==="LineString")Ot=Ti(ct.geometry,W);else if(Et==="MultiLineString"||Et==="Polygon"){Ot=[];for(const zt of ct.geometry)Ot.push(Ti(zt,W))}else if(Et==="MultiPolygon"){Ot=[];for(const zt of ct.geometry){const St=[];for(const ee of zt)St.push(Ti(ee,W));Ot.push(St)}}H.push(Te(ct.id,Et,Ot,ct.tags))}return H}function Ti(_t,W){const H=[];H.size=_t.size,_t.start!==void 0&&(H.start=_t.start,H.end=_t.end);for(let et=0;et<_t.length;et+=3)H.push(_t[et]+W,_t[et+1],_t[et+2]);return H}function zi(_t,W){if(_t.transformed)return _t;const H=1<<_t.z,et=_t.x,ct=_t.y;for(const Et of _t.features){const Ot=Et.geometry,zt=Et.type;if(Et.geometry=[],zt===1)for(let St=0;St<Ot.length;St+=2)Et.geometry.push(nr(Ot[St],Ot[St+1],W,H,et,ct));else for(let St=0;St<Ot.length;St++){const ee=[];for(let le=0;le<Ot[St].length;le+=2)ee.push(nr(Ot[St][le],Ot[St][le+1],W,H,et,ct));Et.geometry.push(ee)}}return _t.transformed=!0,_t}function nr(_t,W,H,et,ct,Et){return[Math.round(H*(_t*et-ct)),Math.round(H*(W*et-Et))]}function Yi(_t,W,H,et,ct){const Et=W===ct.maxZoom?0:ct.tolerance/((1<<W)*ct.extent),Ot={features:[],numPoints:0,numSimplified:0,numFeatures:_t.length,source:null,x:H,y:et,z:W,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const zt of _t)Ee(Ot,zt,Et,ct);return Ot}function Ee(_t,W,H,et){const ct=W.geometry,Et=W.type,Ot=[];if(_t.minX=Math.min(_t.minX,W.minX),_t.minY=Math.min(_t.minY,W.minY),_t.maxX=Math.max(_t.maxX,W.maxX),_t.maxY=Math.max(_t.maxY,W.maxY),Et==="Point"||Et==="MultiPoint")for(let zt=0;zt<ct.length;zt+=3)Ot.push(ct[zt],ct[zt+1]),_t.numPoints++,_t.numSimplified++;else if(Et==="LineString")ui(Ot,ct,_t,H,!1,!1);else if(Et==="MultiLineString"||Et==="Polygon")for(let zt=0;zt<ct.length;zt++)ui(Ot,ct[zt],_t,H,Et==="Polygon",zt===0);else if(Et==="MultiPolygon")for(let zt=0;zt<ct.length;zt++){const St=ct[zt];for(let ee=0;ee<St.length;ee++)ui(Ot,St[ee],_t,H,!0,ee===0)}if(Ot.length){let zt=W.tags||null;if(Et==="LineString"&&et.lineMetrics){zt={};for(const ee in W.tags)zt[ee]=W.tags[ee];zt.mapbox_clip_start=ct.start/ct.size,zt.mapbox_clip_end=ct.end/ct.size}const St={geometry:Ot,type:Et==="Polygon"||Et==="MultiPolygon"?3:Et==="LineString"||Et==="MultiLineString"?2:1,tags:zt};W.id!==null&&(St.id=W.id),_t.features.push(St)}}function ui(_t,W,H,et,ct,Et){const Ot=et*et;if(et>0&&W.size<(ct?Ot:et))return void(H.numPoints+=W.length/3);const zt=[];for(let St=0;St<W.length;St+=3)(et===0||W[St+2]>Ot)&&(H.numSimplified++,zt.push(W[St],W[St+1])),H.numPoints++;ct&&function(St,ee){let le=0;for(let Yt=0,Pe=St.length,Qe=Pe-2;Yt<Pe;Qe=Yt,Yt+=2)le+=(St[Yt]-St[Qe])*(St[Yt+1]+St[Qe+1]);if(le>0===ee)for(let Yt=0,Pe=St.length;Yt<Pe/2;Yt+=2){const Qe=St[Yt],ei=St[Yt+1];St[Yt]=St[Pe-2-Yt],St[Yt+1]=St[Pe-1-Yt],St[Pe-2-Yt]=Qe,St[Pe-1-Yt]=ei}}(zt,Et),_t.push(zt)}const $e={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Zi{constructor(W,H){const et=(H=this.options=function(Et,Ot){for(const zt in Ot)Et[zt]=Ot[zt];return Et}(Object.create($e),H)).debug;if(et&&console.time("preprocess data"),H.maxZoom<0||H.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(H.promoteId&&H.generateId)throw new Error("promoteId and generateId cannot be used together.");let ct=function(Et,Ot){const zt=[];if(Et.type==="FeatureCollection")for(let St=0;St<Et.features.length;St++)Lt(zt,Et.features[St],Ot,St);else Lt(zt,Et.type==="Feature"?Et:{geometry:Et},Ot);return zt}(W,H);this.tiles={},this.tileCoords=[],et&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",H.indexMaxZoom,H.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ct=function(Et,Ot){const zt=Ot.buffer/Ot.extent;let St=Et;const ee=Fe(Et,1,-1-zt,zt,0,-1,2,Ot),le=Fe(Et,1,1-zt,2+zt,0,-1,2,Ot);return(ee||le)&&(St=Fe(Et,1,-zt,1+zt,0,-1,2,Ot)||[],ee&&(St=ce(ee,1).concat(St)),le&&(St=St.concat(ce(le,-1)))),St}(ct,H),ct.length&&this.splitTile(ct,0,0,0),et&&(ct.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(W,H,et,ct,Et,Ot,zt){const St=[W,H,et,ct],ee=this.options,le=ee.debug;for(;St.length;){ct=St.pop(),et=St.pop(),H=St.pop(),W=St.pop();const Yt=1<<H,Pe=Tr(H,et,ct);let Qe=this.tiles[Pe];if(!Qe&&(le>1&&console.time("creation"),Qe=this.tiles[Pe]=Yi(W,H,et,ct,ee),this.tileCoords.push({z:H,x:et,y:ct}),le)){le>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",H,et,ct,Qe.numFeatures,Qe.numPoints,Qe.numSimplified),console.timeEnd("creation"));const Ar=`z${H}`;this.stats[Ar]=(this.stats[Ar]||0)+1,this.total++}if(Qe.source=W,Et==null){if(H===ee.indexMaxZoom||Qe.numPoints<=ee.indexMaxPoints)continue}else{if(H===ee.maxZoom||H===Et)continue;if(Et!=null){const Ar=Et-H;if(et!==Ot>>Ar||ct!==zt>>Ar)continue}}if(Qe.source=null,W.length===0)continue;le>1&&console.time("clipping");const ei=.5*ee.buffer/ee.extent,_i=.5-ei,Ei=.5+ei,gi=1+ei;let tr=null,xr=null,Fi=null,ki=null,Hi=Fe(W,Yt,et-ei,et+Ei,0,Qe.minX,Qe.maxX,ee),hr=Fe(W,Yt,et+_i,et+gi,0,Qe.minX,Qe.maxX,ee);W=null,Hi&&(tr=Fe(Hi,Yt,ct-ei,ct+Ei,1,Qe.minY,Qe.maxY,ee),xr=Fe(Hi,Yt,ct+_i,ct+gi,1,Qe.minY,Qe.maxY,ee),Hi=null),hr&&(Fi=Fe(hr,Yt,ct-ei,ct+Ei,1,Qe.minY,Qe.maxY,ee),ki=Fe(hr,Yt,ct+_i,ct+gi,1,Qe.minY,Qe.maxY,ee),hr=null),le>1&&console.timeEnd("clipping"),St.push(tr||[],H+1,2*et,2*ct),St.push(xr||[],H+1,2*et,2*ct+1),St.push(Fi||[],H+1,2*et+1,2*ct),St.push(ki||[],H+1,2*et+1,2*ct+1)}}getTile(W,H,et){W=+W,H=+H,et=+et;const ct=this.options,{extent:Et,debug:Ot}=ct;if(W<0||W>24)return null;const zt=1<<W,St=Tr(W,H=H+zt&zt-1,et);if(this.tiles[St])return zi(this.tiles[St],Et);Ot>1&&console.log("drilling down to z%d-%d-%d",W,H,et);let ee,le=W,Yt=H,Pe=et;for(;!ee&&le>0;)le--,Yt>>=1,Pe>>=1,ee=this.tiles[Tr(le,Yt,Pe)];return ee&&ee.source?(Ot>1&&(console.log("found parent tile z%d-%d-%d",le,Yt,Pe),console.time("drilling down")),this.splitTile(ee.source,le,Yt,Pe,W,H,et),Ot>1&&console.timeEnd("drilling down"),this.tiles[St]?zi(this.tiles[St],Et):null):null}}function Tr(_t,W,H){return 32*((1<<_t)*H+W)+_t}function ii(_t,W){return W?_t.properties[W]:_t.id}function Oi(_t,W){if(_t==null)return!0;if(_t.type==="Feature")return ii(_t,W)!=null;if(_t.type==="FeatureCollection"){const H=new Set;for(const et of _t.features){const ct=ii(et,W);if(ct==null||H.has(ct))return!1;H.add(ct)}return!0}return!1}function Wi(_t,W){const H=new Map;if(_t!=null)if(_t.type==="Feature")H.set(ii(_t,W),_t);else for(const et of _t.features)H.set(ii(et,W),et);return H}class Rr extends l{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(W,H){return N._(this,void 0,void 0,function*(){const et=W.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const ct=this._geoJSONIndex.getTile(et.z,et.x,et.y);if(!ct)return null;const Et=new class{constructor(zt){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=N.X,this.length=zt.length,this._features=zt}feature(zt){return new class{constructor(St){this._feature=St,this.extent=N.X,this.type=St.type,this.properties=St.tags,"id"in St&&!isNaN(St.id)&&(this.id=parseInt(St.id,10))}loadGeometry(){if(this._feature.type===1){const St=[];for(const ee of this._feature.geometry)St.push([new N.P(ee[0],ee[1])]);return St}{const St=[];for(const ee of this._feature.geometry){const le=[];for(const Yt of ee)le.push(new N.P(Yt[0],Yt[1]));St.push(le)}return St}}toGeoJSON(St,ee,le){return d.call(this,St,ee,le)}}(this._features[zt])}}(ct.features);let Ot=se(Et);return Ot.byteOffset===0&&Ot.byteLength===Ot.buffer.byteLength||(Ot=new Uint8Array(Ot)),{vectorTile:Et,rawData:Ot.buffer}})}loadData(W){return N._(this,void 0,void 0,function*(){var H;(H=this._pendingRequest)===null||H===void 0||H.abort();const et=!!(W&&W.request&&W.request.collectResourceTiming)&&new N.bu(W.request);this._pendingRequest=new AbortController;try{this._pendingData=this.loadAndProcessGeoJSON(W,this._pendingRequest),this._geoJSONIndex=W.cluster?new pt(function({superclusterOptions:Ot,clusterProperties:zt}){if(!zt||!Ot)return Ot;const St={},ee={},le={accumulated:null,zoom:0},Yt={properties:null},Pe=Object.keys(zt);for(const Qe of Pe){const[ei,_i]=zt[Qe],Ei=N.bB(_i),gi=N.bB(typeof ei=="string"?[ei,["accumulated"],["get",Qe]]:ei);St[Qe]=Ei.value,ee[Qe]=gi.value}return Ot.map=Qe=>{Yt.properties=Qe;const ei={};for(const _i of Pe)ei[_i]=St[_i].evaluate(le,Yt);return ei},Ot.reduce=(Qe,ei)=>{Yt.properties=ei;for(const _i of Pe)le.accumulated=Qe[_i],Qe[_i]=ee[_i].evaluate(le,Yt)},Ot}(W)).load((yield this._pendingData).features):(ct=yield this._pendingData,new Zi(ct,W.geojsonVtOptions)),this.loaded={};const Et={};if(et){const Ot=et.finish();Ot&&(Et.resourceTiming={},Et.resourceTiming[W.source]=JSON.parse(JSON.stringify(Ot)))}return Et}catch(Et){if(delete this._pendingRequest,N.bA(Et))return{abandoned:!0};throw Et}var ct})}getData(){return N._(this,void 0,void 0,function*(){return this._pendingData})}reloadTile(W){const H=this.loaded;return H&&H[W.uid]?super.reloadTile(W):this.loadTile(W)}loadAndProcessGeoJSON(W,H){return N._(this,void 0,void 0,function*(){let et=yield this.loadGeoJSON(W,H);if(delete this._pendingRequest,typeof et!="object")throw new Error(`Input data given to '${W.source}' is not a valid GeoJSON object.`);if(g(et,!0),W.filter){const ct=N.bB(W.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(ct.result==="error")throw new Error(ct.value.map(Ot=>`${Ot.key}: ${Ot.message}`).join(", "));et={type:"FeatureCollection",features:et.features.filter(Ot=>ct.value.evaluate({zoom:0},Ot))}}return et})}loadGeoJSON(W,H){return N._(this,void 0,void 0,function*(){const{promoteId:et}=W;if(W.request){const ct=yield N.h(W.request,H);return this._dataUpdateable=Oi(ct.data,et)?Wi(ct.data,et):void 0,ct.data}if(typeof W.data=="string")try{const ct=JSON.parse(W.data);return this._dataUpdateable=Oi(ct,et)?Wi(ct,et):void 0,ct}catch{throw new Error(`Input data given to '${W.source}' is not a valid GeoJSON object.`)}if(!W.dataDiff)throw new Error(`Input data given to '${W.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${W.source}`);return function(ct,Et,Ot){var zt,St,ee,le;if(Et.removeAll&&ct.clear(),Et.remove)for(const Yt of Et.remove)ct.delete(Yt);if(Et.add)for(const Yt of Et.add){const Pe=ii(Yt,Ot);Pe!=null&&ct.set(Pe,Yt)}if(Et.update)for(const Yt of Et.update){let Pe=ct.get(Yt.id);if(Pe==null)continue;const Qe=!Yt.removeAllProperties&&(((zt=Yt.removeProperties)===null||zt===void 0?void 0:zt.length)>0||((St=Yt.addOrUpdateProperties)===null||St===void 0?void 0:St.length)>0);if((Yt.newGeometry||Yt.removeAllProperties||Qe)&&(Pe=Object.assign({},Pe),ct.set(Yt.id,Pe),Qe&&(Pe.properties=Object.assign({},Pe.properties))),Yt.newGeometry&&(Pe.geometry=Yt.newGeometry),Yt.removeAllProperties)Pe.properties={};else if(((ee=Yt.removeProperties)===null||ee===void 0?void 0:ee.length)>0)for(const ei of Yt.removeProperties)Object.prototype.hasOwnProperty.call(Pe.properties,ei)&&delete Pe.properties[ei];if(((le=Yt.addOrUpdateProperties)===null||le===void 0?void 0:le.length)>0)for(const{key:ei,value:_i}of Yt.addOrUpdateProperties)Pe.properties[ei]=_i}}(this._dataUpdateable,W.dataDiff,et),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}})}removeSource(W){return N._(this,void 0,void 0,function*(){this._pendingRequest&&this._pendingRequest.abort()})}getClusterExpansionZoom(W){return this._geoJSONIndex.getClusterExpansionZoom(W.clusterId)}getClusterChildren(W){return this._geoJSONIndex.getChildren(W.clusterId)}getClusterLeaves(W){return this._geoJSONIndex.getLeaves(W.clusterId,W.limit,W.offset)}}class cr{constructor(W){this.self=W,this.actor=new N.F(W),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(H,et)=>{if(this.externalWorkerSourceTypes[H])throw new Error(`Worker source with name "${H}" already registered.`);this.externalWorkerSourceTypes[H]=et},this.self.addProtocol=N.bh,this.self.removeProtocol=N.bi,this.self.registerRTLTextPlugin=H=>{if(N.bC.isParsed())throw new Error("RTL text plugin already registered.");N.bC.setMethods(H)},this.actor.registerMessageHandler("LDT",(H,et)=>this._getDEMWorkerSource(H,et.source).loadTile(et)),this.actor.registerMessageHandler("RDT",(H,et)=>N._(this,void 0,void 0,function*(){this._getDEMWorkerSource(H,et.source).removeTile(et)})),this.actor.registerMessageHandler("GCEZ",(H,et)=>N._(this,void 0,void 0,function*(){return this._getWorkerSource(H,et.type,et.source).getClusterExpansionZoom(et)})),this.actor.registerMessageHandler("GCC",(H,et)=>N._(this,void 0,void 0,function*(){return this._getWorkerSource(H,et.type,et.source).getClusterChildren(et)})),this.actor.registerMessageHandler("GCL",(H,et)=>N._(this,void 0,void 0,function*(){return this._getWorkerSource(H,et.type,et.source).getClusterLeaves(et)})),this.actor.registerMessageHandler("LD",(H,et)=>this._getWorkerSource(H,et.type,et.source).loadData(et)),this.actor.registerMessageHandler("GD",(H,et)=>this._getWorkerSource(H,et.type,et.source).getData()),this.actor.registerMessageHandler("LT",(H,et)=>this._getWorkerSource(H,et.type,et.source).loadTile(et)),this.actor.registerMessageHandler("RT",(H,et)=>this._getWorkerSource(H,et.type,et.source).reloadTile(et)),this.actor.registerMessageHandler("AT",(H,et)=>this._getWorkerSource(H,et.type,et.source).abortTile(et)),this.actor.registerMessageHandler("RMT",(H,et)=>this._getWorkerSource(H,et.type,et.source).removeTile(et)),this.actor.registerMessageHandler("RS",(H,et)=>N._(this,void 0,void 0,function*(){if(!this.workerSources[H]||!this.workerSources[H][et.type]||!this.workerSources[H][et.type][et.source])return;const ct=this.workerSources[H][et.type][et.source];delete this.workerSources[H][et.type][et.source],ct.removeSource!==void 0&&ct.removeSource(et)})),this.actor.registerMessageHandler("RM",H=>N._(this,void 0,void 0,function*(){delete this.layerIndexes[H],delete this.availableImages[H],delete this.workerSources[H],delete this.demWorkerSources[H]})),this.actor.registerMessageHandler("SR",(H,et)=>N._(this,void 0,void 0,function*(){this.referrer=et})),this.actor.registerMessageHandler("SRPS",(H,et)=>this._syncRTLPluginState(H,et)),this.actor.registerMessageHandler("IS",(H,et)=>N._(this,void 0,void 0,function*(){this.self.importScripts(et)})),this.actor.registerMessageHandler("SI",(H,et)=>this._setImages(H,et)),this.actor.registerMessageHandler("UL",(H,et)=>N._(this,void 0,void 0,function*(){this._getLayerIndex(H).update(et.layers,et.removedIds)})),this.actor.registerMessageHandler("SL",(H,et)=>N._(this,void 0,void 0,function*(){this._getLayerIndex(H).replace(et)}))}_setImages(W,H){return N._(this,void 0,void 0,function*(){this.availableImages[W]=H;for(const et in this.workerSources[W]){const ct=this.workerSources[W][et];for(const Et in ct)ct[Et].availableImages=H}})}_syncRTLPluginState(W,H){return N._(this,void 0,void 0,function*(){if(N.bC.isParsed())return N.bC.getState();if(H.pluginStatus!=="loading")return N.bC.setState(H),H;const et=H.pluginURL;if(this.self.importScripts(et),N.bC.isParsed()){const ct={pluginStatus:"loaded",pluginURL:et};return N.bC.setState(ct),ct}throw N.bC.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${et}`)})}_getAvailableImages(W){let H=this.availableImages[W];return H||(H=[]),H}_getLayerIndex(W){let H=this.layerIndexes[W];return H||(H=this.layerIndexes[W]=new s),H}_getWorkerSource(W,H,et){if(this.workerSources[W]||(this.workerSources[W]={}),this.workerSources[W][H]||(this.workerSources[W][H]={}),!this.workerSources[W][H][et]){const ct={sendAsync:(Et,Ot)=>(Et.targetMapId=W,this.actor.sendAsync(Et,Ot))};switch(H){case"vector":this.workerSources[W][H][et]=new l(ct,this._getLayerIndex(W),this._getAvailableImages(W));break;case"geojson":this.workerSources[W][H][et]=new Rr(ct,this._getLayerIndex(W),this._getAvailableImages(W));break;default:this.workerSources[W][H][et]=new this.externalWorkerSourceTypes[H](ct,this._getLayerIndex(W),this._getAvailableImages(W))}}return this.workerSources[W][H][et]}_getDEMWorkerSource(W,H){return this.demWorkerSources[W]||(this.demWorkerSources[W]={}),this.demWorkerSources[W][H]||(this.demWorkerSources[W][H]=new c),this.demWorkerSources[W][H]}}return N.i(self)&&(self.worker=new cr(self)),cr}),lt("index",["exports","./shared"],function(N,s){var p="4.5.2";let C,b;const l={now:typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frameAsync:y=>new Promise((e,n)=>{const a=requestAnimationFrame(e);y.signal.addEventListener("abort",()=>{cancelAnimationFrame(a),n(s.c())})}),getImageData(y,e=0){return this.getImageCanvasContext(y).getImageData(-e,-e,y.width+2*e,y.height+2*e)},getImageCanvasContext(y){const e=window.document.createElement("canvas"),n=e.getContext("2d",{willReadFrequently:!0});if(!n)throw new Error("failed to create canvas 2d context");return e.width=y.width,e.height=y.height,n.drawImage(y,0,0,y.width,y.height),n},resolveURL:y=>(C||(C=document.createElement("a")),C.href=y,C.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(b==null&&(b=matchMedia("(prefers-reduced-motion: reduce)")),b.matches)}};class c{static testProp(e){if(!c.docStyle)return e[0];for(let n=0;n<e.length;n++)if(e[n]in c.docStyle)return e[n];return e[0]}static create(e,n,a){const u=window.document.createElement(e);return n!==void 0&&(u.className=n),a&&a.appendChild(u),u}static createNS(e,n){return window.document.createElementNS(e,n)}static disableDrag(){c.docStyle&&c.selectProp&&(c.userSelect=c.docStyle[c.selectProp],c.docStyle[c.selectProp]="none")}static enableDrag(){c.docStyle&&c.selectProp&&(c.docStyle[c.selectProp]=c.userSelect)}static setTransform(e,n){e.style[c.transformProp]=n}static addEventListener(e,n,a,u={}){e.addEventListener(n,a,"passive"in u?u:u.capture)}static removeEventListener(e,n,a,u={}){e.removeEventListener(n,a,"passive"in u?u:u.capture)}static suppressClickInternal(e){e.preventDefault(),e.stopPropagation(),window.removeEventListener("click",c.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",c.suppressClickInternal,!0),window.setTimeout(()=>{window.removeEventListener("click",c.suppressClickInternal,!0)},0)}static getScale(e){const n=e.getBoundingClientRect();return{x:n.width/e.offsetWidth||1,y:n.height/e.offsetHeight||1,boundingClientRect:n}}static getPoint(e,n,a){const u=n.boundingClientRect;return new s.P((a.clientX-u.left)/n.x-e.clientLeft,(a.clientY-u.top)/n.y-e.clientTop)}static mousePos(e,n){const a=c.getScale(e);return c.getPoint(e,a,n)}static touchPos(e,n){const a=[],u=c.getScale(e);for(let _=0;_<n.length;_++)a.push(c.getPoint(e,u,n[_]));return a}static mouseButton(e){return e.button}static remove(e){e.parentNode&&e.parentNode.removeChild(e)}}c.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,c.selectProp=c.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),c.transformProp=c.testProp(["transform","WebkitTransform"]);const h={supported:!1,testSupport:function(y){!d&&g&&(w?E(y):m=y)}};let m,g,d=!1,w=!1;function E(y){const e=y.createTexture();y.bindTexture(y.TEXTURE_2D,e);try{if(y.texImage2D(y.TEXTURE_2D,0,y.RGBA,y.RGBA,y.UNSIGNED_BYTE,g),y.isContextLost())return;h.supported=!0}catch{}y.deleteTexture(e),d=!0}var O;typeof document<"u"&&(g=document.createElement("img"),g.onload=()=>{m&&E(m),m=null,w=!0},g.onerror=()=>{d=!0,m=null},g.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(y){let e,n,a,u;y.resetRequestQueue=()=>{e=[],n=0,a=0,u={}},y.addThrottleControl=z=>{const R=a++;return u[R]=z,R},y.removeThrottleControl=z=>{delete u[z],I()},y.getImage=(z,R,V=!0)=>new Promise((G,Y)=>{h.supported&&(z.headers||(z.headers={}),z.headers.accept="image/webp,*/*"),s.e(z,{type:"image"}),e.push({abortController:R,requestParameters:z,supportImageRefresh:V,state:"queued",onError:tt=>{Y(tt)},onSuccess:tt=>{G(tt)}}),I()});const _=z=>s._(this,void 0,void 0,function*(){z.state="running";const{requestParameters:R,supportImageRefresh:V,onError:G,onSuccess:Y,abortController:tt}=z,ot=V===!1&&!s.i(self)&&!s.g(R.url)&&(!R.headers||Object.keys(R.headers).reduce((bt,Pt)=>bt&&Pt==="accept",!0));n++;const mt=ot?k(R,tt):s.m(R,tt);try{const bt=yield mt;delete z.abortController,z.state="completed",bt.data instanceof HTMLImageElement||s.b(bt.data)?Y(bt):bt.data&&Y({data:yield(ut=bt.data,typeof createImageBitmap=="function"?s.d(ut):s.f(ut)),cacheControl:bt.cacheControl,expires:bt.expires})}catch(bt){delete z.abortController,G(bt)}finally{n--,I()}var ut}),I=()=>{const z=(()=>{for(const R of Object.keys(u))if(u[R]())return!0;return!1})()?s.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:s.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let R=n;R<z&&e.length>0;R++){const V=e.shift();V.abortController.signal.aborted?R--:_(V)}},k=(z,R)=>new Promise((V,G)=>{const Y=new Image,tt=z.url,ot=z.credentials;ot&&ot==="include"?Y.crossOrigin="use-credentials":(ot&&ot==="same-origin"||!s.s(tt))&&(Y.crossOrigin="anonymous"),R.signal.addEventListener("abort",()=>{Y.src="",G(s.c())}),Y.fetchPriority="high",Y.onload=()=>{Y.onerror=Y.onload=null,V({data:Y})},Y.onerror=()=>{Y.onerror=Y.onload=null,R.signal.aborted||G(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},Y.src=tt})}(O||(O={})),O.resetRequestQueue();class L{constructor(e){this._transformRequestFn=e}transformRequest(e,n){return this._transformRequestFn&&this._transformRequestFn(e,n)||{url:e}}setTransformRequest(e){this._transformRequestFn=e}}function U(y){var e=new s.A(3);return e[0]=y[0],e[1]=y[1],e[2]=y[2],e}var $,nt=function(y,e,n){return y[0]=e[0]-n[0],y[1]=e[1]-n[1],y[2]=e[2]-n[2],y};$=new s.A(3),s.A!=Float32Array&&($[0]=0,$[1]=0,$[2]=0);var xt=function(y){var e=y[0],n=y[1];return e*e+n*n};function Ft(y){const e=[];if(typeof y=="string")e.push({id:"default",url:y});else if(y&&y.length>0){const n=[];for(const{id:a,url:u}of y){const _=`${a}${u}`;n.indexOf(_)===-1&&(n.push(_),e.push({id:a,url:u}))}}return e}function Kt(y,e,n){const a=y.split("?");return a[0]+=`${e}${n}`,a.join("?")}(function(){var y=new s.A(2);s.A!=Float32Array&&(y[0]=0,y[1]=0)})();class Jt{constructor(e,n,a,u){this.context=e,this.format=a,this.texture=e.gl.createTexture(),this.update(n,u)}update(e,n,a){const{width:u,height:_}=e,I=!(this.size&&this.size[0]===u&&this.size[1]===_||a),{context:k}=this,{gl:z}=k;if(this.useMipmap=!!(n&&n.useMipmap),z.bindTexture(z.TEXTURE_2D,this.texture),k.pixelStoreUnpackFlipY.set(!1),k.pixelStoreUnpack.set(1),k.pixelStoreUnpackPremultiplyAlpha.set(this.format===z.RGBA&&(!n||n.premultiply!==!1)),I)this.size=[u,_],e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||s.b(e)?z.texImage2D(z.TEXTURE_2D,0,this.format,this.format,z.UNSIGNED_BYTE,e):z.texImage2D(z.TEXTURE_2D,0,this.format,u,_,0,this.format,z.UNSIGNED_BYTE,e.data);else{const{x:R,y:V}=a||{x:0,y:0};e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||s.b(e)?z.texSubImage2D(z.TEXTURE_2D,0,R,V,z.RGBA,z.UNSIGNED_BYTE,e):z.texSubImage2D(z.TEXTURE_2D,0,R,V,u,_,z.RGBA,z.UNSIGNED_BYTE,e.data)}this.useMipmap&&this.isSizePowerOfTwo()&&z.generateMipmap(z.TEXTURE_2D)}bind(e,n,a){const{context:u}=this,{gl:_}=u;_.bindTexture(_.TEXTURE_2D,this.texture),a!==_.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(a=_.LINEAR),e!==this.filter&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MAG_FILTER,e),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MIN_FILTER,a||e),this.filter=e),n!==this.wrap&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_S,n),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_T,n),this.wrap=n)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}function Qt(y){const{userImage:e}=y;return!!(e&&e.render&&e.render())&&(y.data.replace(new Uint8Array(e.data.buffer)),!0)}class he extends s.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new s.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(e){if(this.loaded!==e&&(this.loaded=e,e)){for(const{ids:n,promiseResolve:a}of this.requestors)a(this._getImagesForIds(n));this.requestors=[]}}getImage(e){const n=this.images[e];if(n&&!n.data&&n.spriteData){const a=n.spriteData;n.data=new s.R({width:a.width,height:a.height},a.context.getImageData(a.x,a.y,a.width,a.height).data),n.spriteData=null}return n}addImage(e,n){if(this.images[e])throw new Error(`Image id ${e} already exist, use updateImage instead`);this._validate(e,n)&&(this.images[e]=n)}_validate(e,n){let a=!0;const u=n.data||n.spriteData;return this._validateStretch(n.stretchX,u&&u.width)||(this.fire(new s.j(new Error(`Image "${e}" has invalid "stretchX" value`))),a=!1),this._validateStretch(n.stretchY,u&&u.height)||(this.fire(new s.j(new Error(`Image "${e}" has invalid "stretchY" value`))),a=!1),this._validateContent(n.content,n)||(this.fire(new s.j(new Error(`Image "${e}" has invalid "content" value`))),a=!1),a}_validateStretch(e,n){if(!e)return!0;let a=0;for(const u of e){if(u[0]<a||u[1]<u[0]||n<u[1])return!1;a=u[1]}return!0}_validateContent(e,n){if(!e)return!0;if(e.length!==4)return!1;const a=n.spriteData,u=a&&a.width||n.data.width,_=a&&a.height||n.data.height;return!(e[0]<0||u<e[0]||e[1]<0||_<e[1]||e[2]<0||u<e[2]||e[3]<0||_<e[3]||e[2]<e[0]||e[3]<e[1])}updateImage(e,n,a=!0){const u=this.getImage(e);if(a&&(u.data.width!==n.data.width||u.data.height!==n.data.height))throw new Error(`size mismatch between old image (${u.data.width}x${u.data.height}) and new image (${n.data.width}x${n.data.height}).`);n.version=u.version+1,this.images[e]=n,this.updatedImages[e]=!0}removeImage(e){const n=this.images[e];delete this.images[e],delete this.patterns[e],n.userImage&&n.userImage.onRemove&&n.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(e){return new Promise((n,a)=>{let u=!0;if(!this.isLoaded())for(const _ of e)this.images[_]||(u=!1);this.isLoaded()||u?n(this._getImagesForIds(e)):this.requestors.push({ids:e,promiseResolve:n})})}_getImagesForIds(e){const n={};for(const a of e){let u=this.getImage(a);u||(this.fire(new s.k("styleimagemissing",{id:a})),u=this.getImage(a)),u?n[a]={data:u.data.clone(),pixelRatio:u.pixelRatio,sdf:u.sdf,version:u.version,stretchX:u.stretchX,stretchY:u.stretchY,content:u.content,textFitWidth:u.textFitWidth,textFitHeight:u.textFitHeight,hasRenderCallback:!!(u.userImage&&u.userImage.render)}:s.w(`Image "${a}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return n}getPixelSize(){const{width:e,height:n}=this.atlasImage;return{width:e,height:n}}getPattern(e){const n=this.patterns[e],a=this.getImage(e);if(!a)return null;if(n&&n.position.version===a.version)return n.position;if(n)n.position.version=a.version;else{const u={w:a.data.width+2,h:a.data.height+2,x:0,y:0},_=new s.I(u,a);this.patterns[e]={bin:u,position:_}}return this._updatePatternAtlas(),this.patterns[e].position}bind(e){const n=e.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new Jt(e,this.atlasImage,n.RGBA),this.atlasTexture.bind(n.LINEAR,n.CLAMP_TO_EDGE)}_updatePatternAtlas(){const e=[];for(const _ in this.patterns)e.push(this.patterns[_].bin);const{w:n,h:a}=s.p(e),u=this.atlasImage;u.resize({width:n||1,height:a||1});for(const _ in this.patterns){const{bin:I}=this.patterns[_],k=I.x+1,z=I.y+1,R=this.getImage(_).data,V=R.width,G=R.height;s.R.copy(R,u,{x:0,y:0},{x:k,y:z},{width:V,height:G}),s.R.copy(R,u,{x:0,y:G-1},{x:k,y:z-1},{width:V,height:1}),s.R.copy(R,u,{x:0,y:0},{x:k,y:z+G},{width:V,height:1}),s.R.copy(R,u,{x:V-1,y:0},{x:k-1,y:z},{width:1,height:G}),s.R.copy(R,u,{x:0,y:0},{x:k+V,y:z},{width:1,height:G})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(e){for(const n of e){if(this.callbackDispatchedThisFrame[n])continue;this.callbackDispatchedThisFrame[n]=!0;const a=this.getImage(n);a||s.w(`Image with ID: "${n}" was not found`),Qt(a)&&this.updateImage(n,a)}}}const ne=1e20;function me(y,e,n,a,u,_,I,k,z){for(let R=e;R<e+a;R++)Oe(y,n*_+R,_,u,I,k,z);for(let R=n;R<n+u;R++)Oe(y,R*_+e,1,a,I,k,z)}function Oe(y,e,n,a,u,_,I){_[0]=0,I[0]=-ne,I[1]=ne,u[0]=y[e];for(let k=1,z=0,R=0;k<a;k++){u[k]=y[e+k*n];const V=k*k;do{const G=_[z];R=(u[k]-u[G]+V-G*G)/(k-G)/2}while(R<=I[z]&&--z>-1);z++,_[z]=k,I[z]=R,I[z+1]=ne}for(let k=0,z=0;k<a;k++){for(;I[z+1]<k;)z++;const R=_[z],V=k-R;y[e+k*n]=u[R]+V*V}}class se{constructor(e,n){this.requestManager=e,this.localIdeographFontFamily=n,this.entries={}}setURL(e){this.url=e}getGlyphs(e){return s._(this,void 0,void 0,function*(){const n=[];for(const _ in e)for(const I of e[_])n.push(this._getAndCacheGlyphsPromise(_,I));const a=yield Promise.all(n),u={};for(const{stack:_,id:I,glyph:k}of a)u[_]||(u[_]={}),u[_][I]=k&&{id:k.id,bitmap:k.bitmap.clone(),metrics:k.metrics};return u})}_getAndCacheGlyphsPromise(e,n){return s._(this,void 0,void 0,function*(){let a=this.entries[e];a||(a=this.entries[e]={glyphs:{},requests:{},ranges:{}});let u=a.glyphs[n];if(u!==void 0)return{stack:e,id:n,glyph:u};if(u=this._tinySDF(a,e,n),u)return a.glyphs[n]=u,{stack:e,id:n,glyph:u};const _=Math.floor(n/256);if(256*_>65535)throw new Error("glyphs > 65535 not supported");if(a.ranges[_])return{stack:e,id:n,glyph:u};if(!this.url)throw new Error("glyphsUrl is not set");if(!a.requests[_]){const k=se.loadGlyphRange(e,_,this.url,this.requestManager);a.requests[_]=k}const I=yield a.requests[_];for(const k in I)this._doesCharSupportLocalGlyph(+k)||(a.glyphs[+k]=I[+k]);return a.ranges[_]=!0,{stack:e,id:n,glyph:I[n]||null}})}_doesCharSupportLocalGlyph(e){return!!this.localIdeographFontFamily&&(s.u["CJK Unified Ideographs"](e)||s.u["Hangul Syllables"](e)||s.u.Hiragana(e)||s.u.Katakana(e))}_tinySDF(e,n,a){const u=this.localIdeographFontFamily;if(!u||!this._doesCharSupportLocalGlyph(a))return;let _=e.tinySDF;if(!_){let k="400";/bold/i.test(n)?k="900":/medium/i.test(n)?k="500":/light/i.test(n)&&(k="200"),_=e.tinySDF=new se.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:u,fontWeight:k})}const I=_.draw(String.fromCharCode(a));return{id:a,bitmap:new s.o({width:I.width||60,height:I.height||60},I.data),metrics:{width:I.glyphWidth/2||24,height:I.glyphHeight/2||24,left:I.glyphLeft/2+.5||0,top:I.glyphTop/2-27.5||-8,advance:I.glyphAdvance/2||24,isDoubleResolution:!0}}}}se.loadGlyphRange=function(y,e,n,a){return s._(this,void 0,void 0,function*(){const u=256*e,_=u+255,I=a.transformRequest(n.replace("{fontstack}",y).replace("{range}",`${u}-${_}`),"Glyphs"),k=yield s.l(I,new AbortController);if(!k||!k.data)throw new Error(`Could not load glyph range. range: ${e}, ${u}-${_}`);const z={};for(const R of s.n(k.data))z[R.id]=R;return z})},se.TinySDF=class{constructor({fontSize:y=24,buffer:e=3,radius:n=8,cutoff:a=.25,fontFamily:u="sans-serif",fontWeight:_="normal",fontStyle:I="normal"}={}){this.buffer=e,this.cutoff=a,this.radius=n;const k=this.size=y+4*e,z=this._createCanvas(k),R=this.ctx=z.getContext("2d",{willReadFrequently:!0});R.font=`${I} ${_} ${y}px ${u}`,R.textBaseline="alphabetic",R.textAlign="left",R.fillStyle="black",this.gridOuter=new Float64Array(k*k),this.gridInner=new Float64Array(k*k),this.f=new Float64Array(k),this.z=new Float64Array(k+1),this.v=new Uint16Array(k)}_createCanvas(y){const e=document.createElement("canvas");return e.width=e.height=y,e}draw(y){const{width:e,actualBoundingBoxAscent:n,actualBoundingBoxDescent:a,actualBoundingBoxLeft:u,actualBoundingBoxRight:_}=this.ctx.measureText(y),I=Math.ceil(n),k=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(_-u))),z=Math.min(this.size-this.buffer,I+Math.ceil(a)),R=k+2*this.buffer,V=z+2*this.buffer,G=Math.max(R*V,0),Y=new Uint8ClampedArray(G),tt={data:Y,width:R,height:V,glyphWidth:k,glyphHeight:z,glyphTop:I,glyphLeft:0,glyphAdvance:e};if(k===0||z===0)return tt;const{ctx:ot,buffer:mt,gridInner:ut,gridOuter:bt}=this;ot.clearRect(mt,mt,k,z),ot.fillText(y,mt,mt+I);const Pt=ot.getImageData(mt,mt,k,z);bt.fill(ne,0,G),ut.fill(0,0,G);for(let ht=0;ht<z;ht++)for(let Dt=0;Dt<k;Dt++){const Ut=Pt.data[4*(ht*k+Dt)+3]/255;if(Ut===0)continue;const $t=(ht+mt)*R+Dt+mt;if(Ut===1)bt[$t]=0,ut[$t]=ne;else{const _e=.5-Ut;bt[$t]=_e>0?_e*_e:0,ut[$t]=_e<0?_e*_e:0}}me(bt,0,0,R,V,R,this.f,this.v,this.z),me(ut,mt,mt,k,z,R,this.f,this.v,this.z);for(let ht=0;ht<G;ht++){const Dt=Math.sqrt(bt[ht])-Math.sqrt(ut[ht]);Y[ht]=Math.round(255-255*(Dt/this.radius+this.cutoff))}return tt}};class be{constructor(){this.specification=s.v.light.position}possiblyEvaluate(e,n){return s.y(e.expression.evaluate(n))}interpolate(e,n,a){return{x:s.z.number(e.x,n.x,a),y:s.z.number(e.y,n.y,a),z:s.z.number(e.z,n.z,a)}}}let Q;class wt extends s.E{constructor(e){super(),Q=Q||new s.q({anchor:new s.D(s.v.light.anchor),position:new be,color:new s.D(s.v.light.color),intensity:new s.D(s.v.light.intensity)}),this._transitionable=new s.T(Q),this.setLight(e),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(e,n={}){if(!this._validate(s.r,e,n))for(const a in e){const u=e[a];a.endsWith("-transition")?this._transitionable.setTransition(a.slice(0,-11),u):this._transitionable.setValue(a,u)}}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(e,n,a){return(!a||a.validate!==!1)&&s.t(this,e.call(s.x,{value:n,style:{glyphs:!0,sprite:!0},styleSpec:s.v}))}}const gt=new s.q({"sky-color":new s.D(s.v.sky["sky-color"]),"horizon-color":new s.D(s.v.sky["horizon-color"]),"fog-color":new s.D(s.v.sky["fog-color"]),"fog-ground-blend":new s.D(s.v.sky["fog-ground-blend"]),"horizon-fog-blend":new s.D(s.v.sky["horizon-fog-blend"]),"sky-horizon-blend":new s.D(s.v.sky["sky-horizon-blend"]),"atmosphere-blend":new s.D(s.v.sky["atmosphere-blend"])});class vt extends s.E{constructor(e){super(),this._transitionable=new s.T(gt),this.setSky(e),this._transitioning=this._transitionable.untransitioned()}setSky(e,n={}){if(!this._validate(s.B,e,n))for(const a in e){const u=e[a];a.endsWith("-transition")?this._transitionable.setTransition(a.slice(0,-11),u):this._transitionable.setValue(a,u)}}getSky(){return this._transitionable.serialize()}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(e,n,a={}){return(a==null?void 0:a.validate)!==!1&&s.t(this,e.call(s.x,s.e({value:n,style:{glyphs:!0,sprite:!0},styleSpec:s.v})))}calculateFogBlendOpacity(e){return e<60?0:e<70?(e-60)/10:1}}class Vt{constructor(e,n){this.width=e,this.height=n,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(e,n){const a=e.join(",")+String(n);return this.dashEntry[a]||(this.dashEntry[a]=this.addDash(e,n)),this.dashEntry[a]}getDashRanges(e,n,a){const u=[];let _=e.length%2==1?-e[e.length-1]*a:0,I=e[0]*a,k=!0;u.push({left:_,right:I,isDash:k,zeroLength:e[0]===0});let z=e[0];for(let R=1;R<e.length;R++){k=!k;const V=e[R];_=z*a,z+=V,I=z*a,u.push({left:_,right:I,isDash:k,zeroLength:V===0})}return u}addRoundDash(e,n,a){const u=n/2;for(let _=-a;_<=a;_++){const I=this.width*(this.nextRow+a+_);let k=0,z=e[k];for(let R=0;R<this.width;R++){R/z.right>1&&(z=e[++k]);const V=Math.abs(R-z.left),G=Math.abs(R-z.right),Y=Math.min(V,G);let tt;const ot=_/a*(u+1);if(z.isDash){const mt=u-Math.abs(ot);tt=Math.sqrt(Y*Y+mt*mt)}else tt=u-Math.sqrt(Y*Y+ot*ot);this.data[I+R]=Math.max(0,Math.min(255,tt+128))}}}addRegularDash(e){for(let k=e.length-1;k>=0;--k){const z=e[k],R=e[k+1];z.zeroLength?e.splice(k,1):R&&R.isDash===z.isDash&&(R.left=z.left,e.splice(k,1))}const n=e[0],a=e[e.length-1];n.isDash===a.isDash&&(n.left=a.left-this.width,a.right=n.right+this.width);const u=this.width*this.nextRow;let _=0,I=e[_];for(let k=0;k<this.width;k++){k/I.right>1&&(I=e[++_]);const z=Math.abs(k-I.left),R=Math.abs(k-I.right),V=Math.min(z,R);this.data[u+k]=Math.max(0,Math.min(255,(I.isDash?V:-V)+128))}}addDash(e,n){const a=n?7:0,u=2*a+1;if(this.nextRow+u>this.height)return s.w("LineAtlas out of space"),null;let _=0;for(let k=0;k<e.length;k++)_+=e[k];if(_!==0){const k=this.width/_,z=this.getDashRanges(e,this.width,k);n?this.addRoundDash(z,k,a):this.addRegularDash(z)}const I={y:(this.nextRow+a+.5)/this.height,height:2*a/this.height,width:_};return this.nextRow+=u,this.dirty=!0,I}bind(e){const n=e.gl;this.texture?(n.bindTexture(n.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,n.texSubImage2D(n.TEXTURE_2D,0,0,0,this.width,this.height,n.ALPHA,n.UNSIGNED_BYTE,this.data))):(this.texture=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this.texture),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texImage2D(n.TEXTURE_2D,0,n.ALPHA,this.width,this.height,0,n.ALPHA,n.UNSIGNED_BYTE,this.data))}}const pt="maplibre_preloaded_worker_pool";class rt{constructor(){this.active={}}acquire(e){if(!this.workers)for(this.workers=[];this.workers.length<rt.workerCount;)this.workers.push(new Worker(s.a.WORKER_URL));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.numActive()===0&&(this.workers.forEach(n=>{n.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[pt]}numActive(){return Object.keys(this.active).length}}const Mt=Math.floor(l.hardwareConcurrency/2);let jt,te;function Wt(){return jt||(jt=new rt),jt}rt.workerCount=s.C(globalThis)?Math.max(Math.min(Mt,3),1):1;class Xt{constructor(e,n){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=n;const a=this.workerPool.acquire(n);for(let u=0;u<a.length;u++){const _=new s.F(a[u],n);_.name=`Worker ${u}`,this.actors.push(_)}if(!this.actors.length)throw new Error("No actors found")}broadcast(e,n){const a=[];for(const u of this.actors)a.push(u.sendAsync({type:e,data:n}));return Promise.all(a)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(e=!0){this.actors.forEach(n=>{n.remove()}),this.actors=[],e&&this.workerPool.release(this.id)}registerMessageHandler(e,n){for(const a of this.actors)a.registerMessageHandler(e,n)}}function ye(){return te||(te=new Xt(Wt(),s.G),te.registerMessageHandler("GR",(y,e,n)=>s.m(e,n))),te}function Te(y,e){const n=s.H();return s.J(n,n,[1,1,0]),s.K(n,n,[.5*y.width,.5*y.height,1]),s.L(n,n,y.calculatePosMatrix(e.toUnwrapped()))}function qt(y,e,n,a,u,_){const I=function(G,Y,tt){if(G)for(const ot of G){const mt=Y[ot];if(mt&&mt.source===tt&&mt.type==="fill-extrusion")return!0}else for(const ot in Y){const mt=Y[ot];if(mt.source===tt&&mt.type==="fill-extrusion")return!0}return!1}(u&&u.layers,e,y.id),k=_.maxPitchScaleFactor(),z=y.tilesIn(a,k,I);z.sort(Lt);const R=[];for(const G of z)R.push({wrappedTileID:G.tileID.wrapped().key,queryResults:G.tile.queryRenderedFeatures(e,n,y._state,G.queryGeometry,G.cameraQueryGeometry,G.scale,u,_,k,Te(y.transform,G.tileID))});const V=function(G){const Y={},tt={};for(const ot of G){const mt=ot.queryResults,ut=ot.wrappedTileID,bt=tt[ut]=tt[ut]||{};for(const Pt in mt){const ht=mt[Pt],Dt=bt[Pt]=bt[Pt]||{},Ut=Y[Pt]=Y[Pt]||[];for(const $t of ht)Dt[$t.featureIndex]||(Dt[$t.featureIndex]=!0,Ut.push($t))}}return Y}(R);for(const G in V)V[G].forEach(Y=>{const tt=Y.feature,ot=y.getFeatureState(tt.layer["source-layer"],tt.id);tt.source=tt.layer.source,tt.layer["source-layer"]&&(tt.sourceLayer=tt.layer["source-layer"]),tt.state=ot});return V}function Lt(y,e){const n=y.tileID,a=e.tileID;return n.overscaledZ-a.overscaledZ||n.canonical.y-a.canonical.y||n.wrap-a.wrap||n.canonical.x-a.canonical.x}function ae(y,e,n){return s._(this,void 0,void 0,function*(){let a=y;if(y.url?a=(yield s.h(e.transformRequest(y.url,"Source"),n)).data:yield l.frameAsync(n),!a)return null;const u=s.M(s.e(a,y),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in a&&a.vector_layers&&(u.vectorLayerIds=a.vector_layers.map(_=>_.id)),u})}class at{constructor(e,n){e&&(n?this.setSouthWest(e).setNorthEast(n):Array.isArray(e)&&(e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1])))}setNorthEast(e){return this._ne=e instanceof s.N?new s.N(e.lng,e.lat):s.N.convert(e),this}setSouthWest(e){return this._sw=e instanceof s.N?new s.N(e.lng,e.lat):s.N.convert(e),this}extend(e){const n=this._sw,a=this._ne;let u,_;if(e instanceof s.N)u=e,_=e;else{if(!(e instanceof at))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(at.convert(e)):this.extend(s.N.convert(e)):e&&("lng"in e||"lon"in e)&&"lat"in e?this.extend(s.N.convert(e)):this;if(u=e._sw,_=e._ne,!u||!_)return this}return n||a?(n.lng=Math.min(u.lng,n.lng),n.lat=Math.min(u.lat,n.lat),a.lng=Math.max(_.lng,a.lng),a.lat=Math.max(_.lat,a.lat)):(this._sw=new s.N(u.lng,u.lat),this._ne=new s.N(_.lng,_.lat)),this}getCenter(){return new s.N((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new s.N(this.getWest(),this.getNorth())}getSouthEast(){return new s.N(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:n,lat:a}=s.N.convert(e);let u=this._sw.lng<=n&&n<=this._ne.lng;return this._sw.lng>this._ne.lng&&(u=this._sw.lng>=n&&n>=this._ne.lng),this._sw.lat<=a&&a<=this._ne.lat&&u}static convert(e){return e instanceof at?e:e&&new at(e)}static fromLngLat(e,n=0){const a=360*n/40075017,u=a/Math.cos(Math.PI/180*e.lat);return new at(new s.N(e.lng-u,e.lat-a),new s.N(e.lng+u,e.lat+a))}}class Zt{constructor(e,n,a){this.bounds=at.convert(this.validateBounds(e)),this.minzoom=n||0,this.maxzoom=a||24}validateBounds(e){return Array.isArray(e)&&e.length===4?[Math.max(-180,e[0]),Math.max(-90,e[1]),Math.min(180,e[2]),Math.min(90,e[3])]:[-180,-90,180,90]}contains(e){const n=Math.pow(2,e.z),a=Math.floor(s.O(this.bounds.getWest())*n),u=Math.floor(s.Q(this.bounds.getNorth())*n),_=Math.ceil(s.O(this.bounds.getEast())*n),I=Math.ceil(s.Q(this.bounds.getSouth())*n);return e.x>=a&&e.x<_&&e.y>=u&&e.y<I}}class pe extends s.E{constructor(e,n,a,u){if(super(),this.id=e,this.dispatcher=a,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,s.e(this,s.M(n,["url","scheme","tileSize","promoteId"])),this._options=s.e({type:"vector"},n),this._collectResourceTiming=n.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(u)}load(){return s._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new s.k("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const e=yield ae(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),e&&(s.e(this,e),e.bounds&&(this.tileBounds=new Zt(e.bounds,this.minzoom,this.maxzoom)),this.fire(new s.k("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.k("data",{dataType:"source",sourceDataType:"content"})))}catch(e){this._tileJSONRequest=null,this.fire(new s.j(e))}})}loaded(){return this._loaded}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}onAdd(e){this.map=e,this.load()}setSourceProperty(e){this._tileJSONRequest&&this._tileJSONRequest.abort(),e(),this.load()}setTiles(e){return this.setSourceProperty(()=>{this._options.tiles=e}),this}setUrl(e){return this.setSourceProperty(()=>{this.url=e,this._options.url=e}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return s.e({},this._options)}loadTile(e){return s._(this,void 0,void 0,function*(){const n=e.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),a={request:this.map._requestManager.transformRequest(n,"Tile"),uid:e.uid,tileID:e.tileID,zoom:e.tileID.overscaledZ,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};a.request.collectResourceTiming=this._collectResourceTiming;let u="RT";if(e.actor&&e.state!=="expired"){if(e.state==="loading")return new Promise((_,I)=>{e.reloadPromise={resolve:_,reject:I}})}else e.actor=this.dispatcher.getActor(),u="LT";e.abortController=new AbortController;try{const _=yield e.actor.sendAsync({type:u,data:a},e.abortController);if(delete e.abortController,e.aborted)return;this._afterTileLoadWorkerResponse(e,_)}catch(_){if(delete e.abortController,e.aborted)return;if(_&&_.status!==404)throw _;this._afterTileLoadWorkerResponse(e,null)}})}_afterTileLoadWorkerResponse(e,n){if(n&&n.resourceTiming&&(e.resourceTiming=n.resourceTiming),n&&this.map._refreshExpiredTiles&&e.setExpiryData(n),e.loadVectorData(n,this.map.painter),e.reloadPromise){const a=e.reloadPromise;e.reloadPromise=null,this.loadTile(e).then(a.resolve).catch(a.reject)}}abortTile(e){return s._(this,void 0,void 0,function*(){e.abortController&&(e.abortController.abort(),delete e.abortController),e.actor&&(yield e.actor.sendAsync({type:"AT",data:{uid:e.uid,type:this.type,source:this.id}}))})}unloadTile(e){return s._(this,void 0,void 0,function*(){e.unloadVectorData(),e.actor&&(yield e.actor.sendAsync({type:"RMT",data:{uid:e.uid,type:this.type,source:this.id}}))})}hasTransition(){return!1}}class ue extends s.E{constructor(e,n,a,u){super(),this.id=e,this.dispatcher=a,this.setEventedParent(u),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=s.e({type:"raster"},n),s.e(this,s.M(n,["url","scheme","tileSize"]))}load(){return s._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new s.k("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const e=yield ae(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,e&&(s.e(this,e),e.bounds&&(this.tileBounds=new Zt(e.bounds,this.minzoom,this.maxzoom)),this.fire(new s.k("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.k("data",{dataType:"source",sourceDataType:"content"})))}catch(e){this._tileJSONRequest=null,this.fire(new s.j(e))}})}loaded(){return this._loaded}onAdd(e){this.map=e,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(e){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),e(),this.load()}setTiles(e){return this.setSourceProperty(()=>{this._options.tiles=e}),this}setUrl(e){return this.setSourceProperty(()=>{this.url=e,this._options.url=e}),this}serialize(){return s.e({},this._options)}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(e){return s._(this,void 0,void 0,function*(){const n=e.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);e.abortController=new AbortController;try{const a=yield O.getImage(this.map._requestManager.transformRequest(n,"Tile"),e.abortController,this.map._refreshExpiredTiles);if(delete e.abortController,e.aborted)return void(e.state="unloaded");if(a&&a.data){this.map._refreshExpiredTiles&&a.cacheControl&&a.expires&&e.setExpiryData({cacheControl:a.cacheControl,expires:a.expires});const u=this.map.painter.context,_=u.gl,I=a.data;e.texture=this.map.painter.getTileTexture(I.width),e.texture?e.texture.update(I,{useMipmap:!0}):(e.texture=new Jt(u,I,_.RGBA,{useMipmap:!0}),e.texture.bind(_.LINEAR,_.CLAMP_TO_EDGE,_.LINEAR_MIPMAP_NEAREST)),e.state="loaded"}}catch(a){if(delete e.abortController,e.aborted)e.state="unloaded";else if(a)throw e.state="errored",a}})}abortTile(e){return s._(this,void 0,void 0,function*(){e.abortController&&(e.abortController.abort(),delete e.abortController)})}unloadTile(e){return s._(this,void 0,void 0,function*(){e.texture&&this.map.painter.saveTileTexture(e.texture)})}hasTransition(){return!1}}class Fe extends ue{constructor(e,n,a,u){super(e,n,a,u),this.type="raster-dem",this.maxzoom=22,this._options=s.e({type:"raster-dem"},n),this.encoding=n.encoding||"mapbox",this.redFactor=n.redFactor,this.greenFactor=n.greenFactor,this.blueFactor=n.blueFactor,this.baseShift=n.baseShift}loadTile(e){return s._(this,void 0,void 0,function*(){const n=e.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),a=this.map._requestManager.transformRequest(n,"Tile");e.neighboringTiles=this._getNeighboringTiles(e.tileID),e.abortController=new AbortController;try{const u=yield O.getImage(a,e.abortController,this.map._refreshExpiredTiles);if(delete e.abortController,e.aborted)return void(e.state="unloaded");if(u&&u.data){const _=u.data;this.map._refreshExpiredTiles&&u.cacheControl&&u.expires&&e.setExpiryData({cacheControl:u.cacheControl,expires:u.expires});const I=s.b(_)&&s.U()?_:yield this.readImageNow(_),k={type:this.type,uid:e.uid,source:this.id,rawImageData:I,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!e.actor||e.state==="expired"){e.actor=this.dispatcher.getActor();const z=yield e.actor.sendAsync({type:"LDT",data:k});e.dem=z,e.needsHillshadePrepare=!0,e.needsTerrainPrepare=!0,e.state="loaded"}}}catch(u){if(delete e.abortController,e.aborted)e.state="unloaded";else if(u)throw e.state="errored",u}})}readImageNow(e){return s._(this,void 0,void 0,function*(){if(typeof VideoFrame<"u"&&s.V()){const n=e.width+2,a=e.height+2;try{return new s.R({width:n,height:a},yield s.W(e,-1,-1,n,a))}catch{}}return l.getImageData(e,1)})}_getNeighboringTiles(e){const n=e.canonical,a=Math.pow(2,n.z),u=(n.x-1+a)%a,_=n.x===0?e.wrap-1:e.wrap,I=(n.x+1+a)%a,k=n.x+1===a?e.wrap+1:e.wrap,z={};return z[new s.S(e.overscaledZ,_,n.z,u,n.y).key]={backfilled:!1},z[new s.S(e.overscaledZ,k,n.z,I,n.y).key]={backfilled:!1},n.y>0&&(z[new s.S(e.overscaledZ,_,n.z,u,n.y-1).key]={backfilled:!1},z[new s.S(e.overscaledZ,e.wrap,n.z,n.x,n.y-1).key]={backfilled:!1},z[new s.S(e.overscaledZ,k,n.z,I,n.y-1).key]={backfilled:!1}),n.y+1<a&&(z[new s.S(e.overscaledZ,_,n.z,u,n.y+1).key]={backfilled:!1},z[new s.S(e.overscaledZ,e.wrap,n.z,n.x,n.y+1).key]={backfilled:!1},z[new s.S(e.overscaledZ,k,n.z,I,n.y+1).key]={backfilled:!1}),z}unloadTile(e){return s._(this,void 0,void 0,function*(){e.demTexture&&this.map.painter.saveTileTexture(e.demTexture),e.fbo&&(e.fbo.destroy(),delete e.fbo),e.dem&&delete e.dem,delete e.neighboringTiles,e.state="unloaded",e.actor&&(yield e.actor.sendAsync({type:"RDT",data:{type:this.type,uid:e.uid,source:this.id}}))})}}class Ke extends s.E{constructor(e,n,a,u){super(),this.id=e,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=a.getActor(),this.setEventedParent(u),this._data=n.data,this._options=s.e({},n),this._collectResourceTiming=n.collectResourceTiming,n.maxzoom!==void 0&&(this.maxzoom=n.maxzoom),n.type&&(this.type=n.type),n.attribution&&(this.attribution=n.attribution),this.promoteId=n.promoteId;const _=s.X/this.tileSize;this.workerOptions=s.e({source:this.id,cluster:n.cluster||!1,geojsonVtOptions:{buffer:(n.buffer!==void 0?n.buffer:128)*_,tolerance:(n.tolerance!==void 0?n.tolerance:.375)*_,extent:s.X,maxZoom:this.maxzoom,lineMetrics:n.lineMetrics||!1,generateId:n.generateId||!1},superclusterOptions:{maxZoom:n.clusterMaxZoom!==void 0?n.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,n.clusterMinPoints||2),extent:s.X,radius:(n.clusterRadius||50)*_,log:!1,generateId:n.generateId||!1},clusterProperties:n.clusterProperties,filter:n.filter},n.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}load(){return s._(this,void 0,void 0,function*(){yield this._updateWorkerData()})}onAdd(e){this.map=e,this.load()}setData(e){return this._data=e,this._updateWorkerData(),this}updateData(e){return this._updateWorkerData(e),this}getData(){return s._(this,void 0,void 0,function*(){const e=s.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:e})})}setClusterOptions(e){return this.workerOptions.cluster=e.cluster,e&&(e.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=e.clusterRadius),e.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=e.clusterMaxZoom)),this._updateWorkerData(),this}getClusterExpansionZoom(e){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:e,source:this.id}})}getClusterChildren(e){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:e,source:this.id}})}getClusterLeaves(e,n,a){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:e,limit:n,offset:a}})}_updateWorkerData(e){return s._(this,void 0,void 0,function*(){const n=s.e({type:this.type},this.workerOptions);e?n.dataDiff=e:typeof this._data=="string"?(n.request=this.map._requestManager.transformRequest(l.resolveURL(this._data),"Source"),n.request.collectResourceTiming=this._collectResourceTiming):n.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new s.k("dataloading",{dataType:"source"}));try{const a=yield this.actor.sendAsync({type:"LD",data:n});if(this._pendingLoads--,this._removed||a.abandoned)return void this.fire(new s.k("dataabort",{dataType:"source"}));let u=null;a.resourceTiming&&a.resourceTiming[this.id]&&(u=a.resourceTiming[this.id].slice(0));const _={dataType:"source"};this._collectResourceTiming&&u&&u.length>0&&s.e(_,{resourceTiming:u}),this.fire(new s.k("data",Object.assign(Object.assign({},_),{sourceDataType:"metadata"}))),this.fire(new s.k("data",Object.assign(Object.assign({},_),{sourceDataType:"content"})))}catch(a){if(this._pendingLoads--,this._removed)return void this.fire(new s.k("dataabort",{dataType:"source"}));this.fire(new s.j(a))}})}loaded(){return this._pendingLoads===0}loadTile(e){return s._(this,void 0,void 0,function*(){const n=e.actor?"RT":"LT";e.actor=this.actor;const a={type:this.type,uid:e.uid,tileID:e.tileID,zoom:e.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};e.abortController=new AbortController;const u=yield this.actor.sendAsync({type:n,data:a},e.abortController);delete e.abortController,e.unloadVectorData(),e.aborted||e.loadVectorData(u,this.map.painter,n==="RT")})}abortTile(e){return s._(this,void 0,void 0,function*(){e.abortController&&(e.abortController.abort(),delete e.abortController),e.aborted=!0})}unloadTile(e){return s._(this,void 0,void 0,function*(){e.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:e.uid,type:this.type,source:this.id}})})}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return s.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}var oe=s.Y([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class ve extends s.E{constructor(e,n,a,u){super(),this.id=e,this.dispatcher=a,this.coordinates=n.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(u),this.options=n}load(e){return s._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new s.k("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const n=yield O.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,n&&n.data&&(this.image=n.data,e&&(this.coordinates=e),this._finishLoading())}catch(n){this._request=null,this._loaded=!0,this.fire(new s.j(n))}})}loaded(){return this._loaded}updateImage(e){return e.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=e.url,this.load(e.coordinates).finally(()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new s.k("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(e){this.coordinates=e;const n=e.map(s.Z.fromLngLat);this.tileID=function(u){let _=1/0,I=1/0,k=-1/0,z=-1/0;for(const Y of u)_=Math.min(_,Y.x),I=Math.min(I,Y.y),k=Math.max(k,Y.x),z=Math.max(z,Y.y);const R=Math.max(k-_,z-I),V=Math.max(0,Math.floor(-Math.log(R)/Math.LN2)),G=Math.pow(2,V);return new s.a1(V,Math.floor((_+k)/2*G),Math.floor((I+z)/2*G))}(n),this.minzoom=this.maxzoom=this.tileID.z;const a=n.map(u=>this.tileID.getTilePoint(u)._round());return this._boundsArray=new s.$,this._boundsArray.emplaceBack(a[0].x,a[0].y,0,0),this._boundsArray.emplaceBack(a[1].x,a[1].y,s.X,0),this._boundsArray.emplaceBack(a[3].x,a[3].y,0,s.X),this._boundsArray.emplaceBack(a[2].x,a[2].y,s.X,s.X),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this.fire(new s.k("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const e=this.map.painter.context,n=e.gl;this.boundsBuffer||(this.boundsBuffer=e.createVertexBuffer(this._boundsArray,oe.members)),this.boundsSegments||(this.boundsSegments=s.a0.simpleSegment(0,0,4,2)),this.texture||(this.texture=new Jt(e,this.image,n.RGBA),this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE));let a=!1;for(const u in this.tiles){const _=this.tiles[u];_.state!=="loaded"&&(_.state="loaded",_.texture=this.texture,a=!0)}a&&this.fire(new s.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(e){return s._(this,void 0,void 0,function*(){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={}):e.state="errored"})}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class He extends ve{constructor(e,n,a,u){super(e,n,a,u),this.roundZoom=!0,this.type="video",this.options=n}load(){return s._(this,void 0,void 0,function*(){this._loaded=!1;const e=this.options;this.urls=[];for(const n of e.urls)this.urls.push(this.map._requestManager.transformRequest(n,"Source").url);try{const n=yield s.a3(this.urls);if(this._loaded=!0,!n)return;this.video=n,this.video.loop=!0,this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading()}catch(n){this.fire(new s.j(n))}})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(e){if(this.video){const n=this.video.seekable;e<n.start(0)||e>n.end(0)?this.fire(new s.j(new s.a2(`sources.${this.id}`,null,`Playback for this video can be set only between the ${n.start(0)} and ${n.end(0)}-second mark.`))):this.video.currentTime=e}}getVideo(){return this.video}onAdd(e){this.map||(this.map=e,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const e=this.map.painter.context,n=e.gl;this.boundsBuffer||(this.boundsBuffer=e.createVertexBuffer(this._boundsArray,oe.members)),this.boundsSegments||(this.boundsSegments=s.a0.simpleSegment(0,0,4,2)),this.texture?this.video.paused||(this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE),n.texSubImage2D(n.TEXTURE_2D,0,0,0,n.RGBA,n.UNSIGNED_BYTE,this.video)):(this.texture=new Jt(e,this.video,n.RGBA),this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE));let a=!1;for(const u in this.tiles){const _=this.tiles[u];_.state!=="loaded"&&(_.state="loaded",_.texture=this.texture,a=!0)}a&&this.fire(new s.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class ci extends ve{constructor(e,n,a,u){super(e,n,a,u),n.coordinates?Array.isArray(n.coordinates)&&n.coordinates.length===4&&!n.coordinates.some(_=>!Array.isArray(_)||_.length!==2||_.some(I=>typeof I!="number"))||this.fire(new s.j(new s.a2(`sources.${e}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.j(new s.a2(`sources.${e}`,null,'missing required property "coordinates"'))),n.animate&&typeof n.animate!="boolean"&&this.fire(new s.j(new s.a2(`sources.${e}`,null,'optional "animate" property must be a boolean value'))),n.canvas?typeof n.canvas=="string"||n.canvas instanceof HTMLCanvasElement||this.fire(new s.j(new s.a2(`sources.${e}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.j(new s.a2(`sources.${e}`,null,'missing required property "canvas"'))),this.options=n,this.animate=n.animate===void 0||n.animate}load(){return s._(this,void 0,void 0,function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.j(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())})}getCanvas(){return this.canvas}onAdd(e){this.map=e,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let e=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,e=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,e=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const n=this.map.painter.context,a=n.gl;this.boundsBuffer||(this.boundsBuffer=n.createVertexBuffer(this._boundsArray,oe.members)),this.boundsSegments||(this.boundsSegments=s.a0.simpleSegment(0,0,4,2)),this.texture?(e||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new Jt(n,this.canvas,a.RGBA,{premultiply:!0});let u=!1;for(const _ in this.tiles){const I=this.tiles[_];I.state!=="loaded"&&(I.state="loaded",I.texture=this.texture,u=!0)}u&&this.fire(new s.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const e of[this.canvas.width,this.canvas.height])if(isNaN(e)||e<=0)return!0;return!1}}const wi={},vi=y=>{switch(y){case"geojson":return Ke;case"image":return ve;case"raster":return ue;case"raster-dem":return Fe;case"vector":return pe;case"video":return He;case"canvas":return ci}return wi[y]},ce="RTLPluginLoaded";class Ti extends s.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=ye()}_syncState(e){return this.status=e,this.dispatcher.broadcast("SRPS",{pluginStatus:e,pluginURL:this.url}).catch(n=>{throw this.status="error",n})}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(e){return s._(this,arguments,void 0,function*(n,a=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=l.resolveURL(n),!this.url)throw new Error(`requested url ${n} is invalid`);if(this.status==="unavailable"){if(!a)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()})}_requestImport(){return s._(this,void 0,void 0,function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new s.k(ce))})}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let zi=null;function nr(){return zi||(zi=new Ti),zi}class Yi{constructor(e,n){this.timeAdded=0,this.fadeEndTime=0,this.tileID=e,this.uid=s.a4(),this.uses=0,this.tileSize=n,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(e){const n=e+this.timeAdded;n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(e){this.demTexture&&e.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(e,n,a){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",e){e.featureIndex&&(this.latestFeatureIndex=e.featureIndex,e.rawTileData?(this.latestRawTileData=e.rawTileData,this.latestFeatureIndex.rawTileData=e.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=e.collisionBoxArray,this.buckets=function(u,_){const I={};if(!_)return I;for(const k of u){const z=k.layerIds.map(R=>_.getLayer(R)).filter(Boolean);if(z.length!==0){k.layers=z,k.stateDependentLayerIds&&(k.stateDependentLayers=k.stateDependentLayerIds.map(R=>z.filter(V=>V.id===R)[0]));for(const R of z)I[R.id]=k}}return I}(e.buckets,n.style),this.hasSymbolBuckets=!1;for(const u in this.buckets){const _=this.buckets[u];if(_ instanceof s.a6){if(this.hasSymbolBuckets=!0,!a)break;_.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const u in this.buckets){const _=this.buckets[u];if(_ instanceof s.a6&&_.hasRTLText){this.hasRTLText=!0,nr().lazyLoad();break}}this.queryPadding=0;for(const u in this.buckets){const _=this.buckets[u];this.queryPadding=Math.max(this.queryPadding,n.style.getLayer(u).queryRadius(_))}e.imageAtlas&&(this.imageAtlas=e.imageAtlas),e.glyphAtlasImage&&(this.glyphAtlasImage=e.glyphAtlasImage)}else this.collisionBoxArray=new s.a5}unloadVectorData(){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(e){return this.buckets[e.id]}upload(e){for(const a in this.buckets){const u=this.buckets[a];u.uploadPending()&&u.upload(e)}const n=e.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new Jt(e,this.imageAtlas.image,n.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new Jt(e,this.glyphAtlasImage,n.ALPHA),this.glyphAtlasImage=null)}prepare(e){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture)}queryRenderedFeatures(e,n,a,u,_,I,k,z,R,V){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:u,cameraQueryGeometry:_,scale:I,tileSize:this.tileSize,pixelPosMatrix:V,transform:z,params:k,queryPadding:this.queryPadding*R},e,n,a):{}}querySourceFeatures(e,n){const a=this.latestFeatureIndex;if(!a||!a.rawTileData)return;const u=a.loadVTLayers(),_=n&&n.sourceLayer?n.sourceLayer:"",I=u._geojsonTileLayer||u[_];if(!I)return;const k=s.a7(n&&n.filter),{z,x:R,y:V}=this.tileID.canonical,G={z,x:R,y:V};for(let Y=0;Y<I.length;Y++){const tt=I.feature(Y);if(k.needGeometry){const ut=s.a8(tt,!0);if(!k.filter(new s.a9(this.tileID.overscaledZ),ut,this.tileID.canonical))continue}else if(!k.filter(new s.a9(this.tileID.overscaledZ),tt))continue;const ot=a.getId(tt,_),mt=new s.aa(tt,z,R,V,ot);mt.tile=G,e.push(mt)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(e){const n=this.expirationTime;if(e.cacheControl){const a=s.ab(e.cacheControl);a["max-age"]&&(this.expirationTime=Date.now()+1e3*a["max-age"])}else e.expires&&(this.expirationTime=new Date(e.expires).getTime());if(this.expirationTime){const a=Date.now();let u=!1;if(this.expirationTime>a)u=!1;else if(n)if(this.expirationTime<n)u=!0;else{const _=this.expirationTime-n;_?this.expirationTime=a+Math.max(_,3e4):u=!0}else u=!0;u?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(e,n){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(e).length===0)return;const a=this.latestFeatureIndex.loadVTLayers();for(const u in this.buckets){if(!n.style.hasLayer(u))continue;const _=this.buckets[u],I=_.layers[0].sourceLayer||"_geojsonTileLayer",k=a[I],z=e[I];if(!k||!z||Object.keys(z).length===0)continue;_.update(z,k,this.imageAtlas&&this.imageAtlas.patternPositions||{});const R=n&&n.style&&n.style.getLayer(u);R&&(this.queryPadding=Math.max(this.queryPadding,R.queryRadius(_)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<l.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(e){this.symbolFadeHoldUntil=l.now()+e}setDependencies(e,n){const a={};for(const u of n)a[u]=!0;this.dependencies[e]=a}hasDependency(e,n){for(const a of e){const u=this.dependencies[a];if(u){for(const _ of n)if(u[_])return!0}}return!1}}class Ee{constructor(e,n){this.max=e,this.onRemove=n,this.reset()}reset(){for(const e in this.data)for(const n of this.data[e])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(e,n,a){const u=e.wrapped().key;this.data[u]===void 0&&(this.data[u]=[]);const _={value:n,timeout:void 0};if(a!==void 0&&(_.timeout=setTimeout(()=>{this.remove(e,_)},a)),this.data[u].push(_),this.order.push(u),this.order.length>this.max){const I=this._getAndRemoveByKey(this.order[0]);I&&this.onRemove(I)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){const n=this.data[e].shift();return n.timeout&&clearTimeout(n.timeout),this.data[e].length===0&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),n.value}getByKey(e){const n=this.data[e];return n?n[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,n){if(!this.has(e))return this;const a=e.wrapped().key,u=n===void 0?0:this.data[a].indexOf(n),_=this.data[a][u];return this.data[a].splice(u,1),_.timeout&&clearTimeout(_.timeout),this.data[a].length===0&&delete this.data[a],this.onRemove(_.value),this.order.splice(this.order.indexOf(a),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(e){const n=[];for(const a in this.data)for(const u of this.data[a])e(u.value)||n.push(u);for(const a of n)this.remove(a.value.tileID,a)}}class ui{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(e,n,a){const u=String(n);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][u]=this.stateChanges[e][u]||{},s.e(this.stateChanges[e][u],a),this.deletedStates[e]===null){this.deletedStates[e]={};for(const _ in this.state[e])_!==u&&(this.deletedStates[e][_]=null)}else if(this.deletedStates[e]&&this.deletedStates[e][u]===null){this.deletedStates[e][u]={};for(const _ in this.state[e][u])a[_]||(this.deletedStates[e][u][_]=null)}else for(const _ in a)this.deletedStates[e]&&this.deletedStates[e][u]&&this.deletedStates[e][u][_]===null&&delete this.deletedStates[e][u][_]}removeFeatureState(e,n,a){if(this.deletedStates[e]===null)return;const u=String(n);if(this.deletedStates[e]=this.deletedStates[e]||{},a&&n!==void 0)this.deletedStates[e][u]!==null&&(this.deletedStates[e][u]=this.deletedStates[e][u]||{},this.deletedStates[e][u][a]=null);else if(n!==void 0)if(this.stateChanges[e]&&this.stateChanges[e][u])for(a in this.deletedStates[e][u]={},this.stateChanges[e][u])this.deletedStates[e][u][a]=null;else this.deletedStates[e][u]=null;else this.deletedStates[e]=null}getState(e,n){const a=String(n),u=s.e({},(this.state[e]||{})[a],(this.stateChanges[e]||{})[a]);if(this.deletedStates[e]===null)return{};if(this.deletedStates[e]){const _=this.deletedStates[e][n];if(_===null)return{};for(const I in _)delete u[I]}return u}initializeTileState(e,n){e.setFeatureState(this.state,n)}coalesceChanges(e,n){const a={};for(const u in this.stateChanges){this.state[u]=this.state[u]||{};const _={};for(const I in this.stateChanges[u])this.state[u][I]||(this.state[u][I]={}),s.e(this.state[u][I],this.stateChanges[u][I]),_[I]=this.state[u][I];a[u]=_}for(const u in this.deletedStates){this.state[u]=this.state[u]||{};const _={};if(this.deletedStates[u]===null)for(const I in this.state[u])_[I]={},this.state[u][I]={};else for(const I in this.deletedStates[u]){if(this.deletedStates[u][I]===null)this.state[u][I]={};else for(const k of Object.keys(this.deletedStates[u][I]))delete this.state[u][I][k];_[I]=this.state[u][I]}a[u]=a[u]||{},s.e(a[u],_)}if(this.stateChanges={},this.deletedStates={},Object.keys(a).length!==0)for(const u in e)e[u].setFeatureState(a,n)}}class $e extends s.E{constructor(e,n,a){super(),this.id=e,this.dispatcher=a,this.on("data",u=>this._dataHandler(u)),this.on("dataloading",()=>{this._sourceErrored=!1}),this.on("error",()=>{this._sourceErrored=this._source.loaded()}),this._source=((u,_,I,k)=>{const z=new(vi(_.type))(u,_,I,k);if(z.id!==u)throw new Error(`Expected Source id to be ${u} instead of ${z.id}`);return z})(e,n,a,this),this._tiles={},this._cache=new Ee(0,u=>this._unloadTile(u)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new ui,this._didEmitContent=!1,this._updated=!1}onAdd(e){this.map=e,this._maxTileCacheSize=e?e._maxTileCacheSize:null,this._maxTileCacheZoomLevels=e?e._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(e)}onRemove(e){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(e)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const e in this._tiles){const n=this._tiles[e];if(n.state!=="loaded"&&n.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(e,n,a){return s._(this,void 0,void 0,function*(){try{yield this._source.loadTile(e),this._tileLoaded(e,n,a)}catch(u){e.state="errored",u.status!==404?this._source.fire(new s.j(u,{tile:e})):this.update(this.transform,this.terrain)}})}_unloadTile(e){this._source.unloadTile&&this._source.unloadTile(e)}_abortTile(e){this._source.abortTile&&this._source.abortTile(e),this._source.fire(new s.k("dataabort",{tile:e,coord:e.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(e){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const a=this._tiles[n];a.upload(e),a.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map(e=>e.tileID).sort(Zi).map(e=>e.key)}getRenderableIds(e){const n=[];for(const a in this._tiles)this._isIdRenderable(a,e)&&n.push(this._tiles[a]);return e?n.sort((a,u)=>{const _=a.tileID,I=u.tileID,k=new s.P(_.canonical.x,_.canonical.y)._rotate(this.transform.angle),z=new s.P(I.canonical.x,I.canonical.y)._rotate(this.transform.angle);return _.overscaledZ-I.overscaledZ||z.y-k.y||z.x-k.x}).map(a=>a.tileID.key):n.map(a=>a.tileID).sort(Zi).map(a=>a.key)}hasRenderableParent(e){const n=this.findLoadedParent(e,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(e,n){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(n||!this._tiles[e].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const e in this._tiles)this._tiles[e].state!=="errored"&&this._reloadTile(e,"reloading")}}_reloadTile(e,n){return s._(this,void 0,void 0,function*(){const a=this._tiles[e];a&&(a.state!=="loading"&&(a.state=n),yield this._loadTile(a,e,n))})}_tileLoaded(e,n,a){e.timeAdded=l.now(),a==="expired"&&(e.refreshedUponExpiration=!0),this._setTileReloadTimer(n,e),this.getSource().type==="raster-dem"&&e.dem&&this._backfillDEM(e),this._state.initializeTileState(e,this.map?this.map.painter:null),e.aborted||this._source.fire(new s.k("data",{dataType:"source",tile:e,coord:e.tileID}))}_backfillDEM(e){const n=this.getRenderableIds();for(let u=0;u<n.length;u++){const _=n[u];if(e.neighboringTiles&&e.neighboringTiles[_]){const I=this.getTileByID(_);a(e,I),a(I,e)}}function a(u,_){u.needsHillshadePrepare=!0,u.needsTerrainPrepare=!0;let I=_.tileID.canonical.x-u.tileID.canonical.x;const k=_.tileID.canonical.y-u.tileID.canonical.y,z=Math.pow(2,u.tileID.canonical.z),R=_.tileID.key;I===0&&k===0||Math.abs(k)>1||(Math.abs(I)>1&&(Math.abs(I+z)===1?I+=z:Math.abs(I-z)===1&&(I-=z)),_.dem&&u.dem&&(u.dem.backfillBorder(_.dem,I,k),u.neighboringTiles&&u.neighboringTiles[R]&&(u.neighboringTiles[R].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,n,a,u){for(const _ in this._tiles){let I=this._tiles[_];if(u[_]||!I.hasData()||I.tileID.overscaledZ<=n||I.tileID.overscaledZ>a)continue;let k=I.tileID;for(;I&&I.tileID.overscaledZ>n+1;){const R=I.tileID.scaledTo(I.tileID.overscaledZ-1);I=this._tiles[R.key],I&&I.hasData()&&(k=R)}let z=k;for(;z.overscaledZ>n;)if(z=z.scaledTo(z.overscaledZ-1),e[z.key]){u[k.key]=k;break}}}findLoadedParent(e,n){if(e.key in this._loadedParentTiles){const a=this._loadedParentTiles[e.key];return a&&a.tileID.overscaledZ>=n?a:null}for(let a=e.overscaledZ-1;a>=n;a--){const u=e.scaledTo(a),_=this._getLoadedTile(u);if(_)return _}}findLoadedSibling(e){return this._getLoadedTile(e)}_getLoadedTile(e){const n=this._tiles[e.key];return n&&n.hasData()?n:this._cache.getByKey(e.wrapped().key)}updateCacheSize(e){const n=Math.ceil(e.width/this._source.tileSize)+1,a=Math.ceil(e.height/this._source.tileSize)+1,u=Math.floor(n*a*(this._maxTileCacheZoomLevels===null?s.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),_=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,u):u;this._cache.setMaxSize(_)}handleWrapJump(e){const n=Math.round((e-(this._prevLng===void 0?e:this._prevLng))/360);if(this._prevLng=e,n){const a={};for(const u in this._tiles){const _=this._tiles[u];_.tileID=_.tileID.unwrapTo(_.tileID.wrap+n),a[_.tileID.key]=_}this._tiles=a;for(const u in this._timers)clearTimeout(this._timers[u]),delete this._timers[u];for(const u in this._tiles)this._setTileReloadTimer(u,this._tiles[u])}}_updateCoveredAndRetainedTiles(e,n,a,u,_,I){const k={},z={},R=Object.keys(e),V=l.now();for(const G of R){const Y=e[G],tt=this._tiles[G];if(!tt||tt.fadeEndTime!==0&&tt.fadeEndTime<=V)continue;const ot=this.findLoadedParent(Y,n),mt=this.findLoadedSibling(Y),ut=ot||mt||null;ut&&(this._addTile(ut.tileID),k[ut.tileID.key]=ut.tileID),z[G]=Y}this._retainLoadedChildren(z,u,a,e);for(const G in k)e[G]||(this._coveredTiles[G]=!0,e[G]=k[G]);if(I){const G={},Y={};for(const tt of _)this._tiles[tt.key].hasData()?G[tt.key]=tt:Y[tt.key]=tt;for(const tt in Y){const ot=Y[tt].children(this._source.maxzoom);this._tiles[ot[0].key]&&this._tiles[ot[1].key]&&this._tiles[ot[2].key]&&this._tiles[ot[3].key]&&(G[ot[0].key]=e[ot[0].key]=ot[0],G[ot[1].key]=e[ot[1].key]=ot[1],G[ot[2].key]=e[ot[2].key]=ot[2],G[ot[3].key]=e[ot[3].key]=ot[3],delete Y[tt])}for(const tt in Y){const ot=Y[tt],mt=this.findLoadedParent(ot,this._source.minzoom),ut=this.findLoadedSibling(ot),bt=mt||ut||null;if(bt){G[bt.tileID.key]=e[bt.tileID.key]=bt.tileID;for(const Pt in G)G[Pt].isChildOf(bt.tileID)&&delete G[Pt]}}for(const tt in this._tiles)G[tt]||(this._coveredTiles[tt]=!0)}}update(e,n){if(!this._sourceLoaded||this._paused)return;let a;this.transform=e,this.terrain=n,this.updateCacheSize(e),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?a=e.getVisibleUnwrappedCoordinates(this._source.tileID).map(V=>new s.S(V.canonical.z,V.wrap,V.canonical.z,V.canonical.x,V.canonical.y)):(a=e.coveringTiles({tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:n}),this._source.hasTile&&(a=a.filter(V=>this._source.hasTile(V)))):a=[];const u=e.coveringZoomLevel(this._source),_=Math.max(u-$e.maxOverzooming,this._source.minzoom),I=Math.max(u+$e.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const V={};for(const G of a)if(G.canonical.z>this._source.minzoom){const Y=G.scaledTo(G.canonical.z-1);V[Y.key]=Y;const tt=G.scaledTo(Math.max(this._source.minzoom,Math.min(G.canonical.z,5)));V[tt.key]=tt}a=a.concat(Object.values(V))}const k=a.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,k&&this.fire(new s.k("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const z=this._updateRetainedTiles(a,u);Tr(this._source.type)&&this._updateCoveredAndRetainedTiles(z,_,I,u,a,n);for(const V in z)this._tiles[V].clearFadeHold();const R=s.ac(this._tiles,z);for(const V of R){const G=this._tiles[V];G.hasSymbolBuckets&&!G.holdingForFade()?G.setHoldDuration(this.map._fadeDuration):G.hasSymbolBuckets&&!G.symbolFadeFinished()||this._removeTile(V)}this._updateLoadedParentTileCache(),this._updateLoadedSiblingTileCache()}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(e)}_updateRetainedTiles(e,n){var a;const u={},_={},I=Math.max(n-$e.maxOverzooming,this._source.minzoom),k=Math.max(n+$e.maxUnderzooming,this._source.minzoom),z={};for(const R of e){const V=this._addTile(R);u[R.key]=R,V.hasData()||n<this._source.maxzoom&&(z[R.key]=R)}this._retainLoadedChildren(z,n,k,u);for(const R of e){let V=this._tiles[R.key];if(V.hasData())continue;if(n+1>this._source.maxzoom){const Y=R.children(this._source.maxzoom)[0],tt=this.getTile(Y);if(tt&&tt.hasData()){u[Y.key]=Y;continue}}else{const Y=R.children(this._source.maxzoom);if(u[Y[0].key]&&u[Y[1].key]&&u[Y[2].key]&&u[Y[3].key])continue}let G=V.wasRequested();for(let Y=R.overscaledZ-1;Y>=I;--Y){const tt=R.scaledTo(Y);if(_[tt.key])break;if(_[tt.key]=!0,V=this.getTile(tt),!V&&G&&(V=this._addTile(tt)),V){const ot=V.hasData();if((ot||!(!((a=this.map)===null||a===void 0)&&a.cancelPendingTileRequestsWhileZooming)||G)&&(u[tt.key]=tt),G=V.wasRequested(),ot)break}}}return u}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const n=[];let a,u=this._tiles[e].tileID;for(;u.overscaledZ>0;){if(u.key in this._loadedParentTiles){a=this._loadedParentTiles[u.key];break}n.push(u.key);const _=u.scaledTo(u.overscaledZ-1);if(a=this._getLoadedTile(_),a)break;u=_}for(const _ of n)this._loadedParentTiles[_]=a}}_updateLoadedSiblingTileCache(){this._loadedSiblingTiles={};for(const e in this._tiles){const n=this._tiles[e].tileID,a=this._getLoadedTile(n);this._loadedSiblingTiles[n.key]=a}}_addTile(e){let n=this._tiles[e.key];if(n)return n;n=this._cache.getAndRemove(e),n&&(this._setTileReloadTimer(e.key,n),n.tileID=e,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[e.key]&&(clearTimeout(this._cacheTimers[e.key]),delete this._cacheTimers[e.key],this._setTileReloadTimer(e.key,n)));const a=n;return n||(n=new Yi(e,this._source.tileSize*e.overscaleFactor()),this._loadTile(n,e.key,n.state)),n.uses++,this._tiles[e.key]=n,a||this._source.fire(new s.k("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n}_setTileReloadTimer(e,n){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const a=n.getExpiryTimeout();a&&(this._timers[e]=setTimeout(()=>{this._reloadTile(e,"expired"),delete this._timers[e]},a))}_removeTile(e){const n=this._tiles[e];n&&(n.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),n.uses>0||(n.hasData()&&n.state!=="reloading"?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}_dataHandler(e){const n=e.sourceDataType;e.dataType==="source"&&n==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&e.dataType==="source"&&n==="content"&&(this.reload(),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(e);this._cache.reset()}tilesIn(e,n,a){const u=[],_=this.transform;if(!_)return u;const I=a?_.getCameraQueryGeometry(e):e,k=e.map(ot=>_.pointCoordinate(ot,this.terrain)),z=I.map(ot=>_.pointCoordinate(ot,this.terrain)),R=this.getIds();let V=1/0,G=1/0,Y=-1/0,tt=-1/0;for(const ot of z)V=Math.min(V,ot.x),G=Math.min(G,ot.y),Y=Math.max(Y,ot.x),tt=Math.max(tt,ot.y);for(let ot=0;ot<R.length;ot++){const mt=this._tiles[R[ot]];if(mt.holdingForFade())continue;const ut=mt.tileID,bt=Math.pow(2,_.zoom-mt.tileID.overscaledZ),Pt=n*mt.queryPadding*s.X/mt.tileSize/bt,ht=[ut.getTilePoint(new s.Z(V,G)),ut.getTilePoint(new s.Z(Y,tt))];if(ht[0].x-Pt<s.X&&ht[0].y-Pt<s.X&&ht[1].x+Pt>=0&&ht[1].y+Pt>=0){const Dt=k.map($t=>ut.getTilePoint($t)),Ut=z.map($t=>ut.getTilePoint($t));u.push({tile:mt,tileID:ut,queryGeometry:Dt,cameraQueryGeometry:Ut,scale:bt})}}return u}getVisibleCoordinates(e){const n=this.getRenderableIds(e).map(a=>this._tiles[a].tileID);for(const a of n)a.posMatrix=this.transform.calculatePosMatrix(a.toUnwrapped());return n}hasTransition(){if(this._source.hasTransition())return!0;if(Tr(this._source.type)){const e=l.now();for(const n in this._tiles)if(this._tiles[n].fadeEndTime>=e)return!0}return!1}setFeatureState(e,n,a){this._state.updateState(e=e||"_geojsonTileLayer",n,a)}removeFeatureState(e,n,a){this._state.removeFeatureState(e=e||"_geojsonTileLayer",n,a)}getFeatureState(e,n){return this._state.getState(e=e||"_geojsonTileLayer",n)}setDependencies(e,n,a){const u=this._tiles[e];u&&u.setDependencies(n,a)}reloadTilesForDependencies(e,n){for(const a in this._tiles)this._tiles[a].hasDependency(e,n)&&this._reloadTile(a,"reloading");this._cache.filter(a=>!a.hasDependency(e,n))}}function Zi(y,e){const n=Math.abs(2*y.wrap)-+(y.wrap<0),a=Math.abs(2*e.wrap)-+(e.wrap<0);return y.overscaledZ-e.overscaledZ||a-n||e.canonical.y-y.canonical.y||e.canonical.x-y.canonical.x}function Tr(y){return y==="raster"||y==="image"||y==="video"}$e.maxOverzooming=10,$e.maxUnderzooming=3;class ii{constructor(e,n){this.reset(e,n)}reset(e,n){this.points=e||[],this._distances=[0];for(let a=1;a<this.points.length;a++)this._distances[a]=this._distances[a-1]+this.points[a].dist(this.points[a-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(n||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(e){if(this.points.length===1)return this.points[0];e=s.ad(e,0,1);let n=1,a=this._distances[n];const u=e*this.paddedLength+this.padding;for(;a<u&&n<this._distances.length;)a=this._distances[++n];const _=n-1,I=this._distances[_],k=a-I,z=k>0?(u-I)/k:0;return this.points[_].mult(1-z).add(this.points[n].mult(z))}}function Oi(y,e){let n=!0;return y==="always"||y!=="never"&&e!=="never"||(n=!1),n}class Wi{constructor(e,n,a){const u=this.boxCells=[],_=this.circleCells=[];this.xCellCount=Math.ceil(e/a),this.yCellCount=Math.ceil(n/a);for(let I=0;I<this.xCellCount*this.yCellCount;I++)u.push([]),_.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=e,this.height=n,this.xScale=this.xCellCount/e,this.yScale=this.yCellCount/n,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(e,n,a,u,_){this._forEachCell(n,a,u,_,this._insertBoxCell,this.boxUid++),this.boxKeys.push(e),this.bboxes.push(n),this.bboxes.push(a),this.bboxes.push(u),this.bboxes.push(_)}insertCircle(e,n,a,u){this._forEachCell(n-u,a-u,n+u,a+u,this._insertCircleCell,this.circleUid++),this.circleKeys.push(e),this.circles.push(n),this.circles.push(a),this.circles.push(u)}_insertBoxCell(e,n,a,u,_,I){this.boxCells[_].push(I)}_insertCircleCell(e,n,a,u,_,I){this.circleCells[_].push(I)}_query(e,n,a,u,_,I,k){if(a<0||e>this.width||u<0||n>this.height)return[];const z=[];if(e<=0&&n<=0&&this.width<=a&&this.height<=u){if(_)return[{key:null,x1:e,y1:n,x2:a,y2:u}];for(let R=0;R<this.boxKeys.length;R++)z.push({key:this.boxKeys[R],x1:this.bboxes[4*R],y1:this.bboxes[4*R+1],x2:this.bboxes[4*R+2],y2:this.bboxes[4*R+3]});for(let R=0;R<this.circleKeys.length;R++){const V=this.circles[3*R],G=this.circles[3*R+1],Y=this.circles[3*R+2];z.push({key:this.circleKeys[R],x1:V-Y,y1:G-Y,x2:V+Y,y2:G+Y})}}else this._forEachCell(e,n,a,u,this._queryCell,z,{hitTest:_,overlapMode:I,seenUids:{box:{},circle:{}}},k);return z}query(e,n,a,u){return this._query(e,n,a,u,!1,null)}hitTest(e,n,a,u,_,I){return this._query(e,n,a,u,!0,_,I).length>0}hitTestCircle(e,n,a,u,_){const I=e-a,k=e+a,z=n-a,R=n+a;if(k<0||I>this.width||R<0||z>this.height)return!1;const V=[];return this._forEachCell(I,z,k,R,this._queryCellCircle,V,{hitTest:!0,overlapMode:u,circle:{x:e,y:n,radius:a},seenUids:{box:{},circle:{}}},_),V.length>0}_queryCell(e,n,a,u,_,I,k,z){const{seenUids:R,hitTest:V,overlapMode:G}=k,Y=this.boxCells[_];if(Y!==null){const ot=this.bboxes;for(const mt of Y)if(!R.box[mt]){R.box[mt]=!0;const ut=4*mt,bt=this.boxKeys[mt];if(e<=ot[ut+2]&&n<=ot[ut+3]&&a>=ot[ut+0]&&u>=ot[ut+1]&&(!z||z(bt))&&(!V||!Oi(G,bt.overlapMode))&&(I.push({key:bt,x1:ot[ut],y1:ot[ut+1],x2:ot[ut+2],y2:ot[ut+3]}),V))return!0}}const tt=this.circleCells[_];if(tt!==null){const ot=this.circles;for(const mt of tt)if(!R.circle[mt]){R.circle[mt]=!0;const ut=3*mt,bt=this.circleKeys[mt];if(this._circleAndRectCollide(ot[ut],ot[ut+1],ot[ut+2],e,n,a,u)&&(!z||z(bt))&&(!V||!Oi(G,bt.overlapMode))){const Pt=ot[ut],ht=ot[ut+1],Dt=ot[ut+2];if(I.push({key:bt,x1:Pt-Dt,y1:ht-Dt,x2:Pt+Dt,y2:ht+Dt}),V)return!0}}}return!1}_queryCellCircle(e,n,a,u,_,I,k,z){const{circle:R,seenUids:V,overlapMode:G}=k,Y=this.boxCells[_];if(Y!==null){const ot=this.bboxes;for(const mt of Y)if(!V.box[mt]){V.box[mt]=!0;const ut=4*mt,bt=this.boxKeys[mt];if(this._circleAndRectCollide(R.x,R.y,R.radius,ot[ut+0],ot[ut+1],ot[ut+2],ot[ut+3])&&(!z||z(bt))&&!Oi(G,bt.overlapMode))return I.push(!0),!0}}const tt=this.circleCells[_];if(tt!==null){const ot=this.circles;for(const mt of tt)if(!V.circle[mt]){V.circle[mt]=!0;const ut=3*mt,bt=this.circleKeys[mt];if(this._circlesCollide(ot[ut],ot[ut+1],ot[ut+2],R.x,R.y,R.radius)&&(!z||z(bt))&&!Oi(G,bt.overlapMode))return I.push(!0),!0}}}_forEachCell(e,n,a,u,_,I,k,z){const R=this._convertToXCellCoord(e),V=this._convertToYCellCoord(n),G=this._convertToXCellCoord(a),Y=this._convertToYCellCoord(u);for(let tt=R;tt<=G;tt++)for(let ot=V;ot<=Y;ot++)if(_.call(this,e,n,a,u,this.xCellCount*ot+tt,I,k,z))return}_convertToXCellCoord(e){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(e*this.xScale)))}_convertToYCellCoord(e){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(e*this.yScale)))}_circlesCollide(e,n,a,u,_,I){const k=u-e,z=_-n,R=a+I;return R*R>k*k+z*z}_circleAndRectCollide(e,n,a,u,_,I,k){const z=(I-u)/2,R=Math.abs(e-(u+z));if(R>z+a)return!1;const V=(k-_)/2,G=Math.abs(n-(_+V));if(G>V+a)return!1;if(R<=z||G<=V)return!0;const Y=R-z,tt=G-V;return Y*Y+tt*tt<=a*a}}function Rr(y,e,n,a,u){const _=s.H();return e?(s.K(_,_,[1/u,1/u,1]),n||s.ae(_,_,a.angle)):s.L(_,a.labelPlaneMatrix,y),_}function cr(y,e,n,a,u){if(e){const _=s.af(y);return s.K(_,_,[u,u,1]),n||s.ae(_,_,-a.angle),_}return a.glCoordMatrix}function _t(y,e,n){let a;n?(a=[y.x,y.y,n(y.x,y.y),1],s.ag(a,a,e)):(a=[y.x,y.y,0,1],function(_,I,k){const z=I[0],R=I[1];_[0]=k[0]*z+k[4]*R+k[12],_[1]=k[1]*z+k[5]*R+k[13],_[3]=k[3]*z+k[7]*R+k[15]}(a,a,e));const u=a[3];return{point:new s.P(a[0]/u,a[1]/u),signedDistanceFromCamera:u,isOccluded:!1}}function W(y,e){return .5+y/e*.5}function H(y,e){return y.x>=-e[0]&&y.x<=e[0]&&y.y>=-e[1]&&y.y<=e[1]}function et(y,e,n,a,u,_,I,k,z,R,V,G,Y,tt,ot){const mt=a?y.textSizeData:y.iconSizeData,ut=s.ah(mt,n.transform.zoom),bt=[256/n.width*2+1,256/n.height*2+1],Pt=a?y.text.dynamicLayoutVertexArray:y.icon.dynamicLayoutVertexArray;Pt.clear();const ht=y.lineVertexArray,Dt=a?y.text.placedSymbolArray:y.icon.placedSymbolArray,Ut=n.transform.width/n.transform.height;let $t=!1;for(let _e=0;_e<Dt.length;_e++){const Ce=Dt.get(_e);if(Ce.hidden||Ce.writingMode===s.ai.vertical&&!$t){ei(Ce.numGlyphs,Pt);continue}$t=!1;const Xe=_t(new s.P(Ce.anchorX,Ce.anchorY),e,ot);if(!H(Xe.point,bt)){ei(Ce.numGlyphs,Pt);continue}const qe=W(n.transform.cameraToCenterDistance,Xe.signedDistanceFromCamera),Se=s.aj(mt,ut,Ce),ke=I?Se/qe:Se*qe,ti={getElevation:ot,labelPlaneMatrix:u,lineVertexArray:ht,pitchWithMap:I,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},projection:R,tileAnchorPoint:new s.P(Ce.anchorX,Ce.anchorY),unwrappedTileID:V,width:G,height:Y,translation:tt},Ci=Ot(ti,Ce,ke,!1,k,e,_,y.glyphOffsetArray,Pt,Ut,z);$t=Ci.useVertical,(Ci.notEnoughRoom||$t||Ci.needsFlipping&&Ot(ti,Ce,ke,!0,k,e,_,y.glyphOffsetArray,Pt,Ut,z).notEnoughRoom)&&ei(Ce.numGlyphs,Pt)}a?y.text.dynamicLayoutVertexBuffer.updateData(Pt):y.icon.dynamicLayoutVertexBuffer.updateData(Pt)}function ct(y,e,n,a,u,_,I,k){const z=_.glyphStartIndex+_.numGlyphs,R=_.lineStartIndex,V=_.lineStartIndex+_.lineLength,G=e.getoffsetX(_.glyphStartIndex),Y=e.getoffsetX(z-1),tt=Pe(y*G,n,a,u,_.segment,R,V,k,I);if(!tt)return null;const ot=Pe(y*Y,n,a,u,_.segment,R,V,k,I);return ot?k.projectionCache.anyProjectionOccluded?null:{first:tt,last:ot}:null}function Et(y,e,n,a){return y===s.ai.horizontal&&Math.abs(n.y-e.y)>Math.abs(n.x-e.x)*a?{useVertical:!0}:(y===s.ai.vertical?e.y<n.y:e.x>n.x)?{needsFlipping:!0}:null}function Ot(y,e,n,a,u,_,I,k,z,R,V){const G=n/24,Y=e.lineOffsetX*G,tt=e.lineOffsetY*G;let ot;if(e.numGlyphs>1){const mt=e.glyphStartIndex+e.numGlyphs,ut=e.lineStartIndex,bt=e.lineStartIndex+e.lineLength,Pt=ct(G,k,Y,tt,a,e,V,y);if(!Pt)return{notEnoughRoom:!0};const ht=_t(Pt.first.point,I,y.getElevation).point,Dt=_t(Pt.last.point,I,y.getElevation).point;if(u&&!a){const Ut=Et(e.writingMode,ht,Dt,R);if(Ut)return Ut}ot=[Pt.first];for(let Ut=e.glyphStartIndex+1;Ut<mt-1;Ut++)ot.push(Pe(G*k.getoffsetX(Ut),Y,tt,a,e.segment,ut,bt,y,V));ot.push(Pt.last)}else{if(u&&!a){const ut=_t(y.tileAnchorPoint,_,y.getElevation).point,bt=e.lineStartIndex+e.segment+1,Pt=new s.P(y.lineVertexArray.getx(bt),y.lineVertexArray.gety(bt)),ht=_t(Pt,_,y.getElevation),Dt=ht.signedDistanceFromCamera>0?ht.point:function($t,_e,Ce,Xe,qe,Se){return zt($t,_e,Ce,1,qe,Se)}(y.tileAnchorPoint,Pt,ut,0,_,y),Ut=Et(e.writingMode,ut,Dt,R);if(Ut)return Ut}const mt=Pe(G*k.getoffsetX(e.glyphStartIndex),Y,tt,a,e.segment,e.lineStartIndex,e.lineStartIndex+e.lineLength,y,V);if(!mt||y.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};ot=[mt]}for(const mt of ot)s.ak(z,mt.point,mt.angle);return{}}function zt(y,e,n,a,u,_){const I=y.add(y.sub(e)._unit()),k=u!==void 0?_t(I,u,_.getElevation).point:ee(I.x,I.y,_).point,z=n.sub(k);return n.add(z._mult(a/z.mag()))}function St(y,e,n){const a=e.projectionCache;if(a.projections[y])return a.projections[y];const u=new s.P(e.lineVertexArray.getx(y),e.lineVertexArray.gety(y)),_=ee(u.x,u.y,e);if(_.signedDistanceFromCamera>0)return a.projections[y]=_.point,a.anyProjectionOccluded=a.anyProjectionOccluded||_.isOccluded,_.point;const I=y-n.direction;return function(k,z,R,V,G){return zt(k,z,R,V,void 0,G)}(n.distanceFromAnchor===0?e.tileAnchorPoint:new s.P(e.lineVertexArray.getx(I),e.lineVertexArray.gety(I)),u,n.previousVertex,n.absOffsetX-n.distanceFromAnchor+1,e)}function ee(y,e,n){const a=y+n.translation[0],u=e+n.translation[1];let _;return!n.pitchWithMap&&n.projection.useSpecialProjectionForSymbols?(_=n.projection.projectTileCoordinates(a,u,n.unwrappedTileID,n.getElevation),_.point.x=(.5*_.point.x+.5)*n.width,_.point.y=(.5*-_.point.y+.5)*n.height):(_=_t(new s.P(a,u),n.labelPlaneMatrix,n.getElevation),_.isOccluded=!1),_}function le(y,e,n){return y._unit()._perp()._mult(e*n)}function Yt(y,e,n,a,u,_,I,k,z){if(k.projectionCache.offsets[y])return k.projectionCache.offsets[y];const R=n.add(e);if(y+z.direction<a||y+z.direction>=u)return k.projectionCache.offsets[y]=R,R;const V=St(y+z.direction,k,z),G=le(V.sub(n),I,z.direction),Y=n.add(G),tt=V.add(G);return k.projectionCache.offsets[y]=s.al(_,R,Y,tt)||R,k.projectionCache.offsets[y]}function Pe(y,e,n,a,u,_,I,k,z){const R=a?y-e:y+e;let V=R>0?1:-1,G=0;a&&(V*=-1,G=Math.PI),V<0&&(G+=Math.PI);let Y,tt=V>0?_+u:_+u+1;k.projectionCache.cachedAnchorPoint?Y=k.projectionCache.cachedAnchorPoint:(Y=ee(k.tileAnchorPoint.x,k.tileAnchorPoint.y,k).point,k.projectionCache.cachedAnchorPoint=Y);let ot,mt,ut=Y,bt=Y,Pt=0,ht=0;const Dt=Math.abs(R),Ut=[];let $t;for(;Pt+ht<=Dt;){if(tt+=V,tt<_||tt>=I)return null;Pt+=ht,bt=ut,mt=ot;const Xe={absOffsetX:Dt,direction:V,distanceFromAnchor:Pt,previousVertex:bt};if(ut=St(tt,k,Xe),n===0)Ut.push(bt),$t=ut.sub(bt);else{let qe;const Se=ut.sub(bt);qe=Se.mag()===0?le(St(tt+V,k,Xe).sub(ut),n,V):le(Se,n,V),mt||(mt=bt.add(qe)),ot=Yt(tt,qe,ut,_,I,mt,n,k,Xe),Ut.push(mt),$t=ot.sub(mt)}ht=$t.mag()}const _e=$t._mult((Dt-Pt)/ht)._add(mt||bt),Ce=G+Math.atan2(ut.y-bt.y,ut.x-bt.x);return Ut.push(_e),{point:_e,angle:z?Ce:0,path:Ut}}const Qe=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function ei(y,e){for(let n=0;n<y;n++){const a=e.length;e.resize(a+4),e.float32.set(Qe,3*a)}}const _i=100;class Ei{constructor(e,n,a=new Wi(e.width+200,e.height+200,25),u=new Wi(e.width+200,e.height+200,25)){this.transform=e,this.mapProjection=n,this.grid=a,this.ignoredGrid=u,this.pitchFactor=Math.cos(e._pitch)*e.cameraToCenterDistance,this.screenRightBoundary=e.width+_i,this.screenBottomBoundary=e.height+_i,this.gridRightBoundary=e.width+200,this.gridBottomBoundary=e.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(e,n,a,u,_,I,k,z,R,V,G){const Y=e.anchorPointX+z[0],tt=e.anchorPointY+z[1],ot=this.projectAndGetPerspectiveRatio(u,Y,tt,_,V),mt=this._projectCollisionBox(e,a,u,_,I,k,z,ot,V,G),[ut,bt,Pt,ht]=mt.box;return this.mapProjection.useSpecialProjectionForSymbols&&(I?mt.allPointsOccluded:this.mapProjection.isOccluded(Y,tt,_))||ot.perspectiveRatio<this.perspectiveRatioCutoff||!this.isInsideGrid(ut,bt,Pt,ht)||n!=="always"&&this.grid.hitTest(ut,bt,Pt,ht,n,R)?{box:[ut,bt,Pt,ht],placeable:!1,offscreen:!1}:{box:[ut,bt,Pt,ht],placeable:!0,offscreen:this.isOffscreen(ut,bt,Pt,ht)}}placeCollisionCircles(e,n,a,u,_,I,k,z,R,V,G,Y,tt,ot,mt,ut){const bt=[],Pt=new s.P(n.anchorX,n.anchorY),ht=this.getPerspectiveRatio(I,Pt.x,Pt.y,k,ut),Dt=(G?_/ht:_*ht)/s.aq,Ut={getElevation:ut,labelPlaneMatrix:z,lineVertexArray:a,pitchWithMap:G,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},projection:this.mapProjection,tileAnchorPoint:Pt,unwrappedTileID:k,width:this.transform.width,height:this.transform.height,translation:mt},$t=ct(Dt,u,n.lineOffsetX*Dt,n.lineOffsetY*Dt,!1,n,!1,Ut);let _e=!1,Ce=!1,Xe=!0;if($t){const qe=.5*tt*ht+ot,Se=new s.P(-100,-100),ke=new s.P(this.screenRightBoundary,this.screenBottomBoundary),ti=new ii,Ci=$t.first,ze=$t.last;let Ve=[];for(let Ii=Ci.path.length-1;Ii>=1;Ii--)Ve.push(Ci.path[Ii]);for(let Ii=1;Ii<ze.path.length;Ii++)Ve.push(ze.path[Ii]);const yi=2.5*qe;if(R){const Ii=this.projectPathToScreenSpace(Ve,Ut,R);Ve=Ii.some(Di=>Di.signedDistanceFromCamera<=0)?[]:Ii.map(Di=>Di.point)}let gr=[];if(Ve.length>0){const Ii=Ve[0].clone(),Di=Ve[0].clone();for(let _r=1;_r<Ve.length;_r++)Ii.x=Math.min(Ii.x,Ve[_r].x),Ii.y=Math.min(Ii.y,Ve[_r].y),Di.x=Math.max(Di.x,Ve[_r].x),Di.y=Math.max(Di.y,Ve[_r].y);gr=Ii.x>=Se.x&&Di.x<=ke.x&&Ii.y>=Se.y&&Di.y<=ke.y?[Ve]:Di.x<Se.x||Ii.x>ke.x||Di.y<Se.y||Ii.y>ke.y?[]:s.am([Ve],Se.x,Se.y,ke.x,ke.y)}for(const Ii of gr){ti.reset(Ii,.25*qe);let Di=0;Di=ti.length<=.5*qe?1:Math.ceil(ti.paddedLength/yi)+1;for(let _r=0;_r<Di;_r++){const rn=_r/Math.max(Di-1,1),ts=ti.lerp(rn),yr=ts.x+_i,Cn=ts.y+_i;bt.push(yr,Cn,qe,0);const _n=yr-qe,nn=Cn-qe,sn=yr+qe,es=Cn+qe;if(Xe=Xe&&this.isOffscreen(_n,nn,sn,es),Ce=Ce||this.isInsideGrid(_n,nn,sn,es),e!=="always"&&this.grid.hitTestCircle(yr,Cn,qe,e,Y)&&(_e=!0,!V))return{circles:[],offscreen:!1,collisionDetected:_e}}}}return{circles:!V&&_e||!Ce||ht<this.perspectiveRatioCutoff?[]:bt,offscreen:Xe,collisionDetected:_e}}projectPathToScreenSpace(e,n,a){return e.map(u=>_t(u,a,n.getElevation))}queryRenderedSymbols(e){if(e.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const n=[];let a=1/0,u=1/0,_=-1/0,I=-1/0;for(const V of e){const G=new s.P(V.x+_i,V.y+_i);a=Math.min(a,G.x),u=Math.min(u,G.y),_=Math.max(_,G.x),I=Math.max(I,G.y),n.push(G)}const k=this.grid.query(a,u,_,I).concat(this.ignoredGrid.query(a,u,_,I)),z={},R={};for(const V of k){const G=V.key;if(z[G.bucketInstanceId]===void 0&&(z[G.bucketInstanceId]={}),z[G.bucketInstanceId][G.featureIndex])continue;const Y=[new s.P(V.x1,V.y1),new s.P(V.x2,V.y1),new s.P(V.x2,V.y2),new s.P(V.x1,V.y2)];s.an(n,Y)&&(z[G.bucketInstanceId][G.featureIndex]=!0,R[G.bucketInstanceId]===void 0&&(R[G.bucketInstanceId]=[]),R[G.bucketInstanceId].push(G.featureIndex))}return R}insertCollisionBox(e,n,a,u,_,I){(a?this.ignoredGrid:this.grid).insert({bucketInstanceId:u,featureIndex:_,collisionGroupID:I,overlapMode:n},e[0],e[1],e[2],e[3])}insertCollisionCircles(e,n,a,u,_,I){const k=a?this.ignoredGrid:this.grid,z={bucketInstanceId:u,featureIndex:_,collisionGroupID:I,overlapMode:n};for(let R=0;R<e.length;R+=4)k.insertCircle(z,e[R],e[R+1],e[R+2])}projectAndGetPerspectiveRatio(e,n,a,u,_){const I=this.mapProjection.useSpecialProjectionForSymbols?this.mapProjection.projectTileCoordinates(n,a,u,_):_t(new s.P(n,a),e,_);return{point:new s.P((I.point.x+1)/2*this.transform.width+_i,(1-I.point.y)/2*this.transform.height+_i),perspectiveRatio:.5+this.transform.cameraToCenterDistance/I.signedDistanceFromCamera*.5,isOccluded:I.isOccluded,signedDistanceFromCamera:I.signedDistanceFromCamera}}getPerspectiveRatio(e,n,a,u,_){const I=this.mapProjection.useSpecialProjectionForSymbols?this.mapProjection.projectTileCoordinates(n,a,u,_):_t(new s.P(n,a),e,_);return .5+this.transform.cameraToCenterDistance/I.signedDistanceFromCamera*.5}isOffscreen(e,n,a,u){return a<_i||e>=this.screenRightBoundary||u<_i||n>this.screenBottomBoundary}isInsideGrid(e,n,a,u){return a>=0&&e<this.gridRightBoundary&&u>=0&&n<this.gridBottomBoundary}getViewportMatrix(){const e=s.ao([]);return s.J(e,e,[-100,-100,0]),e}_projectCollisionBox(e,n,a,u,_,I,k,z,R,V){const G=n*z.perspectiveRatio;let Y=new s.P(1,0),tt=new s.P(0,1);const ot=new s.P(e.anchorPointX+k[0],e.anchorPointY+k[1]);if(I&&!_){const qe=this.projectAndGetPerspectiveRatio(a,ot.x+1,ot.y,u,R).point.sub(z.point).unit(),Se=Math.atan(qe.y/qe.x)+(qe.x<0?Math.PI:0),ke=Math.sin(Se),ti=Math.cos(Se);Y=new s.P(ti,ke),tt=new s.P(-ke,ti)}else if(!I&&_){const qe=-this.transform.angle,Se=Math.sin(qe),ke=Math.cos(qe);Y=new s.P(ke,Se),tt=new s.P(-Se,ke)}let mt=z.point,ut=G;if(_){mt=ot;const qe=this.transform.zoom-Math.floor(this.transform.zoom);ut=Math.pow(2,-qe),ut*=this.mapProjection.getPitchedTextCorrection(this.transform,ot,u),V||(ut*=s.ad(.5+z.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))}V&&(mt=mt.add(Y.mult(V.x*ut)).add(tt.mult(V.y*ut)));const bt=e.x1*ut,Pt=e.x2*ut,ht=(bt+Pt)/2,Dt=e.y1*ut,Ut=e.y2*ut,$t=(Dt+Ut)/2,_e=[{offsetX:bt,offsetY:Dt},{offsetX:ht,offsetY:Dt},{offsetX:Pt,offsetY:Dt},{offsetX:Pt,offsetY:$t},{offsetX:Pt,offsetY:Ut},{offsetX:ht,offsetY:Ut},{offsetX:bt,offsetY:Ut},{offsetX:bt,offsetY:$t}];let Ce=[];for(const{offsetX:qe,offsetY:Se}of _e)Ce.push(new s.P(mt.x+Y.x*qe+tt.x*Se,mt.y+Y.y*qe+tt.y*Se));let Xe=!1;if(_){const qe=Ce.map(Se=>this.projectAndGetPerspectiveRatio(a,Se.x,Se.y,u,R));Xe=qe.some(Se=>!Se.isOccluded),Ce=qe.map(Se=>Se.point)}else Xe=!0;return{box:s.ap(Ce),allPointsOccluded:!Xe}}}function gi(y,e,n){return e*(s.X/(y.tileSize*Math.pow(2,n-y.tileID.overscaledZ)))}class tr{constructor(e,n,a,u){this.opacity=e?Math.max(0,Math.min(1,e.opacity+(e.placed?n:-n))):u&&a?1:0,this.placed=a}isHidden(){return this.opacity===0&&!this.placed}}class xr{constructor(e,n,a,u,_){this.text=new tr(e?e.text:null,n,a,_),this.icon=new tr(e?e.icon:null,n,u,_)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Fi{constructor(e,n,a){this.text=e,this.icon=n,this.skipFade=a}}class ki{constructor(){this.invProjMatrix=s.H(),this.viewportMatrix=s.H(),this.circles=[]}}class Hi{constructor(e,n,a,u,_){this.bucketInstanceId=e,this.featureIndex=n,this.sourceLayerIndex=a,this.bucketIndex=u,this.tileID=_}}class hr{constructor(e){this.crossSourceCollisions=e,this.maxGroupID=0,this.collisionGroups={}}get(e){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[e]){const n=++this.maxGroupID;this.collisionGroups[e]={ID:n,predicate:a=>a.collisionGroupID===n}}return this.collisionGroups[e]}}function Ar(y,e,n,a,u){const{horizontalAlign:_,verticalAlign:I}=s.av(y);return new s.P(-(_-.5)*e+a[0]*u,-(I-.5)*n+a[1]*u)}class Wr{constructor(e,n,a,u,_,I){this.transform=e.clone(),this.terrain=a,this.collisionIndex=new Ei(this.transform,n),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=u,this.retainedQueryData={},this.collisionGroups=new hr(_),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=I,I&&(I.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(e){const n=this.terrain;return n?(a,u)=>n.getElevation(e,a,u):null}getBucketParts(e,n,a,u){const _=a.getBucket(n),I=a.latestFeatureIndex;if(!_||!I||n.id!==_.layerIds[0])return;const k=a.collisionBoxArray,z=_.layers[0].layout,R=_.layers[0].paint,V=Math.pow(2,this.transform.zoom-a.tileID.overscaledZ),G=a.tileSize/s.X,Y=a.tileID.toUnwrapped(),tt=this.transform.calculatePosMatrix(Y),ot=z.get("text-pitch-alignment")==="map",mt=z.get("text-rotation-alignment")==="map",ut=gi(a,1,this.transform.zoom),bt=this.collisionIndex.mapProjection.translatePosition(this.transform,a,R.get("text-translate"),R.get("text-translate-anchor")),Pt=this.collisionIndex.mapProjection.translatePosition(this.transform,a,R.get("icon-translate"),R.get("icon-translate-anchor")),ht=Rr(tt,ot,mt,this.transform,ut);let Dt=null;if(ot){const $t=cr(tt,ot,mt,this.transform,ut);Dt=s.L([],this.transform.labelPlaneMatrix,$t)}this.retainedQueryData[_.bucketInstanceId]=new Hi(_.bucketInstanceId,I,_.sourceLayerIndex,_.index,a.tileID);const Ut={bucket:_,layout:z,translationText:bt,translationIcon:Pt,posMatrix:tt,unwrappedTileID:Y,textLabelPlaneMatrix:ht,labelToScreenMatrix:Dt,scale:V,textPixelRatio:G,holdingForFade:a.holdingForFade(),collisionBoxArray:k,partiallyEvaluatedTextSize:s.ah(_.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(_.sourceID)};if(u)for(const $t of _.sortKeyRanges){const{sortKey:_e,symbolInstanceStart:Ce,symbolInstanceEnd:Xe}=$t;e.push({sortKey:_e,symbolInstanceStart:Ce,symbolInstanceEnd:Xe,parameters:Ut})}else e.push({symbolInstanceStart:0,symbolInstanceEnd:_.symbolInstances.length,parameters:Ut})}attemptAnchorPlacement(e,n,a,u,_,I,k,z,R,V,G,Y,tt,ot,mt,ut,bt,Pt,ht){const Dt=s.ar[e.textAnchor],Ut=[e.textOffset0,e.textOffset1],$t=Ar(Dt,a,u,Ut,_),_e=this.collisionIndex.placeCollisionBox(n,Y,z,R,V,k,I,ut,G.predicate,ht,$t);if((!Pt||this.collisionIndex.placeCollisionBox(Pt,Y,z,R,V,k,I,bt,G.predicate,ht,$t).placeable)&&_e.placeable){let Ce;if(this.prevPlacement&&this.prevPlacement.variableOffsets[tt.crossTileID]&&this.prevPlacement.placements[tt.crossTileID]&&this.prevPlacement.placements[tt.crossTileID].text&&(Ce=this.prevPlacement.variableOffsets[tt.crossTileID].anchor),tt.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[tt.crossTileID]={textOffset:Ut,width:a,height:u,anchor:Dt,textBoxScale:_,prevAnchor:Ce},this.markUsedJustification(ot,Dt,tt,mt),ot.allowVerticalPlacement&&(this.markUsedOrientation(ot,mt,tt),this.placedOrientations[tt.crossTileID]=mt),{shift:$t,placedGlyphBoxes:_e}}}placeLayerBucketPart(e,n,a){const{bucket:u,layout:_,translationText:I,translationIcon:k,posMatrix:z,unwrappedTileID:R,textLabelPlaneMatrix:V,labelToScreenMatrix:G,textPixelRatio:Y,holdingForFade:tt,collisionBoxArray:ot,partiallyEvaluatedTextSize:mt,collisionGroup:ut}=e.parameters,bt=_.get("text-optional"),Pt=_.get("icon-optional"),ht=s.as(_,"text-overlap","text-allow-overlap"),Dt=ht==="always",Ut=s.as(_,"icon-overlap","icon-allow-overlap"),$t=Ut==="always",_e=_.get("text-rotation-alignment")==="map",Ce=_.get("text-pitch-alignment")==="map",Xe=_.get("icon-text-fit")!=="none",qe=_.get("symbol-z-order")==="viewport-y",Se=Dt&&($t||!u.hasIconData()||Pt),ke=$t&&(Dt||!u.hasTextData()||bt);!u.collisionArrays&&ot&&u.deserializeCollisionBoxes(ot);const ti=this._getTerrainElevationFunc(this.retainedQueryData[u.bucketInstanceId].tileID),Ci=(ze,Ve,yi)=>{var gr,Ii;if(n[ze.crossTileID])return;if(tt)return void(this.placements[ze.crossTileID]=new Fi(!1,!1,!1));let Di=!1,_r=!1,rn=!0,ts=null,yr={box:null,placeable:!1,offscreen:null},Cn={box:null,placeable:!1,offscreen:null},_n=null,nn=null,sn=null,es=0,Do=0,nl=0;Ve.textFeatureIndex?es=Ve.textFeatureIndex:ze.useRuntimeCollisionCircles&&(es=ze.featureIndex),Ve.verticalTextFeatureIndex&&(Do=Ve.verticalTextFeatureIndex);const ia=Ve.textBox;if(ia){const Jr=on=>{let an=s.ai.horizontal;if(u.allowVerticalPlacement&&!on&&this.prevPlacement){const Hr=this.prevPlacement.placedOrientations[ze.crossTileID];Hr&&(this.placedOrientations[ze.crossTileID]=Hr,an=Hr,this.markUsedOrientation(u,an,ze))}return an},is=(on,an)=>{if(u.allowVerticalPlacement&&ze.numVerticalGlyphVertices>0&&Ve.verticalTextBox){for(const Hr of u.writingModes)if(Hr===s.ai.vertical?(yr=an(),Cn=yr):yr=on(),yr&&yr.placeable)break}else yr=on()},eo=ze.textAnchorOffsetStartIndex,ra=ze.textAnchorOffsetEndIndex;if(ra===eo){const on=(an,Hr)=>{const Cr=this.collisionIndex.placeCollisionBox(an,ht,Y,z,R,Ce,_e,I,ut.predicate,ti);return Cr&&Cr.placeable&&(this.markUsedOrientation(u,Hr,ze),this.placedOrientations[ze.crossTileID]=Hr),Cr};is(()=>on(ia,s.ai.horizontal),()=>{const an=Ve.verticalTextBox;return u.allowVerticalPlacement&&ze.numVerticalGlyphVertices>0&&an?on(an,s.ai.vertical):{box:null,offscreen:null}}),Jr(yr&&yr.placeable)}else{let on=s.ar[(Ii=(gr=this.prevPlacement)===null||gr===void 0?void 0:gr.variableOffsets[ze.crossTileID])===null||Ii===void 0?void 0:Ii.anchor];const an=(Cr,na,ql)=>{const Gr=Cr.x2-Cr.x1,Ec=Cr.y2-Cr.y1,ol=ze.textBoxScale,al=Xe&&Ut==="never"?na:null;let io=null,Pc=ht==="never"?1:2,$l="never";on&&Pc++;for(let Yl=0;Yl<Pc;Yl++){for(let Zl=eo;Zl<ra;Zl++){const ll=u.textAnchorOffsets.get(Zl);if(on&&ll.textAnchor!==on)continue;const sa=this.attemptAnchorPlacement(ll,Cr,Gr,Ec,ol,_e,Ce,Y,z,R,ut,$l,ze,u,ql,I,k,al,ti);if(sa&&(io=sa.placedGlyphBoxes,io&&io.placeable))return Di=!0,ts=sa.shift,io}on?on=null:$l=ht}return a&&!io&&(io={box:this.collisionIndex.placeCollisionBox(ia,"always",Y,z,R,Ce,_e,I,ut.predicate,ti,new s.P(0,0)).box,offscreen:!1,placeable:!1}),io};is(()=>an(ia,Ve.iconBox,s.ai.horizontal),()=>{const Cr=Ve.verticalTextBox;return u.allowVerticalPlacement&&(!yr||!yr.placeable)&&ze.numVerticalGlyphVertices>0&&Cr?an(Cr,Ve.verticalIconBox,s.ai.vertical):{box:null,occluded:!0,offscreen:null}}),yr&&(Di=yr.placeable,rn=yr.offscreen);const Hr=Jr(yr&&yr.placeable);if(!Di&&this.prevPlacement){const Cr=this.prevPlacement.variableOffsets[ze.crossTileID];Cr&&(this.variableOffsets[ze.crossTileID]=Cr,this.markUsedJustification(u,Cr.anchor,ze,Hr))}}}if(_n=yr,Di=_n&&_n.placeable,rn=_n&&_n.offscreen,ze.useRuntimeCollisionCircles){const Jr=u.text.placedSymbolArray.get(ze.centerJustifiedTextSymbolIndex),is=s.aj(u.textSizeData,mt,Jr),eo=_.get("text-padding");nn=this.collisionIndex.placeCollisionCircles(ht,Jr,u.lineVertexArray,u.glyphOffsetArray,is,z,R,V,G,a,Ce,ut.predicate,ze.collisionCircleDiameter,eo,I,ti),nn.circles.length&&nn.collisionDetected&&!a&&s.w("Collisions detected, but collision boxes are not shown"),Di=Dt||nn.circles.length>0&&!nn.collisionDetected,rn=rn&&nn.offscreen}if(Ve.iconFeatureIndex&&(nl=Ve.iconFeatureIndex),Ve.iconBox){const Jr=is=>this.collisionIndex.placeCollisionBox(is,Ut,Y,z,R,Ce,_e,k,ut.predicate,ti,Xe&&ts?ts:void 0);Cn&&Cn.placeable&&Ve.verticalIconBox?(sn=Jr(Ve.verticalIconBox),_r=sn.placeable):(sn=Jr(Ve.iconBox),_r=sn.placeable),rn=rn&&sn.offscreen}const Lo=bt||ze.numHorizontalGlyphVertices===0&&ze.numVerticalGlyphVertices===0,sl=Pt||ze.numIconVertices===0;Lo||sl?sl?Lo||(_r=_r&&Di):Di=_r&&Di:_r=Di=_r&&Di;const Hl=_r&&sn.placeable;if(Di&&_n.placeable&&this.collisionIndex.insertCollisionBox(_n.box,ht,_.get("text-ignore-placement"),u.bucketInstanceId,Cn&&Cn.placeable&&Do?Do:es,ut.ID),Hl&&this.collisionIndex.insertCollisionBox(sn.box,Ut,_.get("icon-ignore-placement"),u.bucketInstanceId,nl,ut.ID),nn&&Di&&this.collisionIndex.insertCollisionCircles(nn.circles,ht,_.get("text-ignore-placement"),u.bucketInstanceId,es,ut.ID),a&&this.storeCollisionData(u.bucketInstanceId,yi,Ve,_n,sn,nn),ze.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(u.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[ze.crossTileID]=new Fi(Di||Se,_r||ke,rn||u.justReloaded),n[ze.crossTileID]=!0};if(qe){if(e.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const ze=u.getSortedSymbolIndexes(this.transform.angle);for(let Ve=ze.length-1;Ve>=0;--Ve){const yi=ze[Ve];Ci(u.symbolInstances.get(yi),u.collisionArrays[yi],yi)}}else for(let ze=e.symbolInstanceStart;ze<e.symbolInstanceEnd;ze++)Ci(u.symbolInstances.get(ze),u.collisionArrays[ze],ze);if(a&&u.bucketInstanceId in this.collisionCircleArrays){const ze=this.collisionCircleArrays[u.bucketInstanceId];s.at(ze.invProjMatrix,z),ze.viewportMatrix=this.collisionIndex.getViewportMatrix()}u.justReloaded=!1}storeCollisionData(e,n,a,u,_,I){if(a.textBox||a.iconBox){let k,z;this.collisionBoxArrays.has(e)?k=this.collisionBoxArrays.get(e):(k=new Map,this.collisionBoxArrays.set(e,k)),k.has(n)?z=k.get(n):(z={text:null,icon:null},k.set(n,z)),a.textBox&&(z.text=u.box),a.iconBox&&(z.icon=_.box)}if(I){let k=this.collisionCircleArrays[e];k===void 0&&(k=this.collisionCircleArrays[e]=new ki);for(let z=0;z<I.circles.length;z+=4)k.circles.push(I.circles[z+0]),k.circles.push(I.circles[z+1]),k.circles.push(I.circles[z+2]),k.circles.push(I.collisionDetected?1:0)}}markUsedJustification(e,n,a,u){let _;_=u===s.ai.vertical?a.verticalPlacedTextSymbolIndex:{left:a.leftJustifiedTextSymbolIndex,center:a.centerJustifiedTextSymbolIndex,right:a.rightJustifiedTextSymbolIndex}[s.au(n)];const I=[a.leftJustifiedTextSymbolIndex,a.centerJustifiedTextSymbolIndex,a.rightJustifiedTextSymbolIndex,a.verticalPlacedTextSymbolIndex];for(const k of I)k>=0&&(e.text.placedSymbolArray.get(k).crossTileID=_>=0&&k!==_?0:a.crossTileID)}markUsedOrientation(e,n,a){const u=n===s.ai.horizontal||n===s.ai.horizontalOnly?n:0,_=n===s.ai.vertical?n:0,I=[a.leftJustifiedTextSymbolIndex,a.centerJustifiedTextSymbolIndex,a.rightJustifiedTextSymbolIndex];for(const k of I)e.text.placedSymbolArray.get(k).placedOrientation=u;a.verticalPlacedTextSymbolIndex&&(e.text.placedSymbolArray.get(a.verticalPlacedTextSymbolIndex).placedOrientation=_)}commit(e){this.commitTime=e,this.zoomAtLastRecencyCheck=this.transform.zoom;const n=this.prevPlacement;let a=!1;this.prevZoomAdjustment=n?n.zoomAdjustment(this.transform.zoom):0;const u=n?n.symbolFadeChange(e):1,_=n?n.opacities:{},I=n?n.variableOffsets:{},k=n?n.placedOrientations:{};for(const z in this.placements){const R=this.placements[z],V=_[z];V?(this.opacities[z]=new xr(V,u,R.text,R.icon),a=a||R.text!==V.text.placed||R.icon!==V.icon.placed):(this.opacities[z]=new xr(null,u,R.text,R.icon,R.skipFade),a=a||R.text||R.icon)}for(const z in _){const R=_[z];if(!this.opacities[z]){const V=new xr(R,u,!1,!1);V.isHidden()||(this.opacities[z]=V,a=a||R.text.placed||R.icon.placed)}}for(const z in I)this.variableOffsets[z]||!this.opacities[z]||this.opacities[z].isHidden()||(this.variableOffsets[z]=I[z]);for(const z in k)this.placedOrientations[z]||!this.opacities[z]||this.opacities[z].isHidden()||(this.placedOrientations[z]=k[z]);if(n&&n.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");a?this.lastPlacementChangeTime=e:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=n?n.lastPlacementChangeTime:e)}updateLayerOpacities(e,n){const a={};for(const u of n){const _=u.getBucket(e);_&&u.latestFeatureIndex&&e.id===_.layerIds[0]&&this.updateBucketOpacities(_,u.tileID,a,u.collisionBoxArray)}}updateBucketOpacities(e,n,a,u){e.hasTextData()&&(e.text.opacityVertexArray.clear(),e.text.hasVisibleVertices=!1),e.hasIconData()&&(e.icon.opacityVertexArray.clear(),e.icon.hasVisibleVertices=!1),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexArray.clear(),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexArray.clear();const _=e.layers[0],I=_.layout,k=new xr(null,0,!1,!1,!0),z=I.get("text-allow-overlap"),R=I.get("icon-allow-overlap"),V=_._unevaluatedLayout.hasValue("text-variable-anchor")||_._unevaluatedLayout.hasValue("text-variable-anchor-offset"),G=I.get("text-rotation-alignment")==="map",Y=I.get("text-pitch-alignment")==="map",tt=I.get("icon-text-fit")!=="none",ot=new xr(null,0,z&&(R||!e.hasIconData()||I.get("icon-optional")),R&&(z||!e.hasTextData()||I.get("text-optional")),!0);!e.collisionArrays&&u&&(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData())&&e.deserializeCollisionBoxes(u);const mt=(bt,Pt,ht)=>{for(let Dt=0;Dt<Pt/4;Dt++)bt.opacityVertexArray.emplaceBack(ht);bt.hasVisibleVertices=bt.hasVisibleVertices||ht!==ur},ut=this.collisionBoxArrays.get(e.bucketInstanceId);for(let bt=0;bt<e.symbolInstances.length;bt++){const Pt=e.symbolInstances.get(bt),{numHorizontalGlyphVertices:ht,numVerticalGlyphVertices:Dt,crossTileID:Ut}=Pt;let $t=this.opacities[Ut];a[Ut]?$t=k:$t||($t=ot,this.opacities[Ut]=$t),a[Ut]=!0;const _e=Pt.numIconVertices>0,Ce=this.placedOrientations[Pt.crossTileID],Xe=Ce===s.ai.vertical,qe=Ce===s.ai.horizontal||Ce===s.ai.horizontalOnly;if(ht>0||Dt>0){const ke=Mr($t.text);mt(e.text,ht,Xe?ur:ke),mt(e.text,Dt,qe?ur:ke);const ti=$t.text.isHidden();[Pt.rightJustifiedTextSymbolIndex,Pt.centerJustifiedTextSymbolIndex,Pt.leftJustifiedTextSymbolIndex].forEach(Ve=>{Ve>=0&&(e.text.placedSymbolArray.get(Ve).hidden=ti||Xe?1:0)}),Pt.verticalPlacedTextSymbolIndex>=0&&(e.text.placedSymbolArray.get(Pt.verticalPlacedTextSymbolIndex).hidden=ti||qe?1:0);const Ci=this.variableOffsets[Pt.crossTileID];Ci&&this.markUsedJustification(e,Ci.anchor,Pt,Ce);const ze=this.placedOrientations[Pt.crossTileID];ze&&(this.markUsedJustification(e,"left",Pt,ze),this.markUsedOrientation(e,ze,Pt))}if(_e){const ke=Mr($t.icon),ti=!(tt&&Pt.verticalPlacedIconSymbolIndex&&Xe);Pt.placedIconSymbolIndex>=0&&(mt(e.icon,Pt.numIconVertices,ti?ke:ur),e.icon.placedSymbolArray.get(Pt.placedIconSymbolIndex).hidden=$t.icon.isHidden()),Pt.verticalPlacedIconSymbolIndex>=0&&(mt(e.icon,Pt.numVerticalIconVertices,ti?ur:ke),e.icon.placedSymbolArray.get(Pt.verticalPlacedIconSymbolIndex).hidden=$t.icon.isHidden())}const Se=ut&&ut.has(bt)?ut.get(bt):{text:null,icon:null};if(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData()){const ke=e.collisionArrays[bt];if(ke){let ti=new s.P(0,0);if(ke.textBox||ke.verticalTextBox){let Ci=!0;if(V){const ze=this.variableOffsets[Ut];ze?(ti=Ar(ze.anchor,ze.width,ze.height,ze.textOffset,ze.textBoxScale),G&&ti._rotate(Y?this.transform.angle:-this.transform.angle)):Ci=!1}if(ke.textBox||ke.verticalTextBox){let ze;ke.textBox&&(ze=Xe),ke.verticalTextBox&&(ze=qe),Br(e.textCollisionBox.collisionVertexArray,$t.text.placed,!Ci||ze,Se.text,ti.x,ti.y)}}if(ke.iconBox||ke.verticalIconBox){const Ci=!!(!qe&&ke.verticalIconBox);let ze;ke.iconBox&&(ze=Ci),ke.verticalIconBox&&(ze=!Ci),Br(e.iconCollisionBox.collisionVertexArray,$t.icon.placed,ze,Se.icon,tt?ti.x:0,tt?ti.y:0)}}}}if(e.sortFeatures(this.transform.angle),this.retainedQueryData[e.bucketInstanceId]&&(this.retainedQueryData[e.bucketInstanceId].featureSortOrder=e.featureSortOrder),e.hasTextData()&&e.text.opacityVertexBuffer&&e.text.opacityVertexBuffer.updateData(e.text.opacityVertexArray),e.hasIconData()&&e.icon.opacityVertexBuffer&&e.icon.opacityVertexBuffer.updateData(e.icon.opacityVertexArray),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexBuffer&&e.iconCollisionBox.collisionVertexBuffer.updateData(e.iconCollisionBox.collisionVertexArray),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexBuffer&&e.textCollisionBox.collisionVertexBuffer.updateData(e.textCollisionBox.collisionVertexArray),e.text.opacityVertexArray.length!==e.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${e.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${e.text.layoutVertexArray.length}) / 4`);if(e.icon.opacityVertexArray.length!==e.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${e.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${e.icon.layoutVertexArray.length}) / 4`);if(e.bucketInstanceId in this.collisionCircleArrays){const bt=this.collisionCircleArrays[e.bucketInstanceId];e.placementInvProjMatrix=bt.invProjMatrix,e.placementViewportMatrix=bt.viewportMatrix,e.collisionCircleArray=bt.circles,delete this.collisionCircleArrays[e.bucketInstanceId]}}symbolFadeChange(e){return this.fadeDuration===0?1:(e-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(e){return Math.max(0,(this.transform.zoom-e)/1.5)}hasTransitions(e){return this.stale||e-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(e,n){const a=this.zoomAtLastRecencyCheck===n?1-this.zoomAdjustment(n):1;return this.zoomAtLastRecencyCheck=n,this.commitTime+this.fadeDuration*a>e}setStale(){this.stale=!0}}function Br(y,e,n,a,u,_){a&&a.length!==0||(a=[0,0,0,0]);const I=a[0]-_i,k=a[1]-_i,z=a[2]-_i,R=a[3]-_i;y.emplaceBack(e?1:0,n?1:0,u||0,_||0,I,k),y.emplaceBack(e?1:0,n?1:0,u||0,_||0,z,k),y.emplaceBack(e?1:0,n?1:0,u||0,_||0,z,R),y.emplaceBack(e?1:0,n?1:0,u||0,_||0,I,R)}const uo=Math.pow(2,25),Ri=Math.pow(2,24),fo=Math.pow(2,17),po=Math.pow(2,16),Xi=Math.pow(2,9),tn=Math.pow(2,8),Za=Math.pow(2,1);function Mr(y){if(y.opacity===0&&!y.placed)return 0;if(y.opacity===1&&y.placed)return 4294967295;const e=y.placed?1:0,n=Math.floor(127*y.opacity);return n*uo+e*Ri+n*fo+e*po+n*Xi+e*tn+n*Za+e}const ur=0;function Cs(){return{isOccluded:(y,e,n)=>!1,getPitchedTextCorrection:(y,e,n)=>1,get useSpecialProjectionForSymbols(){return!1},projectTileCoordinates(y,e,n,a){throw new Error("Not implemented.")},translatePosition:(y,e,n,a)=>function(u,_,I,k,z=!1){if(!I[0]&&!I[1])return[0,0];const R=z?k==="map"?u.angle:0:k==="viewport"?-u.angle:0;if(R){const V=Math.sin(R),G=Math.cos(R);I=[I[0]*G-I[1]*V,I[0]*V+I[1]*G]}return[z?I[0]:gi(_,I[0],u.zoom),z?I[1]:gi(_,I[1],u.zoom)]}(y,e,n,a),getCircleRadiusCorrection:y=>1}}class Mn{constructor(e){this._sortAcrossTiles=e.layout.get("symbol-z-order")!=="viewport-y"&&!e.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(e,n,a,u,_){const I=this._bucketParts;for(;this._currentTileIndex<e.length;)if(n.getBucketParts(I,u,e[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,_())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,I.sort((k,z)=>k.sortKey-z.sortKey));this._currentPartIndex<I.length;)if(n.placeLayerBucketPart(I[this._currentPartIndex],this._seenCrossTileIDs,a),this._currentPartIndex++,_())return!0;return!1}}class sr{constructor(e,n,a,u,_,I,k,z){this.placement=new Wr(e,Cs(),n,I,k,z),this._currentPlacementIndex=a.length-1,this._forceFullPlacement=u,this._showCollisionBoxes=_,this._done=!1}isDone(){return this._done}continuePlacement(e,n,a){const u=l.now(),_=()=>!this._forceFullPlacement&&l.now()-u>2;for(;this._currentPlacementIndex>=0;){const I=n[e[this._currentPlacementIndex]],k=this.placement.collisionIndex.transform.zoom;if(I.type==="symbol"&&(!I.minzoom||I.minzoom<=k)&&(!I.maxzoom||I.maxzoom>k)){if(this._inProgressLayer||(this._inProgressLayer=new Mn(I)),this._inProgressLayer.continuePlacement(a[I.source],this.placement,this._showCollisionBoxes,I,_))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(e){return this.placement.commit(e),this.placement}}const jn=512/s.X/2;class Ss{constructor(e,n,a){this.tileID=e,this.bucketInstanceId=a,this._symbolsByKey={};const u=new Map;for(let _=0;_<n.length;_++){const I=n.get(_),k=I.key,z=u.get(k);z?z.push(I):u.set(k,[I])}for(const[_,I]of u){const k={positions:I.map(z=>({x:Math.floor(z.anchorX*jn),y:Math.floor(z.anchorY*jn)})),crossTileIDs:I.map(z=>z.crossTileID)};if(k.positions.length>128){const z=new s.aw(k.positions.length,16,Uint16Array);for(const{x:R,y:V}of k.positions)z.add(R,V);z.finish(),delete k.positions,k.index=z}this._symbolsByKey[_]=k}}getScaledCoordinates(e,n){const{x:a,y:u,z:_}=this.tileID.canonical,{x:I,y:k,z}=n.canonical,R=jn/Math.pow(2,z-_),V=(k*s.X+e.anchorY)*R,G=u*s.X*jn;return{x:Math.floor((I*s.X+e.anchorX)*R-a*s.X*jn),y:Math.floor(V-G)}}findMatches(e,n,a){const u=this.tileID.canonical.z<n.canonical.z?1:Math.pow(2,this.tileID.canonical.z-n.canonical.z);for(let _=0;_<e.length;_++){const I=e.get(_);if(I.crossTileID)continue;const k=this._symbolsByKey[I.key];if(!k)continue;const z=this.getScaledCoordinates(I,n);if(k.index){const R=k.index.range(z.x-u,z.y-u,z.x+u,z.y+u).sort();for(const V of R){const G=k.crossTileIDs[V];if(!a[G]){a[G]=!0,I.crossTileID=G;break}}}else if(k.positions)for(let R=0;R<k.positions.length;R++){const V=k.positions[R],G=k.crossTileIDs[R];if(Math.abs(V.x-z.x)<=u&&Math.abs(V.y-z.y)<=u&&!a[G]){a[G]=!0,I.crossTileID=G;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map(({crossTileIDs:e})=>e)}}class Er{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class jo{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(e){const n=Math.round((e-this.lng)/360);if(n!==0)for(const a in this.indexes){const u=this.indexes[a],_={};for(const I in u){const k=u[I];k.tileID=k.tileID.unwrapTo(k.tileID.wrap+n),_[k.tileID.key]=k}this.indexes[a]=_}this.lng=e}addBucket(e,n,a){if(this.indexes[e.overscaledZ]&&this.indexes[e.overscaledZ][e.key]){if(this.indexes[e.overscaledZ][e.key].bucketInstanceId===n.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(e.overscaledZ,this.indexes[e.overscaledZ][e.key])}for(let _=0;_<n.symbolInstances.length;_++)n.symbolInstances.get(_).crossTileID=0;this.usedCrossTileIDs[e.overscaledZ]||(this.usedCrossTileIDs[e.overscaledZ]={});const u=this.usedCrossTileIDs[e.overscaledZ];for(const _ in this.indexes){const I=this.indexes[_];if(Number(_)>e.overscaledZ)for(const k in I){const z=I[k];z.tileID.isChildOf(e)&&z.findMatches(n.symbolInstances,e,u)}else{const k=I[e.scaledTo(Number(_)).key];k&&k.findMatches(n.symbolInstances,e,u)}}for(let _=0;_<n.symbolInstances.length;_++){const I=n.symbolInstances.get(_);I.crossTileID||(I.crossTileID=a.generate(),u[I.crossTileID]=!0)}return this.indexes[e.overscaledZ]===void 0&&(this.indexes[e.overscaledZ]={}),this.indexes[e.overscaledZ][e.key]=new Ss(e,n.symbolInstances,n.bucketInstanceId),!0}removeBucketCrossTileIDs(e,n){for(const a of n.getCrossTileIDsLists())for(const u of a)delete this.usedCrossTileIDs[e][u]}removeStaleBuckets(e){let n=!1;for(const a in this.indexes){const u=this.indexes[a];for(const _ in u)e[u[_].bucketInstanceId]||(this.removeBucketCrossTileIDs(a,u[_]),delete u[_],n=!0)}return n}}class fn{constructor(){this.layerIndexes={},this.crossTileIDs=new Er,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(e,n,a){let u=this.layerIndexes[e.id];u===void 0&&(u=this.layerIndexes[e.id]=new jo);let _=!1;const I={};u.handleWrapJump(a);for(const k of n){const z=k.getBucket(e);z&&e.id===z.layerIds[0]&&(z.bucketInstanceId||(z.bucketInstanceId=++this.maxBucketInstanceId),u.addBucket(k.tileID,z,this.crossTileIDs)&&(_=!0),I[z.bucketInstanceId]=!0)}return u.removeStaleBuckets(I)&&(_=!0),_}pruneUnusedLayers(e){const n={};e.forEach(a=>{n[a]=!0});for(const a in this.layerIndexes)n[a]||delete this.layerIndexes[a]}}const Ts=(y,e)=>s.t(y,e&&e.filter(n=>n.identifier!=="source.canvas")),$n=s.ax();class No extends s.E{constructor(e,n={}){super(),this._rtlPluginLoaded=()=>{for(const a in this.sourceCaches){const u=this.sourceCaches[a].getSource().type;u!=="vector"&&u!=="geojson"||this.sourceCaches[a].reload()}},this.map=e,this.dispatcher=new Xt(Wt(),e._getMapId()),this.dispatcher.registerMessageHandler("GG",(a,u)=>this.getGlyphs(a,u)),this.dispatcher.registerMessageHandler("GI",(a,u)=>this.getImages(a,u)),this.imageManager=new he,this.imageManager.setEventedParent(this),this.glyphManager=new se(e._requestManager,n.localIdeographFontFamily),this.lineAtlas=new Vt(256,512),this.crossTileSymbolIndex=new fn,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new s.ay,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("SR",s.az()),nr().on(ce,this._rtlPluginLoaded),this.on("data",a=>{if(a.dataType!=="source"||a.sourceDataType!=="metadata")return;const u=this.sourceCaches[a.sourceId];if(!u)return;const _=u.getSource();if(_&&_.vectorLayerIds)for(const I in this._layers){const k=this._layers[I];k.source===_.id&&this._validateLayer(k)}})}loadURL(e,n={},a){this.fire(new s.k("dataloading",{dataType:"style"})),n.validate=typeof n.validate!="boolean"||n.validate;const u=this.map._requestManager.transformRequest(e,"Style");this._loadStyleRequest=new AbortController;const _=this._loadStyleRequest;s.h(u,this._loadStyleRequest).then(I=>{this._loadStyleRequest=null,this._load(I.data,n,a)}).catch(I=>{this._loadStyleRequest=null,I&&!_.signal.aborted&&this.fire(new s.j(I))})}loadJSON(e,n={},a){this.fire(new s.k("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,l.frameAsync(this._frameRequest).then(()=>{this._frameRequest=null,n.validate=n.validate!==!1,this._load(e,n,a)}).catch(()=>{})}loadEmpty(){this.fire(new s.k("dataloading",{dataType:"style"})),this._load($n,{validate:!1})}_load(e,n,a){var u;const _=n.transformStyle?n.transformStyle(a,e):e;if(!n.validate||!Ts(this,s.x(_))){this._loaded=!0,this.stylesheet=_;for(const I in _.sources)this.addSource(I,_.sources[I],{validate:!1});_.sprite?this._loadSprite(_.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(_.glyphs),this._createLayers(),this.light=new wt(this.stylesheet.light),this.sky=new vt(this.stylesheet.sky),this.map.setTerrain((u=this.stylesheet.terrain)!==null&&u!==void 0?u:null),this.fire(new s.k("data",{dataType:"style"})),this.fire(new s.k("style.load"))}}_createLayers(){const e=s.aA(this.stylesheet.layers);this.dispatcher.broadcast("SL",e),this._order=e.map(n=>n.id),this._layers={},this._serializedLayers=null;for(const n of e){const a=s.aB(n);a.setEventedParent(this,{layer:{id:n.id}}),this._layers[n.id]=a}}_loadSprite(e,n=!1,a=void 0){let u;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,function(_,I,k,z){return s._(this,void 0,void 0,function*(){const R=Ft(_),V=k>1?"@2x":"",G={},Y={};for(const{id:tt,url:ot}of R){const mt=I.transformRequest(Kt(ot,V,".json"),"SpriteJSON");G[tt]=s.h(mt,z);const ut=I.transformRequest(Kt(ot,V,".png"),"SpriteImage");Y[tt]=O.getImage(ut,z)}return yield Promise.all([...Object.values(G),...Object.values(Y)]),function(tt,ot){return s._(this,void 0,void 0,function*(){const mt={};for(const ut in tt){mt[ut]={};const bt=l.getImageCanvasContext((yield ot[ut]).data),Pt=(yield tt[ut]).data;for(const ht in Pt){const{width:Dt,height:Ut,x:$t,y:_e,sdf:Ce,pixelRatio:Xe,stretchX:qe,stretchY:Se,content:ke,textFitWidth:ti,textFitHeight:Ci}=Pt[ht];mt[ut][ht]={data:null,pixelRatio:Xe,sdf:Ce,stretchX:qe,stretchY:Se,content:ke,textFitWidth:ti,textFitHeight:Ci,spriteData:{width:Dt,height:Ut,x:$t,y:_e,context:bt}}}}return mt})}(G,Y)})}(e,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then(_=>{if(this._spriteRequest=null,_)for(const I in _){this._spritesImagesIds[I]=[];const k=this._spritesImagesIds[I]?this._spritesImagesIds[I].filter(z=>!(z in _)):[];for(const z of k)this.imageManager.removeImage(z),this._changedImages[z]=!0;for(const z in _[I]){const R=I==="default"?z:`${I}:${z}`;this._spritesImagesIds[I].push(R),R in this.imageManager.images?this.imageManager.updateImage(R,_[I][z],!1):this.imageManager.addImage(R,_[I][z]),n&&(this._changedImages[R]=!0)}}}).catch(_=>{this._spriteRequest=null,u=_,this.fire(new s.j(u))}).finally(()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),n&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.k("data",{dataType:"style"})),a&&a(u)})}_unloadSprite(){for(const e of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(e),this._changedImages[e]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.k("data",{dataType:"style"}))}_validateLayer(e){const n=this.sourceCaches[e.source];if(!n)return;const a=e.sourceLayer;if(!a)return;const u=n.getSource();(u.type==="geojson"||u.vectorLayerIds&&u.vectorLayerIds.indexOf(a)===-1)&&this.fire(new s.j(new Error(`Source layer "${a}" does not exist on source "${u.id}" as specified by style layer "${e.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const e in this.sourceCaches)if(!this.sourceCaches[e].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(e){const n=this._serializedAllLayers();if(!e||e.length===0)return Object.values(n);const a=[];for(const u of e)n[u]&&a.push(n[u]);return a}_serializedAllLayers(){let e=this._serializedLayers;if(e)return e;e=this._serializedLayers={};const n=Object.keys(this._layers);for(const a of n){const u=this._layers[a];u.type!=="custom"&&(e[a]=u.serialize())}return e}hasTransitions(){if(this.light&&this.light.hasTransition()||this.sky&&this.sky.hasTransition())return!0;for(const e in this.sourceCaches)if(this.sourceCaches[e].hasTransition())return!0;for(const e in this._layers)if(this._layers[e].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(e){if(!this._loaded)return;const n=this._changed;if(n){const u=Object.keys(this._updatedLayers),_=Object.keys(this._removedLayers);(u.length||_.length)&&this._updateWorkerLayers(u,_);for(const I in this._updatedSources){const k=this._updatedSources[I];if(k==="reload")this._reloadSource(I);else{if(k!=="clear")throw new Error(`Invalid action ${k}`);this._clearSource(I)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const I in this._updatedPaintProps)this._layers[I].updateTransitions(e);this.light.updateTransitions(e),this.sky.updateTransitions(e),this._resetUpdates()}const a={};for(const u in this.sourceCaches){const _=this.sourceCaches[u];a[u]=_.used,_.used=!1}for(const u of this._order){const _=this._layers[u];_.recalculate(e,this._availableImages),!_.isHidden(e.zoom)&&_.source&&(this.sourceCaches[_.source].used=!0)}for(const u in a){const _=this.sourceCaches[u];!!a[u]!=!!_.used&&_.fire(new s.k("data",{sourceDataType:"visibility",dataType:"source",sourceId:u}))}this.light.recalculate(e),this.sky.recalculate(e),this.z=e.zoom,n&&this.fire(new s.k("data",{dataType:"style"}))}_updateTilesForChangedImages(){const e=Object.keys(this._changedImages);if(e.length){for(const n in this.sourceCaches)this.sourceCaches[n].reloadTilesForDependencies(["icons","patterns"],e);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const e in this.sourceCaches)this.sourceCaches[e].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(e,n){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(e),removedIds:n})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(e,n={}){var a;this._checkLoaded();const u=this.serialize();if(e=n.transformStyle?n.transformStyle(u,e):e,((a=n.validate)===null||a===void 0||a)&&Ts(this,s.x(e)))return!1;(e=s.aC(e)).layers=s.aA(e.layers);const _=s.aD(u,e),I=this._getOperationsToPerform(_);if(I.unimplemented.length>0)throw new Error(`Unimplemented: ${I.unimplemented.join(", ")}.`);if(I.operations.length===0)return!1;for(const k of I.operations)k();return this.stylesheet=e,this._serializedLayers=null,!0}_getOperationsToPerform(e){const n=[],a=[];for(const u of e)switch(u.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":continue;case"addLayer":n.push(()=>this.addLayer.apply(this,u.args));break;case"removeLayer":n.push(()=>this.removeLayer.apply(this,u.args));break;case"setPaintProperty":n.push(()=>this.setPaintProperty.apply(this,u.args));break;case"setLayoutProperty":n.push(()=>this.setLayoutProperty.apply(this,u.args));break;case"setFilter":n.push(()=>this.setFilter.apply(this,u.args));break;case"addSource":n.push(()=>this.addSource.apply(this,u.args));break;case"removeSource":n.push(()=>this.removeSource.apply(this,u.args));break;case"setLayerZoomRange":n.push(()=>this.setLayerZoomRange.apply(this,u.args));break;case"setLight":n.push(()=>this.setLight.apply(this,u.args));break;case"setGeoJSONSourceData":n.push(()=>this.setGeoJSONSourceData.apply(this,u.args));break;case"setGlyphs":n.push(()=>this.setGlyphs.apply(this,u.args));break;case"setSprite":n.push(()=>this.setSprite.apply(this,u.args));break;case"setSky":n.push(()=>this.setSky.apply(this,u.args));break;case"setTerrain":n.push(()=>this.map.setTerrain.apply(this,u.args));break;case"setTransition":n.push(()=>{});break;default:a.push(u.command)}return{operations:n,unimplemented:a}}addImage(e,n){if(this.getImage(e))return this.fire(new s.j(new Error(`An image named "${e}" already exists.`)));this.imageManager.addImage(e,n),this._afterImageUpdated(e)}updateImage(e,n){this.imageManager.updateImage(e,n)}getImage(e){return this.imageManager.getImage(e)}removeImage(e){if(!this.getImage(e))return this.fire(new s.j(new Error(`An image named "${e}" does not exist.`)));this.imageManager.removeImage(e),this._afterImageUpdated(e)}_afterImageUpdated(e){this._availableImages=this.imageManager.listImages(),this._changedImages[e]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.k("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(e,n,a={}){if(this._checkLoaded(),this.sourceCaches[e]!==void 0)throw new Error(`Source "${e}" already exists.`);if(!n.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(n).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(n.type)>=0&&this._validate(s.x.source,`sources.${e}`,n,null,a))return;this.map&&this.map._collectResourceTiming&&(n.collectResourceTiming=!0);const u=this.sourceCaches[e]=new $e(e,n,this.dispatcher);u.style=this,u.setEventedParent(this,()=>({isSourceLoaded:u.loaded(),source:u.serialize(),sourceId:e})),u.onAdd(this.map),this._changed=!0}removeSource(e){if(this._checkLoaded(),this.sourceCaches[e]===void 0)throw new Error("There is no source with this ID");for(const a in this._layers)if(this._layers[a].source===e)return this.fire(new s.j(new Error(`Source "${e}" cannot be removed while layer "${a}" is using it.`)));const n=this.sourceCaches[e];delete this.sourceCaches[e],delete this._updatedSources[e],n.fire(new s.k("data",{sourceDataType:"metadata",dataType:"source",sourceId:e})),n.setEventedParent(null),n.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(e,n){if(this._checkLoaded(),this.sourceCaches[e]===void 0)throw new Error(`There is no source with this ID=${e}`);const a=this.sourceCaches[e].getSource();if(a.type!=="geojson")throw new Error(`geojsonSource.type is ${a.type}, which is !== 'geojson`);a.setData(n),this._changed=!0}getSource(e){return this.sourceCaches[e]&&this.sourceCaches[e].getSource()}addLayer(e,n,a={}){this._checkLoaded();const u=e.id;if(this.getLayer(u))return void this.fire(new s.j(new Error(`Layer "${u}" already exists on this map.`)));let _;if(e.type==="custom"){if(Ts(this,s.aE(e)))return;_=s.aB(e)}else{if("source"in e&&typeof e.source=="object"&&(this.addSource(u,e.source),e=s.aC(e),e=s.e(e,{source:u})),this._validate(s.x.layer,`layers.${u}`,e,{arrayIndex:-1},a))return;_=s.aB(e),this._validateLayer(_),_.setEventedParent(this,{layer:{id:u}})}const I=n?this._order.indexOf(n):this._order.length;if(n&&I===-1)this.fire(new s.j(new Error(`Cannot add layer "${u}" before non-existing layer "${n}".`)));else{if(this._order.splice(I,0,u),this._layerOrderChanged=!0,this._layers[u]=_,this._removedLayers[u]&&_.source&&_.type!=="custom"){const k=this._removedLayers[u];delete this._removedLayers[u],k.type!==_.type?this._updatedSources[_.source]="clear":(this._updatedSources[_.source]="reload",this.sourceCaches[_.source].pause())}this._updateLayer(_),_.onAdd&&_.onAdd(this.map)}}moveLayer(e,n){if(this._checkLoaded(),this._changed=!0,!this._layers[e])return void this.fire(new s.j(new Error(`The layer '${e}' does not exist in the map's style and cannot be moved.`)));if(e===n)return;const a=this._order.indexOf(e);this._order.splice(a,1);const u=n?this._order.indexOf(n):this._order.length;n&&u===-1?this.fire(new s.j(new Error(`Cannot move layer "${e}" before non-existing layer "${n}".`))):(this._order.splice(u,0,e),this._layerOrderChanged=!0)}removeLayer(e){this._checkLoaded();const n=this._layers[e];if(!n)return void this.fire(new s.j(new Error(`Cannot remove non-existing layer "${e}".`)));n.setEventedParent(null);const a=this._order.indexOf(e);this._order.splice(a,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[e]=n,delete this._layers[e],this._serializedLayers&&delete this._serializedLayers[e],delete this._updatedLayers[e],delete this._updatedPaintProps[e],n.onRemove&&n.onRemove(this.map)}getLayer(e){return this._layers[e]}getLayersOrder(){return[...this._order]}hasLayer(e){return e in this._layers}setLayerZoomRange(e,n,a){this._checkLoaded();const u=this.getLayer(e);u?u.minzoom===n&&u.maxzoom===a||(n!=null&&(u.minzoom=n),a!=null&&(u.maxzoom=a),this._updateLayer(u)):this.fire(new s.j(new Error(`Cannot set the zoom range of non-existing layer "${e}".`)))}setFilter(e,n,a={}){this._checkLoaded();const u=this.getLayer(e);if(u){if(!s.aF(u.filter,n))return n==null?(u.filter=void 0,void this._updateLayer(u)):void(this._validate(s.x.filter,`layers.${u.id}.filter`,n,null,a)||(u.filter=s.aC(n),this._updateLayer(u)))}else this.fire(new s.j(new Error(`Cannot filter non-existing layer "${e}".`)))}getFilter(e){return s.aC(this.getLayer(e).filter)}setLayoutProperty(e,n,a,u={}){this._checkLoaded();const _=this.getLayer(e);_?s.aF(_.getLayoutProperty(n),a)||(_.setLayoutProperty(n,a,u),this._updateLayer(_)):this.fire(new s.j(new Error(`Cannot style non-existing layer "${e}".`)))}getLayoutProperty(e,n){const a=this.getLayer(e);if(a)return a.getLayoutProperty(n);this.fire(new s.j(new Error(`Cannot get style of non-existing layer "${e}".`)))}setPaintProperty(e,n,a,u={}){this._checkLoaded();const _=this.getLayer(e);_?s.aF(_.getPaintProperty(n),a)||(_.setPaintProperty(n,a,u)&&this._updateLayer(_),this._changed=!0,this._updatedPaintProps[e]=!0,this._serializedLayers=null):this.fire(new s.j(new Error(`Cannot style non-existing layer "${e}".`)))}getPaintProperty(e,n){return this.getLayer(e).getPaintProperty(n)}setFeatureState(e,n){this._checkLoaded();const a=e.source,u=e.sourceLayer,_=this.sourceCaches[a];if(_===void 0)return void this.fire(new s.j(new Error(`The source '${a}' does not exist in the map's style.`)));const I=_.getSource().type;I==="geojson"&&u?this.fire(new s.j(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):I!=="vector"||u?(e.id===void 0&&this.fire(new s.j(new Error("The feature id parameter must be provided."))),_.setFeatureState(u,e.id,n)):this.fire(new s.j(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(e,n){this._checkLoaded();const a=e.source,u=this.sourceCaches[a];if(u===void 0)return void this.fire(new s.j(new Error(`The source '${a}' does not exist in the map's style.`)));const _=u.getSource().type,I=_==="vector"?e.sourceLayer:void 0;_!=="vector"||I?n&&typeof e.id!="string"&&typeof e.id!="number"?this.fire(new s.j(new Error("A feature id is required to remove its specific state property."))):u.removeFeatureState(I,e.id,n):this.fire(new s.j(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(e){this._checkLoaded();const n=e.source,a=e.sourceLayer,u=this.sourceCaches[n];if(u!==void 0)return u.getSource().type!=="vector"||a?(e.id===void 0&&this.fire(new s.j(new Error("The feature id parameter must be provided."))),u.getFeatureState(a,e.id)):void this.fire(new s.j(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new s.j(new Error(`The source '${n}' does not exist in the map's style.`)))}getTransition(){return s.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const e=s.aG(this.sourceCaches,_=>_.serialize()),n=this._serializeByIds(this._order),a=this.map.getTerrain()||void 0,u=this.stylesheet;return s.aH({version:u.version,name:u.name,metadata:u.metadata,light:u.light,sky:u.sky,center:u.center,zoom:u.zoom,bearing:u.bearing,pitch:u.pitch,sprite:u.sprite,glyphs:u.glyphs,transition:u.transition,sources:e,layers:n,terrain:a},_=>_!==void 0)}_updateLayer(e){this._updatedLayers[e.id]=!0,e.source&&!this._updatedSources[e.source]&&this.sourceCaches[e.source].getSource().type!=="raster"&&(this._updatedSources[e.source]="reload",this.sourceCaches[e.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(e){const n=I=>this._layers[I].type==="fill-extrusion",a={},u=[];for(let I=this._order.length-1;I>=0;I--){const k=this._order[I];if(n(k)){a[k]=I;for(const z of e){const R=z[k];if(R)for(const V of R)u.push(V)}}}u.sort((I,k)=>k.intersectionZ-I.intersectionZ);const _=[];for(let I=this._order.length-1;I>=0;I--){const k=this._order[I];if(n(k))for(let z=u.length-1;z>=0;z--){const R=u[z].feature;if(a[R.layer.id]<I)break;_.push(R),u.pop()}else for(const z of e){const R=z[k];if(R)for(const V of R)_.push(V.feature)}}return _}queryRenderedFeatures(e,n,a){n&&n.filter&&this._validate(s.x.filter,"queryRenderedFeatures.filter",n.filter,null,n);const u={};if(n&&n.layers){if(!Array.isArray(n.layers))return this.fire(new s.j(new Error("parameters.layers must be an Array."))),[];for(const k of n.layers){const z=this._layers[k];if(!z)return this.fire(new s.j(new Error(`The layer '${k}' does not exist in the map's style and cannot be queried for features.`))),[];u[z.source]=!0}}const _=[];n.availableImages=this._availableImages;const I=this._serializedAllLayers();for(const k in this.sourceCaches)n.layers&&!u[k]||_.push(qt(this.sourceCaches[k],this._layers,I,e,n,a));return this.placement&&_.push(function(k,z,R,V,G,Y,tt){const ot={},mt=Y.queryRenderedSymbols(V),ut=[];for(const bt of Object.keys(mt).map(Number))ut.push(tt[bt]);ut.sort(Lt);for(const bt of ut){const Pt=bt.featureIndex.lookupSymbolFeatures(mt[bt.bucketInstanceId],z,bt.bucketIndex,bt.sourceLayerIndex,G.filter,G.layers,G.availableImages,k);for(const ht in Pt){const Dt=ot[ht]=ot[ht]||[],Ut=Pt[ht];Ut.sort(($t,_e)=>{const Ce=bt.featureSortOrder;if(Ce){const Xe=Ce.indexOf($t.featureIndex);return Ce.indexOf(_e.featureIndex)-Xe}return _e.featureIndex-$t.featureIndex});for(const $t of Ut)Dt.push($t)}}for(const bt in ot)ot[bt].forEach(Pt=>{const ht=Pt.feature,Dt=R[k[bt].source].getFeatureState(ht.layer["source-layer"],ht.id);ht.source=ht.layer.source,ht.layer["source-layer"]&&(ht.sourceLayer=ht.layer["source-layer"]),ht.state=Dt});return ot}(this._layers,I,this.sourceCaches,e,n,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(_)}querySourceFeatures(e,n){n&&n.filter&&this._validate(s.x.filter,"querySourceFeatures.filter",n.filter,null,n);const a=this.sourceCaches[e];return a?function(u,_){const I=u.getRenderableIds().map(R=>u.getTileByID(R)),k=[],z={};for(let R=0;R<I.length;R++){const V=I[R],G=V.tileID.canonical.key;z[G]||(z[G]=!0,V.querySourceFeatures(k,_))}return k}(a,n):[]}getLight(){return this.light.getLight()}setLight(e,n={}){this._checkLoaded();const a=this.light.getLight();let u=!1;for(const I in e)if(!s.aF(e[I],a[I])){u=!0;break}if(!u)return;const _={now:l.now(),transition:s.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(e,n),this.light.updateTransitions(_)}getSky(){var e;return(e=this.stylesheet)===null||e===void 0?void 0:e.sky}setSky(e,n={}){const a=this.sky.getSky();let u=!1;e||a&&(u=!0);for(const I in e)if(!s.aF(e[I],a[I])){u=!0;break}if(!u)return;const _={now:l.now(),transition:s.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=e,this.sky.setSky(e,n),this.sky.updateTransitions(_)}_validate(e,n,a,u,_={}){return(!_||_.validate!==!1)&&Ts(this,e.call(s.x,s.e({key:n,style:this.serialize(),value:a,styleSpec:s.v},u)))}_remove(e=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),nr().off(ce,this._rtlPluginLoaded);for(const n in this._layers)this._layers[n].setEventedParent(null);for(const n in this.sourceCaches){const a=this.sourceCaches[n];a.setEventedParent(null),a.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),e&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(e)}_clearSource(e){this.sourceCaches[e].clearTiles()}_reloadSource(e){this.sourceCaches[e].resume(),this.sourceCaches[e].reload()}_updateSources(e){for(const n in this.sourceCaches)this.sourceCaches[n].update(e,this.map.terrain)}_generateCollisionBoxes(){for(const e in this.sourceCaches)this._reloadSource(e)}_updatePlacement(e,n,a,u,_=!1){let I=!1,k=!1;const z={};for(const R of this._order){const V=this._layers[R];if(V.type!=="symbol")continue;if(!z[V.source]){const Y=this.sourceCaches[V.source];z[V.source]=Y.getRenderableIds(!0).map(tt=>Y.getTileByID(tt)).sort((tt,ot)=>ot.tileID.overscaledZ-tt.tileID.overscaledZ||(tt.tileID.isLessThan(ot.tileID)?-1:1))}const G=this.crossTileSymbolIndex.addLayer(V,z[V.source],e.center.lng);I=I||G}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((_=_||this._layerOrderChanged||a===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(l.now(),e.zoom))&&(this.pauseablePlacement=new sr(e,this.map.terrain,this._order,_,n,a,u,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,z),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(l.now()),k=!0),I&&this.pauseablePlacement.placement.setStale()),k||I)for(const R of this._order){const V=this._layers[R];V.type==="symbol"&&this.placement.updateLayerOpacities(V,z[V.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(l.now())}_releaseSymbolFadeTiles(){for(const e in this.sourceCaches)this.sourceCaches[e].releaseSymbolFadeTiles()}getImages(e,n){return s._(this,void 0,void 0,function*(){const a=yield this.imageManager.getImages(n.icons);this._updateTilesForChangedImages();const u=this.sourceCaches[n.source];return u&&u.setDependencies(n.tileID.key,n.type,n.icons),a})}getGlyphs(e,n){return s._(this,void 0,void 0,function*(){const a=yield this.glyphManager.getGlyphs(n.stacks),u=this.sourceCaches[n.source];return u&&u.setDependencies(n.tileID.key,n.type,[""]),a})}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(e,n={}){this._checkLoaded(),e&&this._validate(s.x.glyphs,"glyphs",e,null,n)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=e,this.glyphManager.entries={},this.glyphManager.setURL(e))}addSprite(e,n,a={},u){this._checkLoaded();const _=[{id:e,url:n}],I=[...Ft(this.stylesheet.sprite),..._];this._validate(s.x.sprite,"sprite",I,null,a)||(this.stylesheet.sprite=I,this._loadSprite(_,!0,u))}removeSprite(e){this._checkLoaded();const n=Ft(this.stylesheet.sprite);if(n.find(a=>a.id===e)){if(this._spritesImagesIds[e])for(const a of this._spritesImagesIds[e])this.imageManager.removeImage(a),this._changedImages[a]=!0;n.splice(n.findIndex(a=>a.id===e),1),this.stylesheet.sprite=n.length>0?n:void 0,delete this._spritesImagesIds[e],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new s.k("data",{dataType:"style"}))}else this.fire(new s.j(new Error(`Sprite "${e}" doesn't exists on this map.`)))}getSprite(){return Ft(this.stylesheet.sprite)}setSprite(e,n={},a){this._checkLoaded(),e&&this._validate(s.x.sprite,"sprite",e,null,n)||(this.stylesheet.sprite=e,e?this._loadSprite(e,!0,a):(this._unloadSprite(),a&&a(null)))}}var mo=s.Y([{name:"a_pos",type:"Int16",components:2}]);const hs={prelude:Bi(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture2D(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture2D(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}`),background:Bi(`uniform vec4 u_color;uniform float u_opacity;void main() {gl_FragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),backgroundPattern:Bi(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:Bi(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));gl_FragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);float ele=get_elevation(circle_center);v_visibility=calculate_visibility(u_matrix*vec4(circle_center,ele,1.0));if (u_pitch_with_map) {vec2 corner_position=circle_center;if (u_scale_with_map) {corner_position+=extrude*(radius+stroke_width)*u_extrude_scale;} else {vec4 projected_center=u_matrix*vec4(circle_center,0,1);corner_position+=extrude*(radius+stroke_width)*u_extrude_scale*(projected_center.w/u_camera_to_center_distance);}gl_Position=u_matrix*vec4(corner_position,ele,1);} else {gl_Position=u_matrix*vec4(circle_center,ele,1);if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:Bi("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Bi(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec4 pos=vec4(floor(a_pos*0.5)+extrude,0,1);gl_Position=u_matrix*pos;}`),heatmapTexture:Bi(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:Bi("varying float v_placed;varying float v_notUsed;void main() {float alpha=0.5;gl_FragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {gl_FragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {gl_FragColor*=.1;}}","attribute vec2 a_anchor_pos;attribute vec2 a_placed;attribute vec2 a_box_real;uniform mat4 u_matrix;uniform vec2 u_pixel_extrude_scale;varying float v_placed;varying float v_notUsed;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Bi("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Bi("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,get_elevation(a_pos),1);}"),fill:Bi(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_FragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);}`),fillOutline:Bi(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=outline_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillOutlinePattern:Bi(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillPattern:Bi(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:Bi(`varying vec4 v_color;void main() {gl_FragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t > 0.0 ? height : base,1);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:Bi(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);gl_FragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float z=t > 0.0 ? height : base;gl_Position=u_matrix*vec4(a_pos,z,1);vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:Bi(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Bi(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;
#define PI 3.141592653589793
void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;}"),line:Bi(`uniform lowp float u_device_pixel_ratio;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp float v_linesofar;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:Bi(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture2D(u_image,v_uv);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_uv_x;attribute float a_split_index;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:Bi(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);gl_FragColor=color*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:Bi(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture2D(u_image,v_tex_a).a;float sdfdist_b=texture2D(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}`),raster:Bi(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);gl_FragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos0=(((a_texture_pos/8192.0)-0.5)/u_buffer_scale )+0.5;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}"),symbolIcon:Bi(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;varying vec2 v_tex;varying float v_fade_opacity;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:Bi(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;varying vec2 v_data0;varying vec3 v_data1;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:Bi(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;varying vec4 v_data0;varying vec4 v_data1;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:Bi("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;varying vec2 v_texture_pos;varying float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture2D(u_texture,v_texture_pos);if (v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);gl_FragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {gl_FragColor=surface_color;}}","attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform mat4 u_fog_matrix;uniform float u_ele_delta;varying vec2 v_texture_pos;varying float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=u_matrix*vec4(a_pos3d.xy,ele-ele_delta,1.0);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:Bi("varying float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {gl_FragColor=pack(v_depth);}","attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform float u_ele_delta;varying float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=u_matrix*vec4(a_pos3d.xy,ele-ele_delta,1.0);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:Bi("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;varying vec2 v_texture_pos;void main() {vec4 rgba=texture2D(u_texture,v_texture_pos);gl_FragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform float u_ele_delta;varying vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=u_matrix*vec4(a_pos3d.xy,ele-ele_delta,1.0);}"),sky:Bi("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform float u_horizon;uniform float u_sky_horizon_blend;void main() {float y=gl_FragCoord.y;if (y > u_horizon) {float blend=y-u_horizon;if (blend < u_sky_horizon_blend) {gl_FragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {gl_FragColor=u_sky_color;}}}","attribute vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function Bi(y,e){const n=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,a=e.match(/attribute ([\w]+) ([\w]+)/g),u=y.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),_=e.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),I=_?_.concat(u):u,k={};return{fragmentSource:y=y.replace(n,(z,R,V,G,Y)=>(k[Y]=!0,R==="define"?`
#ifndef HAS_UNIFORM_u_${Y}
varying ${V} ${G} ${Y};
#else
uniform ${V} ${G} u_${Y};
#endif
`:`
#ifdef HAS_UNIFORM_u_${Y}
    ${V} ${G} ${Y} = u_${Y};
#endif
`)),vertexSource:e=e.replace(n,(z,R,V,G,Y)=>{const tt=G==="float"?"vec2":"vec4",ot=Y.match(/color/)?"color":tt;return k[Y]?R==="define"?`
#ifndef HAS_UNIFORM_u_${Y}
uniform lowp float u_${Y}_t;
attribute ${V} ${tt} a_${Y};
varying ${V} ${G} ${Y};
#else
uniform ${V} ${G} u_${Y};
#endif
`:ot==="vec4"?`
#ifndef HAS_UNIFORM_u_${Y}
    ${Y} = a_${Y};
#else
    ${V} ${G} ${Y} = u_${Y};
#endif
`:`
#ifndef HAS_UNIFORM_u_${Y}
    ${Y} = unpack_mix_${ot}(a_${Y}, u_${Y}_t);
#else
    ${V} ${G} ${Y} = u_${Y};
#endif
`:R==="define"?`
#ifndef HAS_UNIFORM_u_${Y}
uniform lowp float u_${Y}_t;
attribute ${V} ${tt} a_${Y};
#else
uniform ${V} ${G} u_${Y};
#endif
`:ot==="vec4"?`
#ifndef HAS_UNIFORM_u_${Y}
    ${V} ${G} ${Y} = a_${Y};
#else
    ${V} ${G} ${Y} = u_${Y};
#endif
`:`
#ifndef HAS_UNIFORM_u_${Y}
    ${V} ${G} ${Y} = unpack_mix_${ot}(a_${Y}, u_${Y}_t);
#else
    ${V} ${G} ${Y} = u_${Y};
#endif
`}),staticAttributes:a,staticUniforms:I}}class Es{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(e,n,a,u,_,I,k,z,R){this.context=e;let V=this.boundPaintVertexBuffers.length!==u.length;for(let G=0;!V&&G<u.length;G++)this.boundPaintVertexBuffers[G]!==u[G]&&(V=!0);!this.vao||this.boundProgram!==n||this.boundLayoutVertexBuffer!==a||V||this.boundIndexBuffer!==_||this.boundVertexOffset!==I||this.boundDynamicVertexBuffer!==k||this.boundDynamicVertexBuffer2!==z||this.boundDynamicVertexBuffer3!==R?this.freshBind(n,a,u,_,I,k,z,R):(e.bindVertexArray.set(this.vao),k&&k.bind(),_&&_.dynamicDraw&&_.bind(),z&&z.bind(),R&&R.bind())}freshBind(e,n,a,u,_,I,k,z){const R=e.numAttributes,V=this.context,G=V.gl;this.vao&&this.destroy(),this.vao=V.createVertexArray(),V.bindVertexArray.set(this.vao),this.boundProgram=e,this.boundLayoutVertexBuffer=n,this.boundPaintVertexBuffers=a,this.boundIndexBuffer=u,this.boundVertexOffset=_,this.boundDynamicVertexBuffer=I,this.boundDynamicVertexBuffer2=k,this.boundDynamicVertexBuffer3=z,n.enableAttributes(G,e);for(const Y of a)Y.enableAttributes(G,e);I&&I.enableAttributes(G,e),k&&k.enableAttributes(G,e),z&&z.enableAttributes(G,e),n.bind(),n.setVertexAttribPointers(G,e,_);for(const Y of a)Y.bind(),Y.setVertexAttribPointers(G,e,_);I&&(I.bind(),I.setVertexAttribPointers(G,e,_)),u&&u.bind(),k&&(k.bind(),k.setVertexAttribPointers(G,e,_)),z&&(z.bind(),z.setVertexAttribPointers(G,e,_)),V.currentNumAttributes=R}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}const P=(y,e,n,a,u)=>({u_matrix:y,u_texture:0,u_ele_delta:e,u_fog_matrix:n,u_fog_color:a?a.properties.get("fog-color"):s.aN.white,u_fog_ground_blend:a?a.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:a?a.calculateFogBlendOpacity(u):0,u_horizon_color:a?a.properties.get("horizon-color"):s.aN.white,u_horizon_fog_blend:a?a.properties.get("horizon-fog-blend"):1});function F(y){const e=[];for(let n=0;n<y.length;n++){if(y[n]===null)continue;const a=y[n].split(" ");e.push(a.pop())}return e}class K{constructor(e,n,a,u,_,I){const k=e.gl;this.program=k.createProgram();const z=F(n.staticAttributes),R=a?a.getBinderAttributes():[],V=z.concat(R),G=hs.prelude.staticUniforms?F(hs.prelude.staticUniforms):[],Y=n.staticUniforms?F(n.staticUniforms):[],tt=a?a.getBinderUniforms():[],ot=G.concat(Y).concat(tt),mt=[];for(const $t of ot)mt.indexOf($t)<0&&mt.push($t);const ut=a?a.defines():[];_&&ut.push("#define OVERDRAW_INSPECTOR;"),I&&ut.push("#define TERRAIN3D;");const bt=ut.concat(hs.prelude.fragmentSource,n.fragmentSource).join(`
`),Pt=ut.concat(hs.prelude.vertexSource,n.vertexSource).join(`
`),ht=k.createShader(k.FRAGMENT_SHADER);if(k.isContextLost())return void(this.failedToCreate=!0);if(k.shaderSource(ht,bt),k.compileShader(ht),!k.getShaderParameter(ht,k.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${k.getShaderInfoLog(ht)}`);k.attachShader(this.program,ht);const Dt=k.createShader(k.VERTEX_SHADER);if(k.isContextLost())return void(this.failedToCreate=!0);if(k.shaderSource(Dt,Pt),k.compileShader(Dt),!k.getShaderParameter(Dt,k.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${k.getShaderInfoLog(Dt)}`);k.attachShader(this.program,Dt),this.attributes={};const Ut={};this.numAttributes=V.length;for(let $t=0;$t<this.numAttributes;$t++)V[$t]&&(k.bindAttribLocation(this.program,$t,V[$t]),this.attributes[V[$t]]=$t);if(k.linkProgram(this.program),!k.getProgramParameter(this.program,k.LINK_STATUS))throw new Error(`Program failed to link: ${k.getProgramInfoLog(this.program)}`);k.deleteShader(Dt),k.deleteShader(ht);for(let $t=0;$t<mt.length;$t++){const _e=mt[$t];if(_e&&!Ut[_e]){const Ce=k.getUniformLocation(this.program,_e);Ce&&(Ut[_e]=Ce)}}this.fixedUniforms=u(e,Ut),this.terrainUniforms=(($t,_e)=>({u_depth:new s.aI($t,_e.u_depth),u_terrain:new s.aI($t,_e.u_terrain),u_terrain_dim:new s.aJ($t,_e.u_terrain_dim),u_terrain_matrix:new s.aK($t,_e.u_terrain_matrix),u_terrain_unpack:new s.aL($t,_e.u_terrain_unpack),u_terrain_exaggeration:new s.aJ($t,_e.u_terrain_exaggeration)}))(e,Ut),this.binderUniforms=a?a.getUniforms(e,Ut):[]}draw(e,n,a,u,_,I,k,z,R,V,G,Y,tt,ot,mt,ut,bt,Pt){const ht=e.gl;if(this.failedToCreate)return;if(e.program.set(this.program),e.setDepthMode(a),e.setStencilMode(u),e.setColorMode(_),e.setCullFace(I),z){e.activeTexture.set(ht.TEXTURE2),ht.bindTexture(ht.TEXTURE_2D,z.depthTexture),e.activeTexture.set(ht.TEXTURE3),ht.bindTexture(ht.TEXTURE_2D,z.texture);for(const Ut in this.terrainUniforms)this.terrainUniforms[Ut].set(z[Ut])}for(const Ut in this.fixedUniforms)this.fixedUniforms[Ut].set(k[Ut]);mt&&mt.setUniforms(e,this.binderUniforms,tt,{zoom:ot});let Dt=0;switch(n){case ht.LINES:Dt=2;break;case ht.TRIANGLES:Dt=3;break;case ht.LINE_STRIP:Dt=1}for(const Ut of Y.get()){const $t=Ut.vaos||(Ut.vaos={});($t[R]||($t[R]=new Es)).bind(e,this,V,mt?mt.getPaintVertexBuffers():[],G,Ut.vertexOffset,ut,bt,Pt),ht.drawElements(n,Ut.primitiveLength*Dt,ht.UNSIGNED_SHORT,Ut.primitiveOffset*Dt*2)}}}function yt(y,e,n){const a=1/gi(n,1,e.transform.tileZoom),u=Math.pow(2,n.tileID.overscaledZ),_=n.tileSize*Math.pow(2,e.transform.tileZoom)/u,I=_*(n.tileID.canonical.x+n.tileID.wrap*u),k=_*n.tileID.canonical.y;return{u_image:0,u_texsize:n.imageAtlasTexture.size,u_scale:[a,y.fromScale,y.toScale],u_fade:y.t,u_pixel_coord_upper:[I>>16,k>>16],u_pixel_coord_lower:[65535&I,65535&k]}}const Tt=(y,e,n,a)=>{const u=e.style.light,_=u.properties.get("position"),I=[_.x,_.y,_.z],k=function(){var R=new s.A(9);return s.A!=Float32Array&&(R[1]=0,R[2]=0,R[3]=0,R[5]=0,R[6]=0,R[7]=0),R[0]=1,R[4]=1,R[8]=1,R}();u.properties.get("anchor")==="viewport"&&function(R,V){var G=Math.sin(V),Y=Math.cos(V);R[0]=Y,R[1]=G,R[2]=0,R[3]=-G,R[4]=Y,R[5]=0,R[6]=0,R[7]=0,R[8]=1}(k,-e.transform.angle),function(R,V,G){var Y=V[0],tt=V[1],ot=V[2];R[0]=Y*G[0]+tt*G[3]+ot*G[6],R[1]=Y*G[1]+tt*G[4]+ot*G[7],R[2]=Y*G[2]+tt*G[5]+ot*G[8]}(I,I,k);const z=u.properties.get("color");return{u_matrix:y,u_lightpos:I,u_lightintensity:u.properties.get("intensity"),u_lightcolor:[z.r,z.g,z.b],u_vertical_gradient:+n,u_opacity:a}},kt=(y,e,n,a,u,_,I)=>s.e(Tt(y,e,n,a),yt(_,e,I),{u_height_factor:-Math.pow(2,u.overscaledZ)/I.tileSize/8}),Rt=y=>({u_matrix:y}),xe=(y,e,n,a)=>s.e(Rt(y),yt(n,e,a)),Ie=(y,e)=>({u_matrix:y,u_world:e}),Ne=(y,e,n,a,u)=>s.e(xe(y,e,n,a),{u_world:u}),je=(y,e,n,a)=>{const u=y.transform;let _,I;if(a.paint.get("circle-pitch-alignment")==="map"){const k=gi(n,1,u.zoom);_=!0,I=[k,k]}else _=!1,I=u.pixelsToGLUnits;return{u_camera_to_center_distance:u.cameraToCenterDistance,u_scale_with_map:+(a.paint.get("circle-pitch-scale")==="map"),u_matrix:y.translatePosMatrix(e.posMatrix,n,a.paint.get("circle-translate"),a.paint.get("circle-translate-anchor")),u_pitch_with_map:+_,u_device_pixel_ratio:y.pixelRatio,u_extrude_scale:I}},De=(y,e,n)=>({u_matrix:y,u_inv_matrix:e,u_camera_to_center_distance:n.cameraToCenterDistance,u_viewport_size:[n.width,n.height]}),pi=(y,e,n=1)=>({u_matrix:y,u_color:e,u_overlay:0,u_overlay_scale:n}),er=y=>({u_matrix:y}),di=(y,e,n,a)=>({u_matrix:y,u_extrude_scale:gi(e,1,n),u_intensity:a});function Ni(y,e){const n=Math.pow(2,e.canonical.z),a=e.canonical.y;return[new s.Z(0,a/n).toLngLat().lat,new s.Z(0,(a+1)/n).toLngLat().lat]}const ge=(y,e,n,a)=>{const u=y.transform;return{u_matrix:Vo(y,e,n,a),u_ratio:1/gi(e,1,u.zoom),u_device_pixel_ratio:y.pixelRatio,u_units_to_pixels:[1/u.pixelsToGLUnits[0],1/u.pixelsToGLUnits[1]]}},ri=(y,e,n,a,u)=>s.e(ge(y,e,n,u),{u_image:0,u_image_height:a}),qi=(y,e,n,a,u)=>{const _=y.transform,I=or(e,_);return{u_matrix:Vo(y,e,n,u),u_texsize:e.imageAtlasTexture.size,u_ratio:1/gi(e,1,_.zoom),u_device_pixel_ratio:y.pixelRatio,u_image:0,u_scale:[I,a.fromScale,a.toScale],u_fade:a.t,u_units_to_pixels:[1/_.pixelsToGLUnits[0],1/_.pixelsToGLUnits[1]]}},zr=(y,e,n,a,u,_)=>{const I=y.lineAtlas,k=or(e,y.transform),z=n.layout.get("line-cap")==="round",R=I.getDash(a.from,z),V=I.getDash(a.to,z),G=R.width*u.fromScale,Y=V.width*u.toScale;return s.e(ge(y,e,n,_),{u_patternscale_a:[k/G,-R.height/2],u_patternscale_b:[k/Y,-V.height/2],u_sdfgamma:I.width/(256*Math.min(G,Y)*y.pixelRatio)/2,u_image:0,u_tex_y_a:R.y,u_tex_y_b:V.y,u_mix:u.t})};function or(y,e){return 1/gi(y,1,e.tileZoom)}function Vo(y,e,n,a){return y.translatePosMatrix(a?a.posMatrix:e.tileID.posMatrix,e,n.paint.get("line-translate"),n.paint.get("line-translate-anchor"))}const El=(y,e,n,a,u)=>{return{u_matrix:y,u_tl_parent:e,u_scale_parent:n,u_buffer_scale:1,u_fade_t:a.mix,u_opacity:a.opacity*u.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:u.paint.get("raster-brightness-min"),u_brightness_high:u.paint.get("raster-brightness-max"),u_saturation_factor:(I=u.paint.get("raster-saturation"),I>0?1-1/(1.001-I):-I),u_contrast_factor:(_=u.paint.get("raster-contrast"),_>0?1/(1-_):1+_),u_spin_weights:dr(u.paint.get("raster-hue-rotate"))};var _,I};function dr(y){y*=Math.PI/180;const e=Math.sin(y),n=Math.cos(y);return[(2*n+1)/3,(-Math.sqrt(3)*e-n+1)/3,(Math.sqrt(3)*e-n+1)/3]}const ya=(y,e,n,a,u,_,I,k,z,R,V,G,Y,tt)=>{const ot=I.transform;return{u_is_size_zoom_constant:+(y==="constant"||y==="source"),u_is_size_feature_constant:+(y==="constant"||y==="camera"),u_size_t:e?e.uSizeT:0,u_size:e?e.uSize:0,u_camera_to_center_distance:ot.cameraToCenterDistance,u_pitch:ot.pitch/360*2*Math.PI,u_rotate_symbol:+n,u_aspect_ratio:ot.width/ot.height,u_fade_change:I.options.fadeDuration?I.symbolFadeChange:1,u_matrix:k,u_label_plane_matrix:z,u_coord_matrix:R,u_is_text:+G,u_pitch_with_map:+a,u_is_along_line:u,u_is_variable_anchor:_,u_texsize:Y,u_texture:0,u_translation:V,u_pitched_scale:tt}},Ka=(y,e,n,a,u,_,I,k,z,R,V,G,Y,tt,ot)=>{const mt=I.transform;return s.e(ya(y,e,n,a,u,_,I,k,z,R,V,G,Y,ot),{u_gamma_scale:a?Math.cos(mt._pitch)*mt.cameraToCenterDistance:1,u_device_pixel_ratio:I.pixelRatio,u_is_halo:+tt})},Yn=(y,e,n,a,u,_,I,k,z,R,V,G,Y,tt)=>s.e(Ka(y,e,n,a,u,_,I,k,z,R,V,!0,G,!0,tt),{u_texsize_icon:Y,u_texture_icon:1}),go=(y,e,n)=>({u_matrix:y,u_opacity:e,u_color:n}),Uo=(y,e,n,a,u,_)=>s.e(function(I,k,z,R){const V=z.imageManager.getPattern(I.from.toString()),G=z.imageManager.getPattern(I.to.toString()),{width:Y,height:tt}=z.imageManager.getPixelSize(),ot=Math.pow(2,R.tileID.overscaledZ),mt=R.tileSize*Math.pow(2,z.transform.tileZoom)/ot,ut=mt*(R.tileID.canonical.x+R.tileID.wrap*ot),bt=mt*R.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:V.tl,u_pattern_br_a:V.br,u_pattern_tl_b:G.tl,u_pattern_br_b:G.br,u_texsize:[Y,tt],u_mix:k.t,u_pattern_size_a:V.displaySize,u_pattern_size_b:G.displaySize,u_scale_a:k.fromScale,u_scale_b:k.toScale,u_tile_units_to_pixels:1/gi(R,1,z.transform.tileZoom),u_pixel_coord_upper:[ut>>16,bt>>16],u_pixel_coord_lower:[65535&ut,65535&bt]}}(a,_,n,u),{u_matrix:y,u_opacity:e}),_o={fillExtrusion:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_lightpos:new s.aO(y,e.u_lightpos),u_lightintensity:new s.aJ(y,e.u_lightintensity),u_lightcolor:new s.aO(y,e.u_lightcolor),u_vertical_gradient:new s.aJ(y,e.u_vertical_gradient),u_opacity:new s.aJ(y,e.u_opacity)}),fillExtrusionPattern:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_lightpos:new s.aO(y,e.u_lightpos),u_lightintensity:new s.aJ(y,e.u_lightintensity),u_lightcolor:new s.aO(y,e.u_lightcolor),u_vertical_gradient:new s.aJ(y,e.u_vertical_gradient),u_height_factor:new s.aJ(y,e.u_height_factor),u_image:new s.aI(y,e.u_image),u_texsize:new s.aP(y,e.u_texsize),u_pixel_coord_upper:new s.aP(y,e.u_pixel_coord_upper),u_pixel_coord_lower:new s.aP(y,e.u_pixel_coord_lower),u_scale:new s.aO(y,e.u_scale),u_fade:new s.aJ(y,e.u_fade),u_opacity:new s.aJ(y,e.u_opacity)}),fill:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix)}),fillPattern:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_image:new s.aI(y,e.u_image),u_texsize:new s.aP(y,e.u_texsize),u_pixel_coord_upper:new s.aP(y,e.u_pixel_coord_upper),u_pixel_coord_lower:new s.aP(y,e.u_pixel_coord_lower),u_scale:new s.aO(y,e.u_scale),u_fade:new s.aJ(y,e.u_fade)}),fillOutline:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_world:new s.aP(y,e.u_world)}),fillOutlinePattern:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_world:new s.aP(y,e.u_world),u_image:new s.aI(y,e.u_image),u_texsize:new s.aP(y,e.u_texsize),u_pixel_coord_upper:new s.aP(y,e.u_pixel_coord_upper),u_pixel_coord_lower:new s.aP(y,e.u_pixel_coord_lower),u_scale:new s.aO(y,e.u_scale),u_fade:new s.aJ(y,e.u_fade)}),circle:(y,e)=>({u_camera_to_center_distance:new s.aJ(y,e.u_camera_to_center_distance),u_scale_with_map:new s.aI(y,e.u_scale_with_map),u_pitch_with_map:new s.aI(y,e.u_pitch_with_map),u_extrude_scale:new s.aP(y,e.u_extrude_scale),u_device_pixel_ratio:new s.aJ(y,e.u_device_pixel_ratio),u_matrix:new s.aK(y,e.u_matrix)}),collisionBox:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_pixel_extrude_scale:new s.aP(y,e.u_pixel_extrude_scale)}),collisionCircle:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_inv_matrix:new s.aK(y,e.u_inv_matrix),u_camera_to_center_distance:new s.aJ(y,e.u_camera_to_center_distance),u_viewport_size:new s.aP(y,e.u_viewport_size)}),debug:(y,e)=>({u_color:new s.aM(y,e.u_color),u_matrix:new s.aK(y,e.u_matrix),u_overlay:new s.aI(y,e.u_overlay),u_overlay_scale:new s.aJ(y,e.u_overlay_scale)}),clippingMask:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix)}),heatmap:(y,e)=>({u_extrude_scale:new s.aJ(y,e.u_extrude_scale),u_intensity:new s.aJ(y,e.u_intensity),u_matrix:new s.aK(y,e.u_matrix)}),heatmapTexture:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_world:new s.aP(y,e.u_world),u_image:new s.aI(y,e.u_image),u_color_ramp:new s.aI(y,e.u_color_ramp),u_opacity:new s.aJ(y,e.u_opacity)}),hillshade:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_image:new s.aI(y,e.u_image),u_latrange:new s.aP(y,e.u_latrange),u_light:new s.aP(y,e.u_light),u_shadow:new s.aM(y,e.u_shadow),u_highlight:new s.aM(y,e.u_highlight),u_accent:new s.aM(y,e.u_accent)}),hillshadePrepare:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_image:new s.aI(y,e.u_image),u_dimension:new s.aP(y,e.u_dimension),u_zoom:new s.aJ(y,e.u_zoom),u_unpack:new s.aL(y,e.u_unpack)}),line:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_ratio:new s.aJ(y,e.u_ratio),u_device_pixel_ratio:new s.aJ(y,e.u_device_pixel_ratio),u_units_to_pixels:new s.aP(y,e.u_units_to_pixels)}),lineGradient:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_ratio:new s.aJ(y,e.u_ratio),u_device_pixel_ratio:new s.aJ(y,e.u_device_pixel_ratio),u_units_to_pixels:new s.aP(y,e.u_units_to_pixels),u_image:new s.aI(y,e.u_image),u_image_height:new s.aJ(y,e.u_image_height)}),linePattern:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_texsize:new s.aP(y,e.u_texsize),u_ratio:new s.aJ(y,e.u_ratio),u_device_pixel_ratio:new s.aJ(y,e.u_device_pixel_ratio),u_image:new s.aI(y,e.u_image),u_units_to_pixels:new s.aP(y,e.u_units_to_pixels),u_scale:new s.aO(y,e.u_scale),u_fade:new s.aJ(y,e.u_fade)}),lineSDF:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_ratio:new s.aJ(y,e.u_ratio),u_device_pixel_ratio:new s.aJ(y,e.u_device_pixel_ratio),u_units_to_pixels:new s.aP(y,e.u_units_to_pixels),u_patternscale_a:new s.aP(y,e.u_patternscale_a),u_patternscale_b:new s.aP(y,e.u_patternscale_b),u_sdfgamma:new s.aJ(y,e.u_sdfgamma),u_image:new s.aI(y,e.u_image),u_tex_y_a:new s.aJ(y,e.u_tex_y_a),u_tex_y_b:new s.aJ(y,e.u_tex_y_b),u_mix:new s.aJ(y,e.u_mix)}),raster:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_tl_parent:new s.aP(y,e.u_tl_parent),u_scale_parent:new s.aJ(y,e.u_scale_parent),u_buffer_scale:new s.aJ(y,e.u_buffer_scale),u_fade_t:new s.aJ(y,e.u_fade_t),u_opacity:new s.aJ(y,e.u_opacity),u_image0:new s.aI(y,e.u_image0),u_image1:new s.aI(y,e.u_image1),u_brightness_low:new s.aJ(y,e.u_brightness_low),u_brightness_high:new s.aJ(y,e.u_brightness_high),u_saturation_factor:new s.aJ(y,e.u_saturation_factor),u_contrast_factor:new s.aJ(y,e.u_contrast_factor),u_spin_weights:new s.aO(y,e.u_spin_weights)}),symbolIcon:(y,e)=>({u_is_size_zoom_constant:new s.aI(y,e.u_is_size_zoom_constant),u_is_size_feature_constant:new s.aI(y,e.u_is_size_feature_constant),u_size_t:new s.aJ(y,e.u_size_t),u_size:new s.aJ(y,e.u_size),u_camera_to_center_distance:new s.aJ(y,e.u_camera_to_center_distance),u_pitch:new s.aJ(y,e.u_pitch),u_rotate_symbol:new s.aI(y,e.u_rotate_symbol),u_aspect_ratio:new s.aJ(y,e.u_aspect_ratio),u_fade_change:new s.aJ(y,e.u_fade_change),u_matrix:new s.aK(y,e.u_matrix),u_label_plane_matrix:new s.aK(y,e.u_label_plane_matrix),u_coord_matrix:new s.aK(y,e.u_coord_matrix),u_is_text:new s.aI(y,e.u_is_text),u_pitch_with_map:new s.aI(y,e.u_pitch_with_map),u_is_along_line:new s.aI(y,e.u_is_along_line),u_is_variable_anchor:new s.aI(y,e.u_is_variable_anchor),u_texsize:new s.aP(y,e.u_texsize),u_texture:new s.aI(y,e.u_texture),u_translation:new s.aP(y,e.u_translation),u_pitched_scale:new s.aJ(y,e.u_pitched_scale)}),symbolSDF:(y,e)=>({u_is_size_zoom_constant:new s.aI(y,e.u_is_size_zoom_constant),u_is_size_feature_constant:new s.aI(y,e.u_is_size_feature_constant),u_size_t:new s.aJ(y,e.u_size_t),u_size:new s.aJ(y,e.u_size),u_camera_to_center_distance:new s.aJ(y,e.u_camera_to_center_distance),u_pitch:new s.aJ(y,e.u_pitch),u_rotate_symbol:new s.aI(y,e.u_rotate_symbol),u_aspect_ratio:new s.aJ(y,e.u_aspect_ratio),u_fade_change:new s.aJ(y,e.u_fade_change),u_matrix:new s.aK(y,e.u_matrix),u_label_plane_matrix:new s.aK(y,e.u_label_plane_matrix),u_coord_matrix:new s.aK(y,e.u_coord_matrix),u_is_text:new s.aI(y,e.u_is_text),u_pitch_with_map:new s.aI(y,e.u_pitch_with_map),u_is_along_line:new s.aI(y,e.u_is_along_line),u_is_variable_anchor:new s.aI(y,e.u_is_variable_anchor),u_texsize:new s.aP(y,e.u_texsize),u_texture:new s.aI(y,e.u_texture),u_gamma_scale:new s.aJ(y,e.u_gamma_scale),u_device_pixel_ratio:new s.aJ(y,e.u_device_pixel_ratio),u_is_halo:new s.aI(y,e.u_is_halo),u_translation:new s.aP(y,e.u_translation),u_pitched_scale:new s.aJ(y,e.u_pitched_scale)}),symbolTextAndIcon:(y,e)=>({u_is_size_zoom_constant:new s.aI(y,e.u_is_size_zoom_constant),u_is_size_feature_constant:new s.aI(y,e.u_is_size_feature_constant),u_size_t:new s.aJ(y,e.u_size_t),u_size:new s.aJ(y,e.u_size),u_camera_to_center_distance:new s.aJ(y,e.u_camera_to_center_distance),u_pitch:new s.aJ(y,e.u_pitch),u_rotate_symbol:new s.aI(y,e.u_rotate_symbol),u_aspect_ratio:new s.aJ(y,e.u_aspect_ratio),u_fade_change:new s.aJ(y,e.u_fade_change),u_matrix:new s.aK(y,e.u_matrix),u_label_plane_matrix:new s.aK(y,e.u_label_plane_matrix),u_coord_matrix:new s.aK(y,e.u_coord_matrix),u_is_text:new s.aI(y,e.u_is_text),u_pitch_with_map:new s.aI(y,e.u_pitch_with_map),u_is_along_line:new s.aI(y,e.u_is_along_line),u_is_variable_anchor:new s.aI(y,e.u_is_variable_anchor),u_texsize:new s.aP(y,e.u_texsize),u_texsize_icon:new s.aP(y,e.u_texsize_icon),u_texture:new s.aI(y,e.u_texture),u_texture_icon:new s.aI(y,e.u_texture_icon),u_gamma_scale:new s.aJ(y,e.u_gamma_scale),u_device_pixel_ratio:new s.aJ(y,e.u_device_pixel_ratio),u_is_halo:new s.aI(y,e.u_is_halo),u_translation:new s.aP(y,e.u_translation),u_pitched_scale:new s.aJ(y,e.u_pitched_scale)}),background:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_opacity:new s.aJ(y,e.u_opacity),u_color:new s.aM(y,e.u_color)}),backgroundPattern:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_opacity:new s.aJ(y,e.u_opacity),u_image:new s.aI(y,e.u_image),u_pattern_tl_a:new s.aP(y,e.u_pattern_tl_a),u_pattern_br_a:new s.aP(y,e.u_pattern_br_a),u_pattern_tl_b:new s.aP(y,e.u_pattern_tl_b),u_pattern_br_b:new s.aP(y,e.u_pattern_br_b),u_texsize:new s.aP(y,e.u_texsize),u_mix:new s.aJ(y,e.u_mix),u_pattern_size_a:new s.aP(y,e.u_pattern_size_a),u_pattern_size_b:new s.aP(y,e.u_pattern_size_b),u_scale_a:new s.aJ(y,e.u_scale_a),u_scale_b:new s.aJ(y,e.u_scale_b),u_pixel_coord_upper:new s.aP(y,e.u_pixel_coord_upper),u_pixel_coord_lower:new s.aP(y,e.u_pixel_coord_lower),u_tile_units_to_pixels:new s.aJ(y,e.u_tile_units_to_pixels)}),terrain:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_texture:new s.aI(y,e.u_texture),u_ele_delta:new s.aJ(y,e.u_ele_delta),u_fog_matrix:new s.aK(y,e.u_fog_matrix),u_fog_color:new s.aM(y,e.u_fog_color),u_fog_ground_blend:new s.aJ(y,e.u_fog_ground_blend),u_fog_ground_blend_opacity:new s.aJ(y,e.u_fog_ground_blend_opacity),u_horizon_color:new s.aM(y,e.u_horizon_color),u_horizon_fog_blend:new s.aJ(y,e.u_horizon_fog_blend)}),terrainDepth:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_ele_delta:new s.aJ(y,e.u_ele_delta)}),terrainCoords:(y,e)=>({u_matrix:new s.aK(y,e.u_matrix),u_texture:new s.aI(y,e.u_texture),u_terrain_coords_id:new s.aJ(y,e.u_terrain_coords_id),u_ele_delta:new s.aJ(y,e.u_ele_delta)}),sky:(y,e)=>({u_sky_color:new s.aM(y,e.u_sky_color),u_horizon_color:new s.aM(y,e.u_horizon_color),u_horizon:new s.aJ(y,e.u_horizon),u_sky_horizon_blend:new s.aJ(y,e.u_sky_horizon_blend)})};class yo{constructor(e,n,a){this.context=e;const u=e.gl;this.buffer=u.createBuffer(),this.dynamicDraw=!!a,this.context.unbindVAO(),e.bindElementBuffer.set(this.buffer),u.bufferData(u.ELEMENT_ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?u.DYNAMIC_DRAW:u.STATIC_DRAW),this.dynamicDraw||delete n.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(e){const n=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,0,e.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Go={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class kn{constructor(e,n,a,u){this.length=n.length,this.attributes=a,this.itemSize=n.bytesPerElement,this.dynamicDraw=u,this.context=e;const _=e.gl;this.buffer=_.createBuffer(),e.bindVertexBuffer.set(this.buffer),_.bufferData(_.ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?_.DYNAMIC_DRAW:_.STATIC_DRAW),this.dynamicDraw||delete n.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(e){if(e.length!==this.length)throw new Error(`Length of new data is ${e.length}, which doesn't match current length of ${this.length}`);const n=this.context.gl;this.bind(),n.bufferSubData(n.ARRAY_BUFFER,0,e.arrayBuffer)}enableAttributes(e,n){for(let a=0;a<this.attributes.length;a++){const u=n.attributes[this.attributes[a].name];u!==void 0&&e.enableVertexAttribArray(u)}}setVertexAttribPointers(e,n,a){for(let u=0;u<this.attributes.length;u++){const _=this.attributes[u],I=n.attributes[_.name];I!==void 0&&e.vertexAttribPointer(I,_.components,e[Go[_.type]],!1,this.itemSize,_.offset+this.itemSize*(a||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const va=new WeakMap;function js(y){var e;if(va.has(y))return va.get(y);{const n=(e=y.getParameter(y.VERSION))===null||e===void 0?void 0:e.startsWith("WebGL 2.0");return va.set(y,n),n}}class Li{constructor(e){this.gl=e.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(e){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Ns extends Li{getDefault(){return s.aN.transparent}set(e){const n=this.current;(e.r!==n.r||e.g!==n.g||e.b!==n.b||e.a!==n.a||this.dirty)&&(this.gl.clearColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class Ja extends Li{getDefault(){return 1}set(e){(e!==this.current||this.dirty)&&(this.gl.clearDepth(e),this.current=e,this.dirty=!1)}}class vo extends Li{getDefault(){return 0}set(e){(e!==this.current||this.dirty)&&(this.gl.clearStencil(e),this.current=e,this.dirty=!1)}}class Pl extends Li{getDefault(){return[!0,!0,!0,!0]}set(e){const n=this.current;(e[0]!==n[0]||e[1]!==n[1]||e[2]!==n[2]||e[3]!==n[3]||this.dirty)&&(this.gl.colorMask(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class Vs extends Li{getDefault(){return!0}set(e){(e!==this.current||this.dirty)&&(this.gl.depthMask(e),this.current=e,this.dirty=!1)}}class Xo extends Li{getDefault(){return 255}set(e){(e!==this.current||this.dirty)&&(this.gl.stencilMask(e),this.current=e,this.dirty=!1)}}class Wo extends Li{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(e){const n=this.current;(e.func!==n.func||e.ref!==n.ref||e.mask!==n.mask||this.dirty)&&(this.gl.stencilFunc(e.func,e.ref,e.mask),this.current=e,this.dirty=!1)}}class Qa extends Li{getDefault(){const e=this.gl;return[e.KEEP,e.KEEP,e.KEEP]}set(e){const n=this.current;(e[0]!==n[0]||e[1]!==n[1]||e[2]!==n[2]||this.dirty)&&(this.gl.stencilOp(e[0],e[1],e[2]),this.current=e,this.dirty=!1)}}class On extends Li{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const n=this.gl;e?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.current=e,this.dirty=!1}}class Ho extends Li{getDefault(){return[0,1]}set(e){const n=this.current;(e[0]!==n[0]||e[1]!==n[1]||this.dirty)&&(this.gl.depthRange(e[0],e[1]),this.current=e,this.dirty=!1)}}class xa extends Li{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const n=this.gl;e?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.current=e,this.dirty=!1}}class tl extends Li{getDefault(){return this.gl.LESS}set(e){(e!==this.current||this.dirty)&&(this.gl.depthFunc(e),this.current=e,this.dirty=!1)}}class ba extends Li{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const n=this.gl;e?n.enable(n.BLEND):n.disable(n.BLEND),this.current=e,this.dirty=!1}}class xo extends Li{getDefault(){const e=this.gl;return[e.ONE,e.ZERO]}set(e){const n=this.current;(e[0]!==n[0]||e[1]!==n[1]||this.dirty)&&(this.gl.blendFunc(e[0],e[1]),this.current=e,this.dirty=!1)}}class us extends Li{getDefault(){return s.aN.transparent}set(e){const n=this.current;(e.r!==n.r||e.g!==n.g||e.b!==n.b||e.a!==n.a||this.dirty)&&(this.gl.blendColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class wa extends Li{getDefault(){return this.gl.FUNC_ADD}set(e){(e!==this.current||this.dirty)&&(this.gl.blendEquation(e),this.current=e,this.dirty=!1)}}class Il extends Li{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const n=this.gl;e?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this.current=e,this.dirty=!1}}class Ps extends Li{getDefault(){return this.gl.BACK}set(e){(e!==this.current||this.dirty)&&(this.gl.cullFace(e),this.current=e,this.dirty=!1)}}class Ca extends Li{getDefault(){return this.gl.CCW}set(e){(e!==this.current||this.dirty)&&(this.gl.frontFace(e),this.current=e,this.dirty=!1)}}class bo extends Li{getDefault(){return null}set(e){(e!==this.current||this.dirty)&&(this.gl.useProgram(e),this.current=e,this.dirty=!1)}}class Al extends Li{getDefault(){return this.gl.TEXTURE0}set(e){(e!==this.current||this.dirty)&&(this.gl.activeTexture(e),this.current=e,this.dirty=!1)}}class Us extends Li{getDefault(){const e=this.gl;return[0,0,e.drawingBufferWidth,e.drawingBufferHeight]}set(e){const n=this.current;(e[0]!==n[0]||e[1]!==n[1]||e[2]!==n[2]||e[3]!==n[3]||this.dirty)&&(this.gl.viewport(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class wo extends Li{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,e),this.current=e,this.dirty=!1}}class Sa extends Li{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class qo extends Li{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const n=this.gl;n.bindTexture(n.TEXTURE_2D,e),this.current=e,this.dirty=!1}}class $o extends Li{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class Gs extends Li{getDefault(){return null}set(e){const n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class Ta extends Li{getDefault(){return null}set(e){var n;if(e===this.current&&!this.dirty)return;const a=this.gl;js(a)?a.bindVertexArray(e):(n=a.getExtension("OES_vertex_array_object"))===null||n===void 0||n.bindVertexArrayOES(e),this.current=e,this.dirty=!1}}class el extends Li{getDefault(){return 4}set(e){if(e===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_ALIGNMENT,e),this.current=e,this.dirty=!1}}class Yo extends Li{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e),this.current=e,this.dirty=!1}}class Zn extends Li{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,e),this.current=e,this.dirty=!1}}class Co extends Li{constructor(e,n){super(e),this.context=e,this.parent=n}getDefault(){return null}}class Zo extends Co{setDirty(){this.dirty=!0}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class So extends Co{set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class ds extends Co{set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class Dn{constructor(e,n,a,u,_){this.context=e,this.width=n,this.height=a;const I=e.gl,k=this.framebuffer=I.createFramebuffer();if(this.colorAttachment=new Zo(e,k),u)this.depthAttachment=_?new ds(e,k):new So(e,k);else if(_)throw new Error("Stencil cannot be set without depth");if(I.checkFramebufferStatus(I.FRAMEBUFFER)!==I.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer is not complete")}destroy(){const e=this.context.gl,n=this.colorAttachment.get();if(n&&e.deleteTexture(n),this.depthAttachment){const a=this.depthAttachment.get();a&&e.deleteRenderbuffer(a)}e.deleteFramebuffer(this.framebuffer)}}class ji{constructor(e,n,a){this.blendFunction=e,this.blendColor=n,this.mask=a}}ji.Replace=[1,0],ji.disabled=new ji(ji.Replace,s.aN.transparent,[!1,!1,!1,!1]),ji.unblended=new ji(ji.Replace,s.aN.transparent,[!0,!0,!0,!0]),ji.alphaBlended=new ji([1,771],s.aN.transparent,[!0,!0,!0,!0]);class Xs{constructor(e){var n,a;if(this.gl=e,this.clearColor=new Ns(this),this.clearDepth=new Ja(this),this.clearStencil=new vo(this),this.colorMask=new Pl(this),this.depthMask=new Vs(this),this.stencilMask=new Xo(this),this.stencilFunc=new Wo(this),this.stencilOp=new Qa(this),this.stencilTest=new On(this),this.depthRange=new Ho(this),this.depthTest=new xa(this),this.depthFunc=new tl(this),this.blend=new ba(this),this.blendFunc=new xo(this),this.blendColor=new us(this),this.blendEquation=new wa(this),this.cullFace=new Il(this),this.cullFaceSide=new Ps(this),this.frontFace=new Ca(this),this.program=new bo(this),this.activeTexture=new Al(this),this.viewport=new Us(this),this.bindFramebuffer=new wo(this),this.bindRenderbuffer=new Sa(this),this.bindTexture=new qo(this),this.bindVertexBuffer=new $o(this),this.bindElementBuffer=new Gs(this),this.bindVertexArray=new Ta(this),this.pixelStoreUnpack=new el(this),this.pixelStoreUnpackPremultiplyAlpha=new Yo(this),this.pixelStoreUnpackFlipY=new Zn(this),this.extTextureFilterAnisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=e.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),js(e)){this.HALF_FLOAT=e.HALF_FLOAT;const u=e.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(n=e.RGBA16F)!==null&&n!==void 0?n:u==null?void 0:u.RGBA16F_EXT,this.RGB16F=(a=e.RGB16F)!==null&&a!==void 0?a:u==null?void 0:u.RGB16F_EXT,e.getExtension("EXT_color_buffer_float")}else{e.getExtension("EXT_color_buffer_half_float"),e.getExtension("OES_texture_half_float_linear");const u=e.getExtension("OES_texture_half_float");this.HALF_FLOAT=u==null?void 0:u.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(e,n){return new yo(this,e,n)}createVertexBuffer(e,n,a){return new kn(this,e,n,a)}createRenderbuffer(e,n,a){const u=this.gl,_=u.createRenderbuffer();return this.bindRenderbuffer.set(_),u.renderbufferStorage(u.RENDERBUFFER,e,n,a),this.bindRenderbuffer.set(null),_}createFramebuffer(e,n,a,u){return new Dn(this,e,n,a,u)}clear({color:e,depth:n,stencil:a}){const u=this.gl;let _=0;e&&(_|=u.COLOR_BUFFER_BIT,this.clearColor.set(e),this.colorMask.set([!0,!0,!0,!0])),n!==void 0&&(_|=u.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(n),this.depthMask.set(!0)),a!==void 0&&(_|=u.STENCIL_BUFFER_BIT,this.clearStencil.set(a),this.stencilMask.set(255)),u.clear(_)}setCullFace(e){e.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(e.mode),this.frontFace.set(e.frontFace))}setDepthMode(e){e.func!==this.gl.ALWAYS||e.mask?(this.depthTest.set(!0),this.depthFunc.set(e.func),this.depthMask.set(e.mask),this.depthRange.set(e.range)):this.depthTest.set(!1)}setStencilMode(e){e.test.func!==this.gl.ALWAYS||e.mask?(this.stencilTest.set(!0),this.stencilMask.set(e.mask),this.stencilOp.set([e.fail,e.depthFail,e.pass]),this.stencilFunc.set({func:e.test.func,ref:e.ref,mask:e.test.mask})):this.stencilTest.set(!1)}setColorMode(e){s.aF(e.blendFunction,ji.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(e.blendFunction),this.blendColor.set(e.blendColor)),this.colorMask.set(e.mask)}createVertexArray(){var e;return js(this.gl)?this.gl.createVertexArray():(e=this.gl.getExtension("OES_vertex_array_object"))===null||e===void 0?void 0:e.createVertexArrayOES()}deleteVertexArray(e){var n;return js(this.gl)?this.gl.deleteVertexArray(e):(n=this.gl.getExtension("OES_vertex_array_object"))===null||n===void 0?void 0:n.deleteVertexArrayOES(e)}unbindVAO(){this.bindVertexArray.set(null)}}class Si{constructor(e,n,a){this.func=e,this.mask=n,this.range=a}}Si.ReadOnly=!1,Si.ReadWrite=!0,Si.disabled=new Si(519,Si.ReadOnly,[0,1]);const Ea=7680;class Qi{constructor(e,n,a,u,_,I){this.test=e,this.ref=n,this.mask=a,this.fail=u,this.depthFail=_,this.pass=I}}Qi.disabled=new Qi({func:519,mask:0},0,0,Ea,Ea,Ea);class $i{constructor(e,n,a){this.enable=e,this.mode=n,this.frontFace=a}}let Ws;function Pa(y,e,n,a,u){const _=y.context,I=_.gl,k=y.useProgram("collisionBox"),z=[];let R=0,V=0;for(let bt=0;bt<a.length;bt++){const Pt=a[bt],ht=e.getTile(Pt).getBucket(n);if(!ht)continue;const Dt=u?ht.textCollisionBox:ht.iconCollisionBox,Ut=ht.collisionCircleArray;if(Ut.length>0){const $t=s.H();s.aR($t,ht.placementInvProjMatrix,y.transform.glCoordMatrix),s.aR($t,$t,ht.placementViewportMatrix),z.push({circleArray:Ut,circleOffset:V,transform:Pt.posMatrix,invTransform:$t,coord:Pt}),R+=Ut.length/4,V=R}Dt&&k.draw(_,I.LINES,Si.disabled,Qi.disabled,y.colorModeForRenderPass(),$i.disabled,{u_matrix:Pt.posMatrix,u_pixel_extrude_scale:[1/(G=y.transform).width,1/G.height]},y.style.map.terrain&&y.style.map.terrain.getTerrainData(Pt),n.id,Dt.layoutVertexBuffer,Dt.indexBuffer,Dt.segments,null,y.transform.zoom,null,null,Dt.collisionVertexBuffer)}var G;if(!u||!z.length)return;const Y=y.useProgram("collisionCircle"),tt=new s.aS;tt.resize(4*R),tt._trim();let ot=0;for(const bt of z)for(let Pt=0;Pt<bt.circleArray.length/4;Pt++){const ht=4*Pt,Dt=bt.circleArray[ht+0],Ut=bt.circleArray[ht+1],$t=bt.circleArray[ht+2],_e=bt.circleArray[ht+3];tt.emplace(ot++,Dt,Ut,$t,_e,0),tt.emplace(ot++,Dt,Ut,$t,_e,1),tt.emplace(ot++,Dt,Ut,$t,_e,2),tt.emplace(ot++,Dt,Ut,$t,_e,3)}(!Ws||Ws.length<2*R)&&(Ws=function(bt){const Pt=2*bt,ht=new s.aU;ht.resize(Pt),ht._trim();for(let Dt=0;Dt<Pt;Dt++){const Ut=6*Dt;ht.uint16[Ut+0]=4*Dt+0,ht.uint16[Ut+1]=4*Dt+1,ht.uint16[Ut+2]=4*Dt+2,ht.uint16[Ut+3]=4*Dt+2,ht.uint16[Ut+4]=4*Dt+3,ht.uint16[Ut+5]=4*Dt+0}return ht}(R));const mt=_.createIndexBuffer(Ws,!0),ut=_.createVertexBuffer(tt,s.aT.members,!0);for(const bt of z){const Pt=De(bt.transform,bt.invTransform,y.transform);Y.draw(_,I.TRIANGLES,Si.disabled,Qi.disabled,y.colorModeForRenderPass(),$i.disabled,Pt,y.style.map.terrain&&y.style.map.terrain.getTerrainData(bt.coord),n.id,ut,mt,s.a0.simpleSegment(0,2*bt.circleOffset,bt.circleArray.length,bt.circleArray.length/2),null,y.transform.zoom,null,null,null)}ut.destroy(),mt.destroy()}$i.disabled=new $i(!1,1029,2305),$i.backCCW=new $i(!0,1029,2305);const Ia=s.ao(new Float32Array(16));function Ko(y,e,n,a,u,_){const{horizontalAlign:I,verticalAlign:k}=s.av(y);return new s.P((-(I-.5)*e/u+a[0])*_,(-(k-.5)*n/u+a[1])*_)}function To(y,e,n,a,u,_){const I=e.tileAnchorPoint.add(new s.P(e.translation[0],e.translation[1]));if(e.pitchWithMap){let k=a.mult(_);return n||(k=k.rotate(-u)),_t(I.add(k),e.labelPlaneMatrix,e.getElevation).point}if(n){const k=ee(e.tileAnchorPoint.x+1,e.tileAnchorPoint.y,e).point.sub(y),z=Math.atan(k.y/k.x)+(k.x<0?Math.PI:0);return y.add(a.rotate(z))}return y.add(a)}function Eo(y,e,n,a,u,_,I,k,z,R,V,G,Y,tt){const ot=y.text.placedSymbolArray,mt=y.text.dynamicLayoutVertexArray,ut=y.icon.dynamicLayoutVertexArray,bt={};mt.clear();for(let Pt=0;Pt<ot.length;Pt++){const ht=ot.get(Pt),Dt=ht.hidden||!ht.crossTileID||y.allowVerticalPlacement&&!ht.placedOrientation?null:a[ht.crossTileID];if(Dt){const Ut=new s.P(ht.anchorX,ht.anchorY),$t={getElevation:tt,width:u.width,height:u.height,labelPlaneMatrix:_,lineVertexArray:null,pitchWithMap:n,projection:V,projectionCache:null,tileAnchorPoint:Ut,translation:G,unwrappedTileID:Y},_e=n?_t(Ut,I,tt):ee(Ut.x,Ut.y,$t),Ce=W(u.cameraToCenterDistance,_e.signedDistanceFromCamera);let Xe=s.aj(y.textSizeData,z,ht)*Ce/s.aq;n&&(Xe*=y.tilePixelRatio/k);const{width:qe,height:Se,anchor:ke,textOffset:ti,textBoxScale:Ci}=Dt,ze=Ko(ke,qe,Se,ti,Ci,Xe),Ve=V.getPitchedTextCorrection(u,Ut.add(new s.P(G[0],G[1])),Y),yi=To(_e.point,$t,e,ze,u.angle,Ve),gr=y.allowVerticalPlacement&&ht.placedOrientation===s.ai.vertical?Math.PI/2:0;for(let Ii=0;Ii<ht.numGlyphs;Ii++)s.ak(mt,yi,gr);R&&ht.associatedIconIndex>=0&&(bt[ht.associatedIconIndex]={shiftedAnchor:yi,angle:gr})}else ei(ht.numGlyphs,mt)}if(R){ut.clear();const Pt=y.icon.placedSymbolArray;for(let ht=0;ht<Pt.length;ht++){const Dt=Pt.get(ht);if(Dt.hidden)ei(Dt.numGlyphs,ut);else{const Ut=bt[ht];if(Ut)for(let $t=0;$t<Dt.numGlyphs;$t++)s.ak(ut,Ut.shiftedAnchor,Ut.angle);else ei(Dt.numGlyphs,ut)}}y.icon.dynamicLayoutVertexBuffer.updateData(ut)}y.text.dynamicLayoutVertexBuffer.updateData(mt)}function Hs(y,e,n){return n.iconsInText&&e?"symbolTextAndIcon":y?"symbolSDF":"symbolIcon"}function pn(y,e,n,a,u,_,I,k,z,R,V,G){const Y=y.context,tt=Y.gl,ot=y.transform,mt=Cs(),ut=k==="map",bt=z==="map",Pt=k!=="viewport"&&n.layout.get("symbol-placement")!=="point",ht=ut&&!bt&&!Pt,Dt=!bt&&Pt,Ut=!n.layout.get("symbol-sort-key").isConstant();let $t=!1;const _e=y.depthModeForSublayer(0,Si.ReadOnly),Ce=n._unevaluatedLayout.hasValue("text-variable-anchor")||n._unevaluatedLayout.hasValue("text-variable-anchor-offset"),Xe=[],qe=mt.getCircleRadiusCorrection(ot);for(const Se of a){const ke=e.getTile(Se),ti=ke.getBucket(n);if(!ti)continue;const Ci=u?ti.text:ti.icon;if(!Ci||!Ci.segments.get().length||!Ci.hasVisibleVertices)continue;const ze=Ci.programConfigurations.get(n.id),Ve=u||ti.sdfIcons,yi=u?ti.textSizeData:ti.iconSizeData,gr=bt||ot.pitch!==0,Ii=y.useProgram(Hs(Ve,u,ti),ze),Di=s.ah(yi,ot.zoom),_r=y.style.map.terrain&&y.style.map.terrain.getTerrainData(Se);let rn,ts,yr,Cn,_n=[0,0],nn=null;if(u)ts=ke.glyphAtlasTexture,yr=tt.LINEAR,rn=ke.glyphAtlasTexture.size,ti.iconsInText&&(_n=ke.imageAtlasTexture.size,nn=ke.imageAtlasTexture,Cn=gr||y.options.rotating||y.options.zooming||yi.kind==="composite"||yi.kind==="camera"?tt.LINEAR:tt.NEAREST);else{const Cr=n.layout.get("icon-size").constantOr(0)!==1||ti.iconsNeedLinear;ts=ke.imageAtlasTexture,yr=Ve||y.options.rotating||y.options.zooming||Cr||gr?tt.LINEAR:tt.NEAREST,rn=ke.imageAtlasTexture.size}const sn=gi(ke,1,y.transform.zoom),es=Dt?Se.posMatrix:Ia,Do=Rr(es,bt,ut,y.transform,sn),nl=cr(es,bt,ut,y.transform,sn),ia=cr(Se.posMatrix,bt,ut,y.transform,sn),Lo=mt.translatePosition(y.transform,ke,_,I),sl=Ce&&ti.hasTextData(),Hl=n.layout.get("icon-text-fit")!=="none"&&sl&&ti.hasIconData();if(Pt){const Cr=y.style.map.terrain?(ql,Gr)=>y.style.map.terrain.getElevation(Se,ql,Gr):null,na=n.layout.get("text-rotation-alignment")==="map";et(ti,Se.posMatrix,y,u,Do,ia,bt,R,na,mt,Se.toUnwrapped(),ot.width,ot.height,Lo,Cr)}const Jr=Se.posMatrix,is=u&&Ce||Hl,eo=Pt||is?Ia:Do,ra=nl,on=Ve&&n.paint.get(u?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let an;an=Ve?ti.iconsInText?Yn(yi.kind,Di,ht,bt,Pt,is,y,Jr,eo,ra,Lo,rn,_n,qe):Ka(yi.kind,Di,ht,bt,Pt,is,y,Jr,eo,ra,Lo,u,rn,!0,qe):ya(yi.kind,Di,ht,bt,Pt,is,y,Jr,eo,ra,Lo,u,rn,qe);const Hr={program:Ii,buffers:Ci,uniformValues:an,atlasTexture:ts,atlasTextureIcon:nn,atlasInterpolation:yr,atlasInterpolationIcon:Cn,isSDF:Ve,hasHalo:on};if(Ut&&ti.canOverlap){$t=!0;const Cr=Ci.segments.get();for(const na of Cr)Xe.push({segments:new s.a0([na]),sortKey:na.sortKey,state:Hr,terrainData:_r})}else Xe.push({segments:Ci.segments,sortKey:0,state:Hr,terrainData:_r})}$t&&Xe.sort((Se,ke)=>Se.sortKey-ke.sortKey);for(const Se of Xe){const ke=Se.state;if(Y.activeTexture.set(tt.TEXTURE0),ke.atlasTexture.bind(ke.atlasInterpolation,tt.CLAMP_TO_EDGE),ke.atlasTextureIcon&&(Y.activeTexture.set(tt.TEXTURE1),ke.atlasTextureIcon&&ke.atlasTextureIcon.bind(ke.atlasInterpolationIcon,tt.CLAMP_TO_EDGE)),ke.isSDF){const ti=ke.uniformValues;ke.hasHalo&&(ti.u_is_halo=1,Is(ke.buffers,Se.segments,n,y,ke.program,_e,V,G,ti,Se.terrainData)),ti.u_is_halo=0}Is(ke.buffers,Se.segments,n,y,ke.program,_e,V,G,ke.uniformValues,Se.terrainData)}}function Is(y,e,n,a,u,_,I,k,z,R){const V=a.context;u.draw(V,V.gl.TRIANGLES,_,I,k,$i.disabled,z,R,n.id,y.layoutVertexBuffer,y.indexBuffer,e,n.paint,a.transform.zoom,y.programConfigurations.get(n.id),y.dynamicLayoutVertexBuffer,y.opacityVertexBuffer)}function kr(y,e,n,a,u){if(!n||!a||!a.imageAtlas)return;const _=a.imageAtlas.patternPositions;let I=_[n.to.toString()],k=_[n.from.toString()];if(!I&&k&&(I=k),!k&&I&&(k=I),!I||!k){const z=u.getPaintProperty(e);I=_[z],k=_[z]}I&&k&&y.setConstantPatternPositions(I,k)}function Aa(y,e,n,a,u,_,I){const k=y.context.gl,z="fill-pattern",R=n.paint.get(z),V=R&&R.constantOr(1),G=n.getCrossfadeParameters();let Y,tt,ot,mt,ut;I?(tt=V&&!n.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Y=k.LINES):(tt=V?"fillPattern":"fill",Y=k.TRIANGLES);const bt=R.constantOr(null);for(const Pt of a){const ht=e.getTile(Pt);if(V&&!ht.patternsLoaded())continue;const Dt=ht.getBucket(n);if(!Dt)continue;const Ut=Dt.programConfigurations.get(n.id),$t=y.useProgram(tt,Ut),_e=y.style.map.terrain&&y.style.map.terrain.getTerrainData(Pt);V&&(y.context.activeTexture.set(k.TEXTURE0),ht.imageAtlasTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE),Ut.updatePaintBuffers(G)),kr(Ut,z,bt,ht,n);const Ce=_e?Pt:null,Xe=y.translatePosMatrix(Ce?Ce.posMatrix:Pt.posMatrix,ht,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor"));if(I){mt=Dt.indexBuffer2,ut=Dt.segments2;const qe=[k.drawingBufferWidth,k.drawingBufferHeight];ot=tt==="fillOutlinePattern"&&V?Ne(Xe,y,G,ht,qe):Ie(Xe,qe)}else mt=Dt.indexBuffer,ut=Dt.segments,ot=V?xe(Xe,y,G,ht):Rt(Xe);$t.draw(y.context,Y,u,y.stencilModeForClipping(Pt),_,$i.disabled,ot,_e,n.id,Dt.layoutVertexBuffer,mt,ut,n.paint,y.transform.zoom,Ut)}}function Nn(y,e,n,a,u,_,I){const k=y.context,z=k.gl,R="fill-extrusion-pattern",V=n.paint.get(R),G=V.constantOr(1),Y=n.getCrossfadeParameters(),tt=n.paint.get("fill-extrusion-opacity"),ot=V.constantOr(null);for(const mt of a){const ut=e.getTile(mt),bt=ut.getBucket(n);if(!bt)continue;const Pt=y.style.map.terrain&&y.style.map.terrain.getTerrainData(mt),ht=bt.programConfigurations.get(n.id),Dt=y.useProgram(G?"fillExtrusionPattern":"fillExtrusion",ht);G&&(y.context.activeTexture.set(z.TEXTURE0),ut.imageAtlasTexture.bind(z.LINEAR,z.CLAMP_TO_EDGE),ht.updatePaintBuffers(Y)),kr(ht,R,ot,ut,n);const Ut=y.translatePosMatrix(mt.posMatrix,ut,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),$t=n.paint.get("fill-extrusion-vertical-gradient"),_e=G?kt(Ut,y,$t,tt,mt,Y,ut):Tt(Ut,y,$t,tt);Dt.draw(k,k.gl.TRIANGLES,u,_,I,$i.backCCW,_e,Pt,n.id,bt.layoutVertexBuffer,bt.indexBuffer,bt.segments,n.paint,y.transform.zoom,ht,y.style.map.terrain&&bt.centroidVertexBuffer)}}function Jo(y,e,n,a,u,_,I){const k=y.context,z=k.gl,R=n.fbo;if(!R)return;const V=y.useProgram("hillshade"),G=y.style.map.terrain&&y.style.map.terrain.getTerrainData(e);k.activeTexture.set(z.TEXTURE0),z.bindTexture(z.TEXTURE_2D,R.colorAttachment.get()),V.draw(k,z.TRIANGLES,u,_,I,$i.disabled,((Y,tt,ot,mt)=>{const ut=ot.paint.get("hillshade-shadow-color"),bt=ot.paint.get("hillshade-highlight-color"),Pt=ot.paint.get("hillshade-accent-color");let ht=ot.paint.get("hillshade-illumination-direction")*(Math.PI/180);ot.paint.get("hillshade-illumination-anchor")==="viewport"&&(ht-=Y.transform.angle);const Dt=!Y.options.moving;return{u_matrix:mt?mt.posMatrix:Y.transform.calculatePosMatrix(tt.tileID.toUnwrapped(),Dt),u_image:0,u_latrange:Ni(0,tt.tileID),u_light:[ot.paint.get("hillshade-exaggeration"),ht],u_shadow:ut,u_highlight:bt,u_accent:Pt}})(y,n,a,G?e:null),G,a.id,y.rasterBoundsBuffer,y.quadTriangleIndexBuffer,y.rasterBoundsSegments)}function As(y,e,n,a,u,_){const I=y.context,k=I.gl,z=e.dem;if(z&&z.data){const R=z.dim,V=z.stride,G=z.getPixels();if(I.activeTexture.set(k.TEXTURE1),I.pixelStoreUnpackPremultiplyAlpha.set(!1),e.demTexture=e.demTexture||y.getTileTexture(V),e.demTexture){const tt=e.demTexture;tt.update(G,{premultiply:!1}),tt.bind(k.NEAREST,k.CLAMP_TO_EDGE)}else e.demTexture=new Jt(I,G,k.RGBA,{premultiply:!1}),e.demTexture.bind(k.NEAREST,k.CLAMP_TO_EDGE);I.activeTexture.set(k.TEXTURE0);let Y=e.fbo;if(!Y){const tt=new Jt(I,{width:R,height:R,data:null},k.RGBA);tt.bind(k.LINEAR,k.CLAMP_TO_EDGE),Y=e.fbo=I.createFramebuffer(R,R,!0,!1),Y.colorAttachment.set(tt.texture)}I.bindFramebuffer.set(Y.framebuffer),I.viewport.set([0,0,R,R]),y.useProgram("hillshadePrepare").draw(I,k.TRIANGLES,a,u,_,$i.disabled,((tt,ot)=>{const mt=ot.stride,ut=s.H();return s.aQ(ut,0,s.X,-s.X,0,0,1),s.J(ut,ut,[0,-s.X,0]),{u_matrix:ut,u_image:1,u_dimension:[mt,mt],u_zoom:tt.overscaledZ,u_unpack:ot.getUnpackVector()}})(e.tileID,z),null,n.id,y.rasterBoundsBuffer,y.quadTriangleIndexBuffer,y.rasterBoundsSegments),e.needsHillshadePrepare=!1}}function Ms(y,e,n,a,u,_){const I=a.paint.get("raster-fade-duration");if(!_&&I>0){const k=l.now(),z=(k-y.timeAdded)/I,R=e?(k-e.timeAdded)/I:-1,V=n.getSource(),G=u.coveringZoomLevel({tileSize:V.tileSize,roundZoom:V.roundZoom}),Y=!e||Math.abs(e.tileID.overscaledZ-G)>Math.abs(y.tileID.overscaledZ-G),tt=Y&&y.refreshedUponExpiration?1:s.ad(Y?z:1-R,0,1);return y.refreshedUponExpiration&&z>=1&&(y.refreshedUponExpiration=!1),e?{opacity:1,mix:1-tt}:{opacity:tt,mix:0}}return{opacity:1,mix:0}}const qs=new s.aN(1,0,0,1),$s=new s.aN(0,1,0,1),Po=new s.aN(0,0,1,1),Ma=new s.aN(1,0,1,1),Vn=new s.aN(0,1,1,1);function fs(y,e,n,a){Bt(y,0,e+n/2,y.transform.width,n,a)}function ka(y,e,n,a){Bt(y,e-n/2,0,n,y.transform.height,a)}function Bt(y,e,n,a,u,_){const I=y.context,k=I.gl;k.enable(k.SCISSOR_TEST),k.scissor(e*y.pixelRatio,n*y.pixelRatio,a*y.pixelRatio,u*y.pixelRatio),I.clear({color:_}),k.disable(k.SCISSOR_TEST)}function Ht(y,e,n){const a=y.context,u=a.gl,_=n.posMatrix,I=y.useProgram("debug"),k=Si.disabled,z=Qi.disabled,R=y.colorModeForRenderPass(),V="$debug",G=y.style.map.terrain&&y.style.map.terrain.getTerrainData(n);a.activeTexture.set(u.TEXTURE0);const Y=e.getTileByID(n.key).latestRawTileData,tt=Math.floor((Y&&Y.byteLength||0)/1024),ot=e.getTile(n).tileSize,mt=512/Math.min(ot,512)*(n.overscaledZ/y.transform.zoom)*.5;let ut=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(ut+=` => ${n.overscaledZ}`),function(bt,Pt){bt.initDebugOverlayCanvas();const ht=bt.debugOverlayCanvas,Dt=bt.context.gl,Ut=bt.debugOverlayCanvas.getContext("2d");Ut.clearRect(0,0,ht.width,ht.height),Ut.shadowColor="white",Ut.shadowBlur=2,Ut.lineWidth=1.5,Ut.strokeStyle="white",Ut.textBaseline="top",Ut.font="bold 36px Open Sans, sans-serif",Ut.fillText(Pt,5,5),Ut.strokeText(Pt,5,5),bt.debugOverlayTexture.update(ht),bt.debugOverlayTexture.bind(Dt.LINEAR,Dt.CLAMP_TO_EDGE)}(y,`${ut} ${tt}kB`),I.draw(a,u.TRIANGLES,k,z,ji.alphaBlended,$i.disabled,pi(_,s.aN.transparent,mt),null,V,y.debugBuffer,y.quadTriangleIndexBuffer,y.debugSegments),I.draw(a,u.LINE_STRIP,k,z,R,$i.disabled,pi(_,s.aN.red),G,V,y.debugBuffer,y.tileBorderIndexBuffer,y.debugSegments)}function Le(y,e,n){const a=y.context,u=a.gl,_=y.colorModeForRenderPass(),I=new Si(u.LEQUAL,Si.ReadWrite,y.depthRangeFor3D),k=y.useProgram("terrain"),z=e.getTerrainMesh();a.bindFramebuffer.set(null),a.viewport.set([0,0,y.width,y.height]);for(const R of n){const V=y.renderToTexture.getTexture(R),G=e.getTerrainData(R.tileID);a.activeTexture.set(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,V.texture);const Y=y.transform.calculatePosMatrix(R.tileID.toUnwrapped()),tt=e.getMeshFrameDelta(y.transform.zoom),ot=y.transform.calculateFogMatrix(R.tileID.toUnwrapped()),mt=P(Y,tt,ot,y.style.sky,y.transform.pitch);k.draw(a,u.TRIANGLES,I,Qi.disabled,_,$i.backCCW,mt,G,"terrain",z.vertexBuffer,z.indexBuffer,z.segments)}}class hi{constructor(e,n,a){this.vertexBuffer=e,this.indexBuffer=n,this.segments=a}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}class ar{constructor(e,n){this.context=new Xs(e),this.transform=n,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:s.ao(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=$e.maxUnderzooming+$e.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new fn}resize(e,n,a){if(this.width=Math.floor(e*a),this.height=Math.floor(n*a),this.pixelRatio=a,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const u of this.style._order)this.style._layers[u].resize()}setup(){const e=this.context,n=new s.aX;n.emplaceBack(0,0),n.emplaceBack(s.X,0),n.emplaceBack(0,s.X),n.emplaceBack(s.X,s.X),this.tileExtentBuffer=e.createVertexBuffer(n,mo.members),this.tileExtentSegments=s.a0.simpleSegment(0,0,4,2);const a=new s.aX;a.emplaceBack(0,0),a.emplaceBack(s.X,0),a.emplaceBack(0,s.X),a.emplaceBack(s.X,s.X),this.debugBuffer=e.createVertexBuffer(a,mo.members),this.debugSegments=s.a0.simpleSegment(0,0,4,5);const u=new s.$;u.emplaceBack(0,0,0,0),u.emplaceBack(s.X,0,s.X,0),u.emplaceBack(0,s.X,0,s.X),u.emplaceBack(s.X,s.X,s.X,s.X),this.rasterBoundsBuffer=e.createVertexBuffer(u,oe.members),this.rasterBoundsSegments=s.a0.simpleSegment(0,0,4,2);const _=new s.aX;_.emplaceBack(0,0),_.emplaceBack(1,0),_.emplaceBack(0,1),_.emplaceBack(1,1),this.viewportBuffer=e.createVertexBuffer(_,mo.members),this.viewportSegments=s.a0.simpleSegment(0,0,4,2);const I=new s.aZ;I.emplaceBack(0),I.emplaceBack(1),I.emplaceBack(3),I.emplaceBack(2),I.emplaceBack(0),this.tileBorderIndexBuffer=e.createIndexBuffer(I);const k=new s.aY;k.emplaceBack(0,1,2),k.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=e.createIndexBuffer(k);const z=this.context.gl;this.stencilClearMode=new Qi({func:z.ALWAYS,mask:0},0,255,z.ZERO,z.ZERO,z.ZERO)}clearStencil(){const e=this.context,n=e.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const a=s.H();s.aQ(a,0,this.width,this.height,0,0,1),s.K(a,a,[n.drawingBufferWidth,n.drawingBufferHeight,0]),this.useProgram("clippingMask").draw(e,n.TRIANGLES,Si.disabled,this.stencilClearMode,ji.disabled,$i.disabled,er(a),null,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(e,n){if(this.currentStencilSource===e.source||!e.isTileClipped()||!n||!n.length)return;this.currentStencilSource=e.source;const a=this.context,u=a.gl;this.nextStencilID+n.length>256&&this.clearStencil(),a.setColorMode(ji.disabled),a.setDepthMode(Si.disabled);const _=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const I of n){const k=this._tileClippingMaskIDs[I.key]=this.nextStencilID++,z=this.style.map.terrain&&this.style.map.terrain.getTerrainData(I);_.draw(a,u.TRIANGLES,Si.disabled,new Qi({func:u.ALWAYS,mask:0},k,255,u.KEEP,u.KEEP,u.REPLACE),ji.disabled,$i.disabled,er(I.posMatrix),z,"$clipping",this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const e=this.nextStencilID++,n=this.context.gl;return new Qi({func:n.NOTEQUAL,mask:255},e,255,n.KEEP,n.KEEP,n.REPLACE)}stencilModeForClipping(e){const n=this.context.gl;return new Qi({func:n.EQUAL,mask:255},this._tileClippingMaskIDs[e.key],0,n.KEEP,n.KEEP,n.REPLACE)}stencilConfigForOverlap(e){const n=this.context.gl,a=e.sort((I,k)=>k.overscaledZ-I.overscaledZ),u=a[a.length-1].overscaledZ,_=a[0].overscaledZ-u+1;if(_>1){this.currentStencilSource=void 0,this.nextStencilID+_>256&&this.clearStencil();const I={};for(let k=0;k<_;k++)I[k+u]=new Qi({func:n.GEQUAL,mask:255},k+this.nextStencilID,255,n.KEEP,n.KEEP,n.REPLACE);return this.nextStencilID+=_,[I,a]}return[{[u]:Qi.disabled},a]}colorModeForRenderPass(){const e=this.context.gl;return this._showOverdrawInspector?new ji([e.CONSTANT_COLOR,e.ONE],new s.aN(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?ji.unblended:ji.alphaBlended}depthModeForSublayer(e,n,a){if(!this.opaquePassEnabledForLayer())return Si.disabled;const u=1-((1+this.currentLayer)*this.numSublayers+e)*this.depthEpsilon;return new Si(a||this.context.gl.LEQUAL,n,[u,u])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(e,n){var a;this.style=e,this.options=n,this.lineAtlas=e.lineAtlas,this.imageManager=e.imageManager,this.glyphManager=e.glyphManager,this.symbolFadeChange=e.placement.symbolFadeChange(l.now()),this.imageManager.beginFrame();const u=this.style._order,_=this.style.sourceCaches,I={},k={},z={};for(const R in _){const V=_[R];V.used&&V.prepare(this.context),I[R]=V.getVisibleCoordinates(),k[R]=I[R].slice().reverse(),z[R]=V.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let R=0;R<u.length;R++)if(this.style._layers[u[R]].is3D()){this.opaquePassCutoff=R;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const R of u){const V=this.style._layers[R];if(!V.hasOffscreenPass()||V.isHidden(this.transform.zoom))continue;const G=k[V.source];(V.type==="custom"||G.length)&&this.renderLayer(this,_[V.source],V,G)}if(this.context.bindFramebuffer.set(null),this.context.clear({color:n.showOverdrawInspector?s.aN.black:s.aN.transparent,depth:1}),this.clearStencil(),!((a=this.style.stylesheet)===null||a===void 0)&&a.sky&&function(R,V){const G=R.context,Y=G.gl,tt=((Pt,ht,Dt)=>({u_sky_color:Pt.properties.get("sky-color"),u_horizon_color:Pt.properties.get("horizon-color"),u_horizon:(ht.height/2+ht.getHorizon())*Dt,u_sky_horizon_blend:Pt.properties.get("sky-horizon-blend")*ht.height/2*Dt}))(V,R.style.map.transform,R.pixelRatio),ot=new Si(Y.LEQUAL,Si.ReadWrite,[0,1]),mt=Qi.disabled,ut=R.colorModeForRenderPass(),bt=R.useProgram("sky");if(!V.mesh){const Pt=new s.aX;Pt.emplaceBack(-1,-1),Pt.emplaceBack(1,-1),Pt.emplaceBack(1,1),Pt.emplaceBack(-1,1);const ht=new s.aY;ht.emplaceBack(0,1,2),ht.emplaceBack(0,2,3),V.mesh=new hi(G.createVertexBuffer(Pt,mo.members),G.createIndexBuffer(ht),s.a0.simpleSegment(0,0,Pt.length,ht.length))}bt.draw(G,Y.TRIANGLES,ot,mt,ut,$i.disabled,tt,void 0,"sky",V.mesh.vertexBuffer,V.mesh.indexBuffer,V.mesh.segments)}(this,this.style.sky),this._showOverdrawInspector=n.showOverdrawInspector,this.depthRangeFor3D=[0,1-(e._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=u.length-1;this.currentLayer>=0;this.currentLayer--){const R=this.style._layers[u[this.currentLayer]],V=_[R.source],G=I[R.source];this._renderTileClippingMasks(R,G),this.renderLayer(this,V,R,G)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<u.length;this.currentLayer++){const R=this.style._layers[u[this.currentLayer]],V=_[R.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(R))continue;const G=(R.type==="symbol"?z:k)[R.source];this._renderTileClippingMasks(R,I[R.source]),this.renderLayer(this,V,R,G)}if(this.options.showTileBoundaries){const R=function(V,G){let Y=null;const tt=Object.values(V._layers).flatMap(bt=>bt.source&&!bt.isHidden(G)?[V.sourceCaches[bt.source]]:[]),ot=tt.filter(bt=>bt.getSource().type==="vector"),mt=tt.filter(bt=>bt.getSource().type!=="vector"),ut=bt=>{(!Y||Y.getSource().maxzoom<bt.getSource().maxzoom)&&(Y=bt)};return ot.forEach(bt=>ut(bt)),Y||mt.forEach(bt=>ut(bt)),Y}(this.style,this.transform.zoom);R&&function(V,G,Y){for(let tt=0;tt<Y.length;tt++)Ht(V,G,Y[tt])}(this,R,R.getVisibleCoordinates())}this.options.showPadding&&function(R){const V=R.transform.padding;fs(R,R.transform.height-(V.top||0),3,qs),fs(R,V.bottom||0,3,$s),ka(R,V.left||0,3,Po),ka(R,R.transform.width-(V.right||0),3,Ma);const G=R.transform.centerPoint;(function(Y,tt,ot,mt){Bt(Y,tt-1,ot-10,2,20,mt),Bt(Y,tt-10,ot-1,20,2,mt)})(R,G.x,R.transform.height-G.y,Vn)}(this),this.context.setDefault()}maybeDrawDepthAndCoords(e){if(!this.style||!this.style.map||!this.style.map.terrain)return;const n=this.terrainFacilitator.matrix,a=this.transform.modelViewProjectionMatrix;let u=this.terrainFacilitator.dirty;u||(u=e?!s.a_(n,a):!s.a$(n,a)),u||(u=this.style.map.terrain.sourceCache.tilesAfterTime(this.terrainFacilitator.renderTime).length>0),u&&(s.b0(n,a),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(_,I){const k=_.context,z=k.gl,R=ji.unblended,V=new Si(z.LEQUAL,Si.ReadWrite,[0,1]),G=I.getTerrainMesh(),Y=I.sourceCache.getRenderableTiles(),tt=_.useProgram("terrainDepth");k.bindFramebuffer.set(I.getFramebuffer("depth").framebuffer),k.viewport.set([0,0,_.width/devicePixelRatio,_.height/devicePixelRatio]),k.clear({color:s.aN.transparent,depth:1});for(const ot of Y){const mt=I.getTerrainData(ot.tileID),ut={u_matrix:_.transform.calculatePosMatrix(ot.tileID.toUnwrapped()),u_ele_delta:I.getMeshFrameDelta(_.transform.zoom)};tt.draw(k,z.TRIANGLES,V,Qi.disabled,R,$i.backCCW,ut,mt,"terrain",G.vertexBuffer,G.indexBuffer,G.segments)}k.bindFramebuffer.set(null),k.viewport.set([0,0,_.width,_.height])}(this,this.style.map.terrain),function(_,I){const k=_.context,z=k.gl,R=ji.unblended,V=new Si(z.LEQUAL,Si.ReadWrite,[0,1]),G=I.getTerrainMesh(),Y=I.getCoordsTexture(),tt=I.sourceCache.getRenderableTiles(),ot=_.useProgram("terrainCoords");k.bindFramebuffer.set(I.getFramebuffer("coords").framebuffer),k.viewport.set([0,0,_.width/devicePixelRatio,_.height/devicePixelRatio]),k.clear({color:s.aN.transparent,depth:1}),I.coordsIndex=[];for(const mt of tt){const ut=I.getTerrainData(mt.tileID);k.activeTexture.set(z.TEXTURE0),z.bindTexture(z.TEXTURE_2D,Y.texture);const bt={u_matrix:_.transform.calculatePosMatrix(mt.tileID.toUnwrapped()),u_terrain_coords_id:(255-I.coordsIndex.length)/255,u_texture:0,u_ele_delta:I.getMeshFrameDelta(_.transform.zoom)};ot.draw(k,z.TRIANGLES,V,Qi.disabled,R,$i.backCCW,bt,ut,"terrain",G.vertexBuffer,G.indexBuffer,G.segments),I.coordsIndex.push(mt.tileID.key)}k.bindFramebuffer.set(null),k.viewport.set([0,0,_.width,_.height])}(this,this.style.map.terrain))}renderLayer(e,n,a,u){if(!a.isHidden(this.transform.zoom)&&(a.type==="background"||a.type==="custom"||(u||[]).length))switch(this.id=a.id,a.type){case"symbol":(function(_,I,k,z,R){if(_.renderPass!=="translucent")return;const V=Qi.disabled,G=_.colorModeForRenderPass();(k._unevaluatedLayout.hasValue("text-variable-anchor")||k._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(Y,tt,ot,mt,ut,bt,Pt,ht,Dt){const Ut=tt.transform,$t=Cs(),_e=ut==="map",Ce=bt==="map";for(const Xe of Y){const qe=mt.getTile(Xe),Se=qe.getBucket(ot);if(!Se||!Se.text||!Se.text.segments.get().length)continue;const ke=s.ah(Se.textSizeData,Ut.zoom),ti=gi(qe,1,tt.transform.zoom),Ci=Rr(Xe.posMatrix,Ce,_e,tt.transform,ti),ze=ot.layout.get("icon-text-fit")!=="none"&&Se.hasIconData();if(ke){const Ve=Math.pow(2,Ut.zoom-qe.tileID.overscaledZ),yi=tt.style.map.terrain?(Ii,Di)=>tt.style.map.terrain.getElevation(Xe,Ii,Di):null,gr=$t.translatePosition(Ut,qe,Pt,ht);Eo(Se,_e,Ce,Dt,Ut,Ci,Xe.posMatrix,Ve,ke,ze,$t,gr,Xe.toUnwrapped(),yi)}}}(z,_,k,I,k.layout.get("text-rotation-alignment"),k.layout.get("text-pitch-alignment"),k.paint.get("text-translate"),k.paint.get("text-translate-anchor"),R),k.paint.get("icon-opacity").constantOr(1)!==0&&pn(_,I,k,z,!1,k.paint.get("icon-translate"),k.paint.get("icon-translate-anchor"),k.layout.get("icon-rotation-alignment"),k.layout.get("icon-pitch-alignment"),k.layout.get("icon-keep-upright"),V,G),k.paint.get("text-opacity").constantOr(1)!==0&&pn(_,I,k,z,!0,k.paint.get("text-translate"),k.paint.get("text-translate-anchor"),k.layout.get("text-rotation-alignment"),k.layout.get("text-pitch-alignment"),k.layout.get("text-keep-upright"),V,G),I.map.showCollisionBoxes&&(Pa(_,I,k,z,!0),Pa(_,I,k,z,!1))})(e,n,a,u,this.style.placement.variableOffsets);break;case"circle":(function(_,I,k,z){if(_.renderPass!=="translucent")return;const R=k.paint.get("circle-opacity"),V=k.paint.get("circle-stroke-width"),G=k.paint.get("circle-stroke-opacity"),Y=!k.layout.get("circle-sort-key").isConstant();if(R.constantOr(1)===0&&(V.constantOr(1)===0||G.constantOr(1)===0))return;const tt=_.context,ot=tt.gl,mt=_.depthModeForSublayer(0,Si.ReadOnly),ut=Qi.disabled,bt=_.colorModeForRenderPass(),Pt=[];for(let ht=0;ht<z.length;ht++){const Dt=z[ht],Ut=I.getTile(Dt),$t=Ut.getBucket(k);if(!$t)continue;const _e=$t.programConfigurations.get(k.id),Ce=_.useProgram("circle",_e),Xe=$t.layoutVertexBuffer,qe=$t.indexBuffer,Se=_.style.map.terrain&&_.style.map.terrain.getTerrainData(Dt),ke={programConfiguration:_e,program:Ce,layoutVertexBuffer:Xe,indexBuffer:qe,uniformValues:je(_,Dt,Ut,k),terrainData:Se};if(Y){const ti=$t.segments.get();for(const Ci of ti)Pt.push({segments:new s.a0([Ci]),sortKey:Ci.sortKey,state:ke})}else Pt.push({segments:$t.segments,sortKey:0,state:ke})}Y&&Pt.sort((ht,Dt)=>ht.sortKey-Dt.sortKey);for(const ht of Pt){const{programConfiguration:Dt,program:Ut,layoutVertexBuffer:$t,indexBuffer:_e,uniformValues:Ce,terrainData:Xe}=ht.state;Ut.draw(tt,ot.TRIANGLES,mt,ut,bt,$i.disabled,Ce,Xe,k.id,$t,_e,ht.segments,k.paint,_.transform.zoom,Dt)}})(e,n,a,u);break;case"heatmap":(function(_,I,k,z){if(k.paint.get("heatmap-opacity")!==0)if(_.renderPass==="offscreen"){const R=_.context,V=R.gl,G=Qi.disabled,Y=new ji([V.ONE,V.ONE],s.aN.transparent,[!0,!0,!0,!0]);(function(tt,ot,mt){const ut=tt.gl;tt.activeTexture.set(ut.TEXTURE1),tt.viewport.set([0,0,ot.width/4,ot.height/4]);let bt=mt.heatmapFbo;if(bt)ut.bindTexture(ut.TEXTURE_2D,bt.colorAttachment.get()),tt.bindFramebuffer.set(bt.framebuffer);else{const Pt=ut.createTexture();ut.bindTexture(ut.TEXTURE_2D,Pt),ut.texParameteri(ut.TEXTURE_2D,ut.TEXTURE_WRAP_S,ut.CLAMP_TO_EDGE),ut.texParameteri(ut.TEXTURE_2D,ut.TEXTURE_WRAP_T,ut.CLAMP_TO_EDGE),ut.texParameteri(ut.TEXTURE_2D,ut.TEXTURE_MIN_FILTER,ut.LINEAR),ut.texParameteri(ut.TEXTURE_2D,ut.TEXTURE_MAG_FILTER,ut.LINEAR),bt=mt.heatmapFbo=tt.createFramebuffer(ot.width/4,ot.height/4,!1,!1),function(ht,Dt,Ut,$t){var _e,Ce;const Xe=ht.gl,qe=(_e=ht.HALF_FLOAT)!==null&&_e!==void 0?_e:Xe.UNSIGNED_BYTE,Se=(Ce=ht.RGBA16F)!==null&&Ce!==void 0?Ce:Xe.RGBA;Xe.texImage2D(Xe.TEXTURE_2D,0,Se,Dt.width/4,Dt.height/4,0,Xe.RGBA,qe,null),$t.colorAttachment.set(Ut)}(tt,ot,Pt,bt)}})(R,_,k),R.clear({color:s.aN.transparent});for(let tt=0;tt<z.length;tt++){const ot=z[tt];if(I.hasRenderableParent(ot))continue;const mt=I.getTile(ot),ut=mt.getBucket(k);if(!ut)continue;const bt=ut.programConfigurations.get(k.id),Pt=_.useProgram("heatmap",bt),{zoom:ht}=_.transform;Pt.draw(R,V.TRIANGLES,Si.disabled,G,Y,$i.disabled,di(ot.posMatrix,mt,ht,k.paint.get("heatmap-intensity")),null,k.id,ut.layoutVertexBuffer,ut.indexBuffer,ut.segments,k.paint,_.transform.zoom,bt)}R.viewport.set([0,0,_.width,_.height])}else _.renderPass==="translucent"&&(_.context.setColorMode(_.colorModeForRenderPass()),function(R,V){const G=R.context,Y=G.gl,tt=V.heatmapFbo;if(!tt)return;G.activeTexture.set(Y.TEXTURE0),Y.bindTexture(Y.TEXTURE_2D,tt.colorAttachment.get()),G.activeTexture.set(Y.TEXTURE1);let ot=V.colorRampTexture;ot||(ot=V.colorRampTexture=new Jt(G,V.colorRamp,Y.RGBA)),ot.bind(Y.LINEAR,Y.CLAMP_TO_EDGE),R.useProgram("heatmapTexture").draw(G,Y.TRIANGLES,Si.disabled,Qi.disabled,R.colorModeForRenderPass(),$i.disabled,((mt,ut,bt,Pt)=>{const ht=s.H();s.aQ(ht,0,mt.width,mt.height,0,0,1);const Dt=mt.context.gl;return{u_matrix:ht,u_world:[Dt.drawingBufferWidth,Dt.drawingBufferHeight],u_image:0,u_color_ramp:1,u_opacity:ut.paint.get("heatmap-opacity")}})(R,V),null,V.id,R.viewportBuffer,R.quadTriangleIndexBuffer,R.viewportSegments,V.paint,R.transform.zoom)}(_,k))})(e,n,a,u);break;case"line":(function(_,I,k,z){if(_.renderPass!=="translucent")return;const R=k.paint.get("line-opacity"),V=k.paint.get("line-width");if(R.constantOr(1)===0||V.constantOr(1)===0)return;const G=_.depthModeForSublayer(0,Si.ReadOnly),Y=_.colorModeForRenderPass(),tt=k.paint.get("line-dasharray"),ot=k.paint.get("line-pattern"),mt=ot.constantOr(1),ut=k.paint.get("line-gradient"),bt=k.getCrossfadeParameters(),Pt=mt?"linePattern":tt?"lineSDF":ut?"lineGradient":"line",ht=_.context,Dt=ht.gl;let Ut=!0;for(const $t of z){const _e=I.getTile($t);if(mt&&!_e.patternsLoaded())continue;const Ce=_e.getBucket(k);if(!Ce)continue;const Xe=Ce.programConfigurations.get(k.id),qe=_.context.program.get(),Se=_.useProgram(Pt,Xe),ke=Ut||Se.program!==qe,ti=_.style.map.terrain&&_.style.map.terrain.getTerrainData($t),Ci=ot.constantOr(null);if(Ci&&_e.imageAtlas){const yi=_e.imageAtlas,gr=yi.patternPositions[Ci.to.toString()],Ii=yi.patternPositions[Ci.from.toString()];gr&&Ii&&Xe.setConstantPatternPositions(gr,Ii)}const ze=ti?$t:null,Ve=mt?qi(_,_e,k,bt,ze):tt?zr(_,_e,k,tt,bt,ze):ut?ri(_,_e,k,Ce.lineClipsArray.length,ze):ge(_,_e,k,ze);if(mt)ht.activeTexture.set(Dt.TEXTURE0),_e.imageAtlasTexture.bind(Dt.LINEAR,Dt.CLAMP_TO_EDGE),Xe.updatePaintBuffers(bt);else if(tt&&(ke||_.lineAtlas.dirty))ht.activeTexture.set(Dt.TEXTURE0),_.lineAtlas.bind(ht);else if(ut){const yi=Ce.gradients[k.id];let gr=yi.texture;if(k.gradientVersion!==yi.version){let Ii=256;if(k.stepInterpolant){const Di=I.getSource().maxzoom,_r=$t.canonical.z===Di?Math.ceil(1<<_.transform.maxZoom-$t.canonical.z):1;Ii=s.ad(s.aV(Ce.maxLineLength/s.X*1024*_r),256,ht.maxTextureSize)}yi.gradient=s.aW({expression:k.gradientExpression(),evaluationKey:"lineProgress",resolution:Ii,image:yi.gradient||void 0,clips:Ce.lineClipsArray}),yi.texture?yi.texture.update(yi.gradient):yi.texture=new Jt(ht,yi.gradient,Dt.RGBA),yi.version=k.gradientVersion,gr=yi.texture}ht.activeTexture.set(Dt.TEXTURE0),gr.bind(k.stepInterpolant?Dt.NEAREST:Dt.LINEAR,Dt.CLAMP_TO_EDGE)}Se.draw(ht,Dt.TRIANGLES,G,_.stencilModeForClipping($t),Y,$i.disabled,Ve,ti,k.id,Ce.layoutVertexBuffer,Ce.indexBuffer,Ce.segments,k.paint,_.transform.zoom,Xe,Ce.layoutVertexBuffer2),Ut=!1}})(e,n,a,u);break;case"fill":(function(_,I,k,z){const R=k.paint.get("fill-color"),V=k.paint.get("fill-opacity");if(V.constantOr(1)===0)return;const G=_.colorModeForRenderPass(),Y=k.paint.get("fill-pattern"),tt=_.opaquePassEnabledForLayer()&&!Y.constantOr(1)&&R.constantOr(s.aN.transparent).a===1&&V.constantOr(0)===1?"opaque":"translucent";if(_.renderPass===tt){const ot=_.depthModeForSublayer(1,_.renderPass==="opaque"?Si.ReadWrite:Si.ReadOnly);Aa(_,I,k,z,ot,G,!1)}if(_.renderPass==="translucent"&&k.paint.get("fill-antialias")){const ot=_.depthModeForSublayer(k.getPaintProperty("fill-outline-color")?2:0,Si.ReadOnly);Aa(_,I,k,z,ot,G,!0)}})(e,n,a,u);break;case"fill-extrusion":(function(_,I,k,z){const R=k.paint.get("fill-extrusion-opacity");if(R!==0&&_.renderPass==="translucent"){const V=new Si(_.context.gl.LEQUAL,Si.ReadWrite,_.depthRangeFor3D);if(R!==1||k.paint.get("fill-extrusion-pattern").constantOr(1))Nn(_,I,k,z,V,Qi.disabled,ji.disabled),Nn(_,I,k,z,V,_.stencilModeFor3D(),_.colorModeForRenderPass());else{const G=_.colorModeForRenderPass();Nn(_,I,k,z,V,Qi.disabled,G)}}})(e,n,a,u);break;case"hillshade":(function(_,I,k,z){if(_.renderPass!=="offscreen"&&_.renderPass!=="translucent")return;const R=_.context,V=_.depthModeForSublayer(0,Si.ReadOnly),G=_.colorModeForRenderPass(),[Y,tt]=_.renderPass==="translucent"?_.stencilConfigForOverlap(z):[{},z];for(const ot of tt){const mt=I.getTile(ot);mt.needsHillshadePrepare!==void 0&&mt.needsHillshadePrepare&&_.renderPass==="offscreen"?As(_,mt,k,V,Qi.disabled,G):_.renderPass==="translucent"&&Jo(_,ot,mt,k,V,Y[ot.overscaledZ],G)}R.viewport.set([0,0,_.width,_.height])})(e,n,a,u);break;case"raster":(function(_,I,k,z){if(_.renderPass!=="translucent"||k.paint.get("raster-opacity")===0||!z.length)return;const R=_.context,V=R.gl,G=I.getSource(),Y=_.useProgram("raster"),tt=_.colorModeForRenderPass(),[ot,mt]=G instanceof ve?[{},z]:_.stencilConfigForOverlap(z),ut=mt[mt.length-1].overscaledZ,bt=!_.options.moving;for(const Pt of mt){const ht=_.depthModeForSublayer(Pt.overscaledZ-ut,k.paint.get("raster-opacity")===1?Si.ReadWrite:Si.ReadOnly,V.LESS),Dt=I.getTile(Pt);Dt.registerFadeDuration(k.paint.get("raster-fade-duration"));const Ut=I.findLoadedParent(Pt,0),$t=I.findLoadedSibling(Pt),_e=Ms(Dt,Ut||$t||null,I,k,_.transform,_.style.map.terrain);let Ce,Xe;const qe=k.paint.get("raster-resampling")==="nearest"?V.NEAREST:V.LINEAR;R.activeTexture.set(V.TEXTURE0),Dt.texture.bind(qe,V.CLAMP_TO_EDGE,V.LINEAR_MIPMAP_NEAREST),R.activeTexture.set(V.TEXTURE1),Ut?(Ut.texture.bind(qe,V.CLAMP_TO_EDGE,V.LINEAR_MIPMAP_NEAREST),Ce=Math.pow(2,Ut.tileID.overscaledZ-Dt.tileID.overscaledZ),Xe=[Dt.tileID.canonical.x*Ce%1,Dt.tileID.canonical.y*Ce%1]):Dt.texture.bind(qe,V.CLAMP_TO_EDGE,V.LINEAR_MIPMAP_NEAREST),Dt.texture.useMipmap&&R.extTextureFilterAnisotropic&&_.transform.pitch>20&&V.texParameterf(V.TEXTURE_2D,R.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,R.extTextureFilterAnisotropicMax);const Se=_.style.map.terrain&&_.style.map.terrain.getTerrainData(Pt),ke=Se?Pt:null,ti=ke?ke.posMatrix:_.transform.calculatePosMatrix(Pt.toUnwrapped(),bt),Ci=El(ti,Xe||[0,0],Ce||1,_e,k);G instanceof ve?Y.draw(R,V.TRIANGLES,ht,Qi.disabled,tt,$i.disabled,Ci,Se,k.id,G.boundsBuffer,_.quadTriangleIndexBuffer,G.boundsSegments):Y.draw(R,V.TRIANGLES,ht,ot[Pt.overscaledZ],tt,$i.disabled,Ci,Se,k.id,_.rasterBoundsBuffer,_.quadTriangleIndexBuffer,_.rasterBoundsSegments)}})(e,n,a,u);break;case"background":(function(_,I,k,z){const R=k.paint.get("background-color"),V=k.paint.get("background-opacity");if(V===0)return;const G=_.context,Y=G.gl,tt=_.transform,ot=tt.tileSize,mt=k.paint.get("background-pattern");if(_.isPatternMissing(mt))return;const ut=!mt&&R.a===1&&V===1&&_.opaquePassEnabledForLayer()?"opaque":"translucent";if(_.renderPass!==ut)return;const bt=Qi.disabled,Pt=_.depthModeForSublayer(0,ut==="opaque"?Si.ReadWrite:Si.ReadOnly),ht=_.colorModeForRenderPass(),Dt=_.useProgram(mt?"backgroundPattern":"background"),Ut=z||tt.coveringTiles({tileSize:ot,terrain:_.style.map.terrain});mt&&(G.activeTexture.set(Y.TEXTURE0),_.imageManager.bind(_.context));const $t=k.getCrossfadeParameters();for(const _e of Ut){const Ce=z?_e.posMatrix:_.transform.calculatePosMatrix(_e.toUnwrapped()),Xe=mt?Uo(Ce,V,_,mt,{tileID:_e,tileSize:ot},$t):go(Ce,V,R),qe=_.style.map.terrain&&_.style.map.terrain.getTerrainData(_e);Dt.draw(G,Y.TRIANGLES,Pt,bt,ht,$i.disabled,Xe,qe,k.id,_.tileExtentBuffer,_.quadTriangleIndexBuffer,_.tileExtentSegments)}})(e,0,a,u);break;case"custom":(function(_,I,k){const z=_.context,R=k.implementation;if(_.renderPass==="offscreen"){const V=R.prerender;V&&(_.setCustomLayerDefaults(),z.setColorMode(_.colorModeForRenderPass()),V.call(R,z.gl,_.transform.customLayerMatrix()),z.setDirty(),_.setBaseState())}else if(_.renderPass==="translucent"){_.setCustomLayerDefaults(),z.setColorMode(_.colorModeForRenderPass()),z.setStencilMode(Qi.disabled);const V=R.renderingMode==="3d"?new Si(_.context.gl.LEQUAL,Si.ReadWrite,_.depthRangeFor3D):_.depthModeForSublayer(0,Si.ReadOnly);z.setDepthMode(V),R.render(z.gl,_.transform.customLayerMatrix(),{farZ:_.transform.farZ,nearZ:_.transform.nearZ,fov:_.transform._fov,modelViewProjectionMatrix:_.transform.modelViewProjectionMatrix,projectionMatrix:_.transform.projectionMatrix}),z.setDirty(),_.setBaseState(),z.bindFramebuffer.set(null)}})(e,0,a)}}translatePosMatrix(e,n,a,u,_){if(!a[0]&&!a[1])return e;const I=_?u==="map"?this.transform.angle:0:u==="viewport"?-this.transform.angle:0;if(I){const R=Math.sin(I),V=Math.cos(I);a=[a[0]*V-a[1]*R,a[0]*R+a[1]*V]}const k=[_?a[0]:gi(n,a[0],this.transform.zoom),_?a[1]:gi(n,a[1],this.transform.zoom),0],z=new Float32Array(16);return s.J(z,e,k),z}saveTileTexture(e){const n=this._tileTextures[e.size[0]];n?n.push(e):this._tileTextures[e.size[0]]=[e]}getTileTexture(e){const n=this._tileTextures[e];return n&&n.length>0?n.pop():null}isPatternMissing(e){if(!e)return!1;if(!e.from||!e.to)return!0;const n=this.imageManager.getPattern(e.from.toString()),a=this.imageManager.getPattern(e.to.toString());return!n||!a}useProgram(e,n){this.cache=this.cache||{};const a=e+(n?n.cacheKey:"")+(this._showOverdrawInspector?"/overdraw":"")+(this.style.map.terrain?"/terrain":"");return this.cache[a]||(this.cache[a]=new K(this.context,hs[e],n,_o[e],this._showOverdrawInspector,this.style.map.terrain)),this.cache[a]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const e=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(e.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new Jt(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){const{drawingBufferWidth:e,drawingBufferHeight:n}=this.context.gl;return this.width!==e||this.height!==n}}class Pi{constructor(e,n){this.points=e,this.planes=n}static fromInvProjectionMatrix(e,n,a){const u=Math.pow(2,a),_=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(k=>{const z=1/(k=s.ag([],k,e))[3]/n*u;return s.b1(k,k,[z,z,1/k[3],z])}),I=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(k=>{const z=function(Y,tt){var ot=tt[0],mt=tt[1],ut=tt[2],bt=ot*ot+mt*mt+ut*ut;return bt>0&&(bt=1/Math.sqrt(bt)),Y[0]=tt[0]*bt,Y[1]=tt[1]*bt,Y[2]=tt[2]*bt,Y}([],function(Y,tt,ot){var mt=tt[0],ut=tt[1],bt=tt[2],Pt=ot[0],ht=ot[1],Dt=ot[2];return Y[0]=ut*Dt-bt*ht,Y[1]=bt*Pt-mt*Dt,Y[2]=mt*ht-ut*Pt,Y}([],nt([],_[k[0]],_[k[1]]),nt([],_[k[2]],_[k[1]]))),R=-((V=z)[0]*(G=_[k[1]])[0]+V[1]*G[1]+V[2]*G[2]);var V,G;return z.concat(R)});return new Pi(_,I)}}class fr{constructor(e,n){this.min=e,this.max=n,this.center=function(a,u,_){return a[0]=.5*u[0],a[1]=.5*u[1],a[2]=.5*u[2],a}([],function(a,u,_){return a[0]=u[0]+_[0],a[1]=u[1]+_[1],a[2]=u[2]+_[2],a}([],this.min,this.max))}quadrant(e){const n=[e%2==0,e<2],a=U(this.min),u=U(this.max);for(let _=0;_<n.length;_++)a[_]=n[_]?this.min[_]:this.center[_],u[_]=n[_]?this.center[_]:this.max[_];return u[2]=this.max[2],new fr(a,u)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}intersects(e){const n=[[this.min[0],this.min[1],this.min[2],1],[this.max[0],this.min[1],this.min[2],1],[this.max[0],this.max[1],this.min[2],1],[this.min[0],this.max[1],this.min[2],1],[this.min[0],this.min[1],this.max[2],1],[this.max[0],this.min[1],this.max[2],1],[this.max[0],this.max[1],this.max[2],1],[this.min[0],this.max[1],this.max[2],1]];let a=!0;for(let u=0;u<e.planes.length;u++){const _=e.planes[u];let I=0;for(let k=0;k<n.length;k++)s.b2(_,n[k])>=0&&I++;if(I===0)return 0;I!==n.length&&(a=!1)}if(a)return 2;for(let u=0;u<3;u++){let _=Number.MAX_VALUE,I=-Number.MAX_VALUE;for(let k=0;k<e.points.length;k++){const z=e.points[k][u]-this.min[u];_=Math.min(_,z),I=Math.max(I,z)}if(I<0||_>this.max[u]-this.min[u])return 0}return 1}}class br{constructor(e=0,n=0,a=0,u=0){if(isNaN(e)||e<0||isNaN(n)||n<0||isNaN(a)||a<0||isNaN(u)||u<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=e,this.bottom=n,this.left=a,this.right=u}interpolate(e,n,a){return n.top!=null&&e.top!=null&&(this.top=s.z.number(e.top,n.top,a)),n.bottom!=null&&e.bottom!=null&&(this.bottom=s.z.number(e.bottom,n.bottom,a)),n.left!=null&&e.left!=null&&(this.left=s.z.number(e.left,n.left,a)),n.right!=null&&e.right!=null&&(this.right=s.z.number(e.right,n.right,a)),this}getCenter(e,n){const a=s.ad((this.left+e-this.right)/2,0,e),u=s.ad((this.top+n-this.bottom)/2,0,n);return new s.P(a,u)}equals(e){return this.top===e.top&&this.bottom===e.bottom&&this.left===e.left&&this.right===e.right}clone(){return new br(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const mn=85.051129;class Pr{constructor(e,n,a,u,_){this.tileSize=512,this._renderWorldCopies=_===void 0||!!_,this._minZoom=e||0,this._maxZoom=n||22,this._minPitch=a??0,this._maxPitch=u??60,this.setMaxBounds(),this.width=0,this.height=0,this._center=new s.N(0,0),this._elevation=0,this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._unmodified=!0,this._edgeInsets=new br,this._posMatrixCache={},this._alignedPosMatrixCache={},this._fogMatrixCache={},this.minElevationForCurrentTile=0}clone(){const e=new Pr(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return e.apply(this),e}apply(e){this.tileSize=e.tileSize,this.latRange=e.latRange,this.width=e.width,this.height=e.height,this._center=e._center,this._elevation=e._elevation,this.minElevationForCurrentTile=e.minElevationForCurrentTile,this.zoom=e.zoom,this.angle=e.angle,this._fov=e._fov,this._pitch=e._pitch,this._unmodified=e._unmodified,this._edgeInsets=e._edgeInsets.clone(),this._calcMatrices()}get minZoom(){return this._minZoom}set minZoom(e){this._minZoom!==e&&(this._minZoom=e,this.zoom=Math.max(this.zoom,e))}get maxZoom(){return this._maxZoom}set maxZoom(e){this._maxZoom!==e&&(this._maxZoom=e,this.zoom=Math.min(this.zoom,e))}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch!==e&&(this._minPitch=e,this.pitch=Math.max(this.pitch,e))}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch!==e&&(this._maxPitch=e,this.pitch=Math.min(this.pitch,e))}get renderWorldCopies(){return this._renderWorldCopies}set renderWorldCopies(e){e===void 0?e=!0:e===null&&(e=!1),this._renderWorldCopies=e}get worldSize(){return this.tileSize*this.scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this.width,this.height)}get bearing(){return-this.angle/Math.PI*180}set bearing(e){const n=-s.b3(e,-180,180)*Math.PI/180;this.angle!==n&&(this._unmodified=!1,this.angle=n,this._calcMatrices(),this.rotationMatrix=function(){var a=new s.A(4);return s.A!=Float32Array&&(a[1]=0,a[2]=0),a[0]=1,a[3]=1,a}(),function(a,u,_){var I=u[0],k=u[1],z=u[2],R=u[3],V=Math.sin(_),G=Math.cos(_);a[0]=I*G+z*V,a[1]=k*G+R*V,a[2]=I*-V+z*G,a[3]=k*-V+R*G}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(e){const n=s.ad(e,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==n&&(this._unmodified=!1,this._pitch=n,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(e){e=Math.max(.01,Math.min(60,e)),this._fov!==e&&(this._unmodified=!1,this._fov=e/180*Math.PI,this._calcMatrices())}get zoom(){return this._zoom}set zoom(e){const n=Math.min(Math.max(e,this.minZoom),this.maxZoom);this._zoom!==n&&(this._unmodified=!1,this._zoom=n,this.tileZoom=Math.max(0,Math.floor(n)),this.scale=this.zoomScale(n),this._constrain(),this._calcMatrices())}get center(){return this._center}set center(e){e.lat===this._center.lat&&e.lng===this._center.lng||(this._unmodified=!1,this._center=e,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}set elevation(e){e!==this._elevation&&(this._elevation=e,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}set padding(e){this._edgeInsets.equals(e)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,e,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}isPaddingEqual(e){return this._edgeInsets.equals(e)}interpolatePadding(e,n,a){this._unmodified=!1,this._edgeInsets.interpolate(e,n,a),this._constrain(),this._calcMatrices()}coveringZoomLevel(e){const n=(e.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/e.tileSize));return Math.max(0,n)}getVisibleUnwrappedCoordinates(e){const n=[new s.b4(0,e)];if(this._renderWorldCopies){const a=this.pointCoordinate(new s.P(0,0)),u=this.pointCoordinate(new s.P(this.width,0)),_=this.pointCoordinate(new s.P(this.width,this.height)),I=this.pointCoordinate(new s.P(0,this.height)),k=Math.floor(Math.min(a.x,u.x,_.x,I.x)),z=Math.floor(Math.max(a.x,u.x,_.x,I.x)),R=1;for(let V=k-R;V<=z+R;V++)V!==0&&n.push(new s.b4(V,e))}return n}coveringTiles(e){var n,a;let u=this.coveringZoomLevel(e);const _=u;if(e.minzoom!==void 0&&u<e.minzoom)return[];e.maxzoom!==void 0&&u>e.maxzoom&&(u=e.maxzoom);const I=this.pointCoordinate(this.getCameraPoint()),k=s.Z.fromLngLat(this.center),z=Math.pow(2,u),R=[z*I.x,z*I.y,0],V=[z*k.x,z*k.y,0],G=Pi.fromInvProjectionMatrix(this.invModelViewProjectionMatrix,this.worldSize,u);let Y=e.minzoom||0;!e.terrain&&this.pitch<=60&&this._edgeInsets.top<.1&&(Y=u);const tt=e.terrain?2/Math.min(this.tileSize,e.tileSize)*this.tileSize:3,ot=ht=>({aabb:new fr([ht*z,0,0],[(ht+1)*z,z,0]),zoom:0,x:0,y:0,wrap:ht,fullyVisible:!1}),mt=[],ut=[],bt=u,Pt=e.reparseOverscaled?_:u;if(this._renderWorldCopies)for(let ht=1;ht<=3;ht++)mt.push(ot(-ht)),mt.push(ot(ht));for(mt.push(ot(0));mt.length>0;){const ht=mt.pop(),Dt=ht.x,Ut=ht.y;let $t=ht.fullyVisible;if(!$t){const Se=ht.aabb.intersects(G);if(Se===0)continue;$t=Se===2}const _e=e.terrain?R:V,Ce=ht.aabb.distanceX(_e),Xe=ht.aabb.distanceY(_e),qe=Math.max(Math.abs(Ce),Math.abs(Xe));if(ht.zoom===bt||qe>tt+(1<<bt-ht.zoom)-2&&ht.zoom>=Y){const Se=bt-ht.zoom,ke=R[0]-.5-(Dt<<Se),ti=R[1]-.5-(Ut<<Se);ut.push({tileID:new s.S(ht.zoom===bt?Pt:ht.zoom,ht.wrap,ht.zoom,Dt,Ut),distanceSq:xt([V[0]-.5-Dt,V[1]-.5-Ut]),tileDistanceToCamera:Math.sqrt(ke*ke+ti*ti)})}else for(let Se=0;Se<4;Se++){const ke=(Dt<<1)+Se%2,ti=(Ut<<1)+(Se>>1),Ci=ht.zoom+1;let ze=ht.aabb.quadrant(Se);if(e.terrain){const Ve=new s.S(Ci,ht.wrap,Ci,ke,ti),yi=e.terrain.getMinMaxElevation(Ve),gr=(n=yi.minElevation)!==null&&n!==void 0?n:this.elevation,Ii=(a=yi.maxElevation)!==null&&a!==void 0?a:this.elevation;ze=new fr([ze.min[0],ze.min[1],gr],[ze.max[0],ze.max[1],Ii])}mt.push({aabb:ze,zoom:Ci,x:ke,y:ti,wrap:ht.wrap,fullyVisible:$t})}}return ut.sort((ht,Dt)=>ht.distanceSq-Dt.distanceSq).map(ht=>ht.tileID)}resize(e,n){this.width=e,this.height=n,this.pixelsToGLUnits=[2/e,-2/n],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(e){return Math.pow(2,e)}scaleZoom(e){return Math.log(e)/Math.LN2}project(e){const n=s.ad(e.lat,-85.051129,mn);return new s.P(s.O(e.lng)*this.worldSize,s.Q(n)*this.worldSize)}unproject(e){return new s.Z(e.x/this.worldSize,e.y/this.worldSize).toLngLat()}get point(){return this.project(this.center)}getCameraPosition(){return{lngLat:this.pointLocation(this.getCameraPoint()),altitude:Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter+this.elevation}}recalculateZoom(e){const n=this.elevation,a=Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter,u=this.pointLocation(this.centerPoint,e),_=e.getElevationForLngLatZoom(u,this.tileZoom);if(!(this.elevation-_))return;const I=a+n-_,k=Math.cos(this._pitch)*this.cameraToCenterDistance/I/s.b5(1,u.lat),z=this.scaleZoom(k/this.tileSize);this._elevation=_,this._center=u,this.zoom=z}setLocationAtPoint(e,n){const a=this.pointCoordinate(n),u=this.pointCoordinate(this.centerPoint),_=this.locationCoordinate(e),I=new s.Z(_.x-(a.x-u.x),_.y-(a.y-u.y));this.center=this.coordinateLocation(I),this._renderWorldCopies&&(this.center=this.center.wrap())}locationPoint(e,n){return n?this.coordinatePoint(this.locationCoordinate(e),n.getElevationForLngLatZoom(e,this.tileZoom),this.pixelMatrix3D):this.coordinatePoint(this.locationCoordinate(e))}pointLocation(e,n){return this.coordinateLocation(this.pointCoordinate(e,n))}locationCoordinate(e){return s.Z.fromLngLat(e)}coordinateLocation(e){return e&&e.toLngLat()}pointCoordinate(e,n){if(n){const Y=n.pointCoordinate(e);if(Y!=null)return Y}const a=[e.x,e.y,0,1],u=[e.x,e.y,1,1];s.ag(a,a,this.pixelMatrixInverse),s.ag(u,u,this.pixelMatrixInverse);const _=a[3],I=u[3],k=a[1]/_,z=u[1]/I,R=a[2]/_,V=u[2]/I,G=R===V?0:(0-R)/(V-R);return new s.Z(s.z.number(a[0]/_,u[0]/I,G)/this.worldSize,s.z.number(k,z,G)/this.worldSize)}coordinatePoint(e,n=0,a=this.pixelMatrix){const u=[e.x*this.worldSize,e.y*this.worldSize,n,1];return s.ag(u,u,a),new s.P(u[0]/u[3],u[1]/u[3])}getBounds(){const e=Math.max(0,this.height/2-this.getHorizon());return new at().extend(this.pointLocation(new s.P(0,e))).extend(this.pointLocation(new s.P(this.width,e))).extend(this.pointLocation(new s.P(this.width,this.height))).extend(this.pointLocation(new s.P(0,this.height)))}getMaxBounds(){return this.latRange&&this.latRange.length===2&&this.lngRange&&this.lngRange.length===2?new at([this.lngRange[0],this.latRange[0]],[this.lngRange[1],this.latRange[1]]):null}getHorizon(){return Math.tan(Math.PI/2-this._pitch)*this.cameraToCenterDistance*.85}setMaxBounds(e){e?(this.lngRange=[e.getWest(),e.getEast()],this.latRange=[e.getSouth(),e.getNorth()],this._constrain()):(this.lngRange=null,this.latRange=[-85.051129,mn])}calculateTileMatrix(e){const n=e.canonical,a=this.worldSize/this.zoomScale(n.z),u=n.x+Math.pow(2,n.z)*e.wrap,_=s.ao(new Float64Array(16));return s.J(_,_,[u*a,n.y*a,0]),s.K(_,_,[a/s.X,a/s.X,1]),_}calculatePosMatrix(e,n=!1){const a=e.key,u=n?this._alignedPosMatrixCache:this._posMatrixCache;if(u[a])return u[a];const _=this.calculateTileMatrix(e);return s.L(_,n?this.alignedModelViewProjectionMatrix:this.modelViewProjectionMatrix,_),u[a]=new Float32Array(_),u[a]}calculateFogMatrix(e){const n=e.key,a=this._fogMatrixCache;if(a[n])return a[n];const u=this.calculateTileMatrix(e);return s.L(u,this.fogMatrix,u),a[n]=new Float32Array(u),a[n]}customLayerMatrix(){return this.mercatorMatrix.slice()}getConstrained(e,n){n=s.ad(+n,this.minZoom,this.maxZoom);const a={center:new s.N(e.lng,e.lat),zoom:n};let u=this.lngRange;if(!this._renderWorldCopies&&u===null){const ht=179.9999999999;u=[-ht,ht]}const _=this.tileSize*this.zoomScale(a.zoom);let I=0,k=_,z=0,R=_,V=0,G=0;const{x:Y,y:tt}=this.size;if(this.latRange){const ht=this.latRange;I=s.Q(ht[1])*_,k=s.Q(ht[0])*_,k-I<tt&&(V=tt/(k-I))}u&&(z=s.b3(s.O(u[0])*_,0,_),R=s.b3(s.O(u[1])*_,0,_),R<z&&(R+=_),R-z<Y&&(G=Y/(R-z)));const{x:ot,y:mt}=this.project.call({worldSize:_},e);let ut,bt;const Pt=Math.max(G||0,V||0);if(Pt){const ht=new s.P(G?(R+z)/2:ot,V?(k+I)/2:mt);return a.center=this.unproject.call({worldSize:_},ht).wrap(),a.zoom+=this.scaleZoom(Pt),a}if(this.latRange){const ht=tt/2;mt-ht<I&&(bt=I+ht),mt+ht>k&&(bt=k-ht)}if(u){const ht=(z+R)/2;let Dt=ot;this._renderWorldCopies&&(Dt=s.b3(ot,ht-_/2,ht+_/2));const Ut=Y/2;Dt-Ut<z&&(ut=z+Ut),Dt+Ut>R&&(ut=R-Ut)}if(ut!==void 0||bt!==void 0){const ht=new s.P(ut??ot,bt??mt);a.center=this.unproject.call({worldSize:_},ht).wrap()}return a}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const e=this._unmodified,{center:n,zoom:a}=this.getConstrained(this.center,this.zoom);this.center=n,this.zoom=a,this._unmodified=e,this._constraining=!1}_calcMatrices(){if(!this.height)return;const e=this.centerOffset,n=this.point.x,a=this.point.y;this.cameraToCenterDistance=.5/Math.tan(this._fov/2)*this.height,this._pixelPerMeter=s.b5(1,this.center.lat)*this.worldSize;let u=s.ao(new Float64Array(16));s.K(u,u,[this.width/2,-this.height/2,1]),s.J(u,u,[1,-1,0]),this.labelPlaneMatrix=u,u=s.ao(new Float64Array(16)),s.K(u,u,[1,-1,1]),s.J(u,u,[-1,-1,0]),s.K(u,u,[2/this.width,2/this.height,1]),this.glCoordMatrix=u;const _=this.cameraToCenterDistance+this._elevation*this._pixelPerMeter/Math.cos(this._pitch),I=Math.min(this.elevation,this.minElevationForCurrentTile),k=_-I*this._pixelPerMeter/Math.cos(this._pitch),z=I<0?k:_,R=Math.PI/2+this._pitch,V=this._fov*(.5+e.y/this.height),G=Math.sin(V)*z/Math.sin(s.ad(Math.PI-R-V,.01,Math.PI-.01)),Y=this.getHorizon(),tt=2*Math.atan(Y/this.cameraToCenterDistance)*(.5+e.y/(2*Y)),ot=Math.sin(tt)*z/Math.sin(s.ad(Math.PI-R-tt,.01,Math.PI-.01)),mt=Math.min(G,ot);this.farZ=1.01*(Math.cos(Math.PI/2-this._pitch)*mt+z),this.nearZ=this.height/50,u=new Float64Array(16),s.b6(u,this._fov,this.width/this.height,this.nearZ,this.farZ),u[8]=2*-e.x/this.width,u[9]=2*e.y/this.height,this.projectionMatrix=s.af(u),s.K(u,u,[1,-1,1]),s.J(u,u,[0,0,-this.cameraToCenterDistance]),s.b7(u,u,this._pitch),s.ae(u,u,this.angle),s.J(u,u,[-n,-a,0]),this.mercatorMatrix=s.K([],u,[this.worldSize,this.worldSize,this.worldSize]),s.K(u,u,[1,1,this._pixelPerMeter]),this.pixelMatrix=s.L(new Float64Array(16),this.labelPlaneMatrix,u),s.J(u,u,[0,0,-this.elevation]),this.modelViewProjectionMatrix=u,this.invModelViewProjectionMatrix=s.at([],u),this.fogMatrix=new Float64Array(16),s.b6(this.fogMatrix,this._fov,this.width/this.height,_,this.farZ),this.fogMatrix[8]=2*-e.x/this.width,this.fogMatrix[9]=2*e.y/this.height,s.K(this.fogMatrix,this.fogMatrix,[1,-1,1]),s.J(this.fogMatrix,this.fogMatrix,[0,0,-this.cameraToCenterDistance]),s.b7(this.fogMatrix,this.fogMatrix,this._pitch),s.ae(this.fogMatrix,this.fogMatrix,this.angle),s.J(this.fogMatrix,this.fogMatrix,[-n,-a,0]),s.K(this.fogMatrix,this.fogMatrix,[1,1,this._pixelPerMeter]),s.J(this.fogMatrix,this.fogMatrix,[0,0,-this.elevation]),this.pixelMatrix3D=s.L(new Float64Array(16),this.labelPlaneMatrix,u);const ut=this.width%2/2,bt=this.height%2/2,Pt=Math.cos(this.angle),ht=Math.sin(this.angle),Dt=n-Math.round(n)+Pt*ut+ht*bt,Ut=a-Math.round(a)+Pt*bt+ht*ut,$t=new Float64Array(u);if(s.J($t,$t,[Dt>.5?Dt-1:Dt,Ut>.5?Ut-1:Ut,0]),this.alignedModelViewProjectionMatrix=$t,u=s.at(new Float64Array(16),this.pixelMatrix),!u)throw new Error("failed to invert matrix");this.pixelMatrixInverse=u,this._posMatrixCache={},this._alignedPosMatrixCache={},this._fogMatrixCache={}}maxPitchScaleFactor(){if(!this.pixelMatrixInverse)return 1;const e=this.pointCoordinate(new s.P(0,0)),n=[e.x*this.worldSize,e.y*this.worldSize,0,1];return s.ag(n,n,this.pixelMatrix)[3]/this.cameraToCenterDistance}getCameraPoint(){const e=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(0,e))}getCameraQueryGeometry(e){const n=this.getCameraPoint();if(e.length===1)return[e[0],n];{let a=n.x,u=n.y,_=n.x,I=n.y;for(const k of e)a=Math.min(a,k.x),u=Math.min(u,k.y),_=Math.max(_,k.x),I=Math.max(I,k.y);return[new s.P(a,u),new s.P(_,u),new s.P(_,I),new s.P(a,I),new s.P(a,u)]}}lngLatToCameraDepth(e,n){const a=this.locationCoordinate(e),u=[a.x*this.worldSize,a.y*this.worldSize,n,1];return s.ag(u,u,this.modelViewProjectionMatrix),u[2]/u[3]}}function wr(y,e){let n,a=!1,u=null,_=null;const I=()=>{u=null,a&&(y.apply(_,n),u=setTimeout(I,e),a=!1)};return(...k)=>(a=!0,_=this,n=k,u||I(),u)}class en{constructor(e){this._getCurrentHash=()=>{const n=window.location.hash.replace("#","");if(this._hashName){let a;return n.split("&").map(u=>u.split("=")).forEach(u=>{u[0]===this._hashName&&(a=u)}),(a&&a[1]||"").split("/")}return n.split("/")},this._onHashChange=()=>{const n=this._getCurrentHash();if(n.length>=3&&!n.some(a=>isNaN(a))){const a=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(n[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+n[2],+n[1]],zoom:+n[0],bearing:a,pitch:+(n[4]||0)}),!0}return!1},this._updateHashUnthrottled=()=>{const n=window.location.href.replace(/(#.+)?$/,this.getHashString());window.history.replaceState(window.history.state,null,n)},this._removeHash=()=>{const n=this._getCurrentHash();if(n.length===0)return;const a=n.join("/");let u=a;u.split("&").length>0&&(u=u.split("&")[0]),this._hashName&&(u=`${this._hashName}=${a}`);let _=window.location.hash.replace(u,"");_.startsWith("#&")?_=_.slice(0,1)+_.slice(2):_==="#"&&(_="");let I=window.location.href.replace(/(#.+)?$/,_);I=I.replace("&&","&"),window.history.replaceState(window.history.state,null,I)},this._updateHash=wr(this._updateHashUnthrottled,300),this._hashName=e&&encodeURIComponent(e)}addTo(e){return this._map=e,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(e){const n=this._map.getCenter(),a=Math.round(100*this._map.getZoom())/100,u=Math.ceil((a*Math.LN2+Math.log(512/360/.5))/Math.LN10),_=Math.pow(10,u),I=Math.round(n.lng*_)/_,k=Math.round(n.lat*_)/_,z=this._map.getBearing(),R=this._map.getPitch();let V="";if(V+=e?`/${I}/${k}/${a}`:`${a}/${k}/${I}`,(z||R)&&(V+="/"+Math.round(10*z)/10),R&&(V+=`/${Math.round(R)}`),this._hashName){const G=this._hashName;let Y=!1;const tt=window.location.hash.slice(1).split("&").map(ot=>{const mt=ot.split("=")[0];return mt===G?(Y=!0,`${mt}=${V}`):ot}).filter(ot=>ot);return Y||tt.push(`${G}=${V}`),`#${tt.join("&")}`}return`#${V}`}}const Zr={linearity:.3,easing:s.b8(0,0,.3,1)},Vr=s.e({deceleration:2500,maxSpeed:1400},Zr),Ln=s.e({deceleration:20,maxSpeed:1400},Zr),ks=s.e({deceleration:1e3,maxSpeed:360},Zr),Os=s.e({deceleration:1e3,maxSpeed:90},Zr);class Kn{constructor(e){this._map=e,this.clear()}clear(){this._inertiaBuffer=[]}record(e){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:l.now(),settings:e})}_drainInertiaBuffer(){const e=this._inertiaBuffer,n=l.now();for(;e.length>0&&n-e[0].time>160;)e.shift()}_onMoveEnd(e){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const n={zoom:0,bearing:0,pitch:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:_}of this._inertiaBuffer)n.zoom+=_.zoomDelta||0,n.bearing+=_.bearingDelta||0,n.pitch+=_.pitchDelta||0,_.panDelta&&n.pan._add(_.panDelta),_.around&&(n.around=_.around),_.pinchAround&&(n.pinchAround=_.pinchAround);const a=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,u={};if(n.pan.mag()){const _=Io(n.pan.mag(),a,s.e({},Vr,e||{}));u.offset=n.pan.mult(_.amount/n.pan.mag()),u.center=this._map.transform.center,Un(u,_)}if(n.zoom){const _=Io(n.zoom,a,Ln);u.zoom=this._map.transform.zoom+_.amount,Un(u,_)}if(n.bearing){const _=Io(n.bearing,a,ks);u.bearing=this._map.transform.bearing+s.ad(_.amount,-179,179),Un(u,_)}if(n.pitch){const _=Io(n.pitch,a,Os);u.pitch=this._map.transform.pitch+_.amount,Un(u,_)}if(u.zoom||u.bearing){const _=n.pinchAround===void 0?n.around:n.pinchAround;u.around=_?this._map.unproject(_):this._map.getCenter()}return this.clear(),s.e(u,{noMoveStart:!0})}}function Un(y,e){(!y.duration||y.duration<e.duration)&&(y.duration=e.duration,y.easing=e.easing)}function Io(y,e,n){const{maxSpeed:a,linearity:u,deceleration:_}=n,I=s.ad(y*u/(e/1e3),-a,a),k=Math.abs(I)/(_*u);return{easing:n.easing,duration:1e3*k,amount:I*(k/2)}}class Kr extends s.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,n,a,u={}){const _=c.mousePos(n.getCanvas(),a),I=n.unproject(_);super(e,s.e({point:_,lngLat:I,originalEvent:a},u)),this._defaultPrevented=!1,this.target=n}}class Ao extends s.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,n,a){const u=e==="touchend"?a.changedTouches:a.touches,_=c.touchPos(n.getCanvasContainer(),u),I=_.map(z=>n.unproject(z)),k=_.reduce((z,R,V,G)=>z.add(R.div(G.length)),new s.P(0,0));super(e,{points:_,point:k,lngLats:I,lngLat:n.unproject(k),originalEvent:a}),this._defaultPrevented=!1}}class Ki extends s.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,n,a){super(e,{originalEvent:a}),this._defaultPrevented=!1}}class Vi{constructor(e,n){this._map=e,this._clickTolerance=n.clickTolerance}reset(){delete this._mousedownPos}wheel(e){return this._firePreventable(new Ki(e.type,this._map,e))}mousedown(e,n){return this._mousedownPos=n,this._firePreventable(new Kr(e.type,this._map,e))}mouseup(e){this._map.fire(new Kr(e.type,this._map,e))}click(e,n){this._mousedownPos&&this._mousedownPos.dist(n)>=this._clickTolerance||this._map.fire(new Kr(e.type,this._map,e))}dblclick(e){return this._firePreventable(new Kr(e.type,this._map,e))}mouseover(e){this._map.fire(new Kr(e.type,this._map,e))}mouseout(e){this._map.fire(new Kr(e.type,this._map,e))}touchstart(e){return this._firePreventable(new Ao(e.type,this._map,e))}touchmove(e){this._map.fire(new Ao(e.type,this._map,e))}touchend(e){this._map.fire(new Ao(e.type,this._map,e))}touchcancel(e){this._map.fire(new Ao(e.type,this._map,e))}_firePreventable(e){if(this._map.fire(e),e.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ys{constructor(e){this._map=e}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(e){this._map.fire(new Kr(e.type,this._map,e))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Kr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(e){this._delayContextMenu?this._contextMenuEvent=e:this._ignoreContextMenu||this._map.fire(new Kr(e.type,this._map,e)),this._map.listens("contextmenu")&&e.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class gn{constructor(e){this._map=e}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(e){return this.transform.pointLocation(s.P.convert(e),this._map.terrain)}}class Mo{constructor(e,n){this._map=e,this._tr=new gn(e),this._el=e.getCanvasContainer(),this._container=e.getContainer(),this._clickTolerance=n.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(e,n){this.isEnabled()&&e.shiftKey&&e.button===0&&(c.disableDrag(),this._startPos=this._lastPos=n,this._active=!0)}mousemoveWindow(e,n){if(!this._active)return;const a=n;if(this._lastPos.equals(a)||!this._box&&a.dist(this._startPos)<this._clickTolerance)return;const u=this._startPos;this._lastPos=a,this._box||(this._box=c.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",e));const _=Math.min(u.x,a.x),I=Math.max(u.x,a.x),k=Math.min(u.y,a.y),z=Math.max(u.y,a.y);c.setTransform(this._box,`translate(${_}px,${k}px)`),this._box.style.width=I-_+"px",this._box.style.height=z-k+"px"}mouseupWindow(e,n){if(!this._active||e.button!==0)return;const a=this._startPos,u=n;if(this.reset(),c.suppressClick(),a.x!==u.x||a.y!==u.y)return this._map.fire(new s.k("boxzoomend",{originalEvent:e})),{cameraAnimation:_=>_.fitScreenCoordinates(a,u,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",e)}keydown(e){this._active&&e.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",e))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(c.remove(this._box),this._box=null),c.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(e,n){return this._map.fire(new s.k(e,{originalEvent:n}))}}function Ur(y,e){if(y.length!==e.length)throw new Error(`The number of touches and points are not equal - touches ${y.length}, points ${e.length}`);const n={};for(let a=0;a<y.length;a++)n[y[a].identifier]=e[a];return n}class zn{constructor(e){this.reset(),this.numTouches=e.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(e,n,a){(this.centroid||a.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=e.timeStamp),a.length===this.numTouches&&(this.centroid=function(u){const _=new s.P(0,0);for(const I of u)_._add(I);return _.div(u.length)}(n),this.touches=Ur(a,n)))}touchmove(e,n,a){if(this.aborted||!this.centroid)return;const u=Ur(a,n);for(const _ in this.touches){const I=u[_];(!I||I.dist(this.touches[_])>30)&&(this.aborted=!0)}}touchend(e,n,a){if((!this.centroid||e.timeStamp-this.startTime>500)&&(this.aborted=!0),a.length===0){const u=!this.aborted&&this.centroid;if(this.reset(),u)return u}}}class Gn{constructor(e){this.singleTap=new zn(e),this.numTaps=e.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(e,n,a){this.singleTap.touchstart(e,n,a)}touchmove(e,n,a){this.singleTap.touchmove(e,n,a)}touchend(e,n,a){const u=this.singleTap.touchend(e,n,a);if(u){const _=e.timeStamp-this.lastTime<500,I=!this.lastTap||this.lastTap.dist(u)<30;if(_&&I||this.reset(),this.count++,this.lastTime=e.timeStamp,this.lastTap=u,this.count===this.numTaps)return this.reset(),u}}}class Zs{constructor(e){this._tr=new gn(e),this._zoomIn=new Gn({numTouches:1,numTaps:2}),this._zoomOut=new Gn({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(e,n,a){this._zoomIn.touchstart(e,n,a),this._zoomOut.touchstart(e,n,a)}touchmove(e,n,a){this._zoomIn.touchmove(e,n,a),this._zoomOut.touchmove(e,n,a)}touchend(e,n,a){const u=this._zoomIn.touchend(e,n,a),_=this._zoomOut.touchend(e,n,a),I=this._tr;return u?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:k=>k.easeTo({duration:300,zoom:I.zoom+1,around:I.unproject(u)},{originalEvent:e})}):_?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:k=>k.easeTo({duration:300,zoom:I.zoom-1,around:I.unproject(_)},{originalEvent:e})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ji{constructor(e){this._enabled=!!e.enable,this._moveStateManager=e.moveStateManager,this._clickTolerance=e.clickTolerance||1,this._moveFunction=e.move,this._activateOnStart=!!e.activateOnStart,e.assignEvents(this),this.reset()}reset(e){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(e)}_move(...e){const n=this._moveFunction(...e);if(n.bearingDelta||n.pitchDelta||n.around||n.panDelta)return this._active=!0,n}dragStart(e,n){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(e)&&(this._moveStateManager.startMove(e),this._lastPoint=n.length?n[0]:n,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(e,n){if(!this.isEnabled())return;const a=this._lastPoint;if(!a)return;if(e.preventDefault(),!this._moveStateManager.isValidMoveEvent(e))return void this.reset(e);const u=n.length?n[0]:n;return!this._moved&&u.dist(a)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=u,this._move(a,u))}dragEnd(e){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(e)&&(this._moved&&c.suppressClick(),this.reset(e))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const wn={0:1,2:2};class Or{constructor(e){this._correctEvent=e.checkCorrectEvent}startMove(e){const n=c.mouseButton(e);this._eventButton=n}endMove(e){delete this._eventButton}isValidStartEvent(e){return this._correctEvent(e)}isValidMoveEvent(e){return!function(n,a){const u=wn[a];return n.buttons===void 0||(n.buttons&u)!==u}(e,this._eventButton)}isValidEndEvent(e){return c.mouseButton(e)===this._eventButton}}class ko{constructor(){this._firstTouch=void 0}_isOneFingerTouch(e){return e.targetTouches.length===1}_isSameTouchEvent(e){return e.targetTouches[0].identifier===this._firstTouch}startMove(e){this._firstTouch=e.targetTouches[0].identifier}endMove(e){delete this._firstTouch}isValidStartEvent(e){return this._isOneFingerTouch(e)}isValidMoveEvent(e){return this._isOneFingerTouch(e)&&this._isSameTouchEvent(e)}isValidEndEvent(e){return this._isOneFingerTouch(e)&&this._isSameTouchEvent(e)}}const ps=y=>{y.mousedown=y.dragStart,y.mousemoveWindow=y.dragMove,y.mouseup=y.dragEnd,y.contextmenu=e=>{e.preventDefault()}},Oo=({enable:y,clickTolerance:e,bearingDegreesPerPixelMoved:n=.8})=>{const a=new Or({checkCorrectEvent:u=>c.mouseButton(u)===0&&u.ctrlKey||c.mouseButton(u)===2});return new Ji({clickTolerance:e,move:(u,_)=>({bearingDelta:(_.x-u.x)*n}),moveStateManager:a,enable:y,assignEvents:ps})},Xn=({enable:y,clickTolerance:e,pitchDegreesPerPixelMoved:n=-.5})=>{const a=new Or({checkCorrectEvent:u=>c.mouseButton(u)===0&&u.ctrlKey||c.mouseButton(u)===2});return new Ji({clickTolerance:e,move:(u,_)=>({pitchDelta:(_.y-u.y)*n}),moveStateManager:a,enable:y,assignEvents:ps})};class ms{constructor(e,n){this._clickTolerance=e.clickTolerance||1,this._map=n,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}_shouldBePrevented(e){return e<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(e,n,a){return this._calculateTransform(e,n,a)}touchmove(e,n,a){if(this._active){if(!this._shouldBePrevented(a.length))return e.preventDefault(),this._calculateTransform(e,n,a);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",e)}}touchend(e,n,a){this._calculateTransform(e,n,a),this._active&&this._shouldBePrevented(a.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(e,n,a){a.length>0&&(this._active=!0);const u=Ur(a,n),_=new s.P(0,0),I=new s.P(0,0);let k=0;for(const R in u){const V=u[R],G=this._touches[R];G&&(_._add(V),I._add(V.sub(G)),k++,u[R]=V)}if(this._touches=u,this._shouldBePrevented(k)||!I.mag())return;const z=I.div(k);return this._sum._add(z),this._sum.mag()<this._clickTolerance?void 0:{around:_.div(k),panDelta:z}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ks{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(e,n,a){this._firstTwoTouches||a.length<2||(this._firstTwoTouches=[a[0].identifier,a[1].identifier],this._start([n[0],n[1]]))}touchmove(e,n,a){if(!this._firstTwoTouches)return;e.preventDefault();const[u,_]=this._firstTwoTouches,I=gs(a,n,u),k=gs(a,n,_);if(!I||!k)return;const z=this._aroundCenter?null:I.add(k).div(2);return this._move([I,k],z,e)}touchend(e,n,a){if(!this._firstTwoTouches)return;const[u,_]=this._firstTwoTouches,I=gs(a,n,u),k=gs(a,n,_);I&&k||(this._active&&c.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(e){this._enabled=!0,this._aroundCenter=!!e&&e.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function gs(y,e,n){for(let a=0;a<y.length;a++)if(y[a].identifier===n)return e[a]}function Js(y,e){return Math.log(y/e)/Math.LN2}class Ml extends Ks{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(e){this._startDistance=this._distance=e[0].dist(e[1])}_move(e,n){const a=this._distance;if(this._distance=e[0].dist(e[1]),this._active||!(Math.abs(Js(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Js(this._distance,a),pinchAround:n}}}function kl(y,e){return 180*y.angleWith(e)/Math.PI}class Ol extends Ks{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(e){this._startVector=this._vector=e[0].sub(e[1]),this._minDiameter=e[0].dist(e[1])}_move(e,n,a){const u=this._vector;if(this._vector=e[0].sub(e[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:kl(this._vector,u),pinchAround:n}}_isBelowThreshold(e){this._minDiameter=Math.min(this._minDiameter,e.mag());const n=25/(Math.PI*this._minDiameter)*360,a=kl(e,this._startVector);return Math.abs(a)<n}}function Ds(y){return Math.abs(y.y)>Math.abs(y.x)}class Dl extends Ks{constructor(e){super(),this._currentTouchCount=0,this._map=e}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(e,n,a){super.touchstart(e,n,a),this._currentTouchCount=a.length}_start(e){this._lastPoints=e,Ds(e[0].sub(e[1]))&&(this._valid=!1)}_move(e,n,a){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const u=e[0].sub(this._lastPoints[0]),_=e[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(u,_,a.timeStamp),this._valid?(this._lastPoints=e,this._active=!0,{pitchDelta:(u.y+_.y)/2*-.5}):void 0}gestureBeginsVertically(e,n,a){if(this._valid!==void 0)return this._valid;const u=e.mag()>=2,_=n.mag()>=2;if(!u&&!_)return;if(!u||!_)return this._firstMove===void 0&&(this._firstMove=a),a-this._firstMove<100&&void 0;const I=e.y>0==n.y>0;return Ds(e)&&Ds(n)&&I}}const gc={panStep:100,bearingStep:15,pitchStep:10};class Ll{constructor(e){this._tr=new gn(e);const n=gc;this._panStep=n.panStep,this._bearingStep=n.bearingStep,this._pitchStep=n.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(e){if(e.altKey||e.ctrlKey||e.metaKey)return;let n=0,a=0,u=0,_=0,I=0;switch(e.keyCode){case 61:case 107:case 171:case 187:n=1;break;case 189:case 109:case 173:n=-1;break;case 37:e.shiftKey?a=-1:(e.preventDefault(),_=-1);break;case 39:e.shiftKey?a=1:(e.preventDefault(),_=1);break;case 38:e.shiftKey?u=1:(e.preventDefault(),I=-1);break;case 40:e.shiftKey?u=-1:(e.preventDefault(),I=1);break;default:return}return this._rotationDisabled&&(a=0,u=0),{cameraAnimation:k=>{const z=this._tr;k.easeTo({duration:300,easeId:"keyboardHandler",easing:_c,zoom:n?Math.round(z.zoom)+n*(e.shiftKey?2:1):z.zoom,bearing:z.bearing+a*this._bearingStep,pitch:z.pitch+u*this._pitchStep,offset:[-_*this._panStep,-I*this._panStep],center:z.center},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function _c(y){return y*(2-y)}const zl=4.000244140625;class Fl{constructor(e,n){this._onTimeout=a=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(a)},this._map=e,this._tr=new gn(e),this._triggerRenderFrame=n,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222}setZoomRate(e){this._defaultZoomRate=e}setWheelZoomRate(e){this._wheelZoomRate=e}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(e){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!e&&e.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(e){return!!this._map.cooperativeGestures.isEnabled()&&!(e.ctrlKey||this._map.cooperativeGestures.isBypassed(e))}wheel(e){if(!this.isEnabled())return;if(this._shouldBePrevented(e))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",e);let n=e.deltaMode===WheelEvent.DOM_DELTA_LINE?40*e.deltaY:e.deltaY;const a=l.now(),u=a-(this._lastWheelEventTime||0);this._lastWheelEventTime=a,n!==0&&n%zl==0?this._type="wheel":n!==0&&Math.abs(n)<4?this._type="trackpad":u>400?(this._type=null,this._lastValue=n,this._timeout=setTimeout(this._onTimeout,40,e)):this._type||(this._type=Math.abs(u*n)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,n+=this._lastValue)),e.shiftKey&&n&&(n/=4),this._type&&(this._lastWheelEvent=e,this._delta-=n,this._active||this._start(e)),e.preventDefault()}_start(e){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const n=c.mousePos(this._map.getCanvas(),e),a=this._tr;this._around=n.y>a.transform.height/2-a.transform.getHorizon()?s.N.convert(this._aroundCenter?a.center:a.unproject(n)):s.N.convert(a.center),this._aroundPoint=a.transform.locationPoint(this._around),this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const e=this._tr.transform;if(this._delta!==0){const z=this._type==="wheel"&&Math.abs(this._delta)>zl?this._wheelZoomRate:this._defaultZoomRate;let R=2/(1+Math.exp(-Math.abs(this._delta*z)));this._delta<0&&R!==0&&(R=1/R);const V=typeof this._targetZoom=="number"?e.zoomScale(this._targetZoom):e.scale;this._targetZoom=Math.min(e.maxZoom,Math.max(e.minZoom,e.scaleZoom(V*R))),this._type==="wheel"&&(this._startZoom=e.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const n=typeof this._targetZoom=="number"?this._targetZoom:e.zoom,a=this._startZoom,u=this._easing;let _,I=!1;const k=l.now()-this._lastWheelEventTime;if(this._type==="wheel"&&a&&u&&k){const z=Math.min(k/200,1),R=u(z);_=s.z.number(a,n,R),z<1?this._frameId||(this._frameId=!0):I=!0}else _=n,I=!0;return this._active=!0,I&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!I,zoomDelta:_-e.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(e){let n=s.b9;if(this._prevEase){const a=this._prevEase,u=(l.now()-a.start)/a.duration,_=a.easing(u+.01)-a.easing(u),I=.27/Math.sqrt(_*_+1e-4)*.01,k=Math.sqrt(.0729-I*I);n=s.b8(I,k,.25,1)}return this._prevEase={start:l.now(),duration:e,easing:n},n}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class Rl{constructor(e,n){this._clickZoom=e,this._tapZoom=n}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Oa{constructor(e){this._tr=new gn(e),this.reset()}reset(){this._active=!1}dblclick(e,n){return e.preventDefault(),{cameraAnimation:a=>{a.easeTo({duration:300,zoom:this._tr.zoom+(e.shiftKey?-1:1),around:this._tr.unproject(n)},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class yc{constructor(){this._tap=new Gn({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(e,n,a){if(!this._swipePoint)if(this._tapTime){const u=n[0],_=e.timeStamp-this._tapTime<500,I=this._tapPoint.dist(u)<30;_&&I?a.length>0&&(this._swipePoint=u,this._swipeTouch=a[0].identifier):this.reset()}else this._tap.touchstart(e,n,a)}touchmove(e,n,a){if(this._tapTime){if(this._swipePoint){if(a[0].identifier!==this._swipeTouch)return;const u=n[0],_=u.y-this._swipePoint.y;return this._swipePoint=u,e.preventDefault(),this._active=!0,{zoomDelta:_/128}}}else this._tap.touchmove(e,n,a)}touchend(e,n,a){if(this._tapTime)this._swipePoint&&a.length===0&&this.reset();else{const u=this._tap.touchend(e,n,a);u&&(this._tapTime=e.timeStamp,this._tapPoint=u)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Wn{constructor(e,n,a){this._el=e,this._mousePan=n,this._touchPan=a}enable(e){this._inertiaOptions=e||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Jn{constructor(e,n,a){this._pitchWithRotate=e.pitchWithRotate,this._mouseRotate=n,this._mousePitch=a}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Bl{constructor(e,n,a,u){this._el=e,this._touchZoom=n,this._touchRotate=a,this._tapDragZoom=u,this._rotationDisabled=!1,this._enabled=!0}enable(e){this._touchZoom.enable(e),this._rotationDisabled||this._touchRotate.enable(e),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class Qn{constructor(e,n){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=e,this._options=n,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const e=this._map.getCanvasContainer();e.classList.add("maplibregl-cooperative-gestures"),this._container=c.create("div","maplibregl-cooperative-gesture-screen",e);let n=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(n=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const a=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),u=document.createElement("div");u.className="maplibregl-desktop-message",u.textContent=n,this._container.appendChild(u);const _=document.createElement("div");_.className="maplibregl-mobile-message",_.textContent=a,this._container.appendChild(_),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(c.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(e){return e[this._bypassKey]}notifyGestureBlocked(e,n){this._enabled&&(this._map.fire(new s.k("cooperativegestureprevented",{gestureType:e,originalEvent:n})),this._container.classList.add("maplibregl-show"),setTimeout(()=>{this._container.classList.remove("maplibregl-show")},100))}}const Ls=y=>y.zoom||y.drag||y.pitch||y.rotate;class nh extends s.k{}function jl(y){return y.panDelta&&y.panDelta.mag()||y.zoomDelta||y.bearingDelta||y.pitchDelta}class sh{constructor(e,n){this.handleWindowEvent=u=>{this.handleEvent(u,`${u.type}Window`)},this.handleEvent=(u,_)=>{if(u.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const I=u.type==="renderFrame"?void 0:u,k={needsRenderFrame:!1},z={},R={},V=u.touches,G=V?this._getMapTouches(V):void 0,Y=G?c.touchPos(this._map.getCanvas(),G):c.mousePos(this._map.getCanvas(),u);for(const{handlerName:mt,handler:ut,allowed:bt}of this._handlers){if(!ut.isEnabled())continue;let Pt;this._blockedByActive(R,bt,mt)?ut.reset():ut[_||u.type]&&(Pt=ut[_||u.type](u,Y,G),this.mergeHandlerResult(k,z,Pt,mt,I),Pt&&Pt.needsRenderFrame&&this._triggerRenderFrame()),(Pt||ut.isActive())&&(R[mt]=ut)}const tt={};for(const mt in this._previousActiveHandlers)R[mt]||(tt[mt]=I);this._previousActiveHandlers=R,(Object.keys(tt).length||jl(k))&&(this._changes.push([k,z,tt]),this._triggerRenderFrame()),(Object.keys(R).length||jl(k))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:ot}=k;ot&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],ot(this._map))},this._map=e,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Kn(e),this._bearingSnap=n.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(n);const a=this._el;this._listeners=[[a,"touchstart",{passive:!0}],[a,"touchmove",{passive:!1}],[a,"touchend",void 0],[a,"touchcancel",void 0],[a,"mousedown",void 0],[a,"mousemove",void 0],[a,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[a,"mouseover",void 0],[a,"mouseout",void 0],[a,"dblclick",void 0],[a,"click",void 0],[a,"keydown",{capture:!1}],[a,"keyup",void 0],[a,"wheel",{passive:!1}],[a,"contextmenu",void 0],[window,"blur",void 0]];for(const[u,_,I]of this._listeners)c.addEventListener(u,_,u===document?this.handleWindowEvent:this.handleEvent,I)}destroy(){for(const[e,n,a]of this._listeners)c.removeEventListener(e,n,e===document?this.handleWindowEvent:this.handleEvent,a)}_addDefaultHandlers(e){const n=this._map,a=n.getCanvasContainer();this._add("mapEvent",new Vi(n,e));const u=n.boxZoom=new Mo(n,e);this._add("boxZoom",u),e.interactive&&e.boxZoom&&u.enable();const _=n.cooperativeGestures=new Qn(n,e.cooperativeGestures);this._add("cooperativeGestures",_),e.cooperativeGestures&&_.enable();const I=new Zs(n),k=new Oa(n);n.doubleClickZoom=new Rl(k,I),this._add("tapZoom",I),this._add("clickZoom",k),e.interactive&&e.doubleClickZoom&&n.doubleClickZoom.enable();const z=new yc;this._add("tapDragZoom",z);const R=n.touchPitch=new Dl(n);this._add("touchPitch",R),e.interactive&&e.touchPitch&&n.touchPitch.enable(e.touchPitch);const V=Oo(e),G=Xn(e);n.dragRotate=new Jn(e,V,G),this._add("mouseRotate",V,["mousePitch"]),this._add("mousePitch",G,["mouseRotate"]),e.interactive&&e.dragRotate&&n.dragRotate.enable();const Y=(({enable:Pt,clickTolerance:ht})=>{const Dt=new Or({checkCorrectEvent:Ut=>c.mouseButton(Ut)===0&&!Ut.ctrlKey});return new Ji({clickTolerance:ht,move:(Ut,$t)=>({around:$t,panDelta:$t.sub(Ut)}),activateOnStart:!0,moveStateManager:Dt,enable:Pt,assignEvents:ps})})(e),tt=new ms(e,n);n.dragPan=new Wn(a,Y,tt),this._add("mousePan",Y),this._add("touchPan",tt,["touchZoom","touchRotate"]),e.interactive&&e.dragPan&&n.dragPan.enable(e.dragPan);const ot=new Ol,mt=new Ml;n.touchZoomRotate=new Bl(a,mt,ot,z),this._add("touchRotate",ot,["touchPan","touchZoom"]),this._add("touchZoom",mt,["touchPan","touchRotate"]),e.interactive&&e.touchZoomRotate&&n.touchZoomRotate.enable(e.touchZoomRotate);const ut=n.scrollZoom=new Fl(n,()=>this._triggerRenderFrame());this._add("scrollZoom",ut,["mousePan"]),e.interactive&&e.scrollZoom&&n.scrollZoom.enable(e.scrollZoom);const bt=n.keyboard=new Ll(n);this._add("keyboard",bt),e.interactive&&e.keyboard&&n.keyboard.enable(),this._add("blockableMapEvent",new Ys(n))}_add(e,n,a){this._handlers.push({handlerName:e,handler:n,allowed:a}),this._handlersById[e]=n}stop(e){if(!this._updatingCamera){for(const{handler:n}of this._handlers)n.reset();this._inertia.clear(),this._fireEvents({},{},e),this._changes=[]}}isActive(){for(const{handler:e}of this._handlers)if(e.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Ls(this._eventsInProgress)||this.isZooming()}_blockedByActive(e,n,a){for(const u in e)if(u!==a&&(!n||n.indexOf(u)<0))return!0;return!1}_getMapTouches(e){const n=[];for(const a of e)this._el.contains(a.target)&&n.push(a);return n}mergeHandlerResult(e,n,a,u,_){if(!a)return;s.e(e,a);const I={handlerName:u,originalEvent:a.originalEvent||_};a.zoomDelta!==void 0&&(n.zoom=I),a.panDelta!==void 0&&(n.drag=I),a.pitchDelta!==void 0&&(n.pitch=I),a.bearingDelta!==void 0&&(n.rotate=I)}_applyChanges(){const e={},n={},a={};for(const[u,_,I]of this._changes)u.panDelta&&(e.panDelta=(e.panDelta||new s.P(0,0))._add(u.panDelta)),u.zoomDelta&&(e.zoomDelta=(e.zoomDelta||0)+u.zoomDelta),u.bearingDelta&&(e.bearingDelta=(e.bearingDelta||0)+u.bearingDelta),u.pitchDelta&&(e.pitchDelta=(e.pitchDelta||0)+u.pitchDelta),u.around!==void 0&&(e.around=u.around),u.pinchAround!==void 0&&(e.pinchAround=u.pinchAround),u.noInertia&&(e.noInertia=u.noInertia),s.e(n,_),s.e(a,I);this._updateMapTransform(e,n,a),this._changes=[]}_updateMapTransform(e,n,a){const u=this._map,_=u._getTransformForUpdate(),I=u.terrain;if(!(jl(e)||I&&this._terrainMovement))return this._fireEvents(n,a,!0);let{panDelta:k,zoomDelta:z,bearingDelta:R,pitchDelta:V,around:G,pinchAround:Y}=e;Y!==void 0&&(G=Y),u._stop(!0),G=G||u.transform.centerPoint;const tt=_.pointLocation(k?G.sub(k):G);R&&(_.bearing+=R),V&&(_.pitch+=V),z&&(_.zoom+=z),I?this._terrainMovement||!n.drag&&!n.zoom?n.drag&&this._terrainMovement?_.center=_.pointLocation(_.centerPoint.sub(k)):_.setLocationAtPoint(tt,G):(this._terrainMovement=!0,this._map._elevationFreeze=!0,_.setLocationAtPoint(tt,G)):_.setLocationAtPoint(tt,G),u._applyUpdatedTransform(_),this._map._update(),e.noInertia||this._inertia.record(e),this._fireEvents(n,a,!0)}_fireEvents(e,n,a){const u=Ls(this._eventsInProgress),_=Ls(e),I={};for(const G in e){const{originalEvent:Y}=e[G];this._eventsInProgress[G]||(I[`${G}start`]=Y),this._eventsInProgress[G]=e[G]}!u&&_&&this._fireEvent("movestart",_.originalEvent);for(const G in I)this._fireEvent(G,I[G]);_&&this._fireEvent("move",_.originalEvent);for(const G in e){const{originalEvent:Y}=e[G];this._fireEvent(G,Y)}const k={};let z;for(const G in this._eventsInProgress){const{handlerName:Y,originalEvent:tt}=this._eventsInProgress[G];this._handlersById[Y].isActive()||(delete this._eventsInProgress[G],z=n[Y]||tt,k[`${G}end`]=z)}for(const G in k)this._fireEvent(G,k[G]);const R=Ls(this._eventsInProgress),V=(u||_)&&!R;if(V&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;const G=this._map._getTransformForUpdate();G.recalculateZoom(this._map.terrain),this._map._applyUpdatedTransform(G)}if(a&&V){this._updatingCamera=!0;const G=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),Y=tt=>tt!==0&&-this._bearingSnap<tt&&tt<this._bearingSnap;!G||!G.essential&&l.prefersReducedMotion?(this._map.fire(new s.k("moveend",{originalEvent:z})),Y(this._map.getBearing())&&this._map.resetNorth()):(Y(G.bearing||this._map.getBearing())&&(G.bearing=0),G.freezeElevation=!0,this._map.easeTo(G,{originalEvent:z})),this._updatingCamera=!1}}_fireEvent(e,n){this._map.fire(new s.k(e,n?{originalEvent:n}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(e=>{delete this._frameId,this.handleEvent(new nh("renderFrame",{timeStamp:e})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class oh extends s.E{constructor(e,n){super(),this._renderFrameCallback=()=>{const a=Math.min((l.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(a)),a<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=e,this._bearingSnap=n.bearingSnap,this.on("moveend",()=>{delete this._requestedCameraState})}getCenter(){return new s.N(this.transform.center.lng,this.transform.center.lat)}setCenter(e,n){return this.jumpTo({center:e},n)}panBy(e,n,a){return e=s.P.convert(e).mult(-1),this.panTo(this.transform.center,s.e({offset:e},n),a)}panTo(e,n,a){return this.easeTo(s.e({center:e},n),a)}getZoom(){return this.transform.zoom}setZoom(e,n){return this.jumpTo({zoom:e},n),this}zoomTo(e,n,a){return this.easeTo(s.e({zoom:e},n),a)}zoomIn(e,n){return this.zoomTo(this.getZoom()+1,e,n),this}zoomOut(e,n){return this.zoomTo(this.getZoom()-1,e,n),this}getBearing(){return this.transform.bearing}setBearing(e,n){return this.jumpTo({bearing:e},n),this}getPadding(){return this.transform.padding}setPadding(e,n){return this.jumpTo({padding:e},n),this}rotateTo(e,n,a){return this.easeTo(s.e({bearing:e},n),a)}resetNorth(e,n){return this.rotateTo(0,s.e({duration:1e3},e),n),this}resetNorthPitch(e,n){return this.easeTo(s.e({bearing:0,pitch:0,duration:1e3},e),n),this}snapToNorth(e,n){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(e,n):this}getPitch(){return this.transform.pitch}setPitch(e,n){return this.jumpTo({pitch:e},n),this}cameraForBounds(e,n){e=at.convert(e);const a=n&&n.bearing||0;return this._cameraForBoxAndBearing(e.getNorthWest(),e.getSouthEast(),a,n)}_cameraForBoxAndBearing(e,n,a,u){const _={top:0,bottom:0,right:0,left:0};if(typeof(u=s.e({padding:_,offset:[0,0],maxZoom:this.transform.maxZoom},u)).padding=="number"){const Se=u.padding;u.padding={top:Se,bottom:Se,right:Se,left:Se}}u.padding=s.e(_,u.padding);const I=this.transform,k=I.padding,z=new at(e,n),R=I.project(z.getNorthWest()),V=I.project(z.getNorthEast()),G=I.project(z.getSouthEast()),Y=I.project(z.getSouthWest()),tt=s.ba(-a),ot=R.rotate(tt),mt=V.rotate(tt),ut=G.rotate(tt),bt=Y.rotate(tt),Pt=new s.P(Math.max(ot.x,mt.x,bt.x,ut.x),Math.max(ot.y,mt.y,bt.y,ut.y)),ht=new s.P(Math.min(ot.x,mt.x,bt.x,ut.x),Math.min(ot.y,mt.y,bt.y,ut.y)),Dt=Pt.sub(ht),Ut=(I.width-(k.left+k.right+u.padding.left+u.padding.right))/Dt.x,$t=(I.height-(k.top+k.bottom+u.padding.top+u.padding.bottom))/Dt.y;if($t<0||Ut<0)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const _e=Math.min(I.scaleZoom(I.scale*Math.min(Ut,$t)),u.maxZoom),Ce=s.P.convert(u.offset),Xe=new s.P((u.padding.left-u.padding.right)/2,(u.padding.top-u.padding.bottom)/2).rotate(s.ba(a)),qe=Ce.add(Xe).mult(I.scale/I.zoomScale(_e));return{center:I.unproject(R.add(G).div(2).sub(qe)),zoom:_e,bearing:a}}fitBounds(e,n,a){return this._fitInternal(this.cameraForBounds(e,n),n,a)}fitScreenCoordinates(e,n,a,u,_){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.pointLocation(s.P.convert(e)),this.transform.pointLocation(s.P.convert(n)),a,u),u,_)}_fitInternal(e,n,a){return e?(delete(n=s.e(e,n)).padding,n.linear?this.easeTo(n,a):this.flyTo(n,a)):this}jumpTo(e,n){this.stop();const a=this._getTransformForUpdate();let u=!1,_=!1,I=!1;return"zoom"in e&&a.zoom!==+e.zoom&&(u=!0,a.zoom=+e.zoom),e.center!==void 0&&(a.center=s.N.convert(e.center)),"bearing"in e&&a.bearing!==+e.bearing&&(_=!0,a.bearing=+e.bearing),"pitch"in e&&a.pitch!==+e.pitch&&(I=!0,a.pitch=+e.pitch),e.padding==null||a.isPaddingEqual(e.padding)||(a.padding=e.padding),this._applyUpdatedTransform(a),this.fire(new s.k("movestart",n)).fire(new s.k("move",n)),u&&this.fire(new s.k("zoomstart",n)).fire(new s.k("zoom",n)).fire(new s.k("zoomend",n)),_&&this.fire(new s.k("rotatestart",n)).fire(new s.k("rotate",n)).fire(new s.k("rotateend",n)),I&&this.fire(new s.k("pitchstart",n)).fire(new s.k("pitch",n)).fire(new s.k("pitchend",n)),this.fire(new s.k("moveend",n))}calculateCameraOptionsFromTo(e,n,a,u=0){const _=s.Z.fromLngLat(e,n),I=s.Z.fromLngLat(a,u),k=I.x-_.x,z=I.y-_.y,R=I.z-_.z,V=Math.hypot(k,z,R);if(V===0)throw new Error("Can't calculate camera options with same From and To");const G=Math.hypot(k,z),Y=this.transform.scaleZoom(this.transform.cameraToCenterDistance/V/this.transform.tileSize),tt=180*Math.atan2(k,-z)/Math.PI;let ot=180*Math.acos(G/V)/Math.PI;return ot=R<0?90-ot:90+ot,{center:I.toLngLat(),zoom:Y,pitch:ot,bearing:tt}}easeTo(e,n){var a;this._stop(!1,e.easeId),((e=s.e({offset:[0,0],duration:500,easing:s.b9},e)).animate===!1||!e.essential&&l.prefersReducedMotion)&&(e.duration=0);const u=this._getTransformForUpdate(),_=u.zoom,I=u.bearing,k=u.pitch,z=u.padding,R="bearing"in e?this._normalizeBearing(e.bearing,I):I,V="pitch"in e?+e.pitch:k,G="padding"in e?e.padding:u.padding,Y=s.P.convert(e.offset);let tt=u.centerPoint.add(Y);const ot=u.pointLocation(tt),{center:mt,zoom:ut}=u.getConstrained(s.N.convert(e.center||ot),(a=e.zoom)!==null&&a!==void 0?a:_);this._normalizeCenter(mt,u);const bt=u.project(ot),Pt=u.project(mt).sub(bt),ht=u.zoomScale(ut-_);let Dt,Ut;e.around&&(Dt=s.N.convert(e.around),Ut=u.locationPoint(Dt));const $t={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=this._zooming||ut!==_,this._rotating=this._rotating||I!==R,this._pitching=this._pitching||V!==k,this._padding=!u.isPaddingEqual(G),this._easeId=e.easeId,this._prepareEase(n,e.noMoveStart,$t),this.terrain&&this._prepareElevation(mt),this._ease(_e=>{if(this._zooming&&(u.zoom=s.z.number(_,ut,_e)),this._rotating&&(u.bearing=s.z.number(I,R,_e)),this._pitching&&(u.pitch=s.z.number(k,V,_e)),this._padding&&(u.interpolatePadding(z,G,_e),tt=u.centerPoint.add(Y)),this.terrain&&!e.freezeElevation&&this._updateElevation(_e),Dt)u.setLocationAtPoint(Dt,Ut);else{const Ce=u.zoomScale(u.zoom-_),Xe=ut>_?Math.min(2,ht):Math.max(.5,ht),qe=Math.pow(Xe,1-_e),Se=u.unproject(bt.add(Pt.mult(_e*qe)).mult(Ce));u.setLocationAtPoint(u.renderWorldCopies?Se.wrap():Se,tt)}this._applyUpdatedTransform(u),this._fireMoveEvents(n)},_e=>{this.terrain&&e.freezeElevation&&this._finalizeElevation(),this._afterEase(n,_e)},e),this}_prepareEase(e,n,a={}){this._moving=!0,n||a.moving||this.fire(new s.k("movestart",e)),this._zooming&&!a.zooming&&this.fire(new s.k("zoomstart",e)),this._rotating&&!a.rotating&&this.fire(new s.k("rotatestart",e)),this._pitching&&!a.pitching&&this.fire(new s.k("pitchstart",e))}_prepareElevation(e){this._elevationCenter=e,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(e,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(e){this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);const n=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(e<1&&n!==this._elevationTarget){const a=this._elevationTarget-this._elevationStart;this._elevationStart+=e*(a-(n-(a*e+this._elevationStart))/(1-e)),this._elevationTarget=n}this.transform.elevation=s.z.number(this._elevationStart,this._elevationTarget,e)}_finalizeElevation(){this._elevationFreeze=!1,this.transform.recalculateZoom(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(e){const n=e.getCameraPosition(),a=this.terrain.getElevationForLngLatZoom(n.lngLat,e.zoom);if(n.altitude<a){const u=this.calculateCameraOptionsFromTo(n.lngLat,a,e.center,e.elevation);return{pitch:u.pitch,zoom:u.zoom}}return{}}_applyUpdatedTransform(e){const n=[];if(this.terrain&&n.push(u=>this._elevateCameraIfInsideTerrain(u)),this.transformCameraUpdate&&n.push(u=>this.transformCameraUpdate(u)),!n.length)return;const a=e.clone();for(const u of n){const _=a.clone(),{center:I,zoom:k,pitch:z,bearing:R,elevation:V}=u(_);I&&(_.center=I),k!==void 0&&(_.zoom=k),z!==void 0&&(_.pitch=z),R!==void 0&&(_.bearing=R),V!==void 0&&(_.elevation=V),a.apply(_)}this.transform.apply(a)}_fireMoveEvents(e){this.fire(new s.k("move",e)),this._zooming&&this.fire(new s.k("zoom",e)),this._rotating&&this.fire(new s.k("rotate",e)),this._pitching&&this.fire(new s.k("pitch",e))}_afterEase(e,n){if(this._easeId&&n&&this._easeId===n)return;delete this._easeId;const a=this._zooming,u=this._rotating,_=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,a&&this.fire(new s.k("zoomend",e)),u&&this.fire(new s.k("rotateend",e)),_&&this.fire(new s.k("pitchend",e)),this.fire(new s.k("moveend",e))}flyTo(e,n){var a;if(!e.essential&&l.prefersReducedMotion){const Ve=s.M(e,["center","zoom","bearing","pitch","around"]);return this.jumpTo(Ve,n)}this.stop(),e=s.e({offset:[0,0],speed:1.2,curve:1.42,easing:s.b9},e);const u=this._getTransformForUpdate(),_=u.zoom,I=u.bearing,k=u.pitch,z=u.padding,R="bearing"in e?this._normalizeBearing(e.bearing,I):I,V="pitch"in e?+e.pitch:k,G="padding"in e?e.padding:u.padding,Y=s.P.convert(e.offset);let tt=u.centerPoint.add(Y);const ot=u.pointLocation(tt),{center:mt,zoom:ut}=u.getConstrained(s.N.convert(e.center||ot),(a=e.zoom)!==null&&a!==void 0?a:_);this._normalizeCenter(mt,u);const bt=u.zoomScale(ut-_),Pt=u.project(ot),ht=u.project(mt).sub(Pt);let Dt=e.curve;const Ut=Math.max(u.width,u.height),$t=Ut/bt,_e=ht.mag();if("minZoom"in e){const Ve=s.ad(Math.min(e.minZoom,_,ut),u.minZoom,u.maxZoom),yi=Ut/u.zoomScale(Ve-_);Dt=Math.sqrt(yi/_e*2)}const Ce=Dt*Dt;function Xe(Ve){const yi=($t*$t-Ut*Ut+(Ve?-1:1)*Ce*Ce*_e*_e)/(2*(Ve?$t:Ut)*Ce*_e);return Math.log(Math.sqrt(yi*yi+1)-yi)}function qe(Ve){return(Math.exp(Ve)-Math.exp(-Ve))/2}function Se(Ve){return(Math.exp(Ve)+Math.exp(-Ve))/2}const ke=Xe(!1);let ti=function(Ve){return Se(ke)/Se(ke+Dt*Ve)},Ci=function(Ve){return Ut*((Se(ke)*(qe(yi=ke+Dt*Ve)/Se(yi))-qe(ke))/Ce)/_e;var yi},ze=(Xe(!0)-ke)/Dt;if(Math.abs(_e)<1e-6||!isFinite(ze)){if(Math.abs(Ut-$t)<1e-6)return this.easeTo(e,n);const Ve=$t<Ut?-1:1;ze=Math.abs(Math.log($t/Ut))/Dt,Ci=()=>0,ti=yi=>Math.exp(Ve*Dt*yi)}return e.duration="duration"in e?+e.duration:1e3*ze/("screenSpeed"in e?+e.screenSpeed/Dt:+e.speed),e.maxDuration&&e.duration>e.maxDuration&&(e.duration=0),this._zooming=!0,this._rotating=I!==R,this._pitching=V!==k,this._padding=!u.isPaddingEqual(G),this._prepareEase(n,!1),this.terrain&&this._prepareElevation(mt),this._ease(Ve=>{const yi=Ve*ze,gr=1/ti(yi);u.zoom=Ve===1?ut:_+u.scaleZoom(gr),this._rotating&&(u.bearing=s.z.number(I,R,Ve)),this._pitching&&(u.pitch=s.z.number(k,V,Ve)),this._padding&&(u.interpolatePadding(z,G,Ve),tt=u.centerPoint.add(Y)),this.terrain&&!e.freezeElevation&&this._updateElevation(Ve);const Ii=Ve===1?mt:u.unproject(Pt.add(ht.mult(Ci(yi))).mult(gr));u.setLocationAtPoint(u.renderWorldCopies?Ii.wrap():Ii,tt),this._applyUpdatedTransform(u),this._fireMoveEvents(n)},()=>{this.terrain&&e.freezeElevation&&this._finalizeElevation(),this._afterEase(n)},e),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(e,n){var a;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const u=this._onEaseEnd;delete this._onEaseEnd,u.call(this,n)}return e||(a=this.handlers)===null||a===void 0||a.stop(!1),this}_ease(e,n,a){a.animate===!1||a.duration===0?(e(1),n()):(this._easeStart=l.now(),this._easeOptions=a,this._onEaseFrame=e,this._onEaseEnd=n,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(e,n){e=s.b3(e,-180,180);const a=Math.abs(e-n);return Math.abs(e-360-n)<a&&(e-=360),Math.abs(e+360-n)<a&&(e+=360),e}_normalizeCenter(e,n){if(!n.renderWorldCopies||n.lngRange)return;const a=e.lng-n.center.lng;e.lng+=a>180?-360:a<-180?360:0}queryTerrainElevation(e){return this.terrain?this.terrain.getElevationForLngLatZoom(s.N.convert(e),this.transform.tileZoom)-this.transform.elevation:null}}const Nl={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class Qo{constructor(e=Nl){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=n=>{!n||n.sourceDataType!=="metadata"&&n.sourceDataType!=="visibility"&&n.dataType!=="style"&&n.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=e}getDefaultPosition(){return"bottom-right"}onAdd(e){return this._map=e,this._compact=this.options.compact,this._container=c.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=c.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=c.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){c.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(e,n){const a=this._map._getUIString(`AttributionControl.${n}`);e.title=a,e.setAttribute("aria-label",a)}_updateAttributions(){if(!this._map.style)return;let e=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?e=e.concat(this.options.customAttribution.map(u=>typeof u!="string"?"":u)):typeof this.options.customAttribution=="string"&&e.push(this.options.customAttribution)),this._map.style.stylesheet){const u=this._map.style.stylesheet;this.styleOwner=u.owner,this.styleId=u.id}const n=this._map.style.sourceCaches;for(const u in n){const _=n[u];if(_.used||_.usedForTerrain){const I=_.getSource();I.attribution&&e.indexOf(I.attribution)<0&&e.push(I.attribution)}}e=e.filter(u=>String(u).trim()),e.sort((u,_)=>u.length-_.length),e=e.filter((u,_)=>{for(let I=_+1;I<e.length;I++)if(e[I].indexOf(u)>=0)return!1;return!0});const a=e.join(" | ");a!==this._attribHTML&&(this._attribHTML=a,e.length?(this._innerContainer.innerHTML=a,this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class _s{constructor(e={}){this._updateCompact=()=>{const n=this._container.children;if(n.length){const a=n[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&a.classList.add("maplibregl-compact"):a.classList.remove("maplibregl-compact")}},this.options=e}getDefaultPosition(){return"bottom-left"}onAdd(e){this._map=e,this._compact=this.options&&this.options.compact,this._container=c.create("div","maplibregl-ctrl");const n=c.create("a","maplibregl-ctrl-logo");return n.target="_blank",n.rel="noopener nofollow",n.href="https://maplibre.org/",n.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),n.setAttribute("rel","noopener nofollow"),this._container.appendChild(n),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){c.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class Ze{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(e){const n=++this._id;return this._queue.push({callback:e,id:n,cancelled:!1}),n}remove(e){const n=this._currentlyRunning,a=n?this._queue.concat(n):this._queue;for(const u of a)if(u.id===e)return void(u.cancelled=!0)}run(e=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const n=this._currentlyRunning=this._queue;this._queue=[];for(const a of n)if(!a.cancelled&&(a.callback(e),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var vc=s.Y([{name:"a_pos3d",type:"Int16",components:3}]);class Vl extends s.E{constructor(e){super(),this.sourceCache=e,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.deltaZoom=1,e.usedForTerrain=!0,e.tileSize=this.tileSize*2**this.deltaZoom}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(e,n){this.sourceCache.update(e,n),this._renderableTilesKeys=[];const a={};for(const u of e.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:n}))a[u.key]=!0,this._renderableTilesKeys.push(u.key),this._tiles[u.key]||(u.posMatrix=new Float64Array(16),s.aQ(u.posMatrix,0,s.X,0,s.X,0,1),this._tiles[u.key]=new Yi(u,this.tileSize));for(const u in this._tiles)a[u]||delete this._tiles[u]}freeRtt(e){for(const n in this._tiles){const a=this._tiles[n];(!e||a.tileID.equals(e)||a.tileID.isChildOf(e)||e.isChildOf(a.tileID))&&(a.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map(e=>this.getTileByID(e))}getTileByID(e){return this._tiles[e]}getTerrainCoords(e){const n={};for(const a of this._renderableTilesKeys){const u=this._tiles[a].tileID;if(u.canonical.equals(e.canonical)){const _=e.clone();_.posMatrix=new Float64Array(16),s.aQ(_.posMatrix,0,s.X,0,s.X,0,1),n[a]=_}else if(u.canonical.isChildOf(e.canonical)){const _=e.clone();_.posMatrix=new Float64Array(16);const I=u.canonical.z-e.canonical.z,k=u.canonical.x-(u.canonical.x>>I<<I),z=u.canonical.y-(u.canonical.y>>I<<I),R=s.X>>I;s.aQ(_.posMatrix,0,R,0,R,0,1),s.J(_.posMatrix,_.posMatrix,[-k*R,-z*R,0]),n[a]=_}else if(e.canonical.isChildOf(u.canonical)){const _=e.clone();_.posMatrix=new Float64Array(16);const I=e.canonical.z-u.canonical.z,k=e.canonical.x-(e.canonical.x>>I<<I),z=e.canonical.y-(e.canonical.y>>I<<I),R=s.X>>I;s.aQ(_.posMatrix,0,s.X,0,s.X,0,1),s.J(_.posMatrix,_.posMatrix,[k*R,z*R,0]),s.K(_.posMatrix,_.posMatrix,[1/2**I,1/2**I,0]),n[a]=_}}return n}getSourceTile(e,n){const a=this.sourceCache._source;let u=e.overscaledZ-this.deltaZoom;if(u>a.maxzoom&&(u=a.maxzoom),u<a.minzoom)return null;this._sourceTileCache[e.key]||(this._sourceTileCache[e.key]=e.scaledTo(u).key);let _=this.sourceCache.getTileByID(this._sourceTileCache[e.key]);if((!_||!_.dem)&&n)for(;u>=a.minzoom&&(!_||!_.dem);)_=this.sourceCache.getTileByID(e.scaledTo(u--).key);return _}tilesAfterTime(e=Date.now()){return Object.values(this._tiles).filter(n=>n.timeAdded>=e)}}class xc{constructor(e,n,a){this.painter=e,this.sourceCache=new Vl(n),this.options=a,this.exaggeration=typeof a.exaggeration=="number"?a.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(e,n,a,u=s.X){var _;if(!(n>=0&&n<u&&a>=0&&a<u))return 0;const I=this.getTerrainData(e),k=(_=I.tile)===null||_===void 0?void 0:_.dem;if(!k)return 0;const z=function(ot,mt,ut){var bt=mt[0],Pt=mt[1];return ot[0]=ut[0]*bt+ut[4]*Pt+ut[12],ot[1]=ut[1]*bt+ut[5]*Pt+ut[13],ot}([],[n/u*s.X,a/u*s.X],I.u_terrain_matrix),R=[z[0]*k.dim,z[1]*k.dim],V=Math.floor(R[0]),G=Math.floor(R[1]),Y=R[0]-V,tt=R[1]-G;return k.get(V,G)*(1-Y)*(1-tt)+k.get(V+1,G)*Y*(1-tt)+k.get(V,G+1)*(1-Y)*tt+k.get(V+1,G+1)*Y*tt}getElevationForLngLatZoom(e,n){const{tileID:a,mercatorX:u,mercatorY:_}=this._getOverscaledTileIDFromLngLatZoom(e,n);return this.getElevation(a,u%s.X,_%s.X,s.X)}getElevation(e,n,a,u=s.X){return this.getDEMElevation(e,n,a,u)*this.exaggeration}getTerrainData(e){if(!this._emptyDemTexture){const u=this.painter.context,_=new s.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new Jt(u,_,u.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new Jt(u,new s.R({width:1,height:1}),u.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(u.gl.NEAREST,u.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=s.ao([])}const n=this.sourceCache.getSourceTile(e,!0);if(n&&n.dem&&(!n.demTexture||n.needsTerrainPrepare)){const u=this.painter.context;n.demTexture=this.painter.getTileTexture(n.dem.stride),n.demTexture?n.demTexture.update(n.dem.getPixels(),{premultiply:!1}):n.demTexture=new Jt(u,n.dem.getPixels(),u.gl.RGBA,{premultiply:!1}),n.demTexture.bind(u.gl.NEAREST,u.gl.CLAMP_TO_EDGE),n.needsTerrainPrepare=!1}const a=n&&n+n.tileID.key+e.key;if(a&&!this._demMatrixCache[a]){const u=this.sourceCache.sourceCache._source.maxzoom;let _=e.canonical.z-n.tileID.canonical.z;e.overscaledZ>e.canonical.z&&(e.canonical.z>=u?_=e.canonical.z-u:s.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const I=e.canonical.x-(e.canonical.x>>_<<_),k=e.canonical.y-(e.canonical.y>>_<<_),z=s.bb(new Float64Array(16),[1/(s.X<<_),1/(s.X<<_),0]);s.J(z,z,[I*s.X,k*s.X,0]),this._demMatrixCache[e.key]={matrix:z,coord:e}}return{u_depth:2,u_terrain:3,u_terrain_dim:n&&n.dem&&n.dem.dim||1,u_terrain_matrix:a?this._demMatrixCache[e.key].matrix:this._emptyDemMatrix,u_terrain_unpack:n&&n.dem&&n.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(n&&n.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:n}}getFramebuffer(e){const n=this.painter,a=n.width/devicePixelRatio,u=n.height/devicePixelRatio;return!this._fbo||this._fbo.width===a&&this._fbo.height===u||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new Jt(n.context,{width:a,height:u,data:null},n.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(n.context.gl.NEAREST,n.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new Jt(n.context,{width:a,height:u,data:null},n.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(n.context.gl.NEAREST,n.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=n.context.createFramebuffer(a,u,!0,!1),this._fbo.depthAttachment.set(n.context.createRenderbuffer(n.context.gl.DEPTH_COMPONENT16,a,u))),this._fbo.colorAttachment.set(e==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const e=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const n=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let _=0,I=0;_<this._coordsTextureSize;_++)for(let k=0;k<this._coordsTextureSize;k++,I+=4)n[I+0]=255&k,n[I+1]=255&_,n[I+2]=k>>8<<4|_>>8,n[I+3]=0;const a=new s.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(n.buffer)),u=new Jt(e,a,e.gl.RGBA,{premultiply:!1});return u.bind(e.gl.NEAREST,e.gl.CLAMP_TO_EDGE),this._coordsTexture=u,u}pointCoordinate(e){this.painter.maybeDrawDepthAndCoords(!0);const n=new Uint8Array(4),a=this.painter.context,u=a.gl,_=Math.round(e.x*this.painter.pixelRatio/devicePixelRatio),I=Math.round(e.y*this.painter.pixelRatio/devicePixelRatio),k=Math.round(this.painter.height/devicePixelRatio);a.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),u.readPixels(_,k-I-1,1,1,u.RGBA,u.UNSIGNED_BYTE,n),a.bindFramebuffer.set(null);const z=n[0]+(n[2]>>4<<8),R=n[1]+((15&n[2])<<8),V=this.coordsIndex[255-n[3]],G=V&&this.sourceCache.getTileByID(V);if(!G)return null;const Y=this._coordsTextureSize,tt=(1<<G.tileID.canonical.z)*Y;return new s.Z((G.tileID.canonical.x*Y+z)/tt+G.tileID.wrap,(G.tileID.canonical.y*Y+R)/tt,this.getElevation(G.tileID,z,R,Y))}depthAtPoint(e){const n=new Uint8Array(4),a=this.painter.context,u=a.gl;return a.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),u.readPixels(e.x,this.painter.height/devicePixelRatio-e.y-1,1,1,u.RGBA,u.UNSIGNED_BYTE,n),a.bindFramebuffer.set(null),(n[0]/16777216+n[1]/65536+n[2]/256+n[3])/256}getTerrainMesh(){if(this._mesh)return this._mesh;const e=this.painter.context,n=new s.bc,a=new s.aY,u=this.meshSize,_=s.X/u,I=u*u;for(let G=0;G<=u;G++)for(let Y=0;Y<=u;Y++)n.emplaceBack(Y*_,G*_,0);for(let G=0;G<I;G+=u+1)for(let Y=0;Y<u;Y++)a.emplaceBack(Y+G,u+Y+G+1,u+Y+G+2),a.emplaceBack(Y+G,u+Y+G+2,Y+G+1);const k=n.length,z=k+2*(u+1);for(const G of[0,1])for(let Y=0;Y<=u;Y++)for(const tt of[0,1])n.emplaceBack(Y*_,G*s.X,tt);for(let G=0;G<2*u;G+=2)a.emplaceBack(z+G,z+G+1,z+G+3),a.emplaceBack(z+G,z+G+3,z+G+2),a.emplaceBack(k+G,k+G+3,k+G+1),a.emplaceBack(k+G,k+G+2,k+G+3);const R=n.length,V=R+2*(u+1);for(const G of[0,1])for(let Y=0;Y<=u;Y++)for(const tt of[0,1])n.emplaceBack(G*s.X,Y*_,tt);for(let G=0;G<2*u;G+=2)a.emplaceBack(R+G,R+G+1,R+G+3),a.emplaceBack(R+G,R+G+3,R+G+2),a.emplaceBack(V+G,V+G+3,V+G+1),a.emplaceBack(V+G,V+G+2,V+G+3);return this._mesh=new hi(e.createVertexBuffer(n,vc.members),e.createIndexBuffer(a),s.a0.simpleSegment(0,0,n.length,a.length)),this._mesh}getMeshFrameDelta(e){return 2*Math.PI*s.bd/Math.pow(2,e)/5}getMinTileElevationForLngLatZoom(e,n){var a;const{tileID:u}=this._getOverscaledTileIDFromLngLatZoom(e,n);return(a=this.getMinMaxElevation(u).minElevation)!==null&&a!==void 0?a:0}getMinMaxElevation(e){const n=this.getTerrainData(e).tile,a={minElevation:null,maxElevation:null};return n&&n.dem&&(a.minElevation=n.dem.min*this.exaggeration,a.maxElevation=n.dem.max*this.exaggeration),a}_getOverscaledTileIDFromLngLatZoom(e,n){const a=s.Z.fromLngLat(e.wrap()),u=(1<<n)*s.X,_=a.x*u,I=a.y*u,k=Math.floor(_/s.X),z=Math.floor(I/s.X);return{tileID:new s.S(n,0,n,k,z),mercatorX:_,mercatorY:I}}}class Da{constructor(e,n,a){this._context=e,this._size=n,this._tileSize=a,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const e of this._objects)e.texture.destroy(),e.fbo.destroy()}_createObject(e){const n=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),a=new Jt(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return a.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),n.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),n.colorAttachment.set(a.texture),{id:e,fbo:n,texture:a,stamp:-1,inUse:!1}}getObjectForId(e){return this._objects[e]}useObject(e){e.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter(n=>e.id!==n),this._recentlyUsed.push(e.id)}stampObject(e){e.stamp=++this._stamp}getOrCreateFreeObject(){for(const n of this._recentlyUsed)if(!this._objects[n].inUse)return this._objects[n];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const e=this._createObject(this._objects.length);return this._objects.push(e),e}freeObject(e){e.inUse=!1}freeAllObjects(){for(const e of this._objects)this.freeObject(e)}isFull(){return!(this._objects.length<this._size)&&this._objects.some(e=>!e.inUse)===!1}}const ys={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0};class bc{constructor(e,n){this.painter=e,this.terrain=n,this.pool=new Da(e.context,30,n.sourceCache.tileSize*n.qualityFactor)}destruct(){this.pool.destruct()}getTexture(e){return this.pool.getObjectForId(e.rtt[this._stacks.length-1].id).texture}prepareForRender(e,n){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=e._order.filter(a=>!e._layers[a].isHidden(n)),this._coordsDescendingInv={};for(const a in e.sourceCaches){this._coordsDescendingInv[a]={};const u=e.sourceCaches[a].getVisibleCoordinates();for(const _ of u){const I=this.terrain.sourceCache.getTerrainCoords(_);for(const k in I)this._coordsDescendingInv[a][k]||(this._coordsDescendingInv[a][k]=[]),this._coordsDescendingInv[a][k].push(I[k])}}this._coordsDescendingInvStr={};for(const a of e._order){const u=e._layers[a],_=u.source;if(ys[u.type]&&!this._coordsDescendingInvStr[_]){this._coordsDescendingInvStr[_]={};for(const I in this._coordsDescendingInv[_])this._coordsDescendingInvStr[_][I]=this._coordsDescendingInv[_][I].map(k=>k.key).sort().join()}}for(const a of this._renderableTiles)for(const u in this._coordsDescendingInvStr){const _=this._coordsDescendingInvStr[u][a.tileID.key];_&&_!==a.rttCoords[u]&&(a.rtt=[])}}renderLayer(e){if(e.isHidden(this.painter.transform.zoom))return!1;const n=e.type,a=this.painter,u=this._renderableLayerIds[this._renderableLayerIds.length-1]===e.id;if(ys[n]&&(this._prevType&&ys[this._prevType]||this._stacks.push([]),this._prevType=n,this._stacks[this._stacks.length-1].push(e.id),!u))return!0;if(ys[this._prevType]||ys[n]&&u){this._prevType=n;const _=this._stacks.length-1,I=this._stacks[_]||[];for(const k of this._renderableTiles){if(this.pool.isFull()&&(Le(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(k),k.rtt[_]){const R=this.pool.getObjectForId(k.rtt[_].id);if(R.stamp===k.rtt[_].stamp){this.pool.useObject(R);continue}}const z=this.pool.getOrCreateFreeObject();this.pool.useObject(z),this.pool.stampObject(z),k.rtt[_]={id:z.id,stamp:z.stamp},a.context.bindFramebuffer.set(z.fbo.framebuffer),a.context.clear({color:s.aN.transparent,stencil:0}),a.currentStencilSource=void 0;for(let R=0;R<I.length;R++){const V=a.style._layers[I[R]],G=V.source?this._coordsDescendingInv[V.source][k.tileID.key]:[k.tileID];a.context.viewport.set([0,0,z.fbo.width,z.fbo.height]),a._renderTileClippingMasks(V,G),a.renderLayer(a,a.style.sourceCaches[V.source],V,G),V.source&&(k.rttCoords[V.source]=this._coordsDescendingInvStr[V.source][k.tileID.key])}}return Le(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects(),ys[n]}return!1}}const Ge={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use  + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},Ul=p,ah={hash:!1,interactive:!0,bearingSnap:7,attributionControl:Nl,maplibreLogo:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,refreshExpiredTiles:!0,scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],zoom:0,bearing:0,pitch:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:s.a.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0},wc=y=>{y.touchstart=y.dragStart,y.touchmoveWindow=y.dragMove,y.touchend=y.dragEnd},Gl={showCompass:!0,showZoom:!0,visualizePitch:!1};class Cc{constructor(e,n,a=!1){this.mousedown=I=>{this.startMouse(s.e({},I,{ctrlKey:!0,preventDefault:()=>I.preventDefault()}),c.mousePos(this.element,I)),c.addEventListener(window,"mousemove",this.mousemove),c.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=I=>{this.moveMouse(I,c.mousePos(this.element,I))},this.mouseup=I=>{this.mouseRotate.dragEnd(I),this.mousePitch&&this.mousePitch.dragEnd(I),this.offTemp()},this.touchstart=I=>{I.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=c.touchPos(this.element,I.targetTouches)[0],this.startTouch(I,this._startPos),c.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),c.addEventListener(window,"touchend",this.touchend))},this.touchmove=I=>{I.targetTouches.length!==1?this.reset():(this._lastPos=c.touchPos(this.element,I.targetTouches)[0],this.moveTouch(I,this._lastPos))},this.touchend=I=>{I.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),this.touchRotate.reset(),this.touchPitch&&this.touchPitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10;const u=e.dragRotate._mouseRotate.getClickTolerance(),_=e.dragRotate._mousePitch.getClickTolerance();this.element=n,this.mouseRotate=Oo({clickTolerance:u,enable:!0}),this.touchRotate=(({enable:I,clickTolerance:k,bearingDegreesPerPixelMoved:z=.8})=>{const R=new ko;return new Ji({clickTolerance:k,move:(V,G)=>({bearingDelta:(G.x-V.x)*z}),moveStateManager:R,enable:I,assignEvents:wc})})({clickTolerance:u,enable:!0}),this.map=e,a&&(this.mousePitch=Xn({clickTolerance:_,enable:!0}),this.touchPitch=(({enable:I,clickTolerance:k,pitchDegreesPerPixelMoved:z=-.5})=>{const R=new ko;return new Ji({clickTolerance:k,move:(V,G)=>({pitchDelta:(G.y-V.y)*z}),moveStateManager:R,enable:I,assignEvents:wc})})({clickTolerance:_,enable:!0})),c.addEventListener(n,"mousedown",this.mousedown),c.addEventListener(n,"touchstart",this.touchstart,{passive:!1}),c.addEventListener(n,"touchcancel",this.reset)}startMouse(e,n){this.mouseRotate.dragStart(e,n),this.mousePitch&&this.mousePitch.dragStart(e,n),c.disableDrag()}startTouch(e,n){this.touchRotate.dragStart(e,n),this.touchPitch&&this.touchPitch.dragStart(e,n),c.disableDrag()}moveMouse(e,n){const a=this.map,{bearingDelta:u}=this.mouseRotate.dragMove(e,n)||{};if(u&&a.setBearing(a.getBearing()+u),this.mousePitch){const{pitchDelta:_}=this.mousePitch.dragMove(e,n)||{};_&&a.setPitch(a.getPitch()+_)}}moveTouch(e,n){const a=this.map,{bearingDelta:u}=this.touchRotate.dragMove(e,n)||{};if(u&&a.setBearing(a.getBearing()+u),this.touchPitch){const{pitchDelta:_}=this.touchPitch.dragMove(e,n)||{};_&&a.setPitch(a.getPitch()+_)}}off(){const e=this.element;c.removeEventListener(e,"mousedown",this.mousedown),c.removeEventListener(e,"touchstart",this.touchstart,{passive:!1}),c.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),c.removeEventListener(window,"touchend",this.touchend),c.removeEventListener(e,"touchcancel",this.reset),this.offTemp()}offTemp(){c.enableDrag(),c.removeEventListener(window,"mousemove",this.mousemove),c.removeEventListener(window,"mouseup",this.mouseup),c.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),c.removeEventListener(window,"touchend",this.touchend)}}let Qs;function Sc(y,e,n){const a=new s.N(y.lng,y.lat);if(y=new s.N(y.lng,y.lat),e){const u=new s.N(y.lng-360,y.lat),_=new s.N(y.lng+360,y.lat),I=n.locationPoint(y).distSqr(e);n.locationPoint(u).distSqr(e)<I?y=u:n.locationPoint(_).distSqr(e)<I&&(y=_)}for(;Math.abs(y.lng-n.center.lng)>180;){const u=n.locationPoint(y);if(u.x>=0&&u.y>=0&&u.x<=n.width&&u.y<=n.height)break;y.lng>n.center.lng?y.lng-=360:y.lng+=360}return y.lng!==a.lng&&n.locationPoint(y).y>n.height/2-n.getHorizon()?y:a}const Xl={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function to(y,e,n){const a=y.classList;for(const u in Xl)a.remove(`maplibregl-${n}-anchor-${u}`);a.add(`maplibregl-${n}-anchor-${e}`)}class pr extends s.E{constructor(e){if(super(),this._onKeyPress=n=>{const a=n.code,u=n.charCode||n.keyCode;a!=="Space"&&a!=="Enter"&&u!==32&&u!==13||this.togglePopup()},this._onMapClick=n=>{const a=n.originalEvent.target,u=this._element;this._popup&&(a===u||u.contains(a))&&this.togglePopup()},this._update=n=>{var a;if(!this._map)return;const u=this._map.loaded()&&!this._map.isMoving();((n==null?void 0:n.type)==="terrain"||(n==null?void 0:n.type)==="render"&&!u)&&this._map.once("render",this._update),this._lngLat=this._map.transform.renderWorldCopies?Sc(this._lngLat,this._flatPos,this._map.transform):(a=this._lngLat)===null||a===void 0?void 0:a.wrap(),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationPoint(this._lngLat)._add(this._offset));let _="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?_=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(_=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let I="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?I="rotateX(0deg)":this._pitchAlignment==="map"&&(I=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||n&&n.type!=="moveend"||(this._pos=this._pos.round()),c.setTransform(this._element,`${Xl[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${I} ${_}`),l.frameAsync(new AbortController).then(()=>{this._updateOpacity(n&&n.type==="moveend")}).catch(()=>{})},this._onMove=n=>{if(!this._isDragging){const a=this._clickTolerance||this._map._clickTolerance;this._isDragging=n.point.dist(this._pointerdownPos)>=a}this._isDragging&&(this._pos=n.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.k("dragstart"))),this.fire(new s.k("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new s.k("dragend")),this._state="inactive"},this._addDragHandler=n=>{this._element.contains(n.originalEvent.target)&&(n.preventDefault(),this._positionDelta=n.point.sub(this._pos).add(this._offset),this._pointerdownPos=n.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=e&&e.anchor||"center",this._color=e&&e.color||"#3FB1CE",this._scale=e&&e.scale||1,this._draggable=e&&e.draggable||!1,this._clickTolerance=e&&e.clickTolerance||0,this._subpixelPositioning=e&&e.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=e&&e.rotation||0,this._rotationAlignment=e&&e.rotationAlignment||"auto",this._pitchAlignment=e&&e.pitchAlignment&&e.pitchAlignment!=="auto"?e.pitchAlignment:this._rotationAlignment,this.setOpacity(),this.setOpacity(e==null?void 0:e.opacity,e==null?void 0:e.opacityWhenCovered),e&&e.element)this._element=e.element,this._offset=s.P.convert(e&&e.offset||[0,0]);else{this._defaultMarker=!0,this._element=c.create("div");const n=c.createNS("http://www.w3.org/2000/svg","svg"),a=41,u=27;n.setAttributeNS(null,"display","block"),n.setAttributeNS(null,"height",`${a}px`),n.setAttributeNS(null,"width",`${u}px`),n.setAttributeNS(null,"viewBox",`0 0 ${u} ${a}`);const _=c.createNS("http://www.w3.org/2000/svg","g");_.setAttributeNS(null,"stroke","none"),_.setAttributeNS(null,"stroke-width","1"),_.setAttributeNS(null,"fill","none"),_.setAttributeNS(null,"fill-rule","evenodd");const I=c.createNS("http://www.w3.org/2000/svg","g");I.setAttributeNS(null,"fill-rule","nonzero");const k=c.createNS("http://www.w3.org/2000/svg","g");k.setAttributeNS(null,"transform","translate(3.0, 29.0)"),k.setAttributeNS(null,"fill","#000000");const z=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const bt of z){const Pt=c.createNS("http://www.w3.org/2000/svg","ellipse");Pt.setAttributeNS(null,"opacity","0.04"),Pt.setAttributeNS(null,"cx","10.5"),Pt.setAttributeNS(null,"cy","5.80029008"),Pt.setAttributeNS(null,"rx",bt.rx),Pt.setAttributeNS(null,"ry",bt.ry),k.appendChild(Pt)}const R=c.createNS("http://www.w3.org/2000/svg","g");R.setAttributeNS(null,"fill",this._color);const V=c.createNS("http://www.w3.org/2000/svg","path");V.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),R.appendChild(V);const G=c.createNS("http://www.w3.org/2000/svg","g");G.setAttributeNS(null,"opacity","0.25"),G.setAttributeNS(null,"fill","#000000");const Y=c.createNS("http://www.w3.org/2000/svg","path");Y.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),G.appendChild(Y);const tt=c.createNS("http://www.w3.org/2000/svg","g");tt.setAttributeNS(null,"transform","translate(6.0, 7.0)"),tt.setAttributeNS(null,"fill","#FFFFFF");const ot=c.createNS("http://www.w3.org/2000/svg","g");ot.setAttributeNS(null,"transform","translate(8.0, 8.0)");const mt=c.createNS("http://www.w3.org/2000/svg","circle");mt.setAttributeNS(null,"fill","#000000"),mt.setAttributeNS(null,"opacity","0.25"),mt.setAttributeNS(null,"cx","5.5"),mt.setAttributeNS(null,"cy","5.5"),mt.setAttributeNS(null,"r","5.4999962");const ut=c.createNS("http://www.w3.org/2000/svg","circle");ut.setAttributeNS(null,"fill","#FFFFFF"),ut.setAttributeNS(null,"cx","5.5"),ut.setAttributeNS(null,"cy","5.5"),ut.setAttributeNS(null,"r","5.4999962"),ot.appendChild(mt),ot.appendChild(ut),I.appendChild(k),I.appendChild(R),I.appendChild(G),I.appendChild(tt),I.appendChild(ot),n.appendChild(I),n.setAttributeNS(null,"height",a*this._scale+"px"),n.setAttributeNS(null,"width",u*this._scale+"px"),this._element.appendChild(n),this._offset=s.P.convert(e&&e.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",n=>{n.preventDefault()}),this._element.addEventListener("mousedown",n=>{n.preventDefault()}),to(this._element,this._anchor,"marker"),e&&e.className)for(const n of e.className.split(" "))this._element.classList.add(n);this._popup=null}addTo(e){return this.remove(),this._map=e,this._element.setAttribute("aria-label",e._getUIString("Marker.Title")),e.getCanvasContainer().appendChild(this._element),e.on("move",this._update),e.on("moveend",this._update),e.on("terrain",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),c.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(e){return this._lngLat=s.N.convert(e),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(e){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),e){if(!("offset"in e.options)){const u=Math.abs(13.5)/Math.SQRT2;e.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[u,-1*(38.1-13.5+u)],"bottom-right":[-u,-1*(38.1-13.5+u)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=e,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(e){return this._subpixelPositioning=e,this}getPopup(){return this._popup}togglePopup(){const e=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:e?(e.isOpen()?e.remove():(e.setLngLat(this._lngLat),e.addTo(this._map)),this):this}_updateOpacity(e=!1){var n,a;if(!(!((n=this._map)===null||n===void 0)&&n.terrain))return void(this._element.style.opacity!==this._opacity&&(this._element.style.opacity=this._opacity));if(e)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout(()=>{this._opacityTimeout=null},100)}const u=this._map,_=u.terrain.depthAtPoint(this._pos),I=u.terrain.getElevationForLngLatZoom(this._lngLat,u.transform.tileZoom);if(u.transform.lngLatToCameraDepth(this._lngLat,I)-_<.006)return void(this._element.style.opacity=this._opacity);const k=-this._offset.y/u.transform._pixelPerMeter,z=Math.sin(u.getPitch()*Math.PI/180)*k,R=u.terrain.depthAtPoint(new s.P(this._pos.x,this._pos.y-this._offset.y)),V=u.transform.lngLatToCameraDepth(this._lngLat,I+z)-R>.006;!((a=this._popup)===null||a===void 0)&&a.isOpen()&&V&&this._popup.remove(),this._element.style.opacity=V?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(e){return this._offset=s.P.convert(e),this._update(),this}addClassName(e){this._element.classList.add(e)}removeClassName(e){this._element.classList.remove(e)}toggleClassName(e){return this._element.classList.toggle(e)}setDraggable(e){return this._draggable=!!e,this._map&&(e?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(e){return this._rotation=e||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(e){return this._rotationAlignment=e||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(e){return this._pitchAlignment=e&&e!=="auto"?e:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(e,n){return e===void 0&&n===void 0&&(this._opacity="1",this._opacityWhenCovered="0.2"),e!==void 0&&(this._opacity=e),n!==void 0&&(this._opacityWhenCovered=n),this._map&&this._updateOpacity(!0),this}}const il={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let ta=0,ea=!1;const Tc={maxWidth:100,unit:"metric"};function Wl(y,e,n){const a=n&&n.maxWidth||100,u=y._container.clientHeight/2,_=y.unproject([0,u]),I=y.unproject([a,u]),k=_.distanceTo(I);if(n&&n.unit==="imperial"){const z=3.2808*k;z>5280?La(e,a,z/5280,y._getUIString("ScaleControl.Miles")):La(e,a,z,y._getUIString("ScaleControl.Feet"))}else n&&n.unit==="nautical"?La(e,a,k/1852,y._getUIString("ScaleControl.NauticalMiles")):k>=1e3?La(e,a,k/1e3,y._getUIString("ScaleControl.Kilometers")):La(e,a,k,y._getUIString("ScaleControl.Meters"))}function La(y,e,n,a){const u=function(_){const I=Math.pow(10,`${Math.floor(_)}`.length-1);let k=_/I;return k=k>=10?10:k>=5?5:k>=3?3:k>=2?2:k>=1?1:function(z){const R=Math.pow(10,Math.ceil(-Math.log(z)/Math.LN10));return Math.round(z*R)/R}(k),I*k}(n);y.style.width=e*(u/n)+"px",y.innerHTML=`${u}&nbsp;${a}`}const vs={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1},rl=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function ai(y){if(y){if(typeof y=="number"){const e=Math.round(Math.abs(y)/Math.SQRT2);return{center:new s.P(0,0),top:new s.P(0,y),"top-left":new s.P(e,e),"top-right":new s.P(-e,e),bottom:new s.P(0,-y),"bottom-left":new s.P(e,-e),"bottom-right":new s.P(-e,-e),left:new s.P(y,0),right:new s.P(-y,0)}}if(y instanceof s.P||Array.isArray(y)){const e=s.P.convert(y);return{center:e,top:e,"top-left":e,"top-right":e,bottom:e,"bottom-left":e,"bottom-right":e,left:e,right:e}}return{center:s.P.convert(y.center||[0,0]),top:s.P.convert(y.top||[0,0]),"top-left":s.P.convert(y["top-left"]||[0,0]),"top-right":s.P.convert(y["top-right"]||[0,0]),bottom:s.P.convert(y.bottom||[0,0]),"bottom-left":s.P.convert(y["bottom-left"]||[0,0]),"bottom-right":s.P.convert(y["bottom-right"]||[0,0]),left:s.P.convert(y.left||[0,0]),right:s.P.convert(y.right||[0,0])}}return ai(new s.P(0,0))}const mi=p;N.AJAXError=s.bg,N.Evented=s.E,N.LngLat=s.N,N.MercatorCoordinate=s.Z,N.Point=s.P,N.addProtocol=s.bh,N.config=s.a,N.removeProtocol=s.bi,N.AttributionControl=Qo,N.BoxZoomHandler=Mo,N.CanvasSource=ci,N.CooperativeGesturesHandler=Qn,N.DoubleClickZoomHandler=Rl,N.DragPanHandler=Wn,N.DragRotateHandler=Jn,N.EdgeInsets=br,N.FullscreenControl=class extends s.E{constructor(y={}){super(),this._onFullscreenChange=()=>{var e;let n=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((e=n==null?void 0:n.shadowRoot)===null||e===void 0)&&e.fullscreenElement;)n=n.shadowRoot.fullscreenElement;n===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,y&&y.container&&(y.container instanceof HTMLElement?this._container=y.container:s.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(y){return this._map=y,this._container||(this._container=this._map.getContainer()),this._controlContainer=c.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){c.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const y=this._fullscreenButton=c.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);c.create("span","maplibregl-ctrl-icon",y).setAttribute("aria-hidden","true"),y.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const y=this._getTitle();this._fullscreenButton.setAttribute("aria-label",y),this._fullscreenButton.title=y}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new s.k("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new s.k("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},N.GeoJSONSource=Ke,N.GeolocateControl=class extends s.E{constructor(y){super(),this._onSuccess=e=>{if(this._map){if(this._isOutOfMapMaxBounds(e))return this._setErrorState(),this.fire(new s.k("outofmaxbounds",e)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=e,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(e),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(e),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new s.k("geolocate",e)),this._finish()}},this._updateCamera=e=>{const n=new s.N(e.coords.longitude,e.coords.latitude),a=e.coords.accuracy,u=this._map.getBearing(),_=s.e({bearing:u},this.options.fitBoundsOptions),I=at.fromLngLat(n,a);this._map.fitBounds(I,_,{geolocateSource:!0})},this._updateMarker=e=>{if(e){const n=new s.N(e.coords.longitude,e.coords.latitude);this._accuracyCircleMarker.setLngLat(n).addTo(this._map),this._userLocationDotMarker.setLngLat(n).addTo(this._map),this._accuracy=e.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=e=>{if(this._map){if(this.options.trackUserLocation)if(e.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const n=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=n,this._geolocateButton.setAttribute("aria-label",n),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(e.code===3&&ea)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new s.k("error",e)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",e=>e.preventDefault()),this._geolocateButton=c.create("button","maplibregl-ctrl-geolocate",this._container),c.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=e=>{if(this._map){if(e===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const n=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=n,this._geolocateButton.setAttribute("aria-label",n)}else{const n=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=n,this._geolocateButton.setAttribute("aria-label",n)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=c.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new pr({element:this._dotElement}),this._circleElement=c.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new pr({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",()=>this.trigger()),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",n=>{n.geolocateSource||this._watchState!=="ACTIVE_LOCK"||n.originalEvent&&n.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new s.k("trackuserlocationend")),this.fire(new s.k("userlocationlostfocus")))})}},this.options=s.e({},il,y)}onAdd(y){return this._map=y,this._container=c.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),function(){return s._(this,arguments,void 0,function*(e=!1){if(Qs!==void 0&&!e)return Qs;if(window.navigator.permissions===void 0)return Qs=!!window.navigator.geolocation,Qs;try{Qs=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{Qs=!!window.navigator.geolocation}return Qs})}().then(e=>this._finishSetupUI(e)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),c.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,ta=0,ea=!1}_isOutOfMapMaxBounds(y){const e=this._map.getMaxBounds(),n=y.coords;return e&&(n.longitude<e.getWest()||n.longitude>e.getEast()||n.latitude<e.getSouth()||n.latitude>e.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const y=this._map.getBounds(),e=y.getSouthEast(),n=y.getNorthEast(),a=e.distanceTo(n),u=Math.ceil(this._accuracy/(a/this._map._container.clientHeight)*2);this._circleElement.style.width=`${u}px`,this._circleElement.style.height=`${u}px`}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.k("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":ta--,ea=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new s.k("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.k("trackuserlocationstart")),this.fire(new s.k("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let y;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),ta++,ta>1?(y={maximumAge:6e5,timeout:0},ea=!0):(y=this.options.positionOptions,ea=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,y)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},N.Hash=en,N.ImageSource=ve,N.KeyboardHandler=Ll,N.LngLatBounds=at,N.LogoControl=_s,N.Map=class extends oh{constructor(y){s.be.mark(s.bf.create);const e=Object.assign(Object.assign({},ah),y);if(e.minZoom!=null&&e.maxZoom!=null&&e.minZoom>e.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(e.minPitch!=null&&e.maxPitch!=null&&e.minPitch>e.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(e.minPitch!=null&&e.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(e.maxPitch!=null&&e.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(super(new Pr(e.minZoom,e.maxZoom,e.minPitch,e.maxPitch,e.renderWorldCopies),{bearingSnap:e.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new Ze,this._controls=[],this._mapId=s.a4(),this._contextLost=n=>{n.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new s.k("webglcontextlost",{originalEvent:n}))},this._contextRestored=n=>{this._setupPainter(),this.resize(),this._update(),this.fire(new s.k("webglcontextrestored",{originalEvent:n}))},this._onMapScroll=n=>{if(n.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=e.interactive,this._maxTileCacheSize=e.maxTileCacheSize,this._maxTileCacheZoomLevels=e.maxTileCacheZoomLevels,this._failIfMajorPerformanceCaveat=e.failIfMajorPerformanceCaveat===!0,this._preserveDrawingBuffer=e.preserveDrawingBuffer===!0,this._antialias=e.antialias===!0,this._trackResize=e.trackResize===!0,this._bearingSnap=e.bearingSnap,this._refreshExpiredTiles=e.refreshExpiredTiles===!0,this._fadeDuration=e.fadeDuration,this._crossSourceCollisions=e.crossSourceCollisions===!0,this._collectResourceTiming=e.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},Ge),e.locale),this._clickTolerance=e.clickTolerance,this._overridePixelRatio=e.pixelRatio,this._maxCanvasSize=e.maxCanvasSize,this.transformCameraUpdate=e.transformCameraUpdate,this.cancelPendingTileRequestsWhileZooming=e.cancelPendingTileRequestsWhileZooming===!0,this._imageQueueHandle=O.addThrottleControl(()=>this.isMoving()),this._requestManager=new L(e.transformRequest),typeof e.container=="string"){if(this._container=document.getElementById(e.container),!this._container)throw new Error(`Container '${e.container}' not found.`)}else{if(!(e.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=e.container}if(e.maxBounds&&this.setMaxBounds(e.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",()=>this._update(!1)).on("moveend",()=>this._update(!1)).on("zoom",()=>this._update(!0)).on("terrain",()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)}).once("idle",()=>{this._idleTriggered=!0}),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let n=!1;const a=wr(u=>{this._trackResize&&!this._removed&&this.resize(u)._update()},50);this._resizeObserver=new ResizeObserver(u=>{n?a(u):n=!0}),this._resizeObserver.observe(this._container)}this.handlers=new sh(this,e),this._hash=e.hash&&new en(typeof e.hash=="string"&&e.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:e.center,zoom:e.zoom,bearing:e.bearing,pitch:e.pitch}),e.bounds&&(this.resize(),this.fitBounds(e.bounds,s.e({},e.fitBoundsOptions,{duration:0})))),this.resize(),this._localIdeographFontFamily=e.localIdeographFontFamily,this._validateStyle=e.validateStyle,e.style&&this.setStyle(e.style,{localIdeographFontFamily:e.localIdeographFontFamily}),e.attributionControl&&this.addControl(new Qo(typeof e.attributionControl=="boolean"?void 0:e.attributionControl)),e.maplibreLogo&&this.addControl(new _s,e.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",n=>{this._update(n.dataType==="style"),this.fire(new s.k(`${n.dataType}data`,n))}),this.on("dataloading",n=>{this.fire(new s.k(`${n.dataType}dataloading`,n))}),this.on("dataabort",n=>{this.fire(new s.k("sourcedataabort",n))})}_getMapId(){return this._mapId}addControl(y,e){if(e===void 0&&(e=y.getDefaultPosition?y.getDefaultPosition():"top-right"),!y||!y.onAdd)return this.fire(new s.j(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=y.onAdd(this);this._controls.push(y);const a=this._controlPositions[e];return e.indexOf("bottom")!==-1?a.insertBefore(n,a.firstChild):a.appendChild(n),this}removeControl(y){if(!y||!y.onRemove)return this.fire(new s.j(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const e=this._controls.indexOf(y);return e>-1&&this._controls.splice(e,1),y.onRemove(this),this}hasControl(y){return this._controls.indexOf(y)>-1}calculateCameraOptionsFromTo(y,e,n,a){return a==null&&this.terrain&&(a=this.terrain.getElevationForLngLatZoom(n,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(y,e,n,a)}resize(y){var e;const n=this._containerDimensions(),a=n[0],u=n[1],_=this._getClampedPixelRatio(a,u);if(this._resizeCanvas(a,u,_),this.painter.resize(a,u,_),this.painter.overLimit()){const k=this.painter.context.gl;this._maxCanvasSize=[k.drawingBufferWidth,k.drawingBufferHeight];const z=this._getClampedPixelRatio(a,u);this._resizeCanvas(a,u,z),this.painter.resize(a,u,z)}this.transform.resize(a,u),(e=this._requestedCameraState)===null||e===void 0||e.resize(a,u);const I=!this._moving;return I&&(this.stop(),this.fire(new s.k("movestart",y)).fire(new s.k("move",y))),this.fire(new s.k("resize",y)),I&&this.fire(new s.k("moveend",y)),this}_getClampedPixelRatio(y,e){const{0:n,1:a}=this._maxCanvasSize,u=this.getPixelRatio(),_=y*u,I=e*u;return Math.min(_>n?n/_:1,I>a?a/I:1)*u}getPixelRatio(){var y;return(y=this._overridePixelRatio)!==null&&y!==void 0?y:devicePixelRatio}setPixelRatio(y){this._overridePixelRatio=y,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(y){return this.transform.setMaxBounds(at.convert(y)),this._update()}setMinZoom(y){if((y=y??-2)>=-2&&y<=this.transform.maxZoom)return this.transform.minZoom=y,this._update(),this.getZoom()<y&&this.setZoom(y),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(y){if((y=y??22)>=this.transform.minZoom)return this.transform.maxZoom=y,this._update(),this.getZoom()>y&&this.setZoom(y),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(y){if((y=y??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(y>=0&&y<=this.transform.maxPitch)return this.transform.minPitch=y,this._update(),this.getPitch()<y&&this.setPitch(y),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(y){if((y=y??60)>85)throw new Error("maxPitch must be less than or equal to 85");if(y>=this.transform.minPitch)return this.transform.maxPitch=y,this._update(),this.getPitch()>y&&this.setPitch(y),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(y){return this.transform.renderWorldCopies=y,this._update()}project(y){return this.transform.locationPoint(s.N.convert(y),this.style&&this.terrain)}unproject(y){return this.transform.pointLocation(s.P.convert(y),this.terrain)}isMoving(){var y;return this._moving||((y=this.handlers)===null||y===void 0?void 0:y.isMoving())}isZooming(){var y;return this._zooming||((y=this.handlers)===null||y===void 0?void 0:y.isZooming())}isRotating(){var y;return this._rotating||((y=this.handlers)===null||y===void 0?void 0:y.isRotating())}_createDelegatedListener(y,e,n){if(y==="mouseenter"||y==="mouseover"){let a=!1;return{layer:e,listener:n,delegates:{mousemove:_=>{const I=this.getLayer(e)?this.queryRenderedFeatures(_.point,{layers:[e]}):[];I.length?a||(a=!0,n.call(this,new Kr(y,this,_.originalEvent,{features:I}))):a=!1},mouseout:()=>{a=!1}}}}if(y==="mouseleave"||y==="mouseout"){let a=!1;return{layer:e,listener:n,delegates:{mousemove:I=>{(this.getLayer(e)?this.queryRenderedFeatures(I.point,{layers:[e]}):[]).length?a=!0:a&&(a=!1,n.call(this,new Kr(y,this,I.originalEvent)))},mouseout:I=>{a&&(a=!1,n.call(this,new Kr(y,this,I.originalEvent)))}}}}{const a=u=>{const _=this.getLayer(e)?this.queryRenderedFeatures(u.point,{layers:[e]}):[];_.length&&(u.features=_,n.call(this,u),delete u.features)};return{layer:e,listener:n,delegates:{[y]:a}}}}on(y,e,n){if(n===void 0)return super.on(y,e);const a=this._createDelegatedListener(y,e,n);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[y]=this._delegatedListeners[y]||[],this._delegatedListeners[y].push(a);for(const u in a.delegates)this.on(u,a.delegates[u]);return this}once(y,e,n){if(n===void 0)return super.once(y,e);const a=this._createDelegatedListener(y,e,n);for(const u in a.delegates)this.once(u,a.delegates[u]);return this}off(y,e,n){return n===void 0?super.off(y,e):(this._delegatedListeners&&this._delegatedListeners[y]&&(a=>{const u=this._delegatedListeners[y];for(let _=0;_<u.length;_++){const I=u[_];if(I.layer===e&&I.listener===n){for(const k in I.delegates)this.off(k,I.delegates[k]);return u.splice(_,1),this}}})(),this)}queryRenderedFeatures(y,e){if(!this.style)return[];let n;const a=y instanceof s.P||Array.isArray(y),u=a?y:[[0,0],[this.transform.width,this.transform.height]];if(e=e||(a?{}:y)||{},u instanceof s.P||typeof u[0]=="number")n=[s.P.convert(u)];else{const _=s.P.convert(u[0]),I=s.P.convert(u[1]);n=[_,new s.P(I.x,_.y),I,new s.P(_.x,I.y),_]}return this.style.queryRenderedFeatures(n,e,this.transform)}querySourceFeatures(y,e){return this.style.querySourceFeatures(y,e)}setStyle(y,e){return(e=s.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},e)).diff!==!1&&e.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&y?(this._diffStyle(y,e),this):(this._localIdeographFontFamily=e.localIdeographFontFamily,this._updateStyle(y,e))}setTransformRequest(y){return this._requestManager.setTransformRequest(y),this}_getUIString(y){const e=this._locale[y];if(e==null)throw new Error(`Missing UI string '${y}'`);return e}_updateStyle(y,e){if(e.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",()=>this._updateStyle(y,e));const n=this.style&&e.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!y)),y?(this.style=new No(this,e||{}),this.style.setEventedParent(this,{style:this.style}),typeof y=="string"?this.style.loadURL(y,e,n):this.style.loadJSON(y,e,n),this):(delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new No(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(y,e){if(typeof y=="string"){const n=this._requestManager.transformRequest(y,"Style");s.h(n,new AbortController).then(a=>{this._updateDiff(a.data,e)}).catch(a=>{a&&this.fire(new s.j(a))})}else typeof y=="object"&&this._updateDiff(y,e)}_updateDiff(y,e){try{this.style.setState(y,e)&&this._update(!0)}catch(n){s.w(`Unable to perform style diff: ${n.message||n.error||n}.  Rebuilding the style from scratch.`),this._updateStyle(y,e)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():s.w("There is no style added to the map.")}addSource(y,e){return this._lazyInitEmptyStyle(),this.style.addSource(y,e),this._update(!0)}isSourceLoaded(y){const e=this.style&&this.style.sourceCaches[y];if(e!==void 0)return e.loaded();this.fire(new s.j(new Error(`There is no source with ID '${y}'`)))}setTerrain(y){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),y){const e=this.style.sourceCaches[y.source];if(!e)throw new Error(`cannot load terrain, because there exists no source with ID: ${y.source}`);this.terrain===null&&e.reload();for(const n in this.style._layers){const a=this.style._layers[n];a.type==="hillshade"&&a.source===y.source&&s.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new xc(this.painter,e,y),this.painter.renderToTexture=new bc(this.painter,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._terrainDataCallback=n=>{n.dataType==="style"?this.terrain.sourceCache.freeRtt():n.dataType==="source"&&n.tile&&(n.sourceId!==y.source||this._elevationFreeze||(this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.terrain.sourceCache.freeRtt(n.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.minElevationForCurrentTile=0,this.transform.elevation=0;return this.fire(new s.k("terrain",{terrain:y})),this}getTerrain(){var y,e;return(e=(y=this.terrain)===null||y===void 0?void 0:y.options)!==null&&e!==void 0?e:null}areTilesLoaded(){const y=this.style&&this.style.sourceCaches;for(const e in y){const n=y[e]._tiles;for(const a in n){const u=n[a];if(u.state!=="loaded"&&u.state!=="errored")return!1}}return!0}removeSource(y){return this.style.removeSource(y),this._update(!0)}getSource(y){return this.style.getSource(y)}addImage(y,e,n={}){const{pixelRatio:a=1,sdf:u=!1,stretchX:_,stretchY:I,content:k,textFitWidth:z,textFitHeight:R}=n;if(this._lazyInitEmptyStyle(),!(e instanceof HTMLImageElement||s.b(e))){if(e.width===void 0||e.height===void 0)return this.fire(new s.j(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:V,height:G,data:Y}=e,tt=e;return this.style.addImage(y,{data:new s.R({width:V,height:G},new Uint8Array(Y)),pixelRatio:a,stretchX:_,stretchY:I,content:k,textFitWidth:z,textFitHeight:R,sdf:u,version:0,userImage:tt}),tt.onAdd&&tt.onAdd(this,y),this}}{const{width:V,height:G,data:Y}=l.getImageData(e);this.style.addImage(y,{data:new s.R({width:V,height:G},Y),pixelRatio:a,stretchX:_,stretchY:I,content:k,textFitWidth:z,textFitHeight:R,sdf:u,version:0})}}updateImage(y,e){const n=this.style.getImage(y);if(!n)return this.fire(new s.j(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const a=e instanceof HTMLImageElement||s.b(e)?l.getImageData(e):e,{width:u,height:_,data:I}=a;if(u===void 0||_===void 0)return this.fire(new s.j(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(u!==n.data.width||_!==n.data.height)return this.fire(new s.j(new Error("The width and height of the updated image must be that same as the previous version of the image")));const k=!(e instanceof HTMLImageElement||s.b(e));return n.data.replace(I,k),this.style.updateImage(y,n),this}getImage(y){return this.style.getImage(y)}hasImage(y){return y?!!this.style.getImage(y):(this.fire(new s.j(new Error("Missing required image id"))),!1)}removeImage(y){this.style.removeImage(y)}loadImage(y){return O.getImage(this._requestManager.transformRequest(y,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(y,e){return this._lazyInitEmptyStyle(),this.style.addLayer(y,e),this._update(!0)}moveLayer(y,e){return this.style.moveLayer(y,e),this._update(!0)}removeLayer(y){return this.style.removeLayer(y),this._update(!0)}getLayer(y){return this.style.getLayer(y)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(y,e,n){return this.style.setLayerZoomRange(y,e,n),this._update(!0)}setFilter(y,e,n={}){return this.style.setFilter(y,e,n),this._update(!0)}getFilter(y){return this.style.getFilter(y)}setPaintProperty(y,e,n,a={}){return this.style.setPaintProperty(y,e,n,a),this._update(!0)}getPaintProperty(y,e){return this.style.getPaintProperty(y,e)}setLayoutProperty(y,e,n,a={}){return this.style.setLayoutProperty(y,e,n,a),this._update(!0)}getLayoutProperty(y,e){return this.style.getLayoutProperty(y,e)}setGlyphs(y,e={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(y,e),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(y,e,n={}){return this._lazyInitEmptyStyle(),this.style.addSprite(y,e,n,a=>{a||this._update(!0)}),this}removeSprite(y){return this._lazyInitEmptyStyle(),this.style.removeSprite(y),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(y,e={}){return this._lazyInitEmptyStyle(),this.style.setSprite(y,e,n=>{n||this._update(!0)}),this}setLight(y,e={}){return this._lazyInitEmptyStyle(),this.style.setLight(y,e),this._update(!0)}getLight(){return this.style.getLight()}setSky(y){return this._lazyInitEmptyStyle(),this.style.setSky(y),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(y,e){return this.style.setFeatureState(y,e),this._update()}removeFeatureState(y,e){return this.style.removeFeatureState(y,e),this._update()}getFeatureState(y){return this.style.getFeatureState(y)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let y=0,e=0;return this._container&&(y=this._container.clientWidth||400,e=this._container.clientHeight||300),[y,e]}_setupContainer(){const y=this._container;y.classList.add("maplibregl-map");const e=this._canvasContainer=c.create("div","maplibregl-canvas-container",y);this._interactive&&e.classList.add("maplibregl-interactive"),this._canvas=c.create("canvas","maplibregl-canvas",e),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const n=this._containerDimensions(),a=this._getClampedPixelRatio(n[0],n[1]);this._resizeCanvas(n[0],n[1],a);const u=this._controlContainer=c.create("div","maplibregl-control-container",y),_=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(I=>{_[I]=c.create("div",`maplibregl-ctrl-${I} `,u)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(y,e,n){this._canvas.width=Math.floor(n*y),this._canvas.height=Math.floor(n*e),this._canvas.style.width=`${y}px`,this._canvas.style.height=`${e}px`}_setupPainter(){const y={alpha:!0,stencil:!0,depth:!0,failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1};let e=null;this._canvas.addEventListener("webglcontextcreationerror",a=>{e={requestedAttributes:y},a&&(e.statusMessage=a.statusMessage,e.type=a.type)},{once:!0});const n=this._canvas.getContext("webgl2",y)||this._canvas.getContext("webgl",y);if(!n){const a="Failed to initialize WebGL";throw e?(e.message=a,new Error(JSON.stringify(e))):new Error(a)}this.painter=new ar(n,this.transform),h.testSupport(n)}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(y){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||y,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(y){return this._update(),this._renderTaskQueue.add(y)}_cancelRenderFrame(y){this._renderTaskQueue.remove(y)}_render(y){const e=this._idleTriggered?this._fadeDuration:0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(y),this._removed)return;let n=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const u=this.transform.zoom,_=l.now();this.style.zoomHistory.update(u,_);const I=new s.a9(u,{now:_,fadeDuration:e,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),k=I.crossFadingFactor();k===1&&k===this._crossFadingFactor||(n=!0,this._crossFadingFactor=k),this.style.update(I)}this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._elevationFreeze||(this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.minElevationForCurrentTile=0,this.transform.elevation=0),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,e,this._crossSourceCollisions),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:e,showPadding:this.showPadding}),this.fire(new s.k("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,s.be.mark(s.bf.load),this.fire(new s.k("load"))),this.style&&(this.style.hasTransitions()||n)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const a=this._sourcesDirty||this._styleDirty||this._placementDirty;return a||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new s.k("idle")),!this._loaded||this._fullyLoaded||a||(this._fullyLoaded=!0,s.be.mark(s.bf.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var y;this._hash&&this._hash.remove();for(const n of this._controls)n.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),O.removeThrottleControl(this._imageQueueHandle),(y=this._resizeObserver)===null||y===void 0||y.disconnect();const e=this.painter.context.gl.getExtension("WEBGL_lose_context");e!=null&&e.loseContext&&e.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),c.remove(this._canvasContainer),c.remove(this._controlContainer),this._container.classList.remove("maplibregl-map"),s.be.clearMetrics(),this._removed=!0,this.fire(new s.k("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,l.frameAsync(this._frameRequest).then(y=>{s.be.frame(y),this._frameRequest=null,this._render(y)}).catch(()=>{}))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(y){this._showTileBoundaries!==y&&(this._showTileBoundaries=y,this._update())}get showPadding(){return!!this._showPadding}set showPadding(y){this._showPadding!==y&&(this._showPadding=y,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(y){this._showCollisionBoxes!==y&&(this._showCollisionBoxes=y,y?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(y){this._showOverdrawInspector!==y&&(this._showOverdrawInspector=y,this._update())}get repaint(){return!!this._repaint}set repaint(y){this._repaint!==y&&(this._repaint=y,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(y){this._vertices=y,this._update()}get version(){return Ul}getCameraTargetElevation(){return this.transform.elevation}},N.MapMouseEvent=Kr,N.MapTouchEvent=Ao,N.MapWheelEvent=Ki,N.Marker=pr,N.NavigationControl=class{constructor(y){this._updateZoomButtons=()=>{const e=this._map.getZoom(),n=e===this._map.getMaxZoom(),a=e===this._map.getMinZoom();this._zoomInButton.disabled=n,this._zoomOutButton.disabled=a,this._zoomInButton.setAttribute("aria-disabled",n.toString()),this._zoomOutButton.setAttribute("aria-disabled",a.toString())},this._rotateCompassArrow=()=>{const e=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._compassIcon.style.transform=e},this._setButtonTitle=(e,n)=>{const a=this._map._getUIString(`NavigationControl.${n}`);e.title=a,e.setAttribute("aria-label",a)},this.options=s.e({},Gl,y),this._container=c.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",e=>e.preventDefault()),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",e=>this._map.zoomIn({},{originalEvent:e})),c.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",e=>this._map.zoomOut({},{originalEvent:e})),c.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",e=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:e}):this._map.resetNorth({},{originalEvent:e})}),this._compassIcon=c.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(y){return this._map=y,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Cc(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){c.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(y,e){const n=c.create("button",y,this._container);return n.type="button",n.addEventListener("click",e),n}},N.Popup=class extends s.E{constructor(y){super(),this.remove=()=>(this._content&&c.remove(this._content),this._container&&(c.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new s.k("close"))),this),this._onMouseUp=e=>{this._update(e.point)},this._onMouseMove=e=>{this._update(e.point)},this._onDrag=e=>{this._update(e.point)},this._update=e=>{var n;if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=c.create("div","maplibregl-popup",this._map.getContainer()),this._tip=c.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const k of this.options.className.split(" "))this._container.classList.add(k);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=this._map.transform.renderWorldCopies&&!this._trackPointer?Sc(this._lngLat,this._flatPos,this._map.transform):(n=this._lngLat)===null||n===void 0?void 0:n.wrap(),this._trackPointer&&!e)return;const a=this._flatPos=this._pos=this._trackPointer&&e?e:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&e?e:this._map.transform.locationPoint(this._lngLat));let u=this.options.anchor;const _=ai(this.options.offset);if(!u){const k=this._container.offsetWidth,z=this._container.offsetHeight;let R;R=a.y+_.bottom.y<z?["top"]:a.y>this._map.transform.height-z?["bottom"]:[],a.x<k/2?R.push("left"):a.x>this._map.transform.width-k/2&&R.push("right"),u=R.length===0?"bottom":R.join("-")}let I=a.add(_[u]);this.options.subpixelPositioning||(I=I.round()),c.setTransform(this._container,`${Xl[u]} translate(${I.x}px,${I.y}px)`),to(this._container,u,"popup")},this._onClose=()=>{this.remove()},this.options=s.e(Object.create(vs),y)}addTo(y){return this._map&&this.remove(),this._map=y,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new s.k("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(y){return this._lngLat=s.N.convert(y),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(y){return this.setDOMContent(document.createTextNode(y))}setHTML(y){const e=document.createDocumentFragment(),n=document.createElement("body");let a;for(n.innerHTML=y;a=n.firstChild,a;)e.appendChild(a);return this.setDOMContent(e)}getMaxWidth(){var y;return(y=this._container)===null||y===void 0?void 0:y.style.maxWidth}setMaxWidth(y){return this.options.maxWidth=y,this._update(),this}setDOMContent(y){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=c.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(y),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(y){return this._container&&this._container.classList.add(y),this}removeClassName(y){return this._container&&this._container.classList.remove(y),this}setOffset(y){return this.options.offset=y,this._update(),this}toggleClassName(y){if(this._container)return this._container.classList.toggle(y)}setSubpixelPositioning(y){this.options.subpixelPositioning=y}_createCloseButton(){this.options.closeButton&&(this._closeButton=c.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const y=this._container.querySelector(rl);y&&y.focus()}},N.RasterDEMTileSource=Fe,N.RasterTileSource=ue,N.ScaleControl=class{constructor(y){this._onMove=()=>{Wl(this._map,this._container,this.options)},this.setUnit=e=>{this.options.unit=e,Wl(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},Tc),y)}getDefaultPosition(){return"bottom-left"}onAdd(y){return this._map=y,this._container=c.create("div","maplibregl-ctrl maplibregl-ctrl-scale",y.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){c.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},N.ScrollZoomHandler=Fl,N.Style=No,N.TerrainControl=class{constructor(y){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=y}onAdd(y){return this._map=y,this._container=c.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=c.create("button","maplibregl-ctrl-terrain",this._container),c.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){c.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},N.TwoFingersTouchPitchHandler=Dl,N.TwoFingersTouchRotateHandler=Ol,N.TwoFingersTouchZoomHandler=Ml,N.TwoFingersTouchZoomRotateHandler=Bl,N.VectorTileSource=pe,N.VideoSource=He,N.addSourceType=(y,e)=>s._(void 0,void 0,void 0,function*(){if(vi(y))throw new Error(`A source type called "${y}" already exists.`);((n,a)=>{wi[n]=a})(y,e)}),N.clearPrewarmedResources=function(){const y=jt;y&&(y.isPreloaded()&&y.numActive()===1?(y.release(pt),jt=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},N.getMaxParallelImageRequests=function(){return s.a.MAX_PARALLEL_IMAGE_REQUESTS},N.getRTLTextPluginStatus=function(){return nr().getRTLTextPluginStatus()},N.getVersion=function(){return mi},N.getWorkerCount=function(){return rt.workerCount},N.getWorkerUrl=function(){return s.a.WORKER_URL},N.importScriptInWorkers=function(y){return ye().broadcast("IS",y)},N.prewarm=function(){Wt().acquire(pt)},N.setMaxParallelImageRequests=function(y){s.a.MAX_PARALLEL_IMAGE_REQUESTS=y},N.setRTLTextPlugin=function(y,e){return nr().setRTLTextPlugin(y,e)},N.setWorkerCount=function(y){rt.workerCount=y},N.setWorkerUrl=function(y){s.a.WORKER_URL=y}});var It=st;return It})})(cf);var uf=cf.exports;const Yd=lf(uf);var df={exports:{}};(function(Z,S){(function(st,ft){Z.exports=ft()})(bl,function(){var st=function(P,F){var K={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},yt={on:function(kt,Rt,xe){if(K[kt]===void 0)throw new Error("Invalid event type: "+kt);K[kt].push({selector:Rt,fn:xe})},render:function(kt){F.store.featureChanged(kt)}},Tt=function(kt,Rt){for(var xe=K[kt],Ie=xe.length;Ie--;){var Ne=xe[Ie];if(Ne.selector(Rt)){Ne.fn.call(yt,Rt)||F.store.render(),F.ui.updateMapClasses();break}}};return P.start.call(yt),{render:P.render,stop:function(){P.stop&&P.stop()},trash:function(){P.trash&&(P.trash(),F.store.render())},combineFeatures:function(){P.combineFeatures&&P.combineFeatures()},uncombineFeatures:function(){P.uncombineFeatures&&P.uncombineFeatures()},drag:function(kt){Tt("drag",kt)},click:function(kt){Tt("click",kt)},mousemove:function(kt){Tt("mousemove",kt)},mousedown:function(kt){Tt("mousedown",kt)},mouseup:function(kt){Tt("mouseup",kt)},mouseout:function(kt){Tt("mouseout",kt)},keydown:function(kt){Tt("keydown",kt)},keyup:function(kt){Tt("keyup",kt)},touchstart:function(kt){Tt("touchstart",kt)},touchmove:function(kt){Tt("touchmove",kt)},touchend:function(kt){Tt("touchend",kt)},tap:function(kt){Tt("tap",kt)}}};function ft(P){return P&&P.__esModule&&Object.prototype.hasOwnProperty.call(P,"default")?P.default:P}function lt(P){if(P.__esModule)return P;var F=P.default;if(typeof F=="function"){var K=function yt(){if(this instanceof yt){var Tt=[null];Tt.push.apply(Tt,arguments);var kt=Function.bind.apply(F,Tt);return new kt}return F.apply(this,arguments)};K.prototype=F.prototype}else K={};return Object.defineProperty(K,"__esModule",{value:!0}),Object.keys(P).forEach(function(yt){var Tt=Object.getOwnPropertyDescriptor(P,yt);Object.defineProperty(K,yt,Tt.get?Tt:{enumerable:!0,get:function(){return P[yt]}})}),K}var It={},N={RADIUS:6378137,FLATTENING:1/298.257223563,POLAR_RADIUS:63567523142e-4},s=N;function p(P){var F=0;if(P&&P.length>0){F+=Math.abs(C(P[0]));for(var K=1;K<P.length;K++)F-=Math.abs(C(P[K]))}return F}function C(P){var F,K,yt,Tt,kt,Rt,xe=0,Ie=P.length;if(Ie>2){for(Rt=0;Rt<Ie;Rt++)Rt===Ie-2?(yt=Ie-2,Tt=Ie-1,kt=0):Rt===Ie-1?(yt=Ie-1,Tt=0,kt=1):(yt=Rt,Tt=Rt+1,kt=Rt+2),F=P[yt],K=P[Tt],xe+=(b(P[kt][0])-b(F[0]))*Math.sin(b(K[1]));xe=xe*s.RADIUS*s.RADIUS/2}return xe}function b(P){return P*Math.PI/180}It.geometry=function P(F){var K,yt=0;switch(F.type){case"Polygon":return p(F.coordinates);case"MultiPolygon":for(K=0;K<F.coordinates.length;K++)yt+=p(F.coordinates[K]);return yt;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(K=0;K<F.geometries.length;K++)yt+=P(F.geometries[K]);return yt}},It.ring=C;var l={CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},c={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},h={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},m={POLYGON:"polygon",LINE:"line_string",POINT:"point"},g={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},d={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select",STATIC:"static"},w={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},E={MOVE:"move",CHANGE_COORDINATES:"change_coordinates"},O={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},L={ACTIVE:"true",INACTIVE:"false"},U=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],$=-85,nt=Object.freeze({__proto__:null,classes:l,sources:c,cursors:h,types:m,geojsonTypes:g,modes:d,events:w,updateActions:E,meta:O,activeStates:L,interactions:U,LAT_MIN:-90,LAT_RENDERED_MIN:$,LAT_MAX:90,LAT_RENDERED_MAX:85,LNG_MIN:-270,LNG_MAX:270}),xt={Point:0,LineString:1,MultiLineString:1,Polygon:2};function Ft(P,F){var K=xt[P.geometry.type]-xt[F.geometry.type];return K===0&&P.geometry.type===g.POLYGON?P.area-F.area:K}function Kt(P){return P.map(function(F){return F.geometry.type===g.POLYGON&&(F.area=It.geometry({type:g.FEATURE,property:{},geometry:F.geometry})),F}).sort(Ft).map(function(F){return delete F.area,F})}function Jt(P,F){return F===void 0&&(F=0),[[P.point.x-F,P.point.y-F],[P.point.x+F,P.point.y+F]]}function Qt(P){if(this._items={},this._nums={},this._length=P?P.length:0,P)for(var F=0,K=P.length;F<K;F++)this.add(P[F]),P[F]!==void 0&&(typeof P[F]=="string"?this._items[P[F]]=F:this._nums[P[F]]=F)}Qt.prototype.add=function(P){return this.has(P)||(this._length++,typeof P=="string"?this._items[P]=this._length:this._nums[P]=this._length),this},Qt.prototype.delete=function(P){return this.has(P)===!1||(this._length--,delete this._items[P],delete this._nums[P]),this},Qt.prototype.has=function(P){return(typeof P=="string"||typeof P=="number")&&(this._items[P]!==void 0||this._nums[P]!==void 0)},Qt.prototype.values=function(){var P=this,F=[];return Object.keys(this._items).forEach(function(K){F.push({k:K,v:P._items[K]})}),Object.keys(this._nums).forEach(function(K){F.push({k:JSON.parse(K),v:P._nums[K]})}),F.sort(function(K,yt){return K.v-yt.v}).map(function(K){return K.k})},Qt.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};var he=[O.FEATURE,O.MIDPOINT,O.VERTEX],ne={click:function(P,F,K){return me(P,F,K,K.options.clickBuffer)},touch:function(P,F,K){return me(P,F,K,K.options.touchBuffer)}};function me(P,F,K,yt){if(K.map===null)return[];var Tt=P?Jt(P,yt):F,kt={};K.options.styles&&(kt.layers=K.options.styles.map(function(Ne){return Ne.id}).filter(function(Ne){return K.map.getLayer(Ne)!=null}));var Rt=K.map.queryRenderedFeatures(Tt,kt).filter(function(Ne){return he.indexOf(Ne.properties.meta)!==-1}),xe=new Qt,Ie=[];return Rt.forEach(function(Ne){var je=Ne.properties.id;xe.has(je)||(xe.add(je),Ie.push(Ne))}),Kt(Ie)}function Oe(P,F){var K=ne.click(P,null,F),yt={mouse:h.NONE};return K[0]&&(yt.mouse=K[0].properties.active===L.ACTIVE?h.MOVE:h.POINTER,yt.feature=K[0].properties.meta),F.events.currentModeName().indexOf("draw")!==-1&&(yt.mouse=h.ADD),F.ui.queueMapClasses(yt),F.ui.updateMapClasses(),K[0]}function se(P,F){var K=P.x-F.x,yt=P.y-F.y;return Math.sqrt(K*K+yt*yt)}function be(P,F,K){K===void 0&&(K={});var yt=K.fineTolerance!=null?K.fineTolerance:4,Tt=K.grossTolerance!=null?K.grossTolerance:12,kt=K.interval!=null?K.interval:500;P.point=P.point||F.point,P.time=P.time||F.time;var Rt=se(P.point,F.point);return Rt<yt||Rt<Tt&&F.time-P.time<kt}function Q(P,F,K){K===void 0&&(K={});var yt=K.tolerance!=null?K.tolerance:25,Tt=K.interval!=null?K.interval:250;return P.point=P.point||F.point,P.time=P.time||F.time,se(P.point,F.point)<yt&&F.time-P.time<Tt}var wt={exports:{}},gt=wt.exports=function(P,F){if(F||(F=16),P===void 0&&(P=128),P<=0)return"0";for(var K=Math.log(Math.pow(2,P))/Math.log(F),yt=2;K===1/0;yt*=2)K=Math.log(Math.pow(2,P/yt))/Math.log(F)*yt;var Tt=K-Math.floor(K),kt="";for(yt=0;yt<Math.floor(K);yt++)kt=Math.floor(Math.random()*F).toString(F)+kt;if(Tt){var Rt=Math.pow(F,Tt);kt=Math.floor(Math.random()*Rt).toString(F)+kt}var xe=parseInt(kt,F);return xe!==1/0&&xe>=Math.pow(2,P)?gt(P,F):kt};gt.rack=function(P,F,K){var yt=function(kt){var Rt=0;do{if(Rt++>10){if(!K)throw new Error("too many ID collisions, use more bits");P+=K}var xe=gt(P,F)}while(Object.hasOwnProperty.call(Tt,xe));return Tt[xe]=kt,xe},Tt=yt.hats={};return yt.get=function(kt){return yt.hats[kt]},yt.set=function(kt,Rt){return yt.hats[kt]=Rt,yt},yt.bits=P||128,yt.base=F||16,yt};var vt=ft(wt.exports),Vt=function(P,F){this.ctx=P,this.properties=F.properties||{},this.coordinates=F.geometry.coordinates,this.id=F.id||vt(),this.type=F.geometry.type};Vt.prototype.changed=function(){this.ctx.store.featureChanged(this.id)},Vt.prototype.incomingCoords=function(P){this.setCoordinates(P)},Vt.prototype.setCoordinates=function(P){this.coordinates=P,this.changed()},Vt.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))},Vt.prototype.setProperty=function(P,F){this.properties[P]=F},Vt.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:g.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))},Vt.prototype.internal=function(P){var F={id:this.id,meta:O.FEATURE,"meta:type":this.type,active:L.INACTIVE,mode:P};if(this.ctx.options.userProperties)for(var K in this.properties)F["user_"+K]=this.properties[K];return{type:g.FEATURE,properties:F,geometry:{coordinates:this.getCoordinates(),type:this.type}}};var pt=function(P,F){Vt.call(this,P,F)};(pt.prototype=Object.create(Vt.prototype)).isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"},pt.prototype.updateCoordinate=function(P,F,K){this.coordinates=arguments.length===3?[F,K]:[P,F],this.changed()},pt.prototype.getCoordinate=function(){return this.getCoordinates()};var rt=function(P,F){Vt.call(this,P,F)};(rt.prototype=Object.create(Vt.prototype)).isValid=function(){return this.coordinates.length>1},rt.prototype.addCoordinate=function(P,F,K){this.changed();var yt=parseInt(P,10);this.coordinates.splice(yt,0,[F,K])},rt.prototype.getCoordinate=function(P){var F=parseInt(P,10);return JSON.parse(JSON.stringify(this.coordinates[F]))},rt.prototype.removeCoordinate=function(P){this.changed(),this.coordinates.splice(parseInt(P,10),1)},rt.prototype.updateCoordinate=function(P,F,K){var yt=parseInt(P,10);this.coordinates[yt]=[F,K],this.changed()};var Mt=function(P,F){Vt.call(this,P,F),this.coordinates=this.coordinates.map(function(K){return K.slice(0,-1)})};(Mt.prototype=Object.create(Vt.prototype)).isValid=function(){return this.coordinates.length!==0&&this.coordinates.every(function(P){return P.length>2})},Mt.prototype.incomingCoords=function(P){this.coordinates=P.map(function(F){return F.slice(0,-1)}),this.changed()},Mt.prototype.setCoordinates=function(P){this.coordinates=P,this.changed()},Mt.prototype.addCoordinate=function(P,F,K){this.changed();var yt=P.split(".").map(function(Tt){return parseInt(Tt,10)});this.coordinates[yt[0]].splice(yt[1],0,[F,K])},Mt.prototype.removeCoordinate=function(P){this.changed();var F=P.split(".").map(function(yt){return parseInt(yt,10)}),K=this.coordinates[F[0]];K&&(K.splice(F[1],1),K.length<3&&this.coordinates.splice(F[0],1))},Mt.prototype.getCoordinate=function(P){var F=P.split(".").map(function(yt){return parseInt(yt,10)}),K=this.coordinates[F[0]];return JSON.parse(JSON.stringify(K[F[1]]))},Mt.prototype.getCoordinates=function(){return this.coordinates.map(function(P){return P.concat([P[0]])})},Mt.prototype.updateCoordinate=function(P,F,K){this.changed();var yt=P.split("."),Tt=parseInt(yt[0],10),kt=parseInt(yt[1],10);this.coordinates[Tt]===void 0&&(this.coordinates[Tt]=[]),this.coordinates[Tt][kt]=[F,K]};var jt={MultiPoint:pt,MultiLineString:rt,MultiPolygon:Mt},te=function(P,F,K,yt,Tt){var kt=K.split("."),Rt=parseInt(kt[0],10),xe=kt[1]?kt.slice(1).join("."):null;return P[Rt][F](xe,yt,Tt)},Wt=function(P,F){if(Vt.call(this,P,F),delete this.coordinates,this.model=jt[F.geometry.type],this.model===void 0)throw new TypeError(F.geometry.type+" is not a valid type");this.features=this._coordinatesToFeatures(F.geometry.coordinates)};function Xt(P){this.map=P.map,this.drawConfig=JSON.parse(JSON.stringify(P.options||{})),this._ctx=P}(Wt.prototype=Object.create(Vt.prototype))._coordinatesToFeatures=function(P){var F=this,K=this.model.bind(this);return P.map(function(yt){return new K(F.ctx,{id:vt(),type:g.FEATURE,properties:{},geometry:{coordinates:yt,type:F.type.replace("Multi","")}})})},Wt.prototype.isValid=function(){return this.features.every(function(P){return P.isValid()})},Wt.prototype.setCoordinates=function(P){this.features=this._coordinatesToFeatures(P),this.changed()},Wt.prototype.getCoordinate=function(P){return te(this.features,"getCoordinate",P)},Wt.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(function(P){return P.type===g.POLYGON?P.getCoordinates():P.coordinates})))},Wt.prototype.updateCoordinate=function(P,F,K){te(this.features,"updateCoordinate",P,F,K),this.changed()},Wt.prototype.addCoordinate=function(P,F,K){te(this.features,"addCoordinate",P,F,K),this.changed()},Wt.prototype.removeCoordinate=function(P){te(this.features,"removeCoordinate",P),this.changed()},Wt.prototype.getFeatures=function(){return this.features},Xt.prototype.setSelected=function(P){return this._ctx.store.setSelected(P)},Xt.prototype.setSelectedCoordinates=function(P){var F=this;this._ctx.store.setSelectedCoordinates(P),P.reduce(function(K,yt){return K[yt.feature_id]===void 0&&(K[yt.feature_id]=!0,F._ctx.store.get(yt.feature_id).changed()),K},{})},Xt.prototype.getSelected=function(){return this._ctx.store.getSelected()},Xt.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()},Xt.prototype.isSelected=function(P){return this._ctx.store.isSelected(P)},Xt.prototype.getFeature=function(P){return this._ctx.store.get(P)},Xt.prototype.select=function(P){return this._ctx.store.select(P)},Xt.prototype.deselect=function(P){return this._ctx.store.deselect(P)},Xt.prototype.deleteFeature=function(P,F){return F===void 0&&(F={}),this._ctx.store.delete(P,F)},Xt.prototype.addFeature=function(P){return this._ctx.store.add(P)},Xt.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()},Xt.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()},Xt.prototype.setActionableState=function(P){P===void 0&&(P={});var F={trash:P.trash||!1,combineFeatures:P.combineFeatures||!1,uncombineFeatures:P.uncombineFeatures||!1};return this._ctx.events.actionable(F)},Xt.prototype.changeMode=function(P,F,K){return F===void 0&&(F={}),K===void 0&&(K={}),this._ctx.events.changeMode(P,F,K)},Xt.prototype.updateUIClasses=function(P){return this._ctx.ui.queueMapClasses(P)},Xt.prototype.activateUIButton=function(P){return this._ctx.ui.setActiveButton(P)},Xt.prototype.featuresAt=function(P,F,K){if(K===void 0&&(K="click"),K!=="click"&&K!=="touch")throw new Error("invalid buffer type");return ne[K](P,F,this._ctx)},Xt.prototype.newFeature=function(P){var F=P.geometry.type;return F===g.POINT?new pt(this._ctx,P):F===g.LINE_STRING?new rt(this._ctx,P):F===g.POLYGON?new Mt(this._ctx,P):new Wt(this._ctx,P)},Xt.prototype.isInstanceOf=function(P,F){if(P===g.POINT)return F instanceof pt;if(P===g.LINE_STRING)return F instanceof rt;if(P===g.POLYGON)return F instanceof Mt;if(P==="MultiFeature")return F instanceof Wt;throw new Error("Unknown feature class: "+P)},Xt.prototype.doRender=function(P){return this._ctx.store.featureChanged(P)},Xt.prototype.onSetup=function(){},Xt.prototype.onDrag=function(){},Xt.prototype.onClick=function(){},Xt.prototype.onMouseMove=function(){},Xt.prototype.onMouseDown=function(){},Xt.prototype.onMouseUp=function(){},Xt.prototype.onMouseOut=function(){},Xt.prototype.onKeyUp=function(){},Xt.prototype.onKeyDown=function(){},Xt.prototype.onTouchStart=function(){},Xt.prototype.onTouchMove=function(){},Xt.prototype.onTouchEnd=function(){},Xt.prototype.onTap=function(){},Xt.prototype.onStop=function(){},Xt.prototype.onTrash=function(){},Xt.prototype.onCombineFeature=function(){},Xt.prototype.onUncombineFeature=function(){},Xt.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};var ye={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},Te=Object.keys(ye);function qt(P){var F=Object.keys(P);return function(K,yt){yt===void 0&&(yt={});var Tt={},kt=F.reduce(function(Rt,xe){return Rt[xe]=P[xe],Rt},new Xt(K));return{start:function(){var Rt=this;Tt=kt.onSetup(yt),Te.forEach(function(xe){var Ie,Ne=ye[xe],je=function(){return!1};P[Ne]&&(je=function(){return!0}),Rt.on(xe,je,(Ie=Ne,function(De){return kt[Ie](Tt,De)}))})},stop:function(){kt.onStop(Tt)},trash:function(){kt.onTrash(Tt)},combineFeatures:function(){kt.onCombineFeatures(Tt)},uncombineFeatures:function(){kt.onUncombineFeatures(Tt)},render:function(Rt,xe){kt.toDisplayFeatures(Tt,Rt,xe)}}}}function Lt(P){return[].concat(P).filter(function(F){return F!==void 0})}function ae(){var P=this;if(!(P.ctx.map&&P.ctx.map.getSource(c.HOT)!==void 0))return Ie();var F=P.ctx.events.currentModeName();P.ctx.ui.queueMapClasses({mode:F});var K=[],yt=[];P.isDirty?yt=P.getAllIds():(K=P.getChangedIds().filter(function(Ne){return P.get(Ne)!==void 0}),yt=P.sources.hot.filter(function(Ne){return Ne.properties.id&&K.indexOf(Ne.properties.id)===-1&&P.get(Ne.properties.id)!==void 0}).map(function(Ne){return Ne.properties.id})),P.sources.hot=[];var Tt=P.sources.cold.length;P.sources.cold=P.isDirty?[]:P.sources.cold.filter(function(Ne){var je=Ne.properties.id||Ne.properties.parent;return K.indexOf(je)===-1});var kt=Tt!==P.sources.cold.length||yt.length>0;function Rt(Ne,je){var De=P.get(Ne).internal(F);P.ctx.events.currentModeRender(De,function(pi){P.sources[je].push(pi)})}if(K.forEach(function(Ne){return Rt(Ne,"hot")}),yt.forEach(function(Ne){return Rt(Ne,"cold")}),kt&&P.ctx.map.getSource(c.COLD).setData({type:g.FEATURE_COLLECTION,features:P.sources.cold}),P.ctx.map.getSource(c.HOT).setData({type:g.FEATURE_COLLECTION,features:P.sources.hot}),P._emitSelectionChange&&(P.ctx.map.fire(w.SELECTION_CHANGE,{features:P.getSelected().map(function(Ne){return Ne.toGeoJSON()}),points:P.getSelectedCoordinates().map(function(Ne){return{type:g.FEATURE,properties:{},geometry:{type:g.POINT,coordinates:Ne.coordinates}}})}),P._emitSelectionChange=!1),P._deletedFeaturesToEmit.length){var xe=P._deletedFeaturesToEmit.map(function(Ne){return Ne.toGeoJSON()});P._deletedFeaturesToEmit=[],P.ctx.map.fire(w.DELETE,{features:xe})}function Ie(){P.isDirty=!1,P.clearChangedIds()}Ie(),P.ctx.map.fire(w.RENDER,{})}function at(P){var F,K=this;this._features={},this._featureIds=new Qt,this._selectedFeatureIds=new Qt,this._selectedCoordinates=[],this._changedFeatureIds=new Qt,this._deletedFeaturesToEmit=[],this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=P,this.sources={hot:[],cold:[]},this.render=function(){F||(F=requestAnimationFrame(function(){F=null,ae.call(K)}))},this.isDirty=!1}function Zt(P,F){var K=P._selectedCoordinates.filter(function(yt){return P._selectedFeatureIds.has(yt.feature_id)});P._selectedCoordinates.length===K.length||F.silent||(P._emitSelectionChange=!0),P._selectedCoordinates=K}at.prototype.createRenderBatch=function(){var P=this,F=this.render,K=0;return this.render=function(){K++},function(){P.render=F,K>0&&P.render()}},at.prototype.setDirty=function(){return this.isDirty=!0,this},at.prototype.featureChanged=function(P){return this._changedFeatureIds.add(P),this},at.prototype.getChangedIds=function(){return this._changedFeatureIds.values()},at.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this},at.prototype.getAllIds=function(){return this._featureIds.values()},at.prototype.add=function(P){return this.featureChanged(P.id),this._features[P.id]=P,this._featureIds.add(P.id),this},at.prototype.delete=function(P,F){var K=this;return F===void 0&&(F={}),Lt(P).forEach(function(yt){K._featureIds.has(yt)&&(K._featureIds.delete(yt),K._selectedFeatureIds.delete(yt),F.silent||K._deletedFeaturesToEmit.indexOf(K._features[yt])===-1&&K._deletedFeaturesToEmit.push(K._features[yt]),delete K._features[yt],K.isDirty=!0)}),Zt(this,F),this},at.prototype.get=function(P){return this._features[P]},at.prototype.getAll=function(){var P=this;return Object.keys(this._features).map(function(F){return P._features[F]})},at.prototype.select=function(P,F){var K=this;return F===void 0&&(F={}),Lt(P).forEach(function(yt){K._selectedFeatureIds.has(yt)||(K._selectedFeatureIds.add(yt),K._changedFeatureIds.add(yt),F.silent||(K._emitSelectionChange=!0))}),this},at.prototype.deselect=function(P,F){var K=this;return F===void 0&&(F={}),Lt(P).forEach(function(yt){K._selectedFeatureIds.has(yt)&&(K._selectedFeatureIds.delete(yt),K._changedFeatureIds.add(yt),F.silent||(K._emitSelectionChange=!0))}),Zt(this,F),this},at.prototype.clearSelected=function(P){return P===void 0&&(P={}),this.deselect(this._selectedFeatureIds.values(),{silent:P.silent}),this},at.prototype.setSelected=function(P,F){var K=this;return F===void 0&&(F={}),P=Lt(P),this.deselect(this._selectedFeatureIds.values().filter(function(yt){return P.indexOf(yt)===-1}),{silent:F.silent}),this.select(P.filter(function(yt){return!K._selectedFeatureIds.has(yt)}),{silent:F.silent}),this},at.prototype.setSelectedCoordinates=function(P){return this._selectedCoordinates=P,this._emitSelectionChange=!0,this},at.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this},at.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()},at.prototype.getSelected=function(){var P=this;return this._selectedFeatureIds.values().map(function(F){return P.get(F)})},at.prototype.getSelectedCoordinates=function(){var P=this;return this._selectedCoordinates.map(function(F){return{coordinates:P.get(F.feature_id).getCoordinate(F.coord_path)}})},at.prototype.isSelected=function(P){return this._selectedFeatureIds.has(P)},at.prototype.setFeatureProperty=function(P,F,K){this.get(P).setProperty(F,K),this.featureChanged(P)},at.prototype.storeMapConfig=function(){var P=this;U.forEach(function(F){P.ctx.map[F]&&(P._mapInitialConfig[F]=P.ctx.map[F].isEnabled())})},at.prototype.restoreMapConfig=function(){var P=this;Object.keys(this._mapInitialConfig).forEach(function(F){P._mapInitialConfig[F]?P.ctx.map[F].enable():P.ctx.map[F].disable()})},at.prototype.getInitialConfigValue=function(P){return this._mapInitialConfig[P]===void 0||this._mapInitialConfig[P]};var pe=function(){for(var P=arguments,F={},K=0;K<arguments.length;K++){var yt=P[K];for(var Tt in yt)ue.call(yt,Tt)&&(F[Tt]=yt[Tt])}return F},ue=Object.prototype.hasOwnProperty,Fe=ft(pe),Ke=["mode","feature","mouse"];function oe(P){var F=null,K=null,yt={onRemove:function(){return P.map.off("load",yt.connect),clearInterval(K),yt.removeLayers(),P.store.restoreMapConfig(),P.ui.removeButtons(),P.events.removeEventListeners(),P.ui.clearMapClasses(),P.boxZoomInitial&&P.map.boxZoom.enable(),P.map=null,P.container=null,P.store=null,F&&F.parentNode&&F.parentNode.removeChild(F),F=null,this},connect:function(){P.map.off("load",yt.connect),clearInterval(K),yt.addLayers(),P.store.storeMapConfig(),P.events.addEventListeners()},onAdd:function(Tt){var kt=Tt.fire;return Tt.fire=function(Rt,xe){var Ie=arguments;return kt.length===1&&arguments.length!==1&&(Ie=[Fe({},{type:Rt},xe)]),kt.apply(Tt,Ie)},P.map=Tt,P.events=function(Rt){var xe=Object.keys(Rt.options.modes).reduce(function(ge,ri){return ge[ri]=qt(Rt.options.modes[ri]),ge},{}),Ie={},Ne={},je={},De=null,pi=null;je.drag=function(ge,ri){ri({point:ge.point,time:new Date().getTime()})?(Rt.ui.queueMapClasses({mouse:h.DRAG}),pi.drag(ge)):ge.originalEvent.stopPropagation()},je.mousedrag=function(ge){je.drag(ge,function(ri){return!be(Ie,ri)})},je.touchdrag=function(ge){je.drag(ge,function(ri){return!Q(Ne,ri)})},je.mousemove=function(ge){if((ge.originalEvent.buttons!==void 0?ge.originalEvent.buttons:ge.originalEvent.which)===1)return je.mousedrag(ge);var ri=Oe(ge,Rt);ge.featureTarget=ri,pi.mousemove(ge)},je.mousedown=function(ge){Ie={time:new Date().getTime(),point:ge.point};var ri=Oe(ge,Rt);ge.featureTarget=ri,pi.mousedown(ge)},je.mouseup=function(ge){var ri=Oe(ge,Rt);ge.featureTarget=ri,be(Ie,{point:ge.point,time:new Date().getTime()})?pi.click(ge):pi.mouseup(ge)},je.mouseout=function(ge){pi.mouseout(ge)},je.touchstart=function(ge){if(Rt.options.touchEnabled){Ne={time:new Date().getTime(),point:ge.point};var ri=ne.touch(ge,null,Rt)[0];ge.featureTarget=ri,pi.touchstart(ge)}},je.touchmove=function(ge){if(Rt.options.touchEnabled)return pi.touchmove(ge),je.touchdrag(ge)},je.touchend=function(ge){if(ge.originalEvent.preventDefault(),Rt.options.touchEnabled){var ri=ne.touch(ge,null,Rt)[0];ge.featureTarget=ri,Q(Ne,{time:new Date().getTime(),point:ge.point})?pi.tap(ge):pi.touchend(ge)}};var er=function(ge){return!(ge===8||ge===46||ge>=48&&ge<=57)};function di(ge,ri,qi){qi===void 0&&(qi={}),pi.stop();var zr=xe[ge];if(zr===void 0)throw new Error(ge+" is not valid");De=ge;var or=zr(Rt,ri);pi=st(or,Rt),qi.silent||Rt.map.fire(w.MODE_CHANGE,{mode:ge}),Rt.store.setDirty(),Rt.store.render()}je.keydown=function(ge){(ge.srcElement||ge.target).classList.contains("mapboxgl-canvas")&&(ge.keyCode!==8&&ge.keyCode!==46||!Rt.options.controls.trash?er(ge.keyCode)?pi.keydown(ge):ge.keyCode===49&&Rt.options.controls.point?di(d.DRAW_POINT):ge.keyCode===50&&Rt.options.controls.line_string?di(d.DRAW_LINE_STRING):ge.keyCode===51&&Rt.options.controls.polygon&&di(d.DRAW_POLYGON):(ge.preventDefault(),pi.trash()))},je.keyup=function(ge){er(ge.keyCode)&&pi.keyup(ge)},je.zoomend=function(){Rt.store.changeZoom()},je.data=function(ge){if(ge.dataType==="style"){var ri=Rt.setup,qi=Rt.map,zr=Rt.options,or=Rt.store;zr.styles.some(function(Vo){return qi.getLayer(Vo.id)})||(ri.addLayers(),or.setDirty(),or.render())}};var Ni={trash:!1,combineFeatures:!1,uncombineFeatures:!1};return{start:function(){De=Rt.options.defaultMode,pi=st(xe[De](Rt),Rt)},changeMode:di,actionable:function(ge){var ri=!1;Object.keys(ge).forEach(function(qi){if(Ni[qi]===void 0)throw new Error("Invalid action type");Ni[qi]!==ge[qi]&&(ri=!0),Ni[qi]=ge[qi]}),ri&&Rt.map.fire(w.ACTIONABLE,{actions:Ni})},currentModeName:function(){return De},currentModeRender:function(ge,ri){return pi.render(ge,ri)},fire:function(ge,ri){je[ge]&&je[ge](ri)},addEventListeners:function(){Rt.map.on("mousemove",je.mousemove),Rt.map.on("mousedown",je.mousedown),Rt.map.on("mouseup",je.mouseup),Rt.map.on("data",je.data),Rt.map.on("touchmove",je.touchmove),Rt.map.on("touchstart",je.touchstart),Rt.map.on("touchend",je.touchend),Rt.container.addEventListener("mouseout",je.mouseout),Rt.options.keybindings&&(Rt.container.addEventListener("keydown",je.keydown),Rt.container.addEventListener("keyup",je.keyup))},removeEventListeners:function(){Rt.map.off("mousemove",je.mousemove),Rt.map.off("mousedown",je.mousedown),Rt.map.off("mouseup",je.mouseup),Rt.map.off("data",je.data),Rt.map.off("touchmove",je.touchmove),Rt.map.off("touchstart",je.touchstart),Rt.map.off("touchend",je.touchend),Rt.container.removeEventListener("mouseout",je.mouseout),Rt.options.keybindings&&(Rt.container.removeEventListener("keydown",je.keydown),Rt.container.removeEventListener("keyup",je.keyup))},trash:function(ge){pi.trash(ge)},combineFeatures:function(){pi.combineFeatures()},uncombineFeatures:function(){pi.uncombineFeatures()},getMode:function(){return De}}}(P),P.ui=function(Rt){var xe={},Ie=null,Ne={mode:null,feature:null,mouse:null},je={mode:null,feature:null,mouse:null};function De(ge){je=Fe(je,ge)}function pi(){var ge,ri;if(Rt.container){var qi=[],zr=[];Ke.forEach(function(or){je[or]!==Ne[or]&&(qi.push(or+"-"+Ne[or]),je[or]!==null&&zr.push(or+"-"+je[or]))}),qi.length>0&&(ge=Rt.container.classList).remove.apply(ge,qi),zr.length>0&&(ri=Rt.container.classList).add.apply(ri,zr),Ne=Fe(Ne,je)}}function er(ge,ri){ri===void 0&&(ri={});var qi=document.createElement("button");return qi.className=l.CONTROL_BUTTON+" "+ri.className,qi.setAttribute("title",ri.title),ri.container.appendChild(qi),qi.addEventListener("click",function(zr){if(zr.preventDefault(),zr.stopPropagation(),zr.target===Ie)return di(),void ri.onDeactivate();Ni(ge),ri.onActivate()},!0),qi}function di(){Ie&&(Ie.classList.remove(l.ACTIVE_BUTTON),Ie=null)}function Ni(ge){di();var ri=xe[ge];ri&&ri&&ge!=="trash"&&(ri.classList.add(l.ACTIVE_BUTTON),Ie=ri)}return{setActiveButton:Ni,queueMapClasses:De,updateMapClasses:pi,clearMapClasses:function(){De({mode:null,feature:null,mouse:null}),pi()},addButtons:function(){var ge=Rt.options.controls,ri=document.createElement("div");return ri.className=l.CONTROL_GROUP+" "+l.CONTROL_BASE,ge&&(ge[m.LINE]&&(xe[m.LINE]=er(m.LINE,{container:ri,className:l.CONTROL_BUTTON_LINE,title:"LineString tool "+(Rt.options.keybindings?"(l)":""),onActivate:function(){return Rt.events.changeMode(d.DRAW_LINE_STRING)},onDeactivate:function(){return Rt.events.trash()}})),ge[m.POLYGON]&&(xe[m.POLYGON]=er(m.POLYGON,{container:ri,className:l.CONTROL_BUTTON_POLYGON,title:"Polygon tool "+(Rt.options.keybindings?"(p)":""),onActivate:function(){return Rt.events.changeMode(d.DRAW_POLYGON)},onDeactivate:function(){return Rt.events.trash()}})),ge[m.POINT]&&(xe[m.POINT]=er(m.POINT,{container:ri,className:l.CONTROL_BUTTON_POINT,title:"Marker tool "+(Rt.options.keybindings?"(m)":""),onActivate:function(){return Rt.events.changeMode(d.DRAW_POINT)},onDeactivate:function(){return Rt.events.trash()}})),ge.trash&&(xe.trash=er("trash",{container:ri,className:l.CONTROL_BUTTON_TRASH,title:"Delete",onActivate:function(){Rt.events.trash()}})),ge.combine_features&&(xe.combine_features=er("combineFeatures",{container:ri,className:l.CONTROL_BUTTON_COMBINE_FEATURES,title:"Combine",onActivate:function(){Rt.events.combineFeatures()}})),ge.uncombine_features&&(xe.uncombine_features=er("uncombineFeatures",{container:ri,className:l.CONTROL_BUTTON_UNCOMBINE_FEATURES,title:"Uncombine",onActivate:function(){Rt.events.uncombineFeatures()}}))),ri},removeButtons:function(){Object.keys(xe).forEach(function(ge){var ri=xe[ge];ri.parentNode&&ri.parentNode.removeChild(ri),delete xe[ge]})}}}(P),P.container=Tt.getContainer(),P.store=new at(P),F=P.ui.addButtons(),P.options.boxSelect&&(P.boxZoomInitial=Tt.boxZoom.isEnabled(),Tt.boxZoom.disable(),Tt.dragPan.disable(),Tt.dragPan.enable()),Tt.loaded()?yt.connect():(Tt.on("load",yt.connect),K=setInterval(function(){Tt.loaded()&&yt.connect()},16)),P.events.start(),F},addLayers:function(){P.map.addSource(c.COLD,{data:{type:g.FEATURE_COLLECTION,features:[]},type:"geojson"}),P.map.addSource(c.HOT,{data:{type:g.FEATURE_COLLECTION,features:[]},type:"geojson"}),P.options.styles.forEach(function(Tt){P.map.addLayer(Tt)}),P.store.setDirty(!0),P.store.render()},removeLayers:function(){P.options.styles.forEach(function(Tt){P.map.getLayer(Tt.id)&&P.map.removeLayer(Tt.id)}),P.map.getSource(c.COLD)&&P.map.removeSource(c.COLD),P.map.getSource(c.HOT)&&P.map.removeSource(c.HOT)}};return P.setup=yt,yt}var ve=[{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":"#3bb2d0","fill-outline-color":"#3bb2d0","fill-opacity":.1}},{id:"gl-draw-polygon-fill-active",type:"fill",filter:["all",["==","active","true"],["==","$type","Polygon"]],paint:{"fill-color":"#fbb03b","fill-outline-color":"#fbb03b","fill-opacity":.1}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","active","true"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-line-active",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-stroke-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-color":"#fff"}},{id:"gl-draw-polygon-and-line-vertex-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-point-point-stroke-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-opacity":1,"circle-color":"#fff"}},{id:"gl-draw-point-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#3bb2d0"}},{id:"gl-draw-point-stroke-active",type:"circle",filter:["all",["==","$type","Point"],["==","active","true"],["!=","meta","midpoint"]],paint:{"circle-radius":7,"circle-color":"#fff"}},{id:"gl-draw-point-active",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","true"]],paint:{"circle-radius":5,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-fill-static",type:"fill",filter:["all",["==","mode","static"],["==","$type","Polygon"]],paint:{"fill-color":"#404040","fill-outline-color":"#404040","fill-opacity":.1}},{id:"gl-draw-polygon-stroke-static",type:"line",filter:["all",["==","mode","static"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-line-static",type:"line",filter:["all",["==","mode","static"],["==","$type","LineString"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-point-static",type:"circle",filter:["all",["==","mode","static"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"#404040"}}];function He(P){return function(F){var K=F.featureTarget;return!!K&&!!K.properties&&K.properties.meta===P}}function ci(P){return!!P.originalEvent&&!!P.originalEvent.shiftKey&&P.originalEvent.button===0}function wi(P){return!!P.featureTarget&&!!P.featureTarget.properties&&P.featureTarget.properties.active===L.ACTIVE&&P.featureTarget.properties.meta===O.FEATURE}function vi(P){return!!P.featureTarget&&!!P.featureTarget.properties&&P.featureTarget.properties.active===L.INACTIVE&&P.featureTarget.properties.meta===O.FEATURE}function ce(P){return P.featureTarget===void 0}function Ti(P){return!!P.featureTarget&&!!P.featureTarget.properties&&P.featureTarget.properties.meta===O.FEATURE}function zi(P){var F=P.featureTarget;return!!F&&!!F.properties&&F.properties.meta===O.VERTEX}function nr(P){return!!P.originalEvent&&P.originalEvent.shiftKey===!0}function Yi(P){return P.keyCode===27}function Ee(P){return P.keyCode===13}var ui=Object.freeze({__proto__:null,isOfMetaType:He,isShiftMousedown:ci,isActiveFeature:wi,isInactiveFeature:vi,noTarget:ce,isFeature:Ti,isVertex:zi,isShiftDown:nr,isEscapeKey:Yi,isEnterKey:Ee,isTrue:function(){return!0}}),$e=Zi;function Zi(P,F){this.x=P,this.y=F}Zi.prototype={clone:function(){return new Zi(this.x,this.y)},add:function(P){return this.clone()._add(P)},sub:function(P){return this.clone()._sub(P)},multByPoint:function(P){return this.clone()._multByPoint(P)},divByPoint:function(P){return this.clone()._divByPoint(P)},mult:function(P){return this.clone()._mult(P)},div:function(P){return this.clone()._div(P)},rotate:function(P){return this.clone()._rotate(P)},rotateAround:function(P,F){return this.clone()._rotateAround(P,F)},matMult:function(P){return this.clone()._matMult(P)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(P){return this.x===P.x&&this.y===P.y},dist:function(P){return Math.sqrt(this.distSqr(P))},distSqr:function(P){var F=P.x-this.x,K=P.y-this.y;return F*F+K*K},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(P){return Math.atan2(this.y-P.y,this.x-P.x)},angleWith:function(P){return this.angleWithSep(P.x,P.y)},angleWithSep:function(P,F){return Math.atan2(this.x*F-this.y*P,this.x*P+this.y*F)},_matMult:function(P){var F=P[0]*this.x+P[1]*this.y,K=P[2]*this.x+P[3]*this.y;return this.x=F,this.y=K,this},_add:function(P){return this.x+=P.x,this.y+=P.y,this},_sub:function(P){return this.x-=P.x,this.y-=P.y,this},_mult:function(P){return this.x*=P,this.y*=P,this},_div:function(P){return this.x/=P,this.y/=P,this},_multByPoint:function(P){return this.x*=P.x,this.y*=P.y,this},_divByPoint:function(P){return this.x/=P.x,this.y/=P.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var P=this.y;return this.y=this.x,this.x=-P,this},_rotate:function(P){var F=Math.cos(P),K=Math.sin(P),yt=F*this.x-K*this.y,Tt=K*this.x+F*this.y;return this.x=yt,this.y=Tt,this},_rotateAround:function(P,F){var K=Math.cos(P),yt=Math.sin(P),Tt=F.x+K*(this.x-F.x)-yt*(this.y-F.y),kt=F.y+yt*(this.x-F.x)+K*(this.y-F.y);return this.x=Tt,this.y=kt,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Zi.convert=function(P){return P instanceof Zi?P:Array.isArray(P)?new Zi(P[0],P[1]):P};var Tr=ft($e);function ii(P,F){var K=F.getBoundingClientRect();return new Tr(P.clientX-K.left-(F.clientLeft||0),P.clientY-K.top-(F.clientTop||0))}function Oi(P,F,K,yt){return{type:g.FEATURE,properties:{meta:O.VERTEX,parent:P,coord_path:K,active:yt?L.ACTIVE:L.INACTIVE},geometry:{type:g.POINT,coordinates:F}}}function Wi(P,F,K){var yt=F.geometry.coordinates,Tt=K.geometry.coordinates;if(yt[1]>85||yt[1]<$||Tt[1]>85||Tt[1]<$)return null;var kt={lng:(yt[0]+Tt[0])/2,lat:(yt[1]+Tt[1])/2};return{type:g.FEATURE,properties:{meta:O.MIDPOINT,parent:P,lng:kt.lng,lat:kt.lat,coord_path:K.properties.coord_path},geometry:{type:g.POINT,coordinates:[kt.lng,kt.lat]}}}function Rr(P,F,K){F===void 0&&(F={}),K===void 0&&(K=null);var yt,Tt=P.geometry,kt=Tt.type,Rt=Tt.coordinates,xe=P.properties&&P.properties.id,Ie=[];function Ne(De,pi){var er="",di=null;De.forEach(function(Ni,ge){var ri=pi!=null?pi+"."+ge:String(ge),qi=Oi(xe,Ni,ri,je(ri));if(F.midpoints&&di){var zr=Wi(xe,di,qi);zr&&Ie.push(zr)}di=qi;var or=JSON.stringify(Ni);er!==or&&Ie.push(qi),ge===0&&(er=or)})}function je(De){return!!F.selectedPaths&&F.selectedPaths.indexOf(De)!==-1}return kt===g.POINT?Ie.push(Oi(xe,Rt,K,je(K))):kt===g.POLYGON?Rt.forEach(function(De,pi){Ne(De,K!==null?K+"."+pi:String(pi))}):kt===g.LINE_STRING?Ne(Rt,K):kt.indexOf(g.MULTI_PREFIX)===0&&(yt=kt.replace(g.MULTI_PREFIX,""),Rt.forEach(function(De,pi){var er={type:g.FEATURE,properties:P.properties,geometry:{type:yt,coordinates:De}};Ie=Ie.concat(Rr(er,F,pi))})),Ie}var cr={enable:function(P){setTimeout(function(){P.map&&P.map.doubleClickZoom&&P._ctx&&P._ctx.store&&P._ctx.store.getInitialConfigValue&&P._ctx.store.getInitialConfigValue("doubleClickZoom")&&P.map.doubleClickZoom.enable()},0)},disable:function(P){setTimeout(function(){P.map&&P.map.doubleClickZoom&&P.map.doubleClickZoom.disable()},0)}},_t={exports:{}},W=function(P){if(!P||!P.type)return null;var F=H[P.type];if(!F)return null;if(F==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:P}]};if(F==="feature")return{type:"FeatureCollection",features:[P]};if(F==="featurecollection")return P},H={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"},et=ft(W),ct=Object.freeze({__proto__:null,default:function P(F){switch(F&&F.type||null){case"FeatureCollection":return F.features=F.features.reduce(function(K,yt){return K.concat(P(yt))},[]),F;case"Feature":return F.geometry?P(F.geometry).map(function(K){var yt={type:"Feature",properties:JSON.parse(JSON.stringify(F.properties)),geometry:K};return F.id!==void 0&&(yt.id=F.id),yt}):[F];case"MultiPoint":return F.coordinates.map(function(K){return{type:"Point",coordinates:K}});case"MultiPolygon":return F.coordinates.map(function(K){return{type:"Polygon",coordinates:K}});case"MultiLineString":return F.coordinates.map(function(K){return{type:"LineString",coordinates:K}});case"GeometryCollection":return F.geometries.map(P).reduce(function(K,yt){return K.concat(yt)},[]);case"Point":case"Polygon":case"LineString":return[F]}}}),Et=W,Ot=lt(ct),zt=function(P){return function F(K){return Array.isArray(K)&&K.length&&typeof K[0]=="number"?[K]:K.reduce(function(yt,Tt){return Array.isArray(Tt)&&Array.isArray(Tt[0])?yt.concat(F(Tt)):(yt.push(Tt),yt)},[])}(P)};Ot instanceof Function||(Ot=Ot.default);var St={exports:{}},ee=St.exports=function(P){return new le(P)};function le(P){this.value=P}function Yt(P,F,K){var yt=[],Tt=[],kt=!0;return function Rt(xe){var Ie=K?Pe(xe):xe,Ne={},je=!0,De={node:Ie,node_:xe,path:[].concat(yt),parent:Tt[Tt.length-1],parents:Tt,key:yt.slice(-1)[0],isRoot:yt.length===0,level:yt.length,circular:null,update:function(di,Ni){De.isRoot||(De.parent.node[De.key]=di),De.node=di,Ni&&(je=!1)},delete:function(di){delete De.parent.node[De.key],di&&(je=!1)},remove:function(di){_i(De.parent.node)?De.parent.node.splice(De.key,1):delete De.parent.node[De.key],di&&(je=!1)},keys:null,before:function(di){Ne.before=di},after:function(di){Ne.after=di},pre:function(di){Ne.pre=di},post:function(di){Ne.post=di},stop:function(){kt=!1},block:function(){je=!1}};if(!kt)return De;function pi(){if(typeof De.node=="object"&&De.node!==null){De.keys&&De.node_===De.node||(De.keys=Qe(De.node)),De.isLeaf=De.keys.length==0;for(var di=0;di<Tt.length;di++)if(Tt[di].node_===xe){De.circular=Tt[di];break}}else De.isLeaf=!0,De.keys=null;De.notLeaf=!De.isLeaf,De.notRoot=!De.isRoot}pi();var er=F.call(De,De.node);return er!==void 0&&De.update&&De.update(er),Ne.before&&Ne.before.call(De,De.node),je&&(typeof De.node!="object"||De.node===null||De.circular||(Tt.push(De),pi(),Ei(De.keys,function(di,Ni){yt.push(di),Ne.pre&&Ne.pre.call(De,De.node[di],di);var ge=Rt(De.node[di]);K&&gi.call(De.node,di)&&(De.node[di]=ge.node),ge.isLast=Ni==De.keys.length-1,ge.isFirst=Ni==0,Ne.post&&Ne.post.call(De,ge),yt.pop()}),Tt.pop()),Ne.after&&Ne.after.call(De,De.node)),De}(P).node}function Pe(P){if(typeof P=="object"&&P!==null){var F;if(_i(P))F=[];else if(ei(P)==="[object Date]")F=new Date(P.getTime?P.getTime():P);else if(function(Tt){return ei(Tt)==="[object RegExp]"}(P))F=new RegExp(P);else if(function(Tt){return ei(Tt)==="[object Error]"}(P))F={message:P.message};else if(function(Tt){return ei(Tt)==="[object Boolean]"}(P))F=new Boolean(P);else if(function(Tt){return ei(Tt)==="[object Number]"}(P))F=new Number(P);else if(function(Tt){return ei(Tt)==="[object String]"}(P))F=new String(P);else if(Object.create&&Object.getPrototypeOf)F=Object.create(Object.getPrototypeOf(P));else if(P.constructor===Object)F={};else{var K=P.constructor&&P.constructor.prototype||P.__proto__||{},yt=function(){};yt.prototype=K,F=new yt}return Ei(Qe(P),function(Tt){F[Tt]=P[Tt]}),F}return P}le.prototype.get=function(P){for(var F=this.value,K=0;K<P.length;K++){var yt=P[K];if(!F||!gi.call(F,yt)){F=void 0;break}F=F[yt]}return F},le.prototype.has=function(P){for(var F=this.value,K=0;K<P.length;K++){var yt=P[K];if(!F||!gi.call(F,yt))return!1;F=F[yt]}return!0},le.prototype.set=function(P,F){for(var K=this.value,yt=0;yt<P.length-1;yt++){var Tt=P[yt];gi.call(K,Tt)||(K[Tt]={}),K=K[Tt]}return K[P[yt]]=F,F},le.prototype.map=function(P){return Yt(this.value,P,!0)},le.prototype.forEach=function(P){return this.value=Yt(this.value,P,!1),this.value},le.prototype.reduce=function(P,F){var K=arguments.length===1,yt=K?this.value:F;return this.forEach(function(Tt){this.isRoot&&K||(yt=P.call(this,yt,Tt))}),yt},le.prototype.paths=function(){var P=[];return this.forEach(function(F){P.push(this.path)}),P},le.prototype.nodes=function(){var P=[];return this.forEach(function(F){P.push(this.node)}),P},le.prototype.clone=function(){var P=[],F=[];return function K(yt){for(var Tt=0;Tt<P.length;Tt++)if(P[Tt]===yt)return F[Tt];if(typeof yt=="object"&&yt!==null){var kt=Pe(yt);return P.push(yt),F.push(kt),Ei(Qe(yt),function(Rt){kt[Rt]=K(yt[Rt])}),P.pop(),F.pop(),kt}return yt}(this.value)};var Qe=Object.keys||function(P){var F=[];for(var K in P)F.push(K);return F};function ei(P){return Object.prototype.toString.call(P)}var _i=Array.isArray||function(P){return Object.prototype.toString.call(P)==="[object Array]"},Ei=function(P,F){if(P.forEach)return P.forEach(F);for(var K=0;K<P.length;K++)F(P[K],K,P)};Ei(Qe(le.prototype),function(P){ee[P]=function(F){var K=[].slice.call(arguments,1),yt=new le(F);return yt[P].apply(yt,K)}});var gi=Object.hasOwnProperty||function(P,F){return F in P},tr=St.exports,xr=Fi;function Fi(P){if(!(this instanceof Fi))return new Fi(P);this._bbox=P||[1/0,1/0,-1/0,-1/0],this._valid=!!P}Fi.prototype.include=function(P){return this._valid=!0,this._bbox[0]=Math.min(this._bbox[0],P[0]),this._bbox[1]=Math.min(this._bbox[1],P[1]),this._bbox[2]=Math.max(this._bbox[2],P[0]),this._bbox[3]=Math.max(this._bbox[3],P[1]),this},Fi.prototype.equals=function(P){var F;return F=P instanceof Fi?P.bbox():P,this._bbox[0]==F[0]&&this._bbox[1]==F[1]&&this._bbox[2]==F[2]&&this._bbox[3]==F[3]},Fi.prototype.center=function(P){return this._valid?[(this._bbox[0]+this._bbox[2])/2,(this._bbox[1]+this._bbox[3])/2]:null},Fi.prototype.union=function(P){var F;return this._valid=!0,F=P instanceof Fi?P.bbox():P,this._bbox[0]=Math.min(this._bbox[0],F[0]),this._bbox[1]=Math.min(this._bbox[1],F[1]),this._bbox[2]=Math.max(this._bbox[2],F[2]),this._bbox[3]=Math.max(this._bbox[3],F[3]),this},Fi.prototype.bbox=function(){return this._valid?this._bbox:null},Fi.prototype.contains=function(P){if(!P)return this._fastContains();if(!this._valid)return null;var F=P[0],K=P[1];return this._bbox[0]<=F&&this._bbox[1]<=K&&this._bbox[2]>=F&&this._bbox[3]>=K},Fi.prototype.intersect=function(P){return this._valid?(F=P instanceof Fi?P.bbox():P,!(this._bbox[0]>F[2]||this._bbox[2]<F[0]||this._bbox[3]<F[1]||this._bbox[1]>F[3])):null;var F},Fi.prototype._fastContains=function(){if(!this._valid)return new Function("return null;");var P="return "+this._bbox[0]+"<= ll[0] &&"+this._bbox[1]+"<= ll[1] &&"+this._bbox[2]+">= ll[0] &&"+this._bbox[3]+">= ll[1]";return new Function("ll",P)},Fi.prototype.polygon=function(){return this._valid?{type:"Polygon",coordinates:[[[this._bbox[0],this._bbox[1]],[this._bbox[2],this._bbox[1]],[this._bbox[2],this._bbox[3]],[this._bbox[0],this._bbox[3]],[this._bbox[0],this._bbox[1]]]]}:null};var ki=function(P){if(!P)return[];var F=Ot(Et(P)),K=[];return F.features.forEach(function(yt){yt.geometry&&(K=K.concat(zt(yt.geometry.coordinates)))}),K},Hi=tr,hr=xr,Ar={features:["FeatureCollection"],coordinates:["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],geometry:["Feature"],geometries:["GeometryCollection"]},Wr=Object.keys(Ar);function Br(P){for(var F=hr(),K=ki(P),yt=0;yt<K.length;yt++)F.include(K[yt]);return F}_t.exports=function(P){return Br(P).bbox()},_t.exports.polygon=function(P){return Br(P).polygon()},_t.exports.bboxify=function(P){return Hi(P).map(function(F){F&&Wr.some(function(K){return!!F[K]&&Ar[K].indexOf(F.type)!==-1})&&(F.bbox=Br(F).bbox(),this.update(F))})};var uo=ft(_t.exports),Ri=-90;function fo(P,F){var K=Ri,yt=90,Tt=Ri,kt=90,Rt=270,xe=-270;P.forEach(function(Ne){var je=uo(Ne),De=je[1],pi=je[3],er=je[0],di=je[2];De>K&&(K=De),pi<yt&&(yt=pi),pi>Tt&&(Tt=pi),De<kt&&(kt=De),er<Rt&&(Rt=er),di>xe&&(xe=di)});var Ie=F;return K+Ie.lat>85&&(Ie.lat=85-K),Tt+Ie.lat>90&&(Ie.lat=90-Tt),yt+Ie.lat<-85&&(Ie.lat=-85-yt),kt+Ie.lat<Ri&&(Ie.lat=Ri-kt),Rt+Ie.lng<=-270&&(Ie.lng+=360*Math.ceil(Math.abs(Ie.lng)/360)),xe+Ie.lng>=270&&(Ie.lng-=360*Math.ceil(Math.abs(Ie.lng)/360)),Ie}function po(P,F){var K=fo(P.map(function(yt){return yt.toGeoJSON()}),F);P.forEach(function(yt){var Tt,kt=yt.getCoordinates(),Rt=function(Ie){var Ne={lng:Ie[0]+K.lng,lat:Ie[1]+K.lat};return[Ne.lng,Ne.lat]},xe=function(Ie){return Ie.map(function(Ne){return Rt(Ne)})};yt.type===g.POINT?Tt=Rt(kt):yt.type===g.LINE_STRING||yt.type===g.MULTI_POINT?Tt=kt.map(Rt):yt.type===g.POLYGON||yt.type===g.MULTI_LINE_STRING?Tt=kt.map(xe):yt.type===g.MULTI_POLYGON&&(Tt=kt.map(function(Ie){return Ie.map(function(Ne){return xe(Ne)})})),yt.incomingCoords(Tt)})}var Xi={onSetup:function(P){var F=this,K={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initiallySelectedFeatureIds:P.featureIds||[]};return this.setSelected(K.initiallySelectedFeatureIds.filter(function(yt){return F.getFeature(yt)!==void 0})),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),K},fireUpdate:function(){this.map.fire(w.UPDATE,{action:E.MOVE,features:this.getSelected().map(function(P){return P.toGeoJSON()})})},fireActionable:function(){var P=this,F=this.getSelected(),K=F.filter(function(xe){return P.isInstanceOf("MultiFeature",xe)}),yt=!1;if(F.length>1){yt=!0;var Tt=F[0].type.replace("Multi","");F.forEach(function(xe){xe.type.replace("Multi","")!==Tt&&(yt=!1)})}var kt=K.length>0,Rt=F.length>0;this.setActionableState({combineFeatures:yt,uncombineFeatures:kt,trash:Rt})},getUniqueIds:function(P){return P.length?P.map(function(F){return F.properties.id}).filter(function(F){return F!==void 0}).reduce(function(F,K){return F.add(K),F},new Qt).values():[]},stopExtendedInteractions:function(P){P.boxSelectElement&&(P.boxSelectElement.parentNode&&P.boxSelectElement.parentNode.removeChild(P.boxSelectElement),P.boxSelectElement=null),this.map.dragPan.enable(),P.boxSelecting=!1,P.canBoxSelect=!1,P.dragMoving=!1,P.canDragMove=!1},onStop:function(){cr.enable(this)},onMouseMove:function(P,F){return Ti(F)&&P.dragMoving&&this.fireUpdate(),this.stopExtendedInteractions(P),!0},onMouseOut:function(P){return!P.dragMoving||this.fireUpdate()}};Xi.onTap=Xi.onClick=function(P,F){return ce(F)?this.clickAnywhere(P,F):He(O.VERTEX)(F)?this.clickOnVertex(P,F):Ti(F)?this.clickOnFeature(P,F):void 0},Xi.clickAnywhere=function(P){var F=this,K=this.getSelectedIds();K.length&&(this.clearSelectedFeatures(),K.forEach(function(yt){return F.doRender(yt)})),cr.enable(this),this.stopExtendedInteractions(P)},Xi.clickOnVertex=function(P,F){this.changeMode(d.DIRECT_SELECT,{featureId:F.featureTarget.properties.parent,coordPath:F.featureTarget.properties.coord_path,startPos:F.lngLat}),this.updateUIClasses({mouse:h.MOVE})},Xi.startOnActiveFeature=function(P,F){this.stopExtendedInteractions(P),this.map.dragPan.disable(),this.doRender(F.featureTarget.properties.id),P.canDragMove=!0,P.dragMoveLocation=F.lngLat},Xi.clickOnFeature=function(P,F){var K=this;cr.disable(this),this.stopExtendedInteractions(P);var yt=nr(F),Tt=this.getSelectedIds(),kt=F.featureTarget.properties.id,Rt=this.isSelected(kt);if(!yt&&Rt&&this.getFeature(kt).type!==g.POINT)return this.changeMode(d.DIRECT_SELECT,{featureId:kt});Rt&&yt?(this.deselect(kt),this.updateUIClasses({mouse:h.POINTER}),Tt.length===1&&cr.enable(this)):!Rt&&yt?(this.select(kt),this.updateUIClasses({mouse:h.MOVE})):Rt||yt||(Tt.forEach(function(xe){return K.doRender(xe)}),this.setSelected(kt),this.updateUIClasses({mouse:h.MOVE})),this.doRender(kt)},Xi.onMouseDown=function(P,F){return wi(F)?this.startOnActiveFeature(P,F):this.drawConfig.boxSelect&&ci(F)?this.startBoxSelect(P,F):void 0},Xi.startBoxSelect=function(P,F){this.stopExtendedInteractions(P),this.map.dragPan.disable(),P.boxSelectStartLocation=ii(F.originalEvent,this.map.getContainer()),P.canBoxSelect=!0},Xi.onTouchStart=function(P,F){if(wi(F))return this.startOnActiveFeature(P,F)},Xi.onDrag=function(P,F){return P.canDragMove?this.dragMove(P,F):this.drawConfig.boxSelect&&P.canBoxSelect?this.whileBoxSelect(P,F):void 0},Xi.whileBoxSelect=function(P,F){P.boxSelecting=!0,this.updateUIClasses({mouse:h.ADD}),P.boxSelectElement||(P.boxSelectElement=document.createElement("div"),P.boxSelectElement.classList.add(l.BOX_SELECT),this.map.getContainer().appendChild(P.boxSelectElement));var K=ii(F.originalEvent,this.map.getContainer()),yt=Math.min(P.boxSelectStartLocation.x,K.x),Tt=Math.max(P.boxSelectStartLocation.x,K.x),kt=Math.min(P.boxSelectStartLocation.y,K.y),Rt=Math.max(P.boxSelectStartLocation.y,K.y),xe="translate("+yt+"px, "+kt+"px)";P.boxSelectElement.style.transform=xe,P.boxSelectElement.style.WebkitTransform=xe,P.boxSelectElement.style.width=Tt-yt+"px",P.boxSelectElement.style.height=Rt-kt+"px"},Xi.dragMove=function(P,F){P.dragMoving=!0,F.originalEvent.stopPropagation();var K={lng:F.lngLat.lng-P.dragMoveLocation.lng,lat:F.lngLat.lat-P.dragMoveLocation.lat};po(this.getSelected(),K),P.dragMoveLocation=F.lngLat},Xi.onTouchEnd=Xi.onMouseUp=function(P,F){var K=this;if(P.dragMoving)this.fireUpdate();else if(P.boxSelecting){var yt=[P.boxSelectStartLocation,ii(F.originalEvent,this.map.getContainer())],Tt=this.featuresAt(null,yt,"click"),kt=this.getUniqueIds(Tt).filter(function(Rt){return!K.isSelected(Rt)});kt.length&&(this.select(kt),kt.forEach(function(Rt){return K.doRender(Rt)}),this.updateUIClasses({mouse:h.MOVE}))}this.stopExtendedInteractions(P)},Xi.toDisplayFeatures=function(P,F,K){F.properties.active=this.isSelected(F.properties.id)?L.ACTIVE:L.INACTIVE,K(F),this.fireActionable(),F.properties.active===L.ACTIVE&&F.geometry.type!==g.POINT&&Rr(F).forEach(K)},Xi.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()},Xi.onCombineFeatures=function(){var P=this.getSelected();if(!(P.length===0||P.length<2)){for(var F=[],K=[],yt=P[0].type.replace("Multi",""),Tt=0;Tt<P.length;Tt++){var kt=P[Tt];if(kt.type.replace("Multi","")!==yt)return;kt.type.includes("Multi")?kt.getCoordinates().forEach(function(xe){F.push(xe)}):F.push(kt.getCoordinates()),K.push(kt.toGeoJSON())}if(K.length>1){var Rt=this.newFeature({type:g.FEATURE,properties:K[0].properties,geometry:{type:"Multi"+yt,coordinates:F}});this.addFeature(Rt),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([Rt.id]),this.map.fire(w.COMBINE_FEATURES,{createdFeatures:[Rt.toGeoJSON()],deletedFeatures:K})}this.fireActionable()}},Xi.onUncombineFeatures=function(){var P=this,F=this.getSelected();if(F.length!==0){for(var K=[],yt=[],Tt=function(Rt){var xe=F[Rt];P.isInstanceOf("MultiFeature",xe)&&(xe.getFeatures().forEach(function(Ie){P.addFeature(Ie),Ie.properties=xe.properties,K.push(Ie.toGeoJSON()),P.select([Ie.id])}),P.deleteFeature(xe.id,{silent:!0}),yt.push(xe.toGeoJSON()))},kt=0;kt<F.length;kt++)Tt(kt);K.length>1&&this.map.fire(w.UNCOMBINE_FEATURES,{createdFeatures:K,deletedFeatures:yt}),this.fireActionable()}};var tn=He(O.VERTEX),Za=He(O.MIDPOINT),Mr={fireUpdate:function(){this.map.fire(w.UPDATE,{action:E.CHANGE_COORDINATES,features:this.getSelected().map(function(P){return P.toGeoJSON()})})},fireActionable:function(P){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:P.selectedCoordPaths.length>0})},startDragging:function(P,F){this.map.dragPan.disable(),P.canDragMove=!0,P.dragMoveLocation=F.lngLat},stopDragging:function(P){this.map.dragPan.enable(),P.dragMoving=!1,P.canDragMove=!1,P.dragMoveLocation=null},onVertex:function(P,F){this.startDragging(P,F);var K=F.featureTarget.properties,yt=P.selectedCoordPaths.indexOf(K.coord_path);nr(F)||yt!==-1?nr(F)&&yt===-1&&P.selectedCoordPaths.push(K.coord_path):P.selectedCoordPaths=[K.coord_path];var Tt=this.pathsToCoordinates(P.featureId,P.selectedCoordPaths);this.setSelectedCoordinates(Tt)},onMidpoint:function(P,F){this.startDragging(P,F);var K=F.featureTarget.properties;P.feature.addCoordinate(K.coord_path,K.lng,K.lat),this.fireUpdate(),P.selectedCoordPaths=[K.coord_path]},pathsToCoordinates:function(P,F){return F.map(function(K){return{feature_id:P,coord_path:K}})},onFeature:function(P,F){P.selectedCoordPaths.length===0?this.startDragging(P,F):this.stopDragging(P)},dragFeature:function(P,F,K){po(this.getSelected(),K),P.dragMoveLocation=F.lngLat},dragVertex:function(P,F,K){for(var yt=P.selectedCoordPaths.map(function(xe){return P.feature.getCoordinate(xe)}),Tt=fo(yt.map(function(xe){return{type:g.FEATURE,properties:{},geometry:{type:g.POINT,coordinates:xe}}}),K),kt=0;kt<yt.length;kt++){var Rt=yt[kt];P.feature.updateCoordinate(P.selectedCoordPaths[kt],Rt[0]+Tt.lng,Rt[1]+Tt.lat)}},clickNoTarget:function(){this.changeMode(d.SIMPLE_SELECT)},clickInactive:function(){this.changeMode(d.SIMPLE_SELECT)},clickActiveFeature:function(P){P.selectedCoordPaths=[],this.clearSelectedCoordinates(),P.feature.changed()},onSetup:function(P){var F=P.featureId,K=this.getFeature(F);if(!K)throw new Error("You must provide a featureId to enter direct_select mode");if(K.type===g.POINT)throw new TypeError("direct_select mode doesn't handle point features");var yt={featureId:F,feature:K,dragMoveLocation:P.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:P.coordPath?[P.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(F,yt.selectedCoordPaths)),this.setSelected(F),cr.disable(this),this.setActionableState({trash:!0}),yt},onStop:function(){cr.enable(this),this.clearSelectedCoordinates()},toDisplayFeatures:function(P,F,K){P.featureId===F.properties.id?(F.properties.active=L.ACTIVE,K(F),Rr(F,{map:this.map,midpoints:!0,selectedPaths:P.selectedCoordPaths}).forEach(K)):(F.properties.active=L.INACTIVE,K(F)),this.fireActionable(P)},onTrash:function(P){P.selectedCoordPaths.sort(function(F,K){return K.localeCompare(F,"en",{numeric:!0})}).forEach(function(F){return P.feature.removeCoordinate(F)}),this.fireUpdate(),P.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(P),P.feature.isValid()===!1&&(this.deleteFeature([P.featureId]),this.changeMode(d.SIMPLE_SELECT,{}))},onMouseMove:function(P,F){var K=wi(F),yt=tn(F),Tt=Za(F),kt=P.selectedCoordPaths.length===0;return K&&kt||yt&&!kt?this.updateUIClasses({mouse:h.MOVE}):this.updateUIClasses({mouse:h.NONE}),(yt||K||Tt)&&P.dragMoving&&this.fireUpdate(),this.stopDragging(P),!0},onMouseOut:function(P){return P.dragMoving&&this.fireUpdate(),!0}};Mr.onTouchStart=Mr.onMouseDown=function(P,F){return tn(F)?this.onVertex(P,F):wi(F)?this.onFeature(P,F):Za(F)?this.onMidpoint(P,F):void 0},Mr.onDrag=function(P,F){if(P.canDragMove===!0){P.dragMoving=!0,F.originalEvent.stopPropagation();var K={lng:F.lngLat.lng-P.dragMoveLocation.lng,lat:F.lngLat.lat-P.dragMoveLocation.lat};P.selectedCoordPaths.length>0?this.dragVertex(P,F,K):this.dragFeature(P,F,K),P.dragMoveLocation=F.lngLat}},Mr.onClick=function(P,F){return ce(F)?this.clickNoTarget(P,F):wi(F)?this.clickActiveFeature(P,F):vi(F)?this.clickInactive(P,F):void this.stopDragging(P)},Mr.onTap=function(P,F){return ce(F)?this.clickNoTarget(P,F):wi(F)?this.clickActiveFeature(P,F):vi(F)?this.clickInactive(P,F):void 0},Mr.onTouchEnd=Mr.onMouseUp=function(P){P.dragMoving&&this.fireUpdate(),this.stopDragging(P)};var ur={};function Cs(P,F){return!!P.lngLat&&P.lngLat.lng===F[0]&&P.lngLat.lat===F[1]}ur.onSetup=function(){var P=this.newFeature({type:g.FEATURE,properties:{},geometry:{type:g.POINT,coordinates:[]}});return this.addFeature(P),this.clearSelectedFeatures(),this.updateUIClasses({mouse:h.ADD}),this.activateUIButton(m.POINT),this.setActionableState({trash:!0}),{point:P}},ur.stopDrawingAndRemove=function(P){this.deleteFeature([P.point.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT)},ur.onTap=ur.onClick=function(P,F){this.updateUIClasses({mouse:h.MOVE}),P.point.updateCoordinate("",F.lngLat.lng,F.lngLat.lat),this.map.fire(w.CREATE,{features:[P.point.toGeoJSON()]}),this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.point.id]})},ur.onStop=function(P){this.activateUIButton(),P.point.getCoordinate().length||this.deleteFeature([P.point.id],{silent:!0})},ur.toDisplayFeatures=function(P,F,K){var yt=F.properties.id===P.point.id;if(F.properties.active=yt?L.ACTIVE:L.INACTIVE,!yt)return K(F)},ur.onTrash=ur.stopDrawingAndRemove,ur.onKeyUp=function(P,F){if(Yi(F)||Ee(F))return this.stopDrawingAndRemove(P,F)};var Mn={onSetup:function(){var P=this.newFeature({type:g.FEATURE,properties:{},geometry:{type:g.POLYGON,coordinates:[[]]}});return this.addFeature(P),this.clearSelectedFeatures(),cr.disable(this),this.updateUIClasses({mouse:h.ADD}),this.activateUIButton(m.POLYGON),this.setActionableState({trash:!0}),{polygon:P,currentVertexPosition:0}},clickAnywhere:function(P,F){if(P.currentVertexPosition>0&&Cs(F,P.polygon.coordinates[0][P.currentVertexPosition-1]))return this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.polygon.id]});this.updateUIClasses({mouse:h.ADD}),P.polygon.updateCoordinate("0."+P.currentVertexPosition,F.lngLat.lng,F.lngLat.lat),P.currentVertexPosition++,P.polygon.updateCoordinate("0."+P.currentVertexPosition,F.lngLat.lng,F.lngLat.lat)},clickOnVertex:function(P){return this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.polygon.id]})},onMouseMove:function(P,F){P.polygon.updateCoordinate("0."+P.currentVertexPosition,F.lngLat.lng,F.lngLat.lat),zi(F)&&this.updateUIClasses({mouse:h.POINTER})}};Mn.onTap=Mn.onClick=function(P,F){return zi(F)?this.clickOnVertex(P,F):this.clickAnywhere(P,F)},Mn.onKeyUp=function(P,F){Yi(F)?(this.deleteFeature([P.polygon.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT)):Ee(F)&&this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.polygon.id]})},Mn.onStop=function(P){this.updateUIClasses({mouse:h.NONE}),cr.enable(this),this.activateUIButton(),this.getFeature(P.polygon.id)!==void 0&&(P.polygon.removeCoordinate("0."+P.currentVertexPosition),P.polygon.isValid()?this.map.fire(w.CREATE,{features:[P.polygon.toGeoJSON()]}):(this.deleteFeature([P.polygon.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT,{},{silent:!0})))},Mn.toDisplayFeatures=function(P,F,K){var yt=F.properties.id===P.polygon.id;if(F.properties.active=yt?L.ACTIVE:L.INACTIVE,!yt)return K(F);if(F.geometry.coordinates.length!==0){var Tt=F.geometry.coordinates[0].length;if(!(Tt<3)){if(F.properties.meta=O.FEATURE,K(Oi(P.polygon.id,F.geometry.coordinates[0][0],"0.0",!1)),Tt>3){var kt=F.geometry.coordinates[0].length-3;K(Oi(P.polygon.id,F.geometry.coordinates[0][kt],"0."+kt,!1))}if(Tt<=4){var Rt=[[F.geometry.coordinates[0][0][0],F.geometry.coordinates[0][0][1]],[F.geometry.coordinates[0][1][0],F.geometry.coordinates[0][1][1]]];if(K({type:g.FEATURE,properties:F.properties,geometry:{coordinates:Rt,type:g.LINE_STRING}}),Tt===3)return}return K(F)}}},Mn.onTrash=function(P){this.deleteFeature([P.polygon.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT)};var sr={onSetup:function(P){var F,K,yt=(P=P||{}).featureId,Tt="forward";if(yt){if(!(F=this.getFeature(yt)))throw new Error("Could not find a feature with the provided featureId");var kt=P.from;if(kt&&kt.type==="Feature"&&kt.geometry&&kt.geometry.type==="Point"&&(kt=kt.geometry),kt&&kt.type==="Point"&&kt.coordinates&&kt.coordinates.length===2&&(kt=kt.coordinates),!kt||!Array.isArray(kt))throw new Error("Please use the `from` property to indicate which point to continue the line from");var Rt=F.coordinates.length-1;if(F.coordinates[Rt][0]===kt[0]&&F.coordinates[Rt][1]===kt[1])K=Rt+1,F.addCoordinate.apply(F,[K].concat(F.coordinates[Rt]));else{if(F.coordinates[0][0]!==kt[0]||F.coordinates[0][1]!==kt[1])throw new Error("`from` should match the point at either the start or the end of the provided LineString");Tt="backwards",K=0,F.addCoordinate.apply(F,[K].concat(F.coordinates[0]))}}else F=this.newFeature({type:g.FEATURE,properties:{},geometry:{type:g.LINE_STRING,coordinates:[]}}),K=0,this.addFeature(F);return this.clearSelectedFeatures(),cr.disable(this),this.updateUIClasses({mouse:h.ADD}),this.activateUIButton(m.LINE),this.setActionableState({trash:!0}),{line:F,currentVertexPosition:K,direction:Tt}},clickAnywhere:function(P,F){if(P.currentVertexPosition>0&&Cs(F,P.line.coordinates[P.currentVertexPosition-1])||P.direction==="backwards"&&Cs(F,P.line.coordinates[P.currentVertexPosition+1]))return this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.line.id]});this.updateUIClasses({mouse:h.ADD}),P.line.updateCoordinate(P.currentVertexPosition,F.lngLat.lng,F.lngLat.lat),P.direction==="forward"?(P.currentVertexPosition++,P.line.updateCoordinate(P.currentVertexPosition,F.lngLat.lng,F.lngLat.lat)):P.line.addCoordinate(0,F.lngLat.lng,F.lngLat.lat)},clickOnVertex:function(P){return this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.line.id]})},onMouseMove:function(P,F){P.line.updateCoordinate(P.currentVertexPosition,F.lngLat.lng,F.lngLat.lat),zi(F)&&this.updateUIClasses({mouse:h.POINTER})}};sr.onTap=sr.onClick=function(P,F){if(zi(F))return this.clickOnVertex(P,F);this.clickAnywhere(P,F)},sr.onKeyUp=function(P,F){Ee(F)?this.changeMode(d.SIMPLE_SELECT,{featureIds:[P.line.id]}):Yi(F)&&(this.deleteFeature([P.line.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT))},sr.onStop=function(P){cr.enable(this),this.activateUIButton(),this.getFeature(P.line.id)!==void 0&&(P.line.removeCoordinate(""+P.currentVertexPosition),P.line.isValid()?this.map.fire(w.CREATE,{features:[P.line.toGeoJSON()]}):(this.deleteFeature([P.line.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT,{},{silent:!0})))},sr.onTrash=function(P){this.deleteFeature([P.line.id],{silent:!0}),this.changeMode(d.SIMPLE_SELECT)},sr.toDisplayFeatures=function(P,F,K){var yt=F.properties.id===P.line.id;if(F.properties.active=yt?L.ACTIVE:L.INACTIVE,!yt)return K(F);F.geometry.coordinates.length<2||(F.properties.meta=O.FEATURE,K(Oi(P.line.id,F.geometry.coordinates[P.direction==="forward"?F.geometry.coordinates.length-2:1],""+(P.direction==="forward"?F.geometry.coordinates.length-2:1),!1)),K(F))};var jn={simple_select:Xi,direct_select:Mr,draw_point:ur,draw_polygon:Mn,draw_line_string:sr},Ss={defaultMode:d.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:ve,modes:jn,controls:{},userProperties:!1},Er={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},jo={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function fn(P,F){return P.map(function(K){return K.source?K:Fe(K,{id:K.id+"."+F,source:F==="hot"?c.HOT:c.COLD})})}var Ts={exports:{}};(function(P,F){var K="__lodash_hash_undefined__",yt=9007199254740991,Tt="[object Arguments]",kt="[object Array]",Rt="[object Boolean]",xe="[object Date]",Ie="[object Error]",Ne="[object Function]",je="[object Map]",De="[object Number]",pi="[object Object]",er="[object Promise]",di="[object RegExp]",Ni="[object Set]",ge="[object String]",ri="[object Symbol]",qi="[object WeakMap]",zr="[object ArrayBuffer]",or="[object DataView]",Vo=/^\[object .+?Constructor\]$/,El=/^(?:0|[1-9]\d*)$/,dr={};dr["[object Float32Array]"]=dr["[object Float64Array]"]=dr["[object Int8Array]"]=dr["[object Int16Array]"]=dr["[object Int32Array]"]=dr["[object Uint8Array]"]=dr["[object Uint8ClampedArray]"]=dr["[object Uint16Array]"]=dr["[object Uint32Array]"]=!0,dr[Tt]=dr[kt]=dr[zr]=dr[Rt]=dr[or]=dr[xe]=dr[Ie]=dr[Ne]=dr[je]=dr[De]=dr[pi]=dr[di]=dr[Ni]=dr[ge]=dr[qi]=!1;var ya=typeof bl=="object"&&bl&&bl.Object===Object&&bl,Ka=typeof self=="object"&&self&&self.Object===Object&&self,Yn=ya||Ka||Function("return this")(),go=F&&!F.nodeType&&F,Uo=go&&P&&!P.nodeType&&P,_o=Uo&&Uo.exports===go,yo=_o&&ya.process,Go=function(){try{return yo&&yo.binding&&yo.binding("util")}catch{}}(),kn=Go&&Go.isTypedArray;function va(Bt,Ht){for(var Le=-1,hi=Bt==null?0:Bt.length;++Le<hi;)if(Ht(Bt[Le],Le,Bt))return!0;return!1}function js(Bt){var Ht=-1,Le=Array(Bt.size);return Bt.forEach(function(hi,ar){Le[++Ht]=[ar,hi]}),Le}function Li(Bt){var Ht=-1,Le=Array(Bt.size);return Bt.forEach(function(hi){Le[++Ht]=hi}),Le}var Ns,Ja,vo,Pl=Array.prototype,Vs=Function.prototype,Xo=Object.prototype,Wo=Yn["__core-js_shared__"],Qa=Vs.toString,On=Xo.hasOwnProperty,Ho=(Ns=/[^.]+$/.exec(Wo&&Wo.keys&&Wo.keys.IE_PROTO||""))?"Symbol(src)_1."+Ns:"",xa=Xo.toString,tl=RegExp("^"+Qa.call(On).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),ba=_o?Yn.Buffer:void 0,xo=Yn.Symbol,us=Yn.Uint8Array,wa=Xo.propertyIsEnumerable,Il=Pl.splice,Ps=xo?xo.toStringTag:void 0,Ca=Object.getOwnPropertySymbols,bo=ba?ba.isBuffer:void 0,Al=(Ja=Object.keys,vo=Object,function(Bt){return Ja(vo(Bt))}),Us=pn(Yn,"DataView"),wo=pn(Yn,"Map"),Sa=pn(Yn,"Promise"),qo=pn(Yn,"Set"),$o=pn(Yn,"WeakMap"),Gs=pn(Object,"create"),Ta=Nn(Us),el=Nn(wo),Yo=Nn(Sa),Zn=Nn(qo),Co=Nn($o),Zo=xo?xo.prototype:void 0,So=Zo?Zo.valueOf:void 0;function ds(Bt){var Ht=-1,Le=Bt==null?0:Bt.length;for(this.clear();++Ht<Le;){var hi=Bt[Ht];this.set(hi[0],hi[1])}}function Dn(Bt){var Ht=-1,Le=Bt==null?0:Bt.length;for(this.clear();++Ht<Le;){var hi=Bt[Ht];this.set(hi[0],hi[1])}}function ji(Bt){var Ht=-1,Le=Bt==null?0:Bt.length;for(this.clear();++Ht<Le;){var hi=Bt[Ht];this.set(hi[0],hi[1])}}function Xs(Bt){var Ht=-1,Le=Bt==null?0:Bt.length;for(this.__data__=new ji;++Ht<Le;)this.add(Bt[Ht])}function Si(Bt){var Ht=this.__data__=new Dn(Bt);this.size=Ht.size}function Ea(Bt,Ht){var Le=Ms(Bt),hi=!Le&&As(Bt),ar=!Le&&!hi&&qs(Bt),Pi=!Le&&!hi&&!ar&&fs(Bt),fr=Le||hi||ar||Pi,br=fr?function(wr,en){for(var Zr=-1,Vr=Array(wr);++Zr<wr;)Vr[Zr]=en(Zr);return Vr}(Bt.length,String):[],mn=br.length;for(var Pr in Bt)!On.call(Bt,Pr)||fr&&(Pr=="length"||ar&&(Pr=="offset"||Pr=="parent")||Pi&&(Pr=="buffer"||Pr=="byteLength"||Pr=="byteOffset")||Aa(Pr,mn))||br.push(Pr);return br}function Qi(Bt,Ht){for(var Le=Bt.length;Le--;)if(Jo(Bt[Le][0],Ht))return Le;return-1}function $i(Bt){return Bt==null?Bt===void 0?"[object Undefined]":"[object Null]":Ps&&Ps in Object(Bt)?function(Ht){var Le=On.call(Ht,Ps),hi=Ht[Ps];try{Ht[Ps]=void 0;var ar=!0}catch{}var Pi=xa.call(Ht);return ar&&(Le?Ht[Ps]=hi:delete Ht[Ps]),Pi}(Bt):function(Ht){return xa.call(Ht)}(Bt)}function Ws(Bt){return Vn(Bt)&&$i(Bt)==Tt}function Pa(Bt,Ht,Le,hi,ar){return Bt===Ht||(Bt==null||Ht==null||!Vn(Bt)&&!Vn(Ht)?Bt!=Bt&&Ht!=Ht:function(Pi,fr,br,mn,Pr,wr){var en=Ms(Pi),Zr=Ms(fr),Vr=en?kt:kr(Pi),Ln=Zr?kt:kr(fr),ks=(Vr=Vr==Tt?pi:Vr)==pi,Os=(Ln=Ln==Tt?pi:Ln)==pi,Kn=Vr==Ln;if(Kn&&qs(Pi)){if(!qs(fr))return!1;en=!0,ks=!1}if(Kn&&!ks)return wr||(wr=new Si),en||fs(Pi)?To(Pi,fr,br,mn,Pr,wr):function(Ki,Vi,Ys,gn,Mo,Ur,zn){switch(Ys){case or:if(Ki.byteLength!=Vi.byteLength||Ki.byteOffset!=Vi.byteOffset)return!1;Ki=Ki.buffer,Vi=Vi.buffer;case zr:return!(Ki.byteLength!=Vi.byteLength||!Ur(new us(Ki),new us(Vi)));case Rt:case xe:case De:return Jo(+Ki,+Vi);case Ie:return Ki.name==Vi.name&&Ki.message==Vi.message;case di:case ge:return Ki==Vi+"";case je:var Gn=js;case Ni:var Zs=1&gn;if(Gn||(Gn=Li),Ki.size!=Vi.size&&!Zs)return!1;var Ji=zn.get(Ki);if(Ji)return Ji==Vi;gn|=2,zn.set(Ki,Vi);var wn=To(Gn(Ki),Gn(Vi),gn,Mo,Ur,zn);return zn.delete(Ki),wn;case ri:if(So)return So.call(Ki)==So.call(Vi)}return!1}(Pi,fr,Vr,br,mn,Pr,wr);if(!(1&br)){var Un=ks&&On.call(Pi,"__wrapped__"),Io=Os&&On.call(fr,"__wrapped__");if(Un||Io){var Kr=Un?Pi.value():Pi,Ao=Io?fr.value():fr;return wr||(wr=new Si),Pr(Kr,Ao,br,mn,wr)}}return Kn?(wr||(wr=new Si),function(Ki,Vi,Ys,gn,Mo,Ur){var zn=1&Ys,Gn=Eo(Ki),Zs=Gn.length,Ji=Eo(Vi).length;if(Zs!=Ji&&!zn)return!1;for(var wn=Zs;wn--;){var Or=Gn[wn];if(!(zn?Or in Vi:On.call(Vi,Or)))return!1}var ko=Ur.get(Ki);if(ko&&Ur.get(Vi))return ko==Vi;var ps=!0;Ur.set(Ki,Vi),Ur.set(Vi,Ki);for(var Oo=zn;++wn<Zs;){var Xn=Ki[Or=Gn[wn]],ms=Vi[Or];if(gn)var Ks=zn?gn(ms,Xn,Or,Vi,Ki,Ur):gn(Xn,ms,Or,Ki,Vi,Ur);if(!(Ks===void 0?Xn===ms||Mo(Xn,ms,Ys,gn,Ur):Ks)){ps=!1;break}Oo||(Oo=Or=="constructor")}if(ps&&!Oo){var gs=Ki.constructor,Js=Vi.constructor;gs==Js||!("constructor"in Ki)||!("constructor"in Vi)||typeof gs=="function"&&gs instanceof gs&&typeof Js=="function"&&Js instanceof Js||(ps=!1)}return Ur.delete(Ki),Ur.delete(Vi),ps}(Pi,fr,br,mn,Pr,wr)):!1}(Bt,Ht,Le,hi,Pa,ar))}function Ia(Bt){return!(!Ma(Bt)||function(Ht){return!!Ho&&Ho in Ht}(Bt))&&($s(Bt)?tl:Vo).test(Nn(Bt))}function Ko(Bt){if(Le=(Ht=Bt)&&Ht.constructor,hi=typeof Le=="function"&&Le.prototype||Xo,Ht!==hi)return Al(Bt);var Ht,Le,hi,ar=[];for(var Pi in Object(Bt))On.call(Bt,Pi)&&Pi!="constructor"&&ar.push(Pi);return ar}function To(Bt,Ht,Le,hi,ar,Pi){var fr=1&Le,br=Bt.length,mn=Ht.length;if(br!=mn&&!(fr&&mn>br))return!1;var Pr=Pi.get(Bt);if(Pr&&Pi.get(Ht))return Pr==Ht;var wr=-1,en=!0,Zr=2&Le?new Xs:void 0;for(Pi.set(Bt,Ht),Pi.set(Ht,Bt);++wr<br;){var Vr=Bt[wr],Ln=Ht[wr];if(hi)var ks=fr?hi(Ln,Vr,wr,Ht,Bt,Pi):hi(Vr,Ln,wr,Bt,Ht,Pi);if(ks!==void 0){if(ks)continue;en=!1;break}if(Zr){if(!va(Ht,function(Os,Kn){if(Un=Kn,!Zr.has(Un)&&(Vr===Os||ar(Vr,Os,Le,hi,Pi)))return Zr.push(Kn);var Un})){en=!1;break}}else if(Vr!==Ln&&!ar(Vr,Ln,Le,hi,Pi)){en=!1;break}}return Pi.delete(Bt),Pi.delete(Ht),en}function Eo(Bt){return function(Ht,Le,hi){var ar=Le(Ht);return Ms(Ht)?ar:function(Pi,fr){for(var br=-1,mn=fr.length,Pr=Pi.length;++br<mn;)Pi[Pr+br]=fr[br];return Pi}(ar,hi(Ht))}(Bt,ka,Is)}function Hs(Bt,Ht){var Le,hi,ar=Bt.__data__;return((hi=typeof(Le=Ht))=="string"||hi=="number"||hi=="symbol"||hi=="boolean"?Le!=="__proto__":Le===null)?ar[typeof Ht=="string"?"string":"hash"]:ar.map}function pn(Bt,Ht){var Le=function(hi,ar){return hi==null?void 0:hi[ar]}(Bt,Ht);return Ia(Le)?Le:void 0}ds.prototype.clear=function(){this.__data__=Gs?Gs(null):{},this.size=0},ds.prototype.delete=function(Bt){var Ht=this.has(Bt)&&delete this.__data__[Bt];return this.size-=Ht?1:0,Ht},ds.prototype.get=function(Bt){var Ht=this.__data__;if(Gs){var Le=Ht[Bt];return Le===K?void 0:Le}return On.call(Ht,Bt)?Ht[Bt]:void 0},ds.prototype.has=function(Bt){var Ht=this.__data__;return Gs?Ht[Bt]!==void 0:On.call(Ht,Bt)},ds.prototype.set=function(Bt,Ht){var Le=this.__data__;return this.size+=this.has(Bt)?0:1,Le[Bt]=Gs&&Ht===void 0?K:Ht,this},Dn.prototype.clear=function(){this.__data__=[],this.size=0},Dn.prototype.delete=function(Bt){var Ht=this.__data__,Le=Qi(Ht,Bt);return!(Le<0)&&(Le==Ht.length-1?Ht.pop():Il.call(Ht,Le,1),--this.size,!0)},Dn.prototype.get=function(Bt){var Ht=this.__data__,Le=Qi(Ht,Bt);return Le<0?void 0:Ht[Le][1]},Dn.prototype.has=function(Bt){return Qi(this.__data__,Bt)>-1},Dn.prototype.set=function(Bt,Ht){var Le=this.__data__,hi=Qi(Le,Bt);return hi<0?(++this.size,Le.push([Bt,Ht])):Le[hi][1]=Ht,this},ji.prototype.clear=function(){this.size=0,this.__data__={hash:new ds,map:new(wo||Dn),string:new ds}},ji.prototype.delete=function(Bt){var Ht=Hs(this,Bt).delete(Bt);return this.size-=Ht?1:0,Ht},ji.prototype.get=function(Bt){return Hs(this,Bt).get(Bt)},ji.prototype.has=function(Bt){return Hs(this,Bt).has(Bt)},ji.prototype.set=function(Bt,Ht){var Le=Hs(this,Bt),hi=Le.size;return Le.set(Bt,Ht),this.size+=Le.size==hi?0:1,this},Xs.prototype.add=Xs.prototype.push=function(Bt){return this.__data__.set(Bt,K),this},Xs.prototype.has=function(Bt){return this.__data__.has(Bt)},Si.prototype.clear=function(){this.__data__=new Dn,this.size=0},Si.prototype.delete=function(Bt){var Ht=this.__data__,Le=Ht.delete(Bt);return this.size=Ht.size,Le},Si.prototype.get=function(Bt){return this.__data__.get(Bt)},Si.prototype.has=function(Bt){return this.__data__.has(Bt)},Si.prototype.set=function(Bt,Ht){var Le=this.__data__;if(Le instanceof Dn){var hi=Le.__data__;if(!wo||hi.length<199)return hi.push([Bt,Ht]),this.size=++Le.size,this;Le=this.__data__=new ji(hi)}return Le.set(Bt,Ht),this.size=Le.size,this};var Is=Ca?function(Bt){return Bt==null?[]:(Bt=Object(Bt),function(Ht,Le){for(var hi=-1,ar=Ht==null?0:Ht.length,Pi=0,fr=[];++hi<ar;){var br=Ht[hi];Le(br,hi,Ht)&&(fr[Pi++]=br)}return fr}(Ca(Bt),function(Ht){return wa.call(Bt,Ht)}))}:function(){return[]},kr=$i;function Aa(Bt,Ht){return!!(Ht=Ht??yt)&&(typeof Bt=="number"||El.test(Bt))&&Bt>-1&&Bt%1==0&&Bt<Ht}function Nn(Bt){if(Bt!=null){try{return Qa.call(Bt)}catch{}try{return Bt+""}catch{}}return""}function Jo(Bt,Ht){return Bt===Ht||Bt!=Bt&&Ht!=Ht}(Us&&kr(new Us(new ArrayBuffer(1)))!=or||wo&&kr(new wo)!=je||Sa&&kr(Sa.resolve())!=er||qo&&kr(new qo)!=Ni||$o&&kr(new $o)!=qi)&&(kr=function(Bt){var Ht=$i(Bt),Le=Ht==pi?Bt.constructor:void 0,hi=Le?Nn(Le):"";if(hi)switch(hi){case Ta:return or;case el:return je;case Yo:return er;case Zn:return Ni;case Co:return qi}return Ht});var As=Ws(function(){return arguments}())?Ws:function(Bt){return Vn(Bt)&&On.call(Bt,"callee")&&!wa.call(Bt,"callee")},Ms=Array.isArray,qs=bo||function(){return!1};function $s(Bt){if(!Ma(Bt))return!1;var Ht=$i(Bt);return Ht==Ne||Ht=="[object GeneratorFunction]"||Ht=="[object AsyncFunction]"||Ht=="[object Proxy]"}function Po(Bt){return typeof Bt=="number"&&Bt>-1&&Bt%1==0&&Bt<=yt}function Ma(Bt){var Ht=typeof Bt;return Bt!=null&&(Ht=="object"||Ht=="function")}function Vn(Bt){return Bt!=null&&typeof Bt=="object"}var fs=kn?function(Bt){return function(Ht){return Bt(Ht)}}(kn):function(Bt){return Vn(Bt)&&Po(Bt.length)&&!!dr[$i(Bt)]};function ka(Bt){return(Ht=Bt)!=null&&Po(Ht.length)&&!$s(Ht)?Ea(Bt):Ko(Bt);var Ht}P.exports=function(Bt,Ht){return Pa(Bt,Ht)}})(Ts,Ts.exports);var $n=ft(Ts.exports);function No(P,F){return P.length===F.length&&JSON.stringify(P.map(function(K){return K}).sort())===JSON.stringify(F.map(function(K){return K}).sort())}var mo={Polygon:Mt,LineString:rt,Point:pt,MultiPolygon:Wt,MultiLineString:Wt,MultiPoint:Wt},hs=Object.freeze({__proto__:null,CommonSelectors:ui,constrainFeatureMovement:fo,createMidPoint:Wi,createSupplementaryPoints:Rr,createVertex:Oi,doubleClickZoom:cr,euclideanDistance:se,featuresAt:ne,getFeatureAtAndSetCursors:Oe,isClick:be,isEventAtCoordinates:Cs,isTap:Q,mapEventToBoundingBox:Jt,ModeHandler:st,moveFeatures:po,sortFeatures:Kt,stringSetsAreEqual:No,StringSet:Qt,theme:ve,toDenseArray:Lt}),Bi=function(P,F){var K={options:P=function(Tt){Tt===void 0&&(Tt={});var kt=Fe(Tt);return Tt.controls||(kt.controls={}),Tt.displayControlsDefault===!1?kt.controls=Fe(jo,Tt.controls):kt.controls=Fe(Er,Tt.controls),(kt=Fe(Ss,kt)).styles=fn(kt.styles,"cold").concat(fn(kt.styles,"hot")),kt}(P)};F=function(Tt,kt){return kt.modes=d,kt.getFeatureIdsAt=function(Rt){return ne.click({point:Rt},null,Tt).map(function(xe){return xe.properties.id})},kt.getSelectedIds=function(){return Tt.store.getSelectedIds()},kt.getSelected=function(){return{type:g.FEATURE_COLLECTION,features:Tt.store.getSelectedIds().map(function(Rt){return Tt.store.get(Rt)}).map(function(Rt){return Rt.toGeoJSON()})}},kt.getSelectedPoints=function(){return{type:g.FEATURE_COLLECTION,features:Tt.store.getSelectedCoordinates().map(function(Rt){return{type:g.FEATURE,properties:{},geometry:{type:g.POINT,coordinates:Rt.coordinates}}})}},kt.set=function(Rt){if(Rt.type===void 0||Rt.type!==g.FEATURE_COLLECTION||!Array.isArray(Rt.features))throw new Error("Invalid FeatureCollection");var xe=Tt.store.createRenderBatch(),Ie=Tt.store.getAllIds().slice(),Ne=kt.add(Rt),je=new Qt(Ne);return(Ie=Ie.filter(function(De){return!je.has(De)})).length&&kt.delete(Ie),xe(),Ne},kt.add=function(Rt){var xe=JSON.parse(JSON.stringify(et(Rt))).features.map(function(Ie){if(Ie.id=Ie.id||vt(),Ie.geometry===null)throw new Error("Invalid geometry: null");if(Tt.store.get(Ie.id)===void 0||Tt.store.get(Ie.id).type!==Ie.geometry.type){var Ne=mo[Ie.geometry.type];if(Ne===void 0)throw new Error("Invalid geometry type: "+Ie.geometry.type+".");var je=new Ne(Tt,Ie);Tt.store.add(je)}else{var De=Tt.store.get(Ie.id);De.properties=Ie.properties,$n(De.properties,Ie.properties)||Tt.store.featureChanged(De.id),$n(De.getCoordinates(),Ie.geometry.coordinates)||De.incomingCoords(Ie.geometry.coordinates)}return Ie.id});return Tt.store.render(),xe},kt.get=function(Rt){var xe=Tt.store.get(Rt);if(xe)return xe.toGeoJSON()},kt.getAll=function(){return{type:g.FEATURE_COLLECTION,features:Tt.store.getAll().map(function(Rt){return Rt.toGeoJSON()})}},kt.delete=function(Rt){return Tt.store.delete(Rt,{silent:!0}),kt.getMode()!==d.DIRECT_SELECT||Tt.store.getSelectedIds().length?Tt.store.render():Tt.events.changeMode(d.SIMPLE_SELECT,void 0,{silent:!0}),kt},kt.deleteAll=function(){return Tt.store.delete(Tt.store.getAllIds(),{silent:!0}),kt.getMode()===d.DIRECT_SELECT?Tt.events.changeMode(d.SIMPLE_SELECT,void 0,{silent:!0}):Tt.store.render(),kt},kt.changeMode=function(Rt,xe){return xe===void 0&&(xe={}),Rt===d.SIMPLE_SELECT&&kt.getMode()===d.SIMPLE_SELECT?(No(xe.featureIds||[],Tt.store.getSelectedIds())||(Tt.store.setSelected(xe.featureIds,{silent:!0}),Tt.store.render()),kt):(Rt===d.DIRECT_SELECT&&kt.getMode()===d.DIRECT_SELECT&&xe.featureId===Tt.store.getSelectedIds()[0]||Tt.events.changeMode(Rt,xe,{silent:!0}),kt)},kt.getMode=function(){return Tt.events.getMode()},kt.trash=function(){return Tt.events.trash({silent:!0}),kt},kt.combineFeatures=function(){return Tt.events.combineFeatures({silent:!0}),kt},kt.uncombineFeatures=function(){return Tt.events.uncombineFeatures({silent:!0}),kt},kt.setFeatureProperty=function(Rt,xe,Ie){return Tt.store.setFeatureProperty(Rt,xe,Ie),kt},kt}(K,F),K.api=F;var yt=oe(K);return F.onAdd=yt.onAdd,F.onRemove=yt.onRemove,F.types=m,F.options=P,F};function Es(P){Bi(P,this)}return Es.modes=jn,Es.constants=nt,Es.lib=hs,Es})})(df);var Em=df.exports;const Kh=lf(Em),pc="rgb(127, 127, 127)",Pm=[{id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","true"]],paint:{"fill-color":["case",["==",["get","user_color_rgb_str"],null],pc,["get","user_color_rgb_str"]],"fill-outline-color":"rgb(0, 0, 0)","fill-opacity":.5}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","$type","Polygon"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(178, 204, 255)","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-halo-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-polygon-and-line-vertex-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"]],paint:{"circle-radius":3,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","$type","LineString"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-width":3}},{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","false"]],paint:{"fill-color":["case",["==",["get","user_color_rgb_str"],null],pc,["get","user_color_rgb_str"]],"fill-outline-color":"rgb(0, 0, 0)","fill-opacity":.25}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","$type","Polygon"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-width":3}}];function Im(Z,S){return Z.lngLat?Z.lngLat.lng===S[0]&&Z.lngLat.lat===S[1]:!1}const eu=Kh.modes.draw_polygon;eu.maxVertices=4;eu.clickAnywhere=function(Z,S){if(Z.currentVertexPosition>0&&Im(S,Z.polygon.coordinates[0][Z.currentVertexPosition-1]))return this.changeMode("simple_select",{featureIds:[Z.polygon.id]});if(this.updateUIClasses({mouse:"add"}),Z.polygon.updateCoordinate(`0.${Z.currentVertexPosition}`,S.lngLat.lng,S.lngLat.lat),Z.currentVertexPosition++,Z.polygon.updateCoordinate(`0.${Z.currentVertexPosition}`,S.lngLat.lng,S.lngLat.lat),Z.currentVertexPosition>this.maxVertices-1)return this.updateUIClasses({mouse:"none"}),this.changeMode("simple_select",{featuresId:Z.polygon.id})};var Am={exports:{}};(function(Z){(function(S){S.version="0.5.0",S.defaults={doThrows:{invalidGeometry:!1}};function st(){var g=1<=arguments.length?[].slice.call(arguments,0):[],d=g.shift(),w=g.shift();Error.apply(this,g),this.message=this.message||"Invalid Geometry: item: "+JSON.stringify(d)+", params: "+JSON.stringify(w)}st.prototype=Error,S.errors={InvalidGeometryError:st},S.isGeometryValid=function(g){return!g||!Object.keys(g).length?!1:!!g.type&&!!g.coordinates&&Array.isArray(g.coordinates)&&!!g.coordinates.length},S.parse=function(g,d,w){var E,O=It(d,this.defaults),L;if(lt.length=0,p(O),L=h(O),Array.isArray(g)?(E={type:"FeatureCollection",features:[]},g.forEach(function(U){E.features.push(b({item:U,params:O,propFunc:L}))}),N(E,O)):(E=b({item:g,params:O,propFunc:L}),N(E,O)),w&&typeof w=="function")w(E);else return E};var ft=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","GeoJSON"],lt=[];function It(g,d){var w=g||{};for(var E in d)d.hasOwnProperty(E)&&!w[E]&&(w[E]=d[E]);return w}function N(g,d){if(d.crs&&s(d.crs)&&(d.isPostgres?g.geometry.crs=d.crs:g.crs=d.crs),d.bbox&&(g.bbox=d.bbox),d.extraGlobal){g.properties={};for(var w in d.extraGlobal)g.properties[w]=d.extraGlobal[w]}}function s(g){if(g.type==="name"){if(g.properties&&g.properties.name)return!0;throw new Error('Invalid CRS. Properties must contain "name" key')}else if(g.type==="link"){if(g.properties&&g.properties.href&&g.properties.type)return!0;throw new Error('Invalid CRS. Properties must contain "href" and "type" key')}else throw new Error('Invald CRS. Type attribute must be "name" or "link"')}function p(g){g.geom={};for(var d in g)g.hasOwnProperty(d)&&ft.indexOf(d)!==-1&&(g.geom[d]=g[d],delete g[d]);C(g.geom)}function C(g){for(var d in g)g.hasOwnProperty(d)&&(typeof g[d]=="string"?lt.push(g[d]):typeof g[d]=="object"&&(lt.push(g[d][0]),lt.push(g[d][1])));if(lt.length===0)throw new Error("No geometry attributes specified")}function b(g){var d=g.item,w=g.params,E=g.propFunc,O={type:"Feature"};return O.geometry=c(d,w),O.properties=E.call(d),O}function l(g){return/^.+\..+$/.test(g)}function c(g,d){var w={};for(var E in d.geom){var O=d.geom[E];if(typeof O=="string"&&g.hasOwnProperty(O))E==="GeoJSON"?w=g[O]:(w.type=E,w.coordinates=g[O]);else if(typeof O=="object"&&!Array.isArray(O)){var L=Object.keys(O).map(function(Kt){var Jt=O[Kt],Qt=g[Kt];return c(Qt,{geom:{Point:Jt}})});w.type=E,w.coordinates=[].concat(L.map(function(Kt){return Kt.coordinates}))}else if(Array.isArray(O)&&g.hasOwnProperty(O[0])&&g.hasOwnProperty(O[1]))w.type=E,w.coordinates=[Number(g[O[1]]),Number(g[O[0]])];else if(Array.isArray(O)&&l(O[0])&&l(O[1])){for(var U=[],$=0;$<O.length;$++){for(var nt=O[$].split("."),xt=g,Ft=0;Ft<nt.length;Ft++){if(!xt.hasOwnProperty(nt[Ft]))return!1;xt=xt[nt[Ft]]}U[$]=xt}w.type=E,w.coordinates=[Number(U[1]),Number(U[0])]}}if(d.doThrows&&d.doThrows.invalidGeometry&&!S.isGeometryValid(w))throw new st(g,d);return w}function h(g){var d;return!g.exclude&&!g.include?d=function(w){for(var E in this)this.hasOwnProperty(E)&&lt.indexOf(E)===-1&&(w[E]=this[E])}:g.include?d=function(w){g.include.forEach(function(E){w[E]=this[E]},this)}:g.exclude&&(d=function(w){for(var E in this)this.hasOwnProperty(E)&&lt.indexOf(E)===-1&&g.exclude.indexOf(E)===-1&&(w[E]=this[E])}),function(){var w={};return d.call(this,w),g.extra&&m(w,g.extra),w}}function m(g,d){for(var w in d)d.hasOwnProperty(w)&&(g[w]=d[w]);return g}})(Z.exports)})(Am);const ff={name:"delete_zone",onSetup:function(){return{}},onClick:function(Z,S){var st;if(S.featureTarget){const ft=S.featureTarget,lt=(st=ft==null?void 0:ft.properties)==null?void 0:st.id;if(!lt)return;this.deleteFeature(lt),this.changeMode("simple_select")}},toDisplayFeatures:function(Z,S,st){st(S)}},Jh=Bn(),iu=Bn(new Kh({userProperties:!0,displayControlsDefault:!1,controls:{polygon:!1,trash:!1},modes:Object.assign({draw_restricted_polygon:eu,delete_zone:ff},Kh.modes),styles:Pm}));var Gi=(Z=>(Z[Z.AddingZoneCanvas=1]="AddingZoneCanvas",Z[Z.AddingZoneMap=2]="AddingZoneMap",Z[Z.Waiting=3]="Waiting",Z[Z.EditingZone=4]="EditingZone",Z[Z.DeletingZoneCanvas=5]="DeletingZoneCanvas",Z[Z.DeletingZoneMap=6]="DeletingZoneMap",Z[Z.PickPolygon=7]="PickPolygon",Z))(Gi||{}),Qc=(Z=>(Z.Init="init",Z.ReInit="re-init",Z))(Qc||{});const th=Bn(),Yr=Bn(Gi.Waiting),Cl=Bn(!1),wl=Bn(!1),Mm="http",km="localhost",Om=42001,Dm=window.location.href,ru=new URL(Dm),nu=ru.protocol.replace(/:/g,"")||Mm,pf=ru.hostname||km,mf=parseInt(ru.port)||(nu==="https:"?443:80)||Om;class Lm{constructor(S=Bn(nu),st=Bn(pf),ft=Bn(mf)){this.schema=S,this.host=st,this.port=ft}get apiURL(){return Sm([this.schema,this.host,this.port],([S,st,ft])=>`${S}://${st}:${ft}`)}}const eh=new Lm,su=Bn(`${nu}://${pf}:${mf}`);class zm{constructor(S=Bn("https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL"),st=Bn("https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL")){this.uri=S,this.accepted_uri=st}}const ih=new zm;Bn(ih.accepted_uri);const co=Bn(new Map);function Fm(Z){co.update(S=>{const st=new Map(S),ft={type:Z.type,id:Z.id,properties:{road_lane_direction:Z.properties.road_lane_direction,road_lane_num:Z.properties.road_lane_num,coordinates:Z.properties.coordinates,color_rgb:Z.properties.color_rgb,virtual_line:Z.properties.virtual_line,ds_id:Z.id,spatial_object_id:`spatial-${Z.id}`,color_rgb_str:`rgb(${Z.properties.color_rgb[0]},${Z.properties.color_rgb[1]},${Z.properties.color_rgb[2]})`},geometry:{type:Z.geometry.type,coordinates:Z.geometry.coordinates}};return st.set(Z.id,ft),st})}function Ya(Z,S){co.update(st=>{const ft=new Map(st);return ft.set(Z,S),ft})}function Rm(Z){co.update(S=>{const st=new Map(S);return st.delete(Z),st})}function Bm(){co.update(Z=>{const S=new Map(Z);return S.clear(),S})}const jm=(Z,S,st)=>{const ft=Z.get(st);if(!ft)return;if(!ft.properties.spatial_object_id){console.error(`ID '${ft.id}' should have 'spatial_object_id' in properties, but it has not`);return}const lt=S.get(ft.properties.spatial_object_id);lt&&(S.add(lt),S.setFeatureProperty(lt.id,"color_rgb_str",pc))},gf=(Z,S)=>{const st=Z.get(S);st&&(st.properties.spatial_object_id=void 0,st.properties.road_lane_direction=-1,st.properties.road_lane_num=-1,st.geometry.coordinates=[[],[],[],[],[]],Ya(S,st))};function Nm(Z){let S,st,ft;return{c(){S=Ae("div"),st=Ae("div"),this.h()},l(lt){S=Me(lt,"DIV",{class:!0});var It=ni(S);st=Me(It,"DIV",{class:!0,id:!0}),ni(st).forEach(Re),It.forEach(Re),this.h()},h(){fe(st,"class","map"),fe(st,"id","map"),fe(S,"class",ft="map-wrap "+Z[0])},m(lt,It){dn(lt,S,It),re(S,st),Z[5](st)},p(lt,[It]){It&1&&ft!==(ft="map-wrap "+lt[0])&&fe(S,"class",ft)},i:cs,o:cs,d(lt){lt&&Re(S),Z[5](null)}}}function Vm(Z){return`data:image/svg+xml;charset=utf-8,${encodeURIComponent(Z)}`}function Um(Z,S,st){let ft,lt,It,N;Nr(Z,iu,w=>st(7,ft=w)),Nr(Z,co,w=>st(8,lt=w)),Nr(Z,Jh,w=>st(9,It=w));let{klass:s=""}=S,p;const{accepted_uri:C}=ih;Nr(Z,C,w=>st(10,N=w));let b=N;const l=w=>`<svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="${w}"><path d="M480.276-96Q401-96 331-126q-70-30-122.5-82.5T126-330.958q-30-69.959-30-149.5Q96-560 126-629.5t82.5-122Q261-804 330.958-834q69.959-30 149.5-30Q560-864 629.5-834t122 82.5Q804-699 834-629.276q30 69.725 30 149Q864-401 834-331q-30 70-82.5 122.5T629.276-126q-69.725 30-149 30ZM480-168q130 0 221-91t91-221q0-130-91-221t-221-91q-130 0-221 91t-91 221q0 130 91 221t221 91Zm0 0q-130 0-221-91t-91-221q0-130 91-221t221-91q130 0 221 91t91 221q0 130-91 221t-221 91Z"/></svg>`,c=C.subscribe(w=>{b!==w&&(It.setStyle(w),b=N)});mc(()=>{console.log("Mounted map component");const w={lng:0,lat:0,zoom:5};Jh.set(new uf.Map({container:p,style:b,center:[w.lng,w.lat],zoom:w.zoom})),It.on("load",()=>{It.resize()}),It.on("click","gl-draw-polygon-fill-inactive.cold",function(E){var Ft,Kt,Jt,Qt;const O=ft.get((Ft=E.features)==null?void 0:Ft[0].properties.id);if(!O)return;const L=Array.from(lt.values()).map((he,ne)=>{const me=he.properties.color_rgb_str;return`<option value="${he.id}" data-icon="${Vm(l(me))}">${he.id}</option>`}),U=(Kt=[...lt].find(he=>he[1].properties.spatial_object_id===O.id))==null?void 0:Kt[1],$=`
                <div id="custom-popup">
                    <div class="row">
                        <div class="input-field col s12">
                            <select id="select-canvas">
                                <option value="" disabled selected>Pick up polygon</option>
                                ${L.join(`
`)}
                            </select>
                            <label>Attach canvas polygons</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input value="${U?(Jt=U.properties)==null?void 0:Jt.road_lane_direction:-1}" id="lane-direction" type="number" class="validate">
                            <label class="active" for="lane-direction">Direction value</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input value="${U?(Qt=U.properties)==null?void 0:Qt.road_lane_num:-1}" id="lane-number" type="number" class="validate">
                            <label class="active" for="lane-number">Lane</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12">
                            <button id="attach-canvas-btn" class="btn-small waves-effect waves-light" type="submit" name="action" onclick>Save
                                <i class="material-icons right">save</i>
                            </button>
                        </div>
                    </div>
                </div>
            `;new Yd.Popup({className:"custom-popup"}).setLngLat(E.lngLat).setHTML($).addTo(It);const nt=document.getElementById("select-canvas");if(!nt)return;Array.from(lt.values()).some(he=>{if(he.properties.spatial_object_id===O.id)return nt.value=he.id??"No canvas ID",!0}),M.FormSelect.init(nt,{});const xt=document.getElementById("attach-canvas-btn");if(!xt){console.error("No container 'attach-canvas-btn'");return}xt.addEventListener("click",he=>{const ne=document.getElementById("lane-direction"),me=document.getElementById("lane-number");g(O,nt.value,{road_lane_direction:ne?parseInt(ne.value):-1,road_lane_num:me?parseInt(me.value):-1})})})}),Qh(()=>{c(),It.remove()});function h(w){It.addControl(w)}const m=(w,E)=>{if(E.forEach(U=>{const $={...U,properties:{color_rgb_str:U.properties.color_rgb_str},id:U.properties.spatial_object_id};w.add($)}),E.size===0)return;const O=Array.from(E.values())[0].geometry.coordinates;let L=new Yd.LngLatBounds(O[0]);for(const U of O)L.extend(U);It.fitBounds(L,{maxZoom:18,padding:100})},g=(w,E,O={road_lane_direction:-1,road_lane_num:-1})=>{var Ft;if(E===""||E===null||E===void 0||!w.properties||!w.id)return;const L=lt.get(E);if(!L){console.error(`ID '${E}' not found in datastorage`);return}const U=w.id,$=L.properties.spatial_object_id;if($){const Kt=ft.get($);Kt&&(ft.add(Kt),ft.setFeatureProperty($,"color_rgb_str",pc))}const nt=(Ft=[...lt].find(Kt=>Kt[1].id!==E&&Kt[1].properties.spatial_object_id===U))==null?void 0:Ft[1];nt&&gf(lt,nt.id),L.properties.spatial_object_id=U,L.properties.road_lane_direction=O.road_lane_direction,L.properties.road_lane_num=O.road_lane_num;const xt=w.geometry;L.geometry.coordinates=xt.coordinates,Ya(E,L),ft.add(w),ft.setFeatureProperty(U,"color_rgb_str",L.properties.color_rgb_str)};function d(w){of[w?"unshift":"push"](()=>{p=w,st(1,p)})}return Z.$$set=w=>{"klass"in w&&st(0,s=w.klass)},[s,p,C,h,m,d]}class Gm extends ma{constructor(S){super(),ga(this,S,Um,Nm,pa,{klass:0,attachDraw:3,drawGeoPolygons:4})}get attachDraw(){return this.$$.ctx[3]}get drawGeoPolygons(){return this.$$.ctx[4]}}function Xm(Z){let S,st,ft,lt,It=".",N,s,p=".",C,b,l=".";return{c(){S=Ae("div"),st=xn(Z[0]),ft=Ai(),lt=Ae("span"),lt.textContent=It,N=Ai(),s=Ae("span"),s.textContent=p,C=Ai(),b=Ae("span"),b.textContent=l,this.h()},l(c){S=Me(c,"DIV",{class:!0});var h=ni(S);st=bn(h,Z[0]),ft=Mi(h),lt=Me(h,"SPAN",{class:!0,"data-svelte-h":!0}),Sr(lt)!=="svelte-980x4v"&&(lt.textContent=It),N=Mi(h),s=Me(h,"SPAN",{class:!0,"data-svelte-h":!0}),Sr(s)!=="svelte-1xw9n6t"&&(s.textContent=p),C=Mi(h),b=Me(h,"SPAN",{class:!0,"data-svelte-h":!0}),Sr(b)!=="svelte-17zz11c"&&(b.textContent=l),h.forEach(Re),this.h()},h(){fe(lt,"class","first-dot svelte-4rj70q"),fe(s,"class","second-dot svelte-4rj70q"),fe(b,"class","third-dot svelte-4rj70q"),fe(S,"class","three-dot-loader")},m(c,h){dn(c,S,h),re(S,st),re(S,ft),re(S,lt),re(S,N),re(S,s),re(S,C),re(S,b)},p(c,[h]){h&1&&Bs(st,c[0])},i:cs,o:cs,d(c){c&&Re(S)}}}function Wm(Z,S,st){let{msgText:ft="Loading"}=S;return Z.$$set=lt=>{"msgText"in lt&&st(0,ft=lt.msgText)},[ft]}class Hm extends ma{constructor(S){super(),ga(this,S,Wm,Xm,pa,{msgText:0})}}var bi={};const qm={},$m=Object.freeze(Object.defineProperty({__proto__:null,default:qm},Symbol.toStringTag,{value:"Module"})),Zh=Cm($m);(function(Z){/*! Fabric.js Copyright 2008-2015, Printio (Juriy Zaytsev, Maxim Chernyak) */var S=S||{version:"5.3.0"};if(Z.fabric=S,typeof document<"u"&&typeof window<"u")document instanceof(typeof HTMLDocument<"u"?HTMLDocument:Document)?S.document=document:S.document=document.implementation.createHTMLDocument(""),S.window=window;else{var st=Zh,ft=new st.JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;S.document=ft.document,S.jsdomImplForWrapper=Zh.implForWrapper,S.nodeCanvas=Zh.Canvas,S.window=ft,DOMParser=S.window.DOMParser}S.isTouchSupported="ontouchstart"in S.window||"ontouchstart"in S.document||S.window&&S.window.navigator&&S.window.navigator.maxTouchPoints>0,S.isLikelyNode=typeof Buffer<"u"&&typeof window>"u",S.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],S.DPI=96,S.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",S.commaWsp="(?:\\s+,?\\s*|,\\s*)",S.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/ig,S.reNonWord=/[ \n\.,;!\?\-]/,S.fontPaths={},S.iMatrix=[1,0,0,1,0,0],S.svgNS="http://www.w3.org/2000/svg",S.perfLimitSizeTotal=2097152,S.maxCacheSideLimit=4096,S.minCacheSideLimit=256,S.charWidthsCache={},S.textureSize=2048,S.disableStyleCopyPaste=!1,S.enableGLFiltering=!0,S.devicePixelRatio=S.window.devicePixelRatio||S.window.webkitDevicePixelRatio||S.window.mozDevicePixelRatio||1,S.browserShadowBlurConstant=1,S.arcToSegmentsCache={},S.boundsOfCurveCache={},S.cachesBoundsOfCurve=!0,S.forceGLPutImageData=!1,S.initFilterBackend=function(){if(S.enableGLFiltering&&S.isWebglSupported&&S.isWebglSupported(S.textureSize))return console.log("max texture size: "+S.maxTextureSize),new S.WebglFilterBackend({tileSize:S.textureSize});if(S.Canvas2dFilterBackend)return new S.Canvas2dFilterBackend},typeof document<"u"&&typeof window<"u"&&(window.fabric=S),function(){function s(h,m){if(this.__eventListeners[h]){var g=this.__eventListeners[h];m?g[g.indexOf(m)]=!1:S.util.array.fill(g,!1)}}function p(h,m){if(this.__eventListeners||(this.__eventListeners={}),arguments.length===1)for(var g in h)this.on(g,h[g]);else this.__eventListeners[h]||(this.__eventListeners[h]=[]),this.__eventListeners[h].push(m);return this}function C(h,m){var g=(function(){m.apply(this,arguments),this.off(h,g)}).bind(this);this.on(h,g)}function b(h,m){if(arguments.length===1)for(var g in h)C.call(this,g,h[g]);else C.call(this,h,m);return this}function l(h,m){if(!this.__eventListeners)return this;if(arguments.length===0)for(h in this.__eventListeners)s.call(this,h);else if(arguments.length===1&&typeof arguments[0]=="object")for(var g in h)s.call(this,g,h[g]);else s.call(this,h,m);return this}function c(h,m){if(!this.__eventListeners)return this;var g=this.__eventListeners[h];if(!g)return this;for(var d=0,w=g.length;d<w;d++)g[d]&&g[d].call(this,m||{});return this.__eventListeners[h]=g.filter(function(E){return E!==!1}),this}S.Observable={fire:c,on:p,once:b,off:l}}(),S.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var s=0,p=arguments.length;s<p;s++)this._onObjectAdded(arguments[s]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(s,p,C){var b=this._objects;return C?b[p]=s:b.splice(p,0,s),this._onObjectAdded&&this._onObjectAdded(s),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var s=this._objects,p,C=!1,b=0,l=arguments.length;b<l;b++)p=s.indexOf(arguments[b]),p!==-1&&(C=!0,s.splice(p,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[b]));return this.renderOnAddRemove&&C&&this.requestRenderAll(),this},forEachObject:function(s,p){for(var C=this.getObjects(),b=0,l=C.length;b<l;b++)s.call(p,C[b],b,C);return this},getObjects:function(s){return typeof s>"u"?this._objects.concat():this._objects.filter(function(p){return p.type===s})},item:function(s){return this._objects[s]},isEmpty:function(){return this._objects.length===0},size:function(){return this._objects.length},contains:function(s,p){return this._objects.indexOf(s)>-1?!0:p?this._objects.some(function(C){return typeof C.contains=="function"&&C.contains(s,!0)}):!1},complexity:function(){return this._objects.reduce(function(s,p){return s+=p.complexity?p.complexity():0,s},0)}},S.CommonMethods={_setOptions:function(s){for(var p in s)this.set(p,s[p])},_initGradient:function(s,p){s&&s.colorStops&&!(s instanceof S.Gradient)&&this.set(p,new S.Gradient(s))},_initPattern:function(s,p,C){s&&s.source&&!(s instanceof S.Pattern)?this.set(p,new S.Pattern(s,C)):C&&C()},_setObject:function(s){for(var p in s)this._set(p,s[p])},set:function(s,p){return typeof s=="object"?this._setObject(s):this._set(s,p),this},_set:function(s,p){this[s]=p},toggle:function(s){var p=this.get(s);return typeof p=="boolean"&&this.set(s,!p),this},get:function(s){return this[s]}},function(s){var p=Math.sqrt,C=Math.atan2,b=Math.pow,l=Math.PI/180,c=Math.PI/2;S.util={cos:function(h){if(h===0)return 1;h<0&&(h=-h);var m=h/c;switch(m){case 1:case 3:return 0;case 2:return-1}return Math.cos(h)},sin:function(h){if(h===0)return 0;var m=h/c,g=1;switch(h<0&&(g=-1),m){case 1:return g;case 2:return 0;case 3:return-g}return Math.sin(h)},removeFromArray:function(h,m){var g=h.indexOf(m);return g!==-1&&h.splice(g,1),h},getRandomInt:function(h,m){return Math.floor(Math.random()*(m-h+1))+h},degreesToRadians:function(h){return h*l},radiansToDegrees:function(h){return h/l},rotatePoint:function(h,m,g){var d=new S.Point(h.x-m.x,h.y-m.y),w=S.util.rotateVector(d,g);return new S.Point(w.x,w.y).addEquals(m)},rotateVector:function(h,m){var g=S.util.sin(m),d=S.util.cos(m),w=h.x*d-h.y*g,E=h.x*g+h.y*d;return{x:w,y:E}},createVector:function(h,m){return new S.Point(m.x-h.x,m.y-h.y)},calcAngleBetweenVectors:function(h,m){return Math.acos((h.x*m.x+h.y*m.y)/(Math.hypot(h.x,h.y)*Math.hypot(m.x,m.y)))},getHatVector:function(h){return new S.Point(h.x,h.y).multiply(1/Math.hypot(h.x,h.y))},getBisector:function(h,m,g){var d=S.util.createVector(h,m),w=S.util.createVector(h,g),E=S.util.calcAngleBetweenVectors(d,w),O=S.util.calcAngleBetweenVectors(S.util.rotateVector(d,E),w),L=E*(O===0?1:-1)/2;return{vector:S.util.getHatVector(S.util.rotateVector(d,L)),angle:E}},projectStrokeOnPoints:function(h,m,g){var d=[],w=m.strokeWidth/2,E=m.strokeUniform?new S.Point(1/m.scaleX,1/m.scaleY):new S.Point(1,1),O=function(L){var U=w/Math.hypot(L.x,L.y);return new S.Point(L.x*U*E.x,L.y*U*E.y)};return h.length<=1||h.forEach(function(L,U){var $=new S.Point(L.x,L.y),nt,xt;U===0?(xt=h[U+1],nt=g?O(S.util.createVector(xt,$)).addEquals($):h[h.length-1]):U===h.length-1?(nt=h[U-1],xt=g?O(S.util.createVector(nt,$)).addEquals($):h[0]):(nt=h[U-1],xt=h[U+1]);var Ft=S.util.getBisector($,nt,xt),Kt=Ft.vector,Jt=Ft.angle,Qt,he;if(m.strokeLineJoin==="miter"&&(Qt=-w/Math.sin(Jt/2),he=new S.Point(Kt.x*Qt*E.x,Kt.y*Qt*E.y),Math.hypot(he.x,he.y)/w<=m.strokeMiterLimit)){d.push($.add(he)),d.push($.subtract(he));return}Qt=-w*Math.SQRT2,he=new S.Point(Kt.x*Qt*E.x,Kt.y*Qt*E.y),d.push($.add(he)),d.push($.subtract(he))}),d},transformPoint:function(h,m,g){return g?new S.Point(m[0]*h.x+m[2]*h.y,m[1]*h.x+m[3]*h.y):new S.Point(m[0]*h.x+m[2]*h.y+m[4],m[1]*h.x+m[3]*h.y+m[5])},makeBoundingBoxFromPoints:function(h,m){if(m)for(var g=0;g<h.length;g++)h[g]=S.util.transformPoint(h[g],m);var d=[h[0].x,h[1].x,h[2].x,h[3].x],w=S.util.array.min(d),E=S.util.array.max(d),O=E-w,L=[h[0].y,h[1].y,h[2].y,h[3].y],U=S.util.array.min(L),$=S.util.array.max(L),nt=$-U;return{left:w,top:U,width:O,height:nt}},invertTransform:function(h){var m=1/(h[0]*h[3]-h[1]*h[2]),g=[m*h[3],-m*h[1],-m*h[2],m*h[0]],d=S.util.transformPoint({x:h[4],y:h[5]},g,!0);return g[4]=-d.x,g[5]=-d.y,g},toFixed:function(h,m){return parseFloat(Number(h).toFixed(m))},parseUnit:function(h,m){var g=/\D{0,2}$/.exec(h),d=parseFloat(h);switch(m||(m=S.Text.DEFAULT_SVG_FONT_SIZE),g[0]){case"mm":return d*S.DPI/25.4;case"cm":return d*S.DPI/2.54;case"in":return d*S.DPI;case"pt":return d*S.DPI/72;case"pc":return d*S.DPI/72*12;case"em":return d*m;default:return d}},falseFunction:function(){return!1},getKlass:function(h,m){return h=S.util.string.camelize(h.charAt(0).toUpperCase()+h.slice(1)),S.util.resolveNamespace(m)[h]},getSvgAttributes:function(h){var m=["instantiated_by_use","style","id","class"];switch(h){case"linearGradient":m=m.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":m=m.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":m=m.concat(["offset","stop-color","stop-opacity"]);break}return m},resolveNamespace:function(h){if(!h)return S;var m=h.split("."),g=m.length,d,w=s||S.window;for(d=0;d<g;++d)w=w[m[d]];return w},loadImage:function(h,m,g,d){if(!h){m&&m.call(g,h);return}var w=S.util.createImage(),E=function(){m&&m.call(g,w,!1),w=w.onload=w.onerror=null};w.onload=E,w.onerror=function(){S.log("Error loading "+w.src),m&&m.call(g,null,!0),w=w.onload=w.onerror=null},h.indexOf("data")!==0&&d!==void 0&&d!==null&&(w.crossOrigin=d),h.substring(0,14)==="data:image/svg"&&(w.onload=null,S.util.loadImageInDom(w,E)),w.src=h},loadImageInDom:function(h,m){var g=S.document.createElement("div");g.style.width=g.style.height="1px",g.style.left=g.style.top="-100%",g.style.position="absolute",g.appendChild(h),S.document.querySelector("body").appendChild(g),h.onload=function(){m(),g.parentNode.removeChild(g),g=null}},enlivenObjects:function(h,m,g,d){h=h||[];var w=[],E=0,O=h.length;function L(){++E===O&&m&&m(w.filter(function(U){return U}))}if(!O){m&&m(w);return}h.forEach(function(U,$){if(!U||!U.type){L();return}var nt=S.util.getKlass(U.type,g);nt.fromObject(U,function(xt,Ft){Ft||(w[$]=xt),d&&d(U,xt,Ft),L()})})},enlivenObjectEnlivables:function(h,m,g){var d=S.Object.ENLIVEN_PROPS.filter(function(w){return!!h[w]});S.util.enlivenObjects(d.map(function(w){return h[w]}),function(w){var E={};d.forEach(function(O,L){E[O]=w[L],m&&(m[O]=w[L])}),g&&g(E)})},enlivenPatterns:function(h,m){h=h||[];function g(){++w===E&&m&&m(d)}var d=[],w=0,E=h.length;if(!E){m&&m(d);return}h.forEach(function(O,L){O&&O.source?new S.Pattern(O,function(U){d[L]=U,g()}):(d[L]=O,g())})},groupSVGElements:function(h,m,g){var d;return h&&h.length===1?(typeof g<"u"&&(h[0].sourcePath=g),h[0]):(m&&(m.width&&m.height?m.centerPoint={x:m.width/2,y:m.height/2}:(delete m.width,delete m.height)),d=new S.Group(h,m),typeof g<"u"&&(d.sourcePath=g),d)},populateWithProperties:function(h,m,g){if(g&&Array.isArray(g))for(var d=0,w=g.length;d<w;d++)g[d]in h&&(m[g[d]]=h[g[d]])},createCanvasElement:function(){return S.document.createElement("canvas")},copyCanvasElement:function(h){var m=S.util.createCanvasElement();return m.width=h.width,m.height=h.height,m.getContext("2d").drawImage(h,0,0),m},toDataURL:function(h,m,g){return h.toDataURL("image/"+m,g)},createImage:function(){return S.document.createElement("img")},multiplyTransformMatrices:function(h,m,g){return[h[0]*m[0]+h[2]*m[1],h[1]*m[0]+h[3]*m[1],h[0]*m[2]+h[2]*m[3],h[1]*m[2]+h[3]*m[3],g?0:h[0]*m[4]+h[2]*m[5]+h[4],g?0:h[1]*m[4]+h[3]*m[5]+h[5]]},qrDecompose:function(h){var m=C(h[1],h[0]),g=b(h[0],2)+b(h[1],2),d=p(g),w=(h[0]*h[3]-h[2]*h[1])/d,E=C(h[0]*h[2]+h[1]*h[3],g);return{angle:m/l,scaleX:d,scaleY:w,skewX:E/l,skewY:0,translateX:h[4],translateY:h[5]}},calcRotateMatrix:function(h){if(!h.angle)return S.iMatrix.concat();var m=S.util.degreesToRadians(h.angle),g=S.util.cos(m),d=S.util.sin(m);return[g,d,-d,g,0,0]},calcDimensionsMatrix:function(h){var m=typeof h.scaleX>"u"?1:h.scaleX,g=typeof h.scaleY>"u"?1:h.scaleY,d=[h.flipX?-m:m,0,0,h.flipY?-g:g,0,0],w=S.util.multiplyTransformMatrices,E=S.util.degreesToRadians;return h.skewX&&(d=w(d,[1,0,Math.tan(E(h.skewX)),1],!0)),h.skewY&&(d=w(d,[1,Math.tan(E(h.skewY)),0,1],!0)),d},composeMatrix:function(h){var m=[1,0,0,1,h.translateX||0,h.translateY||0],g=S.util.multiplyTransformMatrices;return h.angle&&(m=g(m,S.util.calcRotateMatrix(h))),(h.scaleX!==1||h.scaleY!==1||h.skewX||h.skewY||h.flipX||h.flipY)&&(m=g(m,S.util.calcDimensionsMatrix(h))),m},resetObjectTransform:function(h){h.scaleX=1,h.scaleY=1,h.skewX=0,h.skewY=0,h.flipX=!1,h.flipY=!1,h.rotate(0)},saveObjectTransform:function(h){return{scaleX:h.scaleX,scaleY:h.scaleY,skewX:h.skewX,skewY:h.skewY,angle:h.angle,left:h.left,flipX:h.flipX,flipY:h.flipY,top:h.top}},isTransparent:function(h,m,g,d){d>0&&(m>d?m-=d:m=0,g>d?g-=d:g=0);var w=!0,E,O,L=h.getImageData(m,g,d*2||1,d*2||1),U=L.data.length;for(E=3;E<U&&(O=L.data[E],w=O<=0,w!==!1);E+=4);return L=null,w},parsePreserveAspectRatioAttribute:function(h){var m="meet",g="Mid",d="Mid",w=h.split(" "),E;return w&&w.length&&(m=w.pop(),m!=="meet"&&m!=="slice"?(E=m,m="meet"):w.length&&(E=w.pop())),g=E!=="none"?E.slice(1,4):"none",d=E!=="none"?E.slice(5,8):"none",{meetOrSlice:m,alignX:g,alignY:d}},clearFabricFontCache:function(h){h=(h||"").toLowerCase(),h?S.charWidthsCache[h]&&delete S.charWidthsCache[h]:S.charWidthsCache={}},limitDimsByArea:function(h,m){var g=Math.sqrt(m*h),d=Math.floor(m/g);return{x:Math.floor(g),y:d}},capValue:function(h,m,g){return Math.max(h,Math.min(m,g))},findScaleToFit:function(h,m){return Math.min(m.width/h.width,m.height/h.height)},findScaleToCover:function(h,m){return Math.max(m.width/h.width,m.height/h.height)},matrixToSVG:function(h){return"matrix("+h.map(function(m){return S.util.toFixed(m,S.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(h,m){var g=S.util.invertTransform(m),d=S.util.multiplyTransformMatrices(g,h.calcOwnMatrix());S.util.applyTransformToObject(h,d)},addTransformToObject:function(h,m){S.util.applyTransformToObject(h,S.util.multiplyTransformMatrices(m,h.calcOwnMatrix()))},applyTransformToObject:function(h,m){var g=S.util.qrDecompose(m),d=new S.Point(g.translateX,g.translateY);h.flipX=!1,h.flipY=!1,h.set("scaleX",g.scaleX),h.set("scaleY",g.scaleY),h.skewX=g.skewX,h.skewY=g.skewY,h.angle=g.angle,h.setPositionByOrigin(d,"center","center")},sizeAfterTransform:function(h,m,g){var d=h/2,w=m/2,E=[{x:-d,y:-w},{x:d,y:-w},{x:-d,y:w},{x:d,y:w}],O=S.util.calcDimensionsMatrix(g),L=S.util.makeBoundingBoxFromPoints(E,O);return{x:L.width,y:L.height}},mergeClipPaths:function(h,m){var g=h,d=m;g.inverted&&!d.inverted&&(g=m,d=h),S.util.applyTransformToObject(d,S.util.multiplyTransformMatrices(S.util.invertTransform(g.calcTransformMatrix()),d.calcTransformMatrix()));var w=g.inverted&&d.inverted;return w&&(g.inverted=d.inverted=!1),new S.Group([g],{clipPath:d,inverted:w})},hasStyleChanged:function(h,m,g){return g=g||!1,h.fill!==m.fill||h.stroke!==m.stroke||h.strokeWidth!==m.strokeWidth||h.fontSize!==m.fontSize||h.fontFamily!==m.fontFamily||h.fontWeight!==m.fontWeight||h.fontStyle!==m.fontStyle||h.textBackgroundColor!==m.textBackgroundColor||h.deltaY!==m.deltaY||g&&(h.overline!==m.overline||h.underline!==m.underline||h.linethrough!==m.linethrough)},stylesToArray:function(g,m){for(var g=S.util.object.clone(g,!0),d=m.split(`
`),w=-1,E={},O=[],L=0;L<d.length;L++){if(!g[L]){w+=d[L].length;continue}for(var U=0;U<d[L].length;U++){w++;var $=g[L][U];if($&&Object.keys($).length>0){var nt=S.util.hasStyleChanged(E,$,!0);nt?O.push({start:w,end:w+1,style:$}):O[O.length-1].end++}E=$||{}}}return O},stylesFromArray:function(h,m){if(!Array.isArray(h))return h;for(var g=m.split(`
`),d=-1,w=0,E={},O=0;O<g.length;O++)for(var L=0;L<g[O].length;L++)d++,h[w]&&h[w].start<=d&&d<h[w].end&&(E[O]=E[O]||{},E[O][L]=Object.assign({},h[w].style),d===h[w].end-1&&w++);return E}}}(Z),function(){var s=Array.prototype.join,p={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},C={m:"l",M:"L"};function b(Q,wt,gt,vt,Vt,pt,rt,Mt,jt,te,Wt){var Xt=S.util.cos(Q),ye=S.util.sin(Q),Te=S.util.cos(wt),qt=S.util.sin(wt),Lt=gt*Vt*Te-vt*pt*qt+rt,ae=vt*Vt*Te+gt*pt*qt+Mt,at=te+jt*(-gt*Vt*ye-vt*pt*Xt),Zt=Wt+jt*(-vt*Vt*ye+gt*pt*Xt),pe=Lt+jt*(gt*Vt*qt+vt*pt*Te),ue=ae+jt*(vt*Vt*qt-gt*pt*Te);return["C",at,Zt,pe,ue,Lt,ae]}function l(Q,wt,gt,vt,Vt,pt,rt){var Mt=Math.PI,jt=rt*Mt/180,te=S.util.sin(jt),Wt=S.util.cos(jt),Xt=0,ye=0;gt=Math.abs(gt),vt=Math.abs(vt);var Te=-Wt*Q*.5-te*wt*.5,qt=-Wt*wt*.5+te*Q*.5,Lt=gt*gt,ae=vt*vt,at=qt*qt,Zt=Te*Te,pe=Lt*ae-Lt*at-ae*Zt,ue=0;if(pe<0){var Fe=Math.sqrt(1-pe/(Lt*ae));gt*=Fe,vt*=Fe}else ue=(Vt===pt?-1:1)*Math.sqrt(pe/(Lt*at+ae*Zt));var Ke=ue*gt*qt/vt,oe=-ue*vt*Te/gt,ve=Wt*Ke-te*oe+Q*.5,He=te*Ke+Wt*oe+wt*.5,ci=c(1,0,(Te-Ke)/gt,(qt-oe)/vt),wi=c((Te-Ke)/gt,(qt-oe)/vt,(-Te-Ke)/gt,(-qt-oe)/vt);pt===0&&wi>0?wi-=2*Mt:pt===1&&wi<0&&(wi+=2*Mt);for(var vi=Math.ceil(Math.abs(wi/Mt*2)),ce=[],Ti=wi/vi,zi=8/3*Math.sin(Ti/4)*Math.sin(Ti/4)/Math.sin(Ti/2),nr=ci+Ti,Yi=0;Yi<vi;Yi++)ce[Yi]=b(ci,nr,Wt,te,gt,vt,ve,He,zi,Xt,ye),Xt=ce[Yi][5],ye=ce[Yi][6],ci=nr,nr+=Ti;return ce}function c(Q,wt,gt,vt){var Vt=Math.atan2(wt,Q),pt=Math.atan2(vt,gt);return pt>=Vt?pt-Vt:2*Math.PI-(Vt-pt)}function h(Q,wt,gt,vt,Vt,pt,rt,Mt){var jt;if(S.cachesBoundsOfCurve&&(jt=s.call(arguments),S.boundsOfCurveCache[jt]))return S.boundsOfCurveCache[jt];var te=Math.sqrt,Wt=Math.min,Xt=Math.max,ye=Math.abs,Te=[],qt=[[],[]],Lt,ae,at,Zt,pe,ue,Fe,Ke;ae=6*Q-12*gt+6*Vt,Lt=-3*Q+9*gt-9*Vt+3*rt,at=3*gt-3*Q;for(var oe=0;oe<2;++oe){if(oe>0&&(ae=6*wt-12*vt+6*pt,Lt=-3*wt+9*vt-9*pt+3*Mt,at=3*vt-3*wt),ye(Lt)<1e-12){if(ye(ae)<1e-12)continue;Zt=-at/ae,0<Zt&&Zt<1&&Te.push(Zt);continue}Fe=ae*ae-4*at*Lt,!(Fe<0)&&(Ke=te(Fe),pe=(-ae+Ke)/(2*Lt),0<pe&&pe<1&&Te.push(pe),ue=(-ae-Ke)/(2*Lt),0<ue&&ue<1&&Te.push(ue))}for(var ve,He,ci=Te.length,wi=ci,vi;ci--;)Zt=Te[ci],vi=1-Zt,ve=vi*vi*vi*Q+3*vi*vi*Zt*gt+3*vi*Zt*Zt*Vt+Zt*Zt*Zt*rt,qt[0][ci]=ve,He=vi*vi*vi*wt+3*vi*vi*Zt*vt+3*vi*Zt*Zt*pt+Zt*Zt*Zt*Mt,qt[1][ci]=He;qt[0][wi]=Q,qt[1][wi]=wt,qt[0][wi+1]=rt,qt[1][wi+1]=Mt;var ce=[{x:Wt.apply(null,qt[0]),y:Wt.apply(null,qt[1])},{x:Xt.apply(null,qt[0]),y:Xt.apply(null,qt[1])}];return S.cachesBoundsOfCurve&&(S.boundsOfCurveCache[jt]=ce),ce}function m(Q,wt,gt){for(var vt=gt[1],Vt=gt[2],pt=gt[3],rt=gt[4],Mt=gt[5],jt=gt[6],te=gt[7],Wt=l(jt-Q,te-wt,vt,Vt,rt,Mt,pt),Xt=0,ye=Wt.length;Xt<ye;Xt++)Wt[Xt][1]+=Q,Wt[Xt][2]+=wt,Wt[Xt][3]+=Q,Wt[Xt][4]+=wt,Wt[Xt][5]+=Q,Wt[Xt][6]+=wt;return Wt}function g(Q){var wt=0,gt=0,vt=Q.length,Vt=0,pt=0,rt,Mt,jt,te=[],Wt,Xt,ye;for(Mt=0;Mt<vt;++Mt){switch(jt=!1,rt=Q[Mt].slice(0),rt[0]){case"l":rt[0]="L",rt[1]+=wt,rt[2]+=gt;case"L":wt=rt[1],gt=rt[2];break;case"h":rt[1]+=wt;case"H":rt[0]="L",rt[2]=gt,wt=rt[1];break;case"v":rt[1]+=gt;case"V":rt[0]="L",gt=rt[1],rt[1]=wt,rt[2]=gt;break;case"m":rt[0]="M",rt[1]+=wt,rt[2]+=gt;case"M":wt=rt[1],gt=rt[2],Vt=rt[1],pt=rt[2];break;case"c":rt[0]="C",rt[1]+=wt,rt[2]+=gt,rt[3]+=wt,rt[4]+=gt,rt[5]+=wt,rt[6]+=gt;case"C":Xt=rt[3],ye=rt[4],wt=rt[5],gt=rt[6];break;case"s":rt[0]="S",rt[1]+=wt,rt[2]+=gt,rt[3]+=wt,rt[4]+=gt;case"S":Wt==="C"?(Xt=2*wt-Xt,ye=2*gt-ye):(Xt=wt,ye=gt),wt=rt[3],gt=rt[4],rt[0]="C",rt[5]=rt[3],rt[6]=rt[4],rt[3]=rt[1],rt[4]=rt[2],rt[1]=Xt,rt[2]=ye,Xt=rt[3],ye=rt[4];break;case"q":rt[0]="Q",rt[1]+=wt,rt[2]+=gt,rt[3]+=wt,rt[4]+=gt;case"Q":Xt=rt[1],ye=rt[2],wt=rt[3],gt=rt[4];break;case"t":rt[0]="T",rt[1]+=wt,rt[2]+=gt;case"T":Wt==="Q"?(Xt=2*wt-Xt,ye=2*gt-ye):(Xt=wt,ye=gt),rt[0]="Q",wt=rt[1],gt=rt[2],rt[1]=Xt,rt[2]=ye,rt[3]=wt,rt[4]=gt;break;case"a":rt[0]="A",rt[6]+=wt,rt[7]+=gt;case"A":jt=!0,te=te.concat(m(wt,gt,rt)),wt=rt[6],gt=rt[7];break;case"z":case"Z":wt=Vt,gt=pt;break}jt||te.push(rt),Wt=rt[0]}return te}function d(Q,wt,gt,vt){return Math.sqrt((gt-Q)*(gt-Q)+(vt-wt)*(vt-wt))}function w(Q){return Q*Q*Q}function E(Q){return 3*Q*Q*(1-Q)}function O(Q){return 3*Q*(1-Q)*(1-Q)}function L(Q){return(1-Q)*(1-Q)*(1-Q)}function U(Q,wt,gt,vt,Vt,pt,rt,Mt){return function(jt){var te=w(jt),Wt=E(jt),Xt=O(jt),ye=L(jt);return{x:rt*te+Vt*Wt+gt*Xt+Q*ye,y:Mt*te+pt*Wt+vt*Xt+wt*ye}}}function $(Q,wt,gt,vt,Vt,pt,rt,Mt){return function(jt){var te=1-jt,Wt=3*te*te*(gt-Q)+6*te*jt*(Vt-gt)+3*jt*jt*(rt-Vt),Xt=3*te*te*(vt-wt)+6*te*jt*(pt-vt)+3*jt*jt*(Mt-pt);return Math.atan2(Xt,Wt)}}function nt(Q){return Q*Q}function xt(Q){return 2*Q*(1-Q)}function Ft(Q){return(1-Q)*(1-Q)}function Kt(Q,wt,gt,vt,Vt,pt){return function(rt){var Mt=nt(rt),jt=xt(rt),te=Ft(rt);return{x:Vt*Mt+gt*jt+Q*te,y:pt*Mt+vt*jt+wt*te}}}function Jt(Q,wt,gt,vt,Vt,pt){return function(rt){var Mt=1-rt,jt=2*Mt*(gt-Q)+2*rt*(Vt-gt),te=2*Mt*(vt-wt)+2*rt*(pt-vt);return Math.atan2(te,jt)}}function Qt(Q,wt,gt){var vt={x:wt,y:gt},Vt,pt=0,rt;for(rt=1;rt<=100;rt+=1)Vt=Q(rt/100),pt+=d(vt.x,vt.y,Vt.x,Vt.y),vt=Vt;return pt}function he(Q,wt){for(var gt=0,vt=0,Vt=Q.iterator,pt={x:Q.x,y:Q.y},rt,Mt,jt=.01,te=Q.angleFinder,Wt;vt<wt&&jt>1e-4;)rt=Vt(gt),Wt=gt,Mt=d(pt.x,pt.y,rt.x,rt.y),Mt+vt>wt?(gt-=jt,jt/=2):(pt=rt,gt+=jt,vt+=Mt);return rt.angle=te(Wt),rt}function ne(Q){for(var wt=0,gt=Q.length,vt,Vt=0,pt=0,rt=0,Mt=0,jt=[],te,Wt,Xt,ye=0;ye<gt;ye++){switch(vt=Q[ye],Wt={x:Vt,y:pt,command:vt[0]},vt[0]){case"M":Wt.length=0,rt=Vt=vt[1],Mt=pt=vt[2];break;case"L":Wt.length=d(Vt,pt,vt[1],vt[2]),Vt=vt[1],pt=vt[2];break;case"C":te=U(Vt,pt,vt[1],vt[2],vt[3],vt[4],vt[5],vt[6]),Xt=$(Vt,pt,vt[1],vt[2],vt[3],vt[4],vt[5],vt[6]),Wt.iterator=te,Wt.angleFinder=Xt,Wt.length=Qt(te,Vt,pt),Vt=vt[5],pt=vt[6];break;case"Q":te=Kt(Vt,pt,vt[1],vt[2],vt[3],vt[4]),Xt=Jt(Vt,pt,vt[1],vt[2],vt[3],vt[4]),Wt.iterator=te,Wt.angleFinder=Xt,Wt.length=Qt(te,Vt,pt),Vt=vt[3],pt=vt[4];break;case"Z":case"z":Wt.destX=rt,Wt.destY=Mt,Wt.length=d(Vt,pt,rt,Mt),Vt=rt,pt=Mt;break}wt+=Wt.length,jt.push(Wt)}return jt.push({length:wt,x:Vt,y:pt}),jt}function me(Q,wt,gt){gt||(gt=ne(Q));for(var vt=0;wt-gt[vt].length>0&&vt<gt.length-2;)wt-=gt[vt].length,vt++;var Vt=gt[vt],pt=wt/Vt.length,rt=Vt.command,Mt=Q[vt],jt;switch(rt){case"M":return{x:Vt.x,y:Vt.y,angle:0};case"Z":case"z":return jt=new S.Point(Vt.x,Vt.y).lerp(new S.Point(Vt.destX,Vt.destY),pt),jt.angle=Math.atan2(Vt.destY-Vt.y,Vt.destX-Vt.x),jt;case"L":return jt=new S.Point(Vt.x,Vt.y).lerp(new S.Point(Mt[1],Mt[2]),pt),jt.angle=Math.atan2(Mt[2]-Vt.y,Mt[1]-Vt.x),jt;case"C":return he(Vt,wt);case"Q":return he(Vt,wt)}}function Oe(Q){var wt=[],gt=[],vt,Vt,pt=S.rePathCommand,rt="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",Mt="("+rt+")"+S.commaWsp,jt="([01])"+S.commaWsp+"?",te=Mt+"?"+Mt+"?"+Mt+jt+jt+Mt+"?("+rt+")",Wt=new RegExp(te,"g"),Xt,ye,Te;if(!Q||!Q.match)return wt;Te=Q.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi);for(var qt=0,Lt,ae=Te.length;qt<ae;qt++){vt=Te[qt],ye=vt.slice(1).trim(),gt.length=0;var at=vt.charAt(0);if(Lt=[at],at.toLowerCase()==="a")for(var Zt;Zt=Wt.exec(ye);)for(var pe=1;pe<Zt.length;pe++)gt.push(Zt[pe]);else for(;Xt=pt.exec(ye);)gt.push(Xt[0]);for(var pe=0,ue=gt.length;pe<ue;pe++)Vt=parseFloat(gt[pe]),isNaN(Vt)||Lt.push(Vt);var Fe=p[at.toLowerCase()],Ke=C[at]||at;if(Lt.length-1>Fe)for(var oe=1,ve=Lt.length;oe<ve;oe+=Fe)wt.push([at].concat(Lt.slice(oe,oe+Fe))),at=Ke;else wt.push(Lt)}return wt}function se(Q,wt){var gt=[],vt,Vt=new S.Point(Q[0].x,Q[0].y),pt=new S.Point(Q[1].x,Q[1].y),rt=Q.length,Mt=1,jt=0,te=rt>2;for(wt=wt||0,te&&(Mt=Q[2].x<pt.x?-1:Q[2].x===pt.x?0:1,jt=Q[2].y<pt.y?-1:Q[2].y===pt.y?0:1),gt.push(["M",Vt.x-Mt*wt,Vt.y-jt*wt]),vt=1;vt<rt;vt++){if(!Vt.eq(pt)){var Wt=Vt.midPointFrom(pt);gt.push(["Q",Vt.x,Vt.y,Wt.x,Wt.y])}Vt=Q[vt],vt+1<Q.length&&(pt=Q[vt+1])}return te&&(Mt=Vt.x>Q[vt-2].x?1:Vt.x===Q[vt-2].x?0:-1,jt=Vt.y>Q[vt-2].y?1:Vt.y===Q[vt-2].y?0:-1),gt.push(["L",Vt.x+Mt*wt,Vt.y+jt*wt]),gt}function be(Q,wt,gt){return gt&&(wt=S.util.multiplyTransformMatrices(wt,[1,0,0,1,-gt.x,-gt.y])),Q.map(function(vt){for(var Vt=vt.slice(0),pt={},rt=1;rt<vt.length-1;rt+=2)pt.x=vt[rt],pt.y=vt[rt+1],pt=S.util.transformPoint(pt,wt),Vt[rt]=pt.x,Vt[rt+1]=pt.y;return Vt})}S.util.joinPath=function(Q){return Q.map(function(wt){return wt.join(" ")}).join(" ")},S.util.parsePath=Oe,S.util.makePathSimpler=g,S.util.getSmoothPathFromPoints=se,S.util.getPathSegmentsInfo=ne,S.util.getBoundsOfCurve=h,S.util.getPointOnPath=me,S.util.transformPath=be}(),function(){var s=Array.prototype.slice;function p(h,m){for(var g=s.call(arguments,2),d=[],w=0,E=h.length;w<E;w++)d[w]=g.length?h[w][m].apply(h[w],g):h[w][m].call(h[w]);return d}function C(h,m){return c(h,m,function(g,d){return g>=d})}function b(h,m){return c(h,m,function(g,d){return g<d})}function l(h,m){for(var g=h.length;g--;)h[g]=m;return h}function c(h,m,g){if(!(!h||h.length===0)){var d=h.length-1,w=m?h[d][m]:h[d];if(m)for(;d--;)g(h[d][m],w)&&(w=h[d][m]);else for(;d--;)g(h[d],w)&&(w=h[d]);return w}}S.util.array={fill:l,invoke:p,min:b,max:C}}(),function(){function s(C,b,l){if(l)if(!S.isLikelyNode&&b instanceof Element)C=b;else if(b instanceof Array){C=[];for(var c=0,h=b.length;c<h;c++)C[c]=s({},b[c],l)}else if(b&&typeof b=="object")for(var m in b)m==="canvas"||m==="group"?C[m]=null:b.hasOwnProperty(m)&&(C[m]=s({},b[m],l));else C=b;else for(var m in b)C[m]=b[m];return C}function p(C,b){return s({},C,b)}S.util.object={extend:s,clone:p},S.util.object.extend(S.util,S.Observable)}(),function(){function s(c){return c.replace(/-+(.)?/g,function(h,m){return m?m.toUpperCase():""})}function p(c,h){return c.charAt(0).toUpperCase()+(h?c.slice(1):c.slice(1).toLowerCase())}function C(c){return c.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function b(c){var h=0,m,g=[];for(h=0,m;h<c.length;h++)(m=l(c,h))!==!1&&g.push(m);return g}function l(c,h){var m=c.charCodeAt(h);if(isNaN(m))return"";if(m<55296||m>57343)return c.charAt(h);if(55296<=m&&m<=56319){if(c.length<=h+1)throw"High surrogate without following low surrogate";var g=c.charCodeAt(h+1);if(56320>g||g>57343)throw"High surrogate without following low surrogate";return c.charAt(h)+c.charAt(h+1)}if(h===0)throw"Low surrogate without preceding high surrogate";var d=c.charCodeAt(h-1);if(55296>d||d>56319)throw"Low surrogate without preceding high surrogate";return!1}S.util.string={camelize:s,capitalize:p,escapeXml:C,graphemeSplit:b}}(),function(){var s=Array.prototype.slice,p=function(){},C=function(){for(var m in{toString:1})if(m==="toString")return!1;return!0}(),b=function(m,g,d){for(var w in g)w in m.prototype&&typeof m.prototype[w]=="function"&&(g[w]+"").indexOf("callSuper")>-1?m.prototype[w]=function(E){return function(){var O=this.constructor.superclass;this.constructor.superclass=d;var L=g[E].apply(this,arguments);if(this.constructor.superclass=O,E!=="initialize")return L}}(w):m.prototype[w]=g[w],C&&(g.toString!==Object.prototype.toString&&(m.prototype.toString=g.toString),g.valueOf!==Object.prototype.valueOf&&(m.prototype.valueOf=g.valueOf))};function l(){}function c(m){for(var g=null,d=this;d.constructor.superclass;){var w=d.constructor.superclass.prototype[m];if(d[m]!==w){g=w;break}d=d.constructor.superclass.prototype}return g?arguments.length>1?g.apply(this,s.call(arguments,1)):g.call(this):console.log("tried to callSuper "+m+", method not found in prototype chain",this)}function h(){var m=null,g=s.call(arguments,0);typeof g[0]=="function"&&(m=g.shift());function d(){this.initialize.apply(this,arguments)}d.superclass=m,d.subclasses=[],m&&(l.prototype=m.prototype,d.prototype=new l,m.subclasses.push(d));for(var w=0,E=g.length;w<E;w++)b(d,g[w],m);return d.prototype.initialize||(d.prototype.initialize=p),d.prototype.constructor=d,d.prototype.callSuper=c,d}S.util.createClass=h}(),function(){var s=!!S.document.createElement("div").attachEvent,p=["touchstart","touchmove","touchend"];S.util.addListener=function(b,l,c,h){b&&b.addEventListener(l,c,s?!1:h)},S.util.removeListener=function(b,l,c,h){b&&b.removeEventListener(l,c,s?!1:h)};function C(b){var l=b.changedTouches;return l&&l[0]?l[0]:b}S.util.getPointer=function(b){var l=b.target,c=S.util.getScrollLeftTop(l),h=C(b);return{x:h.clientX+c.left,y:h.clientY+c.top}},S.util.isTouchEvent=function(b){return p.indexOf(b.type)>-1||b.pointerType==="touch"}}(),function(){function s(h,m){var g=h.style;if(!g)return h;if(typeof m=="string")return h.style.cssText+=";"+m,m.indexOf("opacity")>-1?c(h,m.match(/opacity:\s*(\d?\.?\d*)/)[1]):h;for(var d in m)if(d==="opacity")c(h,m[d]);else{var w=d==="float"||d==="cssFloat"?typeof g.styleFloat>"u"?"cssFloat":"styleFloat":d;g.setProperty(w,m[d])}return h}var p=S.document.createElement("div"),C=typeof p.style.opacity=="string",b=typeof p.style.filter=="string",l=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,c=function(h){return h};C?c=function(h,m){return h.style.opacity=m,h}:b&&(c=function(h,m){var g=h.style;return h.currentStyle&&!h.currentStyle.hasLayout&&(g.zoom=1),l.test(g.filter)?(m=m>=.9999?"":"alpha(opacity="+m*100+")",g.filter=g.filter.replace(l,m)):g.filter+=" alpha(opacity="+m*100+")",h}),S.util.setStyle=s}(),function(){var s=Array.prototype.slice;function p(L){return typeof L=="string"?S.document.getElementById(L):L}var C,b=function(L){return s.call(L,0)};try{C=b(S.document.childNodes)instanceof Array}catch{}C||(b=function(L){for(var U=new Array(L.length),$=L.length;$--;)U[$]=L[$];return U});function l(L,U){var $=S.document.createElement(L);for(var nt in U)nt==="class"?$.className=U[nt]:nt==="for"?$.htmlFor=U[nt]:$.setAttribute(nt,U[nt]);return $}function c(L,U){L&&(" "+L.className+" ").indexOf(" "+U+" ")===-1&&(L.className+=(L.className?" ":"")+U)}function h(L,U,$){return typeof U=="string"&&(U=l(U,$)),L.parentNode&&L.parentNode.replaceChild(U,L),U.appendChild(L),U}function m(L){for(var U=0,$=0,nt=S.document.documentElement,xt=S.document.body||{scrollLeft:0,scrollTop:0};L&&(L.parentNode||L.host)&&(L=L.parentNode||L.host,L===S.document?(U=xt.scrollLeft||nt.scrollLeft||0,$=xt.scrollTop||nt.scrollTop||0):(U+=L.scrollLeft||0,$+=L.scrollTop||0),!(L.nodeType===1&&L.style.position==="fixed")););return{left:U,top:$}}function g(L){var U,$=L&&L.ownerDocument,nt={left:0,top:0},xt={left:0,top:0},Ft,Kt={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!$)return xt;for(var Jt in Kt)xt[Kt[Jt]]+=parseInt(d(L,Jt),10)||0;return U=$.documentElement,typeof L.getBoundingClientRect<"u"&&(nt=L.getBoundingClientRect()),Ft=m(L),{left:nt.left+Ft.left-(U.clientLeft||0)+xt.left,top:nt.top+Ft.top-(U.clientTop||0)+xt.top}}var d;S.document.defaultView&&S.document.defaultView.getComputedStyle?d=function(L,U){var $=S.document.defaultView.getComputedStyle(L,null);return $?$[U]:void 0}:d=function(L,U){var $=L.style[U];return!$&&L.currentStyle&&($=L.currentStyle[U]),$},function(){var L=S.document.documentElement.style,U="userSelect"in L?"userSelect":"MozUserSelect"in L?"MozUserSelect":"WebkitUserSelect"in L?"WebkitUserSelect":"KhtmlUserSelect"in L?"KhtmlUserSelect":"";function $(xt){return typeof xt.onselectstart<"u"&&(xt.onselectstart=S.util.falseFunction),U?xt.style[U]="none":typeof xt.unselectable=="string"&&(xt.unselectable="on"),xt}function nt(xt){return typeof xt.onselectstart<"u"&&(xt.onselectstart=null),U?xt.style[U]="":typeof xt.unselectable=="string"&&(xt.unselectable=""),xt}S.util.makeElementUnselectable=$,S.util.makeElementSelectable=nt}();function w(L){var U=S.jsdomImplForWrapper(L);return U._canvas||U._image}function E(L){if(S.isLikelyNode){var U=S.jsdomImplForWrapper(L);U&&(U._image=null,U._canvas=null,U._currentSrc=null,U._attributes=null,U._classList=null)}}function O(L,U){L.imageSmoothingEnabled=L.imageSmoothingEnabled||L.webkitImageSmoothingEnabled||L.mozImageSmoothingEnabled||L.msImageSmoothingEnabled||L.oImageSmoothingEnabled,L.imageSmoothingEnabled=U}S.util.setImageSmoothing=O,S.util.getById=p,S.util.toArray=b,S.util.addClass=c,S.util.makeElement=l,S.util.wrapElement=h,S.util.getScrollLeftTop=m,S.util.getElementOffset=g,S.util.getNodeCanvas=w,S.util.cleanUpJsdomNode=E}(),function(){function s(b,l){return b+(/\?/.test(b)?"&":"?")+l}function p(){}function C(b,l){l||(l={});var c=l.method?l.method.toUpperCase():"GET",h=l.onComplete||function(){},m=new S.window.XMLHttpRequest,g=l.body||l.parameters;return m.onreadystatechange=function(){m.readyState===4&&(h(m),m.onreadystatechange=p)},c==="GET"&&(g=null,typeof l.parameters=="string"&&(b=s(b,l.parameters))),m.open(c,b,!0),(c==="POST"||c==="PUT")&&m.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),m.send(g),m}S.util.request=C}(),S.log=console.log,S.warn=console.warn,function(){var s=S.util.object.extend,p=S.util.object.clone,C=[];S.util.object.extend(C,{cancelAll:function(){var w=this.splice(0);return w.forEach(function(E){E.cancel()}),w},cancelByCanvas:function(w){if(!w)return[];var E=this.filter(function(O){return typeof O.target=="object"&&O.target.canvas===w});return E.forEach(function(O){O.cancel()}),E},cancelByTarget:function(w){var E=this.findAnimationsByTarget(w);return E.forEach(function(O){O.cancel()}),E},findAnimationIndex:function(w){return this.indexOf(this.findAnimation(w))},findAnimation:function(w){return this.find(function(E){return E.cancel===w})},findAnimationsByTarget:function(w){return w?this.filter(function(E){return E.target===w}):[]}});function b(){return!1}function l(w,E,O,L){return-O*Math.cos(w/L*(Math.PI/2))+O+E}function c(w){w||(w={});var E=!1,O,L=function(){var U=S.runningAnimations.indexOf(O);return U>-1&&S.runningAnimations.splice(U,1)[0]};return O=s(p(w),{cancel:function(){return E=!0,L()},currentValue:"startValue"in w?w.startValue:0,completionRate:0,durationRate:0}),S.runningAnimations.push(O),g(function(U){var $=U||+new Date,nt=w.duration||500,xt=$+nt,Ft,Kt=w.onChange||b,Jt=w.abort||b,Qt=w.onComplete||b,he=w.easing||l,ne="startValue"in w?w.startValue.length>0:!1,me="startValue"in w?w.startValue:0,Oe="endValue"in w?w.endValue:100,se=w.byValue||(ne?me.map(function(be,Q){return Oe[Q]-me[Q]}):Oe-me);w.onStart&&w.onStart(),function be(Q){Ft=Q||+new Date;var wt=Ft>xt?nt:Ft-$,gt=wt/nt,vt=ne?me.map(function(pt,rt){return he(wt,me[rt],se[rt],nt)}):he(wt,me,se,nt),Vt=Math.abs(ne?(vt[0]-me[0])/se[0]:(vt-me)/se);if(O.currentValue=ne?vt.slice():vt,O.completionRate=Vt,O.durationRate=gt,!E){if(Jt(vt,Vt,gt)){L();return}if(Ft>xt){O.currentValue=ne?Oe.slice():Oe,O.completionRate=1,O.durationRate=1,Kt(ne?Oe.slice():Oe,1,1),Qt(Oe,1,1),L();return}else Kt(vt,Vt,gt),g(be)}}($)}),O.cancel}var h=S.window.requestAnimationFrame||S.window.webkitRequestAnimationFrame||S.window.mozRequestAnimationFrame||S.window.oRequestAnimationFrame||S.window.msRequestAnimationFrame||function(w){return S.window.setTimeout(w,1e3/60)},m=S.window.cancelAnimationFrame||S.window.clearTimeout;function g(){return h.apply(S.window,arguments)}function d(){return m.apply(S.window,arguments)}S.util.animate=c,S.util.requestAnimFrame=g,S.util.cancelAnimFrame=d,S.runningAnimations=C}(),function(){function s(C,b,l){var c="rgba("+parseInt(C[0]+l*(b[0]-C[0]),10)+","+parseInt(C[1]+l*(b[1]-C[1]),10)+","+parseInt(C[2]+l*(b[2]-C[2]),10);return c+=","+(C&&b?parseFloat(C[3]+l*(b[3]-C[3])):1),c+=")",c}function p(C,b,l,c){var h=new S.Color(C).getSource(),m=new S.Color(b).getSource(),g=c.onComplete,d=c.onChange;return c=c||{},S.util.animate(S.util.object.extend(c,{duration:l||500,startValue:h,endValue:m,byValue:m,easing:function(w,E,O,L){var U=c.colorEasing?c.colorEasing(w,L):1-Math.cos(w/L*(Math.PI/2));return s(E,O,U)},onComplete:function(w,E,O){if(g)return g(s(m,m,0),E,O)},onChange:function(w,E,O){if(d){if(Array.isArray(w))return d(s(w,w,0),E,O);d(w,E,O)}}}))}S.util.animateColor=p}(),function(){function s(Q,wt,gt,vt){return Q<Math.abs(wt)?(Q=wt,vt=gt/4):wt===0&&Q===0?vt=gt/(2*Math.PI)*Math.asin(1):vt=gt/(2*Math.PI)*Math.asin(wt/Q),{a:Q,c:wt,p:gt,s:vt}}function p(Q,wt,gt){return Q.a*Math.pow(2,10*(wt-=1))*Math.sin((wt*gt-Q.s)*(2*Math.PI)/Q.p)}function C(Q,wt,gt,vt){return gt*((Q=Q/vt-1)*Q*Q+1)+wt}function b(Q,wt,gt,vt){return Q/=vt/2,Q<1?gt/2*Q*Q*Q+wt:gt/2*((Q-=2)*Q*Q+2)+wt}function l(Q,wt,gt,vt){return gt*(Q/=vt)*Q*Q*Q+wt}function c(Q,wt,gt,vt){return-gt*((Q=Q/vt-1)*Q*Q*Q-1)+wt}function h(Q,wt,gt,vt){return Q/=vt/2,Q<1?gt/2*Q*Q*Q*Q+wt:-gt/2*((Q-=2)*Q*Q*Q-2)+wt}function m(Q,wt,gt,vt){return gt*(Q/=vt)*Q*Q*Q*Q+wt}function g(Q,wt,gt,vt){return gt*((Q=Q/vt-1)*Q*Q*Q*Q+1)+wt}function d(Q,wt,gt,vt){return Q/=vt/2,Q<1?gt/2*Q*Q*Q*Q*Q+wt:gt/2*((Q-=2)*Q*Q*Q*Q+2)+wt}function w(Q,wt,gt,vt){return-gt*Math.cos(Q/vt*(Math.PI/2))+gt+wt}function E(Q,wt,gt,vt){return gt*Math.sin(Q/vt*(Math.PI/2))+wt}function O(Q,wt,gt,vt){return-gt/2*(Math.cos(Math.PI*Q/vt)-1)+wt}function L(Q,wt,gt,vt){return Q===0?wt:gt*Math.pow(2,10*(Q/vt-1))+wt}function U(Q,wt,gt,vt){return Q===vt?wt+gt:gt*(-Math.pow(2,-10*Q/vt)+1)+wt}function $(Q,wt,gt,vt){return Q===0?wt:Q===vt?wt+gt:(Q/=vt/2,Q<1?gt/2*Math.pow(2,10*(Q-1))+wt:gt/2*(-Math.pow(2,-10*--Q)+2)+wt)}function nt(Q,wt,gt,vt){return-gt*(Math.sqrt(1-(Q/=vt)*Q)-1)+wt}function xt(Q,wt,gt,vt){return gt*Math.sqrt(1-(Q=Q/vt-1)*Q)+wt}function Ft(Q,wt,gt,vt){return Q/=vt/2,Q<1?-gt/2*(Math.sqrt(1-Q*Q)-1)+wt:gt/2*(Math.sqrt(1-(Q-=2)*Q)+1)+wt}function Kt(Q,wt,gt,vt){var Vt=1.70158,pt=0,rt=gt;if(Q===0)return wt;if(Q/=vt,Q===1)return wt+gt;pt||(pt=vt*.3);var Mt=s(rt,gt,pt,Vt);return-p(Mt,Q,vt)+wt}function Jt(Q,wt,gt,vt){var Vt=1.70158,pt=0,rt=gt;if(Q===0)return wt;if(Q/=vt,Q===1)return wt+gt;pt||(pt=vt*.3);var Mt=s(rt,gt,pt,Vt);return Mt.a*Math.pow(2,-10*Q)*Math.sin((Q*vt-Mt.s)*(2*Math.PI)/Mt.p)+Mt.c+wt}function Qt(Q,wt,gt,vt){var Vt=1.70158,pt=0,rt=gt;if(Q===0)return wt;if(Q/=vt/2,Q===2)return wt+gt;pt||(pt=vt*(.3*1.5));var Mt=s(rt,gt,pt,Vt);return Q<1?-.5*p(Mt,Q,vt)+wt:Mt.a*Math.pow(2,-10*(Q-=1))*Math.sin((Q*vt-Mt.s)*(2*Math.PI)/Mt.p)*.5+Mt.c+wt}function he(Q,wt,gt,vt,Vt){return Vt===void 0&&(Vt=1.70158),gt*(Q/=vt)*Q*((Vt+1)*Q-Vt)+wt}function ne(Q,wt,gt,vt,Vt){return Vt===void 0&&(Vt=1.70158),gt*((Q=Q/vt-1)*Q*((Vt+1)*Q+Vt)+1)+wt}function me(Q,wt,gt,vt,Vt){return Vt===void 0&&(Vt=1.70158),Q/=vt/2,Q<1?gt/2*(Q*Q*(((Vt*=1.525)+1)*Q-Vt))+wt:gt/2*((Q-=2)*Q*(((Vt*=1.525)+1)*Q+Vt)+2)+wt}function Oe(Q,wt,gt,vt){return gt-se(vt-Q,0,gt,vt)+wt}function se(Q,wt,gt,vt){return(Q/=vt)<1/2.75?gt*(7.5625*Q*Q)+wt:Q<2/2.75?gt*(7.5625*(Q-=1.5/2.75)*Q+.75)+wt:Q<2.5/2.75?gt*(7.5625*(Q-=2.25/2.75)*Q+.9375)+wt:gt*(7.5625*(Q-=2.625/2.75)*Q+.984375)+wt}function be(Q,wt,gt,vt){return Q<vt/2?Oe(Q*2,0,gt,vt)*.5+wt:se(Q*2-vt,0,gt,vt)*.5+gt*.5+wt}S.util.ease={easeInQuad:function(Q,wt,gt,vt){return gt*(Q/=vt)*Q+wt},easeOutQuad:function(Q,wt,gt,vt){return-gt*(Q/=vt)*(Q-2)+wt},easeInOutQuad:function(Q,wt,gt,vt){return Q/=vt/2,Q<1?gt/2*Q*Q+wt:-gt/2*(--Q*(Q-2)-1)+wt},easeInCubic:function(Q,wt,gt,vt){return gt*(Q/=vt)*Q*Q+wt},easeOutCubic:C,easeInOutCubic:b,easeInQuart:l,easeOutQuart:c,easeInOutQuart:h,easeInQuint:m,easeOutQuint:g,easeInOutQuint:d,easeInSine:w,easeOutSine:E,easeInOutSine:O,easeInExpo:L,easeOutExpo:U,easeInOutExpo:$,easeInCirc:nt,easeOutCirc:xt,easeInOutCirc:Ft,easeInElastic:Kt,easeOutElastic:Jt,easeInOutElastic:Qt,easeInBack:he,easeOutBack:ne,easeInOutBack:me,easeInBounce:Oe,easeOutBounce:se,easeInOutBounce:be}}(),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.util.object.clone,l=p.util.toFixed,c=p.util.parseUnit,h=p.util.multiplyTransformMatrices,m=["path","circle","polygon","polyline","ellipse","rect","line","image","text"],g=["symbol","image","marker","pattern","view","svg"],d=["pattern","defs","symbol","metadata","clipPath","mask","desc"],w=["symbol","g","a","svg","clipPath","defs"],E={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},O={stroke:"strokeOpacity",fill:"fillOpacity"},L="font-size",U="clip-path";p.svgValidTagNamesRegEx=xt(m),p.svgViewBoxElementsRegEx=xt(g),p.svgInvalidAncestorsRegEx=xt(d),p.svgValidParentsRegEx=xt(w),p.cssRules={},p.gradientDefs={},p.clipPaths={};function $(pt){return pt in E?E[pt]:pt}function nt(pt,rt,Mt,jt){var te=Array.isArray(rt),Wt;if((pt==="fill"||pt==="stroke")&&rt==="none")rt="";else{if(pt==="strokeUniform")return rt==="non-scaling-stroke";if(pt==="strokeDashArray")rt==="none"?rt=null:rt=rt.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(pt==="transformMatrix")Mt&&Mt.transformMatrix?rt=h(Mt.transformMatrix,p.parseTransformAttribute(rt)):rt=p.parseTransformAttribute(rt);else if(pt==="visible")rt=rt!=="none"&&rt!=="hidden",Mt&&Mt.visible===!1&&(rt=!1);else if(pt==="opacity")rt=parseFloat(rt),Mt&&typeof Mt.opacity<"u"&&(rt*=Mt.opacity);else if(pt==="textAnchor")rt=rt==="start"?"left":rt==="end"?"right":"center";else if(pt==="charSpacing")Wt=c(rt,jt)/jt*1e3;else if(pt==="paintFirst"){var Xt=rt.indexOf("fill"),ye=rt.indexOf("stroke"),rt="fill";(Xt>-1&&ye>-1&&ye<Xt||Xt===-1&&ye>-1)&&(rt="stroke")}else{if(pt==="href"||pt==="xlink:href"||pt==="font")return rt;if(pt==="imageSmoothing")return rt==="optimizeQuality";Wt=te?rt.map(c):c(rt,jt)}}return!te&&isNaN(Wt)?rt:Wt}function xt(pt){return new RegExp("^("+pt.join("|")+")\\b","i")}function Ft(pt){for(var rt in O)if(!(typeof pt[O[rt]]>"u"||pt[rt]==="")){if(typeof pt[rt]>"u"){if(!p.Object.prototype[rt])continue;pt[rt]=p.Object.prototype[rt]}if(pt[rt].indexOf("url(")!==0){var Mt=new p.Color(pt[rt]);pt[rt]=Mt.setAlpha(l(Mt.getAlpha()*pt[O[rt]],2)).toRgba()}}return pt}function Kt(pt,rt){var Mt,jt=[],te,Wt,Xt;for(Wt=0,Xt=rt.length;Wt<Xt;Wt++)Mt=rt[Wt],te=pt.getElementsByTagName(Mt),jt=jt.concat(Array.prototype.slice.call(te));return jt}p.parseTransformAttribute=function(){function pt(oe,ve){var He=p.util.cos(ve[0]),ci=p.util.sin(ve[0]),wi=0,vi=0;ve.length===3&&(wi=ve[1],vi=ve[2]),oe[0]=He,oe[1]=ci,oe[2]=-ci,oe[3]=He,oe[4]=wi-(He*wi-ci*vi),oe[5]=vi-(ci*wi+He*vi)}function rt(oe,ve){var He=ve[0],ci=ve.length===2?ve[1]:ve[0];oe[0]=He,oe[3]=ci}function Mt(oe,ve,He){oe[He]=Math.tan(p.util.degreesToRadians(ve[0]))}function jt(oe,ve){oe[4]=ve[0],ve.length===2&&(oe[5]=ve[1])}var te=p.iMatrix,Wt=p.reNum,Xt=p.commaWsp,ye="(?:(skewX)\\s*\\(\\s*("+Wt+")\\s*\\))",Te="(?:(skewY)\\s*\\(\\s*("+Wt+")\\s*\\))",qt="(?:(rotate)\\s*\\(\\s*("+Wt+")(?:"+Xt+"("+Wt+")"+Xt+"("+Wt+"))?\\s*\\))",Lt="(?:(scale)\\s*\\(\\s*("+Wt+")(?:"+Xt+"("+Wt+"))?\\s*\\))",ae="(?:(translate)\\s*\\(\\s*("+Wt+")(?:"+Xt+"("+Wt+"))?\\s*\\))",at="(?:(matrix)\\s*\\(\\s*("+Wt+")"+Xt+"("+Wt+")"+Xt+"("+Wt+")"+Xt+"("+Wt+")"+Xt+"("+Wt+")"+Xt+"("+Wt+")\\s*\\))",Zt="(?:"+at+"|"+ae+"|"+Lt+"|"+qt+"|"+ye+"|"+Te+")",pe="(?:"+Zt+"(?:"+Xt+"*"+Zt+")*)",ue="^\\s*(?:"+pe+"?)\\s*$",Fe=new RegExp(ue),Ke=new RegExp(Zt,"g");return function(oe){var ve=te.concat(),He=[];if(!oe||oe&&!Fe.test(oe))return ve;oe.replace(Ke,function(wi){var vi=new RegExp(Zt).exec(wi).filter(function(zi){return!!zi}),ce=vi[1],Ti=vi.slice(2).map(parseFloat);switch(ce){case"translate":jt(ve,Ti);break;case"rotate":Ti[0]=p.util.degreesToRadians(Ti[0]),pt(ve,Ti);break;case"scale":rt(ve,Ti);break;case"skewX":Mt(ve,Ti,2);break;case"skewY":Mt(ve,Ti,1);break;case"matrix":ve=Ti;break}He.push(ve.concat()),ve=te.concat()});for(var ci=He[0];He.length>1;)He.shift(),ci=p.util.multiplyTransformMatrices(ci,He[0]);return ci}}();function Jt(pt,rt){var Mt,jt;pt.replace(/;\s*$/,"").split(";").forEach(function(te){var Wt=te.split(":");Mt=Wt[0].trim().toLowerCase(),jt=Wt[1].trim(),rt[Mt]=jt})}function Qt(pt,rt){var Mt,jt;for(var te in pt)typeof pt[te]>"u"||(Mt=te.toLowerCase(),jt=pt[te],rt[Mt]=jt)}function he(pt,rt){var Mt={};for(var jt in p.cssRules[rt])if(ne(pt,jt.split(" ")))for(var te in p.cssRules[rt][jt])Mt[te]=p.cssRules[rt][jt][te];return Mt}function ne(pt,rt){var Mt,jt=!0;return Mt=Oe(pt,rt.pop()),Mt&&rt.length&&(jt=me(pt,rt)),Mt&&jt&&rt.length===0}function me(pt,rt){for(var Mt,jt=!0;pt.parentNode&&pt.parentNode.nodeType===1&&rt.length;)jt&&(Mt=rt.pop()),pt=pt.parentNode,jt=Oe(pt,Mt);return rt.length===0}function Oe(pt,rt){var Mt=pt.nodeName,jt=pt.getAttribute("class"),te=pt.getAttribute("id"),Wt,Xt;if(Wt=new RegExp("^"+Mt,"i"),rt=rt.replace(Wt,""),te&&rt.length&&(Wt=new RegExp("#"+te+"(?![a-zA-Z\\-]+)","i"),rt=rt.replace(Wt,"")),jt&&rt.length)for(jt=jt.split(" "),Xt=jt.length;Xt--;)Wt=new RegExp("\\."+jt[Xt]+"(?![a-zA-Z\\-]+)","i"),rt=rt.replace(Wt,"");return rt.length===0}function se(pt,rt){var Mt;if(pt.getElementById&&(Mt=pt.getElementById(rt)),Mt)return Mt;var jt,te,Wt,Xt=pt.getElementsByTagName("*");for(te=0,Wt=Xt.length;te<Wt;te++)if(jt=Xt[te],rt===jt.getAttribute("id"))return jt}function be(pt){for(var rt=Kt(pt,["use","svg:use"]),Mt=0;rt.length&&Mt<rt.length;){var jt=rt[Mt],te=jt.getAttribute("xlink:href")||jt.getAttribute("href");if(te===null)return;var Wt=te.slice(1),Xt=jt.getAttribute("x")||0,ye=jt.getAttribute("y")||0,Te=se(pt,Wt).cloneNode(!0),qt=(Te.getAttribute("transform")||"")+" translate("+Xt+", "+ye+")",Lt,ae=rt.length,at,Zt,pe,ue,Fe=p.svgNS;if(wt(Te),/^svg$/i.test(Te.nodeName)){var Ke=Te.ownerDocument.createElementNS(Fe,"g");for(Zt=0,pe=Te.attributes,ue=pe.length;Zt<ue;Zt++)at=pe.item(Zt),Ke.setAttributeNS(Fe,at.nodeName,at.nodeValue);for(;Te.firstChild;)Ke.appendChild(Te.firstChild);Te=Ke}for(Zt=0,pe=jt.attributes,ue=pe.length;Zt<ue;Zt++)at=pe.item(Zt),!(at.nodeName==="x"||at.nodeName==="y"||at.nodeName==="xlink:href"||at.nodeName==="href")&&(at.nodeName==="transform"?qt=at.nodeValue+" "+qt:Te.setAttribute(at.nodeName,at.nodeValue));Te.setAttribute("transform",qt),Te.setAttribute("instantiated_by_use","1"),Te.removeAttribute("id"),Lt=jt.parentNode,Lt.replaceChild(Te,jt),rt.length===ae&&Mt++}}var Q=new RegExp("^\\s*("+p.reNum+"+)\\s*,?\\s*("+p.reNum+"+)\\s*,?\\s*("+p.reNum+"+)\\s*,?\\s*("+p.reNum+"+)\\s*$");function wt(pt){if(!p.svgViewBoxElementsRegEx.test(pt.nodeName))return{};var rt=pt.getAttribute("viewBox"),Mt=1,jt=1,te=0,Wt=0,Xt,ye,Te,qt,Lt=pt.getAttribute("width"),ae=pt.getAttribute("height"),at=pt.getAttribute("x")||0,Zt=pt.getAttribute("y")||0,pe=pt.getAttribute("preserveAspectRatio")||"",ue=!rt||!(rt=rt.match(Q)),Fe=!Lt||!ae||Lt==="100%"||ae==="100%",Ke=ue&&Fe,oe={},ve="",He=0,ci=0;if(oe.width=0,oe.height=0,oe.toBeParsed=Ke,ue&&(at||Zt)&&pt.parentNode&&pt.parentNode.nodeName!=="#document"&&(ve=" translate("+c(at)+" "+c(Zt)+") ",Te=(pt.getAttribute("transform")||"")+ve,pt.setAttribute("transform",Te),pt.removeAttribute("x"),pt.removeAttribute("y")),Ke)return oe;if(ue)return oe.width=c(Lt),oe.height=c(ae),oe;if(te=-parseFloat(rt[1]),Wt=-parseFloat(rt[2]),Xt=parseFloat(rt[3]),ye=parseFloat(rt[4]),oe.minX=te,oe.minY=Wt,oe.viewBoxWidth=Xt,oe.viewBoxHeight=ye,Fe?(oe.width=Xt,oe.height=ye):(oe.width=c(Lt),oe.height=c(ae),Mt=oe.width/Xt,jt=oe.height/ye),pe=p.util.parsePreserveAspectRatioAttribute(pe),pe.alignX!=="none"&&(pe.meetOrSlice==="meet"&&(jt=Mt=Mt>jt?jt:Mt),pe.meetOrSlice==="slice"&&(jt=Mt=Mt>jt?Mt:jt),He=oe.width-Xt*Mt,ci=oe.height-ye*Mt,pe.alignX==="Mid"&&(He/=2),pe.alignY==="Mid"&&(ci/=2),pe.alignX==="Min"&&(He=0),pe.alignY==="Min"&&(ci=0)),Mt===1&&jt===1&&te===0&&Wt===0&&at===0&&Zt===0)return oe;if((at||Zt)&&pt.parentNode.nodeName!=="#document"&&(ve=" translate("+c(at)+" "+c(Zt)+") "),Te=ve+" matrix("+Mt+" 0 0 "+jt+" "+(te*Mt+He)+" "+(Wt*jt+ci)+") ",pt.nodeName==="svg"){for(qt=pt.ownerDocument.createElementNS(p.svgNS,"g");pt.firstChild;)qt.appendChild(pt.firstChild);pt.appendChild(qt)}else qt=pt,qt.removeAttribute("x"),qt.removeAttribute("y"),Te=qt.getAttribute("transform")+Te;return qt.setAttribute("transform",Te),oe}function gt(pt,rt){for(;pt&&(pt=pt.parentNode);)if(pt.nodeName&&rt.test(pt.nodeName.replace("svg:",""))&&!pt.getAttribute("instantiated_by_use"))return!0;return!1}p.parseSVGDocument=function(pt,rt,Mt,jt){if(pt){be(pt);var te=p.Object.__uid++,Wt,Xt,ye=wt(pt),Te=p.util.toArray(pt.getElementsByTagName("*"));if(ye.crossOrigin=jt&&jt.crossOrigin,ye.svgUid=te,Te.length===0&&p.isLikelyNode){Te=pt.selectNodes('//*[name(.)!="svg"]');var qt=[];for(Wt=0,Xt=Te.length;Wt<Xt;Wt++)qt[Wt]=Te[Wt];Te=qt}var Lt=Te.filter(function(at){return wt(at),p.svgValidTagNamesRegEx.test(at.nodeName.replace("svg:",""))&&!gt(at,p.svgInvalidAncestorsRegEx)});if(!Lt||Lt&&!Lt.length){rt&&rt([],{});return}var ae={};Te.filter(function(at){return at.nodeName.replace("svg:","")==="clipPath"}).forEach(function(at){var Zt=at.getAttribute("id");ae[Zt]=p.util.toArray(at.getElementsByTagName("*")).filter(function(pe){return p.svgValidTagNamesRegEx.test(pe.nodeName.replace("svg:",""))})}),p.gradientDefs[te]=p.getGradientDefs(pt),p.cssRules[te]=p.getCSSRules(pt),p.clipPaths[te]=ae,p.parseElements(Lt,function(at,Zt){rt&&(rt(at,ye,Zt,Te),delete p.gradientDefs[te],delete p.cssRules[te],delete p.clipPaths[te])},b(ye),Mt,jt)}};function vt(pt,rt){var Mt=["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"],jt="xlink:href",te=rt.getAttribute(jt).slice(1),Wt=se(pt,te);if(Wt&&Wt.getAttribute(jt)&&vt(pt,Wt),Mt.forEach(function(ye){Wt&&!rt.hasAttribute(ye)&&Wt.hasAttribute(ye)&&rt.setAttribute(ye,Wt.getAttribute(ye))}),!rt.children.length)for(var Xt=Wt.cloneNode(!0);Xt.firstChild;)rt.appendChild(Xt.firstChild);rt.removeAttribute(jt)}var Vt=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+p.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+p.reNum+"))?\\s+(.*)");C(p,{parseFontDeclaration:function(pt,rt){var Mt=pt.match(Vt);if(Mt){var jt=Mt[1],te=Mt[3],Wt=Mt[4],Xt=Mt[5],ye=Mt[6];jt&&(rt.fontStyle=jt),te&&(rt.fontWeight=isNaN(parseFloat(te))?te:parseFloat(te)),Wt&&(rt.fontSize=c(Wt)),ye&&(rt.fontFamily=ye),Xt&&(rt.lineHeight=Xt==="normal"?1:Xt)}},getGradientDefs:function(pt){var rt=["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"],Mt=Kt(pt,rt),jt,te=0,Wt={};for(te=Mt.length;te--;)jt=Mt[te],jt.getAttribute("xlink:href")&&vt(pt,jt),Wt[jt.getAttribute("id")]=jt;return Wt},parseAttributes:function(pt,rt,Mt){if(pt){var jt,te={},Wt,Xt;typeof Mt>"u"&&(Mt=pt.getAttribute("svgUid")),pt.parentNode&&p.svgValidParentsRegEx.test(pt.parentNode.nodeName)&&(te=p.parseAttributes(pt.parentNode,rt,Mt));var ye=rt.reduce(function(pe,ue){return jt=pt.getAttribute(ue),jt&&(pe[ue]=jt),pe},{}),Te=C(he(pt,Mt),p.parseStyleAttribute(pt));ye=C(ye,Te),Te[U]&&pt.setAttribute(U,Te[U]),Wt=Xt=te.fontSize||p.Text.DEFAULT_SVG_FONT_SIZE,ye[L]&&(ye[L]=Wt=c(ye[L],Xt));var qt,Lt,ae={};for(var at in ye)qt=$(at),Lt=nt(qt,ye[at],te,Wt),ae[qt]=Lt;ae&&ae.font&&p.parseFontDeclaration(ae.font,ae);var Zt=C(te,ae);return p.svgValidParentsRegEx.test(pt.nodeName)?Zt:Ft(Zt)}},parseElements:function(pt,rt,Mt,jt,te){new p.ElementsParser(pt,rt,Mt,jt,te).parse()},parseStyleAttribute:function(pt){var rt={},Mt=pt.getAttribute("style");return Mt&&(typeof Mt=="string"?Jt(Mt,rt):Qt(Mt,rt)),rt},parsePointsAttribute:function(pt){if(!pt)return null;pt=pt.replace(/,/g," ").trim(),pt=pt.split(/\s+/);var rt=[],Mt,jt;for(Mt=0,jt=pt.length;Mt<jt;Mt+=2)rt.push({x:parseFloat(pt[Mt]),y:parseFloat(pt[Mt+1])});return rt},getCSSRules:function(pt){var rt=pt.getElementsByTagName("style"),Mt,jt,te={},Wt;for(Mt=0,jt=rt.length;Mt<jt;Mt++){var Xt=rt[Mt].textContent;Xt=Xt.replace(/\/\*[\s\S]*?\*\//g,""),Xt.trim()!==""&&(Wt=Xt.split("}"),Wt=Wt.filter(function(ye){return ye.trim()}),Wt.forEach(function(ye){var Te=ye.split("{"),qt={},Lt=Te[1].trim(),ae=Lt.split(";").filter(function(ue){return ue.trim()});for(Mt=0,jt=ae.length;Mt<jt;Mt++){var at=ae[Mt].split(":"),Zt=at[0].trim(),pe=at[1].trim();qt[Zt]=pe}ye=Te[0].trim(),ye.split(",").forEach(function(ue){ue=ue.replace(/^svg/i,"").trim(),ue!==""&&(te[ue]?p.util.object.extend(te[ue],qt):te[ue]=p.util.object.clone(qt))})}))}return te},loadSVGFromURL:function(pt,rt,Mt,jt){pt=pt.replace(/^\n\s*/,"").trim(),new p.util.request(pt,{method:"get",onComplete:te});function te(Wt){var Xt=Wt.responseXML;if(!Xt||!Xt.documentElement)return rt&&rt(null),!1;p.parseSVGDocument(Xt.documentElement,function(ye,Te,qt,Lt){rt&&rt(ye,Te,qt,Lt)},Mt,jt)}},loadSVGFromString:function(pt,rt,Mt,jt){var te=new p.window.DOMParser,Wt=te.parseFromString(pt.trim(),"text/xml");p.parseSVGDocument(Wt.documentElement,function(Xt,ye,Te,qt){rt(Xt,ye,Te,qt)},Mt,jt)}})}(Z),S.ElementsParser=function(s,p,C,b,l,c){this.elements=s,this.callback=p,this.options=C,this.reviver=b,this.svgUid=C&&C.svgUid||0,this.parsingOptions=l,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=c},function(s){s.parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},s.createObjects=function(){var p=this;this.elements.forEach(function(C,b){C.setAttribute("svgUid",p.svgUid),p.createObject(C,b)})},s.findTag=function(p){return S[S.util.string.capitalize(p.tagName.replace("svg:",""))]},s.createObject=function(p,C){var b=this.findTag(p);if(b&&b.fromElement)try{b.fromElement(p,this.createCallback(C,p),this.options)}catch(l){S.log(l)}else this.checkIfDone()},s.createCallback=function(p,C){var b=this;return function(l){var c;b.resolveGradient(l,C,"fill"),b.resolveGradient(l,C,"stroke"),l instanceof S.Image&&l._originalElement&&(c=l.parsePreserveAspectRatioAttribute(C)),l._removeTransformMatrix(c),b.resolveClipPath(l,C),b.reviver&&b.reviver(C,l),b.instances[p]=l,b.checkIfDone()}},s.extractPropertyDefinition=function(p,C,b){var l=p[C],c=this.regexUrl;if(c.test(l)){c.lastIndex=0;var h=c.exec(l)[1];return c.lastIndex=0,S[b][this.svgUid][h]}},s.resolveGradient=function(p,C,b){var l=this.extractPropertyDefinition(p,b,"gradientDefs");if(l){var c=C.getAttribute(b+"-opacity"),h=S.Gradient.fromElement(l,p,c,this.options);p.set(b,h)}},s.createClipPathCallback=function(p,C){return function(b){b._removeTransformMatrix(),b.fillRule=b.clipRule,C.push(b)}},s.resolveClipPath=function(p,C){var b=this.extractPropertyDefinition(p,"clipPath","clipPaths"),l,c,h,m,g,d;if(b){m=[],h=S.util.invertTransform(p.calcTransformMatrix());for(var w=b[0].parentNode,E=C;E.parentNode&&E.getAttribute("clip-path")!==p.clipPath;)E=E.parentNode;E.parentNode.appendChild(w);for(var O=0;O<b.length;O++)l=b[O],c=this.findTag(l),c.fromElement(l,this.createClipPathCallback(p,m),this.options);m.length===1?b=m[0]:b=new S.Group(m),g=S.util.multiplyTransformMatrices(h,b.calcTransformMatrix()),b.clipPath&&this.resolveClipPath(b,E);var d=S.util.qrDecompose(g);b.flipX=!1,b.flipY=!1,b.set("scaleX",d.scaleX),b.set("scaleY",d.scaleY),b.angle=d.angle,b.skewX=d.skewX,b.skewY=0,b.setPositionByOrigin({x:d.translateX,y:d.translateY},"center","center"),p.clipPath=b}else delete p.clipPath},s.checkIfDone=function(){--this.numElements===0&&(this.instances=this.instances.filter(function(p){return p!=null}),this.callback(this.instances,this.elements))}}(S.ElementsParser.prototype),function(s){var p=s.fabric||(s.fabric={});if(p.Point){p.warn("fabric.Point is already defined");return}p.Point=C;function C(b,l){this.x=b,this.y=l}C.prototype={type:"point",constructor:C,add:function(b){return new C(this.x+b.x,this.y+b.y)},addEquals:function(b){return this.x+=b.x,this.y+=b.y,this},scalarAdd:function(b){return new C(this.x+b,this.y+b)},scalarAddEquals:function(b){return this.x+=b,this.y+=b,this},subtract:function(b){return new C(this.x-b.x,this.y-b.y)},subtractEquals:function(b){return this.x-=b.x,this.y-=b.y,this},scalarSubtract:function(b){return new C(this.x-b,this.y-b)},scalarSubtractEquals:function(b){return this.x-=b,this.y-=b,this},multiply:function(b){return new C(this.x*b,this.y*b)},multiplyEquals:function(b){return this.x*=b,this.y*=b,this},divide:function(b){return new C(this.x/b,this.y/b)},divideEquals:function(b){return this.x/=b,this.y/=b,this},eq:function(b){return this.x===b.x&&this.y===b.y},lt:function(b){return this.x<b.x&&this.y<b.y},lte:function(b){return this.x<=b.x&&this.y<=b.y},gt:function(b){return this.x>b.x&&this.y>b.y},gte:function(b){return this.x>=b.x&&this.y>=b.y},lerp:function(b,l){return typeof l>"u"&&(l=.5),l=Math.max(Math.min(1,l),0),new C(this.x+(b.x-this.x)*l,this.y+(b.y-this.y)*l)},distanceFrom:function(b){var l=this.x-b.x,c=this.y-b.y;return Math.sqrt(l*l+c*c)},midPointFrom:function(b){return this.lerp(b)},min:function(b){return new C(Math.min(this.x,b.x),Math.min(this.y,b.y))},max:function(b){return new C(Math.max(this.x,b.x),Math.max(this.y,b.y))},toString:function(){return this.x+","+this.y},setXY:function(b,l){return this.x=b,this.y=l,this},setX:function(b){return this.x=b,this},setY:function(b){return this.y=b,this},setFromPoint:function(b){return this.x=b.x,this.y=b.y,this},swap:function(b){var l=this.x,c=this.y;this.x=b.x,this.y=b.y,b.x=l,b.y=c},clone:function(){return new C(this.x,this.y)}}}(Z),function(s){var p=s.fabric||(s.fabric={});if(p.Intersection){p.warn("fabric.Intersection is already defined");return}function C(b){this.status=b,this.points=[]}p.Intersection=C,p.Intersection.prototype={constructor:C,appendPoint:function(b){return this.points.push(b),this},appendPoints:function(b){return this.points=this.points.concat(b),this}},p.Intersection.intersectLineLine=function(b,l,c,h){var m,g=(h.x-c.x)*(b.y-c.y)-(h.y-c.y)*(b.x-c.x),d=(l.x-b.x)*(b.y-c.y)-(l.y-b.y)*(b.x-c.x),w=(h.y-c.y)*(l.x-b.x)-(h.x-c.x)*(l.y-b.y);if(w!==0){var E=g/w,O=d/w;0<=E&&E<=1&&0<=O&&O<=1?(m=new C("Intersection"),m.appendPoint(new p.Point(b.x+E*(l.x-b.x),b.y+E*(l.y-b.y)))):m=new C}else g===0||d===0?m=new C("Coincident"):m=new C("Parallel");return m},p.Intersection.intersectLinePolygon=function(b,l,c){var h=new C,m=c.length,g,d,w,E;for(E=0;E<m;E++)g=c[E],d=c[(E+1)%m],w=C.intersectLineLine(b,l,g,d),h.appendPoints(w.points);return h.points.length>0&&(h.status="Intersection"),h},p.Intersection.intersectPolygonPolygon=function(b,l){var c=new C,h=b.length,m;for(m=0;m<h;m++){var g=b[m],d=b[(m+1)%h],w=C.intersectLinePolygon(g,d,l);c.appendPoints(w.points)}return c.points.length>0&&(c.status="Intersection"),c},p.Intersection.intersectPolygonRectangle=function(b,l,c){var h=l.min(c),m=l.max(c),g=new p.Point(m.x,h.y),d=new p.Point(h.x,m.y),w=C.intersectLinePolygon(h,g,b),E=C.intersectLinePolygon(g,m,b),O=C.intersectLinePolygon(m,d,b),L=C.intersectLinePolygon(d,h,b),U=new C;return U.appendPoints(w.points),U.appendPoints(E.points),U.appendPoints(O.points),U.appendPoints(L.points),U.points.length>0&&(U.status="Intersection"),U}}(Z),function(s){var p=s.fabric||(s.fabric={});if(p.Color){p.warn("fabric.Color is already defined.");return}function C(l){l?this._tryParsingColor(l):this.setSource([0,0,0,1])}p.Color=C,p.Color.prototype={_tryParsingColor:function(l){var c;l in C.colorNameMap&&(l=C.colorNameMap[l]),l==="transparent"&&(c=[255,255,255,0]),c||(c=C.sourceFromHex(l)),c||(c=C.sourceFromRgb(l)),c||(c=C.sourceFromHsl(l)),c||(c=[0,0,0,1]),c&&this.setSource(c)},_rgbToHsl:function(l,c,h){l/=255,c/=255,h/=255;var m,g,d,w=p.util.array.max([l,c,h]),E=p.util.array.min([l,c,h]);if(d=(w+E)/2,w===E)m=g=0;else{var O=w-E;switch(g=d>.5?O/(2-w-E):O/(w+E),w){case l:m=(c-h)/O+(c<h?6:0);break;case c:m=(h-l)/O+2;break;case h:m=(l-c)/O+4;break}m/=6}return[Math.round(m*360),Math.round(g*100),Math.round(d*100)]},getSource:function(){return this._source},setSource:function(l){this._source=l},toRgb:function(){var l=this.getSource();return"rgb("+l[0]+","+l[1]+","+l[2]+")"},toRgba:function(){var l=this.getSource();return"rgba("+l[0]+","+l[1]+","+l[2]+","+l[3]+")"},toHsl:function(){var l=this.getSource(),c=this._rgbToHsl(l[0],l[1],l[2]);return"hsl("+c[0]+","+c[1]+"%,"+c[2]+"%)"},toHsla:function(){var l=this.getSource(),c=this._rgbToHsl(l[0],l[1],l[2]);return"hsla("+c[0]+","+c[1]+"%,"+c[2]+"%,"+l[3]+")"},toHex:function(){var l=this.getSource(),c,h,m;return c=l[0].toString(16),c=c.length===1?"0"+c:c,h=l[1].toString(16),h=h.length===1?"0"+h:h,m=l[2].toString(16),m=m.length===1?"0"+m:m,c.toUpperCase()+h.toUpperCase()+m.toUpperCase()},toHexa:function(){var l=this.getSource(),c;return c=Math.round(l[3]*255),c=c.toString(16),c=c.length===1?"0"+c:c,this.toHex()+c.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(l){var c=this.getSource();return c[3]=l,this.setSource(c),this},toGrayscale:function(){var l=this.getSource(),c=parseInt((l[0]*.3+l[1]*.59+l[2]*.11).toFixed(0),10),h=l[3];return this.setSource([c,c,c,h]),this},toBlackWhite:function(l){var c=this.getSource(),h=(c[0]*.3+c[1]*.59+c[2]*.11).toFixed(0),m=c[3];return l=l||127,h=Number(h)<Number(l)?0:255,this.setSource([h,h,h,m]),this},overlayWith:function(l){l instanceof C||(l=new C(l));var c=[],h=this.getAlpha(),m=.5,g=this.getSource(),d=l.getSource(),w;for(w=0;w<3;w++)c.push(Math.round(g[w]*(1-m)+d[w]*m));return c[3]=h,this.setSource(c),this}},p.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,p.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,p.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,p.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"};function b(l,c,h){return h<0&&(h+=1),h>1&&(h-=1),h<1/6?l+(c-l)*6*h:h<1/2?c:h<2/3?l+(c-l)*(2/3-h)*6:l}p.Color.fromRgb=function(l){return C.fromSource(C.sourceFromRgb(l))},p.Color.sourceFromRgb=function(l){var c=l.match(C.reRGBa);if(c){var h=parseInt(c[1],10)/(/%$/.test(c[1])?100:1)*(/%$/.test(c[1])?255:1),m=parseInt(c[2],10)/(/%$/.test(c[2])?100:1)*(/%$/.test(c[2])?255:1),g=parseInt(c[3],10)/(/%$/.test(c[3])?100:1)*(/%$/.test(c[3])?255:1);return[parseInt(h,10),parseInt(m,10),parseInt(g,10),c[4]?parseFloat(c[4]):1]}},p.Color.fromRgba=C.fromRgb,p.Color.fromHsl=function(l){return C.fromSource(C.sourceFromHsl(l))},p.Color.sourceFromHsl=function(l){var c=l.match(C.reHSLa);if(c){var h=(parseFloat(c[1])%360+360)%360/360,m=parseFloat(c[2])/(/%$/.test(c[2])?100:1),g=parseFloat(c[3])/(/%$/.test(c[3])?100:1),d,w,E;if(m===0)d=w=E=g;else{var O=g<=.5?g*(m+1):g+m-g*m,L=g*2-O;d=b(L,O,h+1/3),w=b(L,O,h),E=b(L,O,h-1/3)}return[Math.round(d*255),Math.round(w*255),Math.round(E*255),c[4]?parseFloat(c[4]):1]}},p.Color.fromHsla=C.fromHsl,p.Color.fromHex=function(l){return C.fromSource(C.sourceFromHex(l))},p.Color.sourceFromHex=function(l){if(l.match(C.reHex)){var c=l.slice(l.indexOf("#")+1),h=c.length===3||c.length===4,m=c.length===8||c.length===4,g=h?c.charAt(0)+c.charAt(0):c.substring(0,2),d=h?c.charAt(1)+c.charAt(1):c.substring(2,4),w=h?c.charAt(2)+c.charAt(2):c.substring(4,6),E=m?h?c.charAt(3)+c.charAt(3):c.substring(6,8):"FF";return[parseInt(g,16),parseInt(d,16),parseInt(w,16),parseFloat((parseInt(E,16)/255).toFixed(2))]}},p.Color.fromSource=function(l){var c=new C;return c.setSource(l),c}}(Z),function(s){var p=s.fabric||(s.fabric={}),C=["e","se","s","sw","w","nw","n","ne","e"],b=["ns","nesw","ew","nwse"],l={},c="left",h="top",m="right",g="bottom",d="center",w={top:g,bottom:h,left:m,right:c,center:d},E=p.util.radiansToDegrees,O=Math.sign||function(qt){return(qt>0)-(qt<0)||+qt};function L(qt,Lt){var ae=qt.angle+E(Math.atan2(Lt.y,Lt.x))+360;return Math.round(ae%360/45)}function U(qt,Lt){var ae=Lt.transform.target,at=ae.canvas,Zt=p.util.object.clone(Lt);Zt.target=ae,at&&at.fire("object:"+qt,Zt),ae.fire(qt,Lt)}function $(qt,Lt){var ae=Lt.canvas,at=ae.uniScaleKey,Zt=qt[at];return ae.uniformScaling&&!Zt||!ae.uniformScaling&&Zt}function nt(qt){return qt.originX===d&&qt.originY===d}function xt(qt,Lt,ae){var at=qt.lockScalingX,Zt=qt.lockScalingY;return!!(at&&Zt||!Lt&&(at||Zt)&&ae||at&&Lt==="x"||Zt&&Lt==="y")}function Ft(qt,Lt,ae){var at="not-allowed",Zt=$(qt,ae),pe="";if(Lt.x!==0&&Lt.y===0?pe="x":Lt.x===0&&Lt.y!==0&&(pe="y"),xt(ae,pe,Zt))return at;var ue=L(ae,Lt);return C[ue]+"-resize"}function Kt(qt,Lt,ae){var at="not-allowed";if(Lt.x!==0&&ae.lockSkewingY||Lt.y!==0&&ae.lockSkewingX)return at;var Zt=L(ae,Lt)%4;return b[Zt]+"-resize"}function Jt(qt,Lt,ae){return qt[ae.canvas.altActionKey]?l.skewCursorStyleHandler(qt,Lt,ae):l.scaleCursorStyleHandler(qt,Lt,ae)}function Qt(qt,Lt,ae){var at=qt[ae.canvas.altActionKey];if(Lt.x===0)return at?"skewX":"scaleY";if(Lt.y===0)return at?"skewY":"scaleX"}function he(qt,Lt,ae){return ae.lockRotation?"not-allowed":Lt.cursorStyle}function ne(qt,Lt,ae,at){return{e:qt,transform:Lt,pointer:{x:ae,y:at}}}function me(qt){return function(Lt,ae,at,Zt){var pe=ae.target,ue=pe.getCenterPoint(),Fe=pe.translateToOriginPoint(ue,ae.originX,ae.originY),Ke=qt(Lt,ae,at,Zt);return pe.setPositionByOrigin(Fe,ae.originX,ae.originY),Ke}}function Oe(qt,Lt){return function(ae,at,Zt,pe){var ue=Lt(ae,at,Zt,pe);return ue&&U(qt,ne(ae,at,Zt,pe)),ue}}function se(qt,Lt,ae,at,Zt){var pe=qt.target,ue=pe.controls[qt.corner],Fe=pe.canvas.getZoom(),Ke=pe.padding/Fe,oe=pe.toLocalPoint(new p.Point(at,Zt),Lt,ae);return oe.x>=Ke&&(oe.x-=Ke),oe.x<=-Ke&&(oe.x+=Ke),oe.y>=Ke&&(oe.y-=Ke),oe.y<=Ke&&(oe.y+=Ke),oe.x-=ue.offsetX,oe.y-=ue.offsetY,oe}function be(qt){return qt.flipX!==qt.flipY}function Q(qt,Lt,ae,at,Zt){if(qt[Lt]!==0){var pe=qt._getTransformedDimensions()[at],ue=Zt/pe*qt[ae];qt.set(ae,ue)}}function wt(qt,Lt,ae,at){var Zt=Lt.target,pe=Zt._getTransformedDimensions(0,Zt.skewY),ue=se(Lt,Lt.originX,Lt.originY,ae,at),Fe=Math.abs(ue.x*2)-pe.x,Ke=Zt.skewX,oe;Fe<2?oe=0:(oe=E(Math.atan2(Fe/Zt.scaleX,pe.y/Zt.scaleY)),Lt.originX===c&&Lt.originY===g&&(oe=-oe),Lt.originX===m&&Lt.originY===h&&(oe=-oe),be(Zt)&&(oe=-oe));var ve=Ke!==oe;if(ve){var He=Zt._getTransformedDimensions().y;Zt.set("skewX",oe),Q(Zt,"skewY","scaleY","y",He)}return ve}function gt(qt,Lt,ae,at){var Zt=Lt.target,pe=Zt._getTransformedDimensions(Zt.skewX,0),ue=se(Lt,Lt.originX,Lt.originY,ae,at),Fe=Math.abs(ue.y*2)-pe.y,Ke=Zt.skewY,oe;Fe<2?oe=0:(oe=E(Math.atan2(Fe/Zt.scaleY,pe.x/Zt.scaleX)),Lt.originX===c&&Lt.originY===g&&(oe=-oe),Lt.originX===m&&Lt.originY===h&&(oe=-oe),be(Zt)&&(oe=-oe));var ve=Ke!==oe;if(ve){var He=Zt._getTransformedDimensions().x;Zt.set("skewY",oe),Q(Zt,"skewX","scaleX","x",He)}return ve}function vt(qt,Lt,ae,at){var Zt=Lt.target,pe=Zt.skewX,ue,Fe=Lt.originY;if(Zt.lockSkewingX)return!1;if(pe===0){var Ke=se(Lt,d,d,ae,at);Ke.x>0?ue=c:ue=m}else pe>0&&(ue=Fe===h?c:m),pe<0&&(ue=Fe===h?m:c),be(Zt)&&(ue=ue===c?m:c);Lt.originX=ue;var oe=Oe("skewing",me(wt));return oe(qt,Lt,ae,at)}function Vt(qt,Lt,ae,at){var Zt=Lt.target,pe=Zt.skewY,ue,Fe=Lt.originX;if(Zt.lockSkewingY)return!1;if(pe===0){var Ke=se(Lt,d,d,ae,at);Ke.y>0?ue=h:ue=g}else pe>0&&(ue=Fe===c?h:g),pe<0&&(ue=Fe===c?g:h),be(Zt)&&(ue=ue===h?g:h);Lt.originY=ue;var oe=Oe("skewing",me(gt));return oe(qt,Lt,ae,at)}function pt(qt,Lt,ae,at){var Zt=Lt,pe=Zt.target,ue=pe.translateToOriginPoint(pe.getCenterPoint(),Zt.originX,Zt.originY);if(pe.lockRotation)return!1;var Fe=Math.atan2(Zt.ey-ue.y,Zt.ex-ue.x),Ke=Math.atan2(at-ue.y,ae-ue.x),oe=E(Ke-Fe+Zt.theta),ve=!0;if(pe.snapAngle>0){var He=pe.snapAngle,ci=pe.snapThreshold||He,wi=Math.ceil(oe/He)*He,vi=Math.floor(oe/He)*He;Math.abs(oe-vi)<ci?oe=vi:Math.abs(oe-wi)<ci&&(oe=wi)}return oe<0&&(oe=360+oe),oe%=360,ve=pe.angle!==oe,pe.angle=oe,ve}function rt(qt,Lt,ae,at,Zt){Zt=Zt||{};var pe=Lt.target,ue=pe.lockScalingX,Fe=pe.lockScalingY,Ke=Zt.by,oe,ve,He,ci,wi=$(qt,pe),vi=xt(pe,Ke,wi),ce,Ti,zi=Lt.gestureScale;if(vi)return!1;if(zi)ve=Lt.scaleX*zi,He=Lt.scaleY*zi;else{if(oe=se(Lt,Lt.originX,Lt.originY,ae,at),ce=Ke!=="y"?O(oe.x):1,Ti=Ke!=="x"?O(oe.y):1,Lt.signX||(Lt.signX=ce),Lt.signY||(Lt.signY=Ti),pe.lockScalingFlip&&(Lt.signX!==ce||Lt.signY!==Ti))return!1;if(ci=pe._getTransformedDimensions(),wi&&!Ke){var nr=Math.abs(oe.x)+Math.abs(oe.y),Yi=Lt.original,Ee=Math.abs(ci.x*Yi.scaleX/pe.scaleX)+Math.abs(ci.y*Yi.scaleY/pe.scaleY),ui=nr/Ee;ve=Yi.scaleX*ui,He=Yi.scaleY*ui}else ve=Math.abs(oe.x*pe.scaleX/ci.x),He=Math.abs(oe.y*pe.scaleY/ci.y);nt(Lt)&&(ve*=2,He*=2),Lt.signX!==ce&&Ke!=="y"&&(Lt.originX=w[Lt.originX],ve*=-1,Lt.signX=ce),Lt.signY!==Ti&&Ke!=="x"&&(Lt.originY=w[Lt.originY],He*=-1,Lt.signY=Ti)}var $e=pe.scaleX,Zi=pe.scaleY;return Ke?(Ke==="x"&&pe.set("scaleX",ve),Ke==="y"&&pe.set("scaleY",He)):(!ue&&pe.set("scaleX",ve),!Fe&&pe.set("scaleY",He)),$e!==pe.scaleX||Zi!==pe.scaleY}function Mt(qt,Lt,ae,at){return rt(qt,Lt,ae,at)}function jt(qt,Lt,ae,at){return rt(qt,Lt,ae,at,{by:"x"})}function te(qt,Lt,ae,at){return rt(qt,Lt,ae,at,{by:"y"})}function Wt(qt,Lt,ae,at){return qt[Lt.target.canvas.altActionKey]?l.skewHandlerX(qt,Lt,ae,at):l.scalingY(qt,Lt,ae,at)}function Xt(qt,Lt,ae,at){return qt[Lt.target.canvas.altActionKey]?l.skewHandlerY(qt,Lt,ae,at):l.scalingX(qt,Lt,ae,at)}function ye(qt,Lt,ae,at){var Zt=Lt.target,pe=se(Lt,Lt.originX,Lt.originY,ae,at),ue=Zt.strokeWidth/(Zt.strokeUniform?Zt.scaleX:1),Fe=nt(Lt)?2:1,Ke=Zt.width,oe=Math.abs(pe.x*Fe/Zt.scaleX)-ue;return Zt.set("width",Math.max(oe,0)),Ke!==oe}function Te(qt,Lt,ae,at){var Zt=Lt.target,pe=ae-Lt.offsetX,ue=at-Lt.offsetY,Fe=!Zt.get("lockMovementX")&&Zt.left!==pe,Ke=!Zt.get("lockMovementY")&&Zt.top!==ue;return Fe&&Zt.set("left",pe),Ke&&Zt.set("top",ue),(Fe||Ke)&&U("moving",ne(qt,Lt,ae,at)),Fe||Ke}l.scaleCursorStyleHandler=Ft,l.skewCursorStyleHandler=Kt,l.scaleSkewCursorStyleHandler=Jt,l.rotationWithSnapping=Oe("rotating",me(pt)),l.scalingEqually=Oe("scaling",me(Mt)),l.scalingX=Oe("scaling",me(jt)),l.scalingY=Oe("scaling",me(te)),l.scalingYOrSkewingX=Wt,l.scalingXOrSkewingY=Xt,l.changeWidth=Oe("resizing",me(ye)),l.skewHandlerX=vt,l.skewHandlerY=Vt,l.dragHandler=Te,l.scaleOrSkewActionName=Qt,l.rotationStyleHandler=he,l.fireEvent=U,l.wrapWithFixedAnchor=me,l.wrapWithFireEvent=Oe,l.getLocalPoint=se,p.controlsUtils=l}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.util.degreesToRadians,b=p.controlsUtils;function l(h,m,g,d,w){d=d||{};var E=this.sizeX||d.cornerSize||w.cornerSize,O=this.sizeY||d.cornerSize||w.cornerSize,L=typeof d.transparentCorners<"u"?d.transparentCorners:w.transparentCorners,U=L?"stroke":"fill",$=!L&&(d.cornerStrokeColor||w.cornerStrokeColor),nt=m,xt=g,Ft;h.save(),h.fillStyle=d.cornerColor||w.cornerColor,h.strokeStyle=d.cornerStrokeColor||w.cornerStrokeColor,E>O?(Ft=E,h.scale(1,O/E),xt=g*E/O):O>E?(Ft=O,h.scale(E/O,1),nt=m*O/E):Ft=E,h.lineWidth=1,h.beginPath(),h.arc(nt,xt,Ft/2,0,2*Math.PI,!1),h[U](),$&&h.stroke(),h.restore()}function c(h,m,g,d,w){d=d||{};var E=this.sizeX||d.cornerSize||w.cornerSize,O=this.sizeY||d.cornerSize||w.cornerSize,L=typeof d.transparentCorners<"u"?d.transparentCorners:w.transparentCorners,U=L?"stroke":"fill",$=!L&&(d.cornerStrokeColor||w.cornerStrokeColor),nt=E/2,xt=O/2;h.save(),h.fillStyle=d.cornerColor||w.cornerColor,h.strokeStyle=d.cornerStrokeColor||w.cornerStrokeColor,h.lineWidth=1,h.translate(m,g),h.rotate(C(w.angle)),h[U+"Rect"](-nt,-xt,E,O),$&&h.strokeRect(-nt,-xt,E,O),h.restore()}b.renderCircleControl=l,b.renderSquareControl=c}(Z),function(s){var p=s.fabric||(s.fabric={});function C(b){for(var l in b)this[l]=b[l]}p.Control=C,p.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(b,l){return l.cursorStyle},getActionName:function(b,l){return l.actionName},getVisibility:function(b,l){var c=b._controlsVisibility;return c&&typeof c[l]<"u"?c[l]:this.visible},setVisibility:function(b){this.visible=b},positionHandler:function(b,l){var c=p.util.transformPoint({x:this.x*b.x+this.offsetX,y:this.y*b.y+this.offsetY},l);return c},calcCornerCoords:function(b,l,c,h,m){var g,d,w,E,O=m?this.touchSizeX:this.sizeX,L=m?this.touchSizeY:this.sizeY;if(O&&L&&O!==L){var U=Math.atan2(L,O),$=Math.sqrt(O*O+L*L)/2,nt=U-p.util.degreesToRadians(b),xt=Math.PI/2-U-p.util.degreesToRadians(b);g=$*p.util.cos(nt),d=$*p.util.sin(nt),w=$*p.util.cos(xt),E=$*p.util.sin(xt)}else{var Ft=O&&L?O:l;$=Ft*.7071067812;var nt=p.util.degreesToRadians(45-b);g=w=$*p.util.cos(nt),d=E=$*p.util.sin(nt)}return{tl:{x:c-E,y:h-w},tr:{x:c+g,y:h-d},bl:{x:c-g,y:h+d},br:{x:c+E,y:h+w}}},render:function(b,l,c,h,m){switch(h=h||{},h.cornerStyle||m.cornerStyle){case"circle":p.controlsUtils.renderCircleControl.call(this,b,l,c,h,m);break;default:p.controlsUtils.renderSquareControl.call(this,b,l,c,h,m)}}}}(Z),function(){function s(c,h){var m=c.getAttribute("style"),g=c.getAttribute("offset")||0,d,w,E,O;if(g=parseFloat(g)/(/%$/.test(g)?100:1),g=g<0?0:g>1?1:g,m){var L=m.split(/\s*;\s*/);for(L[L.length-1]===""&&L.pop(),O=L.length;O--;){var U=L[O].split(/\s*:\s*/),$=U[0].trim(),nt=U[1].trim();$==="stop-color"?d=nt:$==="stop-opacity"&&(E=nt)}}return d||(d=c.getAttribute("stop-color")||"rgb(0,0,0)"),E||(E=c.getAttribute("stop-opacity")),d=new S.Color(d),w=d.getAlpha(),E=isNaN(parseFloat(E))?1:parseFloat(E),E*=w*h,{offset:g,color:d.toRgb(),opacity:E}}function p(c){return{x1:c.getAttribute("x1")||0,y1:c.getAttribute("y1")||0,x2:c.getAttribute("x2")||"100%",y2:c.getAttribute("y2")||0}}function C(c){return{x1:c.getAttribute("fx")||c.getAttribute("cx")||"50%",y1:c.getAttribute("fy")||c.getAttribute("cy")||"50%",r1:0,x2:c.getAttribute("cx")||"50%",y2:c.getAttribute("cy")||"50%",r2:c.getAttribute("r")||"50%"}}var b=S.util.object.clone;S.Gradient=S.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(c){c||(c={}),c.coords||(c.coords={});var h,m=this;Object.keys(c).forEach(function(g){m[g]=c[g]}),this.id?this.id+="_"+S.Object.__uid++:this.id=S.Object.__uid++,h={x1:c.coords.x1||0,y1:c.coords.y1||0,x2:c.coords.x2||0,y2:c.coords.y2||0},this.type==="radial"&&(h.r1=c.coords.r1||0,h.r2=c.coords.r2||0),this.coords=h,this.colorStops=c.colorStops.slice()},addColorStop:function(c){for(var h in c){var m=new S.Color(c[h]);this.colorStops.push({offset:parseFloat(h),color:m.toRgb(),opacity:m.getAlpha()})}return this},toObject:function(c){var h={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return S.util.populateWithProperties(this,h,c),h},toSVG:function(c,w){var m=b(this.coords,!0),g,d,w=w||{},E,O,L=b(this.colorStops,!0),U=m.r1>m.r2,$=this.gradientTransform?this.gradientTransform.concat():S.iMatrix.concat(),nt=-this.offsetX,xt=-this.offsetY,Ft=!!w.additionalTransform,Kt=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox";if(L.sort(function(me,Oe){return me.offset-Oe.offset}),Kt==="objectBoundingBox"?(nt/=c.width,xt/=c.height):(nt+=c.width/2,xt+=c.height/2),c.type==="path"&&this.gradientUnits!=="percentage"&&(nt-=c.pathOffset.x,xt-=c.pathOffset.y),$[4]-=nt,$[5]-=xt,O='id="SVGID_'+this.id+'" gradientUnits="'+Kt+'"',O+=' gradientTransform="'+(Ft?w.additionalTransform+" ":"")+S.util.matrixToSVG($)+'" ',this.type==="linear"?E=["<linearGradient ",O,' x1="',m.x1,'" y1="',m.y1,'" x2="',m.x2,'" y2="',m.y2,`">
`]:this.type==="radial"&&(E=["<radialGradient ",O,' cx="',U?m.x1:m.x2,'" cy="',U?m.y1:m.y2,'" r="',U?m.r1:m.r2,'" fx="',U?m.x2:m.x1,'" fy="',U?m.y2:m.y1,`">
`]),this.type==="radial"){if(U)for(L=L.concat(),L.reverse(),g=0,d=L.length;g<d;g++)L[g].offset=1-L[g].offset;var Jt=Math.min(m.r1,m.r2);if(Jt>0){var Qt=Math.max(m.r1,m.r2),he=Jt/Qt;for(g=0,d=L.length;g<d;g++)L[g].offset+=he*(1-L[g].offset)}}for(g=0,d=L.length;g<d;g++){var ne=L[g];E.push("<stop ",'offset="',ne.offset*100+"%",'" style="stop-color:',ne.color,typeof ne.opacity<"u"?";stop-opacity: "+ne.opacity:";",`"/>
`)}return E.push(this.type==="linear"?`</linearGradient>
`:`</radialGradient>
`),E.join("")},toLive:function(c){var h,m=S.util.object.clone(this.coords),g,d;if(this.type){for(this.type==="linear"?h=c.createLinearGradient(m.x1,m.y1,m.x2,m.y2):this.type==="radial"&&(h=c.createRadialGradient(m.x1,m.y1,m.r1,m.x2,m.y2,m.r2)),g=0,d=this.colorStops.length;g<d;g++){var w=this.colorStops[g].color,E=this.colorStops[g].opacity,O=this.colorStops[g].offset;typeof E<"u"&&(w=new S.Color(w).setAlpha(E).toRgba()),h.addColorStop(O,w)}return h}}}),S.util.object.extend(S.Gradient,{fromElement:function(c,h,m,g){var d=parseFloat(m)/(/%$/.test(m)?100:1);d=d<0?0:d>1?1:d,isNaN(d)&&(d=1);var w=c.getElementsByTagName("stop"),E,O=c.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage",L=c.getAttribute("gradientTransform")||"",U=[],$,nt,xt=0,Ft=0,Kt;for(c.nodeName==="linearGradient"||c.nodeName==="LINEARGRADIENT"?(E="linear",$=p(c)):(E="radial",$=C(c)),nt=w.length;nt--;)U.push(s(w[nt],d));Kt=S.parseTransformAttribute(L),l(h,$,g,O),O==="pixels"&&(xt=-h.left,Ft=-h.top);var Jt=new S.Gradient({id:c.getAttribute("id"),type:E,coords:$,colorStops:U,gradientUnits:O,gradientTransform:Kt,offsetX:xt,offsetY:Ft});return Jt}});function l(c,h,m,g){var d,w;Object.keys(h).forEach(function(E){d=h[E],d==="Infinity"?w=1:d==="-Infinity"?w=0:(w=parseFloat(h[E],10),typeof d=="string"&&/^(\d+\.\d+)%|(\d+)%$/.test(d)&&(w*=.01,g==="pixels"&&((E==="x1"||E==="x2"||E==="r2")&&(w*=m.viewBoxWidth||m.width),(E==="y1"||E==="y2")&&(w*=m.viewBoxHeight||m.height)))),h[E]=w})}}(),function(){var s=S.util.toFixed;S.Pattern=S.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(p,C){if(p||(p={}),this.id=S.Object.__uid++,this.setOptions(p),!p.source||p.source&&typeof p.source!="string"){C&&C(this);return}else{var b=this;this.source=S.util.createImage(),S.util.loadImage(p.source,function(l,c){b.source=l,C&&C(b,c)},null,this.crossOrigin)}},toObject:function(p){var C=S.Object.NUM_FRACTION_DIGITS,b,l;return typeof this.source.src=="string"?b=this.source.src:typeof this.source=="object"&&this.source.toDataURL&&(b=this.source.toDataURL()),l={type:"pattern",source:b,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:s(this.offsetX,C),offsetY:s(this.offsetY,C),patternTransform:this.patternTransform?this.patternTransform.concat():null},S.util.populateWithProperties(this,l,p),l},toSVG:function(p){var C=typeof this.source=="function"?this.source():this.source,b=C.width/p.width,l=C.height/p.height,c=this.offsetX/p.width,h=this.offsetY/p.height,m="";return(this.repeat==="repeat-x"||this.repeat==="no-repeat")&&(l=1,h&&(l+=Math.abs(h))),(this.repeat==="repeat-y"||this.repeat==="no-repeat")&&(b=1,c&&(b+=Math.abs(c))),C.src?m=C.src:C.toDataURL&&(m=C.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+c+'" y="'+h+'" width="'+b+'" height="'+l+`">
<image x="0" y="0" width="`+C.width+'" height="'+C.height+'" xlink:href="'+m+`"></image>
</pattern>
`},setOptions:function(p){for(var C in p)this[C]=p[C]},toLive:function(p){var C=this.source;return!C||typeof C.src<"u"&&(!C.complete||C.naturalWidth===0||C.naturalHeight===0)?"":p.createPattern(C,this.repeat)}})}(),function(s){var p=s.fabric||(s.fabric={}),C=p.util.toFixed;if(p.Shadow){p.warn("fabric.Shadow is already defined.");return}p.Shadow=p.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(b){typeof b=="string"&&(b=this._parseShadow(b));for(var l in b)this[l]=b[l];this.id=p.Object.__uid++},_parseShadow:function(b){var l=b.trim(),c=p.Shadow.reOffsetsAndBlur.exec(l)||[],h=l.replace(p.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)";return{color:h.trim(),offsetX:parseFloat(c[1],10)||0,offsetY:parseFloat(c[2],10)||0,blur:parseFloat(c[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(b){var l=40,c=40,h=p.Object.NUM_FRACTION_DIGITS,m=p.util.rotateVector({x:this.offsetX,y:this.offsetY},p.util.degreesToRadians(-b.angle)),g=20,d=new p.Color(this.color);return b.width&&b.height&&(l=C((Math.abs(m.x)+this.blur)/b.width,h)*100+g,c=C((Math.abs(m.y)+this.blur)/b.height,h)*100+g),b.flipX&&(m.x*=-1),b.flipY&&(m.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+c+'%" height="'+(100+2*c)+'%" x="-'+l+'%" width="'+(100+2*l)+`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`+C(this.blur?this.blur/2:0,h)+`"></feGaussianBlur>
	<feOffset dx="`+C(m.x,h)+'" dy="'+C(m.y,h)+`" result="oBlur" ></feOffset>
	<feFlood flood-color="`+d.toRgb()+'" flood-opacity="'+d.getAlpha()+`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var b={},l=p.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(c){this[c]!==l[c]&&(b[c]=this[c])},this),b}}),p.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/}(Z),function(){if(S.StaticCanvas){S.warn("fabric.StaticCanvas is already defined.");return}var s=S.util.object.extend,p=S.util.getElementOffset,C=S.util.removeFromArray,b=S.util.toFixed,l=S.util.transformPoint,c=S.util.invertTransform,h=S.util.getNodeCanvas,m=S.util.createCanvasElement,g=new Error("Could not initialize `canvas` element");S.StaticCanvas=S.util.createClass(S.CommonMethods,{initialize:function(d,w){w||(w={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(d,w)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:S.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(d,w){var E=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(d),this._initOptions(w),this.interactive||this._initRetinaScaling(),w.overlayImage&&this.setOverlayImage(w.overlayImage,E),w.backgroundImage&&this.setBackgroundImage(w.backgroundImage,E),w.backgroundColor&&this.setBackgroundColor(w.backgroundColor,E),w.overlayColor&&this.setOverlayColor(w.overlayColor,E),this.calcOffset()},_isRetinaScaling:function(){return S.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,S.devicePixelRatio):1},_initRetinaScaling:function(){if(this._isRetinaScaling()){var d=S.devicePixelRatio;this.__initRetinaScaling(d,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(d,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(d,w,E){w.setAttribute("width",this.width*d),w.setAttribute("height",this.height*d),E.scale(d,d)},calcOffset:function(){return this._offset=p(this.lowerCanvasEl),this},setOverlayImage:function(d,w,E){return this.__setBgOverlayImage("overlayImage",d,w,E)},setBackgroundImage:function(d,w,E){return this.__setBgOverlayImage("backgroundImage",d,w,E)},setOverlayColor:function(d,w){return this.__setBgOverlayColor("overlayColor",d,w)},setBackgroundColor:function(d,w){return this.__setBgOverlayColor("backgroundColor",d,w)},__setBgOverlayImage:function(d,w,E,O){return typeof w=="string"?S.util.loadImage(w,function(L,U){if(L){var $=new S.Image(L,O);this[d]=$,$.canvas=this}E&&E(L,U)},this,O&&O.crossOrigin):(O&&w.setOptions(O),this[d]=w,w&&(w.canvas=this),E&&E(w,!1)),this},__setBgOverlayColor:function(d,w,E){return this[d]=w,this._initGradient(w,d),this._initPattern(w,d,E),this},_createCanvasElement:function(){var d=m();if(!d||(d.style||(d.style={}),typeof d.getContext>"u"))throw g;return d},_initOptions:function(d){var w=this.lowerCanvasEl;this._setOptions(d),this.width=this.width||parseInt(w.width,10)||0,this.height=this.height||parseInt(w.height,10)||0,this.lowerCanvasEl.style&&(w.width=this.width,w.height=this.height,w.style.width=this.width+"px",w.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(d){d&&d.getContext?this.lowerCanvasEl=d:this.lowerCanvasEl=S.util.getById(d)||this._createCanvasElement(),S.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(d,w){return this.setDimensions({width:d},w)},setHeight:function(d,w){return this.setDimensions({height:d},w)},setDimensions:function(d,w){var E;w=w||{};for(var O in d)E=d[O],w.cssOnly||(this._setBackstoreDimension(O,d[O]),E+="px",this.hasLostContext=!0),w.backstoreOnly||this._setCssDimension(O,E);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),w.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(d,w){return this.lowerCanvasEl[d]=w,this.upperCanvasEl&&(this.upperCanvasEl[d]=w),this.cacheCanvasEl&&(this.cacheCanvasEl[d]=w),this[d]=w,this},_setCssDimension:function(d,w){return this.lowerCanvasEl.style[d]=w,this.upperCanvasEl&&(this.upperCanvasEl.style[d]=w),this.wrapperEl&&(this.wrapperEl.style[d]=w),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(d){var w=this._activeObject,E=this.backgroundImage,O=this.overlayImage,L,U,$;for(this.viewportTransform=d,U=0,$=this._objects.length;U<$;U++)L=this._objects[U],L.group||L.setCoords(!0);return w&&w.setCoords(),E&&E.setCoords(!0),O&&O.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(d,w){var E=d,O=this.viewportTransform.slice(0);d=l(d,c(this.viewportTransform)),O[0]=w,O[3]=w;var L=l(d,O);return O[4]+=E.x-L.x,O[5]+=E.y-L.y,this.setViewportTransform(O)},setZoom:function(d){return this.zoomToPoint(new S.Point(0,0),d),this},absolutePan:function(d){var w=this.viewportTransform.slice(0);return w[4]=-d.x,w[5]=-d.y,this.setViewportTransform(w)},relativePan:function(d){return this.absolutePan(new S.Point(-d.x-this.viewportTransform[4],-d.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(d){this.stateful&&d.setupState(),d._set("canvas",this),d.setCoords(),this.fire("object:added",{target:d}),d.fire("added")},_onObjectRemoved:function(d){this.fire("object:removed",{target:d}),d.fire("removed"),delete d.canvas},clearContext:function(d){return d.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var d=this.contextContainer;return this.renderCanvas(d,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=S.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var d={},w=this.width,E=this.height,O=c(this.viewportTransform);return d.tl=l({x:0,y:0},O),d.br=l({x:w,y:E},O),d.tr=new S.Point(d.br.x,d.tl.y),d.bl=new S.Point(d.tl.x,d.br.y),this.vptCoords=d,d},cancelRequestedRender:function(){this.isRendering&&(S.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(d,w){var E=this.viewportTransform,O=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(d),S.util.setImageSmoothing(d,this.imageSmoothingEnabled),this.fire("before:render",{ctx:d}),this._renderBackground(d),d.save(),d.transform(E[0],E[1],E[2],E[3],E[4],E[5]),this._renderObjects(d,w),d.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(d),O&&(O.canvas=this,O.shouldCache(),O._transformDone=!0,O.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(d)),this._renderOverlay(d),this.controlsAboveOverlay&&this.interactive&&this.drawControls(d),this.fire("after:render",{ctx:d})},drawClipPathOnCanvas:function(d){var w=this.viewportTransform,E=this.clipPath;d.save(),d.transform(w[0],w[1],w[2],w[3],w[4],w[5]),d.globalCompositeOperation="destination-in",E.transform(d),d.scale(1/E.zoomX,1/E.zoomY),d.drawImage(E._cacheCanvas,-E.cacheTranslationX,-E.cacheTranslationY),d.restore()},_renderObjects:function(d,w){var E,O;for(E=0,O=w.length;E<O;++E)w[E]&&w[E].render(d)},_renderBackgroundOrOverlay:function(d,w){var E=this[w+"Color"],O=this[w+"Image"],L=this.viewportTransform,U=this[w+"Vpt"];if(!(!E&&!O)){if(E){d.save(),d.beginPath(),d.moveTo(0,0),d.lineTo(this.width,0),d.lineTo(this.width,this.height),d.lineTo(0,this.height),d.closePath(),d.fillStyle=E.toLive?E.toLive(d,this):E,U&&d.transform(L[0],L[1],L[2],L[3],L[4],L[5]),d.transform(1,0,0,1,E.offsetX||0,E.offsetY||0);var $=E.gradientTransform||E.patternTransform;$&&d.transform($[0],$[1],$[2],$[3],$[4],$[5]),d.fill(),d.restore()}O&&(d.save(),U&&d.transform(L[0],L[1],L[2],L[3],L[4],L[5]),O.render(d),d.restore())}},_renderBackground:function(d){this._renderBackgroundOrOverlay(d,"background")},_renderOverlay:function(d){this._renderBackgroundOrOverlay(d,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new S.Point(this.width/2,this.height/2)},centerObjectH:function(d){return this._centerObject(d,new S.Point(this.getCenterPoint().x,d.getCenterPoint().y))},centerObjectV:function(d){return this._centerObject(d,new S.Point(d.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(d){var w=this.getCenterPoint();return this._centerObject(d,w)},viewportCenterObject:function(d){var w=this.getVpCenter();return this._centerObject(d,w)},viewportCenterObjectH:function(d){var w=this.getVpCenter();return this._centerObject(d,new S.Point(w.x,d.getCenterPoint().y)),this},viewportCenterObjectV:function(d){var w=this.getVpCenter();return this._centerObject(d,new S.Point(d.getCenterPoint().x,w.y))},getVpCenter:function(){var d=this.getCenterPoint(),w=c(this.viewportTransform);return l(d,w)},_centerObject:function(d,w){return d.setPositionByOrigin(w,"center","center"),d.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(d){return this.toDatalessObject(d)},toObject:function(d){return this._toObjectMethod("toObject",d)},toDatalessObject:function(d){return this._toObjectMethod("toDatalessObject",d)},_toObjectMethod:function(d,w){var E=this.clipPath,O={version:S.version,objects:this._toObjects(d,w)};return E&&!E.excludeFromExport&&(O.clipPath=this._toObject(this.clipPath,d,w)),s(O,this.__serializeBgOverlay(d,w)),S.util.populateWithProperties(this,O,w),O},_toObjects:function(d,w){return this._objects.filter(function(E){return!E.excludeFromExport}).map(function(E){return this._toObject(E,d,w)},this)},_toObject:function(d,w,E){var O;this.includeDefaultValues||(O=d.includeDefaultValues,d.includeDefaultValues=!1);var L=d[w](E);return this.includeDefaultValues||(d.includeDefaultValues=O),L},__serializeBgOverlay:function(d,w){var E={},O=this.backgroundImage,L=this.overlayImage,U=this.backgroundColor,$=this.overlayColor;return U&&U.toObject?U.excludeFromExport||(E.background=U.toObject(w)):U&&(E.background=U),$&&$.toObject?$.excludeFromExport||(E.overlay=$.toObject(w)):$&&(E.overlay=$),O&&!O.excludeFromExport&&(E.backgroundImage=this._toObject(O,d,w)),L&&!L.excludeFromExport&&(E.overlayImage=this._toObject(L,d,w)),E},svgViewportTransformation:!0,toSVG:function(d,w){d||(d={}),d.reviver=w;var E=[];return this._setSVGPreamble(E,d),this._setSVGHeader(E,d),this.clipPath&&E.push('<g clip-path="url(#'+this.clipPath.clipPathId+`)" >
`),this._setSVGBgOverlayColor(E,"background"),this._setSVGBgOverlayImage(E,"backgroundImage",w),this._setSVGObjects(E,w),this.clipPath&&E.push(`</g>
`),this._setSVGBgOverlayColor(E,"overlay"),this._setSVGBgOverlayImage(E,"overlayImage",w),E.push("</svg>"),E.join("")},_setSVGPreamble:function(d,w){w.suppressPreamble||d.push('<?xml version="1.0" encoding="',w.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)},_setSVGHeader:function(d,w){var E=w.width||this.width,O=w.height||this.height,L,U='viewBox="0 0 '+this.width+" "+this.height+'" ',$=S.Object.NUM_FRACTION_DIGITS;w.viewBox?U='viewBox="'+w.viewBox.x+" "+w.viewBox.y+" "+w.viewBox.width+" "+w.viewBox.height+'" ':this.svgViewportTransformation&&(L=this.viewportTransform,U='viewBox="'+b(-L[4]/L[0],$)+" "+b(-L[5]/L[3],$)+" "+b(this.width/L[0],$)+" "+b(this.height/L[3],$)+'" '),d.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',E,'" ','height="',O,'" ',U,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",S.version,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(w),`</defs>
`)},createSVGClipPathMarkup:function(d){var w=this.clipPath;return w?(w.clipPathId="CLIPPATH_"+S.Object.__uid++,'<clipPath id="'+w.clipPathId+`" >
`+this.clipPath.toClipPathSVG(d.reviver)+`</clipPath>
`):""},createSVGRefElementsMarkup:function(){var d=this,w=["background","overlay"].map(function(E){var O=d[E+"Color"];if(O&&O.toLive){var L=d[E+"Vpt"],U=d.viewportTransform,$={width:d.width/(L?U[0]:1),height:d.height/(L?U[3]:1)};return O.toSVG($,{additionalTransform:L?S.util.matrixToSVG(U):""})}});return w.join("")},createSVGFontFacesMarkup:function(){var d="",w={},E,O,L,U,$,nt,xt,Ft,Kt,Jt=S.fontPaths,Qt=[];for(this._objects.forEach(function ne(me){Qt.push(me),me._objects&&me._objects.forEach(ne)}),Ft=0,Kt=Qt.length;Ft<Kt;Ft++)if(E=Qt[Ft],O=E.fontFamily,!(E.type.indexOf("text")===-1||w[O]||!Jt[O])&&(w[O]=!0,!!E.styles)){L=E.styles;for($ in L){U=L[$];for(xt in U)nt=U[xt],O=nt.fontFamily,!w[O]&&Jt[O]&&(w[O]=!0)}}for(var he in w)d+=[`		@font-face {
`,"			font-family: '",he,`';
`,"			src: url('",Jt[he],`');
`,`		}
`].join("");return d&&(d=['	<style type="text/css">',`<![CDATA[
`,d,"]]>",`</style>
`].join("")),d},_setSVGObjects:function(d,w){var E,O,L,U=this._objects;for(O=0,L=U.length;O<L;O++)E=U[O],!E.excludeFromExport&&this._setSVGObject(d,E,w)},_setSVGObject:function(d,w,E){d.push(w.toSVG(E))},_setSVGBgOverlayImage:function(d,w,E){this[w]&&!this[w].excludeFromExport&&this[w].toSVG&&d.push(this[w].toSVG(E))},_setSVGBgOverlayColor:function(d,w){var E=this[w+"Color"],O=this.viewportTransform,L=this.width,U=this.height;if(E)if(E.toLive){var $=E.repeat,nt=S.util.invertTransform(O),xt=this[w+"Vpt"],Ft=xt?S.util.matrixToSVG(nt):"";d.push('<rect transform="'+Ft+" translate(",L/2,",",U/2,')"',' x="',E.offsetX-L/2,'" y="',E.offsetY-U/2,'" ','width="',$==="repeat-y"||$==="no-repeat"?E.source.width:L,'" height="',$==="repeat-x"||$==="no-repeat"?E.source.height:U,'" fill="url(#SVGID_'+E.id+')"',`></rect>
`)}else d.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',E,'"',`></rect>
`)},sendToBack:function(d){if(!d)return this;var w=this._activeObject,E,O,L;if(d===w&&d.type==="activeSelection")for(L=w._objects,E=L.length;E--;)O=L[E],C(this._objects,O),this._objects.unshift(O);else C(this._objects,d),this._objects.unshift(d);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(d){if(!d)return this;var w=this._activeObject,E,O,L;if(d===w&&d.type==="activeSelection")for(L=w._objects,E=0;E<L.length;E++)O=L[E],C(this._objects,O),this._objects.push(O);else C(this._objects,d),this._objects.push(d);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(d,w){if(!d)return this;var E=this._activeObject,O,L,U,$,nt,xt=0;if(d===E&&d.type==="activeSelection")for(nt=E._objects,O=0;O<nt.length;O++)L=nt[O],U=this._objects.indexOf(L),U>0+xt&&($=U-1,C(this._objects,L),this._objects.splice($,0,L)),xt++;else U=this._objects.indexOf(d),U!==0&&($=this._findNewLowerIndex(d,U,w),C(this._objects,d),this._objects.splice($,0,d));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(d,w,E){var O,L;if(E)for(O=w,L=w-1;L>=0;--L){var U=d.intersectsWithObject(this._objects[L])||d.isContainedWithinObject(this._objects[L])||this._objects[L].isContainedWithinObject(d);if(U){O=L;break}}else O=w-1;return O},bringForward:function(d,w){if(!d)return this;var E=this._activeObject,O,L,U,$,nt,xt=0;if(d===E&&d.type==="activeSelection")for(nt=E._objects,O=nt.length;O--;)L=nt[O],U=this._objects.indexOf(L),U<this._objects.length-1-xt&&($=U+1,C(this._objects,L),this._objects.splice($,0,L)),xt++;else U=this._objects.indexOf(d),U!==this._objects.length-1&&($=this._findNewUpperIndex(d,U,w),C(this._objects,d),this._objects.splice($,0,d));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(d,w,E){var O,L,U;if(E)for(O=w,L=w+1,U=this._objects.length;L<U;++L){var $=d.intersectsWithObject(this._objects[L])||d.isContainedWithinObject(this._objects[L])||this._objects[L].isContainedWithinObject(d);if($){O=L;break}}else O=w+1;return O},moveTo:function(d,w){return C(this._objects,d),this._objects.splice(w,0,d),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(S.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(d){d.dispose&&d.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),S.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),S.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),s(S.StaticCanvas.prototype,S.Observable),s(S.StaticCanvas.prototype,S.Collection),s(S.StaticCanvas.prototype,S.DataURLExporter),s(S.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(d){var w=m();if(!w||!w.getContext)return null;var E=w.getContext("2d");if(!E)return null;switch(d){case"setLineDash":return typeof E.setLineDash<"u";default:return null}}}),S.StaticCanvas.prototype.toJSON=S.StaticCanvas.prototype.toObject,S.isLikelyNode&&(S.StaticCanvas.prototype.createPNGStream=function(){var d=h(this.lowerCanvasEl);return d&&d.createPNGStream()},S.StaticCanvas.prototype.createJPEGStream=function(d){var w=h(this.lowerCanvasEl);return w&&w.createJPEGStream(d)})}(),S.BaseBrush=S.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(s){s.strokeStyle=this.color,s.lineWidth=this.width,s.lineCap=this.strokeLineCap,s.miterLimit=this.strokeMiterLimit,s.lineJoin=this.strokeLineJoin,s.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(s){var p=this.canvas.viewportTransform;s.save(),s.transform(p[0],p[1],p[2],p[3],p[4],p[5])},_setShadow:function(){if(this.shadow){var s=this.canvas,p=this.shadow,C=s.contextTop,b=s.getZoom();s&&s._isRetinaScaling()&&(b*=S.devicePixelRatio),C.shadowColor=p.color,C.shadowBlur=p.blur*b,C.shadowOffsetX=p.offsetX*b,C.shadowOffsetY=p.offsetY*b}},needsFullRender:function(){var s=new S.Color(this.color);return s.getAlpha()<1||!!this.shadow},_resetShadow:function(){var s=this.canvas.contextTop;s.shadowColor="",s.shadowBlur=s.shadowOffsetX=s.shadowOffsetY=0},_isOutSideCanvas:function(s){return s.x<0||s.x>this.canvas.getWidth()||s.y<0||s.y>this.canvas.getHeight()}}),function(){S.PencilBrush=S.util.createClass(S.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(s){this.canvas=s,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(s,p,C){var b=p.midPointFrom(C);return s.quadraticCurveTo(p.x,p.y,b.x,b.y),b},onMouseDown:function(s,p){this.canvas._isMainEvent(p.e)&&(this.drawStraightLine=p.e[this.straightLineKey],this._prepareForDrawing(s),this._captureDrawingPath(s),this._render())},onMouseMove:function(s,p){if(this.canvas._isMainEvent(p.e)&&(this.drawStraightLine=p.e[this.straightLineKey],!(this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s))&&this._captureDrawingPath(s)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var C=this._points,b=C.length,l=this.canvas.contextTop;this._saveAndTransform(l),this.oldEnd&&(l.beginPath(),l.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(l,C[b-2],C[b-1],!0),l.stroke(),l.restore()}},onMouseUp:function(s){return this.canvas._isMainEvent(s.e)?(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1):!0},_prepareForDrawing:function(s){var p=new S.Point(s.x,s.y);this._reset(),this._addPoint(p),this.canvas.contextTop.moveTo(p.x,p.y)},_addPoint:function(s){return this._points.length>1&&s.eq(this._points[this._points.length-1])?!1:(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(s),!0)},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(s){var p=new S.Point(s.x,s.y);return this._addPoint(p)},_render:function(s){var p,C,b=this._points[0],l=this._points[1];if(s=s||this.canvas.contextTop,this._saveAndTransform(s),s.beginPath(),this._points.length===2&&b.x===l.x&&b.y===l.y){var c=this.width/1e3;b=new S.Point(b.x,b.y),l=new S.Point(l.x,l.y),b.x-=c,l.x+=c}for(s.moveTo(b.x,b.y),p=1,C=this._points.length;p<C;p++)this._drawSegment(s,b,l),b=this._points[p],l=this._points[p+1];s.lineTo(b.x,b.y),s.stroke(),s.restore()},convertPointsToSVGPath:function(s){var p=this.width/1e3;return S.util.getSmoothPathFromPoints(s,p)},_isEmptySVGPath:function(s){var p=S.util.joinPath(s);return p==="M 0 0 Q 0 0 0 0 L 0 0"},createPath:function(s){var p=new S.Path(s,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,p.shadow=new S.Shadow(this.shadow)),p},decimatePoints:function(s,p){if(s.length<=2)return s;var C=this.canvas.getZoom(),b=Math.pow(p/C,2),l,c=s.length-1,h=s[0],m=[h],g;for(l=1;l<c-1;l++)g=Math.pow(h.x-s[l].x,2)+Math.pow(h.y-s[l].y,2),g>=b&&(h=s[l],m.push(h));return m.push(s[c]),m},_finalizeAndAddPath:function(){var s=this.canvas.contextTop;s.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var p=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(p)){this.canvas.requestRenderAll();return}var C=this.createPath(p);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:C}),this.canvas.add(C),this.canvas.requestRenderAll(),C.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:C})}})}(),S.CircleBrush=S.util.createClass(S.BaseBrush,{width:10,initialize:function(s){this.canvas=s,this.points=[]},drawDot:function(s){var p=this.addPoint(s),C=this.canvas.contextTop;this._saveAndTransform(C),this.dot(C,p),C.restore()},dot:function(s,p){s.fillStyle=p.fill,s.beginPath(),s.arc(p.x,p.y,p.radius,0,Math.PI*2,!1),s.closePath(),s.fill()},onMouseDown:function(s){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(s)},_render:function(){var s=this.canvas.contextTop,p,C,b=this.points;for(this._saveAndTransform(s),p=0,C=b.length;p<C;p++)this.dot(s,b[p]);s.restore()},onMouseMove:function(s){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(s),this._render()):this.drawDot(s))},onMouseUp:function(){var s=this.canvas.renderOnAddRemove,p,C;this.canvas.renderOnAddRemove=!1;var b=[];for(p=0,C=this.points.length;p<C;p++){var l=this.points[p],c=new S.Circle({radius:l.radius,left:l.x,top:l.y,originX:"center",originY:"center",fill:l.fill});this.shadow&&(c.shadow=new S.Shadow(this.shadow)),b.push(c)}var h=new S.Group(b);h.canvas=this.canvas,this.canvas.fire("before:path:created",{path:h}),this.canvas.add(h),this.canvas.fire("path:created",{path:h}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=s,this.canvas.requestRenderAll()},addPoint:function(s){var p=new S.Point(s.x,s.y),C=S.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,b=new S.Color(this.color).setAlpha(S.util.getRandomInt(0,100)/100).toRgba();return p.radius=C,p.fill=b,this.points.push(p),p}}),S.SprayBrush=S.util.createClass(S.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(s){this.canvas=s,this.sprayChunks=[]},onMouseDown:function(s){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(s),this.render(this.sprayChunkPoints)},onMouseMove:function(s){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(s)||(this.addSprayChunk(s),this.render(this.sprayChunkPoints))},onMouseUp:function(){var s=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var p=[],C=0,b=this.sprayChunks.length;C<b;C++)for(var l=this.sprayChunks[C],c=0,h=l.length;c<h;c++){var m=new S.Rect({width:l[c].width,height:l[c].width,left:l[c].x+1,top:l[c].y+1,originX:"center",originY:"center",fill:this.color});p.push(m)}this.optimizeOverlapping&&(p=this._getOptimizedRects(p));var g=new S.Group(p);this.shadow&&g.set("shadow",new S.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:g}),this.canvas.add(g),this.canvas.fire("path:created",{path:g}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=s,this.canvas.requestRenderAll()},_getOptimizedRects:function(s){var p={},C,b,l;for(b=0,l=s.length;b<l;b++)C=s[b].left+""+s[b].top,p[C]||(p[C]=s[b]);var c=[];for(C in p)c.push(p[C]);return c},render:function(s){var p=this.canvas.contextTop,C,b;for(p.fillStyle=this.color,this._saveAndTransform(p),C=0,b=s.length;C<b;C++){var l=s[C];typeof l.opacity<"u"&&(p.globalAlpha=l.opacity),p.fillRect(l.x,l.y,l.width,l.width)}p.restore()},_render:function(){var s=this.canvas.contextTop,p,C;for(s.fillStyle=this.color,this._saveAndTransform(s),p=0,C=this.sprayChunks.length;p<C;p++)this.render(this.sprayChunks[p]);s.restore()},addSprayChunk:function(s){this.sprayChunkPoints=[];var p,C,b,l=this.width/2,c;for(c=0;c<this.density;c++){p=S.util.getRandomInt(s.x-l,s.x+l),C=S.util.getRandomInt(s.y-l,s.y+l),this.dotWidthVariance?b=S.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):b=this.dotWidth;var h=new S.Point(p,C);h.width=b,this.randomOpacity&&(h.opacity=S.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(h)}this.sprayChunks.push(this.sprayChunkPoints)}}),S.PatternBrush=S.util.createClass(S.PencilBrush,{getPatternSrc:function(){var s=20,p=5,C=S.util.createCanvasElement(),b=C.getContext("2d");return C.width=C.height=s+p,b.fillStyle=this.color,b.beginPath(),b.arc(s/2,s/2,s/2,0,Math.PI*2,!1),b.closePath(),b.fill(),C},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(s){return s.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(s){this.callSuper("_setBrushStyles",s),s.strokeStyle=this.getPattern(s)},createPath:function(s){var p=this.callSuper("createPath",s),C=p._getLeftTopCoords().scalarAdd(p.strokeWidth/2);return p.stroke=new S.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-C.x,offsetY:-C.y}),p}}),function(){var s=S.util.getPointer,p=S.util.degreesToRadians,C=S.util.isTouchEvent;S.Canvas=S.util.createClass(S.StaticCanvas,{initialize:function(l,c){c||(c={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(l,c),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=S.PencilBrush&&new S.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var l=this.getActiveObjects(),c,h,m;if(l.length>0&&!this.preserveObjectStacking){h=[],m=[];for(var g=0,d=this._objects.length;g<d;g++)c=this._objects[g],l.indexOf(c)===-1?h.push(c):m.push(c);l.length>1&&(this._activeObject._objects=m),h.push.apply(h,m)}else h=this._objects;return h},renderAll:function(){this.contextTopDirty&&!this._groupSelector&&!this.isDrawingMode&&(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var l=this.contextContainer;return this.renderCanvas(l,this._chooseObjectsToRender()),this},renderTopLayer:function(l){l.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(l),this.contextTopDirty=!0),l.restore()},renderTop:function(){var l=this.contextTop;return this.clearContext(l),this.renderTopLayer(l),this.fire("after:render"),this},_normalizePointer:function(l,c){var h=l.calcTransformMatrix(),m=S.util.invertTransform(h),g=this.restorePointerVpt(c);return S.util.transformPoint(g,m)},isTargetTransparent:function(l,c,h){if(l.shouldCache()&&l._cacheCanvas&&l!==this._activeObject){var m=this._normalizePointer(l,{x:c,y:h}),g=Math.max(l.cacheTranslationX+m.x*l.zoomX,0),d=Math.max(l.cacheTranslationY+m.y*l.zoomY,0),L=S.util.isTransparent(l._cacheContext,Math.round(g),Math.round(d),this.targetFindTolerance);return L}var w=this.contextCache,E=l.selectionBackgroundColor,O=this.viewportTransform;l.selectionBackgroundColor="",this.clearContext(w),w.save(),w.transform(O[0],O[1],O[2],O[3],O[4],O[5]),l.render(w),w.restore(),l.selectionBackgroundColor=E;var L=S.util.isTransparent(w,c,h,this.targetFindTolerance);return L},_isSelectionKeyPressed:function(l){var c=!1;return Array.isArray(this.selectionKey)?c=!!this.selectionKey.find(function(h){return l[h]===!0}):c=l[this.selectionKey],c},_shouldClearSelection:function(l,c){var h=this.getActiveObjects(),m=this._activeObject;return!c||c&&m&&h.length>1&&h.indexOf(c)===-1&&m!==c&&!this._isSelectionKeyPressed(l)||c&&!c.evented||c&&!c.selectable&&m&&m!==c},_shouldCenterTransform:function(l,c,h){if(l){var m;return c==="scale"||c==="scaleX"||c==="scaleY"||c==="resizing"?m=this.centeredScaling||l.centeredScaling:c==="rotate"&&(m=this.centeredRotation||l.centeredRotation),m?!h:h}},_getOriginFromCorner:function(l,c){var h={x:l.originX,y:l.originY};return c==="ml"||c==="tl"||c==="bl"?h.x="right":(c==="mr"||c==="tr"||c==="br")&&(h.x="left"),c==="tl"||c==="mt"||c==="tr"?h.y="bottom":(c==="bl"||c==="mb"||c==="br")&&(h.y="top"),h},_getActionFromCorner:function(l,c,h,m){if(!c||!l)return"drag";var g=m.controls[c];return g.getActionName(h,g,m)},_setupCurrentTransform:function(l,c,h){if(c){var m=this.getPointer(l),g=c.__corner,d=c.controls[g],w=h&&g?d.getActionHandler(l,c,d):S.controlsUtils.dragHandler,E=this._getActionFromCorner(h,g,l,c),O=this._getOriginFromCorner(c,g),L=l[this.centeredKey],U={target:c,action:E,actionHandler:w,corner:g,scaleX:c.scaleX,scaleY:c.scaleY,skewX:c.skewX,skewY:c.skewY,offsetX:m.x-c.left,offsetY:m.y-c.top,originX:O.x,originY:O.y,ex:m.x,ey:m.y,lastX:m.x,lastY:m.y,theta:p(c.angle),width:c.width*c.scaleX,shiftKey:l.shiftKey,altKey:L,original:S.util.saveObjectTransform(c)};this._shouldCenterTransform(c,E,L)&&(U.originX="center",U.originY="center"),U.original.originX=O.x,U.original.originY=O.y,this._currentTransform=U,this._beforeTransform(l)}},setCursor:function(l){this.upperCanvasEl.style.cursor=l},_drawSelection:function(l){var c=this._groupSelector,h=new S.Point(c.ex,c.ey),m=S.util.transformPoint(h,this.viewportTransform),g=new S.Point(c.ex+c.left,c.ey+c.top),d=S.util.transformPoint(g,this.viewportTransform),w=Math.min(m.x,d.x),E=Math.min(m.y,d.y),O=Math.max(m.x,d.x),L=Math.max(m.y,d.y),U=this.selectionLineWidth/2;this.selectionColor&&(l.fillStyle=this.selectionColor,l.fillRect(w,E,O-w,L-E)),!(!this.selectionLineWidth||!this.selectionBorderColor)&&(l.lineWidth=this.selectionLineWidth,l.strokeStyle=this.selectionBorderColor,w+=U,E+=U,O-=U,L-=U,S.Object.prototype._setLineDash.call(this,l,this.selectionDashArray),l.strokeRect(w,E,O-w,L-E))},findTarget:function(l,c){if(!this.skipTargetFind){var h=!0,m=this.getPointer(l,h),g=this._activeObject,d=this.getActiveObjects(),w,E,O=C(l),L=d.length>1&&!c||d.length===1;if(this.targets=[],L&&g._findTargetCorner(m,O)||d.length>1&&!c&&g===this._searchPossibleTargets([g],m))return g;if(d.length===1&&g===this._searchPossibleTargets([g],m))if(this.preserveObjectStacking)w=g,E=this.targets,this.targets=[];else return g;var U=this._searchPossibleTargets(this._objects,m);return l[this.altSelectionKey]&&U&&w&&U!==w&&(U=w,this.targets=E),U}},_checkTarget:function(l,c,h){if(c&&c.visible&&c.evented&&c.containsPoint(l))if((this.perPixelTargetFind||c.perPixelTargetFind)&&!c.isEditing){var m=this.isTargetTransparent(c,h.x,h.y);if(!m)return!0}else return!0},_searchPossibleTargets:function(l,c){for(var h,m=l.length,g;m--;){var d=l[m],w=d.group?this._normalizePointer(d.group,c):c;if(this._checkTarget(w,d,c)){h=l[m],h.subTargetCheck&&h instanceof S.Group&&(g=this._searchPossibleTargets(h._objects,c),g&&this.targets.push(g));break}}return h},restorePointerVpt:function(l){return S.util.transformPoint(l,S.util.invertTransform(this.viewportTransform))},getPointer:function(l,c){if(this._absolutePointer&&!c)return this._absolutePointer;if(this._pointer&&c)return this._pointer;var h=s(l),m=this.upperCanvasEl,g=m.getBoundingClientRect(),d=g.width||0,w=g.height||0,E;(!d||!w)&&("top"in g&&"bottom"in g&&(w=Math.abs(g.top-g.bottom)),"right"in g&&"left"in g&&(d=Math.abs(g.right-g.left))),this.calcOffset(),h.x=h.x-this._offset.left,h.y=h.y-this._offset.top,c||(h=this.restorePointerVpt(h));var O=this.getRetinaScaling();return O!==1&&(h.x/=O,h.y/=O),d===0||w===0?E={width:1,height:1}:E={width:m.width/d,height:m.height/w},{x:h.x*E.width,y:h.y*E.height}},_createUpperCanvas:function(){var l=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),c=this.lowerCanvasEl,h=this.upperCanvasEl;h?h.className="":(h=this._createCanvasElement(),this.upperCanvasEl=h),S.util.addClass(h,"upper-canvas "+l),this.wrapperEl.appendChild(h),this._copyCanvasStyle(c,h),this._applyCanvasStyle(h),this.contextTop=h.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=S.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),S.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),S.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(l){var c=this.width||l.width,h=this.height||l.height;S.util.setStyle(l,{position:"absolute",width:c+"px",height:h+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),l.width=c,l.height=h,S.util.makeElementUnselectable(l)},_copyCanvasStyle:function(l,c){c.style.cssText=l.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var l=this._activeObject;return l?l.type==="activeSelection"&&l._objects?l._objects.slice(0):[l]:[]},_onObjectRemoved:function(l){l===this._activeObject&&(this.fire("before:selection:cleared",{target:l}),this._discardActiveObject(),this.fire("selection:cleared",{target:l}),l.fire("deselected")),l===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",l)},_fireSelectionEvents:function(l,c){var h=!1,m=this.getActiveObjects(),g=[],d=[];l.forEach(function(w){m.indexOf(w)===-1&&(h=!0,w.fire("deselected",{e:c,target:w}),d.push(w))}),m.forEach(function(w){l.indexOf(w)===-1&&(h=!0,w.fire("selected",{e:c,target:w}),g.push(w))}),l.length>0&&m.length>0?h&&this.fire("selection:updated",{e:c,selected:g,deselected:d}):m.length>0?this.fire("selection:created",{e:c,selected:g}):l.length>0&&this.fire("selection:cleared",{e:c,deselected:d})},setActiveObject:function(l,c){var h=this.getActiveObjects();return this._setActiveObject(l,c),this._fireSelectionEvents(h,c),this},_setActiveObject:function(l,c){return this._activeObject===l||!this._discardActiveObject(c,l)||l.onSelect({e:c})?!1:(this._activeObject=l,!0)},_discardActiveObject:function(l,c){var h=this._activeObject;if(h){if(h.onDeselect({e:l,object:c}))return!1;this._activeObject=null}return!0},discardActiveObject:function(l){var c=this.getActiveObjects(),h=this.getActiveObject();return c.length&&this.fire("before:selection:cleared",{target:h,e:l}),this._discardActiveObject(l),this._fireSelectionEvents(c,l),this},dispose:function(){var l=this.wrapperEl;return this.removeListeners(),l.removeChild(this.upperCanvasEl),l.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach((function(c){S.util.cleanUpJsdomNode(this[c]),this[c]=void 0}).bind(this)),l.parentNode&&l.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,S.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(l){var c=this._activeObject;c&&c._renderControls(l)},_toObject:function(l,c,h){var m=this._realizeGroupTransformOnObject(l),g=this.callSuper("_toObject",l,c,h);return this._unwindGroupTransformOnObject(l,m),g},_realizeGroupTransformOnObject:function(l){if(l.group&&l.group.type==="activeSelection"&&this._activeObject===l.group){var c=["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"],h={};return c.forEach(function(m){h[m]=l[m]}),S.util.addTransformToObject(l,this._activeObject.calcOwnMatrix()),h}else return null},_unwindGroupTransformOnObject:function(l,c){c&&l.set(c)},_setSVGObject:function(l,c,h){var m=this._realizeGroupTransformOnObject(c);this.callSuper("_setSVGObject",l,c,h),this._unwindGroupTransformOnObject(c,m)},setViewportTransform:function(l){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),S.StaticCanvas.prototype.setViewportTransform.call(this,l)}});for(var b in S.StaticCanvas)b!=="prototype"&&(S.Canvas[b]=S.StaticCanvas[b])}(),function(){var s=S.util.addListener,p=S.util.removeListener,C=3,b=2,l=1,c={passive:!1};function h(m,g){return m.button&&m.button===g-1}S.util.object.extend(S.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(s,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(m,g){var d=this.upperCanvasEl,w=this._getEventPrefix();m(S.window,"resize",this._onResize),m(d,w+"down",this._onMouseDown),m(d,w+"move",this._onMouseMove,c),m(d,w+"out",this._onMouseOut),m(d,w+"enter",this._onMouseEnter),m(d,"wheel",this._onMouseWheel),m(d,"contextmenu",this._onContextMenu),m(d,"dblclick",this._onDoubleClick),m(d,"dragover",this._onDragOver),m(d,"dragenter",this._onDragEnter),m(d,"dragleave",this._onDragLeave),m(d,"drop",this._onDrop),this.enablePointerEvents||m(d,"touchstart",this._onTouchStart,c),typeof eventjs<"u"&&g in eventjs&&(eventjs[g](d,"gesture",this._onGesture),eventjs[g](d,"drag",this._onDrag),eventjs[g](d,"orientation",this._onOrientationChange),eventjs[g](d,"shake",this._onShake),eventjs[g](d,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(p,"remove");var m=this._getEventPrefix();p(S.document,m+"up",this._onMouseUp),p(S.document,"touchend",this._onTouchEnd,c),p(S.document,m+"move",this._onMouseMove,c),p(S.document,"touchmove",this._onMouseMove,c)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(m,g){this.__onTransformGesture&&this.__onTransformGesture(m,g)},_onDrag:function(m,g){this.__onDrag&&this.__onDrag(m,g)},_onMouseWheel:function(m){this.__onMouseWheel(m)},_onMouseOut:function(m){var g=this._hoveredTarget;this.fire("mouse:out",{target:g,e:m}),this._hoveredTarget=null,g&&g.fire("mouseout",{e:m});var d=this;this._hoveredTargets.forEach(function(w){d.fire("mouse:out",{target:g,e:m}),w&&g.fire("mouseout",{e:m})}),this._hoveredTargets=[]},_onMouseEnter:function(m){!this._currentTransform&&!this.findTarget(m)&&(this.fire("mouse:over",{target:null,e:m}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(m,g){this.__onOrientationChange&&this.__onOrientationChange(m,g)},_onShake:function(m,g){this.__onShake&&this.__onShake(m,g)},_onLongPress:function(m,g){this.__onLongPress&&this.__onLongPress(m,g)},_onDragOver:function(m){m.preventDefault();var g=this._simpleEventHandler("dragover",m);this._fireEnterLeaveEvents(g,m)},_onDrop:function(m){return this._simpleEventHandler("drop:before",m),this._simpleEventHandler("drop",m)},_onContextMenu:function(m){return this.stopContextMenu&&(m.stopPropagation(),m.preventDefault()),!1},_onDoubleClick:function(m){this._cacheTransformEventData(m),this._handleEvent(m,"dblclick"),this._resetTransformEventData(m)},getPointerId:function(m){var g=m.changedTouches;return g?g[0]&&g[0].identifier:this.enablePointerEvents?m.pointerId:-1},_isMainEvent:function(m){return m.isPrimary===!0?!0:m.isPrimary===!1?!1:m.type==="touchend"&&m.touches.length===0?!0:m.changedTouches?m.changedTouches[0].identifier===this.mainTouchId:!0},_onTouchStart:function(m){m.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(m)),this.__onMouseDown(m),this._resetTransformEventData();var g=this.upperCanvasEl,d=this._getEventPrefix();s(S.document,"touchend",this._onTouchEnd,c),s(S.document,"touchmove",this._onMouseMove,c),p(g,d+"down",this._onMouseDown)},_onMouseDown:function(m){this.__onMouseDown(m),this._resetTransformEventData();var g=this.upperCanvasEl,d=this._getEventPrefix();p(g,d+"move",this._onMouseMove,c),s(S.document,d+"up",this._onMouseUp),s(S.document,d+"move",this._onMouseMove,c)},_onTouchEnd:function(m){if(!(m.touches.length>0)){this.__onMouseUp(m),this._resetTransformEventData(),this.mainTouchId=null;var g=this._getEventPrefix();p(S.document,"touchend",this._onTouchEnd,c),p(S.document,"touchmove",this._onMouseMove,c);var d=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){s(d.upperCanvasEl,g+"down",d._onMouseDown),d._willAddMouseDown=0},400)}},_onMouseUp:function(m){this.__onMouseUp(m),this._resetTransformEventData();var g=this.upperCanvasEl,d=this._getEventPrefix();this._isMainEvent(m)&&(p(S.document,d+"up",this._onMouseUp),p(S.document,d+"move",this._onMouseMove,c),s(g,d+"move",this._onMouseMove,c))},_onMouseMove:function(m){!this.allowTouchScrolling&&m.preventDefault&&m.preventDefault(),this.__onMouseMove(m)},_onResize:function(){this.calcOffset()},_shouldRender:function(m){var g=this._activeObject;return!!g!=!!m||g&&m&&g!==m?!0:(g&&g.isEditing,!1)},__onMouseUp:function(m){var g,d=this._currentTransform,w=this._groupSelector,E=!1,O=!w||w.left===0&&w.top===0;if(this._cacheTransformEventData(m),g=this._target,this._handleEvent(m,"up:before"),h(m,C)){this.fireRightClick&&this._handleEvent(m,"up",C,O);return}if(h(m,b)){this.fireMiddleClick&&this._handleEvent(m,"up",b,O),this._resetTransformEventData();return}if(this.isDrawingMode&&this._isCurrentlyDrawing){this._onMouseUpInDrawingMode(m);return}if(this._isMainEvent(m)){if(d&&(this._finalizeCurrentTransform(m),E=d.actionPerformed),!O){var L=g===this._activeObject;this._maybeGroupObjects(m),E||(E=this._shouldRender(g)||!L&&g===this._activeObject)}var U,$;if(g){if(U=g._findTargetCorner(this.getPointer(m,!0),S.util.isTouchEvent(m)),g.selectable&&g!==this._activeObject&&g.activeOn==="up")this.setActiveObject(g,m),E=!0;else{var nt=g.controls[U],xt=nt&&nt.getMouseUpHandler(m,g,nt);xt&&($=this.getPointer(m),xt(m,d,$.x,$.y))}g.isMoving=!1}if(d&&(d.target!==g||d.corner!==U)){var Ft=d.target&&d.target.controls[d.corner],Kt=Ft&&Ft.getMouseUpHandler(m,g,nt);$=$||this.getPointer(m),Kt&&Kt(m,d,$.x,$.y)}this._setCursorFromEvent(m,g),this._handleEvent(m,"up",l,O),this._groupSelector=null,this._currentTransform=null,g&&(g.__corner=0),E?this.requestRenderAll():O||this.renderTop()}},_simpleEventHandler:function(m,g){var d=this.findTarget(g),w=this.targets,E={e:g,target:d,subTargets:w};if(this.fire(m,E),d&&d.fire(m,E),!w)return d;for(var O=0;O<w.length;O++)w[O].fire(m,E);return d},_handleEvent:function(m,g,d,w){var E=this._target,O=this.targets||[],L={e:m,target:E,subTargets:O,button:d||l,isClick:w||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};g==="up"&&(L.currentTarget=this.findTarget(m),L.currentSubTargets=this.targets),this.fire("mouse:"+g,L),E&&E.fire("mouse"+g,L);for(var U=0;U<O.length;U++)O[U].fire("mouse"+g,L)},_finalizeCurrentTransform:function(m){var g=this._currentTransform,d=g.target,w={e:m,target:d,transform:g,action:g.action};d._scaling&&(d._scaling=!1),d.setCoords(),(g.actionPerformed||this.stateful&&d.hasStateChanged())&&this._fire("modified",w)},_onMouseDownInDrawingMode:function(m){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(m).requestRenderAll();var g=this.getPointer(m);this.freeDrawingBrush.onMouseDown(g,{e:m,pointer:g}),this._handleEvent(m,"down")},_onMouseMoveInDrawingMode:function(m){if(this._isCurrentlyDrawing){var g=this.getPointer(m);this.freeDrawingBrush.onMouseMove(g,{e:m,pointer:g})}this.setCursor(this.freeDrawingCursor),this._handleEvent(m,"move")},_onMouseUpInDrawingMode:function(m){var g=this.getPointer(m);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:m,pointer:g}),this._handleEvent(m,"up")},__onMouseDown:function(m){this._cacheTransformEventData(m),this._handleEvent(m,"down:before");var g=this._target;if(h(m,C)){this.fireRightClick&&this._handleEvent(m,"down",C);return}if(h(m,b)){this.fireMiddleClick&&this._handleEvent(m,"down",b);return}if(this.isDrawingMode){this._onMouseDownInDrawingMode(m);return}if(this._isMainEvent(m)&&!this._currentTransform){var d=this._pointer;this._previousPointer=d;var w=this._shouldRender(g),E=this._shouldGroup(m,g);if(this._shouldClearSelection(m,g)?this.discardActiveObject(m):E&&(this._handleGrouping(m,g),g=this._activeObject),this.selection&&(!g||!g.selectable&&!g.isEditing&&g!==this._activeObject)&&(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),g){var O=g===this._activeObject;g.selectable&&g.activeOn==="down"&&this.setActiveObject(g,m);var L=g._findTargetCorner(this.getPointer(m,!0),S.util.isTouchEvent(m));if(g.__corner=L,g===this._activeObject&&(L||!E)){this._setupCurrentTransform(m,g,O);var U=g.controls[L],d=this.getPointer(m),$=U&&U.getMouseDownHandler(m,g,U);$&&$(m,this._currentTransform,d.x,d.y)}}this._handleEvent(m,"down"),(w||E)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(m){this._resetTransformEventData(),this._pointer=this.getPointer(m,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(m)||null},_beforeTransform:function(m){var g=this._currentTransform;this.stateful&&g.target.saveState(),this.fire("before:transform",{e:m,transform:g})},__onMouseMove:function(m){this._handleEvent(m,"move:before"),this._cacheTransformEventData(m);var g,d;if(this.isDrawingMode){this._onMouseMoveInDrawingMode(m);return}if(this._isMainEvent(m)){var w=this._groupSelector;w?(d=this._absolutePointer,w.left=d.x-w.ex,w.top=d.y-w.ey,this.renderTop()):this._currentTransform?this._transformObject(m):(g=this.findTarget(m)||null,this._setCursorFromEvent(m,g),this._fireOverOutEvents(g,m)),this._handleEvent(m,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(m,g){var d=this._hoveredTarget,w=this._hoveredTargets,E=this.targets,O=Math.max(w.length,E.length);this.fireSyntheticInOutEvents(m,g,{oldTarget:d,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var L=0;L<O;L++)this.fireSyntheticInOutEvents(E[L],g,{oldTarget:w[L],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=m,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(m,g){var d=this._draggedoverTarget,w=this._hoveredTargets,E=this.targets,O=Math.max(w.length,E.length);this.fireSyntheticInOutEvents(m,g,{oldTarget:d,evtOut:"dragleave",evtIn:"dragenter"});for(var L=0;L<O;L++)this.fireSyntheticInOutEvents(E[L],g,{oldTarget:w[L],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=m},fireSyntheticInOutEvents:function(m,g,d){var w,E,O=d.oldTarget,L,U,$=O!==m,nt=d.canvasEvtIn,xt=d.canvasEvtOut;$&&(w={e:g,target:m,previousTarget:O},E={e:g,target:O,nextTarget:m}),U=m&&$,L=O&&$,L&&(xt&&this.fire(xt,E),O.fire(d.evtOut,E)),U&&(nt&&this.fire(nt,w),m.fire(d.evtIn,w))},__onMouseWheel:function(m){this._cacheTransformEventData(m),this._handleEvent(m,"wheel"),this._resetTransformEventData()},_transformObject:function(m){var g=this.getPointer(m),d=this._currentTransform;d.reset=!1,d.shiftKey=m.shiftKey,d.altKey=m[this.centeredKey],this._performTransformAction(m,d,g),d.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(m,g,d){var w=d.x,E=d.y,O=g.action,L=!1,U=g.actionHandler;U&&(L=U(m,g,w,E)),O==="drag"&&L&&(g.target.isMoving=!0,this.setCursor(g.target.moveCursor||this.moveCursor)),g.actionPerformed=g.actionPerformed||L},_fire:S.controlsUtils.fireEvent,_setCursorFromEvent:function(m,g){if(!g)return this.setCursor(this.defaultCursor),!1;var d=g.hoverCursor||this.hoverCursor,w=this._activeObject&&this._activeObject.type==="activeSelection"?this._activeObject:null,E=(!w||!w.contains(g))&&g._findTargetCorner(this.getPointer(m,!0));E?this.setCursor(this.getCornerCursor(E,g,m)):(g.subTargetCheck&&this.targets.concat().reverse().map(function(O){d=O.hoverCursor||d}),this.setCursor(d))},getCornerCursor:function(m,g,d){var w=g.controls[m];return w.cursorStyleHandler(d,w,g)}})}(),function(){var s=Math.min,p=Math.max;S.util.object.extend(S.Canvas.prototype,{_shouldGroup:function(C,b){var l=this._activeObject;return l&&this._isSelectionKeyPressed(C)&&b&&b.selectable&&this.selection&&(l!==b||l.type==="activeSelection")&&!b.onSelect({e:C})},_handleGrouping:function(C,b){var l=this._activeObject;l.__corner||b===l&&(b=this.findTarget(C,!0),!b||!b.selectable)||(l&&l.type==="activeSelection"?this._updateActiveSelection(b,C):this._createActiveSelection(b,C))},_updateActiveSelection:function(C,b){var l=this._activeObject,c=l._objects.slice(0);l.contains(C)?(l.removeWithUpdate(C),this._hoveredTarget=C,this._hoveredTargets=this.targets.concat(),l.size()===1&&this._setActiveObject(l.item(0),b)):(l.addWithUpdate(C),this._hoveredTarget=l,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(c,b)},_createActiveSelection:function(C,b){var l=this.getActiveObjects(),c=this._createGroup(C);this._hoveredTarget=c,this._setActiveObject(c,b),this._fireSelectionEvents(l,b)},_createGroup:function(C){var b=this._objects,l=b.indexOf(this._activeObject)<b.indexOf(C),c=l?[this._activeObject,C]:[C,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new S.ActiveSelection(c,{canvas:this})},_groupSelectedObjects:function(C){var b=this._collectObjects(C),l;b.length===1?this.setActiveObject(b[0],C):b.length>1&&(l=new S.ActiveSelection(b.reverse(),{canvas:this}),this.setActiveObject(l,C))},_collectObjects:function(C){for(var b=[],l,c=this._groupSelector.ex,h=this._groupSelector.ey,m=c+this._groupSelector.left,g=h+this._groupSelector.top,d=new S.Point(s(c,m),s(h,g)),w=new S.Point(p(c,m),p(h,g)),E=!this.selectionFullyContained,O=c===m&&h===g,L=this._objects.length;L--&&(l=this._objects[L],!(!(!l||!l.selectable||!l.visible)&&(E&&l.intersectsWithRect(d,w,!0)||l.isContainedWithinRect(d,w,!0)||E&&l.containsPoint(d,null,!0)||E&&l.containsPoint(w,null,!0))&&(b.push(l),O))););return b.length>1&&(b=b.filter(function(U){return!U.onSelect({e:C})})),b},_maybeGroupObjects:function(C){this.selection&&this._groupSelector&&this._groupSelectedObjects(C),this.setCursor(this.defaultCursor),this._groupSelector=null}})}(),function(){S.util.object.extend(S.StaticCanvas.prototype,{toDataURL:function(s){s||(s={});var p=s.format||"png",C=s.quality||1,b=(s.multiplier||1)*(s.enableRetinaScaling?this.getRetinaScaling():1),l=this.toCanvasElement(b,s);return S.util.toDataURL(l,p,C)},toCanvasElement:function(s,p){s=s||1,p=p||{};var C=(p.width||this.width)*s,b=(p.height||this.height)*s,l=this.getZoom(),c=this.width,h=this.height,m=l*s,g=this.viewportTransform,d=(g[4]-(p.left||0))*s,w=(g[5]-(p.top||0))*s,E=this.interactive,O=[m,0,0,m,d,w],L=this.enableRetinaScaling,U=S.util.createCanvasElement(),$=this.contextTop;return U.width=C,U.height=b,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=O,this.width=C,this.height=b,this.calcViewportBoundaries(),this.renderCanvas(U.getContext("2d"),this._objects),this.viewportTransform=g,this.width=c,this.height=h,this.calcViewportBoundaries(),this.interactive=E,this.enableRetinaScaling=L,this.contextTop=$,U}})}(),S.util.object.extend(S.StaticCanvas.prototype,{loadFromJSON:function(s,p,C){if(s){var b=typeof s=="string"?JSON.parse(s):S.util.object.clone(s),l=this,c=b.clipPath,h=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete b.clipPath,this._enlivenObjects(b.objects,function(m){l.clear(),l._setBgOverlay(b,function(){c?l._enlivenObjects([c],function(g){l.clipPath=g[0],l.__setupCanvas.call(l,b,m,h,p)}):l.__setupCanvas.call(l,b,m,h,p)})},C),this}},__setupCanvas:function(s,p,C,b){var l=this;p.forEach(function(c,h){l.insertAt(c,h)}),this.renderOnAddRemove=C,delete s.objects,delete s.backgroundImage,delete s.overlayImage,delete s.background,delete s.overlay,this._setOptions(s),this.renderAll(),b&&b()},_setBgOverlay:function(s,p){var C={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(!s.backgroundImage&&!s.overlayImage&&!s.background&&!s.overlay){p&&p();return}var b=function(){C.backgroundImage&&C.overlayImage&&C.backgroundColor&&C.overlayColor&&p&&p()};this.__setBgOverlay("backgroundImage",s.backgroundImage,C,b),this.__setBgOverlay("overlayImage",s.overlayImage,C,b),this.__setBgOverlay("backgroundColor",s.background,C,b),this.__setBgOverlay("overlayColor",s.overlay,C,b)},__setBgOverlay:function(s,p,C,b){var l=this;if(!p){C[s]=!0,b&&b();return}s==="backgroundImage"||s==="overlayImage"?S.util.enlivenObjects([p],function(c){l[s]=c[0],C[s]=!0,b&&b()}):this["set"+S.util.string.capitalize(s,!0)](p,function(){C[s]=!0,b&&b()})},_enlivenObjects:function(s,p,C){if(!s||s.length===0){p&&p([]);return}S.util.enlivenObjects(s,function(b){p&&p(b)},null,C)},_toDataURL:function(s,p){this.clone(function(C){p(C.toDataURL(s))})},_toDataURLWithMultiplier:function(s,p,C){this.clone(function(b){C(b.toDataURLWithMultiplier(s,p))})},clone:function(s,p){var C=JSON.stringify(this.toJSON(p));this.cloneWithoutData(function(b){b.loadFromJSON(C,function(){s&&s(b)})})},cloneWithoutData:function(s){var p=S.util.createCanvasElement();p.width=this.width,p.height=this.height;var C=new S.Canvas(p);this.backgroundImage?(C.setBackgroundImage(this.backgroundImage.src,function(){C.renderAll(),s&&s(C)}),C.backgroundImageOpacity=this.backgroundImageOpacity,C.backgroundImageStretch=this.backgroundImageStretch):s&&s(C)}}),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.util.object.clone,l=p.util.toFixed,c=p.util.string.capitalize,h=p.util.degreesToRadians,m=!p.isLikelyNode,g=2;p.Object||(p.Object=p.util.createClass(p.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:m,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(d){d&&this.setOptions(d)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=p.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(d){var w=p.perfLimitSizeTotal,E=d.width,O=d.height,L=p.maxCacheSideLimit,U=p.minCacheSideLimit;if(E<=L&&O<=L&&E*O<=w)return E<U&&(d.width=U),O<U&&(d.height=U),d;var $=E/O,nt=p.util.limitDimsByArea($,w),xt=p.util.capValue,Ft=xt(U,nt.x,L),Kt=xt(U,nt.y,L);return E>Ft&&(d.zoomX/=E/Ft,d.width=Ft,d.capped=!0),O>Kt&&(d.zoomY/=O/Kt,d.height=Kt,d.capped=!0),d},_getCacheCanvasDimensions:function(){var d=this.getTotalObjectScaling(),w=this._getTransformedDimensions(0,0),E=w.x*d.scaleX/this.scaleX,O=w.y*d.scaleY/this.scaleY;return{width:E+g,height:O+g,zoomX:d.scaleX,zoomY:d.scaleY,x:E,y:O}},_updateCacheCanvas:function(){var d=this.canvas;if(this.noScaleCache&&d&&d._currentTransform){var w=d._currentTransform.target,E=d._currentTransform.action;if(this===w&&E.slice&&E.slice(0,5)==="scale")return!1}var O=this._cacheCanvas,L=this._limitCacheSize(this._getCacheCanvasDimensions()),U=p.minCacheSideLimit,$=L.width,nt=L.height,xt,Ft,Kt=L.zoomX,Jt=L.zoomY,Qt=$!==this.cacheWidth||nt!==this.cacheHeight,he=this.zoomX!==Kt||this.zoomY!==Jt,ne=Qt||he,me=0,Oe=0,se=!1;if(Qt){var be=this._cacheCanvas.width,Q=this._cacheCanvas.height,wt=$>be||nt>Q,gt=($<be*.9||nt<Q*.9)&&be>U&&Q>U;se=wt||gt,wt&&!L.capped&&($>U||nt>U)&&(me=$*.1,Oe=nt*.1)}return this instanceof p.Text&&this.path&&(ne=!0,se=!0,me+=this.getHeightOfLine(0)*this.zoomX,Oe+=this.getHeightOfLine(0)*this.zoomY),ne?(se?(O.width=Math.ceil($+me),O.height=Math.ceil(nt+Oe)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,O.width,O.height)),xt=L.x/2,Ft=L.y/2,this.cacheTranslationX=Math.round(O.width/2-xt)+xt,this.cacheTranslationY=Math.round(O.height/2-Ft)+Ft,this.cacheWidth=$,this.cacheHeight=nt,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(Kt,Jt),this.zoomX=Kt,this.zoomY=Jt,!0):!1},setOptions:function(d){this._setOptions(d),this._initGradient(d.fill,"fill"),this._initGradient(d.stroke,"stroke"),this._initPattern(d.fill,"fill"),this._initPattern(d.stroke,"stroke")},transform:function(d){var w=this.group&&!this.group._transformDone||this.group&&this.canvas&&d===this.canvas.contextTop,E=this.calcTransformMatrix(!w);d.transform(E[0],E[1],E[2],E[3],E[4],E[5])},toObject:function(d){var w=p.Object.NUM_FRACTION_DIGITS,E={type:this.type,version:p.version,originX:this.originX,originY:this.originY,left:l(this.left,w),top:l(this.top,w),width:l(this.width,w),height:l(this.height,w),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:l(this.strokeWidth,w),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:l(this.strokeMiterLimit,w),scaleX:l(this.scaleX,w),scaleY:l(this.scaleY,w),angle:l(this.angle,w),flipX:this.flipX,flipY:this.flipY,opacity:l(this.opacity,w),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:l(this.skewX,w),skewY:l(this.skewY,w)};return this.clipPath&&!this.clipPath.excludeFromExport&&(E.clipPath=this.clipPath.toObject(d),E.clipPath.inverted=this.clipPath.inverted,E.clipPath.absolutePositioned=this.clipPath.absolutePositioned),p.util.populateWithProperties(this,E,d),this.includeDefaultValues||(E=this._removeDefaultValues(E)),E},toDatalessObject:function(d){return this.toObject(d)},_removeDefaultValues:function(d){var w=p.util.getKlass(d.type).prototype,E=w.stateProperties;return E.forEach(function(O){O==="left"||O==="top"||(d[O]===w[O]&&delete d[O],Array.isArray(d[O])&&Array.isArray(w[O])&&d[O].length===0&&w[O].length===0&&delete d[O])}),d},toString:function(){return"#<fabric."+c(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var d=p.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(d.scaleX),scaleY:Math.abs(d.scaleY)}},getTotalObjectScaling:function(){var d=this.getObjectScaling(),w=d.scaleX,E=d.scaleY;if(this.canvas){var O=this.canvas.getZoom(),L=this.canvas.getRetinaScaling();w*=O*L,E*=O*L}return{scaleX:w,scaleY:E}},getObjectOpacity:function(){var d=this.opacity;return this.group&&(d*=this.group.getObjectOpacity()),d},_set:function(d,w){var E=d==="scaleX"||d==="scaleY",O=this[d]!==w,L=!1;return E&&(w=this._constrainScale(w)),d==="scaleX"&&w<0?(this.flipX=!this.flipX,w*=-1):d==="scaleY"&&w<0?(this.flipY=!this.flipY,w*=-1):d==="shadow"&&w&&!(w instanceof p.Shadow)?w=new p.Shadow(w):d==="dirty"&&this.group&&this.group.set("dirty",w),this[d]=w,O&&(L=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(d)>-1?(this.dirty=!0,L&&this.group.set("dirty",!0)):L&&this.stateProperties.indexOf(d)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:p.iMatrix.concat()},isNotVisible:function(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible},render:function(d){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(d.save(),this._setupCompositeOperation(d),this.drawSelectionBackground(d),this.transform(d),this._setOpacity(d),this._setShadow(d,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(d)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(d),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),d.restore())},renderCache:function(d){d=d||{},(!this._cacheCanvas||!this._cacheContext)&&this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,d.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0},hasFill:function(){return this.fill&&this.fill!=="transparent"},needsItsOwnCache:function(){return!!(this.paintFirst==="stroke"&&this.hasFill()&&this.hasStroke()&&typeof this.shadow=="object"||this.clipPath)},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)},drawClipPathOnCache:function(d,w){if(d.save(),w.inverted?d.globalCompositeOperation="destination-out":d.globalCompositeOperation="destination-in",w.absolutePositioned){var E=p.util.invertTransform(this.calcTransformMatrix());d.transform(E[0],E[1],E[2],E[3],E[4],E[5])}w.transform(d),d.scale(1/w.zoomX,1/w.zoomY),d.drawImage(w._cacheCanvas,-w.cacheTranslationX,-w.cacheTranslationY),d.restore()},drawObject:function(d,w){var E=this.fill,O=this.stroke;w?(this.fill="black",this.stroke="",this._setClippingProperties(d)):this._renderBackground(d),this._render(d),this._drawClipPath(d,this.clipPath),this.fill=E,this.stroke=O},_drawClipPath:function(d,w){w&&(w.canvas=this.canvas,w.shouldCache(),w._transformDone=!0,w.renderCache({forClipping:!0}),this.drawClipPathOnCache(d,w))},drawCacheOnCanvas:function(d){d.scale(1/this.zoomX,1/this.zoomY),d.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(d){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!d&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!d){var w=this.cacheWidth/this.zoomX,E=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-w/2,-E/2,w,E)}return!0}return!1},_renderBackground:function(d){if(this.backgroundColor){var w=this._getNonTransformedDimensions();d.fillStyle=this.backgroundColor,d.fillRect(-w.x/2,-w.y/2,w.x,w.y),this._removeShadow(d)}},_setOpacity:function(d){this.group&&!this.group._transformDone?d.globalAlpha=this.getObjectOpacity():d.globalAlpha*=this.opacity},_setStrokeStyles:function(d,w){var E=w.stroke;E&&(d.lineWidth=w.strokeWidth,d.lineCap=w.strokeLineCap,d.lineDashOffset=w.strokeDashOffset,d.lineJoin=w.strokeLineJoin,d.miterLimit=w.strokeMiterLimit,E.toLive?E.gradientUnits==="percentage"||E.gradientTransform||E.patternTransform?this._applyPatternForTransformedGradient(d,E):(d.strokeStyle=E.toLive(d,this),this._applyPatternGradientTransform(d,E)):d.strokeStyle=w.stroke)},_setFillStyles:function(d,w){var E=w.fill;E&&(E.toLive?(d.fillStyle=E.toLive(d,this),this._applyPatternGradientTransform(d,w.fill)):d.fillStyle=E)},_setClippingProperties:function(d){d.globalAlpha=1,d.strokeStyle="transparent",d.fillStyle="#000000"},_setLineDash:function(d,w){!w||w.length===0||(1&w.length&&w.push.apply(w,w),d.setLineDash(w))},_renderControls:function(d,w){var E=this.getViewportTransform(),O=this.calcTransformMatrix(),L,U,$;w=w||{},U=typeof w.hasBorders<"u"?w.hasBorders:this.hasBorders,$=typeof w.hasControls<"u"?w.hasControls:this.hasControls,O=p.util.multiplyTransformMatrices(E,O),L=p.util.qrDecompose(O),d.save(),d.translate(L.translateX,L.translateY),d.lineWidth=1*this.borderScaleFactor,this.group||(d.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(L.angle-=180),d.rotate(h(this.group?L.angle:this.angle)),w.forActiveSelection||this.group?U&&this.drawBordersInGroup(d,L,w):U&&this.drawBorders(d,w),$&&this.drawControls(d,w),d.restore()},_setShadow:function(d){if(this.shadow){var w=this.shadow,E=this.canvas,O,L=E&&E.viewportTransform[0]||1,U=E&&E.viewportTransform[3]||1;w.nonScaling?O={scaleX:1,scaleY:1}:O=this.getObjectScaling(),E&&E._isRetinaScaling()&&(L*=p.devicePixelRatio,U*=p.devicePixelRatio),d.shadowColor=w.color,d.shadowBlur=w.blur*p.browserShadowBlurConstant*(L+U)*(O.scaleX+O.scaleY)/4,d.shadowOffsetX=w.offsetX*L*O.scaleX,d.shadowOffsetY=w.offsetY*U*O.scaleY}},_removeShadow:function(d){this.shadow&&(d.shadowColor="",d.shadowBlur=d.shadowOffsetX=d.shadowOffsetY=0)},_applyPatternGradientTransform:function(d,w){if(!w||!w.toLive)return{offsetX:0,offsetY:0};var E=w.gradientTransform||w.patternTransform,O=-this.width/2+w.offsetX||0,L=-this.height/2+w.offsetY||0;return w.gradientUnits==="percentage"?d.transform(this.width,0,0,this.height,O,L):d.transform(1,0,0,1,O,L),E&&d.transform(E[0],E[1],E[2],E[3],E[4],E[5]),{offsetX:O,offsetY:L}},_renderPaintInOrder:function(d){this.paintFirst==="stroke"?(this._renderStroke(d),this._renderFill(d)):(this._renderFill(d),this._renderStroke(d))},_render:function(){},_renderFill:function(d){this.fill&&(d.save(),this._setFillStyles(d,this),this.fillRule==="evenodd"?d.fill("evenodd"):d.fill(),d.restore())},_renderStroke:function(d){if(!(!this.stroke||this.strokeWidth===0)){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(d),d.save(),this.strokeUniform&&this.group){var w=this.getObjectScaling();d.scale(1/w.scaleX,1/w.scaleY)}else this.strokeUniform&&d.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(d,this.strokeDashArray),this._setStrokeStyles(d,this),d.stroke(),d.restore()}},_applyPatternForTransformedGradient:function(d,w){var E=this._limitCacheSize(this._getCacheCanvasDimensions()),O=p.util.createCanvasElement(),L,U=this.canvas.getRetinaScaling(),$=E.x/this.scaleX/U,nt=E.y/this.scaleY/U;O.width=$,O.height=nt,L=O.getContext("2d"),L.beginPath(),L.moveTo(0,0),L.lineTo($,0),L.lineTo($,nt),L.lineTo(0,nt),L.closePath(),L.translate($/2,nt/2),L.scale(E.zoomX/this.scaleX/U,E.zoomY/this.scaleY/U),this._applyPatternGradientTransform(L,w),L.fillStyle=w.toLive(d),L.fill(),d.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),d.scale(U*this.scaleX/E.zoomX,U*this.scaleY/E.zoomY),d.strokeStyle=L.createPattern(O,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var d=p.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",d.scaleX),this.set("scaleY",d.scaleY),this.angle=d.angle,this.skewX=d.skewX,this.skewY=0}},_removeTransformMatrix:function(d){var w=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),w=p.util.transformPoint(w,this.transformMatrix)),this.transformMatrix=null,d&&(this.scaleX*=d.scaleX,this.scaleY*=d.scaleY,this.cropX=d.cropX,this.cropY=d.cropY,w.x+=d.offsetLeft,w.y+=d.offsetTop,this.width=d.width,this.height=d.height),this.setPositionByOrigin(w,"center","center")},clone:function(d,w){var E=this.toObject(w);this.constructor.fromObject?this.constructor.fromObject(E,d):p.Object._fromObject("Object",E,d)},cloneAsImage:function(d,w){var E=this.toCanvasElement(w);return d&&d(new p.Image(E)),this},toCanvasElement:function(d){d||(d={});var w=p.util,E=w.saveObjectTransform(this),O=this.group,L=this.shadow,U=Math.abs,$=(d.multiplier||1)*(d.enableRetinaScaling?p.devicePixelRatio:1);delete this.group,d.withoutTransform&&w.resetObjectTransform(this),d.withoutShadow&&(this.shadow=null);var nt=p.util.createCanvasElement(),xt=this.getBoundingRect(!0,!0),Ft=this.shadow,Kt,Jt={x:0,y:0},Qt,he,ne;Ft&&(Qt=Ft.blur,Ft.nonScaling?Kt={scaleX:1,scaleY:1}:Kt=this.getObjectScaling(),Jt.x=2*Math.round(U(Ft.offsetX)+Qt)*U(Kt.scaleX),Jt.y=2*Math.round(U(Ft.offsetY)+Qt)*U(Kt.scaleY)),he=xt.width+Jt.x,ne=xt.height+Jt.y,nt.width=Math.ceil(he),nt.height=Math.ceil(ne);var me=new p.StaticCanvas(nt,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});d.format==="jpeg"&&(me.backgroundColor="#fff"),this.setPositionByOrigin(new p.Point(me.width/2,me.height/2),"center","center");var Oe=this.canvas;me.add(this);var se=me.toCanvasElement($||1,d);return this.shadow=L,this.set("canvas",Oe),O&&(this.group=O),this.set(E).setCoords(),me._objects=[],me.dispose(),me=null,se},toDataURL:function(d){return d||(d={}),p.util.toDataURL(this.toCanvasElement(d),d.format||"png",d.quality||1)},isType:function(d){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===d},complexity:function(){return 1},toJSON:function(d){return this.toObject(d)},rotate:function(d){var w=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;return w&&this._setOriginToCenter(),this.set("angle",d),w&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(d,w){w=w||this.canvas.getPointer(d);var E=new p.Point(w.x,w.y),O=this._getLeftTopCoords();return this.angle&&(E=p.util.rotatePoint(E,O,h(-this.angle))),{x:E.x-O.x,y:E.y-O.y}},_setupCompositeOperation:function(d){this.globalCompositeOperation&&(d.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){p.runningAnimations&&p.runningAnimations.cancelByTarget(this)}}),p.util.createAccessors&&p.util.createAccessors(p.Object),C(p.Object.prototype,p.Observable),p.Object.NUM_FRACTION_DIGITS=2,p.Object.ENLIVEN_PROPS=["clipPath"],p.Object._fromObject=function(d,w,E,O){var L=p[d];w=b(w,!0),p.util.enlivenPatterns([w.fill,w.stroke],function(U){typeof U[0]<"u"&&(w.fill=U[0]),typeof U[1]<"u"&&(w.stroke=U[1]),p.util.enlivenObjectEnlivables(w,w,function(){var $=O?new L(w[O],w):new L(w);E&&E($)})})},p.Object.__uid=0)}(Z),function(){var s=S.util.degreesToRadians,p={left:-.5,center:0,right:.5},C={top:-.5,center:0,bottom:.5};S.util.object.extend(S.Object.prototype,{translateToGivenOrigin:function(b,l,c,h,m){var g=b.x,d=b.y,w,E,O;return typeof l=="string"?l=p[l]:l-=.5,typeof h=="string"?h=p[h]:h-=.5,w=h-l,typeof c=="string"?c=C[c]:c-=.5,typeof m=="string"?m=C[m]:m-=.5,E=m-c,(w||E)&&(O=this._getTransformedDimensions(),g=b.x+w*O.x,d=b.y+E*O.y),new S.Point(g,d)},translateToCenterPoint:function(b,l,c){var h=this.translateToGivenOrigin(b,l,c,"center","center");return this.angle?S.util.rotatePoint(h,b,s(this.angle)):h},translateToOriginPoint:function(b,l,c){var h=this.translateToGivenOrigin(b,"center","center",l,c);return this.angle?S.util.rotatePoint(h,b,s(this.angle)):h},getCenterPoint:function(){var b=new S.Point(this.left,this.top);return this.translateToCenterPoint(b,this.originX,this.originY)},getPointByOrigin:function(b,l){var c=this.getCenterPoint();return this.translateToOriginPoint(c,b,l)},toLocalPoint:function(b,l,c){var h=this.getCenterPoint(),m,g;return typeof l<"u"&&typeof c<"u"?m=this.translateToGivenOrigin(h,"center","center",l,c):m=new S.Point(this.left,this.top),g=new S.Point(b.x,b.y),this.angle&&(g=S.util.rotatePoint(g,h,-s(this.angle))),g.subtractEquals(m)},setPositionByOrigin:function(b,l,c){var h=this.translateToCenterPoint(b,l,c),m=this.translateToOriginPoint(h,this.originX,this.originY);this.set("left",m.x),this.set("top",m.y)},adjustPosition:function(b){var l=s(this.angle),c=this.getScaledWidth(),h=S.util.cos(l)*c,m=S.util.sin(l)*c,g,d;typeof this.originX=="string"?g=p[this.originX]:g=this.originX-.5,typeof b=="string"?d=p[b]:d=b-.5,this.left+=h*(d-g),this.top+=m*(d-g),this.setCoords(),this.originX=b},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var b=this.getCenterPoint();this.originX="center",this.originY="center",this.left=b.x,this.top=b.y},_resetOrigin:function(){var b=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=b.x,this.top=b.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}})}(),function(){function s(c){return[new S.Point(c.tl.x,c.tl.y),new S.Point(c.tr.x,c.tr.y),new S.Point(c.br.x,c.br.y),new S.Point(c.bl.x,c.bl.y)]}var p=S.util,C=p.degreesToRadians,b=p.multiplyTransformMatrices,l=p.transformPoint;p.object.extend(S.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(c,h){return h?c?this.calcACoords():this.calcLineCoords():((!this.aCoords||!this.lineCoords)&&this.setCoords(!0),c?this.aCoords:this.lineCoords)},getCoords:function(c,h){return s(this._getCoords(c,h))},intersectsWithRect:function(c,h,m,g){var d=this.getCoords(m,g),w=S.Intersection.intersectPolygonRectangle(d,c,h);return w.status==="Intersection"},intersectsWithObject:function(c,h,m){var g=S.Intersection.intersectPolygonPolygon(this.getCoords(h,m),c.getCoords(h,m));return g.status==="Intersection"||c.isContainedWithinObject(this,h,m)||this.isContainedWithinObject(c,h,m)},isContainedWithinObject:function(c,h,m){for(var g=this.getCoords(h,m),d=h?c.aCoords:c.lineCoords,w=0,E=c._getImageLines(d);w<4;w++)if(!c.containsPoint(g[w],E))return!1;return!0},isContainedWithinRect:function(c,h,m,g){var d=this.getBoundingRect(m,g);return d.left>=c.x&&d.left+d.width<=h.x&&d.top>=c.y&&d.top+d.height<=h.y},containsPoint:function(c,w,m,g){var d=this._getCoords(m,g),w=w||this._getImageLines(d),E=this._findCrossPoints(c,w);return E!==0&&E%2===1},isOnScreen:function(c){if(!this.canvas)return!1;var h=this.canvas.vptCoords.tl,m=this.canvas.vptCoords.br,g=this.getCoords(!0,c);return g.some(function(d){return d.x<=m.x&&d.x>=h.x&&d.y<=m.y&&d.y>=h.y})||this.intersectsWithRect(h,m,!0,c)?!0:this._containsCenterOfCanvas(h,m,c)},_containsCenterOfCanvas:function(c,h,m){var g={x:(c.x+h.x)/2,y:(c.y+h.y)/2};return!!this.containsPoint(g,null,!0,m)},isPartiallyOnScreen:function(c){if(!this.canvas)return!1;var h=this.canvas.vptCoords.tl,m=this.canvas.vptCoords.br;if(this.intersectsWithRect(h,m,!0,c))return!0;var g=this.getCoords(!0,c).every(function(d){return(d.x>=m.x||d.x<=h.x)&&(d.y>=m.y||d.y<=h.y)});return g&&this._containsCenterOfCanvas(h,m,c)},_getImageLines:function(c){var h={topline:{o:c.tl,d:c.tr},rightline:{o:c.tr,d:c.br},bottomline:{o:c.br,d:c.bl},leftline:{o:c.bl,d:c.tl}};return h},_findCrossPoints:function(c,h){var m,g,d,w,E,O=0,L;for(var U in h)if(L=h[U],!(L.o.y<c.y&&L.d.y<c.y)&&!(L.o.y>=c.y&&L.d.y>=c.y)&&(L.o.x===L.d.x&&L.o.x>=c.x?E=L.o.x:(m=0,g=(L.d.y-L.o.y)/(L.d.x-L.o.x),d=c.y-m*c.x,w=L.o.y-g*L.o.x,E=-(d-w)/(m-g)),E>=c.x&&(O+=1),O===2))break;return O},getBoundingRect:function(c,h){var m=this.getCoords(c,h);return p.makeBoundingBoxFromPoints(m)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(c){return Math.abs(c)<this.minScaleLimit?c<0?-this.minScaleLimit:this.minScaleLimit:c===0?1e-4:c},scale:function(c){return this._set("scaleX",c),this._set("scaleY",c),this.setCoords()},scaleToWidth:function(c,h){var m=this.getBoundingRect(h).width/this.getScaledWidth();return this.scale(c/this.width/m)},scaleToHeight:function(c,h){var m=this.getBoundingRect(h).height/this.getScaledHeight();return this.scale(c/this.height/m)},calcLineCoords:function(){var c=this.getViewportTransform(),h=this.padding,m=C(this.angle),g=p.cos(m),d=p.sin(m),w=g*h,E=d*h,O=w+E,L=w-E,U=this.calcACoords(),$={tl:l(U.tl,c),tr:l(U.tr,c),bl:l(U.bl,c),br:l(U.br,c)};return h&&($.tl.x-=L,$.tl.y-=O,$.tr.x+=O,$.tr.y-=L,$.bl.x-=O,$.bl.y+=L,$.br.x+=L,$.br.y+=O),$},calcOCoords:function(){var c=this._calcRotateMatrix(),h=this._calcTranslateMatrix(),m=this.getViewportTransform(),g=b(m,h),d=b(g,c),d=b(d,[1/m[0],0,0,1/m[3],0,0]),w=this._calculateCurrentDimensions(),E={};return this.forEachControl(function(O,L,U){E[L]=O.positionHandler(w,d,U)}),E},calcACoords:function(){var c=this._calcRotateMatrix(),h=this._calcTranslateMatrix(),m=b(h,c),g=this._getTransformedDimensions(),d=g.x/2,w=g.y/2;return{tl:l({x:-d,y:-w},m),tr:l({x:d,y:-w},m),bl:l({x:-d,y:w},m),br:l({x:d,y:w},m)}},setCoords:function(c){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),c?this:(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords(),this)},_calcRotateMatrix:function(){return p.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var c=this.getCenterPoint();return[1,0,0,1,c.x,c.y]},transformMatrixKey:function(c){var h="_",m="";return!c&&this.group&&(m=this.group.transformMatrixKey(c)+h),m+this.top+h+this.left+h+this.scaleX+h+this.scaleY+h+this.skewX+h+this.skewY+h+this.angle+h+this.originX+h+this.originY+h+this.width+h+this.height+h+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(c){var h=this.calcOwnMatrix();if(c||!this.group)return h;var m=this.transformMatrixKey(c),g=this.matrixCache||(this.matrixCache={});return g.key===m?g.value:(this.group&&(h=b(this.group.calcTransformMatrix(!1),h)),g.key=m,g.value=h,h)},calcOwnMatrix:function(){var c=this.transformMatrixKey(!0),h=this.ownMatrixCache||(this.ownMatrixCache={});if(h.key===c)return h.value;var m=this._calcTranslateMatrix(),g={angle:this.angle,translateX:m[4],translateY:m[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return h.key=c,h.value=p.composeMatrix(g),h.value},_getNonTransformedDimensions:function(){var c=this.strokeWidth,h=this.width+c,m=this.height+c;return{x:h,y:m}},_getTransformedDimensions:function(c,h){typeof c>"u"&&(c=this.skewX),typeof h>"u"&&(h=this.skewY);var m,g,d,w=c===0&&h===0;if(this.strokeUniform?(g=this.width,d=this.height):(m=this._getNonTransformedDimensions(),g=m.x,d=m.y),w)return this._finalizeDimensions(g*this.scaleX,d*this.scaleY);var E=p.sizeAfterTransform(g,d,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:c,skewY:h});return this._finalizeDimensions(E.x,E.y)},_finalizeDimensions:function(c,h){return this.strokeUniform?{x:c+this.strokeWidth,y:h+this.strokeWidth}:{x:c,y:h}},_calculateCurrentDimensions:function(){var c=this.getViewportTransform(),h=this._getTransformedDimensions(),m=l(h,c,!0);return m.scalarAdd(2*this.padding)}})}(),S.util.object.extend(S.Object.prototype,{sendToBack:function(){return this.group?S.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?S.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(s){return this.group?S.StaticCanvas.prototype.sendBackwards.call(this.group,this,s):this.canvas&&this.canvas.sendBackwards(this,s),this},bringForward:function(s){return this.group?S.StaticCanvas.prototype.bringForward.call(this.group,this,s):this.canvas&&this.canvas.bringForward(this,s),this},moveTo:function(s){return this.group&&this.group.type!=="activeSelection"?S.StaticCanvas.prototype.moveTo.call(this.group,this,s):this.canvas&&this.canvas.moveTo(this,s),this}}),function(){function s(C,b){if(b){if(b.toLive)return C+": url(#SVGID_"+b.id+"); ";var l=new S.Color(b),c=C+": "+l.toRgb()+"; ",h=l.getAlpha();return h!==1&&(c+=C+"-opacity: "+h.toString()+"; "),c}else return C+": none; "}var p=S.util.toFixed;S.util.object.extend(S.Object.prototype,{getSvgStyles:function(C){var b=this.fillRule?this.fillRule:"nonzero",l=this.strokeWidth?this.strokeWidth:"0",c=this.strokeDashArray?this.strokeDashArray.join(" "):"none",h=this.strokeDashOffset?this.strokeDashOffset:"0",m=this.strokeLineCap?this.strokeLineCap:"butt",g=this.strokeLineJoin?this.strokeLineJoin:"miter",d=this.strokeMiterLimit?this.strokeMiterLimit:"4",w=typeof this.opacity<"u"?this.opacity:"1",E=this.visible?"":" visibility: hidden;",O=C?"":this.getSvgFilter(),L=s("fill",this.fill),U=s("stroke",this.stroke);return[U,"stroke-width: ",l,"; ","stroke-dasharray: ",c,"; ","stroke-linecap: ",m,"; ","stroke-dashoffset: ",h,"; ","stroke-linejoin: ",g,"; ","stroke-miterlimit: ",d,"; ",L,"fill-rule: ",b,"; ","opacity: ",w,";",O,E].join("")},getSvgSpanStyles:function(C,b){var l="; ",h=C.fontFamily?"font-family: "+(C.fontFamily.indexOf("'")===-1&&C.fontFamily.indexOf('"')===-1?"'"+C.fontFamily+"'":C.fontFamily)+l:"",c=C.strokeWidth?"stroke-width: "+C.strokeWidth+l:"",h=h,m=C.fontSize?"font-size: "+C.fontSize+"px"+l:"",g=C.fontStyle?"font-style: "+C.fontStyle+l:"",d=C.fontWeight?"font-weight: "+C.fontWeight+l:"",w=C.fill?s("fill",C.fill):"",E=C.stroke?s("stroke",C.stroke):"",O=this.getSvgTextDecoration(C),L=C.deltaY?"baseline-shift: "+-C.deltaY+"; ":"";return O&&(O="text-decoration: "+O+l),[E,c,h,m,g,d,O,w,L,b?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(C){return["overline","underline","line-through"].filter(function(b){return C[b.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(C,b){var l=C?this.calcTransformMatrix():this.calcOwnMatrix(),c='transform="'+S.util.matrixToSVG(l);return c+(b||"")+'" '},_setSVGBg:function(C){if(this.backgroundColor){var b=S.Object.NUM_FRACTION_DIGITS;C.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',p(-this.width/2,b),'" y="',p(-this.height/2,b),'" width="',p(this.width,b),'" height="',p(this.height,b),`"></rect>
`)}},toSVG:function(C){return this._createBaseSVGMarkup(this._toSVG(C),{reviver:C})},toClipPathSVG:function(C){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(C),{reviver:C})},_createBaseClipPathSVGMarkup:function(C,b){b=b||{};var l=b.reviver,c=b.additionalTransform||"",h=[this.getSvgTransform(!0,c),this.getSvgCommons()].join(""),m=C.indexOf("COMMON_PARTS");return C[m]=h,l?l(C.join("")):C.join("")},_createBaseSVGMarkup:function(C,b){b=b||{};var l=b.noStyle,c=b.reviver,h=l?"":'style="'+this.getSvgStyles()+'" ',m=b.withShadow?'style="'+this.getSvgFilter()+'" ':"",g=this.clipPath,d=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",w=g&&g.absolutePositioned,E=this.stroke,O=this.fill,L=this.shadow,U,$=[],nt,xt=C.indexOf("COMMON_PARTS"),Ft=b.additionalTransform;return g&&(g.clipPathId="CLIPPATH_"+S.Object.__uid++,nt='<clipPath id="'+g.clipPathId+`" >
`+g.toClipPathSVG(c)+`</clipPath>
`),w&&$.push("<g ",m,this.getSvgCommons(),` >
`),$.push("<g ",this.getSvgTransform(!1),w?"":m+this.getSvgCommons(),` >
`),U=[h,d,l?"":this.addPaintOrder()," ",Ft?'transform="'+Ft+'" ':""].join(""),C[xt]=U,O&&O.toLive&&$.push(O.toSVG(this)),E&&E.toLive&&$.push(E.toSVG(this)),L&&$.push(L.toSVG(this)),g&&$.push(nt),$.push(C.join("")),$.push(`</g>
`),w&&$.push(`</g>
`),c?c($.join("")):$.join("")},addPaintOrder:function(){return this.paintFirst!=="fill"?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var s=S.util.object.extend,p="stateProperties";function C(l,c,h){var m={},g=!0;h.forEach(function(d){m[d]=l[d]}),s(l[c],m,g)}function b(l,c,h){if(l===c)return!0;if(Array.isArray(l)){if(!Array.isArray(c)||l.length!==c.length)return!1;for(var m=0,g=l.length;m<g;m++)if(!b(l[m],c[m]))return!1;return!0}else if(l&&typeof l=="object"){var d=Object.keys(l),w;if(!c||typeof c!="object"||!h&&d.length!==Object.keys(c).length)return!1;for(var m=0,g=d.length;m<g;m++)if(w=d[m],!(w==="canvas"||w==="group")&&!b(l[w],c[w]))return!1;return!0}}S.util.object.extend(S.Object.prototype,{hasStateChanged:function(l){l=l||p;var c="_"+l;return Object.keys(this[c]).length<this[l].length?!0:!b(this[c],this,!0)},saveState:function(l){var c=l&&l.propertySet||p,h="_"+c;return this[h]?(C(this,h,this[c]),l&&l.stateProperties&&C(this,h,l.stateProperties),this):this.setupState(l)},setupState:function(l){l=l||{};var c=l.propertySet||p;return l.propertySet=c,this["_"+c]={},this.saveState(l),this}})}(),function(){var s=S.util.degreesToRadians;S.util.object.extend(S.Object.prototype,{_findTargetCorner:function(p,C){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var b=p.x,l=p.y,c,h,m=Object.keys(this.oCoords),g=m.length-1,d;for(this.__corner=0;g>=0;g--)if(d=m[g],!!this.isControlVisible(d)&&(h=this._getImageLines(C?this.oCoords[d].touchCorner:this.oCoords[d].corner),c=this._findCrossPoints({x:b,y:l},h),c!==0&&c%2===1))return this.__corner=d,d;return!1},forEachControl:function(p){for(var C in this.controls)p(this.controls[C],C,this)},_setCornerCoords:function(){var p=this.oCoords;for(var C in p){var b=this.controls[C];p[C].corner=b.calcCornerCoords(this.angle,this.cornerSize,p[C].x,p[C].y,!1),p[C].touchCorner=b.calcCornerCoords(this.angle,this.touchCornerSize,p[C].x,p[C].y,!0)}},drawSelectionBackground:function(p){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;p.save();var C=this.getCenterPoint(),b=this._calculateCurrentDimensions(),l=this.canvas.viewportTransform;return p.translate(C.x,C.y),p.scale(1/l[0],1/l[3]),p.rotate(s(this.angle)),p.fillStyle=this.selectionBackgroundColor,p.fillRect(-b.x/2,-b.y/2,b.x,b.y),p.restore(),this},drawBorders:function(p,C){C=C||{};var b=this._calculateCurrentDimensions(),l=this.borderScaleFactor,c=b.x+l,h=b.y+l,m=typeof C.hasControls<"u"?C.hasControls:this.hasControls,g=!1;return p.save(),p.strokeStyle=C.borderColor||this.borderColor,this._setLineDash(p,C.borderDashArray||this.borderDashArray),p.strokeRect(-c/2,-h/2,c,h),m&&(p.beginPath(),this.forEachControl(function(d,w,E){d.withConnection&&d.getVisibility(E,w)&&(g=!0,p.moveTo(d.x*c,d.y*h),p.lineTo(d.x*c+d.offsetX,d.y*h+d.offsetY))}),g&&p.stroke()),p.restore(),this},drawBordersInGroup:function(p,C,b){b=b||{};var l=S.util.sizeAfterTransform(this.width,this.height,C),c=this.strokeWidth,h=this.strokeUniform,m=this.borderScaleFactor,g=l.x+c*(h?this.canvas.getZoom():C.scaleX)+m,d=l.y+c*(h?this.canvas.getZoom():C.scaleY)+m;return p.save(),this._setLineDash(p,b.borderDashArray||this.borderDashArray),p.strokeStyle=b.borderColor||this.borderColor,p.strokeRect(-g/2,-d/2,g,d),p.restore(),this},drawControls:function(p,C){C=C||{},p.save();var b=this.canvas.getRetinaScaling(),l,c;return p.setTransform(b,0,0,b,0,0),p.strokeStyle=p.fillStyle=C.cornerColor||this.cornerColor,this.transparentCorners||(p.strokeStyle=C.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(p,C.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(l=this.group.calcTransformMatrix()),this.forEachControl(function(h,m,g){c=g.oCoords[m],h.getVisibility(g,m)&&(l&&(c=S.util.transformPoint(c,l)),h.render(p,c.x,c.y,C,g))}),p.restore(),this},isControlVisible:function(p){return this.controls[p]&&this.controls[p].getVisibility(this,p)},setControlVisible:function(p,C){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[p]=C,this},setControlsVisibility:function(p){p||(p={});for(var C in p)this.setControlVisible(C,p[C]);return this},onDeselect:function(){},onSelect:function(){}})}(),S.util.object.extend(S.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(s,p){p=p||{};var C=function(){},b=p.onComplete||C,l=p.onChange||C,c=this;return S.util.animate({target:this,startValue:s.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(h){s.set("left",h),c.requestRenderAll(),l()},onComplete:function(){s.setCoords(),b()}})},fxCenterObjectV:function(s,p){p=p||{};var C=function(){},b=p.onComplete||C,l=p.onChange||C,c=this;return S.util.animate({target:this,startValue:s.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(h){s.set("top",h),c.requestRenderAll(),l()},onComplete:function(){s.setCoords(),b()}})},fxRemove:function(s,p){p=p||{};var C=function(){},b=p.onComplete||C,l=p.onChange||C,c=this;return S.util.animate({target:this,startValue:s.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(h){s.set("opacity",h),c.requestRenderAll(),l()},onComplete:function(){c.remove(s),b()}})}}),S.util.object.extend(S.Object.prototype,{animate:function(){if(arguments[0]&&typeof arguments[0]=="object"){var s=[],p,C,b=[];for(p in arguments[0])s.push(p);for(var l=0,c=s.length;l<c;l++)p=s[l],C=l!==c-1,b.push(this._animate(p,arguments[0][p],arguments[1],C));return b}else return this._animate.apply(this,arguments)},_animate:function(s,p,C,b){var l=this,c;p=p.toString(),C?C=S.util.object.clone(C):C={},~s.indexOf(".")&&(c=s.split("."));var h=l.colorProperties.indexOf(s)>-1||c&&l.colorProperties.indexOf(c[1])>-1,m=c?this.get(c[0])[c[1]]:this.get(s);"from"in C||(C.from=m),h||(~p.indexOf("=")?p=m+parseFloat(p.replace("=","")):p=parseFloat(p));var g={target:this,startValue:C.from,endValue:p,byValue:C.by,easing:C.easing,duration:C.duration,abort:C.abort&&function(d,w,E){return C.abort.call(l,d,w,E)},onChange:function(d,w,E){c?l[c[0]][c[1]]=d:l.set(s,d),!b&&C.onChange&&C.onChange(d,w,E)},onComplete:function(d,w,E){b||(l.setCoords(),C.onComplete&&C.onComplete(d,w,E))}};return h?S.util.animateColor(g.startValue,g.endValue,g.duration,g):S.util.animate(g)}}),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.util.object.clone,l={x1:1,x2:1,y1:1,y2:1};if(p.Line){p.warn("fabric.Line is already defined");return}p.Line=p.util.createClass(p.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:p.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(h,m){h||(h=[0,0,0,0]),this.callSuper("initialize",m),this.set("x1",h[0]),this.set("y1",h[1]),this.set("x2",h[2]),this.set("y2",h[3]),this._setWidthHeight(m)},_setWidthHeight:function(h){h||(h={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in h?h.left:this._getLeftToOriginX(),this.top="top"in h?h.top:this._getTopToOriginY()},_set:function(h,m){return this.callSuper("_set",h,m),typeof l[h]<"u"&&this._setWidthHeight(),this},_getLeftToOriginX:c({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:c({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(h){h.beginPath();var m=this.calcLinePoints();h.moveTo(m.x1,m.y1),h.lineTo(m.x2,m.y2),h.lineWidth=this.strokeWidth;var g=h.strokeStyle;h.strokeStyle=this.stroke||h.fillStyle,this.stroke&&this._renderStroke(h),h.strokeStyle=g},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(h){return C(this.callSuper("toObject",h),this.calcLinePoints())},_getNonTransformedDimensions:function(){var h=this.callSuper("_getNonTransformedDimensions");return this.strokeLineCap==="butt"&&(this.width===0&&(h.y-=this.strokeWidth),this.height===0&&(h.x-=this.strokeWidth)),h},calcLinePoints:function(){var h=this.x1<=this.x2?-1:1,m=this.y1<=this.y2?-1:1,g=h*this.width*.5,d=m*this.height*.5,w=h*this.width*-.5,E=m*this.height*-.5;return{x1:g,x2:w,y1:d,y2:E}},_toSVG:function(){var h=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',h.x1,'" y1="',h.y1,'" x2="',h.x2,'" y2="',h.y2,`" />
`]}}),p.Line.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),p.Line.fromElement=function(h,m,g){g=g||{};var d=p.parseAttributes(h,p.Line.ATTRIBUTE_NAMES),w=[d.x1||0,d.y1||0,d.x2||0,d.y2||0];m(new p.Line(w,C(d,g)))},p.Line.fromObject=function(h,m){function g(w){delete w.points,m&&m(w)}var d=b(h,!0);d.points=[h.x1,h.y1,h.x2,h.y2],p.Object._fromObject("Line",d,g,"points")};function c(h,m){var g=h.origin,d=h.axis1,w=h.axis2,E=h.dimension,O=m.nearest,L=m.center,U=m.farthest;return function(){switch(this.get(g)){case O:return Math.min(this.get(d),this.get(w));case L:return Math.min(this.get(d),this.get(w))+.5*this.get(E);case U:return Math.max(this.get(d),this.get(w))}}}}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.util.degreesToRadians;if(p.Circle){p.warn("fabric.Circle is already defined.");return}p.Circle=p.util.createClass(p.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:p.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(l,c){return this.callSuper("_set",l,c),l==="radius"&&this.setRadius(c),this},toObject:function(l){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(l))},_toSVG:function(){var l,c=0,h=0,m=(this.endAngle-this.startAngle)%360;if(m===0)l=["<circle ","COMMON_PARTS",'cx="'+c+'" cy="'+h+'" ','r="',this.radius,`" />
`];else{var g=C(this.startAngle),d=C(this.endAngle),w=this.radius,E=p.util.cos(g)*w,O=p.util.sin(g)*w,L=p.util.cos(d)*w,U=p.util.sin(d)*w,$=m>180?"1":"0";l=['<path d="M '+E+" "+O," A "+w+" "+w," 0 ",+$+" 1"," "+L+" "+U,'" ',"COMMON_PARTS",` />
`]}return l},_render:function(l){l.beginPath(),l.arc(0,0,this.radius,C(this.startAngle),C(this.endAngle),!1),this._renderPaintInOrder(l)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(l){return this.radius=l,this.set("width",l*2).set("height",l*2)}}),p.Circle.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),p.Circle.fromElement=function(l,c){var h=p.parseAttributes(l,p.Circle.ATTRIBUTE_NAMES);if(!b(h))throw new Error("value of `r` attribute is required and can not be negative");h.left=(h.left||0)-h.radius,h.top=(h.top||0)-h.radius,c(new p.Circle(h))};function b(l){return"radius"in l&&l.radius>=0}p.Circle.fromObject=function(l,c){p.Object._fromObject("Circle",l,c)}}(Z),function(s){var p=s.fabric||(s.fabric={});if(p.Triangle){p.warn("fabric.Triangle is already defined");return}p.Triangle=p.util.createClass(p.Object,{type:"triangle",width:100,height:100,_render:function(C){var b=this.width/2,l=this.height/2;C.beginPath(),C.moveTo(-b,l),C.lineTo(0,-l),C.lineTo(b,l),C.closePath(),this._renderPaintInOrder(C)},_toSVG:function(){var C=this.width/2,b=this.height/2,l=[-C+" "+b,"0 "+-b,C+" "+b].join(",");return["<polygon ","COMMON_PARTS",'points="',l,'" />']}}),p.Triangle.fromObject=function(C,b){return p.Object._fromObject("Triangle",C,b)}}(Z),function(s){var p=s.fabric||(s.fabric={}),C=Math.PI*2;if(p.Ellipse){p.warn("fabric.Ellipse is already defined.");return}p.Ellipse=p.util.createClass(p.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:p.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(b){this.callSuper("initialize",b),this.set("rx",b&&b.rx||0),this.set("ry",b&&b.ry||0)},_set:function(b,l){switch(this.callSuper("_set",b,l),b){case"rx":this.rx=l,this.set("width",l*2);break;case"ry":this.ry=l,this.set("height",l*2);break}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(b){return this.callSuper("toObject",["rx","ry"].concat(b))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,`" />
`]},_render:function(b){b.beginPath(),b.save(),b.transform(1,0,0,this.ry/this.rx,0,0),b.arc(0,0,this.rx,0,C,!1),b.restore(),this._renderPaintInOrder(b)}}),p.Ellipse.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),p.Ellipse.fromElement=function(b,l){var c=p.parseAttributes(b,p.Ellipse.ATTRIBUTE_NAMES);c.left=(c.left||0)-c.rx,c.top=(c.top||0)-c.ry,l(new p.Ellipse(c))},p.Ellipse.fromObject=function(b,l){p.Object._fromObject("Ellipse",b,l)}}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend;if(p.Rect){p.warn("fabric.Rect is already defined");return}p.Rect=p.util.createClass(p.Object,{stateProperties:p.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:p.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(b){this.callSuper("initialize",b),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(b){var l=this.rx?Math.min(this.rx,this.width/2):0,c=this.ry?Math.min(this.ry,this.height/2):0,h=this.width,m=this.height,g=-this.width/2,d=-this.height/2,w=l!==0||c!==0,E=1-.5522847498;b.beginPath(),b.moveTo(g+l,d),b.lineTo(g+h-l,d),w&&b.bezierCurveTo(g+h-E*l,d,g+h,d+E*c,g+h,d+c),b.lineTo(g+h,d+m-c),w&&b.bezierCurveTo(g+h,d+m-E*c,g+h-E*l,d+m,g+h-l,d+m),b.lineTo(g+l,d+m),w&&b.bezierCurveTo(g+E*l,d+m,g,d+m-E*c,g,d+m-c),b.lineTo(g,d+c),w&&b.bezierCurveTo(g,d+E*c,g+E*l,d,g+l,d),b.closePath(),this._renderPaintInOrder(b)},toObject:function(b){return this.callSuper("toObject",["rx","ry"].concat(b))},_toSVG:function(){var b=-this.width/2,l=-this.height/2;return["<rect ","COMMON_PARTS",'x="',b,'" y="',l,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,`" />
`]}}),p.Rect.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),p.Rect.fromElement=function(b,l,c){if(!b)return l(null);c=c||{};var h=p.parseAttributes(b,p.Rect.ATTRIBUTE_NAMES);h.left=h.left||0,h.top=h.top||0,h.height=h.height||0,h.width=h.width||0;var m=new p.Rect(C(c?p.util.object.clone(c):{},h));m.visible=m.visible&&m.width>0&&m.height>0,l(m)},p.Rect.fromObject=function(b,l){return p.Object._fromObject("Rect",b,l)}}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.util.array.min,l=p.util.array.max,c=p.util.toFixed,h=p.util.projectStrokeOnPoints;if(p.Polyline){p.warn("fabric.Polyline is already defined");return}p.Polyline=p.util.createClass(p.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:p.Object.prototype.cacheProperties.concat("points"),initialize:function(m,g){g=g||{},this.points=m||[],this.callSuper("initialize",g),this._setPositionDimensions(g)},_projectStrokeOnPoints:function(){return h(this.points,this,!0)},_setPositionDimensions:function(m){var g=this._calcDimensions(m),d,w=this.exactBoundingBox?this.strokeWidth:0;this.width=g.width-w,this.height=g.height-w,m.fromSVG||(d=this.translateToGivenOrigin({x:g.left-this.strokeWidth/2+w/2,y:g.top-this.strokeWidth/2+w/2},"left","top",this.originX,this.originY)),typeof m.left>"u"&&(this.left=m.fromSVG?g.left:d.x),typeof m.top>"u"&&(this.top=m.fromSVG?g.top:d.y),this.pathOffset={x:g.left+this.width/2+w/2,y:g.top+this.height/2+w/2}},_calcDimensions:function(){var m=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,g=b(m,"x")||0,d=b(m,"y")||0,w=l(m,"x")||0,E=l(m,"y")||0,O=w-g,L=E-d;return{left:g,top:d,width:O,height:L}},toObject:function(m){return C(this.callSuper("toObject",m),{points:this.points.concat()})},_toSVG:function(){for(var m=[],g=this.pathOffset.x,d=this.pathOffset.y,w=p.Object.NUM_FRACTION_DIGITS,E=0,O=this.points.length;E<O;E++)m.push(c(this.points[E].x-g,w),",",c(this.points[E].y-d,w)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',m.join(""),`" />
`]},commonRender:function(m){var g,d=this.points.length,w=this.pathOffset.x,E=this.pathOffset.y;if(!d||isNaN(this.points[d-1].y))return!1;m.beginPath(),m.moveTo(this.points[0].x-w,this.points[0].y-E);for(var O=0;O<d;O++)g=this.points[O],m.lineTo(g.x-w,g.y-E);return!0},_render:function(m){this.commonRender(m)&&this._renderPaintInOrder(m)},complexity:function(){return this.get("points").length}}),p.Polyline.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat(),p.Polyline.fromElementGenerator=function(m){return function(g,d,w){if(!g)return d(null);w||(w={});var E=p.parsePointsAttribute(g.getAttribute("points")),O=p.parseAttributes(g,p[m].ATTRIBUTE_NAMES);O.fromSVG=!0,d(new p[m](E,C(O,w)))}},p.Polyline.fromElement=p.Polyline.fromElementGenerator("Polyline"),p.Polyline.fromObject=function(m,g){return p.Object._fromObject("Polyline",m,g,"points")}}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.util.projectStrokeOnPoints;if(p.Polygon){p.warn("fabric.Polygon is already defined");return}p.Polygon=p.util.createClass(p.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return C(this.points,this)},_render:function(b){this.commonRender(b)&&(b.closePath(),this._renderPaintInOrder(b))}}),p.Polygon.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat(),p.Polygon.fromElement=p.Polyline.fromElementGenerator("Polygon"),p.Polygon.fromObject=function(b,l){p.Object._fromObject("Polygon",b,l,"points")}}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.util.array.min,b=p.util.array.max,l=p.util.object.extend,c=p.util.object.clone,h=p.util.toFixed;if(p.Path){p.warn("fabric.Path is already defined");return}p.Path=p.util.createClass(p.Object,{type:"path",path:null,cacheProperties:p.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:p.Object.prototype.stateProperties.concat("path"),initialize:function(m,g){g=c(g||{}),delete g.path,this.callSuper("initialize",g),this._setPath(m||[],g)},_setPath:function(m,g){this.path=p.util.makePathSimpler(Array.isArray(m)?m:p.util.parsePath(m)),p.Polyline.prototype._setPositionDimensions.call(this,g||{})},_renderPathCommands:function(m){var g,d=0,w=0,E=0,O=0,L=0,U=0,$=-this.pathOffset.x,nt=-this.pathOffset.y;m.beginPath();for(var xt=0,Ft=this.path.length;xt<Ft;++xt)switch(g=this.path[xt],g[0]){case"L":E=g[1],O=g[2],m.lineTo(E+$,O+nt);break;case"M":E=g[1],O=g[2],d=E,w=O,m.moveTo(E+$,O+nt);break;case"C":E=g[5],O=g[6],L=g[3],U=g[4],m.bezierCurveTo(g[1]+$,g[2]+nt,L+$,U+nt,E+$,O+nt);break;case"Q":m.quadraticCurveTo(g[1]+$,g[2]+nt,g[3]+$,g[4]+nt),E=g[3],O=g[4],L=g[1],U=g[2];break;case"z":case"Z":E=d,O=w,m.closePath();break}},_render:function(m){this._renderPathCommands(m),this._renderPaintInOrder(m)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(m){return l(this.callSuper("toObject",m),{path:this.path.map(function(g){return g.slice()})})},toDatalessObject:function(m){var g=this.toObject(["sourcePath"].concat(m));return g.sourcePath&&delete g.path,g},_toSVG:function(){var m=p.util.joinPath(this.path);return["<path ","COMMON_PARTS",'d="',m,'" stroke-linecap="round" ',`/>
`]},_getOffsetTransform:function(){var m=p.Object.NUM_FRACTION_DIGITS;return" translate("+h(-this.pathOffset.x,m)+", "+h(-this.pathOffset.y,m)+")"},toClipPathSVG:function(m){var g=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:m,additionalTransform:g})},toSVG:function(m){var g=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:m,additionalTransform:g})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var m=[],g=[],d,w=0,E=0,O=0,L=0,U,$=0,nt=this.path.length;$<nt;++$){switch(d=this.path[$],d[0]){case"L":O=d[1],L=d[2],U=[];break;case"M":O=d[1],L=d[2],w=O,E=L,U=[];break;case"C":U=p.util.getBoundsOfCurve(O,L,d[1],d[2],d[3],d[4],d[5],d[6]),O=d[5],L=d[6];break;case"Q":U=p.util.getBoundsOfCurve(O,L,d[1],d[2],d[1],d[2],d[3],d[4]),O=d[3],L=d[4];break;case"z":case"Z":O=w,L=E;break}U.forEach(function(ne){m.push(ne.x),g.push(ne.y)}),m.push(O),g.push(L)}var xt=C(m)||0,Ft=C(g)||0,Kt=b(m)||0,Jt=b(g)||0,Qt=Kt-xt,he=Jt-Ft;return{left:xt,top:Ft,width:Qt,height:he}}}),p.Path.fromObject=function(m,g){if(typeof m.sourcePath=="string"){var d=m.sourcePath;p.loadSVGFromURL(d,function(w){var E=w[0];E.setOptions(m),m.clipPath?p.util.enlivenObjects([m.clipPath],function(O){E.clipPath=O[0],g&&g(E)}):g&&g(E)})}else p.Object._fromObject("Path",m,g,"path")},p.Path.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat(["d"]),p.Path.fromElement=function(m,g,d){var w=p.parseAttributes(m,p.Path.ATTRIBUTE_NAMES);w.fromSVG=!0,g(new p.Path(w.d,l(w,d)))}}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.util.array.min,b=p.util.array.max;p.Group||(p.Group=p.util.createClass(p.Object,p.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(l,c,h){c=c||{},this._objects=[],h&&this.callSuper("initialize",c),this._objects=l||[];for(var m=this._objects.length;m--;)this._objects[m].group=this;if(h)this._updateObjectsACoords();else{var g=c&&c.centerPoint;c.originX!==void 0&&(this.originX=c.originX),c.originY!==void 0&&(this.originY=c.originY),g||this._calcBounds(),this._updateObjectsCoords(g),delete c.centerPoint,this.callSuper("initialize",c)}this.setCoords()},_updateObjectsACoords:function(){for(var l=!0,c=this._objects.length;c--;)this._objects[c].setCoords(l)},_updateObjectsCoords:function(c){for(var c=c||this.getCenterPoint(),h=this._objects.length;h--;)this._updateObjectCoords(this._objects[h],c)},_updateObjectCoords:function(l,c){var h=l.left,m=l.top,g=!0;l.set({left:h-c.x,top:m-c.y}),l.group=this,l.setCoords(g)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(l){var c=!!this.group;return this._restoreObjectsState(),p.util.resetObjectTransform(this),l&&(c&&p.util.removeTransformFromObject(l,this.group.calcTransformMatrix()),this._objects.push(l),l.group=this,l._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,c?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(l){return this._restoreObjectsState(),p.util.resetObjectTransform(this),this.remove(l),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(l){this.dirty=!0,l.group=this,l._set("canvas",this.canvas)},_onObjectRemoved:function(l){this.dirty=!0,delete l.group},_set:function(l,c){var h=this._objects.length;if(this.useSetOnGroup)for(;h--;)this._objects[h].setOnGroup(l,c);if(l==="canvas")for(;h--;)this._objects[h]._set(l,c);p.Object.prototype._set.call(this,l,c)},toObject:function(l){var c=this.includeDefaultValues,h=this._objects.filter(function(g){return!g.excludeFromExport}).map(function(g){var d=g.includeDefaultValues;g.includeDefaultValues=c;var w=g.toObject(l);return g.includeDefaultValues=d,w}),m=p.Object.prototype.toObject.call(this,l);return m.objects=h,m},toDatalessObject:function(l){var c,h=this.sourcePath;if(h)c=h;else{var m=this.includeDefaultValues;c=this._objects.map(function(d){var w=d.includeDefaultValues;d.includeDefaultValues=m;var E=d.toDatalessObject(l);return d.includeDefaultValues=w,E})}var g=p.Object.prototype.toDatalessObject.call(this,l);return g.objects=c,g},render:function(l){this._transformDone=!0,this.callSuper("render",l),this._transformDone=!1},shouldCache:function(){var l=p.Object.prototype.shouldCache.call(this);if(l){for(var c=0,h=this._objects.length;c<h;c++)if(this._objects[c].willDrawShadow())return this.ownCaching=!1,!1}return l},willDrawShadow:function(){if(p.Object.prototype.willDrawShadow.call(this))return!0;for(var l=0,c=this._objects.length;l<c;l++)if(this._objects[l].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(l){for(var c=0,h=this._objects.length;c<h;c++)this._objects[c].render(l);this._drawClipPath(l,this.clipPath)},isCacheDirty:function(l){if(this.callSuper("isCacheDirty",l))return!0;if(!this.statefullCache)return!1;for(var c=0,h=this._objects.length;c<h;c++)if(this._objects[c].isCacheDirty(!0)){if(this._cacheCanvas){var m=this.cacheWidth/this.zoomX,g=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-m/2,-g/2,m,g)}return!0}return!1},_restoreObjectsState:function(){var l=this.calcOwnMatrix();return this._objects.forEach(function(c){p.util.addTransformToObject(c,l),delete c.group,c.setCoords()}),this},destroy:function(){return this._objects.forEach(function(l){l.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(l){l.dispose&&l.dispose()}),this._objects=[]},toActiveSelection:function(){if(this.canvas){var l=this._objects,c=this.canvas;this._objects=[];var h=this.toObject();delete h.objects;var m=new p.ActiveSelection([]);return m.set(h),m.type="activeSelection",c.remove(this),l.forEach(function(g){g.group=m,g.dirty=!0,c.add(g)}),m.canvas=c,m._objects=l,c._activeObject=m,m.setCoords(),m}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){var l=!0;return this.forEachObject(function(c){c.setCoords(l)}),this},_calcBounds:function(l){for(var c=[],h=[],m,g,d,w=["tr","br","bl","tl"],E=0,O=this._objects.length,L,U=w.length;E<O;++E){for(m=this._objects[E],d=m.calcACoords(),L=0;L<U;L++)g=w[L],c.push(d[g].x),h.push(d[g].y);m.aCoords=d}this._getBounds(c,h,l)},_getBounds:function(l,c,h){var m=new p.Point(C(l),C(c)),g=new p.Point(b(l),b(c)),d=m.y||0,w=m.x||0,E=g.x-m.x||0,O=g.y-m.y||0;this.width=E,this.height=O,h||this.setPositionByOrigin({x:w,y:d},"left","top")},_toSVG:function(l){for(var c=["<g ","COMMON_PARTS",` >
`],h=0,m=this._objects.length;h<m;h++)c.push("		",this._objects[h].toSVG(l));return c.push(`</g>
`),c},getSvgStyles:function(){var l=typeof this.opacity<"u"&&this.opacity!==1?"opacity: "+this.opacity+";":"",c=this.visible?"":" visibility: hidden;";return[l,this.getSvgFilter(),c].join("")},toClipPathSVG:function(l){for(var c=[],h=0,m=this._objects.length;h<m;h++)c.push("	",this._objects[h].toClipPathSVG(l));return this._createBaseClipPathSVGMarkup(c,{reviver:l})}}),p.Group.fromObject=function(l,c){var h=l.objects,m=p.util.object.clone(l,!0);if(delete m.objects,typeof h=="string"){p.loadSVGFromURL(h,function(g){var d=p.util.groupSVGElements(g,l,h),w=m.clipPath;delete m.clipPath,d.set(m),w?p.util.enlivenObjects([w],function(E){d.clipPath=E[0],c&&c(d)}):c&&c(d)});return}p.util.enlivenObjects(h,function(g){p.util.enlivenObjectEnlivables(l,m,function(){c&&c(new p.Group(g,m,!0))})})})}(Z),function(s){var p=s.fabric||(s.fabric={});p.ActiveSelection||(p.ActiveSelection=p.util.createClass(p.Group,{type:"activeSelection",initialize:function(C,b){b=b||{},this._objects=C||[];for(var l=this._objects.length;l--;)this._objects[l].group=this;b.originX&&(this.originX=b.originX),b.originY&&(this.originY=b.originY),this._calcBounds(),this._updateObjectsCoords(),p.Object.prototype.initialize.call(this,b),this.setCoords()},toGroup:function(){var C=this._objects.concat();this._objects=[];var b=p.Object.prototype.toObject.call(this),l=new p.Group([]);if(delete b.type,l.set(b),C.forEach(function(h){h.canvas.remove(h),h.group=l}),l._objects=C,!this.canvas)return l;var c=this.canvas;return c.add(l),c._activeObject=l,l.setCoords(),l},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(C,b,l){C.save(),C.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",C,b),l=l||{},typeof l.hasControls>"u"&&(l.hasControls=!1),l.forActiveSelection=!0;for(var c=0,h=this._objects.length;c<h;c++)this._objects[c]._renderControls(C,l);C.restore()}}),p.ActiveSelection.fromObject=function(C,b){p.util.enlivenObjects(C.objects,function(l){delete C.objects,b&&b(new p.ActiveSelection(l,C,!0))})})}(Z),function(s){var p=S.util.object.extend;if(s.fabric||(s.fabric={}),s.fabric.Image){S.warn("fabric.Image is already defined.");return}S.Image=S.util.createClass(S.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:S.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:S.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(C,b){b||(b={}),this.filters=[],this.cacheKey="texture"+S.Object.__uid++,this.callSuper("initialize",b),this._initElement(C,b)},getElement:function(){return this._element||{}},setElement:function(C,b){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=C,this._originalElement=C,this._initConfig(b),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(C){var b=S.filterBackend;b&&b.evictCachesForKey&&b.evictCachesForKey(C)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach((function(C){S.util.cleanUpJsdomNode(this[C]),this[C]=void 0}).bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var C=this.getElement();return{width:C.naturalWidth||C.width,height:C.naturalHeight||C.height}},_stroke:function(C){if(!(!this.stroke||this.strokeWidth===0)){var b=this.width/2,l=this.height/2;C.beginPath(),C.moveTo(-b,-l),C.lineTo(b,-l),C.lineTo(b,l),C.lineTo(-b,l),C.lineTo(-b,-l),C.closePath()}},toObject:function(C){var b=[];this.filters.forEach(function(c){c&&b.push(c.toObject())});var l=p(this.callSuper("toObject",["cropX","cropY"].concat(C)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:b});return this.resizeFilter&&(l.resizeFilter=this.resizeFilter.toObject()),l},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var C=[],b=[],l,c=this._element,h=-this.width/2,m=-this.height/2,g="",d="";if(!c)return[];if(this.hasCrop()){var w=S.Object.__uid++;C.push('<clipPath id="imageCrop_'+w+`">
`,'	<rect x="'+h+'" y="'+m+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),g=' clip-path="url(#imageCrop_'+w+')" '}if(this.imageSmoothing||(d='" image-rendering="optimizeSpeed'),b.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',h-this.cropX,'" y="',m-this.cropY,'" width="',c.width||c.naturalWidth,'" height="',c.height||c.height,d,'"',g,`></image>
`),this.stroke||this.strokeDashArray){var E=this.fill;this.fill=null,l=["	<rect ",'x="',h,'" y="',m,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),`"/>
`],this.fill=E}return this.paintFirst!=="fill"?C=C.concat(l,b):C=C.concat(b,l),C},getSrc:function(C){var b=C?this._element:this._originalElement;return b?b.toDataURL?b.toDataURL():this.srcFromAttribute?b.getAttribute("src"):b.src:this.src||""},setSrc:function(C,b,l){return S.util.loadImage(C,function(c,h){this.setElement(c,l),this._setWidthHeight(),b&&b(this,h)},this,l&&l.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var C=this.resizeFilter,b=this.minimumScaleTrigger,l=this.getTotalObjectScaling(),c=l.scaleX,h=l.scaleY,m=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!C||c>b&&h>b){this._element=m,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=c,this._lastScaleY=h;return}S.filterBackend||(S.filterBackend=S.initFilterBackend());var g=S.util.createCanvasElement(),d=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,w=m.width,E=m.height;g.width=w,g.height=E,this._element=g,this._lastScaleX=C.scaleX=c,this._lastScaleY=C.scaleY=h,S.filterBackend.applyFilters([C],m,w,E,this._element,d),this._filterScalingX=g.width/this._originalElement.width,this._filterScalingY=g.height/this._originalElement.height},applyFilters:function(C){if(C=C||this.filters||[],C=C.filter(function(m){return m&&!m.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),C.length===0)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var b=this._originalElement,l=b.naturalWidth||b.width,c=b.naturalHeight||b.height;if(this._element===this._originalElement){var h=S.util.createCanvasElement();h.width=l,h.height=c,this._element=h,this._filteredEl=h}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,l,c),this._lastScaleX=1,this._lastScaleY=1;return S.filterBackend||(S.filterBackend=S.initFilterBackend()),S.filterBackend.applyFilters(C,this._originalElement,l,c,this._element,this.cacheKey),(this._originalElement.width!==this._element.width||this._originalElement.height!==this._element.height)&&(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(C){S.util.setImageSmoothing(C,this.imageSmoothing),this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(C),this._renderPaintInOrder(C)},drawCacheOnCanvas:function(C){S.util.setImageSmoothing(C,this.imageSmoothing),S.Object.prototype.drawCacheOnCanvas.call(this,C)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(C){var b=this._element;if(b){var l=this._filterScalingX,c=this._filterScalingY,h=this.width,m=this.height,g=Math.min,d=Math.max,w=d(this.cropX,0),E=d(this.cropY,0),O=b.naturalWidth||b.width,L=b.naturalHeight||b.height,U=w*l,$=E*c,nt=g(h*l,O-U),xt=g(m*c,L-$),Ft=-h/2,Kt=-m/2,Jt=g(h,O/l-w),Qt=g(m,L/c-E);b&&C.drawImage(b,U,$,nt,xt,Ft,Kt,Jt,Qt)}},_needsResize:function(){var C=this.getTotalObjectScaling();return C.scaleX!==this._lastScaleX||C.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(C,b){this.setElement(S.util.getById(C),b),S.util.addClass(this.getElement(),S.Image.CSS_CANVAS)},_initConfig:function(C){C||(C={}),this.setOptions(C),this._setWidthHeight(C)},_initFilters:function(C,b){C&&C.length?S.util.enlivenObjects(C,function(l){b&&b(l)},"fabric.Image.filters"):b&&b()},_setWidthHeight:function(C){C||(C={});var b=this.getElement();this.width=C.width||b.naturalWidth||b.width||0,this.height=C.height||b.naturalHeight||b.height||0},parsePreserveAspectRatioAttribute:function(){var C=S.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),b=this._element.width,l=this._element.height,c=1,h=1,m=0,g=0,d=0,w=0,E,O=this.width,L=this.height,U={width:O,height:L};return C&&(C.alignX!=="none"||C.alignY!=="none")?(C.meetOrSlice==="meet"&&(c=h=S.util.findScaleToFit(this._element,U),E=(O-b*c)/2,C.alignX==="Min"&&(m=-E),C.alignX==="Max"&&(m=E),E=(L-l*h)/2,C.alignY==="Min"&&(g=-E),C.alignY==="Max"&&(g=E)),C.meetOrSlice==="slice"&&(c=h=S.util.findScaleToCover(this._element,U),E=b-O/c,C.alignX==="Mid"&&(d=E/2),C.alignX==="Max"&&(d=E),E=l-L/h,C.alignY==="Mid"&&(w=E/2),C.alignY==="Max"&&(w=E),b=O/c,l=L/h)):(c=O/b,h=L/l),{width:b,height:l,scaleX:c,scaleY:h,offsetLeft:m,offsetTop:g,cropX:d,cropY:w}}}),S.Image.CSS_CANVAS="canvas-img",S.Image.prototype.getSvgSrc=S.Image.prototype.getSrc,S.Image.fromObject=function(C,b){var l=S.util.object.clone(C);S.util.loadImage(l.src,function(c,h){if(h){b&&b(null,!0);return}S.Image.prototype._initFilters.call(l,l.filters,function(m){l.filters=m||[],S.Image.prototype._initFilters.call(l,[l.resizeFilter],function(g){l.resizeFilter=g[0],S.util.enlivenObjectEnlivables(l,l,function(){var d=new S.Image(c,l);b(d,!1)})})})},null,l.crossOrigin)},S.Image.fromURL=function(C,b,l){S.util.loadImage(C,function(c,h){b&&b(new S.Image(c,l),h)},null,l&&l.crossOrigin)},S.Image.ATTRIBUTE_NAMES=S.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),S.Image.fromElement=function(C,b,l){var c=S.parseAttributes(C,S.Image.ATTRIBUTE_NAMES);S.Image.fromURL(c["xlink:href"],b,p(l?S.util.object.clone(l):{},c))}}(Z),S.util.object.extend(S.Object.prototype,{_getAngleValueForStraighten:function(){var s=this.angle%360;return s>0?Math.round((s-1)/90)*90:Math.round(s/90)*90},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(s){s=s||{};var p=function(){},C=s.onComplete||p,b=s.onChange||p,l=this;return S.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(c){l.rotate(c),b()},onComplete:function(){l.setCoords(),C()}})}}),S.util.object.extend(S.StaticCanvas.prototype,{straightenObject:function(s){return s.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(s){return s.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){function s(C,b){var l="precision "+b+` float;
void main(){}`,c=C.createShader(C.FRAGMENT_SHADER);return C.shaderSource(c,l),C.compileShader(c),!!C.getShaderParameter(c,C.COMPILE_STATUS)}S.isWebglSupported=function(C){if(S.isLikelyNode)return!1;C=C||S.WebglFilterBackend.prototype.tileSize;var b=document.createElement("canvas"),l=b.getContext("webgl")||b.getContext("experimental-webgl"),c=!1;if(l){S.maxTextureSize=l.getParameter(l.MAX_TEXTURE_SIZE),c=S.maxTextureSize>=C;for(var h=["highp","mediump","lowp"],m=0;m<3;m++)if(s(l,h[m])){S.webGlPrecision=h[m];break}}return this.isSupported=c,c},S.WebglFilterBackend=p;function p(C){C&&C.tileSize&&(this.tileSize=C.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}p.prototype={tileSize:2048,resources:{},setupGLContext:function(C,b){this.dispose(),this.createWebGLCanvas(C,b),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(C,b)},chooseFastestCopyGLTo2DMethod:function(C,b){var l=typeof window.performance<"u",c;try{new ImageData(1,1),c=!0}catch{c=!1}var h=typeof ArrayBuffer<"u",m=typeof Uint8ClampedArray<"u";if(l&&c&&h&&m){var g=S.util.createCanvasElement(),d=new ArrayBuffer(C*b*4);if(S.forceGLPutImageData){this.imageBuffer=d,this.copyGLTo2D=N;return}var w={imageBuffer:d,destinationWidth:C,destinationHeight:b,targetCanvas:g},E,O,L;g.width=C,g.height=b,E=window.performance.now(),It.call(w,this.gl,w),O=window.performance.now()-E,E=window.performance.now(),N.call(w,this.gl,w),L=window.performance.now()-E,O>L?(this.imageBuffer=d,this.copyGLTo2D=N):this.copyGLTo2D=It}},createWebGLCanvas:function(C,b){var l=S.util.createCanvasElement();l.width=C,l.height=b;var c={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},h=l.getContext("webgl",c);h||(h=l.getContext("experimental-webgl",c)),h&&(h.clearColor(0,0,0,0),this.canvas=l,this.gl=h)},applyFilters:function(C,b,l,c,h,m){var g=this.gl,d;m&&(d=this.getCachedTexture(m,b));var w={originalWidth:b.width||b.originalWidth,originalHeight:b.height||b.originalHeight,sourceWidth:l,sourceHeight:c,destinationWidth:l,destinationHeight:c,context:g,sourceTexture:this.createTexture(g,l,c,!d&&b),targetTexture:this.createTexture(g,l,c),originalTexture:d||this.createTexture(g,l,c,!d&&b),passes:C.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:h},E=g.createFramebuffer();return g.bindFramebuffer(g.FRAMEBUFFER,E),C.forEach(function(O){O&&O.applyTo(w)}),lt(w),this.copyGLTo2D(g,w),g.bindTexture(g.TEXTURE_2D,null),g.deleteTexture(w.sourceTexture),g.deleteTexture(w.targetTexture),g.deleteFramebuffer(E),h.getContext("2d").setTransform(1,0,0,1,0,0),w},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(C,b,l,c,h){var m=C.createTexture();return C.bindTexture(C.TEXTURE_2D,m),C.texParameteri(C.TEXTURE_2D,C.TEXTURE_MAG_FILTER,h||C.NEAREST),C.texParameteri(C.TEXTURE_2D,C.TEXTURE_MIN_FILTER,h||C.NEAREST),C.texParameteri(C.TEXTURE_2D,C.TEXTURE_WRAP_S,C.CLAMP_TO_EDGE),C.texParameteri(C.TEXTURE_2D,C.TEXTURE_WRAP_T,C.CLAMP_TO_EDGE),c?C.texImage2D(C.TEXTURE_2D,0,C.RGBA,C.RGBA,C.UNSIGNED_BYTE,c):C.texImage2D(C.TEXTURE_2D,0,C.RGBA,b,l,0,C.RGBA,C.UNSIGNED_BYTE,null),m},getCachedTexture:function(C,b){if(this.textureCache[C])return this.textureCache[C];var l=this.createTexture(this.gl,b.width,b.height,b);return this.textureCache[C]=l,l},evictCachesForKey:function(C){this.textureCache[C]&&(this.gl.deleteTexture(this.textureCache[C]),delete this.textureCache[C])},copyGLTo2D:It,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var C=this.gl,b={renderer:"",vendor:""};if(!C)return b;var l=C.getExtension("WEBGL_debug_renderer_info");if(l){var c=C.getParameter(l.UNMASKED_RENDERER_WEBGL),h=C.getParameter(l.UNMASKED_VENDOR_WEBGL);c&&(b.renderer=c.toLowerCase()),h&&(b.vendor=h.toLowerCase())}return this.gpuInfo=b,b}}}();function lt(s){var p=s.targetCanvas,C=p.width,b=p.height,l=s.destinationWidth,c=s.destinationHeight;(C!==l||b!==c)&&(p.width=l,p.height=c)}function It(s,p){var C=s.canvas,b=p.targetCanvas,l=b.getContext("2d");l.translate(0,b.height),l.scale(1,-1);var c=C.height-b.height;l.drawImage(C,0,c,b.width,b.height,0,0,b.width,b.height)}function N(s,p){var C=p.targetCanvas,b=C.getContext("2d"),l=p.destinationWidth,c=p.destinationHeight,h=l*c*4,m=new Uint8Array(this.imageBuffer,0,h),g=new Uint8ClampedArray(this.imageBuffer,0,h);s.readPixels(0,0,l,c,s.RGBA,s.UNSIGNED_BYTE,m);var d=new ImageData(g,l,c);b.putImageData(d,0,0)}(function(){var s=function(){};S.Canvas2dFilterBackend=p;function p(){}p.prototype={evictCachesForKey:s,dispose:s,clearWebGLCaches:s,resources:{},applyFilters:function(C,b,l,c,h){var m=h.getContext("2d");m.drawImage(b,0,0,l,c);var g=m.getImageData(0,0,l,c),d=m.getImageData(0,0,l,c),w={sourceWidth:l,sourceHeight:c,imageData:g,originalEl:b,originalImageData:d,canvasEl:h,ctx:m,filterBackend:this};return C.forEach(function(E){E.applyTo(w)}),(w.imageData.width!==l||w.imageData.height!==c)&&(h.width=w.imageData.width,h.height=w.imageData.height),m.putImageData(w.imageData,0,0),w}}})(),S.Image=S.Image||{},S.Image.filters=S.Image.filters||{},S.Image.filters.BaseFilter=S.util.createClass({type:"BaseFilter",vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
void main() {
vTexCoord = aPosition;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:`precision highp float;
varying vec2 vTexCoord;
uniform sampler2D uTexture;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
}`,initialize:function(s){s&&this.setOptions(s)},setOptions:function(s){for(var p in s)this[p]=s[p]},createProgram:function(s,p,C){p=p||this.fragmentSource,C=C||this.vertexSource,S.webGlPrecision!=="highp"&&(p=p.replace(/precision highp float/g,"precision "+S.webGlPrecision+" float"));var b=s.createShader(s.VERTEX_SHADER);if(s.shaderSource(b,C),s.compileShader(b),!s.getShaderParameter(b,s.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+s.getShaderInfoLog(b));var l=s.createShader(s.FRAGMENT_SHADER);if(s.shaderSource(l,p),s.compileShader(l),!s.getShaderParameter(l,s.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+s.getShaderInfoLog(l));var c=s.createProgram();if(s.attachShader(c,b),s.attachShader(c,l),s.linkProgram(c),!s.getProgramParameter(c,s.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+s.getProgramInfoLog(c));var h=this.getAttributeLocations(s,c),m=this.getUniformLocations(s,c)||{};return m.uStepW=s.getUniformLocation(c,"uStepW"),m.uStepH=s.getUniformLocation(c,"uStepH"),{program:c,attributeLocations:h,uniformLocations:m}},getAttributeLocations:function(s,p){return{aPosition:s.getAttribLocation(p,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(s,p,C){var b=p.aPosition,l=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,l),s.enableVertexAttribArray(b),s.vertexAttribPointer(b,2,s.FLOAT,!1,0,0),s.bufferData(s.ARRAY_BUFFER,C,s.STATIC_DRAW)},_setupFrameBuffer:function(s){var p=s.context,C,b;s.passes>1?(C=s.destinationWidth,b=s.destinationHeight,(s.sourceWidth!==C||s.sourceHeight!==b)&&(p.deleteTexture(s.targetTexture),s.targetTexture=s.filterBackend.createTexture(p,C,b)),p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,s.targetTexture,0)):(p.bindFramebuffer(p.FRAMEBUFFER,null),p.finish())},_swapTextures:function(s){s.passes--,s.pass++;var p=s.targetTexture;s.targetTexture=s.sourceTexture,s.sourceTexture=p},isNeutralState:function(){var s=this.mainParameter,p=S.Image.filters[this.type].prototype;if(s)if(Array.isArray(p[s])){for(var C=p[s].length;C--;)if(this[s][C]!==p[s][C])return!1;return!0}else return p[s]===this[s];else return!1},applyTo:function(s){s.webgl?(this._setupFrameBuffer(s),this.applyToWebGL(s),this._swapTextures(s)):this.applyTo2d(s)},retrieveShader:function(s){return s.programCache.hasOwnProperty(this.type)||(s.programCache[this.type]=this.createProgram(s.context)),s.programCache[this.type]},applyToWebGL:function(s){var p=s.context,C=this.retrieveShader(s);s.pass===0&&s.originalTexture?p.bindTexture(p.TEXTURE_2D,s.originalTexture):p.bindTexture(p.TEXTURE_2D,s.sourceTexture),p.useProgram(C.program),this.sendAttributeData(p,C.attributeLocations,s.aPosition),p.uniform1f(C.uniformLocations.uStepW,1/s.sourceWidth),p.uniform1f(C.uniformLocations.uStepH,1/s.sourceHeight),this.sendUniformData(p,C.uniformLocations),p.viewport(0,0,s.destinationWidth,s.destinationHeight),p.drawArrays(p.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(s,p,C){s.activeTexture(C),s.bindTexture(s.TEXTURE_2D,p),s.activeTexture(s.TEXTURE0)},unbindAdditionalTexture:function(s,p){s.activeTexture(p),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(s){this[this.mainParameter]=s},sendUniformData:function(){},createHelpLayer:function(s){if(!s.helpLayer){var p=document.createElement("canvas");p.width=s.sourceWidth,p.height=s.sourceHeight,s.helpLayer=p}},toObject:function(){var s={type:this.type},p=this.mainParameter;return p&&(s[p]=this[p]),s},toJSON:function(){return this.toObject()}}),S.Image.filters.BaseFilter.fromObject=function(s,p){var C=new S.Image.filters[s.type](s);return p&&p(C),C},function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.ColorMatrix=b(C.BaseFilter,{type:"ColorMatrix",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
uniform mat4 uColorMatrix;
uniform vec4 uConstants;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color *= uColorMatrix;
color += uConstants;
gl_FragColor = color;
}`,matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(l){this.callSuper("initialize",l),this.matrix=this.matrix.slice(0)},applyTo2d:function(l){var c=l.imageData,h=c.data,m=h.length,g=this.matrix,d,w,E,O,L,U=this.colorsOnly;for(L=0;L<m;L+=4)d=h[L],w=h[L+1],E=h[L+2],U?(h[L]=d*g[0]+w*g[1]+E*g[2]+g[4]*255,h[L+1]=d*g[5]+w*g[6]+E*g[7]+g[9]*255,h[L+2]=d*g[10]+w*g[11]+E*g[12]+g[14]*255):(O=h[L+3],h[L]=d*g[0]+w*g[1]+E*g[2]+O*g[3]+g[4]*255,h[L+1]=d*g[5]+w*g[6]+E*g[7]+O*g[8]+g[9]*255,h[L+2]=d*g[10]+w*g[11]+E*g[12]+O*g[13]+g[14]*255,h[L+3]=d*g[15]+w*g[16]+E*g[17]+O*g[18]+g[19]*255)},getUniformLocations:function(l,c){return{uColorMatrix:l.getUniformLocation(c,"uColorMatrix"),uConstants:l.getUniformLocation(c,"uConstants")}},sendUniformData:function(l,c){var h=this.matrix,m=[h[0],h[1],h[2],h[3],h[5],h[6],h[7],h[8],h[10],h[11],h[12],h[13],h[15],h[16],h[17],h[18]],g=[h[4],h[9],h[14],h[19]];l.uniformMatrix4fv(c.uColorMatrix,!1,m),l.uniform4fv(c.uConstants,g)}}),p.Image.filters.ColorMatrix.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Brightness=b(C.BaseFilter,{type:"Brightness",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBrightness;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += uBrightness;
gl_FragColor = color;
}`,brightness:0,mainParameter:"brightness",applyTo2d:function(l){if(this.brightness!==0){var c=l.imageData,h=c.data,m,g=h.length,d=Math.round(this.brightness*255);for(m=0;m<g;m+=4)h[m]=h[m]+d,h[m+1]=h[m+1]+d,h[m+2]=h[m+2]+d}},getUniformLocations:function(l,c){return{uBrightness:l.getUniformLocation(c,"uBrightness")}},sendUniformData:function(l,c){l.uniform1f(c.uBrightness,this.brightness)}}),p.Image.filters.Brightness.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.Image.filters,l=p.util.createClass;b.Convolute=l(b.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_3_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_5_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_5_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_7_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_7_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_9_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_9_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`},retrieveShader:function(c){var h=Math.sqrt(this.matrix.length),m=this.type+"_"+h+"_"+(this.opaque?1:0),g=this.fragmentSource[m];return c.programCache.hasOwnProperty(m)||(c.programCache[m]=this.createProgram(c.context,g)),c.programCache[m]},applyTo2d:function(c){var h=c.imageData,m=h.data,g=this.matrix,d=Math.round(Math.sqrt(g.length)),w=Math.floor(d/2),E=h.width,O=h.height,L=c.ctx.createImageData(E,O),U=L.data,$=this.opaque?1:0,nt,xt,Ft,Kt,Jt,Qt,he,ne,me,Oe,se,be,Q;for(se=0;se<O;se++)for(Oe=0;Oe<E;Oe++){for(Jt=(se*E+Oe)*4,nt=0,xt=0,Ft=0,Kt=0,Q=0;Q<d;Q++)for(be=0;be<d;be++)he=se+Q-w,Qt=Oe+be-w,!(he<0||he>=O||Qt<0||Qt>=E)&&(ne=(he*E+Qt)*4,me=g[Q*d+be],nt+=m[ne]*me,xt+=m[ne+1]*me,Ft+=m[ne+2]*me,$||(Kt+=m[ne+3]*me));U[Jt]=nt,U[Jt+1]=xt,U[Jt+2]=Ft,$?U[Jt+3]=m[Jt+3]:U[Jt+3]=Kt}c.imageData=L},getUniformLocations:function(c,h){return{uMatrix:c.getUniformLocation(h,"uMatrix"),uOpaque:c.getUniformLocation(h,"uOpaque"),uHalfSize:c.getUniformLocation(h,"uHalfSize"),uSize:c.getUniformLocation(h,"uSize")}},sendUniformData:function(c,h){c.uniform1fv(h.uMatrix,this.matrix)},toObject:function(){return C(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),p.Image.filters.Convolute.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Grayscale=b(C.BaseFilter,{type:"Grayscale",fragmentSource:{average:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float average = (color.r + color.b + color.g) / 3.0;
gl_FragColor = vec4(average, average, average, color.a);
}`,lightness:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
gl_FragColor = vec4(average, average, average, col.a);
}`,luminosity:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
gl_FragColor = vec4(average, average, average, col.a);
}`},mode:"average",mainParameter:"mode",applyTo2d:function(l){var c=l.imageData,h=c.data,m,g=h.length,d,w=this.mode;for(m=0;m<g;m+=4)w==="average"?d=(h[m]+h[m+1]+h[m+2])/3:w==="lightness"?d=(Math.min(h[m],h[m+1],h[m+2])+Math.max(h[m],h[m+1],h[m+2]))/2:w==="luminosity"&&(d=.21*h[m]+.72*h[m+1]+.07*h[m+2]),h[m]=d,h[m+1]=d,h[m+2]=d},retrieveShader:function(l){var c=this.type+"_"+this.mode;if(!l.programCache.hasOwnProperty(c)){var h=this.fragmentSource[this.mode];l.programCache[c]=this.createProgram(l.context,h)}return l.programCache[c]},getUniformLocations:function(l,c){return{uMode:l.getUniformLocation(c,"uMode")}},sendUniformData:function(l,c){var h=1;l.uniform1i(c.uMode,h)},isNeutralState:function(){return!1}}),p.Image.filters.Grayscale.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Invert=b(C.BaseFilter,{type:"Invert",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform int uInvert;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
if (uInvert == 1) {
gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
} else {
gl_FragColor = color;
}
}`,invert:!0,mainParameter:"invert",applyTo2d:function(l){var c=l.imageData,h=c.data,m,g=h.length;for(m=0;m<g;m+=4)h[m]=255-h[m],h[m+1]=255-h[m+1],h[m+2]=255-h[m+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(l,c){return{uInvert:l.getUniformLocation(c,"uInvert")}},sendUniformData:function(l,c){l.uniform1i(c.uInvert,this.invert)}}),p.Image.filters.Invert.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.Image.filters,l=p.util.createClass;b.Noise=l(b.BaseFilter,{type:"Noise",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uStepH;
uniform float uNoise;
uniform float uSeed;
varying vec2 vTexCoord;
float rand(vec2 co, float seed, float vScale) {
return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
}
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
gl_FragColor = color;
}`,mainParameter:"noise",noise:0,applyTo2d:function(c){if(this.noise!==0){var h=c.imageData,m=h.data,g,d=m.length,w=this.noise,E;for(g=0,d=m.length;g<d;g+=4)E=(.5-Math.random())*w,m[g]+=E,m[g+1]+=E,m[g+2]+=E}},getUniformLocations:function(c,h){return{uNoise:c.getUniformLocation(h,"uNoise"),uSeed:c.getUniformLocation(h,"uSeed")}},sendUniformData:function(c,h){c.uniform1f(h.uNoise,this.noise/255),c.uniform1f(h.uSeed,Math.random())},toObject:function(){return C(this.callSuper("toObject"),{noise:this.noise})}}),p.Image.filters.Noise.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Pixelate=b(C.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBlocksize;
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
float blockW = uBlocksize * uStepW;
float blockH = uBlocksize * uStepW;
int posX = int(vTexCoord.x / blockW);
int posY = int(vTexCoord.y / blockH);
float fposX = float(posX);
float fposY = float(posY);
vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
vec4 color = texture2D(uTexture, squareCoords);
gl_FragColor = color;
}`,applyTo2d:function(l){var c=l.imageData,h=c.data,m=c.height,g=c.width,d,w,E,O,L,U,$,nt,xt,Ft,Kt;for(w=0;w<m;w+=this.blocksize)for(E=0;E<g;E+=this.blocksize)for(d=w*4*g+E*4,O=h[d],L=h[d+1],U=h[d+2],$=h[d+3],Ft=Math.min(w+this.blocksize,m),Kt=Math.min(E+this.blocksize,g),nt=w;nt<Ft;nt++)for(xt=E;xt<Kt;xt++)d=nt*4*g+xt*4,h[d]=O,h[d+1]=L,h[d+2]=U,h[d+3]=$},isNeutralState:function(){return this.blocksize===1},getUniformLocations:function(l,c){return{uBlocksize:l.getUniformLocation(c,"uBlocksize"),uStepW:l.getUniformLocation(c,"uStepW"),uStepH:l.getUniformLocation(c,"uStepH")}},sendUniformData:function(l,c){l.uniform1f(c.uBlocksize,this.blocksize)}}),p.Image.filters.Pixelate.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.extend,b=p.Image.filters,l=p.util.createClass;b.RemoveColor=l(b.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
gl_FragColor.a = 0.0;
}
}`,distance:.02,useAlpha:!1,applyTo2d:function(c){var h=c.imageData,m=h.data,g,d=this.distance*255,w,E,O,L=new p.Color(this.color).getSource(),U=[L[0]-d,L[1]-d,L[2]-d],$=[L[0]+d,L[1]+d,L[2]+d];for(g=0;g<m.length;g+=4)w=m[g],E=m[g+1],O=m[g+2],w>U[0]&&E>U[1]&&O>U[2]&&w<$[0]&&E<$[1]&&O<$[2]&&(m[g+3]=0)},getUniformLocations:function(c,h){return{uLow:c.getUniformLocation(h,"uLow"),uHigh:c.getUniformLocation(h,"uHigh")}},sendUniformData:function(c,h){var m=new p.Color(this.color).getSource(),g=parseFloat(this.distance),d=[0+m[0]/255-g,0+m[1]/255-g,0+m[2]/255-g,1],w=[m[0]/255+g,m[1]/255+g,m[2]/255+g,1];c.uniform4fv(h.uLow,d),c.uniform4fv(h.uHigh,w)},toObject:function(){return C(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),p.Image.filters.RemoveColor.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass,l={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var c in l)C[c]=b(C.ColorMatrix,{type:c,matrix:l[c],mainParameter:!1,colorsOnly:!0}),p.Image.filters[c].fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric,C=p.Image.filters,b=p.util.createClass;C.BlendColor=b(C.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,diff:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`if (uColor.r < 0.5) {
gl_FragColor.r *= 2.0 * uColor.r;
} else {
gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
}
if (uColor.g < 0.5) {
gl_FragColor.g *= 2.0 * uColor.g;
} else {
gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
}
if (uColor.b < 0.5) {
gl_FragColor.b *= 2.0 * uColor.b;
} else {
gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
}
`,tint:`gl_FragColor.rgb *= (1.0 - uColor.a);
gl_FragColor.rgb += uColor.rgb;
`},buildSource:function(l){return`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uColor;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
gl_FragColor = color;
if (color.a > 0.0) {
`+this.fragmentSource[l]+`}
}`},retrieveShader:function(l){var c=this.type+"_"+this.mode,h;return l.programCache.hasOwnProperty(c)||(h=this.buildSource(this.mode),l.programCache[c]=this.createProgram(l.context,h)),l.programCache[c]},applyTo2d:function(l){var c=l.imageData,h=c.data,m=h.length,g,d,w,E,O,L,U,$=1-this.alpha;U=new p.Color(this.color).getSource(),g=U[0]*this.alpha,d=U[1]*this.alpha,w=U[2]*this.alpha;for(var nt=0;nt<m;nt+=4)switch(E=h[nt],O=h[nt+1],L=h[nt+2],this.mode){case"multiply":h[nt]=E*g/255,h[nt+1]=O*d/255,h[nt+2]=L*w/255;break;case"screen":h[nt]=255-(255-E)*(255-g)/255,h[nt+1]=255-(255-O)*(255-d)/255,h[nt+2]=255-(255-L)*(255-w)/255;break;case"add":h[nt]=E+g,h[nt+1]=O+d,h[nt+2]=L+w;break;case"diff":case"difference":h[nt]=Math.abs(E-g),h[nt+1]=Math.abs(O-d),h[nt+2]=Math.abs(L-w);break;case"subtract":h[nt]=E-g,h[nt+1]=O-d,h[nt+2]=L-w;break;case"darken":h[nt]=Math.min(E,g),h[nt+1]=Math.min(O,d),h[nt+2]=Math.min(L,w);break;case"lighten":h[nt]=Math.max(E,g),h[nt+1]=Math.max(O,d),h[nt+2]=Math.max(L,w);break;case"overlay":h[nt]=g<128?2*E*g/255:255-2*(255-E)*(255-g)/255,h[nt+1]=d<128?2*O*d/255:255-2*(255-O)*(255-d)/255,h[nt+2]=w<128?2*L*w/255:255-2*(255-L)*(255-w)/255;break;case"exclusion":h[nt]=g+E-2*g*E/255,h[nt+1]=d+O-2*d*O/255,h[nt+2]=w+L-2*w*L/255;break;case"tint":h[nt]=g+E*$,h[nt+1]=d+O*$,h[nt+2]=w+L*$}},getUniformLocations:function(l,c){return{uColor:l.getUniformLocation(c,"uColor")}},sendUniformData:function(l,c){var h=new p.Color(this.color).getSource();h[0]=this.alpha*h[0]/255,h[1]=this.alpha*h[1]/255,h[2]=this.alpha*h[2]/255,h[3]=this.alpha,l.uniform4fv(c.uColor,h)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),p.Image.filters.BlendColor.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric,C=p.Image.filters,b=p.util.createClass;C.BlendImage=b(C.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
uniform mat3 uTransformMatrix;
void main() {
vTexCoord = aPosition;
vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:{multiply:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.rgba *= color2.rgba;
gl_FragColor = color;
}`,mask:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.a = color2.a;
gl_FragColor = color;
}`},retrieveShader:function(l){var c=this.type+"_"+this.mode,h=this.fragmentSource[this.mode];return l.programCache.hasOwnProperty(c)||(l.programCache[c]=this.createProgram(l.context,h)),l.programCache[c]},applyToWebGL:function(l){var c=l.context,h=this.createTexture(l.filterBackend,this.image);this.bindAdditionalTexture(c,h,c.TEXTURE1),this.callSuper("applyToWebGL",l),this.unbindAdditionalTexture(c,c.TEXTURE1)},createTexture:function(l,c){return l.getCachedTexture(c.cacheKey,c._element)},calculateMatrix:function(){var l=this.image,c=l._element.width,h=l._element.height;return[1/l.scaleX,0,0,0,1/l.scaleY,0,-l.left/c,-l.top/h,1]},applyTo2d:function(l){var c=l.imageData,h=l.filterBackend.resources,m=c.data,g=m.length,d=c.width,w=c.height,E,O,L,U,$,nt,xt,Ft,Kt,Jt,Qt=this.image,he;h.blendImage||(h.blendImage=p.util.createCanvasElement()),Kt=h.blendImage,Jt=Kt.getContext("2d"),Kt.width!==d||Kt.height!==w?(Kt.width=d,Kt.height=w):Jt.clearRect(0,0,d,w),Jt.setTransform(Qt.scaleX,0,0,Qt.scaleY,Qt.left,Qt.top),Jt.drawImage(Qt._element,0,0,d,w),he=Jt.getImageData(0,0,d,w).data;for(var ne=0;ne<g;ne+=4)switch($=m[ne],nt=m[ne+1],xt=m[ne+2],Ft=m[ne+3],E=he[ne],O=he[ne+1],L=he[ne+2],U=he[ne+3],this.mode){case"multiply":m[ne]=$*E/255,m[ne+1]=nt*O/255,m[ne+2]=xt*L/255,m[ne+3]=Ft*U/255;break;case"mask":m[ne+3]=U;break}},getUniformLocations:function(l,c){return{uTransformMatrix:l.getUniformLocation(c,"uTransformMatrix"),uImage:l.getUniformLocation(c,"uImage")}},sendUniformData:function(l,c){var h=this.calculateMatrix();l.uniform1i(c.uImage,1),l.uniformMatrix3fv(c.uTransformMatrix,!1,h)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),p.Image.filters.BlendImage.fromObject=function(l,c){p.Image.fromObject(l.image,function(h){var m=p.util.object.clone(l);m.image=h,c(new p.Image.filters.BlendImage(m))})}}(Z),function(s){var p=s.fabric||(s.fabric={}),C=Math.pow,b=Math.floor,l=Math.sqrt,c=Math.abs,h=Math.round,m=Math.sin,g=Math.ceil,d=p.Image.filters,w=p.util.createClass;d.Resize=w(d.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(E,O){return{uDelta:E.getUniformLocation(O,"uDelta"),uTaps:E.getUniformLocation(O,"uTaps")}},sendUniformData:function(E,O){E.uniform2fv(O.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),E.uniform1fv(O.uTaps,this.taps)},retrieveShader:function(E){var O=this.getFilterWindow(),L=this.type+"_"+O;if(!E.programCache.hasOwnProperty(L)){var U=this.generateShader(O);E.programCache[L]=this.createProgram(E.context,U)}return E.programCache[L]},getFilterWindow:function(){var E=this.tempScale;return Math.ceil(this.lanczosLobes/E)},getTaps:function(){for(var E=this.lanczosCreate(this.lanczosLobes),O=this.tempScale,L=this.getFilterWindow(),U=new Array(L),$=1;$<=L;$++)U[$-1]=E($*O);return U},generateShader:function(U){for(var O=new Array(U),L=this.fragmentSourceTOP,U,$=1;$<=U;$++)O[$-1]=$+".0 * uDelta";return L+="uniform float uTaps["+U+`];
`,L+=`void main() {
`,L+=`  vec4 color = texture2D(uTexture, vTexCoord);
`,L+=`  float sum = 1.0;
`,O.forEach(function(nt,xt){L+="  color += texture2D(uTexture, vTexCoord + "+nt+") * uTaps["+xt+`];
`,L+="  color += texture2D(uTexture, vTexCoord - "+nt+") * uTaps["+xt+`];
`,L+="  sum += 2.0 * uTaps["+xt+`];
`}),L+=`  gl_FragColor = color / sum;
`,L+="}",L},fragmentSourceTOP:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
`,applyTo:function(E){E.webgl?(E.passes++,this.width=E.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=E.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),E.destinationWidth=this.dW,this._setupFrameBuffer(E),this.applyToWebGL(E),this._swapTextures(E),E.sourceWidth=E.destinationWidth,this.height=E.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),E.destinationHeight=this.dH,this._setupFrameBuffer(E),this.applyToWebGL(E),this._swapTextures(E),E.sourceHeight=E.destinationHeight):this.applyTo2d(E)},isNeutralState:function(){return this.scaleX===1&&this.scaleY===1},lanczosCreate:function(E){return function(O){if(O>=E||O<=-E)return 0;if(O<11920929e-14&&O>-11920929e-14)return 1;O*=Math.PI;var L=O/E;return m(O)/O*m(L)/L}},applyTo2d:function(E){var O=E.imageData,L=this.scaleX,U=this.scaleY;this.rcpScaleX=1/L,this.rcpScaleY=1/U;var $=O.width,nt=O.height,xt=h($*L),Ft=h(nt*U),Kt;this.resizeType==="sliceHack"?Kt=this.sliceByTwo(E,$,nt,xt,Ft):this.resizeType==="hermite"?Kt=this.hermiteFastResize(E,$,nt,xt,Ft):this.resizeType==="bilinear"?Kt=this.bilinearFiltering(E,$,nt,xt,Ft):this.resizeType==="lanczos"&&(Kt=this.lanczosResize(E,$,nt,xt,Ft)),E.imageData=Kt},sliceByTwo:function(E,O,L,U,$){var nt=E.imageData,xt=.5,Ft=!1,Kt=!1,Jt=O*xt,Qt=L*xt,he=p.filterBackend.resources,ne,me,Oe=0,se=0,be=O,Q=0;for(he.sliceByTwo||(he.sliceByTwo=document.createElement("canvas")),ne=he.sliceByTwo,(ne.width<O*1.5||ne.height<L)&&(ne.width=O*1.5,ne.height=L),me=ne.getContext("2d"),me.clearRect(0,0,O*1.5,L),me.putImageData(nt,0,0),U=b(U),$=b($);!Ft||!Kt;)O=Jt,L=Qt,U<b(Jt*xt)?Jt=b(Jt*xt):(Jt=U,Ft=!0),$<b(Qt*xt)?Qt=b(Qt*xt):(Qt=$,Kt=!0),me.drawImage(ne,Oe,se,O,L,be,Q,Jt,Qt),Oe=be,se=Q,Q+=Qt;return me.getImageData(Oe,se,U,$)},lanczosResize:function(E,O,L,U,$){function nt(gt){var vt,Vt,pt,rt,Mt,jt,te,Wt,Xt,ye,Te;for(Q.x=(gt+.5)*Qt,wt.x=b(Q.x),vt=0;vt<$;vt++){for(Q.y=(vt+.5)*he,wt.y=b(Q.y),Mt=0,jt=0,te=0,Wt=0,Xt=0,Vt=wt.x-Oe;Vt<=wt.x+Oe;Vt++)if(!(Vt<0||Vt>=O)){ye=b(1e3*c(Vt-Q.x)),be[ye]||(be[ye]={});for(var qt=wt.y-se;qt<=wt.y+se;qt++)qt<0||qt>=L||(Te=b(1e3*c(qt-Q.y)),be[ye][Te]||(be[ye][Te]=Jt(l(C(ye*ne,2)+C(Te*me,2))/1e3)),pt=be[ye][Te],pt>0&&(rt=(qt*O+Vt)*4,Mt+=pt,jt+=pt*xt[rt],te+=pt*xt[rt+1],Wt+=pt*xt[rt+2],Xt+=pt*xt[rt+3]))}rt=(vt*U+gt)*4,Kt[rt]=jt/Mt,Kt[rt+1]=te/Mt,Kt[rt+2]=Wt/Mt,Kt[rt+3]=Xt/Mt}return++gt<U?nt(gt):Ft}var xt=E.imageData.data,Ft=E.ctx.createImageData(U,$),Kt=Ft.data,Jt=this.lanczosCreate(this.lanczosLobes),Qt=this.rcpScaleX,he=this.rcpScaleY,ne=2/this.rcpScaleX,me=2/this.rcpScaleY,Oe=g(Qt*this.lanczosLobes/2),se=g(he*this.lanczosLobes/2),be={},Q={},wt={};return nt(0)},bilinearFiltering:function(E,O,L,U,$){var nt,xt,Ft,Kt,Jt,Qt,he,ne,me,Oe,se,be,Q=0,wt,gt=this.rcpScaleX,vt=this.rcpScaleY,Vt=4*(O-1),pt=E.imageData,rt=pt.data,Mt=E.ctx.createImageData(U,$),jt=Mt.data;for(he=0;he<$;he++)for(ne=0;ne<U;ne++)for(Jt=b(gt*ne),Qt=b(vt*he),me=gt*ne-Jt,Oe=vt*he-Qt,wt=4*(Qt*O+Jt),se=0;se<4;se++)nt=rt[wt+se],xt=rt[wt+4+se],Ft=rt[wt+Vt+se],Kt=rt[wt+Vt+4+se],be=nt*(1-me)*(1-Oe)+xt*me*(1-Oe)+Ft*Oe*(1-me)+Kt*me*Oe,jt[Q++]=be;return Mt},hermiteFastResize:function(E,O,L,U,$){for(var nt=this.rcpScaleX,xt=this.rcpScaleY,Ft=g(nt/2),Kt=g(xt/2),Jt=E.imageData,Qt=Jt.data,he=E.ctx.createImageData(U,$),ne=he.data,me=0;me<$;me++)for(var Oe=0;Oe<U;Oe++){for(var se=(Oe+me*U)*4,be=0,Q=0,wt=0,gt=0,vt=0,Vt=0,pt=0,rt=(me+.5)*xt,Mt=b(me*xt);Mt<(me+1)*xt;Mt++)for(var jt=c(rt-(Mt+.5))/Kt,te=(Oe+.5)*nt,Wt=jt*jt,Xt=b(Oe*nt);Xt<(Oe+1)*nt;Xt++){var ye=c(te-(Xt+.5))/Ft,Te=l(Wt+ye*ye);Te>1&&Te<-1||(be=2*Te*Te*Te-3*Te*Te+1,be>0&&(ye=4*(Xt+Mt*O),pt+=be*Qt[ye+3],wt+=be,Qt[ye+3]<255&&(be=be*Qt[ye+3]/250),gt+=be*Qt[ye],vt+=be*Qt[ye+1],Vt+=be*Qt[ye+2],Q+=be))}ne[se]=gt/Q,ne[se+1]=vt/Q,ne[se+2]=Vt/Q,ne[se+3]=pt/wt}return he},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),p.Image.filters.Resize.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Contrast=b(C.BaseFilter,{type:"Contrast",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uContrast;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
gl_FragColor = color;
}`,contrast:0,mainParameter:"contrast",applyTo2d:function(l){if(this.contrast!==0){var c=l.imageData,h,g,m=c.data,g=m.length,d=Math.floor(this.contrast*255),w=259*(d+255)/(255*(259-d));for(h=0;h<g;h+=4)m[h]=w*(m[h]-128)+128,m[h+1]=w*(m[h+1]-128)+128,m[h+2]=w*(m[h+2]-128)+128}},getUniformLocations:function(l,c){return{uContrast:l.getUniformLocation(c,"uContrast")}},sendUniformData:function(l,c){l.uniform1f(c.uContrast,this.contrast)}}),p.Image.filters.Contrast.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Saturation=b(C.BaseFilter,{type:"Saturation",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uSaturation;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float rgMax = max(color.r, color.g);
float rgbMax = max(rgMax, color.b);
color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
gl_FragColor = color;
}`,saturation:0,mainParameter:"saturation",applyTo2d:function(l){if(this.saturation!==0){var c=l.imageData,h=c.data,m=h.length,g=-this.saturation,d,w;for(d=0;d<m;d+=4)w=Math.max(h[d],h[d+1],h[d+2]),h[d]+=w!==h[d]?(w-h[d])*g:0,h[d+1]+=w!==h[d+1]?(w-h[d+1])*g:0,h[d+2]+=w!==h[d+2]?(w-h[d+2])*g:0}},getUniformLocations:function(l,c){return{uSaturation:l.getUniformLocation(c,"uSaturation")}},sendUniformData:function(l,c){l.uniform1f(c.uSaturation,-this.saturation)}}),p.Image.filters.Saturation.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Vibrance=b(C.BaseFilter,{type:"Vibrance",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uVibrance;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float max = max(color.r, max(color.g, color.b));
float avg = (color.r + color.g + color.b) / 3.0;
float amt = (abs(max - avg) * 2.0) * uVibrance;
color.r += max != color.r ? (max - color.r) * amt : 0.00;
color.g += max != color.g ? (max - color.g) * amt : 0.00;
color.b += max != color.b ? (max - color.b) * amt : 0.00;
gl_FragColor = color;
}`,vibrance:0,mainParameter:"vibrance",applyTo2d:function(l){if(this.vibrance!==0){var c=l.imageData,h=c.data,m=h.length,g=-this.vibrance,d,w,E,O;for(d=0;d<m;d+=4)w=Math.max(h[d],h[d+1],h[d+2]),E=(h[d]+h[d+1]+h[d+2])/3,O=Math.abs(w-E)*2/255*g,h[d]+=w!==h[d]?(w-h[d])*O:0,h[d+1]+=w!==h[d+1]?(w-h[d+1])*O:0,h[d+2]+=w!==h[d+2]?(w-h[d+2])*O:0}},getUniformLocations:function(l,c){return{uVibrance:l.getUniformLocation(c,"uVibrance")}},sendUniformData:function(l,c){l.uniform1f(c.uVibrance,-this.vibrance)}}),p.Image.filters.Vibrance.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Blur=b(C.BaseFilter,{type:"Blur",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
const float nSamples = 15.0;
vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
float random(vec3 scale) {
return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
}
void main() {
vec4 color = vec4(0.0);
float total = 0.0;
float offset = random(v3offset);
for (float t = -nSamples; t <= nSamples; t++) {
float percent = (t + offset - 0.5) / nSamples;
float weight = 1.0 - abs(percent);
color += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;
total += weight;
}
gl_FragColor = color / total;
}`,blur:0,mainParameter:"blur",applyTo:function(l){l.webgl?(this.aspectRatio=l.sourceWidth/l.sourceHeight,l.passes++,this._setupFrameBuffer(l),this.horizontal=!0,this.applyToWebGL(l),this._swapTextures(l),this._setupFrameBuffer(l),this.horizontal=!1,this.applyToWebGL(l),this._swapTextures(l)):this.applyTo2d(l)},applyTo2d:function(l){l.imageData=this.simpleBlur(l)},simpleBlur:function(l){var c=l.filterBackend.resources,h,m,g=l.imageData.width,d=l.imageData.height;c.blurLayer1||(c.blurLayer1=p.util.createCanvasElement(),c.blurLayer2=p.util.createCanvasElement()),h=c.blurLayer1,m=c.blurLayer2,(h.width!==g||h.height!==d)&&(m.width=h.width=g,m.height=h.height=d);var w=h.getContext("2d"),E=m.getContext("2d"),O=15,L,U,$,nt,xt=this.blur*.06*.5;for(w.putImageData(l.imageData,0,0),E.clearRect(0,0,g,d),nt=-O;nt<=O;nt++)L=(Math.random()-.5)/4,U=nt/O,$=xt*U*g+L,E.globalAlpha=1-Math.abs(U),E.drawImage(h,$,L),w.drawImage(m,0,0),E.globalAlpha=1,E.clearRect(0,0,m.width,m.height);for(nt=-O;nt<=O;nt++)L=(Math.random()-.5)/4,U=nt/O,$=xt*U*d+L,E.globalAlpha=1-Math.abs(U),E.drawImage(h,L,$),w.drawImage(m,0,0),E.globalAlpha=1,E.clearRect(0,0,m.width,m.height);l.ctx.drawImage(h,0,0);var Ft=l.ctx.getImageData(0,0,h.width,h.height);return w.globalAlpha=1,w.clearRect(0,0,h.width,h.height),Ft},getUniformLocations:function(l,c){return{delta:l.getUniformLocation(c,"uDelta")}},sendUniformData:function(l,c){var h=this.chooseRightDelta();l.uniform2fv(c.delta,h)},chooseRightDelta:function(){var l=1,c=[0,0],h;return this.horizontal?this.aspectRatio>1&&(l=1/this.aspectRatio):this.aspectRatio<1&&(l=this.aspectRatio),h=l*this.blur*.12,this.horizontal?c[0]=h:c[1]=h,c}}),C.Blur.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Gamma=b(C.BaseFilter,{type:"Gamma",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec3 uGamma;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec3 correction = (1.0 / uGamma);
color.r = pow(color.r, correction.r);
color.g = pow(color.g, correction.g);
color.b = pow(color.b, correction.b);
gl_FragColor = color;
gl_FragColor.rgb *= color.a;
}`,gamma:[1,1,1],mainParameter:"gamma",initialize:function(l){this.gamma=[1,1,1],C.BaseFilter.prototype.initialize.call(this,l)},applyTo2d:function(l){var c=l.imageData,h=c.data,m=this.gamma,g=h.length,d=1/m[0],w=1/m[1],E=1/m[2],O;for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),O=0,g=256;O<g;O++)this.rVals[O]=Math.pow(O/255,d)*255,this.gVals[O]=Math.pow(O/255,w)*255,this.bVals[O]=Math.pow(O/255,E)*255;for(O=0,g=h.length;O<g;O+=4)h[O]=this.rVals[h[O]],h[O+1]=this.gVals[h[O+1]],h[O+2]=this.bVals[h[O+2]]},getUniformLocations:function(l,c){return{uGamma:l.getUniformLocation(c,"uGamma")}},sendUniformData:function(l,c){l.uniform3fv(c.uGamma,this.gamma)}}),p.Image.filters.Gamma.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.Composed=b(C.BaseFilter,{type:"Composed",subFilters:[],initialize:function(l){this.callSuper("initialize",l),this.subFilters=this.subFilters.slice(0)},applyTo:function(l){l.passes+=this.subFilters.length-1,this.subFilters.forEach(function(c){c.applyTo(l)})},toObject:function(){return p.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(l){return l.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(l){return!l.isNeutralState()})}}),p.Image.filters.Composed.fromObject=function(l,c){var h=l.subFilters||[],m=h.map(function(d){return new p.Image.filters[d.type](d)}),g=new p.Image.filters.Composed({subFilters:m});return c&&c(g),g}}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.Image.filters,b=p.util.createClass;C.HueRotation=b(C.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var l=this.rotation*Math.PI,c=p.util.cos(l),h=p.util.sin(l),m=1/3,g=Math.sqrt(m)*h,d=1-c;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=c+d/3,this.matrix[1]=m*d-g,this.matrix[2]=m*d+g,this.matrix[5]=m*d+g,this.matrix[6]=c+m*d,this.matrix[7]=m*d-g,this.matrix[10]=m*d-g,this.matrix[11]=m*d+g,this.matrix[12]=c+m*d},isNeutralState:function(l){return this.calculateMatrix(),C.BaseFilter.prototype.isNeutralState.call(this,l)},applyTo:function(l){this.calculateMatrix(),C.BaseFilter.prototype.applyTo.call(this,l)}}),p.Image.filters.HueRotation.fromObject=p.Image.filters.BaseFilter.fromObject}(Z),function(s){var p=s.fabric||(s.fabric={}),C=p.util.object.clone;if(p.Text){p.warn("fabric.Text is already defined");return}var b="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");p.Text=p.util.createClass(p.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:p.Object.prototype.stateProperties.concat(b),cacheProperties:p.Object.prototype.cacheProperties.concat(b),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(l,c){this.styles=c?c.styles||{}:{},this.text=l,this.__skipDimension=!0,this.callSuper("initialize",c),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var l=this.path;l&&(l.segmentsInfo=p.util.getPathSegmentsInfo(l.path))},getMeasuringContext:function(){return p._measuringContext||(p._measuringContext=this.canvas&&this.canvas.contextCache||p.util.createCanvasElement().getContext("2d")),p._measuringContext},_splitText:function(){var l=this._splitTextIntoLines(this.text);return this.textLines=l.lines,this._textLines=l.graphemeLines,this._unwrappedTextLines=l._unwrappedLines,this._text=l.graphemeText,l},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var l,c,h,m,g,d,w,E=0,O=this._textLines.length;E<O;E++)if(!(this.textAlign!=="justify"&&(E===O-1||this.isEndOfWrapping(E)))&&(m=0,g=this._textLines[E],c=this.getLineWidth(E),c<this.width&&(w=this.textLines[E].match(this._reSpacesAndTabs)))){h=w.length,l=(this.width-c)/h;for(var L=0,U=g.length;L<=U;L++)d=this.__charBounds[E][L],this._reSpaceAndTab.test(g[L])?(d.width+=l,d.kernedWidth+=l,d.left+=m,m+=l):d.left+=m}},isEndOfWrapping:function(l){return l===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var l=this.callSuper("_getCacheCanvasDimensions"),c=this.fontSize;return l.width+=c*l.zoomX,l.height+=c*l.zoomY,l},_render:function(l){var c=this.path;c&&!c.isNotVisible()&&c._render(l),this._setTextStyles(l),this._renderTextLinesBackground(l),this._renderTextDecoration(l,"underline"),this._renderText(l),this._renderTextDecoration(l,"overline"),this._renderTextDecoration(l,"linethrough")},_renderText:function(l){this.paintFirst==="stroke"?(this._renderTextStroke(l),this._renderTextFill(l)):(this._renderTextFill(l),this._renderTextStroke(l))},_setTextStyles:function(l,c,h){if(l.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":l.textBaseline="middle";break;case"ascender":l.textBaseline="top";break;case"descender":l.textBaseline="bottom";break}l.font=this._getFontDeclaration(c,h)},calcTextWidth:function(){for(var l=this.getLineWidth(0),c=1,h=this._textLines.length;c<h;c++){var m=this.getLineWidth(c);m>l&&(l=m)}return l},_renderTextLine:function(l,c,h,m,g,d){this._renderChars(l,c,h,m,g,d)},_renderTextLinesBackground:function(l){if(!(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))){for(var c,h,m=l.fillStyle,g,d,w=this._getLeftOffset(),E=this._getTopOffset(),O=0,L=0,U,$,nt=this.path,xt,Ft=0,Kt=this._textLines.length;Ft<Kt;Ft++){if(c=this.getHeightOfLine(Ft),!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",Ft)){E+=c;continue}g=this._textLines[Ft],h=this._getLineLeftOffset(Ft),L=0,O=0,d=this.getValueOfPropertyAt(Ft,0,"textBackgroundColor");for(var Jt=0,Qt=g.length;Jt<Qt;Jt++)U=this.__charBounds[Ft][Jt],$=this.getValueOfPropertyAt(Ft,Jt,"textBackgroundColor"),nt?(l.save(),l.translate(U.renderLeft,U.renderTop),l.rotate(U.angle),l.fillStyle=$,$&&l.fillRect(-U.width/2,-c/this.lineHeight*(1-this._fontSizeFraction),U.width,c/this.lineHeight),l.restore()):$!==d?(xt=w+h+O,this.direction==="rtl"&&(xt=this.width-xt-L),l.fillStyle=d,d&&l.fillRect(xt,E,L,c/this.lineHeight),O=U.left,L=U.width,d=$):L+=U.kernedWidth;$&&!nt&&(xt=w+h+O,this.direction==="rtl"&&(xt=this.width-xt-L),l.fillStyle=$,l.fillRect(xt,E,L,c/this.lineHeight)),E+=c}l.fillStyle=m,this._removeShadow(l)}},getFontCache:function(l){var c=l.fontFamily.toLowerCase();p.charWidthsCache[c]||(p.charWidthsCache[c]={});var h=p.charWidthsCache[c],m=l.fontStyle.toLowerCase()+"_"+(l.fontWeight+"").toLowerCase();return h[m]||(h[m]={}),h[m]},_measureChar:function(l,c,h,m){var g=this.getFontCache(c),d=this._getFontDeclaration(c),w=this._getFontDeclaration(m),E=h+l,O=d===w,L,U,$,nt=c.fontSize/this.CACHE_FONT_SIZE,xt;if(h&&g[h]!==void 0&&($=g[h]),g[l]!==void 0&&(xt=L=g[l]),O&&g[E]!==void 0&&(U=g[E],xt=U-$),L===void 0||$===void 0||U===void 0){var Ft=this.getMeasuringContext();this._setTextStyles(Ft,c,!0)}return L===void 0&&(xt=L=Ft.measureText(l).width,g[l]=L),$===void 0&&O&&h&&($=Ft.measureText(h).width,g[h]=$),O&&U===void 0&&(U=Ft.measureText(E).width,g[E]=U,xt=U-$),{width:L*nt,kernedWidth:xt*nt}},getHeightOfChar:function(l,c){return this.getValueOfPropertyAt(l,c,"fontSize")},measureLine:function(l){var c=this._measureLine(l);return this.charSpacing!==0&&(c.width-=this._getWidthOfCharSpacing()),c.width<0&&(c.width=0),c},_measureLine:function(l){var c=0,h,m,g=this._textLines[l],d,w,E=0,O=new Array(g.length),L=0,U,$,nt=this.path,xt=this.pathSide==="right";for(this.__charBounds[l]=O,h=0;h<g.length;h++)m=g[h],w=this._getGraphemeBox(m,l,h,d),O[h]=w,c+=w.kernedWidth,d=m;if(O[h]={left:w?w.left+w.width:0,width:0,kernedWidth:0,height:this.fontSize},nt){switch($=nt.segmentsInfo[nt.segmentsInfo.length-1].length,U=p.util.getPointOnPath(nt.path,0,nt.segmentsInfo),U.x+=nt.pathOffset.x,U.y+=nt.pathOffset.y,this.textAlign){case"left":L=xt?$-c:0;break;case"center":L=($-c)/2;break;case"right":L=xt?0:$-c;break}for(L+=this.pathStartOffset*(xt?-1:1),h=xt?g.length-1:0;xt?h>=0:h<g.length;xt?h--:h++)w=O[h],L>$?L%=$:L<0&&(L+=$),this._setGraphemeOnPath(L,w,U),L+=w.kernedWidth}return{width:c,numOfSpaces:E}},_setGraphemeOnPath:function(l,c,h){var m=l+c.kernedWidth/2,g=this.path,d=p.util.getPointOnPath(g.path,m,g.segmentsInfo);c.renderLeft=d.x-h.x,c.renderTop=d.y-h.y,c.angle=d.angle+(this.pathSide==="right"?Math.PI:0)},_getGraphemeBox:function(l,c,h,m,g){var d=this.getCompleteStyleDeclaration(c,h),w=m?this.getCompleteStyleDeclaration(c,h-1):{},E=this._measureChar(l,d,m,w),O=E.kernedWidth,L=E.width,U;this.charSpacing!==0&&(U=this._getWidthOfCharSpacing(),L+=U,O+=U);var $={width:L,left:0,height:d.fontSize,kernedWidth:O,deltaY:d.deltaY};if(h>0&&!g){var nt=this.__charBounds[c][h-1];$.left=nt.left+nt.width+E.kernedWidth-E.width}return $},getHeightOfLine:function(l){if(this.__lineHeights[l])return this.__lineHeights[l];for(var c=this._textLines[l],h=this.getHeightOfChar(l,0),m=1,g=c.length;m<g;m++)h=Math.max(this.getHeightOfChar(l,m),h);return this.__lineHeights[l]=h*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var l,c=0,h=0,m=this._textLines.length;h<m;h++)l=this.getHeightOfLine(h),c+=h===m-1?l/this.lineHeight:l;return c},_getLeftOffset:function(){return this.direction==="ltr"?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(l,c){l.save();for(var h=0,m=this._getLeftOffset(),g=this._getTopOffset(),d=0,w=this._textLines.length;d<w;d++){var E=this.getHeightOfLine(d),O=E/this.lineHeight,L=this._getLineLeftOffset(d);this._renderTextLine(c,l,this._textLines[d],m+L,g+h+O,d),h+=E}l.restore()},_renderTextFill:function(l){!this.fill&&!this.styleHas("fill")||this._renderTextCommon(l,"fillText")},_renderTextStroke:function(l){(!this.stroke||this.strokeWidth===0)&&this.isEmptyStyles()||(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(l),l.save(),this._setLineDash(l,this.strokeDashArray),l.beginPath(),this._renderTextCommon(l,"strokeText"),l.closePath(),l.restore())},_renderChars:function(l,c,h,m,g,d){var w=this.getHeightOfLine(d),E=this.textAlign.indexOf("justify")!==-1,O,L,U="",$,nt=0,xt,Ft=this.path,Kt=!E&&this.charSpacing===0&&this.isEmptyStyles(d)&&!Ft,Jt=this.direction==="ltr",Qt=this.direction==="ltr"?1:-1,he,ne=c.canvas.getAttribute("dir");if(c.save(),ne!==this.direction&&(c.canvas.setAttribute("dir",Jt?"ltr":"rtl"),c.direction=Jt?"ltr":"rtl",c.textAlign=Jt?"left":"right"),g-=w*this._fontSizeFraction/this.lineHeight,Kt){this._renderChar(l,c,d,0,h.join(""),m,g,w),c.restore();return}for(var me=0,Oe=h.length-1;me<=Oe;me++)xt=me===Oe||this.charSpacing||Ft,U+=h[me],$=this.__charBounds[d][me],nt===0?(m+=Qt*($.kernedWidth-$.width),nt+=$.width):nt+=$.kernedWidth,E&&!xt&&this._reSpaceAndTab.test(h[me])&&(xt=!0),xt||(O=O||this.getCompleteStyleDeclaration(d,me),L=this.getCompleteStyleDeclaration(d,me+1),xt=p.util.hasStyleChanged(O,L,!1)),xt&&(Ft?(c.save(),c.translate($.renderLeft,$.renderTop),c.rotate($.angle),this._renderChar(l,c,d,me,U,-nt/2,0,w),c.restore()):(he=m,this._renderChar(l,c,d,me,U,he,g,w)),U="",O=L,m+=Qt*nt,nt=0);c.restore()},_applyPatternGradientTransformText:function(l){var c=p.util.createCanvasElement(),h,m=this.width+this.strokeWidth,g=this.height+this.strokeWidth;return c.width=m,c.height=g,h=c.getContext("2d"),h.beginPath(),h.moveTo(0,0),h.lineTo(m,0),h.lineTo(m,g),h.lineTo(0,g),h.closePath(),h.translate(m/2,g/2),h.fillStyle=l.toLive(h),this._applyPatternGradientTransform(h,l),h.fill(),h.createPattern(c,"no-repeat")},handleFiller:function(l,c,h){var m,g;return h.toLive?h.gradientUnits==="percentage"||h.gradientTransform||h.patternTransform?(m=-this.width/2,g=-this.height/2,l.translate(m,g),l[c]=this._applyPatternGradientTransformText(h),{offsetX:m,offsetY:g}):(l[c]=h.toLive(l,this),this._applyPatternGradientTransform(l,h)):(l[c]=h,{offsetX:0,offsetY:0})},_setStrokeStyles:function(l,c){return l.lineWidth=c.strokeWidth,l.lineCap=this.strokeLineCap,l.lineDashOffset=this.strokeDashOffset,l.lineJoin=this.strokeLineJoin,l.miterLimit=this.strokeMiterLimit,this.handleFiller(l,"strokeStyle",c.stroke)},_setFillStyles:function(l,c){return this.handleFiller(l,"fillStyle",c.fill)},_renderChar:function(l,c,h,m,g,d,w){var E=this._getStyleDeclaration(h,m),O=this.getCompleteStyleDeclaration(h,m),L=l==="fillText"&&O.fill,U=l==="strokeText"&&O.stroke&&O.strokeWidth,$,nt;!U&&!L||(c.save(),L&&($=this._setFillStyles(c,O)),U&&(nt=this._setStrokeStyles(c,O)),c.font=this._getFontDeclaration(O),E&&E.textBackgroundColor&&this._removeShadow(c),E&&E.deltaY&&(w+=E.deltaY),L&&c.fillText(g,d-$.offsetX,w-$.offsetY),U&&c.strokeText(g,d-nt.offsetX,w-nt.offsetY),c.restore())},setSuperscript:function(l,c){return this._setScript(l,c,this.superscript)},setSubscript:function(l,c){return this._setScript(l,c,this.subscript)},_setScript:function(l,c,h){var m=this.get2DCursorLocation(l,!0),g=this.getValueOfPropertyAt(m.lineIndex,m.charIndex,"fontSize"),d=this.getValueOfPropertyAt(m.lineIndex,m.charIndex,"deltaY"),w={fontSize:g*h.size,deltaY:d+g*h.baseline};return this.setSelectionStyles(w,l,c),this},_getLineLeftOffset:function(l){var c=this.getLineWidth(l),h=this.width-c,m=this.textAlign,g=this.direction,w,d=0,w=this.isEndOfWrapping(l);return m==="justify"||m==="justify-center"&&!w||m==="justify-right"&&!w||m==="justify-left"&&!w?0:(m==="center"&&(d=h/2),m==="right"&&(d=h),m==="justify-center"&&(d=h/2),m==="justify-right"&&(d=h),g==="rtl"&&(d-=h),d)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var l=this._forceClearCache;return l||(l=this.hasStateChanged("_dimensionAffectingProps")),l&&(this.dirty=!0,this._forceClearCache=!1),l},getLineWidth:function(l){if(this.__lineWidths[l]!==void 0)return this.__lineWidths[l];var c=this.measureLine(l),h=c.width;return this.__lineWidths[l]=h,h},_getWidthOfCharSpacing:function(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(l,c,h){var m=this._getStyleDeclaration(l,c);return m&&typeof m[h]<"u"?m[h]:this[h]},_renderTextDecoration:function(l,c){if(!(!this[c]&&!this.styleHas(c))){for(var h,m,g,d,w,E,O,L,U=this._getLeftOffset(),$=this._getTopOffset(),nt,xt,Ft,Kt,Jt,Qt,he,ne,me=this.path,Oe=this._getWidthOfCharSpacing(),se=this.offsets[c],be=0,Q=this._textLines.length;be<Q;be++){if(h=this.getHeightOfLine(be),!this[c]&&!this.styleHas(c,be)){$+=h;continue}O=this._textLines[be],Qt=h/this.lineHeight,d=this._getLineLeftOffset(be),xt=0,Ft=0,L=this.getValueOfPropertyAt(be,0,c),ne=this.getValueOfPropertyAt(be,0,"fill"),nt=$+Qt*(1-this._fontSizeFraction),m=this.getHeightOfChar(be,0),w=this.getValueOfPropertyAt(be,0,"deltaY");for(var wt=0,gt=O.length;wt<gt;wt++)if(Kt=this.__charBounds[be][wt],Jt=this.getValueOfPropertyAt(be,wt,c),he=this.getValueOfPropertyAt(be,wt,"fill"),g=this.getHeightOfChar(be,wt),E=this.getValueOfPropertyAt(be,wt,"deltaY"),me&&Jt&&he)l.save(),l.fillStyle=ne,l.translate(Kt.renderLeft,Kt.renderTop),l.rotate(Kt.angle),l.fillRect(-Kt.kernedWidth/2,se*g+E,Kt.kernedWidth,this.fontSize/15),l.restore();else if((Jt!==L||he!==ne||g!==m||E!==w)&&Ft>0){var vt=U+d+xt;this.direction==="rtl"&&(vt=this.width-vt-Ft),L&&ne&&(l.fillStyle=ne,l.fillRect(vt,nt+se*m+w,Ft,this.fontSize/15)),xt=Kt.left,Ft=Kt.width,L=Jt,ne=he,m=g,w=E}else Ft+=Kt.kernedWidth;var vt=U+d+xt;this.direction==="rtl"&&(vt=this.width-vt-Ft),l.fillStyle=he,Jt&&he&&l.fillRect(vt,nt+se*m+w,Ft-Oe,this.fontSize/15),$+=h}this._removeShadow(l)}},_getFontDeclaration:function(l,c){var h=l||this,m=this.fontFamily,g=p.Text.genericFonts.indexOf(m.toLowerCase())>-1,d=m===void 0||m.indexOf("'")>-1||m.indexOf(",")>-1||m.indexOf('"')>-1||g?h.fontFamily:'"'+h.fontFamily+'"';return[p.isLikelyNode?h.fontWeight:h.fontStyle,p.isLikelyNode?h.fontStyle:h.fontWeight,c?this.CACHE_FONT_SIZE+"px":h.fontSize+"px",d].join(" ")},render:function(l){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",l)))},_splitTextIntoLines:function(l){for(var c=l.split(this._reNewline),h=new Array(c.length),m=[`
`],g=[],d=0;d<c.length;d++)h[d]=p.util.string.graphemeSplit(c[d]),g=g.concat(h[d],m);return g.pop(),{_unwrappedLines:h,lines:c,graphemeText:g,graphemeLines:h}},toObject:function(l){var c=b.concat(l),h=this.callSuper("toObject",c);return h.styles=p.util.stylesToArray(this.styles,this.text),h.path&&(h.path=this.path.toObject()),h},set:function(l,c){this.callSuper("set",l,c);var h=!1,m=!1;if(typeof l=="object")for(var g in l)g==="path"&&this.setPathInfo(),h=h||this._dimensionAffectingProps.indexOf(g)!==-1,m=m||g==="path";else h=this._dimensionAffectingProps.indexOf(l)!==-1,m=l==="path";return m&&this.setPathInfo(),h&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),p.Text.ATTRIBUTE_NAMES=p.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),p.Text.DEFAULT_SVG_FONT_SIZE=16,p.Text.fromElement=function(l,c,h){if(!l)return c(null);var m=p.parseAttributes(l,p.Text.ATTRIBUTE_NAMES),g=m.textAnchor||"left";if(h=p.util.object.extend(h?C(h):{},m),h.top=h.top||0,h.left=h.left||0,m.textDecoration){var d=m.textDecoration;d.indexOf("underline")!==-1&&(h.underline=!0),d.indexOf("overline")!==-1&&(h.overline=!0),d.indexOf("line-through")!==-1&&(h.linethrough=!0),delete h.textDecoration}"dx"in m&&(h.left+=m.dx),"dy"in m&&(h.top+=m.dy),"fontSize"in h||(h.fontSize=p.Text.DEFAULT_SVG_FONT_SIZE);var w="";"textContent"in l?w=l.textContent:"firstChild"in l&&l.firstChild!==null&&"data"in l.firstChild&&l.firstChild.data!==null&&(w=l.firstChild.data),w=w.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var E=h.strokeWidth;h.strokeWidth=0;var O=new p.Text(w,h),L=O.getScaledHeight()/O.height,U=(O.height+O.strokeWidth)*O.lineHeight-O.height,$=U*L,nt=O.getScaledHeight()+$,xt=0;g==="center"&&(xt=O.getScaledWidth()/2),g==="right"&&(xt=O.getScaledWidth()),O.set({left:O.left-xt,top:O.top-(nt-O.fontSize*(.07+O._fontSizeFraction))/O.lineHeight,strokeWidth:typeof E<"u"?E:1}),c(O)},p.Text.fromObject=function(l,c){var h=C(l),m=l.path;return delete h.path,p.Object._fromObject("Text",h,function(g){g.styles=p.util.stylesFromArray(l.styles,l.text),m?p.Object._fromObject("Path",m,function(d){g.set("path",d),c(g)},"path"):c(g)},"text")},p.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],p.util.createAccessors&&p.util.createAccessors(p.Text)}(Z),function(){S.util.object.extend(S.Text.prototype,{isEmptyStyles:function(s){if(!this.styles||typeof s<"u"&&!this.styles[s])return!0;var p=typeof s>"u"?this.styles:{line:this.styles[s]};for(var C in p)for(var b in p[C])for(var l in p[C][b])return!1;return!0},styleHas:function(s,p){if(!this.styles||!s||s===""||typeof p<"u"&&!this.styles[p])return!1;var C=typeof p>"u"?this.styles:{0:this.styles[p]};for(var b in C)for(var l in C[b])if(typeof C[b][l][s]<"u")return!0;return!1},cleanStyle:function(s){if(!this.styles||!s||s==="")return!1;var p=this.styles,C=0,b,l,c=!0,h=0,m;for(var g in p){b=0;for(var d in p[g]){var m=p[g][d],w=m.hasOwnProperty(s);C++,w?(l?m[s]!==l&&(c=!1):l=m[s],m[s]===this[s]&&delete m[s]):c=!1,Object.keys(m).length!==0?b++:delete p[g][d]}b===0&&delete p[g]}for(var E=0;E<this._textLines.length;E++)h+=this._textLines[E].length;c&&C===h&&(this[s]=l,this.removeStyle(s))},removeStyle:function(s){if(!(!this.styles||!s||s==="")){var p=this.styles,C,b,l;for(b in p){C=p[b];for(l in C)delete C[l][s],Object.keys(C[l]).length===0&&delete C[l];Object.keys(C).length===0&&delete p[b]}}},_extendStyles:function(s,p){var C=this.get2DCursorLocation(s);this._getLineStyle(C.lineIndex)||this._setLineStyle(C.lineIndex),this._getStyleDeclaration(C.lineIndex,C.charIndex)||this._setStyleDeclaration(C.lineIndex,C.charIndex,{}),S.util.object.extend(this._getStyleDeclaration(C.lineIndex,C.charIndex),p)},get2DCursorLocation:function(s,p){typeof s>"u"&&(s=this.selectionStart);for(var C=p?this._unwrappedTextLines:this._textLines,b=C.length,l=0;l<b;l++){if(s<=C[l].length)return{lineIndex:l,charIndex:s};s-=C[l].length+this.missingNewlineOffset(l)}return{lineIndex:l-1,charIndex:C[l-1].length<s?C[l-1].length:s}},getSelectionStyles:function(s,p,C){typeof s>"u"&&(s=this.selectionStart||0),typeof p>"u"&&(p=this.selectionEnd||s);for(var b=[],l=s;l<p;l++)b.push(this.getStyleAtPosition(l,C));return b},getStyleAtPosition:function(s,p){var C=this.get2DCursorLocation(s),b=p?this.getCompleteStyleDeclaration(C.lineIndex,C.charIndex):this._getStyleDeclaration(C.lineIndex,C.charIndex);return b||{}},setSelectionStyles:function(s,p,C){typeof p>"u"&&(p=this.selectionStart||0),typeof C>"u"&&(C=this.selectionEnd||p);for(var b=p;b<C;b++)this._extendStyles(b,s);return this._forceClearCache=!0,this},_getStyleDeclaration:function(s,p){var C=this.styles&&this.styles[s];return C?C[p]:null},getCompleteStyleDeclaration:function(s,p){for(var C=this._getStyleDeclaration(s,p)||{},b={},l,c=0;c<this._styleProperties.length;c++)l=this._styleProperties[c],b[l]=typeof C[l]>"u"?this[l]:C[l];return b},_setStyleDeclaration:function(s,p,C){this.styles[s][p]=C},_deleteStyleDeclaration:function(s,p){delete this.styles[s][p]},_getLineStyle:function(s){return!!this.styles[s]},_setLineStyle:function(s){this.styles[s]={}},_deleteLineStyle:function(s){delete this.styles[s]}})}(),function(){function s(p){p.textDecoration&&(p.textDecoration.indexOf("underline")>-1&&(p.underline=!0),p.textDecoration.indexOf("line-through")>-1&&(p.linethrough=!0),p.textDecoration.indexOf("overline")>-1&&(p.overline=!0),delete p.textDecoration)}S.IText=S.util.createClass(S.Text,S.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(p,C){this.callSuper("initialize",p,C),this.initBehavior()},setSelectionStart:function(p){p=Math.max(p,0),this._updateAndFire("selectionStart",p)},setSelectionEnd:function(p){p=Math.min(p,this.text.length),this._updateAndFire("selectionEnd",p)},_updateAndFire:function(p,C){this[p]!==C&&(this._fireSelectionChanged(),this[p]=C),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(p){this.clearContextTop(),this.callSuper("render",p),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(p){this.callSuper("_render",p)},clearContextTop:function(p){if(!(!this.isEditing||!this.canvas||!this.canvas.contextTop)){var C=this.canvas.contextTop,b=this.canvas.viewportTransform;C.save(),C.transform(b[0],b[1],b[2],b[3],b[4],b[5]),this.transform(C),this._clearTextArea(C),p||C.restore()}},renderCursorOrSelection:function(){if(!(!this.isEditing||!this.canvas||!this.canvas.contextTop)){var p=this._getCursorBoundaries(),C=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(p,C):this.renderSelection(p,C),C.restore()}},_clearTextArea:function(p){var C=this.width+4,b=this.height+4;p.clearRect(-C/2,-b/2,C,b)},_getCursorBoundaries:function(p){typeof p>"u"&&(p=this.selectionStart);var C=this._getLeftOffset(),b=this._getTopOffset(),l=this._getCursorBoundariesOffsets(p);return{left:C,top:b,leftOffset:l.left,topOffset:l.top}},_getCursorBoundariesOffsets:function(p){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var C,b,l,c=0,h=0,m,g=this.get2DCursorLocation(p);l=g.charIndex,b=g.lineIndex;for(var d=0;d<b;d++)c+=this.getHeightOfLine(d);C=this._getLineLeftOffset(b);var w=this.__charBounds[b][l];return w&&(h=w.left),this.charSpacing!==0&&l===this._textLines[b].length&&(h-=this._getWidthOfCharSpacing()),m={top:c,left:C+(h>0?h:0)},this.direction==="rtl"&&(m.left*=-1),this.cursorOffsetCache=m,this.cursorOffsetCache},renderCursor:function(p,C){var b=this.get2DCursorLocation(),l=b.lineIndex,c=b.charIndex>0?b.charIndex-1:0,h=this.getValueOfPropertyAt(l,c,"fontSize"),m=this.scaleX*this.canvas.getZoom(),g=this.cursorWidth/m,d=p.topOffset,w=this.getValueOfPropertyAt(l,c,"deltaY");d+=(1-this._fontSizeFraction)*this.getHeightOfLine(l)/this.lineHeight-h*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(p,C),C.fillStyle=this.cursorColor||this.getValueOfPropertyAt(l,c,"fill"),C.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,C.fillRect(p.left+p.leftOffset-g/2,d+p.top+w,g,h)},renderSelection:function(p,C){for(var b=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,l=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,c=this.textAlign.indexOf("justify")!==-1,h=this.get2DCursorLocation(b),m=this.get2DCursorLocation(l),g=h.lineIndex,d=m.lineIndex,w=h.charIndex<0?0:h.charIndex,E=m.charIndex<0?0:m.charIndex,O=g;O<=d;O++){var L=this._getLineLeftOffset(O)||0,U=this.getHeightOfLine(O),$=0,nt=0,xt=0;if(O===g&&(nt=this.__charBounds[g][w].left),O>=g&&O<d)xt=c&&!this.isEndOfWrapping(O)?this.width:this.getLineWidth(O)||5;else if(O===d)if(E===0)xt=this.__charBounds[d][E].left;else{var Ft=this._getWidthOfCharSpacing();xt=this.__charBounds[d][E-1].left+this.__charBounds[d][E-1].width-Ft}$=U,(this.lineHeight<1||O===d&&this.lineHeight>1)&&(U/=this.lineHeight);var Kt=p.left+L+nt,Jt=xt-nt,Qt=U,he=0;this.inCompositionMode?(C.fillStyle=this.compositionColor||"black",Qt=1,he=U):C.fillStyle=this.selectionColor,this.direction==="rtl"&&(Kt=this.width-Kt-Jt),C.fillRect(Kt,p.top+p.topOffset+he,Jt,Qt),p.topOffset+=$}},getCurrentCharFontSize:function(){var p=this._getCurrentCharIndex();return this.getValueOfPropertyAt(p.l,p.c,"fontSize")},getCurrentCharColor:function(){var p=this._getCurrentCharIndex();return this.getValueOfPropertyAt(p.l,p.c,"fill")},_getCurrentCharIndex:function(){var p=this.get2DCursorLocation(this.selectionStart,!0),C=p.charIndex>0?p.charIndex-1:0;return{l:p.lineIndex,c:C}}}),S.IText.fromObject=function(p,C){var b=S.util.stylesFromArray(p.styles,p.text),l=Object.assign({},p,{styles:b});if(s(l),l.styles)for(var c in l.styles)for(var h in l.styles[c])s(l.styles[c][h]);S.Object._fromObject("IText",l,C,"text")}}(),function(){var s=S.util.object.clone;S.util.object.extend(S.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var p=this;this.on("added",function(){var C=p.canvas;C&&(C._hasITextHandlers||(C._hasITextHandlers=!0,p._initCanvasHandlers(C)),C._iTextInstances=C._iTextInstances||[],C._iTextInstances.push(p))})},initRemovedHandler:function(){var p=this;this.on("removed",function(){var C=p.canvas;C&&(C._iTextInstances=C._iTextInstances||[],S.util.removeFromArray(C._iTextInstances,p),C._iTextInstances.length===0&&(C._hasITextHandlers=!1,p._removeCanvasHandlers(C)))})},_initCanvasHandlers:function(p){p._mouseUpITextHandler=function(){p._iTextInstances&&p._iTextInstances.forEach(function(C){C.__isMousedown=!1})},p.on("mouse:up",p._mouseUpITextHandler)},_removeCanvasHandlers:function(p){p.off("mouse:up",p._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(p,C,b,l){var c;return c={isAborted:!1,abort:function(){this.isAborted=!0}},p.animate("_currentCursorOpacity",C,{duration:b,onComplete:function(){c.isAborted||p[l]()},onChange:function(){p.canvas&&p.selectionStart===p.selectionEnd&&p.renderCursorOrSelection()},abort:function(){return c.isAborted}}),c},_onTickComplete:function(){var p=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){p._currentTickCompleteState=p._animateCursor(p,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(p){var C=this,b=p?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){C._tick()},b)},abortCursorAnimation:function(){var p=this._currentTickState||this._currentTickCompleteState,C=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,p&&C&&C.clearContext(C.contextTop||C.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(p){var C=0,b=p-1;if(this._reSpace.test(this._text[b]))for(;this._reSpace.test(this._text[b]);)C++,b--;for(;/\S/.test(this._text[b])&&b>-1;)C++,b--;return p-C},findWordBoundaryRight:function(p){var C=0,b=p;if(this._reSpace.test(this._text[b]))for(;this._reSpace.test(this._text[b]);)C++,b++;for(;/\S/.test(this._text[b])&&b<this._text.length;)C++,b++;return p+C},findLineBoundaryLeft:function(p){for(var C=0,b=p-1;!/\n/.test(this._text[b])&&b>-1;)C++,b--;return p-C},findLineBoundaryRight:function(p){for(var C=0,b=p;!/\n/.test(this._text[b])&&b<this._text.length;)C++,b++;return p+C},searchWordBoundary:function(p,C){for(var b=this._text,l=this._reSpace.test(b[p])?p-1:p,c=b[l],h=S.reNonWord;!h.test(c)&&l>0&&l<b.length;)l+=C,c=b[l];return h.test(c)&&(l+=C===1?0:1),l},selectWord:function(p){p=p||this.selectionStart;var C=this.searchWordBoundary(p,-1),b=this.searchWordBoundary(p,1);this.selectionStart=C,this.selectionEnd=b,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(p){p=p||this.selectionStart;var C=this.findLineBoundaryLeft(p),b=this.findLineBoundaryRight(p);return this.selectionStart=C,this.selectionEnd=b,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(p){if(!(this.isEditing||!this.editable))return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(p),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(p){p._iTextInstances&&p._iTextInstances.forEach(function(C){C.selected=!1,C.isEditing&&C.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(p){if(!(!this.__isMousedown||!this.isEditing)){document.activeElement!==this.hiddenTextarea&&this.hiddenTextarea.focus();var C=this.getSelectionStartFromPointer(p.e),b=this.selectionStart,l=this.selectionEnd;(C!==this.__selectionStartOnMouseDown||b===l)&&(b===C||l===C)||(C>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=C):(this.selectionStart=C,this.selectionEnd=this.__selectionStartOnMouseDown),(this.selectionStart!==b||this.selectionEnd!==l)&&(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(p,C,b){var l=b.slice(0,p),c=S.util.string.graphemeSplit(l).length;if(p===C)return{selectionStart:c,selectionEnd:c};var h=b.slice(p,C),m=S.util.string.graphemeSplit(h).length;return{selectionStart:c,selectionEnd:c+m}},fromGraphemeToStringSelection:function(p,C,b){var l=b.slice(0,p),c=l.join("").length;if(p===C)return{selectionStart:c,selectionEnd:c};var h=b.slice(p,C),m=h.join("").length;return{selectionStart:c,selectionEnd:c+m}},_updateTextarea:function(){if(this.cursorOffsetCache={},!!this.hiddenTextarea){if(!this.inCompositionMode){var p=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=p.selectionStart,this.hiddenTextarea.selectionEnd=p.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var p=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=p.selectionEnd,this.inCompositionMode||(this.selectionStart=p.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var p=this._calcTextareaPosition();this.hiddenTextarea.style.left=p.left,this.hiddenTextarea.style.top=p.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var p=this.inCompositionMode?this.compositionStart:this.selectionStart,C=this._getCursorBoundaries(p),b=this.get2DCursorLocation(p),l=b.lineIndex,c=b.charIndex,h=this.getValueOfPropertyAt(l,c,"fontSize")*this.lineHeight,m=C.leftOffset,g=this.calcTransformMatrix(),d={x:C.left+m,y:C.top+C.topOffset+h},w=this.canvas.getRetinaScaling(),E=this.canvas.upperCanvasEl,O=E.width/w,L=E.height/w,U=O-h,$=L-h,nt=E.clientWidth/O,xt=E.clientHeight/L;return d=S.util.transformPoint(d,g),d=S.util.transformPoint(d,this.canvas.viewportTransform),d.x*=nt,d.y*=xt,d.x<0&&(d.x=0),d.x>U&&(d.x=U),d.y<0&&(d.y=0),d.y>$&&(d.y=$),d.x+=this.canvas._offset.left,d.y+=this.canvas._offset.top,{left:d.x+"px",top:d.y+"px",fontSize:h+"px",charHeight:h}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var p=this._textBeforeEdit!==this.text,C=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,C&&(C.blur&&C.blur(),C.parentNode&&C.parentNode.removeChild(C)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),p&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),p&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var p in this.styles)this._textLines[p]||delete this.styles[p]},removeStyleFromTo:function(p,C){var b=this.get2DCursorLocation(p,!0),l=this.get2DCursorLocation(C,!0),c=b.lineIndex,h=b.charIndex,m=l.lineIndex,g=l.charIndex,d,w;if(c!==m){if(this.styles[c])for(d=h;d<this._unwrappedTextLines[c].length;d++)delete this.styles[c][d];if(this.styles[m])for(d=g;d<this._unwrappedTextLines[m].length;d++)w=this.styles[m][d],w&&(this.styles[c]||(this.styles[c]={}),this.styles[c][h+d-g]=w);for(d=c+1;d<=m;d++)delete this.styles[d];this.shiftLineStyles(m,c-m)}else if(this.styles[c]){w=this.styles[c];var E=g-h,O,L;for(d=h;d<g;d++)delete w[d];for(L in this.styles[c])O=parseInt(L,10),O>=g&&(w[O-E]=w[L],delete w[L])}},shiftLineStyles:function(p,C){var b=s(this.styles);for(var l in this.styles){var c=parseInt(l,10);c>p&&(this.styles[c+C]=b[c],b[c-C]||delete this.styles[c])}},restartCursorIfNeeded:function(){(!this._currentTickState||this._currentTickState.isAborted||!this._currentTickCompleteState||this._currentTickCompleteState.isAborted)&&this.initDelayedCursor()},insertNewlineStyleObject:function(p,C,b,l){var c,h={},m=!1,g=this._unwrappedTextLines[p].length===C;b||(b=1),this.shiftLineStyles(p,b),this.styles[p]&&(c=this.styles[p][C===0?C:C-1]);for(var d in this.styles[p]){var w=parseInt(d,10);w>=C&&(m=!0,h[w-C]=this.styles[p][d],g&&C===0||delete this.styles[p][d])}var E=!1;for(m&&!g&&(this.styles[p+b]=h,E=!0),E&&b--;b>0;)l&&l[b-1]?this.styles[p+b]={0:s(l[b-1])}:c?this.styles[p+b]={0:s(c)}:delete this.styles[p+b],b--;this._forceClearCache=!0},insertCharStyleObject:function(p,C,b,l){this.styles||(this.styles={});var c=this.styles[p],h=c?s(c):{};b||(b=1);for(var m in h){var g=parseInt(m,10);g>=C&&(c[g+b]=h[g],h[g-b]||delete c[g])}if(this._forceClearCache=!0,l){for(;b--;)Object.keys(l[b]).length&&(this.styles[p]||(this.styles[p]={}),this.styles[p][C+b]=s(l[b]));return}if(c)for(var d=c[C?C-1:1];d&&b--;)this.styles[p][C+b]=s(d)},insertNewStyleBlock:function(p,C,b){for(var l=this.get2DCursorLocation(C,!0),c=[0],h=0,m=0;m<p.length;m++)p[m]===`
`?(h++,c[h]=0):c[h]++;c[0]>0&&(this.insertCharStyleObject(l.lineIndex,l.charIndex,c[0],b),b=b&&b.slice(c[0]+1)),h&&this.insertNewlineStyleObject(l.lineIndex,l.charIndex+c[0],h);for(var m=1;m<h;m++)c[m]>0?this.insertCharStyleObject(l.lineIndex+m,0,c[m],b):b&&this.styles[l.lineIndex+m]&&b[0]&&(this.styles[l.lineIndex+m][0]=b[0]),b=b&&b.slice(c[m]+1);c[m]>0&&this.insertCharStyleObject(l.lineIndex+m,0,c[m],b)},setSelectionStartEndWithShift:function(p,C,b){b<=p?(C===p?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=p),this.selectionStart=b):b>p&&b<C?this._selectionDirection==="right"?this.selectionEnd=b:this.selectionStart=b:(C===p?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=C),this.selectionEnd=b)},setSelectionInBoundaries:function(){var p=this.text.length;this.selectionStart>p?this.selectionStart=p:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>p?this.selectionEnd=p:this.selectionEnd<0&&(this.selectionEnd=0)}})}(),S.util.object.extend(S.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(s){if(this.canvas){this.__newClickTime=+new Date;var p=s.pointer;this.isTripleClick(p)&&(this.fire("tripleclick",s),this._stopEvent(s.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=p,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(s){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===s.x&&this.__lastPointer.y===s.y},_stopEvent:function(s){s.preventDefault&&s.preventDefault(),s.stopPropagation&&s.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(s){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(s.e))},tripleClickHandler:function(s){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(s.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(s){!this.canvas||!this.editable||s.e.button&&s.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(s.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(s){!this.canvas||!this.editable||s.e.button&&s.e.button!==1||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(s){if(this.__isMousedown=!1,!(!this.editable||this.group||s.transform&&s.transform.actionPerformed||s.e.button&&s.e.button!==1)){if(this.canvas){var p=this.canvas._activeObject;if(p&&p!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(s.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(s){var p=this.getSelectionStartFromPointer(s),C=this.selectionStart,b=this.selectionEnd;s.shiftKey?this.setSelectionStartEndWithShift(C,b,p):(this.selectionStart=p,this.selectionEnd=p),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(s){for(var p=this.getLocalPointer(s),C=0,b=0,l=0,c=0,h=0,m,g,d=0,w=this._textLines.length;d<w&&l<=p.y;d++)l+=this.getHeightOfLine(d)*this.scaleY,h=d,d>0&&(c+=this._textLines[d-1].length+this.missingNewlineOffset(d-1));m=this._getLineLeftOffset(h),b=m*this.scaleX,g=this._textLines[h],this.direction==="rtl"&&(p.x=this.width*this.scaleX-p.x+b);for(var E=0,O=g.length;E<O&&(C=b,b+=this.__charBounds[h][E].kernedWidth*this.scaleX,b<=p.x);E++)c++;return this._getNewSelectionStartFromOffset(p,C,b,c,O)},_getNewSelectionStartFromOffset:function(s,p,C,b,l){var c=s.x-p,h=C-s.x,m=h>c||h<0?0:1,g=b+m;return this.flipX&&(g=l-g),g>this._text.length&&(g=this._text.length),g}}),S.util.object.extend(S.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=S.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var s=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+s.top+"; left: "+s.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding-top: "+s.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):S.document.body.appendChild(this.hiddenTextarea),S.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),S.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),S.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),S.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),S.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),S.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),S.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),S.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),S.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(S.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(s){if(this.isEditing){var p=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(s.keyCode in p)this[p[s.keyCode]](s);else if(s.keyCode in this.ctrlKeysMapDown&&(s.ctrlKey||s.metaKey))this[this.ctrlKeysMapDown[s.keyCode]](s);else return;s.stopImmediatePropagation(),s.preventDefault(),s.keyCode>=33&&s.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(s){if(!this.isEditing||this._copyDone||this.inCompositionMode){this._copyDone=!1;return}if(s.keyCode in this.ctrlKeysMapUp&&(s.ctrlKey||s.metaKey))this[this.ctrlKeysMapUp[s.keyCode]](s);else return;s.stopImmediatePropagation(),s.preventDefault(),this.canvas&&this.canvas.requestRenderAll()},onInput:function(s){var p=this.fromPaste;if(this.fromPaste=!1,s&&s.stopPropagation(),!!this.isEditing){var C=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,b=this._text.length,l=C.length,c,h,m=l-b,g=this.selectionStart,d=this.selectionEnd,w=g!==d,E,O,L;if(this.hiddenTextarea.value===""){this.styles={},this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll());return}var U=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),$=g>U.selectionStart;w?(c=this._text.slice(g,d),m+=d-g):l<b&&($?c=this._text.slice(d+m,d):c=this._text.slice(g,g-m)),h=C.slice(U.selectionEnd-m,U.selectionEnd),c&&c.length&&(h.length&&(E=this.getSelectionStyles(g,g+1,!1),E=h.map(function(){return E[0]})),w?(O=g,L=d):$?(O=d-c.length,L=d):(O=d,L=d+c.length),this.removeStyleFromTo(O,L)),h.length&&(p&&h.join("")===S.copiedText&&!S.disableStyleCopyPaste&&(E=S.copiedTextStyle),this.insertNewStyleBlock(h,g,E)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(s){this.compositionStart=s.target.selectionStart,this.compositionEnd=s.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(S.copiedText=this.getSelectedText(),S.disableStyleCopyPaste?S.copiedTextStyle=null:S.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(s){return s&&s.clipboardData||S.window.clipboardData},_getWidthBeforeCursor:function(s,p){var C=this._getLineLeftOffset(s),b;return p>0&&(b=this.__charBounds[s][p-1],C+=b.left+b.width),C},getDownCursorOffset:function(s,p){var C=this._getSelectionForOffset(s,p),b=this.get2DCursorLocation(C),l=b.lineIndex;if(l===this._textLines.length-1||s.metaKey||s.keyCode===34)return this._text.length-C;var c=b.charIndex,h=this._getWidthBeforeCursor(l,c),m=this._getIndexOnLine(l+1,h),g=this._textLines[l].slice(c);return g.length+m+1+this.missingNewlineOffset(l)},_getSelectionForOffset:function(s,p){return s.shiftKey&&this.selectionStart!==this.selectionEnd&&p?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(s,p){var C=this._getSelectionForOffset(s,p),b=this.get2DCursorLocation(C),l=b.lineIndex;if(l===0||s.metaKey||s.keyCode===33)return-C;var c=b.charIndex,h=this._getWidthBeforeCursor(l,c),m=this._getIndexOnLine(l-1,h),g=this._textLines[l].slice(0,c),d=this.missingNewlineOffset(l-1);return-this._textLines[l-1].length+m-g.length+(1-d)},_getIndexOnLine:function(s,p){for(var C=this._textLines[s],b=this._getLineLeftOffset(s),l=b,c=0,h,m,g=0,d=C.length;g<d;g++)if(h=this.__charBounds[s][g].width,l+=h,l>p){m=!0;var w=l-h,E=l,O=Math.abs(w-p),L=Math.abs(E-p);c=L<O?g:g-1;break}return m||(c=C.length-1),c},moveCursorDown:function(s){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",s)},moveCursorUp:function(s){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",s)},_moveCursorUpOrDown:function(s,p){var C="get"+s+"CursorOffset",b=this[C](p,this._selectionDirection==="right");p.shiftKey?this.moveCursorWithShift(b):this.moveCursorWithoutShift(b),b!==0&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(s){var p=this._selectionDirection==="left"?this.selectionStart+s:this.selectionEnd+s;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,p),s!==0},moveCursorWithoutShift:function(s){return s<0?(this.selectionStart+=s,this.selectionEnd=this.selectionStart):(this.selectionEnd+=s,this.selectionStart=this.selectionEnd),s!==0},moveCursorLeft:function(s){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",s)},_move:function(s,p,C){var b;if(s.altKey)b=this["findWordBoundary"+C](this[p]);else if(s.metaKey||s.keyCode===35||s.keyCode===36)b=this["findLineBoundary"+C](this[p]);else return this[p]+=C==="Left"?-1:1,!0;if(typeof b<"u"&&this[p]!==b)return this[p]=b,!0},_moveLeft:function(s,p){return this._move(s,p,"Left")},_moveRight:function(s,p){return this._move(s,p,"Right")},moveCursorLeftWithoutShift:function(s){var p=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(p=this._moveLeft(s,"selectionStart")),this.selectionEnd=this.selectionStart,p},moveCursorLeftWithShift:function(s){if(this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd)return this._moveLeft(s,"selectionEnd");if(this.selectionStart!==0)return this._selectionDirection="left",this._moveLeft(s,"selectionStart")},moveCursorRight:function(s){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",s)},_moveCursorLeftOrRight:function(s,p){var C="moveCursor"+s+"With";this._currentCursorOpacity=1,p.shiftKey?C+="Shift":C+="outShift",this[C](p)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(s){if(this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd)return this._moveRight(s,"selectionStart");if(this.selectionEnd!==this._text.length)return this._selectionDirection="right",this._moveRight(s,"selectionEnd")},moveCursorRightWithoutShift:function(s){var p=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(p=this._moveRight(s,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,p},removeChars:function(s,p){typeof p>"u"&&(p=s+1),this.removeStyleFromTo(s,p),this._text.splice(s,p-s),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(s,p,C,b){typeof b>"u"&&(b=C),b>C&&this.removeStyleFromTo(C,b);var l=S.util.string.graphemeSplit(s);this.insertNewStyleBlock(l,C,p),this._text=[].concat(this._text.slice(0,C),l,this._text.slice(b)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var s=S.util.toFixed,p=/  +/g;S.util.object.extend(S.Text.prototype,{_toSVG:function(){var C=this._getSVGLeftTopOffsets(),b=this._getSVGTextAndBg(C.textTop,C.textLeft);return this._wrapSVGTextAndBg(b)},toSVG:function(C){return this._createBaseSVGMarkup(this._toSVG(),{reviver:C,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(C){var b=!0,l=this.getSvgTextDecoration(this);return[C.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",l?'text-decoration="'+l+'" ':"",'style="',this.getSvgStyles(b),'"',this.addPaintOrder()," >",C.textSpans.join(""),`</text>
`]},_getSVGTextAndBg:function(C,b){var l=[],c=[],h=C,m;this._setSVGBg(c);for(var g=0,d=this._textLines.length;g<d;g++)m=this._getLineLeftOffset(g),(this.textBackgroundColor||this.styleHas("textBackgroundColor",g))&&this._setSVGTextLineBg(c,g,b+m,h),this._setSVGTextLineText(l,g,b+m,h),h+=this.getHeightOfLine(g);return{textSpans:l,textBgRects:c}},_createTextCharSpan:function(C,b,l,c){var h=C!==C.trim()||C.match(p),m=this.getSvgSpanStyles(b,h),g=m?'style="'+m+'"':"",d=b.deltaY,w="",E=S.Object.NUM_FRACTION_DIGITS;return d&&(w=' dy="'+s(d,E)+'" '),['<tspan x="',s(l,E),'" y="',s(c,E),'" ',w,g,">",S.util.string.escapeXml(C),"</tspan>"].join("")},_setSVGTextLineText:function(C,b,l,c){var h=this.getHeightOfLine(b),m=this.textAlign.indexOf("justify")!==-1,g,d,w="",E,O,L=0,U=this._textLines[b],$;c+=h*(1-this._fontSizeFraction)/this.lineHeight;for(var nt=0,xt=U.length-1;nt<=xt;nt++)$=nt===xt||this.charSpacing,w+=U[nt],E=this.__charBounds[b][nt],L===0?(l+=E.kernedWidth-E.width,L+=E.width):L+=E.kernedWidth,m&&!$&&this._reSpaceAndTab.test(U[nt])&&($=!0),$||(g=g||this.getCompleteStyleDeclaration(b,nt),d=this.getCompleteStyleDeclaration(b,nt+1),$=S.util.hasStyleChanged(g,d,!0)),$&&(O=this._getStyleDeclaration(b,nt)||{},C.push(this._createTextCharSpan(w,O,l,c)),w="",g=d,l+=L,L=0)},_pushTextBgRect:function(C,b,l,c,h,m){var g=S.Object.NUM_FRACTION_DIGITS;C.push("		<rect ",this._getFillAttributes(b),' x="',s(l,g),'" y="',s(c,g),'" width="',s(h,g),'" height="',s(m,g),`"></rect>
`)},_setSVGTextLineBg:function(C,b,l,c){for(var h=this._textLines[b],m=this.getHeightOfLine(b)/this.lineHeight,g=0,d=0,w,E,O=this.getValueOfPropertyAt(b,0,"textBackgroundColor"),L=0,U=h.length;L<U;L++)w=this.__charBounds[b][L],E=this.getValueOfPropertyAt(b,L,"textBackgroundColor"),E!==O?(O&&this._pushTextBgRect(C,O,l+d,c,g,m),d=w.left,g=w.width,O=E):g+=w.kernedWidth;E&&this._pushTextBgRect(C,E,l+d,c,g,m)},_getFillAttributes:function(C){var b=C&&typeof C=="string"?new S.Color(C):"";return!b||!b.getSource()||b.getAlpha()===1?'fill="'+C+'"':'opacity="'+b.getAlpha()+'" fill="'+b.setAlpha(1).toRgb()+'"'},_getSVGLineTopOffset:function(C){for(var b=0,l=0,c=0;c<C;c++)b+=this.getHeightOfLine(c);return l=this.getHeightOfLine(c),{lineTop:b,offset:(this._fontSizeMult-this._fontSizeFraction)*l/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(C){var b=S.Object.prototype.getSvgStyles.call(this,C);return b+" white-space: pre;"}})}(),function(s){var p=s.fabric||(s.fabric={});p.Textbox=p.util.createClass(p.IText,p.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:p.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(C){for(var b=0,l=0,c=0,h={},m=0;m<C.graphemeLines.length;m++)C.graphemeText[c]===`
`&&m>0?(l=0,c++,b++):!this.splitByGrapheme&&this._reSpaceAndTab.test(C.graphemeText[c])&&m>0&&(l++,c++),h[m]={line:b,offset:l},c+=C.graphemeLines[m].length,l+=C.graphemeLines[m].length;return h},styleHas:function(C,b){if(this._styleMap&&!this.isWrapping){var l=this._styleMap[b];l&&(b=l.line)}return p.Text.prototype.styleHas.call(this,C,b)},isEmptyStyles:function(C){if(!this.styles)return!0;var b=0,l=C+1,c,h,m=!1,g=this._styleMap[C],d=this._styleMap[C+1];g&&(C=g.line,b=g.offset),d&&(l=d.line,m=l===C,c=d.offset),h=typeof C>"u"?this.styles:{line:this.styles[C]};for(var w in h)for(var E in h[w])if(E>=b&&(!m||E<c))for(var O in h[w][E])return!1;return!0},_getStyleDeclaration:function(C,b){if(this._styleMap&&!this.isWrapping){var l=this._styleMap[C];if(!l)return null;C=l.line,b=l.offset+b}return this.callSuper("_getStyleDeclaration",C,b)},_setStyleDeclaration:function(C,b,l){var c=this._styleMap[C];C=c.line,b=c.offset+b,this.styles[C][b]=l},_deleteStyleDeclaration:function(C,b){var l=this._styleMap[C];C=l.line,b=l.offset+b,delete this.styles[C][b]},_getLineStyle:function(C){var b=this._styleMap[C];return!!this.styles[b.line]},_setLineStyle:function(C){var b=this._styleMap[C];this.styles[b.line]={}},_wrapText:function(C,b){var l=[],c;for(this.isWrapping=!0,c=0;c<C.length;c++)l=l.concat(this._wrapLine(C[c],c,b));return this.isWrapping=!1,l},_measureWord:function(C,b,l){var c=0,h,m=!0;l=l||0;for(var g=0,d=C.length;g<d;g++){var w=this._getGraphemeBox(C[g],b,g+l,h,m);c+=w.kernedWidth,h=C[g]}return c},_wrapLine:function(C,b,l,Kt){var h=0,m=this.splitByGrapheme,g=[],d=[],w=m?p.util.string.graphemeSplit(C):C.split(this._wordJoiners),E="",O=0,L=m?"":" ",U=0,$=0,nt=0,xt=!0,Ft=this._getWidthOfCharSpacing(),Kt=Kt||0;w.length===0&&w.push([]),l-=Kt;for(var Jt=0;Jt<w.length;Jt++)E=m?w[Jt]:p.util.string.graphemeSplit(w[Jt]),U=this._measureWord(E,b,O),O+=E.length,h+=$+U-Ft,h>l&&!xt?(g.push(d),d=[],h=U,xt=!0):h+=Ft,!xt&&!m&&d.push(L),d=d.concat(E),$=m?0:this._measureWord([L],b,O),O++,xt=!1,U>nt&&(nt=U);return Jt&&g.push(d),nt+Kt>this.dynamicMinWidth&&(this.dynamicMinWidth=nt-Ft+Kt),g},isEndOfWrapping:function(C){return!this._styleMap[C+1]||this._styleMap[C+1].line!==this._styleMap[C].line},missingNewlineOffset:function(C){return this.splitByGrapheme?this.isEndOfWrapping(C)?1:0:1},_splitTextIntoLines:function(C){for(var b=p.Text.prototype._splitTextIntoLines.call(this,C),l=this._wrapText(b.lines,this.width),c=new Array(l.length),h=0;h<l.length;h++)c[h]=l[h].join("");return b.lines=c,b.graphemeLines=l,b},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var C={};for(var b in this._styleMap)this._textLines[b]&&(C[this._styleMap[b].line]=1);for(var b in this.styles)C[b]||delete this.styles[b]},toObject:function(C){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(C))}}),p.Textbox.fromObject=function(C,b){var l=p.util.stylesFromArray(C.styles,C.text),c=Object.assign({},C,{styles:l});return p.Object._fromObject("Textbox",c,b,"text")}}(Z),function(){var s=S.controlsUtils,p=s.scaleSkewCursorStyleHandler,C=s.scaleCursorStyleHandler,b=s.scalingEqually,l=s.scalingYOrSkewingX,c=s.scalingXOrSkewingY,h=s.scaleOrSkewActionName,m=S.Object.prototype.controls;if(m.ml=new S.Control({x:-.5,y:0,cursorStyleHandler:p,actionHandler:c,getActionName:h}),m.mr=new S.Control({x:.5,y:0,cursorStyleHandler:p,actionHandler:c,getActionName:h}),m.mb=new S.Control({x:0,y:.5,cursorStyleHandler:p,actionHandler:l,getActionName:h}),m.mt=new S.Control({x:0,y:-.5,cursorStyleHandler:p,actionHandler:l,getActionName:h}),m.tl=new S.Control({x:-.5,y:-.5,cursorStyleHandler:C,actionHandler:b}),m.tr=new S.Control({x:.5,y:-.5,cursorStyleHandler:C,actionHandler:b}),m.bl=new S.Control({x:-.5,y:.5,cursorStyleHandler:C,actionHandler:b}),m.br=new S.Control({x:.5,y:.5,cursorStyleHandler:C,actionHandler:b}),m.mtr=new S.Control({x:0,y:-.5,actionHandler:s.rotationWithSnapping,cursorStyleHandler:s.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),S.Textbox){var g=S.Textbox.prototype.controls={};g.mtr=m.mtr,g.tr=m.tr,g.br=m.br,g.tl=m.tl,g.bl=m.bl,g.mt=m.mt,g.mb=m.mb,g.mr=new S.Control({x:.5,y:0,actionHandler:s.changeWidth,cursorStyleHandler:p,actionName:"resizing"}),g.ml=new S.Control({x:-.5,y:0,actionHandler:s.changeWidth,cursorStyleHandler:p,actionName:"resizing"})}}()})(bi);function _f(){const Z=Math.round(16777215*Math.random()),S=Z>>16,st=Z>>8&255,ft=Z&255;return"rgb("+S+", "+st+", "+ft+")"}const ou=Z=>{if(!Z)return[0,0,0];const S=Z.match(/rgba?\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)?(?:, ?(\d(?:\.\d?))\))?/);return S?[parseInt(S[1]),parseInt(S[2]),parseInt(S[3])]:[0,0,0]},Zd=(Z,S)=>{const st=Z._offset.left,ft=Z._offset.top,lt=S.e.pageX-st,It=S.e.pageY-ft;return{x:lt,y:It}},Ym=Z=>Math.abs(Math.min.apply(Math,Z.map(function(S){return S.y}))),Zm=Z=>Math.abs(Math.min.apply(Math,Z.map(function(S){return S.x}))),yf=Z=>{let S=new bi.fabric.Point(Z.strokeUniform?1/Z.scaleX:1,Z.strokeUniform?1/Z.scaleY:1).multiply(Z.strokeWidth);return new bi.fabric.Point(Z.width+S.x,Z.height+S.y)};class Km{generateNumber(S){return S*Math.random()|0}generateX(){return this.generateNumber(16).toString(16)}generateXes(S){let st="";for(let ft=0;ft<S;++ft)st+=this.generateX();return st}generateVariant(){return(this.generateNumber(16)&3|8).toString(16)}generate(){return this.generateXes(8)+"-"+this.generateXes(4)+"-4"+this.generateXes(3)+"-"+this.generateVariant()+this.generateXes(3)+"-"+this.generateXes(12)}}const Kd=(Z,S,st)=>{const ft=Z.x,lt=Z.y,It=S.x,N=S.y,s=st/Math.hypot(It-ft,N-lt),p=It+(It-ft)*s,C=N+(N-lt)*s;return new bi.fabric.Point(p,C)},rh=(Z,S,st,ft,lt)=>{Z.x<S&&(Z.x=S),Z.y<st&&(Z.y=st),Z.x>ft&&(Z.x=ft),Z.y>lt&&(Z.y=lt)},Jd=(Z,S,st)=>new bi.fabric.Point(Math.floor(Z.x/S),Math.floor(Z.y/st));var qn=(Z=>(Z.LeftRightTopBottom="lrtb",Z.RightLeftBottomTop="rlbt",Z))(qn||{});const Jm=new Map([["lrtb",""],["rlbt",""]]),Qm=new Map([["lrtb","Left->Right or Top->Bottom"],["rlbt","Right->Left or Bottom->Top"]]),tg=new Map([["","lrtb"],["","rlbt"]]);(Z=>{function S(lt){return Jm.get(lt)??"err"}Z.toString=S;function st(lt){return Qm.get(lt)??"err"}Z.toHumanString=st;function ft(lt){return tg.get(lt)}Z.parse=ft})(qn||(qn={}));var ho=(Z=>(Z.LINE_CONTROL="lineControl",Z.CHANGE_DIRECTION_CONTROL="changeDirectionControl",Z.DELETE_VIRTUAL_LINE_CONTROL="deleteVirtualLineControl",Z))(ho||{});const eg="TYPE_VIRTUAL_LINE_GROUP";class Qd extends bi.fabric.Line{constructor(S,st){super(S,st)}calcCurrentPoints(){var s,p;const S=this.calcLinePoints(),st=this.calcTransformMatrix(),ft=((s=this.canvas)==null?void 0:s.getWidth())??10,lt=((p=this.canvas)==null?void 0:p.getHeight())??10,It=bi.fabric.util.transformPoint(new bi.fabric.Point(S.x1,S.y1),st);rh(It,0,0,ft,lt);const N=bi.fabric.util.transformPoint(new bi.fabric.Point(S.x2,S.y2),st);return rh(N,0,0,ft,lt),[It,N]}}class lo extends bi.fabric.Group{constructor(st,ft,lt){super(st,ft,lt);An(this,"segment_object_idx");An(this,"direction");An(this,"current_points");An(this,"color_rgb");An(this,"parentContour");this.segment_object_idx=0,this.direction=qn.LeftRightTopBottom,this.current_points=[[0,0],[0,0]],this.color_rgb=[0,0,0],this.type=eg}}function vf(Z,S,st){const ft=Z.canvas;if(!ft)return console.error("Empty target canvas for preparing virtual line"),!1;const lt=new bi.fabric.Point(st.geometry[0][0],st.geometry[0][1]),It=new bi.fabric.Point(st.geometry[1][0],st.geometry[1][1]),N=new bi.fabric.Shadow({color:"rgba(0, 0, 0, 1)",affectStroke:!0,blur:30}),s=S?new bi.fabric.Point(Math.floor(lt.x*ft.scaleWidth),Math.floor(lt.y*ft.scaleHeight)):new bi.fabric.Point(Math.floor(lt.x/ft.scaleWidth),Math.floor(lt.y/ft.scaleHeight)),p=S?new bi.fabric.Point(Math.floor(It.x*ft.scaleWidth),Math.floor(It.y*ft.scaleHeight)):new bi.fabric.Point(Math.floor(It.x/ft.scaleWidth),Math.floor(It.y/ft.scaleHeight)),C=S?s:lt,b=S?p:It,l=new Qd([C.x,C.y,b.x,b.y],{stroke:Z.stroke,strokeWidth:5,strokeDashArray:[5],strokeUniform:!0,objectCaching:!1,shadow:N}),c={fontWeight:"bold",fontSize:42},h=new bi.fabric.Point((C.x+b.x)/2,(C.y+b.y)/2),m=new bi.fabric.IText(qn.toString(st.direction),{left:h.x-20,top:h.y,fontSize:18,fontFamily:"Roboto",fill:Z.stroke,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9,objectCaching:!1,styles:{0:{0:c,1:c}}}),g=new bi.fabric.Text("L1",{left:C.x-5,top:C.y+10,fontSize:18,fontFamily:"Roboto",fill:Z.stroke,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9,objectCaching:!1}),d=new bi.fabric.Text("L2",{left:b.x-5,top:b.y+10,fontSize:18,fontFamily:"Roboto",fill:Z.stroke,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9,objectCaching:!1}),w=new lo([l,m,g,d],{strokeUniform:!0,objectCaching:!1});w.current_points=S?[[lt.x,lt.y],[It.x,It.y]]:[[s.x,s.y],[p.x,p.y]],w.color_rgb=ou(l.stroke),w.direction=st.direction,w.segment_object_idx=0,w.setControlsVisibility({bl:!1,br:!1,mb:!1,ml:!0,mr:!0,mt:!1,tl:!1,tr:!1,mtr:!0}),w.setControlVisible(ho.LINE_CONTROL,!1),w.setControlVisible(ho.CHANGE_DIRECTION_CONTROL,!0),w.setControlVisible(ho.DELETE_VIRTUAL_LINE_CONTROL,!0),w.on("scaling",function(E){const O=E.transform;if(!O){console.error("Empty transform event for group object on line group. Event: modified. Options:",E);return}const L=O.target;if(!L){console.error("Empty target group object on line group. Event: scaling. Options:",E);return}if(!(L instanceof lo)){console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: scaling. Options:",E);return}const U=1/(L.scaleX??1),$=1/(L.scaleY??1);L.getObjects("text").forEach(Ft=>{Ft.set("scaleX",U),Ft.set("scaleY",$)}),L.getObjects("i-text").forEach(Ft=>{Ft.set("scaleX",U),Ft.set("scaleY",$)})}),w.on("rotating",function(E){const O=E.transform;if(!O){console.error("Empty transform event for group object on line group. Event: modified. Options:",E);return}const L=O.target;if(!L){console.error("Empty target group object on line group. Event: scaling. Options:",E);return}if(!(L instanceof lo)){console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: scaling. Options:",E);return}const U=360-(L.angle??0);L.getObjects("text").forEach(xt=>{xt.rotate(U)}),L.getObjects("i-text").forEach(xt=>{xt.rotate(U)})}),w.on("modified",E=>{const O=E.target;if(!O){console.error("Empty target group object on line group. Event: modified. Options:",E);return}if(!(O instanceof lo)){console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: modified. Options:",E);return}const L=O.canvas;if(!L){console.error("Empty target canvas on line group. Event: modified. Options:",E);return}const U=O.getObjects()[O.segment_object_idx];if(!(U instanceof Qd)){console.error("Unhandled type. Only CustomLime on top of fabric.Object has been implemented. Event: modified. Options:",E);return}const $=U.calcCurrentPoints(),nt=Jd($[0],L.scaleWidth,L.scaleHeight),xt=Jd($[1],L.scaleWidth,L.scaleHeight);O.current_points[0][0]=nt.x,O.current_points[0][1]=nt.y,O.current_points[1][0]=xt.x,O.current_points[1][1]=xt.y,Z.fire("virtial_line:modified",{target:Z})}),w.on("mouseover",function(E){const O=E.target;if(!O){console.error("Empty target group object on line group. Event: mouseover. Options:",E);return}const L=O.canvas;if(!L){console.error("Empty target canvas on line group. Event: mouseover. Options:",E);return}if(!(O instanceof lo))return;O.getObjects().forEach($=>{var ne,me;const nt=(ne=$.shadow)==null?void 0:ne.valueOf();if(!(nt&&nt instanceof bi.fabric.Shadow))return;const Ft=nt;Ft.color="rgba(255, 255, 255, 1)",Ft.blur=30;const Jt=(me=Z.shadow)==null?void 0:me.valueOf();if(!(Jt&&Jt instanceof bi.fabric.Shadow))return;const he=Jt;he.color="rgba(255, 255, 255, 1)",he.blur=30}),L.renderAll()}),w.on("mouseout",function(E){const O=E.target;if(!O){console.error("Empty target object on line group. Event: mouseout. Options:",E);return}const L=O.canvas;if(!L){console.error("Empty target canvas on line group. Event: mouseout. Options:",E);return}if(!(O instanceof lo))return;O.getObjects().forEach($=>{var ne,me;const nt=(ne=$.shadow)==null?void 0:ne.valueOf();if(!(nt&&nt instanceof bi.fabric.Shadow))return;const Ft=nt;Ft.color="rgba(0, 0, 0, 1)",Ft.blur=30;const Kt=Z,Jt=(me=Kt.shadow)==null?void 0:me.valueOf();if(!(Jt&&Jt instanceof bi.fabric.Shadow))return;const he=Jt;he.color=Kt.stroke,he.blur=0}),L.renderAll()}),w.on("removed",function(E){w.parentContour&&w.parentContour.fire("virtial_line:removed",{target:Z})}),Z.virtual_line=w,Z.fire("virtial_line:created",{target:Z}),w.parentContour=Z,ft.add(w)}class ig extends bi.fabric.Canvas{constructor(st,ft){super(st,ft);An(this,"scaleWidth");An(this,"scaleHeight");An(this,"contourTemporary");An(this,"contourNotationTemporary");An(this,"contourFinalized");this.scaleWidth=1,this.scaleHeight=1,this.contourTemporary=new Array,this.contourNotationTemporary=new Array,this.contourFinalized=new Array}editContour(st){var ft,lt;if(this.setActiveObject(st),st.edit=!st.edit,st.edit){let It=((ft=st==null?void 0:st.points)==null?void 0:ft.length)-1;st.cornerStyle="circle",st.cornerSize=15,st.cornerColor="rgba(0, 0, 255, 1.0)",st.controls=(lt=st==null?void 0:st.points)==null?void 0:lt.reduce(function(N,s,p){return N["p"+p]=new bi.fabric.Control({positionHandler:ng,actionHandler:rg(p>0?p-1:It,sg),actionName:"modifyPolygon",pointIndex:p}),N},{})}else st.cornerColor="rgb(178, 204, 255)",st.cornerStyle="rect",st.controls=bi.fabric.Object.prototype.controls;st.hasBorders=!st.edit,this.requestRenderAll()}}const rg=function(Z,S){return function(st,ft,lt,It){let N=ft.target;const s=new bi.fabric.Point(N.points[Z].x-N.pathOffset.x,N.points[Z].y-N.pathOffset.y);let p=bi.fabric.util.transformPoint(s,N.calcTransformMatrix()),C=S(st,ft,lt,It);N._setPositionDimensions({});let b=yf(N),l=(N.points[Z].x-N.pathOffset.x)/b.x,c=(N.points[Z].y-N.pathOffset.y)/b.y;return N.setPositionByOrigin(p,l+.5,c+.5),C}},ng=function(Z,S,st){let ft=st.points[this.pointIndex].x-st.pathOffset.x,lt=st.points[this.pointIndex].y-st.pathOffset.y;const It=new bi.fabric.Point(ft,lt);return bi.fabric.util.transformPoint(It,bi.fabric.util.multiplyTransformMatrices(st.canvas.viewportTransform,st.calcTransformMatrix()))},sg=function(Z,S,st,ft){let lt=S.target,It=lt.controls[lt.__corner],N=lt.toLocalPoint(new bi.fabric.Point(st,ft),"center","center"),s=yf(lt),p=lt._getTransformedDimensions(0,0),C={x:N.x*s.x/p.x+lt.pathOffset.x,y:N.y*s.y/p.y+lt.pathOffset.y};return lt.points[It.pointIndex]=C,!0};class _a extends bi.fabric.Polygon{constructor(st,ft){super(st,ft);An(this,"inner");An(this,"unid");An(this,"notation");An(this,"current_points");An(this,"virtual_line");this.unid="",this.notation=[],this.inner=this,this.current_points=[],this.virtual_line=void 0}}const xf=["A","B","C","D"],og=(Z,S=_f())=>{let st=Zm(Z),ft=Ym(Z);const lt=new bi.fabric.Shadow({color:S,affectStroke:!0,blur:0});let It=new _a(Z,{fill:"rgba(0,0,0,0)",stroke:S,strokeWidth:3,objectCaching:!1,shadow:lt});It.set({left:st,top:ft});const N=new Array;return Z.forEach((s,p)=>{const C=new bi.fabric.Text(xf[p],{left:s.x,top:s.y,fontSize:24,fontFamily:"Roboto",fill:S,shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9,selectable:!1});N.push(C)}),It.current_points=It.points,It.unid="00000000-0000-0000-0000-000000000000",It.notation=N,It};function bf(Z,S,st,ft,lt="",It=_f(),N=!0){const s=og(Z,It);return s.setControlVisible(ho.LINE_CONTROL,!0),s.setControlVisible(ho.CHANGE_DIRECTION_CONTROL,!1),s.setControlVisible(ho.DELETE_VIRTUAL_LINE_CONTROL,!1),s.inner.on("mousedown",ag(S,st,ft)),s.inner.on("modified",lg(st,ft)),N&&(s.inner.on("virtial_line:created",au(st,ft)),s.inner.on("virtial_line:modified",wf(st,ft)),s.inner.on("virtial_line:removed",Cf(st,ft))),s.inner.on("mouseover",function(p){var m;const C=p.target;if(!C){console.error("Empty target contour on mouseover. Options:",p);return}const b=C.canvas;if(!b){console.error("Empty target canvas on mouseover. Options:",p);return}C.set("fill","rgba(0, 0, 0, 0.1)");const l=(m=C.shadow)==null?void 0:m.valueOf();if(!(l&&l instanceof bi.fabric.Shadow))return;const h=l;h.blur=30,b.renderAll()}),s.inner.on("mouseout",function(p){var m;const C=p.target;if(!C){console.error("Empty target contour on mouseout. Options:",p);return}const b=C.canvas;if(!b){console.error("Empty target canvas on mouseout. Options:",p);return}C.set("fill","rgba(0, 0, 0, 0)");const l=(m=C.shadow)==null?void 0:m.valueOf();if(!(l&&l instanceof bi.fabric.Shadow))return;const h=l;h.blur=0,b.renderAll()}),lt!==""?s.unid=lt:s.unid=new Km().generate(),s.notation.forEach((p,C)=>{s.notation[C].text_id=s.unid}),s}function au(Z,S){return function(st){const ft=st.target;if(!ft){console.error("Empty target contour on virtual_line:created. Options:",st);return}if(!(ft instanceof _a)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: virtual_line:created. Options:",st);return}const lt=ft,It=lt.virtual_line;if(!It){console.error("Empty virtual line. Event: virtual_line:created. Options:",st);return}let N=Tl(Z).get(lt.unid);if(!N){console.error("No contour in datastorage. Event: virtual_line:created. Options:",st);return}N.properties.virtual_line={geometry:It.current_points,color_rgb:It.color_rgb,direction:It.direction},S(lt.unid,N)}}function wf(Z,S){return au(Z,S)}function Cf(Z,S){return function(st){const ft=st.target;if(!ft){console.error("Empty target contour on virtual_line:removed. Options:",st);return}if(!(ft instanceof _a)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: virtual_line:removed. Options:",st);return}ft.virtual_line=void 0;let lt=Tl(Z).get(ft.unid);if(!lt){console.warn("No contour in datastorage. Event: virtual_line:removed. Options:",st);return}lt.properties.virtual_line=void 0,S(ft.unid,lt)}}function ag(Z,S,st){return function(ft){const lt=ft.target;if(!lt){console.error("Empty target contour on mouse:down. Options:",ft);return}if(!(lt instanceof _a)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: mouse:down. Options:",ft);return}const It=lt,N=lt.canvas;if(!N){console.error("Empty target canvas on mouse:down. Options:",ft);return}if(ft.e.preventDefault(),ft.e.stopPropagation(),ft.button===3){if(Tl(Z)!=Gi.EditingZone)Z.set(Gi.EditingZone);else{Z.set(Gi.Waiting);let p=Tl(S).get(It.unid);if(!p){console.error("No contour in datastorage. Event: mouse:down. Options:",ft);return}if(!It.current_points){console.error("No current points in target polygon. Event: mouse:down. Options:",ft);return}p.properties.coordinates=It.current_points.map(C=>[Math.floor(C.x/N.scaleWidth),Math.floor(C.y/N.scaleHeight)]),st(It.unid,p)}N.editContour(It)}}}function lg(Z,S){return function(st){const ft=st.target;if(!ft){console.error("Empty target contour on modified. Options:",st);return}if(!(ft instanceof _a)){console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: modified. Options:",st);return}const lt=ft,It=ft.canvas;if(!It){console.error("Empty target canvas on modified. Options:",st);return}const N=lt.inner.calcTransformMatrix();if(!lt.inner.points){console.error("No points in fabric.Polygon. Event: modified. Options:",st);return}const s=lt.inner.points.map(function(C){return new bi.fabric.Point(C.x-lt.inner.pathOffset.x,C.y-lt.inner.pathOffset.y)}).map(function(C){return bi.fabric.util.transformPoint(C,N)});lt.current_points=s,lt.notation.forEach((C,b)=>{var c;const l=(c=lt.current_points)==null?void 0:c[b];if(!l){console.error(`No vertex at pos #${b} in target polygon. Event: modified`,"Options:",st);return}C.set({left:l.x,top:l.y})});let p=Tl(Z).get(lt.unid);if(!p){console.error("No contour in datastorage. Event: modified. Options:",st);return}p.properties.coordinates=lt.current_points.map(C=>[Math.floor(C.x/It.scaleWidth),Math.floor(C.y/It.scaleHeight)]),S(lt.unid,p)}}const tf=(Z,S,st,ft)=>{Tl(st).forEach(lt=>{const It=lt.properties.coordinates.map(s=>({x:s[0]*Z.scaleWidth,y:s[1]*Z.scaleHeight})),N=bf(It,S,st,ft,lt.id,`rgb(${lt.properties.color_rgb[0]},${lt.properties.color_rgb[1]},${lt.properties.color_rgb[2]})`,!1);Z.add(N.inner),lt.properties.virtual_line&&vf(N,!0,lt.properties.virtual_line),N.inner.on("virtial_line:created",au(st,ft)),N.inner.on("virtial_line:modified",wf(st,ft)),N.inner.on("virtial_line:removed",Cf(st,ft)),N.notation.forEach(s=>{Z.add(s)}),Z.renderAll()})},Sl=32,cg="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1.2rem' height='1.2rem' viewBox='0 0 24 24'%3E %3Crect width='100%25' height='100%25' stroke='rgba(0, 0, 0, 1)' stroke-width='2px' fill='rgba(255, 255, 255, 0.3)' %2F%3E %3Cpath fill='red' stroke='%234b4b4b' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 18a2 2 0 1 0 4 0a2 2 0 1 0-4 0M16 6a2 2 0 1 0 4 0a2 2 0 1 0-4 0M7.5 16.5l9-9'/%3E%3C/svg%3E",Sf=document.createElement("img");Sf.src=cg;const hg=(Z,S,st,ft)=>{var d;const lt=S.target;if(!lt)return console.error("Empty target contour on control click. Transform data:",S),!1;if(!(lt instanceof _a))return console.error("Unhandled type. Only CustomPolygon on top of fabric.Object has been implemented. Event: control click. Transform data:",S),!1;if(lt.virtual_line)return console.warn("Target contour already has virtual line. Ignoring. Transform data:",S),!1;const It=lt.canvas;if(!It)return console.error("Empty target canvas on control click. transform Data:",S),!1;const N=(d=lt.current_points)==null?void 0:d.slice();if(!N)return console.error("Empty target canvas points on control click. transform Data:",S),!1;if(N.length!==4)return console.error("Target canvas points should have 4 points exactly on control click. transform Data:",S),!1;const s=N[0],p=N[1],C=N[2],b=N[3],l=30,c=It.getWidth()-10,h=It.getHeight()-10,m=Kd(b,s,l);rh(m,0,0,c,h);const g=Kd(C,p,l);return rh(g,0,0,c,h),vf(lt,!1,{geometry:[[m.x,m.y],[g.x,g.y]],color_rgb:ou(lt.stroke),direction:qn.LeftRightTopBottom}),!0},ug=(Z,S,st,ft,lt)=>{lt instanceof _a&&(Z.save(),Z.translate(S,st),lt.angle&&Z.rotate(bi.fabric.util.degreesToRadians(lt.angle)),Z.drawImage(Sf,-Sl/2,-Sl/2,Sl,Sl),Z.restore())},dg=new bi.fabric.Control({x:.5,y:-.5,offsetY:-16,offsetX:16,cursorStyle:"pointer",mouseUpHandler:hg,render:ug,sizeX:Sl,sizeY:Sl}),ws=32,fg="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1.2rem' height='1.2rem' viewBox='0 0 24 24'%3E%3Crect width='100%25' height='100%25' stroke='rgba(0, 0, 0, 1)' stroke-width='2px' fill='rgba(255, 255, 255, 0.3)'/%3E%3Cpath fill='none' stroke='%23ff0000' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.75' d='M17 20V8m0 12l-3.5-3.5M17 20l3.5-3.5M7 17V4m0 0L3.5 7.5M7 4l3.5 3.5'/%3E%3C/svg%3E",Tf=document.createElement("img");Tf.src=fg;const pg=(Z,S,st,ft)=>{var N;const lt=S.target;if(!lt)return console.error("Empty target. Event: change_direction_control. Transform data:",S),!1;if(!(lt instanceof lo))return console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: change_direction_control. Transform data:",S),!1;if(!lt.parentContour)return console.error("Empty parent contour. Event: change_direction_control. Transform data:",S),!1;lt.direction=lt.direction===qn.LeftRightTopBottom?qn.RightLeftBottomTop:qn.LeftRightTopBottom;const It=lt.getObjects()[1];return It instanceof bi.fabric.IText?(It.set("text",qn.toString(lt.direction)),lt.parentContour.fire("virtial_line:modified",{target:lt.parentContour}),(N=lt.canvas)==null||N.renderAll(),!0):(console.error("Unhandled object. Should be fabric.IText at position #1 Event: change_direction_control. Transform data:",S),!1)},mg=(Z,S,st,ft,lt)=>{lt instanceof lo&&(Z.save(),Z.translate(S,st),lt.angle&&Z.rotate(bi.fabric.util.degreesToRadians(lt.angle)),Z.drawImage(Tf,-ws/2,-ws/2,ws,ws),Z.restore())},gg=new bi.fabric.Control({x:.5,y:-.5,offsetY:-16,offsetX:-16,cursorStyle:"pointer",mouseUpHandler:pg,render:mg,sizeX:ws,sizeY:ws}),_g="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1.2rem' height='1.2rem' viewBox='0 0 24 24'%3E%3Crect width='100%25' height='100%25' stroke='rgba(0, 0, 0, 1)' stroke-width='2px' fill='rgba(255, 255, 255, 0.3)'/%3E%3Cpath fill='%23ff0000' d='M12 2a10 10 0 0 1 10 10a10 10 0 0 1-10 10A10 10 0 0 1 2 12A10 10 0 0 1 12 2m0 2a8 8 0 0 0-8 8a8 8 0 0 0 8 8a8 8 0 0 0 8-8a8 8 0 0 0-8-8m4 6v7a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-7zm-2.5-4l1 1H17v2H7V7h2.5l1-1z'/%3E%3C/svg%3E",Ef=document.createElement("img");Ef.src=_g;const yg=(Z,S,st,ft)=>{var It;const lt=S.target;return lt?lt instanceof lo?lt.parentContour?((It=lt.canvas)==null||It.remove(lt),!0):(console.error("Empty parent contour. Event: delete_virtual_line_control. Transform data:",S),!1):(console.error("Unhandled type. Only CustomLineGroup on top of fabric.Group has been implemented. Event: delete_virtual_line_control. Transform data:",S),!1):(console.error("Empty target. Event: delete_virtual_line_control. Transform data:",S),!1)},vg=(Z,S,st,ft,lt)=>{lt instanceof lo&&(Z.save(),Z.translate(S,st),lt.angle&&Z.rotate(bi.fabric.util.degreesToRadians(lt.angle)),Z.drawImage(Ef,-ws/2,-ws/2,ws,ws),Z.restore())},xg=new bi.fabric.Control({x:.5,y:-.5,offsetY:-16,offsetX:16,cursorStyle:"pointer",mouseUpHandler:yg,render:vg,sizeX:ws,sizeY:ws});function bg(Z){let S,st,ft,lt,It,N,s,p,C,b,l,c,h,m,g;return C=new Hm({props:{msgText:"Please wait until image is loaded"}}),{c(){S=Ae("div"),st=Ae("img"),lt=Ai(),It=Ae("canvas"),N=Ai(),s=Ae("div"),p=Ae("div"),Ga(C.$$.fragment),this.h()},l(d){S=Me(d,"DIV",{id:!0,class:!0});var w=ni(S);st=Me(w,"IMG",{id:!0,src:!0,width:!0,height:!0,class:!0}),lt=Mi(w),It=Me(w,"CANVAS",{id:!0,class:!0}),ni(It).forEach(Re),N=Mi(w),s=Me(w,"DIV",{id:!0,class:!0});var E=ni(s);p=Me(E,"DIV",{class:!0});var O=ni(p);Xa(C.$$.fragment,O),O.forEach(Re),E.forEach(Re),w.forEach(Re),this.h()},h(){fe(st,"id","fit_img"),Hd(st.src,ft=Z[1]+"/live_streaming")||fe(st,"src",ft),fe(st,"width","500"),fe(st,"height","500"),fe(st,"class","svelte-ao3ads"),fe(It,"id","fit_canvas"),fe(It,"class","svelte-ao3ads"),fe(p,"class",b=ao(Z[2]?"d-none":"loading d-block")+" svelte-ao3ads"),fe(s,"id","loading-message"),fe(s,"class",l=ao(Z[2]?"d-none":"d-block")+" svelte-ao3ads"),fe(S,"id","mjpeg"),fe(S,"class",c=ao("mjpeg-canvas "+Z[0])+" svelte-ao3ads")},m(d,w){dn(d,S,w),re(S,st),re(S,lt),re(S,It),re(S,N),re(S,s),re(s,p),Wa(C,p,null),h=!0,m||(g=ls(st,"load",Z[5]),m=!0)},p(d,[w]){(!h||w&2&&!Hd(st.src,ft=d[1]+"/live_streaming"))&&fe(st,"src",ft),(!h||w&4&&b!==(b=ao(d[2]?"d-none":"loading d-block")+" svelte-ao3ads"))&&fe(p,"class",b),(!h||w&4&&l!==(l=ao(d[2]?"d-none":"d-block")+" svelte-ao3ads"))&&fe(s,"class",l),(!h||w&1&&c!==(c=ao("mjpeg-canvas "+d[0])+" svelte-ao3ads"))&&fe(S,"class",c)},i(d){h||(Ha(C.$$.fragment,d),h=!0)},o(d){qa(C.$$.fragment,d),h=!1},d(d){d&&Re(S),$a(C),m=!1,g()}}}function wg(Z,S,st){let ft,lt,It,N,s;Nr(Z,iu,w=>st(8,ft=w)),Nr(Z,co,w=>st(9,lt=w)),Nr(Z,th,w=>st(10,It=w));let{klass:p=""}=S;const{apiURL:C}=eh;Nr(Z,C,w=>st(11,N=w));let b=`${N}`,l;Yr.subscribe(w=>l=w);let c=Bn(!1);Nr(Z,c,w=>st(2,s=w));const h=()=>{if(console.log("Image source reloaded"),It==null){console.log("Prepare canvas on first initialization");const w=d();th.set(w)}c.set(!0),Cl.set(!0)},m=su.subscribe(w=>{b!==w&&(console.log(`Need to change API URL for MJPEG: '${N}'`),st(1,b=w),c.set(!1))});mc(()=>{console.log("Mounted canvas component")}),Qh(()=>{Cl.set(!1),It==null||It.getObjects().forEach(w=>{It.remove(w)}),m(),th.set(void 0)});const g=(w,E)=>{w.getObjects().forEach(O=>{O instanceof _a&&O.unid===E&&(O.virtual_line&&w.remove(O.virtual_line),O.notation.forEach(L=>{w.remove(L)}),w.remove(O))}),jm(lt,ft,E),Rm(E)},d=()=>{const w=document.getElementById("fit_canvas"),E=document.getElementById("fit_img");w.width=E.clientWidth,w.height=E.clientHeight;const O=new ig("fit_canvas",{containerClass:"custom-container-canvas",fireRightClick:!0,fireMiddleClick:!0,stopContextMenu:!0});O.scaleWidth=E.clientWidth/E.naturalWidth,O.scaleHeight=E.clientHeight/E.naturalHeight,bi.fabric.Object.prototype.controls[ho.LINE_CONTROL]=dg,bi.fabric.Object.prototype.controls[ho.CHANGE_DIRECTION_CONTROL]=gg,bi.fabric.Object.prototype.controls[ho.DELETE_VIRTUAL_LINE_CONTROL]=xg;const L=document.getElementsByClassName("custom-container-canvas")[0];return L.id="fbcanvas",O.on("selection:created",U=>{l===Gi.DeletingZoneCanvas&&(g(O,U.selected[0].unid),Yr.set(Gi.Waiting))}),O.on("selection:updated",U=>{l===Gi.DeletingZoneCanvas&&(g(O,U.selected[0].unid),Yr.set(Gi.Waiting))}),O.on("mouse:move",U=>{if(O.contourTemporary[0]!==null&&O.contourTemporary[0]!==void 0&&l===Gi.AddingZoneCanvas){const $=Zd(O,U);O.contourTemporary[O.contourTemporary.length-1].set({x2:$.x,y2:$.y}),O.renderAll()}}),O.on("mouse:down",U=>{if(l!==Gi.AddingZoneCanvas)return;O.selection=!1;const $=Zd(O,U);O.contourFinalized.push({x:$.x,y:$.y});const nt=[$.x,$.y,$.x,$.y],xt=new bi.fabric.Line(nt,{strokeWidth:3,selectable:!1,stroke:"purple"}),Ft=new bi.fabric.Text(xf[O.contourFinalized.length-1],{left:$.x,top:$.y,fontSize:24,fontFamily:"Roboto",fill:"purple",shadow:"0 0 10px rgba(255, 255, 255, 0.7)",stroke:"rgb(0, 0, 0)",strokeWidth:.9});if(O.contourNotationTemporary.push(Ft),O.contourTemporary.push(xt),O.add(xt),O.add(Ft),O.on("mouse:up",function(Qt){O.selection=!0}),O.contourFinalized.length<=3)return;O.contourTemporary.forEach(Qt=>{O.remove(Qt)}),O.contourNotationTemporary.forEach(Qt=>{O.remove(Qt)});const Kt=bf(O.contourFinalized,Yr,co,Ya),Jt={type:"Feature",id:Kt.unid,properties:{color_rgb:ou(Kt.inner.stroke),color_rgb_str:Kt.inner.stroke?Kt.inner.stroke:"rgb(0, 0, 0)",coordinates:Kt.inner.current_points.map(Qt=>[Math.floor(Qt.x/O.scaleWidth),Math.floor(Qt.y/O.scaleHeight)]),road_lane_direction:-1,road_lane_num:-1,spatial_object_id:void 0},geometry:{type:"Polygon",coordinates:[[[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1]]]}};Ya(Kt.unid,Jt),O.add(Kt.inner),Kt.notation.forEach(Qt=>{O.add(Qt)}),O.renderAll(),O.contourTemporary=[],O.contourNotationTemporary=[],O.contourFinalized=[],Yr.set(Gi.Waiting),ft.changeMode("simple_select")}),O};return Z.$$set=w=>{"klass"in w&&st(0,p=w.klass)},[p,b,s,C,c,h]}class Cg extends ma{constructor(S){super(),ga(this,S,wg,bg,pa,{klass:0})}}function Sg(Z){let S,st,ft,lt,It,N,s,p,C="Protocol schema type",b,l,c,h,m,g,d="Address or explicit IP",w,E,O,L,U,$,nt="Port",xt,Ft,Kt="Switch",Jt,Qt;return{c(){S=Ae("div"),st=Ae("form"),ft=Ae("div"),lt=Ae("div"),It=Ae("div"),N=Ae("input"),s=Ai(),p=Ae("label"),p.textContent=C,b=Ai(),l=Ae("div"),c=Ae("div"),h=Ae("input"),m=Ai(),g=Ae("label"),g.textContent=d,w=Ai(),E=Ae("div"),O=Ae("div"),L=Ae("input"),U=Ai(),$=Ae("label"),$.textContent=nt,xt=Ai(),Ft=Ae("button"),Ft.textContent=Kt,this.h()},l(he){S=Me(he,"DIV",{class:!0});var ne=ni(S);st=Me(ne,"FORM",{autocomplete:!0});var me=ni(st);ft=Me(me,"DIV",{class:!0});var Oe=ni(ft);lt=Me(Oe,"DIV",{class:!0});var se=ni(lt);It=Me(se,"DIV",{class:!0});var be=ni(It);N=Me(be,"INPUT",{id:!0,type:!0,class:!0}),s=Mi(be),p=Me(be,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),Sr(p)!=="svelte-4i6s19"&&(p.textContent=C),be.forEach(Re),se.forEach(Re),b=Mi(Oe),l=Me(Oe,"DIV",{class:!0});var Q=ni(l);c=Me(Q,"DIV",{class:!0});var wt=ni(c);h=Me(wt,"INPUT",{id:!0,type:!0,class:!0}),m=Mi(wt),g=Me(wt,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),Sr(g)!=="svelte-1tjbdse"&&(g.textContent=d),wt.forEach(Re),Q.forEach(Re),w=Mi(Oe),E=Me(Oe,"DIV",{class:!0});var gt=ni(E);O=Me(gt,"DIV",{class:!0});var vt=ni(O);L=Me(vt,"INPUT",{id:!0,type:!0,class:!0}),U=Mi(vt),$=Me(vt,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),Sr($)!=="svelte-1gcg7vj"&&($.textContent=nt),vt.forEach(Re),gt.forEach(Re),Oe.forEach(Re),me.forEach(Re),xt=Mi(ne),Ft=Me(ne,"BUTTON",{class:!0,type:!0,name:!0,"data-svelte-h":!0}),Sr(Ft)!=="svelte-14v6gij"&&(Ft.textContent=Kt),ne.forEach(Re),this.h()},h(){fe(N,"id","input_protocol"),fe(N,"type","text"),fe(N,"class","validate"),fe(p,"class","active"),fe(p,"for","input_protocol"),fe(It,"class","input-field"),fe(lt,"class","addr-part row svelte-142324r"),fe(h,"id","input_protocol"),fe(h,"type","text"),fe(h,"class","validate"),fe(g,"class","active"),fe(g,"for","input_protocol"),fe(c,"class","input-field"),fe(l,"class","addr-part row svelte-142324r"),fe(L,"id","input_protocol"),fe(L,"type","number"),fe(L,"class","validate"),fe($,"class","active"),fe($,"for","input_protocol"),fe(O,"class","input-field"),fe(E,"class","addr-part row svelte-142324r"),fe(ft,"class","addr-form svelte-142324r"),fe(st,"autocomplete","off"),fe(Ft,"class","btn waves-effect waves-light btn-small red"),fe(Ft,"type","submit"),fe(Ft,"name","action"),fe(S,"class","addr-container svelte-142324r")},m(he,ne){dn(he,S,ne),re(S,st),re(st,ft),re(ft,lt),re(lt,It),re(It,N),fa(N,Z[0]),re(It,s),re(It,p),re(ft,b),re(ft,l),re(l,c),re(c,h),fa(h,Z[1]),re(c,m),re(c,g),re(ft,w),re(ft,E),re(E,O),re(O,L),fa(L,Z[2]),re(O,U),re(O,$),re(S,xt),re(S,Ft),Jt||(Qt=[ls(N,"input",Z[8]),ls(h,"input",Z[9]),ls(L,"input",Z[10]),ls(Ft,"click",Z[7])],Jt=!0)},p(he,[ne]){ne&1&&N.value!==he[0]&&fa(N,he[0]),ne&2&&h.value!==he[1]&&fa(h,he[1]),ne&4&&af(L.value)!==he[2]&&fa(L,he[2])},i:cs,o:cs,d(he){he&&Re(S),Jt=!1,tu(Qt)}}}function Tg(Z,S,st){let ft,lt,It,N;const{schema:s,host:p,port:C}=eh;Nr(Z,s,d=>st(0,lt=d)),Nr(Z,p,d=>st(1,It=d)),Nr(Z,C,d=>st(2,N=d));const{apiURL:b}=eh;Nr(Z,b,d=>st(12,ft=d));let l=ft;const c=()=>{l!==ft&&(su.set(ft),l=ft)};mc(()=>{console.log(`Mount IP form. Initial address: '${ft}'`)});function h(){lt=this.value,s.set(lt)}function m(){It=this.value,p.set(It)}function g(){N=af(this.value),C.set(N)}return[lt,It,N,s,p,C,b,c,h,m,g]}class Eg extends ma{constructor(S){super(),ga(this,S,Tg,Sg,pa,{})}}function Pg(Z){let S,st,ft,lt,It,N,s,p,C="URI for Maptiler styles JSON",b,l,c="Switch",h,m;return{c(){S=Ae("div"),st=Ae("form"),ft=Ae("div"),lt=Ae("div"),It=Ae("div"),N=Ae("input"),s=Ai(),p=Ae("label"),p.textContent=C,b=Ai(),l=Ae("button"),l.textContent=c,this.h()},l(g){S=Me(g,"DIV",{class:!0});var d=ni(S);st=Me(d,"FORM",{autocomplete:!0});var w=ni(st);ft=Me(w,"DIV",{class:!0});var E=ni(ft);lt=Me(E,"DIV",{class:!0});var O=ni(lt);It=Me(O,"DIV",{class:!0});var L=ni(It);N=Me(L,"INPUT",{id:!0,type:!0,class:!0}),s=Mi(L),p=Me(L,"LABEL",{class:!0,for:!0,"data-svelte-h":!0}),Sr(p)!=="svelte-1xx2eh2"&&(p.textContent=C),L.forEach(Re),O.forEach(Re),E.forEach(Re),w.forEach(Re),b=Mi(d),l=Me(d,"BUTTON",{class:!0,type:!0,name:!0,"data-svelte-h":!0}),Sr(l)!=="svelte-1zwpv7"&&(l.textContent=c),d.forEach(Re),this.h()},h(){fe(N,"id","input_protocol"),fe(N,"type","text"),fe(N,"class","validate"),fe(p,"class","active"),fe(p,"for","input_style_url"),fe(It,"class","input-field"),fe(lt,"class","styles-switch-part row svelte-4gm7qr"),fe(ft,"class","styles-switch-form svelte-4gm7qr"),fe(st,"autocomplete","off"),fe(l,"class","btn waves-effect waves-light btn-small red"),fe(l,"type","submit"),fe(l,"name","action"),fe(S,"class","styles-switch-container svelte-4gm7qr")},m(g,d){dn(g,S,d),re(S,st),re(st,ft),re(ft,lt),re(lt,It),re(It,N),fa(N,Z[0]),re(It,s),re(It,p),re(S,b),re(S,l),h||(m=[ls(N,"input",Z[3]),ls(l,"click",Z[2])],h=!0)},p(g,[d]){d&1&&N.value!==g[0]&&fa(N,g[0])},i:cs,o:cs,d(g){g&&Re(S),h=!1,tu(m)}}}function Ig(Z,S,st){let ft;const{uri:lt}=ih;Nr(Z,lt,p=>st(0,ft=p));let It=ft;const N=()=>{It!==ft&&(It=ft,ih.accepted_uri.update(()=>It))};mc(()=>{console.log(`Mount styles form. Initial styles URL: '${ft}'`)});function s(){ft=this.value,lt.set(ft)}return[ft,lt,N,s]}class Ag extends ma{constructor(S){super(),ga(this,S,Ig,Pg,pa,{})}}function Mg(Z){let S,st,ft,lt,It,N;return st=new Eg({}),lt=new Ag({}),{c(){S=Ae("div"),Ga(st.$$.fragment),ft=Ai(),Ga(lt.$$.fragment),this.h()},l(s){S=Me(s,"DIV",{class:!0});var p=ni(S);Xa(st.$$.fragment,p),ft=Mi(p),Xa(lt.$$.fragment,p),p.forEach(Re),this.h()},h(){fe(S,"class",It=ao("switcher-container "+Z[0])+" svelte-19pygco")},m(s,p){dn(s,S,p),Wa(st,S,null),re(S,ft),Wa(lt,S,null),N=!0},p(s,[p]){(!N||p&1&&It!==(It=ao("switcher-container "+s[0])+" svelte-19pygco"))&&fe(S,"class",It)},i(s){N||(Ha(st.$$.fragment,s),Ha(lt.$$.fragment,s),N=!0)},o(s){qa(st.$$.fragment,s),qa(lt.$$.fragment,s),N=!1},d(s){s&&Re(S),$a(st),$a(lt)}}}function kg(Z,S,st){let{klass:ft=""}=S;return Z.$$set=lt=>{"klass"in lt&&st(0,ft=lt.klass)},[ft]}class Og extends ma{constructor(S){super(),ga(this,S,kg,Mg,pa,{klass:0})}}function ef(Z,S,st){const ft=Z.slice();return ft[4]=S[st][0],ft[5]=S[st][1],ft}function rf(Z){let S,st=$d(Z[2]),ft=[];for(let lt=0;lt<st.length;lt+=1)ft[lt]=nf(ef(Z,st,lt));return{c(){for(let lt=0;lt<ft.length;lt+=1)ft[lt].c();S=qd()},l(lt){for(let It=0;It<ft.length;It+=1)ft[It].l(lt);S=qd()},m(lt,It){for(let N=0;N<ft.length;N+=1)ft[N]&&ft[N].m(lt,It);dn(lt,S,It)},p(lt,It){if(It&4){st=$d(lt[2]);let N;for(N=0;N<st.length;N+=1){const s=ef(lt,st,N);ft[N]?ft[N].p(s,It):(ft[N]=nf(s),ft[N].c(),ft[N].m(S.parentNode,S))}for(;N<ft.length;N+=1)ft[N].d(1);ft.length=st.length}},d(lt){lt&&Re(S),wm(ft,lt)}}}function Dg(Z){let S,st="None";return{c(){S=Ae("span"),S.textContent=st,this.h()},l(ft){S=Me(ft,"SPAN",{style:!0,"data-svelte-h":!0}),Sr(S)!=="svelte-6frfcq"&&(S.textContent=st),this.h()},h(){Ua(S,"font-weight","bold")},m(ft,lt){dn(ft,S,lt)},p:cs,d(ft){ft&&Re(S)}}}function Lg(Z){let S,st=qn.toHumanString(Z[5].properties.virtual_line.direction)+"",ft;return{c(){S=Ae("span"),ft=xn(st)},l(lt){S=Me(lt,"SPAN",{});var It=ni(S);ft=bn(It,st),It.forEach(Re)},m(lt,It){dn(lt,S,It),re(S,ft)},p(lt,It){It&4&&st!==(st=qn.toHumanString(lt[5].properties.virtual_line.direction)+"")&&Bs(ft,st)},d(lt){lt&&Re(S)}}}function zg(Z){let S,st='<td>Virtual line</td> <td><span style="font-weight: bold;">None</span></td>';return{c(){S=Ae("tr"),S.innerHTML=st},l(ft){S=Me(ft,"TR",{"data-svelte-h":!0}),Sr(S)!=="svelte-1un2uac"&&(S.innerHTML=st)},m(ft,lt){dn(ft,S,lt)},p:cs,d(ft){ft&&Re(S)}}}function Fg(Z){let S,st,ft="Virtual line direction",lt,It,N,s=qn.toHumanString(Z[5].properties.virtual_line.direction)+"",p,C,b,l,c="Virtual line coordinates",h,m,g=JSON.stringify(Z[5].properties.virtual_line.geometry)+"",d;return{c(){S=Ae("tr"),st=Ae("td"),st.textContent=ft,lt=Ai(),It=Ae("td"),N=Ae("span"),p=xn(s),C=Ai(),b=Ae("tr"),l=Ae("td"),l.textContent=c,h=Ai(),m=Ae("td"),d=xn(g)},l(w){S=Me(w,"TR",{});var E=ni(S);st=Me(E,"TD",{"data-svelte-h":!0}),Sr(st)!=="svelte-1p9a9lk"&&(st.textContent=ft),lt=Mi(E),It=Me(E,"TD",{});var O=ni(It);N=Me(O,"SPAN",{});var L=ni(N);p=bn(L,s),L.forEach(Re),O.forEach(Re),E.forEach(Re),C=Mi(w),b=Me(w,"TR",{});var U=ni(b);l=Me(U,"TD",{"data-svelte-h":!0}),Sr(l)!=="svelte-11bq1zi"&&(l.textContent=c),h=Mi(U),m=Me(U,"TD",{});var $=ni(m);d=bn($,g),$.forEach(Re),U.forEach(Re)},m(w,E){dn(w,S,E),re(S,st),re(S,lt),re(S,It),re(It,N),re(N,p),dn(w,C,E),dn(w,b,E),re(b,l),re(b,h),re(b,m),re(m,d)},p(w,E){E&4&&s!==(s=qn.toHumanString(w[5].properties.virtual_line.direction)+"")&&Bs(p,s),E&4&&g!==(g=JSON.stringify(w[5].properties.virtual_line.geometry)+"")&&Bs(d,g)},d(w){w&&(Re(S),Re(C),Re(b))}}}function nf(Z){let S,st,ft,lt,It,N,s,p,C,b,l,c=Z[5].id+"",h,m,g,d,w,E,O,L="Virtual line:",U,$,nt,xt,Ft,Kt="<tr><th>Attirubute</th> <th>Value</th></tr>",Jt,Qt,he,ne,me="Road lane direction",Oe,se,be=Z[5].properties.road_lane_direction+"",Q,wt,gt,vt,Vt="Road lane number",pt,rt,Mt=Z[5].properties.road_lane_num+"",jt,te,Wt,Xt,ye="Color",Te,qt,Lt,ae,at,Zt,pe="Canvas coordinates",ue,Fe,Ke=JSON.stringify(Z[5].properties.coordinates)+"",oe,ve,He,ci,wi="Spatial coordinates",vi,ce,Ti=JSON.stringify(Z[5].geometry.coordinates)+"",zi,nr,Yi;function Ee(Oi,Wi){return Oi[5].properties.virtual_line?Lg:Dg}let ui=Ee(Z),$e=ui(Z);function Zi(Oi,Wi){return Oi[5].properties.virtual_line?Fg:zg}let Tr=Zi(Z),ii=Tr(Z);return{c(){S=Ae("li"),st=Ae("div"),ft=Ae("div"),lt=Zc("svg"),It=Zc("g"),N=Zc("path"),s=Zc("path"),C=Ai(),b=Ae("span"),l=xn("Zone identifier: "),h=xn(c),m=Ai(),g=Ae("div"),d=Ai(),w=Ae("div"),E=Ae("div"),O=Ae("span"),O.textContent=L,U=Ai(),$e.c(),$=Ai(),nt=Ae("div"),xt=Ae("table"),Ft=Ae("thead"),Ft.innerHTML=Kt,Jt=Ai(),Qt=Ae("tbody"),he=Ae("tr"),ne=Ae("td"),ne.textContent=me,Oe=Ai(),se=Ae("td"),Q=xn(be),wt=Ai(),gt=Ae("tr"),vt=Ae("td"),vt.textContent=Vt,pt=Ai(),rt=Ae("td"),jt=xn(Mt),te=Ai(),Wt=Ae("tr"),Xt=Ae("td"),Xt.textContent=ye,Te=Ai(),qt=Ae("td"),Lt=Ae("div"),ae=Ai(),at=Ae("tr"),Zt=Ae("td"),Zt.textContent=pe,ue=Ai(),Fe=Ae("td"),oe=xn(Ke),ve=Ai(),He=Ae("tr"),ci=Ae("td"),ci.textContent=wi,vi=Ai(),ce=Ae("td"),zi=xn(Ti),nr=Ai(),ii.c(),Yi=Ai(),this.h()},l(Oi){S=Me(Oi,"LI",{class:!0});var Wi=ni(S);st=Me(Wi,"DIV",{class:!0});var Rr=ni(st);ft=Me(Rr,"DIV",{class:!0});var cr=ni(ft);lt=Kc(cr,"svg",{xmlns:!0,width:!0,height:!0,viewBox:!0});var _t=ni(lt);It=Kc(_t,"g",{fill:!0});var W=ni(It);N=Kc(W,"path",{d:!0,opacity:!0}),ni(N).forEach(Re),s=Kc(W,"path",{d:!0}),ni(s).forEach(Re),W.forEach(Re),_t.forEach(Re),C=Mi(cr),b=Me(cr,"SPAN",{style:!0});var H=ni(b);l=bn(H,"Zone identifier: "),h=bn(H,c),H.forEach(Re),cr.forEach(Re),m=Mi(Rr),g=Me(Rr,"DIV",{class:!0}),ni(g).forEach(Re),d=Mi(Rr),w=Me(Rr,"DIV",{class:!0});var et=ni(w);E=Me(et,"DIV",{});var ct=ni(E);O=Me(ct,"SPAN",{"data-svelte-h":!0}),Sr(O)!=="svelte-epbrqr"&&(O.textContent=L),U=Mi(ct),$e.l(ct),ct.forEach(Re),et.forEach(Re),Rr.forEach(Re),$=Mi(Wi),nt=Me(Wi,"DIV",{class:!0});var Et=ni(nt);xt=Me(Et,"TABLE",{class:!0});var Ot=ni(xt);Ft=Me(Ot,"THEAD",{"data-svelte-h":!0}),Sr(Ft)!=="svelte-12gwnin"&&(Ft.innerHTML=Kt),Jt=Mi(Ot),Qt=Me(Ot,"TBODY",{});var zt=ni(Qt);he=Me(zt,"TR",{});var St=ni(he);ne=Me(St,"TD",{"data-svelte-h":!0}),Sr(ne)!=="svelte-t6zzid"&&(ne.textContent=me),Oe=Mi(St),se=Me(St,"TD",{});var ee=ni(se);Q=bn(ee,be),ee.forEach(Re),St.forEach(Re),wt=Mi(zt),gt=Me(zt,"TR",{});var le=ni(gt);vt=Me(le,"TD",{"data-svelte-h":!0}),Sr(vt)!=="svelte-5n5jo3"&&(vt.textContent=Vt),pt=Mi(le),rt=Me(le,"TD",{});var Yt=ni(rt);jt=bn(Yt,Mt),Yt.forEach(Re),le.forEach(Re),te=Mi(zt),Wt=Me(zt,"TR",{});var Pe=ni(Wt);Xt=Me(Pe,"TD",{"data-svelte-h":!0}),Sr(Xt)!=="svelte-1ghfwjz"&&(Xt.textContent=ye),Te=Mi(Pe),qt=Me(Pe,"TD",{});var Qe=ni(qt);Lt=Me(Qe,"DIV",{style:!0}),ni(Lt).forEach(Re),Qe.forEach(Re),Pe.forEach(Re),ae=Mi(zt),at=Me(zt,"TR",{});var ei=ni(at);Zt=Me(ei,"TD",{"data-svelte-h":!0}),Sr(Zt)!=="svelte-n6p0xp"&&(Zt.textContent=pe),ue=Mi(ei),Fe=Me(ei,"TD",{});var _i=ni(Fe);oe=bn(_i,Ke),_i.forEach(Re),ei.forEach(Re),ve=Mi(zt),He=Me(zt,"TR",{});var Ei=ni(He);ci=Me(Ei,"TD",{"data-svelte-h":!0}),Sr(ci)!=="svelte-1ypus8v"&&(ci.textContent=wi),vi=Mi(Ei),ce=Me(Ei,"TD",{});var gi=ni(ce);zi=bn(gi,Ti),gi.forEach(Re),Ei.forEach(Re),nr=Mi(zt),ii.l(zt),zt.forEach(Re),Ot.forEach(Re),Et.forEach(Re),Yi=Mi(Wi),Wi.forEach(Re),this.h()},h(){fe(N,"d","M137 65a24 24 0 1 1 0-34a24 24 0 0 1 0 34M23 103a24 24 0 1 0 34 0a24 24 0 0 0-34 0m120 88a24 24 0 1 0 34 0a24 24 0 0 0-34 0m82-136a24 24 0 1 0 0 34a24 24 0 0 0 0-34"),fe(N,"opacity","0.2"),fe(s,"d","M230.64 49.36a32 32 0 0 0-45.26 0a32 32 0 0 0-5.16 6.76L152 48.42a32 32 0 0 0-54.63-23.06a32.06 32.06 0 0 0-5.76 37.41L57.67 93.32a32.05 32.05 0 0 0-40.31 4.05a32 32 0 0 0 42.89 47.41l70 51.36a32 32 0 1 0 47.57-14.69l27.39-77.59q1.38.12 2.76.12a32 32 0 0 0 22.63-54.62Zm-122-12.69a16 16 0 1 1 0 22.64a16 16 0 0 1 .04-22.64Zm-80 94.65a16 16 0 0 1 0-22.64a16 16 0 1 1 0 22.64m142.65 88a16 16 0 0 1-22.63-22.63a16 16 0 1 1 22.63 22.63m-8.55-43.18a32 32 0 0 0-23 7.08l-70-51.36a32.17 32.17 0 0 0-1.34-26.65l33.95-30.55a32 32 0 0 0 45.47-10.81L176 71.56a32 32 0 0 0 14.12 27ZM219.3 83.3a16 16 0 1 1-22.6-22.62a16 16 0 0 1 22.63 22.63Z"),fe(It,"fill",p=Z[5].properties.color_rgb_str),fe(lt,"xmlns","http://www.w3.org/2000/svg"),fe(lt,"width","1.6rem"),fe(lt,"height","1.6rem"),fe(lt,"viewBox","0 0 256 256"),Ua(b,"padding-left","0.5rem"),fe(ft,"class","collapbisle-header-zone svelte-iuhs3p"),fe(g,"class","collapbisle-header-divider svelte-iuhs3p"),fe(w,"class","collapbisle-header-zone svelte-iuhs3p"),fe(st,"class","collapsible-header collapsible-header-content svelte-iuhs3p"),Ua(Lt,"background-color",Z[5].properties.color_rgb_str),Ua(Lt,"width","32px"),Ua(Lt,"height","16px"),Ua(Lt,"border","1px solid #000000"),fe(xt,"class","collapsible-table svelte-iuhs3p"),fe(nt,"class","collapsible-body svelte-iuhs3p"),fe(S,"class","svelte-iuhs3p")},m(Oi,Wi){dn(Oi,S,Wi),re(S,st),re(st,ft),re(ft,lt),re(lt,It),re(It,N),re(It,s),re(ft,C),re(ft,b),re(b,l),re(b,h),re(st,m),re(st,g),re(st,d),re(st,w),re(w,E),re(E,O),re(E,U),$e.m(E,null),re(S,$),re(S,nt),re(nt,xt),re(xt,Ft),re(xt,Jt),re(xt,Qt),re(Qt,he),re(he,ne),re(he,Oe),re(he,se),re(se,Q),re(Qt,wt),re(Qt,gt),re(gt,vt),re(gt,pt),re(gt,rt),re(rt,jt),re(Qt,te),re(Qt,Wt),re(Wt,Xt),re(Wt,Te),re(Wt,qt),re(qt,Lt),re(Qt,ae),re(Qt,at),re(at,Zt),re(at,ue),re(at,Fe),re(Fe,oe),re(Qt,ve),re(Qt,He),re(He,ci),re(He,vi),re(He,ce),re(ce,zi),re(Qt,nr),ii.m(Qt,null),re(S,Yi)},p(Oi,Wi){Wi&4&&p!==(p=Oi[5].properties.color_rgb_str)&&fe(It,"fill",p),Wi&4&&c!==(c=Oi[5].id+"")&&Bs(h,c),ui===(ui=Ee(Oi))&&$e?$e.p(Oi,Wi):($e.d(1),$e=ui(Oi),$e&&($e.c(),$e.m(E,null))),Wi&4&&be!==(be=Oi[5].properties.road_lane_direction+"")&&Bs(Q,be),Wi&4&&Mt!==(Mt=Oi[5].properties.road_lane_num+"")&&Bs(jt,Mt),Wi&4&&Ua(Lt,"background-color",Oi[5].properties.color_rgb_str),Wi&4&&Ke!==(Ke=JSON.stringify(Oi[5].properties.coordinates)+"")&&Bs(oe,Ke),Wi&4&&Ti!==(Ti=JSON.stringify(Oi[5].geometry.coordinates)+"")&&Bs(zi,Ti),Tr===(Tr=Zi(Oi))&&ii?ii.p(Oi,Wi):(ii.d(1),ii=Tr(Oi),ii&&(ii.c(),ii.m(Qt,null)))},d(Oi){Oi&&Re(S),$e.d(),ii.d()}}}function Rg(Z){let S,st,ft,lt,It=Z[3]===!0&&rf(Z);return{c(){S=Ae("div"),st=Ae("div"),ft=Ae("ul"),It&&It.c(),this.h()},l(N){S=Me(N,"DIV",{id:!0,class:!0});var s=ni(S);st=Me(s,"DIV",{id:!0});var p=ni(st);ft=Me(p,"UL",{id:!0,class:!0});var C=ni(ft);It&&It.l(C),C.forEach(Re),p.forEach(Re),s.forEach(Re),this.h()},h(){fe(ft,"id","collapsible-data"),fe(ft,"class","collapsible svelte-iuhs3p"),fe(st,"id","configuration-content"),fe(S,"id","configuration"),fe(S,"class",lt=ao(Z[0])+" svelte-iuhs3p")},m(N,s){dn(N,S,s),re(S,st),re(st,ft),It&&It.m(ft,null)},p(N,[s]){N[3]===!0?It?It.p(N,s):(It=rf(N),It.c(),It.m(ft,null)):It&&(It.d(1),It=null),s&1&&lt!==(lt=ao(N[0])+" svelte-iuhs3p")&&fe(S,"class",lt)},i:cs,o:cs,d(N){N&&Re(S),It&&It.d()}}}function Bg(Z,S,st){let ft,lt=cs,It=()=>(lt(),lt=bm(s,C=>st(3,ft=C)),s);Z.$$.on_destroy.push(()=>lt());let{klass:N=""}=S,{dataReady:s}=S;It();let{data:p}=S;return Z.$$set=C=>{"klass"in C&&st(0,N=C.klass),"dataReady"in C&&It(st(1,s=C.dataReady)),"data"in C&&st(2,p=C.data)},[N,s,p,ft]}class jg extends ma{constructor(S){super(),ga(this,S,Bg,Rg,pa,{klass:0,dataReady:1,data:2})}}const Ng=(Z,S)=>{const st={data:S.map(lt=>{const It=lt[1];return{lane_number:It.properties.road_lane_num,lane_direction:It.properties.road_lane_direction,color_rgb:It.properties.color_rgb,pixel_points:It.properties.coordinates,spatial_points:[...It.geometry.coordinates[0].slice(0,-1)],virtual_line:It.properties.virtual_line?{geometry:It.properties.virtual_line.geometry,color_rgb:It.properties.virtual_line.color_rgb,direction:It.properties.virtual_line.direction}:null}})};console.log("Replacing data");const ft=`${Z}/api/mutations/replace_all`;fetch(`${ft}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(st)}).then(lt=>lt.json()).then(lt=>{const It=`${Z}/api/mutations/save_toml`;console.log("Replacing configuration with polygons:",lt),fetch(`${It}`,{method:"GET"}).then(N=>N.json()).then(N=>{console.log("Configuration has been updated. Reply from server:",N)}).catch(N=>{console.log("Error on updating configuration:",N)})}).catch(lt=>{console.log("Error on replacing data",lt)})};function Vg(Z){let S,st,ft,lt,It,N,s,p='<i class="material-icons">edit</i>',C,b,l,c,h='<i class="material-icons">add</i>',m,g,d,w='<i class="material-icons">delete</i>',E,O,L,U='<i class="material-icons">add_location</i>',$,nt,xt,Ft='<i class="material-icons">location_off</i>',Kt,Jt,Qt,he='<i class="material-icons">save</i>',ne,me,Oe,se,be,Q,wt,gt,vt,Vt,pt,rt=(Z[2]!==void 0?Z[2]:Jc)+"",Mt,jt,te,Wt,Xt,ye,Te,qt,Lt,ae=(Z[2]!==void 0?Z[2]:Jc)+"",at,Zt,pe,ue,Fe,Ke;me=new Og({props:{klass:Z[5]||Z[4]?"blurred noselect":""}}),Q=new Cg({props:{klass:!Z[5]&&Z[4]?"blurred noselect":""}}),gt=new jg({props:{dataReady:wl,data:Z[3],klass:!Z[6]||Z[5]||Z[4]?"blurred noselect":""}});let oe={klass:!Z[6]||Z[5]&&!Z[4]?"blurred noselect":""};return ye=new Gm({props:oe}),Z[16](ye),{c(){S=Ae("sveltekit:head"),st=Ae("title"),ft=xn(sf),lt=Ai(),It=Ae("div"),N=Ae("div"),s=Ae("a"),s.innerHTML=p,C=Ai(),b=Ae("ul"),l=Ae("li"),c=Ae("a"),c.innerHTML=h,m=Ai(),g=Ae("li"),d=Ae("a"),d.innerHTML=w,E=Ai(),O=Ae("li"),L=Ae("a"),L.innerHTML=U,$=Ai(),nt=Ae("li"),xt=Ae("a"),xt.innerHTML=Ft,Kt=Ai(),Jt=Ae("li"),Qt=Ae("a"),Qt.innerHTML=he,ne=Ai(),Ga(me.$$.fragment),Oe=Ai(),se=Ae("div"),be=Ae("div"),Ga(Q.$$.fragment),wt=Ai(),Ga(gt.$$.fragment),vt=Ai(),Vt=Ae("div"),pt=xn("Press ESC to cancel '"),Mt=xn(rt),jt=xn("' mode"),Wt=Ai(),Xt=Ae("div"),Ga(ye.$$.fragment),Te=Ai(),qt=Ae("div"),Lt=xn("Press ESC to cancel '"),at=xn(ae),Zt=xn("' mode"),this.h()},l(ve){S=Me(ve,"SVELTEKIT:HEAD",{});var He=ni(S);st=Me(He,"TITLE",{});var ci=ni(st);ft=bn(ci,sf),ci.forEach(Re),He.forEach(Re),lt=Mi(ve),It=Me(ve,"DIV",{id:!0});var wi=ni(It);N=Me(wi,"DIV",{class:!0});var vi=ni(N);s=Me(vi,"A",{class:!0,"data-svelte-h":!0}),Sr(s)!=="svelte-1f8sujf"&&(s.innerHTML=p),C=Mi(vi),b=Me(vi,"UL",{});var ce=ni(b);l=Me(ce,"LI",{});var Ti=ni(l);c=Me(Ti,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),Sr(c)!=="svelte-1iozari"&&(c.innerHTML=h),Ti.forEach(Re),m=Mi(ce),g=Me(ce,"LI",{});var zi=ni(g);d=Me(zi,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),Sr(d)!=="svelte-1wbicqg"&&(d.innerHTML=w),zi.forEach(Re),E=Mi(ce),O=Me(ce,"LI",{});var nr=ni(O);L=Me(nr,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),Sr(L)!=="svelte-1t3kq67"&&(L.innerHTML=U),nr.forEach(Re),$=Mi(ce),nt=Me(ce,"LI",{});var Yi=ni(nt);xt=Me(Yi,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),Sr(xt)!=="svelte-1in2wxm"&&(xt.innerHTML=Ft),Yi.forEach(Re),Kt=Mi(ce),Jt=Me(ce,"LI",{});var Ee=ni(Jt);Qt=Me(Ee,"A",{id:!0,class:!0,title:!0,"aria-label":!0,role:!0,tabindex:!0,"data-svelte-h":!0}),Sr(Qt)!=="svelte-93o42s"&&(Qt.innerHTML=he),Ee.forEach(Re),ce.forEach(Re),vi.forEach(Re),ne=Mi(wi),Xa(me.$$.fragment,wi),Oe=Mi(wi),se=Me(wi,"DIV",{id:!0});var ui=ni(se);be=Me(ui,"DIV",{id:!0});var $e=ni(be);Xa(Q.$$.fragment,$e),wt=Mi($e),Xa(gt.$$.fragment,$e),vt=Mi($e),Vt=Me($e,"DIV",{class:!0,style:!0});var Zi=ni(Vt);pt=bn(Zi,"Press ESC to cancel '"),Mt=bn(Zi,rt),jt=bn(Zi,"' mode"),Zi.forEach(Re),$e.forEach(Re),Wt=Mi(ui),Xt=Me(ui,"DIV",{id:!0});var Tr=ni(Xt);Xa(ye.$$.fragment,Tr),Te=Mi(Tr),qt=Me(Tr,"DIV",{class:!0,style:!0});var ii=ni(qt);Lt=bn(ii,"Press ESC to cancel '"),at=bn(ii,ae),Zt=bn(ii,"' mode"),ii.forEach(Re),Tr.forEach(Re),ui.forEach(Re),wi.forEach(Re),this.h()},h(){fe(s,"class","btn-floating btn-large red"),fe(c,"id","add-btn"),fe(c,"class","btn-floating green"),fe(c,"title","Add zone to the canvas"),fe(c,"aria-label","Add zone to the canvas"),fe(c,"role","button"),fe(c,"tabindex","0"),fe(d,"id","del-btn"),fe(d,"class","btn-floating blue"),fe(d,"title","Delete zone from the canvas"),fe(d,"aria-label","Delete zone from the canvas"),fe(d,"role","button"),fe(d,"tabindex","0"),fe(L,"id","add-btn"),fe(L,"class","btn-floating orange"),fe(L,"title","Add zone to the map"),fe(L,"aria-label","Add zone to the map"),fe(L,"role","button"),fe(L,"tabindex","0"),fe(xt,"id","del-btn"),fe(xt,"class","btn-floating blue"),fe(xt,"title","Delete zone from the map"),fe(xt,"aria-label","Delete zone from the map"),fe(xt,"role","button"),fe(xt,"tabindex","0"),fe(Qt,"id","save-btn"),fe(Qt,"class","btn-floating grey"),fe(Qt,"title","Apply and save changes"),fe(Qt,"aria-label","Apply and save changes"),fe(Qt,"role","button"),fe(Qt,"tabindex","0"),fe(N,"class","fixed-action-btn horizontal click-to-toggle spin-close"),fe(Vt,"class","overlay"),fe(Vt,"style",te=!Z[5]&&Z[4]?"display: block;":"display: none;"),fe(be,"id","left_workspace"),fe(qt,"class","overlay"),fe(qt,"style",pe=Z[5]&&!Z[4]?"display: block;":"display: none;"),fe(Xt,"id","right_workspace"),fe(se,"id","main_workspace"),fe(It,"id","main-app")},m(ve,He){dn(ve,S,He),re(S,st),re(st,ft),dn(ve,lt,He),dn(ve,It,He),re(It,N),re(N,s),re(N,C),re(N,b),re(b,l),re(l,c),re(b,m),re(b,g),re(g,d),re(b,E),re(b,O),re(O,L),re(b,$),re(b,nt),re(nt,xt),re(b,Kt),re(b,Jt),re(Jt,Qt),re(It,ne),Wa(me,It,null),re(It,Oe),re(It,se),re(se,be),Wa(Q,be,null),re(be,wt),Wa(gt,be,null),re(be,vt),re(be,Vt),re(Vt,pt),re(Vt,Mt),re(Vt,jt),re(se,Wt),re(se,Xt),Wa(ye,Xt,null),re(Xt,Te),re(Xt,qt),re(qt,Lt),re(qt,at),re(qt,Zt),ue=!0,Fe||(Ke=[ls(window,"keydown",Z[8]),ls(c,"click",Z[9]),ls(d,"click",Z[11]),ls(L,"click",Z[10]),ls(xt,"click",Z[12]),ls(Qt,"click",Z[15])],Fe=!0)},p(ve,[He]){const ci={};He&48&&(ci.klass=ve[5]||ve[4]?"blurred noselect":""),me.$set(ci);const wi={};He&48&&(wi.klass=!ve[5]&&ve[4]?"blurred noselect":""),Q.$set(wi);const vi={};He&8&&(vi.data=ve[3]),He&112&&(vi.klass=!ve[6]||ve[5]||ve[4]?"blurred noselect":""),gt.$set(vi),(!ue||He&4)&&rt!==(rt=(ve[2]!==void 0?ve[2]:Jc)+"")&&Bs(Mt,rt),(!ue||He&48&&te!==(te=!ve[5]&&ve[4]?"display: block;":"display: none;"))&&fe(Vt,"style",te);const ce={};He&112&&(ce.klass=!ve[6]||ve[5]&&!ve[4]?"blurred noselect":""),ye.$set(ce),(!ue||He&4)&&ae!==(ae=(ve[2]!==void 0?ve[2]:Jc)+"")&&Bs(at,ae),(!ue||He&48&&pe!==(pe=ve[5]&&!ve[4]?"display: block;":"display: none;"))&&fe(qt,"style",pe)},i(ve){ue||(Ha(me.$$.fragment,ve),Ha(Q.$$.fragment,ve),Ha(gt.$$.fragment,ve),Ha(ye.$$.fragment,ve),ue=!0)},o(ve){qa(me.$$.fragment,ve),qa(Q.$$.fragment,ve),qa(gt.$$.fragment,ve),qa(ye.$$.fragment,ve),ue=!1},d(ve){ve&&(Re(S),Re(lt),Re(It)),$a(me),$a(Q),$a(gt),Z[16](null),$a(ye),Fe=!1,tu(Ke)}}}const sf="Rust Road Traffic UI",Jc="Unexpected action";function Ug(Z,S,st){let ft,lt,It,N,s,p,C,b,l,c,h,m;Nr(Z,iu,se=>st(21,s=se)),Nr(Z,th,se=>st(22,p=se)),Nr(Z,co,se=>st(13,C=se)),Nr(Z,Jh,se=>st(23,b=se)),Nr(Z,Cl,se=>st(6,c=se)),Nr(Z,wl,se=>st(25,h=se)),Nr(Z,Yr,se=>st(14,m=se));const{apiURL:g}=eh;Nr(Z,g,se=>st(24,l=se));let d=l,w;Yr.subscribe(se=>w=se);let E,O,L;const U=new Map([[Gi.AddingZoneCanvas,"Adding zone to the canvas"],[Gi.DeletingZoneCanvas,"Deleting zone from the canvas"],[Gi.AddingZoneMap,"Adding zone to the map"],[Gi.DeletingZoneMap,"Deleting zone from the map"]]),$=se=>{O=Cl.subscribe(Q=>{Q===!0&&h==!0&&(console.log(`MJPEG is loaded after geo data: ${se}`),tf(p,Yr,co,Ya))}),L=wl.subscribe(Q=>{Q===!0&&c==!0&&(console.log(`MJPEG is loaded before geo data: '${se}'`),tf(p,Yr,co,Ya))});const be=`${d}/api/polygons/geojson`;fetch(`${be}`).then(Q=>Q.json()).then(Q=>{Q.features.forEach(wt=>{Fm(wt)}),se===Qc.ReInit?E.drawGeoPolygons(s,C):b.on("load",()=>{E.drawGeoPolygons(s,C)}),wl.set(!0)}).catch(Q=>{console.log(`Error on loading polygons ['${se}']`,Q)})},nt=su.subscribe(se=>{d!==se&&(console.log(`Need to change API URL for Data: '${l}'`),st(0,d=se),Cl.set(!1),wl.set(!1),O(),L(),Bm(),p!==void 0&&p!=null&&p.getObjects().forEach(be=>{p.remove(be)}),s.deleteAll(),$(Qc.ReInit))});mc(()=>{console.log("Mounted page"),Ft(),$(Qc.Init),ff.onClick=(se,be)=>{var Q;if(be.featureTarget&&w===Gi.DeletingZoneMap){const gt=be.featureTarget.properties.id;Yr.set(Gi.Waiting);let vt=(Q=[...C].find(Vt=>Vt[1].properties.spatial_object_id===gt))==null?void 0:Q[1];if(!vt){console.warn(`Spatial ID '${gt}' not found in datastorage. Just removing from the spatial map...`),s.delete(gt),s.changeMode("simple_select");return}gf(C,vt.id),s.delete(gt),s.changeMode("simple_select")}},E.attachDraw(s),b.on("draw.create",function(se){se.features[0].properties={color_rgb_str:pc},s.add(se.features[0]),Yr.set(Gi.Waiting)}),b.on("draw.update",function(se){var vt;const be=se.features[0],Q=be.id;let wt=(vt=[...C].find(Vt=>Vt[1].properties.spatial_object_id===Q))==null?void 0:vt[1];if(!wt){console.warn(`Spatial ID '${Q}' not found in datastorage. Ignoring...`);return}const gt=be.geometry;wt.geometry.coordinates=gt.coordinates,Ya(wt.id,wt)})}),Qh(()=>{console.log("Destroyed"),Cl.set(!1),wl.set(!1),O(),L(),nt()});function xt(se){se.key==="Escape"&&(Kt(p),s.changeMode("simple_select"),Yr.set(Gi.Waiting))}const Ft=()=>{const se=document.querySelectorAll(".fixed-action-btn");M.FloatingActionButton.init(se,{direction:"left",hoverEnabled:!1});const be=document.getElementById("collapsible-data");M.Collapsible.init(be,{})},Kt=se=>{se.contourTemporary.forEach(be=>{se.remove(be)}),se.contourNotationTemporary.forEach(be=>{se.remove(be)}),se.contourTemporary=[],se.contourNotationTemporary=[],se.contourFinalized=[]},Jt=()=>{w!==Gi.AddingZoneCanvas?(Yr.set(Gi.AddingZoneCanvas),s.changeMode("draw_restricted_polygon")):(Yr.set(Gi.Waiting),s.changeMode("simple_select"))},Qt=()=>{w!==Gi.AddingZoneMap?(Yr.set(Gi.AddingZoneMap),s.changeMode("draw_restricted_polygon")):(Yr.set(Gi.Waiting),s.changeMode("simple_select"))},he=()=>{w!==Gi.DeletingZoneCanvas?Yr.set(Gi.DeletingZoneCanvas):Yr.set(Gi.Waiting)},ne=()=>{w!==Gi.DeletingZoneMap?(Yr.set(Gi.DeletingZoneMap),s.changeMode("delete_zone")):(Yr.set(Gi.Waiting),s.changeMode("simple_select"))},me=()=>Ng(d,It);function Oe(se){of[se?"unshift":"push"](()=>{E=se,st(1,E)})}return Z.$$.update=()=>{Z.$$.dirty&16384&&st(5,ft=m===Gi.AddingZoneCanvas||m===Gi.DeletingZoneCanvas),Z.$$.dirty&16384&&st(4,lt=m===Gi.AddingZoneMap||m===Gi.DeletingZoneMap),Z.$$.dirty&8192&&st(3,It=[...C].filter(se=>se[1].id&&se[1].properties.spatial_object_id)),Z.$$.dirty&16384&&st(2,N=U.get(m))},[d,E,N,It,lt,ft,c,g,xt,Jt,Qt,he,ne,C,m,me,Oe]}class Yg extends ma{constructor(S){super(),ga(this,S,Ug,Vg,pa,{})}}export{Yg as component,$g as universal};
