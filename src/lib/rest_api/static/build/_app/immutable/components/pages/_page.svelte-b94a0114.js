import{S as Vl,i as Nl,s as Gl,k as ti,l as ii,m as ai,h as Kt,n as oi,b as Oo,J as gt,B as aa,K as Ln,o as Xl,L as Nc,M as Cu,a as sr,c as or,N as Bc,O as uo,q as Mr,r as kr,P as Pa,Q as Su,D as Tu,w as kc,x as Dc,y as Oc,f as Lc,t as zc,z as Fc,R as pu,e as mu,T as yf,p as sl,u as ol}from"../../chunks/index-53191b19.js";import{w as Ws,d as vf}from"../../chunks/index-28c66de4.js";var Ia=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function xf(Ne){var I=Ne.default;if(typeof I=="function"){var Tt=function(){return I.apply(this,arguments)};Tt.prototype=I.prototype}else Tt={};return Object.defineProperty(Tt,"__esModule",{value:!0}),Object.keys(Ne).forEach(function(ft){var At=Object.getOwnPropertyDescriptor(Ne,ft);Object.defineProperty(Tt,ft,At.get?At:{enumerable:!0,get:function(){return Ne[ft]}})}),Tt}var En={};const bf={},wf=Object.freeze(Object.defineProperty({__proto__:null,default:bf},Symbol.toStringTag,{value:"Module"})),Rc=xf(wf);(function(Ne){/*! Fabric.js Copyright 2008-2015, Printio (Juriy Zaytsev, Maxim Chernyak) */var I=I||{version:"5.2.4"};if(Ne.fabric=I,typeof document<"u"&&typeof window<"u")document instanceof(typeof HTMLDocument<"u"?HTMLDocument:Document)?I.document=document:I.document=document.implementation.createHTMLDocument(""),I.window=window;else{var Tt=Rc,ft=new Tt.JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;I.document=ft.document,I.jsdomImplForWrapper=Rc.implForWrapper,I.nodeCanvas=Rc.Canvas,I.window=ft,DOMParser=I.window.DOMParser}I.isTouchSupported="ontouchstart"in I.window||"ontouchstart"in I.document||I.window&&I.window.navigator&&I.window.navigator.maxTouchPoints>0,I.isLikelyNode=typeof Buffer<"u"&&typeof window>"u",I.SHARED_ATTRIBUTES=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"],I.DPI=96,I.reNum="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",I.commaWsp="(?:\\s+,?\\s*|,\\s*)",I.rePathCommand=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/ig,I.reNonWord=/[ \n\.,;!\?\-]/,I.fontPaths={},I.iMatrix=[1,0,0,1,0,0],I.svgNS="http://www.w3.org/2000/svg",I.perfLimitSizeTotal=2097152,I.maxCacheSideLimit=4096,I.minCacheSideLimit=256,I.charWidthsCache={},I.textureSize=2048,I.disableStyleCopyPaste=!1,I.enableGLFiltering=!0,I.devicePixelRatio=I.window.devicePixelRatio||I.window.webkitDevicePixelRatio||I.window.mozDevicePixelRatio||1,I.browserShadowBlurConstant=1,I.arcToSegmentsCache={},I.boundsOfCurveCache={},I.cachesBoundsOfCurve=!0,I.forceGLPutImageData=!1,I.initFilterBackend=function(){if(I.enableGLFiltering&&I.isWebglSupported&&I.isWebglSupported(I.textureSize))return console.log("max texture size: "+I.maxTextureSize),new I.WebglFilterBackend({tileSize:I.textureSize});if(I.Canvas2dFilterBackend)return new I.Canvas2dFilterBackend},typeof document<"u"&&typeof window<"u"&&(window.fabric=I),function(){function n(c,d){if(!!this.__eventListeners[c]){var _=this.__eventListeners[c];d?_[_.indexOf(d)]=!1:I.util.array.fill(_,!1)}}function g(c,d){if(this.__eventListeners||(this.__eventListeners={}),arguments.length===1)for(var _ in c)this.on(_,c[_]);else this.__eventListeners[c]||(this.__eventListeners[c]=[]),this.__eventListeners[c].push(d);return this}function x(c,d){var _=function(){d.apply(this,arguments),this.off(c,_)}.bind(this);this.on(c,_)}function v(c,d){if(arguments.length===1)for(var _ in c)x.call(this,_,c[_]);else x.call(this,c,d);return this}function h(c,d){if(!this.__eventListeners)return this;if(arguments.length===0)for(c in this.__eventListeners)n.call(this,c);else if(arguments.length===1&&typeof arguments[0]=="object")for(var _ in c)n.call(this,_,c[_]);else n.call(this,c,d);return this}function a(c,d){if(!this.__eventListeners)return this;var _=this.__eventListeners[c];if(!_)return this;for(var u=0,C=_.length;u<C;u++)_[u]&&_[u].call(this,d||{});return this.__eventListeners[c]=_.filter(function(S){return S!==!1}),this}I.Observable={fire:a,on:g,once:v,off:h}}(),I.Collection={_objects:[],add:function(){if(this._objects.push.apply(this._objects,arguments),this._onObjectAdded)for(var n=0,g=arguments.length;n<g;n++)this._onObjectAdded(arguments[n]);return this.renderOnAddRemove&&this.requestRenderAll(),this},insertAt:function(n,g,x){var v=this._objects;return x?v[g]=n:v.splice(g,0,n),this._onObjectAdded&&this._onObjectAdded(n),this.renderOnAddRemove&&this.requestRenderAll(),this},remove:function(){for(var n=this._objects,g,x=!1,v=0,h=arguments.length;v<h;v++)g=n.indexOf(arguments[v]),g!==-1&&(x=!0,n.splice(g,1),this._onObjectRemoved&&this._onObjectRemoved(arguments[v]));return this.renderOnAddRemove&&x&&this.requestRenderAll(),this},forEachObject:function(n,g){for(var x=this.getObjects(),v=0,h=x.length;v<h;v++)n.call(g,x[v],v,x);return this},getObjects:function(n){return typeof n>"u"?this._objects.concat():this._objects.filter(function(g){return g.type===n})},item:function(n){return this._objects[n]},isEmpty:function(){return this._objects.length===0},size:function(){return this._objects.length},contains:function(n,g){return this._objects.indexOf(n)>-1?!0:g?this._objects.some(function(x){return typeof x.contains=="function"&&x.contains(n,!0)}):!1},complexity:function(){return this._objects.reduce(function(n,g){return n+=g.complexity?g.complexity():0,n},0)}},I.CommonMethods={_setOptions:function(n){for(var g in n)this.set(g,n[g])},_initGradient:function(n,g){n&&n.colorStops&&!(n instanceof I.Gradient)&&this.set(g,new I.Gradient(n))},_initPattern:function(n,g,x){n&&n.source&&!(n instanceof I.Pattern)?this.set(g,new I.Pattern(n,x)):x&&x()},_setObject:function(n){for(var g in n)this._set(g,n[g])},set:function(n,g){return typeof n=="object"?this._setObject(n):this._set(n,g),this},_set:function(n,g){this[n]=g},toggle:function(n){var g=this.get(n);return typeof g=="boolean"&&this.set(n,!g),this},get:function(n){return this[n]}},function(n){var g=Math.sqrt,x=Math.atan2,v=Math.pow,h=Math.PI/180,a=Math.PI/2;I.util={cos:function(c){if(c===0)return 1;c<0&&(c=-c);var d=c/a;switch(d){case 1:case 3:return 0;case 2:return-1}return Math.cos(c)},sin:function(c){if(c===0)return 0;var d=c/a,_=1;switch(c<0&&(_=-1),d){case 1:return _;case 2:return 0;case 3:return-_}return Math.sin(c)},removeFromArray:function(c,d){var _=c.indexOf(d);return _!==-1&&c.splice(_,1),c},getRandomInt:function(c,d){return Math.floor(Math.random()*(d-c+1))+c},degreesToRadians:function(c){return c*h},radiansToDegrees:function(c){return c/h},rotatePoint:function(c,d,_){var u=new I.Point(c.x-d.x,c.y-d.y),C=I.util.rotateVector(u,_);return new I.Point(C.x,C.y).addEquals(d)},rotateVector:function(c,d){var _=I.util.sin(d),u=I.util.cos(d),C=c.x*u-c.y*_,S=c.x*_+c.y*u;return{x:C,y:S}},createVector:function(c,d){return new I.Point(d.x-c.x,d.y-c.y)},calcAngleBetweenVectors:function(c,d){return Math.acos((c.x*d.x+c.y*d.y)/(Math.hypot(c.x,c.y)*Math.hypot(d.x,d.y)))},getHatVector:function(c){return new I.Point(c.x,c.y).multiply(1/Math.hypot(c.x,c.y))},getBisector:function(c,d,_){var u=I.util.createVector(c,d),C=I.util.createVector(c,_),S=I.util.calcAngleBetweenVectors(u,C),A=I.util.calcAngleBetweenVectors(I.util.rotateVector(u,S),C),O=S*(A===0?1:-1)/2;return{vector:I.util.getHatVector(I.util.rotateVector(u,O)),angle:S}},projectStrokeOnPoints:function(c,d,_){var u=[],C=d.strokeWidth/2,S=d.strokeUniform?new I.Point(1/d.scaleX,1/d.scaleY):new I.Point(1,1),A=function(O){var U=C/Math.hypot(O.x,O.y);return new I.Point(O.x*U*S.x,O.y*U*S.y)};return c.length<=1||c.forEach(function(O,U){var Y=new I.Point(O.x,O.y),oe,ge;U===0?(ge=c[U+1],oe=_?A(I.util.createVector(ge,Y)).addEquals(Y):c[c.length-1]):U===c.length-1?(oe=c[U-1],ge=_?A(I.util.createVector(oe,Y)).addEquals(Y):c[0]):(oe=c[U-1],ge=c[U+1]);var ze=I.util.getBisector(Y,oe,ge),We=ze.vector,at=ze.angle,_t,vt;if(d.strokeLineJoin==="miter"&&(_t=-C/Math.sin(at/2),vt=new I.Point(We.x*_t*S.x,We.y*_t*S.y),Math.hypot(vt.x,vt.y)/C<=d.strokeMiterLimit)){u.push(Y.add(vt)),u.push(Y.subtract(vt));return}_t=-C*Math.SQRT2,vt=new I.Point(We.x*_t*S.x,We.y*_t*S.y),u.push(Y.add(vt)),u.push(Y.subtract(vt))}),u},transformPoint:function(c,d,_){return _?new I.Point(d[0]*c.x+d[2]*c.y,d[1]*c.x+d[3]*c.y):new I.Point(d[0]*c.x+d[2]*c.y+d[4],d[1]*c.x+d[3]*c.y+d[5])},makeBoundingBoxFromPoints:function(c,d){if(d)for(var _=0;_<c.length;_++)c[_]=I.util.transformPoint(c[_],d);var u=[c[0].x,c[1].x,c[2].x,c[3].x],C=I.util.array.min(u),S=I.util.array.max(u),A=S-C,O=[c[0].y,c[1].y,c[2].y,c[3].y],U=I.util.array.min(O),Y=I.util.array.max(O),oe=Y-U;return{left:C,top:U,width:A,height:oe}},invertTransform:function(c){var d=1/(c[0]*c[3]-c[1]*c[2]),_=[d*c[3],-d*c[1],-d*c[2],d*c[0]],u=I.util.transformPoint({x:c[4],y:c[5]},_,!0);return _[4]=-u.x,_[5]=-u.y,_},toFixed:function(c,d){return parseFloat(Number(c).toFixed(d))},parseUnit:function(c,d){var _=/\D{0,2}$/.exec(c),u=parseFloat(c);switch(d||(d=I.Text.DEFAULT_SVG_FONT_SIZE),_[0]){case"mm":return u*I.DPI/25.4;case"cm":return u*I.DPI/2.54;case"in":return u*I.DPI;case"pt":return u*I.DPI/72;case"pc":return u*I.DPI/72*12;case"em":return u*d;default:return u}},falseFunction:function(){return!1},getKlass:function(c,d){return c=I.util.string.camelize(c.charAt(0).toUpperCase()+c.slice(1)),I.util.resolveNamespace(d)[c]},getSvgAttributes:function(c){var d=["instantiated_by_use","style","id","class"];switch(c){case"linearGradient":d=d.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);break;case"radialGradient":d=d.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);break;case"stop":d=d.concat(["offset","stop-color","stop-opacity"]);break}return d},resolveNamespace:function(c){if(!c)return I;var d=c.split("."),_=d.length,u,C=n||I.window;for(u=0;u<_;++u)C=C[d[u]];return C},loadImage:function(c,d,_,u){if(!c){d&&d.call(_,c);return}var C=I.util.createImage(),S=function(){d&&d.call(_,C,!1),C=C.onload=C.onerror=null};C.onload=S,C.onerror=function(){I.log("Error loading "+C.src),d&&d.call(_,null,!0),C=C.onload=C.onerror=null},c.indexOf("data")!==0&&u!==void 0&&u!==null&&(C.crossOrigin=u),c.substring(0,14)==="data:image/svg"&&(C.onload=null,I.util.loadImageInDom(C,S)),C.src=c},loadImageInDom:function(c,d){var _=I.document.createElement("div");_.style.width=_.style.height="1px",_.style.left=_.style.top="-100%",_.style.position="absolute",_.appendChild(c),I.document.querySelector("body").appendChild(_),c.onload=function(){d(),_.parentNode.removeChild(_),_=null}},enlivenObjects:function(c,d,_,u){c=c||[];var C=[],S=0,A=c.length;function O(){++S===A&&d&&d(C.filter(function(U){return U}))}if(!A){d&&d(C);return}c.forEach(function(U,Y){if(!U||!U.type){O();return}var oe=I.util.getKlass(U.type,_);oe.fromObject(U,function(ge,ze){ze||(C[Y]=ge),u&&u(U,ge,ze),O()})})},enlivenObjectEnlivables:function(c,d,_){var u=I.Object.ENLIVEN_PROPS.filter(function(C){return!!c[C]});I.util.enlivenObjects(u.map(function(C){return c[C]}),function(C){var S={};u.forEach(function(A,O){S[A]=C[O],d&&(d[A]=C[O])}),_&&_(S)})},enlivenPatterns:function(c,d){c=c||[];function _(){++C===S&&d&&d(u)}var u=[],C=0,S=c.length;if(!S){d&&d(u);return}c.forEach(function(A,O){A&&A.source?new I.Pattern(A,function(U){u[O]=U,_()}):(u[O]=A,_())})},groupSVGElements:function(c,d,_){var u;return c&&c.length===1?(typeof _<"u"&&(c[0].sourcePath=_),c[0]):(d&&(d.width&&d.height?d.centerPoint={x:d.width/2,y:d.height/2}:(delete d.width,delete d.height)),u=new I.Group(c,d),typeof _<"u"&&(u.sourcePath=_),u)},populateWithProperties:function(c,d,_){if(_&&Array.isArray(_))for(var u=0,C=_.length;u<C;u++)_[u]in c&&(d[_[u]]=c[_[u]])},createCanvasElement:function(){return I.document.createElement("canvas")},copyCanvasElement:function(c){var d=I.util.createCanvasElement();return d.width=c.width,d.height=c.height,d.getContext("2d").drawImage(c,0,0),d},toDataURL:function(c,d,_){return c.toDataURL("image/"+d,_)},createImage:function(){return I.document.createElement("img")},multiplyTransformMatrices:function(c,d,_){return[c[0]*d[0]+c[2]*d[1],c[1]*d[0]+c[3]*d[1],c[0]*d[2]+c[2]*d[3],c[1]*d[2]+c[3]*d[3],_?0:c[0]*d[4]+c[2]*d[5]+c[4],_?0:c[1]*d[4]+c[3]*d[5]+c[5]]},qrDecompose:function(c){var d=x(c[1],c[0]),_=v(c[0],2)+v(c[1],2),u=g(_),C=(c[0]*c[3]-c[2]*c[1])/u,S=x(c[0]*c[2]+c[1]*c[3],_);return{angle:d/h,scaleX:u,scaleY:C,skewX:S/h,skewY:0,translateX:c[4],translateY:c[5]}},calcRotateMatrix:function(c){if(!c.angle)return I.iMatrix.concat();var d=I.util.degreesToRadians(c.angle),_=I.util.cos(d),u=I.util.sin(d);return[_,u,-u,_,0,0]},calcDimensionsMatrix:function(c){var d=typeof c.scaleX>"u"?1:c.scaleX,_=typeof c.scaleY>"u"?1:c.scaleY,u=[c.flipX?-d:d,0,0,c.flipY?-_:_,0,0],C=I.util.multiplyTransformMatrices,S=I.util.degreesToRadians;return c.skewX&&(u=C(u,[1,0,Math.tan(S(c.skewX)),1],!0)),c.skewY&&(u=C(u,[1,Math.tan(S(c.skewY)),0,1],!0)),u},composeMatrix:function(c){var d=[1,0,0,1,c.translateX||0,c.translateY||0],_=I.util.multiplyTransformMatrices;return c.angle&&(d=_(d,I.util.calcRotateMatrix(c))),(c.scaleX!==1||c.scaleY!==1||c.skewX||c.skewY||c.flipX||c.flipY)&&(d=_(d,I.util.calcDimensionsMatrix(c))),d},resetObjectTransform:function(c){c.scaleX=1,c.scaleY=1,c.skewX=0,c.skewY=0,c.flipX=!1,c.flipY=!1,c.rotate(0)},saveObjectTransform:function(c){return{scaleX:c.scaleX,scaleY:c.scaleY,skewX:c.skewX,skewY:c.skewY,angle:c.angle,left:c.left,flipX:c.flipX,flipY:c.flipY,top:c.top}},isTransparent:function(c,d,_,u){u>0&&(d>u?d-=u:d=0,_>u?_-=u:_=0);var C=!0,S,A,O=c.getImageData(d,_,u*2||1,u*2||1),U=O.data.length;for(S=3;S<U&&(A=O.data[S],C=A<=0,C!==!1);S+=4);return O=null,C},parsePreserveAspectRatioAttribute:function(c){var d="meet",_="Mid",u="Mid",C=c.split(" "),S;return C&&C.length&&(d=C.pop(),d!=="meet"&&d!=="slice"?(S=d,d="meet"):C.length&&(S=C.pop())),_=S!=="none"?S.slice(1,4):"none",u=S!=="none"?S.slice(5,8):"none",{meetOrSlice:d,alignX:_,alignY:u}},clearFabricFontCache:function(c){c=(c||"").toLowerCase(),c?I.charWidthsCache[c]&&delete I.charWidthsCache[c]:I.charWidthsCache={}},limitDimsByArea:function(c,d){var _=Math.sqrt(d*c),u=Math.floor(d/_);return{x:Math.floor(_),y:u}},capValue:function(c,d,_){return Math.max(c,Math.min(d,_))},findScaleToFit:function(c,d){return Math.min(d.width/c.width,d.height/c.height)},findScaleToCover:function(c,d){return Math.max(d.width/c.width,d.height/c.height)},matrixToSVG:function(c){return"matrix("+c.map(function(d){return I.util.toFixed(d,I.Object.NUM_FRACTION_DIGITS)}).join(" ")+")"},removeTransformFromObject:function(c,d){var _=I.util.invertTransform(d),u=I.util.multiplyTransformMatrices(_,c.calcOwnMatrix());I.util.applyTransformToObject(c,u)},addTransformToObject:function(c,d){I.util.applyTransformToObject(c,I.util.multiplyTransformMatrices(d,c.calcOwnMatrix()))},applyTransformToObject:function(c,d){var _=I.util.qrDecompose(d),u=new I.Point(_.translateX,_.translateY);c.flipX=!1,c.flipY=!1,c.set("scaleX",_.scaleX),c.set("scaleY",_.scaleY),c.skewX=_.skewX,c.skewY=_.skewY,c.angle=_.angle,c.setPositionByOrigin(u,"center","center")},sizeAfterTransform:function(c,d,_){var u=c/2,C=d/2,S=[{x:-u,y:-C},{x:u,y:-C},{x:-u,y:C},{x:u,y:C}],A=I.util.calcDimensionsMatrix(_),O=I.util.makeBoundingBoxFromPoints(S,A);return{x:O.width,y:O.height}},mergeClipPaths:function(c,d){var _=c,u=d;_.inverted&&!u.inverted&&(_=d,u=c),I.util.applyTransformToObject(u,I.util.multiplyTransformMatrices(I.util.invertTransform(_.calcTransformMatrix()),u.calcTransformMatrix()));var C=_.inverted&&u.inverted;return C&&(_.inverted=u.inverted=!1),new I.Group([_],{clipPath:u,inverted:C})},hasStyleChanged:function(c,d,_){return _=_||!1,c.fill!==d.fill||c.stroke!==d.stroke||c.strokeWidth!==d.strokeWidth||c.fontSize!==d.fontSize||c.fontFamily!==d.fontFamily||c.fontWeight!==d.fontWeight||c.fontStyle!==d.fontStyle||c.deltaY!==d.deltaY||_&&(c.overline!==d.overline||c.underline!==d.underline||c.linethrough!==d.linethrough)},stylesToArray:function(_,d){for(var _=I.util.object.clone(_,!0),u=d.split(`
`),C=-1,S={},A=[],O=0;O<u.length;O++){if(!_[O]){C+=u[O].length;continue}for(var U=0;U<u[O].length;U++){C++;var Y=_[O][U];if(Y){var oe=I.util.hasStyleChanged(S,Y,!0);oe?A.push({start:C,end:C+1,style:Y}):A[A.length-1].end++}S=Y||{}}}return A},stylesFromArray:function(c,d){if(!Array.isArray(c))return c;for(var _=d.split(`
`),u=-1,C=0,S={},A=0;A<_.length;A++)for(var O=0;O<_[A].length;O++)u++,c[C]&&c[C].start<=u&&u<c[C].end&&(S[A]=S[A]||{},S[A][O]=Object.assign({},c[C].style),u===c[C].end-1&&C++);return S}}}(Ne),function(){var n=Array.prototype.join,g={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},x={m:"l",M:"L"};function v(Q,se,de,ie,ve,J,q,ce,be,De,Ie){var tt=I.util.cos(Q),ut=I.util.sin(Q),nt=I.util.cos(se),je=I.util.sin(se),Ce=de*ve*nt-ie*J*je+q,Ve=ie*ve*nt+de*J*je+ce,Je=De+be*(-de*ve*ut-ie*J*tt),$e=Ie+be*(-ie*ve*ut+de*J*tt),lt=Ce+be*(de*ve*je+ie*J*nt),ot=Ve+be*(ie*ve*je-de*J*nt);return["C",Je,$e,lt,ot,Ce,Ve]}function h(Q,se,de,ie,ve,J,q){var ce=Math.PI,be=q*ce/180,De=I.util.sin(be),Ie=I.util.cos(be),tt=0,ut=0;de=Math.abs(de),ie=Math.abs(ie);var nt=-Ie*Q*.5-De*se*.5,je=-Ie*se*.5+De*Q*.5,Ce=de*de,Ve=ie*ie,Je=je*je,$e=nt*nt,lt=Ce*Ve-Ce*Je-Ve*$e,ot=0;if(lt<0){var Gt=Math.sqrt(1-lt/(Ce*Ve));de*=Gt,ie*=Gt}else ot=(ve===J?-1:1)*Math.sqrt(lt/(Ce*Je+Ve*$e));var Xt=ot*de*je/ie,He=-ot*ie*nt/de,jt=Ie*Xt-De*He+Q*.5,qt=De*Xt+Ie*He+se*.5,mi=a(1,0,(nt-Xt)/de,(je-He)/ie),Di=a((nt-Xt)/de,(je-He)/ie,(-nt-Xt)/de,(-je-He)/ie);J===0&&Di>0?Di-=2*ce:J===1&&Di<0&&(Di+=2*ce);for(var wi=Math.ceil(Math.abs(Di/ce*2)),Ue=[],yt=Di/wi,Ri=8/3*Math.sin(yt/4)*Math.sin(yt/4)/Math.sin(yt/2),Zi=mi+yt,ri=0;ri<wi;ri++)Ue[ri]=v(mi,Zi,Ie,De,de,ie,jt,qt,Ri,tt,ut),tt=Ue[ri][5],ut=Ue[ri][6],mi=Zi,Zi+=yt;return Ue}function a(Q,se,de,ie){var ve=Math.atan2(se,Q),J=Math.atan2(ie,de);return J>=ve?J-ve:2*Math.PI-(ve-J)}function c(Q,se,de,ie,ve,J,q,ce){var be;if(I.cachesBoundsOfCurve&&(be=n.call(arguments),I.boundsOfCurveCache[be]))return I.boundsOfCurveCache[be];var De=Math.sqrt,Ie=Math.min,tt=Math.max,ut=Math.abs,nt=[],je=[[],[]],Ce,Ve,Je,$e,lt,ot,Gt,Xt;Ve=6*Q-12*de+6*ve,Ce=-3*Q+9*de-9*ve+3*q,Je=3*de-3*Q;for(var He=0;He<2;++He){if(He>0&&(Ve=6*se-12*ie+6*J,Ce=-3*se+9*ie-9*J+3*ce,Je=3*ie-3*se),ut(Ce)<1e-12){if(ut(Ve)<1e-12)continue;$e=-Je/Ve,0<$e&&$e<1&&nt.push($e);continue}Gt=Ve*Ve-4*Je*Ce,!(Gt<0)&&(Xt=De(Gt),lt=(-Ve+Xt)/(2*Ce),0<lt&&lt<1&&nt.push(lt),ot=(-Ve-Xt)/(2*Ce),0<ot&&ot<1&&nt.push(ot))}for(var jt,qt,mi=nt.length,Di=mi,wi;mi--;)$e=nt[mi],wi=1-$e,jt=wi*wi*wi*Q+3*wi*wi*$e*de+3*wi*$e*$e*ve+$e*$e*$e*q,je[0][mi]=jt,qt=wi*wi*wi*se+3*wi*wi*$e*ie+3*wi*$e*$e*J+$e*$e*$e*ce,je[1][mi]=qt;je[0][Di]=Q,je[1][Di]=se,je[0][Di+1]=q,je[1][Di+1]=ce;var Ue=[{x:Ie.apply(null,je[0]),y:Ie.apply(null,je[1])},{x:tt.apply(null,je[0]),y:tt.apply(null,je[1])}];return I.cachesBoundsOfCurve&&(I.boundsOfCurveCache[be]=Ue),Ue}function d(Q,se,de){for(var ie=de[1],ve=de[2],J=de[3],q=de[4],ce=de[5],be=de[6],De=de[7],Ie=h(be-Q,De-se,ie,ve,q,ce,J),tt=0,ut=Ie.length;tt<ut;tt++)Ie[tt][1]+=Q,Ie[tt][2]+=se,Ie[tt][3]+=Q,Ie[tt][4]+=se,Ie[tt][5]+=Q,Ie[tt][6]+=se;return Ie}function _(Q){var se=0,de=0,ie=Q.length,ve=0,J=0,q,ce,be,De=[],Ie,tt,ut;for(ce=0;ce<ie;++ce){switch(be=!1,q=Q[ce].slice(0),q[0]){case"l":q[0]="L",q[1]+=se,q[2]+=de;case"L":se=q[1],de=q[2];break;case"h":q[1]+=se;case"H":q[0]="L",q[2]=de,se=q[1];break;case"v":q[1]+=de;case"V":q[0]="L",de=q[1],q[1]=se,q[2]=de;break;case"m":q[0]="M",q[1]+=se,q[2]+=de;case"M":se=q[1],de=q[2],ve=q[1],J=q[2];break;case"c":q[0]="C",q[1]+=se,q[2]+=de,q[3]+=se,q[4]+=de,q[5]+=se,q[6]+=de;case"C":tt=q[3],ut=q[4],se=q[5],de=q[6];break;case"s":q[0]="S",q[1]+=se,q[2]+=de,q[3]+=se,q[4]+=de;case"S":Ie==="C"?(tt=2*se-tt,ut=2*de-ut):(tt=se,ut=de),se=q[3],de=q[4],q[0]="C",q[5]=q[3],q[6]=q[4],q[3]=q[1],q[4]=q[2],q[1]=tt,q[2]=ut,tt=q[3],ut=q[4];break;case"q":q[0]="Q",q[1]+=se,q[2]+=de,q[3]+=se,q[4]+=de;case"Q":tt=q[1],ut=q[2],se=q[3],de=q[4];break;case"t":q[0]="T",q[1]+=se,q[2]+=de;case"T":Ie==="Q"?(tt=2*se-tt,ut=2*de-ut):(tt=se,ut=de),q[0]="Q",se=q[1],de=q[2],q[1]=tt,q[2]=ut,q[3]=se,q[4]=de;break;case"a":q[0]="A",q[6]+=se,q[7]+=de;case"A":be=!0,De=De.concat(d(se,de,q)),se=q[6],de=q[7];break;case"z":case"Z":se=ve,de=J;break}be||De.push(q),Ie=q[0]}return De}function u(Q,se,de,ie){return Math.sqrt((de-Q)*(de-Q)+(ie-se)*(ie-se))}function C(Q){return Q*Q*Q}function S(Q){return 3*Q*Q*(1-Q)}function A(Q){return 3*Q*(1-Q)*(1-Q)}function O(Q){return(1-Q)*(1-Q)*(1-Q)}function U(Q,se,de,ie,ve,J,q,ce){return function(be){var De=C(be),Ie=S(be),tt=A(be),ut=O(be);return{x:q*De+ve*Ie+de*tt+Q*ut,y:ce*De+J*Ie+ie*tt+se*ut}}}function Y(Q,se,de,ie,ve,J,q,ce){return function(be){var De=1-be,Ie=3*De*De*(de-Q)+6*De*be*(ve-de)+3*be*be*(q-ve),tt=3*De*De*(ie-se)+6*De*be*(J-ie)+3*be*be*(ce-J);return Math.atan2(tt,Ie)}}function oe(Q){return Q*Q}function ge(Q){return 2*Q*(1-Q)}function ze(Q){return(1-Q)*(1-Q)}function We(Q,se,de,ie,ve,J){return function(q){var ce=oe(q),be=ge(q),De=ze(q);return{x:ve*ce+de*be+Q*De,y:J*ce+ie*be+se*De}}}function at(Q,se,de,ie,ve,J){return function(q){var ce=1-q,be=2*ce*(de-Q)+2*q*(ve-de),De=2*ce*(ie-se)+2*q*(J-ie);return Math.atan2(De,be)}}function _t(Q,se,de){var ie={x:se,y:de},ve,J=0,q;for(q=1;q<=100;q+=1)ve=Q(q/100),J+=u(ie.x,ie.y,ve.x,ve.y),ie=ve;return J}function vt(Q,se){for(var de=0,ie=0,ve=Q.iterator,J={x:Q.x,y:Q.y},q,ce,be=.01,De=Q.angleFinder,Ie;ie<se&&be>1e-4;)q=ve(de),Ie=de,ce=u(J.x,J.y,q.x,q.y),ce+ie>se?(de-=be,be/=2):(J=q,de+=be,ie+=ce);return q.angle=De(Ie),q}function rt(Q){for(var se=0,de=Q.length,ie,ve=0,J=0,q=0,ce=0,be=[],De,Ie,tt,ut=0;ut<de;ut++){switch(ie=Q[ut],Ie={x:ve,y:J,command:ie[0]},ie[0]){case"M":Ie.length=0,q=ve=ie[1],ce=J=ie[2];break;case"L":Ie.length=u(ve,J,ie[1],ie[2]),ve=ie[1],J=ie[2];break;case"C":De=U(ve,J,ie[1],ie[2],ie[3],ie[4],ie[5],ie[6]),tt=Y(ve,J,ie[1],ie[2],ie[3],ie[4],ie[5],ie[6]),Ie.iterator=De,Ie.angleFinder=tt,Ie.length=_t(De,ve,J),ve=ie[5],J=ie[6];break;case"Q":De=We(ve,J,ie[1],ie[2],ie[3],ie[4]),tt=at(ve,J,ie[1],ie[2],ie[3],ie[4]),Ie.iterator=De,Ie.angleFinder=tt,Ie.length=_t(De,ve,J),ve=ie[3],J=ie[4];break;case"Z":case"z":Ie.destX=q,Ie.destY=ce,Ie.length=u(ve,J,q,ce),ve=q,J=ce;break}se+=Ie.length,be.push(Ie)}return be.push({length:se,x:ve,y:J}),be}function mt(Q,se,de){de||(de=rt(Q));for(var ie=0;se-de[ie].length>0&&ie<de.length-2;)se-=de[ie].length,ie++;var ve=de[ie],J=se/ve.length,q=ve.command,ce=Q[ie],be;switch(q){case"M":return{x:ve.x,y:ve.y,angle:0};case"Z":case"z":return be=new I.Point(ve.x,ve.y).lerp(new I.Point(ve.destX,ve.destY),J),be.angle=Math.atan2(ve.destY-ve.y,ve.destX-ve.x),be;case"L":return be=new I.Point(ve.x,ve.y).lerp(new I.Point(ce[1],ce[2]),J),be.angle=Math.atan2(ce[2]-ve.y,ce[1]-ve.x),be;case"C":return vt(ve,se);case"Q":return vt(ve,se)}}function Qe(Q){var se=[],de=[],ie,ve,J=I.rePathCommand,q="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",ce="("+q+")"+I.commaWsp,be="([01])"+I.commaWsp+"?",De=ce+"?"+ce+"?"+ce+be+be+ce+"?("+q+")",Ie=new RegExp(De,"g"),tt,ut,nt;if(!Q||!Q.match)return se;nt=Q.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi);for(var je=0,Ce,Ve=nt.length;je<Ve;je++){ie=nt[je],ut=ie.slice(1).trim(),de.length=0;var Je=ie.charAt(0);if(Ce=[Je],Je.toLowerCase()==="a")for(var $e;$e=Ie.exec(ut);)for(var lt=1;lt<$e.length;lt++)de.push($e[lt]);else for(;tt=J.exec(ut);)de.push(tt[0]);for(var lt=0,ot=de.length;lt<ot;lt++)ve=parseFloat(de[lt]),isNaN(ve)||Ce.push(ve);var Gt=g[Je.toLowerCase()],Xt=x[Je]||Je;if(Ce.length-1>Gt)for(var He=1,jt=Ce.length;He<jt;He+=Gt)se.push([Je].concat(Ce.slice(He,He+Gt))),Je=Xt;else se.push(Ce)}return se}function zt(Q,se){var de=[],ie,ve=new I.Point(Q[0].x,Q[0].y),J=new I.Point(Q[1].x,Q[1].y),q=Q.length,ce=1,be=0,De=q>2;for(se=se||0,De&&(ce=Q[2].x<J.x?-1:Q[2].x===J.x?0:1,be=Q[2].y<J.y?-1:Q[2].y===J.y?0:1),de.push(["M",ve.x-ce*se,ve.y-be*se]),ie=1;ie<q;ie++){if(!ve.eq(J)){var Ie=ve.midPointFrom(J);de.push(["Q",ve.x,ve.y,Ie.x,Ie.y])}ve=Q[ie],ie+1<Q.length&&(J=Q[ie+1])}return De&&(ce=ve.x>Q[ie-2].x?1:ve.x===Q[ie-2].x?0:-1,be=ve.y>Q[ie-2].y?1:ve.y===Q[ie-2].y?0:-1),de.push(["L",ve.x+ce*se,ve.y+be*se]),de}function Et(Q,se,de){return de&&(se=I.util.multiplyTransformMatrices(se,[1,0,0,1,-de.x,-de.y])),Q.map(function(ie){for(var ve=ie.slice(0),J={},q=1;q<ie.length-1;q+=2)J.x=ie[q],J.y=ie[q+1],J=I.util.transformPoint(J,se),ve[q]=J.x,ve[q+1]=J.y;return ve})}I.util.joinPath=function(Q){return Q.map(function(se){return se.join(" ")}).join(" ")},I.util.parsePath=Qe,I.util.makePathSimpler=_,I.util.getSmoothPathFromPoints=zt,I.util.getPathSegmentsInfo=rt,I.util.getBoundsOfCurve=c,I.util.getPointOnPath=mt,I.util.transformPath=Et}(),function(){var n=Array.prototype.slice;function g(c,d){for(var _=n.call(arguments,2),u=[],C=0,S=c.length;C<S;C++)u[C]=_.length?c[C][d].apply(c[C],_):c[C][d].call(c[C]);return u}function x(c,d){return a(c,d,function(_,u){return _>=u})}function v(c,d){return a(c,d,function(_,u){return _<u})}function h(c,d){for(var _=c.length;_--;)c[_]=d;return c}function a(c,d,_){if(!(!c||c.length===0)){var u=c.length-1,C=d?c[u][d]:c[u];if(d)for(;u--;)_(c[u][d],C)&&(C=c[u][d]);else for(;u--;)_(c[u],C)&&(C=c[u]);return C}}I.util.array={fill:h,invoke:g,min:v,max:x}}(),function(){function n(x,v,h){if(h)if(!I.isLikelyNode&&v instanceof Element)x=v;else if(v instanceof Array){x=[];for(var a=0,c=v.length;a<c;a++)x[a]=n({},v[a],h)}else if(v&&typeof v=="object")for(var d in v)d==="canvas"||d==="group"?x[d]=null:v.hasOwnProperty(d)&&(x[d]=n({},v[d],h));else x=v;else for(var d in v)x[d]=v[d];return x}function g(x,v){return n({},x,v)}I.util.object={extend:n,clone:g},I.util.object.extend(I.util,I.Observable)}(),function(){function n(a){return a.replace(/-+(.)?/g,function(c,d){return d?d.toUpperCase():""})}function g(a,c){return a.charAt(0).toUpperCase()+(c?a.slice(1):a.slice(1).toLowerCase())}function x(a){return a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function v(a){var c=0,d,_=[];for(c=0,d;c<a.length;c++)(d=h(a,c))!==!1&&_.push(d);return _}function h(a,c){var d=a.charCodeAt(c);if(isNaN(d))return"";if(d<55296||d>57343)return a.charAt(c);if(55296<=d&&d<=56319){if(a.length<=c+1)throw"High surrogate without following low surrogate";var _=a.charCodeAt(c+1);if(56320>_||_>57343)throw"High surrogate without following low surrogate";return a.charAt(c)+a.charAt(c+1)}if(c===0)throw"Low surrogate without preceding high surrogate";var u=a.charCodeAt(c-1);if(55296>u||u>56319)throw"Low surrogate without preceding high surrogate";return!1}I.util.string={camelize:n,capitalize:g,escapeXml:x,graphemeSplit:v}}(),function(){var n=Array.prototype.slice,g=function(){},x=function(){for(var d in{toString:1})if(d==="toString")return!1;return!0}(),v=function(d,_,u){for(var C in _)C in d.prototype&&typeof d.prototype[C]=="function"&&(_[C]+"").indexOf("callSuper")>-1?d.prototype[C]=function(S){return function(){var A=this.constructor.superclass;this.constructor.superclass=u;var O=_[S].apply(this,arguments);if(this.constructor.superclass=A,S!=="initialize")return O}}(C):d.prototype[C]=_[C],x&&(_.toString!==Object.prototype.toString&&(d.prototype.toString=_.toString),_.valueOf!==Object.prototype.valueOf&&(d.prototype.valueOf=_.valueOf))};function h(){}function a(d){for(var _=null,u=this;u.constructor.superclass;){var C=u.constructor.superclass.prototype[d];if(u[d]!==C){_=C;break}u=u.constructor.superclass.prototype}return _?arguments.length>1?_.apply(this,n.call(arguments,1)):_.call(this):console.log("tried to callSuper "+d+", method not found in prototype chain",this)}function c(){var d=null,_=n.call(arguments,0);typeof _[0]=="function"&&(d=_.shift());function u(){this.initialize.apply(this,arguments)}u.superclass=d,u.subclasses=[],d&&(h.prototype=d.prototype,u.prototype=new h,d.subclasses.push(u));for(var C=0,S=_.length;C<S;C++)v(u,_[C],d);return u.prototype.initialize||(u.prototype.initialize=g),u.prototype.constructor=u,u.prototype.callSuper=a,u}I.util.createClass=c}(),function(){var n=!!I.document.createElement("div").attachEvent,g=["touchstart","touchmove","touchend"];I.util.addListener=function(v,h,a,c){v&&v.addEventListener(h,a,n?!1:c)},I.util.removeListener=function(v,h,a,c){v&&v.removeEventListener(h,a,n?!1:c)};function x(v){var h=v.changedTouches;return h&&h[0]?h[0]:v}I.util.getPointer=function(v){var h=v.target,a=I.util.getScrollLeftTop(h),c=x(v);return{x:c.clientX+a.left,y:c.clientY+a.top}},I.util.isTouchEvent=function(v){return g.indexOf(v.type)>-1||v.pointerType==="touch"}}(),function(){function n(c,d){var _=c.style;if(!_)return c;if(typeof d=="string")return c.style.cssText+=";"+d,d.indexOf("opacity")>-1?a(c,d.match(/opacity:\s*(\d?\.?\d*)/)[1]):c;for(var u in d)if(u==="opacity")a(c,d[u]);else{var C=u==="float"||u==="cssFloat"?typeof _.styleFloat>"u"?"cssFloat":"styleFloat":u;_.setProperty(C,d[u])}return c}var g=I.document.createElement("div"),x=typeof g.style.opacity=="string",v=typeof g.style.filter=="string",h=/alpha\s*\(\s*opacity\s*=\s*([^\)]+)\)/,a=function(c){return c};x?a=function(c,d){return c.style.opacity=d,c}:v&&(a=function(c,d){var _=c.style;return c.currentStyle&&!c.currentStyle.hasLayout&&(_.zoom=1),h.test(_.filter)?(d=d>=.9999?"":"alpha(opacity="+d*100+")",_.filter=_.filter.replace(h,d)):_.filter+=" alpha(opacity="+d*100+")",c}),I.util.setStyle=n}(),function(){var n=Array.prototype.slice;function g(O){return typeof O=="string"?I.document.getElementById(O):O}var x,v=function(O){return n.call(O,0)};try{x=v(I.document.childNodes)instanceof Array}catch{}x||(v=function(O){for(var U=new Array(O.length),Y=O.length;Y--;)U[Y]=O[Y];return U});function h(O,U){var Y=I.document.createElement(O);for(var oe in U)oe==="class"?Y.className=U[oe]:oe==="for"?Y.htmlFor=U[oe]:Y.setAttribute(oe,U[oe]);return Y}function a(O,U){O&&(" "+O.className+" ").indexOf(" "+U+" ")===-1&&(O.className+=(O.className?" ":"")+U)}function c(O,U,Y){return typeof U=="string"&&(U=h(U,Y)),O.parentNode&&O.parentNode.replaceChild(U,O),U.appendChild(O),U}function d(O){for(var U=0,Y=0,oe=I.document.documentElement,ge=I.document.body||{scrollLeft:0,scrollTop:0};O&&(O.parentNode||O.host)&&(O=O.parentNode||O.host,O===I.document?(U=ge.scrollLeft||oe.scrollLeft||0,Y=ge.scrollTop||oe.scrollTop||0):(U+=O.scrollLeft||0,Y+=O.scrollTop||0),!(O.nodeType===1&&O.style.position==="fixed")););return{left:U,top:Y}}function _(O){var U,Y=O&&O.ownerDocument,oe={left:0,top:0},ge={left:0,top:0},ze,We={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!Y)return ge;for(var at in We)ge[We[at]]+=parseInt(u(O,at),10)||0;return U=Y.documentElement,typeof O.getBoundingClientRect<"u"&&(oe=O.getBoundingClientRect()),ze=d(O),{left:oe.left+ze.left-(U.clientLeft||0)+ge.left,top:oe.top+ze.top-(U.clientTop||0)+ge.top}}var u;I.document.defaultView&&I.document.defaultView.getComputedStyle?u=function(O,U){var Y=I.document.defaultView.getComputedStyle(O,null);return Y?Y[U]:void 0}:u=function(O,U){var Y=O.style[U];return!Y&&O.currentStyle&&(Y=O.currentStyle[U]),Y},function(){var O=I.document.documentElement.style,U="userSelect"in O?"userSelect":"MozUserSelect"in O?"MozUserSelect":"WebkitUserSelect"in O?"WebkitUserSelect":"KhtmlUserSelect"in O?"KhtmlUserSelect":"";function Y(ge){return typeof ge.onselectstart<"u"&&(ge.onselectstart=I.util.falseFunction),U?ge.style[U]="none":typeof ge.unselectable=="string"&&(ge.unselectable="on"),ge}function oe(ge){return typeof ge.onselectstart<"u"&&(ge.onselectstart=null),U?ge.style[U]="":typeof ge.unselectable=="string"&&(ge.unselectable=""),ge}I.util.makeElementUnselectable=Y,I.util.makeElementSelectable=oe}();function C(O){var U=I.jsdomImplForWrapper(O);return U._canvas||U._image}function S(O){if(!!I.isLikelyNode){var U=I.jsdomImplForWrapper(O);U&&(U._image=null,U._canvas=null,U._currentSrc=null,U._attributes=null,U._classList=null)}}function A(O,U){O.imageSmoothingEnabled=O.imageSmoothingEnabled||O.webkitImageSmoothingEnabled||O.mozImageSmoothingEnabled||O.msImageSmoothingEnabled||O.oImageSmoothingEnabled,O.imageSmoothingEnabled=U}I.util.setImageSmoothing=A,I.util.getById=g,I.util.toArray=v,I.util.addClass=a,I.util.makeElement=h,I.util.wrapElement=c,I.util.getScrollLeftTop=d,I.util.getElementOffset=_,I.util.getNodeCanvas=C,I.util.cleanUpJsdomNode=S}(),function(){function n(v,h){return v+(/\?/.test(v)?"&":"?")+h}function g(){}function x(v,h){h||(h={});var a=h.method?h.method.toUpperCase():"GET",c=h.onComplete||function(){},d=new I.window.XMLHttpRequest,_=h.body||h.parameters;return d.onreadystatechange=function(){d.readyState===4&&(c(d),d.onreadystatechange=g)},a==="GET"&&(_=null,typeof h.parameters=="string"&&(v=n(v,h.parameters))),d.open(a,v,!0),(a==="POST"||a==="PUT")&&d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.send(_),d}I.util.request=x}(),I.log=console.log,I.warn=console.warn,function(){var n=I.util.object.extend,g=I.util.object.clone,x=[];I.util.object.extend(x,{cancelAll:function(){var C=this.splice(0);return C.forEach(function(S){S.cancel()}),C},cancelByCanvas:function(C){if(!C)return[];var S=this.filter(function(A){return typeof A.target=="object"&&A.target.canvas===C});return S.forEach(function(A){A.cancel()}),S},cancelByTarget:function(C){var S=this.findAnimationsByTarget(C);return S.forEach(function(A){A.cancel()}),S},findAnimationIndex:function(C){return this.indexOf(this.findAnimation(C))},findAnimation:function(C){return this.find(function(S){return S.cancel===C})},findAnimationsByTarget:function(C){return C?this.filter(function(S){return S.target===C}):[]}});function v(){return!1}function h(C,S,A,O){return-A*Math.cos(C/O*(Math.PI/2))+A+S}function a(C){C||(C={});var S=!1,A,O=function(){var U=I.runningAnimations.indexOf(A);return U>-1&&I.runningAnimations.splice(U,1)[0]};return A=n(g(C),{cancel:function(){return S=!0,O()},currentValue:"startValue"in C?C.startValue:0,completionRate:0,durationRate:0}),I.runningAnimations.push(A),_(function(U){var Y=U||+new Date,oe=C.duration||500,ge=Y+oe,ze,We=C.onChange||v,at=C.abort||v,_t=C.onComplete||v,vt=C.easing||h,rt="startValue"in C?C.startValue.length>0:!1,mt="startValue"in C?C.startValue:0,Qe="endValue"in C?C.endValue:100,zt=C.byValue||(rt?mt.map(function(Et,Q){return Qe[Q]-mt[Q]}):Qe-mt);C.onStart&&C.onStart(),function Et(Q){ze=Q||+new Date;var se=ze>ge?oe:ze-Y,de=se/oe,ie=rt?mt.map(function(J,q){return vt(se,mt[q],zt[q],oe)}):vt(se,mt,zt,oe),ve=Math.abs(rt?(ie[0]-mt[0])/zt[0]:(ie-mt)/zt);if(A.currentValue=rt?ie.slice():ie,A.completionRate=ve,A.durationRate=de,!S){if(at(ie,ve,de)){O();return}if(ze>ge){A.currentValue=rt?Qe.slice():Qe,A.completionRate=1,A.durationRate=1,We(rt?Qe.slice():Qe,1,1),_t(Qe,1,1),O();return}else We(ie,ve,de),_(Et)}}(Y)}),A.cancel}var c=I.window.requestAnimationFrame||I.window.webkitRequestAnimationFrame||I.window.mozRequestAnimationFrame||I.window.oRequestAnimationFrame||I.window.msRequestAnimationFrame||function(C){return I.window.setTimeout(C,1e3/60)},d=I.window.cancelAnimationFrame||I.window.clearTimeout;function _(){return c.apply(I.window,arguments)}function u(){return d.apply(I.window,arguments)}I.util.animate=a,I.util.requestAnimFrame=_,I.util.cancelAnimFrame=u,I.runningAnimations=x}(),function(){function n(x,v,h){var a="rgba("+parseInt(x[0]+h*(v[0]-x[0]),10)+","+parseInt(x[1]+h*(v[1]-x[1]),10)+","+parseInt(x[2]+h*(v[2]-x[2]),10);return a+=","+(x&&v?parseFloat(x[3]+h*(v[3]-x[3])):1),a+=")",a}function g(x,v,h,a){var c=new I.Color(x).getSource(),d=new I.Color(v).getSource(),_=a.onComplete,u=a.onChange;return a=a||{},I.util.animate(I.util.object.extend(a,{duration:h||500,startValue:c,endValue:d,byValue:d,easing:function(C,S,A,O){var U=a.colorEasing?a.colorEasing(C,O):1-Math.cos(C/O*(Math.PI/2));return n(S,A,U)},onComplete:function(C,S,A){if(_)return _(n(d,d,0),S,A)},onChange:function(C,S,A){if(u){if(Array.isArray(C))return u(n(C,C,0),S,A);u(C,S,A)}}}))}I.util.animateColor=g}(),function(){function n(Q,se,de,ie){return Q<Math.abs(se)?(Q=se,ie=de/4):se===0&&Q===0?ie=de/(2*Math.PI)*Math.asin(1):ie=de/(2*Math.PI)*Math.asin(se/Q),{a:Q,c:se,p:de,s:ie}}function g(Q,se,de){return Q.a*Math.pow(2,10*(se-=1))*Math.sin((se*de-Q.s)*(2*Math.PI)/Q.p)}function x(Q,se,de,ie){return de*((Q=Q/ie-1)*Q*Q+1)+se}function v(Q,se,de,ie){return Q/=ie/2,Q<1?de/2*Q*Q*Q+se:de/2*((Q-=2)*Q*Q+2)+se}function h(Q,se,de,ie){return de*(Q/=ie)*Q*Q*Q+se}function a(Q,se,de,ie){return-de*((Q=Q/ie-1)*Q*Q*Q-1)+se}function c(Q,se,de,ie){return Q/=ie/2,Q<1?de/2*Q*Q*Q*Q+se:-de/2*((Q-=2)*Q*Q*Q-2)+se}function d(Q,se,de,ie){return de*(Q/=ie)*Q*Q*Q*Q+se}function _(Q,se,de,ie){return de*((Q=Q/ie-1)*Q*Q*Q*Q+1)+se}function u(Q,se,de,ie){return Q/=ie/2,Q<1?de/2*Q*Q*Q*Q*Q+se:de/2*((Q-=2)*Q*Q*Q*Q+2)+se}function C(Q,se,de,ie){return-de*Math.cos(Q/ie*(Math.PI/2))+de+se}function S(Q,se,de,ie){return de*Math.sin(Q/ie*(Math.PI/2))+se}function A(Q,se,de,ie){return-de/2*(Math.cos(Math.PI*Q/ie)-1)+se}function O(Q,se,de,ie){return Q===0?se:de*Math.pow(2,10*(Q/ie-1))+se}function U(Q,se,de,ie){return Q===ie?se+de:de*(-Math.pow(2,-10*Q/ie)+1)+se}function Y(Q,se,de,ie){return Q===0?se:Q===ie?se+de:(Q/=ie/2,Q<1?de/2*Math.pow(2,10*(Q-1))+se:de/2*(-Math.pow(2,-10*--Q)+2)+se)}function oe(Q,se,de,ie){return-de*(Math.sqrt(1-(Q/=ie)*Q)-1)+se}function ge(Q,se,de,ie){return de*Math.sqrt(1-(Q=Q/ie-1)*Q)+se}function ze(Q,se,de,ie){return Q/=ie/2,Q<1?-de/2*(Math.sqrt(1-Q*Q)-1)+se:de/2*(Math.sqrt(1-(Q-=2)*Q)+1)+se}function We(Q,se,de,ie){var ve=1.70158,J=0,q=de;if(Q===0)return se;if(Q/=ie,Q===1)return se+de;J||(J=ie*.3);var ce=n(q,de,J,ve);return-g(ce,Q,ie)+se}function at(Q,se,de,ie){var ve=1.70158,J=0,q=de;if(Q===0)return se;if(Q/=ie,Q===1)return se+de;J||(J=ie*.3);var ce=n(q,de,J,ve);return ce.a*Math.pow(2,-10*Q)*Math.sin((Q*ie-ce.s)*(2*Math.PI)/ce.p)+ce.c+se}function _t(Q,se,de,ie){var ve=1.70158,J=0,q=de;if(Q===0)return se;if(Q/=ie/2,Q===2)return se+de;J||(J=ie*(.3*1.5));var ce=n(q,de,J,ve);return Q<1?-.5*g(ce,Q,ie)+se:ce.a*Math.pow(2,-10*(Q-=1))*Math.sin((Q*ie-ce.s)*(2*Math.PI)/ce.p)*.5+ce.c+se}function vt(Q,se,de,ie,ve){return ve===void 0&&(ve=1.70158),de*(Q/=ie)*Q*((ve+1)*Q-ve)+se}function rt(Q,se,de,ie,ve){return ve===void 0&&(ve=1.70158),de*((Q=Q/ie-1)*Q*((ve+1)*Q+ve)+1)+se}function mt(Q,se,de,ie,ve){return ve===void 0&&(ve=1.70158),Q/=ie/2,Q<1?de/2*(Q*Q*(((ve*=1.525)+1)*Q-ve))+se:de/2*((Q-=2)*Q*(((ve*=1.525)+1)*Q+ve)+2)+se}function Qe(Q,se,de,ie){return de-zt(ie-Q,0,de,ie)+se}function zt(Q,se,de,ie){return(Q/=ie)<1/2.75?de*(7.5625*Q*Q)+se:Q<2/2.75?de*(7.5625*(Q-=1.5/2.75)*Q+.75)+se:Q<2.5/2.75?de*(7.5625*(Q-=2.25/2.75)*Q+.9375)+se:de*(7.5625*(Q-=2.625/2.75)*Q+.984375)+se}function Et(Q,se,de,ie){return Q<ie/2?Qe(Q*2,0,de,ie)*.5+se:zt(Q*2-ie,0,de,ie)*.5+de*.5+se}I.util.ease={easeInQuad:function(Q,se,de,ie){return de*(Q/=ie)*Q+se},easeOutQuad:function(Q,se,de,ie){return-de*(Q/=ie)*(Q-2)+se},easeInOutQuad:function(Q,se,de,ie){return Q/=ie/2,Q<1?de/2*Q*Q+se:-de/2*(--Q*(Q-2)-1)+se},easeInCubic:function(Q,se,de,ie){return de*(Q/=ie)*Q*Q+se},easeOutCubic:x,easeInOutCubic:v,easeInQuart:h,easeOutQuart:a,easeInOutQuart:c,easeInQuint:d,easeOutQuint:_,easeInOutQuint:u,easeInSine:C,easeOutSine:S,easeInOutSine:A,easeInExpo:O,easeOutExpo:U,easeInOutExpo:Y,easeInCirc:oe,easeOutCirc:ge,easeInOutCirc:ze,easeInElastic:We,easeOutElastic:at,easeInOutElastic:_t,easeInBack:vt,easeOutBack:rt,easeInOutBack:mt,easeInBounce:Qe,easeOutBounce:zt,easeInOutBounce:Et}}(),function(n){var g=n.fabric||(n.fabric={}),x=g.util.object.extend,v=g.util.object.clone,h=g.util.toFixed,a=g.util.parseUnit,c=g.util.multiplyTransformMatrices,d=["path","circle","polygon","polyline","ellipse","rect","line","image","text"],_=["symbol","image","marker","pattern","view","svg"],u=["pattern","defs","symbol","metadata","clipPath","mask","desc"],C=["symbol","g","a","svg","clipPath","defs"],S={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},A={stroke:"strokeOpacity",fill:"fillOpacity"},O="font-size",U="clip-path";g.svgValidTagNamesRegEx=ge(d),g.svgViewBoxElementsRegEx=ge(_),g.svgInvalidAncestorsRegEx=ge(u),g.svgValidParentsRegEx=ge(C),g.cssRules={},g.gradientDefs={},g.clipPaths={};function Y(J){return J in S?S[J]:J}function oe(J,q,ce,be){var De=Array.isArray(q),Ie;if((J==="fill"||J==="stroke")&&q==="none")q="";else{if(J==="strokeUniform")return q==="non-scaling-stroke";if(J==="strokeDashArray")q==="none"?q=null:q=q.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(J==="transformMatrix")ce&&ce.transformMatrix?q=c(ce.transformMatrix,g.parseTransformAttribute(q)):q=g.parseTransformAttribute(q);else if(J==="visible")q=q!=="none"&&q!=="hidden",ce&&ce.visible===!1&&(q=!1);else if(J==="opacity")q=parseFloat(q),ce&&typeof ce.opacity<"u"&&(q*=ce.opacity);else if(J==="textAnchor")q=q==="start"?"left":q==="end"?"right":"center";else if(J==="charSpacing")Ie=a(q,be)/be*1e3;else if(J==="paintFirst"){var tt=q.indexOf("fill"),ut=q.indexOf("stroke"),q="fill";(tt>-1&&ut>-1&&ut<tt||tt===-1&&ut>-1)&&(q="stroke")}else{if(J==="href"||J==="xlink:href"||J==="font")return q;if(J==="imageSmoothing")return q==="optimizeQuality";Ie=De?q.map(a):a(q,be)}}return!De&&isNaN(Ie)?q:Ie}function ge(J){return new RegExp("^("+J.join("|")+")\\b","i")}function ze(J){for(var q in A)if(!(typeof J[A[q]]>"u"||J[q]==="")){if(typeof J[q]>"u"){if(!g.Object.prototype[q])continue;J[q]=g.Object.prototype[q]}if(J[q].indexOf("url(")!==0){var ce=new g.Color(J[q]);J[q]=ce.setAlpha(h(ce.getAlpha()*J[A[q]],2)).toRgba()}}return J}function We(J,q){var ce,be=[],De,Ie,tt;for(Ie=0,tt=q.length;Ie<tt;Ie++)ce=q[Ie],De=J.getElementsByTagName(ce),be=be.concat(Array.prototype.slice.call(De));return be}g.parseTransformAttribute=function(){function J(He,jt){var qt=g.util.cos(jt[0]),mi=g.util.sin(jt[0]),Di=0,wi=0;jt.length===3&&(Di=jt[1],wi=jt[2]),He[0]=qt,He[1]=mi,He[2]=-mi,He[3]=qt,He[4]=Di-(qt*Di-mi*wi),He[5]=wi-(mi*Di+qt*wi)}function q(He,jt){var qt=jt[0],mi=jt.length===2?jt[1]:jt[0];He[0]=qt,He[3]=mi}function ce(He,jt,qt){He[qt]=Math.tan(g.util.degreesToRadians(jt[0]))}function be(He,jt){He[4]=jt[0],jt.length===2&&(He[5]=jt[1])}var De=g.iMatrix,Ie=g.reNum,tt=g.commaWsp,ut="(?:(skewX)\\s*\\(\\s*("+Ie+")\\s*\\))",nt="(?:(skewY)\\s*\\(\\s*("+Ie+")\\s*\\))",je="(?:(rotate)\\s*\\(\\s*("+Ie+")(?:"+tt+"("+Ie+")"+tt+"("+Ie+"))?\\s*\\))",Ce="(?:(scale)\\s*\\(\\s*("+Ie+")(?:"+tt+"("+Ie+"))?\\s*\\))",Ve="(?:(translate)\\s*\\(\\s*("+Ie+")(?:"+tt+"("+Ie+"))?\\s*\\))",Je="(?:(matrix)\\s*\\(\\s*("+Ie+")"+tt+"("+Ie+")"+tt+"("+Ie+")"+tt+"("+Ie+")"+tt+"("+Ie+")"+tt+"("+Ie+")\\s*\\))",$e="(?:"+Je+"|"+Ve+"|"+Ce+"|"+je+"|"+ut+"|"+nt+")",lt="(?:"+$e+"(?:"+tt+"*"+$e+")*)",ot="^\\s*(?:"+lt+"?)\\s*$",Gt=new RegExp(ot),Xt=new RegExp($e,"g");return function(He){var jt=De.concat(),qt=[];if(!He||He&&!Gt.test(He))return jt;He.replace(Xt,function(Di){var wi=new RegExp($e).exec(Di).filter(function(Ri){return!!Ri}),Ue=wi[1],yt=wi.slice(2).map(parseFloat);switch(Ue){case"translate":be(jt,yt);break;case"rotate":yt[0]=g.util.degreesToRadians(yt[0]),J(jt,yt);break;case"scale":q(jt,yt);break;case"skewX":ce(jt,yt,2);break;case"skewY":ce(jt,yt,1);break;case"matrix":jt=yt;break}qt.push(jt.concat()),jt=De.concat()});for(var mi=qt[0];qt.length>1;)qt.shift(),mi=g.util.multiplyTransformMatrices(mi,qt[0]);return mi}}();function at(J,q){var ce,be;J.replace(/;\s*$/,"").split(";").forEach(function(De){var Ie=De.split(":");ce=Ie[0].trim().toLowerCase(),be=Ie[1].trim(),q[ce]=be})}function _t(J,q){var ce,be;for(var De in J)typeof J[De]>"u"||(ce=De.toLowerCase(),be=J[De],q[ce]=be)}function vt(J,q){var ce={};for(var be in g.cssRules[q])if(rt(J,be.split(" ")))for(var De in g.cssRules[q][be])ce[De]=g.cssRules[q][be][De];return ce}function rt(J,q){var ce,be=!0;return ce=Qe(J,q.pop()),ce&&q.length&&(be=mt(J,q)),ce&&be&&q.length===0}function mt(J,q){for(var ce,be=!0;J.parentNode&&J.parentNode.nodeType===1&&q.length;)be&&(ce=q.pop()),J=J.parentNode,be=Qe(J,ce);return q.length===0}function Qe(J,q){var ce=J.nodeName,be=J.getAttribute("class"),De=J.getAttribute("id"),Ie,tt;if(Ie=new RegExp("^"+ce,"i"),q=q.replace(Ie,""),De&&q.length&&(Ie=new RegExp("#"+De+"(?![a-zA-Z\\-]+)","i"),q=q.replace(Ie,"")),be&&q.length)for(be=be.split(" "),tt=be.length;tt--;)Ie=new RegExp("\\."+be[tt]+"(?![a-zA-Z\\-]+)","i"),q=q.replace(Ie,"");return q.length===0}function zt(J,q){var ce;if(J.getElementById&&(ce=J.getElementById(q)),ce)return ce;var be,De,Ie,tt=J.getElementsByTagName("*");for(De=0,Ie=tt.length;De<Ie;De++)if(be=tt[De],q===be.getAttribute("id"))return be}function Et(J){for(var q=We(J,["use","svg:use"]),ce=0;q.length&&ce<q.length;){var be=q[ce],De=be.getAttribute("xlink:href")||be.getAttribute("href");if(De===null)return;var Ie=De.slice(1),tt=be.getAttribute("x")||0,ut=be.getAttribute("y")||0,nt=zt(J,Ie).cloneNode(!0),je=(nt.getAttribute("transform")||"")+" translate("+tt+", "+ut+")",Ce,Ve=q.length,Je,$e,lt,ot,Gt=g.svgNS;if(se(nt),/^svg$/i.test(nt.nodeName)){var Xt=nt.ownerDocument.createElementNS(Gt,"g");for($e=0,lt=nt.attributes,ot=lt.length;$e<ot;$e++)Je=lt.item($e),Xt.setAttributeNS(Gt,Je.nodeName,Je.nodeValue);for(;nt.firstChild;)Xt.appendChild(nt.firstChild);nt=Xt}for($e=0,lt=be.attributes,ot=lt.length;$e<ot;$e++)Je=lt.item($e),!(Je.nodeName==="x"||Je.nodeName==="y"||Je.nodeName==="xlink:href"||Je.nodeName==="href")&&(Je.nodeName==="transform"?je=Je.nodeValue+" "+je:nt.setAttribute(Je.nodeName,Je.nodeValue));nt.setAttribute("transform",je),nt.setAttribute("instantiated_by_use","1"),nt.removeAttribute("id"),Ce=be.parentNode,Ce.replaceChild(nt,be),q.length===Ve&&ce++}}var Q=new RegExp("^\\s*("+g.reNum+"+)\\s*,?\\s*("+g.reNum+"+)\\s*,?\\s*("+g.reNum+"+)\\s*,?\\s*("+g.reNum+"+)\\s*$");function se(J){if(!g.svgViewBoxElementsRegEx.test(J.nodeName))return{};var q=J.getAttribute("viewBox"),ce=1,be=1,De=0,Ie=0,tt,ut,nt,je,Ce=J.getAttribute("width"),Ve=J.getAttribute("height"),Je=J.getAttribute("x")||0,$e=J.getAttribute("y")||0,lt=J.getAttribute("preserveAspectRatio")||"",ot=!q||!(q=q.match(Q)),Gt=!Ce||!Ve||Ce==="100%"||Ve==="100%",Xt=ot&&Gt,He={},jt="",qt=0,mi=0;if(He.width=0,He.height=0,He.toBeParsed=Xt,ot&&(Je||$e)&&J.parentNode&&J.parentNode.nodeName!=="#document"&&(jt=" translate("+a(Je)+" "+a($e)+") ",nt=(J.getAttribute("transform")||"")+jt,J.setAttribute("transform",nt),J.removeAttribute("x"),J.removeAttribute("y")),Xt)return He;if(ot)return He.width=a(Ce),He.height=a(Ve),He;if(De=-parseFloat(q[1]),Ie=-parseFloat(q[2]),tt=parseFloat(q[3]),ut=parseFloat(q[4]),He.minX=De,He.minY=Ie,He.viewBoxWidth=tt,He.viewBoxHeight=ut,Gt?(He.width=tt,He.height=ut):(He.width=a(Ce),He.height=a(Ve),ce=He.width/tt,be=He.height/ut),lt=g.util.parsePreserveAspectRatioAttribute(lt),lt.alignX!=="none"&&(lt.meetOrSlice==="meet"&&(be=ce=ce>be?be:ce),lt.meetOrSlice==="slice"&&(be=ce=ce>be?ce:be),qt=He.width-tt*ce,mi=He.height-ut*ce,lt.alignX==="Mid"&&(qt/=2),lt.alignY==="Mid"&&(mi/=2),lt.alignX==="Min"&&(qt=0),lt.alignY==="Min"&&(mi=0)),ce===1&&be===1&&De===0&&Ie===0&&Je===0&&$e===0)return He;if((Je||$e)&&J.parentNode.nodeName!=="#document"&&(jt=" translate("+a(Je)+" "+a($e)+") "),nt=jt+" matrix("+ce+" 0 0 "+be+" "+(De*ce+qt)+" "+(Ie*be+mi)+") ",J.nodeName==="svg"){for(je=J.ownerDocument.createElementNS(g.svgNS,"g");J.firstChild;)je.appendChild(J.firstChild);J.appendChild(je)}else je=J,je.removeAttribute("x"),je.removeAttribute("y"),nt=je.getAttribute("transform")+nt;return je.setAttribute("transform",nt),He}function de(J,q){for(;J&&(J=J.parentNode);)if(J.nodeName&&q.test(J.nodeName.replace("svg:",""))&&!J.getAttribute("instantiated_by_use"))return!0;return!1}g.parseSVGDocument=function(J,q,ce,be){if(!!J){Et(J);var De=g.Object.__uid++,Ie,tt,ut=se(J),nt=g.util.toArray(J.getElementsByTagName("*"));if(ut.crossOrigin=be&&be.crossOrigin,ut.svgUid=De,nt.length===0&&g.isLikelyNode){nt=J.selectNodes('//*[name(.)!="svg"]');var je=[];for(Ie=0,tt=nt.length;Ie<tt;Ie++)je[Ie]=nt[Ie];nt=je}var Ce=nt.filter(function(Je){return se(Je),g.svgValidTagNamesRegEx.test(Je.nodeName.replace("svg:",""))&&!de(Je,g.svgInvalidAncestorsRegEx)});if(!Ce||Ce&&!Ce.length){q&&q([],{});return}var Ve={};nt.filter(function(Je){return Je.nodeName.replace("svg:","")==="clipPath"}).forEach(function(Je){var $e=Je.getAttribute("id");Ve[$e]=g.util.toArray(Je.getElementsByTagName("*")).filter(function(lt){return g.svgValidTagNamesRegEx.test(lt.nodeName.replace("svg:",""))})}),g.gradientDefs[De]=g.getGradientDefs(J),g.cssRules[De]=g.getCSSRules(J),g.clipPaths[De]=Ve,g.parseElements(Ce,function(Je,$e){q&&(q(Je,ut,$e,nt),delete g.gradientDefs[De],delete g.cssRules[De],delete g.clipPaths[De])},v(ut),ce,be)}};function ie(J,q){var ce=["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"],be="xlink:href",De=q.getAttribute(be).slice(1),Ie=zt(J,De);if(Ie&&Ie.getAttribute(be)&&ie(J,Ie),ce.forEach(function(ut){Ie&&!q.hasAttribute(ut)&&Ie.hasAttribute(ut)&&q.setAttribute(ut,Ie.getAttribute(ut))}),!q.children.length)for(var tt=Ie.cloneNode(!0);tt.firstChild;)q.appendChild(tt.firstChild);q.removeAttribute(be)}var ve=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+g.reNum+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+g.reNum+"))?\\s+(.*)");x(g,{parseFontDeclaration:function(J,q){var ce=J.match(ve);if(!!ce){var be=ce[1],De=ce[3],Ie=ce[4],tt=ce[5],ut=ce[6];be&&(q.fontStyle=be),De&&(q.fontWeight=isNaN(parseFloat(De))?De:parseFloat(De)),Ie&&(q.fontSize=a(Ie)),ut&&(q.fontFamily=ut),tt&&(q.lineHeight=tt==="normal"?1:tt)}},getGradientDefs:function(J){var q=["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"],ce=We(J,q),be,De=0,Ie={};for(De=ce.length;De--;)be=ce[De],be.getAttribute("xlink:href")&&ie(J,be),Ie[be.getAttribute("id")]=be;return Ie},parseAttributes:function(J,q,ce){if(!!J){var be,De={},Ie,tt;typeof ce>"u"&&(ce=J.getAttribute("svgUid")),J.parentNode&&g.svgValidParentsRegEx.test(J.parentNode.nodeName)&&(De=g.parseAttributes(J.parentNode,q,ce));var ut=q.reduce(function(lt,ot){return be=J.getAttribute(ot),be&&(lt[ot]=be),lt},{}),nt=x(vt(J,ce),g.parseStyleAttribute(J));ut=x(ut,nt),nt[U]&&J.setAttribute(U,nt[U]),Ie=tt=De.fontSize||g.Text.DEFAULT_SVG_FONT_SIZE,ut[O]&&(ut[O]=Ie=a(ut[O],tt));var je,Ce,Ve={};for(var Je in ut)je=Y(Je),Ce=oe(je,ut[Je],De,Ie),Ve[je]=Ce;Ve&&Ve.font&&g.parseFontDeclaration(Ve.font,Ve);var $e=x(De,Ve);return g.svgValidParentsRegEx.test(J.nodeName)?$e:ze($e)}},parseElements:function(J,q,ce,be,De){new g.ElementsParser(J,q,ce,be,De).parse()},parseStyleAttribute:function(J){var q={},ce=J.getAttribute("style");return ce&&(typeof ce=="string"?at(ce,q):_t(ce,q)),q},parsePointsAttribute:function(J){if(!J)return null;J=J.replace(/,/g," ").trim(),J=J.split(/\s+/);var q=[],ce,be;for(ce=0,be=J.length;ce<be;ce+=2)q.push({x:parseFloat(J[ce]),y:parseFloat(J[ce+1])});return q},getCSSRules:function(J){var q=J.getElementsByTagName("style"),ce,be,De={},Ie;for(ce=0,be=q.length;ce<be;ce++){var tt=q[ce].textContent;tt=tt.replace(/\/\*[\s\S]*?\*\//g,""),tt.trim()!==""&&(Ie=tt.split("}"),Ie=Ie.filter(function(ut){return ut.trim()}),Ie.forEach(function(ut){var nt=ut.split("{"),je={},Ce=nt[1].trim(),Ve=Ce.split(";").filter(function(ot){return ot.trim()});for(ce=0,be=Ve.length;ce<be;ce++){var Je=Ve[ce].split(":"),$e=Je[0].trim(),lt=Je[1].trim();je[$e]=lt}ut=nt[0].trim(),ut.split(",").forEach(function(ot){ot=ot.replace(/^svg/i,"").trim(),ot!==""&&(De[ot]?g.util.object.extend(De[ot],je):De[ot]=g.util.object.clone(je))})}))}return De},loadSVGFromURL:function(J,q,ce,be){J=J.replace(/^\n\s*/,"").trim(),new g.util.request(J,{method:"get",onComplete:De});function De(Ie){var tt=Ie.responseXML;if(!tt||!tt.documentElement)return q&&q(null),!1;g.parseSVGDocument(tt.documentElement,function(ut,nt,je,Ce){q&&q(ut,nt,je,Ce)},ce,be)}},loadSVGFromString:function(J,q,ce,be){var De=new g.window.DOMParser,Ie=De.parseFromString(J.trim(),"text/xml");g.parseSVGDocument(Ie.documentElement,function(tt,ut,nt,je){q(tt,ut,nt,je)},ce,be)}})}(Ne),I.ElementsParser=function(n,g,x,v,h,a){this.elements=n,this.callback=g,this.options=x,this.reviver=v,this.svgUid=x&&x.svgUid||0,this.parsingOptions=h,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=a},function(n){n.parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},n.createObjects=function(){var g=this;this.elements.forEach(function(x,v){x.setAttribute("svgUid",g.svgUid),g.createObject(x,v)})},n.findTag=function(g){return I[I.util.string.capitalize(g.tagName.replace("svg:",""))]},n.createObject=function(g,x){var v=this.findTag(g);if(v&&v.fromElement)try{v.fromElement(g,this.createCallback(x,g),this.options)}catch(h){I.log(h)}else this.checkIfDone()},n.createCallback=function(g,x){var v=this;return function(h){var a;v.resolveGradient(h,x,"fill"),v.resolveGradient(h,x,"stroke"),h instanceof I.Image&&h._originalElement&&(a=h.parsePreserveAspectRatioAttribute(x)),h._removeTransformMatrix(a),v.resolveClipPath(h,x),v.reviver&&v.reviver(x,h),v.instances[g]=h,v.checkIfDone()}},n.extractPropertyDefinition=function(g,x,v){var h=g[x],a=this.regexUrl;if(!!a.test(h)){a.lastIndex=0;var c=a.exec(h)[1];return a.lastIndex=0,I[v][this.svgUid][c]}},n.resolveGradient=function(g,x,v){var h=this.extractPropertyDefinition(g,v,"gradientDefs");if(h){var a=x.getAttribute(v+"-opacity"),c=I.Gradient.fromElement(h,g,a,this.options);g.set(v,c)}},n.createClipPathCallback=function(g,x){return function(v){v._removeTransformMatrix(),v.fillRule=v.clipRule,x.push(v)}},n.resolveClipPath=function(g,x){var v=this.extractPropertyDefinition(g,"clipPath","clipPaths"),h,a,c,d,_,u;if(v){d=[],c=I.util.invertTransform(g.calcTransformMatrix());for(var C=v[0].parentNode,S=x;S.parentNode&&S.getAttribute("clip-path")!==g.clipPath;)S=S.parentNode;S.parentNode.appendChild(C);for(var A=0;A<v.length;A++)h=v[A],a=this.findTag(h),a.fromElement(h,this.createClipPathCallback(g,d),this.options);d.length===1?v=d[0]:v=new I.Group(d),_=I.util.multiplyTransformMatrices(c,v.calcTransformMatrix()),v.clipPath&&this.resolveClipPath(v,S);var u=I.util.qrDecompose(_);v.flipX=!1,v.flipY=!1,v.set("scaleX",u.scaleX),v.set("scaleY",u.scaleY),v.angle=u.angle,v.skewX=u.skewX,v.skewY=0,v.setPositionByOrigin({x:u.translateX,y:u.translateY},"center","center"),g.clipPath=v}else delete g.clipPath},n.checkIfDone=function(){--this.numElements===0&&(this.instances=this.instances.filter(function(g){return g!=null}),this.callback(this.instances,this.elements))}}(I.ElementsParser.prototype),function(n){var g=n.fabric||(n.fabric={});if(g.Point){g.warn("fabric.Point is already defined");return}g.Point=x;function x(v,h){this.x=v,this.y=h}x.prototype={type:"point",constructor:x,add:function(v){return new x(this.x+v.x,this.y+v.y)},addEquals:function(v){return this.x+=v.x,this.y+=v.y,this},scalarAdd:function(v){return new x(this.x+v,this.y+v)},scalarAddEquals:function(v){return this.x+=v,this.y+=v,this},subtract:function(v){return new x(this.x-v.x,this.y-v.y)},subtractEquals:function(v){return this.x-=v.x,this.y-=v.y,this},scalarSubtract:function(v){return new x(this.x-v,this.y-v)},scalarSubtractEquals:function(v){return this.x-=v,this.y-=v,this},multiply:function(v){return new x(this.x*v,this.y*v)},multiplyEquals:function(v){return this.x*=v,this.y*=v,this},divide:function(v){return new x(this.x/v,this.y/v)},divideEquals:function(v){return this.x/=v,this.y/=v,this},eq:function(v){return this.x===v.x&&this.y===v.y},lt:function(v){return this.x<v.x&&this.y<v.y},lte:function(v){return this.x<=v.x&&this.y<=v.y},gt:function(v){return this.x>v.x&&this.y>v.y},gte:function(v){return this.x>=v.x&&this.y>=v.y},lerp:function(v,h){return typeof h>"u"&&(h=.5),h=Math.max(Math.min(1,h),0),new x(this.x+(v.x-this.x)*h,this.y+(v.y-this.y)*h)},distanceFrom:function(v){var h=this.x-v.x,a=this.y-v.y;return Math.sqrt(h*h+a*a)},midPointFrom:function(v){return this.lerp(v)},min:function(v){return new x(Math.min(this.x,v.x),Math.min(this.y,v.y))},max:function(v){return new x(Math.max(this.x,v.x),Math.max(this.y,v.y))},toString:function(){return this.x+","+this.y},setXY:function(v,h){return this.x=v,this.y=h,this},setX:function(v){return this.x=v,this},setY:function(v){return this.y=v,this},setFromPoint:function(v){return this.x=v.x,this.y=v.y,this},swap:function(v){var h=this.x,a=this.y;this.x=v.x,this.y=v.y,v.x=h,v.y=a},clone:function(){return new x(this.x,this.y)}}}(Ne),function(n){var g=n.fabric||(n.fabric={});if(g.Intersection){g.warn("fabric.Intersection is already defined");return}function x(v){this.status=v,this.points=[]}g.Intersection=x,g.Intersection.prototype={constructor:x,appendPoint:function(v){return this.points.push(v),this},appendPoints:function(v){return this.points=this.points.concat(v),this}},g.Intersection.intersectLineLine=function(v,h,a,c){var d,_=(c.x-a.x)*(v.y-a.y)-(c.y-a.y)*(v.x-a.x),u=(h.x-v.x)*(v.y-a.y)-(h.y-v.y)*(v.x-a.x),C=(c.y-a.y)*(h.x-v.x)-(c.x-a.x)*(h.y-v.y);if(C!==0){var S=_/C,A=u/C;0<=S&&S<=1&&0<=A&&A<=1?(d=new x("Intersection"),d.appendPoint(new g.Point(v.x+S*(h.x-v.x),v.y+S*(h.y-v.y)))):d=new x}else _===0||u===0?d=new x("Coincident"):d=new x("Parallel");return d},g.Intersection.intersectLinePolygon=function(v,h,a){var c=new x,d=a.length,_,u,C,S;for(S=0;S<d;S++)_=a[S],u=a[(S+1)%d],C=x.intersectLineLine(v,h,_,u),c.appendPoints(C.points);return c.points.length>0&&(c.status="Intersection"),c},g.Intersection.intersectPolygonPolygon=function(v,h){var a=new x,c=v.length,d;for(d=0;d<c;d++){var _=v[d],u=v[(d+1)%c],C=x.intersectLinePolygon(_,u,h);a.appendPoints(C.points)}return a.points.length>0&&(a.status="Intersection"),a},g.Intersection.intersectPolygonRectangle=function(v,h,a){var c=h.min(a),d=h.max(a),_=new g.Point(d.x,c.y),u=new g.Point(c.x,d.y),C=x.intersectLinePolygon(c,_,v),S=x.intersectLinePolygon(_,d,v),A=x.intersectLinePolygon(d,u,v),O=x.intersectLinePolygon(u,c,v),U=new x;return U.appendPoints(C.points),U.appendPoints(S.points),U.appendPoints(A.points),U.appendPoints(O.points),U.points.length>0&&(U.status="Intersection"),U}}(Ne),function(n){var g=n.fabric||(n.fabric={});if(g.Color){g.warn("fabric.Color is already defined.");return}function x(h){h?this._tryParsingColor(h):this.setSource([0,0,0,1])}g.Color=x,g.Color.prototype={_tryParsingColor:function(h){var a;h in x.colorNameMap&&(h=x.colorNameMap[h]),h==="transparent"&&(a=[255,255,255,0]),a||(a=x.sourceFromHex(h)),a||(a=x.sourceFromRgb(h)),a||(a=x.sourceFromHsl(h)),a||(a=[0,0,0,1]),a&&this.setSource(a)},_rgbToHsl:function(h,a,c){h/=255,a/=255,c/=255;var d,_,u,C=g.util.array.max([h,a,c]),S=g.util.array.min([h,a,c]);if(u=(C+S)/2,C===S)d=_=0;else{var A=C-S;switch(_=u>.5?A/(2-C-S):A/(C+S),C){case h:d=(a-c)/A+(a<c?6:0);break;case a:d=(c-h)/A+2;break;case c:d=(h-a)/A+4;break}d/=6}return[Math.round(d*360),Math.round(_*100),Math.round(u*100)]},getSource:function(){return this._source},setSource:function(h){this._source=h},toRgb:function(){var h=this.getSource();return"rgb("+h[0]+","+h[1]+","+h[2]+")"},toRgba:function(){var h=this.getSource();return"rgba("+h[0]+","+h[1]+","+h[2]+","+h[3]+")"},toHsl:function(){var h=this.getSource(),a=this._rgbToHsl(h[0],h[1],h[2]);return"hsl("+a[0]+","+a[1]+"%,"+a[2]+"%)"},toHsla:function(){var h=this.getSource(),a=this._rgbToHsl(h[0],h[1],h[2]);return"hsla("+a[0]+","+a[1]+"%,"+a[2]+"%,"+h[3]+")"},toHex:function(){var h=this.getSource(),a,c,d;return a=h[0].toString(16),a=a.length===1?"0"+a:a,c=h[1].toString(16),c=c.length===1?"0"+c:c,d=h[2].toString(16),d=d.length===1?"0"+d:d,a.toUpperCase()+c.toUpperCase()+d.toUpperCase()},toHexa:function(){var h=this.getSource(),a;return a=Math.round(h[3]*255),a=a.toString(16),a=a.length===1?"0"+a:a,this.toHex()+a.toUpperCase()},getAlpha:function(){return this.getSource()[3]},setAlpha:function(h){var a=this.getSource();return a[3]=h,this.setSource(a),this},toGrayscale:function(){var h=this.getSource(),a=parseInt((h[0]*.3+h[1]*.59+h[2]*.11).toFixed(0),10),c=h[3];return this.setSource([a,a,a,c]),this},toBlackWhite:function(h){var a=this.getSource(),c=(a[0]*.3+a[1]*.59+a[2]*.11).toFixed(0),d=a[3];return h=h||127,c=Number(c)<Number(h)?0:255,this.setSource([c,c,c,d]),this},overlayWith:function(h){h instanceof x||(h=new x(h));var a=[],c=this.getAlpha(),d=.5,_=this.getSource(),u=h.getSource(),C;for(C=0;C<3;C++)a.push(Math.round(_[C]*(1-d)+u[C]*d));return a[3]=c,this.setSource(a),this}},g.Color.reRGBa=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*,\s*(\d{1,3}(?:\.\d+)?\%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,g.Color.reHSLa=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,g.Color.reHex=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i,g.Color.colorNameMap={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"};function v(h,a,c){return c<0&&(c+=1),c>1&&(c-=1),c<1/6?h+(a-h)*6*c:c<1/2?a:c<2/3?h+(a-h)*(2/3-c)*6:h}g.Color.fromRgb=function(h){return x.fromSource(x.sourceFromRgb(h))},g.Color.sourceFromRgb=function(h){var a=h.match(x.reRGBa);if(a){var c=parseInt(a[1],10)/(/%$/.test(a[1])?100:1)*(/%$/.test(a[1])?255:1),d=parseInt(a[2],10)/(/%$/.test(a[2])?100:1)*(/%$/.test(a[2])?255:1),_=parseInt(a[3],10)/(/%$/.test(a[3])?100:1)*(/%$/.test(a[3])?255:1);return[parseInt(c,10),parseInt(d,10),parseInt(_,10),a[4]?parseFloat(a[4]):1]}},g.Color.fromRgba=x.fromRgb,g.Color.fromHsl=function(h){return x.fromSource(x.sourceFromHsl(h))},g.Color.sourceFromHsl=function(h){var a=h.match(x.reHSLa);if(!!a){var c=(parseFloat(a[1])%360+360)%360/360,d=parseFloat(a[2])/(/%$/.test(a[2])?100:1),_=parseFloat(a[3])/(/%$/.test(a[3])?100:1),u,C,S;if(d===0)u=C=S=_;else{var A=_<=.5?_*(d+1):_+d-_*d,O=_*2-A;u=v(O,A,c+1/3),C=v(O,A,c),S=v(O,A,c-1/3)}return[Math.round(u*255),Math.round(C*255),Math.round(S*255),a[4]?parseFloat(a[4]):1]}},g.Color.fromHsla=x.fromHsl,g.Color.fromHex=function(h){return x.fromSource(x.sourceFromHex(h))},g.Color.sourceFromHex=function(h){if(h.match(x.reHex)){var a=h.slice(h.indexOf("#")+1),c=a.length===3||a.length===4,d=a.length===8||a.length===4,_=c?a.charAt(0)+a.charAt(0):a.substring(0,2),u=c?a.charAt(1)+a.charAt(1):a.substring(2,4),C=c?a.charAt(2)+a.charAt(2):a.substring(4,6),S=d?c?a.charAt(3)+a.charAt(3):a.substring(6,8):"FF";return[parseInt(_,16),parseInt(u,16),parseInt(C,16),parseFloat((parseInt(S,16)/255).toFixed(2))]}},g.Color.fromSource=function(h){var a=new x;return a.setSource(h),a}}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=["e","se","s","sw","w","nw","n","ne","e"],v=["ns","nesw","ew","nwse"],h={},a="left",c="top",d="right",_="bottom",u="center",C={top:_,bottom:c,left:d,right:a,center:u},S=g.util.radiansToDegrees,A=Math.sign||function(je){return(je>0)-(je<0)||+je};function O(je,Ce){var Ve=je.angle+S(Math.atan2(Ce.y,Ce.x))+360;return Math.round(Ve%360/45)}function U(je,Ce){var Ve=Ce.transform.target,Je=Ve.canvas,$e=g.util.object.clone(Ce);$e.target=Ve,Je&&Je.fire("object:"+je,$e),Ve.fire(je,Ce)}function Y(je,Ce){var Ve=Ce.canvas,Je=Ve.uniScaleKey,$e=je[Je];return Ve.uniformScaling&&!$e||!Ve.uniformScaling&&$e}function oe(je){return je.originX===u&&je.originY===u}function ge(je,Ce,Ve){var Je=je.lockScalingX,$e=je.lockScalingY;return!!(Je&&$e||!Ce&&(Je||$e)&&Ve||Je&&Ce==="x"||$e&&Ce==="y")}function ze(je,Ce,Ve){var Je="not-allowed",$e=Y(je,Ve),lt="";if(Ce.x!==0&&Ce.y===0?lt="x":Ce.x===0&&Ce.y!==0&&(lt="y"),ge(Ve,lt,$e))return Je;var ot=O(Ve,Ce);return x[ot]+"-resize"}function We(je,Ce,Ve){var Je="not-allowed";if(Ce.x!==0&&Ve.lockSkewingY||Ce.y!==0&&Ve.lockSkewingX)return Je;var $e=O(Ve,Ce)%4;return v[$e]+"-resize"}function at(je,Ce,Ve){return je[Ve.canvas.altActionKey]?h.skewCursorStyleHandler(je,Ce,Ve):h.scaleCursorStyleHandler(je,Ce,Ve)}function _t(je,Ce,Ve){var Je=je[Ve.canvas.altActionKey];if(Ce.x===0)return Je?"skewX":"scaleY";if(Ce.y===0)return Je?"skewY":"scaleX"}function vt(je,Ce,Ve){return Ve.lockRotation?"not-allowed":Ce.cursorStyle}function rt(je,Ce,Ve,Je){return{e:je,transform:Ce,pointer:{x:Ve,y:Je}}}function mt(je){return function(Ce,Ve,Je,$e){var lt=Ve.target,ot=lt.getCenterPoint(),Gt=lt.translateToOriginPoint(ot,Ve.originX,Ve.originY),Xt=je(Ce,Ve,Je,$e);return lt.setPositionByOrigin(Gt,Ve.originX,Ve.originY),Xt}}function Qe(je,Ce){return function(Ve,Je,$e,lt){var ot=Ce(Ve,Je,$e,lt);return ot&&U(je,rt(Ve,Je,$e,lt)),ot}}function zt(je,Ce,Ve,Je,$e){var lt=je.target,ot=lt.controls[je.corner],Gt=lt.canvas.getZoom(),Xt=lt.padding/Gt,He=lt.toLocalPoint(new g.Point(Je,$e),Ce,Ve);return He.x>=Xt&&(He.x-=Xt),He.x<=-Xt&&(He.x+=Xt),He.y>=Xt&&(He.y-=Xt),He.y<=Xt&&(He.y+=Xt),He.x-=ot.offsetX,He.y-=ot.offsetY,He}function Et(je){return je.flipX!==je.flipY}function Q(je,Ce,Ve,Je,$e){if(je[Ce]!==0){var lt=je._getTransformedDimensions()[Je],ot=$e/lt*je[Ve];je.set(Ve,ot)}}function se(je,Ce,Ve,Je){var $e=Ce.target,lt=$e._getTransformedDimensions(0,$e.skewY),ot=zt(Ce,Ce.originX,Ce.originY,Ve,Je),Gt=Math.abs(ot.x*2)-lt.x,Xt=$e.skewX,He;Gt<2?He=0:(He=S(Math.atan2(Gt/$e.scaleX,lt.y/$e.scaleY)),Ce.originX===a&&Ce.originY===_&&(He=-He),Ce.originX===d&&Ce.originY===c&&(He=-He),Et($e)&&(He=-He));var jt=Xt!==He;if(jt){var qt=$e._getTransformedDimensions().y;$e.set("skewX",He),Q($e,"skewY","scaleY","y",qt)}return jt}function de(je,Ce,Ve,Je){var $e=Ce.target,lt=$e._getTransformedDimensions($e.skewX,0),ot=zt(Ce,Ce.originX,Ce.originY,Ve,Je),Gt=Math.abs(ot.y*2)-lt.y,Xt=$e.skewY,He;Gt<2?He=0:(He=S(Math.atan2(Gt/$e.scaleY,lt.x/$e.scaleX)),Ce.originX===a&&Ce.originY===_&&(He=-He),Ce.originX===d&&Ce.originY===c&&(He=-He),Et($e)&&(He=-He));var jt=Xt!==He;if(jt){var qt=$e._getTransformedDimensions().x;$e.set("skewY",He),Q($e,"skewX","scaleX","x",qt)}return jt}function ie(je,Ce,Ve,Je){var $e=Ce.target,lt=$e.skewX,ot,Gt=Ce.originY;if($e.lockSkewingX)return!1;if(lt===0){var Xt=zt(Ce,u,u,Ve,Je);Xt.x>0?ot=a:ot=d}else lt>0&&(ot=Gt===c?a:d),lt<0&&(ot=Gt===c?d:a),Et($e)&&(ot=ot===a?d:a);Ce.originX=ot;var He=Qe("skewing",mt(se));return He(je,Ce,Ve,Je)}function ve(je,Ce,Ve,Je){var $e=Ce.target,lt=$e.skewY,ot,Gt=Ce.originX;if($e.lockSkewingY)return!1;if(lt===0){var Xt=zt(Ce,u,u,Ve,Je);Xt.y>0?ot=c:ot=_}else lt>0&&(ot=Gt===a?c:_),lt<0&&(ot=Gt===a?_:c),Et($e)&&(ot=ot===c?_:c);Ce.originY=ot;var He=Qe("skewing",mt(de));return He(je,Ce,Ve,Je)}function J(je,Ce,Ve,Je){var $e=Ce,lt=$e.target,ot=lt.translateToOriginPoint(lt.getCenterPoint(),$e.originX,$e.originY);if(lt.lockRotation)return!1;var Gt=Math.atan2($e.ey-ot.y,$e.ex-ot.x),Xt=Math.atan2(Je-ot.y,Ve-ot.x),He=S(Xt-Gt+$e.theta),jt=!0;if(lt.snapAngle>0){var qt=lt.snapAngle,mi=lt.snapThreshold||qt,Di=Math.ceil(He/qt)*qt,wi=Math.floor(He/qt)*qt;Math.abs(He-wi)<mi?He=wi:Math.abs(He-Di)<mi&&(He=Di)}return He<0&&(He=360+He),He%=360,jt=lt.angle!==He,lt.angle=He,jt}function q(je,Ce,Ve,Je,$e){$e=$e||{};var lt=Ce.target,ot=lt.lockScalingX,Gt=lt.lockScalingY,Xt=$e.by,He,jt,qt,mi,Di=Y(je,lt),wi=ge(lt,Xt,Di),Ue,yt,Ri=Ce.gestureScale;if(wi)return!1;if(Ri)jt=Ce.scaleX*Ri,qt=Ce.scaleY*Ri;else{if(He=zt(Ce,Ce.originX,Ce.originY,Ve,Je),Ue=Xt!=="y"?A(He.x):1,yt=Xt!=="x"?A(He.y):1,Ce.signX||(Ce.signX=Ue),Ce.signY||(Ce.signY=yt),lt.lockScalingFlip&&(Ce.signX!==Ue||Ce.signY!==yt))return!1;if(mi=lt._getTransformedDimensions(),Di&&!Xt){var Zi=Math.abs(He.x)+Math.abs(He.y),ri=Ce.original,Ei=Math.abs(mi.x*ri.scaleX/lt.scaleX)+Math.abs(mi.y*ri.scaleY/lt.scaleY),dr=Zi/Ei;jt=ri.scaleX*dr,qt=ri.scaleY*dr}else jt=Math.abs(He.x*lt.scaleX/mi.x),qt=Math.abs(He.y*lt.scaleY/mi.y);oe(Ce)&&(jt*=2,qt*=2),Ce.signX!==Ue&&Xt!=="y"&&(Ce.originX=C[Ce.originX],jt*=-1,Ce.signX=Ue),Ce.signY!==yt&&Xt!=="x"&&(Ce.originY=C[Ce.originY],qt*=-1,Ce.signY=yt)}var fr=lt.scaleX,Ki=lt.scaleY;return Xt?(Xt==="x"&&lt.set("scaleX",jt),Xt==="y"&&lt.set("scaleY",qt)):(!ot&&lt.set("scaleX",jt),!Gt&&lt.set("scaleY",qt)),fr!==lt.scaleX||Ki!==lt.scaleY}function ce(je,Ce,Ve,Je){return q(je,Ce,Ve,Je)}function be(je,Ce,Ve,Je){return q(je,Ce,Ve,Je,{by:"x"})}function De(je,Ce,Ve,Je){return q(je,Ce,Ve,Je,{by:"y"})}function Ie(je,Ce,Ve,Je){return je[Ce.target.canvas.altActionKey]?h.skewHandlerX(je,Ce,Ve,Je):h.scalingY(je,Ce,Ve,Je)}function tt(je,Ce,Ve,Je){return je[Ce.target.canvas.altActionKey]?h.skewHandlerY(je,Ce,Ve,Je):h.scalingX(je,Ce,Ve,Je)}function ut(je,Ce,Ve,Je){var $e=Ce.target,lt=zt(Ce,Ce.originX,Ce.originY,Ve,Je),ot=$e.strokeWidth/($e.strokeUniform?$e.scaleX:1),Gt=oe(Ce)?2:1,Xt=$e.width,He=Math.abs(lt.x*Gt/$e.scaleX)-ot;return $e.set("width",Math.max(He,0)),Xt!==He}function nt(je,Ce,Ve,Je){var $e=Ce.target,lt=Ve-Ce.offsetX,ot=Je-Ce.offsetY,Gt=!$e.get("lockMovementX")&&$e.left!==lt,Xt=!$e.get("lockMovementY")&&$e.top!==ot;return Gt&&$e.set("left",lt),Xt&&$e.set("top",ot),(Gt||Xt)&&U("moving",rt(je,Ce,Ve,Je)),Gt||Xt}h.scaleCursorStyleHandler=ze,h.skewCursorStyleHandler=We,h.scaleSkewCursorStyleHandler=at,h.rotationWithSnapping=Qe("rotating",mt(J)),h.scalingEqually=Qe("scaling",mt(ce)),h.scalingX=Qe("scaling",mt(be)),h.scalingY=Qe("scaling",mt(De)),h.scalingYOrSkewingX=Ie,h.scalingXOrSkewingY=tt,h.changeWidth=Qe("resizing",mt(ut)),h.skewHandlerX=ie,h.skewHandlerY=ve,h.dragHandler=nt,h.scaleOrSkewActionName=_t,h.rotationStyleHandler=vt,h.fireEvent=U,h.wrapWithFixedAnchor=mt,h.wrapWithFireEvent=Qe,h.getLocalPoint=zt,g.controlsUtils=h}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.util.degreesToRadians,v=g.controlsUtils;function h(c,d,_,u,C){u=u||{};var S=this.sizeX||u.cornerSize||C.cornerSize,A=this.sizeY||u.cornerSize||C.cornerSize,O=typeof u.transparentCorners<"u"?u.transparentCorners:C.transparentCorners,U=O?"stroke":"fill",Y=!O&&(u.cornerStrokeColor||C.cornerStrokeColor),oe=d,ge=_,ze;c.save(),c.fillStyle=u.cornerColor||C.cornerColor,c.strokeStyle=u.cornerStrokeColor||C.cornerStrokeColor,S>A?(ze=S,c.scale(1,A/S),ge=_*S/A):A>S?(ze=A,c.scale(S/A,1),oe=d*A/S):ze=S,c.lineWidth=1,c.beginPath(),c.arc(oe,ge,ze/2,0,2*Math.PI,!1),c[U](),Y&&c.stroke(),c.restore()}function a(c,d,_,u,C){u=u||{};var S=this.sizeX||u.cornerSize||C.cornerSize,A=this.sizeY||u.cornerSize||C.cornerSize,O=typeof u.transparentCorners<"u"?u.transparentCorners:C.transparentCorners,U=O?"stroke":"fill",Y=!O&&(u.cornerStrokeColor||C.cornerStrokeColor),oe=S/2,ge=A/2;c.save(),c.fillStyle=u.cornerColor||C.cornerColor,c.strokeStyle=u.cornerStrokeColor||C.cornerStrokeColor,c.lineWidth=1,c.translate(d,_),c.rotate(x(C.angle)),c[U+"Rect"](-oe,-ge,S,A),Y&&c.strokeRect(-oe,-ge,S,A),c.restore()}v.renderCircleControl=h,v.renderSquareControl=a}(Ne),function(n){var g=n.fabric||(n.fabric={});function x(v){for(var h in v)this[h]=v[h]}g.Control=x,g.Control.prototype={visible:!0,actionName:"scale",angle:0,x:0,y:0,offsetX:0,offsetY:0,sizeX:null,sizeY:null,touchSizeX:null,touchSizeY:null,cursorStyle:"crosshair",withConnection:!1,actionHandler:function(){},mouseDownHandler:function(){},mouseUpHandler:function(){},getActionHandler:function(){return this.actionHandler},getMouseDownHandler:function(){return this.mouseDownHandler},getMouseUpHandler:function(){return this.mouseUpHandler},cursorStyleHandler:function(v,h){return h.cursorStyle},getActionName:function(v,h){return h.actionName},getVisibility:function(v,h){var a=v._controlsVisibility;return a&&typeof a[h]<"u"?a[h]:this.visible},setVisibility:function(v){this.visible=v},positionHandler:function(v,h){var a=g.util.transformPoint({x:this.x*v.x+this.offsetX,y:this.y*v.y+this.offsetY},h);return a},calcCornerCoords:function(v,h,a,c,d){var _,u,C,S,A=d?this.touchSizeX:this.sizeX,O=d?this.touchSizeY:this.sizeY;if(A&&O&&A!==O){var U=Math.atan2(O,A),Y=Math.sqrt(A*A+O*O)/2,oe=U-g.util.degreesToRadians(v),ge=Math.PI/2-U-g.util.degreesToRadians(v);_=Y*g.util.cos(oe),u=Y*g.util.sin(oe),C=Y*g.util.cos(ge),S=Y*g.util.sin(ge)}else{var ze=A&&O?A:h;Y=ze*.7071067812;var oe=g.util.degreesToRadians(45-v);_=C=Y*g.util.cos(oe),u=S=Y*g.util.sin(oe)}return{tl:{x:a-S,y:c-C},tr:{x:a+_,y:c-u},bl:{x:a-_,y:c+u},br:{x:a+S,y:c+C}}},render:function(v,h,a,c,d){switch(c=c||{},c.cornerStyle||d.cornerStyle){case"circle":g.controlsUtils.renderCircleControl.call(this,v,h,a,c,d);break;default:g.controlsUtils.renderSquareControl.call(this,v,h,a,c,d)}}}}(Ne),function(){function n(a,c){var d=a.getAttribute("style"),_=a.getAttribute("offset")||0,u,C,S,A;if(_=parseFloat(_)/(/%$/.test(_)?100:1),_=_<0?0:_>1?1:_,d){var O=d.split(/\s*;\s*/);for(O[O.length-1]===""&&O.pop(),A=O.length;A--;){var U=O[A].split(/\s*:\s*/),Y=U[0].trim(),oe=U[1].trim();Y==="stop-color"?u=oe:Y==="stop-opacity"&&(S=oe)}}return u||(u=a.getAttribute("stop-color")||"rgb(0,0,0)"),S||(S=a.getAttribute("stop-opacity")),u=new I.Color(u),C=u.getAlpha(),S=isNaN(parseFloat(S))?1:parseFloat(S),S*=C*c,{offset:_,color:u.toRgb(),opacity:S}}function g(a){return{x1:a.getAttribute("x1")||0,y1:a.getAttribute("y1")||0,x2:a.getAttribute("x2")||"100%",y2:a.getAttribute("y2")||0}}function x(a){return{x1:a.getAttribute("fx")||a.getAttribute("cx")||"50%",y1:a.getAttribute("fy")||a.getAttribute("cy")||"50%",r1:0,x2:a.getAttribute("cx")||"50%",y2:a.getAttribute("cy")||"50%",r2:a.getAttribute("r")||"50%"}}var v=I.util.object.clone;I.Gradient=I.util.createClass({offsetX:0,offsetY:0,gradientTransform:null,gradientUnits:"pixels",type:"linear",initialize:function(a){a||(a={}),a.coords||(a.coords={});var c,d=this;Object.keys(a).forEach(function(_){d[_]=a[_]}),this.id?this.id+="_"+I.Object.__uid++:this.id=I.Object.__uid++,c={x1:a.coords.x1||0,y1:a.coords.y1||0,x2:a.coords.x2||0,y2:a.coords.y2||0},this.type==="radial"&&(c.r1=a.coords.r1||0,c.r2=a.coords.r2||0),this.coords=c,this.colorStops=a.colorStops.slice()},addColorStop:function(a){for(var c in a){var d=new I.Color(a[c]);this.colorStops.push({offset:parseFloat(c),color:d.toRgb(),opacity:d.getAlpha()})}return this},toObject:function(a){var c={type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform};return I.util.populateWithProperties(this,c,a),c},toSVG:function(a,C){var d=v(this.coords,!0),_,u,C=C||{},S,A,O=v(this.colorStops,!0),U=d.r1>d.r2,Y=this.gradientTransform?this.gradientTransform.concat():I.iMatrix.concat(),oe=-this.offsetX,ge=-this.offsetY,ze=!!C.additionalTransform,We=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox";if(O.sort(function(mt,Qe){return mt.offset-Qe.offset}),We==="objectBoundingBox"?(oe/=a.width,ge/=a.height):(oe+=a.width/2,ge+=a.height/2),a.type==="path"&&this.gradientUnits!=="percentage"&&(oe-=a.pathOffset.x,ge-=a.pathOffset.y),Y[4]-=oe,Y[5]-=ge,A='id="SVGID_'+this.id+'" gradientUnits="'+We+'"',A+=' gradientTransform="'+(ze?C.additionalTransform+" ":"")+I.util.matrixToSVG(Y)+'" ',this.type==="linear"?S=["<linearGradient ",A,' x1="',d.x1,'" y1="',d.y1,'" x2="',d.x2,'" y2="',d.y2,`">
`]:this.type==="radial"&&(S=["<radialGradient ",A,' cx="',U?d.x1:d.x2,'" cy="',U?d.y1:d.y2,'" r="',U?d.r1:d.r2,'" fx="',U?d.x2:d.x1,'" fy="',U?d.y2:d.y1,`">
`]),this.type==="radial"){if(U)for(O=O.concat(),O.reverse(),_=0,u=O.length;_<u;_++)O[_].offset=1-O[_].offset;var at=Math.min(d.r1,d.r2);if(at>0){var _t=Math.max(d.r1,d.r2),vt=at/_t;for(_=0,u=O.length;_<u;_++)O[_].offset+=vt*(1-O[_].offset)}}for(_=0,u=O.length;_<u;_++){var rt=O[_];S.push("<stop ",'offset="',rt.offset*100+"%",'" style="stop-color:',rt.color,typeof rt.opacity<"u"?";stop-opacity: "+rt.opacity:";",`"/>
`)}return S.push(this.type==="linear"?`</linearGradient>
`:`</radialGradient>
`),S.join("")},toLive:function(a){var c,d=I.util.object.clone(this.coords),_,u;if(!!this.type){for(this.type==="linear"?c=a.createLinearGradient(d.x1,d.y1,d.x2,d.y2):this.type==="radial"&&(c=a.createRadialGradient(d.x1,d.y1,d.r1,d.x2,d.y2,d.r2)),_=0,u=this.colorStops.length;_<u;_++){var C=this.colorStops[_].color,S=this.colorStops[_].opacity,A=this.colorStops[_].offset;typeof S<"u"&&(C=new I.Color(C).setAlpha(S).toRgba()),c.addColorStop(A,C)}return c}}}),I.util.object.extend(I.Gradient,{fromElement:function(a,c,d,_){var u=parseFloat(d)/(/%$/.test(d)?100:1);u=u<0?0:u>1?1:u,isNaN(u)&&(u=1);var C=a.getElementsByTagName("stop"),S,A=a.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage",O=a.getAttribute("gradientTransform")||"",U=[],Y,oe,ge=0,ze=0,We;for(a.nodeName==="linearGradient"||a.nodeName==="LINEARGRADIENT"?(S="linear",Y=g(a)):(S="radial",Y=x(a)),oe=C.length;oe--;)U.push(n(C[oe],u));We=I.parseTransformAttribute(O),h(c,Y,_,A),A==="pixels"&&(ge=-c.left,ze=-c.top);var at=new I.Gradient({id:a.getAttribute("id"),type:S,coords:Y,colorStops:U,gradientUnits:A,gradientTransform:We,offsetX:ge,offsetY:ze});return at}});function h(a,c,d,_){var u,C;Object.keys(c).forEach(function(S){u=c[S],u==="Infinity"?C=1:u==="-Infinity"?C=0:(C=parseFloat(c[S],10),typeof u=="string"&&/^(\d+\.\d+)%|(\d+)%$/.test(u)&&(C*=.01,_==="pixels"&&((S==="x1"||S==="x2"||S==="r2")&&(C*=d.viewBoxWidth||d.width),(S==="y1"||S==="y2")&&(C*=d.viewBoxHeight||d.height)))),c[S]=C})}}(),function(){var n=I.util.toFixed;I.Pattern=I.util.createClass({repeat:"repeat",offsetX:0,offsetY:0,crossOrigin:"",patternTransform:null,initialize:function(g,x){if(g||(g={}),this.id=I.Object.__uid++,this.setOptions(g),!g.source||g.source&&typeof g.source!="string"){x&&x(this);return}else{var v=this;this.source=I.util.createImage(),I.util.loadImage(g.source,function(h,a){v.source=h,x&&x(v,a)},null,this.crossOrigin)}},toObject:function(g){var x=I.Object.NUM_FRACTION_DIGITS,v,h;return typeof this.source.src=="string"?v=this.source.src:typeof this.source=="object"&&this.source.toDataURL&&(v=this.source.toDataURL()),h={type:"pattern",source:v,repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:n(this.offsetX,x),offsetY:n(this.offsetY,x),patternTransform:this.patternTransform?this.patternTransform.concat():null},I.util.populateWithProperties(this,h,g),h},toSVG:function(g){var x=typeof this.source=="function"?this.source():this.source,v=x.width/g.width,h=x.height/g.height,a=this.offsetX/g.width,c=this.offsetY/g.height,d="";return(this.repeat==="repeat-x"||this.repeat==="no-repeat")&&(h=1,c&&(h+=Math.abs(c))),(this.repeat==="repeat-y"||this.repeat==="no-repeat")&&(v=1,a&&(v+=Math.abs(a))),x.src?d=x.src:x.toDataURL&&(d=x.toDataURL()),'<pattern id="SVGID_'+this.id+'" x="'+a+'" y="'+c+'" width="'+v+'" height="'+h+`">
<image x="0" y="0" width="`+x.width+'" height="'+x.height+'" xlink:href="'+d+`"></image>
</pattern>
`},setOptions:function(g){for(var x in g)this[x]=g[x]},toLive:function(g){var x=this.source;return!x||typeof x.src<"u"&&(!x.complete||x.naturalWidth===0||x.naturalHeight===0)?"":g.createPattern(x,this.repeat)}})}(),function(n){var g=n.fabric||(n.fabric={}),x=g.util.toFixed;if(g.Shadow){g.warn("fabric.Shadow is already defined.");return}g.Shadow=g.util.createClass({color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1,initialize:function(v){typeof v=="string"&&(v=this._parseShadow(v));for(var h in v)this[h]=v[h];this.id=g.Object.__uid++},_parseShadow:function(v){var h=v.trim(),a=g.Shadow.reOffsetsAndBlur.exec(h)||[],c=h.replace(g.Shadow.reOffsetsAndBlur,"")||"rgb(0,0,0)";return{color:c.trim(),offsetX:parseFloat(a[1],10)||0,offsetY:parseFloat(a[2],10)||0,blur:parseFloat(a[3],10)||0}},toString:function(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")},toSVG:function(v){var h=40,a=40,c=g.Object.NUM_FRACTION_DIGITS,d=g.util.rotateVector({x:this.offsetX,y:this.offsetY},g.util.degreesToRadians(-v.angle)),_=20,u=new g.Color(this.color);return v.width&&v.height&&(h=x((Math.abs(d.x)+this.blur)/v.width,c)*100+_,a=x((Math.abs(d.y)+this.blur)/v.height,c)*100+_),v.flipX&&(d.x*=-1),v.flipY&&(d.y*=-1),'<filter id="SVGID_'+this.id+'" y="-'+a+'%" height="'+(100+2*a)+'%" x="-'+h+'%" width="'+(100+2*h)+`%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="`+x(this.blur?this.blur/2:0,c)+`"></feGaussianBlur>
	<feOffset dx="`+x(d.x,c)+'" dy="'+x(d.y,c)+`" result="oBlur" ></feOffset>
	<feFlood flood-color="`+u.toRgb()+'" flood-opacity="'+u.getAlpha()+`"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`},toObject:function(){if(this.includeDefaultValues)return{color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};var v={},h=g.Shadow.prototype;return["color","blur","offsetX","offsetY","affectStroke","nonScaling"].forEach(function(a){this[a]!==h[a]&&(v[a]=this[a])},this),v}}),g.Shadow.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/}(Ne),function(){if(I.StaticCanvas){I.warn("fabric.StaticCanvas is already defined.");return}var n=I.util.object.extend,g=I.util.getElementOffset,x=I.util.removeFromArray,v=I.util.toFixed,h=I.util.transformPoint,a=I.util.invertTransform,c=I.util.getNodeCanvas,d=I.util.createCanvasElement,_=new Error("Could not initialize `canvas` element");I.StaticCanvas=I.util.createClass(I.CommonMethods,{initialize:function(u,C){C||(C={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(u,C)},backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:I.iMatrix.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,vptCoords:{},skipOffscreen:!0,clipPath:void 0,_initStatic:function(u,C){var S=this.requestRenderAllBound;this._objects=[],this._createLowerCanvas(u),this._initOptions(C),this.interactive||this._initRetinaScaling(),C.overlayImage&&this.setOverlayImage(C.overlayImage,S),C.backgroundImage&&this.setBackgroundImage(C.backgroundImage,S),C.backgroundColor&&this.setBackgroundColor(C.backgroundColor,S),C.overlayColor&&this.setOverlayColor(C.overlayColor,S),this.calcOffset()},_isRetinaScaling:function(){return I.devicePixelRatio>1&&this.enableRetinaScaling},getRetinaScaling:function(){return this._isRetinaScaling()?Math.max(1,I.devicePixelRatio):1},_initRetinaScaling:function(){if(!!this._isRetinaScaling()){var u=I.devicePixelRatio;this.__initRetinaScaling(u,this.lowerCanvasEl,this.contextContainer),this.upperCanvasEl&&this.__initRetinaScaling(u,this.upperCanvasEl,this.contextTop)}},__initRetinaScaling:function(u,C,S){C.setAttribute("width",this.width*u),C.setAttribute("height",this.height*u),S.scale(u,u)},calcOffset:function(){return this._offset=g(this.lowerCanvasEl),this},setOverlayImage:function(u,C,S){return this.__setBgOverlayImage("overlayImage",u,C,S)},setBackgroundImage:function(u,C,S){return this.__setBgOverlayImage("backgroundImage",u,C,S)},setOverlayColor:function(u,C){return this.__setBgOverlayColor("overlayColor",u,C)},setBackgroundColor:function(u,C){return this.__setBgOverlayColor("backgroundColor",u,C)},__setBgOverlayImage:function(u,C,S,A){return typeof C=="string"?I.util.loadImage(C,function(O,U){if(O){var Y=new I.Image(O,A);this[u]=Y,Y.canvas=this}S&&S(O,U)},this,A&&A.crossOrigin):(A&&C.setOptions(A),this[u]=C,C&&(C.canvas=this),S&&S(C,!1)),this},__setBgOverlayColor:function(u,C,S){return this[u]=C,this._initGradient(C,u),this._initPattern(C,u,S),this},_createCanvasElement:function(){var u=d();if(!u||(u.style||(u.style={}),typeof u.getContext>"u"))throw _;return u},_initOptions:function(u){var C=this.lowerCanvasEl;this._setOptions(u),this.width=this.width||parseInt(C.width,10)||0,this.height=this.height||parseInt(C.height,10)||0,this.lowerCanvasEl.style&&(C.width=this.width,C.height=this.height,C.style.width=this.width+"px",C.style.height=this.height+"px",this.viewportTransform=this.viewportTransform.slice())},_createLowerCanvas:function(u){u&&u.getContext?this.lowerCanvasEl=u:this.lowerCanvasEl=I.util.getById(u)||this._createCanvasElement(),I.util.addClass(this.lowerCanvasEl,"lower-canvas"),this._originalCanvasStyle=this.lowerCanvasEl.style,this.interactive&&this._applyCanvasStyle(this.lowerCanvasEl),this.contextContainer=this.lowerCanvasEl.getContext("2d")},getWidth:function(){return this.width},getHeight:function(){return this.height},setWidth:function(u,C){return this.setDimensions({width:u},C)},setHeight:function(u,C){return this.setDimensions({height:u},C)},setDimensions:function(u,C){var S;C=C||{};for(var A in u)S=u[A],C.cssOnly||(this._setBackstoreDimension(A,u[A]),S+="px",this.hasLostContext=!0),C.backstoreOnly||this._setCssDimension(A,S);return this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop),this._initRetinaScaling(),this.calcOffset(),C.cssOnly||this.requestRenderAll(),this},_setBackstoreDimension:function(u,C){return this.lowerCanvasEl[u]=C,this.upperCanvasEl&&(this.upperCanvasEl[u]=C),this.cacheCanvasEl&&(this.cacheCanvasEl[u]=C),this[u]=C,this},_setCssDimension:function(u,C){return this.lowerCanvasEl.style[u]=C,this.upperCanvasEl&&(this.upperCanvasEl.style[u]=C),this.wrapperEl&&(this.wrapperEl.style[u]=C),this},getZoom:function(){return this.viewportTransform[0]},setViewportTransform:function(u){var C=this._activeObject,S=this.backgroundImage,A=this.overlayImage,O,U,Y;for(this.viewportTransform=u,U=0,Y=this._objects.length;U<Y;U++)O=this._objects[U],O.group||O.setCoords(!0);return C&&C.setCoords(),S&&S.setCoords(!0),A&&A.setCoords(!0),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll(),this},zoomToPoint:function(u,C){var S=u,A=this.viewportTransform.slice(0);u=h(u,a(this.viewportTransform)),A[0]=C,A[3]=C;var O=h(u,A);return A[4]+=S.x-O.x,A[5]+=S.y-O.y,this.setViewportTransform(A)},setZoom:function(u){return this.zoomToPoint(new I.Point(0,0),u),this},absolutePan:function(u){var C=this.viewportTransform.slice(0);return C[4]=-u.x,C[5]=-u.y,this.setViewportTransform(C)},relativePan:function(u){return this.absolutePan(new I.Point(-u.x-this.viewportTransform[4],-u.y-this.viewportTransform[5]))},getElement:function(){return this.lowerCanvasEl},_onObjectAdded:function(u){this.stateful&&u.setupState(),u._set("canvas",this),u.setCoords(),this.fire("object:added",{target:u}),u.fire("added")},_onObjectRemoved:function(u){this.fire("object:removed",{target:u}),u.fire("removed"),delete u.canvas},clearContext:function(u){return u.clearRect(0,0,this.width,this.height),this},getContext:function(){return this.contextContainer},clear:function(){return this.remove.apply(this,this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=null,this._hasITextHandlers=!1),this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll(),this},renderAll:function(){var u=this.contextContainer;return this.renderCanvas(u,this._objects),this},renderAndReset:function(){this.isRendering=0,this.renderAll()},requestRenderAll:function(){return this.isRendering||(this.isRendering=I.util.requestAnimFrame(this.renderAndResetBound)),this},calcViewportBoundaries:function(){var u={},C=this.width,S=this.height,A=a(this.viewportTransform);return u.tl=h({x:0,y:0},A),u.br=h({x:C,y:S},A),u.tr=new I.Point(u.br.x,u.tl.y),u.bl=new I.Point(u.tl.x,u.br.y),this.vptCoords=u,u},cancelRequestedRender:function(){this.isRendering&&(I.util.cancelAnimFrame(this.isRendering),this.isRendering=0)},renderCanvas:function(u,C){var S=this.viewportTransform,A=this.clipPath;this.cancelRequestedRender(),this.calcViewportBoundaries(),this.clearContext(u),I.util.setImageSmoothing(u,this.imageSmoothingEnabled),this.fire("before:render",{ctx:u}),this._renderBackground(u),u.save(),u.transform(S[0],S[1],S[2],S[3],S[4],S[5]),this._renderObjects(u,C),u.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(u),A&&(A.canvas=this,A.shouldCache(),A._transformDone=!0,A.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(u)),this._renderOverlay(u),this.controlsAboveOverlay&&this.interactive&&this.drawControls(u),this.fire("after:render",{ctx:u})},drawClipPathOnCanvas:function(u){var C=this.viewportTransform,S=this.clipPath;u.save(),u.transform(C[0],C[1],C[2],C[3],C[4],C[5]),u.globalCompositeOperation="destination-in",S.transform(u),u.scale(1/S.zoomX,1/S.zoomY),u.drawImage(S._cacheCanvas,-S.cacheTranslationX,-S.cacheTranslationY),u.restore()},_renderObjects:function(u,C){var S,A;for(S=0,A=C.length;S<A;++S)C[S]&&C[S].render(u)},_renderBackgroundOrOverlay:function(u,C){var S=this[C+"Color"],A=this[C+"Image"],O=this.viewportTransform,U=this[C+"Vpt"];if(!(!S&&!A)){if(S){u.save(),u.beginPath(),u.moveTo(0,0),u.lineTo(this.width,0),u.lineTo(this.width,this.height),u.lineTo(0,this.height),u.closePath(),u.fillStyle=S.toLive?S.toLive(u,this):S,U&&u.transform(O[0],O[1],O[2],O[3],O[4],O[5]),u.transform(1,0,0,1,S.offsetX||0,S.offsetY||0);var Y=S.gradientTransform||S.patternTransform;Y&&u.transform(Y[0],Y[1],Y[2],Y[3],Y[4],Y[5]),u.fill(),u.restore()}A&&(u.save(),U&&u.transform(O[0],O[1],O[2],O[3],O[4],O[5]),A.render(u),u.restore())}},_renderBackground:function(u){this._renderBackgroundOrOverlay(u,"background")},_renderOverlay:function(u){this._renderBackgroundOrOverlay(u,"overlay")},getCenter:function(){return{top:this.height/2,left:this.width/2}},getCenterPoint:function(){return new I.Point(this.width/2,this.height/2)},centerObjectH:function(u){return this._centerObject(u,new I.Point(this.getCenterPoint().x,u.getCenterPoint().y))},centerObjectV:function(u){return this._centerObject(u,new I.Point(u.getCenterPoint().x,this.getCenterPoint().y))},centerObject:function(u){var C=this.getCenterPoint();return this._centerObject(u,C)},viewportCenterObject:function(u){var C=this.getVpCenter();return this._centerObject(u,C)},viewportCenterObjectH:function(u){var C=this.getVpCenter();return this._centerObject(u,new I.Point(C.x,u.getCenterPoint().y)),this},viewportCenterObjectV:function(u){var C=this.getVpCenter();return this._centerObject(u,new I.Point(u.getCenterPoint().x,C.y))},getVpCenter:function(){var u=this.getCenterPoint(),C=a(this.viewportTransform);return h(u,C)},_centerObject:function(u,C){return u.setPositionByOrigin(C,"center","center"),u.setCoords(),this.renderOnAddRemove&&this.requestRenderAll(),this},toDatalessJSON:function(u){return this.toDatalessObject(u)},toObject:function(u){return this._toObjectMethod("toObject",u)},toDatalessObject:function(u){return this._toObjectMethod("toDatalessObject",u)},_toObjectMethod:function(u,C){var S=this.clipPath,A={version:I.version,objects:this._toObjects(u,C)};return S&&!S.excludeFromExport&&(A.clipPath=this._toObject(this.clipPath,u,C)),n(A,this.__serializeBgOverlay(u,C)),I.util.populateWithProperties(this,A,C),A},_toObjects:function(u,C){return this._objects.filter(function(S){return!S.excludeFromExport}).map(function(S){return this._toObject(S,u,C)},this)},_toObject:function(u,C,S){var A;this.includeDefaultValues||(A=u.includeDefaultValues,u.includeDefaultValues=!1);var O=u[C](S);return this.includeDefaultValues||(u.includeDefaultValues=A),O},__serializeBgOverlay:function(u,C){var S={},A=this.backgroundImage,O=this.overlayImage,U=this.backgroundColor,Y=this.overlayColor;return U&&U.toObject?U.excludeFromExport||(S.background=U.toObject(C)):U&&(S.background=U),Y&&Y.toObject?Y.excludeFromExport||(S.overlay=Y.toObject(C)):Y&&(S.overlay=Y),A&&!A.excludeFromExport&&(S.backgroundImage=this._toObject(A,u,C)),O&&!O.excludeFromExport&&(S.overlayImage=this._toObject(O,u,C)),S},svgViewportTransformation:!0,toSVG:function(u,C){u||(u={}),u.reviver=C;var S=[];return this._setSVGPreamble(S,u),this._setSVGHeader(S,u),this.clipPath&&S.push('<g clip-path="url(#'+this.clipPath.clipPathId+`)" >
`),this._setSVGBgOverlayColor(S,"background"),this._setSVGBgOverlayImage(S,"backgroundImage",C),this._setSVGObjects(S,C),this.clipPath&&S.push(`</g>
`),this._setSVGBgOverlayColor(S,"overlay"),this._setSVGBgOverlayImage(S,"overlayImage",C),S.push("</svg>"),S.join("")},_setSVGPreamble:function(u,C){C.suppressPreamble||u.push('<?xml version="1.0" encoding="',C.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)},_setSVGHeader:function(u,C){var S=C.width||this.width,A=C.height||this.height,O,U='viewBox="0 0 '+this.width+" "+this.height+'" ',Y=I.Object.NUM_FRACTION_DIGITS;C.viewBox?U='viewBox="'+C.viewBox.x+" "+C.viewBox.y+" "+C.viewBox.width+" "+C.viewBox.height+'" ':this.svgViewportTransformation&&(O=this.viewportTransform,U='viewBox="'+v(-O[4]/O[0],Y)+" "+v(-O[5]/O[3],Y)+" "+v(this.width/O[0],Y)+" "+v(this.height/O[3],Y)+'" '),u.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',S,'" ','height="',A,'" ',U,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",I.version,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(C),`</defs>
`)},createSVGClipPathMarkup:function(u){var C=this.clipPath;return C?(C.clipPathId="CLIPPATH_"+I.Object.__uid++,'<clipPath id="'+C.clipPathId+`" >
`+this.clipPath.toClipPathSVG(u.reviver)+`</clipPath>
`):""},createSVGRefElementsMarkup:function(){var u=this,C=["background","overlay"].map(function(S){var A=u[S+"Color"];if(A&&A.toLive){var O=u[S+"Vpt"],U=u.viewportTransform,Y={width:u.width/(O?U[0]:1),height:u.height/(O?U[3]:1)};return A.toSVG(Y,{additionalTransform:O?I.util.matrixToSVG(U):""})}});return C.join("")},createSVGFontFacesMarkup:function(){var u="",C={},S,A,O,U,Y,oe,ge,ze,We,at=I.fontPaths,_t=[];for(this._objects.forEach(function rt(mt){_t.push(mt),mt._objects&&mt._objects.forEach(rt)}),ze=0,We=_t.length;ze<We;ze++)if(S=_t[ze],A=S.fontFamily,!(S.type.indexOf("text")===-1||C[A]||!at[A])&&(C[A]=!0,!!S.styles)){O=S.styles;for(Y in O){U=O[Y];for(ge in U)oe=U[ge],A=oe.fontFamily,!C[A]&&at[A]&&(C[A]=!0)}}for(var vt in C)u+=[`		@font-face {
`,"			font-family: '",vt,`';
`,"			src: url('",at[vt],`');
`,`		}
`].join("");return u&&(u=['	<style type="text/css">',`<![CDATA[
`,u,"]]>",`</style>
`].join("")),u},_setSVGObjects:function(u,C){var S,A,O,U=this._objects;for(A=0,O=U.length;A<O;A++)S=U[A],!S.excludeFromExport&&this._setSVGObject(u,S,C)},_setSVGObject:function(u,C,S){u.push(C.toSVG(S))},_setSVGBgOverlayImage:function(u,C,S){this[C]&&!this[C].excludeFromExport&&this[C].toSVG&&u.push(this[C].toSVG(S))},_setSVGBgOverlayColor:function(u,C){var S=this[C+"Color"],A=this.viewportTransform,O=this.width,U=this.height;if(!!S)if(S.toLive){var Y=S.repeat,oe=I.util.invertTransform(A),ge=this[C+"Vpt"],ze=ge?I.util.matrixToSVG(oe):"";u.push('<rect transform="'+ze+" translate(",O/2,",",U/2,')"',' x="',S.offsetX-O/2,'" y="',S.offsetY-U/2,'" ','width="',Y==="repeat-y"||Y==="no-repeat"?S.source.width:O,'" height="',Y==="repeat-x"||Y==="no-repeat"?S.source.height:U,'" fill="url(#SVGID_'+S.id+')"',`></rect>
`)}else u.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',S,'"',`></rect>
`)},sendToBack:function(u){if(!u)return this;var C=this._activeObject,S,A,O;if(u===C&&u.type==="activeSelection")for(O=C._objects,S=O.length;S--;)A=O[S],x(this._objects,A),this._objects.unshift(A);else x(this._objects,u),this._objects.unshift(u);return this.renderOnAddRemove&&this.requestRenderAll(),this},bringToFront:function(u){if(!u)return this;var C=this._activeObject,S,A,O;if(u===C&&u.type==="activeSelection")for(O=C._objects,S=0;S<O.length;S++)A=O[S],x(this._objects,A),this._objects.push(A);else x(this._objects,u),this._objects.push(u);return this.renderOnAddRemove&&this.requestRenderAll(),this},sendBackwards:function(u,C){if(!u)return this;var S=this._activeObject,A,O,U,Y,oe,ge=0;if(u===S&&u.type==="activeSelection")for(oe=S._objects,A=0;A<oe.length;A++)O=oe[A],U=this._objects.indexOf(O),U>0+ge&&(Y=U-1,x(this._objects,O),this._objects.splice(Y,0,O)),ge++;else U=this._objects.indexOf(u),U!==0&&(Y=this._findNewLowerIndex(u,U,C),x(this._objects,u),this._objects.splice(Y,0,u));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewLowerIndex:function(u,C,S){var A,O;if(S)for(A=C,O=C-1;O>=0;--O){var U=u.intersectsWithObject(this._objects[O])||u.isContainedWithinObject(this._objects[O])||this._objects[O].isContainedWithinObject(u);if(U){A=O;break}}else A=C-1;return A},bringForward:function(u,C){if(!u)return this;var S=this._activeObject,A,O,U,Y,oe,ge=0;if(u===S&&u.type==="activeSelection")for(oe=S._objects,A=oe.length;A--;)O=oe[A],U=this._objects.indexOf(O),U<this._objects.length-1-ge&&(Y=U+1,x(this._objects,O),this._objects.splice(Y,0,O)),ge++;else U=this._objects.indexOf(u),U!==this._objects.length-1&&(Y=this._findNewUpperIndex(u,U,C),x(this._objects,u),this._objects.splice(Y,0,u));return this.renderOnAddRemove&&this.requestRenderAll(),this},_findNewUpperIndex:function(u,C,S){var A,O,U;if(S)for(A=C,O=C+1,U=this._objects.length;O<U;++O){var Y=u.intersectsWithObject(this._objects[O])||u.isContainedWithinObject(this._objects[O])||this._objects[O].isContainedWithinObject(u);if(Y){A=O;break}}else A=C+1;return A},moveTo:function(u,C){return x(this._objects,u),this._objects.splice(C,0,u),this.renderOnAddRemove&&this.requestRenderAll()},dispose:function(){return this.isRendering&&(I.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.forEachObject(function(u){u.dispose&&u.dispose()}),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this._iTextInstances=null,this.contextContainer=null,this.lowerCanvasEl.classList.remove("lower-canvas"),I.util.setStyle(this.lowerCanvasEl,this._originalCanvasStyle),delete this._originalCanvasStyle,this.lowerCanvasEl.setAttribute("width",this.width),this.lowerCanvasEl.setAttribute("height",this.height),I.util.cleanUpJsdomNode(this.lowerCanvasEl),this.lowerCanvasEl=void 0,this},toString:function(){return"#<fabric.Canvas ("+this.complexity()+"): { objects: "+this._objects.length+" }>"}}),n(I.StaticCanvas.prototype,I.Observable),n(I.StaticCanvas.prototype,I.Collection),n(I.StaticCanvas.prototype,I.DataURLExporter),n(I.StaticCanvas,{EMPTY_JSON:'{"objects": [], "background": "white"}',supports:function(u){var C=d();if(!C||!C.getContext)return null;var S=C.getContext("2d");if(!S)return null;switch(u){case"setLineDash":return typeof S.setLineDash<"u";default:return null}}}),I.StaticCanvas.prototype.toJSON=I.StaticCanvas.prototype.toObject,I.isLikelyNode&&(I.StaticCanvas.prototype.createPNGStream=function(){var u=c(this.lowerCanvasEl);return u&&u.createPNGStream()},I.StaticCanvas.prototype.createJPEGStream=function(u){var C=c(this.lowerCanvasEl);return C&&C.createJPEGStream(u)})}(),I.BaseBrush=I.util.createClass({color:"rgb(0, 0, 0)",width:1,shadow:null,strokeLineCap:"round",strokeLineJoin:"round",strokeMiterLimit:10,strokeDashArray:null,limitedToCanvasSize:!1,_setBrushStyles:function(n){n.strokeStyle=this.color,n.lineWidth=this.width,n.lineCap=this.strokeLineCap,n.miterLimit=this.strokeMiterLimit,n.lineJoin=this.strokeLineJoin,n.setLineDash(this.strokeDashArray||[])},_saveAndTransform:function(n){var g=this.canvas.viewportTransform;n.save(),n.transform(g[0],g[1],g[2],g[3],g[4],g[5])},_setShadow:function(){if(!!this.shadow){var n=this.canvas,g=this.shadow,x=n.contextTop,v=n.getZoom();n&&n._isRetinaScaling()&&(v*=I.devicePixelRatio),x.shadowColor=g.color,x.shadowBlur=g.blur*v,x.shadowOffsetX=g.offsetX*v,x.shadowOffsetY=g.offsetY*v}},needsFullRender:function(){var n=new I.Color(this.color);return n.getAlpha()<1||!!this.shadow},_resetShadow:function(){var n=this.canvas.contextTop;n.shadowColor="",n.shadowBlur=n.shadowOffsetX=n.shadowOffsetY=0},_isOutSideCanvas:function(n){return n.x<0||n.x>this.canvas.getWidth()||n.y<0||n.y>this.canvas.getHeight()}}),function(){I.PencilBrush=I.util.createClass(I.BaseBrush,{decimate:.4,drawStraightLine:!1,straightLineKey:"shiftKey",initialize:function(n){this.canvas=n,this._points=[]},needsFullRender:function(){return this.callSuper("needsFullRender")||this._hasStraightLine},_drawSegment:function(n,g,x){var v=g.midPointFrom(x);return n.quadraticCurveTo(g.x,g.y,v.x,v.y),v},onMouseDown:function(n,g){!this.canvas._isMainEvent(g.e)||(this.drawStraightLine=g.e[this.straightLineKey],this._prepareForDrawing(n),this._captureDrawingPath(n),this._render())},onMouseMove:function(n,g){if(!!this.canvas._isMainEvent(g.e)&&(this.drawStraightLine=g.e[this.straightLineKey],!(this.limitedToCanvasSize===!0&&this._isOutSideCanvas(n))&&this._captureDrawingPath(n)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{var x=this._points,v=x.length,h=this.canvas.contextTop;this._saveAndTransform(h),this.oldEnd&&(h.beginPath(),h.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(h,x[v-2],x[v-1],!0),h.stroke(),h.restore()}},onMouseUp:function(n){return this.canvas._isMainEvent(n.e)?(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1):!0},_prepareForDrawing:function(n){var g=new I.Point(n.x,n.y);this._reset(),this._addPoint(g),this.canvas.contextTop.moveTo(g.x,g.y)},_addPoint:function(n){return this._points.length>1&&n.eq(this._points[this._points.length-1])?!1:(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(n),!0)},_reset:function(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1},_captureDrawingPath:function(n){var g=new I.Point(n.x,n.y);return this._addPoint(g)},_render:function(n){var g,x,v=this._points[0],h=this._points[1];if(n=n||this.canvas.contextTop,this._saveAndTransform(n),n.beginPath(),this._points.length===2&&v.x===h.x&&v.y===h.y){var a=this.width/1e3;v=new I.Point(v.x,v.y),h=new I.Point(h.x,h.y),v.x-=a,h.x+=a}for(n.moveTo(v.x,v.y),g=1,x=this._points.length;g<x;g++)this._drawSegment(n,v,h),v=this._points[g],h=this._points[g+1];n.lineTo(v.x,v.y),n.stroke(),n.restore()},convertPointsToSVGPath:function(n){var g=this.width/1e3;return I.util.getSmoothPathFromPoints(n,g)},_isEmptySVGPath:function(n){var g=I.util.joinPath(n);return g==="M 0 0 Q 0 0 0 0 L 0 0"},createPath:function(n){var g=new I.Path(n,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,g.shadow=new I.Shadow(this.shadow)),g},decimatePoints:function(n,g){if(n.length<=2)return n;var x=this.canvas.getZoom(),v=Math.pow(g/x,2),h,a=n.length-1,c=n[0],d=[c],_;for(h=1;h<a-1;h++)_=Math.pow(c.x-n[h].x,2)+Math.pow(c.y-n[h].y,2),_>=v&&(c=n[h],d.push(c));return d.push(n[a]),d},_finalizeAndAddPath:function(){var n=this.canvas.contextTop;n.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));var g=this.convertPointsToSVGPath(this._points);if(this._isEmptySVGPath(g)){this.canvas.requestRenderAll();return}var x=this.createPath(g);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:x}),this.canvas.add(x),this.canvas.requestRenderAll(),x.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:x})}})}(),I.CircleBrush=I.util.createClass(I.BaseBrush,{width:10,initialize:function(n){this.canvas=n,this.points=[]},drawDot:function(n){var g=this.addPoint(n),x=this.canvas.contextTop;this._saveAndTransform(x),this.dot(x,g),x.restore()},dot:function(n,g){n.fillStyle=g.fill,n.beginPath(),n.arc(g.x,g.y,g.radius,0,Math.PI*2,!1),n.closePath(),n.fill()},onMouseDown:function(n){this.points.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(n)},_render:function(){var n=this.canvas.contextTop,g,x,v=this.points;for(this._saveAndTransform(n),g=0,x=v.length;g<x;g++)this.dot(n,v[g]);n.restore()},onMouseMove:function(n){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(n)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(n),this._render()):this.drawDot(n))},onMouseUp:function(){var n=this.canvas.renderOnAddRemove,g,x;this.canvas.renderOnAddRemove=!1;var v=[];for(g=0,x=this.points.length;g<x;g++){var h=this.points[g],a=new I.Circle({radius:h.radius,left:h.x,top:h.y,originX:"center",originY:"center",fill:h.fill});this.shadow&&(a.shadow=new I.Shadow(this.shadow)),v.push(a)}var c=new I.Group(v);c.canvas=this.canvas,this.canvas.fire("before:path:created",{path:c}),this.canvas.add(c),this.canvas.fire("path:created",{path:c}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=n,this.canvas.requestRenderAll()},addPoint:function(n){var g=new I.Point(n.x,n.y),x=I.util.getRandomInt(Math.max(0,this.width-20),this.width+20)/2,v=new I.Color(this.color).setAlpha(I.util.getRandomInt(0,100)/100).toRgba();return g.radius=x,g.fill=v,this.points.push(g),g}}),I.SprayBrush=I.util.createClass(I.BaseBrush,{width:10,density:20,dotWidth:1,dotWidthVariance:1,randomOpacity:!1,optimizeOverlapping:!0,initialize:function(n){this.canvas=n,this.sprayChunks=[]},onMouseDown:function(n){this.sprayChunks.length=0,this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(n),this.render(this.sprayChunkPoints)},onMouseMove:function(n){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(n)||(this.addSprayChunk(n),this.render(this.sprayChunkPoints))},onMouseUp:function(){var n=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;for(var g=[],x=0,v=this.sprayChunks.length;x<v;x++)for(var h=this.sprayChunks[x],a=0,c=h.length;a<c;a++){var d=new I.Rect({width:h[a].width,height:h[a].width,left:h[a].x+1,top:h[a].y+1,originX:"center",originY:"center",fill:this.color});g.push(d)}this.optimizeOverlapping&&(g=this._getOptimizedRects(g));var _=new I.Group(g);this.shadow&&_.set("shadow",new I.Shadow(this.shadow)),this.canvas.fire("before:path:created",{path:_}),this.canvas.add(_),this.canvas.fire("path:created",{path:_}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=n,this.canvas.requestRenderAll()},_getOptimizedRects:function(n){var g={},x,v,h;for(v=0,h=n.length;v<h;v++)x=n[v].left+""+n[v].top,g[x]||(g[x]=n[v]);var a=[];for(x in g)a.push(g[x]);return a},render:function(n){var g=this.canvas.contextTop,x,v;for(g.fillStyle=this.color,this._saveAndTransform(g),x=0,v=n.length;x<v;x++){var h=n[x];typeof h.opacity<"u"&&(g.globalAlpha=h.opacity),g.fillRect(h.x,h.y,h.width,h.width)}g.restore()},_render:function(){var n=this.canvas.contextTop,g,x;for(n.fillStyle=this.color,this._saveAndTransform(n),g=0,x=this.sprayChunks.length;g<x;g++)this.render(this.sprayChunks[g]);n.restore()},addSprayChunk:function(n){this.sprayChunkPoints=[];var g,x,v,h=this.width/2,a;for(a=0;a<this.density;a++){g=I.util.getRandomInt(n.x-h,n.x+h),x=I.util.getRandomInt(n.y-h,n.y+h),this.dotWidthVariance?v=I.util.getRandomInt(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):v=this.dotWidth;var c=new I.Point(g,x);c.width=v,this.randomOpacity&&(c.opacity=I.util.getRandomInt(0,100)/100),this.sprayChunkPoints.push(c)}this.sprayChunks.push(this.sprayChunkPoints)}}),I.PatternBrush=I.util.createClass(I.PencilBrush,{getPatternSrc:function(){var n=20,g=5,x=I.util.createCanvasElement(),v=x.getContext("2d");return x.width=x.height=n+g,v.fillStyle=this.color,v.beginPath(),v.arc(n/2,n/2,n/2,0,Math.PI*2,!1),v.closePath(),v.fill(),x},getPatternSrcFunction:function(){return String(this.getPatternSrc).replace("this.color",'"'+this.color+'"')},getPattern:function(n){return n.createPattern(this.source||this.getPatternSrc(),"repeat")},_setBrushStyles:function(n){this.callSuper("_setBrushStyles",n),n.strokeStyle=this.getPattern(n)},createPath:function(n){var g=this.callSuper("createPath",n),x=g._getLeftTopCoords().scalarAdd(g.strokeWidth/2);return g.stroke=new I.Pattern({source:this.source||this.getPatternSrcFunction(),offsetX:-x.x,offsetY:-x.y}),g}}),function(){var n=I.util.getPointer,g=I.util.degreesToRadians,x=I.util.isTouchEvent;I.Canvas=I.util.createClass(I.StaticCanvas,{initialize:function(h,a){a||(a={}),this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(h,a),this._initInteractive(),this._createCacheCanvas()},uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",interactive:!0,selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,isDrawingMode:!1,preserveObjectStacking:!1,snapAngle:0,snapThreshold:null,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,targets:[],enablePointerEvents:!1,_hoveredTarget:null,_hoveredTargets:[],_initInteractive:function(){this._currentTransform=null,this._groupSelector=null,this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._initRetinaScaling(),this.freeDrawingBrush=I.PencilBrush&&new I.PencilBrush(this),this.calcOffset()},_chooseObjectsToRender:function(){var h=this.getActiveObjects(),a,c,d;if(h.length>0&&!this.preserveObjectStacking){c=[],d=[];for(var _=0,u=this._objects.length;_<u;_++)a=this._objects[_],h.indexOf(a)===-1?c.push(a):d.push(a);h.length>1&&(this._activeObject._objects=d),c.push.apply(c,d)}else c=this._objects;return c},renderAll:function(){this.contextTopDirty&&!this._groupSelector&&!this.isDrawingMode&&(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1);var h=this.contextContainer;return this.renderCanvas(h,this._chooseObjectsToRender()),this},renderTopLayer:function(h){h.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(h),this.contextTopDirty=!0),h.restore()},renderTop:function(){var h=this.contextTop;return this.clearContext(h),this.renderTopLayer(h),this.fire("after:render"),this},_normalizePointer:function(h,a){var c=h.calcTransformMatrix(),d=I.util.invertTransform(c),_=this.restorePointerVpt(a);return I.util.transformPoint(_,d)},isTargetTransparent:function(h,a,c){if(h.shouldCache()&&h._cacheCanvas&&h!==this._activeObject){var d=this._normalizePointer(h,{x:a,y:c}),_=Math.max(h.cacheTranslationX+d.x*h.zoomX,0),u=Math.max(h.cacheTranslationY+d.y*h.zoomY,0),O=I.util.isTransparent(h._cacheContext,Math.round(_),Math.round(u),this.targetFindTolerance);return O}var C=this.contextCache,S=h.selectionBackgroundColor,A=this.viewportTransform;h.selectionBackgroundColor="",this.clearContext(C),C.save(),C.transform(A[0],A[1],A[2],A[3],A[4],A[5]),h.render(C),C.restore(),h.selectionBackgroundColor=S;var O=I.util.isTransparent(C,a,c,this.targetFindTolerance);return O},_isSelectionKeyPressed:function(h){var a=!1;return Array.isArray(this.selectionKey)?a=!!this.selectionKey.find(function(c){return h[c]===!0}):a=h[this.selectionKey],a},_shouldClearSelection:function(h,a){var c=this.getActiveObjects(),d=this._activeObject;return!a||a&&d&&c.length>1&&c.indexOf(a)===-1&&d!==a&&!this._isSelectionKeyPressed(h)||a&&!a.evented||a&&!a.selectable&&d&&d!==a},_shouldCenterTransform:function(h,a,c){if(!!h){var d;return a==="scale"||a==="scaleX"||a==="scaleY"||a==="resizing"?d=this.centeredScaling||h.centeredScaling:a==="rotate"&&(d=this.centeredRotation||h.centeredRotation),d?!c:c}},_getOriginFromCorner:function(h,a){var c={x:h.originX,y:h.originY};return a==="ml"||a==="tl"||a==="bl"?c.x="right":(a==="mr"||a==="tr"||a==="br")&&(c.x="left"),a==="tl"||a==="mt"||a==="tr"?c.y="bottom":(a==="bl"||a==="mb"||a==="br")&&(c.y="top"),c},_getActionFromCorner:function(h,a,c,d){if(!a||!h)return"drag";var _=d.controls[a];return _.getActionName(c,_,d)},_setupCurrentTransform:function(h,a,c){if(!!a){var d=this.getPointer(h),_=a.__corner,u=a.controls[_],C=c&&_?u.getActionHandler(h,a,u):I.controlsUtils.dragHandler,S=this._getActionFromCorner(c,_,h,a),A=this._getOriginFromCorner(a,_),O=h[this.centeredKey],U={target:a,action:S,actionHandler:C,corner:_,scaleX:a.scaleX,scaleY:a.scaleY,skewX:a.skewX,skewY:a.skewY,offsetX:d.x-a.left,offsetY:d.y-a.top,originX:A.x,originY:A.y,ex:d.x,ey:d.y,lastX:d.x,lastY:d.y,theta:g(a.angle),width:a.width*a.scaleX,shiftKey:h.shiftKey,altKey:O,original:I.util.saveObjectTransform(a)};this._shouldCenterTransform(a,S,O)&&(U.originX="center",U.originY="center"),U.original.originX=A.x,U.original.originY=A.y,this._currentTransform=U,this._beforeTransform(h)}},setCursor:function(h){this.upperCanvasEl.style.cursor=h},_drawSelection:function(h){var a=this._groupSelector,c=new I.Point(a.ex,a.ey),d=I.util.transformPoint(c,this.viewportTransform),_=new I.Point(a.ex+a.left,a.ey+a.top),u=I.util.transformPoint(_,this.viewportTransform),C=Math.min(d.x,u.x),S=Math.min(d.y,u.y),A=Math.max(d.x,u.x),O=Math.max(d.y,u.y),U=this.selectionLineWidth/2;this.selectionColor&&(h.fillStyle=this.selectionColor,h.fillRect(C,S,A-C,O-S)),!(!this.selectionLineWidth||!this.selectionBorderColor)&&(h.lineWidth=this.selectionLineWidth,h.strokeStyle=this.selectionBorderColor,C+=U,S+=U,A-=U,O-=U,I.Object.prototype._setLineDash.call(this,h,this.selectionDashArray),h.strokeRect(C,S,A-C,O-S))},findTarget:function(h,a){if(!this.skipTargetFind){var c=!0,d=this.getPointer(h,c),_=this._activeObject,u=this.getActiveObjects(),C,S,A=x(h),O=u.length>1&&!a||u.length===1;if(this.targets=[],O&&_._findTargetCorner(d,A)||u.length>1&&!a&&_===this._searchPossibleTargets([_],d))return _;if(u.length===1&&_===this._searchPossibleTargets([_],d))if(this.preserveObjectStacking)C=_,S=this.targets,this.targets=[];else return _;var U=this._searchPossibleTargets(this._objects,d);return h[this.altSelectionKey]&&U&&C&&U!==C&&(U=C,this.targets=S),U}},_checkTarget:function(h,a,c){if(a&&a.visible&&a.evented&&a.containsPoint(h))if((this.perPixelTargetFind||a.perPixelTargetFind)&&!a.isEditing){var d=this.isTargetTransparent(a,c.x,c.y);if(!d)return!0}else return!0},_searchPossibleTargets:function(h,a){for(var c,d=h.length,_;d--;){var u=h[d],C=u.group?this._normalizePointer(u.group,a):a;if(this._checkTarget(C,u,a)){c=h[d],c.subTargetCheck&&c instanceof I.Group&&(_=this._searchPossibleTargets(c._objects,a),_&&this.targets.push(_));break}}return c},restorePointerVpt:function(h){return I.util.transformPoint(h,I.util.invertTransform(this.viewportTransform))},getPointer:function(h,a){if(this._absolutePointer&&!a)return this._absolutePointer;if(this._pointer&&a)return this._pointer;var c=n(h),d=this.upperCanvasEl,_=d.getBoundingClientRect(),u=_.width||0,C=_.height||0,S;(!u||!C)&&("top"in _&&"bottom"in _&&(C=Math.abs(_.top-_.bottom)),"right"in _&&"left"in _&&(u=Math.abs(_.right-_.left))),this.calcOffset(),c.x=c.x-this._offset.left,c.y=c.y-this._offset.top,a||(c=this.restorePointerVpt(c));var A=this.getRetinaScaling();return A!==1&&(c.x/=A,c.y/=A),u===0||C===0?S={width:1,height:1}:S={width:d.width/u,height:d.height/C},{x:c.x*S.width,y:c.y*S.height}},_createUpperCanvas:function(){var h=this.lowerCanvasEl.className.replace(/\s*lower-canvas\s*/,""),a=this.lowerCanvasEl,c=this.upperCanvasEl;c?c.className="":(c=this._createCanvasElement(),this.upperCanvasEl=c),I.util.addClass(c,"upper-canvas "+h),this.wrapperEl.appendChild(c),this._copyCanvasStyle(a,c),this._applyCanvasStyle(c),this.contextTop=c.getContext("2d")},getTopContext:function(){return this.contextTop},_createCacheCanvas:function(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",this.width),this.cacheCanvasEl.setAttribute("height",this.height),this.contextCache=this.cacheCanvasEl.getContext("2d")},_initWrapperElement:function(){this.wrapperEl=I.util.wrapElement(this.lowerCanvasEl,"div",{class:this.containerClass}),I.util.setStyle(this.wrapperEl,{width:this.width+"px",height:this.height+"px",position:"relative"}),I.util.makeElementUnselectable(this.wrapperEl)},_applyCanvasStyle:function(h){var a=this.width||h.width,c=this.height||h.height;I.util.setStyle(h,{position:"absolute",width:a+"px",height:c+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),h.width=a,h.height=c,I.util.makeElementUnselectable(h)},_copyCanvasStyle:function(h,a){a.style.cssText=h.style.cssText},getSelectionContext:function(){return this.contextTop},getSelectionElement:function(){return this.upperCanvasEl},getActiveObject:function(){return this._activeObject},getActiveObjects:function(){var h=this._activeObject;return h?h.type==="activeSelection"&&h._objects?h._objects.slice(0):[h]:[]},_onObjectRemoved:function(h){h===this._activeObject&&(this.fire("before:selection:cleared",{target:h}),this._discardActiveObject(),this.fire("selection:cleared",{target:h}),h.fire("deselected")),h===this._hoveredTarget&&(this._hoveredTarget=null,this._hoveredTargets=[]),this.callSuper("_onObjectRemoved",h)},_fireSelectionEvents:function(h,a){var c=!1,d=this.getActiveObjects(),_=[],u=[];h.forEach(function(C){d.indexOf(C)===-1&&(c=!0,C.fire("deselected",{e:a,target:C}),u.push(C))}),d.forEach(function(C){h.indexOf(C)===-1&&(c=!0,C.fire("selected",{e:a,target:C}),_.push(C))}),h.length>0&&d.length>0?c&&this.fire("selection:updated",{e:a,selected:_,deselected:u}):d.length>0?this.fire("selection:created",{e:a,selected:_}):h.length>0&&this.fire("selection:cleared",{e:a,deselected:u})},setActiveObject:function(h,a){var c=this.getActiveObjects();return this._setActiveObject(h,a),this._fireSelectionEvents(c,a),this},_setActiveObject:function(h,a){return this._activeObject===h||!this._discardActiveObject(a,h)||h.onSelect({e:a})?!1:(this._activeObject=h,!0)},_discardActiveObject:function(h,a){var c=this._activeObject;if(c){if(c.onDeselect({e:h,object:a}))return!1;this._activeObject=null}return!0},discardActiveObject:function(h){var a=this.getActiveObjects(),c=this.getActiveObject();return a.length&&this.fire("before:selection:cleared",{target:c,e:h}),this._discardActiveObject(h),this._fireSelectionEvents(a,h),this},dispose:function(){var h=this.wrapperEl;return this.removeListeners(),h.removeChild(this.upperCanvasEl),h.removeChild(this.lowerCanvasEl),this.contextCache=null,this.contextTop=null,["upperCanvasEl","cacheCanvasEl"].forEach(function(a){I.util.cleanUpJsdomNode(this[a]),this[a]=void 0}.bind(this)),h.parentNode&&h.parentNode.replaceChild(this.lowerCanvasEl,this.wrapperEl),delete this.wrapperEl,I.StaticCanvas.prototype.dispose.call(this),this},clear:function(){return this.discardActiveObject(),this.clearContext(this.contextTop),this.callSuper("clear")},drawControls:function(h){var a=this._activeObject;a&&a._renderControls(h)},_toObject:function(h,a,c){var d=this._realizeGroupTransformOnObject(h),_=this.callSuper("_toObject",h,a,c);return this._unwindGroupTransformOnObject(h,d),_},_realizeGroupTransformOnObject:function(h){if(h.group&&h.group.type==="activeSelection"&&this._activeObject===h.group){var a=["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"],c={};return a.forEach(function(d){c[d]=h[d]}),I.util.addTransformToObject(h,this._activeObject.calcOwnMatrix()),c}else return null},_unwindGroupTransformOnObject:function(h,a){a&&h.set(a)},_setSVGObject:function(h,a,c){var d=this._realizeGroupTransformOnObject(a);this.callSuper("_setSVGObject",h,a,c),this._unwindGroupTransformOnObject(a,d)},setViewportTransform:function(h){this.renderOnAddRemove&&this._activeObject&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),I.StaticCanvas.prototype.setViewportTransform.call(this,h)}});for(var v in I.StaticCanvas)v!=="prototype"&&(I.Canvas[v]=I.StaticCanvas[v])}(),function(){var n=I.util.addListener,g=I.util.removeListener,x=3,v=2,h=1,a={passive:!1};function c(d,_){return d.button&&d.button===_-1}I.util.object.extend(I.Canvas.prototype,{mainTouchId:null,_initEventListeners:function(){this.removeListeners(),this._bindEvents(),this.addOrRemove(n,"add")},_getEventPrefix:function(){return this.enablePointerEvents?"pointer":"mouse"},addOrRemove:function(d,_){var u=this.upperCanvasEl,C=this._getEventPrefix();d(I.window,"resize",this._onResize),d(u,C+"down",this._onMouseDown),d(u,C+"move",this._onMouseMove,a),d(u,C+"out",this._onMouseOut),d(u,C+"enter",this._onMouseEnter),d(u,"wheel",this._onMouseWheel),d(u,"contextmenu",this._onContextMenu),d(u,"dblclick",this._onDoubleClick),d(u,"dragover",this._onDragOver),d(u,"dragenter",this._onDragEnter),d(u,"dragleave",this._onDragLeave),d(u,"drop",this._onDrop),this.enablePointerEvents||d(u,"touchstart",this._onTouchStart,a),typeof eventjs<"u"&&_ in eventjs&&(eventjs[_](u,"gesture",this._onGesture),eventjs[_](u,"drag",this._onDrag),eventjs[_](u,"orientation",this._onOrientationChange),eventjs[_](u,"shake",this._onShake),eventjs[_](u,"longpress",this._onLongPress))},removeListeners:function(){this.addOrRemove(g,"remove");var d=this._getEventPrefix();g(I.document,d+"up",this._onMouseUp),g(I.document,"touchend",this._onTouchEnd,a),g(I.document,d+"move",this._onMouseMove,a),g(I.document,"touchmove",this._onMouseMove,a)},_bindEvents:function(){this.eventsBound||(this._onMouseDown=this._onMouseDown.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onResize=this._onResize.bind(this),this._onGesture=this._onGesture.bind(this),this._onDrag=this._onDrag.bind(this),this._onShake=this._onShake.bind(this),this._onLongPress=this._onLongPress.bind(this),this._onOrientationChange=this._onOrientationChange.bind(this),this._onMouseWheel=this._onMouseWheel.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onMouseEnter=this._onMouseEnter.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onDoubleClick=this._onDoubleClick.bind(this),this._onDragOver=this._onDragOver.bind(this),this._onDragEnter=this._simpleEventHandler.bind(this,"dragenter"),this._onDragLeave=this._simpleEventHandler.bind(this,"dragleave"),this._onDrop=this._onDrop.bind(this),this.eventsBound=!0)},_onGesture:function(d,_){this.__onTransformGesture&&this.__onTransformGesture(d,_)},_onDrag:function(d,_){this.__onDrag&&this.__onDrag(d,_)},_onMouseWheel:function(d){this.__onMouseWheel(d)},_onMouseOut:function(d){var _=this._hoveredTarget;this.fire("mouse:out",{target:_,e:d}),this._hoveredTarget=null,_&&_.fire("mouseout",{e:d});var u=this;this._hoveredTargets.forEach(function(C){u.fire("mouse:out",{target:_,e:d}),C&&_.fire("mouseout",{e:d})}),this._hoveredTargets=[]},_onMouseEnter:function(d){!this._currentTransform&&!this.findTarget(d)&&(this.fire("mouse:over",{target:null,e:d}),this._hoveredTarget=null,this._hoveredTargets=[])},_onOrientationChange:function(d,_){this.__onOrientationChange&&this.__onOrientationChange(d,_)},_onShake:function(d,_){this.__onShake&&this.__onShake(d,_)},_onLongPress:function(d,_){this.__onLongPress&&this.__onLongPress(d,_)},_onDragOver:function(d){d.preventDefault();var _=this._simpleEventHandler("dragover",d);this._fireEnterLeaveEvents(_,d)},_onDrop:function(d){return this._simpleEventHandler("drop:before",d),this._simpleEventHandler("drop",d)},_onContextMenu:function(d){return this.stopContextMenu&&(d.stopPropagation(),d.preventDefault()),!1},_onDoubleClick:function(d){this._cacheTransformEventData(d),this._handleEvent(d,"dblclick"),this._resetTransformEventData(d)},getPointerId:function(d){var _=d.changedTouches;return _?_[0]&&_[0].identifier:this.enablePointerEvents?d.pointerId:-1},_isMainEvent:function(d){return d.isPrimary===!0?!0:d.isPrimary===!1?!1:d.type==="touchend"&&d.touches.length===0?!0:d.changedTouches?d.changedTouches[0].identifier===this.mainTouchId:!0},_onTouchStart:function(d){d.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(d)),this.__onMouseDown(d),this._resetTransformEventData();var _=this.upperCanvasEl,u=this._getEventPrefix();n(I.document,"touchend",this._onTouchEnd,a),n(I.document,"touchmove",this._onMouseMove,a),g(_,u+"down",this._onMouseDown)},_onMouseDown:function(d){this.__onMouseDown(d),this._resetTransformEventData();var _=this.upperCanvasEl,u=this._getEventPrefix();g(_,u+"move",this._onMouseMove,a),n(I.document,u+"up",this._onMouseUp),n(I.document,u+"move",this._onMouseMove,a)},_onTouchEnd:function(d){if(!(d.touches.length>0)){this.__onMouseUp(d),this._resetTransformEventData(),this.mainTouchId=null;var _=this._getEventPrefix();g(I.document,"touchend",this._onTouchEnd,a),g(I.document,"touchmove",this._onMouseMove,a);var u=this;this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(function(){n(u.upperCanvasEl,_+"down",u._onMouseDown),u._willAddMouseDown=0},400)}},_onMouseUp:function(d){this.__onMouseUp(d),this._resetTransformEventData();var _=this.upperCanvasEl,u=this._getEventPrefix();this._isMainEvent(d)&&(g(I.document,u+"up",this._onMouseUp),g(I.document,u+"move",this._onMouseMove,a),n(_,u+"move",this._onMouseMove,a))},_onMouseMove:function(d){!this.allowTouchScrolling&&d.preventDefault&&d.preventDefault(),this.__onMouseMove(d)},_onResize:function(){this.calcOffset()},_shouldRender:function(d){var _=this._activeObject;return!!_!=!!d||_&&d&&_!==d?!0:(_&&_.isEditing,!1)},__onMouseUp:function(d){var _,u=this._currentTransform,C=this._groupSelector,S=!1,A=!C||C.left===0&&C.top===0;if(this._cacheTransformEventData(d),_=this._target,this._handleEvent(d,"up:before"),c(d,x)){this.fireRightClick&&this._handleEvent(d,"up",x,A);return}if(c(d,v)){this.fireMiddleClick&&this._handleEvent(d,"up",v,A),this._resetTransformEventData();return}if(this.isDrawingMode&&this._isCurrentlyDrawing){this._onMouseUpInDrawingMode(d);return}if(!!this._isMainEvent(d)){if(u&&(this._finalizeCurrentTransform(d),S=u.actionPerformed),!A){var O=_===this._activeObject;this._maybeGroupObjects(d),S||(S=this._shouldRender(_)||!O&&_===this._activeObject)}var U,Y;if(_){if(U=_._findTargetCorner(this.getPointer(d,!0),I.util.isTouchEvent(d)),_.selectable&&_!==this._activeObject&&_.activeOn==="up")this.setActiveObject(_,d),S=!0;else{var oe=_.controls[U],ge=oe&&oe.getMouseUpHandler(d,_,oe);ge&&(Y=this.getPointer(d),ge(d,u,Y.x,Y.y))}_.isMoving=!1}if(u&&(u.target!==_||u.corner!==U)){var ze=u.target&&u.target.controls[u.corner],We=ze&&ze.getMouseUpHandler(d,_,oe);Y=Y||this.getPointer(d),We&&We(d,u,Y.x,Y.y)}this._setCursorFromEvent(d,_),this._handleEvent(d,"up",h,A),this._groupSelector=null,this._currentTransform=null,_&&(_.__corner=0),S?this.requestRenderAll():A||this.renderTop()}},_simpleEventHandler:function(d,_){var u=this.findTarget(_),C=this.targets,S={e:_,target:u,subTargets:C};if(this.fire(d,S),u&&u.fire(d,S),!C)return u;for(var A=0;A<C.length;A++)C[A].fire(d,S);return u},_handleEvent:function(d,_,u,C){var S=this._target,A=this.targets||[],O={e:d,target:S,subTargets:A,button:u||h,isClick:C||!1,pointer:this._pointer,absolutePointer:this._absolutePointer,transform:this._currentTransform};_==="up"&&(O.currentTarget=this.findTarget(d),O.currentSubTargets=this.targets),this.fire("mouse:"+_,O),S&&S.fire("mouse"+_,O);for(var U=0;U<A.length;U++)A[U].fire("mouse"+_,O)},_finalizeCurrentTransform:function(d){var _=this._currentTransform,u=_.target,C={e:d,target:u,transform:_,action:_.action};u._scaling&&(u._scaling=!1),u.setCoords(),(_.actionPerformed||this.stateful&&u.hasStateChanged())&&this._fire("modified",C)},_onMouseDownInDrawingMode:function(d){this._isCurrentlyDrawing=!0,this.getActiveObject()&&this.discardActiveObject(d).requestRenderAll();var _=this.getPointer(d);this.freeDrawingBrush.onMouseDown(_,{e:d,pointer:_}),this._handleEvent(d,"down")},_onMouseMoveInDrawingMode:function(d){if(this._isCurrentlyDrawing){var _=this.getPointer(d);this.freeDrawingBrush.onMouseMove(_,{e:d,pointer:_})}this.setCursor(this.freeDrawingCursor),this._handleEvent(d,"move")},_onMouseUpInDrawingMode:function(d){var _=this.getPointer(d);this._isCurrentlyDrawing=this.freeDrawingBrush.onMouseUp({e:d,pointer:_}),this._handleEvent(d,"up")},__onMouseDown:function(d){this._cacheTransformEventData(d),this._handleEvent(d,"down:before");var _=this._target;if(c(d,x)){this.fireRightClick&&this._handleEvent(d,"down",x);return}if(c(d,v)){this.fireMiddleClick&&this._handleEvent(d,"down",v);return}if(this.isDrawingMode){this._onMouseDownInDrawingMode(d);return}if(!!this._isMainEvent(d)&&!this._currentTransform){var u=this._pointer;this._previousPointer=u;var C=this._shouldRender(_),S=this._shouldGroup(d,_);if(this._shouldClearSelection(d,_)?this.discardActiveObject(d):S&&(this._handleGrouping(d,_),_=this._activeObject),this.selection&&(!_||!_.selectable&&!_.isEditing&&_!==this._activeObject)&&(this._groupSelector={ex:this._absolutePointer.x,ey:this._absolutePointer.y,top:0,left:0}),_){var A=_===this._activeObject;_.selectable&&_.activeOn==="down"&&this.setActiveObject(_,d);var O=_._findTargetCorner(this.getPointer(d,!0),I.util.isTouchEvent(d));if(_.__corner=O,_===this._activeObject&&(O||!S)){this._setupCurrentTransform(d,_,A);var U=_.controls[O],u=this.getPointer(d),Y=U&&U.getMouseDownHandler(d,_,U);Y&&Y(d,this._currentTransform,u.x,u.y)}}this._handleEvent(d,"down"),(C||S)&&this.requestRenderAll()}},_resetTransformEventData:function(){this._target=null,this._pointer=null,this._absolutePointer=null},_cacheTransformEventData:function(d){this._resetTransformEventData(),this._pointer=this.getPointer(d,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(d)||null},_beforeTransform:function(d){var _=this._currentTransform;this.stateful&&_.target.saveState(),this.fire("before:transform",{e:d,transform:_})},__onMouseMove:function(d){this._handleEvent(d,"move:before"),this._cacheTransformEventData(d);var _,u;if(this.isDrawingMode){this._onMouseMoveInDrawingMode(d);return}if(!!this._isMainEvent(d)){var C=this._groupSelector;C?(u=this._absolutePointer,C.left=u.x-C.ex,C.top=u.y-C.ey,this.renderTop()):this._currentTransform?this._transformObject(d):(_=this.findTarget(d)||null,this._setCursorFromEvent(d,_),this._fireOverOutEvents(_,d)),this._handleEvent(d,"move"),this._resetTransformEventData()}},_fireOverOutEvents:function(d,_){var u=this._hoveredTarget,C=this._hoveredTargets,S=this.targets,A=Math.max(C.length,S.length);this.fireSyntheticInOutEvents(d,_,{oldTarget:u,evtOut:"mouseout",canvasEvtOut:"mouse:out",evtIn:"mouseover",canvasEvtIn:"mouse:over"});for(var O=0;O<A;O++)this.fireSyntheticInOutEvents(S[O],_,{oldTarget:C[O],evtOut:"mouseout",evtIn:"mouseover"});this._hoveredTarget=d,this._hoveredTargets=this.targets.concat()},_fireEnterLeaveEvents:function(d,_){var u=this._draggedoverTarget,C=this._hoveredTargets,S=this.targets,A=Math.max(C.length,S.length);this.fireSyntheticInOutEvents(d,_,{oldTarget:u,evtOut:"dragleave",evtIn:"dragenter"});for(var O=0;O<A;O++)this.fireSyntheticInOutEvents(S[O],_,{oldTarget:C[O],evtOut:"dragleave",evtIn:"dragenter"});this._draggedoverTarget=d},fireSyntheticInOutEvents:function(d,_,u){var C,S,A=u.oldTarget,O,U,Y=A!==d,oe=u.canvasEvtIn,ge=u.canvasEvtOut;Y&&(C={e:_,target:d,previousTarget:A},S={e:_,target:A,nextTarget:d}),U=d&&Y,O=A&&Y,O&&(ge&&this.fire(ge,S),A.fire(u.evtOut,S)),U&&(oe&&this.fire(oe,C),d.fire(u.evtIn,C))},__onMouseWheel:function(d){this._cacheTransformEventData(d),this._handleEvent(d,"wheel"),this._resetTransformEventData()},_transformObject:function(d){var _=this.getPointer(d),u=this._currentTransform;u.reset=!1,u.shiftKey=d.shiftKey,u.altKey=d[this.centeredKey],this._performTransformAction(d,u,_),u.actionPerformed&&this.requestRenderAll()},_performTransformAction:function(d,_,u){var C=u.x,S=u.y,A=_.action,O=!1,U=_.actionHandler;U&&(O=U(d,_,C,S)),A==="drag"&&O&&(_.target.isMoving=!0,this.setCursor(_.target.moveCursor||this.moveCursor)),_.actionPerformed=_.actionPerformed||O},_fire:I.controlsUtils.fireEvent,_setCursorFromEvent:function(d,_){if(!_)return this.setCursor(this.defaultCursor),!1;var u=_.hoverCursor||this.hoverCursor,C=this._activeObject&&this._activeObject.type==="activeSelection"?this._activeObject:null,S=(!C||!C.contains(_))&&_._findTargetCorner(this.getPointer(d,!0));S?this.setCursor(this.getCornerCursor(S,_,d)):(_.subTargetCheck&&this.targets.concat().reverse().map(function(A){u=A.hoverCursor||u}),this.setCursor(u))},getCornerCursor:function(d,_,u){var C=_.controls[d];return C.cursorStyleHandler(u,C,_)}})}(),function(){var n=Math.min,g=Math.max;I.util.object.extend(I.Canvas.prototype,{_shouldGroup:function(x,v){var h=this._activeObject;return h&&this._isSelectionKeyPressed(x)&&v&&v.selectable&&this.selection&&(h!==v||h.type==="activeSelection")&&!v.onSelect({e:x})},_handleGrouping:function(x,v){var h=this._activeObject;h.__corner||v===h&&(v=this.findTarget(x,!0),!v||!v.selectable)||(h&&h.type==="activeSelection"?this._updateActiveSelection(v,x):this._createActiveSelection(v,x))},_updateActiveSelection:function(x,v){var h=this._activeObject,a=h._objects.slice(0);h.contains(x)?(h.removeWithUpdate(x),this._hoveredTarget=x,this._hoveredTargets=this.targets.concat(),h.size()===1&&this._setActiveObject(h.item(0),v)):(h.addWithUpdate(x),this._hoveredTarget=h,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(a,v)},_createActiveSelection:function(x,v){var h=this.getActiveObjects(),a=this._createGroup(x);this._hoveredTarget=a,this._setActiveObject(a,v),this._fireSelectionEvents(h,v)},_createGroup:function(x){var v=this._objects,h=v.indexOf(this._activeObject)<v.indexOf(x),a=h?[this._activeObject,x]:[x,this._activeObject];return this._activeObject.isEditing&&this._activeObject.exitEditing(),new I.ActiveSelection(a,{canvas:this})},_groupSelectedObjects:function(x){var v=this._collectObjects(x),h;v.length===1?this.setActiveObject(v[0],x):v.length>1&&(h=new I.ActiveSelection(v.reverse(),{canvas:this}),this.setActiveObject(h,x))},_collectObjects:function(x){for(var v=[],h,a=this._groupSelector.ex,c=this._groupSelector.ey,d=a+this._groupSelector.left,_=c+this._groupSelector.top,u=new I.Point(n(a,d),n(c,_)),C=new I.Point(g(a,d),g(c,_)),S=!this.selectionFullyContained,A=a===d&&c===_,O=this._objects.length;O--&&(h=this._objects[O],!(!(!h||!h.selectable||!h.visible)&&(S&&h.intersectsWithRect(u,C,!0)||h.isContainedWithinRect(u,C,!0)||S&&h.containsPoint(u,null,!0)||S&&h.containsPoint(C,null,!0))&&(v.push(h),A))););return v.length>1&&(v=v.filter(function(U){return!U.onSelect({e:x})})),v},_maybeGroupObjects:function(x){this.selection&&this._groupSelector&&this._groupSelectedObjects(x),this.setCursor(this.defaultCursor),this._groupSelector=null}})}(),function(){I.util.object.extend(I.StaticCanvas.prototype,{toDataURL:function(n){n||(n={});var g=n.format||"png",x=n.quality||1,v=(n.multiplier||1)*(n.enableRetinaScaling?this.getRetinaScaling():1),h=this.toCanvasElement(v,n);return I.util.toDataURL(h,g,x)},toCanvasElement:function(n,g){n=n||1,g=g||{};var x=(g.width||this.width)*n,v=(g.height||this.height)*n,h=this.getZoom(),a=this.width,c=this.height,d=h*n,_=this.viewportTransform,u=(_[4]-(g.left||0))*n,C=(_[5]-(g.top||0))*n,S=this.interactive,A=[d,0,0,d,u,C],O=this.enableRetinaScaling,U=I.util.createCanvasElement(),Y=this.contextTop;return U.width=x,U.height=v,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=A,this.width=x,this.height=v,this.calcViewportBoundaries(),this.renderCanvas(U.getContext("2d"),this._objects),this.viewportTransform=_,this.width=a,this.height=c,this.calcViewportBoundaries(),this.interactive=S,this.enableRetinaScaling=O,this.contextTop=Y,U}})}(),I.util.object.extend(I.StaticCanvas.prototype,{loadFromJSON:function(n,g,x){if(!!n){var v=typeof n=="string"?JSON.parse(n):I.util.object.clone(n),h=this,a=v.clipPath,c=this.renderOnAddRemove;return this.renderOnAddRemove=!1,delete v.clipPath,this._enlivenObjects(v.objects,function(d){h.clear(),h._setBgOverlay(v,function(){a?h._enlivenObjects([a],function(_){h.clipPath=_[0],h.__setupCanvas.call(h,v,d,c,g)}):h.__setupCanvas.call(h,v,d,c,g)})},x),this}},__setupCanvas:function(n,g,x,v){var h=this;g.forEach(function(a,c){h.insertAt(a,c)}),this.renderOnAddRemove=x,delete n.objects,delete n.backgroundImage,delete n.overlayImage,delete n.background,delete n.overlay,this._setOptions(n),this.renderAll(),v&&v()},_setBgOverlay:function(n,g){var x={backgroundColor:!1,overlayColor:!1,backgroundImage:!1,overlayImage:!1};if(!n.backgroundImage&&!n.overlayImage&&!n.background&&!n.overlay){g&&g();return}var v=function(){x.backgroundImage&&x.overlayImage&&x.backgroundColor&&x.overlayColor&&g&&g()};this.__setBgOverlay("backgroundImage",n.backgroundImage,x,v),this.__setBgOverlay("overlayImage",n.overlayImage,x,v),this.__setBgOverlay("backgroundColor",n.background,x,v),this.__setBgOverlay("overlayColor",n.overlay,x,v)},__setBgOverlay:function(n,g,x,v){var h=this;if(!g){x[n]=!0,v&&v();return}n==="backgroundImage"||n==="overlayImage"?I.util.enlivenObjects([g],function(a){h[n]=a[0],x[n]=!0,v&&v()}):this["set"+I.util.string.capitalize(n,!0)](g,function(){x[n]=!0,v&&v()})},_enlivenObjects:function(n,g,x){if(!n||n.length===0){g&&g([]);return}I.util.enlivenObjects(n,function(v){g&&g(v)},null,x)},_toDataURL:function(n,g){this.clone(function(x){g(x.toDataURL(n))})},_toDataURLWithMultiplier:function(n,g,x){this.clone(function(v){x(v.toDataURLWithMultiplier(n,g))})},clone:function(n,g){var x=JSON.stringify(this.toJSON(g));this.cloneWithoutData(function(v){v.loadFromJSON(x,function(){n&&n(v)})})},cloneWithoutData:function(n){var g=I.util.createCanvasElement();g.width=this.width,g.height=this.height;var x=new I.Canvas(g);this.backgroundImage?(x.setBackgroundImage(this.backgroundImage.src,function(){x.renderAll(),n&&n(x)}),x.backgroundImageOpacity=this.backgroundImageOpacity,x.backgroundImageStretch=this.backgroundImageStretch):n&&n(x)}}),function(n){var g=n.fabric||(n.fabric={}),x=g.util.object.extend,v=g.util.object.clone,h=g.util.toFixed,a=g.util.string.capitalize,c=g.util.degreesToRadians,d=!g.isLikelyNode,_=2;g.Object||(g.Object=g.util.createClass(g.CommonMethods,{type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:null,cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:d,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:"top left width height scaleX scaleY flipX flipY originX originY transformMatrix stroke strokeWidth strokeDashArray strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit angle opacity fill globalCompositeOperation shadow visible backgroundColor skewX skewY fillRule paintFirst clipPath strokeUniform".split(" "),cacheProperties:"fill stroke strokeWidth strokeDashArray width height paintFirst strokeUniform strokeLineCap strokeDashOffset strokeLineJoin strokeMiterLimit backgroundColor clipPath".split(" "),colorProperties:"fill stroke backgroundColor".split(" "),clipPath:void 0,inverted:!1,absolutePositioned:!1,initialize:function(u){u&&this.setOptions(u)},_createCacheCanvas:function(){this._cacheProperties={},this._cacheCanvas=g.util.createCanvasElement(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0},_limitCacheSize:function(u){var C=g.perfLimitSizeTotal,S=u.width,A=u.height,O=g.maxCacheSideLimit,U=g.minCacheSideLimit;if(S<=O&&A<=O&&S*A<=C)return S<U&&(u.width=U),A<U&&(u.height=U),u;var Y=S/A,oe=g.util.limitDimsByArea(Y,C),ge=g.util.capValue,ze=ge(U,oe.x,O),We=ge(U,oe.y,O);return S>ze&&(u.zoomX/=S/ze,u.width=ze,u.capped=!0),A>We&&(u.zoomY/=A/We,u.height=We,u.capped=!0),u},_getCacheCanvasDimensions:function(){var u=this.getTotalObjectScaling(),C=this._getTransformedDimensions(0,0),S=C.x*u.scaleX/this.scaleX,A=C.y*u.scaleY/this.scaleY;return{width:S+_,height:A+_,zoomX:u.scaleX,zoomY:u.scaleY,x:S,y:A}},_updateCacheCanvas:function(){var u=this.canvas;if(this.noScaleCache&&u&&u._currentTransform){var C=u._currentTransform.target,S=u._currentTransform.action;if(this===C&&S.slice&&S.slice(0,5)==="scale")return!1}var A=this._cacheCanvas,O=this._limitCacheSize(this._getCacheCanvasDimensions()),U=g.minCacheSideLimit,Y=O.width,oe=O.height,ge,ze,We=O.zoomX,at=O.zoomY,_t=Y!==this.cacheWidth||oe!==this.cacheHeight,vt=this.zoomX!==We||this.zoomY!==at,rt=_t||vt,mt=0,Qe=0,zt=!1;if(_t){var Et=this._cacheCanvas.width,Q=this._cacheCanvas.height,se=Y>Et||oe>Q,de=(Y<Et*.9||oe<Q*.9)&&Et>U&&Q>U;zt=se||de,se&&!O.capped&&(Y>U||oe>U)&&(mt=Y*.1,Qe=oe*.1)}return this instanceof g.Text&&this.path&&(rt=!0,zt=!0,mt+=this.getHeightOfLine(0)*this.zoomX,Qe+=this.getHeightOfLine(0)*this.zoomY),rt?(zt?(A.width=Math.ceil(Y+mt),A.height=Math.ceil(oe+Qe)):(this._cacheContext.setTransform(1,0,0,1,0,0),this._cacheContext.clearRect(0,0,A.width,A.height)),ge=O.x/2,ze=O.y/2,this.cacheTranslationX=Math.round(A.width/2-ge)+ge,this.cacheTranslationY=Math.round(A.height/2-ze)+ze,this.cacheWidth=Y,this.cacheHeight=oe,this._cacheContext.translate(this.cacheTranslationX,this.cacheTranslationY),this._cacheContext.scale(We,at),this.zoomX=We,this.zoomY=at,!0):!1},setOptions:function(u){this._setOptions(u),this._initGradient(u.fill,"fill"),this._initGradient(u.stroke,"stroke"),this._initPattern(u.fill,"fill"),this._initPattern(u.stroke,"stroke")},transform:function(u){var C=this.group&&!this.group._transformDone||this.group&&this.canvas&&u===this.canvas.contextTop,S=this.calcTransformMatrix(!C);u.transform(S[0],S[1],S[2],S[3],S[4],S[5])},toObject:function(u){var C=g.Object.NUM_FRACTION_DIGITS,S={type:this.type,version:g.version,originX:this.originX,originY:this.originY,left:h(this.left,C),top:h(this.top,C),width:h(this.width,C),height:h(this.height,C),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:h(this.strokeWidth,C),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:h(this.strokeMiterLimit,C),scaleX:h(this.scaleX,C),scaleY:h(this.scaleY,C),angle:h(this.angle,C),flipX:this.flipX,flipY:this.flipY,opacity:h(this.opacity,C),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:h(this.skewX,C),skewY:h(this.skewY,C)};return this.clipPath&&!this.clipPath.excludeFromExport&&(S.clipPath=this.clipPath.toObject(u),S.clipPath.inverted=this.clipPath.inverted,S.clipPath.absolutePositioned=this.clipPath.absolutePositioned),g.util.populateWithProperties(this,S,u),this.includeDefaultValues||(S=this._removeDefaultValues(S)),S},toDatalessObject:function(u){return this.toObject(u)},_removeDefaultValues:function(u){var C=g.util.getKlass(u.type).prototype,S=C.stateProperties;return S.forEach(function(A){A==="left"||A==="top"||(u[A]===C[A]&&delete u[A],Array.isArray(u[A])&&Array.isArray(C[A])&&u[A].length===0&&C[A].length===0&&delete u[A])}),u},toString:function(){return"#<fabric."+a(this.type)+">"},getObjectScaling:function(){if(!this.group)return{scaleX:this.scaleX,scaleY:this.scaleY};var u=g.util.qrDecompose(this.calcTransformMatrix());return{scaleX:Math.abs(u.scaleX),scaleY:Math.abs(u.scaleY)}},getTotalObjectScaling:function(){var u=this.getObjectScaling(),C=u.scaleX,S=u.scaleY;if(this.canvas){var A=this.canvas.getZoom(),O=this.canvas.getRetinaScaling();C*=A*O,S*=A*O}return{scaleX:C,scaleY:S}},getObjectOpacity:function(){var u=this.opacity;return this.group&&(u*=this.group.getObjectOpacity()),u},_set:function(u,C){var S=u==="scaleX"||u==="scaleY",A=this[u]!==C,O=!1;return S&&(C=this._constrainScale(C)),u==="scaleX"&&C<0?(this.flipX=!this.flipX,C*=-1):u==="scaleY"&&C<0?(this.flipY=!this.flipY,C*=-1):u==="shadow"&&C&&!(C instanceof g.Shadow)?C=new g.Shadow(C):u==="dirty"&&this.group&&this.group.set("dirty",C),this[u]=C,A&&(O=this.group&&this.group.isOnACache(),this.cacheProperties.indexOf(u)>-1?(this.dirty=!0,O&&this.group.set("dirty",!0)):O&&this.stateProperties.indexOf(u)>-1&&this.group.set("dirty",!0)),this},setOnGroup:function(){},getViewportTransform:function(){return this.canvas&&this.canvas.viewportTransform?this.canvas.viewportTransform:g.iMatrix.concat()},isNotVisible:function(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible},render:function(u){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(u.save(),this._setupCompositeOperation(u),this.drawSelectionBackground(u),this.transform(u),this._setOpacity(u),this._setShadow(u,this),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(u)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(u),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),u.restore())},renderCache:function(u){u=u||{},(!this._cacheCanvas||!this._cacheContext)&&this._createCacheCanvas(),this.isCacheDirty()&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,u.forClipping),this.dirty=!1)},_removeCacheCanvas:function(){this._cacheCanvas=null,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0},hasStroke:function(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0},hasFill:function(){return this.fill&&this.fill!=="transparent"},needsItsOwnCache:function(){return!!(this.paintFirst==="stroke"&&this.hasFill()&&this.hasStroke()&&typeof this.shadow=="object"||this.clipPath)},shouldCache:function(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching},willDrawShadow:function(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)},drawClipPathOnCache:function(u,C){if(u.save(),C.inverted?u.globalCompositeOperation="destination-out":u.globalCompositeOperation="destination-in",C.absolutePositioned){var S=g.util.invertTransform(this.calcTransformMatrix());u.transform(S[0],S[1],S[2],S[3],S[4],S[5])}C.transform(u),u.scale(1/C.zoomX,1/C.zoomY),u.drawImage(C._cacheCanvas,-C.cacheTranslationX,-C.cacheTranslationY),u.restore()},drawObject:function(u,C){var S=this.fill,A=this.stroke;C?(this.fill="black",this.stroke="",this._setClippingProperties(u)):this._renderBackground(u),this._render(u),this._drawClipPath(u,this.clipPath),this.fill=S,this.stroke=A},_drawClipPath:function(u,C){!C||(C.canvas=this.canvas,C.shouldCache(),C._transformDone=!0,C.renderCache({forClipping:!0}),this.drawClipPathOnCache(u,C))},drawCacheOnCanvas:function(u){u.scale(1/this.zoomX,1/this.zoomY),u.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)},isCacheDirty:function(u){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!u&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!u){var C=this.cacheWidth/this.zoomX,S=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-C/2,-S/2,C,S)}return!0}return!1},_renderBackground:function(u){if(!!this.backgroundColor){var C=this._getNonTransformedDimensions();u.fillStyle=this.backgroundColor,u.fillRect(-C.x/2,-C.y/2,C.x,C.y),this._removeShadow(u)}},_setOpacity:function(u){this.group&&!this.group._transformDone?u.globalAlpha=this.getObjectOpacity():u.globalAlpha*=this.opacity},_setStrokeStyles:function(u,C){var S=C.stroke;S&&(u.lineWidth=C.strokeWidth,u.lineCap=C.strokeLineCap,u.lineDashOffset=C.strokeDashOffset,u.lineJoin=C.strokeLineJoin,u.miterLimit=C.strokeMiterLimit,S.toLive?S.gradientUnits==="percentage"||S.gradientTransform||S.patternTransform?this._applyPatternForTransformedGradient(u,S):(u.strokeStyle=S.toLive(u,this),this._applyPatternGradientTransform(u,S)):u.strokeStyle=C.stroke)},_setFillStyles:function(u,C){var S=C.fill;S&&(S.toLive?(u.fillStyle=S.toLive(u,this),this._applyPatternGradientTransform(u,C.fill)):u.fillStyle=S)},_setClippingProperties:function(u){u.globalAlpha=1,u.strokeStyle="transparent",u.fillStyle="#000000"},_setLineDash:function(u,C){!C||C.length===0||(1&C.length&&C.push.apply(C,C),u.setLineDash(C))},_renderControls:function(u,C){var S=this.getViewportTransform(),A=this.calcTransformMatrix(),O,U,Y;C=C||{},U=typeof C.hasBorders<"u"?C.hasBorders:this.hasBorders,Y=typeof C.hasControls<"u"?C.hasControls:this.hasControls,A=g.util.multiplyTransformMatrices(S,A),O=g.util.qrDecompose(A),u.save(),u.translate(O.translateX,O.translateY),u.lineWidth=1*this.borderScaleFactor,this.group||(u.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(O.angle-=180),u.rotate(c(this.group?O.angle:this.angle)),C.forActiveSelection||this.group?U&&this.drawBordersInGroup(u,O,C):U&&this.drawBorders(u,C),Y&&this.drawControls(u,C),u.restore()},_setShadow:function(u){if(!!this.shadow){var C=this.shadow,S=this.canvas,A,O=S&&S.viewportTransform[0]||1,U=S&&S.viewportTransform[3]||1;C.nonScaling?A={scaleX:1,scaleY:1}:A=this.getObjectScaling(),S&&S._isRetinaScaling()&&(O*=g.devicePixelRatio,U*=g.devicePixelRatio),u.shadowColor=C.color,u.shadowBlur=C.blur*g.browserShadowBlurConstant*(O+U)*(A.scaleX+A.scaleY)/4,u.shadowOffsetX=C.offsetX*O*A.scaleX,u.shadowOffsetY=C.offsetY*U*A.scaleY}},_removeShadow:function(u){!this.shadow||(u.shadowColor="",u.shadowBlur=u.shadowOffsetX=u.shadowOffsetY=0)},_applyPatternGradientTransform:function(u,C){if(!C||!C.toLive)return{offsetX:0,offsetY:0};var S=C.gradientTransform||C.patternTransform,A=-this.width/2+C.offsetX||0,O=-this.height/2+C.offsetY||0;return C.gradientUnits==="percentage"?u.transform(this.width,0,0,this.height,A,O):u.transform(1,0,0,1,A,O),S&&u.transform(S[0],S[1],S[2],S[3],S[4],S[5]),{offsetX:A,offsetY:O}},_renderPaintInOrder:function(u){this.paintFirst==="stroke"?(this._renderStroke(u),this._renderFill(u)):(this._renderFill(u),this._renderStroke(u))},_render:function(){},_renderFill:function(u){!this.fill||(u.save(),this._setFillStyles(u,this),this.fillRule==="evenodd"?u.fill("evenodd"):u.fill(),u.restore())},_renderStroke:function(u){if(!(!this.stroke||this.strokeWidth===0)){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(u),u.save(),this.strokeUniform&&this.group){var C=this.getObjectScaling();u.scale(1/C.scaleX,1/C.scaleY)}else this.strokeUniform&&u.scale(1/this.scaleX,1/this.scaleY);this._setLineDash(u,this.strokeDashArray),this._setStrokeStyles(u,this),u.stroke(),u.restore()}},_applyPatternForTransformedGradient:function(u,C){var S=this._limitCacheSize(this._getCacheCanvasDimensions()),A=g.util.createCanvasElement(),O,U=this.canvas.getRetinaScaling(),Y=S.x/this.scaleX/U,oe=S.y/this.scaleY/U;A.width=Y,A.height=oe,O=A.getContext("2d"),O.beginPath(),O.moveTo(0,0),O.lineTo(Y,0),O.lineTo(Y,oe),O.lineTo(0,oe),O.closePath(),O.translate(Y/2,oe/2),O.scale(S.zoomX/this.scaleX/U,S.zoomY/this.scaleY/U),this._applyPatternGradientTransform(O,C),O.fillStyle=C.toLive(u),O.fill(),u.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),u.scale(U*this.scaleX/S.zoomX,U*this.scaleY/S.zoomY),u.strokeStyle=O.createPattern(A,"no-repeat")},_findCenterFromElement:function(){return{x:this.left+this.width/2,y:this.top+this.height/2}},_assignTransformMatrixProps:function(){if(this.transformMatrix){var u=g.util.qrDecompose(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",u.scaleX),this.set("scaleY",u.scaleY),this.angle=u.angle,this.skewX=u.skewX,this.skewY=0}},_removeTransformMatrix:function(u){var C=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),C=g.util.transformPoint(C,this.transformMatrix)),this.transformMatrix=null,u&&(this.scaleX*=u.scaleX,this.scaleY*=u.scaleY,this.cropX=u.cropX,this.cropY=u.cropY,C.x+=u.offsetLeft,C.y+=u.offsetTop,this.width=u.width,this.height=u.height),this.setPositionByOrigin(C,"center","center")},clone:function(u,C){var S=this.toObject(C);this.constructor.fromObject?this.constructor.fromObject(S,u):g.Object._fromObject("Object",S,u)},cloneAsImage:function(u,C){var S=this.toCanvasElement(C);return u&&u(new g.Image(S)),this},toCanvasElement:function(u){u||(u={});var C=g.util,S=C.saveObjectTransform(this),A=this.group,O=this.shadow,U=Math.abs,Y=(u.multiplier||1)*(u.enableRetinaScaling?g.devicePixelRatio:1);delete this.group,u.withoutTransform&&C.resetObjectTransform(this),u.withoutShadow&&(this.shadow=null);var oe=g.util.createCanvasElement(),ge=this.getBoundingRect(!0,!0),ze=this.shadow,We,at={x:0,y:0},_t,vt,rt;ze&&(_t=ze.blur,ze.nonScaling?We={scaleX:1,scaleY:1}:We=this.getObjectScaling(),at.x=2*Math.round(U(ze.offsetX)+_t)*U(We.scaleX),at.y=2*Math.round(U(ze.offsetY)+_t)*U(We.scaleY)),vt=ge.width+at.x,rt=ge.height+at.y,oe.width=Math.ceil(vt),oe.height=Math.ceil(rt);var mt=new g.StaticCanvas(oe,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});u.format==="jpeg"&&(mt.backgroundColor="#fff"),this.setPositionByOrigin(new g.Point(mt.width/2,mt.height/2),"center","center");var Qe=this.canvas;mt.add(this);var zt=mt.toCanvasElement(Y||1,u);return this.shadow=O,this.set("canvas",Qe),A&&(this.group=A),this.set(S).setCoords(),mt._objects=[],mt.dispose(),mt=null,zt},toDataURL:function(u){return u||(u={}),g.util.toDataURL(this.toCanvasElement(u),u.format||"png",u.quality||1)},isType:function(u){return arguments.length>1?Array.from(arguments).includes(this.type):this.type===u},complexity:function(){return 1},toJSON:function(u){return this.toObject(u)},rotate:function(u){var C=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;return C&&this._setOriginToCenter(),this.set("angle",u),C&&this._resetOrigin(),this},centerH:function(){return this.canvas&&this.canvas.centerObjectH(this),this},viewportCenterH:function(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this},centerV:function(){return this.canvas&&this.canvas.centerObjectV(this),this},viewportCenterV:function(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this},center:function(){return this.canvas&&this.canvas.centerObject(this),this},viewportCenter:function(){return this.canvas&&this.canvas.viewportCenterObject(this),this},getLocalPointer:function(u,C){C=C||this.canvas.getPointer(u);var S=new g.Point(C.x,C.y),A=this._getLeftTopCoords();return this.angle&&(S=g.util.rotatePoint(S,A,c(-this.angle))),{x:S.x-A.x,y:S.y-A.y}},_setupCompositeOperation:function(u){this.globalCompositeOperation&&(u.globalCompositeOperation=this.globalCompositeOperation)},dispose:function(){g.runningAnimations&&g.runningAnimations.cancelByTarget(this)}}),g.util.createAccessors&&g.util.createAccessors(g.Object),x(g.Object.prototype,g.Observable),g.Object.NUM_FRACTION_DIGITS=2,g.Object.ENLIVEN_PROPS=["clipPath"],g.Object._fromObject=function(u,C,S,A){var O=g[u];C=v(C,!0),g.util.enlivenPatterns([C.fill,C.stroke],function(U){typeof U[0]<"u"&&(C.fill=U[0]),typeof U[1]<"u"&&(C.stroke=U[1]),g.util.enlivenObjectEnlivables(C,C,function(){var Y=A?new O(C[A],C):new O(C);S&&S(Y)})})},g.Object.__uid=0)}(Ne),function(){var n=I.util.degreesToRadians,g={left:-.5,center:0,right:.5},x={top:-.5,center:0,bottom:.5};I.util.object.extend(I.Object.prototype,{translateToGivenOrigin:function(v,h,a,c,d){var _=v.x,u=v.y,C,S,A;return typeof h=="string"?h=g[h]:h-=.5,typeof c=="string"?c=g[c]:c-=.5,C=c-h,typeof a=="string"?a=x[a]:a-=.5,typeof d=="string"?d=x[d]:d-=.5,S=d-a,(C||S)&&(A=this._getTransformedDimensions(),_=v.x+C*A.x,u=v.y+S*A.y),new I.Point(_,u)},translateToCenterPoint:function(v,h,a){var c=this.translateToGivenOrigin(v,h,a,"center","center");return this.angle?I.util.rotatePoint(c,v,n(this.angle)):c},translateToOriginPoint:function(v,h,a){var c=this.translateToGivenOrigin(v,"center","center",h,a);return this.angle?I.util.rotatePoint(c,v,n(this.angle)):c},getCenterPoint:function(){var v=new I.Point(this.left,this.top);return this.translateToCenterPoint(v,this.originX,this.originY)},getPointByOrigin:function(v,h){var a=this.getCenterPoint();return this.translateToOriginPoint(a,v,h)},toLocalPoint:function(v,h,a){var c=this.getCenterPoint(),d,_;return typeof h<"u"&&typeof a<"u"?d=this.translateToGivenOrigin(c,"center","center",h,a):d=new I.Point(this.left,this.top),_=new I.Point(v.x,v.y),this.angle&&(_=I.util.rotatePoint(_,c,-n(this.angle))),_.subtractEquals(d)},setPositionByOrigin:function(v,h,a){var c=this.translateToCenterPoint(v,h,a),d=this.translateToOriginPoint(c,this.originX,this.originY);this.set("left",d.x),this.set("top",d.y)},adjustPosition:function(v){var h=n(this.angle),a=this.getScaledWidth(),c=I.util.cos(h)*a,d=I.util.sin(h)*a,_,u;typeof this.originX=="string"?_=g[this.originX]:_=this.originX-.5,typeof v=="string"?u=g[v]:u=v-.5,this.left+=c*(u-_),this.top+=d*(u-_),this.setCoords(),this.originX=v},_setOriginToCenter:function(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;var v=this.getCenterPoint();this.originX="center",this.originY="center",this.left=v.x,this.top=v.y},_resetOrigin:function(){var v=this.translateToOriginPoint(this.getCenterPoint(),this._originalOriginX,this._originalOriginY);this.originX=this._originalOriginX,this.originY=this._originalOriginY,this.left=v.x,this.top=v.y,this._originalOriginX=null,this._originalOriginY=null},_getLeftTopCoords:function(){return this.translateToOriginPoint(this.getCenterPoint(),"left","top")}})}(),function(){function n(a){return[new I.Point(a.tl.x,a.tl.y),new I.Point(a.tr.x,a.tr.y),new I.Point(a.br.x,a.br.y),new I.Point(a.bl.x,a.bl.y)]}var g=I.util,x=g.degreesToRadians,v=g.multiplyTransformMatrices,h=g.transformPoint;g.object.extend(I.Object.prototype,{oCoords:null,aCoords:null,lineCoords:null,ownMatrixCache:null,matrixCache:null,controls:{},_getCoords:function(a,c){return c?a?this.calcACoords():this.calcLineCoords():((!this.aCoords||!this.lineCoords)&&this.setCoords(!0),a?this.aCoords:this.lineCoords)},getCoords:function(a,c){return n(this._getCoords(a,c))},intersectsWithRect:function(a,c,d,_){var u=this.getCoords(d,_),C=I.Intersection.intersectPolygonRectangle(u,a,c);return C.status==="Intersection"},intersectsWithObject:function(a,c,d){var _=I.Intersection.intersectPolygonPolygon(this.getCoords(c,d),a.getCoords(c,d));return _.status==="Intersection"||a.isContainedWithinObject(this,c,d)||this.isContainedWithinObject(a,c,d)},isContainedWithinObject:function(a,c,d){for(var _=this.getCoords(c,d),u=c?a.aCoords:a.lineCoords,C=0,S=a._getImageLines(u);C<4;C++)if(!a.containsPoint(_[C],S))return!1;return!0},isContainedWithinRect:function(a,c,d,_){var u=this.getBoundingRect(d,_);return u.left>=a.x&&u.left+u.width<=c.x&&u.top>=a.y&&u.top+u.height<=c.y},containsPoint:function(a,C,d,_){var u=this._getCoords(d,_),C=C||this._getImageLines(u),S=this._findCrossPoints(a,C);return S!==0&&S%2===1},isOnScreen:function(a){if(!this.canvas)return!1;var c=this.canvas.vptCoords.tl,d=this.canvas.vptCoords.br,_=this.getCoords(!0,a);return _.some(function(u){return u.x<=d.x&&u.x>=c.x&&u.y<=d.y&&u.y>=c.y})||this.intersectsWithRect(c,d,!0,a)?!0:this._containsCenterOfCanvas(c,d,a)},_containsCenterOfCanvas:function(a,c,d){var _={x:(a.x+c.x)/2,y:(a.y+c.y)/2};return!!this.containsPoint(_,null,!0,d)},isPartiallyOnScreen:function(a){if(!this.canvas)return!1;var c=this.canvas.vptCoords.tl,d=this.canvas.vptCoords.br;if(this.intersectsWithRect(c,d,!0,a))return!0;var _=this.getCoords(!0,a).every(function(u){return(u.x>=d.x||u.x<=c.x)&&(u.y>=d.y||u.y<=c.y)});return _&&this._containsCenterOfCanvas(c,d,a)},_getImageLines:function(a){var c={topline:{o:a.tl,d:a.tr},rightline:{o:a.tr,d:a.br},bottomline:{o:a.br,d:a.bl},leftline:{o:a.bl,d:a.tl}};return c},_findCrossPoints:function(a,c){var d,_,u,C,S,A=0,O;for(var U in c)if(O=c[U],!(O.o.y<a.y&&O.d.y<a.y)&&!(O.o.y>=a.y&&O.d.y>=a.y)&&(O.o.x===O.d.x&&O.o.x>=a.x?S=O.o.x:(d=0,_=(O.d.y-O.o.y)/(O.d.x-O.o.x),u=a.y-d*a.x,C=O.o.y-_*O.o.x,S=-(u-C)/(d-_)),S>=a.x&&(A+=1),A===2))break;return A},getBoundingRect:function(a,c){var d=this.getCoords(a,c);return g.makeBoundingBoxFromPoints(d)},getScaledWidth:function(){return this._getTransformedDimensions().x},getScaledHeight:function(){return this._getTransformedDimensions().y},_constrainScale:function(a){return Math.abs(a)<this.minScaleLimit?a<0?-this.minScaleLimit:this.minScaleLimit:a===0?1e-4:a},scale:function(a){return this._set("scaleX",a),this._set("scaleY",a),this.setCoords()},scaleToWidth:function(a,c){var d=this.getBoundingRect(c).width/this.getScaledWidth();return this.scale(a/this.width/d)},scaleToHeight:function(a,c){var d=this.getBoundingRect(c).height/this.getScaledHeight();return this.scale(a/this.height/d)},calcLineCoords:function(){var a=this.getViewportTransform(),c=this.padding,d=x(this.angle),_=g.cos(d),u=g.sin(d),C=_*c,S=u*c,A=C+S,O=C-S,U=this.calcACoords(),Y={tl:h(U.tl,a),tr:h(U.tr,a),bl:h(U.bl,a),br:h(U.br,a)};return c&&(Y.tl.x-=O,Y.tl.y-=A,Y.tr.x+=A,Y.tr.y-=O,Y.bl.x-=A,Y.bl.y+=O,Y.br.x+=O,Y.br.y+=A),Y},calcOCoords:function(){var a=this._calcRotateMatrix(),c=this._calcTranslateMatrix(),d=this.getViewportTransform(),_=v(d,c),u=v(_,a),u=v(u,[1/d[0],0,0,1/d[3],0,0]),C=this._calculateCurrentDimensions(),S={};return this.forEachControl(function(A,O,U){S[O]=A.positionHandler(C,u,U)}),S},calcACoords:function(){var a=this._calcRotateMatrix(),c=this._calcTranslateMatrix(),d=v(c,a),_=this._getTransformedDimensions(),u=_.x/2,C=_.y/2;return{tl:h({x:-u,y:-C},d),tr:h({x:u,y:-C},d),bl:h({x:-u,y:C},d),br:h({x:u,y:C},d)}},setCoords:function(a){return this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords(),a?this:(this.oCoords=this.calcOCoords(),this._setCornerCoords&&this._setCornerCoords(),this)},_calcRotateMatrix:function(){return g.calcRotateMatrix(this)},_calcTranslateMatrix:function(){var a=this.getCenterPoint();return[1,0,0,1,a.x,a.y]},transformMatrixKey:function(a){var c="_",d="";return!a&&this.group&&(d=this.group.transformMatrixKey(a)+c),d+this.top+c+this.left+c+this.scaleX+c+this.scaleY+c+this.skewX+c+this.skewY+c+this.angle+c+this.originX+c+this.originY+c+this.width+c+this.height+c+this.strokeWidth+this.flipX+this.flipY},calcTransformMatrix:function(a){var c=this.calcOwnMatrix();if(a||!this.group)return c;var d=this.transformMatrixKey(a),_=this.matrixCache||(this.matrixCache={});return _.key===d?_.value:(this.group&&(c=v(this.group.calcTransformMatrix(!1),c)),_.key=d,_.value=c,c)},calcOwnMatrix:function(){var a=this.transformMatrixKey(!0),c=this.ownMatrixCache||(this.ownMatrixCache={});if(c.key===a)return c.value;var d=this._calcTranslateMatrix(),_={angle:this.angle,translateX:d[4],translateY:d[5],scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY};return c.key=a,c.value=g.composeMatrix(_),c.value},_getNonTransformedDimensions:function(){var a=this.strokeWidth,c=this.width+a,d=this.height+a;return{x:c,y:d}},_getTransformedDimensions:function(a,c){typeof a>"u"&&(a=this.skewX),typeof c>"u"&&(c=this.skewY);var d,_,u,C=a===0&&c===0;if(this.strokeUniform?(_=this.width,u=this.height):(d=this._getNonTransformedDimensions(),_=d.x,u=d.y),C)return this._finalizeDimensions(_*this.scaleX,u*this.scaleY);var S=g.sizeAfterTransform(_,u,{scaleX:this.scaleX,scaleY:this.scaleY,skewX:a,skewY:c});return this._finalizeDimensions(S.x,S.y)},_finalizeDimensions:function(a,c){return this.strokeUniform?{x:a+this.strokeWidth,y:c+this.strokeWidth}:{x:a,y:c}},_calculateCurrentDimensions:function(){var a=this.getViewportTransform(),c=this._getTransformedDimensions(),d=h(c,a,!0);return d.scalarAdd(2*this.padding)}})}(),I.util.object.extend(I.Object.prototype,{sendToBack:function(){return this.group?I.StaticCanvas.prototype.sendToBack.call(this.group,this):this.canvas&&this.canvas.sendToBack(this),this},bringToFront:function(){return this.group?I.StaticCanvas.prototype.bringToFront.call(this.group,this):this.canvas&&this.canvas.bringToFront(this),this},sendBackwards:function(n){return this.group?I.StaticCanvas.prototype.sendBackwards.call(this.group,this,n):this.canvas&&this.canvas.sendBackwards(this,n),this},bringForward:function(n){return this.group?I.StaticCanvas.prototype.bringForward.call(this.group,this,n):this.canvas&&this.canvas.bringForward(this,n),this},moveTo:function(n){return this.group&&this.group.type!=="activeSelection"?I.StaticCanvas.prototype.moveTo.call(this.group,this,n):this.canvas&&this.canvas.moveTo(this,n),this}}),function(){function n(x,v){if(v){if(v.toLive)return x+": url(#SVGID_"+v.id+"); ";var h=new I.Color(v),a=x+": "+h.toRgb()+"; ",c=h.getAlpha();return c!==1&&(a+=x+"-opacity: "+c.toString()+"; "),a}else return x+": none; "}var g=I.util.toFixed;I.util.object.extend(I.Object.prototype,{getSvgStyles:function(x){var v=this.fillRule?this.fillRule:"nonzero",h=this.strokeWidth?this.strokeWidth:"0",a=this.strokeDashArray?this.strokeDashArray.join(" "):"none",c=this.strokeDashOffset?this.strokeDashOffset:"0",d=this.strokeLineCap?this.strokeLineCap:"butt",_=this.strokeLineJoin?this.strokeLineJoin:"miter",u=this.strokeMiterLimit?this.strokeMiterLimit:"4",C=typeof this.opacity<"u"?this.opacity:"1",S=this.visible?"":" visibility: hidden;",A=x?"":this.getSvgFilter(),O=n("fill",this.fill),U=n("stroke",this.stroke);return[U,"stroke-width: ",h,"; ","stroke-dasharray: ",a,"; ","stroke-linecap: ",d,"; ","stroke-dashoffset: ",c,"; ","stroke-linejoin: ",_,"; ","stroke-miterlimit: ",u,"; ",O,"fill-rule: ",v,"; ","opacity: ",C,";",A,S].join("")},getSvgSpanStyles:function(x,v){var h="; ",c=x.fontFamily?"font-family: "+(x.fontFamily.indexOf("'")===-1&&x.fontFamily.indexOf('"')===-1?"'"+x.fontFamily+"'":x.fontFamily)+h:"",a=x.strokeWidth?"stroke-width: "+x.strokeWidth+h:"",c=c,d=x.fontSize?"font-size: "+x.fontSize+"px"+h:"",_=x.fontStyle?"font-style: "+x.fontStyle+h:"",u=x.fontWeight?"font-weight: "+x.fontWeight+h:"",C=x.fill?n("fill",x.fill):"",S=x.stroke?n("stroke",x.stroke):"",A=this.getSvgTextDecoration(x),O=x.deltaY?"baseline-shift: "+-x.deltaY+"; ":"";return A&&(A="text-decoration: "+A+h),[S,a,c,d,_,u,A,C,O,v?"white-space: pre; ":""].join("")},getSvgTextDecoration:function(x){return["overline","underline","line-through"].filter(function(v){return x[v.replace("-","")]}).join(" ")},getSvgFilter:function(){return this.shadow?"filter: url(#SVGID_"+this.shadow.id+");":""},getSvgCommons:function(){return[this.id?'id="'+this.id+'" ':"",this.clipPath?'clip-path="url(#'+this.clipPath.clipPathId+')" ':""].join("")},getSvgTransform:function(x,v){var h=x?this.calcTransformMatrix():this.calcOwnMatrix(),a='transform="'+I.util.matrixToSVG(h);return a+(v||"")+'" '},_setSVGBg:function(x){if(this.backgroundColor){var v=I.Object.NUM_FRACTION_DIGITS;x.push("		<rect ",this._getFillAttributes(this.backgroundColor),' x="',g(-this.width/2,v),'" y="',g(-this.height/2,v),'" width="',g(this.width,v),'" height="',g(this.height,v),`"></rect>
`)}},toSVG:function(x){return this._createBaseSVGMarkup(this._toSVG(x),{reviver:x})},toClipPathSVG:function(x){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(x),{reviver:x})},_createBaseClipPathSVGMarkup:function(x,v){v=v||{};var h=v.reviver,a=v.additionalTransform||"",c=[this.getSvgTransform(!0,a),this.getSvgCommons()].join(""),d=x.indexOf("COMMON_PARTS");return x[d]=c,h?h(x.join("")):x.join("")},_createBaseSVGMarkup:function(x,v){v=v||{};var h=v.noStyle,a=v.reviver,c=h?"":'style="'+this.getSvgStyles()+'" ',d=v.withShadow?'style="'+this.getSvgFilter()+'" ':"",_=this.clipPath,u=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",C=_&&_.absolutePositioned,S=this.stroke,A=this.fill,O=this.shadow,U,Y=[],oe,ge=x.indexOf("COMMON_PARTS"),ze=v.additionalTransform;return _&&(_.clipPathId="CLIPPATH_"+I.Object.__uid++,oe='<clipPath id="'+_.clipPathId+`" >
`+_.toClipPathSVG(a)+`</clipPath>
`),C&&Y.push("<g ",d,this.getSvgCommons(),` >
`),Y.push("<g ",this.getSvgTransform(!1),C?"":d+this.getSvgCommons(),` >
`),U=[c,u,h?"":this.addPaintOrder()," ",ze?'transform="'+ze+'" ':""].join(""),x[ge]=U,A&&A.toLive&&Y.push(A.toSVG(this)),S&&S.toLive&&Y.push(S.toSVG(this)),O&&Y.push(O.toSVG(this)),_&&Y.push(oe),Y.push(x.join("")),Y.push(`</g>
`),C&&Y.push(`</g>
`),a?a(Y.join("")):Y.join("")},addPaintOrder:function(){return this.paintFirst!=="fill"?' paint-order="'+this.paintFirst+'" ':""}})}(),function(){var n=I.util.object.extend,g="stateProperties";function x(h,a,c){var d={},_=!0;c.forEach(function(u){d[u]=h[u]}),n(h[a],d,_)}function v(h,a,c){if(h===a)return!0;if(Array.isArray(h)){if(!Array.isArray(a)||h.length!==a.length)return!1;for(var d=0,_=h.length;d<_;d++)if(!v(h[d],a[d]))return!1;return!0}else if(h&&typeof h=="object"){var u=Object.keys(h),C;if(!a||typeof a!="object"||!c&&u.length!==Object.keys(a).length)return!1;for(var d=0,_=u.length;d<_;d++)if(C=u[d],!(C==="canvas"||C==="group")&&!v(h[C],a[C]))return!1;return!0}}I.util.object.extend(I.Object.prototype,{hasStateChanged:function(h){h=h||g;var a="_"+h;return Object.keys(this[a]).length<this[h].length?!0:!v(this[a],this,!0)},saveState:function(h){var a=h&&h.propertySet||g,c="_"+a;return this[c]?(x(this,c,this[a]),h&&h.stateProperties&&x(this,c,h.stateProperties),this):this.setupState(h)},setupState:function(h){h=h||{};var a=h.propertySet||g;return h.propertySet=a,this["_"+a]={},this.saveState(h),this}})}(),function(){var n=I.util.degreesToRadians;I.util.object.extend(I.Object.prototype,{_findTargetCorner:function(g,x){if(!this.hasControls||this.group||!this.canvas||this.canvas._activeObject!==this)return!1;var v=g.x,h=g.y,a,c,d=Object.keys(this.oCoords),_=d.length-1,u;for(this.__corner=0;_>=0;_--)if(u=d[_],!!this.isControlVisible(u)&&(c=this._getImageLines(x?this.oCoords[u].touchCorner:this.oCoords[u].corner),a=this._findCrossPoints({x:v,y:h},c),a!==0&&a%2===1))return this.__corner=u,u;return!1},forEachControl:function(g){for(var x in this.controls)g(this.controls[x],x,this)},_setCornerCoords:function(){var g=this.oCoords;for(var x in g){var v=this.controls[x];g[x].corner=v.calcCornerCoords(this.angle,this.cornerSize,g[x].x,g[x].y,!1),g[x].touchCorner=v.calcCornerCoords(this.angle,this.touchCornerSize,g[x].x,g[x].y,!0)}},drawSelectionBackground:function(g){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return this;g.save();var x=this.getCenterPoint(),v=this._calculateCurrentDimensions(),h=this.canvas.viewportTransform;return g.translate(x.x,x.y),g.scale(1/h[0],1/h[3]),g.rotate(n(this.angle)),g.fillStyle=this.selectionBackgroundColor,g.fillRect(-v.x/2,-v.y/2,v.x,v.y),g.restore(),this},drawBorders:function(g,x){x=x||{};var v=this._calculateCurrentDimensions(),h=this.borderScaleFactor,a=v.x+h,c=v.y+h,d=typeof x.hasControls<"u"?x.hasControls:this.hasControls,_=!1;return g.save(),g.strokeStyle=x.borderColor||this.borderColor,this._setLineDash(g,x.borderDashArray||this.borderDashArray),g.strokeRect(-a/2,-c/2,a,c),d&&(g.beginPath(),this.forEachControl(function(u,C,S){u.withConnection&&u.getVisibility(S,C)&&(_=!0,g.moveTo(u.x*a,u.y*c),g.lineTo(u.x*a+u.offsetX,u.y*c+u.offsetY))}),_&&g.stroke()),g.restore(),this},drawBordersInGroup:function(g,x,v){v=v||{};var h=I.util.sizeAfterTransform(this.width,this.height,x),a=this.strokeWidth,c=this.strokeUniform,d=this.borderScaleFactor,_=h.x+a*(c?this.canvas.getZoom():x.scaleX)+d,u=h.y+a*(c?this.canvas.getZoom():x.scaleY)+d;return g.save(),this._setLineDash(g,v.borderDashArray||this.borderDashArray),g.strokeStyle=v.borderColor||this.borderColor,g.strokeRect(-_/2,-u/2,_,u),g.restore(),this},drawControls:function(g,x){x=x||{},g.save();var v=this.canvas.getRetinaScaling(),h,a;return g.setTransform(v,0,0,v,0,0),g.strokeStyle=g.fillStyle=x.cornerColor||this.cornerColor,this.transparentCorners||(g.strokeStyle=x.cornerStrokeColor||this.cornerStrokeColor),this._setLineDash(g,x.cornerDashArray||this.cornerDashArray),this.setCoords(),this.group&&(h=this.group.calcTransformMatrix()),this.forEachControl(function(c,d,_){a=_.oCoords[d],c.getVisibility(_,d)&&(h&&(a=I.util.transformPoint(a,h)),c.render(g,a.x,a.y,x,_))}),g.restore(),this},isControlVisible:function(g){return this.controls[g]&&this.controls[g].getVisibility(this,g)},setControlVisible:function(g,x){return this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[g]=x,this},setControlsVisibility:function(g){g||(g={});for(var x in g)this.setControlVisible(x,g[x]);return this},onDeselect:function(){},onSelect:function(){}})}(),I.util.object.extend(I.StaticCanvas.prototype,{FX_DURATION:500,fxCenterObjectH:function(n,g){g=g||{};var x=function(){},v=g.onComplete||x,h=g.onChange||x,a=this;return I.util.animate({target:this,startValue:n.left,endValue:this.getCenterPoint().x,duration:this.FX_DURATION,onChange:function(c){n.set("left",c),a.requestRenderAll(),h()},onComplete:function(){n.setCoords(),v()}})},fxCenterObjectV:function(n,g){g=g||{};var x=function(){},v=g.onComplete||x,h=g.onChange||x,a=this;return I.util.animate({target:this,startValue:n.top,endValue:this.getCenterPoint().y,duration:this.FX_DURATION,onChange:function(c){n.set("top",c),a.requestRenderAll(),h()},onComplete:function(){n.setCoords(),v()}})},fxRemove:function(n,g){g=g||{};var x=function(){},v=g.onComplete||x,h=g.onChange||x,a=this;return I.util.animate({target:this,startValue:n.opacity,endValue:0,duration:this.FX_DURATION,onChange:function(c){n.set("opacity",c),a.requestRenderAll(),h()},onComplete:function(){a.remove(n),v()}})}}),I.util.object.extend(I.Object.prototype,{animate:function(){if(arguments[0]&&typeof arguments[0]=="object"){var n=[],g,x,v=[];for(g in arguments[0])n.push(g);for(var h=0,a=n.length;h<a;h++)g=n[h],x=h!==a-1,v.push(this._animate(g,arguments[0][g],arguments[1],x));return v}else return this._animate.apply(this,arguments)},_animate:function(n,g,x,v){var h=this,a;g=g.toString(),x?x=I.util.object.clone(x):x={},~n.indexOf(".")&&(a=n.split("."));var c=h.colorProperties.indexOf(n)>-1||a&&h.colorProperties.indexOf(a[1])>-1,d=a?this.get(a[0])[a[1]]:this.get(n);"from"in x||(x.from=d),c||(~g.indexOf("=")?g=d+parseFloat(g.replace("=","")):g=parseFloat(g));var _={target:this,startValue:x.from,endValue:g,byValue:x.by,easing:x.easing,duration:x.duration,abort:x.abort&&function(u,C,S){return x.abort.call(h,u,C,S)},onChange:function(u,C,S){a?h[a[0]][a[1]]=u:h.set(n,u),!v&&x.onChange&&x.onChange(u,C,S)},onComplete:function(u,C,S){v||(h.setCoords(),x.onComplete&&x.onComplete(u,C,S))}};return c?I.util.animateColor(_.startValue,_.endValue,_.duration,_):I.util.animate(_)}}),function(n){var g=n.fabric||(n.fabric={}),x=g.util.object.extend,v=g.util.object.clone,h={x1:1,x2:1,y1:1,y2:1};if(g.Line){g.warn("fabric.Line is already defined");return}g.Line=g.util.createClass(g.Object,{type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:g.Object.prototype.cacheProperties.concat("x1","x2","y1","y2"),initialize:function(c,d){c||(c=[0,0,0,0]),this.callSuper("initialize",d),this.set("x1",c[0]),this.set("y1",c[1]),this.set("x2",c[2]),this.set("y2",c[3]),this._setWidthHeight(d)},_setWidthHeight:function(c){c||(c={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in c?c.left:this._getLeftToOriginX(),this.top="top"in c?c.top:this._getTopToOriginY()},_set:function(c,d){return this.callSuper("_set",c,d),typeof h[c]<"u"&&this._setWidthHeight(),this},_getLeftToOriginX:a({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"}),_getTopToOriginY:a({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"}),_render:function(c){c.beginPath();var d=this.calcLinePoints();c.moveTo(d.x1,d.y1),c.lineTo(d.x2,d.y2),c.lineWidth=this.strokeWidth;var _=c.strokeStyle;c.strokeStyle=this.stroke||c.fillStyle,this.stroke&&this._renderStroke(c),c.strokeStyle=_},_findCenterFromElement:function(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}},toObject:function(c){return x(this.callSuper("toObject",c),this.calcLinePoints())},_getNonTransformedDimensions:function(){var c=this.callSuper("_getNonTransformedDimensions");return this.strokeLineCap==="butt"&&(this.width===0&&(c.y-=this.strokeWidth),this.height===0&&(c.x-=this.strokeWidth)),c},calcLinePoints:function(){var c=this.x1<=this.x2?-1:1,d=this.y1<=this.y2?-1:1,_=c*this.width*.5,u=d*this.height*.5,C=c*this.width*-.5,S=d*this.height*-.5;return{x1:_,x2:C,y1:u,y2:S}},_toSVG:function(){var c=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',c.x1,'" y1="',c.y1,'" x2="',c.x2,'" y2="',c.y2,`" />
`]}}),g.Line.ATTRIBUTE_NAMES=g.SHARED_ATTRIBUTES.concat("x1 y1 x2 y2".split(" ")),g.Line.fromElement=function(c,d,_){_=_||{};var u=g.parseAttributes(c,g.Line.ATTRIBUTE_NAMES),C=[u.x1||0,u.y1||0,u.x2||0,u.y2||0];d(new g.Line(C,x(u,_)))},g.Line.fromObject=function(c,d){function _(C){delete C.points,d&&d(C)}var u=v(c,!0);u.points=[c.x1,c.y1,c.x2,c.y2],g.Object._fromObject("Line",u,_,"points")};function a(c,d){var _=c.origin,u=c.axis1,C=c.axis2,S=c.dimension,A=d.nearest,O=d.center,U=d.farthest;return function(){switch(this.get(_)){case A:return Math.min(this.get(u),this.get(C));case O:return Math.min(this.get(u),this.get(C))+.5*this.get(S);case U:return Math.max(this.get(u),this.get(C))}}}}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.util.degreesToRadians;if(g.Circle){g.warn("fabric.Circle is already defined.");return}g.Circle=g.util.createClass(g.Object,{type:"circle",radius:0,startAngle:0,endAngle:360,cacheProperties:g.Object.prototype.cacheProperties.concat("radius","startAngle","endAngle"),_set:function(h,a){return this.callSuper("_set",h,a),h==="radius"&&this.setRadius(a),this},toObject:function(h){return this.callSuper("toObject",["radius","startAngle","endAngle"].concat(h))},_toSVG:function(){var h,a=0,c=0,d=(this.endAngle-this.startAngle)%360;if(d===0)h=["<circle ","COMMON_PARTS",'cx="'+a+'" cy="'+c+'" ','r="',this.radius,`" />
`];else{var _=x(this.startAngle),u=x(this.endAngle),C=this.radius,S=g.util.cos(_)*C,A=g.util.sin(_)*C,O=g.util.cos(u)*C,U=g.util.sin(u)*C,Y=d>180?"1":"0";h=['<path d="M '+S+" "+A," A "+C+" "+C," 0 ",+Y+" 1"," "+O+" "+U,'" ',"COMMON_PARTS",` />
`]}return h},_render:function(h){h.beginPath(),h.arc(0,0,this.radius,x(this.startAngle),x(this.endAngle),!1),this._renderPaintInOrder(h)},getRadiusX:function(){return this.get("radius")*this.get("scaleX")},getRadiusY:function(){return this.get("radius")*this.get("scaleY")},setRadius:function(h){return this.radius=h,this.set("width",h*2).set("height",h*2)}}),g.Circle.ATTRIBUTE_NAMES=g.SHARED_ATTRIBUTES.concat("cx cy r".split(" ")),g.Circle.fromElement=function(h,a){var c=g.parseAttributes(h,g.Circle.ATTRIBUTE_NAMES);if(!v(c))throw new Error("value of `r` attribute is required and can not be negative");c.left=(c.left||0)-c.radius,c.top=(c.top||0)-c.radius,a(new g.Circle(c))};function v(h){return"radius"in h&&h.radius>=0}g.Circle.fromObject=function(h,a){g.Object._fromObject("Circle",h,a)}}(Ne),function(n){var g=n.fabric||(n.fabric={});if(g.Triangle){g.warn("fabric.Triangle is already defined");return}g.Triangle=g.util.createClass(g.Object,{type:"triangle",width:100,height:100,_render:function(x){var v=this.width/2,h=this.height/2;x.beginPath(),x.moveTo(-v,h),x.lineTo(0,-h),x.lineTo(v,h),x.closePath(),this._renderPaintInOrder(x)},_toSVG:function(){var x=this.width/2,v=this.height/2,h=[-x+" "+v,"0 "+-v,x+" "+v].join(",");return["<polygon ","COMMON_PARTS",'points="',h,'" />']}}),g.Triangle.fromObject=function(x,v){return g.Object._fromObject("Triangle",x,v)}}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=Math.PI*2;if(g.Ellipse){g.warn("fabric.Ellipse is already defined.");return}g.Ellipse=g.util.createClass(g.Object,{type:"ellipse",rx:0,ry:0,cacheProperties:g.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(v){this.callSuper("initialize",v),this.set("rx",v&&v.rx||0),this.set("ry",v&&v.ry||0)},_set:function(v,h){switch(this.callSuper("_set",v,h),v){case"rx":this.rx=h,this.set("width",h*2);break;case"ry":this.ry=h,this.set("height",h*2);break}return this},getRx:function(){return this.get("rx")*this.get("scaleX")},getRy:function(){return this.get("ry")*this.get("scaleY")},toObject:function(v){return this.callSuper("toObject",["rx","ry"].concat(v))},_toSVG:function(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,`" />
`]},_render:function(v){v.beginPath(),v.save(),v.transform(1,0,0,this.ry/this.rx,0,0),v.arc(0,0,this.rx,0,x,!1),v.restore(),this._renderPaintInOrder(v)}}),g.Ellipse.ATTRIBUTE_NAMES=g.SHARED_ATTRIBUTES.concat("cx cy rx ry".split(" ")),g.Ellipse.fromElement=function(v,h){var a=g.parseAttributes(v,g.Ellipse.ATTRIBUTE_NAMES);a.left=(a.left||0)-a.rx,a.top=(a.top||0)-a.ry,h(new g.Ellipse(a))},g.Ellipse.fromObject=function(v,h){g.Object._fromObject("Ellipse",v,h)}}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.util.object.extend;if(g.Rect){g.warn("fabric.Rect is already defined");return}g.Rect=g.util.createClass(g.Object,{stateProperties:g.Object.prototype.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:g.Object.prototype.cacheProperties.concat("rx","ry"),initialize:function(v){this.callSuper("initialize",v),this._initRxRy()},_initRxRy:function(){this.rx&&!this.ry?this.ry=this.rx:this.ry&&!this.rx&&(this.rx=this.ry)},_render:function(v){var h=this.rx?Math.min(this.rx,this.width/2):0,a=this.ry?Math.min(this.ry,this.height/2):0,c=this.width,d=this.height,_=-this.width/2,u=-this.height/2,C=h!==0||a!==0,S=1-.5522847498;v.beginPath(),v.moveTo(_+h,u),v.lineTo(_+c-h,u),C&&v.bezierCurveTo(_+c-S*h,u,_+c,u+S*a,_+c,u+a),v.lineTo(_+c,u+d-a),C&&v.bezierCurveTo(_+c,u+d-S*a,_+c-S*h,u+d,_+c-h,u+d),v.lineTo(_+h,u+d),C&&v.bezierCurveTo(_+S*h,u+d,_,u+d-S*a,_,u+d-a),v.lineTo(_,u+a),C&&v.bezierCurveTo(_,u+S*a,_+S*h,u,_+h,u),v.closePath(),this._renderPaintInOrder(v)},toObject:function(v){return this.callSuper("toObject",["rx","ry"].concat(v))},_toSVG:function(){var v=-this.width/2,h=-this.height/2;return["<rect ","COMMON_PARTS",'x="',v,'" y="',h,'" rx="',this.rx,'" ry="',this.ry,'" width="',this.width,'" height="',this.height,`" />
`]}}),g.Rect.ATTRIBUTE_NAMES=g.SHARED_ATTRIBUTES.concat("x y rx ry width height".split(" ")),g.Rect.fromElement=function(v,h,a){if(!v)return h(null);a=a||{};var c=g.parseAttributes(v,g.Rect.ATTRIBUTE_NAMES);c.left=c.left||0,c.top=c.top||0,c.height=c.height||0,c.width=c.width||0;var d=new g.Rect(x(a?g.util.object.clone(a):{},c));d.visible=d.visible&&d.width>0&&d.height>0,h(d)},g.Rect.fromObject=function(v,h){return g.Object._fromObject("Rect",v,h)}}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.util.object.extend,v=g.util.array.min,h=g.util.array.max,a=g.util.toFixed,c=g.util.projectStrokeOnPoints;if(g.Polyline){g.warn("fabric.Polyline is already defined");return}g.Polyline=g.util.createClass(g.Object,{type:"polyline",points:null,exactBoundingBox:!1,cacheProperties:g.Object.prototype.cacheProperties.concat("points"),initialize:function(d,_){_=_||{},this.points=d||[],this.callSuper("initialize",_),this._setPositionDimensions(_)},_projectStrokeOnPoints:function(){return c(this.points,this,!0)},_setPositionDimensions:function(d){var _=this._calcDimensions(d),u,C=this.exactBoundingBox?this.strokeWidth:0;this.width=_.width-C,this.height=_.height-C,d.fromSVG||(u=this.translateToGivenOrigin({x:_.left-this.strokeWidth/2+C/2,y:_.top-this.strokeWidth/2+C/2},"left","top",this.originX,this.originY)),typeof d.left>"u"&&(this.left=d.fromSVG?_.left:u.x),typeof d.top>"u"&&(this.top=d.fromSVG?_.top:u.y),this.pathOffset={x:_.left+this.width/2+C/2,y:_.top+this.height/2+C/2}},_calcDimensions:function(){var d=this.exactBoundingBox?this._projectStrokeOnPoints():this.points,_=v(d,"x")||0,u=v(d,"y")||0,C=h(d,"x")||0,S=h(d,"y")||0,A=C-_,O=S-u;return{left:_,top:u,width:A,height:O}},toObject:function(d){return x(this.callSuper("toObject",d),{points:this.points.concat()})},_toSVG:function(){for(var d=[],_=this.pathOffset.x,u=this.pathOffset.y,C=g.Object.NUM_FRACTION_DIGITS,S=0,A=this.points.length;S<A;S++)d.push(a(this.points[S].x-_,C),",",a(this.points[S].y-u,C)," ");return["<"+this.type+" ","COMMON_PARTS",'points="',d.join(""),`" />
`]},commonRender:function(d){var _,u=this.points.length,C=this.pathOffset.x,S=this.pathOffset.y;if(!u||isNaN(this.points[u-1].y))return!1;d.beginPath(),d.moveTo(this.points[0].x-C,this.points[0].y-S);for(var A=0;A<u;A++)_=this.points[A],d.lineTo(_.x-C,_.y-S);return!0},_render:function(d){!this.commonRender(d)||this._renderPaintInOrder(d)},complexity:function(){return this.get("points").length}}),g.Polyline.ATTRIBUTE_NAMES=g.SHARED_ATTRIBUTES.concat(),g.Polyline.fromElementGenerator=function(d){return function(_,u,C){if(!_)return u(null);C||(C={});var S=g.parsePointsAttribute(_.getAttribute("points")),A=g.parseAttributes(_,g[d].ATTRIBUTE_NAMES);A.fromSVG=!0,u(new g[d](S,x(A,C)))}},g.Polyline.fromElement=g.Polyline.fromElementGenerator("Polyline"),g.Polyline.fromObject=function(d,_){return g.Object._fromObject("Polyline",d,_,"points")}}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.util.projectStrokeOnPoints;if(g.Polygon){g.warn("fabric.Polygon is already defined");return}g.Polygon=g.util.createClass(g.Polyline,{type:"polygon",_projectStrokeOnPoints:function(){return x(this.points,this)},_render:function(v){!this.commonRender(v)||(v.closePath(),this._renderPaintInOrder(v))}}),g.Polygon.ATTRIBUTE_NAMES=g.SHARED_ATTRIBUTES.concat(),g.Polygon.fromElement=g.Polyline.fromElementGenerator("Polygon"),g.Polygon.fromObject=function(v,h){g.Object._fromObject("Polygon",v,h,"points")}}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.util.array.min,v=g.util.array.max,h=g.util.object.extend,a=g.util.object.clone,c=g.util.toFixed;if(g.Path){g.warn("fabric.Path is already defined");return}g.Path=g.util.createClass(g.Object,{type:"path",path:null,cacheProperties:g.Object.prototype.cacheProperties.concat("path","fillRule"),stateProperties:g.Object.prototype.stateProperties.concat("path"),initialize:function(d,_){_=a(_||{}),delete _.path,this.callSuper("initialize",_),this._setPath(d||[],_)},_setPath:function(d,_){this.path=g.util.makePathSimpler(Array.isArray(d)?d:g.util.parsePath(d)),g.Polyline.prototype._setPositionDimensions.call(this,_||{})},_renderPathCommands:function(d){var _,u=0,C=0,S=0,A=0,O=0,U=0,Y=-this.pathOffset.x,oe=-this.pathOffset.y;d.beginPath();for(var ge=0,ze=this.path.length;ge<ze;++ge)switch(_=this.path[ge],_[0]){case"L":S=_[1],A=_[2],d.lineTo(S+Y,A+oe);break;case"M":S=_[1],A=_[2],u=S,C=A,d.moveTo(S+Y,A+oe);break;case"C":S=_[5],A=_[6],O=_[3],U=_[4],d.bezierCurveTo(_[1]+Y,_[2]+oe,O+Y,U+oe,S+Y,A+oe);break;case"Q":d.quadraticCurveTo(_[1]+Y,_[2]+oe,_[3]+Y,_[4]+oe),S=_[3],A=_[4],O=_[1],U=_[2];break;case"z":case"Z":S=u,A=C,d.closePath();break}},_render:function(d){this._renderPathCommands(d),this._renderPaintInOrder(d)},toString:function(){return"#<fabric.Path ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(d){return h(this.callSuper("toObject",d),{path:this.path.map(function(_){return _.slice()})})},toDatalessObject:function(d){var _=this.toObject(["sourcePath"].concat(d));return _.sourcePath&&delete _.path,_},_toSVG:function(){var d=g.util.joinPath(this.path);return["<path ","COMMON_PARTS",'d="',d,'" stroke-linecap="round" ',`/>
`]},_getOffsetTransform:function(){var d=g.Object.NUM_FRACTION_DIGITS;return" translate("+c(-this.pathOffset.x,d)+", "+c(-this.pathOffset.y,d)+")"},toClipPathSVG:function(d){var _=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:d,additionalTransform:_})},toSVG:function(d){var _=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:d,additionalTransform:_})},complexity:function(){return this.path.length},_calcDimensions:function(){for(var d=[],_=[],u,C=0,S=0,A=0,O=0,U,Y=0,oe=this.path.length;Y<oe;++Y){switch(u=this.path[Y],u[0]){case"L":A=u[1],O=u[2],U=[];break;case"M":A=u[1],O=u[2],C=A,S=O,U=[];break;case"C":U=g.util.getBoundsOfCurve(A,O,u[1],u[2],u[3],u[4],u[5],u[6]),A=u[5],O=u[6];break;case"Q":U=g.util.getBoundsOfCurve(A,O,u[1],u[2],u[1],u[2],u[3],u[4]),A=u[3],O=u[4];break;case"z":case"Z":A=C,O=S;break}U.forEach(function(rt){d.push(rt.x),_.push(rt.y)}),d.push(A),_.push(O)}var ge=x(d)||0,ze=x(_)||0,We=v(d)||0,at=v(_)||0,_t=We-ge,vt=at-ze;return{left:ge,top:ze,width:_t,height:vt}}}),g.Path.fromObject=function(d,_){if(typeof d.sourcePath=="string"){var u=d.sourcePath;g.loadSVGFromURL(u,function(C){var S=C[0];S.setOptions(d),d.clipPath?g.util.enlivenObjects([d.clipPath],function(A){S.clipPath=A[0],_&&_(S)}):_&&_(S)})}else g.Object._fromObject("Path",d,_,"path")},g.Path.ATTRIBUTE_NAMES=g.SHARED_ATTRIBUTES.concat(["d"]),g.Path.fromElement=function(d,_,u){var C=g.parseAttributes(d,g.Path.ATTRIBUTE_NAMES);C.fromSVG=!0,_(new g.Path(C.d,h(C,u)))}}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.util.array.min,v=g.util.array.max;g.Group||(g.Group=g.util.createClass(g.Object,g.Collection,{type:"group",strokeWidth:0,subTargetCheck:!1,cacheProperties:[],useSetOnGroup:!1,initialize:function(h,a,c){a=a||{},this._objects=[],c&&this.callSuper("initialize",a),this._objects=h||[];for(var d=this._objects.length;d--;)this._objects[d].group=this;if(c)this._updateObjectsACoords();else{var _=a&&a.centerPoint;a.originX!==void 0&&(this.originX=a.originX),a.originY!==void 0&&(this.originY=a.originY),_||this._calcBounds(),this._updateObjectsCoords(_),delete a.centerPoint,this.callSuper("initialize",a)}this.setCoords()},_updateObjectsACoords:function(){for(var h=!0,a=this._objects.length;a--;)this._objects[a].setCoords(h)},_updateObjectsCoords:function(a){for(var a=a||this.getCenterPoint(),c=this._objects.length;c--;)this._updateObjectCoords(this._objects[c],a)},_updateObjectCoords:function(h,a){var c=h.left,d=h.top,_=!0;h.set({left:c-a.x,top:d-a.y}),h.group=this,h.setCoords(_)},toString:function(){return"#<fabric.Group: ("+this.complexity()+")>"},addWithUpdate:function(h){var a=!!this.group;return this._restoreObjectsState(),g.util.resetObjectTransform(this),h&&(a&&g.util.removeTransformFromObject(h,this.group.calcTransformMatrix()),this._objects.push(h),h.group=this,h._set("canvas",this.canvas)),this._calcBounds(),this._updateObjectsCoords(),this.dirty=!0,a?this.group.addWithUpdate():this.setCoords(),this},removeWithUpdate:function(h){return this._restoreObjectsState(),g.util.resetObjectTransform(this),this.remove(h),this._calcBounds(),this._updateObjectsCoords(),this.setCoords(),this.dirty=!0,this},_onObjectAdded:function(h){this.dirty=!0,h.group=this,h._set("canvas",this.canvas)},_onObjectRemoved:function(h){this.dirty=!0,delete h.group},_set:function(h,a){var c=this._objects.length;if(this.useSetOnGroup)for(;c--;)this._objects[c].setOnGroup(h,a);if(h==="canvas")for(;c--;)this._objects[c]._set(h,a);g.Object.prototype._set.call(this,h,a)},toObject:function(h){var a=this.includeDefaultValues,c=this._objects.filter(function(_){return!_.excludeFromExport}).map(function(_){var u=_.includeDefaultValues;_.includeDefaultValues=a;var C=_.toObject(h);return _.includeDefaultValues=u,C}),d=g.Object.prototype.toObject.call(this,h);return d.objects=c,d},toDatalessObject:function(h){var a,c=this.sourcePath;if(c)a=c;else{var d=this.includeDefaultValues;a=this._objects.map(function(u){var C=u.includeDefaultValues;u.includeDefaultValues=d;var S=u.toDatalessObject(h);return u.includeDefaultValues=C,S})}var _=g.Object.prototype.toDatalessObject.call(this,h);return _.objects=a,_},render:function(h){this._transformDone=!0,this.callSuper("render",h),this._transformDone=!1},shouldCache:function(){var h=g.Object.prototype.shouldCache.call(this);if(h){for(var a=0,c=this._objects.length;a<c;a++)if(this._objects[a].willDrawShadow())return this.ownCaching=!1,!1}return h},willDrawShadow:function(){if(g.Object.prototype.willDrawShadow.call(this))return!0;for(var h=0,a=this._objects.length;h<a;h++)if(this._objects[h].willDrawShadow())return!0;return!1},isOnACache:function(){return this.ownCaching||this.group&&this.group.isOnACache()},drawObject:function(h){for(var a=0,c=this._objects.length;a<c;a++)this._objects[a].render(h);this._drawClipPath(h,this.clipPath)},isCacheDirty:function(h){if(this.callSuper("isCacheDirty",h))return!0;if(!this.statefullCache)return!1;for(var a=0,c=this._objects.length;a<c;a++)if(this._objects[a].isCacheDirty(!0)){if(this._cacheCanvas){var d=this.cacheWidth/this.zoomX,_=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-d/2,-_/2,d,_)}return!0}return!1},_restoreObjectsState:function(){var h=this.calcOwnMatrix();return this._objects.forEach(function(a){g.util.addTransformToObject(a,h),delete a.group,a.setCoords()}),this},destroy:function(){return this._objects.forEach(function(h){h.set("dirty",!0)}),this._restoreObjectsState()},dispose:function(){this.callSuper("dispose"),this.forEachObject(function(h){h.dispose&&h.dispose()}),this._objects=[]},toActiveSelection:function(){if(!!this.canvas){var h=this._objects,a=this.canvas;this._objects=[];var c=this.toObject();delete c.objects;var d=new g.ActiveSelection([]);return d.set(c),d.type="activeSelection",a.remove(this),h.forEach(function(_){_.group=d,_.dirty=!0,a.add(_)}),d.canvas=a,d._objects=h,a._activeObject=d,d.setCoords(),d}},ungroupOnCanvas:function(){return this._restoreObjectsState()},setObjectsCoords:function(){var h=!0;return this.forEachObject(function(a){a.setCoords(h)}),this},_calcBounds:function(h){for(var a=[],c=[],d,_,u,C=["tr","br","bl","tl"],S=0,A=this._objects.length,O,U=C.length;S<A;++S){for(d=this._objects[S],u=d.calcACoords(),O=0;O<U;O++)_=C[O],a.push(u[_].x),c.push(u[_].y);d.aCoords=u}this._getBounds(a,c,h)},_getBounds:function(h,a,c){var d=new g.Point(x(h),x(a)),_=new g.Point(v(h),v(a)),u=d.y||0,C=d.x||0,S=_.x-d.x||0,A=_.y-d.y||0;this.width=S,this.height=A,c||this.setPositionByOrigin({x:C,y:u},"left","top")},_toSVG:function(h){for(var a=["<g ","COMMON_PARTS",` >
`],c=0,d=this._objects.length;c<d;c++)a.push("		",this._objects[c].toSVG(h));return a.push(`</g>
`),a},getSvgStyles:function(){var h=typeof this.opacity<"u"&&this.opacity!==1?"opacity: "+this.opacity+";":"",a=this.visible?"":" visibility: hidden;";return[h,this.getSvgFilter(),a].join("")},toClipPathSVG:function(h){for(var a=[],c=0,d=this._objects.length;c<d;c++)a.push("	",this._objects[c].toClipPathSVG(h));return this._createBaseClipPathSVGMarkup(a,{reviver:h})}}),g.Group.fromObject=function(h,a){var c=h.objects,d=g.util.object.clone(h,!0);if(delete d.objects,typeof c=="string"){g.loadSVGFromURL(c,function(_){var u=g.util.groupSVGElements(_,h,c),C=d.clipPath;delete d.clipPath,u.set(d),C?g.util.enlivenObjects([C],function(S){u.clipPath=S[0],a&&a(u)}):a&&a(u)});return}g.util.enlivenObjects(c,function(_){g.util.enlivenObjectEnlivables(h,d,function(){a&&a(new g.Group(_,d,!0))})})})}(Ne),function(n){var g=n.fabric||(n.fabric={});g.ActiveSelection||(g.ActiveSelection=g.util.createClass(g.Group,{type:"activeSelection",initialize:function(x,v){v=v||{},this._objects=x||[];for(var h=this._objects.length;h--;)this._objects[h].group=this;v.originX&&(this.originX=v.originX),v.originY&&(this.originY=v.originY),this._calcBounds(),this._updateObjectsCoords(),g.Object.prototype.initialize.call(this,v),this.setCoords()},toGroup:function(){var x=this._objects.concat();this._objects=[];var v=g.Object.prototype.toObject.call(this),h=new g.Group([]);if(delete v.type,h.set(v),x.forEach(function(c){c.canvas.remove(c),c.group=h}),h._objects=x,!this.canvas)return h;var a=this.canvas;return a.add(h),a._activeObject=h,h.setCoords(),h},onDeselect:function(){return this.destroy(),!1},toString:function(){return"#<fabric.ActiveSelection: ("+this.complexity()+")>"},shouldCache:function(){return!1},isOnACache:function(){return!1},_renderControls:function(x,v,h){x.save(),x.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,this.callSuper("_renderControls",x,v),h=h||{},typeof h.hasControls>"u"&&(h.hasControls=!1),h.forActiveSelection=!0;for(var a=0,c=this._objects.length;a<c;a++)this._objects[a]._renderControls(x,h);x.restore()}}),g.ActiveSelection.fromObject=function(x,v){g.util.enlivenObjects(x.objects,function(h){delete x.objects,v&&v(new g.ActiveSelection(h,x,!0))})})}(Ne),function(n){var g=I.util.object.extend;if(n.fabric||(n.fabric={}),n.fabric.Image){I.warn("fabric.Image is already defined.");return}I.Image=I.util.createClass(I.Object,{type:"image",strokeWidth:0,srcFromAttribute:!1,_lastScaleX:1,_lastScaleY:1,_filterScalingX:1,_filterScalingY:1,minimumScaleTrigger:.5,stateProperties:I.Object.prototype.stateProperties.concat("cropX","cropY"),cacheProperties:I.Object.prototype.cacheProperties.concat("cropX","cropY"),cacheKey:"",cropX:0,cropY:0,imageSmoothing:!0,initialize:function(x,v){v||(v={}),this.filters=[],this.cacheKey="texture"+I.Object.__uid++,this.callSuper("initialize",v),this._initElement(x,v)},getElement:function(){return this._element||{}},setElement:function(x,v){return this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._element=x,this._originalElement=x,this._initConfig(v),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters(),this},removeTexture:function(x){var v=I.filterBackend;v&&v.evictCachesForKey&&v.evictCachesForKey(x)},dispose:function(){this.callSuper("dispose"),this.removeTexture(this.cacheKey),this.removeTexture(this.cacheKey+"_filtered"),this._cacheContext=void 0,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach(function(x){I.util.cleanUpJsdomNode(this[x]),this[x]=void 0}.bind(this))},getCrossOrigin:function(){return this._originalElement&&(this._originalElement.crossOrigin||null)},getOriginalSize:function(){var x=this.getElement();return{width:x.naturalWidth||x.width,height:x.naturalHeight||x.height}},_stroke:function(x){if(!(!this.stroke||this.strokeWidth===0)){var v=this.width/2,h=this.height/2;x.beginPath(),x.moveTo(-v,-h),x.lineTo(v,-h),x.lineTo(v,h),x.lineTo(-v,h),x.lineTo(-v,-h),x.closePath()}},toObject:function(x){var v=[];this.filters.forEach(function(a){a&&v.push(a.toObject())});var h=g(this.callSuper("toObject",["cropX","cropY"].concat(x)),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:v});return this.resizeFilter&&(h.resizeFilter=this.resizeFilter.toObject()),h},hasCrop:function(){return this.cropX||this.cropY||this.width<this._element.width||this.height<this._element.height},_toSVG:function(){var x=[],v=[],h,a=this._element,c=-this.width/2,d=-this.height/2,_="",u="";if(!a)return[];if(this.hasCrop()){var C=I.Object.__uid++;x.push('<clipPath id="imageCrop_'+C+`">
`,'	<rect x="'+c+'" y="'+d+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),_=' clip-path="url(#imageCrop_'+C+')" '}if(this.imageSmoothing||(u='" image-rendering="optimizeSpeed'),v.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',c-this.cropX,'" y="',d-this.cropY,'" width="',a.width||a.naturalWidth,'" height="',a.height||a.height,u,'"',_,`></image>
`),this.stroke||this.strokeDashArray){var S=this.fill;this.fill=null,h=["	<rect ",'x="',c,'" y="',d,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),`"/>
`],this.fill=S}return this.paintFirst!=="fill"?x=x.concat(h,v):x=x.concat(v,h),x},getSrc:function(x){var v=x?this._element:this._originalElement;return v?v.toDataURL?v.toDataURL():this.srcFromAttribute?v.getAttribute("src"):v.src:this.src||""},setSrc:function(x,v,h){return I.util.loadImage(x,function(a,c){this.setElement(a,h),this._setWidthHeight(),v&&v(this,c)},this,h&&h.crossOrigin),this},toString:function(){return'#<fabric.Image: { src: "'+this.getSrc()+'" }>'},applyResizeFilters:function(){var x=this.resizeFilter,v=this.minimumScaleTrigger,h=this.getTotalObjectScaling(),a=h.scaleX,c=h.scaleY,d=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!x||a>v&&c>v){this._element=d,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=a,this._lastScaleY=c;return}I.filterBackend||(I.filterBackend=I.initFilterBackend());var _=I.util.createCanvasElement(),u=this._filteredEl?this.cacheKey+"_filtered":this.cacheKey,C=d.width,S=d.height;_.width=C,_.height=S,this._element=_,this._lastScaleX=x.scaleX=a,this._lastScaleY=x.scaleY=c,I.filterBackend.applyFilters([x],d,C,S,this._element,u),this._filterScalingX=_.width/this._originalElement.width,this._filterScalingY=_.height/this._originalElement.height},applyFilters:function(x){if(x=x||this.filters||[],x=x.filter(function(d){return d&&!d.isNeutralState()}),this.set("dirty",!0),this.removeTexture(this.cacheKey+"_filtered"),x.length===0)return this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1,this;var v=this._originalElement,h=v.naturalWidth||v.width,a=v.naturalHeight||v.height;if(this._element===this._originalElement){var c=I.util.createCanvasElement();c.width=h,c.height=a,this._element=c,this._filteredEl=c}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,h,a),this._lastScaleX=1,this._lastScaleY=1;return I.filterBackend||(I.filterBackend=I.initFilterBackend()),I.filterBackend.applyFilters(x,this._originalElement,h,a,this._element,this.cacheKey),(this._originalElement.width!==this._element.width||this._originalElement.height!==this._element.height)&&(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height),this},_render:function(x){I.util.setImageSmoothing(x,this.imageSmoothing),this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(x),this._renderPaintInOrder(x)},drawCacheOnCanvas:function(x){I.util.setImageSmoothing(x,this.imageSmoothing),I.Object.prototype.drawCacheOnCanvas.call(this,x)},shouldCache:function(){return this.needsItsOwnCache()},_renderFill:function(x){var v=this._element;if(!!v){var h=this._filterScalingX,a=this._filterScalingY,c=this.width,d=this.height,_=Math.min,u=Math.max,C=u(this.cropX,0),S=u(this.cropY,0),A=v.naturalWidth||v.width,O=v.naturalHeight||v.height,U=C*h,Y=S*a,oe=_(c*h,A-U),ge=_(d*a,O-Y),ze=-c/2,We=-d/2,at=_(c,A/h-C),_t=_(d,O/a-S);v&&x.drawImage(v,U,Y,oe,ge,ze,We,at,_t)}},_needsResize:function(){var x=this.getTotalObjectScaling();return x.scaleX!==this._lastScaleX||x.scaleY!==this._lastScaleY},_resetWidthHeight:function(){this.set(this.getOriginalSize())},_initElement:function(x,v){this.setElement(I.util.getById(x),v),I.util.addClass(this.getElement(),I.Image.CSS_CANVAS)},_initConfig:function(x){x||(x={}),this.setOptions(x),this._setWidthHeight(x)},_initFilters:function(x,v){x&&x.length?I.util.enlivenObjects(x,function(h){v&&v(h)},"fabric.Image.filters"):v&&v()},_setWidthHeight:function(x){x||(x={});var v=this.getElement();this.width=x.width||v.naturalWidth||v.width||0,this.height=x.height||v.naturalHeight||v.height||0},parsePreserveAspectRatioAttribute:function(){var x=I.util.parsePreserveAspectRatioAttribute(this.preserveAspectRatio||""),v=this._element.width,h=this._element.height,a=1,c=1,d=0,_=0,u=0,C=0,S,A=this.width,O=this.height,U={width:A,height:O};return x&&(x.alignX!=="none"||x.alignY!=="none")?(x.meetOrSlice==="meet"&&(a=c=I.util.findScaleToFit(this._element,U),S=(A-v*a)/2,x.alignX==="Min"&&(d=-S),x.alignX==="Max"&&(d=S),S=(O-h*c)/2,x.alignY==="Min"&&(_=-S),x.alignY==="Max"&&(_=S)),x.meetOrSlice==="slice"&&(a=c=I.util.findScaleToCover(this._element,U),S=v-A/a,x.alignX==="Mid"&&(u=S/2),x.alignX==="Max"&&(u=S),S=h-O/c,x.alignY==="Mid"&&(C=S/2),x.alignY==="Max"&&(C=S),v=A/a,h=O/c)):(a=A/v,c=O/h),{width:v,height:h,scaleX:a,scaleY:c,offsetLeft:d,offsetTop:_,cropX:u,cropY:C}}}),I.Image.CSS_CANVAS="canvas-img",I.Image.prototype.getSvgSrc=I.Image.prototype.getSrc,I.Image.fromObject=function(x,v){var h=I.util.object.clone(x);I.util.loadImage(h.src,function(a,c){if(c){v&&v(null,!0);return}I.Image.prototype._initFilters.call(h,h.filters,function(d){h.filters=d||[],I.Image.prototype._initFilters.call(h,[h.resizeFilter],function(_){h.resizeFilter=_[0],I.util.enlivenObjectEnlivables(h,h,function(){var u=new I.Image(a,h);v(u,!1)})})})},null,h.crossOrigin)},I.Image.fromURL=function(x,v,h){I.util.loadImage(x,function(a,c){v&&v(new I.Image(a,h),c)},null,h&&h.crossOrigin)},I.Image.ATTRIBUTE_NAMES=I.SHARED_ATTRIBUTES.concat("x y width height preserveAspectRatio xlink:href crossOrigin image-rendering".split(" ")),I.Image.fromElement=function(x,v,h){var a=I.parseAttributes(x,I.Image.ATTRIBUTE_NAMES);I.Image.fromURL(a["xlink:href"],v,g(h?I.util.object.clone(h):{},a))}}(Ne),I.util.object.extend(I.Object.prototype,{_getAngleValueForStraighten:function(){var n=this.angle%360;return n>0?Math.round((n-1)/90)*90:Math.round(n/90)*90},straighten:function(){return this.rotate(this._getAngleValueForStraighten())},fxStraighten:function(n){n=n||{};var g=function(){},x=n.onComplete||g,v=n.onChange||g,h=this;return I.util.animate({target:this,startValue:this.get("angle"),endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:function(a){h.rotate(a),v()},onComplete:function(){h.setCoords(),x()}})}}),I.util.object.extend(I.StaticCanvas.prototype,{straightenObject:function(n){return n.straighten(),this.requestRenderAll(),this},fxStraightenObject:function(n){return n.fxStraighten({onChange:this.requestRenderAllBound})}}),function(){function n(x,v){var h="precision "+v+` float;
void main(){}`,a=x.createShader(x.FRAGMENT_SHADER);return x.shaderSource(a,h),x.compileShader(a),!!x.getShaderParameter(a,x.COMPILE_STATUS)}I.isWebglSupported=function(x){if(I.isLikelyNode)return!1;x=x||I.WebglFilterBackend.prototype.tileSize;var v=document.createElement("canvas"),h=v.getContext("webgl")||v.getContext("experimental-webgl"),a=!1;if(h){I.maxTextureSize=h.getParameter(h.MAX_TEXTURE_SIZE),a=I.maxTextureSize>=x;for(var c=["highp","mediump","lowp"],d=0;d<3;d++)if(n(h,c[d])){I.webGlPrecision=c[d];break}}return this.isSupported=a,a},I.WebglFilterBackend=g;function g(x){x&&x.tileSize&&(this.tileSize=x.tileSize),this.setupGLContext(this.tileSize,this.tileSize),this.captureGPUInfo()}g.prototype={tileSize:2048,resources:{},setupGLContext:function(x,v){this.dispose(),this.createWebGLCanvas(x,v),this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.chooseFastestCopyGLTo2DMethod(x,v)},chooseFastestCopyGLTo2DMethod:function(x,v){var h=typeof window.performance<"u",a;try{new ImageData(1,1),a=!0}catch{a=!1}var c=typeof ArrayBuffer<"u",d=typeof Uint8ClampedArray<"u";if(!!(h&&a&&c&&d)){var _=I.util.createCanvasElement(),u=new ArrayBuffer(x*v*4);if(I.forceGLPutImageData){this.imageBuffer=u,this.copyGLTo2D=ei;return}var C={imageBuffer:u,destinationWidth:x,destinationHeight:v,targetCanvas:_},S,A,O;_.width=x,_.height=v,S=window.performance.now(),Yt.call(C,this.gl,C),A=window.performance.now()-S,S=window.performance.now(),ei.call(C,this.gl,C),O=window.performance.now()-S,A>O?(this.imageBuffer=u,this.copyGLTo2D=ei):this.copyGLTo2D=Yt}},createWebGLCanvas:function(x,v){var h=I.util.createCanvasElement();h.width=x,h.height=v;var a={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},c=h.getContext("webgl",a);c||(c=h.getContext("experimental-webgl",a)),c&&(c.clearColor(0,0,0,0),this.canvas=h,this.gl=c)},applyFilters:function(x,v,h,a,c,d){var _=this.gl,u;d&&(u=this.getCachedTexture(d,v));var C={originalWidth:v.width||v.originalWidth,originalHeight:v.height||v.originalHeight,sourceWidth:h,sourceHeight:a,destinationWidth:h,destinationHeight:a,context:_,sourceTexture:this.createTexture(_,h,a,!u&&v),targetTexture:this.createTexture(_,h,a),originalTexture:u||this.createTexture(_,h,a,!u&&v),passes:x.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:c},S=_.createFramebuffer();return _.bindFramebuffer(_.FRAMEBUFFER,S),x.forEach(function(A){A&&A.applyTo(C)}),At(C),this.copyGLTo2D(_,C),_.bindTexture(_.TEXTURE_2D,null),_.deleteTexture(C.sourceTexture),_.deleteTexture(C.targetTexture),_.deleteFramebuffer(S),c.getContext("2d").setTransform(1,0,0,1,0,0),C},dispose:function(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()},clearWebGLCaches:function(){this.programCache={},this.textureCache={}},createTexture:function(x,v,h,a){var c=x.createTexture();return x.bindTexture(x.TEXTURE_2D,c),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),a?x.texImage2D(x.TEXTURE_2D,0,x.RGBA,x.RGBA,x.UNSIGNED_BYTE,a):x.texImage2D(x.TEXTURE_2D,0,x.RGBA,v,h,0,x.RGBA,x.UNSIGNED_BYTE,null),c},getCachedTexture:function(x,v){if(this.textureCache[x])return this.textureCache[x];var h=this.createTexture(this.gl,v.width,v.height,v);return this.textureCache[x]=h,h},evictCachesForKey:function(x){this.textureCache[x]&&(this.gl.deleteTexture(this.textureCache[x]),delete this.textureCache[x])},copyGLTo2D:Yt,captureGPUInfo:function(){if(this.gpuInfo)return this.gpuInfo;var x=this.gl,v={renderer:"",vendor:""};if(!x)return v;var h=x.getExtension("WEBGL_debug_renderer_info");if(h){var a=x.getParameter(h.UNMASKED_RENDERER_WEBGL),c=x.getParameter(h.UNMASKED_VENDOR_WEBGL);a&&(v.renderer=a.toLowerCase()),c&&(v.vendor=c.toLowerCase())}return this.gpuInfo=v,v}}}();function At(n){var g=n.targetCanvas,x=g.width,v=g.height,h=n.destinationWidth,a=n.destinationHeight;(x!==h||v!==a)&&(g.width=h,g.height=a)}function Yt(n,g){var x=n.canvas,v=g.targetCanvas,h=v.getContext("2d");h.translate(0,v.height),h.scale(1,-1);var a=x.height-v.height;h.drawImage(x,0,a,v.width,v.height,0,0,v.width,v.height)}function ei(n,g){var x=g.targetCanvas,v=x.getContext("2d"),h=g.destinationWidth,a=g.destinationHeight,c=h*a*4,d=new Uint8Array(this.imageBuffer,0,c),_=new Uint8ClampedArray(this.imageBuffer,0,c);n.readPixels(0,0,h,a,n.RGBA,n.UNSIGNED_BYTE,d);var u=new ImageData(_,h,a);v.putImageData(u,0,0)}(function(){var n=function(){};I.Canvas2dFilterBackend=g;function g(){}g.prototype={evictCachesForKey:n,dispose:n,clearWebGLCaches:n,resources:{},applyFilters:function(x,v,h,a,c){var d=c.getContext("2d");d.drawImage(v,0,0,h,a);var _=d.getImageData(0,0,h,a),u=d.getImageData(0,0,h,a),C={sourceWidth:h,sourceHeight:a,imageData:_,originalEl:v,originalImageData:u,canvasEl:c,ctx:d,filterBackend:this};return x.forEach(function(S){S.applyTo(C)}),(C.imageData.width!==h||C.imageData.height!==a)&&(c.width=C.imageData.width,c.height=C.imageData.height),d.putImageData(C.imageData,0,0),C}}})(),I.Image=I.Image||{},I.Image.filters=I.Image.filters||{},I.Image.filters.BaseFilter=I.util.createClass({type:"BaseFilter",vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
void main() {
vTexCoord = aPosition;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:`precision highp float;
varying vec2 vTexCoord;
uniform sampler2D uTexture;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
}`,initialize:function(n){n&&this.setOptions(n)},setOptions:function(n){for(var g in n)this[g]=n[g]},createProgram:function(n,g,x){g=g||this.fragmentSource,x=x||this.vertexSource,I.webGlPrecision!=="highp"&&(g=g.replace(/precision highp float/g,"precision "+I.webGlPrecision+" float"));var v=n.createShader(n.VERTEX_SHADER);if(n.shaderSource(v,x),n.compileShader(v),!n.getShaderParameter(v,n.COMPILE_STATUS))throw new Error("Vertex shader compile error for "+this.type+": "+n.getShaderInfoLog(v));var h=n.createShader(n.FRAGMENT_SHADER);if(n.shaderSource(h,g),n.compileShader(h),!n.getShaderParameter(h,n.COMPILE_STATUS))throw new Error("Fragment shader compile error for "+this.type+": "+n.getShaderInfoLog(h));var a=n.createProgram();if(n.attachShader(a,v),n.attachShader(a,h),n.linkProgram(a),!n.getProgramParameter(a,n.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+n.getProgramInfoLog(a));var c=this.getAttributeLocations(n,a),d=this.getUniformLocations(n,a)||{};return d.uStepW=n.getUniformLocation(a,"uStepW"),d.uStepH=n.getUniformLocation(a,"uStepH"),{program:a,attributeLocations:c,uniformLocations:d}},getAttributeLocations:function(n,g){return{aPosition:n.getAttribLocation(g,"aPosition")}},getUniformLocations:function(){return{}},sendAttributeData:function(n,g,x){var v=g.aPosition,h=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,h),n.enableVertexAttribArray(v),n.vertexAttribPointer(v,2,n.FLOAT,!1,0,0),n.bufferData(n.ARRAY_BUFFER,x,n.STATIC_DRAW)},_setupFrameBuffer:function(n){var g=n.context,x,v;n.passes>1?(x=n.destinationWidth,v=n.destinationHeight,(n.sourceWidth!==x||n.sourceHeight!==v)&&(g.deleteTexture(n.targetTexture),n.targetTexture=n.filterBackend.createTexture(g,x,v)),g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_2D,n.targetTexture,0)):(g.bindFramebuffer(g.FRAMEBUFFER,null),g.finish())},_swapTextures:function(n){n.passes--,n.pass++;var g=n.targetTexture;n.targetTexture=n.sourceTexture,n.sourceTexture=g},isNeutralState:function(){var n=this.mainParameter,g=I.Image.filters[this.type].prototype;if(n)if(Array.isArray(g[n])){for(var x=g[n].length;x--;)if(this[n][x]!==g[n][x])return!1;return!0}else return g[n]===this[n];else return!1},applyTo:function(n){n.webgl?(this._setupFrameBuffer(n),this.applyToWebGL(n),this._swapTextures(n)):this.applyTo2d(n)},retrieveShader:function(n){return n.programCache.hasOwnProperty(this.type)||(n.programCache[this.type]=this.createProgram(n.context)),n.programCache[this.type]},applyToWebGL:function(n){var g=n.context,x=this.retrieveShader(n);n.pass===0&&n.originalTexture?g.bindTexture(g.TEXTURE_2D,n.originalTexture):g.bindTexture(g.TEXTURE_2D,n.sourceTexture),g.useProgram(x.program),this.sendAttributeData(g,x.attributeLocations,n.aPosition),g.uniform1f(x.uniformLocations.uStepW,1/n.sourceWidth),g.uniform1f(x.uniformLocations.uStepH,1/n.sourceHeight),this.sendUniformData(g,x.uniformLocations),g.viewport(0,0,n.destinationWidth,n.destinationHeight),g.drawArrays(g.TRIANGLE_STRIP,0,4)},bindAdditionalTexture:function(n,g,x){n.activeTexture(x),n.bindTexture(n.TEXTURE_2D,g),n.activeTexture(n.TEXTURE0)},unbindAdditionalTexture:function(n,g){n.activeTexture(g),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE0)},getMainParameter:function(){return this[this.mainParameter]},setMainParameter:function(n){this[this.mainParameter]=n},sendUniformData:function(){},createHelpLayer:function(n){if(!n.helpLayer){var g=document.createElement("canvas");g.width=n.sourceWidth,g.height=n.sourceHeight,n.helpLayer=g}},toObject:function(){var n={type:this.type},g=this.mainParameter;return g&&(n[g]=this[g]),n},toJSON:function(){return this.toObject()}}),I.Image.filters.BaseFilter.fromObject=function(n,g){var x=new I.Image.filters[n.type](n);return g&&g(x),x},function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass;x.ColorMatrix=v(x.BaseFilter,{type:"ColorMatrix",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
uniform mat4 uColorMatrix;
uniform vec4 uConstants;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color *= uColorMatrix;
color += uConstants;
gl_FragColor = color;
}`,matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0,initialize:function(h){this.callSuper("initialize",h),this.matrix=this.matrix.slice(0)},applyTo2d:function(h){var a=h.imageData,c=a.data,d=c.length,_=this.matrix,u,C,S,A,O,U=this.colorsOnly;for(O=0;O<d;O+=4)u=c[O],C=c[O+1],S=c[O+2],U?(c[O]=u*_[0]+C*_[1]+S*_[2]+_[4]*255,c[O+1]=u*_[5]+C*_[6]+S*_[7]+_[9]*255,c[O+2]=u*_[10]+C*_[11]+S*_[12]+_[14]*255):(A=c[O+3],c[O]=u*_[0]+C*_[1]+S*_[2]+A*_[3]+_[4]*255,c[O+1]=u*_[5]+C*_[6]+S*_[7]+A*_[8]+_[9]*255,c[O+2]=u*_[10]+C*_[11]+S*_[12]+A*_[13]+_[14]*255,c[O+3]=u*_[15]+C*_[16]+S*_[17]+A*_[18]+_[19]*255)},getUniformLocations:function(h,a){return{uColorMatrix:h.getUniformLocation(a,"uColorMatrix"),uConstants:h.getUniformLocation(a,"uConstants")}},sendUniformData:function(h,a){var c=this.matrix,d=[c[0],c[1],c[2],c[3],c[5],c[6],c[7],c[8],c[10],c[11],c[12],c[13],c[15],c[16],c[17],c[18]],_=[c[4],c[9],c[14],c[19]];h.uniformMatrix4fv(a.uColorMatrix,!1,d),h.uniform4fv(a.uConstants,_)}}),g.Image.filters.ColorMatrix.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass;x.Brightness=v(x.BaseFilter,{type:"Brightness",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBrightness;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += uBrightness;
gl_FragColor = color;
}`,brightness:0,mainParameter:"brightness",applyTo2d:function(h){if(this.brightness!==0){var a=h.imageData,c=a.data,d,_=c.length,u=Math.round(this.brightness*255);for(d=0;d<_;d+=4)c[d]=c[d]+u,c[d+1]=c[d+1]+u,c[d+2]=c[d+2]+u}},getUniformLocations:function(h,a){return{uBrightness:h.getUniformLocation(a,"uBrightness")}},sendUniformData:function(h,a){h.uniform1f(a.uBrightness,this.brightness)}}),g.Image.filters.Brightness.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.util.object.extend,v=g.Image.filters,h=g.util.createClass;v.Convolute=h(v.BaseFilter,{type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_3_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[9];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 3.0; h+=1.0) {
for (float w = 0.0; w < 3.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_5_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_5_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[25];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 5.0; h+=1.0) {
for (float w = 0.0; w < 5.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_7_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_7_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[49];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 7.0; h+=1.0) {
for (float w = 0.0; w < 7.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`,Convolute_9_1:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 0);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
}
}
gl_FragColor = color;
}`,Convolute_9_0:`precision highp float;
uniform sampler2D uTexture;
uniform float uMatrix[81];
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
vec4 color = vec4(0, 0, 0, 1);
for (float h = 0.0; h < 9.0; h+=1.0) {
for (float w = 0.0; w < 9.0; w+=1.0) {
vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
}
}
float alpha = texture2D(uTexture, vTexCoord).a;
gl_FragColor = color;
gl_FragColor.a = alpha;
}`},retrieveShader:function(a){var c=Math.sqrt(this.matrix.length),d=this.type+"_"+c+"_"+(this.opaque?1:0),_=this.fragmentSource[d];return a.programCache.hasOwnProperty(d)||(a.programCache[d]=this.createProgram(a.context,_)),a.programCache[d]},applyTo2d:function(a){var c=a.imageData,d=c.data,_=this.matrix,u=Math.round(Math.sqrt(_.length)),C=Math.floor(u/2),S=c.width,A=c.height,O=a.ctx.createImageData(S,A),U=O.data,Y=this.opaque?1:0,oe,ge,ze,We,at,_t,vt,rt,mt,Qe,zt,Et,Q;for(zt=0;zt<A;zt++)for(Qe=0;Qe<S;Qe++){for(at=(zt*S+Qe)*4,oe=0,ge=0,ze=0,We=0,Q=0;Q<u;Q++)for(Et=0;Et<u;Et++)vt=zt+Q-C,_t=Qe+Et-C,!(vt<0||vt>=A||_t<0||_t>=S)&&(rt=(vt*S+_t)*4,mt=_[Q*u+Et],oe+=d[rt]*mt,ge+=d[rt+1]*mt,ze+=d[rt+2]*mt,Y||(We+=d[rt+3]*mt));U[at]=oe,U[at+1]=ge,U[at+2]=ze,Y?U[at+3]=d[at+3]:U[at+3]=We}a.imageData=O},getUniformLocations:function(a,c){return{uMatrix:a.getUniformLocation(c,"uMatrix"),uOpaque:a.getUniformLocation(c,"uOpaque"),uHalfSize:a.getUniformLocation(c,"uHalfSize"),uSize:a.getUniformLocation(c,"uSize")}},sendUniformData:function(a,c){a.uniform1fv(c.uMatrix,this.matrix)},toObject:function(){return x(this.callSuper("toObject"),{opaque:this.opaque,matrix:this.matrix})}}),g.Image.filters.Convolute.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass;x.Grayscale=v(x.BaseFilter,{type:"Grayscale",fragmentSource:{average:`precision highp float;
uniform sampler2D uTexture;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float average = (color.r + color.b + color.g) / 3.0;
gl_FragColor = vec4(average, average, average, color.a);
}`,lightness:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
gl_FragColor = vec4(average, average, average, col.a);
}`,luminosity:`precision highp float;
uniform sampler2D uTexture;
uniform int uMode;
varying vec2 vTexCoord;
void main() {
vec4 col = texture2D(uTexture, vTexCoord);
float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
gl_FragColor = vec4(average, average, average, col.a);
}`},mode:"average",mainParameter:"mode",applyTo2d:function(h){var a=h.imageData,c=a.data,d,_=c.length,u,C=this.mode;for(d=0;d<_;d+=4)C==="average"?u=(c[d]+c[d+1]+c[d+2])/3:C==="lightness"?u=(Math.min(c[d],c[d+1],c[d+2])+Math.max(c[d],c[d+1],c[d+2]))/2:C==="luminosity"&&(u=.21*c[d]+.72*c[d+1]+.07*c[d+2]),c[d]=u,c[d+1]=u,c[d+2]=u},retrieveShader:function(h){var a=this.type+"_"+this.mode;if(!h.programCache.hasOwnProperty(a)){var c=this.fragmentSource[this.mode];h.programCache[a]=this.createProgram(h.context,c)}return h.programCache[a]},getUniformLocations:function(h,a){return{uMode:h.getUniformLocation(a,"uMode")}},sendUniformData:function(h,a){var c=1;h.uniform1i(a.uMode,c)},isNeutralState:function(){return!1}}),g.Image.filters.Grayscale.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass;x.Invert=v(x.BaseFilter,{type:"Invert",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform int uInvert;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
if (uInvert == 1) {
gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
} else {
gl_FragColor = color;
}
}`,invert:!0,mainParameter:"invert",applyTo2d:function(h){var a=h.imageData,c=a.data,d,_=c.length;for(d=0;d<_;d+=4)c[d]=255-c[d],c[d+1]=255-c[d+1],c[d+2]=255-c[d+2]},isNeutralState:function(){return!this.invert},getUniformLocations:function(h,a){return{uInvert:h.getUniformLocation(a,"uInvert")}},sendUniformData:function(h,a){h.uniform1i(a.uInvert,this.invert)}}),g.Image.filters.Invert.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.util.object.extend,v=g.Image.filters,h=g.util.createClass;v.Noise=h(v.BaseFilter,{type:"Noise",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uStepH;
uniform float uNoise;
uniform float uSeed;
varying vec2 vTexCoord;
float rand(vec2 co, float seed, float vScale) {
return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
}
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
gl_FragColor = color;
}`,mainParameter:"noise",noise:0,applyTo2d:function(a){if(this.noise!==0){var c=a.imageData,d=c.data,_,u=d.length,C=this.noise,S;for(_=0,u=d.length;_<u;_+=4)S=(.5-Math.random())*C,d[_]+=S,d[_+1]+=S,d[_+2]+=S}},getUniformLocations:function(a,c){return{uNoise:a.getUniformLocation(c,"uNoise"),uSeed:a.getUniformLocation(c,"uSeed")}},sendUniformData:function(a,c){a.uniform1f(c.uNoise,this.noise/255),a.uniform1f(c.uSeed,Math.random())},toObject:function(){return x(this.callSuper("toObject"),{noise:this.noise})}}),g.Image.filters.Noise.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass;x.Pixelate=v(x.BaseFilter,{type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uBlocksize;
uniform float uStepW;
uniform float uStepH;
varying vec2 vTexCoord;
void main() {
float blockW = uBlocksize * uStepW;
float blockH = uBlocksize * uStepW;
int posX = int(vTexCoord.x / blockW);
int posY = int(vTexCoord.y / blockH);
float fposX = float(posX);
float fposY = float(posY);
vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
vec4 color = texture2D(uTexture, squareCoords);
gl_FragColor = color;
}`,applyTo2d:function(h){var a=h.imageData,c=a.data,d=a.height,_=a.width,u,C,S,A,O,U,Y,oe,ge,ze,We;for(C=0;C<d;C+=this.blocksize)for(S=0;S<_;S+=this.blocksize)for(u=C*4*_+S*4,A=c[u],O=c[u+1],U=c[u+2],Y=c[u+3],ze=Math.min(C+this.blocksize,d),We=Math.min(S+this.blocksize,_),oe=C;oe<ze;oe++)for(ge=S;ge<We;ge++)u=oe*4*_+ge*4,c[u]=A,c[u+1]=O,c[u+2]=U,c[u+3]=Y},isNeutralState:function(){return this.blocksize===1},getUniformLocations:function(h,a){return{uBlocksize:h.getUniformLocation(a,"uBlocksize"),uStepW:h.getUniformLocation(a,"uStepW"),uStepH:h.getUniformLocation(a,"uStepH")}},sendUniformData:function(h,a){h.uniform1f(a.uBlocksize,this.blocksize)}}),g.Image.filters.Pixelate.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.util.object.extend,v=g.Image.filters,h=g.util.createClass;v.RemoveColor=h(v.BaseFilter,{type:"RemoveColor",color:"#FFFFFF",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uLow;
uniform vec4 uHigh;
varying vec2 vTexCoord;
void main() {
gl_FragColor = texture2D(uTexture, vTexCoord);
if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
gl_FragColor.a = 0.0;
}
}`,distance:.02,useAlpha:!1,applyTo2d:function(a){var c=a.imageData,d=c.data,_,u=this.distance*255,C,S,A,O=new g.Color(this.color).getSource(),U=[O[0]-u,O[1]-u,O[2]-u],Y=[O[0]+u,O[1]+u,O[2]+u];for(_=0;_<d.length;_+=4)C=d[_],S=d[_+1],A=d[_+2],C>U[0]&&S>U[1]&&A>U[2]&&C<Y[0]&&S<Y[1]&&A<Y[2]&&(d[_+3]=0)},getUniformLocations:function(a,c){return{uLow:a.getUniformLocation(c,"uLow"),uHigh:a.getUniformLocation(c,"uHigh")}},sendUniformData:function(a,c){var d=new g.Color(this.color).getSource(),_=parseFloat(this.distance),u=[0+d[0]/255-_,0+d[1]/255-_,0+d[2]/255-_,1],C=[d[0]/255+_,d[1]/255+_,d[2]/255+_,1];a.uniform4fv(c.uLow,u),a.uniform4fv(c.uHigh,C)},toObject:function(){return x(this.callSuper("toObject"),{color:this.color,distance:this.distance})}}),g.Image.filters.RemoveColor.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass,h={Brownie:[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0],Vintage:[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0],Kodachrome:[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0],Technicolor:[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0],Polaroid:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],Sepia:[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0],BlackWhite:[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]};for(var a in h)x[a]=v(x.ColorMatrix,{type:a,matrix:h[a],mainParameter:!1,colorsOnly:!0}),g.Image.filters[a].fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric,x=g.Image.filters,v=g.util.createClass;x.BlendColor=v(x.BaseFilter,{type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,diff:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`if (uColor.r < 0.5) {
gl_FragColor.r *= 2.0 * uColor.r;
} else {
gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
}
if (uColor.g < 0.5) {
gl_FragColor.g *= 2.0 * uColor.g;
} else {
gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
}
if (uColor.b < 0.5) {
gl_FragColor.b *= 2.0 * uColor.b;
} else {
gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
}
`,tint:`gl_FragColor.rgb *= (1.0 - uColor.a);
gl_FragColor.rgb += uColor.rgb;
`},buildSource:function(h){return`precision highp float;
uniform sampler2D uTexture;
uniform vec4 uColor;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
gl_FragColor = color;
if (color.a > 0.0) {
`+this.fragmentSource[h]+`}
}`},retrieveShader:function(h){var a=this.type+"_"+this.mode,c;return h.programCache.hasOwnProperty(a)||(c=this.buildSource(this.mode),h.programCache[a]=this.createProgram(h.context,c)),h.programCache[a]},applyTo2d:function(h){var a=h.imageData,c=a.data,d=c.length,_,u,C,S,A,O,U,Y=1-this.alpha;U=new g.Color(this.color).getSource(),_=U[0]*this.alpha,u=U[1]*this.alpha,C=U[2]*this.alpha;for(var oe=0;oe<d;oe+=4)switch(S=c[oe],A=c[oe+1],O=c[oe+2],this.mode){case"multiply":c[oe]=S*_/255,c[oe+1]=A*u/255,c[oe+2]=O*C/255;break;case"screen":c[oe]=255-(255-S)*(255-_)/255,c[oe+1]=255-(255-A)*(255-u)/255,c[oe+2]=255-(255-O)*(255-C)/255;break;case"add":c[oe]=S+_,c[oe+1]=A+u,c[oe+2]=O+C;break;case"diff":case"difference":c[oe]=Math.abs(S-_),c[oe+1]=Math.abs(A-u),c[oe+2]=Math.abs(O-C);break;case"subtract":c[oe]=S-_,c[oe+1]=A-u,c[oe+2]=O-C;break;case"darken":c[oe]=Math.min(S,_),c[oe+1]=Math.min(A,u),c[oe+2]=Math.min(O,C);break;case"lighten":c[oe]=Math.max(S,_),c[oe+1]=Math.max(A,u),c[oe+2]=Math.max(O,C);break;case"overlay":c[oe]=_<128?2*S*_/255:255-2*(255-S)*(255-_)/255,c[oe+1]=u<128?2*A*u/255:255-2*(255-A)*(255-u)/255,c[oe+2]=C<128?2*O*C/255:255-2*(255-O)*(255-C)/255;break;case"exclusion":c[oe]=_+S-2*_*S/255,c[oe+1]=u+A-2*u*A/255,c[oe+2]=C+O-2*C*O/255;break;case"tint":c[oe]=_+S*Y,c[oe+1]=u+A*Y,c[oe+2]=C+O*Y}},getUniformLocations:function(h,a){return{uColor:h.getUniformLocation(a,"uColor")}},sendUniformData:function(h,a){var c=new g.Color(this.color).getSource();c[0]=this.alpha*c[0]/255,c[1]=this.alpha*c[1]/255,c[2]=this.alpha*c[2]/255,c[3]=this.alpha,h.uniform4fv(a.uColor,c)},toObject:function(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}}),g.Image.filters.BlendColor.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric,x=g.Image.filters,v=g.util.createClass;x.BlendImage=v(x.BaseFilter,{type:"BlendImage",image:null,mode:"multiply",alpha:1,vertexSource:`attribute vec2 aPosition;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
uniform mat3 uTransformMatrix;
void main() {
vTexCoord = aPosition;
vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
}`,fragmentSource:{multiply:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.rgba *= color2.rgba;
gl_FragColor = color;
}`,mask:`precision highp float;
uniform sampler2D uTexture;
uniform sampler2D uImage;
uniform vec4 uColor;
varying vec2 vTexCoord;
varying vec2 vTexCoord2;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec4 color2 = texture2D(uImage, vTexCoord2);
color.a = color2.a;
gl_FragColor = color;
}`},retrieveShader:function(h){var a=this.type+"_"+this.mode,c=this.fragmentSource[this.mode];return h.programCache.hasOwnProperty(a)||(h.programCache[a]=this.createProgram(h.context,c)),h.programCache[a]},applyToWebGL:function(h){var a=h.context,c=this.createTexture(h.filterBackend,this.image);this.bindAdditionalTexture(a,c,a.TEXTURE1),this.callSuper("applyToWebGL",h),this.unbindAdditionalTexture(a,a.TEXTURE1)},createTexture:function(h,a){return h.getCachedTexture(a.cacheKey,a._element)},calculateMatrix:function(){var h=this.image,a=h._element.width,c=h._element.height;return[1/h.scaleX,0,0,0,1/h.scaleY,0,-h.left/a,-h.top/c,1]},applyTo2d:function(h){var a=h.imageData,c=h.filterBackend.resources,d=a.data,_=d.length,u=a.width,C=a.height,S,A,O,U,Y,oe,ge,ze,We,at,_t=this.image,vt;c.blendImage||(c.blendImage=g.util.createCanvasElement()),We=c.blendImage,at=We.getContext("2d"),We.width!==u||We.height!==C?(We.width=u,We.height=C):at.clearRect(0,0,u,C),at.setTransform(_t.scaleX,0,0,_t.scaleY,_t.left,_t.top),at.drawImage(_t._element,0,0,u,C),vt=at.getImageData(0,0,u,C).data;for(var rt=0;rt<_;rt+=4)switch(Y=d[rt],oe=d[rt+1],ge=d[rt+2],ze=d[rt+3],S=vt[rt],A=vt[rt+1],O=vt[rt+2],U=vt[rt+3],this.mode){case"multiply":d[rt]=Y*S/255,d[rt+1]=oe*A/255,d[rt+2]=ge*O/255,d[rt+3]=ze*U/255;break;case"mask":d[rt+3]=U;break}},getUniformLocations:function(h,a){return{uTransformMatrix:h.getUniformLocation(a,"uTransformMatrix"),uImage:h.getUniformLocation(a,"uImage")}},sendUniformData:function(h,a){var c=this.calculateMatrix();h.uniform1i(a.uImage,1),h.uniformMatrix3fv(a.uTransformMatrix,!1,c)},toObject:function(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}}),g.Image.filters.BlendImage.fromObject=function(h,a){g.Image.fromObject(h.image,function(c){var d=g.util.object.clone(h);d.image=c,a(new g.Image.filters.BlendImage(d))})}}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=Math.pow,v=Math.floor,h=Math.sqrt,a=Math.abs,c=Math.round,d=Math.sin,_=Math.ceil,u=g.Image.filters,C=g.util.createClass;u.Resize=C(u.BaseFilter,{type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,getUniformLocations:function(S,A){return{uDelta:S.getUniformLocation(A,"uDelta"),uTaps:S.getUniformLocation(A,"uTaps")}},sendUniformData:function(S,A){S.uniform2fv(A.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),S.uniform1fv(A.uTaps,this.taps)},retrieveShader:function(S){var A=this.getFilterWindow(),O=this.type+"_"+A;if(!S.programCache.hasOwnProperty(O)){var U=this.generateShader(A);S.programCache[O]=this.createProgram(S.context,U)}return S.programCache[O]},getFilterWindow:function(){var S=this.tempScale;return Math.ceil(this.lanczosLobes/S)},getTaps:function(){for(var S=this.lanczosCreate(this.lanczosLobes),A=this.tempScale,O=this.getFilterWindow(),U=new Array(O),Y=1;Y<=O;Y++)U[Y-1]=S(Y*A);return U},generateShader:function(U){for(var A=new Array(U),O=this.fragmentSourceTOP,U,Y=1;Y<=U;Y++)A[Y-1]=Y+".0 * uDelta";return O+="uniform float uTaps["+U+`];
`,O+=`void main() {
`,O+=`  vec4 color = texture2D(uTexture, vTexCoord);
`,O+=`  float sum = 1.0;
`,A.forEach(function(oe,ge){O+="  color += texture2D(uTexture, vTexCoord + "+oe+") * uTaps["+ge+`];
`,O+="  color += texture2D(uTexture, vTexCoord - "+oe+") * uTaps["+ge+`];
`,O+="  sum += 2.0 * uTaps["+ge+`];
`}),O+=`  gl_FragColor = color / sum;
`,O+="}",O},fragmentSourceTOP:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
`,applyTo:function(S){S.webgl?(S.passes++,this.width=S.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=S.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),S.destinationWidth=this.dW,this._setupFrameBuffer(S),this.applyToWebGL(S),this._swapTextures(S),S.sourceWidth=S.destinationWidth,this.height=S.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),S.destinationHeight=this.dH,this._setupFrameBuffer(S),this.applyToWebGL(S),this._swapTextures(S),S.sourceHeight=S.destinationHeight):this.applyTo2d(S)},isNeutralState:function(){return this.scaleX===1&&this.scaleY===1},lanczosCreate:function(S){return function(A){if(A>=S||A<=-S)return 0;if(A<11920929e-14&&A>-11920929e-14)return 1;A*=Math.PI;var O=A/S;return d(A)/A*d(O)/O}},applyTo2d:function(S){var A=S.imageData,O=this.scaleX,U=this.scaleY;this.rcpScaleX=1/O,this.rcpScaleY=1/U;var Y=A.width,oe=A.height,ge=c(Y*O),ze=c(oe*U),We;this.resizeType==="sliceHack"?We=this.sliceByTwo(S,Y,oe,ge,ze):this.resizeType==="hermite"?We=this.hermiteFastResize(S,Y,oe,ge,ze):this.resizeType==="bilinear"?We=this.bilinearFiltering(S,Y,oe,ge,ze):this.resizeType==="lanczos"&&(We=this.lanczosResize(S,Y,oe,ge,ze)),S.imageData=We},sliceByTwo:function(S,A,O,U,Y){var oe=S.imageData,ge=.5,ze=!1,We=!1,at=A*ge,_t=O*ge,vt=g.filterBackend.resources,rt,mt,Qe=0,zt=0,Et=A,Q=0;for(vt.sliceByTwo||(vt.sliceByTwo=document.createElement("canvas")),rt=vt.sliceByTwo,(rt.width<A*1.5||rt.height<O)&&(rt.width=A*1.5,rt.height=O),mt=rt.getContext("2d"),mt.clearRect(0,0,A*1.5,O),mt.putImageData(oe,0,0),U=v(U),Y=v(Y);!ze||!We;)A=at,O=_t,U<v(at*ge)?at=v(at*ge):(at=U,ze=!0),Y<v(_t*ge)?_t=v(_t*ge):(_t=Y,We=!0),mt.drawImage(rt,Qe,zt,A,O,Et,Q,at,_t),Qe=Et,zt=Q,Q+=_t;return mt.getImageData(Qe,zt,U,Y)},lanczosResize:function(S,A,O,U,Y){function oe(de){var ie,ve,J,q,ce,be,De,Ie,tt,ut,nt;for(Q.x=(de+.5)*_t,se.x=v(Q.x),ie=0;ie<Y;ie++){for(Q.y=(ie+.5)*vt,se.y=v(Q.y),ce=0,be=0,De=0,Ie=0,tt=0,ve=se.x-Qe;ve<=se.x+Qe;ve++)if(!(ve<0||ve>=A)){ut=v(1e3*a(ve-Q.x)),Et[ut]||(Et[ut]={});for(var je=se.y-zt;je<=se.y+zt;je++)je<0||je>=O||(nt=v(1e3*a(je-Q.y)),Et[ut][nt]||(Et[ut][nt]=at(h(x(ut*rt,2)+x(nt*mt,2))/1e3)),J=Et[ut][nt],J>0&&(q=(je*A+ve)*4,ce+=J,be+=J*ge[q],De+=J*ge[q+1],Ie+=J*ge[q+2],tt+=J*ge[q+3]))}q=(ie*U+de)*4,We[q]=be/ce,We[q+1]=De/ce,We[q+2]=Ie/ce,We[q+3]=tt/ce}return++de<U?oe(de):ze}var ge=S.imageData.data,ze=S.ctx.createImageData(U,Y),We=ze.data,at=this.lanczosCreate(this.lanczosLobes),_t=this.rcpScaleX,vt=this.rcpScaleY,rt=2/this.rcpScaleX,mt=2/this.rcpScaleY,Qe=_(_t*this.lanczosLobes/2),zt=_(vt*this.lanczosLobes/2),Et={},Q={},se={};return oe(0)},bilinearFiltering:function(S,A,O,U,Y){var oe,ge,ze,We,at,_t,vt,rt,mt,Qe,zt,Et,Q=0,se,de=this.rcpScaleX,ie=this.rcpScaleY,ve=4*(A-1),J=S.imageData,q=J.data,ce=S.ctx.createImageData(U,Y),be=ce.data;for(vt=0;vt<Y;vt++)for(rt=0;rt<U;rt++)for(at=v(de*rt),_t=v(ie*vt),mt=de*rt-at,Qe=ie*vt-_t,se=4*(_t*A+at),zt=0;zt<4;zt++)oe=q[se+zt],ge=q[se+4+zt],ze=q[se+ve+zt],We=q[se+ve+4+zt],Et=oe*(1-mt)*(1-Qe)+ge*mt*(1-Qe)+ze*Qe*(1-mt)+We*mt*Qe,be[Q++]=Et;return ce},hermiteFastResize:function(S,A,O,U,Y){for(var oe=this.rcpScaleX,ge=this.rcpScaleY,ze=_(oe/2),We=_(ge/2),at=S.imageData,_t=at.data,vt=S.ctx.createImageData(U,Y),rt=vt.data,mt=0;mt<Y;mt++)for(var Qe=0;Qe<U;Qe++){for(var zt=(Qe+mt*U)*4,Et=0,Q=0,se=0,de=0,ie=0,ve=0,J=0,q=(mt+.5)*ge,ce=v(mt*ge);ce<(mt+1)*ge;ce++)for(var be=a(q-(ce+.5))/We,De=(Qe+.5)*oe,Ie=be*be,tt=v(Qe*oe);tt<(Qe+1)*oe;tt++){var ut=a(De-(tt+.5))/ze,nt=h(Ie+ut*ut);nt>1&&nt<-1||(Et=2*nt*nt*nt-3*nt*nt+1,Et>0&&(ut=4*(tt+ce*A),J+=Et*_t[ut+3],se+=Et,_t[ut+3]<255&&(Et=Et*_t[ut+3]/250),de+=Et*_t[ut],ie+=Et*_t[ut+1],ve+=Et*_t[ut+2],Q+=Et))}rt[zt]=de/Q,rt[zt+1]=ie/Q,rt[zt+2]=ve/Q,rt[zt+3]=J/se}return vt},toObject:function(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}}),g.Image.filters.Resize.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass;x.Contrast=v(x.BaseFilter,{type:"Contrast",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uContrast;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
gl_FragColor = color;
}`,contrast:0,mainParameter:"contrast",applyTo2d:function(h){if(this.contrast!==0){var a=h.imageData,c,_,d=a.data,_=d.length,u=Math.floor(this.contrast*255),C=259*(u+255)/(255*(259-u));for(c=0;c<_;c+=4)d[c]=C*(d[c]-128)+128,d[c+1]=C*(d[c+1]-128)+128,d[c+2]=C*(d[c+2]-128)+128}},getUniformLocations:function(h,a){return{uContrast:h.getUniformLocation(a,"uContrast")}},sendUniformData:function(h,a){h.uniform1f(a.uContrast,this.contrast)}}),g.Image.filters.Contrast.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass;x.Saturation=v(x.BaseFilter,{type:"Saturation",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uSaturation;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float rgMax = max(color.r, color.g);
float rgbMax = max(rgMax, color.b);
color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
gl_FragColor = color;
}`,saturation:0,mainParameter:"saturation",applyTo2d:function(h){if(this.saturation!==0){var a=h.imageData,c=a.data,d=c.length,_=-this.saturation,u,C;for(u=0;u<d;u+=4)C=Math.max(c[u],c[u+1],c[u+2]),c[u]+=C!==c[u]?(C-c[u])*_:0,c[u+1]+=C!==c[u+1]?(C-c[u+1])*_:0,c[u+2]+=C!==c[u+2]?(C-c[u+2])*_:0}},getUniformLocations:function(h,a){return{uSaturation:h.getUniformLocation(a,"uSaturation")}},sendUniformData:function(h,a){h.uniform1f(a.uSaturation,-this.saturation)}}),g.Image.filters.Saturation.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass;x.Vibrance=v(x.BaseFilter,{type:"Vibrance",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform float uVibrance;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
float max = max(color.r, max(color.g, color.b));
float avg = (color.r + color.g + color.b) / 3.0;
float amt = (abs(max - avg) * 2.0) * uVibrance;
color.r += max != color.r ? (max - color.r) * amt : 0.00;
color.g += max != color.g ? (max - color.g) * amt : 0.00;
color.b += max != color.b ? (max - color.b) * amt : 0.00;
gl_FragColor = color;
}`,vibrance:0,mainParameter:"vibrance",applyTo2d:function(h){if(this.vibrance!==0){var a=h.imageData,c=a.data,d=c.length,_=-this.vibrance,u,C,S,A;for(u=0;u<d;u+=4)C=Math.max(c[u],c[u+1],c[u+2]),S=(c[u]+c[u+1]+c[u+2])/3,A=Math.abs(C-S)*2/255*_,c[u]+=C!==c[u]?(C-c[u])*A:0,c[u+1]+=C!==c[u+1]?(C-c[u+1])*A:0,c[u+2]+=C!==c[u+2]?(C-c[u+2])*A:0}},getUniformLocations:function(h,a){return{uVibrance:h.getUniformLocation(a,"uVibrance")}},sendUniformData:function(h,a){h.uniform1f(a.uVibrance,-this.vibrance)}}),g.Image.filters.Vibrance.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass;x.Blur=v(x.BaseFilter,{type:"Blur",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec2 uDelta;
varying vec2 vTexCoord;
const float nSamples = 15.0;
vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
float random(vec3 scale) {
return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
}
void main() {
vec4 color = vec4(0.0);
float total = 0.0;
float offset = random(v3offset);
for (float t = -nSamples; t <= nSamples; t++) {
float percent = (t + offset - 0.5) / nSamples;
float weight = 1.0 - abs(percent);
color += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;
total += weight;
}
gl_FragColor = color / total;
}`,blur:0,mainParameter:"blur",applyTo:function(h){h.webgl?(this.aspectRatio=h.sourceWidth/h.sourceHeight,h.passes++,this._setupFrameBuffer(h),this.horizontal=!0,this.applyToWebGL(h),this._swapTextures(h),this._setupFrameBuffer(h),this.horizontal=!1,this.applyToWebGL(h),this._swapTextures(h)):this.applyTo2d(h)},applyTo2d:function(h){h.imageData=this.simpleBlur(h)},simpleBlur:function(h){var a=h.filterBackend.resources,c,d,_=h.imageData.width,u=h.imageData.height;a.blurLayer1||(a.blurLayer1=g.util.createCanvasElement(),a.blurLayer2=g.util.createCanvasElement()),c=a.blurLayer1,d=a.blurLayer2,(c.width!==_||c.height!==u)&&(d.width=c.width=_,d.height=c.height=u);var C=c.getContext("2d"),S=d.getContext("2d"),A=15,O,U,Y,oe,ge=this.blur*.06*.5;for(C.putImageData(h.imageData,0,0),S.clearRect(0,0,_,u),oe=-A;oe<=A;oe++)O=(Math.random()-.5)/4,U=oe/A,Y=ge*U*_+O,S.globalAlpha=1-Math.abs(U),S.drawImage(c,Y,O),C.drawImage(d,0,0),S.globalAlpha=1,S.clearRect(0,0,d.width,d.height);for(oe=-A;oe<=A;oe++)O=(Math.random()-.5)/4,U=oe/A,Y=ge*U*u+O,S.globalAlpha=1-Math.abs(U),S.drawImage(c,O,Y),C.drawImage(d,0,0),S.globalAlpha=1,S.clearRect(0,0,d.width,d.height);h.ctx.drawImage(c,0,0);var ze=h.ctx.getImageData(0,0,c.width,c.height);return C.globalAlpha=1,C.clearRect(0,0,c.width,c.height),ze},getUniformLocations:function(h,a){return{delta:h.getUniformLocation(a,"uDelta")}},sendUniformData:function(h,a){var c=this.chooseRightDelta();h.uniform2fv(a.delta,c)},chooseRightDelta:function(){var h=1,a=[0,0],c;return this.horizontal?this.aspectRatio>1&&(h=1/this.aspectRatio):this.aspectRatio<1&&(h=this.aspectRatio),c=h*this.blur*.12,this.horizontal?a[0]=c:a[1]=c,a}}),x.Blur.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass;x.Gamma=v(x.BaseFilter,{type:"Gamma",fragmentSource:`precision highp float;
uniform sampler2D uTexture;
uniform vec3 uGamma;
varying vec2 vTexCoord;
void main() {
vec4 color = texture2D(uTexture, vTexCoord);
vec3 correction = (1.0 / uGamma);
color.r = pow(color.r, correction.r);
color.g = pow(color.g, correction.g);
color.b = pow(color.b, correction.b);
gl_FragColor = color;
gl_FragColor.rgb *= color.a;
}`,gamma:[1,1,1],mainParameter:"gamma",initialize:function(h){this.gamma=[1,1,1],x.BaseFilter.prototype.initialize.call(this,h)},applyTo2d:function(h){var a=h.imageData,c=a.data,d=this.gamma,_=c.length,u=1/d[0],C=1/d[1],S=1/d[2],A;for(this.rVals||(this.rVals=new Uint8Array(256),this.gVals=new Uint8Array(256),this.bVals=new Uint8Array(256)),A=0,_=256;A<_;A++)this.rVals[A]=Math.pow(A/255,u)*255,this.gVals[A]=Math.pow(A/255,C)*255,this.bVals[A]=Math.pow(A/255,S)*255;for(A=0,_=c.length;A<_;A+=4)c[A]=this.rVals[c[A]],c[A+1]=this.gVals[c[A+1]],c[A+2]=this.bVals[c[A+2]]},getUniformLocations:function(h,a){return{uGamma:h.getUniformLocation(a,"uGamma")}},sendUniformData:function(h,a){h.uniform3fv(a.uGamma,this.gamma)}}),g.Image.filters.Gamma.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass;x.Composed=v(x.BaseFilter,{type:"Composed",subFilters:[],initialize:function(h){this.callSuper("initialize",h),this.subFilters=this.subFilters.slice(0)},applyTo:function(h){h.passes+=this.subFilters.length-1,this.subFilters.forEach(function(a){a.applyTo(h)})},toObject:function(){return g.util.object.extend(this.callSuper("toObject"),{subFilters:this.subFilters.map(function(h){return h.toObject()})})},isNeutralState:function(){return!this.subFilters.some(function(h){return!h.isNeutralState()})}}),g.Image.filters.Composed.fromObject=function(h,a){var c=h.subFilters||[],d=c.map(function(u){return new g.Image.filters[u.type](u)}),_=new g.Image.filters.Composed({subFilters:d});return a&&a(_),_}}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.Image.filters,v=g.util.createClass;x.HueRotation=v(x.ColorMatrix,{type:"HueRotation",rotation:0,mainParameter:"rotation",calculateMatrix:function(){var h=this.rotation*Math.PI,a=g.util.cos(h),c=g.util.sin(h),d=1/3,_=Math.sqrt(d)*c,u=1-a;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=a+u/3,this.matrix[1]=d*u-_,this.matrix[2]=d*u+_,this.matrix[5]=d*u+_,this.matrix[6]=a+d*u,this.matrix[7]=d*u-_,this.matrix[10]=d*u-_,this.matrix[11]=d*u+_,this.matrix[12]=a+d*u},isNeutralState:function(h){return this.calculateMatrix(),x.BaseFilter.prototype.isNeutralState.call(this,h)},applyTo:function(h){this.calculateMatrix(),x.BaseFilter.prototype.applyTo.call(this,h)}}),g.Image.filters.HueRotation.fromObject=g.Image.filters.BaseFilter.fromObject}(Ne),function(n){var g=n.fabric||(n.fabric={}),x=g.util.object.clone;if(g.Text){g.warn("fabric.Text is already defined");return}var v="fontFamily fontWeight fontSize text underline overline linethrough textAlign fontStyle lineHeight textBackgroundColor charSpacing styles direction path pathStartOffset pathSide pathAlign".split(" ");g.Text=g.util.createClass(g.Object,{_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:g.Object.prototype.stateProperties.concat(v),cacheProperties:g.Object.prototype.cacheProperties.concat(v),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,_measuringContext:null,deltaY:0,direction:"ltr",_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],__charBounds:[],CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2,initialize:function(h,a){this.styles=a?a.styles||{}:{},this.text=h,this.__skipDimension=!0,this.callSuper("initialize",a),this.path&&this.setPathInfo(),this.__skipDimension=!1,this.initDimensions(),this.setCoords(),this.setupState({propertySet:"_dimensionAffectingProps"})},setPathInfo:function(){var h=this.path;h&&(h.segmentsInfo=g.util.getPathSegmentsInfo(h.path))},getMeasuringContext:function(){return g._measuringContext||(g._measuringContext=this.canvas&&this.canvas.contextCache||g.util.createCanvasElement().getContext("2d")),g._measuringContext},_splitText:function(){var h=this._splitTextIntoLines(this.text);return this.textLines=h.lines,this._textLines=h.graphemeLines,this._unwrappedTextLines=h._unwrappedLines,this._text=h.graphemeText,h},initDimensions:function(){this.__skipDimension||(this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"}))},enlargeSpaces:function(){for(var h,a,c,d,_,u,C,S=0,A=this._textLines.length;S<A;S++)if(!(this.textAlign!=="justify"&&(S===A-1||this.isEndOfWrapping(S)))&&(d=0,_=this._textLines[S],a=this.getLineWidth(S),a<this.width&&(C=this.textLines[S].match(this._reSpacesAndTabs)))){c=C.length,h=(this.width-a)/c;for(var O=0,U=_.length;O<=U;O++)u=this.__charBounds[S][O],this._reSpaceAndTab.test(_[O])?(u.width+=h,u.kernedWidth+=h,u.left+=d,d+=h):u.left+=d}},isEndOfWrapping:function(h){return h===this._textLines.length-1},missingNewlineOffset:function(){return 1},toString:function(){return"#<fabric.Text ("+this.complexity()+'): { "text": "'+this.text+'", "fontFamily": "'+this.fontFamily+'" }>'},_getCacheCanvasDimensions:function(){var h=this.callSuper("_getCacheCanvasDimensions"),a=this.fontSize;return h.width+=a*h.zoomX,h.height+=a*h.zoomY,h},_render:function(h){var a=this.path;a&&!a.isNotVisible()&&a._render(h),this._setTextStyles(h),this._renderTextLinesBackground(h),this._renderTextDecoration(h,"underline"),this._renderText(h),this._renderTextDecoration(h,"overline"),this._renderTextDecoration(h,"linethrough")},_renderText:function(h){this.paintFirst==="stroke"?(this._renderTextStroke(h),this._renderTextFill(h)):(this._renderTextFill(h),this._renderTextStroke(h))},_setTextStyles:function(h,a,c){if(h.textBaseline="alphabetical",this.path)switch(this.pathAlign){case"center":h.textBaseline="middle";break;case"ascender":h.textBaseline="top";break;case"descender":h.textBaseline="bottom";break}h.font=this._getFontDeclaration(a,c)},calcTextWidth:function(){for(var h=this.getLineWidth(0),a=1,c=this._textLines.length;a<c;a++){var d=this.getLineWidth(a);d>h&&(h=d)}return h},_renderTextLine:function(h,a,c,d,_,u){this._renderChars(h,a,c,d,_,u)},_renderTextLinesBackground:function(h){if(!(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))){for(var a,c,d=h.fillStyle,_,u,C=this._getLeftOffset(),S=this._getTopOffset(),A=0,O=0,U,Y,oe=this.path,ge,ze=0,We=this._textLines.length;ze<We;ze++){if(a=this.getHeightOfLine(ze),!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",ze)){S+=a;continue}_=this._textLines[ze],c=this._getLineLeftOffset(ze),O=0,A=0,u=this.getValueOfPropertyAt(ze,0,"textBackgroundColor");for(var at=0,_t=_.length;at<_t;at++)U=this.__charBounds[ze][at],Y=this.getValueOfPropertyAt(ze,at,"textBackgroundColor"),oe?(h.save(),h.translate(U.renderLeft,U.renderTop),h.rotate(U.angle),h.fillStyle=Y,Y&&h.fillRect(-U.width/2,-a/this.lineHeight*(1-this._fontSizeFraction),U.width,a/this.lineHeight),h.restore()):Y!==u?(ge=C+c+A,this.direction==="rtl"&&(ge=this.width-ge-O),h.fillStyle=u,u&&h.fillRect(ge,S,O,a/this.lineHeight),A=U.left,O=U.width,u=Y):O+=U.kernedWidth;Y&&!oe&&(ge=C+c+A,this.direction==="rtl"&&(ge=this.width-ge-O),h.fillStyle=Y,h.fillRect(ge,S,O,a/this.lineHeight)),S+=a}h.fillStyle=d,this._removeShadow(h)}},getFontCache:function(h){var a=h.fontFamily.toLowerCase();g.charWidthsCache[a]||(g.charWidthsCache[a]={});var c=g.charWidthsCache[a],d=h.fontStyle.toLowerCase()+"_"+(h.fontWeight+"").toLowerCase();return c[d]||(c[d]={}),c[d]},_measureChar:function(h,a,c,d){var _=this.getFontCache(a),u=this._getFontDeclaration(a),C=this._getFontDeclaration(d),S=c+h,A=u===C,O,U,Y,oe=a.fontSize/this.CACHE_FONT_SIZE,ge;if(c&&_[c]!==void 0&&(Y=_[c]),_[h]!==void 0&&(ge=O=_[h]),A&&_[S]!==void 0&&(U=_[S],ge=U-Y),O===void 0||Y===void 0||U===void 0){var ze=this.getMeasuringContext();this._setTextStyles(ze,a,!0)}return O===void 0&&(ge=O=ze.measureText(h).width,_[h]=O),Y===void 0&&A&&c&&(Y=ze.measureText(c).width,_[c]=Y),A&&U===void 0&&(U=ze.measureText(S).width,_[S]=U,ge=U-Y),{width:O*oe,kernedWidth:ge*oe}},getHeightOfChar:function(h,a){return this.getValueOfPropertyAt(h,a,"fontSize")},measureLine:function(h){var a=this._measureLine(h);return this.charSpacing!==0&&(a.width-=this._getWidthOfCharSpacing()),a.width<0&&(a.width=0),a},_measureLine:function(h){var a=0,c,d,_=this._textLines[h],u,C,S=0,A=new Array(_.length),O=0,U,Y,oe=this.path,ge=this.pathSide==="right";for(this.__charBounds[h]=A,c=0;c<_.length;c++)d=_[c],C=this._getGraphemeBox(d,h,c,u),A[c]=C,a+=C.kernedWidth,u=d;if(A[c]={left:C?C.left+C.width:0,width:0,kernedWidth:0,height:this.fontSize},oe){switch(Y=oe.segmentsInfo[oe.segmentsInfo.length-1].length,U=g.util.getPointOnPath(oe.path,0,oe.segmentsInfo),U.x+=oe.pathOffset.x,U.y+=oe.pathOffset.y,this.textAlign){case"left":O=ge?Y-a:0;break;case"center":O=(Y-a)/2;break;case"right":O=ge?0:Y-a;break}for(O+=this.pathStartOffset*(ge?-1:1),c=ge?_.length-1:0;ge?c>=0:c<_.length;ge?c--:c++)C=A[c],O>Y?O%=Y:O<0&&(O+=Y),this._setGraphemeOnPath(O,C,U),O+=C.kernedWidth}return{width:a,numOfSpaces:S}},_setGraphemeOnPath:function(h,a,c){var d=h+a.kernedWidth/2,_=this.path,u=g.util.getPointOnPath(_.path,d,_.segmentsInfo);a.renderLeft=u.x-c.x,a.renderTop=u.y-c.y,a.angle=u.angle+(this.pathSide==="right"?Math.PI:0)},_getGraphemeBox:function(h,a,c,d,_){var u=this.getCompleteStyleDeclaration(a,c),C=d?this.getCompleteStyleDeclaration(a,c-1):{},S=this._measureChar(h,u,d,C),A=S.kernedWidth,O=S.width,U;this.charSpacing!==0&&(U=this._getWidthOfCharSpacing(),O+=U,A+=U);var Y={width:O,left:0,height:u.fontSize,kernedWidth:A,deltaY:u.deltaY};if(c>0&&!_){var oe=this.__charBounds[a][c-1];Y.left=oe.left+oe.width+S.kernedWidth-S.width}return Y},getHeightOfLine:function(h){if(this.__lineHeights[h])return this.__lineHeights[h];for(var a=this._textLines[h],c=this.getHeightOfChar(h,0),d=1,_=a.length;d<_;d++)c=Math.max(this.getHeightOfChar(h,d),c);return this.__lineHeights[h]=c*this.lineHeight*this._fontSizeMult},calcTextHeight:function(){for(var h,a=0,c=0,d=this._textLines.length;c<d;c++)h=this.getHeightOfLine(c),a+=c===d-1?h/this.lineHeight:h;return a},_getLeftOffset:function(){return this.direction==="ltr"?-this.width/2:this.width/2},_getTopOffset:function(){return-this.height/2},_renderTextCommon:function(h,a){h.save();for(var c=0,d=this._getLeftOffset(),_=this._getTopOffset(),u=0,C=this._textLines.length;u<C;u++){var S=this.getHeightOfLine(u),A=S/this.lineHeight,O=this._getLineLeftOffset(u);this._renderTextLine(a,h,this._textLines[u],d+O,_+c+A,u),c+=S}h.restore()},_renderTextFill:function(h){!this.fill&&!this.styleHas("fill")||this._renderTextCommon(h,"fillText")},_renderTextStroke:function(h){(!this.stroke||this.strokeWidth===0)&&this.isEmptyStyles()||(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(h),h.save(),this._setLineDash(h,this.strokeDashArray),h.beginPath(),this._renderTextCommon(h,"strokeText"),h.closePath(),h.restore())},_renderChars:function(h,a,c,d,_,u){var C=this.getHeightOfLine(u),S=this.textAlign.indexOf("justify")!==-1,A,O,U="",Y,oe=0,ge,ze=this.path,We=!S&&this.charSpacing===0&&this.isEmptyStyles(u)&&!ze,at=this.direction==="ltr",_t=this.direction==="ltr"?1:-1,vt,rt=a.canvas.getAttribute("dir");if(a.save(),rt!==this.direction&&(a.canvas.setAttribute("dir",at?"ltr":"rtl"),a.direction=at?"ltr":"rtl",a.textAlign=at?"left":"right"),_-=C*this._fontSizeFraction/this.lineHeight,We){this._renderChar(h,a,u,0,c.join(""),d,_,C),a.restore();return}for(var mt=0,Qe=c.length-1;mt<=Qe;mt++)ge=mt===Qe||this.charSpacing||ze,U+=c[mt],Y=this.__charBounds[u][mt],oe===0?(d+=_t*(Y.kernedWidth-Y.width),oe+=Y.width):oe+=Y.kernedWidth,S&&!ge&&this._reSpaceAndTab.test(c[mt])&&(ge=!0),ge||(A=A||this.getCompleteStyleDeclaration(u,mt),O=this.getCompleteStyleDeclaration(u,mt+1),ge=g.util.hasStyleChanged(A,O,!1)),ge&&(ze?(a.save(),a.translate(Y.renderLeft,Y.renderTop),a.rotate(Y.angle),this._renderChar(h,a,u,mt,U,-oe/2,0,C),a.restore()):(vt=d,this._renderChar(h,a,u,mt,U,vt,_,C)),U="",A=O,d+=_t*oe,oe=0);a.restore()},_applyPatternGradientTransformText:function(h){var a=g.util.createCanvasElement(),c,d=this.width+this.strokeWidth,_=this.height+this.strokeWidth;return a.width=d,a.height=_,c=a.getContext("2d"),c.beginPath(),c.moveTo(0,0),c.lineTo(d,0),c.lineTo(d,_),c.lineTo(0,_),c.closePath(),c.translate(d/2,_/2),c.fillStyle=h.toLive(c),this._applyPatternGradientTransform(c,h),c.fill(),c.createPattern(a,"no-repeat")},handleFiller:function(h,a,c){var d,_;return c.toLive?c.gradientUnits==="percentage"||c.gradientTransform||c.patternTransform?(d=-this.width/2,_=-this.height/2,h.translate(d,_),h[a]=this._applyPatternGradientTransformText(c),{offsetX:d,offsetY:_}):(h[a]=c.toLive(h,this),this._applyPatternGradientTransform(h,c)):(h[a]=c,{offsetX:0,offsetY:0})},_setStrokeStyles:function(h,a){return h.lineWidth=a.strokeWidth,h.lineCap=this.strokeLineCap,h.lineDashOffset=this.strokeDashOffset,h.lineJoin=this.strokeLineJoin,h.miterLimit=this.strokeMiterLimit,this.handleFiller(h,"strokeStyle",a.stroke)},_setFillStyles:function(h,a){return this.handleFiller(h,"fillStyle",a.fill)},_renderChar:function(h,a,c,d,_,u,C){var S=this._getStyleDeclaration(c,d),A=this.getCompleteStyleDeclaration(c,d),O=h==="fillText"&&A.fill,U=h==="strokeText"&&A.stroke&&A.strokeWidth,Y,oe;!U&&!O||(a.save(),O&&(Y=this._setFillStyles(a,A)),U&&(oe=this._setStrokeStyles(a,A)),a.font=this._getFontDeclaration(A),S&&S.textBackgroundColor&&this._removeShadow(a),S&&S.deltaY&&(C+=S.deltaY),O&&a.fillText(_,u-Y.offsetX,C-Y.offsetY),U&&a.strokeText(_,u-oe.offsetX,C-oe.offsetY),a.restore())},setSuperscript:function(h,a){return this._setScript(h,a,this.superscript)},setSubscript:function(h,a){return this._setScript(h,a,this.subscript)},_setScript:function(h,a,c){var d=this.get2DCursorLocation(h,!0),_=this.getValueOfPropertyAt(d.lineIndex,d.charIndex,"fontSize"),u=this.getValueOfPropertyAt(d.lineIndex,d.charIndex,"deltaY"),C={fontSize:_*c.size,deltaY:u+_*c.baseline};return this.setSelectionStyles(C,h,a),this},_getLineLeftOffset:function(h){var a=this.getLineWidth(h),c=this.width-a,d=this.textAlign,_=this.direction,C,u=0,C=this.isEndOfWrapping(h);return d==="justify"||d==="justify-center"&&!C||d==="justify-right"&&!C||d==="justify-left"&&!C?0:(d==="center"&&(u=c/2),d==="right"&&(u=c),d==="justify-center"&&(u=c/2),d==="justify-right"&&(u=c),_==="rtl"&&(u-=c),u)},_clearCache:function(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]},_shouldClearDimensionCache:function(){var h=this._forceClearCache;return h||(h=this.hasStateChanged("_dimensionAffectingProps")),h&&(this.dirty=!0,this._forceClearCache=!1),h},getLineWidth:function(h){if(this.__lineWidths[h]!==void 0)return this.__lineWidths[h];var a=this.measureLine(h),c=a.width;return this.__lineWidths[h]=c,c},_getWidthOfCharSpacing:function(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0},getValueOfPropertyAt:function(h,a,c){var d=this._getStyleDeclaration(h,a);return d&&typeof d[c]<"u"?d[c]:this[c]},_renderTextDecoration:function(h,a){if(!(!this[a]&&!this.styleHas(a))){for(var c,d,_,u,C,S,A,O,U=this._getLeftOffset(),Y=this._getTopOffset(),oe,ge,ze,We,at,_t,vt,rt,mt=this.path,Qe=this._getWidthOfCharSpacing(),zt=this.offsets[a],Et=0,Q=this._textLines.length;Et<Q;Et++){if(c=this.getHeightOfLine(Et),!this[a]&&!this.styleHas(a,Et)){Y+=c;continue}A=this._textLines[Et],_t=c/this.lineHeight,u=this._getLineLeftOffset(Et),ge=0,ze=0,O=this.getValueOfPropertyAt(Et,0,a),rt=this.getValueOfPropertyAt(Et,0,"fill"),oe=Y+_t*(1-this._fontSizeFraction),d=this.getHeightOfChar(Et,0),C=this.getValueOfPropertyAt(Et,0,"deltaY");for(var se=0,de=A.length;se<de;se++)if(We=this.__charBounds[Et][se],at=this.getValueOfPropertyAt(Et,se,a),vt=this.getValueOfPropertyAt(Et,se,"fill"),_=this.getHeightOfChar(Et,se),S=this.getValueOfPropertyAt(Et,se,"deltaY"),mt&&at&&vt)h.save(),h.fillStyle=rt,h.translate(We.renderLeft,We.renderTop),h.rotate(We.angle),h.fillRect(-We.kernedWidth/2,zt*_+S,We.kernedWidth,this.fontSize/15),h.restore();else if((at!==O||vt!==rt||_!==d||S!==C)&&ze>0){var ie=U+u+ge;this.direction==="rtl"&&(ie=this.width-ie-ze),O&&rt&&(h.fillStyle=rt,h.fillRect(ie,oe+zt*d+C,ze,this.fontSize/15)),ge=We.left,ze=We.width,O=at,rt=vt,d=_,C=S}else ze+=We.kernedWidth;var ie=U+u+ge;this.direction==="rtl"&&(ie=this.width-ie-ze),h.fillStyle=vt,at&&vt&&h.fillRect(ie,oe+zt*d+C,ze-Qe,this.fontSize/15),Y+=c}this._removeShadow(h)}},_getFontDeclaration:function(h,a){var c=h||this,d=this.fontFamily,_=g.Text.genericFonts.indexOf(d.toLowerCase())>-1,u=d===void 0||d.indexOf("'")>-1||d.indexOf(",")>-1||d.indexOf('"')>-1||_?c.fontFamily:'"'+c.fontFamily+'"';return[g.isLikelyNode?c.fontWeight:c.fontStyle,g.isLikelyNode?c.fontStyle:c.fontWeight,a?this.CACHE_FONT_SIZE+"px":c.fontSize+"px",u].join(" ")},render:function(h){!this.visible||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),this.callSuper("render",h))},_splitTextIntoLines:function(h){for(var a=h.split(this._reNewline),c=new Array(a.length),d=[`
`],_=[],u=0;u<a.length;u++)c[u]=g.util.string.graphemeSplit(a[u]),_=_.concat(c[u],d);return _.pop(),{_unwrappedLines:c,lines:a,graphemeText:_,graphemeLines:c}},toObject:function(h){var a=v.concat(h),c=this.callSuper("toObject",a);return c.styles=g.util.stylesToArray(this.styles,this.text),c.path&&(c.path=this.path.toObject()),c},set:function(h,a){this.callSuper("set",h,a);var c=!1,d=!1;if(typeof h=="object")for(var _ in h)_==="path"&&this.setPathInfo(),c=c||this._dimensionAffectingProps.indexOf(_)!==-1,d=d||_==="path";else c=this._dimensionAffectingProps.indexOf(h)!==-1,d=h==="path";return d&&this.setPathInfo(),c&&(this.initDimensions(),this.setCoords()),this},complexity:function(){return 1}}),g.Text.ATTRIBUTE_NAMES=g.SHARED_ATTRIBUTES.concat("x y dx dy font-family font-style font-weight font-size letter-spacing text-decoration text-anchor".split(" ")),g.Text.DEFAULT_SVG_FONT_SIZE=16,g.Text.fromElement=function(h,a,c){if(!h)return a(null);var d=g.parseAttributes(h,g.Text.ATTRIBUTE_NAMES),_=d.textAnchor||"left";if(c=g.util.object.extend(c?x(c):{},d),c.top=c.top||0,c.left=c.left||0,d.textDecoration){var u=d.textDecoration;u.indexOf("underline")!==-1&&(c.underline=!0),u.indexOf("overline")!==-1&&(c.overline=!0),u.indexOf("line-through")!==-1&&(c.linethrough=!0),delete c.textDecoration}"dx"in d&&(c.left+=d.dx),"dy"in d&&(c.top+=d.dy),"fontSize"in c||(c.fontSize=g.Text.DEFAULT_SVG_FONT_SIZE);var C="";"textContent"in h?C=h.textContent:"firstChild"in h&&h.firstChild!==null&&"data"in h.firstChild&&h.firstChild.data!==null&&(C=h.firstChild.data),C=C.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");var S=c.strokeWidth;c.strokeWidth=0;var A=new g.Text(C,c),O=A.getScaledHeight()/A.height,U=(A.height+A.strokeWidth)*A.lineHeight-A.height,Y=U*O,oe=A.getScaledHeight()+Y,ge=0;_==="center"&&(ge=A.getScaledWidth()/2),_==="right"&&(ge=A.getScaledWidth()),A.set({left:A.left-ge,top:A.top-(oe-A.fontSize*(.07+A._fontSizeFraction))/A.lineHeight,strokeWidth:typeof S<"u"?S:1}),a(A)},g.Text.fromObject=function(h,a){var c=x(h),d=h.path;return delete c.path,g.Object._fromObject("Text",c,function(_){_.styles=g.util.stylesFromArray(h.styles,h.text),d?g.Object._fromObject("Path",d,function(u){_.set("path",u),a(_)},"path"):a(_)},"text")},g.Text.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],g.util.createAccessors&&g.util.createAccessors(g.Text)}(Ne),function(){I.util.object.extend(I.Text.prototype,{isEmptyStyles:function(n){if(!this.styles||typeof n<"u"&&!this.styles[n])return!0;var g=typeof n>"u"?this.styles:{line:this.styles[n]};for(var x in g)for(var v in g[x])for(var h in g[x][v])return!1;return!0},styleHas:function(n,g){if(!this.styles||!n||n===""||typeof g<"u"&&!this.styles[g])return!1;var x=typeof g>"u"?this.styles:{0:this.styles[g]};for(var v in x)for(var h in x[v])if(typeof x[v][h][n]<"u")return!0;return!1},cleanStyle:function(n){if(!this.styles||!n||n==="")return!1;var g=this.styles,x=0,v,h,a=!0,c=0,d;for(var _ in g){v=0;for(var u in g[_]){var d=g[_][u],C=d.hasOwnProperty(n);x++,C?(h?d[n]!==h&&(a=!1):h=d[n],d[n]===this[n]&&delete d[n]):a=!1,Object.keys(d).length!==0?v++:delete g[_][u]}v===0&&delete g[_]}for(var S=0;S<this._textLines.length;S++)c+=this._textLines[S].length;a&&x===c&&(this[n]=h,this.removeStyle(n))},removeStyle:function(n){if(!(!this.styles||!n||n==="")){var g=this.styles,x,v,h;for(v in g){x=g[v];for(h in x)delete x[h][n],Object.keys(x[h]).length===0&&delete x[h];Object.keys(x).length===0&&delete g[v]}}},_extendStyles:function(n,g){var x=this.get2DCursorLocation(n);this._getLineStyle(x.lineIndex)||this._setLineStyle(x.lineIndex),this._getStyleDeclaration(x.lineIndex,x.charIndex)||this._setStyleDeclaration(x.lineIndex,x.charIndex,{}),I.util.object.extend(this._getStyleDeclaration(x.lineIndex,x.charIndex),g)},get2DCursorLocation:function(n,g){typeof n>"u"&&(n=this.selectionStart);for(var x=g?this._unwrappedTextLines:this._textLines,v=x.length,h=0;h<v;h++){if(n<=x[h].length)return{lineIndex:h,charIndex:n};n-=x[h].length+this.missingNewlineOffset(h)}return{lineIndex:h-1,charIndex:x[h-1].length<n?x[h-1].length:n}},getSelectionStyles:function(n,g,x){typeof n>"u"&&(n=this.selectionStart||0),typeof g>"u"&&(g=this.selectionEnd||n);for(var v=[],h=n;h<g;h++)v.push(this.getStyleAtPosition(h,x));return v},getStyleAtPosition:function(n,g){var x=this.get2DCursorLocation(n),v=g?this.getCompleteStyleDeclaration(x.lineIndex,x.charIndex):this._getStyleDeclaration(x.lineIndex,x.charIndex);return v||{}},setSelectionStyles:function(n,g,x){typeof g>"u"&&(g=this.selectionStart||0),typeof x>"u"&&(x=this.selectionEnd||g);for(var v=g;v<x;v++)this._extendStyles(v,n);return this._forceClearCache=!0,this},_getStyleDeclaration:function(n,g){var x=this.styles&&this.styles[n];return x?x[g]:null},getCompleteStyleDeclaration:function(n,g){for(var x=this._getStyleDeclaration(n,g)||{},v={},h,a=0;a<this._styleProperties.length;a++)h=this._styleProperties[a],v[h]=typeof x[h]>"u"?this[h]:x[h];return v},_setStyleDeclaration:function(n,g,x){this.styles[n][g]=x},_deleteStyleDeclaration:function(n,g){delete this.styles[n][g]},_getLineStyle:function(n){return!!this.styles[n]},_setLineStyle:function(n){this.styles[n]={}},_deleteLineStyle:function(n){delete this.styles[n]}})}(),function(){function n(g){g.textDecoration&&(g.textDecoration.indexOf("underline")>-1&&(g.underline=!0),g.textDecoration.indexOf("line-through")>-1&&(g.linethrough=!0),g.textDecoration.indexOf("overline")>-1&&(g.overline=!0),delete g.textDecoration)}I.IText=I.util.createClass(I.Text,I.Observable,{type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:0,_selectionDirection:null,_abortCursorAnimation:!1,__widthOfSpace:[],inCompositionMode:!1,initialize:function(g,x){this.callSuper("initialize",g,x),this.initBehavior()},setSelectionStart:function(g){g=Math.max(g,0),this._updateAndFire("selectionStart",g)},setSelectionEnd:function(g){g=Math.min(g,this.text.length),this._updateAndFire("selectionEnd",g)},_updateAndFire:function(g,x){this[g]!==x&&(this._fireSelectionChanged(),this[g]=x),this._updateTextarea()},_fireSelectionChanged:function(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})},initDimensions:function(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this.callSuper("initDimensions")},render:function(g){this.clearContextTop(),this.callSuper("render",g),this.cursorOffsetCache={},this.renderCursorOrSelection()},_render:function(g){this.callSuper("_render",g)},clearContextTop:function(g){if(!(!this.isEditing||!this.canvas||!this.canvas.contextTop)){var x=this.canvas.contextTop,v=this.canvas.viewportTransform;x.save(),x.transform(v[0],v[1],v[2],v[3],v[4],v[5]),this.transform(x),this._clearTextArea(x),g||x.restore()}},renderCursorOrSelection:function(){if(!(!this.isEditing||!this.canvas||!this.canvas.contextTop)){var g=this._getCursorBoundaries(),x=this.canvas.contextTop;this.clearContextTop(!0),this.selectionStart===this.selectionEnd?this.renderCursor(g,x):this.renderSelection(g,x),x.restore()}},_clearTextArea:function(g){var x=this.width+4,v=this.height+4;g.clearRect(-x/2,-v/2,x,v)},_getCursorBoundaries:function(g){typeof g>"u"&&(g=this.selectionStart);var x=this._getLeftOffset(),v=this._getTopOffset(),h=this._getCursorBoundariesOffsets(g);return{left:x,top:v,leftOffset:h.left,topOffset:h.top}},_getCursorBoundariesOffsets:function(g){if(this.cursorOffsetCache&&"top"in this.cursorOffsetCache)return this.cursorOffsetCache;var x,v,h,a=0,c=0,d,_=this.get2DCursorLocation(g);h=_.charIndex,v=_.lineIndex;for(var u=0;u<v;u++)a+=this.getHeightOfLine(u);x=this._getLineLeftOffset(v);var C=this.__charBounds[v][h];return C&&(c=C.left),this.charSpacing!==0&&h===this._textLines[v].length&&(c-=this._getWidthOfCharSpacing()),d={top:a,left:x+(c>0?c:0)},this.direction==="rtl"&&(d.left*=-1),this.cursorOffsetCache=d,this.cursorOffsetCache},renderCursor:function(g,x){var v=this.get2DCursorLocation(),h=v.lineIndex,a=v.charIndex>0?v.charIndex-1:0,c=this.getValueOfPropertyAt(h,a,"fontSize"),d=this.scaleX*this.canvas.getZoom(),_=this.cursorWidth/d,u=g.topOffset,C=this.getValueOfPropertyAt(h,a,"deltaY");u+=(1-this._fontSizeFraction)*this.getHeightOfLine(h)/this.lineHeight-c*(1-this._fontSizeFraction),this.inCompositionMode&&this.renderSelection(g,x),x.fillStyle=this.cursorColor||this.getValueOfPropertyAt(h,a,"fill"),x.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,x.fillRect(g.left+g.leftOffset-_/2,u+g.top+C,_,c)},renderSelection:function(g,x){for(var v=this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,h=this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd,a=this.textAlign.indexOf("justify")!==-1,c=this.get2DCursorLocation(v),d=this.get2DCursorLocation(h),_=c.lineIndex,u=d.lineIndex,C=c.charIndex<0?0:c.charIndex,S=d.charIndex<0?0:d.charIndex,A=_;A<=u;A++){var O=this._getLineLeftOffset(A)||0,U=this.getHeightOfLine(A),Y=0,oe=0,ge=0;if(A===_&&(oe=this.__charBounds[_][C].left),A>=_&&A<u)ge=a&&!this.isEndOfWrapping(A)?this.width:this.getLineWidth(A)||5;else if(A===u)if(S===0)ge=this.__charBounds[u][S].left;else{var ze=this._getWidthOfCharSpacing();ge=this.__charBounds[u][S-1].left+this.__charBounds[u][S-1].width-ze}Y=U,(this.lineHeight<1||A===u&&this.lineHeight>1)&&(U/=this.lineHeight);var We=g.left+O+oe,at=ge-oe,_t=U,vt=0;this.inCompositionMode?(x.fillStyle=this.compositionColor||"black",_t=1,vt=U):x.fillStyle=this.selectionColor,this.direction==="rtl"&&(We=this.width-We-at),x.fillRect(We,g.top+g.topOffset+vt,at,_t),g.topOffset+=Y}},getCurrentCharFontSize:function(){var g=this._getCurrentCharIndex();return this.getValueOfPropertyAt(g.l,g.c,"fontSize")},getCurrentCharColor:function(){var g=this._getCurrentCharIndex();return this.getValueOfPropertyAt(g.l,g.c,"fill")},_getCurrentCharIndex:function(){var g=this.get2DCursorLocation(this.selectionStart,!0),x=g.charIndex>0?g.charIndex-1:0;return{l:g.lineIndex,c:x}}}),I.IText.fromObject=function(g,x){var v=I.util.stylesFromArray(g.styles,g.text),h=Object.assign({},g,{styles:v});if(n(h),h.styles)for(var a in h.styles)for(var c in h.styles[a])n(h.styles[a][c]);I.Object._fromObject("IText",h,x,"text")}}(),function(){var n=I.util.object.clone;I.util.object.extend(I.IText.prototype,{initBehavior:function(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this)},onDeselect:function(){this.isEditing&&this.exitEditing(),this.selected=!1},initAddedHandler:function(){var g=this;this.on("added",function(){var x=g.canvas;x&&(x._hasITextHandlers||(x._hasITextHandlers=!0,g._initCanvasHandlers(x)),x._iTextInstances=x._iTextInstances||[],x._iTextInstances.push(g))})},initRemovedHandler:function(){var g=this;this.on("removed",function(){var x=g.canvas;x&&(x._iTextInstances=x._iTextInstances||[],I.util.removeFromArray(x._iTextInstances,g),x._iTextInstances.length===0&&(x._hasITextHandlers=!1,g._removeCanvasHandlers(x)))})},_initCanvasHandlers:function(g){g._mouseUpITextHandler=function(){g._iTextInstances&&g._iTextInstances.forEach(function(x){x.__isMousedown=!1})},g.on("mouse:up",g._mouseUpITextHandler)},_removeCanvasHandlers:function(g){g.off("mouse:up",g._mouseUpITextHandler)},_tick:function(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")},_animateCursor:function(g,x,v,h){var a;return a={isAborted:!1,abort:function(){this.isAborted=!0}},g.animate("_currentCursorOpacity",x,{duration:v,onComplete:function(){a.isAborted||g[h]()},onChange:function(){g.canvas&&g.selectionStart===g.selectionEnd&&g.renderCursorOrSelection()},abort:function(){return a.isAborted}}),a},_onTickComplete:function(){var g=this;this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(function(){g._currentTickCompleteState=g._animateCursor(g,0,this.cursorDuration/2,"_tick")},100)},initDelayedCursor:function(g){var x=this,v=g?0:this.cursorDelay;this.abortCursorAnimation(),this._currentCursorOpacity=1,this._cursorTimeout2=setTimeout(function(){x._tick()},v)},abortCursorAnimation:function(){var g=this._currentTickState||this._currentTickCompleteState,x=this.canvas;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=0,g&&x&&x.clearContext(x.contextTop||x.contextContainer)},selectAll:function(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this},getSelectedText:function(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")},findWordBoundaryLeft:function(g){var x=0,v=g-1;if(this._reSpace.test(this._text[v]))for(;this._reSpace.test(this._text[v]);)x++,v--;for(;/\S/.test(this._text[v])&&v>-1;)x++,v--;return g-x},findWordBoundaryRight:function(g){var x=0,v=g;if(this._reSpace.test(this._text[v]))for(;this._reSpace.test(this._text[v]);)x++,v++;for(;/\S/.test(this._text[v])&&v<this._text.length;)x++,v++;return g+x},findLineBoundaryLeft:function(g){for(var x=0,v=g-1;!/\n/.test(this._text[v])&&v>-1;)x++,v--;return g-x},findLineBoundaryRight:function(g){for(var x=0,v=g;!/\n/.test(this._text[v])&&v<this._text.length;)x++,v++;return g+x},searchWordBoundary:function(g,x){for(var v=this._text,h=this._reSpace.test(v[g])?g-1:g,a=v[h],c=I.reNonWord;!c.test(a)&&h>0&&h<v.length;)h+=x,a=v[h];return c.test(a)&&(h+=x===1?0:1),h},selectWord:function(g){g=g||this.selectionStart;var x=this.searchWordBoundary(g,-1),v=this.searchWordBoundary(g,1);this.selectionStart=x,this.selectionEnd=v,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()},selectLine:function(g){g=g||this.selectionStart;var x=this.findLineBoundaryLeft(g),v=this.findLineBoundaryRight(g);return this.selectionStart=x,this.selectionEnd=v,this._fireSelectionChanged(),this._updateTextarea(),this},enterEditing:function(g){if(!(this.isEditing||!this.editable))return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(g),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this},exitEditingOnOthers:function(g){g._iTextInstances&&g._iTextInstances.forEach(function(x){x.selected=!1,x.isEditing&&x.exitEditing()})},initMouseMoveHandler:function(){this.canvas.on("mouse:move",this.mouseMoveHandler)},mouseMoveHandler:function(g){if(!(!this.__isMousedown||!this.isEditing)){document.activeElement!==this.hiddenTextarea&&this.hiddenTextarea.focus();var x=this.getSelectionStartFromPointer(g.e),v=this.selectionStart,h=this.selectionEnd;(x!==this.__selectionStartOnMouseDown||v===h)&&(v===x||h===x)||(x>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=x):(this.selectionStart=x,this.selectionEnd=this.__selectionStartOnMouseDown),(this.selectionStart!==v||this.selectionEnd!==h)&&(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}},_setEditingProps:function(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0},fromStringToGraphemeSelection:function(g,x,v){var h=v.slice(0,g),a=I.util.string.graphemeSplit(h).length;if(g===x)return{selectionStart:a,selectionEnd:a};var c=v.slice(g,x),d=I.util.string.graphemeSplit(c).length;return{selectionStart:a,selectionEnd:a+d}},fromGraphemeToStringSelection:function(g,x,v){var h=v.slice(0,g),a=h.join("").length;if(g===x)return{selectionStart:a,selectionEnd:a};var c=v.slice(g,x),d=c.join("").length;return{selectionStart:a,selectionEnd:a+d}},_updateTextarea:function(){if(this.cursorOffsetCache={},!!this.hiddenTextarea){if(!this.inCompositionMode){var g=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=g.selectionStart,this.hiddenTextarea.selectionEnd=g.selectionEnd}this.updateTextareaPosition()}},updateFromTextArea:function(){if(!!this.hiddenTextarea){this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());var g=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=g.selectionEnd,this.inCompositionMode||(this.selectionStart=g.selectionStart),this.updateTextareaPosition()}},updateTextareaPosition:function(){if(this.selectionStart===this.selectionEnd){var g=this._calcTextareaPosition();this.hiddenTextarea.style.left=g.left,this.hiddenTextarea.style.top=g.top}},_calcTextareaPosition:function(){if(!this.canvas)return{x:1,y:1};var g=this.inCompositionMode?this.compositionStart:this.selectionStart,x=this._getCursorBoundaries(g),v=this.get2DCursorLocation(g),h=v.lineIndex,a=v.charIndex,c=this.getValueOfPropertyAt(h,a,"fontSize")*this.lineHeight,d=x.leftOffset,_=this.calcTransformMatrix(),u={x:x.left+d,y:x.top+x.topOffset+c},C=this.canvas.getRetinaScaling(),S=this.canvas.upperCanvasEl,A=S.width/C,O=S.height/C,U=A-c,Y=O-c,oe=S.clientWidth/A,ge=S.clientHeight/O;return u=I.util.transformPoint(u,_),u=I.util.transformPoint(u,this.canvas.viewportTransform),u.x*=oe,u.y*=ge,u.x<0&&(u.x=0),u.x>U&&(u.x=U),u.y<0&&(u.y=0),u.y>Y&&(u.y=Y),u.x+=this.canvas._offset.left,u.y+=this.canvas._offset.top,{left:u.x+"px",top:u.y+"px",fontSize:c+"px",charHeight:c}},_saveEditingProps:function(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}},_restoreEditingProps:function(){!this._savedProps||(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor))},exitEditing:function(){var g=this._textBeforeEdit!==this.text,x=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,x&&(x.blur&&x.blur(),x.parentNode&&x.parentNode.removeChild(x)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._currentCursorOpacity=0,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),g&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),g&&this.canvas.fire("object:modified",{target:this})),this},_removeExtraneousStyles:function(){for(var g in this.styles)this._textLines[g]||delete this.styles[g]},removeStyleFromTo:function(g,x){var v=this.get2DCursorLocation(g,!0),h=this.get2DCursorLocation(x,!0),a=v.lineIndex,c=v.charIndex,d=h.lineIndex,_=h.charIndex,u,C;if(a!==d){if(this.styles[a])for(u=c;u<this._unwrappedTextLines[a].length;u++)delete this.styles[a][u];if(this.styles[d])for(u=_;u<this._unwrappedTextLines[d].length;u++)C=this.styles[d][u],C&&(this.styles[a]||(this.styles[a]={}),this.styles[a][c+u-_]=C);for(u=a+1;u<=d;u++)delete this.styles[u];this.shiftLineStyles(d,a-d)}else if(this.styles[a]){C=this.styles[a];var S=_-c,A,O;for(u=c;u<_;u++)delete C[u];for(O in this.styles[a])A=parseInt(O,10),A>=_&&(C[A-S]=C[O],delete C[O])}},shiftLineStyles:function(g,x){var v=n(this.styles);for(var h in this.styles){var a=parseInt(h,10);a>g&&(this.styles[a+x]=v[a],v[a-x]||delete this.styles[a])}},restartCursorIfNeeded:function(){(!this._currentTickState||this._currentTickState.isAborted||!this._currentTickCompleteState||this._currentTickCompleteState.isAborted)&&this.initDelayedCursor()},insertNewlineStyleObject:function(g,x,v,h){var a,c={},d=!1,_=this._unwrappedTextLines[g].length===x;v||(v=1),this.shiftLineStyles(g,v),this.styles[g]&&(a=this.styles[g][x===0?x:x-1]);for(var u in this.styles[g]){var C=parseInt(u,10);C>=x&&(d=!0,c[C-x]=this.styles[g][u],_&&x===0||delete this.styles[g][u])}var S=!1;for(d&&!_&&(this.styles[g+v]=c,S=!0),S&&v--;v>0;)h&&h[v-1]?this.styles[g+v]={0:n(h[v-1])}:a?this.styles[g+v]={0:n(a)}:delete this.styles[g+v],v--;this._forceClearCache=!0},insertCharStyleObject:function(g,x,v,h){this.styles||(this.styles={});var a=this.styles[g],c=a?n(a):{};v||(v=1);for(var d in c){var _=parseInt(d,10);_>=x&&(a[_+v]=c[_],c[_-v]||delete a[_])}if(this._forceClearCache=!0,h){for(;v--;)!Object.keys(h[v]).length||(this.styles[g]||(this.styles[g]={}),this.styles[g][x+v]=n(h[v]));return}if(!!a)for(var u=a[x?x-1:1];u&&v--;)this.styles[g][x+v]=n(u)},insertNewStyleBlock:function(g,x,v){for(var h=this.get2DCursorLocation(x,!0),a=[0],c=0,d=0;d<g.length;d++)g[d]===`
`?(c++,a[c]=0):a[c]++;a[0]>0&&(this.insertCharStyleObject(h.lineIndex,h.charIndex,a[0],v),v=v&&v.slice(a[0]+1)),c&&this.insertNewlineStyleObject(h.lineIndex,h.charIndex+a[0],c);for(var d=1;d<c;d++)a[d]>0?this.insertCharStyleObject(h.lineIndex+d,0,a[d],v):v&&this.styles[h.lineIndex+d]&&v[0]&&(this.styles[h.lineIndex+d][0]=v[0]),v=v&&v.slice(a[d]+1);a[d]>0&&this.insertCharStyleObject(h.lineIndex+d,0,a[d],v)},setSelectionStartEndWithShift:function(g,x,v){v<=g?(x===g?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=g),this.selectionStart=v):v>g&&v<x?this._selectionDirection==="right"?this.selectionEnd=v:this.selectionStart=v:(x===g?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=x),this.selectionEnd=v)},setSelectionInBoundaries:function(){var g=this.text.length;this.selectionStart>g?this.selectionStart=g:this.selectionStart<0&&(this.selectionStart=0),this.selectionEnd>g?this.selectionEnd=g:this.selectionEnd<0&&(this.selectionEnd=0)}})}(),I.util.object.extend(I.IText.prototype,{initDoubleClickSimulation:function(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)},onMouseDown:function(n){if(!!this.canvas){this.__newClickTime=+new Date;var g=n.pointer;this.isTripleClick(g)&&(this.fire("tripleclick",n),this._stopEvent(n.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=g,this.__lastIsEditing=this.isEditing,this.__lastSelected=this.selected}},isTripleClick:function(n){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===n.x&&this.__lastPointer.y===n.y},_stopEvent:function(n){n.preventDefault&&n.preventDefault(),n.stopPropagation&&n.stopPropagation()},initCursorSelectionHandlers:function(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()},doubleClickHandler:function(n){!this.isEditing||this.selectWord(this.getSelectionStartFromPointer(n.e))},tripleClickHandler:function(n){!this.isEditing||this.selectLine(this.getSelectionStartFromPointer(n.e))},initClicks:function(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)},_mouseDownHandler:function(n){!this.canvas||!this.editable||n.e.button&&n.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(n.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))},_mouseDownHandlerBefore:function(n){!this.canvas||!this.editable||n.e.button&&n.e.button!==1||(this.selected=this===this.canvas._activeObject)},initMousedownHandler:function(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)},initMouseupHandler:function(){this.on("mouseup",this.mouseUpHandler)},mouseUpHandler:function(n){if(this.__isMousedown=!1,!(!this.editable||this.group||n.transform&&n.transform.actionPerformed||n.e.button&&n.e.button!==1)){if(this.canvas){var g=this.canvas._activeObject;if(g&&g!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(n.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}},setCursorByClick:function(n){var g=this.getSelectionStartFromPointer(n),x=this.selectionStart,v=this.selectionEnd;n.shiftKey?this.setSelectionStartEndWithShift(x,v,g):(this.selectionStart=g,this.selectionEnd=g),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())},getSelectionStartFromPointer:function(n){for(var g=this.getLocalPointer(n),x=0,v=0,h=0,a=0,c=0,d,_,u=0,C=this._textLines.length;u<C&&h<=g.y;u++)h+=this.getHeightOfLine(u)*this.scaleY,c=u,u>0&&(a+=this._textLines[u-1].length+this.missingNewlineOffset(u-1));d=this._getLineLeftOffset(c),v=d*this.scaleX,_=this._textLines[c],this.direction==="rtl"&&(g.x=this.width*this.scaleX-g.x+v);for(var S=0,A=_.length;S<A&&(x=v,v+=this.__charBounds[c][S].kernedWidth*this.scaleX,v<=g.x);S++)a++;return this._getNewSelectionStartFromOffset(g,x,v,a,A)},_getNewSelectionStartFromOffset:function(n,g,x,v,h){var a=n.x-g,c=x-n.x,d=c>a||c<0?0:1,_=v+d;return this.flipX&&(_=h-_),_>this._text.length&&(_=this._text.length),_}}),I.util.object.extend(I.IText.prototype,{initHiddenTextarea:function(){this.hiddenTextarea=I.document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric-hiddentextarea",""),this.hiddenTextarea.setAttribute("wrap","off");var n=this._calcTextareaPosition();this.hiddenTextarea.style.cssText="position: absolute; top: "+n.top+"; left: "+n.left+"; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding\uFF70top: "+n.fontSize+";",this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):I.document.body.appendChild(this.hiddenTextarea),I.util.addListener(this.hiddenTextarea,"keydown",this.onKeyDown.bind(this)),I.util.addListener(this.hiddenTextarea,"keyup",this.onKeyUp.bind(this)),I.util.addListener(this.hiddenTextarea,"input",this.onInput.bind(this)),I.util.addListener(this.hiddenTextarea,"copy",this.copy.bind(this)),I.util.addListener(this.hiddenTextarea,"cut",this.copy.bind(this)),I.util.addListener(this.hiddenTextarea,"paste",this.paste.bind(this)),I.util.addListener(this.hiddenTextarea,"compositionstart",this.onCompositionStart.bind(this)),I.util.addListener(this.hiddenTextarea,"compositionupdate",this.onCompositionUpdate.bind(this)),I.util.addListener(this.hiddenTextarea,"compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(I.util.addListener(this.canvas.upperCanvasEl,"click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)},keysMap:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},keysMapRtl:{9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},ctrlKeysMapUp:{67:"copy",88:"cut"},ctrlKeysMapDown:{65:"selectAll"},onClick:function(){this.hiddenTextarea&&this.hiddenTextarea.focus()},onKeyDown:function(n){if(!!this.isEditing){var g=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(n.keyCode in g)this[g[n.keyCode]](n);else if(n.keyCode in this.ctrlKeysMapDown&&(n.ctrlKey||n.metaKey))this[this.ctrlKeysMapDown[n.keyCode]](n);else return;n.stopImmediatePropagation(),n.preventDefault(),n.keyCode>=33&&n.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}},onKeyUp:function(n){if(!this.isEditing||this._copyDone||this.inCompositionMode){this._copyDone=!1;return}if(n.keyCode in this.ctrlKeysMapUp&&(n.ctrlKey||n.metaKey))this[this.ctrlKeysMapUp[n.keyCode]](n);else return;n.stopImmediatePropagation(),n.preventDefault(),this.canvas&&this.canvas.requestRenderAll()},onInput:function(n){var g=this.fromPaste;if(this.fromPaste=!1,n&&n.stopPropagation(),!!this.isEditing){var x=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,v=this._text.length,h=x.length,a,c,d=h-v,_=this.selectionStart,u=this.selectionEnd,C=_!==u,S,A,O;if(this.hiddenTextarea.value===""){this.styles={},this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll());return}var U=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),Y=_>U.selectionStart;C?(a=this._text.slice(_,u),d+=u-_):h<v&&(Y?a=this._text.slice(u+d,u):a=this._text.slice(_,_-d)),c=x.slice(U.selectionEnd-d,U.selectionEnd),a&&a.length&&(c.length&&(S=this.getSelectionStyles(_,_+1,!1),S=c.map(function(){return S[0]})),C?(A=_,O=u):Y?(A=u-a.length,O=u):(A=u,O=u+a.length),this.removeStyleFromTo(A,O)),c.length&&(g&&c.join("")===I.copiedText&&!I.disableStyleCopyPaste&&(S=I.copiedTextStyle),this.insertNewStyleBlock(c,_,S)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}},onCompositionStart:function(){this.inCompositionMode=!0},onCompositionEnd:function(){this.inCompositionMode=!1},onCompositionUpdate:function(n){this.compositionStart=n.target.selectionStart,this.compositionEnd=n.target.selectionEnd,this.updateTextareaPosition()},copy:function(){this.selectionStart!==this.selectionEnd&&(I.copiedText=this.getSelectedText(),I.disableStyleCopyPaste?I.copiedTextStyle=null:I.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)},paste:function(){this.fromPaste=!0},_getClipboardData:function(n){return n&&n.clipboardData||I.window.clipboardData},_getWidthBeforeCursor:function(n,g){var x=this._getLineLeftOffset(n),v;return g>0&&(v=this.__charBounds[n][g-1],x+=v.left+v.width),x},getDownCursorOffset:function(n,g){var x=this._getSelectionForOffset(n,g),v=this.get2DCursorLocation(x),h=v.lineIndex;if(h===this._textLines.length-1||n.metaKey||n.keyCode===34)return this._text.length-x;var a=v.charIndex,c=this._getWidthBeforeCursor(h,a),d=this._getIndexOnLine(h+1,c),_=this._textLines[h].slice(a);return _.length+d+1+this.missingNewlineOffset(h)},_getSelectionForOffset:function(n,g){return n.shiftKey&&this.selectionStart!==this.selectionEnd&&g?this.selectionEnd:this.selectionStart},getUpCursorOffset:function(n,g){var x=this._getSelectionForOffset(n,g),v=this.get2DCursorLocation(x),h=v.lineIndex;if(h===0||n.metaKey||n.keyCode===33)return-x;var a=v.charIndex,c=this._getWidthBeforeCursor(h,a),d=this._getIndexOnLine(h-1,c),_=this._textLines[h].slice(0,a),u=this.missingNewlineOffset(h-1);return-this._textLines[h-1].length+d-_.length+(1-u)},_getIndexOnLine:function(n,g){for(var x=this._textLines[n],v=this._getLineLeftOffset(n),h=v,a=0,c,d,_=0,u=x.length;_<u;_++)if(c=this.__charBounds[n][_].width,h+=c,h>g){d=!0;var C=h-c,S=h,A=Math.abs(C-g),O=Math.abs(S-g);a=O<A?_:_-1;break}return d||(a=x.length-1),a},moveCursorDown:function(n){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",n)},moveCursorUp:function(n){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",n)},_moveCursorUpOrDown:function(n,g){var x="get"+n+"CursorOffset",v=this[x](g,this._selectionDirection==="right");g.shiftKey?this.moveCursorWithShift(v):this.moveCursorWithoutShift(v),v!==0&&(this.setSelectionInBoundaries(),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorWithShift:function(n){var g=this._selectionDirection==="left"?this.selectionStart+n:this.selectionEnd+n;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,g),n!==0},moveCursorWithoutShift:function(n){return n<0?(this.selectionStart+=n,this.selectionEnd=this.selectionStart):(this.selectionEnd+=n,this.selectionStart=this.selectionEnd),n!==0},moveCursorLeft:function(n){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",n)},_move:function(n,g,x){var v;if(n.altKey)v=this["findWordBoundary"+x](this[g]);else if(n.metaKey||n.keyCode===35||n.keyCode===36)v=this["findLineBoundary"+x](this[g]);else return this[g]+=x==="Left"?-1:1,!0;if(typeof v<"u"&&this[g]!==v)return this[g]=v,!0},_moveLeft:function(n,g){return this._move(n,g,"Left")},_moveRight:function(n,g){return this._move(n,g,"Right")},moveCursorLeftWithoutShift:function(n){var g=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(g=this._moveLeft(n,"selectionStart")),this.selectionEnd=this.selectionStart,g},moveCursorLeftWithShift:function(n){if(this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd)return this._moveLeft(n,"selectionEnd");if(this.selectionStart!==0)return this._selectionDirection="left",this._moveLeft(n,"selectionStart")},moveCursorRight:function(n){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",n)},_moveCursorLeftOrRight:function(n,g){var x="moveCursor"+n+"With";this._currentCursorOpacity=1,g.shiftKey?x+="Shift":x+="outShift",this[x](g)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())},moveCursorRightWithShift:function(n){if(this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd)return this._moveRight(n,"selectionStart");if(this.selectionEnd!==this._text.length)return this._selectionDirection="right",this._moveRight(n,"selectionEnd")},moveCursorRightWithoutShift:function(n){var g=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(g=this._moveRight(n,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,g},removeChars:function(n,g){typeof g>"u"&&(g=n+1),this.removeStyleFromTo(n,g),this._text.splice(n,g-n),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()},insertChars:function(n,g,x,v){typeof v>"u"&&(v=x),v>x&&this.removeStyleFromTo(x,v);var h=I.util.string.graphemeSplit(n);this.insertNewStyleBlock(h,x,g),this._text=[].concat(this._text.slice(0,x),h,this._text.slice(v)),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}}),function(){var n=I.util.toFixed,g=/  +/g;I.util.object.extend(I.Text.prototype,{_toSVG:function(){var x=this._getSVGLeftTopOffsets(),v=this._getSVGTextAndBg(x.textTop,x.textLeft);return this._wrapSVGTextAndBg(v)},toSVG:function(x){return this._createBaseSVGMarkup(this._toSVG(),{reviver:x,noStyle:!0,withShadow:!0})},_getSVGLeftTopOffsets:function(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}},_wrapSVGTextAndBg:function(x){var v=!0,h=this.getSvgTextDecoration(this);return[x.textBgRects.join(""),'		<text xml:space="preserve" ',this.fontFamily?'font-family="'+this.fontFamily.replace(/"/g,"'")+'" ':"",this.fontSize?'font-size="'+this.fontSize+'" ':"",this.fontStyle?'font-style="'+this.fontStyle+'" ':"",this.fontWeight?'font-weight="'+this.fontWeight+'" ':"",h?'text-decoration="'+h+'" ':"",'style="',this.getSvgStyles(v),'"',this.addPaintOrder()," >",x.textSpans.join(""),`</text>
`]},_getSVGTextAndBg:function(x,v){var h=[],a=[],c=x,d;this._setSVGBg(a);for(var _=0,u=this._textLines.length;_<u;_++)d=this._getLineLeftOffset(_),(this.textBackgroundColor||this.styleHas("textBackgroundColor",_))&&this._setSVGTextLineBg(a,_,v+d,c),this._setSVGTextLineText(h,_,v+d,c),c+=this.getHeightOfLine(_);return{textSpans:h,textBgRects:a}},_createTextCharSpan:function(x,v,h,a){var c=x!==x.trim()||x.match(g),d=this.getSvgSpanStyles(v,c),_=d?'style="'+d+'"':"",u=v.deltaY,C="",S=I.Object.NUM_FRACTION_DIGITS;return u&&(C=' dy="'+n(u,S)+'" '),['<tspan x="',n(h,S),'" y="',n(a,S),'" ',C,_,">",I.util.string.escapeXml(x),"</tspan>"].join("")},_setSVGTextLineText:function(x,v,h,a){var c=this.getHeightOfLine(v),d=this.textAlign.indexOf("justify")!==-1,_,u,C="",S,A,O=0,U=this._textLines[v],Y;a+=c*(1-this._fontSizeFraction)/this.lineHeight;for(var oe=0,ge=U.length-1;oe<=ge;oe++)Y=oe===ge||this.charSpacing,C+=U[oe],S=this.__charBounds[v][oe],O===0?(h+=S.kernedWidth-S.width,O+=S.width):O+=S.kernedWidth,d&&!Y&&this._reSpaceAndTab.test(U[oe])&&(Y=!0),Y||(_=_||this.getCompleteStyleDeclaration(v,oe),u=this.getCompleteStyleDeclaration(v,oe+1),Y=I.util.hasStyleChanged(_,u,!0)),Y&&(A=this._getStyleDeclaration(v,oe)||{},x.push(this._createTextCharSpan(C,A,h,a)),C="",_=u,h+=O,O=0)},_pushTextBgRect:function(x,v,h,a,c,d){var _=I.Object.NUM_FRACTION_DIGITS;x.push("		<rect ",this._getFillAttributes(v),' x="',n(h,_),'" y="',n(a,_),'" width="',n(c,_),'" height="',n(d,_),`"></rect>
`)},_setSVGTextLineBg:function(x,v,h,a){for(var c=this._textLines[v],d=this.getHeightOfLine(v)/this.lineHeight,_=0,u=0,C,S,A=this.getValueOfPropertyAt(v,0,"textBackgroundColor"),O=0,U=c.length;O<U;O++)C=this.__charBounds[v][O],S=this.getValueOfPropertyAt(v,O,"textBackgroundColor"),S!==A?(A&&this._pushTextBgRect(x,A,h+u,a,_,d),u=C.left,_=C.width,A=S):_+=C.kernedWidth;S&&this._pushTextBgRect(x,S,h+u,a,_,d)},_getFillAttributes:function(x){var v=x&&typeof x=="string"?new I.Color(x):"";return!v||!v.getSource()||v.getAlpha()===1?'fill="'+x+'"':'opacity="'+v.getAlpha()+'" fill="'+v.setAlpha(1).toRgb()+'"'},_getSVGLineTopOffset:function(x){for(var v=0,h=0,a=0;a<x;a++)v+=this.getHeightOfLine(a);return h=this.getHeightOfLine(a),{lineTop:v,offset:(this._fontSizeMult-this._fontSizeFraction)*h/(this.lineHeight*this._fontSizeMult)}},getSvgStyles:function(x){var v=I.Object.prototype.getSvgStyles.call(this,x);return v+" white-space: pre;"}})}(),function(n){var g=n.fabric||(n.fabric={});g.Textbox=g.util.createClass(g.IText,g.Observable,{type:"textbox",minWidth:20,dynamicMinWidth:2,__cachedLines:null,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:g.Text.prototype._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1,initDimensions:function(){this.__skipDimension||(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))},_generateStyleMap:function(x){for(var v=0,h=0,a=0,c={},d=0;d<x.graphemeLines.length;d++)x.graphemeText[a]===`
`&&d>0?(h=0,a++,v++):!this.splitByGrapheme&&this._reSpaceAndTab.test(x.graphemeText[a])&&d>0&&(h++,a++),c[d]={line:v,offset:h},a+=x.graphemeLines[d].length,h+=x.graphemeLines[d].length;return c},styleHas:function(x,v){if(this._styleMap&&!this.isWrapping){var h=this._styleMap[v];h&&(v=h.line)}return g.Text.prototype.styleHas.call(this,x,v)},isEmptyStyles:function(x){if(!this.styles)return!0;var v=0,h=x+1,a,c,d=!1,_=this._styleMap[x],u=this._styleMap[x+1];_&&(x=_.line,v=_.offset),u&&(h=u.line,d=h===x,a=u.offset),c=typeof x>"u"?this.styles:{line:this.styles[x]};for(var C in c)for(var S in c[C])if(S>=v&&(!d||S<a))for(var A in c[C][S])return!1;return!0},_getStyleDeclaration:function(x,v){if(this._styleMap&&!this.isWrapping){var h=this._styleMap[x];if(!h)return null;x=h.line,v=h.offset+v}return this.callSuper("_getStyleDeclaration",x,v)},_setStyleDeclaration:function(x,v,h){var a=this._styleMap[x];x=a.line,v=a.offset+v,this.styles[x][v]=h},_deleteStyleDeclaration:function(x,v){var h=this._styleMap[x];x=h.line,v=h.offset+v,delete this.styles[x][v]},_getLineStyle:function(x){var v=this._styleMap[x];return!!this.styles[v.line]},_setLineStyle:function(x){var v=this._styleMap[x];this.styles[v.line]={}},_wrapText:function(x,v){var h=[],a;for(this.isWrapping=!0,a=0;a<x.length;a++)h=h.concat(this._wrapLine(x[a],a,v));return this.isWrapping=!1,h},_measureWord:function(x,v,h){var a=0,c,d=!0;h=h||0;for(var _=0,u=x.length;_<u;_++){var C=this._getGraphemeBox(x[_],v,_+h,c,d);a+=C.kernedWidth,c=x[_]}return a},_wrapLine:function(x,v,h,We){var c=0,d=this.splitByGrapheme,_=[],u=[],C=d?g.util.string.graphemeSplit(x):x.split(this._wordJoiners),S="",A=0,O=d?"":" ",U=0,Y=0,oe=0,ge=!0,ze=this._getWidthOfCharSpacing(),We=We||0;C.length===0&&C.push([]),h-=We;for(var at=0;at<C.length;at++)S=d?C[at]:g.util.string.graphemeSplit(C[at]),U=this._measureWord(S,v,A),A+=S.length,c+=Y+U-ze,c>h&&!ge?(_.push(u),u=[],c=U,ge=!0):c+=ze,!ge&&!d&&u.push(O),u=u.concat(S),Y=d?0:this._measureWord([O],v,A),A++,ge=!1,U>oe&&(oe=U);return at&&_.push(u),oe+We>this.dynamicMinWidth&&(this.dynamicMinWidth=oe-ze+We),_},isEndOfWrapping:function(x){return!this._styleMap[x+1]||this._styleMap[x+1].line!==this._styleMap[x].line},missingNewlineOffset:function(x){return this.splitByGrapheme?this.isEndOfWrapping(x)?1:0:1},_splitTextIntoLines:function(x){for(var v=g.Text.prototype._splitTextIntoLines.call(this,x),h=this._wrapText(v.lines,this.width),a=new Array(h.length),c=0;c<h.length;c++)a[c]=h[c].join("");return v.lines=a,v.graphemeLines=h,v},getMinWidth:function(){return Math.max(this.minWidth,this.dynamicMinWidth)},_removeExtraneousStyles:function(){var x={};for(var v in this._styleMap)this._textLines[v]&&(x[this._styleMap[v].line]=1);for(var v in this.styles)x[v]||delete this.styles[v]},toObject:function(x){return this.callSuper("toObject",["minWidth","splitByGrapheme"].concat(x))}}),g.Textbox.fromObject=function(x,v){var h=g.util.stylesFromArray(x.styles,x.text),a=Object.assign({},x,{styles:h});return g.Object._fromObject("Textbox",a,v,"text")}}(Ne),function(){var n=I.controlsUtils,g=n.scaleSkewCursorStyleHandler,x=n.scaleCursorStyleHandler,v=n.scalingEqually,h=n.scalingYOrSkewingX,a=n.scalingXOrSkewingY,c=n.scaleOrSkewActionName,d=I.Object.prototype.controls;if(d.ml=new I.Control({x:-.5,y:0,cursorStyleHandler:g,actionHandler:a,getActionName:c}),d.mr=new I.Control({x:.5,y:0,cursorStyleHandler:g,actionHandler:a,getActionName:c}),d.mb=new I.Control({x:0,y:.5,cursorStyleHandler:g,actionHandler:h,getActionName:c}),d.mt=new I.Control({x:0,y:-.5,cursorStyleHandler:g,actionHandler:h,getActionName:c}),d.tl=new I.Control({x:-.5,y:-.5,cursorStyleHandler:x,actionHandler:v}),d.tr=new I.Control({x:.5,y:-.5,cursorStyleHandler:x,actionHandler:v}),d.bl=new I.Control({x:-.5,y:.5,cursorStyleHandler:x,actionHandler:v}),d.br=new I.Control({x:.5,y:.5,cursorStyleHandler:x,actionHandler:v}),d.mtr=new I.Control({x:0,y:-.5,actionHandler:n.rotationWithSnapping,cursorStyleHandler:n.rotationStyleHandler,offsetY:-40,withConnection:!0,actionName:"rotate"}),I.Textbox){var _=I.Textbox.prototype.controls={};_.mtr=d.mtr,_.tr=d.tr,_.br=d.br,_.tl=d.tl,_.bl=d.bl,_.mt=d.mt,_.mb=d.mb,_.mr=new I.Control({x:.5,y:0,actionHandler:n.changeWidth,cursorStyleHandler:g,actionName:"resizing"}),_.ml=new I.Control({x:-.5,y:0,actionHandler:n.changeWidth,cursorStyleHandler:g,actionName:"resizing"})}}()})(En);var Gc={exports:{}};(function(Ne,I){(function(Tt,ft){Ne.exports=ft()})(Ia,function(){var Tt,ft,At;function Yt(n,g){if(!Tt)Tt=g;else if(!ft)ft=g;else{var x="var sharedChunk = {}; ("+Tt+")(sharedChunk); ("+ft+")(sharedChunk);",v={};Tt(v),At=g(v),typeof window<"u"&&(At.workerUrl=window.URL.createObjectURL(new Blob([x],{type:"text/javascript"})))}}Yt(["exports"],function(n){var g=x;function x(i,e,r,o){this.cx=3*i,this.bx=3*(r-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(o-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=e,this.p2x=r,this.p2y=o}function v(i,e,r,o){const p=new g(i,e,r,o);return function(y){return p.solve(y)}}x.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,e){if(e===void 0&&(e=1e-6),i<0)return 0;if(i>1)return 1;for(var r=i,o=0;o<8;o++){var p=this.sampleCurveX(r)-i;if(Math.abs(p)<e)return r;var y=this.sampleCurveDerivativeX(r);if(Math.abs(y)<1e-6)break;r-=p/y}var w=0,P=1;for(r=i,o=0;o<20&&(p=this.sampleCurveX(r),!(Math.abs(p-i)<e));o++)i>p?w=r:P=r,r=.5*(P-w)+w;return r},solve:function(i,e){return this.sampleCurveY(this.solveCurveX(i,e))}};const h=v(.25,.1,.25,1);function a(i,e,r){return Math.min(r,Math.max(e,i))}function c(i,e,r){const o=r-e,p=((i-e)%o+o)%o+e;return p===e?r:p}function d(i,...e){for(const r of e)for(const o in r)i[o]=r[o];return i}let _=1;function u(i,e){i.forEach(r=>{e[r]&&(e[r]=e[r].bind(e))})}function C(i,e,r){const o={};for(const p in i)o[p]=e.call(r||this,i[p],p,i);return o}function S(i,e,r){const o={};for(const p in i)e.call(r||this,i[p],p,i)&&(o[p]=i[p]);return o}function A(i){return Array.isArray(i)?i.map(A):typeof i=="object"&&i?C(i,A):i}const O={};function U(i){O[i]||(typeof console<"u"&&console.warn(i),O[i]=!0)}function Y(i,e,r){return(r.y-i.y)*(e.x-i.x)>(e.y-i.y)*(r.x-i.x)}function oe(i){let e=0;for(let r,o,p=0,y=i.length,w=y-1;p<y;w=p++)r=i[p],o=i[w],e+=(o.x-r.x)*(r.y+o.y);return e}function ge(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function ze(i){const e={};if(i.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,o,p,y)=>{const w=p||y;return e[o]=!w||w.toLowerCase(),""}),e["max-age"]){const r=parseInt(e["max-age"],10);isNaN(r)?delete e["max-age"]:e["max-age"]=r}return e}let We,at,_t=null;function vt(i){if(_t==null){const e=i.navigator?i.navigator.userAgent:null;_t=!!i.safari||!(!e||!(/\b(iPad|iPhone|iPod)\b/.test(e)||e.match("Safari")&&!e.match("Chrome")))}return _t}function rt(i){return typeof ImageBitmap<"u"&&i instanceof ImageBitmap}const mt={now:typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frame(i){const e=requestAnimationFrame(i);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(i,e=0){const r=window.document.createElement("canvas"),o=r.getContext("2d");if(!o)throw new Error("failed to create canvas 2d context");return r.width=i.width,r.height=i.height,o.drawImage(i,0,0,i.width,i.height),o.getImageData(-e,-e,i.width+2*e,i.height+2*e)},resolveURL:i=>(We||(We=document.createElement("a")),We.href=i,We.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(at==null&&(at=matchMedia("(prefers-reduced-motion: reduce)")),at.matches)}};var Qe=zt;function zt(i,e){this.x=i,this.y=e}zt.prototype={clone:function(){return new zt(this.x,this.y)},add:function(i){return this.clone()._add(i)},sub:function(i){return this.clone()._sub(i)},multByPoint:function(i){return this.clone()._multByPoint(i)},divByPoint:function(i){return this.clone()._divByPoint(i)},mult:function(i){return this.clone()._mult(i)},div:function(i){return this.clone()._div(i)},rotate:function(i){return this.clone()._rotate(i)},rotateAround:function(i,e){return this.clone()._rotateAround(i,e)},matMult:function(i){return this.clone()._matMult(i)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(i){return this.x===i.x&&this.y===i.y},dist:function(i){return Math.sqrt(this.distSqr(i))},distSqr:function(i){var e=i.x-this.x,r=i.y-this.y;return e*e+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(i){return Math.atan2(this.y-i.y,this.x-i.x)},angleWith:function(i){return this.angleWithSep(i.x,i.y)},angleWithSep:function(i,e){return Math.atan2(this.x*e-this.y*i,this.x*i+this.y*e)},_matMult:function(i){var e=i[2]*this.x+i[3]*this.y;return this.x=i[0]*this.x+i[1]*this.y,this.y=e,this},_add:function(i){return this.x+=i.x,this.y+=i.y,this},_sub:function(i){return this.x-=i.x,this.y-=i.y,this},_mult:function(i){return this.x*=i,this.y*=i,this},_div:function(i){return this.x/=i,this.y/=i,this},_multByPoint:function(i){return this.x*=i.x,this.y*=i.y,this},_divByPoint:function(i){return this.x/=i.x,this.y/=i.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var i=this.y;return this.y=this.x,this.x=-i,this},_rotate:function(i){var e=Math.cos(i),r=Math.sin(i),o=r*this.x+e*this.y;return this.x=e*this.x-r*this.y,this.y=o,this},_rotateAround:function(i,e){var r=Math.cos(i),o=Math.sin(i),p=e.y+o*(this.x-e.x)+r*(this.y-e.y);return this.x=e.x+r*(this.x-e.x)-o*(this.y-e.y),this.y=p,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},zt.convert=function(i){return i instanceof zt?i:Array.isArray(i)?new zt(i[0],i[1]):i};const Et={MAX_PARALLEL_IMAGE_REQUESTS:16,REGISTERED_PROTOCOLS:{}},Q="mapbox-tiles";let se,de,ie=500,ve=50;function J(){typeof caches>"u"||se||(se=caches.open(Q))}let q=1/0;const ce={supported:!1,testSupport:function(i){!Ie&&De&&(tt?ut(i):be=i)}};let be,De,Ie=!1,tt=!1;function ut(i){const e=i.createTexture();i.bindTexture(i.TEXTURE_2D,e);try{if(i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,De),i.isContextLost())return;ce.supported=!0}catch{}i.deleteTexture(e),Ie=!0}typeof document<"u"&&(De=document.createElement("img"),De.onload=function(){be&&ut(be),be=null,tt=!0},De.onerror=function(){Ie=!0,be=null},De.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const nt={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};typeof Object.freeze=="function"&&Object.freeze(nt);class je extends Error{constructor(e,r,o,p){super(`AJAXError: ${r} (${e}): ${o}`),this.status=e,this.statusText=r,this.url=o,this.body=p}}const Ce=ge()?()=>self.worker&&self.worker.referrer:()=>(window.location.protocol==="blob:"?window.parent:window).location.href;function Ve(i,e){const r=new AbortController,o=new Request(i.url,{method:i.method||"GET",body:i.body,credentials:i.credentials,headers:i.headers,referrer:Ce(),signal:r.signal});let p=!1,y=!1;return i.type==="json"&&o.headers.set("Accept","application/json"),((w,P,k)=>{if(y)return;const F=Date.now();fetch(o).then(j=>j.ok?((N,W,Z)=>{(i.type==="arrayBuffer"?N.arrayBuffer():i.type==="json"?N.json():N.text()).then(K=>{y||(W&&Z&&function(me,ue,Me){if(J(),!se)return;const Xe={status:ue.status,statusText:ue.statusText,headers:new Headers};ue.headers.forEach((Be,ht)=>Xe.headers.set(ht,Be));const Pe=ze(ue.headers.get("Cache-Control")||"");Pe["no-store"]||(Pe["max-age"]&&Xe.headers.set("Expires",new Date(Me+1e3*Pe["max-age"]).toUTCString()),new Date(Xe.headers.get("Expires")).getTime()-Me<42e4||function(Be,ht){if(de===void 0)try{new Response(new ReadableStream),de=!0}catch{de=!1}de?ht(Be.body):Be.blob().then(ht)}(ue,Be=>{const ht=new Response(Be,Xe);J(),se&&se.then(ct=>ct.put(function($t){const Qt=$t.indexOf("?");return Qt<0?$t:$t.slice(0,Qt)}(me.url),ht)).catch(ct=>U(ct.message))}))}(o,W,Z),p=!0,e(null,K,N.headers.get("Cache-Control"),N.headers.get("Expires")))}).catch(K=>{y||e(new Error(K.message))})})(j,null,F):j.blob().then(N=>e(new je(j.status,j.statusText,i.url,N)))).catch(j=>{j.code!==20&&e(new Error(j.message))})})(),{cancel:()=>{y=!0,p||r.abort()}}}const Je=function(i,e){if(/:\/\//.test(i.url)&&!/^https?:|^file:/.test(i.url)){if(ge()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",i,e);if(!ge()){const o=i.url.substring(0,i.url.indexOf("://"));return(Et.REGISTERED_PROTOCOLS[o]||Ve)(i,e)}}if(!(/^file:/.test(r=i.url)||/^file:/.test(Ce())&&!/^\w+:/.test(r))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return Ve(i,e);if(ge()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",i,e,void 0,!0)}var r;return function(o,p){const y=new XMLHttpRequest;y.open(o.method||"GET",o.url,!0),o.type==="arrayBuffer"&&(y.responseType="arraybuffer");for(const w in o.headers)y.setRequestHeader(w,o.headers[w]);return o.type==="json"&&(y.responseType="text",y.setRequestHeader("Accept","application/json")),y.withCredentials=o.credentials==="include",y.onerror=()=>{p(new Error(y.statusText))},y.onload=()=>{if((y.status>=200&&y.status<300||y.status===0)&&y.response!==null){let w=y.response;if(o.type==="json")try{w=JSON.parse(y.response)}catch(P){return p(P)}p(null,w,y.getResponseHeader("Cache-Control"),y.getResponseHeader("Expires"))}else{const w=new Blob([y.response],{type:y.getResponseHeader("Content-Type")});p(new je(y.status,y.statusText,o.url,w))}},y.send(o.body),{cancel:()=>y.abort()}}(i,e)},$e=function(i,e){return Je(d(i,{type:"arrayBuffer"}),e)};function lt(i){const e=window.document.createElement("a");return e.href=i,e.protocol===window.document.location.protocol&&e.host===window.document.location.host}const ot="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Gt,Xt;Gt=[],Xt=0;const He=function(i,e){if(ce.supported&&(i.headers||(i.headers={}),i.headers.accept="image/webp,*/*"),Xt>=Et.MAX_PARALLEL_IMAGE_REQUESTS){const y={requestParameters:i,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Gt.push(y),y}Xt++;let r=!1;const o=()=>{if(!r)for(r=!0,Xt--;Gt.length&&Xt<Et.MAX_PARALLEL_IMAGE_REQUESTS;){const y=Gt.shift(),{requestParameters:w,callback:P,cancelled:k}=y;k||(y.cancel=He(w,P).cancel)}},p=$e(i,(y,w,P,k)=>{o(),y?e(y):w&&function(F,j){typeof createImageBitmap=="function"?function(N,W){const Z=new Blob([new Uint8Array(N)],{type:"image/png"});createImageBitmap(Z).then(K=>{W(null,K)}).catch(K=>{W(new Error(`Could not load image because of ${K.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(F,j):function(N,W){const Z=new Image;Z.onload=()=>{W(null,Z),URL.revokeObjectURL(Z.src),Z.onload=null,window.requestAnimationFrame(()=>{Z.src=ot})},Z.onerror=()=>W(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const K=new Blob([new Uint8Array(N)],{type:"image/png"});Z.src=N.byteLength?URL.createObjectURL(K):ot}(F,j)}(w,(F,j)=>{F!=null?e(F):j!=null&&e(null,j,{cacheControl:P,expires:k})})});return{cancel:()=>{p.cancel(),o()}}};function jt(i,e,r){r[i]&&r[i].indexOf(e)!==-1||(r[i]=r[i]||[],r[i].push(e))}function qt(i,e,r){if(r&&r[i]){const o=r[i].indexOf(e);o!==-1&&r[i].splice(o,1)}}class mi{constructor(e,r={}){d(this,r),this.type=e}}class Di extends mi{constructor(e,r={}){super("error",d({error:e},r))}}class wi{on(e,r){return this._listeners=this._listeners||{},jt(e,r,this._listeners),this}off(e,r){return qt(e,r,this._listeners),qt(e,r,this._oneTimeListeners),this}once(e,r){return this._oneTimeListeners=this._oneTimeListeners||{},jt(e,r,this._oneTimeListeners),this}fire(e,r){typeof e=="string"&&(e=new mi(e,r||{}));const o=e.type;if(this.listens(o)){e.target=this;const p=this._listeners&&this._listeners[o]?this._listeners[o].slice():[];for(const P of p)P.call(this,e);const y=this._oneTimeListeners&&this._oneTimeListeners[o]?this._oneTimeListeners[o].slice():[];for(const P of y)qt(o,P,this._oneTimeListeners),P.call(this,e);const w=this._eventedParent;w&&(d(e,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),w.fire(e))}else e instanceof Di&&console.error(e.error);return this}listens(e){return this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e)}setEventedParent(e,r){return this._eventedParent=e,this._eventedParentData=r,this}}var Ue={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},light:{type:"light"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"string"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{}},default:"mapbox"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{},within:{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1},elevationOffset:{type:"number",default:450}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};class yt{constructor(e,r,o,p){this.message=(e?`${e}: `:"")+o,p&&(this.identifier=p),r!=null&&r.__line__&&(this.line=r.__line__)}}function Ri(i){const e=i.value;return e?[new yt(i.key,e,"constants have been deprecated as of v8")]:[]}function Zi(i,...e){for(const r of e)for(const o in r)i[o]=r[o];return i}function ri(i){return i instanceof Number||i instanceof String||i instanceof Boolean?i.valueOf():i}function Ei(i){if(Array.isArray(i))return i.map(Ei);if(i instanceof Object&&!(i instanceof Number||i instanceof String||i instanceof Boolean)){const e={};for(const r in i)e[r]=Ei(i[r]);return e}return ri(i)}class dr extends Error{constructor(e,r){super(r),this.message=r,this.key=e}}class fr{constructor(e,r=[]){this.parent=e,this.bindings={};for(const[o,p]of r)this.bindings[o]=p}concat(e){return new fr(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const Ki={kind:"null"},st={kind:"number"},bi={kind:"string"},xi={kind:"boolean"},br={kind:"color"},tn={kind:"object"},yi={kind:"value"},Oi={kind:"collator"},wr={kind:"formatted"},Vr={kind:"padding"},lr={kind:"resolvedImage"};function Dr(i,e){return{kind:"array",itemType:i,N:e}}function Xi(i){if(i.kind==="array"){const e=Xi(i.itemType);return typeof i.N=="number"?`array<${e}, ${i.N}>`:i.itemType.kind==="value"?"array":`array<${e}>`}return i.kind}const as=[Ki,st,bi,xi,br,wr,tn,Dr(yi),Vr,lr];function Zr(i,e){if(e.kind==="error")return null;if(i.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Zr(i.itemType,e.itemType))&&(typeof i.N!="number"||i.N===e.N))return null}else{if(i.kind===e.kind)return null;if(i.kind==="value"){for(const r of as)if(!Zr(r,e))return null}}return`Expected ${Xi(i)} but found ${Xi(e)} instead.`}function ls(i,e){return e.some(r=>r.kind===i.kind)}function Wn(i,e){return e.some(r=>r==="null"?i===null:r==="array"?Array.isArray(i):r==="object"?i&&!Array.isArray(i)&&typeof i=="object":r===typeof i)}var $n,qn={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function re(i){return(i=Math.round(i))<0?0:i>255?255:i}function B(i){return re(i[i.length-1]==="%"?parseFloat(i)/100*255:parseInt(i))}function G(i){return(e=i[i.length-1]==="%"?parseFloat(i)/100:parseFloat(i))<0?0:e>1?1:e;var e}function ee(i,e,r){return r<0?r+=1:r>1&&(r-=1),6*r<1?i+(e-i)*r*6:2*r<1?e:3*r<2?i+(e-i)*(2/3-r)*6:i}try{$n={}.parseCSSColor=function(i){var e,r=i.replace(/ /g,"").toLowerCase();if(r in qn)return qn[r].slice();if(r[0]==="#")return r.length===4?(e=parseInt(r.substr(1),16))>=0&&e<=4095?[(3840&e)>>4|(3840&e)>>8,240&e|(240&e)>>4,15&e|(15&e)<<4,1]:null:r.length===7&&(e=parseInt(r.substr(1),16))>=0&&e<=16777215?[(16711680&e)>>16,(65280&e)>>8,255&e,1]:null;var o=r.indexOf("("),p=r.indexOf(")");if(o!==-1&&p+1===r.length){var y=r.substr(0,o),w=r.substr(o+1,p-(o+1)).split(","),P=1;switch(y){case"rgba":if(w.length!==4)return null;P=G(w.pop());case"rgb":return w.length!==3?null:[B(w[0]),B(w[1]),B(w[2]),P];case"hsla":if(w.length!==4)return null;P=G(w.pop());case"hsl":if(w.length!==3)return null;var k=(parseFloat(w[0])%360+360)%360/360,F=G(w[1]),j=G(w[2]),N=j<=.5?j*(F+1):j+F-j*F,W=2*j-N;return[re(255*ee(W,N,k+1/3)),re(255*ee(W,N,k)),re(255*ee(W,N,k-1/3)),P];default:return null}}return null}}catch{}class te{constructor(e,r,o,p=1){this.r=e,this.g=r,this.b=o,this.a=p}static parse(e){if(!e)return;if(e instanceof te)return e;if(typeof e!="string")return;const r=$n(e);return r?new te(r[0]/255*r[3],r[1]/255*r[3],r[2]/255*r[3],r[3]):void 0}toString(){const[e,r,o,p]=this.toArray();return`rgba(${Math.round(e)},${Math.round(r)},${Math.round(o)},${p})`}toArray(){const{r:e,g:r,b:o,a:p}=this;return p===0?[0,0,0,0]:[255*e/p,255*r/p,255*o/p,p]}}te.black=new te(0,0,0,1),te.white=new te(1,1,1,1),te.transparent=new te(0,0,0,0),te.red=new te(1,0,0,1);class fe{constructor(e,r,o){this.sensitivity=e?r?"variant":"case":r?"accent":"base",this.locale=o,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,r){return this.collator.compare(e,r)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class we{constructor(e,r,o,p,y){this.text=e,this.image=r,this.scale=o,this.fontStack=p,this.textColor=y}}class _e{constructor(e){this.sections=e}static fromString(e){return new _e([new we(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||e.image&&e.image.name.length!==0)}static factory(e){return e instanceof _e?e:_e.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}}class pe{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof pe)return e;if(typeof e=="number")return new pe([e,e,e,e]);if(Array.isArray(e)&&!(e.length<1||e.length>4)){for(const r of e)if(typeof r!="number")return;switch(e.length){case 1:e=[e[0],e[0],e[0],e[0]];break;case 2:e=[e[0],e[1],e[0],e[1]];break;case 3:e=[e[0],e[1],e[2],e[1]]}return new pe(e)}}toString(){return JSON.stringify(this.values)}}class Se{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new Se({name:e,available:!1}):null}}function Ye(i,e,r,o){return typeof i=="number"&&i>=0&&i<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof r=="number"&&r>=0&&r<=255?o===void 0||typeof o=="number"&&o>=0&&o<=1?null:`Invalid rgba value [${[i,e,r,o].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof o=="number"?[i,e,r,o]:[i,e,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function pt(i){if(i===null||typeof i=="string"||typeof i=="boolean"||typeof i=="number"||i instanceof te||i instanceof fe||i instanceof _e||i instanceof pe||i instanceof Se)return!0;if(Array.isArray(i)){for(const e of i)if(!pt(e))return!1;return!0}if(typeof i=="object"){for(const e in i)if(!pt(i[e]))return!1;return!0}return!1}function qe(i){if(i===null)return Ki;if(typeof i=="string")return bi;if(typeof i=="boolean")return xi;if(typeof i=="number")return st;if(i instanceof te)return br;if(i instanceof fe)return Oi;if(i instanceof _e)return wr;if(i instanceof pe)return Vr;if(i instanceof Se)return lr;if(Array.isArray(i)){const e=i.length;let r;for(const o of i){const p=qe(o);if(r){if(r===p)continue;r=yi;break}r=p}return Dr(r||yi,e)}return tn}function Ht(i){const e=typeof i;return i===null?"":e==="string"||e==="number"||e==="boolean"?String(i):i instanceof te||i instanceof _e||i instanceof pe||i instanceof Se?i.toString():JSON.stringify(i)}class Jt{constructor(e,r){this.type=e,this.value=r}static parse(e,r){if(e.length!==2)return r.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!pt(e[1]))return r.error("invalid value");const o=e[1];let p=qe(o);const y=r.expectedType;return p.kind!=="array"||p.N!==0||!y||y.kind!=="array"||typeof y.N=="number"&&y.N!==0||(p=y),new Jt(p,o)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}class Pt{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const di={string:bi,number:st,boolean:xi,object:tn};class gi{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");let o,p=1;const y=e[0];if(y==="array"){let P,k;if(e.length>2){const F=e[1];if(typeof F!="string"||!(F in di)||F==="object")return r.error('The item type argument of "array" must be one of string, number, boolean',1);P=di[F],p++}else P=yi;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return r.error('The length argument to "array" must be a positive integer literal',2);k=e[2],p++}o=Dr(P,k)}else{if(!di[y])throw new Error(`Types doesn't contain name = ${y}`);o=di[y]}const w=[];for(;p<e.length;p++){const P=r.parse(e[p],p,yi);if(!P)return null;w.push(P)}return new gi(o,w)}evaluate(e){for(let r=0;r<this.args.length;r++){const o=this.args[r].evaluate(e);if(!Zr(this.type,qe(o)))return o;if(r===this.args.length-1)throw new Pt(`Expected value to be of type ${Xi(this.type)}, but found ${Xi(qe(o))} instead.`)}throw new Error}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}const Li={"to-boolean":xi,"to-color":br,"to-number":st,"to-string":bi};class vi{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const o=e[0];if(!Li[o])throw new Error(`Can't parse ${o} as it is not part of the known types`);if((o==="to-boolean"||o==="to-string")&&e.length!==2)return r.error("Expected one argument.");const p=Li[o],y=[];for(let w=1;w<e.length;w++){const P=r.parse(e[w],w,yi);if(!P)return null;y.push(P)}return new vi(p,y)}evaluate(e){if(this.type.kind==="boolean")return Boolean(this.args[0].evaluate(e));if(this.type.kind==="color"){let r,o;for(const p of this.args){if(r=p.evaluate(e),o=null,r instanceof te)return r;if(typeof r=="string"){const y=e.parseColor(r);if(y)return y}else if(Array.isArray(r)&&(o=r.length<3||r.length>4?`Invalid rbga value ${JSON.stringify(r)}: expected an array containing either three or four numeric values.`:Ye(r[0],r[1],r[2],r[3]),!o))return new te(r[0]/255,r[1]/255,r[2]/255,r[3])}throw new Pt(o||`Could not parse color from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}if(this.type.kind==="padding"){let r;for(const o of this.args){r=o.evaluate(e);const p=pe.parse(r);if(p)return p}throw new Pt(`Could not parse padding from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}if(this.type.kind==="number"){let r=null;for(const o of this.args){if(r=o.evaluate(e),r===null)return 0;const p=Number(r);if(!isNaN(p))return p}throw new Pt(`Could not convert ${JSON.stringify(r)} to number.`)}return this.type.kind==="formatted"?_e.fromString(Ht(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Se.fromString(Ht(this.args[0].evaluate(e))):Ht(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}const Ti=["Unknown","Point","LineString","Polygon"];class Bi{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Ti[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(e){let r=this._parseColorCache[e];return r||(r=this._parseColorCache[e]=te.parse(e)),r}}class Ci{constructor(e,r,o,p){this.name=e,this.type=r,this._evaluate=o,this.args=p}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}static parse(e,r){const o=e[0],p=Ci.definitions[o];if(!p)return r.error(`Unknown expression "${o}". If you wanted a literal array, use ["literal", [...]].`,0);const y=Array.isArray(p)?p[0]:p.type,w=Array.isArray(p)?[[p[1],p[2]]]:p.overloads,P=w.filter(([F])=>!Array.isArray(F)||F.length===e.length-1);let k=null;for(const[F,j]of P){k=new Te(r.registry,r.path,null,r.scope);const N=[];let W=!1;for(let Z=1;Z<e.length;Z++){const K=e[Z],me=Array.isArray(F)?F[Z-1]:F.type,ue=k.parse(K,1+N.length,me);if(!ue){W=!0;break}N.push(ue)}if(!W)if(Array.isArray(F)&&F.length!==N.length)k.error(`Expected ${F.length} arguments, but found ${N.length} instead.`);else{for(let Z=0;Z<N.length;Z++){const K=Array.isArray(F)?F[Z]:F.type,me=N[Z];k.concat(Z+1).checkSubtype(K,me.type)}if(k.errors.length===0)return new Ci(o,y,j,N)}}if(P.length===1)r.errors.push(...k.errors);else{const F=(P.length?P:w).map(([N])=>{return W=N,Array.isArray(W)?`(${W.map(Xi).join(", ")})`:`(${Xi(W.type)}...)`;var W}).join(" | "),j=[];for(let N=1;N<e.length;N++){const W=r.parse(e[N],1+j.length);if(!W)return null;j.push(Xi(W.type))}r.error(`Expected arguments of type ${F}, but found (${j.join(", ")}) instead.`)}return null}static register(e,r){Ci.definitions=r;for(const o in r)e[o]=Ci}}class Ir{constructor(e,r,o){this.type=Oi,this.locale=o,this.caseSensitive=e,this.diacriticSensitive=r}static parse(e,r){if(e.length!==2)return r.error("Expected one argument.");const o=e[1];if(typeof o!="object"||Array.isArray(o))return r.error("Collator options argument must be an object.");const p=r.parse(o["case-sensitive"]!==void 0&&o["case-sensitive"],1,xi);if(!p)return null;const y=r.parse(o["diacritic-sensitive"]!==void 0&&o["diacritic-sensitive"],1,xi);if(!y)return null;let w=null;return o.locale&&(w=r.parse(o.locale,1,bi),!w)?null:new Ir(p,y,w)}evaluate(e){return new fe(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}}const cr=8192;function gr(i,e){i[0]=Math.min(i[0],e[0]),i[1]=Math.min(i[1],e[1]),i[2]=Math.max(i[2],e[0]),i[3]=Math.max(i[3],e[1])}function Kr(i,e){return!(i[0]<=e[0]||i[2]>=e[2]||i[1]<=e[1]||i[3]>=e[3])}function vs(i,e){const r=(180+i[0])/360,o=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i[1]*Math.PI/360)))/360,p=Math.pow(2,e.z);return[Math.round(r*p*cr),Math.round(o*p*cr)]}function Vi(i,e,r){const o=i[0]-e[0],p=i[1]-e[1],y=i[0]-r[0],w=i[1]-r[1];return o*w-y*p==0&&o*y<=0&&p*w<=0}function Yn(i,e){let r=!1;for(let w=0,P=e.length;w<P;w++){const k=e[w];for(let F=0,j=k.length;F<j-1;F++){if(Vi(i,k[F],k[F+1]))return!1;(p=k[F])[1]>(o=i)[1]!=(y=k[F+1])[1]>o[1]&&o[0]<(y[0]-p[0])*(o[1]-p[1])/(y[1]-p[1])+p[0]&&(r=!r)}}var o,p,y;return r}function fo(i,e){for(let r=0;r<e.length;r++)if(Yn(i,e[r]))return!0;return!1}function la(i,e,r,o){const p=o[0]-r[0],y=o[1]-r[1],w=(i[0]-r[0])*y-p*(i[1]-r[1]),P=(e[0]-r[0])*y-p*(e[1]-r[1]);return w>0&&P<0||w<0&&P>0}function ca(i,e,r){for(const F of r)for(let j=0;j<F.length-1;++j)if((P=[(w=F[j+1])[0]-(y=F[j])[0],w[1]-y[1]])[0]*(k=[(p=e)[0]-(o=i)[0],p[1]-o[1]])[1]-P[1]*k[0]!=0&&la(o,p,y,w)&&la(y,w,o,p))return!0;var o,p,y,w,P,k;return!1}function Lo(i,e){for(let r=0;r<i.length;++r)if(!Yn(i[r],e))return!1;for(let r=0;r<i.length-1;++r)if(ca(i[r],i[r+1],e))return!1;return!0}function ha(i,e){for(let r=0;r<e.length;r++)if(Lo(i,e[r]))return!0;return!1}function po(i,e,r){const o=[];for(let p=0;p<i.length;p++){const y=[];for(let w=0;w<i[p].length;w++){const P=vs(i[p][w],r);gr(e,P),y.push(P)}o.push(y)}return o}function zo(i,e,r){const o=[];for(let p=0;p<i.length;p++){const y=po(i[p],e,r);o.push(y)}return o}function ua(i,e,r,o){if(i[0]<r[0]||i[0]>r[2]){const p=.5*o;let y=i[0]-r[0]>p?-o:r[0]-i[0]>p?o:0;y===0&&(y=i[0]-r[2]>p?-o:r[2]-i[0]>p?o:0),i[0]+=y}gr(e,i)}function da(i,e,r,o){const p=Math.pow(2,o.z)*cr,y=[o.x*cr,o.y*cr],w=[];for(const P of i)for(const k of P){const F=[k.x+y[0],k.y+y[1]];ua(F,e,r,p),w.push(F)}return w}function Fo(i,e,r,o){const p=Math.pow(2,o.z)*cr,y=[o.x*cr,o.y*cr],w=[];for(const k of i){const F=[];for(const j of k){const N=[j.x+y[0],j.y+y[1]];gr(e,N),F.push(N)}w.push(F)}if(e[2]-e[0]<=p/2){(P=e)[0]=P[1]=1/0,P[2]=P[3]=-1/0;for(const k of w)for(const F of k)ua(F,e,r,p)}var P;return w}class T{constructor(e,r){this.type=xi,this.geojson=e,this.geometries=r}static parse(e,r){if(e.length!==2)return r.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(pt(e[1])){const o=e[1];if(o.type==="FeatureCollection")for(let p=0;p<o.features.length;++p){const y=o.features[p].geometry.type;if(y==="Polygon"||y==="MultiPolygon")return new T(o,o.features[p].geometry)}else if(o.type==="Feature"){const p=o.geometry.type;if(p==="Polygon"||p==="MultiPolygon")return new T(o,o.geometry)}else if(o.type==="Polygon"||o.type==="MultiPolygon")return new T(o,o)}return r.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(r,o){const p=[1/0,1/0,-1/0,-1/0],y=[1/0,1/0,-1/0,-1/0],w=r.canonicalID();if(o.type==="Polygon"){const P=po(o.coordinates,y,w),k=da(r.geometry(),p,y,w);if(!Kr(p,y))return!1;for(const F of k)if(!Yn(F,P))return!1}if(o.type==="MultiPolygon"){const P=zo(o.coordinates,y,w),k=da(r.geometry(),p,y,w);if(!Kr(p,y))return!1;for(const F of k)if(!fo(F,P))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(r,o){const p=[1/0,1/0,-1/0,-1/0],y=[1/0,1/0,-1/0,-1/0],w=r.canonicalID();if(o.type==="Polygon"){const P=po(o.coordinates,y,w),k=Fo(r.geometry(),p,y,w);if(!Kr(p,y))return!1;for(const F of k)if(!Lo(F,P))return!1}if(o.type==="MultiPolygon"){const P=zo(o.coordinates,y,w),k=Fo(r.geometry(),p,y,w);if(!Kr(p,y))return!1;for(const F of k)if(!ha(F,P))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}function z(i){if(i instanceof Ci&&(i.name==="get"&&i.args.length===1||i.name==="feature-state"||i.name==="has"&&i.args.length===1||i.name==="properties"||i.name==="geometry-type"||i.name==="id"||/^filter-/.test(i.name))||i instanceof T)return!1;let e=!0;return i.eachChild(r=>{e&&!z(r)&&(e=!1)}),e}function $(i){if(i instanceof Ci&&i.name==="feature-state")return!1;let e=!0;return i.eachChild(r=>{e&&!$(r)&&(e=!1)}),e}function ye(i,e){if(i instanceof Ci&&e.indexOf(i.name)>=0)return!1;let r=!0;return i.eachChild(o=>{r&&!ye(o,e)&&(r=!1)}),r}class Le{constructor(e,r){this.type=r.type,this.name=e,this.boundExpression=r}static parse(e,r){if(e.length!==2||typeof e[1]!="string")return r.error("'var' expression requires exactly one string literal argument.");const o=e[1];return r.scope.has(o)?new Le(o,r.scope.get(o)):r.error(`Unknown variable "${o}". Make sure "${o}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}}class Te{constructor(e,r=[],o,p=new fr,y=[]){this.registry=e,this.path=r,this.key=r.map(w=>`[${w}]`).join(""),this.scope=p,this.errors=y,this.expectedType=o}parse(e,r,o,p,y={}){return r?this.concat(r,o,p)._parse(e,y):this._parse(e,y)}_parse(e,r){function o(p,y,w){return w==="assert"?new gi(y,[p]):w==="coerce"?new vi(y,[p]):p}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const p=e[0];if(typeof p!="string")return this.error(`Expression name must be a string, but found ${typeof p} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const y=this.registry[p];if(y){let w=y.parse(e,this);if(!w)return null;if(this.expectedType){const P=this.expectedType,k=w.type;if(P.kind!=="string"&&P.kind!=="number"&&P.kind!=="boolean"&&P.kind!=="object"&&P.kind!=="array"||k.kind!=="value")if(P.kind!=="color"&&P.kind!=="formatted"&&P.kind!=="resolvedImage"||k.kind!=="value"&&k.kind!=="string")if(P.kind!=="padding"||k.kind!=="value"&&k.kind!=="number"&&k.kind!=="array"){if(this.checkSubtype(P,k))return null}else w=o(w,P,r.typeAnnotation||"coerce");else w=o(w,P,r.typeAnnotation||"coerce");else w=o(w,P,r.typeAnnotation||"assert")}if(!(w instanceof Jt)&&w.type.kind!=="resolvedImage"&&ke(w)){const P=new Bi;try{w=new Jt(w.type,w.evaluate(P))}catch(k){return this.error(k.message),null}}return w}return this.error(`Unknown expression "${p}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,r,o){const p=typeof e=="number"?this.path.concat(e):this.path,y=o?this.scope.concat(o):this.scope;return new Te(this.registry,p,r||null,y,this.errors)}error(e,...r){const o=`${this.key}${r.map(p=>`[${p}]`).join("")}`;this.errors.push(new dr(o,e))}checkSubtype(e,r){const o=Zr(e,r);return o&&this.error(o),o}}function ke(i){if(i instanceof Le)return ke(i.boundExpression);if(i instanceof Ci&&i.name==="error"||i instanceof Ir||i instanceof T)return!1;const e=i instanceof vi||i instanceof gi;let r=!0;return i.eachChild(o=>{r=e?r&&ke(o):r&&o instanceof Jt}),!!r&&z(i)&&ye(i,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function wt(i,e){const r=i.length-1;let o,p,y=0,w=r,P=0;for(;y<=w;)if(P=Math.floor((y+w)/2),o=i[P],p=i[P+1],o<=e){if(P===r||e<p)return P;y=P+1}else{if(!(o>e))throw new Pt("Input is not a number.");w=P-1}return 0}class xt{constructor(e,r,o){this.type=e,this.input=r,this.labels=[],this.outputs=[];for(const[p,y]of o)this.labels.push(p),this.outputs.push(y)}static parse(e,r){if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");const o=r.parse(e[1],1,st);if(!o)return null;const p=[];let y=null;r.expectedType&&r.expectedType.kind!=="value"&&(y=r.expectedType);for(let w=1;w<e.length;w+=2){const P=w===1?-1/0:e[w],k=e[w+1],F=w,j=w+1;if(typeof P!="number")return r.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',F);if(p.length&&p[p.length-1][0]>=P)return r.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',F);const N=r.parse(k,j,y);if(!N)return null;y=y||N.type,p.push([P,N])}return new xt(y,o,p)}evaluate(e){const r=this.labels,o=this.outputs;if(r.length===1)return o[0].evaluate(e);const p=this.input.evaluate(e);if(p<=r[0])return o[0].evaluate(e);const y=r.length;return p>=r[y-1]?o[y-1].evaluate(e):o[wt(r,p)].evaluate(e)}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}}function Ct(i,e,r){return i*(1-r)+e*r}var Re=Object.freeze({__proto__:null,number:Ct,color:function(i,e,r){return new te(Ct(i.r,e.r,r),Ct(i.g,e.g,r),Ct(i.b,e.b,r),Ct(i.a,e.a,r))},array:function(i,e,r){return i.map((o,p)=>Ct(o,e[p],r))},padding:function(i,e,r){const o=i.values,p=e.values;return new pe([Ct(o[0],p[0],r),Ct(o[1],p[1],r),Ct(o[2],p[2],r),Ct(o[3],p[3],r)])}});const Mt=.95047,Nt=1.08883,li=4/29,_i=6/29,Cr=3*_i*_i,dt=Math.PI/180,Zt=180/Math.PI;function qi(i){return i>.008856451679035631?Math.pow(i,1/3):i/Cr+li}function $i(i){return i>_i?i*i*i:Cr*(i-li)}function hr(i){return 255*(i<=.0031308?12.92*i:1.055*Math.pow(i,1/2.4)-.055)}function ci(i){return(i/=255)<=.04045?i/12.92:Math.pow((i+.055)/1.055,2.4)}function Ai(i){const e=ci(i.r),r=ci(i.g),o=ci(i.b),p=qi((.4124564*e+.3575761*r+.1804375*o)/Mt),y=qi((.2126729*e+.7151522*r+.072175*o)/1);return{l:116*y-16,a:500*(p-y),b:200*(y-qi((.0193339*e+.119192*r+.9503041*o)/Nt)),alpha:i.a}}function Hn(i){let e=(i.l+16)/116,r=isNaN(i.a)?e:e+i.a/500,o=isNaN(i.b)?e:e-i.b/200;return e=1*$i(e),r=Mt*$i(r),o=Nt*$i(o),new te(hr(3.2404542*r-1.5371385*e-.4985314*o),hr(-.969266*r+1.8760108*e+.041556*o),hr(.0556434*r-.2040259*e+1.0572252*o),i.alpha)}function Wi(i,e,r){const o=e-i;return i+r*(o>180||o<-180?o-360*Math.round(o/360):o)}const Jr={forward:Ai,reverse:Hn,interpolate:function(i,e,r){return{l:Ct(i.l,e.l,r),a:Ct(i.a,e.a,r),b:Ct(i.b,e.b,r),alpha:Ct(i.alpha,e.alpha,r)}}},Or={forward:function(i){const{l:e,a:r,b:o}=Ai(i),p=Math.atan2(o,r)*Zt;return{h:p<0?p+360:p,c:Math.sqrt(r*r+o*o),l:e,alpha:i.a}},reverse:function(i){const e=i.h*dt,r=i.c;return Hn({l:i.l,a:Math.cos(e)*r,b:Math.sin(e)*r,alpha:i.alpha})},interpolate:function(i,e,r){return{h:Wi(i.h,e.h,r),c:Ct(i.c,e.c,r),l:Ct(i.l,e.l,r),alpha:Ct(i.alpha,e.alpha,r)}}};var mo=Object.freeze({__proto__:null,lab:Jr,hcl:Or});class rn{constructor(e,r,o,p,y){this.type=e,this.operator=r,this.interpolation=o,this.input=p,this.labels=[],this.outputs=[];for(const[w,P]of y)this.labels.push(w),this.outputs.push(P)}static interpolationFactor(e,r,o,p){let y=0;if(e.name==="exponential")y=yn(r,e.base,o,p);else if(e.name==="linear")y=yn(r,1,o,p);else if(e.name==="cubic-bezier"){const w=e.controlPoints;y=new g(w[0],w[1],w[2],w[3]).solve(yn(r,1,o,p))}return y}static parse(e,r){let[o,p,y,...w]=e;if(!Array.isArray(p)||p.length===0)return r.error("Expected an interpolation type expression.",1);if(p[0]==="linear")p={name:"linear"};else if(p[0]==="exponential"){const F=p[1];if(typeof F!="number")return r.error("Exponential interpolation requires a numeric base.",1,1);p={name:"exponential",base:F}}else{if(p[0]!=="cubic-bezier")return r.error(`Unknown interpolation type ${String(p[0])}`,1,0);{const F=p.slice(1);if(F.length!==4||F.some(j=>typeof j!="number"||j<0||j>1))return r.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);p={name:"cubic-bezier",controlPoints:F}}}if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");if(y=r.parse(y,2,st),!y)return null;const P=[];let k=null;o==="interpolate-hcl"||o==="interpolate-lab"?k=br:r.expectedType&&r.expectedType.kind!=="value"&&(k=r.expectedType);for(let F=0;F<w.length;F+=2){const j=w[F],N=w[F+1],W=F+3,Z=F+4;if(typeof j!="number")return r.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',W);if(P.length&&P[P.length-1][0]>=j)return r.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',W);const K=r.parse(N,Z,k);if(!K)return null;k=k||K.type,P.push([j,K])}return k.kind==="number"||k.kind==="color"||k.kind==="padding"||k.kind==="array"&&k.itemType.kind==="number"&&typeof k.N=="number"?new rn(k,o,p,y,P):r.error(`Type ${Xi(k)} is not interpolatable.`)}evaluate(e){const r=this.labels,o=this.outputs;if(r.length===1)return o[0].evaluate(e);const p=this.input.evaluate(e);if(p<=r[0])return o[0].evaluate(e);const y=r.length;if(p>=r[y-1])return o[y-1].evaluate(e);const w=wt(r,p),P=rn.interpolationFactor(this.interpolation,p,r[w],r[w+1]),k=o[w].evaluate(e),F=o[w+1].evaluate(e);return this.operator==="interpolate"?Re[this.type.kind.toLowerCase()](k,F,P):this.operator==="interpolate-hcl"?Or.reverse(Or.interpolate(Or.forward(k),Or.forward(F),P)):Jr.reverse(Jr.interpolate(Jr.forward(k),Jr.forward(F),P))}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}}function yn(i,e,r,o){const p=o-r,y=i-r;return p===0?0:e===1?y/p:(Math.pow(e,y)-1)/(Math.pow(e,p)-1)}class $s{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expectected at least one argument.");let o=null;const p=r.expectedType;p&&p.kind!=="value"&&(o=p);const y=[];for(const P of e.slice(1)){const k=r.parse(P,1+y.length,o,void 0,{typeAnnotation:"omit"});if(!k)return null;o=o||k.type,y.push(k)}if(!o)throw new Error("No output type");const w=p&&y.some(P=>Zr(p,P.type));return new $s(w?yi:o,y)}evaluate(e){let r,o=null,p=0;for(const y of this.args)if(p++,o=y.evaluate(e),o&&o instanceof Se&&!o.available&&(r||(r=o.name),o=null,p===this.args.length&&(o=r)),o!==null)break;return o}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}}class qs{constructor(e,r){this.type=r.type,this.bindings=[].concat(e),this.result=r}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const r of this.bindings)e(r[1]);e(this.result)}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const o=[];for(let y=1;y<e.length-1;y+=2){const w=e[y];if(typeof w!="string")return r.error(`Expected string, but found ${typeof w} instead.`,y);if(/[^a-zA-Z0-9_]/.test(w))return r.error("Variable names must contain only alphanumeric characters or '_'.",y);const P=r.parse(e[y+1],y+1);if(!P)return null;o.push([w,P])}const p=r.parse(e[e.length-1],e.length-1,r.expectedType,o);return p?new qs(o,p):null}outputDefined(){return this.result.outputDefined()}}class Ro{constructor(e,r,o){this.type=e,this.index=r,this.input=o}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=r.parse(e[1],1,st),p=r.parse(e[2],2,Dr(r.expectedType||yi));return o&&p?new Ro(p.type.itemType,o,p):null}evaluate(e){const r=this.index.evaluate(e),o=this.input.evaluate(e);if(r<0)throw new Pt(`Array index out of bounds: ${r} < 0.`);if(r>=o.length)throw new Pt(`Array index out of bounds: ${r} > ${o.length-1}.`);if(r!==Math.floor(r))throw new Pt(`Array index must be an integer, but found ${r} instead.`);return o[r]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}}class go{constructor(e,r){this.type=xi,this.needle=e,this.haystack=r}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=r.parse(e[1],1,yi),p=r.parse(e[2],2,yi);return o&&p?ls(o.type,[xi,bi,st,Ki,yi])?new go(o,p):r.error(`Expected first argument to be of type boolean, string, number or null, but found ${Xi(o.type)} instead`):null}evaluate(e){const r=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(!o)return!1;if(!Wn(r,["boolean","string","number","null"]))throw new Pt(`Expected first argument to be of type boolean, string, number or null, but found ${Xi(qe(r))} instead.`);if(!Wn(o,["string","array"]))throw new Pt(`Expected second argument to be of type array or string, but found ${Xi(qe(o))} instead.`);return o.indexOf(r)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}}class xs{constructor(e,r,o){this.type=st,this.needle=e,this.haystack=r,this.fromIndex=o}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=r.parse(e[1],1,yi),p=r.parse(e[2],2,yi);if(!o||!p)return null;if(!ls(o.type,[xi,bi,st,Ki,yi]))return r.error(`Expected first argument to be of type boolean, string, number or null, but found ${Xi(o.type)} instead`);if(e.length===4){const y=r.parse(e[3],3,st);return y?new xs(o,p,y):null}return new xs(o,p)}evaluate(e){const r=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(!Wn(r,["boolean","string","number","null"]))throw new Pt(`Expected first argument to be of type boolean, string, number or null, but found ${Xi(qe(r))} instead.`);if(!Wn(o,["string","array"]))throw new Pt(`Expected second argument to be of type array or string, but found ${Xi(qe(o))} instead.`);if(this.fromIndex){const p=this.fromIndex.evaluate(e);return o.indexOf(r,p)}return o.indexOf(r)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}}class _o{constructor(e,r,o,p,y,w){this.inputType=e,this.type=r,this.input=o,this.cases=p,this.outputs=y,this.otherwise=w}static parse(e,r){if(e.length<5)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return r.error("Expected an even number of arguments.");let o,p;r.expectedType&&r.expectedType.kind!=="value"&&(p=r.expectedType);const y={},w=[];for(let F=2;F<e.length-1;F+=2){let j=e[F];const N=e[F+1];Array.isArray(j)||(j=[j]);const W=r.concat(F);if(j.length===0)return W.error("Expected at least one branch label.");for(const K of j){if(typeof K!="number"&&typeof K!="string")return W.error("Branch labels must be numbers or strings.");if(typeof K=="number"&&Math.abs(K)>Number.MAX_SAFE_INTEGER)return W.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof K=="number"&&Math.floor(K)!==K)return W.error("Numeric branch labels must be integer values.");if(o){if(W.checkSubtype(o,qe(K)))return null}else o=qe(K);if(y[String(K)]!==void 0)return W.error("Branch labels must be unique.");y[String(K)]=w.length}const Z=r.parse(N,F,p);if(!Z)return null;p=p||Z.type,w.push(Z)}const P=r.parse(e[1],1,yi);if(!P)return null;const k=r.parse(e[e.length-1],e.length-1,p);return k?P.type.kind!=="value"&&r.concat(1).checkSubtype(o,P.type)?null:new _o(o,p,P,y,w,k):null}evaluate(e){const r=this.input.evaluate(e);return(qe(r)===this.inputType&&this.outputs[this.cases[r]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}}class yo{constructor(e,r,o){this.type=e,this.branches=r,this.otherwise=o}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return r.error("Expected an odd number of arguments.");let o;r.expectedType&&r.expectedType.kind!=="value"&&(o=r.expectedType);const p=[];for(let w=1;w<e.length-1;w+=2){const P=r.parse(e[w],w,xi);if(!P)return null;const k=r.parse(e[w+1],w+1,o);if(!k)return null;p.push([P,k]),o=o||k.type}const y=r.parse(e[e.length-1],e.length-1,o);if(!y)return null;if(!o)throw new Error("Can't infer output type");return new yo(o,p,y)}evaluate(e){for(const[r,o]of this.branches)if(r.evaluate(e))return o.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[r,o]of this.branches)e(r),e(o);e(this.otherwise)}outputDefined(){return this.branches.every(([e,r])=>r.outputDefined())&&this.otherwise.outputDefined()}}class vo{constructor(e,r,o,p){this.type=e,this.input=r,this.beginIndex=o,this.endIndex=p}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=r.parse(e[1],1,yi),p=r.parse(e[2],2,st);if(!o||!p)return null;if(!ls(o.type,[Dr(yi),bi,yi]))return r.error(`Expected first argument to be of type array or string, but found ${Xi(o.type)} instead`);if(e.length===4){const y=r.parse(e[3],3,st);return y?new vo(o.type,o,p,y):null}return new vo(o.type,o,p)}evaluate(e){const r=this.input.evaluate(e),o=this.beginIndex.evaluate(e);if(!Wn(r,["string","array"]))throw new Pt(`Expected first argument to be of type array or string, but found ${Xi(qe(r))} instead.`);if(this.endIndex){const p=this.endIndex.evaluate(e);return r.slice(o,p)}return r.slice(o)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}}function cs(i,e){return i==="=="||i==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Bo(i,e,r,o){return o.compare(e,r)===0}function As(i,e,r){const o=i!=="=="&&i!=="!=";return class Eu{constructor(y,w,P){this.type=xi,this.lhs=y,this.rhs=w,this.collator=P,this.hasUntypedArgument=y.type.kind==="value"||w.type.kind==="value"}static parse(y,w){if(y.length!==3&&y.length!==4)return w.error("Expected two or three arguments.");const P=y[0];let k=w.parse(y[1],1,yi);if(!k)return null;if(!cs(P,k.type))return w.concat(1).error(`"${P}" comparisons are not supported for type '${Xi(k.type)}'.`);let F=w.parse(y[2],2,yi);if(!F)return null;if(!cs(P,F.type))return w.concat(2).error(`"${P}" comparisons are not supported for type '${Xi(F.type)}'.`);if(k.type.kind!==F.type.kind&&k.type.kind!=="value"&&F.type.kind!=="value")return w.error(`Cannot compare types '${Xi(k.type)}' and '${Xi(F.type)}'.`);o&&(k.type.kind==="value"&&F.type.kind!=="value"?k=new gi(F.type,[k]):k.type.kind!=="value"&&F.type.kind==="value"&&(F=new gi(k.type,[F])));let j=null;if(y.length===4){if(k.type.kind!=="string"&&F.type.kind!=="string"&&k.type.kind!=="value"&&F.type.kind!=="value")return w.error("Cannot use collator to compare non-string types.");if(j=w.parse(y[3],3,Oi),!j)return null}return new Eu(k,F,j)}evaluate(y){const w=this.lhs.evaluate(y),P=this.rhs.evaluate(y);if(o&&this.hasUntypedArgument){const k=qe(w),F=qe(P);if(k.kind!==F.kind||k.kind!=="string"&&k.kind!=="number")throw new Pt(`Expected arguments for "${i}" to be (string, string) or (number, number), but found (${k.kind}, ${F.kind}) instead.`)}if(this.collator&&!o&&this.hasUntypedArgument){const k=qe(w),F=qe(P);if(k.kind!=="string"||F.kind!=="string")return e(y,w,P)}return this.collator?r(y,w,P,this.collator.evaluate(y)):e(y,w,P)}eachChild(y){y(this.lhs),y(this.rhs),this.collator&&y(this.collator)}outputDefined(){return!0}}}const Ma=As("==",function(i,e,r){return e===r},Bo),Uo=As("!=",function(i,e,r){return e!==r},function(i,e,r,o){return!Bo(0,e,r,o)}),Ys=As("<",function(i,e,r){return e<r},function(i,e,r,o){return o.compare(e,r)<0}),jo=As(">",function(i,e,r){return e>r},function(i,e,r,o){return o.compare(e,r)>0}),Vo=As("<=",function(i,e,r){return e<=r},function(i,e,r,o){return o.compare(e,r)<=0}),No=As(">=",function(i,e,r){return e>=r},function(i,e,r,o){return o.compare(e,r)>=0});class bs{constructor(e,r,o,p,y){this.type=bi,this.number=e,this.locale=r,this.currency=o,this.minFractionDigits=p,this.maxFractionDigits=y}static parse(e,r){if(e.length!==3)return r.error("Expected two arguments.");const o=r.parse(e[1],1,st);if(!o)return null;const p=e[2];if(typeof p!="object"||Array.isArray(p))return r.error("NumberFormat options argument must be an object.");let y=null;if(p.locale&&(y=r.parse(p.locale,1,bi),!y))return null;let w=null;if(p.currency&&(w=r.parse(p.currency,1,bi),!w))return null;let P=null;if(p["min-fraction-digits"]&&(P=r.parse(p["min-fraction-digits"],1,st),!P))return null;let k=null;return p["max-fraction-digits"]&&(k=r.parse(p["max-fraction-digits"],1,st),!k)?null:new bs(o,y,w,P,k)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}}class xo{constructor(e){this.type=wr,this.sections=e}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const o=e[1];if(!Array.isArray(o)&&typeof o=="object")return r.error("First argument must be an image or text section.");const p=[];let y=!1;for(let w=1;w<=e.length-1;++w){const P=e[w];if(y&&typeof P=="object"&&!Array.isArray(P)){y=!1;let k=null;if(P["font-scale"]&&(k=r.parse(P["font-scale"],1,st),!k))return null;let F=null;if(P["text-font"]&&(F=r.parse(P["text-font"],1,Dr(bi)),!F))return null;let j=null;if(P["text-color"]&&(j=r.parse(P["text-color"],1,br),!j))return null;const N=p[p.length-1];N.scale=k,N.font=F,N.textColor=j}else{const k=r.parse(e[w],1,yi);if(!k)return null;const F=k.type.kind;if(F!=="string"&&F!=="value"&&F!=="null"&&F!=="resolvedImage")return r.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");y=!0,p.push({content:k,scale:null,font:null,textColor:null})}}return new xo(p)}evaluate(e){return new _e(this.sections.map(r=>{const o=r.content.evaluate(e);return qe(o)===lr?new we("",o,null,null,null):new we(Ht(o),null,r.scale?r.scale.evaluate(e):null,r.font?r.font.evaluate(e).join(","):null,r.textColor?r.textColor.evaluate(e):null)}))}eachChild(e){for(const r of this.sections)e(r.content),r.scale&&e(r.scale),r.font&&e(r.font),r.textColor&&e(r.textColor)}outputDefined(){return!1}}class Go{constructor(e){this.type=lr,this.input=e}static parse(e,r){if(e.length!==2)return r.error("Expected two arguments.");const o=r.parse(e[1],1,bi);return o?new Go(o):r.error("No image name provided.")}evaluate(e){const r=this.input.evaluate(e),o=Se.fromString(r);return o&&e.availableImages&&(o.available=e.availableImages.indexOf(r)>-1),o}eachChild(e){e(this.input)}outputDefined(){return!1}}class Xo{constructor(e){this.type=st,this.input=e}static parse(e,r){if(e.length!==2)return r.error(`Expected 1 argument, but found ${e.length-1} instead.`);const o=r.parse(e[1],1);return o?o.type.kind!=="array"&&o.type.kind!=="string"&&o.type.kind!=="value"?r.error(`Expected argument of type string or array, but found ${Xi(o.type)} instead.`):new Xo(o):null}evaluate(e){const r=this.input.evaluate(e);if(typeof r=="string"||Array.isArray(r))return r.length;throw new Pt(`Expected value to be of type string or array, but found ${Xi(qe(r))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}}const Ms={"==":Ma,"!=":Uo,">":jo,"<":Ys,">=":No,"<=":Vo,array:gi,at:Ro,boolean:gi,case:yo,coalesce:$s,collator:Ir,format:xo,image:Go,in:go,"index-of":xs,interpolate:rn,"interpolate-hcl":rn,"interpolate-lab":rn,length:Xo,let:qs,literal:Jt,match:_o,number:gi,"number-format":bs,object:gi,slice:vo,step:xt,string:gi,"to-boolean":vi,"to-color":vi,"to-number":vi,"to-string":vi,var:Le,within:T};function fa(i,[e,r,o,p]){e=e.evaluate(i),r=r.evaluate(i),o=o.evaluate(i);const y=p?p.evaluate(i):1,w=Ye(e,r,o,y);if(w)throw new Pt(w);return new te(e/255*y,r/255*y,o/255*y,y)}function Wo(i,e){return i in e}function ks(i,e){const r=e[i];return r===void 0?null:r}function dn(i){return{type:i}}function zn(i){return{result:"success",value:i}}function vn(i){return{result:"error",value:i}}function Ji(i){return i["property-type"]==="data-driven"||i["property-type"]==="cross-faded-data-driven"}function Zn(i){return!!i.expression&&i.expression.parameters.indexOf("zoom")>-1}function Mi(i){return!!i.expression&&i.expression.interpolated}function Ui(i){return i instanceof Number?"number":i instanceof String?"string":i instanceof Boolean?"boolean":Array.isArray(i)?"array":i===null?"null":typeof i}function Yi(i){return typeof i=="object"&&i!==null&&!Array.isArray(i)}function ar(i){return i}function Ds(i,e){const r=e.type==="color",o=i.stops&&typeof i.stops[0][0]=="object",p=o||!(o||i.property!==void 0),y=i.type||(Mi(e)?"exponential":"interval");if(r||e.type==="padding"){const F=r?te.parse:pe.parse;(i=Zi({},i)).stops&&(i.stops=i.stops.map(j=>[j[0],F(j[1])])),i.default=F(i.default?i.default:e.default)}if(i.colorSpace&&i.colorSpace!=="rgb"&&!mo[i.colorSpace])throw new Error(`Unknown color space: ${i.colorSpace}`);let w,P,k;if(y==="exponential")w=$o;else if(y==="interval")w=pa;else if(y==="categorical"){w=ka,P=Object.create(null);for(const F of i.stops)P[F[0]]=F[1];k=typeof i.stops[0][0]}else{if(y!=="identity")throw new Error(`Unknown function type "${y}"`);w=bo}if(o){const F={},j=[];for(let Z=0;Z<i.stops.length;Z++){const K=i.stops[Z],me=K[0].zoom;F[me]===void 0&&(F[me]={zoom:me,type:i.type,property:i.property,default:i.default,stops:[]},j.push(me)),F[me].stops.push([K[0].value,K[1]])}const N=[];for(const Z of j)N.push([F[Z].zoom,Ds(F[Z],e)]);const W={name:"linear"};return{kind:"composite",interpolationType:W,interpolationFactor:rn.interpolationFactor.bind(void 0,W),zoomStops:N.map(Z=>Z[0]),evaluate:({zoom:Z},K)=>$o({stops:N,base:i.base},e,Z).evaluate(Z,K)}}if(p){const F=y==="exponential"?{name:"exponential",base:i.base!==void 0?i.base:1}:null;return{kind:"camera",interpolationType:F,interpolationFactor:rn.interpolationFactor.bind(void 0,F),zoomStops:i.stops.map(j=>j[0]),evaluate:({zoom:j})=>w(i,e,j,P,k)}}return{kind:"source",evaluate(F,j){const N=j&&j.properties?j.properties[i.property]:void 0;return N===void 0?Os(i.default,e.default):w(i,e,N,P,k)}}}function Os(i,e,r){return i!==void 0?i:e!==void 0?e:r!==void 0?r:void 0}function ka(i,e,r,o,p){return Os(typeof r===p?o[r]:void 0,i.default,e.default)}function pa(i,e,r){if(Ui(r)!=="number")return Os(i.default,e.default);const o=i.stops.length;if(o===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[o-1][0])return i.stops[o-1][1];const p=wt(i.stops.map(y=>y[0]),r);return i.stops[p][1]}function $o(i,e,r){const o=i.base!==void 0?i.base:1;if(Ui(r)!=="number")return Os(i.default,e.default);const p=i.stops.length;if(p===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[p-1][0])return i.stops[p-1][1];const y=wt(i.stops.map(j=>j[0]),r),w=function(j,N,W,Z){const K=Z-W,me=j-W;return K===0?0:N===1?me/K:(Math.pow(N,me)-1)/(Math.pow(N,K)-1)}(r,o,i.stops[y][0],i.stops[y+1][0]),P=i.stops[y][1],k=i.stops[y+1][1];let F=Re[e.type]||ar;if(i.colorSpace&&i.colorSpace!=="rgb"){const j=mo[i.colorSpace];F=(N,W)=>j.reverse(j.interpolate(j.forward(N),j.forward(W),w))}return typeof P.evaluate=="function"?{evaluate(...j){const N=P.evaluate.apply(void 0,j),W=k.evaluate.apply(void 0,j);if(N!==void 0&&W!==void 0)return F(N,W,w)}}:F(P,k,w)}function bo(i,e,r){switch(e.type){case"color":r=te.parse(r);break;case"formatted":r=_e.fromString(r.toString());break;case"resolvedImage":r=Se.fromString(r.toString());break;case"padding":r=pe.parse(r);break;default:Ui(r)===e.type||e.type==="enum"&&e.values[r]||(r=void 0)}return Os(r,i.default,e.default)}Ci.register(Ms,{error:[{kind:"error"},[bi],(i,[e])=>{throw new Pt(e.evaluate(i))}],typeof:[bi,[yi],(i,[e])=>Xi(qe(e.evaluate(i)))],"to-rgba":[Dr(st,4),[br],(i,[e])=>e.evaluate(i).toArray()],rgb:[br,[st,st,st],fa],rgba:[br,[st,st,st,st],fa],has:{type:xi,overloads:[[[bi],(i,[e])=>Wo(e.evaluate(i),i.properties())],[[bi,tn],(i,[e,r])=>Wo(e.evaluate(i),r.evaluate(i))]]},get:{type:yi,overloads:[[[bi],(i,[e])=>ks(e.evaluate(i),i.properties())],[[bi,tn],(i,[e,r])=>ks(e.evaluate(i),r.evaluate(i))]]},"feature-state":[yi,[bi],(i,[e])=>ks(e.evaluate(i),i.featureState||{})],properties:[tn,[],i=>i.properties()],"geometry-type":[bi,[],i=>i.geometryType()],id:[yi,[],i=>i.id()],zoom:[st,[],i=>i.globals.zoom],"heatmap-density":[st,[],i=>i.globals.heatmapDensity||0],"line-progress":[st,[],i=>i.globals.lineProgress||0],accumulated:[yi,[],i=>i.globals.accumulated===void 0?null:i.globals.accumulated],"+":[st,dn(st),(i,e)=>{let r=0;for(const o of e)r+=o.evaluate(i);return r}],"*":[st,dn(st),(i,e)=>{let r=1;for(const o of e)r*=o.evaluate(i);return r}],"-":{type:st,overloads:[[[st,st],(i,[e,r])=>e.evaluate(i)-r.evaluate(i)],[[st],(i,[e])=>-e.evaluate(i)]]},"/":[st,[st,st],(i,[e,r])=>e.evaluate(i)/r.evaluate(i)],"%":[st,[st,st],(i,[e,r])=>e.evaluate(i)%r.evaluate(i)],ln2:[st,[],()=>Math.LN2],pi:[st,[],()=>Math.PI],e:[st,[],()=>Math.E],"^":[st,[st,st],(i,[e,r])=>Math.pow(e.evaluate(i),r.evaluate(i))],sqrt:[st,[st],(i,[e])=>Math.sqrt(e.evaluate(i))],log10:[st,[st],(i,[e])=>Math.log(e.evaluate(i))/Math.LN10],ln:[st,[st],(i,[e])=>Math.log(e.evaluate(i))],log2:[st,[st],(i,[e])=>Math.log(e.evaluate(i))/Math.LN2],sin:[st,[st],(i,[e])=>Math.sin(e.evaluate(i))],cos:[st,[st],(i,[e])=>Math.cos(e.evaluate(i))],tan:[st,[st],(i,[e])=>Math.tan(e.evaluate(i))],asin:[st,[st],(i,[e])=>Math.asin(e.evaluate(i))],acos:[st,[st],(i,[e])=>Math.acos(e.evaluate(i))],atan:[st,[st],(i,[e])=>Math.atan(e.evaluate(i))],min:[st,dn(st),(i,e)=>Math.min(...e.map(r=>r.evaluate(i)))],max:[st,dn(st),(i,e)=>Math.max(...e.map(r=>r.evaluate(i)))],abs:[st,[st],(i,[e])=>Math.abs(e.evaluate(i))],round:[st,[st],(i,[e])=>{const r=e.evaluate(i);return r<0?-Math.round(-r):Math.round(r)}],floor:[st,[st],(i,[e])=>Math.floor(e.evaluate(i))],ceil:[st,[st],(i,[e])=>Math.ceil(e.evaluate(i))],"filter-==":[xi,[bi,yi],(i,[e,r])=>i.properties()[e.value]===r.value],"filter-id-==":[xi,[yi],(i,[e])=>i.id()===e.value],"filter-type-==":[xi,[bi],(i,[e])=>i.geometryType()===e.value],"filter-<":[xi,[bi,yi],(i,[e,r])=>{const o=i.properties()[e.value],p=r.value;return typeof o==typeof p&&o<p}],"filter-id-<":[xi,[yi],(i,[e])=>{const r=i.id(),o=e.value;return typeof r==typeof o&&r<o}],"filter->":[xi,[bi,yi],(i,[e,r])=>{const o=i.properties()[e.value],p=r.value;return typeof o==typeof p&&o>p}],"filter-id->":[xi,[yi],(i,[e])=>{const r=i.id(),o=e.value;return typeof r==typeof o&&r>o}],"filter-<=":[xi,[bi,yi],(i,[e,r])=>{const o=i.properties()[e.value],p=r.value;return typeof o==typeof p&&o<=p}],"filter-id-<=":[xi,[yi],(i,[e])=>{const r=i.id(),o=e.value;return typeof r==typeof o&&r<=o}],"filter->=":[xi,[bi,yi],(i,[e,r])=>{const o=i.properties()[e.value],p=r.value;return typeof o==typeof p&&o>=p}],"filter-id->=":[xi,[yi],(i,[e])=>{const r=i.id(),o=e.value;return typeof r==typeof o&&r>=o}],"filter-has":[xi,[yi],(i,[e])=>e.value in i.properties()],"filter-has-id":[xi,[],i=>i.id()!==null&&i.id()!==void 0],"filter-type-in":[xi,[Dr(bi)],(i,[e])=>e.value.indexOf(i.geometryType())>=0],"filter-id-in":[xi,[Dr(yi)],(i,[e])=>e.value.indexOf(i.id())>=0],"filter-in-small":[xi,[bi,Dr(yi)],(i,[e,r])=>r.value.indexOf(i.properties()[e.value])>=0],"filter-in-large":[xi,[bi,Dr(yi)],(i,[e,r])=>function(o,p,y,w){for(;y<=w;){const P=y+w>>1;if(p[P]===o)return!0;p[P]>o?w=P-1:y=P+1}return!1}(i.properties()[e.value],r.value,0,r.value.length-1)],all:{type:xi,overloads:[[[xi,xi],(i,[e,r])=>e.evaluate(i)&&r.evaluate(i)],[dn(xi),(i,e)=>{for(const r of e)if(!r.evaluate(i))return!1;return!0}]]},any:{type:xi,overloads:[[[xi,xi],(i,[e,r])=>e.evaluate(i)||r.evaluate(i)],[dn(xi),(i,e)=>{for(const r of e)if(r.evaluate(i))return!0;return!1}]]},"!":[xi,[xi],(i,[e])=>!e.evaluate(i)],"is-supported-script":[xi,[bi],(i,[e])=>{const r=i.globals&&i.globals.isSupportedScript;return!r||r(e.evaluate(i))}],upcase:[bi,[bi],(i,[e])=>e.evaluate(i).toUpperCase()],downcase:[bi,[bi],(i,[e])=>e.evaluate(i).toLowerCase()],concat:[bi,dn(yi),(i,e)=>e.map(r=>Ht(r.evaluate(i))).join("")],"resolved-locale":[bi,[Oi],(i,[e])=>e.evaluate(i).resolvedLocale()]});class Kn{constructor(e,r){this.expression=e,this._warningHistory={},this._evaluator=new Bi,this._defaultValue=r?function(o){return o.type==="color"&&Yi(o.default)?new te(0,0,0,0):o.type==="color"?te.parse(o.default)||null:o.type==="padding"?pe.parse(o.default)||null:o.default===void 0?null:o.default}(r):null,this._enumValues=r&&r.type==="enum"?r.values:null}evaluateWithoutErrorHandling(e,r,o,p,y,w){return this._evaluator.globals=e,this._evaluator.feature=r,this._evaluator.featureState=o,this._evaluator.canonical=p,this._evaluator.availableImages=y||null,this._evaluator.formattedSection=w,this.expression.evaluate(this._evaluator)}evaluate(e,r,o,p,y,w){this._evaluator.globals=e,this._evaluator.feature=r||null,this._evaluator.featureState=o||null,this._evaluator.canonical=p,this._evaluator.availableImages=y||null,this._evaluator.formattedSection=w||null;try{const P=this.expression.evaluate(this._evaluator);if(P==null||typeof P=="number"&&P!=P)return this._defaultValue;if(this._enumValues&&!(P in this._enumValues))throw new Pt(`Expected value to be one of ${Object.keys(this._enumValues).map(k=>JSON.stringify(k)).join(", ")}, but found ${JSON.stringify(P)} instead.`);return P}catch(P){return this._warningHistory[P.message]||(this._warningHistory[P.message]=!0,typeof console<"u"&&console.warn(P.message)),this._defaultValue}}}function Hs(i){return Array.isArray(i)&&i.length>0&&typeof i[0]=="string"&&i[0]in Ms}function xn(i,e){const r=new Te(Ms,[],e?function(p){const y={color:br,string:bi,number:st,enum:bi,boolean:xi,formatted:wr,padding:Vr,resolvedImage:lr};return p.type==="array"?Dr(y[p.value]||yi,p.length):y[p.type]}(e):void 0),o=r.parse(i,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return o?zn(new Kn(o,e)):vn(r.errors)}class Zs{constructor(e,r){this.kind=e,this._styleExpression=r,this.isStateDependent=e!=="constant"&&!$(r.expression)}evaluateWithoutErrorHandling(e,r,o,p,y,w){return this._styleExpression.evaluateWithoutErrorHandling(e,r,o,p,y,w)}evaluate(e,r,o,p,y,w){return this._styleExpression.evaluate(e,r,o,p,y,w)}}class Jn{constructor(e,r,o,p){this.kind=e,this.zoomStops=o,this._styleExpression=r,this.isStateDependent=e!=="camera"&&!$(r.expression),this.interpolationType=p}evaluateWithoutErrorHandling(e,r,o,p,y,w){return this._styleExpression.evaluateWithoutErrorHandling(e,r,o,p,y,w)}evaluate(e,r,o,p,y,w){return this._styleExpression.evaluate(e,r,o,p,y,w)}interpolationFactor(e,r,o){return this.interpolationType?rn.interpolationFactor(this.interpolationType,e,r,o):0}}function qo(i,e){const r=xn(i,e);if(r.result==="error")return r;const o=r.value.expression,p=z(o);if(!p&&!Ji(e))return vn([new dr("","data expressions not supported")]);const y=ye(o,["zoom"]);if(!y&&!Zn(e))return vn([new dr("","zoom expressions not supported")]);const w=ws(o);return w||y?w instanceof dr?vn([w]):w instanceof rn&&!Mi(e)?vn([new dr("",'"interpolate" expressions cannot be used with this property')]):zn(w?new Jn(p?"camera":"composite",r.value,w.labels,w instanceof rn?w.interpolation:void 0):new Zs(p?"constant":"source",r.value)):vn([new dr("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class wo{constructor(e,r){this._parameters=e,this._specification=r,Zi(this,Ds(this._parameters,this._specification))}static deserialize(e){return new wo(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function ws(i){let e=null;if(i instanceof qs)e=ws(i.result);else if(i instanceof $s){for(const r of i.args)if(e=ws(r),e)break}else(i instanceof xt||i instanceof rn)&&i.input instanceof Ci&&i.input.name==="zoom"&&(e=i);return e instanceof dr||i.eachChild(r=>{const o=ws(r);o instanceof dr?e=o:!e&&o?e=new dr("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&o&&e!==o&&(e=new dr("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}function fn(i){const e=i.key,r=i.value,o=i.valueSpec||{},p=i.objectElementValidators||{},y=i.style,w=i.styleSpec;let P=[];const k=Ui(r);if(k!=="object")return[new yt(e,r,`object expected, ${k} found`)];for(const F in r){const j=F.split(".")[0],N=o[j]||o["*"];let W;if(p[j])W=p[j];else if(o[j])W=pn;else if(p["*"])W=p["*"];else{if(!o["*"]){P.push(new yt(e,r[F],`unknown property "${F}"`));continue}W=pn}P=P.concat(W({key:(e&&`${e}.`)+F,value:r[F],valueSpec:N,style:y,styleSpec:w,object:r,objectKey:F},r))}for(const F in o)p[F]||o[F].required&&o[F].default===void 0&&r[F]===void 0&&P.push(new yt(e,r,`missing required property "${F}"`));return P}function Yo(i){const e=i.value,r=i.valueSpec,o=i.style,p=i.styleSpec,y=i.key,w=i.arrayElementValidator||pn;if(Ui(e)!=="array")return[new yt(y,e,`array expected, ${Ui(e)} found`)];if(r.length&&e.length!==r.length)return[new yt(y,e,`array length ${r.length} expected, length ${e.length} found`)];if(r["min-length"]&&e.length<r["min-length"])return[new yt(y,e,`array length at least ${r["min-length"]} expected, length ${e.length} found`)];let P={type:r.value,values:r.values};p.$version<7&&(P.function=r.function),Ui(r.value)==="object"&&(P=r.value);let k=[];for(let F=0;F<e.length;F++)k=k.concat(w({array:e,arrayIndex:F,value:e[F],valueSpec:P,style:o,styleSpec:p,key:`${y}[${F}]`}));return k}function Co(i){const e=i.key,r=i.value,o=i.valueSpec;let p=Ui(r);return p==="number"&&r!=r&&(p="NaN"),p!=="number"?[new yt(e,r,`number expected, ${p} found`)]:"minimum"in o&&r<o.minimum?[new yt(e,r,`${r} is less than the minimum value ${o.minimum}`)]:"maximum"in o&&r>o.maximum?[new yt(e,r,`${r} is greater than the maximum value ${o.maximum}`)]:[]}function Ho(i){const e=i.valueSpec,r=ri(i.value.type);let o,p,y,w={};const P=r!=="categorical"&&i.value.property===void 0,k=!P,F=Ui(i.value.stops)==="array"&&Ui(i.value.stops[0])==="array"&&Ui(i.value.stops[0][0])==="object",j=fn({key:i.key,value:i.value,valueSpec:i.styleSpec.function,style:i.style,styleSpec:i.styleSpec,objectElementValidators:{stops:function(Z){if(r==="identity")return[new yt(Z.key,Z.value,'identity function may not have a "stops" property')];let K=[];const me=Z.value;return K=K.concat(Yo({key:Z.key,value:me,valueSpec:Z.valueSpec,style:Z.style,styleSpec:Z.styleSpec,arrayElementValidator:N})),Ui(me)==="array"&&me.length===0&&K.push(new yt(Z.key,me,"array must have at least one stop")),K},default:function(Z){return pn({key:Z.key,value:Z.value,valueSpec:e,style:Z.style,styleSpec:Z.styleSpec})}}});return r==="identity"&&P&&j.push(new yt(i.key,i.value,'missing required property "property"')),r==="identity"||i.value.stops||j.push(new yt(i.key,i.value,'missing required property "stops"')),r==="exponential"&&i.valueSpec.expression&&!Mi(i.valueSpec)&&j.push(new yt(i.key,i.value,"exponential functions not supported")),i.styleSpec.$version>=8&&(k&&!Ji(i.valueSpec)?j.push(new yt(i.key,i.value,"property functions not supported")):P&&!Zn(i.valueSpec)&&j.push(new yt(i.key,i.value,"zoom functions not supported"))),r!=="categorical"&&!F||i.value.property!==void 0||j.push(new yt(i.key,i.value,'"property" property is required')),j;function N(Z){let K=[];const me=Z.value,ue=Z.key;if(Ui(me)!=="array")return[new yt(ue,me,`array expected, ${Ui(me)} found`)];if(me.length!==2)return[new yt(ue,me,`array length 2 expected, length ${me.length} found`)];if(F){if(Ui(me[0])!=="object")return[new yt(ue,me,`object expected, ${Ui(me[0])} found`)];if(me[0].zoom===void 0)return[new yt(ue,me,"object stop key must have zoom")];if(me[0].value===void 0)return[new yt(ue,me,"object stop key must have value")];if(y&&y>ri(me[0].zoom))return[new yt(ue,me[0].zoom,"stop zoom values must appear in ascending order")];ri(me[0].zoom)!==y&&(y=ri(me[0].zoom),p=void 0,w={}),K=K.concat(fn({key:`${ue}[0]`,value:me[0],valueSpec:{zoom:{}},style:Z.style,styleSpec:Z.styleSpec,objectElementValidators:{zoom:Co,value:W}}))}else K=K.concat(W({key:`${ue}[0]`,value:me[0],valueSpec:{},style:Z.style,styleSpec:Z.styleSpec},me));return Hs(Ei(me[1]))?K.concat([new yt(`${ue}[1]`,me[1],"expressions are not allowed in function stops.")]):K.concat(pn({key:`${ue}[1]`,value:me[1],valueSpec:e,style:Z.style,styleSpec:Z.styleSpec}))}function W(Z,K){const me=Ui(Z.value),ue=ri(Z.value),Me=Z.value!==null?Z.value:K;if(o){if(me!==o)return[new yt(Z.key,Me,`${me} stop domain type must match previous stop domain type ${o}`)]}else o=me;if(me!=="number"&&me!=="string"&&me!=="boolean")return[new yt(Z.key,Me,"stop domain value must be a number, string, or boolean")];if(me!=="number"&&r!=="categorical"){let Xe=`number expected, ${me} found`;return Ji(e)&&r===void 0&&(Xe+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new yt(Z.key,Me,Xe)]}return r!=="categorical"||me!=="number"||isFinite(ue)&&Math.floor(ue)===ue?r!=="categorical"&&me==="number"&&p!==void 0&&ue<p?[new yt(Z.key,Me,"stop domain values must appear in ascending order")]:(p=ue,r==="categorical"&&ue in w?[new yt(Z.key,Me,"stop domain values must be unique")]:(w[ue]=!0,[])):[new yt(Z.key,Me,`integer expected, found ${ue}`)]}}function Pn(i){const e=(i.expressionContext==="property"?qo:xn)(Ei(i.value),i.valueSpec);if(e.result==="error")return e.value.map(o=>new yt(`${i.key}${o.key}`,i.value,o.message));const r=e.value.expression||e.value._styleExpression.expression;if(i.expressionContext==="property"&&i.propertyKey==="text-font"&&!r.outputDefined())return[new yt(i.key,i.value,`Invalid data expression for "${i.propertyKey}". Output values must be contained as literals within the expression.`)];if(i.expressionContext==="property"&&i.propertyType==="layout"&&!$(r))return[new yt(i.key,i.value,'"feature-state" data expressions are not supported with layout properties.')];if(i.expressionContext==="filter"&&!$(r))return[new yt(i.key,i.value,'"feature-state" data expressions are not supported with filters.')];if(i.expressionContext&&i.expressionContext.indexOf("cluster")===0){if(!ye(r,["zoom","feature-state"]))return[new yt(i.key,i.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(i.expressionContext==="cluster-initial"&&!z(r))return[new yt(i.key,i.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Ls(i){const e=i.key,r=i.value,o=i.valueSpec,p=[];return Array.isArray(o.values)?o.values.indexOf(ri(r))===-1&&p.push(new yt(e,r,`expected one of [${o.values.join(", ")}], ${JSON.stringify(r)} found`)):Object.keys(o.values).indexOf(ri(r))===-1&&p.push(new yt(e,r,`expected one of [${Object.keys(o.values).join(", ")}], ${JSON.stringify(r)} found`)),p}function zs(i){if(i===!0||i===!1)return!0;if(!Array.isArray(i)||i.length===0)return!1;switch(i[0]){case"has":return i.length>=2&&i[1]!=="$id"&&i[1]!=="$type";case"in":return i.length>=3&&(typeof i[1]!="string"||Array.isArray(i[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return i.length!==3||Array.isArray(i[1])||Array.isArray(i[2]);case"any":case"all":for(const e of i.slice(1))if(!zs(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}const Ae={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function Ke(i){if(i==null)return{filter:()=>!0,needGeometry:!1};zs(i)||(i=Qi(i));const e=xn(i,Ae);if(e.result==="error")throw new Error(e.value.map(r=>`${r.key}: ${r.message}`).join(", "));return{filter:(r,o,p)=>e.value.evaluate(r,o,{},p),needGeometry:fi(i)}}function Lt(i,e){return i<e?-1:i>e?1:0}function fi(i){if(!Array.isArray(i))return!1;if(i[0]==="within")return!0;for(let e=1;e<i.length;e++)if(fi(i[e]))return!0;return!1}function Qi(i){if(!i)return!0;const e=i[0];return i.length<=1?e!=="any":e==="=="?zi(i[1],i[2],"=="):e==="!="?Nr(zi(i[1],i[2],"==")):e==="<"||e===">"||e==="<="||e===">="?zi(i[1],i[2],e):e==="any"?(r=i.slice(1),["any"].concat(r.map(Qi))):e==="all"?["all"].concat(i.slice(1).map(Qi)):e==="none"?["all"].concat(i.slice(1).map(Qi).map(Nr)):e==="in"?ur(i[1],i.slice(2)):e==="!in"?Nr(ur(i[1],i.slice(2))):e==="has"?pr(i[1]):e==="!has"?Nr(pr(i[1])):e!=="within"||i;var r}function zi(i,e,r){switch(i){case"$type":return[`filter-type-${r}`,e];case"$id":return[`filter-id-${r}`,e];default:return[`filter-${r}`,i,e]}}function ur(i,e){if(e.length===0)return!1;switch(i){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(r=>typeof r!=typeof e[0])?["filter-in-large",i,["literal",e.sort(Lt)]]:["filter-in-small",i,["literal",e]]}}function pr(i){switch(i){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",i]}}function Nr(i){return["!",i]}function _r(i){return zs(Ei(i.value))?Pn(Zi({},i,{expressionContext:"filter",valueSpec:{value:"boolean"}})):Tr(i)}function Tr(i){const e=i.value,r=i.key;if(Ui(e)!=="array")return[new yt(r,e,`array expected, ${Ui(e)} found`)];const o=i.styleSpec;let p,y=[];if(e.length<1)return[new yt(r,e,"filter array must have at least 1 element")];switch(y=y.concat(Ls({key:`${r}[0]`,value:e[0],valueSpec:o.filter_operator,style:i.style,styleSpec:i.styleSpec})),ri(e[0])){case"<":case"<=":case">":case">=":e.length>=2&&ri(e[1])==="$type"&&y.push(new yt(r,e,`"$type" cannot be use with operator "${e[0]}"`));case"==":case"!=":e.length!==3&&y.push(new yt(r,e,`filter array for operator "${e[0]}" must have 3 elements`));case"in":case"!in":e.length>=2&&(p=Ui(e[1]),p!=="string"&&y.push(new yt(`${r}[1]`,e[1],`string expected, ${p} found`)));for(let w=2;w<e.length;w++)p=Ui(e[w]),ri(e[1])==="$type"?y=y.concat(Ls({key:`${r}[${w}]`,value:e[w],valueSpec:o.geometry_type,style:i.style,styleSpec:i.styleSpec})):p!=="string"&&p!=="number"&&p!=="boolean"&&y.push(new yt(`${r}[${w}]`,e[w],`string, number, or boolean expected, ${p} found`));break;case"any":case"all":case"none":for(let w=1;w<e.length;w++)y=y.concat(Tr({key:`${r}[${w}]`,value:e[w],style:i.style,styleSpec:i.styleSpec}));break;case"has":case"!has":p=Ui(e[1]),e.length!==2?y.push(new yt(r,e,`filter array for "${e[0]}" operator must have 2 elements`)):p!=="string"&&y.push(new yt(`${r}[1]`,e[1],`string expected, ${p} found`));break;case"within":p=Ui(e[1]),e.length!==2?y.push(new yt(r,e,`filter array for "${e[0]}" operator must have 2 elements`)):p!=="object"&&y.push(new yt(`${r}[1]`,e[1],`object expected, ${p} found`))}return y}function nn(i,e){const r=i.key,o=i.style,p=i.styleSpec,y=i.value,w=i.objectKey,P=p[`${e}_${i.layerType}`];if(!P)return[];const k=w.match(/^(.*)-transition$/);if(e==="paint"&&k&&P[k[1]]&&P[k[1]].transition)return pn({key:r,value:y,valueSpec:p.transition,style:o,styleSpec:p});const F=i.valueSpec||P[w];if(!F)return[new yt(r,y,`unknown property "${w}"`)];let j;if(Ui(y)==="string"&&Ji(F)&&!F.tokens&&(j=/^{([^}]+)}$/.exec(y)))return[new yt(r,y,`"${w}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(j[1])} }\`.`)];const N=[];return i.layerType==="symbol"&&(w==="text-field"&&o&&!o.glyphs&&N.push(new yt(r,y,'use of "text-field" requires a style "glyphs" property')),w==="text-font"&&Yi(Ei(y))&&ri(y.type)==="identity"&&N.push(new yt(r,y,'"text-font" does not support identity functions'))),N.concat(pn({key:i.key,value:y,valueSpec:F,style:o,styleSpec:p,expressionContext:"property",propertyType:e,propertyKey:w}))}function Fn(i){return nn(i,"paint")}function Gr(i){return nn(i,"layout")}function Rn(i){let e=[];const r=i.value,o=i.key,p=i.style,y=i.styleSpec;r.type||r.ref||e.push(new yt(o,r,'either "type" or "ref" is required'));let w=ri(r.type);const P=ri(r.ref);if(r.id){const k=ri(r.id);for(let F=0;F<i.arrayIndex;F++){const j=p.layers[F];ri(j.id)===k&&e.push(new yt(o,r.id,`duplicate layer id "${r.id}", previously used at line ${j.id.__line__}`))}}if("ref"in r){let k;["type","source","source-layer","filter","layout"].forEach(F=>{F in r&&e.push(new yt(o,r[F],`"${F}" is prohibited for ref layers`))}),p.layers.forEach(F=>{ri(F.id)===P&&(k=F)}),k?k.ref?e.push(new yt(o,r.ref,"ref cannot reference another ref layer")):w=ri(k.type):e.push(new yt(o,r.ref,`ref layer "${P}" not found`))}else if(w!=="background")if(r.source){const k=p.sources&&p.sources[r.source],F=k&&ri(k.type);k?F==="vector"&&w==="raster"?e.push(new yt(o,r.source,`layer "${r.id}" requires a raster source`)):F==="raster"&&w!=="raster"?e.push(new yt(o,r.source,`layer "${r.id}" requires a vector source`)):F!=="vector"||r["source-layer"]?F==="raster-dem"&&w!=="hillshade"?e.push(new yt(o,r.source,"raster-dem source can only be used with layer type 'hillshade'.")):w!=="line"||!r.paint||!r.paint["line-gradient"]||F==="geojson"&&k.lineMetrics||e.push(new yt(o,r,`layer "${r.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):e.push(new yt(o,r,`layer "${r.id}" must specify a "source-layer"`)):e.push(new yt(o,r.source,`source "${r.source}" not found`))}else e.push(new yt(o,r,'missing required property "source"'));return e=e.concat(fn({key:o,value:r,valueSpec:y.layer,style:i.style,styleSpec:i.styleSpec,objectElementValidators:{"*":()=>[],type:()=>pn({key:`${o}.type`,value:r.type,valueSpec:y.layer.type,style:i.style,styleSpec:i.styleSpec,object:r,objectKey:"type"}),filter:_r,layout:k=>fn({layer:r,key:k.key,value:k.value,style:k.style,styleSpec:k.styleSpec,objectElementValidators:{"*":F=>Gr(Zi({layerType:w},F))}}),paint:k=>fn({layer:r,key:k.key,value:k.value,style:k.style,styleSpec:k.styleSpec,objectElementValidators:{"*":F=>Fn(Zi({layerType:w},F))}})}})),e}function In(i){const e=i.value,r=i.key,o=Ui(e);return o!=="string"?[new yt(r,e,`string expected, ${o} found`)]:[]}const Ks={promoteId:function({key:i,value:e}){if(Ui(e)==="string")return In({key:i,value:e});{const r=[];for(const o in e)r.push(...In({key:`${i}.${o}`,value:e[o]}));return r}}};function Bn(i){const e=i.value,r=i.key,o=i.styleSpec,p=i.style;if(!e.type)return[new yt(r,e,'"type" is required')];const y=ri(e.type);let w;switch(y){case"vector":case"raster":case"raster-dem":return w=fn({key:r,value:e,valueSpec:o[`source_${y.replace("-","_")}`],style:i.style,styleSpec:o,objectElementValidators:Ks}),w;case"geojson":if(w=fn({key:r,value:e,valueSpec:o.source_geojson,style:p,styleSpec:o,objectElementValidators:Ks}),e.cluster)for(const P in e.clusterProperties){const[k,F]=e.clusterProperties[P],j=typeof k=="string"?[k,["accumulated"],["get",P]]:k;w.push(...Pn({key:`${r}.${P}.map`,value:F,expressionContext:"cluster-map"})),w.push(...Pn({key:`${r}.${P}.reduce`,value:j,expressionContext:"cluster-reduce"}))}return w;case"video":return fn({key:r,value:e,valueSpec:o.source_video,style:p,styleSpec:o});case"image":return fn({key:r,value:e,valueSpec:o.source_image,style:p,styleSpec:o});case"canvas":return[new yt(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Ls({key:`${r}.type`,value:e.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:p,styleSpec:o})}}function Qn(i){const e=i.value,r=i.styleSpec,o=r.light,p=i.style;let y=[];const w=Ui(e);if(e===void 0)return y;if(w!=="object")return y=y.concat([new yt("light",e,`object expected, ${w} found`)]),y;for(const P in e){const k=P.match(/^(.*)-transition$/);y=y.concat(k&&o[k[1]]&&o[k[1]].transition?pn({key:P,value:e[P],valueSpec:r.transition,style:p,styleSpec:r}):o[P]?pn({key:P,value:e[P],valueSpec:o[P],style:p,styleSpec:r}):[new yt(P,e[P],`unknown property "${P}"`)])}return y}function sn(i){const e=i.value,r=i.styleSpec,o=r.terrain,p=i.style;let y=[];const w=Ui(e);if(e===void 0)return y;if(w!=="object")return y=y.concat([new yt("terrain",e,`object expected, ${w} found`)]),y;for(const P in e)y=y.concat(o[P]?pn({key:P,value:e[P],valueSpec:o[P],style:p,styleSpec:r}):[new yt(P,e[P],`unknown property "${P}"`)]);return y}const Js={"*":()=>[],array:Yo,boolean:function(i){const e=i.value,r=i.key,o=Ui(e);return o!=="boolean"?[new yt(r,e,`boolean expected, ${o} found`)]:[]},number:Co,color:function(i){const e=i.key,r=i.value,o=Ui(r);return o!=="string"?[new yt(e,r,`color expected, ${o} found`)]:$n(r)===null?[new yt(e,r,`color expected, "${r}" found`)]:[]},constants:Ri,enum:Ls,filter:_r,function:Ho,layer:Rn,object:fn,source:Bn,light:Qn,terrain:sn,string:In,formatted:function(i){return In(i).length===0?[]:Pn(i)},resolvedImage:function(i){return In(i).length===0?[]:Pn(i)},padding:function(i){const e=i.key,r=i.value;if(Ui(r)==="array"){if(r.length<1||r.length>4)return[new yt(e,r,`padding requires 1 to 4 values; ${r.length} values found`)];const o={type:"number"};let p=[];for(let y=0;y<r.length;y++)p=p.concat(pn({key:`${e}[${y}]`,value:r[y],valueSpec:o}));return p}return Co({key:e,value:r,valueSpec:{}})}};function pn(i){const e=i.value,r=i.valueSpec,o=i.styleSpec;return r.expression&&Yi(ri(e))?Ho(i):r.expression&&Hs(Ei(e))?Pn(i):r.type&&Js[r.type]?Js[r.type](i):fn(Zi({},i,{valueSpec:r.type?o[r.type]:r}))}function rr(i){const e=i.value,r=i.key,o=In(i);return o.length||(e.indexOf("{fontstack}")===-1&&o.push(new yt(r,e,'"glyphs" url must include a "{fontstack}" token')),e.indexOf("{range}")===-1&&o.push(new yt(r,e,'"glyphs" url must include a "{range}" token'))),o}function ji(i,e=Ue){let r=[];return r=r.concat(pn({key:"",value:i,valueSpec:e.$root,styleSpec:e,style:i,objectElementValidators:{glyphs:rr,"*":()=>[]}})),i.constants&&(r=r.concat(Ri({key:"constants",value:i.constants,style:i,styleSpec:e}))),Qs(r)}function Qs(i){return[].concat(i).sort((e,r)=>e.line-r.line)}function Xr(i){return function(...e){return Qs(i.apply(this,e))}}ji.source=Xr(Bn),ji.light=Xr(Qn),ji.terrain=Xr(sn),ji.layer=Xr(Rn),ji.filter=Xr(_r),ji.paintProperty=Xr(Fn),ji.layoutProperty=Xr(Gr);const Cs=ji,on=Cs.light,es=Cs.paintProperty,hs=Cs.layoutProperty;function us(i,e){let r=!1;if(e&&e.length)for(const o of e)i.fire(new Di(new Error(o.message))),r=!0;return r}class ds{constructor(e,r,o){const p=this.cells=[];if(e instanceof ArrayBuffer){this.arrayBuffer=e;const w=new Int32Array(this.arrayBuffer);e=w[0],this.d=(r=w[1])+2*(o=w[2]);for(let k=0;k<this.d*this.d;k++){const F=w[3+k],j=w[3+k+1];p.push(F===j?null:w.subarray(F,j))}const P=w[3+p.length+1];this.keys=w.subarray(w[3+p.length],P),this.bboxes=w.subarray(P),this.insert=this._insertReadonly}else{this.d=r+2*o;for(let w=0;w<this.d*this.d;w++)p.push([]);this.keys=[],this.bboxes=[]}this.n=r,this.extent=e,this.padding=o,this.scale=r/e,this.uid=0;const y=o/r*e;this.min=-y,this.max=e+y}insert(e,r,o,p,y){this._forEachCell(r,o,p,y,this._insertCell,this.uid++,void 0,void 0),this.keys.push(e),this.bboxes.push(r),this.bboxes.push(o),this.bboxes.push(p),this.bboxes.push(y)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(e,r,o,p,y,w){this.cells[y].push(w)}query(e,r,o,p,y){const w=this.min,P=this.max;if(e<=w&&r<=w&&P<=o&&P<=p&&!y)return Array.prototype.slice.call(this.keys);{const k=[];return this._forEachCell(e,r,o,p,this._queryCell,k,{},y),k}}_queryCell(e,r,o,p,y,w,P,k){const F=this.cells[y];if(F!==null){const j=this.keys,N=this.bboxes;for(let W=0;W<F.length;W++){const Z=F[W];if(P[Z]===void 0){const K=4*Z;(k?k(N[K+0],N[K+1],N[K+2],N[K+3]):e<=N[K+2]&&r<=N[K+3]&&o>=N[K+0]&&p>=N[K+1])?(P[Z]=!0,w.push(j[Z])):P[Z]=!1}}}}_forEachCell(e,r,o,p,y,w,P,k){const F=this._convertToCellCoord(e),j=this._convertToCellCoord(r),N=this._convertToCellCoord(o),W=this._convertToCellCoord(p);for(let Z=F;Z<=N;Z++)for(let K=j;K<=W;K++){const me=this.d*K+Z;if((!k||k(this._convertFromCellCoord(Z),this._convertFromCellCoord(K),this._convertFromCellCoord(Z+1),this._convertFromCellCoord(K+1)))&&y.call(this,e,r,o,p,me,w,P,k))return}}_convertFromCellCoord(e){return(e-this.padding)/this.scale}_convertToCellCoord(e){return Math.max(0,Math.min(this.d-1,Math.floor(e*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const e=this.cells,r=3+this.cells.length+1+1;let o=0;for(let w=0;w<this.cells.length;w++)o+=this.cells[w].length;const p=new Int32Array(r+o+this.keys.length+this.bboxes.length);p[0]=this.extent,p[1]=this.n,p[2]=this.padding;let y=r;for(let w=0;w<e.length;w++){const P=e[w];p[3+w]=y,p.set(P,y),y+=P.length}return p[3+e.length]=y,p.set(this.keys,y),y+=this.keys.length,p[3+e.length+1]=y,p.set(this.bboxes,y),y+=this.bboxes.length,p.buffer}static serialize(e,r){const o=e.toArrayBuffer();return r&&r.push(o),{buffer:o}}static deserialize(e){return new ds(e.buffer)}}const an={};function Rt(i,e,r={}){if(an[i])throw new Error(`${i} is already registered.`);Object.defineProperty(e,"_classRegistryKey",{value:i,writeable:!1}),an[i]={klass:e,omit:r.omit||[],shallow:r.shallow||[]}}Rt("Object",Object),Rt("TransferableGridIndex",ds),Rt("Color",te),Rt("Error",Error),Rt("AJAXError",je),Rt("ResolvedImage",Se),Rt("StylePropertyFunction",wo),Rt("StyleExpression",Kn,{omit:["_evaluator"]}),Rt("ZoomDependentExpression",Jn),Rt("ZoomConstantExpression",Zs),Rt("CompoundExpression",Ci,{omit:["_evaluate"]});for(const i in Ms)Ms[i]._classRegistryKey||Rt(`Expression_${i}`,Ms[i]);function Zo(i){return i&&typeof ArrayBuffer<"u"&&(i instanceof ArrayBuffer||i.constructor&&i.constructor.name==="ArrayBuffer")}function Un(i,e){if(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||i instanceof Blob)return i;if(Zo(i)||rt(i))return e&&e.push(i),i;if(ArrayBuffer.isView(i)){const r=i;return e&&e.push(r.buffer),r}if(i instanceof ImageData)return e&&e.push(i.data.buffer),i;if(Array.isArray(i)){const r=[];for(const o of i)r.push(Un(o,e));return r}if(typeof i=="object"){const r=i.constructor,o=r._classRegistryKey;if(!o)throw new Error("can't serialize object of unregistered class");if(!an[o])throw new Error(`${o} is not registered.`);const p=r.serialize?r.serialize(i,e):{};if(r.serialize){if(e&&p===e[e.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const y in i){if(!i.hasOwnProperty(y)||an[o].omit.indexOf(y)>=0)continue;const w=i[y];p[y]=an[o].shallow.indexOf(y)>=0?w:Un(w,e)}i instanceof Error&&(p.message=i.message)}if(p.$name)throw new Error("$name property is reserved for worker serialization logic.");return o!=="Object"&&(p.$name=o),p}throw new Error("can't serialize object of type "+typeof i)}function jn(i){if(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||i instanceof Blob||Zo(i)||rt(i)||ArrayBuffer.isView(i)||i instanceof ImageData)return i;if(Array.isArray(i))return i.map(jn);if(typeof i=="object"){const e=i.$name||"Object";if(!an[e])throw new Error(`can't deserialize unregistered class ${e}`);const{klass:r}=an[e];if(!r)throw new Error(`can't deserialize unregistered class ${e}`);if(r.deserialize)return r.deserialize(i);const o=Object.create(r.prototype);for(const p of Object.keys(i)){if(p==="$name")continue;const y=i[p];o[p]=an[e].shallow.indexOf(p)>=0?y:jn(y)}return o}throw new Error("can't deserialize object of type "+typeof i)}class Fs{constructor(){this.first=!0}update(e,r){const o=Math.floor(e);return this.first?(this.first=!1,this.lastIntegerZoom=o,this.lastIntegerZoomTime=0,this.lastZoom=e,this.lastFloorZoom=o,!0):(this.lastFloorZoom>o?(this.lastIntegerZoom=o+1,this.lastIntegerZoomTime=r):this.lastFloorZoom<o&&(this.lastIntegerZoom=o,this.lastIntegerZoomTime=r),e!==this.lastZoom&&(this.lastZoom=e,this.lastFloorZoom=o,!0))}}const kt={"Latin-1 Supplement":i=>i>=128&&i<=255,Arabic:i=>i>=1536&&i<=1791,"Arabic Supplement":i=>i>=1872&&i<=1919,"Arabic Extended-A":i=>i>=2208&&i<=2303,"Hangul Jamo":i=>i>=4352&&i<=4607,"Unified Canadian Aboriginal Syllabics":i=>i>=5120&&i<=5759,Khmer:i=>i>=6016&&i<=6143,"Unified Canadian Aboriginal Syllabics Extended":i=>i>=6320&&i<=6399,"General Punctuation":i=>i>=8192&&i<=8303,"Letterlike Symbols":i=>i>=8448&&i<=8527,"Number Forms":i=>i>=8528&&i<=8591,"Miscellaneous Technical":i=>i>=8960&&i<=9215,"Control Pictures":i=>i>=9216&&i<=9279,"Optical Character Recognition":i=>i>=9280&&i<=9311,"Enclosed Alphanumerics":i=>i>=9312&&i<=9471,"Geometric Shapes":i=>i>=9632&&i<=9727,"Miscellaneous Symbols":i=>i>=9728&&i<=9983,"Miscellaneous Symbols and Arrows":i=>i>=11008&&i<=11263,"CJK Radicals Supplement":i=>i>=11904&&i<=12031,"Kangxi Radicals":i=>i>=12032&&i<=12255,"Ideographic Description Characters":i=>i>=12272&&i<=12287,"CJK Symbols and Punctuation":i=>i>=12288&&i<=12351,Hiragana:i=>i>=12352&&i<=12447,Katakana:i=>i>=12448&&i<=12543,Bopomofo:i=>i>=12544&&i<=12591,"Hangul Compatibility Jamo":i=>i>=12592&&i<=12687,Kanbun:i=>i>=12688&&i<=12703,"Bopomofo Extended":i=>i>=12704&&i<=12735,"CJK Strokes":i=>i>=12736&&i<=12783,"Katakana Phonetic Extensions":i=>i>=12784&&i<=12799,"Enclosed CJK Letters and Months":i=>i>=12800&&i<=13055,"CJK Compatibility":i=>i>=13056&&i<=13311,"CJK Unified Ideographs Extension A":i=>i>=13312&&i<=19903,"Yijing Hexagram Symbols":i=>i>=19904&&i<=19967,"CJK Unified Ideographs":i=>i>=19968&&i<=40959,"Yi Syllables":i=>i>=40960&&i<=42127,"Yi Radicals":i=>i>=42128&&i<=42191,"Hangul Jamo Extended-A":i=>i>=43360&&i<=43391,"Hangul Syllables":i=>i>=44032&&i<=55215,"Hangul Jamo Extended-B":i=>i>=55216&&i<=55295,"Private Use Area":i=>i>=57344&&i<=63743,"CJK Compatibility Ideographs":i=>i>=63744&&i<=64255,"Arabic Presentation Forms-A":i=>i>=64336&&i<=65023,"Vertical Forms":i=>i>=65040&&i<=65055,"CJK Compatibility Forms":i=>i>=65072&&i<=65103,"Small Form Variants":i=>i>=65104&&i<=65135,"Arabic Presentation Forms-B":i=>i>=65136&&i<=65279,"Halfwidth and Fullwidth Forms":i=>i>=65280&&i<=65519};function eo(i){for(const e of i)if(Da(e.charCodeAt(0)))return!0;return!1}function So(i){for(const e of i)if(!Rs(e.charCodeAt(0)))return!1;return!0}function Rs(i){return!(kt.Arabic(i)||kt["Arabic Supplement"](i)||kt["Arabic Extended-A"](i)||kt["Arabic Presentation Forms-A"](i)||kt["Arabic Presentation Forms-B"](i))}function Da(i){return!(i!==746&&i!==747&&(i<4352||!(kt["Bopomofo Extended"](i)||kt.Bopomofo(i)||kt["CJK Compatibility Forms"](i)&&!(i>=65097&&i<=65103)||kt["CJK Compatibility Ideographs"](i)||kt["CJK Compatibility"](i)||kt["CJK Radicals Supplement"](i)||kt["CJK Strokes"](i)||!(!kt["CJK Symbols and Punctuation"](i)||i>=12296&&i<=12305||i>=12308&&i<=12319||i===12336)||kt["CJK Unified Ideographs Extension A"](i)||kt["CJK Unified Ideographs"](i)||kt["Enclosed CJK Letters and Months"](i)||kt["Hangul Compatibility Jamo"](i)||kt["Hangul Jamo Extended-A"](i)||kt["Hangul Jamo Extended-B"](i)||kt["Hangul Jamo"](i)||kt["Hangul Syllables"](i)||kt.Hiragana(i)||kt["Ideographic Description Characters"](i)||kt.Kanbun(i)||kt["Kangxi Radicals"](i)||kt["Katakana Phonetic Extensions"](i)||kt.Katakana(i)&&i!==12540||!(!kt["Halfwidth and Fullwidth Forms"](i)||i===65288||i===65289||i===65293||i>=65306&&i<=65310||i===65339||i===65341||i===65343||i>=65371&&i<=65503||i===65507||i>=65512&&i<=65519)||!(!kt["Small Form Variants"](i)||i>=65112&&i<=65118||i>=65123&&i<=65126)||kt["Unified Canadian Aboriginal Syllabics"](i)||kt["Unified Canadian Aboriginal Syllabics Extended"](i)||kt["Vertical Forms"](i)||kt["Yijing Hexagram Symbols"](i)||kt["Yi Syllables"](i)||kt["Yi Radicals"](i))))}function ll(i){return!(Da(i)||function(e){return!!(kt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||kt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||kt["Letterlike Symbols"](e)||kt["Number Forms"](e)||kt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||kt["Control Pictures"](e)&&e!==9251||kt["Optical Character Recognition"](e)||kt["Enclosed Alphanumerics"](e)||kt["Geometric Shapes"](e)||kt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||kt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||kt["CJK Symbols and Punctuation"](e)||kt.Katakana(e)||kt["Private Use Area"](e)||kt["CJK Compatibility Forms"](e)||kt["Small Form Variants"](e)||kt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(i))}function cl(i){return i>=1424&&i<=2303||kt["Arabic Presentation Forms-A"](i)||kt["Arabic Presentation Forms-B"](i)}function Wl(i,e){return!(!e&&cl(i)||i>=2304&&i<=3583||i>=3840&&i<=4255||kt.Khmer(i))}function hl(i){for(const e of i)if(cl(e.charCodeAt(0)))return!0;return!1}const Oa="deferred",La="loading",za="loaded";let Fa=null,bn="unavailable",Bs=null;const ul=function(i){i&&typeof i=="string"&&i.indexOf("NetworkError")>-1&&(bn="error"),Fa&&Fa(i)};function To(){Ra.fire(new mi("pluginStateChange",{pluginStatus:bn,pluginURL:Bs}))}const Ra=new wi,Ko=function(){return bn},dl=function(){if(bn!==Oa||!Bs)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");bn=La,To(),Bs&&$e({url:Bs},i=>{i?ul(i):(bn=za,To())})},Vn={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>bn===za||Vn.applyArabicShaping!=null,isLoading:()=>bn===La,setState(i){if(!ge())throw new Error("Cannot set the state of the rtl-text-plugin when not in the web-worker context");bn=i.pluginStatus,Bs=i.pluginURL},isParsed(){if(!ge())throw new Error("rtl-text-plugin is only parsed on the worker-threads");return Vn.applyArabicShaping!=null&&Vn.processBidirectionalText!=null&&Vn.processStyledBidirectionalText!=null},getPluginURL(){if(!ge())throw new Error("rtl-text-plugin url can only be queried from the worker threads");return Bs}};class yr{constructor(e,r){this.zoom=e,r?(this.now=r.now,this.fadeDuration=r.fadeDuration,this.zoomHistory=r.zoomHistory,this.transition=r.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new Fs,this.transition={})}isSupportedScript(e){return function(r,o){for(const p of r)if(!Wl(p.charCodeAt(0),o))return!1;return!0}(e,Vn.isLoaded())}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const e=this.zoom,r=e-Math.floor(e),o=this.crossFadingFactor();return e>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:r+(1-r)*o}:{fromScale:.5,toScale:1,t:1-(1-o)*r}}}class Jo{constructor(e,r){this.property=e,this.value=r,this.expression=function(o,p){if(Yi(o))return new wo(o,p);if(Hs(o)){const y=qo(o,p);if(y.result==="error")throw new Error(y.value.map(w=>`${w.key}: ${w.message}`).join(", "));return y.value}{let y=o;return p.type==="color"&&typeof o=="string"?y=te.parse(o):p.type!=="padding"||typeof o!="number"&&!Array.isArray(o)||(y=pe.parse(o)),{kind:"constant",evaluate:()=>y}}}(r===void 0?e.specification.default:r,e.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,r,o){return this.property.possiblyEvaluate(this,e,r,o)}}class ma{constructor(e){this.property=e,this.value=new Jo(e,void 0)}transitioned(e,r){return new pl(this.property,this.value,r,d({},e.transition,this.transition),e.now)}untransitioned(){return new pl(this.property,this.value,null,{},0)}}class fl{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues)}getValue(e){return A(this._values[e].value.value)}setValue(e,r){Object.prototype.hasOwnProperty.call(this._values,e)||(this._values[e]=new ma(this._values[e].property)),this._values[e].value=new Jo(this._values[e].property,r===null?void 0:A(r))}getTransition(e){return A(this._values[e].transition)}setTransition(e,r){Object.prototype.hasOwnProperty.call(this._values,e)||(this._values[e]=new ma(this._values[e].property)),this._values[e].transition=A(r)||void 0}serialize(){const e={};for(const r of Object.keys(this._values)){const o=this.getValue(r);o!==void 0&&(e[r]=o);const p=this.getTransition(r);p!==void 0&&(e[`${r}-transition`]=p)}return e}transitioned(e,r){const o=new ml(this._properties);for(const p of Object.keys(this._values))o._values[p]=this._values[p].transitioned(e,r._values[p]);return o}untransitioned(){const e=new ml(this._properties);for(const r of Object.keys(this._values))e._values[r]=this._values[r].untransitioned();return e}}class pl{constructor(e,r,o,p,y){this.property=e,this.value=r,this.begin=y+p.delay||0,this.end=this.begin+p.duration||0,e.specification.transition&&(p.delay||p.duration)&&(this.prior=o)}possiblyEvaluate(e,r,o){const p=e.now||0,y=this.value.possiblyEvaluate(e,r,o),w=this.prior;if(w){if(p>this.end)return this.prior=null,y;if(this.value.isDataDriven())return this.prior=null,y;if(p<this.begin)return w.possiblyEvaluate(e,r,o);{const P=(p-this.begin)/(this.end-this.begin);return this.property.interpolate(w.possiblyEvaluate(e,r,o),y,function(k){if(k<=0)return 0;if(k>=1)return 1;const F=k*k,j=F*k;return 4*(k<.5?j:3*(k-F)+j-.75)}(P))}}return y}}class ml{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,r,o){const p=new Qo(this._properties);for(const y of Object.keys(this._values))p._values[y]=this._values[y].possiblyEvaluate(e,r,o);return p}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class $l{constructor(e){this._properties=e,this._values=Object.create(e.defaultPropertyValues)}getValue(e){return A(this._values[e].value)}setValue(e,r){this._values[e]=new Jo(this._values[e].property,r===null?void 0:A(r))}serialize(){const e={};for(const r of Object.keys(this._values)){const o=this.getValue(r);o!==void 0&&(e[r]=o)}return e}possiblyEvaluate(e,r,o){const p=new Qo(this._properties);for(const y of Object.keys(this._values))p._values[y]=this._values[y].possiblyEvaluate(e,r,o);return p}}class fs{constructor(e,r,o){this.property=e,this.value=r,this.parameters=o}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,r,o,p){return this.property.evaluate(this.value,this.parameters,e,r,o,p)}}class Qo{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class ni{constructor(e){this.specification=e}possiblyEvaluate(e,r){if(e.isDataDriven())throw new Error("Value should not be data driven");return e.expression.evaluate(r)}interpolate(e,r,o){const p=Re[this.specification.type];return p?p(e,r,o):e}}class pi{constructor(e,r){this.specification=e,this.overrides=r}possiblyEvaluate(e,r,o,p){return new fs(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(r,null,{},o,p)}:e.expression,r)}interpolate(e,r,o){if(e.value.kind!=="constant"||r.value.kind!=="constant")return e;if(e.value.value===void 0||r.value.value===void 0)return new fs(this,{kind:"constant",value:void 0},e.parameters);const p=Re[this.specification.type];return p?new fs(this,{kind:"constant",value:p(e.value.value,r.value.value,o)},e.parameters):e}evaluate(e,r,o,p,y,w){return e.kind==="constant"?e.value:e.evaluate(r,o,p,y,w)}}class Eo extends pi{possiblyEvaluate(e,r,o,p){if(e.value===void 0)return new fs(this,{kind:"constant",value:void 0},r);if(e.expression.kind==="constant"){const y=e.expression.evaluate(r,null,{},o,p),w=e.property.specification.type==="resolvedImage"&&typeof y!="string"?y.name:y,P=this._calculate(w,w,w,r);return new fs(this,{kind:"constant",value:P},r)}if(e.expression.kind==="camera"){const y=this._calculate(e.expression.evaluate({zoom:r.zoom-1}),e.expression.evaluate({zoom:r.zoom}),e.expression.evaluate({zoom:r.zoom+1}),r);return new fs(this,{kind:"constant",value:y},r)}return new fs(this,e.expression,r)}evaluate(e,r,o,p,y,w){if(e.kind==="source"){const P=e.evaluate(r,o,p,y,w);return this._calculate(P,P,P,r)}return e.kind==="composite"?this._calculate(e.evaluate({zoom:Math.floor(r.zoom)-1},o,p),e.evaluate({zoom:Math.floor(r.zoom)},o,p),e.evaluate({zoom:Math.floor(r.zoom)+1},o,p),r):e.value}_calculate(e,r,o,p){return p.zoom>p.zoomHistory.lastIntegerZoom?{from:e,to:r}:{from:o,to:r}}interpolate(e){return e}}class Ba{constructor(e){this.specification=e}possiblyEvaluate(e,r,o,p){if(e.value!==void 0){if(e.expression.kind==="constant"){const y=e.expression.evaluate(r,null,{},o,p);return this._calculate(y,y,y,r)}return this._calculate(e.expression.evaluate(new yr(Math.floor(r.zoom-1),r)),e.expression.evaluate(new yr(Math.floor(r.zoom),r)),e.expression.evaluate(new yr(Math.floor(r.zoom+1),r)),r)}}_calculate(e,r,o,p){return p.zoom>p.zoomHistory.lastIntegerZoom?{from:e,to:r}:{from:o,to:r}}interpolate(e){return e}}class Us{constructor(e){this.specification=e}possiblyEvaluate(e,r,o,p){return!!e.expression.evaluate(r,null,{},o,p)}interpolate(){return!1}}class Qr{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const r in e){const o=e[r];o.specification.overridable&&this.overridableProperties.push(r);const p=this.defaultPropertyValues[r]=new Jo(o,void 0),y=this.defaultTransitionablePropertyValues[r]=new ma(o);this.defaultTransitioningPropertyValues[r]=y.untransitioned(),this.defaultPossiblyEvaluatedValues[r]=p.possiblyEvaluate({})}}}Rt("DataDrivenProperty",pi),Rt("DataConstantProperty",ni),Rt("CrossFadedDataDrivenProperty",Eo),Rt("CrossFadedProperty",Ba),Rt("ColorRampProperty",Us);const js="-transition";class ps extends wi{constructor(e,r){if(super(),this.id=e.id,this.type=e.type,this._featureFilter={filter:()=>!0,needGeometry:!1},e.type!=="custom"&&(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type!=="background"&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),r.layout&&(this._unevaluatedLayout=new $l(r.layout)),r.paint)){this._transitionablePaint=new fl(r.paint);for(const o in e.paint)this.setPaintProperty(o,e.paint[o],{validate:!1});for(const o in e.layout)this.setLayoutProperty(o,e.layout[o],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Qo(r.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,r,o={}){r!=null&&this._validate(hs,`layers.${this.id}.layout.${e}`,e,r,o)||(e!=="visibility"?this._unevaluatedLayout.setValue(e,r):this.visibility=r)}getPaintProperty(e){return e.endsWith(js)?this._transitionablePaint.getTransition(e.slice(0,-js.length)):this._transitionablePaint.getValue(e)}setPaintProperty(e,r,o={}){if(r!=null&&this._validate(es,`layers.${this.id}.paint.${e}`,e,r,o))return!1;if(e.endsWith(js))return this._transitionablePaint.setTransition(e.slice(0,-js.length),r||void 0),!1;{const p=this._transitionablePaint._values[e],y=p.property.specification["property-type"]==="cross-faded-data-driven",w=p.value.isDataDriven(),P=p.value;this._transitionablePaint.setValue(e,r),this._handleSpecialPaintPropertyUpdate(e);const k=this._transitionablePaint._values[e].value;return k.isDataDriven()||w||y||this._handleOverridablePaintPropertyUpdate(e,P,k)}}_handleSpecialPaintPropertyUpdate(e){}_handleOverridablePaintPropertyUpdate(e,r,o){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,r){e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,r)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,r)}serialize(){const e={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(e.layout=e.layout||{},e.layout.visibility=this.visibility),S(e,(r,o)=>!(r===void 0||o==="layout"&&!Object.keys(r).length||o==="paint"&&!Object.keys(r).length))}_validate(e,r,o,p,y={}){return(!y||y.validate!==!1)&&us(this,e.call(Cs,{key:r,layerType:this.type,objectKey:o,value:p,styleSpec:Ue,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const e in this.paint._values){const r=this.paint.get(e);if(r instanceof fs&&Ji(r.property.specification)&&(r.value.kind==="source"||r.value.kind==="composite")&&r.value.isStateDependent)return!0}return!1}}const gl={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Vs{constructor(e,r){this._structArray=e,this._pos1=r*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Er{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,r){return e._trim(),r&&(e.isTransferred=!0,r.push(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const r=Object.create(this.prototype);return r.arrayBuffer=e.arrayBuffer,r.length=e.length,r.capacity=e.arrayBuffer.byteLength/r.bytesPerElement,r._refreshViews(),r}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const r=this.uint8;this._refreshViews(),r&&this.uint8.set(r)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function Lr(i,e=1){let r=0,o=0;return{members:i.map(p=>{const y=gl[p.type].BYTES_PER_ELEMENT,w=r=Ua(r,Math.max(e,y)),P=p.components||1;return o=Math.max(o,y),r+=y*P,{name:p.name,type:p.type,components:P,offset:w}}),size:Ua(r,Math.max(o,e)),alignment:e}}function Ua(i,e){return Math.ceil(i/e)*e}class to extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,r)}emplace(e,r,o){const p=2*e;return this.int16[p+0]=r,this.int16[p+1]=o,e}}to.prototype.bytesPerElement=4,Rt("StructArrayLayout2i4",to);class f extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,p){const y=this.length;return this.resize(y+1),this.emplace(y,e,r,o,p)}emplace(e,r,o,p,y){const w=4*e;return this.int16[w+0]=r,this.int16[w+1]=o,this.int16[w+2]=p,this.int16[w+3]=y,e}}f.prototype.bytesPerElement=8,Rt("StructArrayLayout4i8",f);class t extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,p,y,w){const P=this.length;return this.resize(P+1),this.emplace(P,e,r,o,p,y,w)}emplace(e,r,o,p,y,w,P){const k=6*e;return this.int16[k+0]=r,this.int16[k+1]=o,this.int16[k+2]=p,this.int16[k+3]=y,this.int16[k+4]=w,this.int16[k+5]=P,e}}t.prototype.bytesPerElement=12,Rt("StructArrayLayout2i4i12",t);class s extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,p,y,w){const P=this.length;return this.resize(P+1),this.emplace(P,e,r,o,p,y,w)}emplace(e,r,o,p,y,w,P){const k=4*e,F=8*e;return this.int16[k+0]=r,this.int16[k+1]=o,this.uint8[F+4]=p,this.uint8[F+5]=y,this.uint8[F+6]=w,this.uint8[F+7]=P,e}}s.prototype.bytesPerElement=8,Rt("StructArrayLayout2i4ub8",s);class l extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,r)}emplace(e,r,o){const p=2*e;return this.float32[p+0]=r,this.float32[p+1]=o,e}}l.prototype.bytesPerElement=8,Rt("StructArrayLayout2f8",l);class m extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o,p,y,w,P,k,F,j){const N=this.length;return this.resize(N+1),this.emplace(N,e,r,o,p,y,w,P,k,F,j)}emplace(e,r,o,p,y,w,P,k,F,j,N){const W=10*e;return this.uint16[W+0]=r,this.uint16[W+1]=o,this.uint16[W+2]=p,this.uint16[W+3]=y,this.uint16[W+4]=w,this.uint16[W+5]=P,this.uint16[W+6]=k,this.uint16[W+7]=F,this.uint16[W+8]=j,this.uint16[W+9]=N,e}}m.prototype.bytesPerElement=20,Rt("StructArrayLayout10ui20",m);class b extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o,p,y,w,P,k,F,j,N,W){const Z=this.length;return this.resize(Z+1),this.emplace(Z,e,r,o,p,y,w,P,k,F,j,N,W)}emplace(e,r,o,p,y,w,P,k,F,j,N,W,Z){const K=12*e;return this.int16[K+0]=r,this.int16[K+1]=o,this.int16[K+2]=p,this.int16[K+3]=y,this.uint16[K+4]=w,this.uint16[K+5]=P,this.uint16[K+6]=k,this.uint16[K+7]=F,this.int16[K+8]=j,this.int16[K+9]=N,this.int16[K+10]=W,this.int16[K+11]=Z,e}}b.prototype.bytesPerElement=24,Rt("StructArrayLayout4i4ui4i24",b);class E extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o){const p=this.length;return this.resize(p+1),this.emplace(p,e,r,o)}emplace(e,r,o,p){const y=3*e;return this.float32[y+0]=r,this.float32[y+1]=o,this.float32[y+2]=p,e}}E.prototype.bytesPerElement=12,Rt("StructArrayLayout3f12",E);class D extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint32[1*e+0]=r,e}}D.prototype.bytesPerElement=4,Rt("StructArrayLayout1ul4",D);class L extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o,p,y,w,P,k,F){const j=this.length;return this.resize(j+1),this.emplace(j,e,r,o,p,y,w,P,k,F)}emplace(e,r,o,p,y,w,P,k,F,j){const N=10*e,W=5*e;return this.int16[N+0]=r,this.int16[N+1]=o,this.int16[N+2]=p,this.int16[N+3]=y,this.int16[N+4]=w,this.int16[N+5]=P,this.uint32[W+3]=k,this.uint16[N+8]=F,this.uint16[N+9]=j,e}}L.prototype.bytesPerElement=20,Rt("StructArrayLayout6i1ul2ui20",L);class R extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,p,y,w){const P=this.length;return this.resize(P+1),this.emplace(P,e,r,o,p,y,w)}emplace(e,r,o,p,y,w,P){const k=6*e;return this.int16[k+0]=r,this.int16[k+1]=o,this.int16[k+2]=p,this.int16[k+3]=y,this.int16[k+4]=w,this.int16[k+5]=P,e}}R.prototype.bytesPerElement=12,Rt("StructArrayLayout2i2i2i12",R);class V extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o,p,y){const w=this.length;return this.resize(w+1),this.emplace(w,e,r,o,p,y)}emplace(e,r,o,p,y,w){const P=4*e,k=8*e;return this.float32[P+0]=r,this.float32[P+1]=o,this.float32[P+2]=p,this.int16[k+6]=y,this.int16[k+7]=w,e}}V.prototype.bytesPerElement=16,Rt("StructArrayLayout2f1f2i16",V);class X extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o,p){const y=this.length;return this.resize(y+1),this.emplace(y,e,r,o,p)}emplace(e,r,o,p,y){const w=12*e,P=3*e;return this.uint8[w+0]=r,this.uint8[w+1]=o,this.float32[P+1]=p,this.float32[P+2]=y,e}}X.prototype.bytesPerElement=12,Rt("StructArrayLayout2ub2f12",X);class H extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o){const p=this.length;return this.resize(p+1),this.emplace(p,e,r,o)}emplace(e,r,o,p){const y=3*e;return this.uint16[y+0]=r,this.uint16[y+1]=o,this.uint16[y+2]=p,e}}H.prototype.bytesPerElement=6,Rt("StructArrayLayout3ui6",H);class le extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o,p,y,w,P,k,F,j,N,W,Z,K,me,ue,Me){const Xe=this.length;return this.resize(Xe+1),this.emplace(Xe,e,r,o,p,y,w,P,k,F,j,N,W,Z,K,me,ue,Me)}emplace(e,r,o,p,y,w,P,k,F,j,N,W,Z,K,me,ue,Me,Xe){const Pe=24*e,Be=12*e,ht=48*e;return this.int16[Pe+0]=r,this.int16[Pe+1]=o,this.uint16[Pe+2]=p,this.uint16[Pe+3]=y,this.uint32[Be+2]=w,this.uint32[Be+3]=P,this.uint32[Be+4]=k,this.uint16[Pe+10]=F,this.uint16[Pe+11]=j,this.uint16[Pe+12]=N,this.float32[Be+7]=W,this.float32[Be+8]=Z,this.uint8[ht+36]=K,this.uint8[ht+37]=me,this.uint8[ht+38]=ue,this.uint32[Be+10]=Me,this.int16[Pe+22]=Xe,e}}le.prototype.bytesPerElement=48,Rt("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",le);class ne extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o,p,y,w,P,k,F,j,N,W,Z,K,me,ue,Me,Xe,Pe,Be,ht,ct,$t,Qt,Bt,Ot,It,Ut){const Ft=this.length;return this.resize(Ft+1),this.emplace(Ft,e,r,o,p,y,w,P,k,F,j,N,W,Z,K,me,ue,Me,Xe,Pe,Be,ht,ct,$t,Qt,Bt,Ot,It,Ut)}emplace(e,r,o,p,y,w,P,k,F,j,N,W,Z,K,me,ue,Me,Xe,Pe,Be,ht,ct,$t,Qt,Bt,Ot,It,Ut,Ft){const St=34*e,ui=17*e;return this.int16[St+0]=r,this.int16[St+1]=o,this.int16[St+2]=p,this.int16[St+3]=y,this.int16[St+4]=w,this.int16[St+5]=P,this.int16[St+6]=k,this.int16[St+7]=F,this.uint16[St+8]=j,this.uint16[St+9]=N,this.uint16[St+10]=W,this.uint16[St+11]=Z,this.uint16[St+12]=K,this.uint16[St+13]=me,this.uint16[St+14]=ue,this.uint16[St+15]=Me,this.uint16[St+16]=Xe,this.uint16[St+17]=Pe,this.uint16[St+18]=Be,this.uint16[St+19]=ht,this.uint16[St+20]=ct,this.uint16[St+21]=$t,this.uint16[St+22]=Qt,this.uint32[ui+12]=Bt,this.float32[ui+13]=Ot,this.float32[ui+14]=It,this.float32[ui+15]=Ut,this.float32[ui+16]=Ft,e}}ne.prototype.bytesPerElement=68,Rt("StructArrayLayout8i15ui1ul4f68",ne);class ae extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.float32[1*e+0]=r,e}}ae.prototype.bytesPerElement=4,Rt("StructArrayLayout1f4",ae);class xe extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,o){const p=this.length;return this.resize(p+1),this.emplace(p,e,r,o)}emplace(e,r,o,p){const y=3*e;return this.int16[y+0]=r,this.int16[y+1]=o,this.int16[y+2]=p,e}}xe.prototype.bytesPerElement=6,Rt("StructArrayLayout3i6",xe);class Ee extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,o){const p=this.length;return this.resize(p+1),this.emplace(p,e,r,o)}emplace(e,r,o,p){const y=4*e;return this.uint32[2*e+0]=r,this.uint16[y+2]=o,this.uint16[y+3]=p,e}}Ee.prototype.bytesPerElement=8,Rt("StructArrayLayout1ul2ui8",Ee);class Oe extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,r)}emplace(e,r,o){const p=2*e;return this.uint16[p+0]=r,this.uint16[p+1]=o,e}}Oe.prototype.bytesPerElement=4,Rt("StructArrayLayout2ui4",Oe);class he extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint16[1*e+0]=r,e}}he.prototype.bytesPerElement=2,Rt("StructArrayLayout1ui2",he);class Ge extends Er{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,o,p){const y=this.length;return this.resize(y+1),this.emplace(y,e,r,o,p)}emplace(e,r,o,p,y){const w=4*e;return this.float32[w+0]=r,this.float32[w+1]=o,this.float32[w+2]=p,this.float32[w+3]=y,e}}Ge.prototype.bytesPerElement=16,Rt("StructArrayLayout4f16",Ge);class Fe extends Vs{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new Qe(this.anchorPointX,this.anchorPointY)}}Fe.prototype.size=20;class et extends L{get(e){return new Fe(this,e)}}Rt("CollisionBoxArray",et);class it extends Vs{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(e){this._structArray.uint8[this._pos1+37]=e}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(e){this._structArray.uint8[this._pos1+38]=e}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(e){this._structArray.uint32[this._pos4+10]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}it.prototype.size=48;class bt extends le{get(e){return new it(this,e)}}Rt("PlacedSymbolArray",bt);class Ze extends Vs{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(e){this._structArray.uint32[this._pos4+12]=e}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get textOffset0(){return this._structArray.float32[this._pos4+14]}get textOffset1(){return this._structArray.float32[this._pos4+15]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+16]}}Ze.prototype.size=68;class Vt extends ne{get(e){return new Ze(this,e)}}Rt("SymbolInstanceArray",Vt);class Dt extends ae{getoffsetX(e){return this.float32[1*e+0]}}Rt("GlyphOffsetArray",Dt);class Wt extends xe{getx(e){return this.int16[3*e+0]}gety(e){return this.int16[3*e+1]}gettileUnitDistanceFromAnchor(e){return this.int16[3*e+2]}}Rt("SymbolLineVertexArray",Wt);class Si extends Vs{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}Si.prototype.size=8;class Pi extends Ee{get(e){return new Si(this,e)}}Rt("FeatureIndexArray",Pi);class hi extends to{}class er extends to{}class tr extends to{}class Ni extends t{}class Gi extends s{}class ir extends l{}class Wr extends m{}class ms extends b{}class ts extends E{}class gs extends D{}class Ns extends R{}class Nn extends X{}class wn extends H{}class Ss extends Oe{}const ga=Lr([{name:"a_pos",components:2,type:"Int16"}],4),{members:Rr}=ga;class ki{constructor(e=[]){this.segments=e}prepareSegment(e,r,o,p){let y=this.segments[this.segments.length-1];return e>ki.MAX_VERTEX_ARRAY_LENGTH&&U(`Max vertices per segment is ${ki.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!y||y.vertexLength+e>ki.MAX_VERTEX_ARRAY_LENGTH||y.sortKey!==p)&&(y={vertexOffset:r.length,primitiveOffset:o.length,vertexLength:0,primitiveLength:0},p!==void 0&&(y.sortKey=p),this.segments.push(y)),y}get(){return this.segments}destroy(){for(const e of this.segments)for(const r in e.vaos)e.vaos[r].destroy()}static simpleSegment(e,r,o,p){return new ki([{vertexOffset:e,primitiveOffset:r,vertexLength:o,primitiveLength:p,vaos:{},sortKey:0}])}}function Hi(i,e){return 256*(i=a(Math.floor(i),0,255))+a(Math.floor(e),0,255)}ki.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Rt("SegmentVector",ki);const $r=Lr([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var qr={exports:{}},vr={exports:{}};vr.exports=function(i,e){var r,o,p,y,w,P,k,F;for(o=i.length-(r=3&i.length),p=e,w=3432918353,P=461845907,F=0;F<o;)k=255&i.charCodeAt(F)|(255&i.charCodeAt(++F))<<8|(255&i.charCodeAt(++F))<<16|(255&i.charCodeAt(++F))<<24,++F,p=27492+(65535&(y=5*(65535&(p=(p^=k=(65535&(k=(k=(65535&k)*w+(((k>>>16)*w&65535)<<16)&4294967295)<<15|k>>>17))*P+(((k>>>16)*P&65535)<<16)&4294967295)<<13|p>>>19))+((5*(p>>>16)&65535)<<16)&4294967295))+((58964+(y>>>16)&65535)<<16);switch(k=0,r){case 3:k^=(255&i.charCodeAt(F+2))<<16;case 2:k^=(255&i.charCodeAt(F+1))<<8;case 1:p^=k=(65535&(k=(k=(65535&(k^=255&i.charCodeAt(F)))*w+(((k>>>16)*w&65535)<<16)&4294967295)<<15|k>>>17))*P+(((k>>>16)*P&65535)<<16)&4294967295}return p^=i.length,p=2246822507*(65535&(p^=p>>>16))+((2246822507*(p>>>16)&65535)<<16)&4294967295,p=3266489909*(65535&(p^=p>>>13))+((3266489909*(p>>>16)&65535)<<16)&4294967295,(p^=p>>>16)>>>0};var Gn={exports:{}};Gn.exports=function(i,e){for(var r,o=i.length,p=e^o,y=0;o>=4;)r=1540483477*(65535&(r=255&i.charCodeAt(y)|(255&i.charCodeAt(++y))<<8|(255&i.charCodeAt(++y))<<16|(255&i.charCodeAt(++y))<<24))+((1540483477*(r>>>16)&65535)<<16),p=1540483477*(65535&p)+((1540483477*(p>>>16)&65535)<<16)^(r=1540483477*(65535&(r^=r>>>24))+((1540483477*(r>>>16)&65535)<<16)),o-=4,++y;switch(o){case 3:p^=(255&i.charCodeAt(y+2))<<16;case 2:p^=(255&i.charCodeAt(y+1))<<8;case 1:p=1540483477*(65535&(p^=255&i.charCodeAt(y)))+((1540483477*(p>>>16)&65535)<<16)}return p=1540483477*(65535&(p^=p>>>13))+((1540483477*(p>>>16)&65535)<<16),(p^=p>>>15)>>>0};var io=vr.exports,ja=Gn.exports;qr.exports=io,qr.exports.murmur3=io,qr.exports.murmur2=ja;class Po{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(e,r,o,p){this.ids.push(_l(e)),this.positions.push(r,o,p)}getPositions(e){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const r=_l(e);let o=0,p=this.ids.length-1;for(;o<p;){const w=o+p>>1;this.ids[w]>=r?p=w:o=w+1}const y=[];for(;this.ids[o]===r;)y.push({index:this.positions[3*o],start:this.positions[3*o+1],end:this.positions[3*o+2]}),o++;return y}static serialize(e,r){const o=new Float64Array(e.ids),p=new Uint32Array(e.positions);return Va(o,p,0,o.length-1),r&&r.push(o.buffer,p.buffer),{ids:o,positions:p}}static deserialize(e){const r=new Po;return r.ids=e.ids,r.positions=e.positions,r.indexed=!0,r}}function _l(i){const e=+i;return!isNaN(e)&&e<=Number.MAX_SAFE_INTEGER?e:qr.exports(String(i))}function Va(i,e,r,o){for(;r<o;){const p=i[r+o>>1];let y=r-1,w=o+1;for(;;){do y++;while(i[y]<p);do w--;while(i[w]>p);if(y>=w)break;Gs(i,y,w),Gs(e,3*y,3*w),Gs(e,3*y+1,3*w+1),Gs(e,3*y+2,3*w+2)}w-r<o-w?(Va(i,e,r,w),r=w+1):(Va(i,e,w+1,o),o=w)}}function Gs(i,e,r){const o=i[e];i[e]=i[r],i[r]=o}Rt("FeaturePositionMap",Po);class ro{constructor(e,r){this.gl=e.gl,this.location=r}}class no extends ro{constructor(e,r){super(e,r),this.current=0}set(e){this.current!==e&&(this.current=e,this.gl.uniform1f(this.location,e))}}class _a extends ro{constructor(e,r){super(e,r),this.current=[0,0,0,0]}set(e){e[0]===this.current[0]&&e[1]===this.current[1]&&e[2]===this.current[2]&&e[3]===this.current[3]||(this.current=e,this.gl.uniform4f(this.location,e[0],e[1],e[2],e[3]))}}class $c extends ro{constructor(e,r){super(e,r),this.current=te.transparent}set(e){e.r===this.current.r&&e.g===this.current.g&&e.b===this.current.b&&e.a===this.current.a||(this.current=e,this.gl.uniform4f(this.location,e.r,e.g,e.b,e.a))}}const Au=new Float32Array(16);function ql(i){return[Hi(255*i.r,255*i.g),Hi(255*i.b,255*i.a)]}class Na{constructor(e,r,o){this.value=e,this.uniformNames=r.map(p=>`u_${p}`),this.type=o}setUniform(e,r,o){e.set(o.constantOr(this.value))}getBinding(e,r,o){return this.type==="color"?new $c(e,r):new no(e,r)}}class ya{constructor(e,r){this.uniformNames=r.map(o=>`u_${o}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(e,r){this.pixelRatioFrom=r.pixelRatio,this.pixelRatioTo=e.pixelRatio,this.patternFrom=r.tlbr,this.patternTo=e.tlbr}setUniform(e,r,o,p){const y=p==="u_pattern_to"?this.patternTo:p==="u_pattern_from"?this.patternFrom:p==="u_pixel_ratio_to"?this.pixelRatioTo:p==="u_pixel_ratio_from"?this.pixelRatioFrom:null;y&&e.set(y)}getBinding(e,r,o){return o.substr(0,9)==="u_pattern"?new _a(e,r):new no(e,r)}}class so{constructor(e,r,o,p){this.expression=e,this.type=o,this.maxValue=0,this.paintVertexAttributes=r.map(y=>({name:`a_${y}`,type:"Float32",components:o==="color"?2:1,offset:0})),this.paintVertexArray=new p}populatePaintArray(e,r,o,p,y){const w=this.paintVertexArray.length,P=this.expression.evaluate(new yr(0),r,{},p,[],y);this.paintVertexArray.resize(e),this._setPaintValue(w,e,P)}updatePaintArray(e,r,o,p){const y=this.expression.evaluate({zoom:0},o,p);this._setPaintValue(e,r,y)}_setPaintValue(e,r,o){if(this.type==="color"){const p=ql(o);for(let y=e;y<r;y++)this.paintVertexArray.emplace(y,p[0],p[1])}else{for(let p=e;p<r;p++)this.paintVertexArray.emplace(p,o);this.maxValue=Math.max(this.maxValue,Math.abs(o))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ts{constructor(e,r,o,p,y,w){this.expression=e,this.uniformNames=r.map(P=>`u_${P}_t`),this.type=o,this.useIntegerZoom=p,this.zoom=y,this.maxValue=0,this.paintVertexAttributes=r.map(P=>({name:`a_${P}`,type:"Float32",components:o==="color"?4:2,offset:0})),this.paintVertexArray=new w}populatePaintArray(e,r,o,p,y){const w=this.expression.evaluate(new yr(this.zoom),r,{},p,[],y),P=this.expression.evaluate(new yr(this.zoom+1),r,{},p,[],y),k=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(k,e,w,P)}updatePaintArray(e,r,o,p){const y=this.expression.evaluate({zoom:this.zoom},o,p),w=this.expression.evaluate({zoom:this.zoom+1},o,p);this._setPaintValue(e,r,y,w)}_setPaintValue(e,r,o,p){if(this.type==="color"){const y=ql(o),w=ql(p);for(let P=e;P<r;P++)this.paintVertexArray.emplace(P,y[0],y[1],w[0],w[1])}else{for(let y=e;y<r;y++)this.paintVertexArray.emplace(y,o,p);this.maxValue=Math.max(this.maxValue,Math.abs(o),Math.abs(p))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,r){const o=this.useIntegerZoom?Math.floor(r.zoom):r.zoom,p=a(this.expression.interpolationFactor(o,this.zoom,this.zoom+1),0,1);e.set(p)}getBinding(e,r,o){return new no(e,r)}}class Io{constructor(e,r,o,p,y,w){this.expression=e,this.type=r,this.useIntegerZoom=o,this.zoom=p,this.layerId=w,this.zoomInPaintVertexArray=new y,this.zoomOutPaintVertexArray=new y}populatePaintArray(e,r,o){const p=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(e),this.zoomOutPaintVertexArray.resize(e),this._setPaintValues(p,e,r.patterns&&r.patterns[this.layerId],o)}updatePaintArray(e,r,o,p,y){this._setPaintValues(e,r,o.patterns&&o.patterns[this.layerId],y)}_setPaintValues(e,r,o,p){if(!p||!o)return;const{min:y,mid:w,max:P}=o,k=p[y],F=p[w],j=p[P];if(k&&F&&j)for(let N=e;N<r;N++)this.zoomInPaintVertexArray.emplace(N,F.tl[0],F.tl[1],F.br[0],F.br[1],k.tl[0],k.tl[1],k.br[0],k.br[1],F.pixelRatio,k.pixelRatio),this.zoomOutPaintVertexArray.emplace(N,F.tl[0],F.tl[1],F.br[0],F.br[1],j.tl[0],j.tl[1],j.br[0],j.br[1],F.pixelRatio,j.pixelRatio)}upload(e){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=e.createVertexBuffer(this.zoomInPaintVertexArray,$r.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=e.createVertexBuffer(this.zoomOutPaintVertexArray,$r.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class qc{constructor(e,r,o){this.binders={},this._buffers=[];const p=[];for(const y in e.paint._values){if(!o(y))continue;const w=e.paint.get(y);if(!(w instanceof fs&&Ji(w.property.specification)))continue;const P=Mu(y,e.type),k=w.value,F=w.property.specification.type,j=w.property.useIntegerZoom,N=w.property.specification["property-type"],W=N==="cross-faded"||N==="cross-faded-data-driven";if(k.kind==="constant")this.binders[y]=W?new ya(k.value,P):new Na(k.value,P,F),p.push(`/u_${y}`);else if(k.kind==="source"||W){const Z=Yc(y,F,"source");this.binders[y]=W?new Io(k,F,j,r,Z,e.id):new so(k,P,F,Z),p.push(`/a_${y}`)}else{const Z=Yc(y,F,"composite");this.binders[y]=new Ts(k,P,F,j,r,Z),p.push(`/z_${y}`)}}this.cacheKey=p.sort().join("")}getMaxValue(e){const r=this.binders[e];return r instanceof so||r instanceof Ts?r.maxValue:0}populatePaintArrays(e,r,o,p,y){for(const w in this.binders){const P=this.binders[w];(P instanceof so||P instanceof Ts||P instanceof Io)&&P.populatePaintArray(e,r,o,p,y)}}setConstantPatternPositions(e,r){for(const o in this.binders){const p=this.binders[o];p instanceof ya&&p.setConstantPatternPositions(e,r)}}updatePaintArrays(e,r,o,p,y){let w=!1;for(const P in e){const k=r.getPositions(P);for(const F of k){const j=o.feature(F.index);for(const N in this.binders){const W=this.binders[N];if((W instanceof so||W instanceof Ts||W instanceof Io)&&W.expression.isStateDependent===!0){const Z=p.paint.get(N);W.expression=Z.value,W.updatePaintArray(F.start,F.end,j,e[P],y),w=!0}}}}return w}defines(){const e=[];for(const r in this.binders){const o=this.binders[r];(o instanceof Na||o instanceof ya)&&e.push(...o.uniformNames.map(p=>`#define HAS_UNIFORM_${p}`))}return e}getBinderAttributes(){const e=[];for(const r in this.binders){const o=this.binders[r];if(o instanceof so||o instanceof Ts)for(let p=0;p<o.paintVertexAttributes.length;p++)e.push(o.paintVertexAttributes[p].name);else if(o instanceof Io)for(let p=0;p<$r.members.length;p++)e.push($r.members[p].name)}return e}getBinderUniforms(){const e=[];for(const r in this.binders){const o=this.binders[r];if(o instanceof Na||o instanceof ya||o instanceof Ts)for(const p of o.uniformNames)e.push(p)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e,r){const o=[];for(const p in this.binders){const y=this.binders[p];if(y instanceof Na||y instanceof ya||y instanceof Ts){for(const w of y.uniformNames)if(r[w]){const P=y.getBinding(e,r[w],w);o.push({name:w,property:p,binding:P})}}}return o}setUniforms(e,r,o,p){for(const{name:y,property:w,binding:P}of r)this.binders[w].setUniform(P,p,o.get(w),y)}updatePaintBuffers(e){this._buffers=[];for(const r in this.binders){const o=this.binders[r];if(e&&o instanceof Io){const p=e.fromScale===2?o.zoomInPaintVertexBuffer:o.zoomOutPaintVertexBuffer;p&&this._buffers.push(p)}else(o instanceof so||o instanceof Ts)&&o.paintVertexBuffer&&this._buffers.push(o.paintVertexBuffer)}}upload(e){for(const r in this.binders){const o=this.binders[r];(o instanceof so||o instanceof Ts||o instanceof Io)&&o.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const r=this.binders[e];(r instanceof so||r instanceof Ts||r instanceof Io)&&r.destroy()}}}class ea{constructor(e,r,o=()=>!0){this.programConfigurations={};for(const p of e)this.programConfigurations[p.id]=new qc(p,r,o);this.needsUpload=!1,this._featureMap=new Po,this._bufferOffset=0}populatePaintArrays(e,r,o,p,y,w){for(const P in this.programConfigurations)this.programConfigurations[P].populatePaintArrays(e,r,p,y,w);r.id!==void 0&&this._featureMap.add(r.id,o,this._bufferOffset,e),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,r,o,p){for(const y of o)this.needsUpload=this.programConfigurations[y.id].updatePaintArrays(e,this._featureMap,r,y,p)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const r in this.programConfigurations)this.programConfigurations[r].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}function Mu(i,e){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[i]||[i.replace(`${e}-`,"").replace(/-/g,"_")]}function Yc(i,e,r){const o={color:{source:l,composite:Ge},number:{source:ae,composite:l}},p=function(y){return{"line-pattern":{source:Wr,composite:Wr},"fill-pattern":{source:Wr,composite:Wr},"fill-extrusion-pattern":{source:Wr,composite:Wr}}[y]}(i);return p&&p[r]||o[e][r]}Rt("ConstantBinder",Na),Rt("CrossFadedConstantBinder",ya),Rt("SourceExpressionBinder",so),Rt("CrossFadedCompositeBinder",Io),Rt("CompositeExpressionBinder",Ts),Rt("ProgramConfiguration",qc,{omit:["_buffers"]}),Rt("ProgramConfigurationSet",ea);var Br=8192;const Yl=Math.pow(2,14)-1,Hc=-Yl-1;function ta(i){const e=Br/i.extent,r=i.loadGeometry();for(let o=0;o<r.length;o++){const p=r[o];for(let y=0;y<p.length;y++){const w=p[y],P=Math.round(w.x*e),k=Math.round(w.y*e);w.x=a(P,Hc,Yl),w.y=a(k,Hc,Yl),(P<w.x||P>w.x+1||k<w.y||k>w.y+1)&&U("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return r}function ia(i,e){return{type:i.type,id:i.id,properties:i.properties,geometry:e?ta(i):[]}}function yl(i,e,r,o,p){i.emplaceBack(2*e+(o+1)/2,2*r+(p+1)/2)}class Hl{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new er,this.indexArray=new wn,this.segments=new ki,this.programConfigurations=new ea(e.layers,e.zoom),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,o){const p=this.layers[0],y=[];let w=null,P=!1;p.type==="circle"&&(w=p.layout.get("circle-sort-key"),P=!w.isConstant());for(const{feature:k,id:F,index:j,sourceLayerIndex:N}of e){const W=this.layers[0]._featureFilter.needGeometry,Z=ia(k,W);if(!this.layers[0]._featureFilter.filter(new yr(this.zoom),Z,o))continue;const K=P?w.evaluate(Z,{},o):void 0,me={id:F,properties:k.properties,type:k.type,sourceLayerIndex:N,index:j,geometry:W?Z.geometry:ta(k),patterns:{},sortKey:K};y.push(me)}P&&y.sort((k,F)=>k.sortKey-F.sortKey);for(const k of y){const{geometry:F,index:j,sourceLayerIndex:N}=k,W=e[j].feature;this.addFeature(k,F,j,o),r.featureIndex.insert(W,F,j,N,this.index)}}update(e,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Rr),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,r,o,p){for(const y of r)for(const w of y){const P=w.x,k=w.y;if(P<0||P>=Br||k<0||k>=Br)continue;const F=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),j=F.vertexLength;yl(this.layoutVertexArray,P,k,-1,-1),yl(this.layoutVertexArray,P,k,1,-1),yl(this.layoutVertexArray,P,k,1,1),yl(this.layoutVertexArray,P,k,-1,1),this.indexArray.emplaceBack(j,j+1,j+2),this.indexArray.emplaceBack(j,j+3,j+2),F.vertexLength+=4,F.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,{},p)}}function Zc(i,e){for(let r=0;r<i.length;r++)if(va(e,i[r]))return!0;for(let r=0;r<e.length;r++)if(va(i,e[r]))return!0;return!!Zl(i,e)}function ku(i,e,r){return!!va(i,e)||!!Kl(e,i,r)}function Kc(i,e){if(i.length===1)return Qc(e,i[0]);for(let r=0;r<e.length;r++){const o=e[r];for(let p=0;p<o.length;p++)if(va(i,o[p]))return!0}for(let r=0;r<i.length;r++)if(Qc(e,i[r]))return!0;for(let r=0;r<e.length;r++)if(Zl(i,e[r]))return!0;return!1}function Du(i,e,r){if(i.length>1){if(Zl(i,e))return!0;for(let o=0;o<e.length;o++)if(Kl(e[o],i,r))return!0}for(let o=0;o<i.length;o++)if(Kl(i[o],e,r))return!0;return!1}function Zl(i,e){if(i.length===0||e.length===0)return!1;for(let r=0;r<i.length-1;r++){const o=i[r],p=i[r+1];for(let y=0;y<e.length-1;y++)if(Ou(o,p,e[y],e[y+1]))return!0}return!1}function Ou(i,e,r,o){return Y(i,r,o)!==Y(e,r,o)&&Y(i,e,r)!==Y(i,e,o)}function Kl(i,e,r){const o=r*r;if(e.length===1)return i.distSqr(e[0])<o;for(let p=1;p<e.length;p++)if(Jc(i,e[p-1],e[p])<o)return!0;return!1}function Jc(i,e,r){const o=e.distSqr(r);if(o===0)return i.distSqr(e);const p=((i.x-e.x)*(r.x-e.x)+(i.y-e.y)*(r.y-e.y))/o;return i.distSqr(p<0?e:p>1?r:r.sub(e)._mult(p)._add(e))}function Qc(i,e){let r,o,p,y=!1;for(let w=0;w<i.length;w++){r=i[w];for(let P=0,k=r.length-1;P<r.length;k=P++)o=r[P],p=r[k],o.y>e.y!=p.y>e.y&&e.x<(p.x-o.x)*(e.y-o.y)/(p.y-o.y)+o.x&&(y=!y)}return y}function va(i,e){let r=!1;for(let o=0,p=i.length-1;o<i.length;p=o++){const y=i[o],w=i[p];y.y>e.y!=w.y>e.y&&e.x<(w.x-y.x)*(e.y-y.y)/(w.y-y.y)+y.x&&(r=!r)}return r}function Lu(i,e,r){const o=r[0],p=r[2];if(i.x<o.x&&e.x<o.x||i.x>p.x&&e.x>p.x||i.y<o.y&&e.y<o.y||i.y>p.y&&e.y>p.y)return!1;const y=Y(i,e,r[0]);return y!==Y(i,e,r[1])||y!==Y(i,e,r[2])||y!==Y(i,e,r[3])}function Ga(i,e,r){const o=e.paint.get(i).value;return o.kind==="constant"?o.value:r.programConfigurations.get(e.id).getMaxValue(i)}function vl(i){return Math.sqrt(i[0]*i[0]+i[1]*i[1])}function xl(i,e,r,o,p){if(!e[0]&&!e[1])return i;const y=Qe.convert(e)._mult(p);r==="viewport"&&y._rotate(-o);const w=[];for(let P=0;P<i.length;P++)w.push(i[P].sub(y));return w}Rt("CircleBucket",Hl,{omit:["layers"]});const zu=new Qr({"circle-sort-key":new pi(Ue.layout_circle["circle-sort-key"])});var Fu={paint:new Qr({"circle-radius":new pi(Ue.paint_circle["circle-radius"]),"circle-color":new pi(Ue.paint_circle["circle-color"]),"circle-blur":new pi(Ue.paint_circle["circle-blur"]),"circle-opacity":new pi(Ue.paint_circle["circle-opacity"]),"circle-translate":new ni(Ue.paint_circle["circle-translate"]),"circle-translate-anchor":new ni(Ue.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ni(Ue.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ni(Ue.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new pi(Ue.paint_circle["circle-stroke-width"]),"circle-stroke-color":new pi(Ue.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new pi(Ue.paint_circle["circle-stroke-opacity"])}),layout:zu},Cn=1e-6,Sn=typeof Float32Array<"u"?Float32Array:Array;function eh(){var i=new Sn(9);return Sn!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[5]=0,i[6]=0,i[7]=0),i[0]=1,i[4]=1,i[8]=1,i}function Jl(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function th(i,e,r){var o=e[0],p=e[1],y=e[2],w=e[3],P=e[4],k=e[5],F=e[6],j=e[7],N=e[8],W=e[9],Z=e[10],K=e[11],me=e[12],ue=e[13],Me=e[14],Xe=e[15],Pe=r[0],Be=r[1],ht=r[2],ct=r[3];return i[0]=Pe*o+Be*P+ht*N+ct*me,i[1]=Pe*p+Be*k+ht*W+ct*ue,i[2]=Pe*y+Be*F+ht*Z+ct*Me,i[3]=Pe*w+Be*j+ht*K+ct*Xe,i[4]=(Pe=r[4])*o+(Be=r[5])*P+(ht=r[6])*N+(ct=r[7])*me,i[5]=Pe*p+Be*k+ht*W+ct*ue,i[6]=Pe*y+Be*F+ht*Z+ct*Me,i[7]=Pe*w+Be*j+ht*K+ct*Xe,i[8]=(Pe=r[8])*o+(Be=r[9])*P+(ht=r[10])*N+(ct=r[11])*me,i[9]=Pe*p+Be*k+ht*W+ct*ue,i[10]=Pe*y+Be*F+ht*Z+ct*Me,i[11]=Pe*w+Be*j+ht*K+ct*Xe,i[12]=(Pe=r[12])*o+(Be=r[13])*P+(ht=r[14])*N+(ct=r[15])*me,i[13]=Pe*p+Be*k+ht*W+ct*ue,i[14]=Pe*y+Be*F+ht*Z+ct*Me,i[15]=Pe*w+Be*j+ht*K+ct*Xe,i}Math.hypot||(Math.hypot=function(){for(var i=0,e=arguments.length;e--;)i+=arguments[e]*arguments[e];return Math.sqrt(i)});var Xa,Ru=th;function ih(){var i=new Sn(3);return Sn!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function rh(i,e,r){var o=new Sn(3);return o[0]=i,o[1]=e,o[2]=r,o}function bl(i,e,r){var o=e[0],p=e[1],y=e[2],w=e[3];return i[0]=r[0]*o+r[4]*p+r[8]*y+r[12]*w,i[1]=r[1]*o+r[5]*p+r[9]*y+r[13]*w,i[2]=r[2]*o+r[6]*p+r[10]*y+r[14]*w,i[3]=r[3]*o+r[7]*p+r[11]*y+r[15]*w,i}function nh(){var i=new Sn(4);return Sn!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i[3]=1,i}function sh(i,e){const r=bl([],[i.x,i.y,0,1],e);return new Qe(r[0]/r[3],r[1]/r[3])}ih(),Xa=new Sn(4),Sn!=Float32Array&&(Xa[0]=0,Xa[1]=0,Xa[2]=0,Xa[3]=0),ih(),rh(1,0,0),rh(0,1,0),nh(),nh(),eh(),function(){var i;i=new Sn(2),Sn!=Float32Array&&(i[0]=0,i[1]=0)}();class oh extends Hl{}Rt("HeatmapBucket",oh,{omit:["layers"]});var Bu={paint:new Qr({"heatmap-radius":new pi(Ue.paint_heatmap["heatmap-radius"]),"heatmap-weight":new pi(Ue.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ni(Ue.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Us(Ue.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ni(Ue.paint_heatmap["heatmap-opacity"])})};function Ql(i,{width:e,height:r},o,p){if(p){if(p instanceof Uint8ClampedArray)p=new Uint8Array(p.buffer);else if(p.length!==e*r*o)throw new RangeError(`mismatched image size. expected: ${p.length} but got: ${e*r*o}`)}else p=new Uint8Array(e*r*o);return i.width=e,i.height=r,i.data=p,i}function ah(i,{width:e,height:r},o){if(e===i.width&&r===i.height)return;const p=Ql({},{width:e,height:r},o);ec(i,p,{x:0,y:0},{x:0,y:0},{width:Math.min(i.width,e),height:Math.min(i.height,r)},o),i.width=e,i.height=r,i.data=p.data}function ec(i,e,r,o,p,y){if(p.width===0||p.height===0)return e;if(p.width>i.width||p.height>i.height||r.x>i.width-p.width||r.y>i.height-p.height)throw new RangeError("out of range source coordinates for image copy");if(p.width>e.width||p.height>e.height||o.x>e.width-p.width||o.y>e.height-p.height)throw new RangeError("out of range destination coordinates for image copy");const w=i.data,P=e.data;if(w===P)throw new Error("srcData equals dstData, so image is already copied");for(let k=0;k<p.height;k++){const F=((r.y+k)*i.width+r.x)*y,j=((o.y+k)*e.width+o.x)*y;for(let N=0;N<p.width*y;N++)P[j+N]=w[F+N]}return e}class Wa{constructor(e,r){Ql(this,e,1,r)}resize(e){ah(this,e,1)}clone(){return new Wa({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,o,p,y){ec(e,r,o,p,y,1)}}class is{constructor(e,r){Ql(this,e,4,r)}resize(e){ah(this,e,4)}replace(e,r){r?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new is({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,o,p,y){ec(e,r,o,p,y,4)}}function lh(i){const e={},r=i.resolution||256,o=i.clips?i.clips.length:1,p=i.image||new is({width:r,height:o});if(Math.log(r)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${r}`);const y=(w,P,k)=>{e[i.evaluationKey]=k;const F=i.expression.evaluate(e);p.data[w+P+0]=Math.floor(255*F.r/F.a),p.data[w+P+1]=Math.floor(255*F.g/F.a),p.data[w+P+2]=Math.floor(255*F.b/F.a),p.data[w+P+3]=Math.floor(255*F.a)};if(i.clips)for(let w=0,P=0;w<o;++w,P+=4*r)for(let k=0,F=0;k<r;k++,F+=4){const j=k/(r-1),{start:N,end:W}=i.clips[w];y(P,F,N*(1-j)+W*j)}else for(let w=0,P=0;w<r;w++,P+=4)y(0,P,w/(r-1));return p}Rt("AlphaImage",Wa),Rt("RGBAImage",is);var Uu={paint:new Qr({"hillshade-illumination-direction":new ni(Ue.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ni(Ue.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ni(Ue.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ni(Ue.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ni(Ue.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ni(Ue.paint_hillshade["hillshade-accent-color"])})};const ju=Lr([{name:"a_pos",components:2,type:"Int16"}],4),{members:Vu}=ju;var wl={exports:{}};function Cl(i,e,r){r=r||2;var o,p,y,w,P,k,F,j=e&&e.length,N=j?e[0]*r:i.length,W=ch(i,0,N,r,!0),Z=[];if(!W||W.next===W.prev)return Z;if(j&&(W=function(me,ue,Me,Xe){var Pe,Be,ht,ct=[];for(Pe=0,Be=ue.length;Pe<Be;Pe++)(ht=ch(me,ue[Pe]*Xe,Pe<Be-1?ue[Pe+1]*Xe:me.length,Xe,!1))===ht.next&&(ht.steiner=!0),ct.push(Hu(ht));for(ct.sort($u),Pe=0;Pe<ct.length;Pe++)Me=qu(ct[Pe],Me);return Me}(i,e,W,r)),i.length>80*r){o=y=i[0],p=w=i[1];for(var K=r;K<N;K+=r)(P=i[K])<o&&(o=P),(k=i[K+1])<p&&(p=k),P>y&&(y=P),k>w&&(w=k);F=(F=Math.max(y-o,w-p))!==0?32767/F:0}return $a(W,Z,r,o,p,F,0),Z}function ch(i,e,r,o,p){var y,w;if(p===rc(i,e,r,o)>0)for(y=e;y<r;y+=o)w=dh(y,i[y],i[y+1],w);else for(y=r-o;y>=e;y-=o)w=dh(y,i[y],i[y+1],w);return w&&Sl(w,w.next)&&(Ya(w),w=w.next),w}function ra(i,e){if(!i)return i;e||(e=i);var r,o=i;do if(r=!1,o.steiner||!Sl(o,o.next)&&Ar(o.prev,o,o.next)!==0)o=o.next;else{if(Ya(o),(o=e=o.prev)===o.next)break;r=!0}while(r||o!==e);return e}function $a(i,e,r,o,p,y,w){if(i){!w&&y&&function(j,N,W,Z){var K=j;do K.z===0&&(K.z=tc(K.x,K.y,N,W,Z)),K.prevZ=K.prev,K.nextZ=K.next,K=K.next;while(K!==j);K.prevZ.nextZ=null,K.prevZ=null,function(me){var ue,Me,Xe,Pe,Be,ht,ct,$t,Qt=1;do{for(Me=me,me=null,Be=null,ht=0;Me;){for(ht++,Xe=Me,ct=0,ue=0;ue<Qt&&(ct++,Xe=Xe.nextZ);ue++);for($t=Qt;ct>0||$t>0&&Xe;)ct!==0&&($t===0||!Xe||Me.z<=Xe.z)?(Pe=Me,Me=Me.nextZ,ct--):(Pe=Xe,Xe=Xe.nextZ,$t--),Be?Be.nextZ=Pe:me=Pe,Pe.prevZ=Be,Be=Pe;Me=Xe}Be.nextZ=null,Qt*=2}while(ht>1)}(K)}(i,o,p,y);for(var P,k,F=i;i.prev!==i.next;)if(P=i.prev,k=i.next,y?Gu(i,o,p,y):Nu(i))e.push(P.i/r|0),e.push(i.i/r|0),e.push(k.i/r|0),Ya(i),i=k.next,F=k.next;else if((i=k)===F){w?w===1?$a(i=Xu(ra(i),e,r),e,r,o,p,y,2):w===2&&Wu(i,e,r,o,p,y):$a(ra(i),e,r,o,p,y,1);break}}}function Nu(i){var e=i.prev,r=i,o=i.next;if(Ar(e,r,o)>=0)return!1;for(var p=e.x,y=r.x,w=o.x,P=e.y,k=r.y,F=o.y,j=p<y?p<w?p:w:y<w?y:w,N=P<k?P<F?P:F:k<F?k:F,W=p>y?p>w?p:w:y>w?y:w,Z=P>k?P>F?P:F:k>F?k:F,K=o.next;K!==e;){if(K.x>=j&&K.x<=W&&K.y>=N&&K.y<=Z&&xa(p,P,y,k,w,F,K.x,K.y)&&Ar(K.prev,K,K.next)>=0)return!1;K=K.next}return!0}function Gu(i,e,r,o){var p=i.prev,y=i,w=i.next;if(Ar(p,y,w)>=0)return!1;for(var P=p.x,k=y.x,F=w.x,j=p.y,N=y.y,W=w.y,Z=P<k?P<F?P:F:k<F?k:F,K=j<N?j<W?j:W:N<W?N:W,me=P>k?P>F?P:F:k>F?k:F,ue=j>N?j>W?j:W:N>W?N:W,Me=tc(Z,K,e,r,o),Xe=tc(me,ue,e,r,o),Pe=i.prevZ,Be=i.nextZ;Pe&&Pe.z>=Me&&Be&&Be.z<=Xe;){if(Pe.x>=Z&&Pe.x<=me&&Pe.y>=K&&Pe.y<=ue&&Pe!==p&&Pe!==w&&xa(P,j,k,N,F,W,Pe.x,Pe.y)&&Ar(Pe.prev,Pe,Pe.next)>=0||(Pe=Pe.prevZ,Be.x>=Z&&Be.x<=me&&Be.y>=K&&Be.y<=ue&&Be!==p&&Be!==w&&xa(P,j,k,N,F,W,Be.x,Be.y)&&Ar(Be.prev,Be,Be.next)>=0))return!1;Be=Be.nextZ}for(;Pe&&Pe.z>=Me;){if(Pe.x>=Z&&Pe.x<=me&&Pe.y>=K&&Pe.y<=ue&&Pe!==p&&Pe!==w&&xa(P,j,k,N,F,W,Pe.x,Pe.y)&&Ar(Pe.prev,Pe,Pe.next)>=0)return!1;Pe=Pe.prevZ}for(;Be&&Be.z<=Xe;){if(Be.x>=Z&&Be.x<=me&&Be.y>=K&&Be.y<=ue&&Be!==p&&Be!==w&&xa(P,j,k,N,F,W,Be.x,Be.y)&&Ar(Be.prev,Be,Be.next)>=0)return!1;Be=Be.nextZ}return!0}function Xu(i,e,r){var o=i;do{var p=o.prev,y=o.next.next;!Sl(p,y)&&hh(p,o,o.next,y)&&qa(p,y)&&qa(y,p)&&(e.push(p.i/r|0),e.push(o.i/r|0),e.push(y.i/r|0),Ya(o),Ya(o.next),o=i=y),o=o.next}while(o!==i);return ra(o)}function Wu(i,e,r,o,p,y){var w=i;do{for(var P=w.next.next;P!==w.prev;){if(w.i!==P.i&&Zu(w,P)){var k=uh(w,P);return w=ra(w,w.next),k=ra(k,k.next),$a(w,e,r,o,p,y,0),void $a(k,e,r,o,p,y,0)}P=P.next}w=w.next}while(w!==i)}function $u(i,e){return i.x-e.x}function qu(i,e){var r=function(p,y){var w,P=y,k=p.x,F=p.y,j=-1/0;do{if(F<=P.y&&F>=P.next.y&&P.next.y!==P.y){var N=P.x+(F-P.y)*(P.next.x-P.x)/(P.next.y-P.y);if(N<=k&&N>j&&(j=N,w=P.x<P.next.x?P:P.next,N===k))return w}P=P.next}while(P!==y);if(!w)return null;var W,Z=w,K=w.x,me=w.y,ue=1/0;P=w;do k>=P.x&&P.x>=K&&k!==P.x&&xa(F<me?k:j,F,K,me,F<me?j:k,F,P.x,P.y)&&(W=Math.abs(F-P.y)/(k-P.x),qa(P,p)&&(W<ue||W===ue&&(P.x>w.x||P.x===w.x&&Yu(w,P)))&&(w=P,ue=W)),P=P.next;while(P!==Z);return w}(i,e);if(!r)return e;var o=uh(r,i);return ra(o,o.next),ra(r,r.next)}function Yu(i,e){return Ar(i.prev,i,e.prev)<0&&Ar(e.next,i,i.next)<0}function tc(i,e,r,o,p){return(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=(i-r)*p|0)|i<<8))|i<<4))|i<<2))|i<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-o)*p|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Hu(i){var e=i,r=i;do(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next;while(e!==i);return r}function xa(i,e,r,o,p,y,w,P){return(p-w)*(e-P)>=(i-w)*(y-P)&&(i-w)*(o-P)>=(r-w)*(e-P)&&(r-w)*(y-P)>=(p-w)*(o-P)}function Zu(i,e){return i.next.i!==e.i&&i.prev.i!==e.i&&!function(r,o){var p=r;do{if(p.i!==r.i&&p.next.i!==r.i&&p.i!==o.i&&p.next.i!==o.i&&hh(p,p.next,r,o))return!0;p=p.next}while(p!==r);return!1}(i,e)&&(qa(i,e)&&qa(e,i)&&function(r,o){var p=r,y=!1,w=(r.x+o.x)/2,P=(r.y+o.y)/2;do p.y>P!=p.next.y>P&&p.next.y!==p.y&&w<(p.next.x-p.x)*(P-p.y)/(p.next.y-p.y)+p.x&&(y=!y),p=p.next;while(p!==r);return y}(i,e)&&(Ar(i.prev,i,e.prev)||Ar(i,e.prev,e))||Sl(i,e)&&Ar(i.prev,i,i.next)>0&&Ar(e.prev,e,e.next)>0)}function Ar(i,e,r){return(e.y-i.y)*(r.x-e.x)-(e.x-i.x)*(r.y-e.y)}function Sl(i,e){return i.x===e.x&&i.y===e.y}function hh(i,e,r,o){var p=El(Ar(i,e,r)),y=El(Ar(i,e,o)),w=El(Ar(r,o,i)),P=El(Ar(r,o,e));return p!==y&&w!==P||!(p!==0||!Tl(i,r,e))||!(y!==0||!Tl(i,o,e))||!(w!==0||!Tl(r,i,o))||!(P!==0||!Tl(r,e,o))}function Tl(i,e,r){return e.x<=Math.max(i.x,r.x)&&e.x>=Math.min(i.x,r.x)&&e.y<=Math.max(i.y,r.y)&&e.y>=Math.min(i.y,r.y)}function El(i){return i>0?1:i<0?-1:0}function qa(i,e){return Ar(i.prev,i,i.next)<0?Ar(i,e,i.next)>=0&&Ar(i,i.prev,e)>=0:Ar(i,e,i.prev)<0||Ar(i,i.next,e)<0}function uh(i,e){var r=new ic(i.i,i.x,i.y),o=new ic(e.i,e.x,e.y),p=i.next,y=e.prev;return i.next=e,e.prev=i,r.next=p,p.prev=r,o.next=r,r.prev=o,y.next=o,o.prev=y,o}function dh(i,e,r,o){var p=new ic(i,e,r);return o?(p.next=o.next,p.prev=o,o.next.prev=p,o.next=p):(p.prev=p,p.next=p),p}function Ya(i){i.next.prev=i.prev,i.prev.next=i.next,i.prevZ&&(i.prevZ.nextZ=i.nextZ),i.nextZ&&(i.nextZ.prevZ=i.prevZ)}function ic(i,e,r){this.i=i,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function rc(i,e,r,o){for(var p=0,y=e,w=r-o;y<r;y+=o)p+=(i[w]-i[y])*(i[y+1]+i[w+1]),w=y;return p}function Ku(i,e,r,o,p){fh(i,e,r||0,o||i.length-1,p||Ju)}function fh(i,e,r,o,p){for(;o>r;){if(o-r>600){var y=o-r+1,w=e-r+1,P=Math.log(y),k=.5*Math.exp(2*P/3),F=.5*Math.sqrt(P*k*(y-k)/y)*(w-y/2<0?-1:1);fh(i,e,Math.max(r,Math.floor(e-w*k/y+F)),Math.min(o,Math.floor(e+(y-w)*k/y+F)),p)}var j=i[e],N=r,W=o;for(Ha(i,r,e),p(i[o],j)>0&&Ha(i,r,o);N<W;){for(Ha(i,N,W),N++,W--;p(i[N],j)<0;)N++;for(;p(i[W],j)>0;)W--}p(i[r],j)===0?Ha(i,r,W):Ha(i,++W,o),W<=e&&(r=W+1),e<=W&&(o=W-1)}}function Ha(i,e,r){var o=i[e];i[e]=i[r],i[r]=o}function Ju(i,e){return i<e?-1:i>e?1:0}function nc(i,e){const r=i.length;if(r<=1)return[i];const o=[];let p,y;for(let w=0;w<r;w++){const P=oe(i[w]);P!==0&&(i[w].area=Math.abs(P),y===void 0&&(y=P<0),y===P<0?(p&&o.push(p),p=[i[w]]):p.push(i[w]))}if(p&&o.push(p),e>1)for(let w=0;w<o.length;w++)o[w].length<=e||(Ku(o[w],e,1,o[w].length-1,Qu),o[w]=o[w].slice(0,e));return o}function Qu(i,e){return e.area-i.area}function sc(i,e,r){const o=r.patternDependencies;let p=!1;for(const y of e){const w=y.paint.get(`${i}-pattern`);w.isConstant()||(p=!0);const P=w.constantOr(null);P&&(p=!0,o[P.to]=!0,o[P.from]=!0)}return p}function oc(i,e,r,o,p){const y=p.patternDependencies;for(const w of e){const P=w.paint.get(`${i}-pattern`).value;if(P.kind!=="constant"){let k=P.evaluate({zoom:o-1},r,{},p.availableImages),F=P.evaluate({zoom:o},r,{},p.availableImages),j=P.evaluate({zoom:o+1},r,{},p.availableImages);k=k&&k.name?k.name:k,F=F&&F.name?F.name:F,j=j&&j.name?j.name:j,y[k]=!0,y[F]=!0,y[j]=!0,r.patterns[w.id]={min:k,mid:F,max:j}}}return r}wl.exports=Cl,wl.exports.default=Cl,Cl.deviation=function(i,e,r,o){var p=e&&e.length,y=Math.abs(rc(i,0,p?e[0]*r:i.length,r));if(p)for(var w=0,P=e.length;w<P;w++)y-=Math.abs(rc(i,e[w]*r,w<P-1?e[w+1]*r:i.length,r));var k=0;for(w=0;w<o.length;w+=3){var F=o[w]*r,j=o[w+1]*r,N=o[w+2]*r;k+=Math.abs((i[F]-i[N])*(i[j+1]-i[F+1])-(i[F]-i[j])*(i[N+1]-i[F+1]))}return y===0&&k===0?0:Math.abs((k-y)/y)},Cl.flatten=function(i){for(var e=i[0][0].length,r={vertices:[],holes:[],dimensions:e},o=0,p=0;p<i.length;p++){for(var y=0;y<i[p].length;y++)for(var w=0;w<e;w++)r.vertices.push(i[p][y][w]);p>0&&r.holes.push(o+=i[p-1].length)}return r};class ac{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new tr,this.indexArray=new wn,this.indexArray2=new Ss,this.programConfigurations=new ea(e.layers,e.zoom),this.segments=new ki,this.segments2=new ki,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,o){this.hasPattern=sc("fill",this.layers,r);const p=this.layers[0].layout.get("fill-sort-key"),y=!p.isConstant(),w=[];for(const{feature:P,id:k,index:F,sourceLayerIndex:j}of e){const N=this.layers[0]._featureFilter.needGeometry,W=ia(P,N);if(!this.layers[0]._featureFilter.filter(new yr(this.zoom),W,o))continue;const Z=y?p.evaluate(W,{},o,r.availableImages):void 0,K={id:k,properties:P.properties,type:P.type,sourceLayerIndex:j,index:F,geometry:N?W.geometry:ta(P),patterns:{},sortKey:Z};w.push(K)}y&&w.sort((P,k)=>P.sortKey-k.sortKey);for(const P of w){const{geometry:k,index:F,sourceLayerIndex:j}=P;if(this.hasPattern){const N=oc("fill",this.layers,P,this.zoom,r);this.patternFeatures.push(N)}else this.addFeature(P,k,F,o,{});r.featureIndex.insert(e[F].feature,k,F,j,this.index)}}update(e,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,o)}addFeatures(e,r,o){for(const p of this.patternFeatures)this.addFeature(p,p.geometry,p.index,r,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Vu),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,r,o,p,y){for(const w of nc(r,500)){let P=0;for(const Z of w)P+=Z.length;const k=this.segments.prepareSegment(P,this.layoutVertexArray,this.indexArray),F=k.vertexLength,j=[],N=[];for(const Z of w){if(Z.length===0)continue;Z!==w[0]&&N.push(j.length/2);const K=this.segments2.prepareSegment(Z.length,this.layoutVertexArray,this.indexArray2),me=K.vertexLength;this.layoutVertexArray.emplaceBack(Z[0].x,Z[0].y),this.indexArray2.emplaceBack(me+Z.length-1,me),j.push(Z[0].x),j.push(Z[0].y);for(let ue=1;ue<Z.length;ue++)this.layoutVertexArray.emplaceBack(Z[ue].x,Z[ue].y),this.indexArray2.emplaceBack(me+ue-1,me+ue),j.push(Z[ue].x),j.push(Z[ue].y);K.vertexLength+=Z.length,K.primitiveLength+=Z.length}const W=wl.exports(j,N);for(let Z=0;Z<W.length;Z+=3)this.indexArray.emplaceBack(F+W[Z],F+W[Z+1],F+W[Z+2]);k.vertexLength+=P,k.primitiveLength+=W.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,y,p)}}Rt("FillBucket",ac,{omit:["layers","patternFeatures"]});const ed=new Qr({"fill-sort-key":new pi(Ue.layout_fill["fill-sort-key"])});var td={paint:new Qr({"fill-antialias":new ni(Ue.paint_fill["fill-antialias"]),"fill-opacity":new pi(Ue.paint_fill["fill-opacity"]),"fill-color":new pi(Ue.paint_fill["fill-color"]),"fill-outline-color":new pi(Ue.paint_fill["fill-outline-color"]),"fill-translate":new ni(Ue.paint_fill["fill-translate"]),"fill-translate-anchor":new ni(Ue.paint_fill["fill-translate-anchor"]),"fill-pattern":new Eo(Ue.paint_fill["fill-pattern"])}),layout:ed};const id=Lr([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),rd=Lr([{name:"a_centroid",components:2,type:"Int16"}],4),{members:nd}=id;var Ao={},sd=Qe,ph=ba;function ba(i,e,r,o,p){this.properties={},this.extent=r,this.type=0,this._pbf=i,this._geometry=-1,this._keys=o,this._values=p,i.readFields(od,this,e)}function od(i,e,r){i==1?e.id=r.readVarint():i==2?function(o,p){for(var y=o.readVarint()+o.pos;o.pos<y;){var w=p._keys[o.readVarint()],P=p._values[o.readVarint()];p.properties[w]=P}}(r,e):i==3?e.type=r.readVarint():i==4&&(e._geometry=r.pos)}function ad(i){for(var e,r,o=0,p=0,y=i.length,w=y-1;p<y;w=p++)o+=((r=i[w]).x-(e=i[p]).x)*(e.y+r.y);return o}ba.types=["Unknown","Point","LineString","Polygon"],ba.prototype.loadGeometry=function(){var i=this._pbf;i.pos=this._geometry;for(var e,r=i.readVarint()+i.pos,o=1,p=0,y=0,w=0,P=[];i.pos<r;){if(p<=0){var k=i.readVarint();o=7&k,p=k>>3}if(p--,o===1||o===2)y+=i.readSVarint(),w+=i.readSVarint(),o===1&&(e&&P.push(e),e=[]),e.push(new sd(y,w));else{if(o!==7)throw new Error("unknown command "+o);e&&e.push(e[0].clone())}}return e&&P.push(e),P},ba.prototype.bbox=function(){var i=this._pbf;i.pos=this._geometry;for(var e=i.readVarint()+i.pos,r=1,o=0,p=0,y=0,w=1/0,P=-1/0,k=1/0,F=-1/0;i.pos<e;){if(o<=0){var j=i.readVarint();r=7&j,o=j>>3}if(o--,r===1||r===2)(p+=i.readSVarint())<w&&(w=p),p>P&&(P=p),(y+=i.readSVarint())<k&&(k=y),y>F&&(F=y);else if(r!==7)throw new Error("unknown command "+r)}return[w,k,P,F]},ba.prototype.toGeoJSON=function(i,e,r){var o,p,y=this.extent*Math.pow(2,r),w=this.extent*i,P=this.extent*e,k=this.loadGeometry(),F=ba.types[this.type];function j(Z){for(var K=0;K<Z.length;K++){var me=Z[K];Z[K]=[360*(me.x+w)/y-180,360/Math.PI*Math.atan(Math.exp((180-360*(me.y+P)/y)*Math.PI/180))-90]}}switch(this.type){case 1:var N=[];for(o=0;o<k.length;o++)N[o]=k[o][0];j(k=N);break;case 2:for(o=0;o<k.length;o++)j(k[o]);break;case 3:for(k=function(Z){var K=Z.length;if(K<=1)return[Z];for(var me,ue,Me=[],Xe=0;Xe<K;Xe++){var Pe=ad(Z[Xe]);Pe!==0&&(ue===void 0&&(ue=Pe<0),ue===Pe<0?(me&&Me.push(me),me=[Z[Xe]]):me.push(Z[Xe]))}return me&&Me.push(me),Me}(k),o=0;o<k.length;o++)for(p=0;p<k[o].length;p++)j(k[o][p])}k.length===1?k=k[0]:F="Multi"+F;var W={type:"Feature",geometry:{type:F,coordinates:k},properties:this.properties};return"id"in this&&(W.id=this.id),W};var ld=ph,mh=gh;function gh(i,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=i,this._keys=[],this._values=[],this._features=[],i.readFields(cd,this,e),this.length=this._features.length}function cd(i,e,r){i===15?e.version=r.readVarint():i===1?e.name=r.readString():i===5?e.extent=r.readVarint():i===2?e._features.push(r.pos):i===3?e._keys.push(r.readString()):i===4&&e._values.push(function(o){for(var p=null,y=o.readVarint()+o.pos;o.pos<y;){var w=o.readVarint()>>3;p=w===1?o.readString():w===2?o.readFloat():w===3?o.readDouble():w===4?o.readVarint64():w===5?o.readVarint():w===6?o.readSVarint():w===7?o.readBoolean():null}return p}(r))}gh.prototype.feature=function(i){if(i<0||i>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[i];var e=this._pbf.readVarint()+this._pbf.pos;return new ld(this._pbf,e,this.extent,this._keys,this._values)};var hd=mh;function ud(i,e,r){if(i===3){var o=new hd(r,r.readVarint()+r.pos);o.length&&(e[o.name]=o)}}Ao.VectorTile=function(i,e){this.layers=i.readFields(ud,{},e)},Ao.VectorTileFeature=ph,Ao.VectorTileLayer=mh;const dd=Ao.VectorTileFeature.types,lc=Math.pow(2,13);function Za(i,e,r,o,p,y,w,P){i.emplaceBack(e,r,2*Math.floor(o*lc)+w,p*lc*2,y*lc*2,Math.round(P))}class cc{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new Ni,this.centroidVertexArray=new hi,this.indexArray=new wn,this.programConfigurations=new ea(e.layers,e.zoom),this.segments=new ki,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,o){this.features=[],this.hasPattern=sc("fill-extrusion",this.layers,r);for(const{feature:p,id:y,index:w,sourceLayerIndex:P}of e){const k=this.layers[0]._featureFilter.needGeometry,F=ia(p,k);if(!this.layers[0]._featureFilter.filter(new yr(this.zoom),F,o))continue;const j={id:y,sourceLayerIndex:P,index:w,geometry:k?F.geometry:ta(p),properties:p.properties,type:p.type,patterns:{}};this.hasPattern?this.features.push(oc("fill-extrusion",this.layers,j,this.zoom,r)):this.addFeature(j,j.geometry,w,o,{}),r.featureIndex.insert(p,j.geometry,w,P,this.index,!0)}}addFeatures(e,r,o){for(const p of this.features){const{geometry:y}=p;this.addFeature(p,y,p.index,r,o)}}update(e,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,o)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,nd),this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,rd.members,!0),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(e,r,o,p,y){const w={x:0,y:0,vertexCount:0};for(const P of nc(r,500)){let k=0;for(const K of P)k+=K.length;let F=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);for(const K of P){if(K.length===0||pd(K))continue;let me=0;for(let ue=0;ue<K.length;ue++){const Me=K[ue];if(ue>=1){const Xe=K[ue-1];if(!fd(Me,Xe)){F.vertexLength+4>ki.MAX_VERTEX_ARRAY_LENGTH&&(F=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const Pe=Me.sub(Xe)._perp()._unit(),Be=Xe.dist(Me);me+Be>32768&&(me=0),Za(this.layoutVertexArray,Me.x,Me.y,Pe.x,Pe.y,0,0,me),Za(this.layoutVertexArray,Me.x,Me.y,Pe.x,Pe.y,0,1,me),w.x+=2*Me.x,w.y+=2*Me.y,w.vertexCount+=2,me+=Be,Za(this.layoutVertexArray,Xe.x,Xe.y,Pe.x,Pe.y,0,0,me),Za(this.layoutVertexArray,Xe.x,Xe.y,Pe.x,Pe.y,0,1,me),w.x+=2*Xe.x,w.y+=2*Xe.y,w.vertexCount+=2;const ht=F.vertexLength;this.indexArray.emplaceBack(ht,ht+2,ht+1),this.indexArray.emplaceBack(ht+1,ht+2,ht+3),F.vertexLength+=4,F.primitiveLength+=2}}}}if(F.vertexLength+k>ki.MAX_VERTEX_ARRAY_LENGTH&&(F=this.segments.prepareSegment(k,this.layoutVertexArray,this.indexArray)),dd[e.type]!=="Polygon")continue;const j=[],N=[],W=F.vertexLength;for(const K of P)if(K.length!==0){K!==P[0]&&N.push(j.length/2);for(let me=0;me<K.length;me++){const ue=K[me];Za(this.layoutVertexArray,ue.x,ue.y,0,0,1,1,0),w.x+=ue.x,w.y+=ue.y,w.vertexCount+=1,j.push(ue.x),j.push(ue.y)}}const Z=wl.exports(j,N);for(let K=0;K<Z.length;K+=3)this.indexArray.emplaceBack(W+Z[K],W+Z[K+2],W+Z[K+1]);F.primitiveLength+=Z.length/3,F.vertexLength+=k}for(let P=0;P<w.vertexCount;P++)this.centroidVertexArray.emplaceBack(Math.floor(w.x/w.vertexCount),Math.floor(w.y/w.vertexCount));this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,y,p)}}function fd(i,e){return i.x===e.x&&(i.x<0||i.x>Br)||i.y===e.y&&(i.y<0||i.y>Br)}function pd(i){return i.every(e=>e.x<0)||i.every(e=>e.x>Br)||i.every(e=>e.y<0)||i.every(e=>e.y>Br)}Rt("FillExtrusionBucket",cc,{omit:["layers","features"]});var md={paint:new Qr({"fill-extrusion-opacity":new ni(Ue["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new pi(Ue["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ni(Ue["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ni(Ue["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Eo(Ue["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new pi(Ue["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new pi(Ue["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new ni(Ue["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})};function Ka(i,e){return i.x*e.x+i.y*e.y}function _h(i,e){if(i.length===1){let r=0;const o=e[r++];let p;for(;!p||o.equals(p);)if(p=e[r++],!p)return 1/0;for(;r<e.length;r++){const y=e[r],w=i[0],P=p.sub(o),k=y.sub(o),F=w.sub(o),j=Ka(P,P),N=Ka(P,k),W=Ka(k,k),Z=Ka(F,P),K=Ka(F,k),me=j*W-N*N,ue=(W*Z-N*K)/me,Me=(j*K-N*Z)/me,Xe=o.z*(1-ue-Me)+p.z*ue+y.z*Me;if(isFinite(Xe))return Xe}return 1/0}{let r=1/0;for(const o of e)r=Math.min(r,o.z);return r}}const gd=Lr([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:_d}=gd,yd=Lr([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:vd}=yd,xd=Ao.VectorTileFeature.types,bd=Math.cos(Math.PI/180*37.5),yh=Math.pow(2,14)/.5;class hc{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(r=>r.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(r=>{this.gradients[r.id]={}}),this.layoutVertexArray=new Gi,this.layoutVertexArray2=new ir,this.indexArray=new wn,this.programConfigurations=new ea(e.layers,e.zoom),this.segments=new ki,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(e,r,o){this.hasPattern=sc("line",this.layers,r);const p=this.layers[0].layout.get("line-sort-key"),y=!p.isConstant(),w=[];for(const{feature:P,id:k,index:F,sourceLayerIndex:j}of e){const N=this.layers[0]._featureFilter.needGeometry,W=ia(P,N);if(!this.layers[0]._featureFilter.filter(new yr(this.zoom),W,o))continue;const Z=y?p.evaluate(W,{},o):void 0,K={id:k,properties:P.properties,type:P.type,sourceLayerIndex:j,index:F,geometry:N?W.geometry:ta(P),patterns:{},sortKey:Z};w.push(K)}y&&w.sort((P,k)=>P.sortKey-k.sortKey);for(const P of w){const{geometry:k,index:F,sourceLayerIndex:j}=P;if(this.hasPattern){const N=oc("line",this.layers,P,this.zoom,r);this.patternFeatures.push(N)}else this.addFeature(P,k,F,o,{});r.featureIndex.insert(e[F].feature,k,F,j,this.index)}}update(e,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,o)}addFeatures(e,r,o){for(const p of this.patternFeatures)this.addFeature(p,p.geometry,p.index,r,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,vd)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,_d),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&Object.prototype.hasOwnProperty.call(e.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(e.properties,"mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,r,o,p,y){const w=this.layers[0].layout,P=w.get("line-join").evaluate(e,{}),k=w.get("line-cap"),F=w.get("line-miter-limit"),j=w.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const N of r)this.addLine(N,e,P,k,F,j);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,y,p)}addLine(e,r,o,p,y,w){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Me=0;Me<e.length-1;Me++)this.totalDistance+=e[Me].dist(e[Me+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const P=xd[r.type]==="Polygon";let k=e.length;for(;k>=2&&e[k-1].equals(e[k-2]);)k--;let F=0;for(;F<k-1&&e[F].equals(e[F+1]);)F++;if(k<(P?3:2))return;o==="bevel"&&(y=1.05);const j=this.overscaling<=16?122880/(512*this.overscaling):0,N=this.segments.prepareSegment(10*k,this.layoutVertexArray,this.indexArray);let W,Z,K,me,ue;this.e1=this.e2=-1,P&&(W=e[k-2],ue=e[F].sub(W)._unit()._perp());for(let Me=F;Me<k;Me++){if(K=Me===k-1?P?e[F+1]:void 0:e[Me+1],K&&e[Me].equals(K))continue;ue&&(me=ue),W&&(Z=W),W=e[Me],ue=K?K.sub(W)._unit()._perp():me,me=me||ue;let Xe=me.add(ue);Xe.x===0&&Xe.y===0||Xe._unit();const Pe=me.x*ue.x+me.y*ue.y,Be=Xe.x*ue.x+Xe.y*ue.y,ht=Be!==0?1/Be:1/0,ct=2*Math.sqrt(2-2*Be),$t=Be<bd&&Z&&K,Qt=me.x*ue.y-me.y*ue.x>0;if($t&&Me>F){const It=W.dist(Z);if(It>2*j){const Ut=W.sub(W.sub(Z)._mult(j/It)._round());this.updateDistance(Z,Ut),this.addCurrentVertex(Ut,me,0,0,N),Z=Ut}}const Bt=Z&&K;let Ot=Bt?o:P?"butt":p;if(Bt&&Ot==="round"&&(ht<w?Ot="miter":ht<=2&&(Ot="fakeround")),Ot==="miter"&&ht>y&&(Ot="bevel"),Ot==="bevel"&&(ht>2&&(Ot="flipbevel"),ht<y&&(Ot="miter")),Z&&this.updateDistance(Z,W),Ot==="miter")Xe._mult(ht),this.addCurrentVertex(W,Xe,0,0,N);else if(Ot==="flipbevel"){if(ht>100)Xe=ue.mult(-1);else{const It=ht*me.add(ue).mag()/me.sub(ue).mag();Xe._perp()._mult(It*(Qt?-1:1))}this.addCurrentVertex(W,Xe,0,0,N),this.addCurrentVertex(W,Xe.mult(-1),0,0,N)}else if(Ot==="bevel"||Ot==="fakeround"){const It=-Math.sqrt(ht*ht-1),Ut=Qt?It:0,Ft=Qt?0:It;if(Z&&this.addCurrentVertex(W,me,Ut,Ft,N),Ot==="fakeround"){const St=Math.round(180*ct/Math.PI/20);for(let ui=1;ui<St;ui++){let si=ui/St;if(si!==.5){const mr=si-.5;si+=si*mr*(si-1)*((1.0904+Pe*(Pe*(3.55645-1.43519*Pe)-3.2452))*mr*mr+(.848013+Pe*(.215638*Pe-1.06021)))}const Ii=ue.sub(me)._mult(si)._add(me)._unit()._mult(Qt?-1:1);this.addHalfVertex(W,Ii.x,Ii.y,!1,Qt,0,N)}}K&&this.addCurrentVertex(W,ue,-Ut,-Ft,N)}else if(Ot==="butt")this.addCurrentVertex(W,Xe,0,0,N);else if(Ot==="square"){const It=Z?1:-1;this.addCurrentVertex(W,Xe,It,It,N)}else Ot==="round"&&(Z&&(this.addCurrentVertex(W,me,0,0,N),this.addCurrentVertex(W,me,1,1,N,!0)),K&&(this.addCurrentVertex(W,ue,-1,-1,N,!0),this.addCurrentVertex(W,ue,0,0,N)));if($t&&Me<k-1){const It=W.dist(K);if(It>2*j){const Ut=W.add(K.sub(W)._mult(j/It)._round());this.updateDistance(W,Ut),this.addCurrentVertex(Ut,ue,0,0,N),W=Ut}}}}addCurrentVertex(e,r,o,p,y,w=!1){const P=r.y*p-r.x,k=-r.y-r.x*p;this.addHalfVertex(e,r.x+r.y*o,r.y-r.x*o,w,!1,o,y),this.addHalfVertex(e,P,k,w,!0,-p,y),this.distance>yh/2&&this.totalDistance===0&&(this.distance=0,this.addCurrentVertex(e,r,o,p,y,w))}addHalfVertex({x:e,y:r},o,p,y,w,P,k){const F=.5*(this.lineClips?this.scaledDistance*(yh-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((e<<1)+(y?1:0),(r<<1)+(w?1:0),Math.round(63*o)+128,Math.round(63*p)+128,1+(P===0?0:P<0?-1:1)|(63&F)<<2,F>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const j=k.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,j),k.primitiveLength++),w?this.e2=j:this.e1=j}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(e,r){this.distance+=e.dist(r),this.updateScaledDistance()}}Rt("LineBucket",hc,{omit:["layers","patternFeatures"]});const wd=new Qr({"line-cap":new ni(Ue.layout_line["line-cap"]),"line-join":new pi(Ue.layout_line["line-join"]),"line-miter-limit":new ni(Ue.layout_line["line-miter-limit"]),"line-round-limit":new ni(Ue.layout_line["line-round-limit"]),"line-sort-key":new pi(Ue.layout_line["line-sort-key"])});var vh={paint:new Qr({"line-opacity":new pi(Ue.paint_line["line-opacity"]),"line-color":new pi(Ue.paint_line["line-color"]),"line-translate":new ni(Ue.paint_line["line-translate"]),"line-translate-anchor":new ni(Ue.paint_line["line-translate-anchor"]),"line-width":new pi(Ue.paint_line["line-width"]),"line-gap-width":new pi(Ue.paint_line["line-gap-width"]),"line-offset":new pi(Ue.paint_line["line-offset"]),"line-blur":new pi(Ue.paint_line["line-blur"]),"line-dasharray":new Ba(Ue.paint_line["line-dasharray"]),"line-pattern":new Eo(Ue.paint_line["line-pattern"]),"line-gradient":new Us(Ue.paint_line["line-gradient"])}),layout:wd};const xh=new class extends pi{possiblyEvaluate(i,e){return e=new yr(Math.floor(e.zoom),{now:e.now,fadeDuration:e.fadeDuration,zoomHistory:e.zoomHistory,transition:e.transition}),super.possiblyEvaluate(i,e)}evaluate(i,e,r,o){return e=d({},e,{zoom:Math.floor(e.zoom)}),super.evaluate(i,e,r,o)}}(vh.paint.properties["line-width"].specification);function bh(i,e){return e>0?e+2*i:i}xh.useIntegerZoom=!0;const Cd=Lr([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Sd=Lr([{name:"a_projected_pos",components:3,type:"Float32"}],4);Lr([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Td=Lr([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]);Lr([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const wh=Lr([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Ed=Lr([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function Pd(i,e,r){return i.sections.forEach(o=>{o.text=function(p,y,w){const P=y.layout.get("text-transform").evaluate(w,{});return P==="uppercase"?p=p.toLocaleUpperCase():P==="lowercase"&&(p=p.toLocaleLowerCase()),Vn.applyArabicShaping&&(p=Vn.applyArabicShaping(p)),p}(o.text,e,r)}),i}Lr([{name:"triangle",components:3,type:"Uint16"}]),Lr([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),Lr([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),Lr([{type:"Float32",name:"offsetX"}]),Lr([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);const Ja={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42"};var en=24,uc=nr,Ch=function(i,e,r,o,p){var y,w,P=8*p-o-1,k=(1<<P)-1,F=k>>1,j=-7,N=r?p-1:0,W=r?-1:1,Z=i[e+N];for(N+=W,y=Z&(1<<-j)-1,Z>>=-j,j+=P;j>0;y=256*y+i[e+N],N+=W,j-=8);for(w=y&(1<<-j)-1,y>>=-j,j+=o;j>0;w=256*w+i[e+N],N+=W,j-=8);if(y===0)y=1-F;else{if(y===k)return w?NaN:1/0*(Z?-1:1);w+=Math.pow(2,o),y-=F}return(Z?-1:1)*w*Math.pow(2,y-o)},Sh=function(i,e,r,o,p,y){var w,P,k,F=8*y-p-1,j=(1<<F)-1,N=j>>1,W=p===23?Math.pow(2,-24)-Math.pow(2,-77):0,Z=o?0:y-1,K=o?1:-1,me=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(P=isNaN(e)?1:0,w=j):(w=Math.floor(Math.log(e)/Math.LN2),e*(k=Math.pow(2,-w))<1&&(w--,k*=2),(e+=w+N>=1?W/k:W*Math.pow(2,1-N))*k>=2&&(w++,k/=2),w+N>=j?(P=0,w=j):w+N>=1?(P=(e*k-1)*Math.pow(2,p),w+=N):(P=e*Math.pow(2,N-1)*Math.pow(2,p),w=0));p>=8;i[r+Z]=255&P,Z+=K,P/=256,p-=8);for(w=w<<p|P,F+=p;F>0;i[r+Z]=255&w,Z+=K,w/=256,F-=8);i[r+Z-K]|=128*me};function nr(i){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(i)?i:new Uint8Array(i||0),this.pos=0,this.type=0,this.length=this.buf.length}nr.Varint=0,nr.Fixed64=1,nr.Bytes=2,nr.Fixed32=5;var Mo,dc=4294967296,Th=1/dc,Eh=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function oo(i){return i.type===nr.Bytes?i.readVarint()+i.pos:i.pos+1}function wa(i,e,r){return r?4294967296*e+(i>>>0):4294967296*(e>>>0)+(i>>>0)}function Ph(i,e,r){var o=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));r.realloc(o);for(var p=r.pos-1;p>=i;p--)r.buf[p+o]=r.buf[p]}function Id(i,e){for(var r=0;r<i.length;r++)e.writeVarint(i[r])}function Ad(i,e){for(var r=0;r<i.length;r++)e.writeSVarint(i[r])}function Md(i,e){for(var r=0;r<i.length;r++)e.writeFloat(i[r])}function kd(i,e){for(var r=0;r<i.length;r++)e.writeDouble(i[r])}function Dd(i,e){for(var r=0;r<i.length;r++)e.writeBoolean(i[r])}function Od(i,e){for(var r=0;r<i.length;r++)e.writeFixed32(i[r])}function Ld(i,e){for(var r=0;r<i.length;r++)e.writeSFixed32(i[r])}function zd(i,e){for(var r=0;r<i.length;r++)e.writeFixed64(i[r])}function Fd(i,e){for(var r=0;r<i.length;r++)e.writeSFixed64(i[r])}function Pl(i,e){return(i[e]|i[e+1]<<8|i[e+2]<<16)+16777216*i[e+3]}function Ca(i,e,r){i[r]=e,i[r+1]=e>>>8,i[r+2]=e>>>16,i[r+3]=e>>>24}function Ih(i,e){return(i[e]|i[e+1]<<8|i[e+2]<<16)+(i[e+3]<<24)}function Rd(i,e,r){i===1&&r.readMessage(Bd,e)}function Bd(i,e,r){if(i===3){const{id:o,bitmap:p,width:y,height:w,left:P,top:k,advance:F}=r.readMessage(Ud,{});e.push({id:o,bitmap:new Wa({width:y+6,height:w+6},p),metrics:{width:y,height:w,left:P,top:k,advance:F}})}}function Ud(i,e,r){i===1?e.id=r.readVarint():i===2?e.bitmap=r.readBytes():i===3?e.width=r.readVarint():i===4?e.height=r.readVarint():i===5?e.left=r.readSVarint():i===6?e.top=r.readSVarint():i===7&&(e.advance=r.readVarint())}function Ah(i){let e=0,r=0;for(const w of i)e+=w.w*w.h,r=Math.max(r,w.w);i.sort((w,P)=>P.h-w.h);const o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),r),h:1/0}];let p=0,y=0;for(const w of i)for(let P=o.length-1;P>=0;P--){const k=o[P];if(!(w.w>k.w||w.h>k.h)){if(w.x=k.x,w.y=k.y,y=Math.max(y,w.y+w.h),p=Math.max(p,w.x+w.w),w.w===k.w&&w.h===k.h){const F=o.pop();P<o.length&&(o[P]=F)}else w.h===k.h?(k.x+=w.w,k.w-=w.w):w.w===k.w?(k.y+=w.h,k.h-=w.h):(o.push({x:k.x+w.w,y:k.y,w:k.w-w.w,h:w.h}),k.y+=w.h,k.h-=w.h);break}}return{w:p,h:y,fill:e/(p*y)||0}}nr.prototype={destroy:function(){this.buf=null},readFields:function(i,e,r){for(r=r||this.length;this.pos<r;){var o=this.readVarint(),p=o>>3,y=this.pos;this.type=7&o,i(p,e,this),this.pos===y&&this.skip(o)}return e},readMessage:function(i,e){return this.readFields(i,e,this.readVarint()+this.pos)},readFixed32:function(){var i=Pl(this.buf,this.pos);return this.pos+=4,i},readSFixed32:function(){var i=Ih(this.buf,this.pos);return this.pos+=4,i},readFixed64:function(){var i=Pl(this.buf,this.pos)+Pl(this.buf,this.pos+4)*dc;return this.pos+=8,i},readSFixed64:function(){var i=Pl(this.buf,this.pos)+Ih(this.buf,this.pos+4)*dc;return this.pos+=8,i},readFloat:function(){var i=Ch(this.buf,this.pos,!0,23,4);return this.pos+=4,i},readDouble:function(){var i=Ch(this.buf,this.pos,!0,52,8);return this.pos+=8,i},readVarint:function(i){var e,r,o=this.buf;return e=127&(r=o[this.pos++]),r<128?e:(e|=(127&(r=o[this.pos++]))<<7,r<128?e:(e|=(127&(r=o[this.pos++]))<<14,r<128?e:(e|=(127&(r=o[this.pos++]))<<21,r<128?e:function(p,y,w){var P,k,F=w.buf;if(P=(112&(k=F[w.pos++]))>>4,k<128||(P|=(127&(k=F[w.pos++]))<<3,k<128)||(P|=(127&(k=F[w.pos++]))<<10,k<128)||(P|=(127&(k=F[w.pos++]))<<17,k<128)||(P|=(127&(k=F[w.pos++]))<<24,k<128)||(P|=(1&(k=F[w.pos++]))<<31,k<128))return wa(p,P,y);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(r=o[this.pos]))<<28,i,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var i=this.readVarint();return i%2==1?(i+1)/-2:i/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var i=this.readVarint()+this.pos,e=this.pos;return this.pos=i,i-e>=12&&Eh?function(r,o,p){return Eh.decode(r.subarray(o,p))}(this.buf,e,i):function(r,o,p){for(var y="",w=o;w<p;){var P,k,F,j=r[w],N=null,W=j>239?4:j>223?3:j>191?2:1;if(w+W>p)break;W===1?j<128&&(N=j):W===2?(192&(P=r[w+1]))==128&&(N=(31&j)<<6|63&P)<=127&&(N=null):W===3?(k=r[w+2],(192&(P=r[w+1]))==128&&(192&k)==128&&((N=(15&j)<<12|(63&P)<<6|63&k)<=2047||N>=55296&&N<=57343)&&(N=null)):W===4&&(k=r[w+2],F=r[w+3],(192&(P=r[w+1]))==128&&(192&k)==128&&(192&F)==128&&((N=(15&j)<<18|(63&P)<<12|(63&k)<<6|63&F)<=65535||N>=1114112)&&(N=null)),N===null?(N=65533,W=1):N>65535&&(N-=65536,y+=String.fromCharCode(N>>>10&1023|55296),N=56320|1023&N),y+=String.fromCharCode(N),w+=W}return y}(this.buf,e,i)},readBytes:function(){var i=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,i);return this.pos=i,e},readPackedVarint:function(i,e){if(this.type!==nr.Bytes)return i.push(this.readVarint(e));var r=oo(this);for(i=i||[];this.pos<r;)i.push(this.readVarint(e));return i},readPackedSVarint:function(i){if(this.type!==nr.Bytes)return i.push(this.readSVarint());var e=oo(this);for(i=i||[];this.pos<e;)i.push(this.readSVarint());return i},readPackedBoolean:function(i){if(this.type!==nr.Bytes)return i.push(this.readBoolean());var e=oo(this);for(i=i||[];this.pos<e;)i.push(this.readBoolean());return i},readPackedFloat:function(i){if(this.type!==nr.Bytes)return i.push(this.readFloat());var e=oo(this);for(i=i||[];this.pos<e;)i.push(this.readFloat());return i},readPackedDouble:function(i){if(this.type!==nr.Bytes)return i.push(this.readDouble());var e=oo(this);for(i=i||[];this.pos<e;)i.push(this.readDouble());return i},readPackedFixed32:function(i){if(this.type!==nr.Bytes)return i.push(this.readFixed32());var e=oo(this);for(i=i||[];this.pos<e;)i.push(this.readFixed32());return i},readPackedSFixed32:function(i){if(this.type!==nr.Bytes)return i.push(this.readSFixed32());var e=oo(this);for(i=i||[];this.pos<e;)i.push(this.readSFixed32());return i},readPackedFixed64:function(i){if(this.type!==nr.Bytes)return i.push(this.readFixed64());var e=oo(this);for(i=i||[];this.pos<e;)i.push(this.readFixed64());return i},readPackedSFixed64:function(i){if(this.type!==nr.Bytes)return i.push(this.readSFixed64());var e=oo(this);for(i=i||[];this.pos<e;)i.push(this.readSFixed64());return i},skip:function(i){var e=7&i;if(e===nr.Varint)for(;this.buf[this.pos++]>127;);else if(e===nr.Bytes)this.pos=this.readVarint()+this.pos;else if(e===nr.Fixed32)this.pos+=4;else{if(e!==nr.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(i,e){this.writeVarint(i<<3|e)},realloc:function(i){for(var e=this.length||16;e<this.pos+i;)e*=2;if(e!==this.length){var r=new Uint8Array(e);r.set(this.buf),this.buf=r,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(i){this.realloc(4),Ca(this.buf,i,this.pos),this.pos+=4},writeSFixed32:function(i){this.realloc(4),Ca(this.buf,i,this.pos),this.pos+=4},writeFixed64:function(i){this.realloc(8),Ca(this.buf,-1&i,this.pos),Ca(this.buf,Math.floor(i*Th),this.pos+4),this.pos+=8},writeSFixed64:function(i){this.realloc(8),Ca(this.buf,-1&i,this.pos),Ca(this.buf,Math.floor(i*Th),this.pos+4),this.pos+=8},writeVarint:function(i){(i=+i||0)>268435455||i<0?function(e,r){var o,p;if(e>=0?(o=e%4294967296|0,p=e/4294967296|0):(p=~(-e/4294967296),4294967295^(o=~(-e%4294967296))?o=o+1|0:(o=0,p=p+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");r.realloc(10),function(y,w,P){P.buf[P.pos++]=127&y|128,y>>>=7,P.buf[P.pos++]=127&y|128,y>>>=7,P.buf[P.pos++]=127&y|128,y>>>=7,P.buf[P.pos++]=127&y|128,P.buf[P.pos]=127&(y>>>=7)}(o,0,r),function(y,w){var P=(7&y)<<4;w.buf[w.pos++]|=P|((y>>>=3)?128:0),y&&(w.buf[w.pos++]=127&y|((y>>>=7)?128:0),y&&(w.buf[w.pos++]=127&y|((y>>>=7)?128:0),y&&(w.buf[w.pos++]=127&y|((y>>>=7)?128:0),y&&(w.buf[w.pos++]=127&y|((y>>>=7)?128:0),y&&(w.buf[w.pos++]=127&y)))))}(p,r)}(i,this):(this.realloc(4),this.buf[this.pos++]=127&i|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=i>>>7&127))))},writeSVarint:function(i){this.writeVarint(i<0?2*-i-1:2*i)},writeBoolean:function(i){this.writeVarint(Boolean(i))},writeString:function(i){i=String(i),this.realloc(4*i.length),this.pos++;var e=this.pos;this.pos=function(o,p,y){for(var w,P,k=0;k<p.length;k++){if((w=p.charCodeAt(k))>55295&&w<57344){if(!P){w>56319||k+1===p.length?(o[y++]=239,o[y++]=191,o[y++]=189):P=w;continue}if(w<56320){o[y++]=239,o[y++]=191,o[y++]=189,P=w;continue}w=P-55296<<10|w-56320|65536,P=null}else P&&(o[y++]=239,o[y++]=191,o[y++]=189,P=null);w<128?o[y++]=w:(w<2048?o[y++]=w>>6|192:(w<65536?o[y++]=w>>12|224:(o[y++]=w>>18|240,o[y++]=w>>12&63|128),o[y++]=w>>6&63|128),o[y++]=63&w|128)}return y}(this.buf,i,this.pos);var r=this.pos-e;r>=128&&Ph(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r},writeFloat:function(i){this.realloc(4),Sh(this.buf,i,this.pos,!0,23,4),this.pos+=4},writeDouble:function(i){this.realloc(8),Sh(this.buf,i,this.pos,!0,52,8),this.pos+=8},writeBytes:function(i){var e=i.length;this.writeVarint(e),this.realloc(e);for(var r=0;r<e;r++)this.buf[this.pos++]=i[r]},writeRawMessage:function(i,e){this.pos++;var r=this.pos;i(e,this);var o=this.pos-r;o>=128&&Ph(r,o,this),this.pos=r-1,this.writeVarint(o),this.pos+=o},writeMessage:function(i,e,r){this.writeTag(i,nr.Bytes),this.writeRawMessage(e,r)},writePackedVarint:function(i,e){e.length&&this.writeMessage(i,Id,e)},writePackedSVarint:function(i,e){e.length&&this.writeMessage(i,Ad,e)},writePackedBoolean:function(i,e){e.length&&this.writeMessage(i,Dd,e)},writePackedFloat:function(i,e){e.length&&this.writeMessage(i,Md,e)},writePackedDouble:function(i,e){e.length&&this.writeMessage(i,kd,e)},writePackedFixed32:function(i,e){e.length&&this.writeMessage(i,Od,e)},writePackedSFixed32:function(i,e){e.length&&this.writeMessage(i,Ld,e)},writePackedFixed64:function(i,e){e.length&&this.writeMessage(i,zd,e)},writePackedSFixed64:function(i,e){e.length&&this.writeMessage(i,Fd,e)},writeBytesField:function(i,e){this.writeTag(i,nr.Bytes),this.writeBytes(e)},writeFixed32Field:function(i,e){this.writeTag(i,nr.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(i,e){this.writeTag(i,nr.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(i,e){this.writeTag(i,nr.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(i,e){this.writeTag(i,nr.Fixed64),this.writeSFixed64(e)},writeVarintField:function(i,e){this.writeTag(i,nr.Varint),this.writeVarint(e)},writeSVarintField:function(i,e){this.writeTag(i,nr.Varint),this.writeSVarint(e)},writeStringField:function(i,e){this.writeTag(i,nr.Bytes),this.writeString(e)},writeFloatField:function(i,e){this.writeTag(i,nr.Fixed32),this.writeFloat(e)},writeDoubleField:function(i,e){this.writeTag(i,nr.Fixed64),this.writeDouble(e)},writeBooleanField:function(i,e){this.writeVarintField(i,Boolean(e))}};class fc{constructor(e,{pixelRatio:r,version:o,stretchX:p,stretchY:y,content:w}){this.paddedRect=e,this.pixelRatio=r,this.stretchX=p,this.stretchY=y,this.content=w,this.version=o}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Mh{constructor(e,r){const o={},p={};this.haveRenderCallbacks=[];const y=[];this.addImages(e,o,y),this.addImages(r,p,y);const{w,h:P}=Ah(y),k=new is({width:w||1,height:P||1});for(const F in e){const j=e[F],N=o[F].paddedRect;is.copy(j.data,k,{x:0,y:0},{x:N.x+1,y:N.y+1},j.data)}for(const F in r){const j=r[F],N=p[F].paddedRect,W=N.x+1,Z=N.y+1,K=j.data.width,me=j.data.height;is.copy(j.data,k,{x:0,y:0},{x:W,y:Z},j.data),is.copy(j.data,k,{x:0,y:me-1},{x:W,y:Z-1},{width:K,height:1}),is.copy(j.data,k,{x:0,y:0},{x:W,y:Z+me},{width:K,height:1}),is.copy(j.data,k,{x:K-1,y:0},{x:W-1,y:Z},{width:1,height:me}),is.copy(j.data,k,{x:0,y:0},{x:W+K,y:Z},{width:1,height:me})}this.image=k,this.iconPositions=o,this.patternPositions=p}addImages(e,r,o){for(const p in e){const y=e[p],w={x:0,y:0,w:y.data.width+2,h:y.data.height+2};o.push(w),r[p]=new fc(w,y),y.hasRenderCallback&&this.haveRenderCallbacks.push(p)}}patchUpdatedImages(e,r){e.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const o in e.updatedImages)this.patchUpdatedImage(this.iconPositions[o],e.getImage(o),r),this.patchUpdatedImage(this.patternPositions[o],e.getImage(o),r)}patchUpdatedImage(e,r,o){if(!e||!r||e.version===r.version)return;e.version=r.version;const[p,y]=e.tl;o.update(r.data,void 0,{x:p,y})}}Rt("ImagePosition",fc),Rt("ImageAtlas",Mh),n.WritingMode=void 0,(Mo=n.WritingMode||(n.WritingMode={}))[Mo.none=0]="none",Mo[Mo.horizontal=1]="horizontal",Mo[Mo.vertical=2]="vertical",Mo[Mo.horizontalOnly=3]="horizontalOnly";const Il=-17;class Qa{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(e,r){const o=new Qa;return o.scale=e||1,o.fontStack=r,o}static forImage(e){const r=new Qa;return r.imageName=e,r}}class Sa{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,r){const o=new Sa;for(let p=0;p<e.sections.length;p++){const y=e.sections[p];y.image?o.addImageSection(y):o.addTextSection(y,r)}return o}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSectionIndex(e){return this.sectionIndex[e]}getCharCode(e){return this.text.charCodeAt(e)}verticalizePunctuation(){this.text=function(e){let r="";for(let o=0;o<e.length;o++){const p=e.charCodeAt(o+1)||null,y=e.charCodeAt(o-1)||null;r+=p&&ll(p)&&!Ja[e[o+1]]||y&&ll(y)&&!Ja[e[o-1]]||!Ja[e[o]]?e[o]:Ja[e[o]]}return r}(this.text)}trim(){let e=0;for(let o=0;o<this.text.length&&Ml[this.text.charCodeAt(o)];o++)e++;let r=this.text.length;for(let o=this.text.length-1;o>=0&&o>=e&&Ml[this.text.charCodeAt(o)];o--)r--;this.text=this.text.substring(e,r),this.sectionIndex=this.sectionIndex.slice(e,r)}substring(e,r){const o=new Sa;return o.text=this.text.substring(e,r),o.sectionIndex=this.sectionIndex.slice(e,r),o.sections=this.sections,o}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,r)=>Math.max(e,this.sections[r].scale),0)}addTextSection(e,r){this.text+=e.text,this.sections.push(Qa.forText(e.scale,e.fontStack||r));const o=this.sections.length-1;for(let p=0;p<e.text.length;++p)this.sectionIndex.push(o)}addImageSection(e){const r=e.image?e.image.name:"";if(r.length===0)return void U("Can't add FormattedSection with an empty image.");const o=this.getNextImageSectionCharCode();o?(this.text+=String.fromCharCode(o),this.sections.push(Qa.forImage(r)),this.sectionIndex.push(this.sections.length-1)):U("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Al(i,e,r,o,p,y,w,P,k,F,j,N,W,Z,K,me){const ue=Sa.fromFeature(i,p);let Me;N===n.WritingMode.vertical&&ue.verticalizePunctuation();const{processBidirectionalText:Xe,processStyledBidirectionalText:Pe}=Vn;if(Xe&&ue.sections.length===1){Me=[];const ct=Xe(ue.toString(),pc(ue,F,y,e,o,Z,K));for(const $t of ct){const Qt=new Sa;Qt.text=$t,Qt.sections=ue.sections;for(let Bt=0;Bt<$t.length;Bt++)Qt.sectionIndex.push(0);Me.push(Qt)}}else if(Pe){Me=[];const ct=Pe(ue.text,ue.sectionIndex,pc(ue,F,y,e,o,Z,K));for(const $t of ct){const Qt=new Sa;Qt.text=$t[0],Qt.sectionIndex=$t[1],Qt.sections=ue.sections,Me.push(Qt)}}else Me=function(ct,$t){const Qt=[],Bt=ct.text;let Ot=0;for(const It of $t)Qt.push(ct.substring(Ot,It)),Ot=It;return Ot<Bt.length&&Qt.push(ct.substring(Ot,Bt.length)),Qt}(ue,pc(ue,F,y,e,o,Z,K));const Be=[],ht={positionedLines:Be,text:ue.toString(),top:j[1],bottom:j[1],left:j[0],right:j[0],writingMode:N,iconsInText:!1,verticalizable:!1};return function(ct,$t,Qt,Bt,Ot,It,Ut,Ft,St,ui,si,Ii){let mr=0,xr=Il,Ur=0,ns=0;const ln=Ft==="right"?1:Ft==="left"?0:.5;let zr=0;for(const Fr of Ot){Fr.trim();const hn=Fr.getMaxScale(),gn=(hn-1)*en,Tn={positionedGlyphs:[],lineOffset:0};ct.positionedLines[zr]=Tn;const Mn=Tn.positionedGlyphs;let kn=0;if(!Fr.length()){xr+=It,++zr;continue}for(let Hr=0;Hr<Fr.length();Hr++){const Fi=Fr.getSection(Hr),Xn=Fr.getSectionIndex(Hr),un=Fr.getCharCode(Hr);let _n=0,_s=null,Es=null,Ps=null,lo=en;const ys=!(St===n.WritingMode.horizontal||!si&&!Da(un)||si&&(Ml[un]||(Yr=un,kt.Arabic(Yr)||kt["Arabic Supplement"](Yr)||kt["Arabic Extended-A"](Yr)||kt["Arabic Presentation Forms-A"](Yr)||kt["Arabic Presentation Forms-B"](Yr))));if(Fi.imageName){const ss=Bt[Fi.imageName];if(!ss)continue;Ps=Fi.imageName,ct.iconsInText=ct.iconsInText||!0,Es=ss.paddedRect;const Dn=ss.displaySize;Fi.scale=Fi.scale*en/Ii,_s={width:Dn[0],height:Dn[1],left:1,top:-3,advance:ys?Dn[1]:Dn[0]},_n=gn+(en-Dn[1]*Fi.scale),lo=_s.advance;const co=ys?Dn[0]*Fi.scale-en*hn:Dn[1]*Fi.scale-en*hn;co>0&&co>kn&&(kn=co)}else{const ss=Qt[Fi.fontStack],Dn=ss&&ss[un];if(Dn&&Dn.rect)Es=Dn.rect,_s=Dn.metrics;else{const co=$t[Fi.fontStack],il=co&&co[un];if(!il)continue;_s=il.metrics}_n=(hn-Fi.scale)*en}ys?(ct.verticalizable=!0,Mn.push({glyph:un,imageName:Ps,x:mr,y:xr+_n,vertical:ys,scale:Fi.scale,fontStack:Fi.fontStack,sectionIndex:Xn,metrics:_s,rect:Es}),mr+=lo*Fi.scale+ui):(Mn.push({glyph:un,imageName:Ps,x:mr,y:xr+_n,vertical:ys,scale:Fi.scale,fontStack:Fi.fontStack,sectionIndex:Xn,metrics:_s,rect:Es}),mr+=_s.advance*Fi.scale+ui)}Mn.length!==0&&(Ur=Math.max(mr-ui,Ur),Nd(Mn,0,Mn.length-1,ln,kn)),mr=0;const Sr=It*hn+kn;Tn.lineOffset=Math.max(kn,gn),xr+=Sr,ns=Math.max(Sr,ns),++zr}var Yr;const cn=xr-Il,{horizontalAlign:mn,verticalAlign:An}=mc(Ut);(function(Fr,hn,gn,Tn,Mn,kn,Sr,Hr,Fi){const Xn=(hn-gn)*Mn;let un=0;un=kn!==Sr?-Hr*Tn-Il:(-Tn*Fi+.5)*Sr;for(const _n of Fr)for(const _s of _n.positionedGlyphs)_s.x+=Xn,_s.y+=un})(ct.positionedLines,ln,mn,An,Ur,ns,It,cn,Ot.length),ct.top+=-An*cn,ct.bottom=ct.top+cn,ct.left+=-mn*Ur,ct.right=ct.left+Ur}(ht,e,r,o,Me,w,P,k,N,F,W,me),!function(ct){for(const $t of ct)if($t.positionedGlyphs.length!==0)return!1;return!0}(Be)&&ht}const Ml={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},jd={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function kh(i,e,r,o,p,y){if(e.imageName){const w=o[e.imageName];return w?w.displaySize[0]*e.scale*en/y+p:0}{const w=r[e.fontStack],P=w&&w[i];return P?P.metrics.advance*e.scale+p:0}}function Dh(i,e,r,o){const p=Math.pow(i-e,2);return o?i<e?p/2:2*p:p+Math.abs(r)*r}function Vd(i,e,r){let o=0;return i===10&&(o-=1e4),r&&(o+=150),i!==40&&i!==65288||(o+=50),e!==41&&e!==65289||(o+=50),o}function Oh(i,e,r,o,p,y){let w=null,P=Dh(e,r,p,y);for(const k of o){const F=Dh(e-k.x,r,p,y)+k.badness;F<=P&&(w=k,P=F)}return{index:i,x:e,priorBreak:w,badness:P}}function Lh(i){return i?Lh(i.priorBreak).concat(i.index):[]}function pc(i,e,r,o,p,y,w){if(y!=="point")return[];if(!i)return[];const P=[],k=function(W,Z,K,me,ue,Me){let Xe=0;for(let Pe=0;Pe<W.length();Pe++){const Be=W.getSection(Pe);Xe+=kh(W.getCharCode(Pe),Be,me,ue,Z,Me)}return Xe/Math.max(1,Math.ceil(Xe/K))}(i,e,r,o,p,w),F=i.text.indexOf("\u200B")>=0;let j=0;for(let W=0;W<i.length();W++){const Z=i.getSection(W),K=i.getCharCode(W);if(Ml[K]||(j+=kh(K,Z,o,p,e,w)),W<i.length()-1){const me=!((N=K)<11904||!(kt["Bopomofo Extended"](N)||kt.Bopomofo(N)||kt["CJK Compatibility Forms"](N)||kt["CJK Compatibility Ideographs"](N)||kt["CJK Compatibility"](N)||kt["CJK Radicals Supplement"](N)||kt["CJK Strokes"](N)||kt["CJK Symbols and Punctuation"](N)||kt["CJK Unified Ideographs Extension A"](N)||kt["CJK Unified Ideographs"](N)||kt["Enclosed CJK Letters and Months"](N)||kt["Halfwidth and Fullwidth Forms"](N)||kt.Hiragana(N)||kt["Ideographic Description Characters"](N)||kt["Kangxi Radicals"](N)||kt["Katakana Phonetic Extensions"](N)||kt.Katakana(N)||kt["Vertical Forms"](N)||kt["Yi Radicals"](N)||kt["Yi Syllables"](N)));(jd[K]||me||Z.imageName)&&P.push(Oh(W+1,j,k,P,Vd(K,i.getCharCode(W+1),me&&F),!1))}}var N;return Lh(Oh(i.length(),j,k,P,0,!0))}function mc(i){let e=.5,r=.5;switch(i){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(i){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:e,verticalAlign:r}}function Nd(i,e,r,o,p){if(!o&&!p)return;const y=i[r],w=(i[r].x+y.metrics.advance*y.scale)*o;for(let P=e;P<=r;P++)i[P].x-=w,i[P].y+=p}function Gd(i,e,r){const{horizontalAlign:o,verticalAlign:p}=mc(r),y=e[0]-i.displaySize[0]*o,w=e[1]-i.displaySize[1]*p;return{image:i,top:w,bottom:w+i.displaySize[1],left:y,right:y+i.displaySize[0]}}function zh(i,e,r,o,p,y){const w=i.image;let P;if(w.content){const ue=w.content,Me=w.pixelRatio||1;P=[ue[0]/Me,ue[1]/Me,w.displaySize[0]-ue[2]/Me,w.displaySize[1]-ue[3]/Me]}const k=e.left*y,F=e.right*y;let j,N,W,Z;r==="width"||r==="both"?(Z=p[0]+k-o[3],N=p[0]+F+o[1]):(Z=p[0]+(k+F-w.displaySize[0])/2,N=Z+w.displaySize[0]);const K=e.top*y,me=e.bottom*y;return r==="height"||r==="both"?(j=p[1]+K-o[0],W=p[1]+me+o[2]):(j=p[1]+(K+me-w.displaySize[1])/2,W=j+w.displaySize[1]),{image:w,top:j,right:N,bottom:W,left:Z,collisionPadding:P}}const ao=128;function Fh(i,e){const{expression:r}=e;if(r.kind==="constant")return{kind:"constant",layoutSize:r.evaluate(new yr(i+1))};if(r.kind==="source")return{kind:"source"};{const{zoomStops:o,interpolationType:p}=r;let y=0;for(;y<o.length&&o[y]<=i;)y++;y=Math.max(0,y-1);let w=y;for(;w<o.length&&o[w]<i+1;)w++;w=Math.min(o.length-1,w);const P=o[y],k=o[w];return r.kind==="composite"?{kind:"composite",minZoom:P,maxZoom:k,interpolationType:p}:{kind:"camera",minZoom:P,maxZoom:k,minSize:r.evaluate(new yr(P)),maxSize:r.evaluate(new yr(k)),interpolationType:p}}}class ko extends Qe{constructor(e,r,o,p){super(e,r),this.angle=o,p!==void 0&&(this.segment=p)}clone(){return new ko(this.x,this.y,this.angle,this.segment)}}function Rh(i,e,r,o,p){if(e.segment===void 0)return!0;let y=e,w=e.segment+1,P=0;for(;P>-r/2;){if(w--,w<0)return!1;P-=i[w].dist(y),y=i[w]}P+=i[w].dist(i[w+1]),w++;const k=[];let F=0;for(;P<r/2;){const j=i[w],N=i[w+1];if(!N)return!1;let W=i[w-1].angleTo(j)-j.angleTo(N);for(W=Math.abs((W+3*Math.PI)%(2*Math.PI)-Math.PI),k.push({distance:P,angleDelta:W}),F+=W;P-k[0].distance>o;)F-=k.shift().angleDelta;if(F>p)return!1;w++,P+=j.dist(N)}return!0}function Bh(i){let e=0;for(let r=0;r<i.length-1;r++)e+=i[r].dist(i[r+1]);return e}function Uh(i,e,r){return i?.6*e*r:0}function jh(i,e){return Math.max(i?i.right-i.left:0,e?e.right-e.left:0)}function Xd(i,e,r,o,p,y){const w=Uh(r,p,y),P=jh(r,o)*y;let k=0;const F=Bh(i)/2;for(let j=0;j<i.length-1;j++){const N=i[j],W=i[j+1],Z=N.dist(W);if(k+Z>F){const K=(F-k)/Z,me=Ct(N.x,W.x,K),ue=Ct(N.y,W.y,K),Me=new ko(me,ue,W.angleTo(N),j);return Me._round(),!w||Rh(i,Me,P,w,e)?Me:void 0}k+=Z}}function Wd(i,e,r,o,p,y,w,P,k){const F=Uh(o,y,w),j=jh(o,p),N=j*w,W=i[0].x===0||i[0].x===k||i[0].y===0||i[0].y===k;return e-N<e/4&&(e=N+e/4),Vh(i,W?e/2*P%e:(j/2+2*y)*w*P%e,e,F,r,N,W,!1,k)}function Vh(i,e,r,o,p,y,w,P,k){const F=y/2,j=Bh(i);let N=0,W=e-r,Z=[];for(let K=0;K<i.length-1;K++){const me=i[K],ue=i[K+1],Me=me.dist(ue),Xe=ue.angleTo(me);for(;W+r<N+Me;){W+=r;const Pe=(W-N)/Me,Be=Ct(me.x,ue.x,Pe),ht=Ct(me.y,ue.y,Pe);if(Be>=0&&Be<k&&ht>=0&&ht<k&&W-F>=0&&W+F<=j){const ct=new ko(Be,ht,Xe,K);ct._round(),o&&!Rh(i,ct,y,o,p)||Z.push(ct)}}N+=Me}return P||Z.length||w||(Z=Vh(i,N/2,r,o,p,y,w,!0,k)),Z}function Nh(i,e,r,o,p){const y=[];for(let w=0;w<i.length;w++){const P=i[w];let k;for(let F=0;F<P.length-1;F++){let j=P[F],N=P[F+1];j.x<e&&N.x<e||(j.x<e?j=new Qe(e,j.y+(e-j.x)/(N.x-j.x)*(N.y-j.y))._round():N.x<e&&(N=new Qe(e,j.y+(e-j.x)/(N.x-j.x)*(N.y-j.y))._round()),j.y<r&&N.y<r||(j.y<r?j=new Qe(j.x+(r-j.y)/(N.y-j.y)*(N.x-j.x),r)._round():N.y<r&&(N=new Qe(j.x+(r-j.y)/(N.y-j.y)*(N.x-j.x),r)._round()),j.x>=o&&N.x>=o||(j.x>=o?j=new Qe(o,j.y+(o-j.x)/(N.x-j.x)*(N.y-j.y))._round():N.x>=o&&(N=new Qe(o,j.y+(o-j.x)/(N.x-j.x)*(N.y-j.y))._round()),j.y>=p&&N.y>=p||(j.y>=p?j=new Qe(j.x+(p-j.y)/(N.y-j.y)*(N.x-j.x),p)._round():N.y>=p&&(N=new Qe(j.x+(p-j.y)/(N.y-j.y)*(N.x-j.x),p)._round()),k&&j.equals(k[k.length-1])||(k=[j],y.push(k)),k.push(N)))))}}return y}function Gh(i,e,r,o){const p=[],y=i.image,w=y.pixelRatio,P=y.paddedRect.w-2,k=y.paddedRect.h-2,F=i.right-i.left,j=i.bottom-i.top,N=y.stretchX||[[0,P]],W=y.stretchY||[[0,k]],Z=(It,Ut)=>It+Ut[1]-Ut[0],K=N.reduce(Z,0),me=W.reduce(Z,0),ue=P-K,Me=k-me;let Xe=0,Pe=K,Be=0,ht=me,ct=0,$t=ue,Qt=0,Bt=Me;if(y.content&&o){const It=y.content;Xe=kl(N,0,It[0]),Be=kl(W,0,It[1]),Pe=kl(N,It[0],It[2]),ht=kl(W,It[1],It[3]),ct=It[0]-Xe,Qt=It[1]-Be,$t=It[2]-It[0]-Pe,Bt=It[3]-It[1]-ht}const Ot=(It,Ut,Ft,St)=>{const ui=Dl(It.stretch-Xe,Pe,F,i.left),si=Ol(It.fixed-ct,$t,It.stretch,K),Ii=Dl(Ut.stretch-Be,ht,j,i.top),mr=Ol(Ut.fixed-Qt,Bt,Ut.stretch,me),xr=Dl(Ft.stretch-Xe,Pe,F,i.left),Ur=Ol(Ft.fixed-ct,$t,Ft.stretch,K),ns=Dl(St.stretch-Be,ht,j,i.top),ln=Ol(St.fixed-Qt,Bt,St.stretch,me),zr=new Qe(ui,Ii),Yr=new Qe(xr,Ii),cn=new Qe(xr,ns),mn=new Qe(ui,ns),An=new Qe(si/w,mr/w),Fr=new Qe(Ur/w,ln/w),hn=e*Math.PI/180;if(hn){const Mn=Math.sin(hn),kn=Math.cos(hn),Sr=[kn,-Mn,Mn,kn];zr._matMult(Sr),Yr._matMult(Sr),mn._matMult(Sr),cn._matMult(Sr)}const gn=It.stretch+It.fixed,Tn=Ut.stretch+Ut.fixed;return{tl:zr,tr:Yr,bl:mn,br:cn,tex:{x:y.paddedRect.x+1+gn,y:y.paddedRect.y+1+Tn,w:Ft.stretch+Ft.fixed-gn,h:St.stretch+St.fixed-Tn},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:An,pixelOffsetBR:Fr,minFontScaleX:$t/w/F,minFontScaleY:Bt/w/j,isSDF:r}};if(o&&(y.stretchX||y.stretchY)){const It=Xh(N,ue,K),Ut=Xh(W,Me,me);for(let Ft=0;Ft<It.length-1;Ft++){const St=It[Ft],ui=It[Ft+1];for(let si=0;si<Ut.length-1;si++)p.push(Ot(St,Ut[si],ui,Ut[si+1]))}}else p.push(Ot({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:P+1},{fixed:0,stretch:k+1}));return p}function kl(i,e,r){let o=0;for(const p of i)o+=Math.max(e,Math.min(r,p[1]))-Math.max(e,Math.min(r,p[0]));return o}function Xh(i,e,r){const o=[{fixed:-1,stretch:0}];for(const[p,y]of i){const w=o[o.length-1];o.push({fixed:p-w.stretch,stretch:w.stretch}),o.push({fixed:p-w.stretch,stretch:w.stretch+(y-p)})}return o.push({fixed:e+1,stretch:r}),o}function Dl(i,e,r,o){return i/e*r+o}function Ol(i,e,r,o){return i-e*r/o}Rt("Anchor",ko);class Ll{constructor(e,r,o,p,y,w,P,k,F,j){if(this.boxStartIndex=e.length,F){let N=w.top,W=w.bottom;const Z=w.collisionPadding;Z&&(N-=Z[1],W+=Z[3]);let K=W-N;K>0&&(K=Math.max(10,K),this.circleDiameter=K)}else{let N=w.top*P-k[0],W=w.bottom*P+k[2],Z=w.left*P-k[3],K=w.right*P+k[1];const me=w.collisionPadding;if(me&&(Z-=me[0]*P,N-=me[1]*P,K+=me[2]*P,W+=me[3]*P),j){const ue=new Qe(Z,N),Me=new Qe(K,N),Xe=new Qe(Z,W),Pe=new Qe(K,W),Be=j*Math.PI/180;ue._rotate(Be),Me._rotate(Be),Xe._rotate(Be),Pe._rotate(Be),Z=Math.min(ue.x,Me.x,Xe.x,Pe.x),K=Math.max(ue.x,Me.x,Xe.x,Pe.x),N=Math.min(ue.y,Me.y,Xe.y,Pe.y),W=Math.max(ue.y,Me.y,Xe.y,Pe.y)}e.emplaceBack(r.x,r.y,Z,N,K,W,o,p,y)}this.boxEndIndex=e.length}}class $d{constructor(e=[],r=qd){if(this.data=e,this.length=this.data.length,this.compare=r,this.length>0)for(let o=(this.length>>1)-1;o>=0;o--)this._down(o)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const e=this.data[0],r=this.data.pop();return this.length--,this.length>0&&(this.data[0]=r,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:r,compare:o}=this,p=r[e];for(;e>0;){const y=e-1>>1,w=r[y];if(o(p,w)>=0)break;r[e]=w,e=y}r[e]=p}_down(e){const{data:r,compare:o}=this,p=this.length>>1,y=r[e];for(;e<p;){let w=1+(e<<1),P=r[w];const k=w+1;if(k<this.length&&o(r[k],P)<0&&(w=k,P=r[k]),o(P,y)>=0)break;r[e]=P,e=w}r[e]=y}}function qd(i,e){return i<e?-1:i>e?1:0}function Yd(i,e=1,r=!1){let o=1/0,p=1/0,y=-1/0,w=-1/0;const P=i[0];for(let Z=0;Z<P.length;Z++){const K=P[Z];(!Z||K.x<o)&&(o=K.x),(!Z||K.y<p)&&(p=K.y),(!Z||K.x>y)&&(y=K.x),(!Z||K.y>w)&&(w=K.y)}const k=Math.min(y-o,w-p);let F=k/2;const j=new $d([],Hd);if(k===0)return new Qe(o,p);for(let Z=o;Z<y;Z+=k)for(let K=p;K<w;K+=k)j.push(new Ta(Z+F,K+F,F,i));let N=function(Z){let K=0,me=0,ue=0;const Me=Z[0];for(let Xe=0,Pe=Me.length,Be=Pe-1;Xe<Pe;Be=Xe++){const ht=Me[Xe],ct=Me[Be],$t=ht.x*ct.y-ct.x*ht.y;me+=(ht.x+ct.x)*$t,ue+=(ht.y+ct.y)*$t,K+=3*$t}return new Ta(me/K,ue/K,0,Z)}(i),W=j.length;for(;j.length;){const Z=j.pop();(Z.d>N.d||!N.d)&&(N=Z,r&&console.log("found best %d after %d probes",Math.round(1e4*Z.d)/1e4,W)),Z.max-N.d<=e||(F=Z.h/2,j.push(new Ta(Z.p.x-F,Z.p.y-F,F,i)),j.push(new Ta(Z.p.x+F,Z.p.y-F,F,i)),j.push(new Ta(Z.p.x-F,Z.p.y+F,F,i)),j.push(new Ta(Z.p.x+F,Z.p.y+F,F,i)),W+=4)}return r&&(console.log(`num probes: ${W}`),console.log(`best distance: ${N.d}`)),N.p}function Hd(i,e){return e.max-i.max}function Ta(i,e,r,o){this.p=new Qe(i,e),this.h=r,this.d=function(p,y){let w=!1,P=1/0;for(let k=0;k<y.length;k++){const F=y[k];for(let j=0,N=F.length,W=N-1;j<N;W=j++){const Z=F[j],K=F[W];Z.y>p.y!=K.y>p.y&&p.x<(K.x-Z.x)*(p.y-Z.y)/(K.y-Z.y)+Z.x&&(w=!w),P=Math.min(P,Jc(p,Z,K))}}return(w?1:-1)*Math.sqrt(P)}(this.p,o),this.max=this.d+this.h*Math.SQRT2}const gc=Number.POSITIVE_INFINITY;function Wh(i,e){return e[1]!==gc?function(r,o,p){let y=0,w=0;switch(o=Math.abs(o),p=Math.abs(p),r){case"top-right":case"top-left":case"top":w=p-7;break;case"bottom-right":case"bottom-left":case"bottom":w=7-p}switch(r){case"top-right":case"bottom-right":case"right":y=-o;break;case"top-left":case"bottom-left":case"left":y=o}return[y,w]}(i,e[0],e[1]):function(r,o){let p=0,y=0;o<0&&(o=0);const w=o/Math.sqrt(2);switch(r){case"top-right":case"top-left":y=w-7;break;case"bottom-right":case"bottom-left":y=7-w;break;case"bottom":y=7-o;break;case"top":y=o-7}switch(r){case"top-right":case"bottom-right":p=-w;break;case"top-left":case"bottom-left":p=w;break;case"left":p=o;break;case"right":p=-o}return[p,y]}(i,e[0])}function _c(i){switch(i){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Zd(i,e,r,o,p,y,w,P,k,F,j){let N=y.textMaxSize.evaluate(e,{});N===void 0&&(N=w);const W=i.layers[0].layout,Z=W.get("icon-offset").evaluate(e,{},j),K=qh(r.horizontal),me=w/24,ue=i.tilePixelRatio*me,Me=i.tilePixelRatio*N/24,Xe=i.tilePixelRatio*P,Pe=i.tilePixelRatio*W.get("symbol-spacing"),Be=W.get("text-padding")*i.tilePixelRatio,ht=function(St,ui,si,Ii=1){const mr=St.get("icon-padding").evaluate(ui,{},si),xr=mr&&mr.values;return[xr[0]*Ii,xr[1]*Ii,xr[2]*Ii,xr[3]*Ii]}(W,e,j,i.tilePixelRatio),ct=W.get("text-max-angle")/180*Math.PI,$t=W.get("text-rotation-alignment")!=="viewport"&&W.get("symbol-placement")!=="point",Qt=W.get("icon-rotation-alignment")==="map"&&W.get("symbol-placement")!=="point",Bt=W.get("symbol-placement"),Ot=Pe/2,It=W.get("icon-text-fit");let Ut;o&&It!=="none"&&(i.allowVerticalPlacement&&r.vertical&&(Ut=zh(o,r.vertical,It,W.get("icon-text-fit-padding"),Z,me)),K&&(o=zh(o,K,It,W.get("icon-text-fit-padding"),Z,me)));const Ft=(St,ui)=>{ui.x<0||ui.x>=Br||ui.y<0||ui.y>=Br||function(si,Ii,mr,xr,Ur,ns,ln,zr,Yr,cn,mn,An,Fr,hn,gn,Tn,Mn,kn,Sr,Hr,Fi,Xn,un,_n,_s){const Es=si.addToLineVertexArray(Ii,mr);let Ps,lo,ys,ss,Dn=0,co=0,il=0,cu=0,Pc=-1,Ic=-1;const ho={};let hu=qr.exports(""),Ac=0,Mc=0;if(zr._unevaluatedLayout.getValue("text-radial-offset")===void 0?[Ac,Mc]=zr.layout.get("text-offset").evaluate(Fi,{},_n).map(On=>On*en):(Ac=zr.layout.get("text-radial-offset").evaluate(Fi,{},_n)*en,Mc=gc),si.allowVerticalPlacement&&xr.vertical){const On=zr.layout.get("text-rotate").evaluate(Fi,{},_n)+90;ys=new Ll(Yr,Ii,cn,mn,An,xr.vertical,Fr,hn,gn,On),ln&&(ss=new Ll(Yr,Ii,cn,mn,An,ln,Mn,kn,gn,On))}if(Ur){const On=zr.layout.get("icon-rotate").evaluate(Fi,{}),Xs=zr.layout.get("icon-text-fit")!=="none",rl=Gh(Ur,On,un,Xs),nl=ln?Gh(ln,On,un,Xs):void 0;lo=new Ll(Yr,Ii,cn,mn,An,Ur,Mn,kn,!1,On),Dn=4*rl.length;const fu=si.iconSizeData;let sa=null;fu.kind==="source"?(sa=[ao*zr.layout.get("icon-size").evaluate(Fi,{})],sa[0]>Do&&U(`${si.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):fu.kind==="composite"&&(sa=[ao*Xn.compositeIconSizes[0].evaluate(Fi,{},_n),ao*Xn.compositeIconSizes[1].evaluate(Fi,{},_n)],(sa[0]>Do||sa[1]>Do)&&U(`${si.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),si.addSymbols(si.icon,rl,sa,Hr,Sr,Fi,n.WritingMode.none,Ii,Es.lineStartIndex,Es.lineLength,-1,_n),Pc=si.icon.placedSymbolArray.length-1,nl&&(co=4*nl.length,si.addSymbols(si.icon,nl,sa,Hr,Sr,Fi,n.WritingMode.vertical,Ii,Es.lineStartIndex,Es.lineLength,-1,_n),Ic=si.icon.placedSymbolArray.length-1)}const uu=Object.keys(xr.horizontal);for(const On of uu){const Xs=xr.horizontal[On];if(!Ps){hu=qr.exports(Xs.text);const nl=zr.layout.get("text-rotate").evaluate(Fi,{},_n);Ps=new Ll(Yr,Ii,cn,mn,An,Xs,Fr,hn,gn,nl)}const rl=Xs.positionedLines.length===1;if(il+=$h(si,Ii,Xs,ns,zr,gn,Fi,Tn,Es,xr.vertical?n.WritingMode.horizontal:n.WritingMode.horizontalOnly,rl?uu:[On],ho,Pc,Xn,_n),rl)break}xr.vertical&&(cu+=$h(si,Ii,xr.vertical,ns,zr,gn,Fi,Tn,Es,n.WritingMode.vertical,["vertical"],ho,Ic,Xn,_n));const hf=Ps?Ps.boxStartIndex:si.collisionBoxArray.length,uf=Ps?Ps.boxEndIndex:si.collisionBoxArray.length,df=ys?ys.boxStartIndex:si.collisionBoxArray.length,ff=ys?ys.boxEndIndex:si.collisionBoxArray.length,pf=lo?lo.boxStartIndex:si.collisionBoxArray.length,mf=lo?lo.boxEndIndex:si.collisionBoxArray.length,gf=ss?ss.boxStartIndex:si.collisionBoxArray.length,_f=ss?ss.boxEndIndex:si.collisionBoxArray.length;let Is=-1;const Ul=(On,Xs)=>On&&On.circleDiameter?Math.max(On.circleDiameter,Xs):Xs;Is=Ul(Ps,Is),Is=Ul(ys,Is),Is=Ul(lo,Is),Is=Ul(ss,Is);const du=Is>-1?1:0;du&&(Is*=_s/en),si.glyphOffsetArray.length>=Ea.MAX_GLYPHS&&U("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Fi.sortKey!==void 0&&si.addToSortKeyRanges(si.symbolInstances.length,Fi.sortKey),si.symbolInstances.emplaceBack(Ii.x,Ii.y,ho.right>=0?ho.right:-1,ho.center>=0?ho.center:-1,ho.left>=0?ho.left:-1,ho.vertical||-1,Pc,Ic,hu,hf,uf,df,ff,pf,mf,gf,_f,cn,il,cu,Dn,co,du,0,Fr,Ac,Mc,Is)}(i,ui,St,r,o,p,Ut,i.layers[0],i.collisionBoxArray,e.index,e.sourceLayerIndex,i.index,ue,[Be,Be,Be,Be],$t,k,Xe,ht,Qt,Z,e,y,F,j,w)};if(Bt==="line")for(const St of Nh(e.geometry,0,0,Br,Br)){const ui=Wd(St,Pe,ct,r.vertical||K,o,24,Me,i.overscaling,Br);for(const si of ui){const Ii=K;Ii&&Kd(i,Ii.text,Ot,si)||Ft(St,si)}}else if(Bt==="line-center"){for(const St of e.geometry)if(St.length>1){const ui=Xd(St,ct,r.vertical||K,o,24,Me);ui&&Ft(St,ui)}}else if(e.type==="Polygon")for(const St of nc(e.geometry,0)){const ui=Yd(St,16);Ft(St[0],new ko(ui.x,ui.y,0))}else if(e.type==="LineString")for(const St of e.geometry)Ft(St,new ko(St[0].x,St[0].y,0));else if(e.type==="Point")for(const St of e.geometry)for(const ui of St)Ft([ui],new ko(ui.x,ui.y,0))}const Do=32640;function $h(i,e,r,o,p,y,w,P,k,F,j,N,W,Z,K){const me=function(Xe,Pe,Be,ht,ct,$t,Qt,Bt){const Ot=ht.layout.get("text-rotate").evaluate($t,{})*Math.PI/180,It=[];for(const Ut of Pe.positionedLines)for(const Ft of Ut.positionedGlyphs){if(!Ft.rect)continue;const St=Ft.rect||{};let ui=4,si=!0,Ii=1,mr=0;const xr=(ct||Bt)&&Ft.vertical,Ur=Ft.metrics.advance*Ft.scale/2;if(Bt&&Pe.verticalizable){const Sr=(Ft.scale-1)*en,Hr=(en-Ft.metrics.width*Ft.scale)/2;mr=Ut.lineOffset/2-(Ft.imageName?-Hr:Sr)}if(Ft.imageName){const Sr=Qt[Ft.imageName];si=Sr.sdf,Ii=Sr.pixelRatio,ui=1/Ii}const ns=ct?[Ft.x+Ur,Ft.y]:[0,0];let ln=ct?[0,0]:[Ft.x+Ur+Be[0],Ft.y+Be[1]-mr],zr=[0,0];xr&&(zr=ln,ln=[0,0]);const Yr=(Ft.metrics.left-ui)*Ft.scale-Ur+ln[0],cn=(-Ft.metrics.top-ui)*Ft.scale+ln[1],mn=Yr+St.w*Ft.scale/Ii,An=cn+St.h*Ft.scale/Ii,Fr=new Qe(Yr,cn),hn=new Qe(mn,cn),gn=new Qe(Yr,An),Tn=new Qe(mn,An);if(xr){const Sr=new Qe(-Ur,Ur-Il),Hr=-Math.PI/2,Fi=12-Ur,Xn=new Qe(22-Fi,-(Ft.imageName?Fi:0)),un=new Qe(...zr);Fr._rotateAround(Hr,Sr)._add(Xn)._add(un),hn._rotateAround(Hr,Sr)._add(Xn)._add(un),gn._rotateAround(Hr,Sr)._add(Xn)._add(un),Tn._rotateAround(Hr,Sr)._add(Xn)._add(un)}if(Ot){const Sr=Math.sin(Ot),Hr=Math.cos(Ot),Fi=[Hr,-Sr,Sr,Hr];Fr._matMult(Fi),hn._matMult(Fi),gn._matMult(Fi),Tn._matMult(Fi)}const Mn=new Qe(0,0),kn=new Qe(0,0);It.push({tl:Fr,tr:hn,bl:gn,br:Tn,tex:St,writingMode:Pe.writingMode,glyphOffset:ns,sectionIndex:Ft.sectionIndex,isSDF:si,pixelOffsetTL:Mn,pixelOffsetBR:kn,minFontScaleX:0,minFontScaleY:0})}return It}(0,r,P,p,y,w,o,i.allowVerticalPlacement),ue=i.textSizeData;let Me=null;ue.kind==="source"?(Me=[ao*p.layout.get("text-size").evaluate(w,{})],Me[0]>Do&&U(`${i.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):ue.kind==="composite"&&(Me=[ao*Z.compositeTextSizes[0].evaluate(w,{},K),ao*Z.compositeTextSizes[1].evaluate(w,{},K)],(Me[0]>Do||Me[1]>Do)&&U(`${i.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),i.addSymbols(i.text,me,Me,P,y,w,F,e,k.lineStartIndex,k.lineLength,W,K);for(const Xe of j)N[Xe]=i.text.placedSymbolArray.length-1;return 4*me.length}function qh(i){for(const e in i)return i[e];return null}function Kd(i,e,r,o){const p=i.compareText;if(e in p){const y=p[e];for(let w=y.length-1;w>=0;w--)if(o.dist(y[w])<r)return!0}else p[e]=[];return p[e].push(o),!1}const Jd=Ao.VectorTileFeature.types,Qd=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function zl(i,e,r,o,p,y,w,P,k,F,j,N,W){const Z=P?Math.min(Do,Math.round(P[0])):0,K=P?Math.min(Do,Math.round(P[1])):0;i.emplaceBack(e,r,Math.round(32*o),Math.round(32*p),y,w,(Z<<1)+(k?1:0),K,16*F,16*j,256*N,256*W)}function yc(i,e,r){i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r)}function ef(i){for(const e of i.sections)if(hl(e.text))return!0;return!1}class vc{constructor(e){this.layoutVertexArray=new ms,this.indexArray=new wn,this.programConfigurations=e,this.segments=new ki,this.dynamicLayoutVertexArray=new ts,this.opacityVertexArray=new gs,this.placedSymbolArray=new bt}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(e,r,o,p){this.isEmpty()||(o&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Cd.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,r),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,Sd.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,Qd,!0),this.opacityVertexBuffer.itemSize=1),(o||p)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}Rt("SymbolBuffers",vc);class xc{constructor(e,r,o){this.layoutVertexArray=new e,this.layoutAttributes=r,this.indexArray=new o,this.segments=new ki,this.collisionVertexArray=new Nn}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,Td.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}Rt("CollisionBuffers",xc);class Ea{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(w=>w.id),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Jl([]),this.placementViewportMatrix=Jl([]);const r=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Fh(this.zoom,r["text-size"]),this.iconSizeData=Fh(this.zoom,r["icon-size"]);const o=this.layers[0].layout,p=o.get("symbol-sort-key"),y=o.get("symbol-z-order");this.canOverlap=wc(o,"text-overlap","text-allow-overlap")!=="never"||wc(o,"icon-overlap","icon-allow-overlap")!=="never"||o.get("text-ignore-placement")||o.get("icon-ignore-placement"),this.sortFeaturesByKey=y!=="viewport-y"&&!p.isConstant(),this.sortFeaturesByY=(y==="viewport-y"||y==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,o.get("symbol-placement")==="point"&&(this.writingModes=o.get("text-writing-mode").map(w=>n.WritingMode[w])),this.stateDependentLayerIds=this.layers.filter(w=>w.isStateDependent()).map(w=>w.id),this.sourceID=e.sourceID}createArrays(){this.text=new vc(new ea(this.layers,this.zoom,e=>/^text/.test(e))),this.icon=new vc(new ea(this.layers,this.zoom,e=>/^icon/.test(e))),this.glyphOffsetArray=new Dt,this.lineVertexArray=new Wt,this.symbolInstances=new Vt}calculateGlyphDependencies(e,r,o,p,y){for(let w=0;w<e.length;w++)if(r[e.charCodeAt(w)]=!0,(o||p)&&y){const P=Ja[e.charAt(w)];P&&(r[P.charCodeAt(0)]=!0)}}populate(e,r,o){const p=this.layers[0],y=p.layout,w=y.get("text-font"),P=y.get("text-field"),k=y.get("icon-image"),F=(P.value.kind!=="constant"||P.value.value instanceof _e&&!P.value.value.isEmpty()||P.value.value.toString().length>0)&&(w.value.kind!=="constant"||w.value.value.length>0),j=k.value.kind!=="constant"||!!k.value.value||Object.keys(k.parameters).length>0,N=y.get("symbol-sort-key");if(this.features=[],!F&&!j)return;const W=r.iconDependencies,Z=r.glyphDependencies,K=r.availableImages,me=new yr(this.zoom);for(const{feature:ue,id:Me,index:Xe,sourceLayerIndex:Pe}of e){const Be=p._featureFilter.needGeometry,ht=ia(ue,Be);if(!p._featureFilter.filter(me,ht,o))continue;let ct,$t;if(Be||(ht.geometry=ta(ue)),F){const Bt=p.getValueAndResolveTokens("text-field",ht,o,K),Ot=_e.factory(Bt);ef(Ot)&&(this.hasRTLText=!0),(!this.hasRTLText||Ko()==="unavailable"||this.hasRTLText&&Vn.isParsed())&&(ct=Pd(Ot,p,ht))}if(j){const Bt=p.getValueAndResolveTokens("icon-image",ht,o,K);$t=Bt instanceof Se?Bt:Se.fromString(Bt)}if(!ct&&!$t)continue;const Qt=this.sortFeaturesByKey?N.evaluate(ht,{},o):void 0;if(this.features.push({id:Me,text:ct,icon:$t,index:Xe,sourceLayerIndex:Pe,geometry:ht.geometry,properties:ue.properties,type:Jd[ue.type],sortKey:Qt}),$t&&(W[$t.name]=!0),ct){const Bt=w.evaluate(ht,{},o).join(","),Ot=y.get("text-rotation-alignment")!=="viewport"&&y.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(n.WritingMode.vertical)>=0;for(const It of ct.sections)if(It.image)W[It.image.name]=!0;else{const Ut=eo(ct.toString()),Ft=It.fontStack||Bt,St=Z[Ft]=Z[Ft]||{};this.calculateGlyphDependencies(It.text,St,Ot,this.allowVerticalPlacement,Ut)}}}y.get("symbol-placement")==="line"&&(this.features=function(ue){const Me={},Xe={},Pe=[];let Be=0;function ht(Bt){Pe.push(ue[Bt]),Be++}function ct(Bt,Ot,It){const Ut=Xe[Bt];return delete Xe[Bt],Xe[Ot]=Ut,Pe[Ut].geometry[0].pop(),Pe[Ut].geometry[0]=Pe[Ut].geometry[0].concat(It[0]),Ut}function $t(Bt,Ot,It){const Ut=Me[Ot];return delete Me[Ot],Me[Bt]=Ut,Pe[Ut].geometry[0].shift(),Pe[Ut].geometry[0]=It[0].concat(Pe[Ut].geometry[0]),Ut}function Qt(Bt,Ot,It){const Ut=It?Ot[0][Ot[0].length-1]:Ot[0][0];return`${Bt}:${Ut.x}:${Ut.y}`}for(let Bt=0;Bt<ue.length;Bt++){const Ot=ue[Bt],It=Ot.geometry,Ut=Ot.text?Ot.text.toString():null;if(!Ut){ht(Bt);continue}const Ft=Qt(Ut,It),St=Qt(Ut,It,!0);if(Ft in Xe&&St in Me&&Xe[Ft]!==Me[St]){const ui=$t(Ft,St,It),si=ct(Ft,St,Pe[ui].geometry);delete Me[Ft],delete Xe[St],Xe[Qt(Ut,Pe[si].geometry,!0)]=si,Pe[ui].geometry=null}else Ft in Xe?ct(Ft,St,It):St in Me?$t(Ft,St,It):(ht(Bt),Me[Ft]=Be-1,Xe[St]=Be-1)}return Pe.filter(Bt=>Bt.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((ue,Me)=>ue.sortKey-Me.sortKey)}update(e,r,o){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(e,r,this.layers,o),this.icon.programConfigurations.updatePaintArrays(e,r,this.layers,o))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,r){const o=this.lineVertexArray.length;if(e.segment!==void 0){let p=e.dist(r[e.segment+1]),y=e.dist(r[e.segment]);const w={};for(let P=e.segment+1;P<r.length;P++)w[P]={x:r[P].x,y:r[P].y,tileUnitDistanceFromAnchor:p},P<r.length-1&&(p+=r[P+1].dist(r[P]));for(let P=e.segment||0;P>=0;P--)w[P]={x:r[P].x,y:r[P].y,tileUnitDistanceFromAnchor:y},P>0&&(y+=r[P-1].dist(r[P]));for(let P=0;P<r.length;P++){const k=w[P];this.lineVertexArray.emplaceBack(k.x,k.y,k.tileUnitDistanceFromAnchor)}}return{lineStartIndex:o,lineLength:this.lineVertexArray.length-o}}addSymbols(e,r,o,p,y,w,P,k,F,j,N,W){const Z=e.indexArray,K=e.layoutVertexArray,me=e.segments.prepareSegment(4*r.length,K,Z,this.canOverlap?w.sortKey:void 0),ue=this.glyphOffsetArray.length,Me=me.vertexLength,Xe=this.allowVerticalPlacement&&P===n.WritingMode.vertical?Math.PI/2:0,Pe=w.text&&w.text.sections;for(let Be=0;Be<r.length;Be++){const{tl:ht,tr:ct,bl:$t,br:Qt,tex:Bt,pixelOffsetTL:Ot,pixelOffsetBR:It,minFontScaleX:Ut,minFontScaleY:Ft,glyphOffset:St,isSDF:ui,sectionIndex:si}=r[Be],Ii=me.vertexLength,mr=St[1];zl(K,k.x,k.y,ht.x,mr+ht.y,Bt.x,Bt.y,o,ui,Ot.x,Ot.y,Ut,Ft),zl(K,k.x,k.y,ct.x,mr+ct.y,Bt.x+Bt.w,Bt.y,o,ui,It.x,Ot.y,Ut,Ft),zl(K,k.x,k.y,$t.x,mr+$t.y,Bt.x,Bt.y+Bt.h,o,ui,Ot.x,It.y,Ut,Ft),zl(K,k.x,k.y,Qt.x,mr+Qt.y,Bt.x+Bt.w,Bt.y+Bt.h,o,ui,It.x,It.y,Ut,Ft),yc(e.dynamicLayoutVertexArray,k,Xe),Z.emplaceBack(Ii,Ii+1,Ii+2),Z.emplaceBack(Ii+1,Ii+2,Ii+3),me.vertexLength+=4,me.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(St[0]),Be!==r.length-1&&si===r[Be+1].sectionIndex||e.programConfigurations.populatePaintArrays(K.length,w,w.index,{},W,Pe&&Pe[si])}e.placedSymbolArray.emplaceBack(k.x,k.y,ue,this.glyphOffsetArray.length-ue,Me,F,j,k.segment,o?o[0]:0,o?o[1]:0,p[0],p[1],P,0,!1,0,N)}_addCollisionDebugVertex(e,r,o,p,y,w){return r.emplaceBack(0,0),e.emplaceBack(o.x,o.y,p,y,Math.round(w.x),Math.round(w.y))}addCollisionDebugVertices(e,r,o,p,y,w,P){const k=y.segments.prepareSegment(4,y.layoutVertexArray,y.indexArray),F=k.vertexLength,j=y.layoutVertexArray,N=y.collisionVertexArray,W=P.anchorX,Z=P.anchorY;this._addCollisionDebugVertex(j,N,w,W,Z,new Qe(e,r)),this._addCollisionDebugVertex(j,N,w,W,Z,new Qe(o,r)),this._addCollisionDebugVertex(j,N,w,W,Z,new Qe(o,p)),this._addCollisionDebugVertex(j,N,w,W,Z,new Qe(e,p)),k.vertexLength+=4;const K=y.indexArray;K.emplaceBack(F,F+1),K.emplaceBack(F+1,F+2),K.emplaceBack(F+2,F+3),K.emplaceBack(F+3,F),k.primitiveLength+=4}addDebugCollisionBoxes(e,r,o,p){for(let y=e;y<r;y++){const w=this.collisionBoxArray.get(y);this.addCollisionDebugVertices(w.x1,w.y1,w.x2,w.y2,p?this.textCollisionBox:this.iconCollisionBox,w.anchorPoint,o)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new xc(Ns,wh.members,Ss),this.iconCollisionBox=new xc(Ns,wh.members,Ss);for(let e=0;e<this.symbolInstances.length;e++){const r=this.symbolInstances.get(e);this.addDebugCollisionBoxes(r.textBoxStartIndex,r.textBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.verticalTextBoxStartIndex,r.verticalTextBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.iconBoxStartIndex,r.iconBoxEndIndex,r,!1),this.addDebugCollisionBoxes(r.verticalIconBoxStartIndex,r.verticalIconBoxEndIndex,r,!1)}}_deserializeCollisionBoxesForSymbol(e,r,o,p,y,w,P,k,F){const j={};for(let N=r;N<o;N++){const W=e.get(N);j.textBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,anchorPointX:W.anchorPointX,anchorPointY:W.anchorPointY},j.textFeatureIndex=W.featureIndex;break}for(let N=p;N<y;N++){const W=e.get(N);j.verticalTextBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,anchorPointX:W.anchorPointX,anchorPointY:W.anchorPointY},j.verticalTextFeatureIndex=W.featureIndex;break}for(let N=w;N<P;N++){const W=e.get(N);j.iconBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,anchorPointX:W.anchorPointX,anchorPointY:W.anchorPointY},j.iconFeatureIndex=W.featureIndex;break}for(let N=k;N<F;N++){const W=e.get(N);j.verticalIconBox={x1:W.x1,y1:W.y1,x2:W.x2,y2:W.y2,anchorPointX:W.anchorPointX,anchorPointY:W.anchorPointY},j.verticalIconFeatureIndex=W.featureIndex;break}return j}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let r=0;r<this.symbolInstances.length;r++){const o=this.symbolInstances.get(r);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,o.textBoxStartIndex,o.textBoxEndIndex,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o.iconBoxStartIndex,o.iconBoxEndIndex,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(e,r){const o=e.placedSymbolArray.get(r),p=o.vertexStartIndex+4*o.numGlyphs;for(let y=o.vertexStartIndex;y<p;y+=4)e.indexArray.emplaceBack(y,y+1,y+2),e.indexArray.emplaceBack(y+1,y+2,y+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const r=Math.sin(e),o=Math.cos(e),p=[],y=[],w=[];for(let P=0;P<this.symbolInstances.length;++P){w.push(P);const k=this.symbolInstances.get(P);p.push(0|Math.round(r*k.anchorX+o*k.anchorY)),y.push(k.featureIndex)}return w.sort((P,k)=>p[P]-p[k]||y[k]-y[P]),w}addToSortKeyRanges(e,r){const o=this.sortKeyRanges[this.sortKeyRanges.length-1];o&&o.sortKey===r?o.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:r,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const r of this.symbolInstanceIndexes){const o=this.symbolInstances.get(r);this.featureSortOrder.push(o.featureIndex),[o.rightJustifiedTextSymbolIndex,o.centerJustifiedTextSymbolIndex,o.leftJustifiedTextSymbolIndex].forEach((p,y,w)=>{p>=0&&w.indexOf(p)===y&&this.addIndicesForPlacedSymbol(this.text,p)}),o.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,o.verticalPlacedTextSymbolIndex),o.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,o.placedIconSymbolIndex),o.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,o.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Rt("SymbolBucket",Ea,{omit:["layers","collisionBoxArray","features","compareText"]}),Ea.MAX_GLYPHS=65535,Ea.addDynamicAttributes=yc;const tf=new Qr({"symbol-placement":new ni(Ue.layout_symbol["symbol-placement"]),"symbol-spacing":new ni(Ue.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ni(Ue.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new pi(Ue.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ni(Ue.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new ni(Ue.layout_symbol["icon-allow-overlap"]),"icon-overlap":new ni(Ue.layout_symbol["icon-overlap"]),"icon-ignore-placement":new ni(Ue.layout_symbol["icon-ignore-placement"]),"icon-optional":new ni(Ue.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ni(Ue.layout_symbol["icon-rotation-alignment"]),"icon-size":new pi(Ue.layout_symbol["icon-size"]),"icon-text-fit":new ni(Ue.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new ni(Ue.layout_symbol["icon-text-fit-padding"]),"icon-image":new pi(Ue.layout_symbol["icon-image"]),"icon-rotate":new pi(Ue.layout_symbol["icon-rotate"]),"icon-padding":new pi(Ue.layout_symbol["icon-padding"]),"icon-keep-upright":new ni(Ue.layout_symbol["icon-keep-upright"]),"icon-offset":new pi(Ue.layout_symbol["icon-offset"]),"icon-anchor":new pi(Ue.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ni(Ue.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ni(Ue.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ni(Ue.layout_symbol["text-rotation-alignment"]),"text-field":new pi(Ue.layout_symbol["text-field"]),"text-font":new pi(Ue.layout_symbol["text-font"]),"text-size":new pi(Ue.layout_symbol["text-size"]),"text-max-width":new pi(Ue.layout_symbol["text-max-width"]),"text-line-height":new ni(Ue.layout_symbol["text-line-height"]),"text-letter-spacing":new pi(Ue.layout_symbol["text-letter-spacing"]),"text-justify":new pi(Ue.layout_symbol["text-justify"]),"text-radial-offset":new pi(Ue.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ni(Ue.layout_symbol["text-variable-anchor"]),"text-anchor":new pi(Ue.layout_symbol["text-anchor"]),"text-max-angle":new ni(Ue.layout_symbol["text-max-angle"]),"text-writing-mode":new ni(Ue.layout_symbol["text-writing-mode"]),"text-rotate":new pi(Ue.layout_symbol["text-rotate"]),"text-padding":new ni(Ue.layout_symbol["text-padding"]),"text-keep-upright":new ni(Ue.layout_symbol["text-keep-upright"]),"text-transform":new pi(Ue.layout_symbol["text-transform"]),"text-offset":new pi(Ue.layout_symbol["text-offset"]),"text-allow-overlap":new ni(Ue.layout_symbol["text-allow-overlap"]),"text-overlap":new ni(Ue.layout_symbol["text-overlap"]),"text-ignore-placement":new ni(Ue.layout_symbol["text-ignore-placement"]),"text-optional":new ni(Ue.layout_symbol["text-optional"])});var bc={paint:new Qr({"icon-opacity":new pi(Ue.paint_symbol["icon-opacity"]),"icon-color":new pi(Ue.paint_symbol["icon-color"]),"icon-halo-color":new pi(Ue.paint_symbol["icon-halo-color"]),"icon-halo-width":new pi(Ue.paint_symbol["icon-halo-width"]),"icon-halo-blur":new pi(Ue.paint_symbol["icon-halo-blur"]),"icon-translate":new ni(Ue.paint_symbol["icon-translate"]),"icon-translate-anchor":new ni(Ue.paint_symbol["icon-translate-anchor"]),"text-opacity":new pi(Ue.paint_symbol["text-opacity"]),"text-color":new pi(Ue.paint_symbol["text-color"],{runtimeType:br,getOverride:i=>i.textColor,hasOverride:i=>!!i.textColor}),"text-halo-color":new pi(Ue.paint_symbol["text-halo-color"]),"text-halo-width":new pi(Ue.paint_symbol["text-halo-width"]),"text-halo-blur":new pi(Ue.paint_symbol["text-halo-blur"]),"text-translate":new ni(Ue.paint_symbol["text-translate"]),"text-translate-anchor":new ni(Ue.paint_symbol["text-translate-anchor"])}),layout:tf};class Yh{constructor(e){if(e.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=e.property.overrides?e.property.overrides.runtimeType:Ki,this.defaultValue=e}evaluate(e){if(e.formattedSection){const r=this.defaultValue.property.overrides;if(r&&r.hasOverride(e.formattedSection))return r.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Rt("FormatSectionOverride",Yh,{omit:["defaultValue"]});class Fl extends ps{constructor(e){super(e,bc)}recalculate(e,r){if(super.recalculate(e,r),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const o=this.layout.get("text-writing-mode");if(o){const p=[];for(const y of o)p.indexOf(y)<0&&p.push(y);this.layout._values["text-writing-mode"]=p}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(e,r,o,p){const y=this.layout.get(e).evaluate(r,{},o,p),w=this._unevaluatedLayout._values[e];return w.isDataDriven()||Hs(w.value)||!y?y:function(P,k){return k.replace(/{([^{}]+)}/g,(F,j)=>j in P?String(P[j]):"")}(r.properties,y)}createBucket(e){return new Ea(e)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const e of bc.paint.overridableProperties){if(!Fl.hasPaintOverride(this.layout,e))continue;const r=this.paint.get(e),o=new Yh(r),p=new Kn(o,r.property.specification);let y=null;y=r.value.kind==="constant"||r.value.kind==="source"?new Zs("source",p):new Jn("composite",p,r.value.zoomStops),this.paint._values[e]=new fs(r.property,y,r.parameters)}}_handleOverridablePaintPropertyUpdate(e,r,o){return!(!this.layout||r.isDataDriven()||o.isDataDriven())&&Fl.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,r){const o=e.get("text-field"),p=bc.paint.properties[r];let y=!1;const w=P=>{for(const k of P)if(p.overrides&&p.overrides.hasOverride(k))return void(y=!0)};if(o.value.kind==="constant"&&o.value.value instanceof _e)w(o.value.value.sections);else if(o.value.kind==="source"){const P=F=>{y||(F instanceof Jt&&qe(F.value)===wr?w(F.value.sections):F instanceof xo?w(F.sections):F.eachChild(P))},k=o.value;k._styleExpression&&P(k._styleExpression.expression)}return y}}function wc(i,e,r){let o="never";const p=i.get(e);return p?o=p:i.get(r)&&(o="always"),o}var rf={paint:new Qr({"background-color":new ni(Ue.paint_background["background-color"]),"background-pattern":new Ba(Ue.paint_background["background-pattern"]),"background-opacity":new ni(Ue.paint_background["background-opacity"])})},nf={paint:new Qr({"raster-opacity":new ni(Ue.paint_raster["raster-opacity"]),"raster-hue-rotate":new ni(Ue.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ni(Ue.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ni(Ue.paint_raster["raster-brightness-max"]),"raster-saturation":new ni(Ue.paint_raster["raster-saturation"]),"raster-contrast":new ni(Ue.paint_raster["raster-contrast"]),"raster-resampling":new ni(Ue.paint_raster["raster-resampling"]),"raster-fade-duration":new ni(Ue.paint_raster["raster-fade-duration"])})};class sf extends ps{constructor(e){super(e,{}),this.onAdd=r=>{this.implementation.onAdd&&this.implementation.onAdd(r,r.painter.context.gl)},this.onRemove=r=>{this.implementation.onRemove&&this.implementation.onRemove(r,r.painter.context.gl)},this.implementation=e}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}const of={circle:class extends ps{constructor(i){super(i,Fu)}createBucket(i){return new Hl(i)}queryRadius(i){const e=i;return Ga("circle-radius",this,e)+Ga("circle-stroke-width",this,e)+vl(this.paint.get("circle-translate"))}queryIntersectsFeature(i,e,r,o,p,y,w,P){const k=xl(i,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),y.angle,w),F=this.paint.get("circle-radius").evaluate(e,r)+this.paint.get("circle-stroke-width").evaluate(e,r),j=this.paint.get("circle-pitch-alignment")==="map",N=j?k:function(Z,K){return Z.map(me=>sh(me,K))}(k,P),W=j?F*w:F;for(const Z of o)for(const K of Z){const me=j?K:sh(K,P);let ue=W;const Me=bl([],[K.x,K.y,0,1],P);if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"?ue*=Me[3]/y.cameraToCenterDistance:this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"&&(ue*=y.cameraToCenterDistance/Me[3]),ku(N,me,ue))return!0}return!1}},heatmap:class extends ps{constructor(i){super(i,Bu),this._updateColorRamp()}createBucket(i){return new oh(i)}_handleSpecialPaintPropertyUpdate(i){i==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=lh({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}},hillshade:class extends ps{constructor(i){super(i,Uu)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}},fill:class extends ps{constructor(i){super(i,td)}recalculate(i,e){super.recalculate(i,e);const r=this.paint._values["fill-outline-color"];r.value.kind==="constant"&&r.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(i){return new ac(i)}queryRadius(){return vl(this.paint.get("fill-translate"))}queryIntersectsFeature(i,e,r,o,p,y,w){return Kc(xl(i,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),y.angle,w),o)}isTileClipped(){return!0}},"fill-extrusion":class extends ps{constructor(i){super(i,md)}createBucket(i){return new cc(i)}queryRadius(){return vl(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature(i,e,r,o,p,y,w,P){const k=xl(i,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),y.angle,w),F=this.paint.get("fill-extrusion-height").evaluate(e,r),j=this.paint.get("fill-extrusion-base").evaluate(e,r),N=function(Z,K,me,ue){const Me=[];for(const Xe of Z){const Pe=[Xe.x,Xe.y,0,1];bl(Pe,Pe,K),Me.push(new Qe(Pe[0]/Pe[3],Pe[1]/Pe[3]))}return Me}(k,P),W=function(Z,K,me,ue){const Me=[],Xe=[],Pe=ue[8]*K,Be=ue[9]*K,ht=ue[10]*K,ct=ue[11]*K,$t=ue[8]*me,Qt=ue[9]*me,Bt=ue[10]*me,Ot=ue[11]*me;for(const It of Z){const Ut=[],Ft=[];for(const St of It){const ui=St.x,si=St.y,Ii=ue[0]*ui+ue[4]*si+ue[12],mr=ue[1]*ui+ue[5]*si+ue[13],xr=ue[2]*ui+ue[6]*si+ue[14],Ur=ue[3]*ui+ue[7]*si+ue[15],ns=xr+ht,ln=Ur+ct,zr=Ii+$t,Yr=mr+Qt,cn=xr+Bt,mn=Ur+Ot,An=new Qe((Ii+Pe)/ln,(mr+Be)/ln);An.z=ns/ln,Ut.push(An);const Fr=new Qe(zr/mn,Yr/mn);Fr.z=cn/mn,Ft.push(Fr)}Me.push(Ut),Xe.push(Ft)}return[Me,Xe]}(o,j,F,P);return function(Z,K,me){let ue=1/0;Kc(me,K)&&(ue=_h(me,K[0]));for(let Me=0;Me<K.length;Me++){const Xe=K[Me],Pe=Z[Me];for(let Be=0;Be<Xe.length-1;Be++){const ht=Xe[Be],ct=[ht,Xe[Be+1],Pe[Be+1],Pe[Be],ht];Zc(me,ct)&&(ue=Math.min(ue,_h(me,ct)))}}return ue!==1/0&&ue}(W[0],W[1],N)}},line:class extends ps{constructor(i){super(i,vh),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(i){i==="line-gradient"&&(this.stepInterpolant=this._transitionablePaint._values["line-gradient"].value.expression._styleExpression.expression instanceof xt,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER)}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(i,e){super.recalculate(i,e),this.paint._values["line-floorwidth"]=xh.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,i)}createBucket(i){return new hc(i)}queryRadius(i){const e=i,r=bh(Ga("line-width",this,e),Ga("line-gap-width",this,e)),o=Ga("line-offset",this,e);return r/2+Math.abs(o)+vl(this.paint.get("line-translate"))}queryIntersectsFeature(i,e,r,o,p,y,w){const P=xl(i,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),y.angle,w),k=w/2*bh(this.paint.get("line-width").evaluate(e,r),this.paint.get("line-gap-width").evaluate(e,r)),F=this.paint.get("line-offset").evaluate(e,r);return F&&(o=function(j,N){const W=[];for(let Z=0;Z<j.length;Z++){const K=j[Z],me=[];for(let ue=0;ue<K.length;ue++){const Me=K[ue-1],Xe=K[ue],Pe=K[ue+1],Be=ue===0?new Qe(0,0):Xe.sub(Me)._unit()._perp(),ht=ue===K.length-1?new Qe(0,0):Pe.sub(Xe)._unit()._perp(),ct=Be._add(ht)._unit(),$t=ct.x*ht.x+ct.y*ht.y;$t!==0&&ct._mult(1/$t),me.push(ct._mult(N)._add(Xe))}W.push(me)}return W}(o,F*w)),function(j,N,W){for(let Z=0;Z<N.length;Z++){const K=N[Z];if(j.length>=3){for(let me=0;me<K.length;me++)if(va(j,K[me]))return!0}if(Du(j,K,W))return!0}return!1}(P,o,k)}isTileClipped(){return!0}},symbol:Fl,background:class extends ps{constructor(i){super(i,rf)}},raster:class extends ps{constructor(i){super(i,nf)}}};class af{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){delete this._channel,this._callback=()=>{}}}const Hh=63710088e-1;class Pr{constructor(e,r){if(isNaN(e)||isNaN(r))throw new Error(`Invalid LngLat object: (${e}, ${r})`);if(this.lng=+e,this.lat=+r,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Pr(c(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const r=Math.PI/180,o=this.lat*r,p=e.lat*r,y=Math.sin(o)*Math.sin(p)+Math.cos(o)*Math.cos(p)*Math.cos((e.lng-this.lng)*r);return Hh*Math.acos(Math.min(y,1))}toBounds(e=0){const r=360*e/40075017,o=r/Math.cos(Math.PI/180*this.lat);return new na(new Pr(this.lng-o,this.lat-r),new Pr(this.lng+o,this.lat+r))}static convert(e){if(e instanceof Pr)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new Pr(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new Pr(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class na{constructor(e,r){e&&(r?this.setSouthWest(e).setNorthEast(r):e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof Pr?new Pr(e.lng,e.lat):Pr.convert(e),this}setSouthWest(e){return this._sw=e instanceof Pr?new Pr(e.lng,e.lat):Pr.convert(e),this}extend(e){const r=this._sw,o=this._ne;let p,y;if(e instanceof Pr)p=e,y=e;else{if(!(e instanceof na))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(na.convert(e)):this.extend(Pr.convert(e)):this;if(p=e._sw,y=e._ne,!p||!y)return this}return r||o?(r.lng=Math.min(p.lng,r.lng),r.lat=Math.min(p.lat,r.lat),o.lng=Math.max(y.lng,o.lng),o.lat=Math.max(y.lat,o.lat)):(this._sw=new Pr(p.lng,p.lat),this._ne=new Pr(y.lng,y.lat)),this}getCenter(){return new Pr((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Pr(this.getWest(),this.getNorth())}getSouthEast(){return new Pr(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:r,lat:o}=Pr.convert(e);let p=this._sw.lng<=r&&r<=this._ne.lng;return this._sw.lng>this._ne.lng&&(p=this._sw.lng>=r&&r>=this._ne.lng),this._sw.lat<=o&&o<=this._ne.lat&&p}static convert(e){return e instanceof na?e:e&&new na(e)}}const Zh=2*Math.PI*Hh;function Kh(i){return Zh*Math.cos(i*Math.PI/180)}function Jh(i){return(180+i)/360}function Qh(i){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i*Math.PI/360)))/360}function eu(i,e){return i/Kh(e)}function Cc(i){return 360/Math.PI*Math.atan(Math.exp((180-360*i)*Math.PI/180))-90}class Rl{constructor(e,r,o=0){this.x=+e,this.y=+r,this.z=+o}static fromLngLat(e,r=0){const o=Pr.convert(e);return new Rl(Jh(o.lng),Qh(o.lat),eu(r,o.lat))}toLngLat(){return new Pr(360*this.x-180,Cc(this.y))}toAltitude(){return this.z*Kh(Cc(this.y))}meterInMercatorCoordinateUnits(){return 1/Zh*(e=Cc(this.y),1/Math.cos(e*Math.PI/180));var e}}function tu(i,e,r){var o=2*Math.PI*6378137/256/Math.pow(2,r);return[i*o-2*Math.PI*6378137/2,e*o-2*Math.PI*6378137/2]}class Sc{constructor(e,r,o){if(e<0||e>25||o<0||o>=Math.pow(2,e)||r<0||r>=Math.pow(2,e))throw new Error(`x=${r}, y=${o}, z=${e} outside of bounds. 0<=x<${Math.pow(2,e)}, 0<=y<${Math.pow(2,e)} 0<=z<=25 `);this.z=e,this.x=r,this.y=o,this.key=el(0,e,e,r,o)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,r,o){const p=(w=this.y,P=this.z,k=tu(256*(y=this.x),256*(w=Math.pow(2,P)-w-1),P),F=tu(256*(y+1),256*(w+1),P),k[0]+","+k[1]+","+F[0]+","+F[1]);var y,w,P,k,F;const j=function(N,W,Z){let K,me="";for(let ue=N;ue>0;ue--)K=1<<ue-1,me+=(W&K?1:0)+(Z&K?2:0);return me}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(o==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,r>1?"@2x":"").replace(/{quadkey}/g,j).replace(/{bbox-epsg-3857}/g,p)}isChildOf(e){const r=this.z-e.z;return r>0&&e.x===this.x>>r&&e.y===this.y>>r}getTilePoint(e){const r=Math.pow(2,this.z);return new Qe((e.x*r-this.x)*Br,(e.y*r-this.y)*Br)}toString(){return`${this.z}/${this.x}/${this.y}`}}class iu{constructor(e,r){this.wrap=e,this.canonical=r,this.key=el(e,r.z,r.z,r.x,r.y)}}class rs{constructor(e,r,o,p,y){if(e<o)throw new Error(`overscaledZ should be >= z; overscaledZ = ${e}; z = ${o}`);this.overscaledZ=e,this.wrap=r,this.canonical=new Sc(o,+p,+y),this.key=el(r,e,o,p,y)}clone(){return new rs(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){if(e>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${e}; overscaledZ = ${this.overscaledZ}`);const r=this.canonical.z-e;return e>this.canonical.z?new rs(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new rs(e,this.wrap,e,this.canonical.x>>r,this.canonical.y>>r)}calculateScaledKey(e,r){if(e>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${e}; overscaledZ = ${this.overscaledZ}`);const o=this.canonical.z-e;return e>this.canonical.z?el(this.wrap*+r,e,this.canonical.z,this.canonical.x,this.canonical.y):el(this.wrap*+r,e,e,this.canonical.x>>o,this.canonical.y>>o)}isChildOf(e){if(e.wrap!==this.wrap)return!1;const r=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.x===this.canonical.x>>r&&e.canonical.y===this.canonical.y>>r}children(e){if(this.overscaledZ>=e)return[new rs(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const r=this.canonical.z+1,o=2*this.canonical.x,p=2*this.canonical.y;return[new rs(r,this.wrap,r,o,p),new rs(r,this.wrap,r,o+1,p),new rs(r,this.wrap,r,o,p+1),new rs(r,this.wrap,r,o+1,p+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new rs(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new rs(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new iu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(e){return this.canonical.getTilePoint(new Rl(e.x-this.wrap,e.y))}}function el(i,e,r,o,p){(i*=2)<0&&(i=-1*i-1);const y=1<<r;return(y*y*i+y*p+o).toString(36)+r.toString(36)+e.toString(36)}Rt("CanonicalTileID",Sc),Rt("OverscaledTileID",rs,{omit:["posMatrix"]});class ru{constructor(e,r,o){if(this.uid=e,r.height!==r.width)throw new RangeError("DEM tiles must be square");if(o&&o!=="mapbox"&&o!=="terrarium")return void U(`"${o}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=r.height;const p=this.dim=r.height-2;this.data=new Uint32Array(r.data.buffer),this.encoding=o||"mapbox";for(let y=0;y<p;y++)this.data[this._idx(-1,y)]=this.data[this._idx(0,y)],this.data[this._idx(p,y)]=this.data[this._idx(p-1,y)],this.data[this._idx(y,-1)]=this.data[this._idx(y,0)],this.data[this._idx(y,p)]=this.data[this._idx(y,p-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(p,-1)]=this.data[this._idx(p-1,0)],this.data[this._idx(-1,p)]=this.data[this._idx(0,p-1)],this.data[this._idx(p,p)]=this.data[this._idx(p-1,p-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let y=0;y<p;y++)for(let w=0;w<p;w++){const P=this.get(y,w);P>this.max&&(this.max=P),P<this.min&&(this.min=P)}}get(e,r){const o=new Uint8Array(this.data.buffer),p=4*this._idx(e,r);return(this.encoding==="terrarium"?this._unpackTerrarium:this._unpackMapbox)(o[p],o[p+1],o[p+2])}getUnpackVector(){return this.encoding==="terrarium"?[256,1,1/256,32768]:[6553.6,25.6,.1,1e4]}_idx(e,r){if(e<-1||e>=this.dim+1||r<-1||r>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(r+1)*this.stride+(e+1)}_unpackMapbox(e,r,o){return(256*e*256+256*r+o)/10-1e4}_unpackTerrarium(e,r,o){return 256*e+r+o/256-32768}getPixels(){return new is({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(e,r,o){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let p=r*this.dim,y=r*this.dim+this.dim,w=o*this.dim,P=o*this.dim+this.dim;switch(r){case-1:p=y-1;break;case 1:y=p+1}switch(o){case-1:w=P-1;break;case 1:P=w+1}const k=-r*this.dim,F=-o*this.dim;for(let j=w;j<P;j++)for(let N=p;N<y;N++)this.data[this._idx(N,j)]=e.data[this._idx(N+k,j+F)]}}Rt("DEMData",ru);class nu{constructor(e){this._stringToNumber={},this._numberToString=[];for(let r=0;r<e.length;r++){const o=e[r];this._stringToNumber[o]=r,this._numberToString[r]=o}}encode(e){return this._stringToNumber[e]}decode(e){if(e>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${e} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[e]}}class su{constructor(e,r,o,p,y){this.type="Feature",this._vectorTileFeature=e,e._z=r,e._x=o,e._y=p,this.properties=e.properties,this.id=y}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={geometry:this.geometry};for(const r in this)r!=="_geometry"&&r!=="_vectorTileFeature"&&(e[r]=this[r]);return e}}class ou{constructor(e,r){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new ds(Br,16,0),this.grid3D=new ds(Br,16,0),this.featureIndexArray=new Pi,this.promoteId=r}insert(e,r,o,p,y,w){const P=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(o,p,y);const k=w?this.grid3D:this.grid;for(let F=0;F<r.length;F++){const j=r[F],N=[1/0,1/0,-1/0,-1/0];for(let W=0;W<j.length;W++){const Z=j[W];N[0]=Math.min(N[0],Z.x),N[1]=Math.min(N[1],Z.y),N[2]=Math.max(N[2],Z.x),N[3]=Math.max(N[3],Z.y)}N[0]<Br&&N[1]<Br&&N[2]>=0&&N[3]>=0&&k.insert(P,N[0],N[1],N[2],N[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new Ao.VectorTile(new uc(this.rawTileData)).layers,this.sourceLayerCoder=new nu(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(e,r,o,p){this.loadVTLayers();const y=e.params||{},w=Br/e.tileSize/e.scale,P=Ke(y.filter),k=e.queryGeometry,F=e.queryPadding*w,j=lu(k),N=this.grid.query(j.minX-F,j.minY-F,j.maxX+F,j.maxY+F),W=lu(e.cameraQueryGeometry),Z=this.grid3D.query(W.minX-F,W.minY-F,W.maxX+F,W.maxY+F,(ue,Me,Xe,Pe)=>function(Be,ht,ct,$t,Qt){for(const Ot of Be)if(ht<=Ot.x&&ct<=Ot.y&&$t>=Ot.x&&Qt>=Ot.y)return!0;const Bt=[new Qe(ht,ct),new Qe(ht,Qt),new Qe($t,Qt),new Qe($t,ct)];if(Be.length>2){for(const Ot of Bt)if(va(Be,Ot))return!0}for(let Ot=0;Ot<Be.length-1;Ot++)if(Lu(Be[Ot],Be[Ot+1],Bt))return!0;return!1}(e.cameraQueryGeometry,ue-F,Me-F,Xe+F,Pe+F));for(const ue of Z)N.push(ue);N.sort(lf);const K={};let me;for(let ue=0;ue<N.length;ue++){const Me=N[ue];if(Me===me)continue;me=Me;const Xe=this.featureIndexArray.get(Me);let Pe=null;this.loadMatchingFeature(K,Xe.bucketIndex,Xe.sourceLayerIndex,Xe.featureIndex,P,y.layers,y.availableImages,r,o,p,(Be,ht,ct)=>(Pe||(Pe=ta(Be)),ht.queryIntersectsFeature(k,Be,ct,Pe,this.z,e.transform,w,e.pixelPosMatrix)))}return K}loadMatchingFeature(e,r,o,p,y,w,P,k,F,j,N){const W=this.bucketLayerIDs[r];if(w&&!function(ue,Me){for(let Xe=0;Xe<ue.length;Xe++)if(Me.indexOf(ue[Xe])>=0)return!0;return!1}(w,W))return;const Z=this.sourceLayerCoder.decode(o),K=this.vtLayers[Z].feature(p);if(y.needGeometry){const ue=ia(K,!0);if(!y.filter(new yr(this.tileID.overscaledZ),ue,this.tileID.canonical))return}else if(!y.filter(new yr(this.tileID.overscaledZ),K))return;const me=this.getId(K,Z);for(let ue=0;ue<W.length;ue++){const Me=W[ue];if(w&&w.indexOf(Me)<0)continue;const Xe=k[Me];if(!Xe)continue;let Pe={};me&&j&&(Pe=j.getState(Xe.sourceLayer||"_geojsonTileLayer",me));const Be=d({},F[Me]);Be.paint=au(Be.paint,Xe.paint,K,Pe,P),Be.layout=au(Be.layout,Xe.layout,K,Pe,P);const ht=!N||N(K,Xe,Pe);if(!ht)continue;const ct=new su(K,this.z,this.x,this.y,me);ct.layer=Be;let $t=e[Me];$t===void 0&&($t=e[Me]=[]),$t.push({featureIndex:p,feature:ct,intersectionZ:ht})}}lookupSymbolFeatures(e,r,o,p,y,w,P,k){const F={};this.loadVTLayers();const j=Ke(y);for(const N of e)this.loadMatchingFeature(F,o,p,N,j,w,P,k,r);return F}hasLayer(e){for(const r of this.bucketLayerIDs)for(const o of r)if(e===o)return!0;return!1}getId(e,r){let o=e.id;return this.promoteId&&(o=e.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[r]],typeof o=="boolean"&&(o=Number(o))),o}}function au(i,e,r,o,p){return C(i,(y,w)=>{const P=e instanceof Qo?e.get(w):null;return P&&P.evaluate?P.evaluate(r,o,p):P})}function lu(i){let e=1/0,r=1/0,o=-1/0,p=-1/0;for(const y of i)e=Math.min(e,y.x),r=Math.min(r,y.y),o=Math.max(o,y.x),p=Math.max(p,y.y);return{minX:e,minY:r,maxX:o,maxY:p}}function lf(i,e){return e-i}var Tc;Rt("FeatureIndex",ou,{omit:["rawTileData","sourceLayerCoder"]}),n.PerformanceMarkers=void 0,(Tc=n.PerformanceMarkers||(n.PerformanceMarkers={})).create="create",Tc.load="load",Tc.fullLoad="fullLoad";let Bl=null,tl=[];const Ec=1e3/30,cf={mark(i){performance.mark(i)},frame(i){const e=i;Bl!=null&&tl.push(e-Bl),Bl=e},clearMetrics(){Bl=null,tl=[],performance.clearMeasures("loadTime"),performance.clearMeasures("fullLoadTime");for(const i in n.PerformanceMarkers)performance.clearMarks(n.PerformanceMarkers[i])},getPerformanceMetrics(){performance.measure("loadTime",n.PerformanceMarkers.create,n.PerformanceMarkers.load),performance.measure("fullLoadTime",n.PerformanceMarkers.create,n.PerformanceMarkers.fullLoad);const i=performance.getEntriesByName("loadTime")[0].duration,e=performance.getEntriesByName("fullLoadTime")[0].duration,r=tl.length,o=1/(tl.reduce((y,w)=>y+w,0)/r/1e3),p=tl.filter(y=>y>Ec).reduce((y,w)=>y+(w-Ec)/Ec,0);return{loadTime:i,fullLoadTime:e,fps:o,percentDroppedFrames:p/(r+p)*100}}};n.AJAXError=je,n.ARRAY_TYPE=Sn,n.Actor=class{constructor(i,e,r){this.target=i,this.parent=e,this.mapId=r,this.callbacks={},this.tasks={},this.taskQueue=[],this.cancelCallbacks={},u(["receive","process"],this),this.invoker=new af(this.process),this.target.addEventListener("message",this.receive,!1),this.globalScope=ge()?i:window}send(i,e,r,o,p=!1){const y=Math.round(1e18*Math.random()).toString(36).substring(0,10);r&&(this.callbacks[y]=r);const w=vt(this.globalScope)?void 0:[];return this.target.postMessage({id:y,type:i,hasCallback:!!r,targetMapId:o,mustQueue:p,sourceMapId:this.mapId,data:Un(e,w)},w),{cancel:()=>{r&&delete this.callbacks[y],this.target.postMessage({id:y,type:"<cancel>",targetMapId:o,sourceMapId:this.mapId})}}}receive(i){const e=i.data,r=e.id;if(r&&(!e.targetMapId||this.mapId===e.targetMapId))if(e.type==="<cancel>"){delete this.tasks[r];const o=this.cancelCallbacks[r];delete this.cancelCallbacks[r],o&&o()}else ge()||e.mustQueue?(this.tasks[r]=e,this.taskQueue.push(r),this.invoker.trigger()):this.processTask(r,e)}process(){if(!this.taskQueue.length)return;const i=this.taskQueue.shift(),e=this.tasks[i];delete this.tasks[i],this.taskQueue.length&&this.invoker.trigger(),e&&this.processTask(i,e)}processTask(i,e){if(e.type==="<response>"){const r=this.callbacks[i];delete this.callbacks[i],r&&(e.error?r(jn(e.error)):r(null,jn(e.data)))}else{let r=!1;const o=vt(this.globalScope)?void 0:[],p=e.hasCallback?(P,k)=>{r=!0,delete this.cancelCallbacks[i],this.target.postMessage({id:i,type:"<response>",sourceMapId:this.mapId,error:P?Un(P):null,data:Un(k,o)},o)}:P=>{r=!0};let y=null;const w=jn(e.data);if(this.parent[e.type])y=this.parent[e.type](e.sourceMapId,w,p);else if(this.parent.getWorkerSource){const P=e.type.split(".");y=this.parent.getWorkerSource(e.sourceMapId,P[0],w.source)[P[1]](w,p)}else p(new Error(`Could not find function ${e.type}`));!r&&y&&y.cancel&&(this.cancelCallbacks[i]=y.cancel)}}remove(){this.invoker.remove(),this.target.removeEventListener("message",this.receive,!1)}},n.AlphaImage=Wa,n.CanonicalTileID=Sc,n.CollisionBoxArray=et,n.CollisionCircleLayoutArray=class extends V{},n.Color=te,n.DEMData=ru,n.DataConstantProperty=ni,n.DictionaryCoder=nu,n.EXTENT=Br,n.ErrorEvent=Di,n.EvaluationParameters=yr,n.Event=mi,n.Evented=wi,n.FeatureIndex=ou,n.FillBucket=ac,n.FillExtrusionBucket=cc,n.GeoJSONFeature=su,n.ImageAtlas=Mh,n.ImagePosition=fc,n.LineBucket=hc,n.LineStripIndexArray=class extends he{},n.LngLat=Pr,n.LngLatBounds=na,n.MercatorCoordinate=Rl,n.ONE_EM=en,n.OverscaledTileID=rs,n.PerformanceUtils=cf,n.PosArray=hi,n.Properties=Qr,n.QuadTriangleArray=class extends H{},n.RGBAImage=is,n.RasterBoundsArray=class extends f{},n.RequestPerformance=class{constructor(i){this._marks={start:[i.url,"start"].join("#"),end:[i.url,"end"].join("#"),measure:i.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let i=performance.getEntriesByName(this._marks.measure);return i.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),i=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),i}},n.ResourceType=nt,n.SegmentVector=ki,n.SymbolBucket=Ea,n.Transitionable=fl,n.TriangleIndexArray=wn,n.Uniform1f=no,n.Uniform1i=class extends ro{constructor(i,e){super(i,e),this.current=0}set(i){this.current!==i&&(this.current=i,this.gl.uniform1i(this.location,i))}},n.Uniform2f=class extends ro{constructor(i,e){super(i,e),this.current=[0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]||(this.current=i,this.gl.uniform2f(this.location,i[0],i[1]))}},n.Uniform3f=class extends ro{constructor(i,e){super(i,e),this.current=[0,0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]&&i[2]===this.current[2]||(this.current=i,this.gl.uniform3f(this.location,i[0],i[1],i[2]))}},n.Uniform4f=_a,n.UniformColor=$c,n.UniformMatrix4f=class extends ro{constructor(i,e){super(i,e),this.current=Au}set(i){if(i[12]!==this.current[12]||i[0]!==this.current[0])return this.current=i,void this.gl.uniformMatrix4fv(this.location,!1,i);for(let e=1;e<16;e++)if(i[e]!==this.current[e]){this.current=i,this.gl.uniformMatrix4fv(this.location,!1,i);break}}},n.UnwrappedTileID=iu,n.ValidationError=yt,n.ZoomHistory=Fs,n.add=function(i,e,r){return i[0]=e[0]+r[0],i[1]=e[1]+r[1],i[2]=e[2]+r[2],i},n.addDynamicAttributes=yc,n.asyncAll=function(i,e,r){if(!i.length)return r(null,[]);let o=i.length;const p=new Array(i.length);let y=null;i.forEach((w,P)=>{e(w,(k,F)=>{k&&(y=k),p[P]=F,--o==0&&r(y,p)})})},n.bezier=v,n.bindAll=u,n.cacheEntryPossiblyAdded=function(i){q++,q>ve&&(i.getActor().send("enforceCacheSizeLimit",ie),q=0)},n.clamp=a,n.clearTileCache=function(i){const e=caches.delete(Q);i&&e.catch(i).then(()=>i())},n.clipLine=Nh,n.clone=function(i){var e=new Sn(16);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],e},n.clone$1=A,n.clone$2=function(i){var e=new Sn(3);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e},n.collisionCircleLayout=Ed,n.config=Et,n.copy=function(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i},n.create=function(){var i=new Sn(16);return Sn!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i},n.create$1=eh,n.createExpression=xn,n.createFilter=Ke,n.createLayout=Lr,n.createStyleLayer=function(i){return i.type==="custom"?new sf(i):new of[i.type](i)},n.cross=function(i,e,r){var o=e[0],p=e[1],y=e[2],w=r[0],P=r[1],k=r[2];return i[0]=p*k-y*P,i[1]=y*w-o*k,i[2]=o*P-p*w,i},n.dot=function(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]},n.dot$1=function(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]+i[3]*e[3]},n.ease=h,n.emitValidationErrors=us,n.enforceCacheSizeLimit=function(i){J(),se&&se.then(e=>{e.keys().then(r=>{for(let o=0;o<r.length-i;o++)e.delete(r[o])})})},n.equals=function(i,e){var r=i[0],o=i[1],p=i[2],y=i[3],w=i[4],P=i[5],k=i[6],F=i[7],j=i[8],N=i[9],W=i[10],Z=i[11],K=i[12],me=i[13],ue=i[14],Me=i[15],Xe=e[0],Pe=e[1],Be=e[2],ht=e[3],ct=e[4],$t=e[5],Qt=e[6],Bt=e[7],Ot=e[8],It=e[9],Ut=e[10],Ft=e[11],St=e[12],ui=e[13],si=e[14],Ii=e[15];return Math.abs(r-Xe)<=Cn*Math.max(1,Math.abs(r),Math.abs(Xe))&&Math.abs(o-Pe)<=Cn*Math.max(1,Math.abs(o),Math.abs(Pe))&&Math.abs(p-Be)<=Cn*Math.max(1,Math.abs(p),Math.abs(Be))&&Math.abs(y-ht)<=Cn*Math.max(1,Math.abs(y),Math.abs(ht))&&Math.abs(w-ct)<=Cn*Math.max(1,Math.abs(w),Math.abs(ct))&&Math.abs(P-$t)<=Cn*Math.max(1,Math.abs(P),Math.abs($t))&&Math.abs(k-Qt)<=Cn*Math.max(1,Math.abs(k),Math.abs(Qt))&&Math.abs(F-Bt)<=Cn*Math.max(1,Math.abs(F),Math.abs(Bt))&&Math.abs(j-Ot)<=Cn*Math.max(1,Math.abs(j),Math.abs(Ot))&&Math.abs(N-It)<=Cn*Math.max(1,Math.abs(N),Math.abs(It))&&Math.abs(W-Ut)<=Cn*Math.max(1,Math.abs(W),Math.abs(Ut))&&Math.abs(Z-Ft)<=Cn*Math.max(1,Math.abs(Z),Math.abs(Ft))&&Math.abs(K-St)<=Cn*Math.max(1,Math.abs(K),Math.abs(St))&&Math.abs(me-ui)<=Cn*Math.max(1,Math.abs(me),Math.abs(ui))&&Math.abs(ue-si)<=Cn*Math.max(1,Math.abs(ue),Math.abs(si))&&Math.abs(Me-Ii)<=Cn*Math.max(1,Math.abs(Me),Math.abs(Ii))},n.evaluateSizeForFeature=function(i,{uSize:e,uSizeT:r},{lowerSize:o,upperSize:p}){return i.kind==="source"?o/ao:i.kind==="composite"?Ct(o/ao,p/ao,r):e},n.evaluateSizeForZoom=function(i,e){let r=0,o=0;if(i.kind==="constant")o=i.layoutSize;else if(i.kind!=="source"){const{interpolationType:p,minZoom:y,maxZoom:w}=i,P=p?a(rn.interpolationFactor(p,e,y,w),0,1):0;i.kind==="camera"?o=Ct(i.minSize,i.maxSize,P):r=P}return{uSizeT:r,uSize:o}},n.evaluateVariableOffset=Wh,n.evented=Ra,n.exported=mt,n.exported$1=ce,n.extend=d,n.filterObject=S,n.fromRotation=function(i,e){var r=Math.sin(e),o=Math.cos(e);return i[0]=o,i[1]=r,i[2]=0,i[3]=-r,i[4]=o,i[5]=0,i[6]=0,i[7]=0,i[8]=1,i},n.fromScaling=function(i,e){return i[0]=e[0],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e[1],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=e[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},n.getAnchorAlignment=mc,n.getAnchorJustification=_c,n.getArrayBuffer=$e,n.getImage=He,n.getJSON=function(i,e){return Je(d(i,{type:"json"}),e)},n.getOverlapMode=wc,n.getRTLTextPluginStatus=Ko,n.getReferrer=Ce,n.getVideo=function(i,e){const r=window.document.createElement("video");r.muted=!0,r.onloadstart=function(){e(null,r)};for(let o=0;o<i.length;o++){const p=window.document.createElement("source");lt(i[o])||(r.crossOrigin="Anonymous"),p.src=i[o],r.appendChild(p)}return{cancel:()=>{}}},n.identity=Jl,n.invert=function(i,e){var r=e[0],o=e[1],p=e[2],y=e[3],w=e[4],P=e[5],k=e[6],F=e[7],j=e[8],N=e[9],W=e[10],Z=e[11],K=e[12],me=e[13],ue=e[14],Me=e[15],Xe=r*P-o*w,Pe=r*k-p*w,Be=r*F-y*w,ht=o*k-p*P,ct=o*F-y*P,$t=p*F-y*k,Qt=j*me-N*K,Bt=j*ue-W*K,Ot=j*Me-Z*K,It=N*ue-W*me,Ut=N*Me-Z*me,Ft=W*Me-Z*ue,St=Xe*Ft-Pe*Ut+Be*It+ht*Ot-ct*Bt+$t*Qt;return St?(i[0]=(P*Ft-k*Ut+F*It)*(St=1/St),i[1]=(p*Ut-o*Ft-y*It)*St,i[2]=(me*$t-ue*ct+Me*ht)*St,i[3]=(W*ct-N*$t-Z*ht)*St,i[4]=(k*Ot-w*Ft-F*Bt)*St,i[5]=(r*Ft-p*Ot+y*Bt)*St,i[6]=(ue*Be-K*$t-Me*Pe)*St,i[7]=(j*$t-W*Be+Z*Pe)*St,i[8]=(w*Ut-P*Ot+F*Qt)*St,i[9]=(o*Ot-r*Ut-y*Qt)*St,i[10]=(K*ct-me*Be+Me*Xe)*St,i[11]=(N*Be-j*ct-Z*Xe)*St,i[12]=(P*Bt-w*It-k*Qt)*St,i[13]=(r*It-o*Bt+p*Qt)*St,i[14]=(me*Pe-K*ht-ue*Xe)*St,i[15]=(j*ht-N*Pe+W*Xe)*St,i):null},n.isImageBitmap=rt,n.isSafari=vt,n.isWorker=ge,n.keysDifference=function(i,e){const r=[];for(const o in i)o in e||r.push(o);return r},n.lazyLoadRTLTextPlugin=function(){Vn.isLoading()||Vn.isLoaded()||Ko()!=="deferred"||dl()},n.makeRequest=Je,n.mapObject=C,n.mercatorXfromLng=Jh,n.mercatorYfromLat=Qh,n.mercatorZfromAltitude=eu,n.mul=Ru,n.mul$1=function(i,e,r){return i[0]=e[0]*r[0],i[1]=e[1]*r[1],i[2]=e[2]*r[2],i[3]=e[3]*r[3],i},n.multiply=th,n.nextPowerOfTwo=function(i){return i<=1?1:Math.pow(2,Math.ceil(Math.log(i)/Math.LN2))},n.normalize=function(i,e){var r=e[0],o=e[1],p=e[2],y=r*r+o*o+p*p;return y>0&&(y=1/Math.sqrt(y)),i[0]=e[0]*y,i[1]=e[1]*y,i[2]=e[2]*y,i},n.number=Ct,n.ortho=function(i,e,r,o,p,y,w){var P=1/(e-r),k=1/(o-p),F=1/(y-w);return i[0]=-2*P,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*k,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*F,i[11]=0,i[12]=(e+r)*P,i[13]=(p+o)*k,i[14]=(w+y)*F,i[15]=1,i},n.parseCacheControl=ze,n.parseGlyphPbf=function(i){return new uc(i).readFields(Rd,[])},n.pbf=uc,n.performSymbolLayout=function(i){i.bucket.createArrays(),i.bucket.tilePixelRatio=Br/(512*i.bucket.overscaling),i.bucket.compareText={},i.bucket.iconsNeedLinear=!1;const e=i.bucket.layers[0].layout,r=i.bucket.layers[0]._unevaluatedLayout._values,o={layoutIconSize:r["icon-size"].possiblyEvaluate(new yr(i.bucket.zoom+1),i.canonical),layoutTextSize:r["text-size"].possiblyEvaluate(new yr(i.bucket.zoom+1),i.canonical),textMaxSize:r["text-size"].possiblyEvaluate(new yr(18))};if(i.bucket.textSizeData.kind==="composite"){const{minZoom:k,maxZoom:F}=i.bucket.textSizeData;o.compositeTextSizes=[r["text-size"].possiblyEvaluate(new yr(k),i.canonical),r["text-size"].possiblyEvaluate(new yr(F),i.canonical)]}if(i.bucket.iconSizeData.kind==="composite"){const{minZoom:k,maxZoom:F}=i.bucket.iconSizeData;o.compositeIconSizes=[r["icon-size"].possiblyEvaluate(new yr(k),i.canonical),r["icon-size"].possiblyEvaluate(new yr(F),i.canonical)]}const p=e.get("text-line-height")*en,y=e.get("text-rotation-alignment")!=="viewport"&&e.get("symbol-placement")!=="point",w=e.get("text-keep-upright"),P=e.get("text-size");for(const k of i.bucket.features){const F=e.get("text-font").evaluate(k,{},i.canonical).join(","),j=P.evaluate(k,{},i.canonical),N=o.layoutTextSize.evaluate(k,{},i.canonical),W=o.layoutIconSize.evaluate(k,{},i.canonical),Z={horizontal:{},vertical:void 0},K=k.text;let me,ue=[0,0];if(K){const Pe=K.toString(),Be=e.get("text-letter-spacing").evaluate(k,{},i.canonical)*en,ht=So(Pe)?Be:0,ct=e.get("text-anchor").evaluate(k,{},i.canonical),$t=e.get("text-variable-anchor");if(!$t){const Ut=e.get("text-radial-offset").evaluate(k,{},i.canonical);ue=Ut?Wh(ct,[Ut*en,gc]):e.get("text-offset").evaluate(k,{},i.canonical).map(Ft=>Ft*en)}let Qt=y?"center":e.get("text-justify").evaluate(k,{},i.canonical);const Bt=e.get("symbol-placement"),Ot=Bt==="point"?e.get("text-max-width").evaluate(k,{},i.canonical)*en:0,It=()=>{i.bucket.allowVerticalPlacement&&eo(Pe)&&(Z.vertical=Al(K,i.glyphMap,i.glyphPositions,i.imagePositions,F,Ot,p,ct,"left",ht,ue,n.WritingMode.vertical,!0,Bt,N,j))};if(!y&&$t){const Ut=Qt==="auto"?$t.map(St=>_c(St)):[Qt];let Ft=!1;for(let St=0;St<Ut.length;St++){const ui=Ut[St];if(!Z.horizontal[ui])if(Ft)Z.horizontal[ui]=Z.horizontal[0];else{const si=Al(K,i.glyphMap,i.glyphPositions,i.imagePositions,F,Ot,p,"center",ui,ht,ue,n.WritingMode.horizontal,!1,Bt,N,j);si&&(Z.horizontal[ui]=si,Ft=si.positionedLines.length===1)}}It()}else{Qt==="auto"&&(Qt=_c(ct));const Ut=Al(K,i.glyphMap,i.glyphPositions,i.imagePositions,F,Ot,p,ct,Qt,ht,ue,n.WritingMode.horizontal,!1,Bt,N,j);Ut&&(Z.horizontal[Qt]=Ut),It(),eo(Pe)&&y&&w&&(Z.vertical=Al(K,i.glyphMap,i.glyphPositions,i.imagePositions,F,Ot,p,ct,Qt,ht,ue,n.WritingMode.vertical,!1,Bt,N,j))}}let Me=!1;if(k.icon&&k.icon.name){const Pe=i.imageMap[k.icon.name];Pe&&(me=Gd(i.imagePositions[k.icon.name],e.get("icon-offset").evaluate(k,{},i.canonical),e.get("icon-anchor").evaluate(k,{},i.canonical)),Me=!!Pe.sdf,i.bucket.sdfIcons===void 0?i.bucket.sdfIcons=Me:i.bucket.sdfIcons!==Me&&U("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Pe.pixelRatio!==i.bucket.pixelRatio||e.get("icon-rotate").constantOr(1)!==0)&&(i.bucket.iconsNeedLinear=!0))}const Xe=qh(Z.horizontal)||Z.vertical;i.bucket.iconsInText=!!Xe&&Xe.iconsInText,(Xe||me)&&Zd(i.bucket,k,Z,me,i.imageMap,o,N,W,ue,Me,i.canonical)}i.showCollisionBoxes&&i.bucket.generateCollisionDebugBuffers()},n.perspective=function(i,e,r,o,p){var y,w=1/Math.tan(e/2);return i[0]=w/r,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=w,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,p!=null&&p!==1/0?(i[10]=(p+o)*(y=1/(o-p)),i[14]=2*p*o*y):(i[10]=-1,i[14]=-2*o),i},n.pick=function(i,e){const r={};for(let o=0;o<e.length;o++){const p=e[o];p in i&&(r[p]=i[p])}return r},n.plugin=Vn,n.pointGeometry=Qe,n.polygonIntersectsPolygon=Zc,n.potpack=Ah,n.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],n.register=Rt,n.registerForPluginStateChange=function(i){return i({pluginStatus:bn,pluginURL:Bs}),Ra.on("pluginStateChange",i),i},n.renderColorRamp=lh,n.rotateX=function(i,e,r){var o=Math.sin(r),p=Math.cos(r),y=e[4],w=e[5],P=e[6],k=e[7],F=e[8],j=e[9],N=e[10],W=e[11];return e!==i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[4]=y*p+F*o,i[5]=w*p+j*o,i[6]=P*p+N*o,i[7]=k*p+W*o,i[8]=F*p-y*o,i[9]=j*p-w*o,i[10]=N*p-P*o,i[11]=W*p-k*o,i},n.rotateZ=function(i,e,r){var o=Math.sin(r),p=Math.cos(r),y=e[0],w=e[1],P=e[2],k=e[3],F=e[4],j=e[5],N=e[6],W=e[7];return e!==i&&(i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=y*p+F*o,i[1]=w*p+j*o,i[2]=P*p+N*o,i[3]=k*p+W*o,i[4]=F*p-y*o,i[5]=j*p-w*o,i[6]=N*p-P*o,i[7]=W*p-k*o,i},n.scale=function(i,e,r){var o=r[0],p=r[1],y=r[2];return i[0]=e[0]*o,i[1]=e[1]*o,i[2]=e[2]*o,i[3]=e[3]*o,i[4]=e[4]*p,i[5]=e[5]*p,i[6]=e[6]*p,i[7]=e[7]*p,i[8]=e[8]*y,i[9]=e[9]*y,i[10]=e[10]*y,i[11]=e[11]*y,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i},n.scale$1=function(i,e,r){return i[0]=e[0]*r,i[1]=e[1]*r,i[2]=e[2]*r,i},n.setCacheLimits=function(i,e){ie=i,ve=e},n.setRTLTextPlugin=function(i,e,r=!1){if(bn===Oa||bn===La||bn===za)throw new Error("setRTLTextPlugin cannot be called multiple times.");Bs=mt.resolveURL(i),bn=Oa,Fa=e,To(),r||dl()},n.spec=Ue,n.sphericalToCartesian=function([i,e,r]){return e+=90,e*=Math.PI/180,r*=Math.PI/180,{x:i*Math.cos(e)*Math.sin(r),y:i*Math.sin(e)*Math.sin(r),z:i*Math.cos(r)}},n.sqrLen=function(i){var e=i[0],r=i[1];return e*e+r*r},n.sub=function(i,e,r){return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],i},n.toEvaluationFeature=ia,n.transformMat3=function(i,e,r){var o=e[0],p=e[1],y=e[2];return i[0]=o*r[0]+p*r[3]+y*r[6],i[1]=o*r[1]+p*r[4]+y*r[7],i[2]=o*r[2]+p*r[5]+y*r[8],i},n.transformMat4=bl,n.transformMat4$1=function(i,e,r){var o=e[0],p=e[1];return i[0]=r[0]*o+r[4]*p+r[12],i[1]=r[1]*o+r[5]*p+r[13],i},n.translate=function(i,e,r){var o,p,y,w,P,k,F,j,N,W,Z,K,me=r[0],ue=r[1],Me=r[2];return e===i?(i[12]=e[0]*me+e[4]*ue+e[8]*Me+e[12],i[13]=e[1]*me+e[5]*ue+e[9]*Me+e[13],i[14]=e[2]*me+e[6]*ue+e[10]*Me+e[14],i[15]=e[3]*me+e[7]*ue+e[11]*Me+e[15]):(p=e[1],y=e[2],w=e[3],P=e[4],k=e[5],F=e[6],j=e[7],N=e[8],W=e[9],Z=e[10],K=e[11],i[0]=o=e[0],i[1]=p,i[2]=y,i[3]=w,i[4]=P,i[5]=k,i[6]=F,i[7]=j,i[8]=N,i[9]=W,i[10]=Z,i[11]=K,i[12]=o*me+P*ue+N*Me+e[12],i[13]=p*me+k*ue+W*Me+e[13],i[14]=y*me+F*ue+Z*Me+e[14],i[15]=w*me+j*ue+K*Me+e[15]),i},n.triggerPluginCompletionEvent=ul,n.unicodeBlockLookup=kt,n.uniqueId=function(){return _++},n.validateCustomStyleLayer=function(i){const e=[],r=i.id;return r===void 0&&e.push({message:`layers.${r}: missing required property "id"`}),i.render===void 0&&e.push({message:`layers.${r}: missing required method "render"`}),i.renderingMode&&i.renderingMode!=="2d"&&i.renderingMode!=="3d"&&e.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),e},n.validateLight=on,n.validateStyle=Cs,n.vectorTile=Ao,n.warnOnce=U,n.wrap=c}),Yt(["./shared"],function(n){function g(re){const B=typeof re;if(B==="number"||B==="boolean"||B==="string"||re==null)return JSON.stringify(re);if(Array.isArray(re)){let te="[";for(const fe of re)te+=`${g(fe)},`;return`${te}]`}const G=Object.keys(re).sort();let ee="{";for(let te=0;te<G.length;te++)ee+=`${JSON.stringify(G[te])}:${g(re[G[te]])},`;return`${ee}}`}function x(re){let B="";for(const G of n.refProperties)B+=`/${g(re[G])}`;return B}class v{constructor(B){this.keyCache={},B&&this.replace(B)}replace(B){this._layerConfigs={},this._layers={},this.update(B,[])}update(B,G){for(const te of B){this._layerConfigs[te.id]=te;const fe=this._layers[te.id]=n.createStyleLayer(te);fe._featureFilter=n.createFilter(fe.filter),this.keyCache[te.id]&&delete this.keyCache[te.id]}for(const te of G)delete this.keyCache[te],delete this._layerConfigs[te],delete this._layers[te];this.familiesBySource={};const ee=function(te,fe){const we={};for(let pe=0;pe<te.length;pe++){const Se=fe&&fe[te[pe].id]||x(te[pe]);fe&&(fe[te[pe].id]=Se);let Ye=we[Se];Ye||(Ye=we[Se]=[]),Ye.push(te[pe])}const _e=[];for(const pe in we)_e.push(we[pe]);return _e}(Object.values(this._layerConfigs),this.keyCache);for(const te of ee){const fe=te.map(pt=>this._layers[pt.id]),we=fe[0];if(we.visibility==="none")continue;const _e=we.source||"";let pe=this.familiesBySource[_e];pe||(pe=this.familiesBySource[_e]={});const Se=we.sourceLayer||"_geojsonTileLayer";let Ye=pe[Se];Ye||(Ye=pe[Se]=[]),Ye.push(fe)}}}class h{constructor(B){const G={},ee=[];for(const _e in B){const pe=B[_e],Se=G[_e]={};for(const Ye in pe){const pt=pe[+Ye];if(!pt||pt.bitmap.width===0||pt.bitmap.height===0)continue;const qe={x:0,y:0,w:pt.bitmap.width+2,h:pt.bitmap.height+2};ee.push(qe),Se[Ye]={rect:qe,metrics:pt.metrics}}}const{w:te,h:fe}=n.potpack(ee),we=new n.AlphaImage({width:te||1,height:fe||1});for(const _e in B){const pe=B[_e];for(const Se in pe){const Ye=pe[+Se];if(!Ye||Ye.bitmap.width===0||Ye.bitmap.height===0)continue;const pt=G[_e][Se].rect;n.AlphaImage.copy(Ye.bitmap,we,{x:0,y:0},{x:pt.x+1,y:pt.y+1},Ye.bitmap)}}this.image=we,this.positions=G}}n.register("GlyphAtlas",h);class a{constructor(B){this.tileID=new n.OverscaledTileID(B.tileID.overscaledZ,B.tileID.wrap,B.tileID.canonical.z,B.tileID.canonical.x,B.tileID.canonical.y),this.uid=B.uid,this.zoom=B.zoom,this.pixelRatio=B.pixelRatio,this.tileSize=B.tileSize,this.source=B.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=B.showCollisionBoxes,this.collectResourceTiming=!!B.collectResourceTiming,this.returnDependencies=!!B.returnDependencies,this.promoteId=B.promoteId}parse(B,G,ee,te,fe){this.status="parsing",this.data=B,this.collisionBoxArray=new n.CollisionBoxArray;const we=new n.DictionaryCoder(Object.keys(B.layers).sort()),_e=new n.FeatureIndex(this.tileID,this.promoteId);_e.bucketLayerIDs=[];const pe={},Se={featureIndex:_e,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:ee},Ye=G.familiesBySource[this.source];for(const vi in Ye){const Ti=B.layers[vi];if(!Ti)continue;Ti.version===1&&n.warnOnce(`Vector tile source "${this.source}" layer "${vi}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Bi=we.encode(vi),Ci=[];for(let Ir=0;Ir<Ti.length;Ir++){const cr=Ti.feature(Ir),gr=_e.getId(cr,vi);Ci.push({feature:cr,id:gr,index:Ir,sourceLayerIndex:Bi})}for(const Ir of Ye[vi]){const cr=Ir[0];cr.source!==this.source&&n.warnOnce(`layer.source = ${cr.source} does not equal this.source = ${this.source}`),cr.minzoom&&this.zoom<Math.floor(cr.minzoom)||cr.maxzoom&&this.zoom>=cr.maxzoom||cr.visibility!=="none"&&(c(Ir,this.zoom,ee),(pe[cr.id]=cr.createBucket({index:_e.bucketLayerIDs.length,layers:Ir,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Bi,sourceID:this.source})).populate(Ci,Se,this.tileID.canonical),_e.bucketLayerIDs.push(Ir.map(gr=>gr.id)))}}let pt,qe,Ht,Jt;const Pt=n.mapObject(Se.glyphDependencies,vi=>Object.keys(vi).map(Number));Object.keys(Pt).length?te.send("getGlyphs",{uid:this.uid,stacks:Pt},(vi,Ti)=>{pt||(pt=vi,qe=Ti,Li.call(this))}):qe={};const di=Object.keys(Se.iconDependencies);di.length?te.send("getImages",{icons:di,source:this.source,tileID:this.tileID,type:"icons"},(vi,Ti)=>{pt||(pt=vi,Ht=Ti,Li.call(this))}):Ht={};const gi=Object.keys(Se.patternDependencies);function Li(){if(pt)return fe(pt);if(qe&&Ht&&Jt){const vi=new h(qe),Ti=new n.ImageAtlas(Ht,Jt);for(const Bi in pe){const Ci=pe[Bi];Ci instanceof n.SymbolBucket?(c(Ci.layers,this.zoom,ee),n.performSymbolLayout({bucket:Ci,glyphMap:qe,glyphPositions:vi.positions,imageMap:Ht,imagePositions:Ti.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical})):Ci.hasPattern&&(Ci instanceof n.LineBucket||Ci instanceof n.FillBucket||Ci instanceof n.FillExtrusionBucket)&&(c(Ci.layers,this.zoom,ee),Ci.addFeatures(Se,this.tileID.canonical,Ti.patternPositions))}this.status="done",fe(null,{buckets:Object.values(pe).filter(Bi=>!Bi.isEmpty()),featureIndex:_e,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:vi.image,imageAtlas:Ti,glyphMap:this.returnDependencies?qe:null,iconMap:this.returnDependencies?Ht:null,glyphPositions:this.returnDependencies?vi.positions:null})}}gi.length?te.send("getImages",{icons:gi,source:this.source,tileID:this.tileID,type:"patterns"},(vi,Ti)=>{pt||(pt=vi,Jt=Ti,Li.call(this))}):Jt={},Li.call(this)}}function c(re,B,G){const ee=new n.EvaluationParameters(B);for(const te of re)te.recalculate(ee,G)}function d(re,B){const G=n.getArrayBuffer(re.request,(ee,te,fe,we)=>{ee?B(ee):te&&B(null,{vectorTile:new n.vectorTile.VectorTile(new n.pbf(te)),rawData:te,cacheControl:fe,expires:we})});return()=>{G.cancel(),B()}}class _{constructor(B,G,ee,te){this.actor=B,this.layerIndex=G,this.availableImages=ee,this.loadVectorData=te||d,this.loading={},this.loaded={}}loadTile(B,G){const ee=B.uid;this.loading||(this.loading={});const te=!!(B&&B.request&&B.request.collectResourceTiming)&&new n.RequestPerformance(B.request),fe=this.loading[ee]=new a(B);fe.abort=this.loadVectorData(B,(we,_e)=>{if(delete this.loading[ee],we||!_e)return fe.status="done",this.loaded[ee]=fe,G(we);const pe=_e.rawData,Se={};_e.expires&&(Se.expires=_e.expires),_e.cacheControl&&(Se.cacheControl=_e.cacheControl);const Ye={};if(te){const pt=te.finish();pt&&(Ye.resourceTiming=JSON.parse(JSON.stringify(pt)))}fe.vectorTile=_e.vectorTile,fe.parse(_e.vectorTile,this.layerIndex,this.availableImages,this.actor,(pt,qe)=>{if(pt||!qe)return G(pt);G(null,n.extend({rawTileData:pe.slice(0)},qe,Se,Ye))}),this.loaded=this.loaded||{},this.loaded[ee]=fe})}reloadTile(B,G){const ee=this.loaded,te=B.uid,fe=this;if(ee&&ee[te]){const we=ee[te];we.showCollisionBoxes=B.showCollisionBoxes;const _e=(pe,Se)=>{const Ye=we.reloadCallback;Ye&&(delete we.reloadCallback,we.parse(we.vectorTile,fe.layerIndex,this.availableImages,fe.actor,Ye)),G(pe,Se)};we.status==="parsing"?we.reloadCallback=_e:we.status==="done"&&(we.vectorTile?we.parse(we.vectorTile,this.layerIndex,this.availableImages,this.actor,_e):_e())}}abortTile(B,G){const ee=this.loading,te=B.uid;ee&&ee[te]&&ee[te].abort&&(ee[te].abort(),delete ee[te]),G()}removeTile(B,G){const ee=this.loaded,te=B.uid;ee&&ee[te]&&delete ee[te],G()}}class u{constructor(){this.loaded={}}loadTile(B,G){const{uid:ee,encoding:te,rawImageData:fe}=B,we=n.isImageBitmap(fe)?this.getImageData(fe):fe,_e=new n.DEMData(ee,we,te);this.loaded=this.loaded||{},this.loaded[ee]=_e,G(null,_e)}getImageData(B){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(B.width,B.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d")),this.offscreenCanvas.width=B.width,this.offscreenCanvas.height=B.height,this.offscreenCanvasContext.drawImage(B,0,0,B.width,B.height);const G=this.offscreenCanvasContext.getImageData(-1,-1,B.width+2,B.height+2);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),new n.RGBAImage({width:G.width,height:G.height},G.data)}removeTile(B){const G=this.loaded,ee=B.uid;G&&G[ee]&&delete G[ee]}}var C=function re(B,G){var ee,te=B&&B.type;if(te==="FeatureCollection")for(ee=0;ee<B.features.length;ee++)re(B.features[ee],G);else if(te==="GeometryCollection")for(ee=0;ee<B.geometries.length;ee++)re(B.geometries[ee],G);else if(te==="Feature")re(B.geometry,G);else if(te==="Polygon")S(B.coordinates,G);else if(te==="MultiPolygon")for(ee=0;ee<B.coordinates.length;ee++)S(B.coordinates[ee],G);return B};function S(re,B){if(re.length!==0){A(re[0],B);for(var G=1;G<re.length;G++)A(re[G],!B)}}function A(re,B){for(var G=0,ee=0,te=0,fe=re.length,we=fe-1;te<fe;we=te++){var _e=(re[te][0]-re[we][0])*(re[we][1]+re[te][1]),pe=G+_e;ee+=Math.abs(G)>=Math.abs(_e)?G-pe+_e:_e-pe+G,G=pe}G+ee>=0!=!!B&&re.reverse()}const O=n.vectorTile.VectorTileFeature.prototype.toGeoJSON;class U{constructor(B){this._feature=B,this.extent=n.EXTENT,this.type=B.type,this.properties=B.tags,"id"in B&&!isNaN(B.id)&&(this.id=parseInt(B.id,10))}loadGeometry(){if(this._feature.type===1){const B=[];for(const G of this._feature.geometry)B.push([new n.pointGeometry(G[0],G[1])]);return B}{const B=[];for(const G of this._feature.geometry){const ee=[];for(const te of G)ee.push(new n.pointGeometry(te[0],te[1]));B.push(ee)}return B}}toGeoJSON(B,G,ee){return O.call(this,B,G,ee)}}class Y{constructor(B){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=n.EXTENT,this.length=B.length,this._features=B}feature(B){return new U(this._features[B])}}var oe={exports:{}},ge=n.pointGeometry,ze=n.vectorTile.VectorTileFeature,We=at;function at(re,B){this.options=B||{},this.features=re,this.length=re.length}function _t(re,B){this.id=typeof re.id=="number"?re.id:void 0,this.type=re.type,this.rawGeometry=re.type===1?[re.geometry]:re.geometry,this.properties=re.tags,this.extent=B||4096}at.prototype.feature=function(re){return new _t(this.features[re],this.options.extent)},_t.prototype.loadGeometry=function(){var re=this.rawGeometry;this.geometry=[];for(var B=0;B<re.length;B++){for(var G=re[B],ee=[],te=0;te<G.length;te++)ee.push(new ge(G[te][0],G[te][1]));this.geometry.push(ee)}return this.geometry},_t.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var re=this.geometry,B=1/0,G=-1/0,ee=1/0,te=-1/0,fe=0;fe<re.length;fe++)for(var we=re[fe],_e=0;_e<we.length;_e++){var pe=we[_e];B=Math.min(B,pe.x),G=Math.max(G,pe.x),ee=Math.min(ee,pe.y),te=Math.max(te,pe.y)}return[B,ee,G,te]},_t.prototype.toGeoJSON=ze.prototype.toGeoJSON;var vt=n.pbf,rt=We;function mt(re){var B=new vt;return function(G,ee){for(var te in G.layers)ee.writeMessage(3,Qe,G.layers[te])}(re,B),B.finish()}function Qe(re,B){var G;B.writeVarintField(15,re.version||1),B.writeStringField(1,re.name||""),B.writeVarintField(5,re.extent||4096);var ee={keys:[],values:[],keycache:{},valuecache:{}};for(G=0;G<re.length;G++)ee.feature=re.feature(G),B.writeMessage(2,zt,ee);var te=ee.keys;for(G=0;G<te.length;G++)B.writeStringField(3,te[G]);var fe=ee.values;for(G=0;G<fe.length;G++)B.writeMessage(4,ie,fe[G])}function zt(re,B){var G=re.feature;G.id!==void 0&&B.writeVarintField(1,G.id),B.writeMessage(2,Et,re),B.writeVarintField(3,G.type),B.writeMessage(4,de,G)}function Et(re,B){var G=re.feature,ee=re.keys,te=re.values,fe=re.keycache,we=re.valuecache;for(var _e in G.properties){var pe=G.properties[_e],Se=fe[_e];if(pe!==null){Se===void 0&&(ee.push(_e),fe[_e]=Se=ee.length-1),B.writeVarint(Se);var Ye=typeof pe;Ye!=="string"&&Ye!=="boolean"&&Ye!=="number"&&(pe=JSON.stringify(pe));var pt=Ye+":"+pe,qe=we[pt];qe===void 0&&(te.push(pe),we[pt]=qe=te.length-1),B.writeVarint(qe)}}}function Q(re,B){return(B<<3)+(7&re)}function se(re){return re<<1^re>>31}function de(re,B){for(var G=re.loadGeometry(),ee=re.type,te=0,fe=0,we=G.length,_e=0;_e<we;_e++){var pe=G[_e],Se=1;ee===1&&(Se=pe.length),B.writeVarint(Q(1,Se));for(var Ye=ee===3?pe.length-1:pe.length,pt=0;pt<Ye;pt++){pt===1&&ee!==1&&B.writeVarint(Q(2,Ye-1));var qe=pe[pt].x-te,Ht=pe[pt].y-fe;B.writeVarint(se(qe)),B.writeVarint(se(Ht)),te+=qe,fe+=Ht}ee===3&&B.writeVarint(Q(7,1))}}function ie(re,B){var G=typeof re;G==="string"?B.writeStringField(1,re):G==="boolean"?B.writeBooleanField(7,re):G==="number"&&(re%1!=0?B.writeDoubleField(3,re):re<0?B.writeSVarintField(6,re):B.writeVarintField(5,re))}function ve(re,B,G,ee,te,fe){if(te-ee<=G)return;const we=ee+te>>1;J(re,B,we,ee,te,fe%2),ve(re,B,G,ee,we-1,fe+1),ve(re,B,G,we+1,te,fe+1)}function J(re,B,G,ee,te,fe){for(;te>ee;){if(te-ee>600){const Se=te-ee+1,Ye=G-ee+1,pt=Math.log(Se),qe=.5*Math.exp(2*pt/3),Ht=.5*Math.sqrt(pt*qe*(Se-qe)/Se)*(Ye-Se/2<0?-1:1);J(re,B,G,Math.max(ee,Math.floor(G-Ye*qe/Se+Ht)),Math.min(te,Math.floor(G+(Se-Ye)*qe/Se+Ht)),fe)}const we=B[2*G+fe];let _e=ee,pe=te;for(q(re,B,ee,G),B[2*te+fe]>we&&q(re,B,ee,te);_e<pe;){for(q(re,B,_e,pe),_e++,pe--;B[2*_e+fe]<we;)_e++;for(;B[2*pe+fe]>we;)pe--}B[2*ee+fe]===we?q(re,B,ee,pe):(pe++,q(re,B,pe,te)),pe<=G&&(ee=pe+1),G<=pe&&(te=pe-1)}}function q(re,B,G,ee){ce(re,G,ee),ce(B,2*G,2*ee),ce(B,2*G+1,2*ee+1)}function ce(re,B,G){const ee=re[B];re[B]=re[G],re[G]=ee}function be(re,B,G,ee){const te=re-G,fe=B-ee;return te*te+fe*fe}oe.exports=mt,oe.exports.fromVectorTileJs=mt,oe.exports.fromGeojsonVt=function(re,B){B=B||{};var G={};for(var ee in re)G[ee]=new rt(re[ee].features,B),G[ee].name=ee,G[ee].version=B.version,G[ee].extent=B.extent;return mt({layers:G})},oe.exports.GeoJSONWrapper=rt;const De=re=>re[0],Ie=re=>re[1];class tt{constructor(B,G=De,ee=Ie,te=64,fe=Float64Array){this.nodeSize=te,this.points=B;const we=B.length<65536?Uint16Array:Uint32Array,_e=this.ids=new we(B.length),pe=this.coords=new fe(2*B.length);for(let Se=0;Se<B.length;Se++)_e[Se]=Se,pe[2*Se]=G(B[Se]),pe[2*Se+1]=ee(B[Se]);ve(_e,pe,te,0,_e.length-1,0)}range(B,G,ee,te){return function(fe,we,_e,pe,Se,Ye,pt){const qe=[0,fe.length-1,0],Ht=[];let Jt,Pt;for(;qe.length;){const di=qe.pop(),gi=qe.pop(),Li=qe.pop();if(gi-Li<=pt){for(let Bi=Li;Bi<=gi;Bi++)Jt=we[2*Bi],Pt=we[2*Bi+1],Jt>=_e&&Jt<=Se&&Pt>=pe&&Pt<=Ye&&Ht.push(fe[Bi]);continue}const vi=Math.floor((Li+gi)/2);Jt=we[2*vi],Pt=we[2*vi+1],Jt>=_e&&Jt<=Se&&Pt>=pe&&Pt<=Ye&&Ht.push(fe[vi]);const Ti=(di+1)%2;(di===0?_e<=Jt:pe<=Pt)&&(qe.push(Li),qe.push(vi-1),qe.push(Ti)),(di===0?Se>=Jt:Ye>=Pt)&&(qe.push(vi+1),qe.push(gi),qe.push(Ti))}return Ht}(this.ids,this.coords,B,G,ee,te,this.nodeSize)}within(B,G,ee){return function(te,fe,we,_e,pe,Se){const Ye=[0,te.length-1,0],pt=[],qe=pe*pe;for(;Ye.length;){const Ht=Ye.pop(),Jt=Ye.pop(),Pt=Ye.pop();if(Jt-Pt<=Se){for(let Ti=Pt;Ti<=Jt;Ti++)be(fe[2*Ti],fe[2*Ti+1],we,_e)<=qe&&pt.push(te[Ti]);continue}const di=Math.floor((Pt+Jt)/2),gi=fe[2*di],Li=fe[2*di+1];be(gi,Li,we,_e)<=qe&&pt.push(te[di]);const vi=(Ht+1)%2;(Ht===0?we-pe<=gi:_e-pe<=Li)&&(Ye.push(Pt),Ye.push(di-1),Ye.push(vi)),(Ht===0?we+pe>=gi:_e+pe>=Li)&&(Ye.push(di+1),Ye.push(Jt),Ye.push(vi))}return pt}(this.ids,this.coords,B,G,ee,this.nodeSize)}}const ut={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:re=>re},nt=Math.fround||(je=new Float32Array(1),re=>(je[0]=+re,je[0]));var je;class Ce{constructor(B){this.options=He(Object.create(ut),B),this.trees=new Array(this.options.maxZoom+1)}load(B){const{log:G,minZoom:ee,maxZoom:te,nodeSize:fe}=this.options;G&&console.time("total time");const we=`prepare ${B.length} points`;G&&console.time(we),this.points=B;let _e=[];for(let pe=0;pe<B.length;pe++)B[pe].geometry&&_e.push(Je(B[pe],pe));this.trees[te+1]=new tt(_e,jt,qt,fe,Float32Array),G&&console.timeEnd(we);for(let pe=te;pe>=ee;pe--){const Se=+Date.now();_e=this._cluster(_e,pe),this.trees[pe]=new tt(_e,jt,qt,fe,Float32Array),G&&console.log("z%d: %d clusters in %dms",pe,_e.length,+Date.now()-Se)}return G&&console.timeEnd("total time"),this}getClusters(B,G){let ee=((B[0]+180)%360+360)%360-180;const te=Math.max(-90,Math.min(90,B[1]));let fe=B[2]===180?180:((B[2]+180)%360+360)%360-180;const we=Math.max(-90,Math.min(90,B[3]));if(B[2]-B[0]>=360)ee=-180,fe=180;else if(ee>fe){const Ye=this.getClusters([ee,te,180,we],G),pt=this.getClusters([-180,te,fe,we],G);return Ye.concat(pt)}const _e=this.trees[this._limitZoom(G)],pe=_e.range(ot(ee),Gt(we),ot(fe),Gt(te)),Se=[];for(const Ye of pe){const pt=_e.points[Ye];Se.push(pt.numPoints?$e(pt):this.points[pt.index])}return Se}getChildren(B){const G=this._getOriginId(B),ee=this._getOriginZoom(B),te="No cluster with the specified id.",fe=this.trees[ee];if(!fe)throw new Error(te);const we=fe.points[G];if(!we)throw new Error(te);const _e=this.options.radius/(this.options.extent*Math.pow(2,ee-1)),pe=fe.within(we.x,we.y,_e),Se=[];for(const Ye of pe){const pt=fe.points[Ye];pt.parentId===B&&Se.push(pt.numPoints?$e(pt):this.points[pt.index])}if(Se.length===0)throw new Error(te);return Se}getLeaves(B,G,ee){const te=[];return this._appendLeaves(te,B,G=G||10,ee=ee||0,0),te}getTile(B,G,ee){const te=this.trees[this._limitZoom(B)],fe=Math.pow(2,B),{extent:we,radius:_e}=this.options,pe=_e/we,Se=(ee-pe)/fe,Ye=(ee+1+pe)/fe,pt={features:[]};return this._addTileFeatures(te.range((G-pe)/fe,Se,(G+1+pe)/fe,Ye),te.points,G,ee,fe,pt),G===0&&this._addTileFeatures(te.range(1-pe/fe,Se,1,Ye),te.points,fe,ee,fe,pt),G===fe-1&&this._addTileFeatures(te.range(0,Se,pe/fe,Ye),te.points,-1,ee,fe,pt),pt.features.length?pt:null}getClusterExpansionZoom(B){let G=this._getOriginZoom(B)-1;for(;G<=this.options.maxZoom;){const ee=this.getChildren(B);if(G++,ee.length!==1)break;B=ee[0].properties.cluster_id}return G}_appendLeaves(B,G,ee,te,fe){const we=this.getChildren(G);for(const _e of we){const pe=_e.properties;if(pe&&pe.cluster?fe+pe.point_count<=te?fe+=pe.point_count:fe=this._appendLeaves(B,pe.cluster_id,ee,te,fe):fe<te?fe++:B.push(_e),B.length===ee)break}return fe}_addTileFeatures(B,G,ee,te,fe,we){for(const _e of B){const pe=G[_e],Se=pe.numPoints;let Ye,pt,qe;if(Se)Ye=lt(pe),pt=pe.x,qe=pe.y;else{const Pt=this.points[pe.index];Ye=Pt.properties,pt=ot(Pt.geometry.coordinates[0]),qe=Gt(Pt.geometry.coordinates[1])}const Ht={type:1,geometry:[[Math.round(this.options.extent*(pt*fe-ee)),Math.round(this.options.extent*(qe*fe-te))]],tags:Ye};let Jt;Se?Jt=pe.id:this.options.generateId?Jt=pe.index:this.points[pe.index].id&&(Jt=this.points[pe.index].id),Jt!==void 0&&(Ht.id=Jt),we.features.push(Ht)}}_limitZoom(B){return Math.max(this.options.minZoom,Math.min(Math.floor(+B),this.options.maxZoom+1))}_cluster(B,G){const ee=[],{radius:te,extent:fe,reduce:we,minPoints:_e}=this.options,pe=te/(fe*Math.pow(2,G));for(let Se=0;Se<B.length;Se++){const Ye=B[Se];if(Ye.zoom<=G)continue;Ye.zoom=G;const pt=this.trees[G+1],qe=pt.within(Ye.x,Ye.y,pe),Ht=Ye.numPoints||1;let Jt=Ht;for(const Pt of qe){const di=pt.points[Pt];di.zoom>G&&(Jt+=di.numPoints||1)}if(Jt>Ht&&Jt>=_e){let Pt=Ye.x*Ht,di=Ye.y*Ht,gi=we&&Ht>1?this._map(Ye,!0):null;const Li=(Se<<5)+(G+1)+this.points.length;for(const vi of qe){const Ti=pt.points[vi];if(Ti.zoom<=G)continue;Ti.zoom=G;const Bi=Ti.numPoints||1;Pt+=Ti.x*Bi,di+=Ti.y*Bi,Ti.parentId=Li,we&&(gi||(gi=this._map(Ye,!0)),we(gi,this._map(Ti)))}Ye.parentId=Li,ee.push(Ve(Pt/Jt,di/Jt,Li,Jt,gi))}else if(ee.push(Ye),Jt>1)for(const Pt of qe){const di=pt.points[Pt];di.zoom<=G||(di.zoom=G,ee.push(di))}}return ee}_getOriginId(B){return B-this.points.length>>5}_getOriginZoom(B){return(B-this.points.length)%32}_map(B,G){if(B.numPoints)return G?He({},B.properties):B.properties;const ee=this.points[B.index].properties,te=this.options.map(ee);return G&&te===ee?He({},te):te}}function Ve(re,B,G,ee,te){return{x:nt(re),y:nt(B),zoom:1/0,id:G,parentId:-1,numPoints:ee,properties:te}}function Je(re,B){const[G,ee]=re.geometry.coordinates;return{x:nt(ot(G)),y:nt(Gt(ee)),zoom:1/0,index:B,parentId:-1}}function $e(re){return{type:"Feature",id:re.id,properties:lt(re),geometry:{type:"Point",coordinates:[(B=re.x,360*(B-.5)),Xt(re.y)]}};var B}function lt(re){const B=re.numPoints,G=B>=1e4?`${Math.round(B/1e3)}k`:B>=1e3?Math.round(B/100)/10+"k":B;return He(He({},re.properties),{cluster:!0,cluster_id:re.id,point_count:B,point_count_abbreviated:G})}function ot(re){return re/360+.5}function Gt(re){const B=Math.sin(re*Math.PI/180),G=.5-.25*Math.log((1+B)/(1-B))/Math.PI;return G<0?0:G>1?1:G}function Xt(re){const B=(180-360*re)*Math.PI/180;return 360*Math.atan(Math.exp(B))/Math.PI-90}function He(re,B){for(const G in B)re[G]=B[G];return re}function jt(re){return re.x}function qt(re){return re.y}function mi(re,B,G,ee){for(var te,fe=ee,we=G-B>>1,_e=G-B,pe=re[B],Se=re[B+1],Ye=re[G],pt=re[G+1],qe=B+3;qe<G;qe+=3){var Ht=Di(re[qe],re[qe+1],pe,Se,Ye,pt);if(Ht>fe)te=qe,fe=Ht;else if(Ht===fe){var Jt=Math.abs(qe-we);Jt<_e&&(te=qe,_e=Jt)}}fe>ee&&(te-B>3&&mi(re,B,te,ee),re[te+2]=fe,G-te>3&&mi(re,te,G,ee))}function Di(re,B,G,ee,te,fe){var we=te-G,_e=fe-ee;if(we!==0||_e!==0){var pe=((re-G)*we+(B-ee)*_e)/(we*we+_e*_e);pe>1?(G=te,ee=fe):pe>0&&(G+=we*pe,ee+=_e*pe)}return(we=re-G)*we+(_e=B-ee)*_e}function wi(re,B,G,ee){var te={id:re===void 0?null:re,type:B,geometry:G,tags:ee,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(fe){var we=fe.geometry,_e=fe.type;if(_e==="Point"||_e==="MultiPoint"||_e==="LineString")Ue(fe,we);else if(_e==="Polygon"||_e==="MultiLineString")for(var pe=0;pe<we.length;pe++)Ue(fe,we[pe]);else if(_e==="MultiPolygon")for(pe=0;pe<we.length;pe++)for(var Se=0;Se<we[pe].length;Se++)Ue(fe,we[pe][Se])}(te),te}function Ue(re,B){for(var G=0;G<B.length;G+=3)re.minX=Math.min(re.minX,B[G]),re.minY=Math.min(re.minY,B[G+1]),re.maxX=Math.max(re.maxX,B[G]),re.maxY=Math.max(re.maxY,B[G+1])}function yt(re,B,G,ee){if(B.geometry){var te=B.geometry.coordinates,fe=B.geometry.type,we=Math.pow(G.tolerance/((1<<G.maxZoom)*G.extent),2),_e=[],pe=B.id;if(G.promoteId?pe=B.properties[G.promoteId]:G.generateId&&(pe=ee||0),fe==="Point")Ri(te,_e);else if(fe==="MultiPoint")for(var Se=0;Se<te.length;Se++)Ri(te[Se],_e);else if(fe==="LineString")Zi(te,_e,we,!1);else if(fe==="MultiLineString"){if(G.lineMetrics){for(Se=0;Se<te.length;Se++)Zi(te[Se],_e=[],we,!1),re.push(wi(pe,"LineString",_e,B.properties));return}ri(te,_e,we,!1)}else if(fe==="Polygon")ri(te,_e,we,!0);else{if(fe!=="MultiPolygon"){if(fe==="GeometryCollection"){for(Se=0;Se<B.geometry.geometries.length;Se++)yt(re,{id:pe,geometry:B.geometry.geometries[Se],properties:B.properties},G,ee);return}throw new Error("Input data is not a valid GeoJSON object.")}for(Se=0;Se<te.length;Se++){var Ye=[];ri(te[Se],Ye,we,!0),_e.push(Ye)}}re.push(wi(pe,fe,_e,B.properties))}}function Ri(re,B){B.push(Ei(re[0])),B.push(dr(re[1])),B.push(0)}function Zi(re,B,G,ee){for(var te,fe,we=0,_e=0;_e<re.length;_e++){var pe=Ei(re[_e][0]),Se=dr(re[_e][1]);B.push(pe),B.push(Se),B.push(0),_e>0&&(we+=ee?(te*Se-pe*fe)/2:Math.sqrt(Math.pow(pe-te,2)+Math.pow(Se-fe,2))),te=pe,fe=Se}var Ye=B.length-3;B[2]=1,mi(B,0,Ye,G),B[Ye+2]=1,B.size=Math.abs(we),B.start=0,B.end=B.size}function ri(re,B,G,ee){for(var te=0;te<re.length;te++){var fe=[];Zi(re[te],fe,G,ee),B.push(fe)}}function Ei(re){return re/360+.5}function dr(re){var B=Math.sin(re*Math.PI/180),G=.5-.25*Math.log((1+B)/(1-B))/Math.PI;return G<0?0:G>1?1:G}function fr(re,B,G,ee,te,fe,we,_e){if(ee/=B,fe>=(G/=B)&&we<ee)return re;if(we<G||fe>=ee)return null;for(var pe=[],Se=0;Se<re.length;Se++){var Ye=re[Se],pt=Ye.geometry,qe=Ye.type,Ht=te===0?Ye.minX:Ye.minY,Jt=te===0?Ye.maxX:Ye.maxY;if(Ht>=G&&Jt<ee)pe.push(Ye);else if(!(Jt<G||Ht>=ee)){var Pt=[];if(qe==="Point"||qe==="MultiPoint")Ki(pt,Pt,G,ee,te);else if(qe==="LineString")st(pt,Pt,G,ee,te,!1,_e.lineMetrics);else if(qe==="MultiLineString")xi(pt,Pt,G,ee,te,!1);else if(qe==="Polygon")xi(pt,Pt,G,ee,te,!0);else if(qe==="MultiPolygon")for(var di=0;di<pt.length;di++){var gi=[];xi(pt[di],gi,G,ee,te,!0),gi.length&&Pt.push(gi)}if(Pt.length){if(_e.lineMetrics&&qe==="LineString"){for(di=0;di<Pt.length;di++)pe.push(wi(Ye.id,qe,Pt[di],Ye.tags));continue}qe!=="LineString"&&qe!=="MultiLineString"||(Pt.length===1?(qe="LineString",Pt=Pt[0]):qe="MultiLineString"),qe!=="Point"&&qe!=="MultiPoint"||(qe=Pt.length===3?"Point":"MultiPoint"),pe.push(wi(Ye.id,qe,Pt,Ye.tags))}}}return pe.length?pe:null}function Ki(re,B,G,ee,te){for(var fe=0;fe<re.length;fe+=3){var we=re[fe+te];we>=G&&we<=ee&&(B.push(re[fe]),B.push(re[fe+1]),B.push(re[fe+2]))}}function st(re,B,G,ee,te,fe,we){for(var _e,pe,Se=bi(re),Ye=te===0?tn:yi,pt=re.start,qe=0;qe<re.length-3;qe+=3){var Ht=re[qe],Jt=re[qe+1],Pt=re[qe+2],di=re[qe+3],gi=re[qe+4],Li=te===0?Ht:Jt,vi=te===0?di:gi,Ti=!1;we&&(_e=Math.sqrt(Math.pow(Ht-di,2)+Math.pow(Jt-gi,2))),Li<G?vi>G&&(pe=Ye(Se,Ht,Jt,di,gi,G),we&&(Se.start=pt+_e*pe)):Li>ee?vi<ee&&(pe=Ye(Se,Ht,Jt,di,gi,ee),we&&(Se.start=pt+_e*pe)):br(Se,Ht,Jt,Pt),vi<G&&Li>=G&&(pe=Ye(Se,Ht,Jt,di,gi,G),Ti=!0),vi>ee&&Li<=ee&&(pe=Ye(Se,Ht,Jt,di,gi,ee),Ti=!0),!fe&&Ti&&(we&&(Se.end=pt+_e*pe),B.push(Se),Se=bi(re)),we&&(pt+=_e)}var Bi=re.length-3;Ht=re[Bi],Jt=re[Bi+1],Pt=re[Bi+2],(Li=te===0?Ht:Jt)>=G&&Li<=ee&&br(Se,Ht,Jt,Pt),Bi=Se.length-3,fe&&Bi>=3&&(Se[Bi]!==Se[0]||Se[Bi+1]!==Se[1])&&br(Se,Se[0],Se[1],Se[2]),Se.length&&B.push(Se)}function bi(re){var B=[];return B.size=re.size,B.start=re.start,B.end=re.end,B}function xi(re,B,G,ee,te,fe){for(var we=0;we<re.length;we++)st(re[we],B,G,ee,te,fe,!1)}function br(re,B,G,ee){re.push(B),re.push(G),re.push(ee)}function tn(re,B,G,ee,te,fe){var we=(fe-B)/(ee-B);return re.push(fe),re.push(G+(te-G)*we),re.push(1),we}function yi(re,B,G,ee,te,fe){var we=(fe-G)/(te-G);return re.push(B+(ee-B)*we),re.push(fe),re.push(1),we}function Oi(re,B){for(var G=[],ee=0;ee<re.length;ee++){var te,fe=re[ee],we=fe.type;if(we==="Point"||we==="MultiPoint"||we==="LineString")te=wr(fe.geometry,B);else if(we==="MultiLineString"||we==="Polygon"){te=[];for(var _e=0;_e<fe.geometry.length;_e++)te.push(wr(fe.geometry[_e],B))}else if(we==="MultiPolygon")for(te=[],_e=0;_e<fe.geometry.length;_e++){for(var pe=[],Se=0;Se<fe.geometry[_e].length;Se++)pe.push(wr(fe.geometry[_e][Se],B));te.push(pe)}G.push(wi(fe.id,we,te,fe.tags))}return G}function wr(re,B){var G=[];G.size=re.size,re.start!==void 0&&(G.start=re.start,G.end=re.end);for(var ee=0;ee<re.length;ee+=3)G.push(re[ee]+B,re[ee+1],re[ee+2]);return G}function Vr(re,B){if(re.transformed)return re;var G,ee,te,fe=1<<re.z,we=re.x,_e=re.y;for(G=0;G<re.features.length;G++){var pe=re.features[G],Se=pe.geometry,Ye=pe.type;if(pe.geometry=[],Ye===1)for(ee=0;ee<Se.length;ee+=2)pe.geometry.push(lr(Se[ee],Se[ee+1],B,fe,we,_e));else for(ee=0;ee<Se.length;ee++){var pt=[];for(te=0;te<Se[ee].length;te+=2)pt.push(lr(Se[ee][te],Se[ee][te+1],B,fe,we,_e));pe.geometry.push(pt)}}return re.transformed=!0,re}function lr(re,B,G,ee,te,fe){return[Math.round(G*(re*ee-te)),Math.round(G*(B*ee-fe))]}function Dr(re,B,G,ee,te){for(var fe=B===te.maxZoom?0:te.tolerance/((1<<B)*te.extent),we={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:G,y:ee,z:B,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},_e=0;_e<re.length;_e++){we.numFeatures++,Xi(we,re[_e],fe,te);var pe=re[_e].minX,Se=re[_e].minY,Ye=re[_e].maxX,pt=re[_e].maxY;pe<we.minX&&(we.minX=pe),Se<we.minY&&(we.minY=Se),Ye>we.maxX&&(we.maxX=Ye),pt>we.maxY&&(we.maxY=pt)}return we}function Xi(re,B,G,ee){var te=B.geometry,fe=B.type,we=[];if(fe==="Point"||fe==="MultiPoint")for(var _e=0;_e<te.length;_e+=3)we.push(te[_e]),we.push(te[_e+1]),re.numPoints++,re.numSimplified++;else if(fe==="LineString")as(we,te,re,G,!1,!1);else if(fe==="MultiLineString"||fe==="Polygon")for(_e=0;_e<te.length;_e++)as(we,te[_e],re,G,fe==="Polygon",_e===0);else if(fe==="MultiPolygon")for(var pe=0;pe<te.length;pe++){var Se=te[pe];for(_e=0;_e<Se.length;_e++)as(we,Se[_e],re,G,!0,_e===0)}if(we.length){var Ye=B.tags||null;if(fe==="LineString"&&ee.lineMetrics){for(var pt in Ye={},B.tags)Ye[pt]=B.tags[pt];Ye.mapbox_clip_start=te.start/te.size,Ye.mapbox_clip_end=te.end/te.size}var qe={geometry:we,type:fe==="Polygon"||fe==="MultiPolygon"?3:fe==="LineString"||fe==="MultiLineString"?2:1,tags:Ye};B.id!==null&&(qe.id=B.id),re.features.push(qe)}}function as(re,B,G,ee,te,fe){var we=ee*ee;if(ee>0&&B.size<(te?we:ee))G.numPoints+=B.length/3;else{for(var _e=[],pe=0;pe<B.length;pe+=3)(ee===0||B[pe+2]>we)&&(G.numSimplified++,_e.push(B[pe]),_e.push(B[pe+1])),G.numPoints++;te&&function(Se,Ye){for(var pt=0,qe=0,Ht=Se.length,Jt=Ht-2;qe<Ht;Jt=qe,qe+=2)pt+=(Se[qe]-Se[Jt])*(Se[qe+1]+Se[Jt+1]);if(pt>0===Ye)for(qe=0,Ht=Se.length;qe<Ht/2;qe+=2){var Pt=Se[qe],di=Se[qe+1];Se[qe]=Se[Ht-2-qe],Se[qe+1]=Se[Ht-1-qe],Se[Ht-2-qe]=Pt,Se[Ht-1-qe]=di}}(_e,fe),re.push(_e)}}function Zr(re,B){var G=(B=this.options=function(te,fe){for(var we in fe)te[we]=fe[we];return te}(Object.create(this.options),B)).debug;if(G&&console.time("preprocess data"),B.maxZoom<0||B.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(B.promoteId&&B.generateId)throw new Error("promoteId and generateId cannot be used together.");var ee=function(te,fe){var we=[];if(te.type==="FeatureCollection")for(var _e=0;_e<te.features.length;_e++)yt(we,te.features[_e],fe,_e);else yt(we,te.type==="Feature"?te:{geometry:te},fe);return we}(re,B);this.tiles={},this.tileCoords=[],G&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",B.indexMaxZoom,B.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ee=function(te,fe){var we=fe.buffer/fe.extent,_e=te,pe=fr(te,1,-1-we,we,0,-1,2,fe),Se=fr(te,1,1-we,2+we,0,-1,2,fe);return(pe||Se)&&(_e=fr(te,1,-we,1+we,0,-1,2,fe)||[],pe&&(_e=Oi(pe,1).concat(_e)),Se&&(_e=_e.concat(Oi(Se,-1)))),_e}(ee,B),ee.length&&this.splitTile(ee,0,0,0),G&&(ee.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function ls(re,B,G){return 32*((1<<re)*G+B)+re}function Wn(re,B){const G=re.tileID.canonical;if(!this._geoJSONIndex)return B(null,null);const ee=this._geoJSONIndex.getTile(G.z,G.x,G.y);if(!ee)return B(null,null);const te=new Y(ee.features);let fe=oe.exports(te);fe.byteOffset===0&&fe.byteLength===fe.buffer.byteLength||(fe=new Uint8Array(fe)),B(null,{vectorTile:te,rawData:fe.buffer})}Zr.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},Zr.prototype.splitTile=function(re,B,G,ee,te,fe,we){for(var _e=[re,B,G,ee],pe=this.options,Se=pe.debug;_e.length;){ee=_e.pop(),G=_e.pop(),B=_e.pop(),re=_e.pop();var Ye=1<<B,pt=ls(B,G,ee),qe=this.tiles[pt];if(!qe&&(Se>1&&console.time("creation"),qe=this.tiles[pt]=Dr(re,B,G,ee,pe),this.tileCoords.push({z:B,x:G,y:ee}),Se)){Se>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",B,G,ee,qe.numFeatures,qe.numPoints,qe.numSimplified),console.timeEnd("creation"));var Ht="z"+B;this.stats[Ht]=(this.stats[Ht]||0)+1,this.total++}if(qe.source=re,te){if(B===pe.maxZoom||B===te)continue;var Jt=1<<te-B;if(G!==Math.floor(fe/Jt)||ee!==Math.floor(we/Jt))continue}else if(B===pe.indexMaxZoom||qe.numPoints<=pe.indexMaxPoints)continue;if(qe.source=null,re.length!==0){Se>1&&console.time("clipping");var Pt,di,gi,Li,vi,Ti,Bi=.5*pe.buffer/pe.extent,Ci=.5-Bi,Ir=.5+Bi,cr=1+Bi;Pt=di=gi=Li=null,vi=fr(re,Ye,G-Bi,G+Ir,0,qe.minX,qe.maxX,pe),Ti=fr(re,Ye,G+Ci,G+cr,0,qe.minX,qe.maxX,pe),re=null,vi&&(Pt=fr(vi,Ye,ee-Bi,ee+Ir,1,qe.minY,qe.maxY,pe),di=fr(vi,Ye,ee+Ci,ee+cr,1,qe.minY,qe.maxY,pe),vi=null),Ti&&(gi=fr(Ti,Ye,ee-Bi,ee+Ir,1,qe.minY,qe.maxY,pe),Li=fr(Ti,Ye,ee+Ci,ee+cr,1,qe.minY,qe.maxY,pe),Ti=null),Se>1&&console.timeEnd("clipping"),_e.push(Pt||[],B+1,2*G,2*ee),_e.push(di||[],B+1,2*G,2*ee+1),_e.push(gi||[],B+1,2*G+1,2*ee),_e.push(Li||[],B+1,2*G+1,2*ee+1)}}},Zr.prototype.getTile=function(re,B,G){var ee=this.options,te=ee.extent,fe=ee.debug;if(re<0||re>24)return null;var we=1<<re,_e=ls(re,B=(B%we+we)%we,G);if(this.tiles[_e])return Vr(this.tiles[_e],te);fe>1&&console.log("drilling down to z%d-%d-%d",re,B,G);for(var pe,Se=re,Ye=B,pt=G;!pe&&Se>0;)Se--,Ye=Math.floor(Ye/2),pt=Math.floor(pt/2),pe=this.tiles[ls(Se,Ye,pt)];return pe&&pe.source?(fe>1&&console.log("found parent tile z%d-%d-%d",Se,Ye,pt),fe>1&&console.time("drilling down"),this.splitTile(pe.source,Se,Ye,pt,re,B,G),fe>1&&console.timeEnd("drilling down"),this.tiles[_e]?Vr(this.tiles[_e],te):null):null};class $n extends _{constructor(B,G,ee,te){super(B,G,ee,Wn),te&&(this.loadGeoJSON=te)}loadData(B,G){var ee;(ee=this._pendingRequest)===null||ee===void 0||ee.cancel(),this._pendingCallback&&this._pendingCallback(null,{abandoned:!0});const te=!!(B&&B.request&&B.request.collectResourceTiming)&&new n.RequestPerformance(B.request);this._pendingCallback=G,this._pendingRequest=this.loadGeoJSON(B,(fe,we)=>{if(delete this._pendingCallback,delete this._pendingRequest,fe||!we)return G(fe);if(typeof we!="object")return G(new Error(`Input data given to '${B.source}' is not a valid GeoJSON object.`));{C(we,!0);try{if(B.filter){const pe=n.createExpression(B.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(pe.result==="error")throw new Error(pe.value.map(Ye=>`${Ye.key}: ${Ye.message}`).join(", "));we={type:"FeatureCollection",features:we.features.filter(Ye=>pe.value.evaluate({zoom:0},Ye))}}this._geoJSONIndex=B.cluster?new Ce(function({superclusterOptions:pe,clusterProperties:Se}){if(!Se||!pe)return pe;const Ye={},pt={},qe={accumulated:null,zoom:0},Ht={properties:null},Jt=Object.keys(Se);for(const Pt of Jt){const[di,gi]=Se[Pt],Li=n.createExpression(gi),vi=n.createExpression(typeof di=="string"?[di,["accumulated"],["get",Pt]]:di);Ye[Pt]=Li.value,pt[Pt]=vi.value}return pe.map=Pt=>{Ht.properties=Pt;const di={};for(const gi of Jt)di[gi]=Ye[gi].evaluate(qe,Ht);return di},pe.reduce=(Pt,di)=>{Ht.properties=di;for(const gi of Jt)qe.accumulated=Pt[gi],Pt[gi]=pt[gi].evaluate(qe,Ht)},pe}(B)).load(we.features):function(pe,Se){return new Zr(pe,Se)}(we,B.geojsonVtOptions)}catch(pe){return G(pe)}this.loaded={};const _e={};if(te){const pe=te.finish();pe&&(_e.resourceTiming={},_e.resourceTiming[B.source]=JSON.parse(JSON.stringify(pe)))}G(null,_e)}})}reloadTile(B,G){const ee=this.loaded;return ee&&ee[B.uid]?super.reloadTile(B,G):this.loadTile(B,G)}loadGeoJSON(B,G){if(B.request)return n.getJSON(B.request,G);if(typeof B.data=="string")try{G(null,JSON.parse(B.data))}catch{G(new Error(`Input data given to '${B.source}' is not a valid GeoJSON object.`))}else G(new Error(`Input data given to '${B.source}' is not a valid GeoJSON object.`));return{cancel:()=>{}}}removeSource(B,G){this._pendingCallback&&this._pendingCallback(null,{abandoned:!0}),G()}getClusterExpansionZoom(B,G){try{G(null,this._geoJSONIndex.getClusterExpansionZoom(B.clusterId))}catch(ee){G(ee)}}getClusterChildren(B,G){try{G(null,this._geoJSONIndex.getChildren(B.clusterId))}catch(ee){G(ee)}}getClusterLeaves(B,G){try{G(null,this._geoJSONIndex.getLeaves(B.clusterId,B.limit,B.offset))}catch(ee){G(ee)}}}class qn{constructor(B){this.self=B,this.actor=new n.Actor(B,this),this.layerIndexes={},this.availableImages={},this.workerSourceTypes={vector:_,geojson:$n},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(G,ee)=>{if(this.workerSourceTypes[G])throw new Error(`Worker source with name "${G}" already registered.`);this.workerSourceTypes[G]=ee},this.self.registerRTLTextPlugin=G=>{if(n.plugin.isParsed())throw new Error("RTL text plugin already registered.");n.plugin.applyArabicShaping=G.applyArabicShaping,n.plugin.processBidirectionalText=G.processBidirectionalText,n.plugin.processStyledBidirectionalText=G.processStyledBidirectionalText}}setReferrer(B,G){this.referrer=G}setImages(B,G,ee){this.availableImages[B]=G;for(const te in this.workerSources[B]){const fe=this.workerSources[B][te];for(const we in fe)fe[we].availableImages=G}ee()}setLayers(B,G,ee){this.getLayerIndex(B).replace(G),ee()}updateLayers(B,G,ee){this.getLayerIndex(B).update(G.layers,G.removedIds),ee()}loadTile(B,G,ee){this.getWorkerSource(B,G.type,G.source).loadTile(G,ee)}loadDEMTile(B,G,ee){this.getDEMWorkerSource(B,G.source).loadTile(G,ee)}reloadTile(B,G,ee){this.getWorkerSource(B,G.type,G.source).reloadTile(G,ee)}abortTile(B,G,ee){this.getWorkerSource(B,G.type,G.source).abortTile(G,ee)}removeTile(B,G,ee){this.getWorkerSource(B,G.type,G.source).removeTile(G,ee)}removeDEMTile(B,G){this.getDEMWorkerSource(B,G.source).removeTile(G)}removeSource(B,G,ee){if(!this.workerSources[B]||!this.workerSources[B][G.type]||!this.workerSources[B][G.type][G.source])return;const te=this.workerSources[B][G.type][G.source];delete this.workerSources[B][G.type][G.source],te.removeSource!==void 0?te.removeSource(G,ee):ee()}loadWorkerSource(B,G,ee){try{this.self.importScripts(G.url),ee()}catch(te){ee(te.toString())}}syncRTLPluginState(B,G,ee){try{n.plugin.setState(G);const te=n.plugin.getPluginURL();if(n.plugin.isLoaded()&&!n.plugin.isParsed()&&te!=null){this.self.importScripts(te);const fe=n.plugin.isParsed();ee(fe?void 0:new Error(`RTL Text Plugin failed to import scripts from ${te}`),fe)}}catch(te){ee(te.toString())}}getAvailableImages(B){let G=this.availableImages[B];return G||(G=[]),G}getLayerIndex(B){let G=this.layerIndexes[B];return G||(G=this.layerIndexes[B]=new v),G}getWorkerSource(B,G,ee){if(this.workerSources[B]||(this.workerSources[B]={}),this.workerSources[B][G]||(this.workerSources[B][G]={}),!this.workerSources[B][G][ee]){const te={send:(fe,we,_e)=>{this.actor.send(fe,we,_e,B)}};this.workerSources[B][G][ee]=new this.workerSourceTypes[G](te,this.getLayerIndex(B),this.getAvailableImages(B))}return this.workerSources[B][G][ee]}getDEMWorkerSource(B,G){return this.demWorkerSources[B]||(this.demWorkerSources[B]={}),this.demWorkerSources[B][G]||(this.demWorkerSources[B][G]=new u),this.demWorkerSources[B][G]}enforceCacheSizeLimit(B,G){n.enforceCacheSizeLimit(G)}}return n.isWorker()&&(self.worker=new qn(self)),qn}),Yt(["./shared"],function(n){var g=x;function x(f){return!function(t){return typeof window>"u"||typeof document>"u"?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var l,m,b=new Blob([""],{type:"text/javascript"}),E=URL.createObjectURL(b);try{m=new Worker(E),l=!0}catch{l=!1}return m&&m.terminate(),URL.revokeObjectURL(E),l}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var l=document.createElement("canvas");l.width=l.height=1;var m=l.getContext("2d");if(!m)return!1;var b=m.getImageData(0,0,1,1);return b&&b.width===l.width}()?(v[s=t&&t.failIfMajorPerformanceCaveat]===void 0&&(v[s]=function(l){var m,b=function(E){var D=document.createElement("canvas"),L=Object.create(x.webGLContextAttributes);return L.failIfMajorPerformanceCaveat=E,D.getContext("webgl",L)||D.getContext("experimental-webgl",L)}(l);if(!b)return!1;try{m=b.createShader(b.VERTEX_SHADER)}catch{return!1}return!(!m||b.isContextLost())&&(b.shaderSource(m,"void main() {}"),b.compileShader(m),b.getShaderParameter(m,b.COMPILE_STATUS)===!0)}(s)),v[s]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var s}(f)}var v={};function h(f,t){if(Array.isArray(f)){if(!Array.isArray(t)||f.length!==t.length)return!1;for(let s=0;s<f.length;s++)if(!h(f[s],t[s]))return!1;return!0}if(typeof f=="object"&&f!==null&&t!==null){if(typeof t!="object"||Object.keys(f).length!==Object.keys(t).length)return!1;for(const s in f)if(!h(f[s],t[s]))return!1;return!0}return f===t}x.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};class a{static testProp(t){if(!a.docStyle)return t[0];for(let s=0;s<t.length;s++)if(t[s]in a.docStyle)return t[s];return t[0]}static create(t,s,l){const m=window.document.createElement(t);return s!==void 0&&(m.className=s),l&&l.appendChild(m),m}static createNS(t,s){return window.document.createElementNS(t,s)}static disableDrag(){a.docStyle&&a.selectProp&&(a.userSelect=a.docStyle[a.selectProp],a.docStyle[a.selectProp]="none")}static enableDrag(){a.docStyle&&a.selectProp&&(a.docStyle[a.selectProp]=a.userSelect)}static setTransform(t,s){t.style[a.transformProp]=s}static addEventListener(t,s,l,m={}){t.addEventListener(s,l,"passive"in m?m:m.capture)}static removeEventListener(t,s,l,m={}){t.removeEventListener(s,l,"passive"in m?m:m.capture)}static suppressClickInternal(t){t.preventDefault(),t.stopPropagation(),window.removeEventListener("click",a.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",a.suppressClickInternal,!0),window.setTimeout(()=>{window.removeEventListener("click",a.suppressClickInternal,!0)},0)}static mousePos(t,s){const l=t.getBoundingClientRect();return new n.pointGeometry(s.clientX-l.left-t.clientLeft,s.clientY-l.top-t.clientTop)}static touchPos(t,s){const l=t.getBoundingClientRect(),m=[];for(let b=0;b<s.length;b++)m.push(new n.pointGeometry(s[b].clientX-l.left-t.clientLeft,s[b].clientY-l.top-t.clientTop));return m}static mouseButton(t){return t.button}static remove(t){t.parentNode&&t.parentNode.removeChild(t)}}a.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,a.selectProp=a.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),a.transformProp=a.testProp(["transform","WebkitTransform"]);class c{constructor(t){this._transformRequestFn=t}transformRequest(t,s){return this._transformRequestFn&&this._transformRequestFn(t,s)||{url:t}}normalizeSpriteURL(t,s,l){const m=function(b){const E=b.match(d);if(!E)throw new Error(`Unable to parse URL "${b}"`);return{protocol:E[1],authority:E[2],path:E[3]||"/",params:E[4]?E[4].split("&"):[]}}(t);return m.path+=`${s}${l}`,function(b){const E=b.params.length?`?${b.params.join("&")}`:"";return`${b.protocol}://${b.authority}${b.path}${E}`}(m)}setTransformRequest(t){this._transformRequestFn=t}}const d=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;class _{constructor(t,s,l,m){this.context=t,this.format=l,this.texture=t.gl.createTexture(),this.update(s,m)}update(t,s,l){const{width:m,height:b}=t,E=!(this.size&&this.size[0]===m&&this.size[1]===b||l),{context:D}=this,{gl:L}=D;if(this.useMipmap=Boolean(s&&s.useMipmap),L.bindTexture(L.TEXTURE_2D,this.texture),D.pixelStoreUnpackFlipY.set(!1),D.pixelStoreUnpack.set(1),D.pixelStoreUnpackPremultiplyAlpha.set(this.format===L.RGBA&&(!s||s.premultiply!==!1)),E)this.size=[m,b],t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||n.isImageBitmap(t)?L.texImage2D(L.TEXTURE_2D,0,this.format,this.format,L.UNSIGNED_BYTE,t):L.texImage2D(L.TEXTURE_2D,0,this.format,m,b,0,this.format,L.UNSIGNED_BYTE,t.data);else{const{x:R,y:V}=l||{x:0,y:0};t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||n.isImageBitmap(t)?L.texSubImage2D(L.TEXTURE_2D,0,R,V,L.RGBA,L.UNSIGNED_BYTE,t):L.texSubImage2D(L.TEXTURE_2D,0,R,V,m,b,L.RGBA,L.UNSIGNED_BYTE,t.data)}this.useMipmap&&this.isSizePowerOfTwo()&&L.generateMipmap(L.TEXTURE_2D)}bind(t,s,l){const{context:m}=this,{gl:b}=m;b.bindTexture(b.TEXTURE_2D,this.texture),l!==b.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(l=b.LINEAR),t!==this.filter&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,t),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,l||t),this.filter=t),s!==this.wrap&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,s),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,s),this.wrap=s)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}function u(f){const{userImage:t}=f;return!!(t&&t.render&&t.render())&&(f.data.replace(new Uint8Array(t.data.buffer)),!0)}class C extends n.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new n.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(t){if(this.loaded!==t&&(this.loaded=t,t)){for(const{ids:s,callback:l}of this.requestors)this._notify(s,l);this.requestors=[]}}getImage(t){return this.images[t]}addImage(t,s){if(this.images[t])throw new Error(`Image id ${t} already exist, use updateImage instead`);this._validate(t,s)&&(this.images[t]=s)}_validate(t,s){let l=!0;return this._validateStretch(s.stretchX,s.data&&s.data.width)||(this.fire(new n.ErrorEvent(new Error(`Image "${t}" has invalid "stretchX" value`))),l=!1),this._validateStretch(s.stretchY,s.data&&s.data.height)||(this.fire(new n.ErrorEvent(new Error(`Image "${t}" has invalid "stretchY" value`))),l=!1),this._validateContent(s.content,s)||(this.fire(new n.ErrorEvent(new Error(`Image "${t}" has invalid "content" value`))),l=!1),l}_validateStretch(t,s){if(!t)return!0;let l=0;for(const m of t){if(m[0]<l||m[1]<m[0]||s<m[1])return!1;l=m[1]}return!0}_validateContent(t,s){return!(t&&(t.length!==4||t[0]<0||s.data.width<t[0]||t[1]<0||s.data.height<t[1]||t[2]<0||s.data.width<t[2]||t[3]<0||s.data.height<t[3]||t[2]<t[0]||t[3]<t[1]))}updateImage(t,s){const l=this.images[t];if(l.data.width!==s.data.width||l.data.height!==s.data.height)throw new Error(`size mismatch between old image (${l.data.width}x${l.data.height}) and new image (${s.data.width}x${s.data.height}).`);s.version=l.version+1,this.images[t]=s,this.updatedImages[t]=!0}removeImage(t){const s=this.images[t];delete this.images[t],delete this.patterns[t],s.userImage&&s.userImage.onRemove&&s.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(t,s){let l=!0;if(!this.isLoaded())for(const m of t)this.images[m]||(l=!1);this.isLoaded()||l?this._notify(t,s):this.requestors.push({ids:t,callback:s})}_notify(t,s){const l={};for(const m of t){this.images[m]||this.fire(new n.Event("styleimagemissing",{id:m}));const b=this.images[m];b?l[m]={data:b.data.clone(),pixelRatio:b.pixelRatio,sdf:b.sdf,version:b.version,stretchX:b.stretchX,stretchY:b.stretchY,content:b.content,hasRenderCallback:Boolean(b.userImage&&b.userImage.render)}:n.warnOnce(`Image "${m}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}s(null,l)}getPixelSize(){const{width:t,height:s}=this.atlasImage;return{width:t,height:s}}getPattern(t){const s=this.patterns[t],l=this.getImage(t);if(!l)return null;if(s&&s.position.version===l.version)return s.position;if(s)s.position.version=l.version;else{const m={w:l.data.width+2,h:l.data.height+2,x:0,y:0},b=new n.ImagePosition(m,l);this.patterns[t]={bin:m,position:b}}return this._updatePatternAtlas(),this.patterns[t].position}bind(t){const s=t.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new _(t,this.atlasImage,s.RGBA),this.atlasTexture.bind(s.LINEAR,s.CLAMP_TO_EDGE)}_updatePatternAtlas(){const t=[];for(const b in this.patterns)t.push(this.patterns[b].bin);const{w:s,h:l}=n.potpack(t),m=this.atlasImage;m.resize({width:s||1,height:l||1});for(const b in this.patterns){const{bin:E}=this.patterns[b],D=E.x+1,L=E.y+1,R=this.images[b].data,V=R.width,X=R.height;n.RGBAImage.copy(R,m,{x:0,y:0},{x:D,y:L},{width:V,height:X}),n.RGBAImage.copy(R,m,{x:0,y:X-1},{x:D,y:L-1},{width:V,height:1}),n.RGBAImage.copy(R,m,{x:0,y:0},{x:D,y:L+X},{width:V,height:1}),n.RGBAImage.copy(R,m,{x:V-1,y:0},{x:D-1,y:L},{width:1,height:X}),n.RGBAImage.copy(R,m,{x:0,y:0},{x:D+V,y:L},{width:1,height:X})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(t){for(const s of t){if(this.callbackDispatchedThisFrame[s])continue;this.callbackDispatchedThisFrame[s]=!0;const l=this.images[s];l||n.warnOnce(`Image with ID: "${s}" was not found`),u(l)&&this.updateImage(s,l)}}}const S=1e20;function A(f,t,s,l,m,b,E,D,L){for(let R=t;R<t+l;R++)O(f,s*b+R,b,m,E,D,L);for(let R=s;R<s+m;R++)O(f,R*b+t,1,l,E,D,L)}function O(f,t,s,l,m,b,E){b[0]=0,E[0]=-S,E[1]=S,m[0]=f[t];for(let D=1,L=0,R=0;D<l;D++){m[D]=f[t+D*s];const V=D*D;do{const X=b[L];R=(m[D]-m[X]+V-X*X)/(D-X)/2}while(R<=E[L]&&--L>-1);L++,b[L]=D,E[L]=R,E[L+1]=S}for(let D=0,L=0;D<l;D++){for(;E[L+1]<D;)L++;const R=b[L],V=D-R;f[t+D*s]=m[R]+V*V}}class U{constructor(t,s){this.requestManager=t,this.localIdeographFontFamily=s,this.entries={}}setURL(t){this.url=t}getGlyphs(t,s){const l=[];for(const m in t)for(const b of t[m])l.push({stack:m,id:b});n.asyncAll(l,({stack:m,id:b},E)=>{let D=this.entries[m];D||(D=this.entries[m]={glyphs:{},requests:{},ranges:{}});let L=D.glyphs[b];if(L!==void 0)return void E(null,{stack:m,id:b,glyph:L});if(L=this._tinySDF(D,m,b),L)return D.glyphs[b]=L,void E(null,{stack:m,id:b,glyph:L});const R=Math.floor(b/256);if(256*R>65535)return void E(new Error("glyphs > 65535 not supported"));if(D.ranges[R])return void E(null,{stack:m,id:b,glyph:L});let V=D.requests[R];V||(V=D.requests[R]=[],U.loadGlyphRange(m,R,this.url,this.requestManager,(X,H)=>{if(H){for(const le in H)this._doesCharSupportLocalGlyph(+le)||(D.glyphs[+le]=H[+le]);D.ranges[R]=!0}for(const le of V)le(X,H);delete D.requests[R]})),V.push((X,H)=>{X?E(X):H&&E(null,{stack:m,id:b,glyph:H[b]||null})})},(m,b)=>{if(m)s(m);else if(b){const E={};for(const{stack:D,id:L,glyph:R}of b)(E[D]||(E[D]={}))[L]=R&&{id:R.id,bitmap:R.bitmap.clone(),metrics:R.metrics};s(null,E)}})}_doesCharSupportLocalGlyph(t){return!!this.localIdeographFontFamily&&(n.unicodeBlockLookup["CJK Unified Ideographs"](t)||n.unicodeBlockLookup["Hangul Syllables"](t)||n.unicodeBlockLookup.Hiragana(t)||n.unicodeBlockLookup.Katakana(t))}_tinySDF(t,s,l){const m=this.localIdeographFontFamily;if(!m||!this._doesCharSupportLocalGlyph(l))return;let b=t.tinySDF;if(!b){let D="400";/bold/i.test(s)?D="900":/medium/i.test(s)?D="500":/light/i.test(s)&&(D="200"),b=t.tinySDF=new U.TinySDF({fontSize:24,buffer:3,radius:8,cutoff:.25,fontFamily:m,fontWeight:D})}const E=b.draw(String.fromCharCode(l));return{id:l,bitmap:new n.AlphaImage({width:E.width||30,height:E.height||30},E.data),metrics:{width:E.glyphWidth||24,height:E.glyphHeight||24,left:E.glyphLeft||0,top:E.glyphTop-27||-8,advance:E.glyphAdvance||24}}}}U.loadGlyphRange=function(f,t,s,l,m){const b=256*t,E=b+255,D=l.transformRequest(s.replace("{fontstack}",f).replace("{range}",`${b}-${E}`),n.ResourceType.Glyphs);n.getArrayBuffer(D,(L,R)=>{if(L)m(L);else if(R){const V={};for(const X of n.parseGlyphPbf(R))V[X.id]=X;m(null,V)}})},U.TinySDF=class{constructor({fontSize:f=24,buffer:t=3,radius:s=8,cutoff:l=.25,fontFamily:m="sans-serif",fontWeight:b="normal",fontStyle:E="normal"}={}){this.buffer=t,this.cutoff=l,this.radius=s;const D=this.size=f+4*t,L=this._createCanvas(D),R=this.ctx=L.getContext("2d",{willReadFrequently:!0});R.font=`${E} ${b} ${f}px ${m}`,R.textBaseline="alphabetic",R.textAlign="left",R.fillStyle="black",this.gridOuter=new Float64Array(D*D),this.gridInner=new Float64Array(D*D),this.f=new Float64Array(D),this.z=new Float64Array(D+1),this.v=new Uint16Array(D)}_createCanvas(f){const t=document.createElement("canvas");return t.width=t.height=f,t}draw(f){const{width:t,actualBoundingBoxAscent:s,actualBoundingBoxDescent:l,actualBoundingBoxLeft:m,actualBoundingBoxRight:b}=this.ctx.measureText(f),E=Math.ceil(s),D=Math.min(this.size-this.buffer,Math.ceil(b-m)),L=Math.min(this.size-this.buffer,E+Math.ceil(l)),R=D+2*this.buffer,V=L+2*this.buffer,X=Math.max(R*V,0),H=new Uint8ClampedArray(X),le={data:H,width:R,height:V,glyphWidth:D,glyphHeight:L,glyphTop:E,glyphLeft:0,glyphAdvance:t};if(D===0||L===0)return le;const{ctx:ne,buffer:ae,gridInner:xe,gridOuter:Ee}=this;ne.clearRect(ae,ae,D,L),ne.fillText(f,ae,ae+E);const Oe=ne.getImageData(ae,ae,D,L);Ee.fill(S,0,X),xe.fill(0,0,X);for(let he=0;he<L;he++)for(let Ge=0;Ge<D;Ge++){const Fe=Oe.data[4*(he*D+Ge)+3]/255;if(Fe===0)continue;const et=(he+ae)*R+Ge+ae;if(Fe===1)Ee[et]=0,xe[et]=S;else{const it=.5-Fe;Ee[et]=it>0?it*it:0,xe[et]=it<0?it*it:0}}A(Ee,0,0,R,V,R,this.f,this.v,this.z),A(xe,ae,ae,D,L,R,this.f,this.v,this.z);for(let he=0;he<X;he++){const Ge=Math.sqrt(Ee[he])-Math.sqrt(xe[he]);H[he]=Math.round(255-255*(Ge/this.radius+this.cutoff))}return le}};const Y=new n.Properties({anchor:new n.DataConstantProperty(n.spec.light.anchor),position:new class{constructor(){this.specification=n.spec.light.position}possiblyEvaluate(f,t){return n.sphericalToCartesian(f.expression.evaluate(t))}interpolate(f,t,s){return{x:n.number(f.x,t.x,s),y:n.number(f.y,t.y,s),z:n.number(f.z,t.z,s)}}},color:new n.DataConstantProperty(n.spec.light.color),intensity:new n.DataConstantProperty(n.spec.light.intensity)}),oe="-transition";class ge extends n.Evented{constructor(t){super(),this._transitionable=new n.Transitionable(Y),this.setLight(t),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,s={}){if(!this._validate(n.validateLight,t,s))for(const l in t){const m=t[l];l.endsWith(oe)?this._transitionable.setTransition(l.slice(0,-oe.length),m):this._transitionable.setValue(l,m)}}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,s,l){return(!l||l.validate!==!1)&&n.emitValidationErrors(this,t.call(n.validateStyle,n.extend({value:s,style:{glyphs:!0,sprite:!0},styleSpec:n.spec})))}}class ze{constructor(t,s){this.width=t,this.height=s,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(t,s){const l=t.join(",")+String(s);return this.dashEntry[l]||(this.dashEntry[l]=this.addDash(t,s)),this.dashEntry[l]}getDashRanges(t,s,l){const m=[];let b=t.length%2==1?-t[t.length-1]*l:0,E=t[0]*l,D=!0;m.push({left:b,right:E,isDash:D,zeroLength:t[0]===0});let L=t[0];for(let R=1;R<t.length;R++){D=!D;const V=t[R];b=L*l,L+=V,E=L*l,m.push({left:b,right:E,isDash:D,zeroLength:V===0})}return m}addRoundDash(t,s,l){const m=s/2;for(let b=-l;b<=l;b++){const E=this.width*(this.nextRow+l+b);let D=0,L=t[D];for(let R=0;R<this.width;R++){R/L.right>1&&(L=t[++D]);const V=Math.abs(R-L.left),X=Math.abs(R-L.right),H=Math.min(V,X);let le;const ne=b/l*(m+1);if(L.isDash){const ae=m-Math.abs(ne);le=Math.sqrt(H*H+ae*ae)}else le=m-Math.sqrt(H*H+ne*ne);this.data[E+R]=Math.max(0,Math.min(255,le+128))}}}addRegularDash(t){for(let D=t.length-1;D>=0;--D){const L=t[D],R=t[D+1];L.zeroLength?t.splice(D,1):R&&R.isDash===L.isDash&&(R.left=L.left,t.splice(D,1))}const s=t[0],l=t[t.length-1];s.isDash===l.isDash&&(s.left=l.left-this.width,l.right=s.right+this.width);const m=this.width*this.nextRow;let b=0,E=t[b];for(let D=0;D<this.width;D++){D/E.right>1&&(E=t[++b]);const L=Math.abs(D-E.left),R=Math.abs(D-E.right),V=Math.min(L,R);this.data[m+D]=Math.max(0,Math.min(255,(E.isDash?V:-V)+128))}}addDash(t,s){const l=s?7:0,m=2*l+1;if(this.nextRow+m>this.height)return n.warnOnce("LineAtlas out of space"),null;let b=0;for(let D=0;D<t.length;D++)b+=t[D];if(b!==0){const D=this.width/b,L=this.getDashRanges(t,this.width,D);s?this.addRoundDash(L,D,l):this.addRegularDash(L)}const E={y:(this.nextRow+l+.5)/this.height,height:2*l/this.height,width:b};return this.nextRow+=m,this.dirty=!0,E}bind(t){const s=t.gl;this.texture?(s.bindTexture(s.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,s.texSubImage2D(s.TEXTURE_2D,0,0,0,this.width,this.height,s.ALPHA,s.UNSIGNED_BYTE,this.data))):(this.texture=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this.texture),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texImage2D(s.TEXTURE_2D,0,s.ALPHA,this.width,this.height,0,s.ALPHA,s.UNSIGNED_BYTE,this.data))}}class We{constructor(t,s){this.workerPool=t,this.actors=[],this.currentActor=0,this.id=n.uniqueId();const l=this.workerPool.acquire(this.id);for(let m=0;m<l.length;m++){const b=new We.Actor(l[m],s,this.id);b.name=`Worker ${m}`,this.actors.push(b)}if(!this.actors.length)throw new Error("No actors found")}broadcast(t,s,l){n.asyncAll(this.actors,(m,b)=>{m.send(t,s,b)},l=l||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(t=>{t.remove()}),this.actors=[],this.workerPool.release(this.id)}}function at(f,t,s){const l=function(m,b){if(m)return s(m);if(b){const E=n.pick(n.extend(b,f),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);b.vector_layers&&(E.vectorLayers=b.vector_layers,E.vectorLayerIds=E.vectorLayers.map(D=>D.id)),s(null,E)}};return f.url?n.getJSON(t.transformRequest(f.url,n.ResourceType.Source),l):n.exported.frame(()=>l(null,f))}We.Actor=n.Actor;class _t{constructor(t,s,l){this.bounds=n.LngLatBounds.convert(this.validateBounds(t)),this.minzoom=s||0,this.maxzoom=l||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(t){const s=Math.pow(2,t.z),l=Math.floor(n.mercatorXfromLng(this.bounds.getWest())*s),m=Math.floor(n.mercatorYfromLat(this.bounds.getNorth())*s),b=Math.ceil(n.mercatorXfromLng(this.bounds.getEast())*s),E=Math.ceil(n.mercatorYfromLat(this.bounds.getSouth())*s);return t.x>=l&&t.x<b&&t.y>=m&&t.y<E}}class vt extends n.Evented{constructor(t,s,l,m){if(super(),this.id=t,this.dispatcher=l,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,n.extend(this,n.pick(s,["url","scheme","tileSize","promoteId"])),this._options=n.extend({type:"vector"},s),this._collectResourceTiming=s.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(m)}load(){this._loaded=!1,this.fire(new n.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=at(this._options,this.map._requestManager,(t,s)=>{this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),t?this.fire(new n.ErrorEvent(t)):s&&(n.extend(this,s),s.bounds&&(this.tileBounds=new _t(s.bounds,this.minzoom,this.maxzoom)),this.fire(new n.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new n.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}setSourceProperty(t){this._tileJSONRequest&&this._tileJSONRequest.cancel(),t(),this.load()}setTiles(t){return this.setSourceProperty(()=>{this._options.tiles=t}),this}setUrl(t){return this.setSourceProperty(()=>{this.url=t,this._options.url=t}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return n.extend({},this._options)}loadTile(t,s){const l=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),m={request:this.map._requestManager.transformRequest(l,n.ResourceType.Tile),uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};function b(E,D){return delete t.request,t.aborted?s(null):E&&E.status!==404?s(E):(D&&D.resourceTiming&&(t.resourceTiming=D.resourceTiming),this.map._refreshExpiredTiles&&D&&t.setExpiryData(D),t.loadVectorData(D,this.map.painter),n.cacheEntryPossiblyAdded(this.dispatcher),s(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}m.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired"?t.state==="loading"?t.reloadCallback=s:t.request=t.actor.send("reloadTile",m,b.bind(this)):(t.actor=this.dispatcher.getActor(),t.request=t.actor.send("loadTile",m,b.bind(this)))}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id},void 0)}unloadTile(t){t.unloadVectorData(),t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id},void 0)}hasTransition(){return!1}}class rt extends n.Evented{constructor(t,s,l,m){super(),this.id=t,this.dispatcher=l,this.setEventedParent(m),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=n.extend({type:"raster"},s),n.extend(this,n.pick(s,["url","scheme","tileSize"]))}load(){this._loaded=!1,this.fire(new n.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=at(this._options,this.map._requestManager,(t,s)=>{this._tileJSONRequest=null,this._loaded=!0,t?this.fire(new n.ErrorEvent(t)):s&&(n.extend(this,s),s.bounds&&(this.tileBounds=new _t(s.bounds,this.minzoom,this.maxzoom)),this.fire(new n.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new n.Event("data",{dataType:"source",sourceDataType:"content"})))})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}serialize(){return n.extend({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,s){const l=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);t.request=n.getImage(this.map._requestManager.transformRequest(l,n.ResourceType.Tile),(m,b,E)=>{if(delete t.request,t.aborted)t.state="unloaded",s(null);else if(m)t.state="errored",s(m);else if(b){this.map._refreshExpiredTiles&&t.setExpiryData(E);const D=this.map.painter.context,L=D.gl;t.texture=this.map.painter.getTileTexture(b.width),t.texture?t.texture.update(b,{useMipmap:!0}):(t.texture=new _(D,b,L.RGBA,{useMipmap:!0}),t.texture.bind(L.LINEAR,L.CLAMP_TO_EDGE,L.LINEAR_MIPMAP_NEAREST),D.extTextureFilterAnisotropic&&L.texParameterf(L.TEXTURE_2D,D.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,D.extTextureFilterAnisotropicMax)),t.state="loaded",n.cacheEntryPossiblyAdded(this.dispatcher),s(null)}})}abortTile(t,s){t.request&&(t.request.cancel(),delete t.request),s()}unloadTile(t,s){t.texture&&this.map.painter.saveTileTexture(t.texture),s()}hasTransition(){return!1}}let mt;class Qe extends rt{constructor(t,s,l,m){super(t,s,l,m),this.type="raster-dem",this.maxzoom=22,this._options=n.extend({type:"raster-dem"},s),this.encoding=s.encoding||"mapbox"}serialize(){return{type:"raster-dem",url:this.url,tileSize:this.tileSize,tiles:this.tiles,bounds:this.bounds,encoding:this.encoding}}loadTile(t,s){const l=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);function m(b,E){b&&(t.state="errored",s(b)),E&&(t.dem=E,t.needsHillshadePrepare=!0,t.needsTerrainPrepare=!0,t.state="loaded",s(null))}t.request=n.getImage(this.map._requestManager.transformRequest(l,n.ResourceType.Tile),function(b,E){if(delete t.request,t.aborted)t.state="unloaded",s(null);else if(b)t.state="errored",s(b);else if(E){this.map._refreshExpiredTiles&&t.setExpiryData(E),delete E.cacheControl,delete E.expires;const D=n.isImageBitmap(E)&&(mt==null&&(mt=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),mt)?E:n.exported.getImageData(E,1),L={uid:t.uid,coord:t.tileID,source:this.id,rawImageData:D,encoding:this.encoding};t.actor&&t.state!=="expired"||(t.actor=this.dispatcher.getActor(),t.actor.send("loadDEMTile",L,m.bind(this)))}}.bind(this)),t.neighboringTiles=this._getNeighboringTiles(t.tileID)}_getNeighboringTiles(t){const s=t.canonical,l=Math.pow(2,s.z),m=(s.x-1+l)%l,b=s.x===0?t.wrap-1:t.wrap,E=(s.x+1+l)%l,D=s.x+1===l?t.wrap+1:t.wrap,L={};return L[new n.OverscaledTileID(t.overscaledZ,b,s.z,m,s.y).key]={backfilled:!1},L[new n.OverscaledTileID(t.overscaledZ,D,s.z,E,s.y).key]={backfilled:!1},s.y>0&&(L[new n.OverscaledTileID(t.overscaledZ,b,s.z,m,s.y-1).key]={backfilled:!1},L[new n.OverscaledTileID(t.overscaledZ,t.wrap,s.z,s.x,s.y-1).key]={backfilled:!1},L[new n.OverscaledTileID(t.overscaledZ,D,s.z,E,s.y-1).key]={backfilled:!1}),s.y+1<l&&(L[new n.OverscaledTileID(t.overscaledZ,b,s.z,m,s.y+1).key]={backfilled:!1},L[new n.OverscaledTileID(t.overscaledZ,t.wrap,s.z,s.x,s.y+1).key]={backfilled:!1},L[new n.OverscaledTileID(t.overscaledZ,D,s.z,E,s.y+1).key]={backfilled:!1}),L}unloadTile(t){t.demTexture&&this.map.painter.saveTileTexture(t.demTexture),t.fbo&&(t.fbo.destroy(),delete t.fbo),t.dem&&delete t.dem,delete t.neighboringTiles,t.state="unloaded",t.actor&&t.actor.send("removeDEMTile",{uid:t.uid,source:this.id})}}class zt extends n.Evented{constructor(t,s,l,m){super(),this.id=t,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=l.getActor(),this.setEventedParent(m),this._data=s.data,this._options=n.extend({},s),this._collectResourceTiming=s.collectResourceTiming,s.maxzoom!==void 0&&(this.maxzoom=s.maxzoom),s.type&&(this.type=s.type),s.attribution&&(this.attribution=s.attribution),this.promoteId=s.promoteId;const b=n.EXTENT/this.tileSize;this.workerOptions=n.extend({source:this.id,cluster:s.cluster||!1,geojsonVtOptions:{buffer:(s.buffer!==void 0?s.buffer:128)*b,tolerance:(s.tolerance!==void 0?s.tolerance:.375)*b,extent:n.EXTENT,maxZoom:this.maxzoom,lineMetrics:s.lineMetrics||!1,generateId:s.generateId||!1},superclusterOptions:{maxZoom:s.clusterMaxZoom!==void 0?s.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,s.clusterMinPoints||2),extent:n.EXTENT,radius:(s.clusterRadius||50)*b,log:!1,generateId:s.generateId||!1},clusterProperties:s.clusterProperties,filter:s.filter},s.workerOptions)}load(){this._updateWorkerData("metadata")}onAdd(t){this.map=t,this.load()}setData(t){return this._data=t,this._updateWorkerData("content"),this}getClusterExpansionZoom(t,s){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:t,source:this.id},s),this}getClusterChildren(t,s){return this.actor.send("geojson.getClusterChildren",{clusterId:t,source:this.id},s),this}getClusterLeaves(t,s,l,m){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:t,limit:s,offset:l},m),this}_updateWorkerData(t){const s=n.extend({},this.workerOptions),l=this._data;typeof l=="string"?(s.request=this.map._requestManager.transformRequest(n.exported.resolveURL(l),n.ResourceType.Source),s.request.collectResourceTiming=this._collectResourceTiming):s.data=JSON.stringify(l),this._pendingLoads++,this.fire(new n.Event("dataloading",{dataType:"source"})),this.actor.send(`${this.type}.loadData`,s,(m,b)=>{if(this._pendingLoads--,this._removed||b&&b.abandoned)return void this.fire(new n.Event("dataabort",{dataType:"source",sourceDataType:t}));let E=null;if(b&&b.resourceTiming&&b.resourceTiming[this.id]&&(E=b.resourceTiming[this.id].slice(0)),m)return void this.fire(new n.ErrorEvent(m));const D={dataType:"source",sourceDataType:t};this._collectResourceTiming&&E&&E.length>0&&n.extend(D,{resourceTiming:E}),this.fire(new n.Event("data",D))})}loaded(){return this._pendingLoads===0}loadTile(t,s){const l=t.actor?"reloadTile":"loadTile";t.actor=this.actor;const m={type:this.type,uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};t.request=this.actor.send(l,m,(b,E)=>(delete t.request,t.unloadVectorData(),t.aborted?s(null):b?s(b):(t.loadVectorData(E,this.map.painter,l==="reloadTile"),s(null))))}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.aborted=!0}unloadTile(t){t.unloadVectorData(),this.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id})}onRemove(){this._removed=!0,this.actor.send("removeSource",{type:this.type,source:this.id})}serialize(){return n.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}var Et=n.createLayout([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class Q extends n.Evented{constructor(t,s,l,m){super(),this.id=t,this.dispatcher=l,this.coordinates=s.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(m),this.options=s}load(t,s){this._loaded=!1,this.fire(new n.Event("dataloading",{dataType:"source"})),this.url=this.options.url,n.getImage(this.map._requestManager.transformRequest(this.url,n.ResourceType.Image),(l,m)=>{this._loaded=!0,l?this.fire(new n.ErrorEvent(l)):m&&(this.image=m,t&&(this.coordinates=t),s&&s(),this._finishLoading())})}loaded(){return this._loaded}updateImage(t){return this.image&&t.url?(this.options.url=t.url,this.load(t.coordinates,()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new n.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}setCoordinates(t){this.coordinates=t;const s=t.map(n.MercatorCoordinate.fromLngLat);this.tileID=function(m){let b=1/0,E=1/0,D=-1/0,L=-1/0;for(const H of m)b=Math.min(b,H.x),E=Math.min(E,H.y),D=Math.max(D,H.x),L=Math.max(L,H.y);const R=Math.max(D-b,L-E),V=Math.max(0,Math.floor(-Math.log(R)/Math.LN2)),X=Math.pow(2,V);return new n.CanonicalTileID(V,Math.floor((b+D)/2*X),Math.floor((E+L)/2*X))}(s),this.minzoom=this.maxzoom=this.tileID.z;const l=s.map(m=>this.tileID.getTilePoint(m)._round());return this._boundsArray=new n.RasterBoundsArray,this._boundsArray.emplaceBack(l[0].x,l[0].y,0,0),this._boundsArray.emplaceBack(l[1].x,l[1].y,n.EXTENT,0),this._boundsArray.emplaceBack(l[3].x,l[3].y,0,n.EXTENT),this._boundsArray.emplaceBack(l[2].x,l[2].y,n.EXTENT,n.EXTENT),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this.fire(new n.Event("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const t=this.map.painter.context,s=t.gl;this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,Et.members)),this.boundsSegments||(this.boundsSegments=n.SegmentVector.simpleSegment(0,0,4,2)),this.texture||(this.texture=new _(t,this.image,s.RGBA),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE));for(const l in this.tiles){const m=this.tiles[l];m.state!=="loaded"&&(m.state="loaded",m.texture=this.texture)}}loadTile(t,s){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={},s(null)):(t.state="errored",s(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class se extends Q{constructor(t,s,l,m){super(t,s,l,m),this.roundZoom=!0,this.type="video",this.options=s}load(){this._loaded=!1;const t=this.options;this.urls=[];for(const s of t.urls)this.urls.push(this.map._requestManager.transformRequest(s,n.ResourceType.Source).url);n.getVideo(this.urls,(s,l)=>{this._loaded=!0,s?this.fire(new n.ErrorEvent(s)):l&&(this.video=l,this.video.loop=!0,this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(t){if(this.video){const s=this.video.seekable;t<s.start(0)||t>s.end(0)?this.fire(new n.ErrorEvent(new n.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${s.start(0)} and ${s.end(0)}-second mark.`))):this.video.currentTime=t}}getVideo(){return this.video}onAdd(t){this.map||(this.map=t,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const t=this.map.painter.context,s=t.gl;this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,Et.members)),this.boundsSegments||(this.boundsSegments=n.SegmentVector.simpleSegment(0,0,4,2)),this.texture?this.video.paused||(this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE),s.texSubImage2D(s.TEXTURE_2D,0,0,0,s.RGBA,s.UNSIGNED_BYTE,this.video)):(this.texture=new _(t,this.video,s.RGBA),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE));for(const l in this.tiles){const m=this.tiles[l];m.state!=="loaded"&&(m.state="loaded",m.texture=this.texture)}}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class de extends Q{constructor(t,s,l,m){super(t,s,l,m),s.coordinates?Array.isArray(s.coordinates)&&s.coordinates.length===4&&!s.coordinates.some(b=>!Array.isArray(b)||b.length!==2||b.some(E=>typeof E!="number"))||this.fire(new n.ErrorEvent(new n.ValidationError(`sources.${t}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new n.ErrorEvent(new n.ValidationError(`sources.${t}`,null,'missing required property "coordinates"'))),s.animate&&typeof s.animate!="boolean"&&this.fire(new n.ErrorEvent(new n.ValidationError(`sources.${t}`,null,'optional "animate" property must be a boolean value'))),s.canvas?typeof s.canvas=="string"||s.canvas instanceof HTMLCanvasElement||this.fire(new n.ErrorEvent(new n.ValidationError(`sources.${t}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new n.ErrorEvent(new n.ValidationError(`sources.${t}`,null,'missing required property "canvas"'))),this.options=s,this.animate=s.animate===void 0||s.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new n.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(t){this.map=t,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let t=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,t=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,t=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const s=this.map.painter.context,l=s.gl;this.boundsBuffer||(this.boundsBuffer=s.createVertexBuffer(this._boundsArray,Et.members)),this.boundsSegments||(this.boundsSegments=n.SegmentVector.simpleSegment(0,0,4,2)),this.texture?(t||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new _(s,this.canvas,l.RGBA,{premultiply:!0});for(const m in this.tiles){const b=this.tiles[m];b.state!=="loaded"&&(b.state="loaded",b.texture=this.texture)}}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const t of[this.canvas.width,this.canvas.height])if(isNaN(t)||t<=0)return!0;return!1}}const ie={vector:vt,raster:rt,"raster-dem":Qe,geojson:zt,video:se,image:Q,canvas:de};function ve(f,t){const s=n.create();return n.translate(s,s,[1,1,0]),n.scale(s,s,[.5*f.width,.5*f.height,1]),n.multiply(s,s,f.calculatePosMatrix(t.toUnwrapped()))}function J(f,t,s,l,m,b){const E=function(X,H,le){if(X)for(const ne of X){const ae=H[ne];if(ae&&ae.source===le&&ae.type==="fill-extrusion")return!0}else for(const ne in H){const ae=H[ne];if(ae.source===le&&ae.type==="fill-extrusion")return!0}return!1}(m&&m.layers,t,f.id),D=b.maxPitchScaleFactor(),L=f.tilesIn(l,D,E);L.sort(q);const R=[];for(const X of L)R.push({wrappedTileID:X.tileID.wrapped().key,queryResults:X.tile.queryRenderedFeatures(t,s,f._state,X.queryGeometry,X.cameraQueryGeometry,X.scale,m,b,D,ve(f.transform,X.tileID))});const V=function(X){const H={},le={};for(const ne of X){const ae=ne.queryResults,xe=ne.wrappedTileID,Ee=le[xe]=le[xe]||{};for(const Oe in ae){const he=ae[Oe],Ge=Ee[Oe]=Ee[Oe]||{},Fe=H[Oe]=H[Oe]||[];for(const et of he)Ge[et.featureIndex]||(Ge[et.featureIndex]=!0,Fe.push(et))}}return H}(R);for(const X in V)V[X].forEach(H=>{const le=H.feature,ne=f.getFeatureState(le.layer["source-layer"],le.id);le.source=le.layer.source,le.layer["source-layer"]&&(le.sourceLayer=le.layer["source-layer"]),le.state=ne});return V}function q(f,t){const s=f.tileID,l=t.tileID;return s.overscaledZ-l.overscaledZ||s.canonical.y-l.canonical.y||s.wrap-l.wrap||s.canonical.x-l.canonical.x}class ce{constructor(t,s){this.tileID=t,this.uid=n.uniqueId(),this.uses=0,this.tileSize=s,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.textures=[],this.textureCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(t){const s=t+this.timeAdded;s<n.exported.now()||this.fadeEndTime&&s<this.fadeEndTime||(this.fadeEndTime=s)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(t){this.demTexture&&t.saveTileTexture(this.demTexture),this.textures.forEach(s=>t.saveTileTexture(s)),this.demTexture=null,this.textures=[],this.textureCoords={}}loadVectorData(t,s,l){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(m,b){const E={};if(!b)return E;for(const D of m){const L=D.layerIds.map(R=>b.getLayer(R)).filter(Boolean);if(L.length!==0){D.layers=L,D.stateDependentLayerIds&&(D.stateDependentLayers=D.stateDependentLayerIds.map(R=>L.filter(V=>V.id===R)[0]));for(const R of L)E[R.id]=D}}return E}(t.buckets,s.style),this.hasSymbolBuckets=!1;for(const m in this.buckets){const b=this.buckets[m];if(b instanceof n.SymbolBucket){if(this.hasSymbolBuckets=!0,!l)break;b.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const m in this.buckets){const b=this.buckets[m];if(b instanceof n.SymbolBucket&&b.hasRTLText){this.hasRTLText=!0,n.lazyLoadRTLTextPlugin();break}}this.queryPadding=0;for(const m in this.buckets){const b=this.buckets[m];this.queryPadding=Math.max(this.queryPadding,s.style.getLayer(m).queryRadius(b))}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage)}else this.collisionBoxArray=new n.CollisionBoxArray}unloadVectorData(){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(t){return this.buckets[t.id]}upload(t){for(const l in this.buckets){const m=this.buckets[l];m.uploadPending()&&m.upload(t)}const s=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new _(t,this.imageAtlas.image,s.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new _(t,this.glyphAtlasImage,s.ALPHA),this.glyphAtlasImage=null)}prepare(t){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture)}queryRenderedFeatures(t,s,l,m,b,E,D,L,R,V){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:m,cameraQueryGeometry:b,scale:E,tileSize:this.tileSize,pixelPosMatrix:V,transform:L,params:D,queryPadding:this.queryPadding*R},t,s,l):{}}querySourceFeatures(t,s){const l=this.latestFeatureIndex;if(!l||!l.rawTileData)return;const m=l.loadVTLayers(),b=s?s.sourceLayer:"",E=m._geojsonTileLayer||m[b];if(!E)return;const D=n.createFilter(s&&s.filter),{z:L,x:R,y:V}=this.tileID.canonical,X={z:L,x:R,y:V};for(let H=0;H<E.length;H++){const le=E.feature(H);if(D.needGeometry){const xe=n.toEvaluationFeature(le,!0);if(!D.filter(new n.EvaluationParameters(this.tileID.overscaledZ),xe,this.tileID.canonical))continue}else if(!D.filter(new n.EvaluationParameters(this.tileID.overscaledZ),le))continue;const ne=l.getId(le,b),ae=new n.GeoJSONFeature(le,L,R,V,ne);ae.tile=X,t.push(ae)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const s=this.expirationTime;if(t.cacheControl){const l=n.parseCacheControl(t.cacheControl);l["max-age"]&&(this.expirationTime=Date.now()+1e3*l["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const l=Date.now();let m=!1;if(this.expirationTime>l)m=!1;else if(s)if(this.expirationTime<s)m=!0;else{const b=this.expirationTime-s;b?this.expirationTime=l+Math.max(b,3e4):m=!0}else m=!0;m?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(t,s){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(t).length===0)return;const l=this.latestFeatureIndex.loadVTLayers();for(const m in this.buckets){if(!s.style.hasLayer(m))continue;const b=this.buckets[m],E=b.layers[0].sourceLayer||"_geojsonTileLayer",D=l[E],L=t[E];if(!D||!L||Object.keys(L).length===0)continue;b.update(L,D,this.imageAtlas&&this.imageAtlas.patternPositions||{});const R=s&&s.style&&s.style.getLayer(m);R&&(this.queryPadding=Math.max(this.queryPadding,R.queryRadius(b)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<n.exported.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=n.exported.now()+t}setDependencies(t,s){const l={};for(const m of s)l[m]=!0;this.dependencies[t]=l}hasDependency(t,s){for(const l of t){const m=this.dependencies[l];if(m){for(const b of s)if(m[b])return!0}}return!1}}class be{constructor(t,s){this.max=t,this.onRemove=s,this.reset()}reset(){for(const t in this.data)for(const s of this.data[t])s.timeout&&clearTimeout(s.timeout),this.onRemove(s.value);return this.data={},this.order=[],this}add(t,s,l){const m=t.wrapped().key;this.data[m]===void 0&&(this.data[m]=[]);const b={value:s,timeout:void 0};if(l!==void 0&&(b.timeout=setTimeout(()=>{this.remove(t,b)},l)),this.data[m].push(b),this.order.push(m),this.order.length>this.max){const E=this._getAndRemoveByKey(this.order[0]);E&&this.onRemove(E)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const s=this.data[t].shift();return s.timeout&&clearTimeout(s.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),s.value}getByKey(t){const s=this.data[t];return s?s[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,s){if(!this.has(t))return this;const l=t.wrapped().key,m=s===void 0?0:this.data[l].indexOf(s),b=this.data[l][m];return this.data[l].splice(m,1),b.timeout&&clearTimeout(b.timeout),this.data[l].length===0&&delete this.data[l],this.onRemove(b.value),this.order.splice(this.order.indexOf(l),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const s=this._getAndRemoveByKey(this.order[0]);s&&this.onRemove(s)}return this}filter(t){const s=[];for(const l in this.data)for(const m of this.data[l])t(m.value)||s.push(m);for(const l of s)this.remove(l.value.tileID,l)}}class De{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,s,l){const m=String(s);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][m]=this.stateChanges[t][m]||{},n.extend(this.stateChanges[t][m],l),this.deletedStates[t]===null){this.deletedStates[t]={};for(const b in this.state[t])b!==m&&(this.deletedStates[t][b]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][m]===null){this.deletedStates[t][m]={};for(const b in this.state[t][m])l[b]||(this.deletedStates[t][m][b]=null)}else for(const b in l)this.deletedStates[t]&&this.deletedStates[t][m]&&this.deletedStates[t][m][b]===null&&delete this.deletedStates[t][m][b]}removeFeatureState(t,s,l){if(this.deletedStates[t]===null)return;const m=String(s);if(this.deletedStates[t]=this.deletedStates[t]||{},l&&s!==void 0)this.deletedStates[t][m]!==null&&(this.deletedStates[t][m]=this.deletedStates[t][m]||{},this.deletedStates[t][m][l]=null);else if(s!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][m])for(l in this.deletedStates[t][m]={},this.stateChanges[t][m])this.deletedStates[t][m][l]=null;else this.deletedStates[t][m]=null;else this.deletedStates[t]=null}getState(t,s){const l=String(s),m=n.extend({},(this.state[t]||{})[l],(this.stateChanges[t]||{})[l]);if(this.deletedStates[t]===null)return{};if(this.deletedStates[t]){const b=this.deletedStates[t][s];if(b===null)return{};for(const E in b)delete m[E]}return m}initializeTileState(t,s){t.setFeatureState(this.state,s)}coalesceChanges(t,s){const l={};for(const m in this.stateChanges){this.state[m]=this.state[m]||{};const b={};for(const E in this.stateChanges[m])this.state[m][E]||(this.state[m][E]={}),n.extend(this.state[m][E],this.stateChanges[m][E]),b[E]=this.state[m][E];l[m]=b}for(const m in this.deletedStates){this.state[m]=this.state[m]||{};const b={};if(this.deletedStates[m]===null)for(const E in this.state[m])b[E]={},this.state[m][E]={};else for(const E in this.deletedStates[m]){if(this.deletedStates[m][E]===null)this.state[m][E]={};else for(const D of Object.keys(this.deletedStates[m][E]))delete this.state[m][E][D];b[E]=this.state[m][E]}l[m]=l[m]||{},n.extend(l[m],b)}if(this.stateChanges={},this.deletedStates={},Object.keys(l).length!==0)for(const m in t)t[m].setFeatureState(l,s)}}class Ie extends n.Evented{constructor(t,s,l){super(),this.id=t,this.dispatcher=l,this.on("data",m=>{m.dataType==="source"&&m.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&m.dataType==="source"&&m.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform,this.terrain))}),this.on("dataloading",()=>{this._sourceErrored=!1}),this.on("error",()=>{this._sourceErrored=this._source.loaded()}),this._source=function(m,b,E,D){const L=new ie[b.type](m,b,E,D);if(L.id!==m)throw new Error(`Expected Source id to be ${m} instead of ${L.id}`);return n.bindAll(["load","abort","unload","serialize","prepare"],L),L}(t,s,l,this),this._tiles={},this._cache=new be(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new De}onAdd(t){this.map=t,this._maxTileCacheSize=t?t._maxTileCacheSize:null,this._source&&this._source.onAdd&&this._source.onAdd(t)}onRemove(t){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(t)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles){const s=this._tiles[t];if(s.state!=="loaded"&&s.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(t,s){return this._source.loadTile(t,s)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t,()=>{})}_abortTile(t){this._source.abortTile&&this._source.abortTile(t,()=>{}),this._source.fire(new n.Event("dataabort",{tile:t,coord:t.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const s in this._tiles){const l=this._tiles[s];l.upload(t),l.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(tt).map(t=>t.key)}getRenderableIds(t){const s=[];for(const l in this._tiles)this._isIdRenderable(l,t)&&s.push(this._tiles[l]);return t?s.sort((l,m)=>{const b=l.tileID,E=m.tileID,D=new n.pointGeometry(b.canonical.x,b.canonical.y)._rotate(this.transform.angle),L=new n.pointGeometry(E.canonical.x,E.canonical.y)._rotate(this.transform.angle);return b.overscaledZ-E.overscaledZ||L.y-D.y||L.x-D.x}).map(l=>l.tileID.key):s.map(l=>l.tileID).sort(tt).map(l=>l.key)}hasRenderableParent(t){const s=this.findLoadedParent(t,0);return!!s&&this._isIdRenderable(s.tileID.key)}_isIdRenderable(t,s){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(s||!this._tiles[t].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(t,"reloading")}}_reloadTile(t,s){const l=this._tiles[t];l&&(l.state!=="loading"&&(l.state=s),this._loadTile(l,this._tileLoaded.bind(this,l,t,s)))}_tileLoaded(t,s,l,m){if(m)return t.state="errored",void(m.status!==404?this._source.fire(new n.ErrorEvent(m,{tile:t})):this.update(this.transform,this.terrain));t.timeAdded=n.exported.now(),l==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(s,t),this.getSource().type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),t.aborted||this._source.fire(new n.Event("data",{dataType:"source",tile:t,coord:t.tileID}))}_backfillDEM(t){const s=this.getRenderableIds();for(let m=0;m<s.length;m++){const b=s[m];if(t.neighboringTiles&&t.neighboringTiles[b]){const E=this.getTileByID(b);l(t,E),l(E,t)}}function l(m,b){m.needsHillshadePrepare=!0,m.needsTerrainPrepare=!0;let E=b.tileID.canonical.x-m.tileID.canonical.x;const D=b.tileID.canonical.y-m.tileID.canonical.y,L=Math.pow(2,m.tileID.canonical.z),R=b.tileID.key;E===0&&D===0||Math.abs(D)>1||(Math.abs(E)>1&&(Math.abs(E+L)===1?E+=L:Math.abs(E-L)===1&&(E-=L)),b.dem&&m.dem&&(m.dem.backfillBorder(b.dem,E,D),m.neighboringTiles&&m.neighboringTiles[R]&&(m.neighboringTiles[R].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,s,l,m){for(const b in this._tiles){let E=this._tiles[b];if(m[b]||!E.hasData()||E.tileID.overscaledZ<=s||E.tileID.overscaledZ>l)continue;let D=E.tileID;for(;E&&E.tileID.overscaledZ>s+1;){const R=E.tileID.scaledTo(E.tileID.overscaledZ-1);E=this._tiles[R.key],E&&E.hasData()&&(D=R)}let L=D;for(;L.overscaledZ>s;)if(L=L.scaledTo(L.overscaledZ-1),t[L.key]){m[D.key]=D;break}}}findLoadedParent(t,s){if(t.key in this._loadedParentTiles){const l=this._loadedParentTiles[t.key];return l&&l.tileID.overscaledZ>=s?l:null}for(let l=t.overscaledZ-1;l>=s;l--){const m=t.scaledTo(l),b=this._getLoadedTile(m);if(b)return b}}_getLoadedTile(t){const s=this._tiles[t.key];return s&&s.hasData()?s:this._cache.getByKey(t.wrapped().key)}updateCacheSize(t){const s=Math.ceil(t.width/this._source.tileSize)+1,l=Math.ceil(t.height/this._source.tileSize)+1,m=Math.floor(s*l*5),b=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,m):m;this._cache.setMaxSize(b)}handleWrapJump(t){const s=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,s){const l={};for(const m in this._tiles){const b=this._tiles[m];b.tileID=b.tileID.unwrapTo(b.tileID.wrap+s),l[b.tileID.key]=b}this._tiles=l;for(const m in this._timers)clearTimeout(this._timers[m]),delete this._timers[m];for(const m in this._tiles)this._setTileReloadTimer(m,this._tiles[m])}}update(t,s){if(this.transform=t,this.terrain=s,!this._sourceLoaded||this._paused)return;let l;this.updateCacheSize(t),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?l=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(R=>new n.OverscaledTileID(R.canonical.z,R.wrap,R.canonical.z,R.canonical.x,R.canonical.y)):(l=t.coveringTiles({tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:s}),this._source.hasTile&&(l=l.filter(R=>this._source.hasTile(R)))):l=[];const m=t.coveringZoomLevel(this._source),b=Math.max(m-Ie.maxOverzooming,this._source.minzoom),E=Math.max(m+Ie.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const R={};for(const V of l)if(V.canonical.z>this._source.minzoom){const X=V.scaledTo(V.canonical.z-1);R[X.key]=X;const H=V.scaledTo(Math.max(this._source.minzoom,Math.min(V.canonical.z,5)));R[H.key]=H}l=l.concat(Object.values(R))}const D=this._updateRetainedTiles(l,m);if(ut(this._source.type)){const R={},V={},X=Object.keys(D);for(const H of X){const le=D[H],ne=this._tiles[H];if(!ne||ne.fadeEndTime&&ne.fadeEndTime<=n.exported.now())continue;const ae=this.findLoadedParent(le,b);ae&&(this._addTile(ae.tileID),R[ae.tileID.key]=ae.tileID),V[H]=le}this._retainLoadedChildren(V,m,E,D);for(const H in R)D[H]||(this._coveredTiles[H]=!0,D[H]=R[H]);if(s){const H={},le={};for(const ne of l)this._tiles[ne.key].hasData()?H[ne.key]=ne:le[ne.key]=ne;for(const ne in le){const ae=le[ne].children(this._source.maxzoom);this._tiles[ae[0].key]&&this._tiles[ae[1].key]&&this._tiles[ae[2].key]&&this._tiles[ae[3].key]&&(H[ae[0].key]=D[ae[0].key]=ae[0],H[ae[1].key]=D[ae[1].key]=ae[1],H[ae[2].key]=D[ae[2].key]=ae[2],H[ae[3].key]=D[ae[3].key]=ae[3],delete le[ne])}for(const ne in le){const ae=this.findLoadedParent(le[ne],this._source.minzoom);if(ae){H[ae.tileID.key]=D[ae.tileID.key]=ae.tileID;for(const xe in H)H[xe].isChildOf(ae.tileID)&&delete H[xe]}}for(const ne in this._tiles)H[ne]||(this._coveredTiles[ne]=!0)}}for(const R in D)this._tiles[R].clearFadeHold();const L=n.keysDifference(this._tiles,D);for(const R of L){const V=this._tiles[R];V.hasSymbolBuckets&&!V.holdingForFade()?V.setHoldDuration(this.map._fadeDuration):V.hasSymbolBuckets&&!V.symbolFadeFinished()||this._removeTile(R)}this._updateLoadedParentTileCache()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(t)}_updateRetainedTiles(t,s){const l={},m={},b=Math.max(s-Ie.maxOverzooming,this._source.minzoom),E=Math.max(s+Ie.maxUnderzooming,this._source.minzoom),D={};for(const L of t){const R=this._addTile(L);l[L.key]=L,R.hasData()||s<this._source.maxzoom&&(D[L.key]=L)}this._retainLoadedChildren(D,s,E,l);for(const L of t){let R=this._tiles[L.key];if(R.hasData())continue;if(s+1>this._source.maxzoom){const X=L.children(this._source.maxzoom)[0],H=this.getTile(X);if(H&&H.hasData()){l[X.key]=X;continue}}else{const X=L.children(this._source.maxzoom);if(l[X[0].key]&&l[X[1].key]&&l[X[2].key]&&l[X[3].key])continue}let V=R.wasRequested();for(let X=L.overscaledZ-1;X>=b;--X){const H=L.scaledTo(X);if(m[H.key]||(m[H.key]=!0,R=this.getTile(H),!R&&V&&(R=this._addTile(H)),R&&(l[H.key]=H,V=R.wasRequested(),R.hasData())))break}}return l}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const s=[];let l,m=this._tiles[t].tileID;for(;m.overscaledZ>0;){if(m.key in this._loadedParentTiles){l=this._loadedParentTiles[m.key];break}s.push(m.key);const b=m.scaledTo(m.overscaledZ-1);if(l=this._getLoadedTile(b),l)break;m=b}for(const b of s)this._loadedParentTiles[b]=l}}_addTile(t){let s=this._tiles[t.key];if(s)return s;s=this._cache.getAndRemove(t),s&&(this._setTileReloadTimer(t.key,s),s.tileID=t,this._state.initializeTileState(s,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,s)));const l=s;return s||(s=new ce(t,this._source.tileSize*t.overscaleFactor()),this._loadTile(s,this._tileLoaded.bind(this,s,t.key,s.state))),s.uses++,this._tiles[t.key]=s,l||this._source.fire(new n.Event("dataloading",{tile:s,coord:s.tileID,dataType:"source"})),s}_setTileReloadTimer(t,s){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const l=s.getExpiryTimeout();l&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},l))}_removeTile(t){const s=this._tiles[t];s&&(s.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),s.uses>0||(s.hasData()&&s.state!=="reloading"?this._cache.add(s.tileID,s,s.getExpiryTimeout()):(s.aborted=!0,this._abortTile(s),this._unloadTile(s))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(t);this._cache.reset()}tilesIn(t,s,l){const m=[],b=this.transform;if(!b)return m;const E=l?b.getCameraQueryGeometry(t):t,D=t.map(ne=>b.pointCoordinate(ne,this.terrain)),L=E.map(ne=>b.pointCoordinate(ne,this.terrain)),R=this.getIds();let V=1/0,X=1/0,H=-1/0,le=-1/0;for(const ne of L)V=Math.min(V,ne.x),X=Math.min(X,ne.y),H=Math.max(H,ne.x),le=Math.max(le,ne.y);for(let ne=0;ne<R.length;ne++){const ae=this._tiles[R[ne]];if(ae.holdingForFade())continue;const xe=ae.tileID,Ee=Math.pow(2,b.zoom-ae.tileID.overscaledZ),Oe=s*ae.queryPadding*n.EXTENT/ae.tileSize/Ee,he=[xe.getTilePoint(new n.MercatorCoordinate(V,X)),xe.getTilePoint(new n.MercatorCoordinate(H,le))];if(he[0].x-Oe<n.EXTENT&&he[0].y-Oe<n.EXTENT&&he[1].x+Oe>=0&&he[1].y+Oe>=0){const Ge=D.map(et=>xe.getTilePoint(et)),Fe=L.map(et=>xe.getTilePoint(et));m.push({tile:ae,tileID:xe,queryGeometry:Ge,cameraQueryGeometry:Fe,scale:Ee})}}return m}getVisibleCoordinates(t){const s=this.getRenderableIds(t).map(l=>this._tiles[l].tileID);for(const l of s)l.posMatrix=this.transform.calculatePosMatrix(l.toUnwrapped());return s}hasTransition(){if(this._source.hasTransition())return!0;if(ut(this._source.type))for(const t in this._tiles){const s=this._tiles[t];if(s.fadeEndTime!==void 0&&s.fadeEndTime>=n.exported.now())return!0}return!1}setFeatureState(t,s,l){this._state.updateState(t=t||"_geojsonTileLayer",s,l)}removeFeatureState(t,s,l){this._state.removeFeatureState(t=t||"_geojsonTileLayer",s,l)}getFeatureState(t,s){return this._state.getState(t=t||"_geojsonTileLayer",s)}setDependencies(t,s,l){const m=this._tiles[t];m&&m.setDependencies(s,l)}reloadTilesForDependencies(t,s){for(const l in this._tiles)this._tiles[l].hasDependency(t,s)&&this._reloadTile(l,"reloading");this._cache.filter(l=>!l.hasDependency(t,s))}}function tt(f,t){const s=Math.abs(2*f.wrap)-+(f.wrap<0),l=Math.abs(2*t.wrap)-+(t.wrap<0);return f.overscaledZ-t.overscaledZ||l-s||t.canonical.y-f.canonical.y||t.canonical.x-f.canonical.x}function ut(f){return f==="raster"||f==="image"||f==="video"}Ie.maxOverzooming=10,Ie.maxUnderzooming=3;const nt="mapboxgl_preloaded_worker_pool";class je{constructor(){this.active={}}acquire(t){if(!this.workers)for(this.workers=[];this.workers.length<je.workerCount;)this.workers.push(new Worker(to.workerUrl));return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],this.numActive()===0&&(this.workers.forEach(s=>{s.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[nt]}numActive(){return Object.keys(this.active).length}}const Ce=Math.floor(n.exported.hardwareConcurrency/2);let Ve;function Je(){return Ve||(Ve=new je),Ve}function $e(f,t){const s={};for(const l in f)l!=="ref"&&(s[l]=f[l]);return n.refProperties.forEach(l=>{l in t&&(s[l]=t[l])}),s}function lt(f){f=f.slice();const t=Object.create(null);for(let s=0;s<f.length;s++)t[f[s].id]=f[s];for(let s=0;s<f.length;s++)"ref"in f[s]&&(f[s]=$e(f[s],t[f[s].ref]));return f}je.workerCount=Math.max(Math.min(Ce,6),1);const ot={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight"};function Gt(f,t,s){s.push({command:ot.addSource,args:[f,t[f]]})}function Xt(f,t,s){t.push({command:ot.removeSource,args:[f]}),s[f]=!0}function He(f,t,s,l){Xt(f,s,l),Gt(f,t,s)}function jt(f,t,s){let l;for(l in f[s])if(Object.prototype.hasOwnProperty.call(f[s],l)&&l!=="data"&&!h(f[s][l],t[s][l]))return!1;for(l in t[s])if(Object.prototype.hasOwnProperty.call(t[s],l)&&l!=="data"&&!h(f[s][l],t[s][l]))return!1;return!0}function qt(f,t,s,l,m,b){let E;for(E in t=t||{},f=f||{})Object.prototype.hasOwnProperty.call(f,E)&&(h(f[E],t[E])||s.push({command:b,args:[l,E,t[E],m]}));for(E in t)Object.prototype.hasOwnProperty.call(t,E)&&!Object.prototype.hasOwnProperty.call(f,E)&&(h(f[E],t[E])||s.push({command:b,args:[l,E,t[E],m]}))}function mi(f){return f.id}function Di(f,t){return f[t.id]=t,f}class wi{constructor(t,s){this.reset(t,s)}reset(t,s){this.points=t||[],this._distances=[0];for(let l=1;l<this.points.length;l++)this._distances[l]=this._distances[l-1]+this.points[l].dist(this.points[l-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(s||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=n.clamp(t,0,1);let s=1,l=this._distances[s];const m=t*this.paddedLength+this.padding;for(;l<m&&s<this._distances.length;)l=this._distances[++s];const b=s-1,E=this._distances[b],D=l-E,L=D>0?(m-E)/D:0;return this.points[b].mult(1-L).add(this.points[s].mult(L))}}function Ue(f,t){let s=!0;return f==="always"||f!=="never"&&t!=="never"||(s=!1),s}class yt{constructor(t,s,l){const m=this.boxCells=[],b=this.circleCells=[];this.xCellCount=Math.ceil(t/l),this.yCellCount=Math.ceil(s/l);for(let E=0;E<this.xCellCount*this.yCellCount;E++)m.push([]),b.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=s,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/s,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,s,l,m,b){this._forEachCell(s,l,m,b,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(s),this.bboxes.push(l),this.bboxes.push(m),this.bboxes.push(b)}insertCircle(t,s,l,m){this._forEachCell(s-m,l-m,s+m,l+m,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(s),this.circles.push(l),this.circles.push(m)}_insertBoxCell(t,s,l,m,b,E){this.boxCells[b].push(E)}_insertCircleCell(t,s,l,m,b,E){this.circleCells[b].push(E)}_query(t,s,l,m,b,E,D){if(l<0||t>this.width||m<0||s>this.height)return[];const L=[];if(t<=0&&s<=0&&this.width<=l&&this.height<=m){if(b)return[{key:null,x1:t,y1:s,x2:l,y2:m}];for(let R=0;R<this.boxKeys.length;R++)L.push({key:this.boxKeys[R],x1:this.bboxes[4*R],y1:this.bboxes[4*R+1],x2:this.bboxes[4*R+2],y2:this.bboxes[4*R+3]});for(let R=0;R<this.circleKeys.length;R++){const V=this.circles[3*R],X=this.circles[3*R+1],H=this.circles[3*R+2];L.push({key:this.circleKeys[R],x1:V-H,y1:X-H,x2:V+H,y2:X+H})}}else this._forEachCell(t,s,l,m,this._queryCell,L,{hitTest:b,overlapMode:E,seenUids:{box:{},circle:{}}},D);return L}query(t,s,l,m){return this._query(t,s,l,m,!1,null)}hitTest(t,s,l,m,b,E){return this._query(t,s,l,m,!0,b,E).length>0}hitTestCircle(t,s,l,m,b){const E=t-l,D=t+l,L=s-l,R=s+l;if(D<0||E>this.width||R<0||L>this.height)return!1;const V=[];return this._forEachCell(E,L,D,R,this._queryCellCircle,V,{hitTest:!0,overlapMode:m,circle:{x:t,y:s,radius:l},seenUids:{box:{},circle:{}}},b),V.length>0}_queryCell(t,s,l,m,b,E,D,L){const{seenUids:R,hitTest:V,overlapMode:X}=D,H=this.boxCells[b];if(H!==null){const ne=this.bboxes;for(const ae of H)if(!R.box[ae]){R.box[ae]=!0;const xe=4*ae,Ee=this.boxKeys[ae];if(t<=ne[xe+2]&&s<=ne[xe+3]&&l>=ne[xe+0]&&m>=ne[xe+1]&&(!L||L(Ee))&&(!V||!Ue(X,Ee.overlapMode))&&(E.push({key:Ee,x1:ne[xe],y1:ne[xe+1],x2:ne[xe+2],y2:ne[xe+3]}),V))return!0}}const le=this.circleCells[b];if(le!==null){const ne=this.circles;for(const ae of le)if(!R.circle[ae]){R.circle[ae]=!0;const xe=3*ae,Ee=this.circleKeys[ae];if(this._circleAndRectCollide(ne[xe],ne[xe+1],ne[xe+2],t,s,l,m)&&(!L||L(Ee))&&(!V||!Ue(X,Ee.overlapMode))){const Oe=ne[xe],he=ne[xe+1],Ge=ne[xe+2];if(E.push({key:Ee,x1:Oe-Ge,y1:he-Ge,x2:Oe+Ge,y2:he+Ge}),V)return!0}}}return!1}_queryCellCircle(t,s,l,m,b,E,D,L){const{circle:R,seenUids:V,overlapMode:X}=D,H=this.boxCells[b];if(H!==null){const ne=this.bboxes;for(const ae of H)if(!V.box[ae]){V.box[ae]=!0;const xe=4*ae,Ee=this.boxKeys[ae];if(this._circleAndRectCollide(R.x,R.y,R.radius,ne[xe+0],ne[xe+1],ne[xe+2],ne[xe+3])&&(!L||L(Ee))&&!Ue(X,Ee.overlapMode))return E.push(!0),!0}}const le=this.circleCells[b];if(le!==null){const ne=this.circles;for(const ae of le)if(!V.circle[ae]){V.circle[ae]=!0;const xe=3*ae,Ee=this.circleKeys[ae];if(this._circlesCollide(ne[xe],ne[xe+1],ne[xe+2],R.x,R.y,R.radius)&&(!L||L(Ee))&&!Ue(X,Ee.overlapMode))return E.push(!0),!0}}}_forEachCell(t,s,l,m,b,E,D,L){const R=this._convertToXCellCoord(t),V=this._convertToYCellCoord(s),X=this._convertToXCellCoord(l),H=this._convertToYCellCoord(m);for(let le=R;le<=X;le++)for(let ne=V;ne<=H;ne++)if(b.call(this,t,s,l,m,this.xCellCount*ne+le,E,D,L))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,s,l,m,b,E){const D=m-t,L=b-s,R=l+E;return R*R>D*D+L*L}_circleAndRectCollide(t,s,l,m,b,E,D){const L=(E-m)/2,R=Math.abs(t-(m+L));if(R>L+l)return!1;const V=(D-b)/2,X=Math.abs(s-(b+V));if(X>V+l)return!1;if(R<=L||X<=V)return!0;const H=R-L,le=X-V;return H*H+le*le<=l*l}}function Ri(f,t,s,l,m){const b=n.create();return t?(n.scale(b,b,[1/m,1/m,1]),s||n.rotateZ(b,b,l.angle)):n.multiply(b,l.labelPlaneMatrix,f),b}function Zi(f,t,s,l,m){if(t){const b=n.clone(f);return n.scale(b,b,[m,m,1]),s||n.rotateZ(b,b,-l.angle),b}return l.glCoordMatrix}function ri(f,t,s){let l;s?(l=[f.x,f.y,s(f.x,f.y),1],n.transformMat4(l,l,t)):(l=[f.x,f.y,0,1],Oi(l,l,t));const m=l[3];return{point:new n.pointGeometry(l[0]/m,l[1]/m),signedDistanceFromCamera:m}}function Ei(f,t){return .5+f/t*.5}function dr(f,t){const s=f[0]/f[3],l=f[1]/f[3];return s>=-t[0]&&s<=t[0]&&l>=-t[1]&&l<=t[1]}function fr(f,t,s,l,m,b,E,D,L,R){const V=l?f.textSizeData:f.iconSizeData,X=n.evaluateSizeForZoom(V,s.transform.zoom),H=[256/s.width*2+1,256/s.height*2+1],le=l?f.text.dynamicLayoutVertexArray:f.icon.dynamicLayoutVertexArray;le.clear();const ne=f.lineVertexArray,ae=l?f.text.placedSymbolArray:f.icon.placedSymbolArray,xe=s.transform.width/s.transform.height;let Ee=!1;for(let Oe=0;Oe<ae.length;Oe++){const he=ae.get(Oe);if(he.hidden||he.writingMode===n.WritingMode.vertical&&!Ee){yi(he.numGlyphs,le);continue}let Ge;if(Ee=!1,R?(Ge=[he.anchorX,he.anchorY,R(he.anchorX,he.anchorY),1],n.transformMat4(Ge,Ge,t)):(Ge=[he.anchorX,he.anchorY,0,1],Oi(Ge,Ge,t)),!dr(Ge,H)){yi(he.numGlyphs,le);continue}const Fe=Ei(s.transform.cameraToCenterDistance,Ge[3]),et=n.evaluateSizeForFeature(V,X,he),it=E?et/Fe:et*Fe,bt=new n.pointGeometry(he.anchorX,he.anchorY),Ze=ri(bt,m,R).point,Vt={},Dt=bi(he,it,!1,D,t,m,b,f.glyphOffsetArray,ne,le,Ze,bt,Vt,xe,L,R);Ee=Dt.useVertical,(Dt.notEnoughRoom||Ee||Dt.needsFlipping&&bi(he,it,!0,D,t,m,b,f.glyphOffsetArray,ne,le,Ze,bt,Vt,xe,L,R).notEnoughRoom)&&yi(he.numGlyphs,le)}l?f.text.dynamicLayoutVertexBuffer.updateData(le):f.icon.dynamicLayoutVertexBuffer.updateData(le)}function Ki(f,t,s,l,m,b,E,D,L,R,V,X,H){const le=D.glyphStartIndex+D.numGlyphs,ne=D.lineStartIndex,ae=D.lineStartIndex+D.lineLength,xe=t.getoffsetX(D.glyphStartIndex),Ee=t.getoffsetX(le-1),Oe=br(f*xe,s,l,m,b,E,D.segment,ne,ae,L,R,V,X,H);if(!Oe)return null;const he=br(f*Ee,s,l,m,b,E,D.segment,ne,ae,L,R,V,X,H);return he?{first:Oe,last:he}:null}function st(f,t,s,l){return f===n.WritingMode.horizontal&&Math.abs(s.y-t.y)>Math.abs(s.x-t.x)*l?{useVertical:!0}:(f===n.WritingMode.vertical?t.y<s.y:t.x>s.x)?{needsFlipping:!0}:null}function bi(f,t,s,l,m,b,E,D,L,R,V,X,H,le,ne,ae){const xe=t/24,Ee=f.lineOffsetX*xe,Oe=f.lineOffsetY*xe;let he;if(f.numGlyphs>1){const Ge=f.glyphStartIndex+f.numGlyphs,Fe=f.lineStartIndex,et=f.lineStartIndex+f.lineLength,it=Ki(xe,D,Ee,Oe,s,V,X,f,L,b,H,ne,ae);if(!it)return{notEnoughRoom:!0};const bt=ri(it.first.point,E,ae).point,Ze=ri(it.last.point,E,ae).point;if(l&&!s){const Vt=st(f.writingMode,bt,Ze,le);if(Vt)return Vt}he=[it.first];for(let Vt=f.glyphStartIndex+1;Vt<Ge-1;Vt++)he.push(br(xe*D.getoffsetX(Vt),Ee,Oe,s,V,X,f.segment,Fe,et,L,b,H,ne,ae));he.push(it.last)}else{if(l&&!s){const Fe=ri(X,m,ae).point,et=f.lineStartIndex+f.segment+1,it=new n.pointGeometry(L.getx(et),L.gety(et)),bt=ri(it,m,ae),Ze=bt.signedDistanceFromCamera>0?bt.point:xi(X,it,Fe,1,m,ae),Vt=st(f.writingMode,Fe,Ze,le);if(Vt)return Vt}const Ge=br(xe*D.getoffsetX(f.glyphStartIndex),Ee,Oe,s,V,X,f.segment,f.lineStartIndex,f.lineStartIndex+f.lineLength,L,b,H,ne,ae);if(!Ge)return{notEnoughRoom:!0};he=[Ge]}for(const Ge of he)n.addDynamicAttributes(R,Ge.point,Ge.angle);return{}}function xi(f,t,s,l,m,b){const E=ri(f.add(f.sub(t)._unit()),m,b).point,D=s.sub(E);return s.add(D._mult(l/D.mag()))}function br(f,t,s,l,m,b,E,D,L,R,V,X,H,le){const ne=l?f-t:f+t;let ae=ne>0?1:-1,xe=0;l&&(ae*=-1,xe=Math.PI),ae<0&&(xe+=Math.PI);let Ee=ae>0?D+E:D+E+1,Oe=m,he=m,Ge=0,Fe=0;const et=Math.abs(ne),it=[];for(;Ge+Fe<=et;){if(Ee+=ae,Ee<D||Ee>=L)return null;if(he=Oe,it.push(Oe),Oe=X[Ee],Oe===void 0){const Wt=new n.pointGeometry(R.getx(Ee),R.gety(Ee)),Si=ri(Wt,V,le);if(Si.signedDistanceFromCamera>0)Oe=X[Ee]=Si.point;else{const Pi=Ee-ae;Oe=xi(Ge===0?b:new n.pointGeometry(R.getx(Pi),R.gety(Pi)),Wt,he,et-Ge+1,V,le)}}Ge+=Fe,Fe=he.dist(Oe)}const bt=(et-Ge)/Fe,Ze=Oe.sub(he),Vt=Ze.mult(bt)._add(he);Vt._add(Ze._unit()._perp()._mult(s*ae));const Dt=xe+Math.atan2(Oe.y-he.y,Oe.x-he.x);return it.push(Vt),{point:Vt,angle:H?Dt:0,path:it}}const tn=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function yi(f,t){for(let s=0;s<f;s++){const l=t.length;t.resize(l+4),t.float32.set(tn,3*l)}}function Oi(f,t,s){const l=t[0],m=t[1];return f[0]=s[0]*l+s[4]*m+s[12],f[1]=s[1]*l+s[5]*m+s[13],f[3]=s[3]*l+s[7]*m+s[15],f}const wr=100;class Vr{constructor(t,s=new yt(t.width+200,t.height+200,25),l=new yt(t.width+200,t.height+200,25)){this.transform=t,this.grid=s,this.ignoredGrid=l,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+wr,this.screenBottomBoundary=t.height+wr,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(t,s,l,m,b,E){const D=this.projectAndGetPerspectiveRatio(m,t.anchorPointX,t.anchorPointY,E),L=l*D.perspectiveRatio,R=t.x1*L+D.point.x,V=t.y1*L+D.point.y,X=t.x2*L+D.point.x,H=t.y2*L+D.point.y;return!this.isInsideGrid(R,V,X,H)||s!=="always"&&this.grid.hitTest(R,V,X,H,s,b)||D.perspectiveRatio<this.perspectiveRatioCutoff?{box:[],offscreen:!1}:{box:[R,V,X,H],offscreen:this.isOffscreen(R,V,X,H)}}placeCollisionCircles(t,s,l,m,b,E,D,L,R,V,X,H,le,ne){const ae=[],xe=new n.pointGeometry(s.anchorX,s.anchorY),Ee=ri(xe,E,ne),Oe=Ei(this.transform.cameraToCenterDistance,Ee.signedDistanceFromCamera),he=(V?b/Oe:b*Oe)/n.ONE_EM,Ge=ri(xe,D,ne).point,Fe=Ki(he,m,s.lineOffsetX*he,s.lineOffsetY*he,!1,Ge,xe,s,l,D,{},!1,ne);let et=!1,it=!1,bt=!0;if(Fe){const Ze=.5*H*Oe+le,Vt=new n.pointGeometry(-100,-100),Dt=new n.pointGeometry(this.screenRightBoundary,this.screenBottomBoundary),Wt=new wi,Si=Fe.first,Pi=Fe.last;let hi=[];for(let Ni=Si.path.length-1;Ni>=1;Ni--)hi.push(Si.path[Ni]);for(let Ni=1;Ni<Pi.path.length;Ni++)hi.push(Pi.path[Ni]);const er=2.5*Ze;if(L){const Ni=hi.map(Gi=>ri(Gi,L,ne));hi=Ni.some(Gi=>Gi.signedDistanceFromCamera<=0)?[]:Ni.map(Gi=>Gi.point)}let tr=[];if(hi.length>0){const Ni=hi[0].clone(),Gi=hi[0].clone();for(let ir=1;ir<hi.length;ir++)Ni.x=Math.min(Ni.x,hi[ir].x),Ni.y=Math.min(Ni.y,hi[ir].y),Gi.x=Math.max(Gi.x,hi[ir].x),Gi.y=Math.max(Gi.y,hi[ir].y);tr=Ni.x>=Vt.x&&Gi.x<=Dt.x&&Ni.y>=Vt.y&&Gi.y<=Dt.y?[hi]:Gi.x<Vt.x||Ni.x>Dt.x||Gi.y<Vt.y||Ni.y>Dt.y?[]:n.clipLine([hi],Vt.x,Vt.y,Dt.x,Dt.y)}for(const Ni of tr){Wt.reset(Ni,.25*Ze);let Gi=0;Gi=Wt.length<=.5*Ze?1:Math.ceil(Wt.paddedLength/er)+1;for(let ir=0;ir<Gi;ir++){const Wr=ir/Math.max(Gi-1,1),ms=Wt.lerp(Wr),ts=ms.x+wr,gs=ms.y+wr;ae.push(ts,gs,Ze,0);const Ns=ts-Ze,Nn=gs-Ze,wn=ts+Ze,Ss=gs+Ze;if(bt=bt&&this.isOffscreen(Ns,Nn,wn,Ss),it=it||this.isInsideGrid(Ns,Nn,wn,Ss),t!=="always"&&this.grid.hitTestCircle(ts,gs,Ze,t,X)&&(et=!0,!R))return{circles:[],offscreen:!1,collisionDetected:et}}}}return{circles:!R&&et||!it||Oe<this.perspectiveRatioCutoff?[]:ae,offscreen:bt,collisionDetected:et}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const s=[];let l=1/0,m=1/0,b=-1/0,E=-1/0;for(const V of t){const X=new n.pointGeometry(V.x+wr,V.y+wr);l=Math.min(l,X.x),m=Math.min(m,X.y),b=Math.max(b,X.x),E=Math.max(E,X.y),s.push(X)}const D=this.grid.query(l,m,b,E).concat(this.ignoredGrid.query(l,m,b,E)),L={},R={};for(const V of D){const X=V.key;if(L[X.bucketInstanceId]===void 0&&(L[X.bucketInstanceId]={}),L[X.bucketInstanceId][X.featureIndex])continue;const H=[new n.pointGeometry(V.x1,V.y1),new n.pointGeometry(V.x2,V.y1),new n.pointGeometry(V.x2,V.y2),new n.pointGeometry(V.x1,V.y2)];n.polygonIntersectsPolygon(s,H)&&(L[X.bucketInstanceId][X.featureIndex]=!0,R[X.bucketInstanceId]===void 0&&(R[X.bucketInstanceId]=[]),R[X.bucketInstanceId].push(X.featureIndex))}return R}insertCollisionBox(t,s,l,m,b,E){(l?this.ignoredGrid:this.grid).insert({bucketInstanceId:m,featureIndex:b,collisionGroupID:E,overlapMode:s},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,s,l,m,b,E){const D=l?this.ignoredGrid:this.grid,L={bucketInstanceId:m,featureIndex:b,collisionGroupID:E,overlapMode:s};for(let R=0;R<t.length;R+=4)D.insertCircle(L,t[R],t[R+1],t[R+2])}projectAndGetPerspectiveRatio(t,s,l,m){let b;return m?(b=[s,l,m(s,l),1],n.transformMat4(b,b,t)):(b=[s,l,0,1],Oi(b,b,t)),{point:new n.pointGeometry((b[0]/b[3]+1)/2*this.transform.width+wr,(-b[1]/b[3]+1)/2*this.transform.height+wr),perspectiveRatio:.5+this.transform.cameraToCenterDistance/b[3]*.5}}isOffscreen(t,s,l,m){return l<wr||t>=this.screenRightBoundary||m<wr||s>this.screenBottomBoundary}isInsideGrid(t,s,l,m){return l>=0&&t<this.gridRightBoundary&&m>=0&&s<this.gridBottomBoundary}getViewportMatrix(){const t=n.identity([]);return n.translate(t,t,[-100,-100,0]),t}}function lr(f,t,s){return t*(n.EXTENT/(f.tileSize*Math.pow(2,s-f.tileID.overscaledZ)))}class Dr{constructor(t,s,l,m){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?s:-s))):m&&l?1:0,this.placed=l}isHidden(){return this.opacity===0&&!this.placed}}class Xi{constructor(t,s,l,m,b){this.text=new Dr(t?t.text:null,s,l,b),this.icon=new Dr(t?t.icon:null,s,m,b)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class as{constructor(t,s,l){this.text=t,this.icon=s,this.skipFade=l}}class Zr{constructor(){this.invProjMatrix=n.create(),this.viewportMatrix=n.create(),this.circles=[]}}class ls{constructor(t,s,l,m,b){this.bucketInstanceId=t,this.featureIndex=s,this.sourceLayerIndex=l,this.bucketIndex=m,this.tileID=b}}class Wn{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const s=++this.maxGroupID;this.collisionGroups[t]={ID:s,predicate:l=>l.collisionGroupID===s}}return this.collisionGroups[t]}}function $n(f,t,s,l,m){const{horizontalAlign:b,verticalAlign:E}=n.getAnchorAlignment(f),D=-(b-.5)*t,L=-(E-.5)*s,R=n.evaluateVariableOffset(f,l);return new n.pointGeometry(D+R[0]*m,L+R[1]*m)}function qn(f,t,s,l,m,b){const{x1:E,x2:D,y1:L,y2:R,anchorPointX:V,anchorPointY:X}=f,H=new n.pointGeometry(t,s);return l&&H._rotate(m?b:-b),{x1:E+H.x,y1:L+H.y,x2:D+H.x,y2:R+H.y,anchorPointX:V,anchorPointY:X}}class re{constructor(t,s,l,m,b){this.transform=t.clone(),this.terrain=s,this.collisionIndex=new Vr(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=l,this.retainedQueryData={},this.collisionGroups=new Wn(m),this.collisionCircleArrays={},this.prevPlacement=b,b&&(b.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,s,l,m){const b=l.getBucket(s),E=l.latestFeatureIndex;if(!b||!E||s.id!==b.layerIds[0])return;const D=l.collisionBoxArray,L=b.layers[0].layout,R=Math.pow(2,this.transform.zoom-l.tileID.overscaledZ),V=l.tileSize/n.EXTENT,X=this.transform.calculatePosMatrix(l.tileID.toUnwrapped()),H=L.get("text-pitch-alignment")==="map",le=L.get("text-rotation-alignment")==="map",ne=lr(l,1,this.transform.zoom),ae=Ri(X,H,le,this.transform,ne);let xe=null;if(H){const Oe=Zi(X,H,le,this.transform,ne);xe=n.multiply([],this.transform.labelPlaneMatrix,Oe)}this.retainedQueryData[b.bucketInstanceId]=new ls(b.bucketInstanceId,E,b.sourceLayerIndex,b.index,l.tileID);const Ee={bucket:b,layout:L,posMatrix:X,textLabelPlaneMatrix:ae,labelToScreenMatrix:xe,scale:R,textPixelRatio:V,holdingForFade:l.holdingForFade(),collisionBoxArray:D,partiallyEvaluatedTextSize:n.evaluateSizeForZoom(b.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(b.sourceID)};if(m)for(const Oe of b.sortKeyRanges){const{sortKey:he,symbolInstanceStart:Ge,symbolInstanceEnd:Fe}=Oe;t.push({sortKey:he,symbolInstanceStart:Ge,symbolInstanceEnd:Fe,parameters:Ee})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:b.symbolInstances.length,parameters:Ee})}attemptAnchorPlacement(t,s,l,m,b,E,D,L,R,V,X,H,le,ne,ae,xe){const Ee=[H.textOffset0,H.textOffset1],Oe=$n(t,l,m,Ee,b),he=this.collisionIndex.placeCollisionBox(qn(s,Oe.x,Oe.y,E,D,this.transform.angle),X,L,R,V.predicate,xe);if((!ae||this.collisionIndex.placeCollisionBox(qn(ae,Oe.x,Oe.y,E,D,this.transform.angle),X,L,R,V.predicate,xe).box.length!==0)&&he.box.length>0){let Ge;if(this.prevPlacement&&this.prevPlacement.variableOffsets[H.crossTileID]&&this.prevPlacement.placements[H.crossTileID]&&this.prevPlacement.placements[H.crossTileID].text&&(Ge=this.prevPlacement.variableOffsets[H.crossTileID].anchor),H.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[H.crossTileID]={textOffset:Ee,width:l,height:m,anchor:t,textBoxScale:b,prevAnchor:Ge},this.markUsedJustification(le,t,H,ne),le.allowVerticalPlacement&&(this.markUsedOrientation(le,ne,H),this.placedOrientations[H.crossTileID]=ne),{shift:Oe,placedGlyphBoxes:he}}}placeLayerBucketPart(t,s,l){const{bucket:m,layout:b,posMatrix:E,textLabelPlaneMatrix:D,labelToScreenMatrix:L,textPixelRatio:R,holdingForFade:V,collisionBoxArray:X,partiallyEvaluatedTextSize:H,collisionGroup:le}=t.parameters,ne=b.get("text-optional"),ae=b.get("icon-optional"),xe=n.getOverlapMode(b,"text-overlap","text-allow-overlap"),Ee=xe==="always",Oe=n.getOverlapMode(b,"icon-overlap","icon-allow-overlap"),he=Oe==="always",Ge=b.get("text-rotation-alignment")==="map",Fe=b.get("text-pitch-alignment")==="map",et=b.get("icon-text-fit")!=="none",it=b.get("symbol-z-order")==="viewport-y",bt=Ee&&(he||!m.hasIconData()||ae),Ze=he&&(Ee||!m.hasTextData()||ne);!m.collisionArrays&&X&&m.deserializeCollisionBoxes(X);const Vt=(Dt,Wt)=>{if(s[Dt.crossTileID])return;if(V)return void(this.placements[Dt.crossTileID]=new as(!1,!1,!1));let Si=!1,Pi=!1,hi=!0,er=null,tr={box:null,offscreen:null},Ni={box:null,offscreen:null},Gi=null,ir=null,Wr=null,ms=0,ts=0,gs=0;Wt.textFeatureIndex?ms=Wt.textFeatureIndex:Dt.useRuntimeCollisionCircles&&(ms=Dt.featureIndex),Wt.verticalTextFeatureIndex&&(ts=Wt.verticalTextFeatureIndex);const Ns=this.retainedQueryData[m.bucketInstanceId].tileID,Nn=this.terrain?(Rr,ki)=>this.terrain.getElevation(Ns,Rr,ki):null;for(const Rr of["textBox","verticalTextBox","iconBox","verticalIconBox"]){const ki=Wt[Rr];ki&&(ki.elevation=Nn?Nn(ki.anchorPointX,ki.anchorPointY):0)}const wn=Wt.textBox;if(wn){const Rr=Hi=>{let $r=n.WritingMode.horizontal;if(m.allowVerticalPlacement&&!Hi&&this.prevPlacement){const qr=this.prevPlacement.placedOrientations[Dt.crossTileID];qr&&(this.placedOrientations[Dt.crossTileID]=qr,$r=qr,this.markUsedOrientation(m,$r,Dt))}return $r},ki=(Hi,$r)=>{if(m.allowVerticalPlacement&&Dt.numVerticalGlyphVertices>0&&Wt.verticalTextBox){for(const qr of m.writingModes)if(qr===n.WritingMode.vertical?(tr=$r(),Ni=tr):tr=Hi(),tr&&tr.box&&tr.box.length)break}else tr=Hi()};if(b.get("text-variable-anchor")){let Hi=b.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Dt.crossTileID]){const vr=this.prevPlacement.variableOffsets[Dt.crossTileID];Hi.indexOf(vr.anchor)>0&&(Hi=Hi.filter(Gn=>Gn!==vr.anchor),Hi.unshift(vr.anchor))}const $r=(vr,Gn,io)=>{const ja=vr.x2-vr.x1,Po=vr.y2-vr.y1,_l=Dt.textBoxScale,Va=et&&Oe==="never"?Gn:null;let Gs={box:[],offscreen:!1};const ro=xe!=="never"?2*Hi.length:Hi.length;for(let no=0;no<ro;++no){const _a=this.attemptAnchorPlacement(Hi[no%Hi.length],vr,ja,Po,_l,Ge,Fe,R,E,le,no>=Hi.length?xe:"never",Dt,m,io,Va,Nn);if(_a&&(Gs=_a.placedGlyphBoxes,Gs&&Gs.box&&Gs.box.length)){Si=!0,er=_a.shift;break}}return Gs};ki(()=>$r(wn,Wt.iconBox,n.WritingMode.horizontal),()=>{const vr=Wt.verticalTextBox;return m.allowVerticalPlacement&&!(tr&&tr.box&&tr.box.length)&&Dt.numVerticalGlyphVertices>0&&vr?$r(vr,Wt.verticalIconBox,n.WritingMode.vertical):{box:null,offscreen:null}}),tr&&(Si=tr.box,hi=tr.offscreen);const qr=Rr(tr&&tr.box);if(!Si&&this.prevPlacement){const vr=this.prevPlacement.variableOffsets[Dt.crossTileID];vr&&(this.variableOffsets[Dt.crossTileID]=vr,this.markUsedJustification(m,vr.anchor,Dt,qr))}}else{const Hi=($r,qr)=>{const vr=this.collisionIndex.placeCollisionBox($r,xe,R,E,le.predicate,Nn);return vr&&vr.box&&vr.box.length&&(this.markUsedOrientation(m,qr,Dt),this.placedOrientations[Dt.crossTileID]=qr),vr};ki(()=>Hi(wn,n.WritingMode.horizontal),()=>{const $r=Wt.verticalTextBox;return m.allowVerticalPlacement&&Dt.numVerticalGlyphVertices>0&&$r?Hi($r,n.WritingMode.vertical):{box:null,offscreen:null}}),Rr(tr&&tr.box&&tr.box.length)}}if(Gi=tr,Si=Gi&&Gi.box&&Gi.box.length>0,hi=Gi&&Gi.offscreen,Dt.useRuntimeCollisionCircles){const Rr=m.text.placedSymbolArray.get(Dt.centerJustifiedTextSymbolIndex),ki=n.evaluateSizeForFeature(m.textSizeData,H,Rr),Hi=b.get("text-padding");ir=this.collisionIndex.placeCollisionCircles(xe,Rr,m.lineVertexArray,m.glyphOffsetArray,ki,E,D,L,l,Fe,le.predicate,Dt.collisionCircleDiameter,Hi,Nn),ir.circles.length&&ir.collisionDetected&&!l&&n.warnOnce("Collisions detected, but collision boxes are not shown"),Si=Ee||ir.circles.length>0&&!ir.collisionDetected,hi=hi&&ir.offscreen}if(Wt.iconFeatureIndex&&(gs=Wt.iconFeatureIndex),Wt.iconBox){const Rr=ki=>{const Hi=et&&er?qn(ki,er.x,er.y,Ge,Fe,this.transform.angle):ki;return this.collisionIndex.placeCollisionBox(Hi,Oe,R,E,le.predicate,Nn)};Ni&&Ni.box&&Ni.box.length&&Wt.verticalIconBox?(Wr=Rr(Wt.verticalIconBox),Pi=Wr.box.length>0):(Wr=Rr(Wt.iconBox),Pi=Wr.box.length>0),hi=hi&&Wr.offscreen}const Ss=ne||Dt.numHorizontalGlyphVertices===0&&Dt.numVerticalGlyphVertices===0,ga=ae||Dt.numIconVertices===0;if(Ss||ga?ga?Ss||(Pi=Pi&&Si):Si=Pi&&Si:Pi=Si=Pi&&Si,Si&&Gi&&Gi.box&&this.collisionIndex.insertCollisionBox(Gi.box,xe,b.get("text-ignore-placement"),m.bucketInstanceId,Ni&&Ni.box&&ts?ts:ms,le.ID),Pi&&Wr&&this.collisionIndex.insertCollisionBox(Wr.box,Oe,b.get("icon-ignore-placement"),m.bucketInstanceId,gs,le.ID),ir&&(Si&&this.collisionIndex.insertCollisionCircles(ir.circles,xe,b.get("text-ignore-placement"),m.bucketInstanceId,ms,le.ID),l)){const Rr=m.bucketInstanceId;let ki=this.collisionCircleArrays[Rr];ki===void 0&&(ki=this.collisionCircleArrays[Rr]=new Zr);for(let Hi=0;Hi<ir.circles.length;Hi+=4)ki.circles.push(ir.circles[Hi+0]),ki.circles.push(ir.circles[Hi+1]),ki.circles.push(ir.circles[Hi+2]),ki.circles.push(ir.collisionDetected?1:0)}if(Dt.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(m.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[Dt.crossTileID]=new as(Si||bt,Pi||Ze,hi||m.justReloaded),s[Dt.crossTileID]=!0};if(it){if(t.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const Dt=m.getSortedSymbolIndexes(this.transform.angle);for(let Wt=Dt.length-1;Wt>=0;--Wt){const Si=Dt[Wt];Vt(m.symbolInstances.get(Si),m.collisionArrays[Si])}}else for(let Dt=t.symbolInstanceStart;Dt<t.symbolInstanceEnd;Dt++)Vt(m.symbolInstances.get(Dt),m.collisionArrays[Dt]);if(l&&m.bucketInstanceId in this.collisionCircleArrays){const Dt=this.collisionCircleArrays[m.bucketInstanceId];n.invert(Dt.invProjMatrix,E),Dt.viewportMatrix=this.collisionIndex.getViewportMatrix()}m.justReloaded=!1}markUsedJustification(t,s,l,m){let b;b=m===n.WritingMode.vertical?l.verticalPlacedTextSymbolIndex:{left:l.leftJustifiedTextSymbolIndex,center:l.centerJustifiedTextSymbolIndex,right:l.rightJustifiedTextSymbolIndex}[n.getAnchorJustification(s)];const E=[l.leftJustifiedTextSymbolIndex,l.centerJustifiedTextSymbolIndex,l.rightJustifiedTextSymbolIndex,l.verticalPlacedTextSymbolIndex];for(const D of E)D>=0&&(t.text.placedSymbolArray.get(D).crossTileID=b>=0&&D!==b?0:l.crossTileID)}markUsedOrientation(t,s,l){const m=s===n.WritingMode.horizontal||s===n.WritingMode.horizontalOnly?s:0,b=s===n.WritingMode.vertical?s:0,E=[l.leftJustifiedTextSymbolIndex,l.centerJustifiedTextSymbolIndex,l.rightJustifiedTextSymbolIndex];for(const D of E)t.text.placedSymbolArray.get(D).placedOrientation=m;l.verticalPlacedTextSymbolIndex&&(t.text.placedSymbolArray.get(l.verticalPlacedTextSymbolIndex).placedOrientation=b)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const s=this.prevPlacement;let l=!1;this.prevZoomAdjustment=s?s.zoomAdjustment(this.transform.zoom):0;const m=s?s.symbolFadeChange(t):1,b=s?s.opacities:{},E=s?s.variableOffsets:{},D=s?s.placedOrientations:{};for(const L in this.placements){const R=this.placements[L],V=b[L];V?(this.opacities[L]=new Xi(V,m,R.text,R.icon),l=l||R.text!==V.text.placed||R.icon!==V.icon.placed):(this.opacities[L]=new Xi(null,m,R.text,R.icon,R.skipFade),l=l||R.text||R.icon)}for(const L in b){const R=b[L];if(!this.opacities[L]){const V=new Xi(R,m,!1,!1);V.isHidden()||(this.opacities[L]=V,l=l||R.text.placed||R.icon.placed)}}for(const L in E)this.variableOffsets[L]||!this.opacities[L]||this.opacities[L].isHidden()||(this.variableOffsets[L]=E[L]);for(const L in D)this.placedOrientations[L]||!this.opacities[L]||this.opacities[L].isHidden()||(this.placedOrientations[L]=D[L]);if(s&&s.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");l?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=s?s.lastPlacementChangeTime:t)}updateLayerOpacities(t,s){const l={};for(const m of s){const b=m.getBucket(t);b&&m.latestFeatureIndex&&t.id===b.layerIds[0]&&this.updateBucketOpacities(b,l,m.collisionBoxArray)}}updateBucketOpacities(t,s,l){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const m=t.layers[0].layout,b=new Xi(null,0,!1,!1,!0),E=m.get("text-allow-overlap"),D=m.get("icon-allow-overlap"),L=m.get("text-variable-anchor"),R=m.get("text-rotation-alignment")==="map",V=m.get("text-pitch-alignment")==="map",X=m.get("icon-text-fit")!=="none",H=new Xi(null,0,E&&(D||!t.hasIconData()||m.get("icon-optional")),D&&(E||!t.hasTextData()||m.get("text-optional")),!0);!t.collisionArrays&&l&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(l);const le=(ne,ae,xe)=>{for(let Ee=0;Ee<ae/4;Ee++)ne.opacityVertexArray.emplaceBack(xe)};for(let ne=0;ne<t.symbolInstances.length;ne++){const ae=t.symbolInstances.get(ne),{numHorizontalGlyphVertices:xe,numVerticalGlyphVertices:Ee,crossTileID:Oe}=ae;let he=this.opacities[Oe];s[Oe]?he=b:he||(he=H,this.opacities[Oe]=he),s[Oe]=!0;const Ge=ae.numIconVertices>0,Fe=this.placedOrientations[ae.crossTileID],et=Fe===n.WritingMode.vertical,it=Fe===n.WritingMode.horizontal||Fe===n.WritingMode.horizontalOnly;if(xe>0||Ee>0){const bt=Se(he.text);le(t.text,xe,et?Ye:bt),le(t.text,Ee,it?Ye:bt);const Ze=he.text.isHidden();[ae.rightJustifiedTextSymbolIndex,ae.centerJustifiedTextSymbolIndex,ae.leftJustifiedTextSymbolIndex].forEach(Wt=>{Wt>=0&&(t.text.placedSymbolArray.get(Wt).hidden=Ze||et?1:0)}),ae.verticalPlacedTextSymbolIndex>=0&&(t.text.placedSymbolArray.get(ae.verticalPlacedTextSymbolIndex).hidden=Ze||it?1:0);const Vt=this.variableOffsets[ae.crossTileID];Vt&&this.markUsedJustification(t,Vt.anchor,ae,Fe);const Dt=this.placedOrientations[ae.crossTileID];Dt&&(this.markUsedJustification(t,"left",ae,Dt),this.markUsedOrientation(t,Dt,ae))}if(Ge){const bt=Se(he.icon),Ze=!(X&&ae.verticalPlacedIconSymbolIndex&&et);ae.placedIconSymbolIndex>=0&&(le(t.icon,ae.numIconVertices,Ze?bt:Ye),t.icon.placedSymbolArray.get(ae.placedIconSymbolIndex).hidden=he.icon.isHidden()),ae.verticalPlacedIconSymbolIndex>=0&&(le(t.icon,ae.numVerticalIconVertices,Ze?Ye:bt),t.icon.placedSymbolArray.get(ae.verticalPlacedIconSymbolIndex).hidden=he.icon.isHidden())}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const bt=t.collisionArrays[ne];if(bt){let Ze=new n.pointGeometry(0,0);if(bt.textBox||bt.verticalTextBox){let Dt=!0;if(L){const Wt=this.variableOffsets[Oe];Wt?(Ze=$n(Wt.anchor,Wt.width,Wt.height,Wt.textOffset,Wt.textBoxScale),R&&Ze._rotate(V?this.transform.angle:-this.transform.angle)):Dt=!1}bt.textBox&&B(t.textCollisionBox.collisionVertexArray,he.text.placed,!Dt||et,Ze.x,Ze.y),bt.verticalTextBox&&B(t.textCollisionBox.collisionVertexArray,he.text.placed,!Dt||it,Ze.x,Ze.y)}const Vt=Boolean(!it&&bt.verticalIconBox);bt.iconBox&&B(t.iconCollisionBox.collisionVertexArray,he.icon.placed,Vt,X?Ze.x:0,X?Ze.y:0),bt.verticalIconBox&&B(t.iconCollisionBox.collisionVertexArray,he.icon.placed,!Vt,X?Ze.x:0,X?Ze.y:0)}}}if(t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.text.opacityVertexArray.length!==t.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${t.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${t.text.layoutVertexArray.length}) / 4`);if(t.icon.opacityVertexArray.length!==t.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${t.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${t.icon.layoutVertexArray.length}) / 4`);if(t.bucketInstanceId in this.collisionCircleArrays){const ne=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=ne.invProjMatrix,t.placementViewportMatrix=ne.viewportMatrix,t.collisionCircleArray=ne.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,s){const l=this.zoomAtLastRecencyCheck===s?1-this.zoomAdjustment(s):1;return this.zoomAtLastRecencyCheck=s,this.commitTime+this.fadeDuration*l>t}setStale(){this.stale=!0}}function B(f,t,s,l,m){f.emplaceBack(t?1:0,s?1:0,l||0,m||0),f.emplaceBack(t?1:0,s?1:0,l||0,m||0),f.emplaceBack(t?1:0,s?1:0,l||0,m||0),f.emplaceBack(t?1:0,s?1:0,l||0,m||0)}const G=Math.pow(2,25),ee=Math.pow(2,24),te=Math.pow(2,17),fe=Math.pow(2,16),we=Math.pow(2,9),_e=Math.pow(2,8),pe=Math.pow(2,1);function Se(f){if(f.opacity===0&&!f.placed)return 0;if(f.opacity===1&&f.placed)return 4294967295;const t=f.placed?1:0,s=Math.floor(127*f.opacity);return s*G+t*ee+s*te+t*fe+s*we+t*_e+s*pe+t}const Ye=0;class pt{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&!t.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(t,s,l,m,b){const E=this._bucketParts;for(;this._currentTileIndex<t.length;)if(s.getBucketParts(E,m,t[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,b())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,E.sort((D,L)=>D.sortKey-L.sortKey));this._currentPartIndex<E.length;)if(s.placeLayerBucketPart(E[this._currentPartIndex],this._seenCrossTileIDs,l),this._currentPartIndex++,b())return!0;return!1}}class qe{constructor(t,s,l,m,b,E,D,L){this.placement=new re(t,s,E,D,L),this._currentPlacementIndex=l.length-1,this._forceFullPlacement=m,this._showCollisionBoxes=b,this._done=!1}isDone(){return this._done}continuePlacement(t,s,l){const m=n.exported.now(),b=()=>{const E=n.exported.now()-m;return!this._forceFullPlacement&&E>2};for(;this._currentPlacementIndex>=0;){const E=s[t[this._currentPlacementIndex]],D=this.placement.collisionIndex.transform.zoom;if(E.type==="symbol"&&(!E.minzoom||E.minzoom<=D)&&(!E.maxzoom||E.maxzoom>D)){if(this._inProgressLayer||(this._inProgressLayer=new pt(E)),this._inProgressLayer.continuePlacement(l[E.source],this.placement,this._showCollisionBoxes,E,b))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const Ht=512/n.EXTENT/2;class Jt{constructor(t,s,l){this.tileID=t,this.indexedSymbolInstances={},this.bucketInstanceId=l;for(let m=0;m<s.length;m++){const b=s.get(m),E=b.key;this.indexedSymbolInstances[E]||(this.indexedSymbolInstances[E]=[]),this.indexedSymbolInstances[E].push({crossTileID:b.crossTileID,coord:this.getScaledCoordinates(b,t)})}}getScaledCoordinates(t,s){const l=Ht/Math.pow(2,s.canonical.z-this.tileID.canonical.z);return{x:Math.floor((s.canonical.x*n.EXTENT+t.anchorX)*l),y:Math.floor((s.canonical.y*n.EXTENT+t.anchorY)*l)}}findMatches(t,s,l){const m=this.tileID.canonical.z<s.canonical.z?1:Math.pow(2,this.tileID.canonical.z-s.canonical.z);for(let b=0;b<t.length;b++){const E=t.get(b);if(E.crossTileID)continue;const D=this.indexedSymbolInstances[E.key];if(!D)continue;const L=this.getScaledCoordinates(E,s);for(const R of D)if(Math.abs(R.coord.x-L.x)<=m&&Math.abs(R.coord.y-L.y)<=m&&!l[R.crossTileID]){l[R.crossTileID]=!0,E.crossTileID=R.crossTileID;break}}}}class Pt{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class di{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const s=Math.round((t-this.lng)/360);if(s!==0)for(const l in this.indexes){const m=this.indexes[l],b={};for(const E in m){const D=m[E];D.tileID=D.tileID.unwrapTo(D.tileID.wrap+s),b[D.tileID.key]=D}this.indexes[l]=b}this.lng=t}addBucket(t,s,l){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===s.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let b=0;b<s.symbolInstances.length;b++)s.symbolInstances.get(b).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]={});const m=this.usedCrossTileIDs[t.overscaledZ];for(const b in this.indexes){const E=this.indexes[b];if(Number(b)>t.overscaledZ)for(const D in E){const L=E[D];L.tileID.isChildOf(t)&&L.findMatches(s.symbolInstances,t,m)}else{const D=E[t.scaledTo(Number(b)).key];D&&D.findMatches(s.symbolInstances,t,m)}}for(let b=0;b<s.symbolInstances.length;b++){const E=s.symbolInstances.get(b);E.crossTileID||(E.crossTileID=l.generate(),m[E.crossTileID]=!0)}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new Jt(t,s.symbolInstances,s.bucketInstanceId),!0}removeBucketCrossTileIDs(t,s){for(const l in s.indexedSymbolInstances)for(const m of s.indexedSymbolInstances[l])delete this.usedCrossTileIDs[t][m.crossTileID]}removeStaleBuckets(t){let s=!1;for(const l in this.indexes){const m=this.indexes[l];for(const b in m)t[m[b].bucketInstanceId]||(this.removeBucketCrossTileIDs(l,m[b]),delete m[b],s=!0)}return s}}class gi{constructor(){this.layerIndexes={},this.crossTileIDs=new Pt,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,s,l){let m=this.layerIndexes[t.id];m===void 0&&(m=this.layerIndexes[t.id]=new di);let b=!1;const E={};m.handleWrapJump(l);for(const D of s){const L=D.getBucket(t);L&&t.id===L.layerIds[0]&&(L.bucketInstanceId||(L.bucketInstanceId=++this.maxBucketInstanceId),m.addBucket(D.tileID,L,this.crossTileIDs)&&(b=!0),E[L.bucketInstanceId]=!0)}return m.removeStaleBuckets(E)&&(b=!0),b}pruneUnusedLayers(t){const s={};t.forEach(l=>{s[l]=!0});for(const l in this.layerIndexes)s[l]||delete this.layerIndexes[l]}}var Li=n.createLayout([{name:"a_pos",type:"Int16",components:2}]);class vi extends n.Evented{constructor(t){super(),this.sourceCache=t,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.renderHistory=[],this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.deltaZoom=1,this.renderHistorySize=t._cache.max,t.usedForTerrain=!0,t.tileSize=this.tileSize*2**this.deltaZoom}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null;for(const t in this._tiles){const s=this._tiles[t];s.textures.forEach(l=>l.destroy()),s.textures=[]}}update(t,s){this.sourceCache.update(t,s),this._renderableTilesKeys=[];for(const l of t.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:s}))this._renderableTilesKeys.push(l.key),this._tiles[l.key]||(l.posMatrix=new Float64Array(16),n.ortho(l.posMatrix,0,n.EXTENT,0,n.EXTENT,0,1),this._tiles[l.key]=new ce(l,this.tileSize))}removeOutdated(t){const s={};this.renderHistory=this.renderHistory.filter((l,m)=>this.renderHistory.indexOf(l)===m).slice(0,this.renderHistorySize);for(const l of this._renderableTilesKeys)s[l]=!0;for(const l of this.renderHistory)s[l]=!0;for(const l in this._tiles)s[l]||(this._tiles[l].clearTextures(t),delete this._tiles[l])}getRenderableTiles(){return this._renderableTilesKeys.map(t=>this.getTileByID(t))}getTileByID(t){return this._tiles[t]}getTerrainCoords(t){const s={};for(const l of this._renderableTilesKeys){const m=this._tiles[l].tileID;if(m.canonical.equals(t.canonical)){const b=t.clone();b.posMatrix=new Float64Array(16),n.ortho(b.posMatrix,0,n.EXTENT,0,n.EXTENT,0,1),s[l]=b}else if(m.canonical.isChildOf(t.canonical)){const b=t.clone();b.posMatrix=new Float64Array(16);const E=m.canonical.z-t.canonical.z,D=m.canonical.x-(m.canonical.x>>E<<E),L=m.canonical.y-(m.canonical.y>>E<<E),R=n.EXTENT>>E;n.ortho(b.posMatrix,0,R,0,R,0,1),n.translate(b.posMatrix,b.posMatrix,[-D*R,-L*R,0]),s[l]=b}else if(t.canonical.isChildOf(m.canonical)){const b=t.clone();b.posMatrix=new Float64Array(16);const E=t.canonical.z-m.canonical.z,D=t.canonical.x-(t.canonical.x>>E<<E),L=t.canonical.y-(t.canonical.y>>E<<E),R=n.EXTENT>>E;n.ortho(b.posMatrix,0,n.EXTENT,0,n.EXTENT,0,1),n.translate(b.posMatrix,b.posMatrix,[D*R,L*R,0]),n.scale(b.posMatrix,b.posMatrix,[1/2**E,1/2**E,0]),s[l]=b}}return s}getSourceTile(t,s){const l=this.sourceCache._source;let m=t.overscaledZ-this.deltaZoom;if(m>l.maxzoom&&(m=l.maxzoom),m<l.minzoom)return null;this._sourceTileCache[t.key]||(this._sourceTileCache[t.key]=t.scaledTo(m).key);let b=this.sourceCache.getTileByID(this._sourceTileCache[t.key]);if((!b||!b.dem)&&s)for(;m>=l.minzoom&&(!b||!b.dem);)b=this.sourceCache.getTileByID(t.scaledTo(m--).key);return b}tilesAfterTime(t=Date.now()){return Object.values(this._tiles).filter(s=>s.timeLoaded>=t)}}class Ti{constructor(t,s,l){this.style=t,this.sourceCache=new vi(s),this.options=l,this.exaggeration=typeof l.exaggeration=="number"?l.exaggeration:1,this.elevationOffset=typeof l.elevationOffset=="number"?l.elevationOffset:450,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024,this.clearRerenderCache()}getDEMElevation(t,s,l,m=n.EXTENT){if(!(s>=0&&s<m&&l>=0&&l<m))return this.elevationOffset;let b=0;const E=this.getTerrainData(t);if(E.tile&&E.tile.dem){const D=n.transformMat4$1([],[s/m*n.EXTENT,l/m*n.EXTENT],E.u_terrain_matrix),L=[D[0]*E.tile.dem.dim,D[1]*E.tile.dem.dim],R=[Math.floor(L[0]),Math.floor(L[1])],V=E.tile.dem.get(R[0],R[1]),X=E.tile.dem.get(R[0],R[1]+1),H=E.tile.dem.get(R[0]+1,R[1]),le=E.tile.dem.get(R[0]+1,R[1]+1);b=n.number(n.number(V,X,L[0]-R[0]),n.number(H,le,L[0]-R[0]),L[1]-R[1])}return b}rememberForRerender(t,s){for(const l in this.sourceCache._tiles){const m=this.sourceCache._tiles[l];(m.tileID.equals(s)||m.tileID.isChildOf(s))&&(t===this.sourceCache.sourceCache.id&&(m.timeLoaded=Date.now()),this._rerender[t]=this._rerender[t]||{},this._rerender[t][m.tileID.key]=!0)}}needsRerender(t,s){return this._rerender[t]&&this._rerender[t][s.key]}clearRerenderCache(){this._rerender={}}getElevation(t,s,l,m=n.EXTENT){return(this.getDEMElevation(t,s,l,m)+this.elevationOffset)*this.exaggeration}getTerrainData(t){if(!this._emptyDemTexture){const m=this.style.map.painter.context,b=new n.RGBAImage({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new _(m,b,m.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new _(m,new n.RGBAImage({width:1,height:1}),m.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(m.gl.NEAREST,m.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=n.identity([])}const s=this.sourceCache.getSourceTile(t,!0);if(s&&s.dem&&(!s.demTexture||s.needsTerrainPrepare)){const m=this.style.map.painter.context;s.demTexture=this.style.map.painter.getTileTexture(s.dem.stride),s.demTexture?s.demTexture.update(s.dem.getPixels(),{premultiply:!1}):s.demTexture=new _(m,s.dem.getPixels(),m.gl.RGBA,{premultiply:!1}),s.demTexture.bind(m.gl.NEAREST,m.gl.CLAMP_TO_EDGE),s.needsTerrainPrepare=!1}const l=s&&s+s.tileID.key+t.key;if(l&&!this._demMatrixCache[l]){const m=this.sourceCache.sourceCache._source.maxzoom;let b=t.canonical.z-s.tileID.canonical.z;t.overscaledZ>t.canonical.z&&(t.canonical.z>=m?b=t.canonical.z-m:n.warnOnce("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const E=t.canonical.x-(t.canonical.x>>b<<b),D=t.canonical.y-(t.canonical.y>>b<<b),L=n.fromScaling(new Float64Array(16),[1/(n.EXTENT<<b),1/(n.EXTENT<<b),0]);n.translate(L,L,[E*n.EXTENT,D*n.EXTENT,0]),this._demMatrixCache[t.key]={matrix:L,coord:t}}return{u_depth:2,u_terrain:3,u_terrain_dim:s&&s.dem&&s.dem.dim||1,u_terrain_matrix:l?this._demMatrixCache[t.key].matrix:this._emptyDemMatrix,u_terrain_unpack:s&&s.dem&&s.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_offset:this.elevationOffset,u_terrain_exaggeration:this.exaggeration,texture:(s&&s.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:s}}getRTTFramebuffer(){const t=this.style.map.painter;if(!this._rttFramebuffer){const s=this.sourceCache.tileSize*this.qualityFactor;this._rttFramebuffer=t.context.createFramebuffer(s,s,!0),this._rttFramebuffer.depthAttachment.set(t.context.createRenderbuffer(t.context.gl.DEPTH_COMPONENT16,s,s))}return this._rttFramebuffer}getFramebuffer(t){const s=this.style.map.painter,l=s.width/devicePixelRatio,m=s.height/devicePixelRatio;return!this._fbo||this._fbo.width===l&&this._fbo.height===m||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new _(s.context,{width:l,height:m,data:null},s.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(s.context.gl.NEAREST,s.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new _(s.context,{width:l,height:m,data:null},s.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(s.context.gl.NEAREST,s.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=s.context.createFramebuffer(l,m,!0),this._fbo.depthAttachment.set(s.context.createRenderbuffer(s.context.gl.DEPTH_COMPONENT16,l,m))),this._fbo.colorAttachment.set(t==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const t=this.style.map.painter.context;if(this._coordsTexture)return this._coordsTexture;const s=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let b=0,E=0;b<this._coordsTextureSize;b++)for(let D=0;D<this._coordsTextureSize;D++,E+=4)s[E+0]=255&D,s[E+1]=255&b,s[E+2]=D>>8<<4|b>>8,s[E+3]=0;const l=new n.RGBAImage({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(s.buffer)),m=new _(t,l,t.gl.RGBA,{premultiply:!1});return m.bind(t.gl.NEAREST,t.gl.CLAMP_TO_EDGE),this._coordsTexture=m,m}pointCoordinate(t){const s=new Uint8Array(4),l=this.style.map.painter,m=l.context,b=m.gl;m.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),b.readPixels(t.x,l.height/devicePixelRatio-t.y-1,1,1,b.RGBA,b.UNSIGNED_BYTE,s),m.bindFramebuffer.set(null);const E=s[0]+(s[2]>>4<<8),D=s[1]+((15&s[2])<<8),L=this.coordsIndex[255-s[3]],R=L&&this.sourceCache.getTileByID(L);if(!R)return null;const V=this._coordsTextureSize,X=(1<<R.tileID.canonical.z)*V;return new n.MercatorCoordinate((R.tileID.canonical.x*V+E)/X,(R.tileID.canonical.y*V+D)/X,this.getElevation(R.tileID,E,D,V))}getTerrainMesh(){if(this._mesh)return this._mesh;const t=this.style.map.painter.context,s=new n.PosArray,l=new n.TriangleIndexArray,m=this.meshSize,b=n.EXTENT/m,E=m*m;for(let D=0;D<=m;D++)for(let L=0;L<=m;L++)s.emplaceBack(L*b,D*b);for(let D=0;D<E;D+=m+1)for(let L=0;L<m;L++)l.emplaceBack(L+D,m+L+D+1,m+L+D+2),l.emplaceBack(L+D,m+L+D+2,L+D+1);return this._mesh={indexBuffer:t.createIndexBuffer(l),vertexBuffer:t.createVertexBuffer(s,Li.members),segments:n.SegmentVector.simpleSegment(0,0,s.length,l.length)},this._mesh}getMinMaxElevation(t){const s=this.getTerrainData(t).tile,l={minElevation:null,maxElevation:null};return s&&s.dem&&(l.minElevation=(s.dem.min+this.elevationOffset)*this.exaggeration,l.maxElevation=(s.dem.max+this.elevationOffset)*this.exaggeration),l}}const Bi=(f,t)=>n.emitValidationErrors(f,t&&t.filter(s=>s.identifier!=="source.canvas")),Ci=n.pick(ot,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData"]),Ir=n.pick(ot,["setCenter","setZoom","setBearing","setPitch"]),cr=function(){const f={},t=n.spec.$version;for(const s in n.spec.$root){const l=n.spec.$root[s];if(l.required){let m=null;m=s==="version"?t:l.type==="array"?[]:{},m!=null&&(f[s]=m)}}return f}();class gr extends n.Evented{constructor(t,s={}){super(),this.map=t,this.dispatcher=new We(Je(),this),this.imageManager=new C,this.imageManager.setEventedParent(this),this.glyphManager=new U(t._requestManager,s.localIdeographFontFamily),this.lineAtlas=new ze(256,512),this.crossTileSymbolIndex=new gi,this._layers={},this._serializedLayers={},this._order=[],this.sourceCaches={},this.zoomHistory=new n.ZoomHistory,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("setReferrer",n.getReferrer());const l=this;this._rtlTextPluginCallback=gr.registerForPluginStateChange(m=>{l.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:m.pluginStatus,pluginURL:m.pluginURL},(b,E)=>{if(n.triggerPluginCompletionEvent(b),E&&E.every(D=>D))for(const D in l.sourceCaches)l.sourceCaches[D].reload()})}),this.on("data",m=>{if(m.dataType!=="source"||m.sourceDataType!=="metadata")return;const b=this.sourceCaches[m.sourceId];if(!b)return;const E=b.getSource();if(E&&E.vectorLayerIds)for(const D in this._layers){const L=this._layers[D];L.source===E.id&&this._validateLayer(L)}})}loadURL(t,s={}){this.fire(new n.Event("dataloading",{dataType:"style"}));const l=typeof s.validate!="boolean"||s.validate,m=this.map._requestManager.transformRequest(t,n.ResourceType.Style);this._request=n.getJSON(m,(b,E)=>{this._request=null,b?this.fire(new n.ErrorEvent(b)):E&&this._load(E,l)})}loadJSON(t,s={}){this.fire(new n.Event("dataloading",{dataType:"style"})),this._request=n.exported.frame(()=>{this._request=null,this._load(t,s.validate!==!1)})}loadEmpty(){this.fire(new n.Event("dataloading",{dataType:"style"})),this._load(cr,!1)}_load(t,s){if(s&&Bi(this,n.validateStyle(t)))return;this._loaded=!0,this.stylesheet=t;for(const m in t.sources)this.addSource(m,t.sources[m],{validate:!1});t.sprite?this._loadSprite(t.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(t.glyphs);const l=lt(this.stylesheet.layers);this._order=l.map(m=>m.id),this._layers={},this._serializedLayers={};for(let m of l)m=n.createStyleLayer(m),m.setEventedParent(this,{layer:{id:m.id}}),this._layers[m.id]=m,this._serializedLayers[m.id]=m.serialize();this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new ge(this.stylesheet.light),this.setTerrain(this.stylesheet.terrain),this.fire(new n.Event("data",{dataType:"style"})),this.fire(new n.Event("style.load"))}_loadSprite(t){this._spriteRequest=function(s,l,m,b){let E,D,L;const R=m>1?"@2x":"";let V=n.getJSON(l.transformRequest(l.normalizeSpriteURL(s,R,".json"),n.ResourceType.SpriteJSON),(le,ne)=>{V=null,L||(L=le,E=ne,H())}),X=n.getImage(l.transformRequest(l.normalizeSpriteURL(s,R,".png"),n.ResourceType.SpriteImage),(le,ne)=>{X=null,L||(L=le,D=ne,H())});function H(){if(L)b(L);else if(E&&D){const le=n.exported.getImageData(D),ne={};for(const ae in E){const{width:xe,height:Ee,x:Oe,y:he,sdf:Ge,pixelRatio:Fe,stretchX:et,stretchY:it,content:bt}=E[ae],Ze=new n.RGBAImage({width:xe,height:Ee});n.RGBAImage.copy(le,Ze,{x:Oe,y:he},{x:0,y:0},{width:xe,height:Ee}),ne[ae]={data:Ze,pixelRatio:Fe,sdf:Ge,stretchX:et,stretchY:it,content:bt}}b(null,ne)}}return{cancel(){V&&(V.cancel(),V=null),X&&(X.cancel(),X=null)}}}(t,this.map._requestManager,this.map.getPixelRatio(),(s,l)=>{if(this._spriteRequest=null,s)this.fire(new n.ErrorEvent(s));else if(l)for(const m in l)this.imageManager.addImage(m,l[m]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new n.Event("data",{dataType:"style"}))})}_validateLayer(t){const s=this.sourceCaches[t.source];if(!s)return;const l=t.sourceLayer;if(!l)return;const m=s.getSource();(m.type==="geojson"||m.vectorLayerIds&&m.vectorLayerIds.indexOf(l)===-1)&&this.fire(new n.ErrorEvent(new Error(`Source layer "${l}" does not exist on source "${m.id}" as specified by style layer "${t.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const t in this.sourceCaches)if(!this.sourceCaches[t].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeLayers(t){const s=[];for(const l of t){const m=this._layers[l];m.type!=="custom"&&s.push(m.serialize())}return s}hasTransitions(){if(this.light&&this.light.hasTransition())return!0;for(const t in this.sourceCaches)if(this.sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(t){if(!this._loaded)return;const s=this._changed;if(this._changed){const m=Object.keys(this._updatedLayers),b=Object.keys(this._removedLayers);(m.length||b.length)&&this._updateWorkerLayers(m,b);for(const E in this._updatedSources){const D=this._updatedSources[E];if(D==="reload")this._reloadSource(E);else{if(D!=="clear")throw new Error(`Invalid action ${D}`);this._clearSource(E)}}this._updateTilesForChangedImages();for(const E in this._updatedPaintProps)this._layers[E].updateTransitions(t);this.light.updateTransitions(t),this._resetUpdates()}const l={};for(const m in this.sourceCaches){const b=this.sourceCaches[m];l[m]=b.used,b.used=!1}for(const m of this._order){const b=this._layers[m];b.recalculate(t,this._availableImages),!b.isHidden(t.zoom)&&b.source&&(this.sourceCaches[b.source].used=!0)}for(const m in l){const b=this.sourceCaches[m];l[m]!==b.used&&b.fire(new n.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:m}))}this.light.recalculate(t),this.z=t.zoom,s&&this.fire(new n.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=Object.keys(this._changedImages);if(t.length){for(const s in this.sourceCaches)this.sourceCaches[s].reloadTilesForDependencies(["icons","patterns"],t);this._changedImages={}}}_updateWorkerLayers(t,s){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(t),removedIds:s})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setTerrain(t){if(this._checkLoaded(),this._terrainDataCallback&&this.off("data",this._terrainDataCallback),this._terrainfreezeElevationCallback&&this.map.off("freezeElevation",this._terrainfreezeElevationCallback),t){const s=this.sourceCaches[t.source];if(!s)throw new Error(`cannot load terrain, because there exists no source with ID: ${t.source}`);this.terrain=new Ti(this,s,t),this.map.transform.updateElevation(this.terrain),this._terrainfreezeElevationCallback=l=>{l.freeze?this.map.transform.freezeElevation=!0:(this.map.transform.freezeElevation=!1,this.map.transform.recalculateZoom(this.terrain))},this._terrainDataCallback=l=>{l.tile&&(l.sourceId===t.source?(this.map.transform.updateElevation(this.terrain),this.terrain.rememberForRerender(l.sourceId,l.tile.tileID)):l.source.type==="geojson"&&this.terrain.rememberForRerender(l.sourceId,l.tile.tileID))},this.on("data",this._terrainDataCallback),this.map.on("freezeElevation",this._terrainfreezeElevationCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.map.transform.updateElevation(this.terrain);this.map.fire(new n.Event("terrain",{terrain:t}))}setState(t){if(this._checkLoaded(),Bi(this,n.validateStyle(t)))return!1;(t=n.clone$1(t)).layers=lt(t.layers);const s=function(m,b){if(!m)return[{command:ot.setStyle,args:[b]}];let E=[];try{if(!h(m.version,b.version))return[{command:ot.setStyle,args:[b]}];h(m.center,b.center)||E.push({command:ot.setCenter,args:[b.center]}),h(m.zoom,b.zoom)||E.push({command:ot.setZoom,args:[b.zoom]}),h(m.bearing,b.bearing)||E.push({command:ot.setBearing,args:[b.bearing]}),h(m.pitch,b.pitch)||E.push({command:ot.setPitch,args:[b.pitch]}),h(m.sprite,b.sprite)||E.push({command:ot.setSprite,args:[b.sprite]}),h(m.glyphs,b.glyphs)||E.push({command:ot.setGlyphs,args:[b.glyphs]}),h(m.transition,b.transition)||E.push({command:ot.setTransition,args:[b.transition]}),h(m.light,b.light)||E.push({command:ot.setLight,args:[b.light]});const D={},L=[];(function(V,X,H,le){let ne;for(ne in X=X||{},V=V||{})Object.prototype.hasOwnProperty.call(V,ne)&&(Object.prototype.hasOwnProperty.call(X,ne)||Xt(ne,H,le));for(ne in X)Object.prototype.hasOwnProperty.call(X,ne)&&(Object.prototype.hasOwnProperty.call(V,ne)?h(V[ne],X[ne])||(V[ne].type==="geojson"&&X[ne].type==="geojson"&&jt(V,X,ne)?H.push({command:ot.setGeoJSONSourceData,args:[ne,X[ne].data]}):He(ne,X,H,le)):Gt(ne,X,H))})(m.sources,b.sources,L,D);const R=[];m.layers&&m.layers.forEach(V=>{D[V.source]?E.push({command:ot.removeLayer,args:[V.id]}):R.push(V)}),E=E.concat(L),function(V,X,H){X=X||[];const le=(V=V||[]).map(mi),ne=X.map(mi),ae=V.reduce(Di,{}),xe=X.reduce(Di,{}),Ee=le.slice(),Oe=Object.create(null);let he,Ge,Fe,et,it,bt,Ze;for(he=0,Ge=0;he<le.length;he++)Fe=le[he],Object.prototype.hasOwnProperty.call(xe,Fe)?Ge++:(H.push({command:ot.removeLayer,args:[Fe]}),Ee.splice(Ee.indexOf(Fe,Ge),1));for(he=0,Ge=0;he<ne.length;he++)Fe=ne[ne.length-1-he],Ee[Ee.length-1-he]!==Fe&&(Object.prototype.hasOwnProperty.call(ae,Fe)?(H.push({command:ot.removeLayer,args:[Fe]}),Ee.splice(Ee.lastIndexOf(Fe,Ee.length-Ge),1)):Ge++,bt=Ee[Ee.length-he],H.push({command:ot.addLayer,args:[xe[Fe],bt]}),Ee.splice(Ee.length-he,0,Fe),Oe[Fe]=!0);for(he=0;he<ne.length;he++)if(Fe=ne[he],et=ae[Fe],it=xe[Fe],!Oe[Fe]&&!h(et,it))if(h(et.source,it.source)&&h(et["source-layer"],it["source-layer"])&&h(et.type,it.type)){for(Ze in qt(et.layout,it.layout,H,Fe,null,ot.setLayoutProperty),qt(et.paint,it.paint,H,Fe,null,ot.setPaintProperty),h(et.filter,it.filter)||H.push({command:ot.setFilter,args:[Fe,it.filter]}),h(et.minzoom,it.minzoom)&&h(et.maxzoom,it.maxzoom)||H.push({command:ot.setLayerZoomRange,args:[Fe,it.minzoom,it.maxzoom]}),et)Object.prototype.hasOwnProperty.call(et,Ze)&&Ze!=="layout"&&Ze!=="paint"&&Ze!=="filter"&&Ze!=="metadata"&&Ze!=="minzoom"&&Ze!=="maxzoom"&&(Ze.indexOf("paint.")===0?qt(et[Ze],it[Ze],H,Fe,Ze.slice(6),ot.setPaintProperty):h(et[Ze],it[Ze])||H.push({command:ot.setLayerProperty,args:[Fe,Ze,it[Ze]]}));for(Ze in it)Object.prototype.hasOwnProperty.call(it,Ze)&&!Object.prototype.hasOwnProperty.call(et,Ze)&&Ze!=="layout"&&Ze!=="paint"&&Ze!=="filter"&&Ze!=="metadata"&&Ze!=="minzoom"&&Ze!=="maxzoom"&&(Ze.indexOf("paint.")===0?qt(et[Ze],it[Ze],H,Fe,Ze.slice(6),ot.setPaintProperty):h(et[Ze],it[Ze])||H.push({command:ot.setLayerProperty,args:[Fe,Ze,it[Ze]]}))}else H.push({command:ot.removeLayer,args:[Fe]}),bt=Ee[Ee.lastIndexOf(Fe)+1],H.push({command:ot.addLayer,args:[it,bt]})}(R,b.layers,E)}catch(D){console.warn("Unable to compute style diff:",D),E=[{command:ot.setStyle,args:[b]}]}return E}(this.serialize(),t).filter(m=>!(m.command in Ir));if(s.length===0)return!1;const l=s.filter(m=>!(m.command in Ci));if(l.length>0)throw new Error(`Unimplemented: ${l.map(m=>m.command).join(", ")}.`);return s.forEach(m=>{m.command!=="setTransition"&&this[m.command].apply(this,m.args)}),this.stylesheet=t,!0}addImage(t,s){if(this.getImage(t))return this.fire(new n.ErrorEvent(new Error(`An image named "${t}" already exists.`)));this.imageManager.addImage(t,s),this._afterImageUpdated(t)}updateImage(t,s){this.imageManager.updateImage(t,s)}getImage(t){return this.imageManager.getImage(t)}removeImage(t){if(!this.getImage(t))return this.fire(new n.ErrorEvent(new Error(`An image named "${t}" does not exist.`)));this.imageManager.removeImage(t),this._afterImageUpdated(t)}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(),this._changedImages[t]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new n.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(t,s,l={}){if(this._checkLoaded(),this.sourceCaches[t]!==void 0)throw new Error(`Source "${t}" already exists.`);if(!s.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(s).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(s.type)>=0&&this._validate(n.validateStyle.source,`sources.${t}`,s,null,l))return;this.map&&this.map._collectResourceTiming&&(s.collectResourceTiming=!0);const m=this.sourceCaches[t]=new Ie(t,s,this.dispatcher);m.style=this,m.setEventedParent(this,()=>({isSourceLoaded:this.loaded(),source:m.serialize(),sourceId:t})),m.onAdd(this.map),this._changed=!0}removeSource(t){if(this._checkLoaded(),this.sourceCaches[t]===void 0)throw new Error("There is no source with this ID");for(const l in this._layers)if(this._layers[l].source===t)return this.fire(new n.ErrorEvent(new Error(`Source "${t}" cannot be removed while layer "${l}" is using it.`)));const s=this.sourceCaches[t];delete this.sourceCaches[t],delete this._updatedSources[t],s.fire(new n.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:t})),s.setEventedParent(null),s.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(t,s){if(this._checkLoaded(),this.sourceCaches[t]===void 0)throw new Error(`There is no source with this ID=${t}`);const l=this.sourceCaches[t].getSource();if(l.type!=="geojson")throw new Error(`geojsonSource.type is ${l.type}, which is !== 'geojson`);l.setData(s),this._changed=!0}getSource(t){return this.sourceCaches[t]&&this.sourceCaches[t].getSource()}addLayer(t,s,l={}){this._checkLoaded();const m=t.id;if(this.getLayer(m))return void this.fire(new n.ErrorEvent(new Error(`Layer "${m}" already exists on this map.`)));let b;if(t.type==="custom"){if(Bi(this,n.validateCustomStyleLayer(t)))return;b=n.createStyleLayer(t)}else{if(typeof t.source=="object"&&(this.addSource(m,t.source),t=n.clone$1(t),t=n.extend(t,{source:m})),this._validate(n.validateStyle.layer,`layers.${m}`,t,{arrayIndex:-1},l))return;b=n.createStyleLayer(t),this._validateLayer(b),b.setEventedParent(this,{layer:{id:m}}),this._serializedLayers[b.id]=b.serialize()}const E=s?this._order.indexOf(s):this._order.length;if(s&&E===-1)this.fire(new n.ErrorEvent(new Error(`Cannot add layer "${m}" before non-existing layer "${s}".`)));else{if(this._order.splice(E,0,m),this._layerOrderChanged=!0,this._layers[m]=b,this._removedLayers[m]&&b.source&&b.type!=="custom"){const D=this._removedLayers[m];delete this._removedLayers[m],D.type!==b.type?this._updatedSources[b.source]="clear":(this._updatedSources[b.source]="reload",this.sourceCaches[b.source].pause())}this._updateLayer(b),b.onAdd&&b.onAdd(this.map)}}moveLayer(t,s){if(this._checkLoaded(),this._changed=!0,!this._layers[t])return void this.fire(new n.ErrorEvent(new Error(`The layer '${t}' does not exist in the map's style and cannot be moved.`)));if(t===s)return;const l=this._order.indexOf(t);this._order.splice(l,1);const m=s?this._order.indexOf(s):this._order.length;s&&m===-1?this.fire(new n.ErrorEvent(new Error(`Cannot move layer "${t}" before non-existing layer "${s}".`))):(this._order.splice(m,0,t),this._layerOrderChanged=!0)}removeLayer(t){this._checkLoaded();const s=this._layers[t];if(!s)return void this.fire(new n.ErrorEvent(new Error(`Cannot remove non-existing layer "${t}".`)));s.setEventedParent(null);const l=this._order.indexOf(t);this._order.splice(l,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[t]=s,delete this._layers[t],delete this._serializedLayers[t],delete this._updatedLayers[t],delete this._updatedPaintProps[t],s.onRemove&&s.onRemove(this.map)}getLayer(t){return this._layers[t]}hasLayer(t){return t in this._layers}setLayerZoomRange(t,s,l){this._checkLoaded();const m=this.getLayer(t);m?m.minzoom===s&&m.maxzoom===l||(s!=null&&(m.minzoom=s),l!=null&&(m.maxzoom=l),this._updateLayer(m)):this.fire(new n.ErrorEvent(new Error(`Cannot set the zoom range of non-existing layer "${t}".`)))}setFilter(t,s,l={}){this._checkLoaded();const m=this.getLayer(t);if(m){if(!h(m.filter,s))return s==null?(m.filter=void 0,void this._updateLayer(m)):void(this._validate(n.validateStyle.filter,`layers.${m.id}.filter`,s,null,l)||(m.filter=n.clone$1(s),this._updateLayer(m)))}else this.fire(new n.ErrorEvent(new Error(`Cannot filter non-existing layer "${t}".`)))}getFilter(t){return n.clone$1(this.getLayer(t).filter)}setLayoutProperty(t,s,l,m={}){this._checkLoaded();const b=this.getLayer(t);b?h(b.getLayoutProperty(s),l)||(b.setLayoutProperty(s,l,m),this._updateLayer(b)):this.fire(new n.ErrorEvent(new Error(`Cannot style non-existing layer "${t}".`)))}getLayoutProperty(t,s){const l=this.getLayer(t);if(l)return l.getLayoutProperty(s);this.fire(new n.ErrorEvent(new Error(`Cannot get style of non-existing layer "${t}".`)))}setPaintProperty(t,s,l,m={}){this._checkLoaded();const b=this.getLayer(t);b?h(b.getPaintProperty(s),l)||(b.setPaintProperty(s,l,m)&&this._updateLayer(b),this._changed=!0,this._updatedPaintProps[t]=!0):this.fire(new n.ErrorEvent(new Error(`Cannot style non-existing layer "${t}".`)))}getPaintProperty(t,s){return this.getLayer(t).getPaintProperty(s)}setFeatureState(t,s){this._checkLoaded();const l=t.source,m=t.sourceLayer,b=this.sourceCaches[l];if(b===void 0)return void this.fire(new n.ErrorEvent(new Error(`The source '${l}' does not exist in the map's style.`)));const E=b.getSource().type;E==="geojson"&&m?this.fire(new n.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):E!=="vector"||m?(t.id===void 0&&this.fire(new n.ErrorEvent(new Error("The feature id parameter must be provided."))),b.setFeatureState(m,t.id,s)):this.fire(new n.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(t,s){this._checkLoaded();const l=t.source,m=this.sourceCaches[l];if(m===void 0)return void this.fire(new n.ErrorEvent(new Error(`The source '${l}' does not exist in the map's style.`)));const b=m.getSource().type,E=b==="vector"?t.sourceLayer:void 0;b!=="vector"||E?s&&typeof t.id!="string"&&typeof t.id!="number"?this.fire(new n.ErrorEvent(new Error("A feature id is required to remove its specific state property."))):m.removeFeatureState(E,t.id,s):this.fire(new n.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(t){this._checkLoaded();const s=t.source,l=t.sourceLayer,m=this.sourceCaches[s];if(m!==void 0)return m.getSource().type!=="vector"||l?(t.id===void 0&&this.fire(new n.ErrorEvent(new Error("The feature id parameter must be provided."))),m.getFeatureState(l,t.id)):void this.fire(new n.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new n.ErrorEvent(new Error(`The source '${s}' does not exist in the map's style.`)))}getTransition(){return n.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){return n.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,sources:n.mapObject(this.sourceCaches,t=>t.serialize()),layers:this._serializeLayers(this._order)},t=>t!==void 0)}_updateLayer(t){this._updatedLayers[t.id]=!0,t.source&&!this._updatedSources[t.source]&&this.sourceCaches[t.source].getSource().type!=="raster"&&(this._updatedSources[t.source]="reload",this.sourceCaches[t.source].pause()),this._changed=!0}_flattenAndSortRenderedFeatures(t){const s=E=>this._layers[E].type==="fill-extrusion",l={},m=[];for(let E=this._order.length-1;E>=0;E--){const D=this._order[E];if(s(D)){l[D]=E;for(const L of t){const R=L[D];if(R)for(const V of R)m.push(V)}}}m.sort((E,D)=>D.intersectionZ-E.intersectionZ);const b=[];for(let E=this._order.length-1;E>=0;E--){const D=this._order[E];if(s(D))for(let L=m.length-1;L>=0;L--){const R=m[L].feature;if(l[R.layer.id]<E)break;b.push(R),m.pop()}else for(const L of t){const R=L[D];if(R)for(const V of R)b.push(V.feature)}}return b}queryRenderedFeatures(t,s,l){s&&s.filter&&this._validate(n.validateStyle.filter,"queryRenderedFeatures.filter",s.filter,null,s);const m={};if(s&&s.layers){if(!Array.isArray(s.layers))return this.fire(new n.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const E of s.layers){const D=this._layers[E];if(!D)return this.fire(new n.ErrorEvent(new Error(`The layer '${E}' does not exist in the map's style and cannot be queried for features.`))),[];m[D.source]=!0}}const b=[];s.availableImages=this._availableImages;for(const E in this.sourceCaches)s.layers&&!m[E]||b.push(J(this.sourceCaches[E],this._layers,this._serializedLayers,t,s,l));return this.placement&&b.push(function(E,D,L,R,V,X,H){const le={},ne=X.queryRenderedSymbols(R),ae=[];for(const xe of Object.keys(ne).map(Number))ae.push(H[xe]);ae.sort(q);for(const xe of ae){const Ee=xe.featureIndex.lookupSymbolFeatures(ne[xe.bucketInstanceId],D,xe.bucketIndex,xe.sourceLayerIndex,V.filter,V.layers,V.availableImages,E);for(const Oe in Ee){const he=le[Oe]=le[Oe]||[],Ge=Ee[Oe];Ge.sort((Fe,et)=>{const it=xe.featureSortOrder;if(it){const bt=it.indexOf(Fe.featureIndex);return it.indexOf(et.featureIndex)-bt}return et.featureIndex-Fe.featureIndex});for(const Fe of Ge)he.push(Fe)}}for(const xe in le)le[xe].forEach(Ee=>{const Oe=Ee.feature,he=L[E[xe].source].getFeatureState(Oe.layer["source-layer"],Oe.id);Oe.source=Oe.layer.source,Oe.layer["source-layer"]&&(Oe.sourceLayer=Oe.layer["source-layer"]),Oe.state=he});return le}(this._layers,this._serializedLayers,this.sourceCaches,t,s,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(b)}querySourceFeatures(t,s){s&&s.filter&&this._validate(n.validateStyle.filter,"querySourceFeatures.filter",s.filter,null,s);const l=this.sourceCaches[t];return l?function(m,b){const E=m.getRenderableIds().map(R=>m.getTileByID(R)),D=[],L={};for(let R=0;R<E.length;R++){const V=E[R],X=V.tileID.canonical.key;L[X]||(L[X]=!0,V.querySourceFeatures(D,b))}return D}(l,s):[]}addSourceType(t,s,l){return gr.getSourceType(t)?l(new Error(`A source type called "${t}" already exists.`)):(gr.setSourceType(t,s),s.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:s.workerSourceURL},l):l(null,null))}getLight(){return this.light.getLight()}setLight(t,s={}){this._checkLoaded();const l=this.light.getLight();let m=!1;for(const E in t)if(!h(t[E],l[E])){m=!0;break}if(!m)return;const b={now:n.exported.now(),transition:n.extend({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(t,s),this.light.updateTransitions(b)}_validate(t,s,l,m,b={}){return(!b||b.validate!==!1)&&Bi(this,t.call(n.validateStyle,n.extend({key:s,style:this.serialize(),value:l,styleSpec:n.spec},m)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),n.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._layers)this._layers[t].setEventedParent(null);for(const t in this.sourceCaches){const s=this.sourceCaches[t];s.setEventedParent(null),s.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(t){this.sourceCaches[t].clearTiles()}_reloadSource(t){this.sourceCaches[t].resume(),this.sourceCaches[t].reload()}_updateSources(t){for(const s in this.sourceCaches)this.sourceCaches[s].update(t,this.terrain)}_generateCollisionBoxes(){for(const t in this.sourceCaches)this._reloadSource(t)}_updatePlacement(t,s,l,m,b=!1){let E=!1,D=!1;const L={};for(const R of this._order){const V=this._layers[R];if(V.type!=="symbol")continue;if(!L[V.source]){const H=this.sourceCaches[V.source];L[V.source]=H.getRenderableIds(!0).map(le=>H.getTileByID(le)).sort((le,ne)=>ne.tileID.overscaledZ-le.tileID.overscaledZ||(le.tileID.isLessThan(ne.tileID)?-1:1))}const X=this.crossTileSymbolIndex.addLayer(V,L[V.source],t.center.lng);E=E||X}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((b=b||this._layerOrderChanged||l===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(n.exported.now(),t.zoom))&&(this.pauseablePlacement=new qe(t,this.terrain,this._order,b,s,l,m,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,L),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(n.exported.now()),D=!0),E&&this.pauseablePlacement.placement.setStale()),D||E)for(const R of this._order){const V=this._layers[R];V.type==="symbol"&&this.placement.updateLayerOpacities(V,L[V.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(n.exported.now())}_releaseSymbolFadeTiles(){for(const t in this.sourceCaches)this.sourceCaches[t].releaseSymbolFadeTiles()}getImages(t,s,l){this.imageManager.getImages(s.icons,l),this._updateTilesForChangedImages();const m=this.sourceCaches[s.source];m&&m.setDependencies(s.tileID.key,s.type,s.icons)}getGlyphs(t,s,l){this.glyphManager.getGlyphs(s.stacks,l)}getResource(t,s,l){return n.makeRequest(s,l)}}gr.getSourceType=function(f){return ie[f]},gr.setSourceType=function(f,t){ie[f]=t},gr.registerForPluginStateChange=n.registerForPluginStateChange;var Kr="attribute vec2 a_pos;uniform mat4 u_matrix;varying vec2 v_texture_pos;varying float v_depth;void main() {v_texture_pos=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos,get_elevation(a_pos),1.0);v_depth=gl_Position.z/gl_Position.w;}";const vs={prelude:Vi(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_offset;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture2D(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture2D(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return (elevation+u_terrain_offset)*u_terrain_exaggeration;
#else
return 0.0;
#endif
}`),background:Vi(`uniform vec4 u_color;uniform float u_opacity;void main() {gl_FragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),backgroundPattern:Vi(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:Vi(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));gl_FragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);float ele=get_elevation(circle_center);v_visibility=calculate_visibility(u_matrix*vec4(circle_center,ele,1.0));if (u_pitch_with_map) {vec2 corner_position=circle_center;if (u_scale_with_map) {corner_position+=extrude*(radius+stroke_width)*u_extrude_scale;} else {vec4 projected_center=u_matrix*vec4(circle_center,0,1);corner_position+=extrude*(radius+stroke_width)*u_extrude_scale*(projected_center.w/u_camera_to_center_distance);}gl_Position=u_matrix*vec4(corner_position,ele,1);} else {gl_Position=u_matrix*vec4(circle_center,ele,1);if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:Vi("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Vi(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec4 pos=vec4(floor(a_pos*0.5)+extrude,0,1);gl_Position=u_matrix*pos;}`),heatmapTexture:Vi(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:Vi("varying float v_placed;varying float v_notUsed;void main() {float alpha=0.5;gl_FragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {gl_FragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {gl_FragColor*=.1;}}","attribute vec2 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_anchor_pos,0,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);gl_Position=u_matrix*vec4(a_pos,get_elevation(a_pos),1.0);gl_Position.xy+=(a_extrude+a_shift)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Vi("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Vi("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,get_elevation(a_pos),1);}"),fill:Vi(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_FragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);}`),fillOutline:Vi(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=outline_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillOutlinePattern:Vi(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillPattern:Vi(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:Vi(`varying vec4 v_color;void main() {gl_FragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float baseDelta=10.0;float ele=get_elevation(a_centroid);
#else
float baseDelta=0.0;float ele=0.0;
#endif
base=max(0.0,ele+base-baseDelta);height=max(0.0,ele+height);float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t > 0.0 ? height : base,1);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:Vi(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);gl_FragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float baseDelta=10.0;float ele=get_elevation(a_centroid);
#else
float baseDelta=0.0;float ele=0.0;
#endif
base=max(0.0,ele+base-baseDelta);height=max(0.0,ele+height);float t=mod(normal.x,2.0);float z=t > 0.0 ? height : base;gl_Position=u_matrix*vec4(a_pos,z,1);vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:Vi(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Vi(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;
#define PI 3.141592653589793
void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;}"),line:Vi(`uniform lowp float u_device_pixel_ratio;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp float v_linesofar;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:Vi(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture2D(u_image,v_uv);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_uv_x;attribute float a_split_index;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:Vi(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);gl_FragColor=color*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:Vi(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture2D(u_image,v_tex_a).a;float sdfdist_b=texture2D(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}`),raster:Vi(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);gl_FragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos0=(((a_texture_pos/8192.0)-0.5)/u_buffer_scale )+0.5;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}"),symbolIcon:Vi(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0),z,1.0);v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:Vi(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset),z,1.0);float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:Vi(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale),z,1.0);float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:Vi("uniform sampler2D u_texture;varying vec2 v_texture_pos;void main() {gl_FragColor=texture2D(u_texture,v_texture_pos);}",Kr),terrainDepth:Vi("varying float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {gl_FragColor=pack(v_depth);}",Kr),terrainCoords:Vi("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;varying vec2 v_texture_pos;void main() {vec4 rgba=texture2D(u_texture,v_texture_pos);gl_FragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}",Kr)};function Vi(f,t){const s=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,l=t.match(/attribute ([\w]+) ([\w]+)/g),m=f.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),b=t.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),E=b?b.concat(m):m,D={};return{fragmentSource:f=f.replace(s,(L,R,V,X,H)=>(D[H]=!0,R==="define"?`
#ifndef HAS_UNIFORM_u_${H}
varying ${V} ${X} ${H};
#else
uniform ${V} ${X} u_${H};
#endif
`:`
#ifdef HAS_UNIFORM_u_${H}
    ${V} ${X} ${H} = u_${H};
#endif
`)),vertexSource:t=t.replace(s,(L,R,V,X,H)=>{const le=X==="float"?"vec2":"vec4",ne=H.match(/color/)?"color":le;return D[H]?R==="define"?`
#ifndef HAS_UNIFORM_u_${H}
uniform lowp float u_${H}_t;
attribute ${V} ${le} a_${H};
varying ${V} ${X} ${H};
#else
uniform ${V} ${X} u_${H};
#endif
`:ne==="vec4"?`
#ifndef HAS_UNIFORM_u_${H}
    ${H} = a_${H};
#else
    ${V} ${X} ${H} = u_${H};
#endif
`:`
#ifndef HAS_UNIFORM_u_${H}
    ${H} = unpack_mix_${ne}(a_${H}, u_${H}_t);
#else
    ${V} ${X} ${H} = u_${H};
#endif
`:R==="define"?`
#ifndef HAS_UNIFORM_u_${H}
uniform lowp float u_${H}_t;
attribute ${V} ${le} a_${H};
#else
uniform ${V} ${X} u_${H};
#endif
`:ne==="vec4"?`
#ifndef HAS_UNIFORM_u_${H}
    ${V} ${X} ${H} = a_${H};
#else
    ${V} ${X} ${H} = u_${H};
#endif
`:`
#ifndef HAS_UNIFORM_u_${H}
    ${V} ${X} ${H} = unpack_mix_${ne}(a_${H}, u_${H}_t);
#else
    ${V} ${X} ${H} = u_${H};
#endif
`}),staticAttributes:l,staticUniforms:E}}class Yn{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(t,s,l,m,b,E,D,L,R){this.context=t;let V=this.boundPaintVertexBuffers.length!==m.length;for(let X=0;!V&&X<m.length;X++)this.boundPaintVertexBuffers[X]!==m[X]&&(V=!0);t.extVertexArrayObject&&this.vao&&this.boundProgram===s&&this.boundLayoutVertexBuffer===l&&!V&&this.boundIndexBuffer===b&&this.boundVertexOffset===E&&this.boundDynamicVertexBuffer===D&&this.boundDynamicVertexBuffer2===L&&this.boundDynamicVertexBuffer3===R?(t.bindVertexArrayOES.set(this.vao),D&&D.bind(),b&&b.dynamicDraw&&b.bind(),L&&L.bind(),R&&R.bind()):this.freshBind(s,l,m,b,E,D,L,R)}freshBind(t,s,l,m,b,E,D,L){let R;const V=t.numAttributes,X=this.context,H=X.gl;if(X.extVertexArrayObject)this.vao&&this.destroy(),this.vao=X.extVertexArrayObject.createVertexArrayOES(),X.bindVertexArrayOES.set(this.vao),R=0,this.boundProgram=t,this.boundLayoutVertexBuffer=s,this.boundPaintVertexBuffers=l,this.boundIndexBuffer=m,this.boundVertexOffset=b,this.boundDynamicVertexBuffer=E,this.boundDynamicVertexBuffer2=D,this.boundDynamicVertexBuffer3=L;else{R=X.currentNumAttributes||0;for(let le=V;le<R;le++)H.disableVertexAttribArray(le)}s.enableAttributes(H,t);for(const le of l)le.enableAttributes(H,t);E&&E.enableAttributes(H,t),D&&D.enableAttributes(H,t),L&&L.enableAttributes(H,t),s.bind(),s.setVertexAttribPointers(H,t,b);for(const le of l)le.bind(),le.setVertexAttribPointers(H,t,b);E&&(E.bind(),E.setVertexAttribPointers(H,t,b)),m&&m.bind(),D&&(D.bind(),D.setVertexAttribPointers(H,t,b)),L&&(L.bind(),L.setVertexAttribPointers(H,t,b)),X.currentNumAttributes=V}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function fo(f){const t=[];for(let s=0;s<f.length;s++){if(f[s]===null)continue;const l=f[s].split(" ");t.push(l.pop())}return t}class la{constructor(t,s,l,m,b,E,D){const L=t.gl;this.program=L.createProgram();const R=fo(l.staticAttributes),V=m?m.getBinderAttributes():[],X=R.concat(V),H=vs.prelude.staticUniforms?fo(vs.prelude.staticUniforms):[],le=l.staticUniforms?fo(l.staticUniforms):[],ne=m?m.getBinderUniforms():[],ae=H.concat(le).concat(ne),xe=[];for(const it of ae)xe.indexOf(it)<0&&xe.push(it);const Ee=m?m.defines():[];E&&Ee.push("#define OVERDRAW_INSPECTOR;"),D&&Ee.push("#define TERRAIN3D;");const Oe=Ee.concat(vs.prelude.fragmentSource,l.fragmentSource).join(`
`),he=Ee.concat(vs.prelude.vertexSource,l.vertexSource).join(`
`),Ge=L.createShader(L.FRAGMENT_SHADER);if(L.isContextLost())return void(this.failedToCreate=!0);L.shaderSource(Ge,Oe),L.compileShader(Ge),L.attachShader(this.program,Ge);const Fe=L.createShader(L.VERTEX_SHADER);if(L.isContextLost())return void(this.failedToCreate=!0);L.shaderSource(Fe,he),L.compileShader(Fe),L.attachShader(this.program,Fe),this.attributes={};const et={};this.numAttributes=X.length;for(let it=0;it<this.numAttributes;it++)X[it]&&(L.bindAttribLocation(this.program,it,X[it]),this.attributes[X[it]]=it);L.linkProgram(this.program),L.deleteShader(Fe),L.deleteShader(Ge);for(let it=0;it<xe.length;it++){const bt=xe[it];if(bt&&!et[bt]){const Ze=L.getUniformLocation(this.program,bt);Ze&&(et[bt]=Ze)}}this.fixedUniforms=b(t,et),this.terrainUniforms=((it,bt)=>({u_depth:new n.Uniform1i(it,bt.u_depth),u_terrain:new n.Uniform1i(it,bt.u_terrain),u_terrain_dim:new n.Uniform1f(it,bt.u_terrain_dim),u_terrain_matrix:new n.UniformMatrix4f(it,bt.u_terrain_matrix),u_terrain_unpack:new n.Uniform4f(it,bt.u_terrain_unpack),u_terrain_offset:new n.Uniform1f(it,bt.u_terrain_offset),u_terrain_exaggeration:new n.Uniform1f(it,bt.u_terrain_exaggeration)}))(t,et),this.binderUniforms=m?m.getUniforms(t,et):[]}draw(t,s,l,m,b,E,D,L,R,V,X,H,le,ne,ae,xe,Ee,Oe){const he=t.gl;if(this.failedToCreate)return;if(t.program.set(this.program),t.setDepthMode(l),t.setStencilMode(m),t.setColorMode(b),t.setCullFace(E),L){t.activeTexture.set(he.TEXTURE2),he.bindTexture(he.TEXTURE_2D,L.depthTexture),t.activeTexture.set(he.TEXTURE3),he.bindTexture(he.TEXTURE_2D,L.texture);for(const Fe in this.terrainUniforms)this.terrainUniforms[Fe].set(L[Fe])}for(const Fe in this.fixedUniforms)this.fixedUniforms[Fe].set(D[Fe]);ae&&ae.setUniforms(t,this.binderUniforms,le,{zoom:ne});let Ge=0;switch(s){case he.LINES:Ge=2;break;case he.TRIANGLES:Ge=3;break;case he.LINE_STRIP:Ge=1}for(const Fe of H.get()){const et=Fe.vaos||(Fe.vaos={});(et[R]||(et[R]=new Yn)).bind(t,this,V,ae?ae.getPaintVertexBuffers():[],X,Fe.vertexOffset,xe,Ee,Oe),he.drawElements(s,Fe.primitiveLength*Ge,he.UNSIGNED_SHORT,Fe.primitiveOffset*Ge*2)}}}function ca(f,t,s){const l=1/lr(s,1,t.transform.tileZoom),m=Math.pow(2,s.tileID.overscaledZ),b=s.tileSize*Math.pow(2,t.transform.tileZoom)/m,E=b*(s.tileID.canonical.x+s.tileID.wrap*m),D=b*s.tileID.canonical.y;return{u_image:0,u_texsize:s.imageAtlasTexture.size,u_scale:[l,f.fromScale,f.toScale],u_fade:f.t,u_pixel_coord_upper:[E>>16,D>>16],u_pixel_coord_lower:[65535&E,65535&D]}}const Lo=(f,t,s,l)=>{const m=t.style.light,b=m.properties.get("position"),E=[b.x,b.y,b.z],D=n.create$1();m.properties.get("anchor")==="viewport"&&n.fromRotation(D,-t.transform.angle),n.transformMat3(E,E,D);const L=m.properties.get("color");return{u_matrix:f,u_lightpos:E,u_lightintensity:m.properties.get("intensity"),u_lightcolor:[L.r,L.g,L.b],u_vertical_gradient:+s,u_opacity:l}},ha=(f,t,s,l,m,b,E)=>n.extend(Lo(f,t,s,l),ca(b,t,E),{u_height_factor:-Math.pow(2,m.overscaledZ)/E.tileSize/8}),po=f=>({u_matrix:f}),zo=(f,t,s,l)=>n.extend(po(f),ca(s,t,l)),ua=(f,t)=>({u_matrix:f,u_world:t}),da=(f,t,s,l,m)=>n.extend(zo(f,t,s,l),{u_world:m}),Fo=(f,t,s,l)=>{const m=f.transform;let b,E;if(l.paint.get("circle-pitch-alignment")==="map"){const D=lr(s,1,m.zoom);b=!0,E=[D,D]}else b=!1,E=m.pixelsToGLUnits;return{u_camera_to_center_distance:m.cameraToCenterDistance,u_scale_with_map:+(l.paint.get("circle-pitch-scale")==="map"),u_matrix:f.translatePosMatrix(t.posMatrix,s,l.paint.get("circle-translate"),l.paint.get("circle-translate-anchor")),u_pitch_with_map:+b,u_device_pixel_ratio:f.pixelRatio,u_extrude_scale:E}},T=(f,t,s)=>{const l=lr(s,1,t.zoom),m=Math.pow(2,t.zoom-s.tileID.overscaledZ),b=s.tileID.overscaleFactor();return{u_matrix:f,u_camera_to_center_distance:t.cameraToCenterDistance,u_pixels_to_tile_units:l,u_extrude_scale:[t.pixelsToGLUnits[0]/(l*m),t.pixelsToGLUnits[1]/(l*m)],u_overscale_factor:b}},z=(f,t,s=1)=>({u_matrix:f,u_color:t,u_overlay:0,u_overlay_scale:s}),$=f=>({u_matrix:f}),ye=(f,t,s,l)=>({u_matrix:f,u_extrude_scale:lr(t,1,s),u_intensity:l});function Le(f,t){const s=Math.pow(2,t.canonical.z),l=t.canonical.y;return[new n.MercatorCoordinate(0,l/s).toLngLat().lat,new n.MercatorCoordinate(0,(l+1)/s).toLngLat().lat]}const Te=(f,t,s,l)=>{const m=f.transform;return{u_matrix:Re(f,t,s,l),u_ratio:1/lr(t,1,m.zoom),u_device_pixel_ratio:f.pixelRatio,u_units_to_pixels:[1/m.pixelsToGLUnits[0],1/m.pixelsToGLUnits[1]]}},ke=(f,t,s,l,m)=>n.extend(Te(f,t,s,m),{u_image:0,u_image_height:l}),wt=(f,t,s,l,m)=>{const b=f.transform,E=Ct(t,b);return{u_matrix:Re(f,t,s,m),u_texsize:t.imageAtlasTexture.size,u_ratio:1/lr(t,1,b.zoom),u_device_pixel_ratio:f.pixelRatio,u_image:0,u_scale:[E,l.fromScale,l.toScale],u_fade:l.t,u_units_to_pixels:[1/b.pixelsToGLUnits[0],1/b.pixelsToGLUnits[1]]}},xt=(f,t,s,l,m,b)=>{const E=f.lineAtlas,D=Ct(t,f.transform),L=s.layout.get("line-cap")==="round",R=E.getDash(l.from,L),V=E.getDash(l.to,L),X=R.width*m.fromScale,H=V.width*m.toScale;return n.extend(Te(f,t,s,b),{u_patternscale_a:[D/X,-R.height/2],u_patternscale_b:[D/H,-V.height/2],u_sdfgamma:E.width/(256*Math.min(X,H)*f.pixelRatio)/2,u_image:0,u_tex_y_a:R.y,u_tex_y_b:V.y,u_mix:m.t})};function Ct(f,t){return 1/lr(f,1,t.tileZoom)}function Re(f,t,s,l){return f.translatePosMatrix(l?l.posMatrix:t.tileID.posMatrix,t,s.paint.get("line-translate"),s.paint.get("line-translate-anchor"))}const Mt=(f,t,s,l,m)=>{return{u_matrix:f,u_tl_parent:t,u_scale_parent:s,u_buffer_scale:1,u_fade_t:l.mix,u_opacity:l.opacity*m.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:m.paint.get("raster-brightness-min"),u_brightness_high:m.paint.get("raster-brightness-max"),u_saturation_factor:(E=m.paint.get("raster-saturation"),E>0?1-1/(1.001-E):-E),u_contrast_factor:(b=m.paint.get("raster-contrast"),b>0?1/(1-b):1+b),u_spin_weights:Nt(m.paint.get("raster-hue-rotate"))};var b,E};function Nt(f){f*=Math.PI/180;const t=Math.sin(f),s=Math.cos(f);return[(2*s+1)/3,(-Math.sqrt(3)*t-s+1)/3,(Math.sqrt(3)*t-s+1)/3]}const li=(f,t,s,l,m,b,E,D,L,R)=>{const V=m.transform;return{u_is_size_zoom_constant:+(f==="constant"||f==="source"),u_is_size_feature_constant:+(f==="constant"||f==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:V.cameraToCenterDistance,u_pitch:V.pitch/360*2*Math.PI,u_rotate_symbol:+s,u_aspect_ratio:V.width/V.height,u_fade_change:m.options.fadeDuration?m.symbolFadeChange:1,u_matrix:b,u_label_plane_matrix:E,u_coord_matrix:D,u_is_text:+L,u_pitch_with_map:+l,u_texsize:R,u_texture:0}},_i=(f,t,s,l,m,b,E,D,L,R,V)=>{const X=m.transform;return n.extend(li(f,t,s,l,m,b,E,D,L,R),{u_gamma_scale:l?Math.cos(X._pitch)*X.cameraToCenterDistance:1,u_device_pixel_ratio:m.pixelRatio,u_is_halo:+V})},Cr=(f,t,s,l,m,b,E,D,L,R)=>n.extend(_i(f,t,s,l,m,b,E,D,!0,L,!0),{u_texsize_icon:R,u_texture_icon:1}),dt=(f,t,s)=>({u_matrix:f,u_opacity:t,u_color:s}),Zt=(f,t,s,l,m,b)=>n.extend(function(E,D,L,R){const V=L.imageManager.getPattern(E.from.toString()),X=L.imageManager.getPattern(E.to.toString()),{width:H,height:le}=L.imageManager.getPixelSize(),ne=Math.pow(2,R.tileID.overscaledZ),ae=R.tileSize*Math.pow(2,L.transform.tileZoom)/ne,xe=ae*(R.tileID.canonical.x+R.tileID.wrap*ne),Ee=ae*R.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:V.tl,u_pattern_br_a:V.br,u_pattern_tl_b:X.tl,u_pattern_br_b:X.br,u_texsize:[H,le],u_mix:D.t,u_pattern_size_a:V.displaySize,u_pattern_size_b:X.displaySize,u_scale_a:D.fromScale,u_scale_b:D.toScale,u_tile_units_to_pixels:1/lr(R,1,L.transform.tileZoom),u_pixel_coord_upper:[xe>>16,Ee>>16],u_pixel_coord_lower:[65535&xe,65535&Ee]}}(l,b,s,m),{u_matrix:f,u_opacity:t}),qi={fillExtrusion:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_lightpos:new n.Uniform3f(f,t.u_lightpos),u_lightintensity:new n.Uniform1f(f,t.u_lightintensity),u_lightcolor:new n.Uniform3f(f,t.u_lightcolor),u_vertical_gradient:new n.Uniform1f(f,t.u_vertical_gradient),u_opacity:new n.Uniform1f(f,t.u_opacity)}),fillExtrusionPattern:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_lightpos:new n.Uniform3f(f,t.u_lightpos),u_lightintensity:new n.Uniform1f(f,t.u_lightintensity),u_lightcolor:new n.Uniform3f(f,t.u_lightcolor),u_vertical_gradient:new n.Uniform1f(f,t.u_vertical_gradient),u_height_factor:new n.Uniform1f(f,t.u_height_factor),u_image:new n.Uniform1i(f,t.u_image),u_texsize:new n.Uniform2f(f,t.u_texsize),u_pixel_coord_upper:new n.Uniform2f(f,t.u_pixel_coord_upper),u_pixel_coord_lower:new n.Uniform2f(f,t.u_pixel_coord_lower),u_scale:new n.Uniform3f(f,t.u_scale),u_fade:new n.Uniform1f(f,t.u_fade),u_opacity:new n.Uniform1f(f,t.u_opacity)}),fill:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix)}),fillPattern:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_image:new n.Uniform1i(f,t.u_image),u_texsize:new n.Uniform2f(f,t.u_texsize),u_pixel_coord_upper:new n.Uniform2f(f,t.u_pixel_coord_upper),u_pixel_coord_lower:new n.Uniform2f(f,t.u_pixel_coord_lower),u_scale:new n.Uniform3f(f,t.u_scale),u_fade:new n.Uniform1f(f,t.u_fade)}),fillOutline:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_world:new n.Uniform2f(f,t.u_world)}),fillOutlinePattern:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_world:new n.Uniform2f(f,t.u_world),u_image:new n.Uniform1i(f,t.u_image),u_texsize:new n.Uniform2f(f,t.u_texsize),u_pixel_coord_upper:new n.Uniform2f(f,t.u_pixel_coord_upper),u_pixel_coord_lower:new n.Uniform2f(f,t.u_pixel_coord_lower),u_scale:new n.Uniform3f(f,t.u_scale),u_fade:new n.Uniform1f(f,t.u_fade)}),circle:(f,t)=>({u_camera_to_center_distance:new n.Uniform1f(f,t.u_camera_to_center_distance),u_scale_with_map:new n.Uniform1i(f,t.u_scale_with_map),u_pitch_with_map:new n.Uniform1i(f,t.u_pitch_with_map),u_extrude_scale:new n.Uniform2f(f,t.u_extrude_scale),u_device_pixel_ratio:new n.Uniform1f(f,t.u_device_pixel_ratio),u_matrix:new n.UniformMatrix4f(f,t.u_matrix)}),collisionBox:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_camera_to_center_distance:new n.Uniform1f(f,t.u_camera_to_center_distance),u_pixels_to_tile_units:new n.Uniform1f(f,t.u_pixels_to_tile_units),u_extrude_scale:new n.Uniform2f(f,t.u_extrude_scale),u_overscale_factor:new n.Uniform1f(f,t.u_overscale_factor)}),collisionCircle:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_inv_matrix:new n.UniformMatrix4f(f,t.u_inv_matrix),u_camera_to_center_distance:new n.Uniform1f(f,t.u_camera_to_center_distance),u_viewport_size:new n.Uniform2f(f,t.u_viewport_size)}),debug:(f,t)=>({u_color:new n.UniformColor(f,t.u_color),u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_overlay:new n.Uniform1i(f,t.u_overlay),u_overlay_scale:new n.Uniform1f(f,t.u_overlay_scale)}),clippingMask:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix)}),heatmap:(f,t)=>({u_extrude_scale:new n.Uniform1f(f,t.u_extrude_scale),u_intensity:new n.Uniform1f(f,t.u_intensity),u_matrix:new n.UniformMatrix4f(f,t.u_matrix)}),heatmapTexture:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_world:new n.Uniform2f(f,t.u_world),u_image:new n.Uniform1i(f,t.u_image),u_color_ramp:new n.Uniform1i(f,t.u_color_ramp),u_opacity:new n.Uniform1f(f,t.u_opacity)}),hillshade:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_image:new n.Uniform1i(f,t.u_image),u_latrange:new n.Uniform2f(f,t.u_latrange),u_light:new n.Uniform2f(f,t.u_light),u_shadow:new n.UniformColor(f,t.u_shadow),u_highlight:new n.UniformColor(f,t.u_highlight),u_accent:new n.UniformColor(f,t.u_accent)}),hillshadePrepare:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_image:new n.Uniform1i(f,t.u_image),u_dimension:new n.Uniform2f(f,t.u_dimension),u_zoom:new n.Uniform1f(f,t.u_zoom),u_unpack:new n.Uniform4f(f,t.u_unpack)}),line:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_ratio:new n.Uniform1f(f,t.u_ratio),u_device_pixel_ratio:new n.Uniform1f(f,t.u_device_pixel_ratio),u_units_to_pixels:new n.Uniform2f(f,t.u_units_to_pixels)}),lineGradient:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_ratio:new n.Uniform1f(f,t.u_ratio),u_device_pixel_ratio:new n.Uniform1f(f,t.u_device_pixel_ratio),u_units_to_pixels:new n.Uniform2f(f,t.u_units_to_pixels),u_image:new n.Uniform1i(f,t.u_image),u_image_height:new n.Uniform1f(f,t.u_image_height)}),linePattern:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_texsize:new n.Uniform2f(f,t.u_texsize),u_ratio:new n.Uniform1f(f,t.u_ratio),u_device_pixel_ratio:new n.Uniform1f(f,t.u_device_pixel_ratio),u_image:new n.Uniform1i(f,t.u_image),u_units_to_pixels:new n.Uniform2f(f,t.u_units_to_pixels),u_scale:new n.Uniform3f(f,t.u_scale),u_fade:new n.Uniform1f(f,t.u_fade)}),lineSDF:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_ratio:new n.Uniform1f(f,t.u_ratio),u_device_pixel_ratio:new n.Uniform1f(f,t.u_device_pixel_ratio),u_units_to_pixels:new n.Uniform2f(f,t.u_units_to_pixels),u_patternscale_a:new n.Uniform2f(f,t.u_patternscale_a),u_patternscale_b:new n.Uniform2f(f,t.u_patternscale_b),u_sdfgamma:new n.Uniform1f(f,t.u_sdfgamma),u_image:new n.Uniform1i(f,t.u_image),u_tex_y_a:new n.Uniform1f(f,t.u_tex_y_a),u_tex_y_b:new n.Uniform1f(f,t.u_tex_y_b),u_mix:new n.Uniform1f(f,t.u_mix)}),raster:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_tl_parent:new n.Uniform2f(f,t.u_tl_parent),u_scale_parent:new n.Uniform1f(f,t.u_scale_parent),u_buffer_scale:new n.Uniform1f(f,t.u_buffer_scale),u_fade_t:new n.Uniform1f(f,t.u_fade_t),u_opacity:new n.Uniform1f(f,t.u_opacity),u_image0:new n.Uniform1i(f,t.u_image0),u_image1:new n.Uniform1i(f,t.u_image1),u_brightness_low:new n.Uniform1f(f,t.u_brightness_low),u_brightness_high:new n.Uniform1f(f,t.u_brightness_high),u_saturation_factor:new n.Uniform1f(f,t.u_saturation_factor),u_contrast_factor:new n.Uniform1f(f,t.u_contrast_factor),u_spin_weights:new n.Uniform3f(f,t.u_spin_weights)}),symbolIcon:(f,t)=>({u_is_size_zoom_constant:new n.Uniform1i(f,t.u_is_size_zoom_constant),u_is_size_feature_constant:new n.Uniform1i(f,t.u_is_size_feature_constant),u_size_t:new n.Uniform1f(f,t.u_size_t),u_size:new n.Uniform1f(f,t.u_size),u_camera_to_center_distance:new n.Uniform1f(f,t.u_camera_to_center_distance),u_pitch:new n.Uniform1f(f,t.u_pitch),u_rotate_symbol:new n.Uniform1i(f,t.u_rotate_symbol),u_aspect_ratio:new n.Uniform1f(f,t.u_aspect_ratio),u_fade_change:new n.Uniform1f(f,t.u_fade_change),u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_label_plane_matrix:new n.UniformMatrix4f(f,t.u_label_plane_matrix),u_coord_matrix:new n.UniformMatrix4f(f,t.u_coord_matrix),u_is_text:new n.Uniform1i(f,t.u_is_text),u_pitch_with_map:new n.Uniform1i(f,t.u_pitch_with_map),u_texsize:new n.Uniform2f(f,t.u_texsize),u_texture:new n.Uniform1i(f,t.u_texture)}),symbolSDF:(f,t)=>({u_is_size_zoom_constant:new n.Uniform1i(f,t.u_is_size_zoom_constant),u_is_size_feature_constant:new n.Uniform1i(f,t.u_is_size_feature_constant),u_size_t:new n.Uniform1f(f,t.u_size_t),u_size:new n.Uniform1f(f,t.u_size),u_camera_to_center_distance:new n.Uniform1f(f,t.u_camera_to_center_distance),u_pitch:new n.Uniform1f(f,t.u_pitch),u_rotate_symbol:new n.Uniform1i(f,t.u_rotate_symbol),u_aspect_ratio:new n.Uniform1f(f,t.u_aspect_ratio),u_fade_change:new n.Uniform1f(f,t.u_fade_change),u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_label_plane_matrix:new n.UniformMatrix4f(f,t.u_label_plane_matrix),u_coord_matrix:new n.UniformMatrix4f(f,t.u_coord_matrix),u_is_text:new n.Uniform1i(f,t.u_is_text),u_pitch_with_map:new n.Uniform1i(f,t.u_pitch_with_map),u_texsize:new n.Uniform2f(f,t.u_texsize),u_texture:new n.Uniform1i(f,t.u_texture),u_gamma_scale:new n.Uniform1f(f,t.u_gamma_scale),u_device_pixel_ratio:new n.Uniform1f(f,t.u_device_pixel_ratio),u_is_halo:new n.Uniform1i(f,t.u_is_halo)}),symbolTextAndIcon:(f,t)=>({u_is_size_zoom_constant:new n.Uniform1i(f,t.u_is_size_zoom_constant),u_is_size_feature_constant:new n.Uniform1i(f,t.u_is_size_feature_constant),u_size_t:new n.Uniform1f(f,t.u_size_t),u_size:new n.Uniform1f(f,t.u_size),u_camera_to_center_distance:new n.Uniform1f(f,t.u_camera_to_center_distance),u_pitch:new n.Uniform1f(f,t.u_pitch),u_rotate_symbol:new n.Uniform1i(f,t.u_rotate_symbol),u_aspect_ratio:new n.Uniform1f(f,t.u_aspect_ratio),u_fade_change:new n.Uniform1f(f,t.u_fade_change),u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_label_plane_matrix:new n.UniformMatrix4f(f,t.u_label_plane_matrix),u_coord_matrix:new n.UniformMatrix4f(f,t.u_coord_matrix),u_is_text:new n.Uniform1i(f,t.u_is_text),u_pitch_with_map:new n.Uniform1i(f,t.u_pitch_with_map),u_texsize:new n.Uniform2f(f,t.u_texsize),u_texsize_icon:new n.Uniform2f(f,t.u_texsize_icon),u_texture:new n.Uniform1i(f,t.u_texture),u_texture_icon:new n.Uniform1i(f,t.u_texture_icon),u_gamma_scale:new n.Uniform1f(f,t.u_gamma_scale),u_device_pixel_ratio:new n.Uniform1f(f,t.u_device_pixel_ratio),u_is_halo:new n.Uniform1i(f,t.u_is_halo)}),background:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_opacity:new n.Uniform1f(f,t.u_opacity),u_color:new n.UniformColor(f,t.u_color)}),backgroundPattern:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_opacity:new n.Uniform1f(f,t.u_opacity),u_image:new n.Uniform1i(f,t.u_image),u_pattern_tl_a:new n.Uniform2f(f,t.u_pattern_tl_a),u_pattern_br_a:new n.Uniform2f(f,t.u_pattern_br_a),u_pattern_tl_b:new n.Uniform2f(f,t.u_pattern_tl_b),u_pattern_br_b:new n.Uniform2f(f,t.u_pattern_br_b),u_texsize:new n.Uniform2f(f,t.u_texsize),u_mix:new n.Uniform1f(f,t.u_mix),u_pattern_size_a:new n.Uniform2f(f,t.u_pattern_size_a),u_pattern_size_b:new n.Uniform2f(f,t.u_pattern_size_b),u_scale_a:new n.Uniform1f(f,t.u_scale_a),u_scale_b:new n.Uniform1f(f,t.u_scale_b),u_pixel_coord_upper:new n.Uniform2f(f,t.u_pixel_coord_upper),u_pixel_coord_lower:new n.Uniform2f(f,t.u_pixel_coord_lower),u_tile_units_to_pixels:new n.Uniform1f(f,t.u_tile_units_to_pixels)}),terrain:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_texture:new n.Uniform1i(f,t.u_texture)}),terrainDepth:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix)}),terrainCoords:(f,t)=>({u_matrix:new n.UniformMatrix4f(f,t.u_matrix),u_texture:new n.Uniform1i(f,t.u_texture),u_terrain_coords_id:new n.Uniform1f(f,t.u_terrain_coords_id)})};class $i{constructor(t,s,l){this.context=t;const m=t.gl;this.buffer=m.createBuffer(),this.dynamicDraw=Boolean(l),this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),m.bufferData(m.ELEMENT_ARRAY_BUFFER,s.arrayBuffer,this.dynamicDraw?m.DYNAMIC_DRAW:m.STATIC_DRAW),this.dynamicDraw||delete s.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){const s=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),s.bufferSubData(s.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const hr={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class ci{constructor(t,s,l,m){this.length=s.length,this.attributes=l,this.itemSize=s.bytesPerElement,this.dynamicDraw=m,this.context=t;const b=t.gl;this.buffer=b.createBuffer(),t.bindVertexBuffer.set(this.buffer),b.bufferData(b.ARRAY_BUFFER,s.arrayBuffer,this.dynamicDraw?b.DYNAMIC_DRAW:b.STATIC_DRAW),this.dynamicDraw||delete s.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){if(t.length!==this.length)throw new Error(`Length of new data is ${t.length}, which doesn't match current length of ${this.length}`);const s=this.context.gl;this.bind(),s.bufferSubData(s.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,s){for(let l=0;l<this.attributes.length;l++){const m=s.attributes[this.attributes[l].name];m!==void 0&&t.enableVertexAttribArray(m)}}setVertexAttribPointers(t,s,l){for(let m=0;m<this.attributes.length;m++){const b=this.attributes[m],E=s.attributes[b.name];E!==void 0&&t.vertexAttribPointer(E,b.components,t[hr[b.type]],!1,this.itemSize,b.offset+this.itemSize*(l||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Ai{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Hn extends Ai{getDefault(){return n.Color.transparent}set(t){const s=this.current;(t.r!==s.r||t.g!==s.g||t.b!==s.b||t.a!==s.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Wi extends Ai{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Jr extends Ai{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Or extends Ai{getDefault(){return[!0,!0,!0,!0]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||t[2]!==s[2]||t[3]!==s[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class mo extends Ai{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class rn extends Ai{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class yn extends Ai{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const s=this.current;(t.func!==s.func||t.ref!==s.ref||t.mask!==s.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class $s extends Ai{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||t[2]!==s[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class qs extends Ai{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;t?s.enable(s.STENCIL_TEST):s.disable(s.STENCIL_TEST),this.current=t,this.dirty=!1}}class Ro extends Ai{getDefault(){return[0,1]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class go extends Ai{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;t?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST),this.current=t,this.dirty=!1}}class xs extends Ai{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class _o extends Ai{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;t?s.enable(s.BLEND):s.disable(s.BLEND),this.current=t,this.dirty=!1}}class yo extends Ai{getDefault(){const t=this.gl;return[t.ONE,t.ZERO]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||this.dirty)&&(this.gl.blendFunc(t[0],t[1]),this.current=t,this.dirty=!1)}}class vo extends Ai{getDefault(){return n.Color.transparent}set(t){const s=this.current;(t.r!==s.r||t.g!==s.g||t.b!==s.b||t.a!==s.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class cs extends Ai{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquation(t),this.current=t,this.dirty=!1)}}class Bo extends Ai{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;t?s.enable(s.CULL_FACE):s.disable(s.CULL_FACE),this.current=t,this.dirty=!1}}class As extends Ai{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Ma extends Ai{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}class Uo extends Ai{getDefault(){return null}set(t){(t!==this.current||this.dirty)&&(this.gl.useProgram(t),this.current=t,this.dirty=!1)}}class Ys extends Ai{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class jo extends Ai{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||t[2]!==s[2]||t[3]!==s[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Vo extends Ai{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.bindFramebuffer(s.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class No extends Ai{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.bindRenderbuffer(s.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class bs extends Ai{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.bindTexture(s.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class xo extends Ai{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.bindBuffer(s.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Go extends Ai{getDefault(){return null}set(t){const s=this.gl;s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Xo extends Ai{constructor(t){super(t),this.vao=t.extVertexArrayObject}getDefault(){return null}set(t){this.vao&&(t!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(t),this.current=t,this.dirty=!1)}}class Ms extends Ai{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.pixelStorei(s.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class fa extends Ai{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class Wo extends Ai{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class ks extends Ai{constructor(t,s){super(t),this.context=t,this.parent=s}getDefault(){return null}}class dn extends ks{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const s=this.gl;s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class zn extends ks{set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const s=this.gl;s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class vn{constructor(t,s,l,m){this.context=t,this.width=s,this.height=l;const b=t.gl,E=this.framebuffer=b.createFramebuffer();if(this.colorAttachment=new dn(t,E),m&&(this.depthAttachment=new zn(t,E)),b.checkFramebufferStatus(b.FRAMEBUFFER)!==b.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer is not complete")}destroy(){const t=this.context.gl,s=this.colorAttachment.get();if(s&&t.deleteTexture(s),this.depthAttachment){const l=this.depthAttachment.get();l&&t.deleteRenderbuffer(l)}t.deleteFramebuffer(this.framebuffer)}}class Ji{constructor(t,s,l){this.blendFunction=t,this.blendColor=s,this.mask=l}}Ji.Replace=[1,0],Ji.disabled=new Ji(Ji.Replace,n.Color.transparent,[!1,!1,!1,!1]),Ji.unblended=new Ji(Ji.Replace,n.Color.transparent,[!0,!0,!0,!0]),Ji.alphaBlended=new Ji([1,771],n.Color.transparent,[!0,!0,!0,!0]);class Zn{constructor(t){this.gl=t,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),this.clearColor=new Hn(this),this.clearDepth=new Wi(this),this.clearStencil=new Jr(this),this.colorMask=new Or(this),this.depthMask=new mo(this),this.stencilMask=new rn(this),this.stencilFunc=new yn(this),this.stencilOp=new $s(this),this.stencilTest=new qs(this),this.depthRange=new Ro(this),this.depthTest=new go(this),this.depthFunc=new xs(this),this.blend=new _o(this),this.blendFunc=new yo(this),this.blendColor=new vo(this),this.blendEquation=new cs(this),this.cullFace=new Bo(this),this.cullFaceSide=new As(this),this.frontFace=new Ma(this),this.program=new Uo(this),this.activeTexture=new Ys(this),this.viewport=new jo(this),this.bindFramebuffer=new Vo(this),this.bindRenderbuffer=new No(this),this.bindTexture=new bs(this),this.bindVertexBuffer=new xo(this),this.bindElementBuffer=new Go(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new Xo(this),this.pixelStoreUnpack=new Ms(this),this.pixelStoreUnpackPremultiplyAlpha=new fa(this),this.pixelStoreUnpackFlipY=new Wo(this),this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureHalfFloat=t.getExtension("OES_texture_half_float"),this.extTextureHalfFloat&&(t.getExtension("OES_texture_half_float_linear"),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float")),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,s){return new $i(this,t,s)}createVertexBuffer(t,s,l){return new ci(this,t,s,l)}createRenderbuffer(t,s,l){const m=this.gl,b=m.createRenderbuffer();return this.bindRenderbuffer.set(b),m.renderbufferStorage(m.RENDERBUFFER,t,s,l),this.bindRenderbuffer.set(null),b}createFramebuffer(t,s,l){return new vn(this,t,s,l)}clear({color:t,depth:s}){const l=this.gl;let m=0;t&&(m|=l.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set([!0,!0,!0,!0])),s!==void 0&&(m|=l.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(s),this.depthMask.set(!0)),l.clear(m)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){h(t.blendFunction,Ji.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor)),this.colorMask.set(t.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class Mi{constructor(t,s,l){this.func=t,this.mask=s,this.range=l}}Mi.ReadOnly=!1,Mi.ReadWrite=!0,Mi.disabled=new Mi(519,Mi.ReadOnly,[0,1]);const Ui=7680;class Yi{constructor(t,s,l,m,b,E){this.test=t,this.ref=s,this.mask=l,this.fail=m,this.depthFail=b,this.pass=E}}Yi.disabled=new Yi({func:519,mask:0},0,0,Ui,Ui,Ui);class ar{constructor(t,s,l){this.enable=t,this.mode=s,this.frontFace=l}}let Ds;function Os(f,t,s,l,m,b,E){const D=f.context,L=D.gl,R=f.useProgram("collisionBox"),V=[];let X=0,H=0;for(let he=0;he<l.length;he++){const Ge=l[he],Fe=t.getTile(Ge),et=Fe.getBucket(s);if(!et)continue;let it=Ge.posMatrix;m[0]===0&&m[1]===0||(it=f.translatePosMatrix(Ge.posMatrix,Fe,m,b));const bt=E?et.textCollisionBox:et.iconCollisionBox,Ze=et.collisionCircleArray;if(Ze.length>0){const Vt=n.create(),Dt=it;n.mul(Vt,et.placementInvProjMatrix,f.transform.glCoordMatrix),n.mul(Vt,Vt,et.placementViewportMatrix),V.push({circleArray:Ze,circleOffset:H,transform:Dt,invTransform:Vt,coord:Ge}),X+=Ze.length/4,H=X}bt&&R.draw(D,L.LINES,Mi.disabled,Yi.disabled,f.colorModeForRenderPass(),ar.disabled,T(it,f.transform,Fe),f.style.terrain&&f.style.terrain.getTerrainData(Ge),s.id,bt.layoutVertexBuffer,bt.indexBuffer,bt.segments,null,f.transform.zoom,null,null,bt.collisionVertexBuffer)}if(!E||!V.length)return;const le=f.useProgram("collisionCircle"),ne=new n.CollisionCircleLayoutArray;ne.resize(4*X),ne._trim();let ae=0;for(const he of V)for(let Ge=0;Ge<he.circleArray.length/4;Ge++){const Fe=4*Ge,et=he.circleArray[Fe+0],it=he.circleArray[Fe+1],bt=he.circleArray[Fe+2],Ze=he.circleArray[Fe+3];ne.emplace(ae++,et,it,bt,Ze,0),ne.emplace(ae++,et,it,bt,Ze,1),ne.emplace(ae++,et,it,bt,Ze,2),ne.emplace(ae++,et,it,bt,Ze,3)}(!Ds||Ds.length<2*X)&&(Ds=function(he){const Ge=2*he,Fe=new n.QuadTriangleArray;Fe.resize(Ge),Fe._trim();for(let et=0;et<Ge;et++){const it=6*et;Fe.uint16[it+0]=4*et+0,Fe.uint16[it+1]=4*et+1,Fe.uint16[it+2]=4*et+2,Fe.uint16[it+3]=4*et+2,Fe.uint16[it+4]=4*et+3,Fe.uint16[it+5]=4*et+0}return Fe}(X));const xe=D.createIndexBuffer(Ds,!0),Ee=D.createVertexBuffer(ne,n.collisionCircleLayout.members,!0);for(const he of V){const Ge={u_matrix:he.transform,u_inv_matrix:he.invTransform,u_camera_to_center_distance:(Oe=f.transform).cameraToCenterDistance,u_viewport_size:[Oe.width,Oe.height]};le.draw(D,L.TRIANGLES,Mi.disabled,Yi.disabled,f.colorModeForRenderPass(),ar.disabled,Ge,f.style.terrain&&f.style.terrain.getTerrainData(he.coord),s.id,Ee,xe,n.SegmentVector.simpleSegment(0,2*he.circleOffset,he.circleArray.length,he.circleArray.length/2),null,f.transform.zoom,null,null,null)}var Oe;Ee.destroy(),xe.destroy()}ar.disabled=new ar(!1,1029,2305),ar.backCCW=new ar(!0,1029,2305);const ka=n.identity(new Float32Array(16));function pa(f,t,s,l,m,b){const{horizontalAlign:E,verticalAlign:D}=n.getAnchorAlignment(f),L=-(E-.5)*t,R=-(D-.5)*s,V=n.evaluateVariableOffset(f,l);return new n.pointGeometry((L/m+V[0])*b,(R/m+V[1])*b)}function $o(f,t,s,l,m,b,E,D,L,R,V){const X=f.text.placedSymbolArray,H=f.text.dynamicLayoutVertexArray,le=f.icon.dynamicLayoutVertexArray,ne={};H.clear();for(let ae=0;ae<X.length;ae++){const xe=X.get(ae),Ee=f.allowVerticalPlacement&&!xe.placedOrientation,Oe=xe.hidden||!xe.crossTileID||Ee?null:l[xe.crossTileID];if(Oe){const he=new n.pointGeometry(xe.anchorX,xe.anchorY),Ge=ri(he,s?E:b,V),Fe=Ei(m.cameraToCenterDistance,Ge.signedDistanceFromCamera);let et=n.evaluateSizeForFeature(f.textSizeData,L,xe)*Fe/n.ONE_EM;s&&(et*=f.tilePixelRatio/D);const{width:it,height:bt,anchor:Ze,textOffset:Vt,textBoxScale:Dt}=Oe,Wt=pa(Ze,it,bt,Vt,Dt,et),Si=s?ri(he.add(Wt),b,V).point:Ge.point.add(t?Wt.rotate(-m.angle):Wt),Pi=f.allowVerticalPlacement&&xe.placedOrientation===n.WritingMode.vertical?Math.PI/2:0;for(let hi=0;hi<xe.numGlyphs;hi++)n.addDynamicAttributes(H,Si,Pi);R&&xe.associatedIconIndex>=0&&(ne[xe.associatedIconIndex]={shiftedAnchor:Si,angle:Pi})}else yi(xe.numGlyphs,H)}if(R){le.clear();const ae=f.icon.placedSymbolArray;for(let xe=0;xe<ae.length;xe++){const Ee=ae.get(xe);if(Ee.hidden)yi(Ee.numGlyphs,le);else{const Oe=ne[xe];if(Oe)for(let he=0;he<Ee.numGlyphs;he++)n.addDynamicAttributes(le,Oe.shiftedAnchor,Oe.angle);else yi(Ee.numGlyphs,le)}}f.icon.dynamicLayoutVertexBuffer.updateData(le)}f.text.dynamicLayoutVertexBuffer.updateData(H)}function bo(f,t,s){return s.iconsInText&&t?"symbolTextAndIcon":f?"symbolSDF":"symbolIcon"}function Kn(f,t,s,l,m,b,E,D,L,R,V,X){const H=f.context,le=H.gl,ne=f.transform,ae=D==="map",xe=L==="map",Ee=D!=="viewport"&&s.layout.get("symbol-placement")!=="point",Oe=ae&&!xe&&!Ee,he=!s.layout.get("symbol-sort-key").isConstant();let Ge=!1;const Fe=f.depthModeForSublayer(0,Mi.ReadOnly),et=s.layout.get("text-variable-anchor"),it=[];for(const bt of l){const Ze=t.getTile(bt),Vt=Ze.getBucket(s);if(!Vt)continue;const Dt=m?Vt.text:Vt.icon;if(!Dt||!Dt.segments.get().length)continue;const Wt=Dt.programConfigurations.get(s.id),Si=m||Vt.sdfIcons,Pi=m?Vt.textSizeData:Vt.iconSizeData,hi=xe||ne.pitch!==0,er=f.useProgram(bo(Si,m,Vt),Wt),tr=n.evaluateSizeForZoom(Pi,ne.zoom),Ni=f.style.terrain&&f.style.terrain.getTerrainData(bt);let Gi,ir,Wr,ms,ts=[0,0],gs=null;if(m){if(ir=Ze.glyphAtlasTexture,Wr=le.LINEAR,Gi=Ze.glyphAtlasTexture.size,Vt.iconsInText){ts=Ze.imageAtlasTexture.size,gs=Ze.imageAtlasTexture;const Gn=Pi.kind==="composite"||Pi.kind==="camera";ms=hi||f.options.rotating||f.options.zooming||Gn?le.LINEAR:le.NEAREST}}else{const Gn=s.layout.get("icon-size").constantOr(0)!==1||Vt.iconsNeedLinear;ir=Ze.imageAtlasTexture,Wr=Si||f.options.rotating||f.options.zooming||Gn||hi?le.LINEAR:le.NEAREST,Gi=Ze.imageAtlasTexture.size}const Ns=lr(Ze,1,f.transform.zoom),Nn=Ri(bt.posMatrix,xe,ae,f.transform,Ns),wn=Zi(bt.posMatrix,xe,ae,f.transform,Ns),Ss=et&&Vt.hasTextData(),ga=s.layout.get("icon-text-fit")!=="none"&&Ss&&Vt.hasIconData();if(Ee){const Gn=f.style.terrain?(ja,Po)=>f.style.terrain.getElevation(bt,ja,Po):null,io=s.layout.get("text-rotation-alignment")==="map";fr(Vt,bt.posMatrix,f,m,Nn,wn,xe,R,io,Gn)}const Rr=f.translatePosMatrix(bt.posMatrix,Ze,b,E),ki=Ee||m&&et||ga?ka:Nn,Hi=f.translatePosMatrix(wn,Ze,b,E,!0),$r=Si&&s.paint.get(m?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let qr;qr=Si?Vt.iconsInText?Cr(Pi.kind,tr,Oe,xe,f,Rr,ki,Hi,Gi,ts):_i(Pi.kind,tr,Oe,xe,f,Rr,ki,Hi,m,Gi,!0):li(Pi.kind,tr,Oe,xe,f,Rr,ki,Hi,m,Gi);const vr={program:er,buffers:Dt,uniformValues:qr,atlasTexture:ir,atlasTextureIcon:gs,atlasInterpolation:Wr,atlasInterpolationIcon:ms,isSDF:Si,hasHalo:$r};if(he&&Vt.canOverlap){Ge=!0;const Gn=Dt.segments.get();for(const io of Gn)it.push({segments:new n.SegmentVector([io]),sortKey:io.sortKey,state:vr,terrainData:Ni})}else it.push({segments:Dt.segments,sortKey:0,state:vr,terrainData:Ni})}Ge&&it.sort((bt,Ze)=>bt.sortKey-Ze.sortKey);for(const bt of it){const Ze=bt.state;if(H.activeTexture.set(le.TEXTURE0),Ze.atlasTexture.bind(Ze.atlasInterpolation,le.CLAMP_TO_EDGE),Ze.atlasTextureIcon&&(H.activeTexture.set(le.TEXTURE1),Ze.atlasTextureIcon&&Ze.atlasTextureIcon.bind(Ze.atlasInterpolationIcon,le.CLAMP_TO_EDGE)),Ze.isSDF){const Vt=Ze.uniformValues;Ze.hasHalo&&(Vt.u_is_halo=1,Hs(Ze.buffers,bt.segments,s,f,Ze.program,Fe,V,X,Vt,bt.terrainData)),Vt.u_is_halo=0}Hs(Ze.buffers,bt.segments,s,f,Ze.program,Fe,V,X,Ze.uniformValues,bt.terrainData)}}function Hs(f,t,s,l,m,b,E,D,L,R){const V=l.context;m.draw(V,V.gl.TRIANGLES,b,E,D,ar.disabled,L,R,s.id,f.layoutVertexBuffer,f.indexBuffer,t,s.paint,l.transform.zoom,f.programConfigurations.get(s.id),f.dynamicLayoutVertexBuffer,f.opacityVertexBuffer)}function xn(f,t,s,l,m,b,E){const D=f.context.gl,L=s.paint.get("fill-pattern"),R=L&&L.constantOr(1),V=s.getCrossfadeParameters();let X,H,le,ne,ae;E?(H=R&&!s.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",X=D.LINES):(H=R?"fillPattern":"fill",X=D.TRIANGLES);for(const xe of l){const Ee=t.getTile(xe);if(R&&!Ee.patternsLoaded())continue;const Oe=Ee.getBucket(s);if(!Oe)continue;const he=Oe.programConfigurations.get(s.id),Ge=f.useProgram(H,he),Fe=f.style.terrain&&f.style.terrain.getTerrainData(xe);R&&(f.context.activeTexture.set(D.TEXTURE0),Ee.imageAtlasTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),he.updatePaintBuffers(V));const et=L.constantOr(null);if(et&&Ee.imageAtlas){const Ze=Ee.imageAtlas,Vt=Ze.patternPositions[et.to.toString()],Dt=Ze.patternPositions[et.from.toString()];Vt&&Dt&&he.setConstantPatternPositions(Vt,Dt)}const it=Fe?xe:null,bt=f.translatePosMatrix(it?it.posMatrix:xe.posMatrix,Ee,s.paint.get("fill-translate"),s.paint.get("fill-translate-anchor"));if(E){ne=Oe.indexBuffer2,ae=Oe.segments2;const Ze=[D.drawingBufferWidth,D.drawingBufferHeight];le=H==="fillOutlinePattern"&&R?da(bt,f,V,Ee,Ze):ua(bt,Ze)}else ne=Oe.indexBuffer,ae=Oe.segments,le=R?zo(bt,f,V,Ee):po(bt);Ge.draw(f.context,X,m,f.stencilModeForClipping(xe),b,ar.disabled,le,Fe,s.id,Oe.layoutVertexBuffer,ne,ae,s.paint,f.transform.zoom,he)}}function Zs(f,t,s,l,m,b,E){const D=f.context,L=D.gl,R=s.paint.get("fill-extrusion-pattern"),V=R.constantOr(1),X=s.getCrossfadeParameters(),H=s.paint.get("fill-extrusion-opacity");for(const le of l){const ne=t.getTile(le),ae=ne.getBucket(s);if(!ae)continue;const xe=f.style.terrain&&f.style.terrain.getTerrainData(le),Ee=ae.programConfigurations.get(s.id),Oe=f.useProgram(V?"fillExtrusionPattern":"fillExtrusion",Ee);V&&(f.context.activeTexture.set(L.TEXTURE0),ne.imageAtlasTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),Ee.updatePaintBuffers(X));const he=R.constantOr(null);if(he&&ne.imageAtlas){const it=ne.imageAtlas,bt=it.patternPositions[he.to.toString()],Ze=it.patternPositions[he.from.toString()];bt&&Ze&&Ee.setConstantPatternPositions(bt,Ze)}const Ge=f.translatePosMatrix(le.posMatrix,ne,s.paint.get("fill-extrusion-translate"),s.paint.get("fill-extrusion-translate-anchor")),Fe=s.paint.get("fill-extrusion-vertical-gradient"),et=V?ha(Ge,f,Fe,H,le,X,ne):Lo(Ge,f,Fe,H);Oe.draw(D,D.gl.TRIANGLES,m,b,E,ar.backCCW,et,xe,s.id,ae.layoutVertexBuffer,ae.indexBuffer,ae.segments,s.paint,f.transform.zoom,Ee,f.style.terrain&&ae.centroidVertexBuffer)}}function Jn(f,t,s,l,m,b,E){const D=f.context,L=D.gl,R=s.fbo;if(!R)return;const V=f.useProgram("hillshade"),X=f.style.terrain&&f.style.terrain.getTerrainData(t);D.activeTexture.set(L.TEXTURE0),L.bindTexture(L.TEXTURE_2D,R.colorAttachment.get()),V.draw(D,L.TRIANGLES,m,b,E,ar.disabled,((H,le,ne,ae)=>{const xe=ne.paint.get("hillshade-shadow-color"),Ee=ne.paint.get("hillshade-highlight-color"),Oe=ne.paint.get("hillshade-accent-color");let he=ne.paint.get("hillshade-illumination-direction")*(Math.PI/180);ne.paint.get("hillshade-illumination-anchor")==="viewport"&&(he-=H.transform.angle);const Ge=!H.options.moving;return{u_matrix:ae?ae.posMatrix:H.transform.calculatePosMatrix(le.tileID.toUnwrapped(),Ge),u_image:0,u_latrange:Le(0,le.tileID),u_light:[ne.paint.get("hillshade-exaggeration"),he],u_shadow:xe,u_highlight:Ee,u_accent:Oe}})(f,s,l,X?t:null),X,l.id,f.rasterBoundsBuffer,f.quadTriangleIndexBuffer,f.rasterBoundsSegments)}function qo(f,t,s,l,m,b){const E=f.context,D=E.gl,L=t.dem;if(L&&L.data){const R=L.dim,V=L.stride,X=L.getPixels();if(E.activeTexture.set(D.TEXTURE1),E.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||f.getTileTexture(V),t.demTexture){const le=t.demTexture;le.update(X,{premultiply:!1}),le.bind(D.NEAREST,D.CLAMP_TO_EDGE)}else t.demTexture=new _(E,X,D.RGBA,{premultiply:!1}),t.demTexture.bind(D.NEAREST,D.CLAMP_TO_EDGE);E.activeTexture.set(D.TEXTURE0);let H=t.fbo;if(!H){const le=new _(E,{width:R,height:R,data:null},D.RGBA);le.bind(D.LINEAR,D.CLAMP_TO_EDGE),H=t.fbo=E.createFramebuffer(R,R,!0),H.colorAttachment.set(le.texture)}E.bindFramebuffer.set(H.framebuffer),E.viewport.set([0,0,R,R]),f.useProgram("hillshadePrepare").draw(E,D.TRIANGLES,l,m,b,ar.disabled,((le,ne)=>{const ae=ne.stride,xe=n.create();return n.ortho(xe,0,n.EXTENT,-n.EXTENT,0,0,1),n.translate(xe,xe,[0,-n.EXTENT,0]),{u_matrix:xe,u_image:1,u_dimension:[ae,ae],u_zoom:le.overscaledZ,u_unpack:ne.getUnpackVector()}})(t.tileID,L),null,s.id,f.rasterBoundsBuffer,f.quadTriangleIndexBuffer,f.rasterBoundsSegments),t.needsHillshadePrepare=!1}}function wo(f,t,s,l,m,b){const E=l.paint.get("raster-fade-duration");if(!b&&E>0){const D=n.exported.now(),L=(D-f.timeAdded)/E,R=t?(D-t.timeAdded)/E:-1,V=s.getSource(),X=m.coveringZoomLevel({tileSize:V.tileSize,roundZoom:V.roundZoom}),H=!t||Math.abs(t.tileID.overscaledZ-X)>Math.abs(f.tileID.overscaledZ-X),le=H&&f.refreshedUponExpiration?1:n.clamp(H?L:1-R,0,1);return f.refreshedUponExpiration&&L>=1&&(f.refreshedUponExpiration=!1),t?{opacity:1,mix:1-le}:{opacity:le,mix:0}}return{opacity:1,mix:0}}const ws=new n.Color(1,0,0,1),fn=new n.Color(0,1,0,1),Yo=new n.Color(0,0,1,1),Co=new n.Color(1,0,1,1),Ho=new n.Color(0,1,1,1);function Pn(f,t,s,l){zs(f,0,t+s/2,f.transform.width,s,l)}function Ls(f,t,s,l){zs(f,t-s/2,0,s,f.transform.height,l)}function zs(f,t,s,l,m,b){const E=f.context,D=E.gl;D.enable(D.SCISSOR_TEST),D.scissor(t*f.pixelRatio,s*f.pixelRatio,l*f.pixelRatio,m*f.pixelRatio),E.clear({color:b}),D.disable(D.SCISSOR_TEST)}function Ae(f,t,s){const l=f.context,m=l.gl,b=s.posMatrix,E=f.useProgram("debug"),D=Mi.disabled,L=Yi.disabled,R=f.colorModeForRenderPass(),V="$debug",X=f.style.terrain&&f.style.terrain.getTerrainData(s);l.activeTexture.set(m.TEXTURE0),f.emptyTexture.bind(m.LINEAR,m.CLAMP_TO_EDGE);const H=t.getTileByID(s.key).latestRawTileData,le=Math.floor((H&&H.byteLength||0)/1024),ne=t.getTile(s).tileSize,ae=512/Math.min(ne,512)*(s.overscaledZ/f.transform.zoom)*.5;let xe=s.canonical.toString();s.overscaledZ!==s.canonical.z&&(xe+=` => ${s.overscaledZ}`),function(Ee,Oe){Ee.initDebugOverlayCanvas();const he=Ee.debugOverlayCanvas,Ge=Ee.context.gl,Fe=Ee.debugOverlayCanvas.getContext("2d");Fe.clearRect(0,0,he.width,he.height),Fe.shadowColor="white",Fe.shadowBlur=2,Fe.lineWidth=1.5,Fe.strokeStyle="white",Fe.textBaseline="top",Fe.font="bold 36px Open Sans, sans-serif",Fe.fillText(Oe,5,5),Fe.strokeText(Oe,5,5),Ee.debugOverlayTexture.update(he),Ee.debugOverlayTexture.bind(Ge.LINEAR,Ge.CLAMP_TO_EDGE)}(f,`${xe} ${le}kB`),E.draw(l,m.TRIANGLES,D,L,Ji.alphaBlended,ar.disabled,z(b,n.Color.transparent,ae),null,V,f.debugBuffer,f.quadTriangleIndexBuffer,f.debugSegments),E.draw(l,m.LINE_STRIP,D,L,R,ar.disabled,z(b,n.Color.red),X,V,f.debugBuffer,f.tileBorderIndexBuffer,f.debugSegments)}function Ke(f,t,s){const l=f.context,m=l.gl,b=f.colorModeForRenderPass(),E=new Mi(m.LEQUAL,Mi.ReadWrite,f.depthRangeFor3D),D=f.useProgram("terrain"),L=t.getTerrainMesh(),R=t.getTerrainData(s.tileID);l.bindFramebuffer.set(null),l.viewport.set([0,0,f.width,f.height]),l.activeTexture.set(m.TEXTURE0),m.bindTexture(m.TEXTURE_2D,t.getRTTFramebuffer().colorAttachment.get());const V=f.transform.calculatePosMatrix(s.tileID.toUnwrapped());D.draw(l,m.TRIANGLES,E,Yi.disabled,b,ar.backCCW,{u_matrix:V,u_texture:0},R,"terrain",L.vertexBuffer,L.indexBuffer,L.segments)}function Lt(f,t,s,l){const m=f.context,b=s.tileSize*t.qualityFactor;s.textures[l]||(s.textures[l]=f.getTileTexture(b)||new _(m,{width:b,height:b,data:null},m.gl.RGBA),s.textures[l].bind(m.gl.LINEAR,m.gl.CLAMP_TO_EDGE),l===0&&t.sourceCache.renderHistory.unshift(s.tileID.key));const E=t.getRTTFramebuffer();E.colorAttachment.set(s.textures[l].texture),m.bindFramebuffer.set(E.framebuffer),m.viewport.set([0,0,b,b])}class fi{constructor(t){this._coordsDescendingInv={},this._coordsDescendingInvStr={},this.painter=t,this._renderToTexture={background:!0,fill:!0,line:!0,raster:!0},this._coordsDescendingInv={},this._coordsDescendingInvStr={},this._stacks=[],this._prevType=null,this._rerender={},this._renderableTiles=t.style.terrain.sourceCache.getRenderableTiles(),this._init()}_init(){const t=this.painter.style,s=t.terrain;for(const l in t.sourceCaches){this._coordsDescendingInv[l]={};const m=t.sourceCaches[l].getVisibleCoordinates();for(const b of m){const E=s.sourceCache.getTerrainCoords(b);for(const D in E)this._coordsDescendingInv[l][D]||(this._coordsDescendingInv[l][D]=[]),this._coordsDescendingInv[l][D].push(E[D])}}for(const l of t._order){const m=t._layers[l],b=m.source;if(this._renderToTexture[m.type]&&!this._coordsDescendingInvStr[b]){this._coordsDescendingInvStr[b]={};for(const E in this._coordsDescendingInv[b])this._coordsDescendingInvStr[b][E]=this._coordsDescendingInv[b][E].map(D=>D.key).sort().join()}}return this._renderableTiles.forEach(l=>{for(const m in this._coordsDescendingInvStr){const b=this._coordsDescendingInvStr[m][l.tileID.key];b&&b!==l.textureCoords[m]&&l.clearTextures(this.painter),s.needsRerender(m,l.tileID)&&l.clearTextures(this.painter)}this._rerender[l.tileID.key]=!l.textures.length}),s.clearRerenderCache(),s.sourceCache.removeOutdated(this.painter),this}renderLayer(t){const s=t.type,l=this.painter,m=l.style._order,b=l.currentLayer,E=b+1===m.length;if(this._renderToTexture[s]&&(this._prevType&&this._renderToTexture[this._prevType]||this._stacks.push([]),this._prevType=s,this._stacks[this._stacks.length-1].push(m[b]),!E))return!0;if(this._renderToTexture[this._prevType]||s==="hillshade"||this._renderToTexture[s]&&E){this._prevType=s;const D=this._stacks.length-1,L=this._stacks[D]||[];for(const R of this._renderableTiles){if(Lt(l,l.style.terrain,R,D),this._rerender[R.tileID.key]){l.context.clear({color:n.Color.transparent});for(let V=0;V<L.length;V++){const X=l.style._layers[L[V]],H=X.source?this._coordsDescendingInv[X.source][R.tileID.key]:[R.tileID];l._renderTileClippingMasks(X,H),l.renderLayer(l,l.style.sourceCaches[X.source],X,H),X.source&&(R.textureCoords[X.source]=this._coordsDescendingInvStr[X.source][R.tileID.key])}}Ke(l,l.style.terrain,R)}if(s==="hillshade"){this._stacks.push([m[b]]);for(const R of this._renderableTiles){const V=this._coordsDescendingInv[t.source][R.tileID.key];Lt(l,l.style.terrain,R,this._stacks.length-1),l.context.clear({color:n.Color.transparent}),l._renderTileClippingMasks(t,V),l.renderLayer(l,l.style.sourceCaches[t.source],t,V),Ke(l,l.style.terrain,R)}return!0}return this._renderToTexture[s]}return!1}}const Qi={symbol:function(f,t,s,l,m){if(f.renderPass!=="translucent")return;const b=Yi.disabled,E=f.colorModeForRenderPass();s.layout.get("text-variable-anchor")&&function(D,L,R,V,X,H,le){const ne=L.transform,ae=X==="map",xe=H==="map";for(const Ee of D){const Oe=V.getTile(Ee),he=Oe.getBucket(R);if(!he||!he.text||!he.text.segments.get().length)continue;const Ge=n.evaluateSizeForZoom(he.textSizeData,ne.zoom),Fe=lr(Oe,1,L.transform.zoom),et=Ri(Ee.posMatrix,xe,ae,L.transform,Fe),it=R.layout.get("icon-text-fit")!=="none"&&he.hasIconData();if(Ge){const bt=Math.pow(2,ne.zoom-Oe.tileID.overscaledZ);$o(he,ae,xe,le,ne,et,Ee.posMatrix,bt,Ge,it,L.style.terrain?(Ze,Vt)=>L.style.terrain.getElevation(Ee,Ze,Vt):null)}}}(l,f,s,t,s.layout.get("text-rotation-alignment"),s.layout.get("text-pitch-alignment"),m),s.paint.get("icon-opacity").constantOr(1)!==0&&Kn(f,t,s,l,!1,s.paint.get("icon-translate"),s.paint.get("icon-translate-anchor"),s.layout.get("icon-rotation-alignment"),s.layout.get("icon-pitch-alignment"),s.layout.get("icon-keep-upright"),b,E),s.paint.get("text-opacity").constantOr(1)!==0&&Kn(f,t,s,l,!0,s.paint.get("text-translate"),s.paint.get("text-translate-anchor"),s.layout.get("text-rotation-alignment"),s.layout.get("text-pitch-alignment"),s.layout.get("text-keep-upright"),b,E),t.map.showCollisionBoxes&&(Os(f,t,s,l,s.paint.get("text-translate"),s.paint.get("text-translate-anchor"),!0),Os(f,t,s,l,s.paint.get("icon-translate"),s.paint.get("icon-translate-anchor"),!1))},circle:function(f,t,s,l){if(f.renderPass!=="translucent")return;const m=s.paint.get("circle-opacity"),b=s.paint.get("circle-stroke-width"),E=s.paint.get("circle-stroke-opacity"),D=!s.layout.get("circle-sort-key").isConstant();if(m.constantOr(1)===0&&(b.constantOr(1)===0||E.constantOr(1)===0))return;const L=f.context,R=L.gl,V=f.depthModeForSublayer(0,Mi.ReadOnly),X=Yi.disabled,H=f.colorModeForRenderPass(),le=[];for(let ne=0;ne<l.length;ne++){const ae=l[ne],xe=t.getTile(ae),Ee=xe.getBucket(s);if(!Ee)continue;const Oe=Ee.programConfigurations.get(s.id),he=f.useProgram("circle",Oe),Ge=Ee.layoutVertexBuffer,Fe=Ee.indexBuffer,et=f.style.terrain&&f.style.terrain.getTerrainData(ae),it={programConfiguration:Oe,program:he,layoutVertexBuffer:Ge,indexBuffer:Fe,uniformValues:Fo(f,ae,xe,s),terrainData:et};if(D){const bt=Ee.segments.get();for(const Ze of bt)le.push({segments:new n.SegmentVector([Ze]),sortKey:Ze.sortKey,state:it})}else le.push({segments:Ee.segments,sortKey:0,state:it})}D&&le.sort((ne,ae)=>ne.sortKey-ae.sortKey);for(const ne of le){const{programConfiguration:ae,program:xe,layoutVertexBuffer:Ee,indexBuffer:Oe,uniformValues:he,terrainData:Ge}=ne.state;xe.draw(L,R.TRIANGLES,V,X,H,ar.disabled,he,Ge,s.id,Ee,Oe,ne.segments,s.paint,f.transform.zoom,ae)}},heatmap:function(f,t,s,l){if(s.paint.get("heatmap-opacity")!==0)if(f.renderPass==="offscreen"){const m=f.context,b=m.gl,E=Yi.disabled,D=new Ji([b.ONE,b.ONE],n.Color.transparent,[!0,!0,!0,!0]);(function(L,R,V){const X=L.gl;L.activeTexture.set(X.TEXTURE1),L.viewport.set([0,0,R.width/4,R.height/4]);let H=V.heatmapFbo;if(H)X.bindTexture(X.TEXTURE_2D,H.colorAttachment.get()),L.bindFramebuffer.set(H.framebuffer);else{const le=X.createTexture();X.bindTexture(X.TEXTURE_2D,le),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_WRAP_S,X.CLAMP_TO_EDGE),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_WRAP_T,X.CLAMP_TO_EDGE),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_MIN_FILTER,X.LINEAR),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_MAG_FILTER,X.LINEAR),H=V.heatmapFbo=L.createFramebuffer(R.width/4,R.height/4,!1),function(ne,ae,xe,Ee){const Oe=ne.gl;Oe.texImage2D(Oe.TEXTURE_2D,0,Oe.RGBA,ae.width/4,ae.height/4,0,Oe.RGBA,ne.extRenderToTextureHalfFloat?ne.extTextureHalfFloat.HALF_FLOAT_OES:Oe.UNSIGNED_BYTE,null),Ee.colorAttachment.set(xe)}(L,R,le,H)}})(m,f,s),m.clear({color:n.Color.transparent});for(let L=0;L<l.length;L++){const R=l[L];if(t.hasRenderableParent(R))continue;const V=t.getTile(R),X=V.getBucket(s);if(!X)continue;const H=X.programConfigurations.get(s.id),le=f.useProgram("heatmap",H),{zoom:ne}=f.transform;le.draw(m,b.TRIANGLES,Mi.disabled,E,D,ar.disabled,ye(R.posMatrix,V,ne,s.paint.get("heatmap-intensity")),null,s.id,X.layoutVertexBuffer,X.indexBuffer,X.segments,s.paint,f.transform.zoom,H)}m.viewport.set([0,0,f.width,f.height])}else f.renderPass==="translucent"&&(f.context.setColorMode(f.colorModeForRenderPass()),function(m,b){const E=m.context,D=E.gl,L=b.heatmapFbo;if(!L)return;E.activeTexture.set(D.TEXTURE0),D.bindTexture(D.TEXTURE_2D,L.colorAttachment.get()),E.activeTexture.set(D.TEXTURE1);let R=b.colorRampTexture;R||(R=b.colorRampTexture=new _(E,b.colorRamp,D.RGBA)),R.bind(D.LINEAR,D.CLAMP_TO_EDGE),m.useProgram("heatmapTexture").draw(E,D.TRIANGLES,Mi.disabled,Yi.disabled,m.colorModeForRenderPass(),ar.disabled,((V,X,H,le)=>{const ne=n.create();n.ortho(ne,0,V.width,V.height,0,0,1);const ae=V.context.gl;return{u_matrix:ne,u_world:[ae.drawingBufferWidth,ae.drawingBufferHeight],u_image:0,u_color_ramp:1,u_opacity:X.paint.get("heatmap-opacity")}})(m,b),null,b.id,m.viewportBuffer,m.quadTriangleIndexBuffer,m.viewportSegments,b.paint,m.transform.zoom)}(f,s))},line:function(f,t,s,l){if(f.renderPass!=="translucent")return;const m=s.paint.get("line-opacity"),b=s.paint.get("line-width");if(m.constantOr(1)===0||b.constantOr(1)===0)return;const E=f.depthModeForSublayer(0,Mi.ReadOnly),D=f.colorModeForRenderPass(),L=s.paint.get("line-dasharray"),R=s.paint.get("line-pattern"),V=R.constantOr(1),X=s.paint.get("line-gradient"),H=s.getCrossfadeParameters(),le=V?"linePattern":L?"lineSDF":X?"lineGradient":"line",ne=f.context,ae=ne.gl;let xe=!0;for(const Ee of l){const Oe=t.getTile(Ee);if(V&&!Oe.patternsLoaded())continue;const he=Oe.getBucket(s);if(!he)continue;const Ge=he.programConfigurations.get(s.id),Fe=f.context.program.get(),et=f.useProgram(le,Ge),it=xe||et.program!==Fe,bt=f.style.terrain&&f.style.terrain.getTerrainData(Ee),Ze=R.constantOr(null);if(Ze&&Oe.imageAtlas){const Wt=Oe.imageAtlas,Si=Wt.patternPositions[Ze.to.toString()],Pi=Wt.patternPositions[Ze.from.toString()];Si&&Pi&&Ge.setConstantPatternPositions(Si,Pi)}const Vt=bt?Ee:null,Dt=V?wt(f,Oe,s,H,Vt):L?xt(f,Oe,s,L,H,Vt):X?ke(f,Oe,s,he.lineClipsArray.length,Vt):Te(f,Oe,s,Vt);if(V)ne.activeTexture.set(ae.TEXTURE0),Oe.imageAtlasTexture.bind(ae.LINEAR,ae.CLAMP_TO_EDGE),Ge.updatePaintBuffers(H);else if(L&&(it||f.lineAtlas.dirty))ne.activeTexture.set(ae.TEXTURE0),f.lineAtlas.bind(ne);else if(X){const Wt=he.gradients[s.id];let Si=Wt.texture;if(s.gradientVersion!==Wt.version){let Pi=256;if(s.stepInterpolant){const hi=t.getSource().maxzoom,er=Ee.canonical.z===hi?Math.ceil(1<<f.transform.maxZoom-Ee.canonical.z):1;Pi=n.clamp(n.nextPowerOfTwo(he.maxLineLength/n.EXTENT*1024*er),256,ne.maxTextureSize)}Wt.gradient=n.renderColorRamp({expression:s.gradientExpression(),evaluationKey:"lineProgress",resolution:Pi,image:Wt.gradient||void 0,clips:he.lineClipsArray}),Wt.texture?Wt.texture.update(Wt.gradient):Wt.texture=new _(ne,Wt.gradient,ae.RGBA),Wt.version=s.gradientVersion,Si=Wt.texture}ne.activeTexture.set(ae.TEXTURE0),Si.bind(s.stepInterpolant?ae.NEAREST:ae.LINEAR,ae.CLAMP_TO_EDGE)}et.draw(ne,ae.TRIANGLES,E,f.stencilModeForClipping(Ee),D,ar.disabled,Dt,bt,s.id,he.layoutVertexBuffer,he.indexBuffer,he.segments,s.paint,f.transform.zoom,Ge,he.layoutVertexBuffer2),xe=!1}},fill:function(f,t,s,l){const m=s.paint.get("fill-color"),b=s.paint.get("fill-opacity");if(b.constantOr(1)===0)return;const E=f.colorModeForRenderPass(),D=s.paint.get("fill-pattern"),L=f.opaquePassEnabledForLayer()&&!D.constantOr(1)&&m.constantOr(n.Color.transparent).a===1&&b.constantOr(0)===1?"opaque":"translucent";if(f.renderPass===L){const R=f.depthModeForSublayer(1,f.renderPass==="opaque"?Mi.ReadWrite:Mi.ReadOnly);xn(f,t,s,l,R,E,!1)}if(f.renderPass==="translucent"&&s.paint.get("fill-antialias")){const R=f.depthModeForSublayer(s.getPaintProperty("fill-outline-color")?2:0,Mi.ReadOnly);xn(f,t,s,l,R,E,!0)}},"fill-extrusion":function(f,t,s,l){const m=s.paint.get("fill-extrusion-opacity");if(m!==0&&f.renderPass==="translucent"){const b=new Mi(f.context.gl.LEQUAL,Mi.ReadWrite,f.depthRangeFor3D);if(m!==1||s.paint.get("fill-extrusion-pattern").constantOr(1))Zs(f,t,s,l,b,Yi.disabled,Ji.disabled),Zs(f,t,s,l,b,f.stencilModeFor3D(),f.colorModeForRenderPass());else{const E=f.colorModeForRenderPass();Zs(f,t,s,l,b,Yi.disabled,E)}}},hillshade:function(f,t,s,l){if(f.renderPass!=="offscreen"&&f.renderPass!=="translucent")return;const m=f.context,b=f.depthModeForSublayer(0,Mi.ReadOnly),E=f.colorModeForRenderPass(),[D,L]=f.renderPass==="translucent"?f.stencilConfigForOverlap(l):[{},l];for(const R of L){const V=t.getTile(R);V.needsHillshadePrepare!==void 0&&V.needsHillshadePrepare&&f.renderPass==="offscreen"?qo(f,V,s,b,Yi.disabled,E):f.renderPass==="translucent"&&Jn(f,R,V,s,b,D[R.overscaledZ],E)}m.viewport.set([0,0,f.width,f.height])},raster:function(f,t,s,l){if(f.renderPass!=="translucent"||s.paint.get("raster-opacity")===0||!l.length)return;const m=f.context,b=m.gl,E=t.getSource(),D=f.useProgram("raster"),L=f.colorModeForRenderPass(),[R,V]=E instanceof Q?[{},l]:f.stencilConfigForOverlap(l),X=V[V.length-1].overscaledZ,H=!f.options.moving;for(const le of V){const ne=f.depthModeForSublayer(le.overscaledZ-X,s.paint.get("raster-opacity")===1?Mi.ReadWrite:Mi.ReadOnly,b.LESS),ae=t.getTile(le);ae.registerFadeDuration(s.paint.get("raster-fade-duration"));const xe=t.findLoadedParent(le,0),Ee=wo(ae,xe,t,s,f.transform,f.style.terrain);let Oe,he;const Ge=s.paint.get("raster-resampling")==="nearest"?b.NEAREST:b.LINEAR;m.activeTexture.set(b.TEXTURE0),ae.texture.bind(Ge,b.CLAMP_TO_EDGE,b.LINEAR_MIPMAP_NEAREST),m.activeTexture.set(b.TEXTURE1),xe?(xe.texture.bind(Ge,b.CLAMP_TO_EDGE,b.LINEAR_MIPMAP_NEAREST),Oe=Math.pow(2,xe.tileID.overscaledZ-ae.tileID.overscaledZ),he=[ae.tileID.canonical.x*Oe%1,ae.tileID.canonical.y*Oe%1]):ae.texture.bind(Ge,b.CLAMP_TO_EDGE,b.LINEAR_MIPMAP_NEAREST);const Fe=f.style.terrain&&f.style.terrain.getTerrainData(le),et=Fe?le:null,it=et?et.posMatrix:f.transform.calculatePosMatrix(le.toUnwrapped(),H),bt=Mt(it,he||[0,0],Oe||1,Ee,s);E instanceof Q?D.draw(m,b.TRIANGLES,ne,Yi.disabled,L,ar.disabled,bt,Fe,s.id,E.boundsBuffer,f.quadTriangleIndexBuffer,E.boundsSegments):D.draw(m,b.TRIANGLES,ne,R[le.overscaledZ],L,ar.disabled,bt,Fe,s.id,f.rasterBoundsBuffer,f.quadTriangleIndexBuffer,f.rasterBoundsSegments)}},background:function(f,t,s,l){const m=s.paint.get("background-color"),b=s.paint.get("background-opacity");if(b===0)return;const E=f.context,D=E.gl,L=f.transform,R=L.tileSize,V=s.paint.get("background-pattern");if(f.isPatternMissing(V))return;const X=!V&&m.a===1&&b===1&&f.opaquePassEnabledForLayer()?"opaque":"translucent";if(f.renderPass!==X)return;const H=Yi.disabled,le=f.depthModeForSublayer(0,X==="opaque"?Mi.ReadWrite:Mi.ReadOnly),ne=f.colorModeForRenderPass(),ae=f.useProgram(V?"backgroundPattern":"background"),xe=l||L.coveringTiles({tileSize:R,terrain:f.style.terrain});V&&(E.activeTexture.set(D.TEXTURE0),f.imageManager.bind(f.context));const Ee=s.getCrossfadeParameters();for(const Oe of xe){const he=l?Oe.posMatrix:f.transform.calculatePosMatrix(Oe.toUnwrapped()),Ge=V?Zt(he,b,f,V,{tileID:Oe,tileSize:R},Ee):dt(he,b,m),Fe=f.style.terrain&&f.style.terrain.getTerrainData(Oe);ae.draw(E,D.TRIANGLES,le,H,ne,ar.disabled,Ge,Fe,s.id,f.tileExtentBuffer,f.quadTriangleIndexBuffer,f.tileExtentSegments)}},debug:function(f,t,s){for(let l=0;l<s.length;l++)Ae(f,t,s[l])},custom:function(f,t,s){const l=f.context,m=s.implementation;if(f.renderPass==="offscreen"){const b=m.prerender;b&&(f.setCustomLayerDefaults(),l.setColorMode(f.colorModeForRenderPass()),b.call(m,l.gl,f.transform.customLayerMatrix()),l.setDirty(),f.setBaseState())}else if(f.renderPass==="translucent"){f.setCustomLayerDefaults(),l.setColorMode(f.colorModeForRenderPass()),l.setStencilMode(Yi.disabled);const b=m.renderingMode==="3d"?new Mi(f.context.gl.LEQUAL,Mi.ReadWrite,f.depthRangeFor3D):f.depthModeForSublayer(0,Mi.ReadOnly);l.setDepthMode(b),m.render(l.gl,f.transform.customLayerMatrix()),l.setDirty(),f.setBaseState(),l.bindFramebuffer.set(null)}}};class zi{constructor(t,s){this.context=new Zn(t),this.transform=s,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:n.create(),renderTime:0},this.setup(),this.numSublayers=Ie.maxUnderzooming+Ie.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new gi,this.gpuTimers={}}resize(t,s,l){if(this.width=t*l,this.height=s*l,this.pixelRatio=l,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const m of this.style._order)this.style._layers[m].resize()}setup(){const t=this.context,s=new n.PosArray;s.emplaceBack(0,0),s.emplaceBack(n.EXTENT,0),s.emplaceBack(0,n.EXTENT),s.emplaceBack(n.EXTENT,n.EXTENT),this.tileExtentBuffer=t.createVertexBuffer(s,Li.members),this.tileExtentSegments=n.SegmentVector.simpleSegment(0,0,4,2);const l=new n.PosArray;l.emplaceBack(0,0),l.emplaceBack(n.EXTENT,0),l.emplaceBack(0,n.EXTENT),l.emplaceBack(n.EXTENT,n.EXTENT),this.debugBuffer=t.createVertexBuffer(l,Li.members),this.debugSegments=n.SegmentVector.simpleSegment(0,0,4,5);const m=new n.RasterBoundsArray;m.emplaceBack(0,0,0,0),m.emplaceBack(n.EXTENT,0,n.EXTENT,0),m.emplaceBack(0,n.EXTENT,0,n.EXTENT),m.emplaceBack(n.EXTENT,n.EXTENT,n.EXTENT,n.EXTENT),this.rasterBoundsBuffer=t.createVertexBuffer(m,Et.members),this.rasterBoundsSegments=n.SegmentVector.simpleSegment(0,0,4,2);const b=new n.PosArray;b.emplaceBack(0,0),b.emplaceBack(1,0),b.emplaceBack(0,1),b.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(b,Li.members),this.viewportSegments=n.SegmentVector.simpleSegment(0,0,4,2);const E=new n.LineStripIndexArray;E.emplaceBack(0),E.emplaceBack(1),E.emplaceBack(3),E.emplaceBack(2),E.emplaceBack(0),this.tileBorderIndexBuffer=t.createIndexBuffer(E);const D=new n.TriangleIndexArray;D.emplaceBack(0,1,2),D.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(D),this.emptyTexture=new _(t,{width:1,height:1,data:new Uint8Array([0,0,0,0])},t.gl.RGBA);const L=this.context.gl;this.stencilClearMode=new Yi({func:L.ALWAYS,mask:0},0,255,L.ZERO,L.ZERO,L.ZERO)}clearStencil(){const t=this.context,s=t.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const l=n.create();n.ortho(l,0,this.width,this.height,0,0,1),n.scale(l,l,[s.drawingBufferWidth,s.drawingBufferHeight,0]),this.useProgram("clippingMask").draw(t,s.TRIANGLES,Mi.disabled,this.stencilClearMode,Ji.disabled,ar.disabled,$(l),null,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(t,s){if(this.currentStencilSource===t.source||!t.isTileClipped()||!s||!s.length)return;this.currentStencilSource=t.source;const l=this.context,m=l.gl;this.nextStencilID+s.length>256&&this.clearStencil(),l.setColorMode(Ji.disabled),l.setDepthMode(Mi.disabled);const b=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const E of s){const D=this._tileClippingMaskIDs[E.key]=this.nextStencilID++,L=this.style.terrain&&this.style.terrain.getTerrainData(E);b.draw(l,m.TRIANGLES,Mi.disabled,new Yi({func:m.ALWAYS,mask:0},D,255,m.KEEP,m.KEEP,m.REPLACE),Ji.disabled,ar.disabled,$(E.posMatrix),L,"$clipping",this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,s=this.context.gl;return new Yi({func:s.NOTEQUAL,mask:255},t,255,s.KEEP,s.KEEP,s.REPLACE)}stencilModeForClipping(t){const s=this.context.gl;return new Yi({func:s.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,s.KEEP,s.KEEP,s.REPLACE)}stencilConfigForOverlap(t){const s=this.context.gl,l=t.sort((E,D)=>D.overscaledZ-E.overscaledZ),m=l[l.length-1].overscaledZ,b=l[0].overscaledZ-m+1;if(b>1){this.currentStencilSource=void 0,this.nextStencilID+b>256&&this.clearStencil();const E={};for(let D=0;D<b;D++)E[D+m]=new Yi({func:s.GEQUAL,mask:255},D+this.nextStencilID,255,s.KEEP,s.KEEP,s.REPLACE);return this.nextStencilID+=b,[E,l]}return[{[m]:Yi.disabled},l]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new Ji([t.CONSTANT_COLOR,t.ONE],new n.Color(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Ji.unblended:Ji.alphaBlended}depthModeForSublayer(t,s,l){if(!this.opaquePassEnabledForLayer())return Mi.disabled;const m=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new Mi(l||this.context.gl.LEQUAL,s,[m,m])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(t,s){this.style=t,this.options=s,this.lineAtlas=t.lineAtlas,this.imageManager=t.imageManager,this.glyphManager=t.glyphManager,this.symbolFadeChange=t.placement.symbolFadeChange(n.exported.now()),this.imageManager.beginFrame();const l=this.style._order,m=this.style.sourceCaches,b=this.style.terrain&&new fi(this);for(const R in m){const V=m[R];V.used&&V.prepare(this.context)}const E={},D={},L={};for(const R in m){const V=m[R];E[R]=V.getVisibleCoordinates(),D[R]=E[R].slice().reverse(),L[R]=V.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let R=0;R<l.length;R++)if(this.style._layers[l[R]].is3D()){this.opaquePassCutoff=R;break}if(b){this.opaquePassCutoff=0;const R=this.style.terrain.sourceCache.tilesAfterTime(this.terrainFacilitator.renderTime);(this.terrainFacilitator.dirty||!n.equals(this.terrainFacilitator.matrix,this.transform.projMatrix)||R.length)&&(n.copy(this.terrainFacilitator.matrix,this.transform.projMatrix),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(V,X){const H=V.context,le=H.gl,ne=Ji.unblended,ae=new Mi(le.LEQUAL,Mi.ReadWrite,[0,1]),xe=X.getTerrainMesh(),Ee=X.sourceCache.getRenderableTiles(),Oe=V.useProgram("terrainDepth");H.bindFramebuffer.set(X.getFramebuffer("depth").framebuffer),H.viewport.set([0,0,V.width/devicePixelRatio,V.height/devicePixelRatio]),H.clear({color:n.Color.transparent,depth:1});for(const he of Ee){const Ge=X.getTerrainData(he.tileID),Fe=V.transform.calculatePosMatrix(he.tileID.toUnwrapped());Oe.draw(H,le.TRIANGLES,ae,Yi.disabled,ne,ar.backCCW,{u_matrix:Fe},Ge,"terrain",xe.vertexBuffer,xe.indexBuffer,xe.segments)}H.bindFramebuffer.set(null),H.viewport.set([0,0,V.width,V.height])}(this,this.style.terrain),function(V,X){const H=V.context,le=H.gl,ne=Ji.unblended,ae=new Mi(le.LEQUAL,Mi.ReadWrite,[0,1]),xe=X.getTerrainMesh(),Ee=X.getCoordsTexture(),Oe=X.sourceCache.getRenderableTiles(),he=V.useProgram("terrainCoords");H.bindFramebuffer.set(X.getFramebuffer("coords").framebuffer),H.viewport.set([0,0,V.width/devicePixelRatio,V.height/devicePixelRatio]),H.clear({color:n.Color.transparent,depth:1}),X.coordsIndex=[];for(const Ge of Oe){const Fe=X.getTerrainData(Ge.tileID);H.activeTexture.set(le.TEXTURE0),le.bindTexture(le.TEXTURE_2D,Ee.texture);const et=V.transform.calculatePosMatrix(Ge.tileID.toUnwrapped());he.draw(H,le.TRIANGLES,ae,Yi.disabled,ne,ar.backCCW,{u_matrix:et,u_terrain_coords_id:(255-X.coordsIndex.length)/255,u_texture:0},Fe,"terrain",xe.vertexBuffer,xe.indexBuffer,xe.segments),X.coordsIndex.push(Ge.tileID.key)}H.bindFramebuffer.set(null),H.viewport.set([0,0,V.width,V.height])}(this,this.style.terrain))}this.renderPass="offscreen";for(const R of l){const V=this.style._layers[R];if(!V.hasOffscreenPass()||V.isHidden(this.transform.zoom))continue;const X=D[V.source];(V.type==="custom"||X.length)&&this.renderLayer(this,m[V.source],V,X)}if(this.context.bindFramebuffer.set(null),this.context.clear({color:s.showOverdrawInspector?n.Color.black:n.Color.transparent,depth:1}),this.clearStencil(),this._showOverdrawInspector=s.showOverdrawInspector,this.depthRangeFor3D=[0,1-(t._order.length+2)*this.numSublayers*this.depthEpsilon],!b)for(this.renderPass="opaque",this.currentLayer=l.length-1;this.currentLayer>=0;this.currentLayer--){const R=this.style._layers[l[this.currentLayer]],V=m[R.source],X=E[R.source];this._renderTileClippingMasks(R,X),this.renderLayer(this,V,R,X)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<l.length;this.currentLayer++){const R=this.style._layers[l[this.currentLayer]],V=m[R.source];if(b&&b.renderLayer(R))continue;const X=(R.type==="symbol"?L:D)[R.source];this._renderTileClippingMasks(R,E[R.source]),this.renderLayer(this,V,R,X)}if(this.options.showTileBoundaries){let R,V;Object.values(this.style._layers).forEach(X=>{X.source&&!X.isHidden(this.transform.zoom)&&(X.source!==(V&&V.id)&&(V=this.style.sourceCaches[X.source]),(!R||R.getSource().maxzoom<V.getSource().maxzoom)&&(R=V))}),R&&Qi.debug(this,R,R.getVisibleCoordinates())}this.options.showPadding&&function(R){const V=R.transform.padding;Pn(R,R.transform.height-(V.top||0),3,ws),Pn(R,V.bottom||0,3,fn),Ls(R,V.left||0,3,Yo),Ls(R,R.transform.width-(V.right||0),3,Co);const X=R.transform.centerPoint;(function(H,le,ne,ae){zs(H,le-1,ne-10,2,20,ae),zs(H,le-10,ne-1,20,2,ae)})(R,X.x,R.transform.height-X.y,Ho)}(this),this.context.setDefault()}renderLayer(t,s,l,m){l.isHidden(this.transform.zoom)||(l.type==="background"||l.type==="custom"||(m||[]).length)&&(this.id=l.id,this.gpuTimingStart(l),Qi[l.type](t,s,l,m,this.style.placement.variableOffsets),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const s=this.context.extTimerQuery;let l=this.gpuTimers[t.id];l||(l=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:s.createQueryEXT()}),l.calls++,s.beginQueryEXT(s.TIME_ELAPSED_EXT,l.query)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const t=this.context.extTimerQuery;t.endQueryEXT(t.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}queryGpuTimers(t){const s={};for(const l in t){const m=t[l],b=this.context.extTimerQuery,E=b.getQueryObjectEXT(m.query,b.QUERY_RESULT_EXT)/1e6;b.deleteQueryEXT(m.query),s[l]=E}return s}translatePosMatrix(t,s,l,m,b){if(!l[0]&&!l[1])return t;const E=b?m==="map"?this.transform.angle:0:m==="viewport"?-this.transform.angle:0;if(E){const R=Math.sin(E),V=Math.cos(E);l=[l[0]*V-l[1]*R,l[0]*R+l[1]*V]}const D=[b?l[0]:lr(s,l[0],this.transform.zoom),b?l[1]:lr(s,l[1],this.transform.zoom),0],L=new Float32Array(16);return n.translate(L,t,D),L}saveTileTexture(t){const s=this._tileTextures[t.size[0]];s?s.push(t):this._tileTextures[t.size[0]]=[t]}getTileTexture(t){const s=this._tileTextures[t];return s&&s.length>0?s.pop():null}isPatternMissing(t){if(!t)return!1;if(!t.from||!t.to)return!0;const s=this.imageManager.getPattern(t.from.toString()),l=this.imageManager.getPattern(t.to.toString());return!s||!l}useProgram(t,s){this.cache=this.cache||{};const l=t+(s?s.cacheKey:"")+(this._showOverdrawInspector?"/overdraw":"")+(this.style.terrain?"/terrain":"");return this.cache[l]||(this.cache[l]=new la(this.context,t,vs[t],s,qi[t],this._showOverdrawInspector,this.style.terrain)),this.cache[l]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new _(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}}class ur{constructor(t,s){this.points=t,this.planes=s}static fromInvProjectionMatrix(t,s,l){const m=Math.pow(2,l),b=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(D=>{const L=1/(D=n.transformMat4([],D,t))[3]/s*m;return n.mul$1(D,D,[L,L,1/D[3],L])}),E=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(D=>{const L=n.sub([],b[D[0]],b[D[1]]),R=n.sub([],b[D[2]],b[D[1]]),V=n.normalize([],n.cross([],L,R)),X=-n.dot(V,b[D[1]]);return V.concat(X)});return new ur(b,E)}}class pr{constructor(t,s){this.min=t,this.max=s,this.center=n.scale$1([],n.add([],this.min,this.max),.5)}quadrant(t){const s=[t%2==0,t<2],l=n.clone$2(this.min),m=n.clone$2(this.max);for(let b=0;b<s.length;b++)l[b]=s[b]?this.min[b]:this.center[b],m[b]=s[b]?this.center[b]:this.max[b];return m[2]=this.max[2],new pr(l,m)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}intersects(t){const s=[[this.min[0],this.min[1],this.min[2],1],[this.max[0],this.min[1],this.min[2],1],[this.max[0],this.max[1],this.min[2],1],[this.min[0],this.max[1],this.min[2],1],[this.min[0],this.min[1],this.max[2],1],[this.max[0],this.min[1],this.max[2],1],[this.max[0],this.max[1],this.max[2],1],[this.min[0],this.max[1],this.max[2],1]];let l=!0;for(let m=0;m<t.planes.length;m++){const b=t.planes[m];let E=0;for(let D=0;D<s.length;D++)n.dot$1(b,s[D])>=0&&E++;if(E===0)return 0;E!==s.length&&(l=!1)}if(l)return 2;for(let m=0;m<3;m++){let b=Number.MAX_VALUE,E=-Number.MAX_VALUE;for(let D=0;D<t.points.length;D++){const L=t.points[D][m]-this.min[m];b=Math.min(b,L),E=Math.max(E,L)}if(E<0||b>this.max[m]-this.min[m])return 0}return 1}}class Nr{constructor(t=0,s=0,l=0,m=0){if(isNaN(t)||t<0||isNaN(s)||s<0||isNaN(l)||l<0||isNaN(m)||m<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=s,this.left=l,this.right=m}interpolate(t,s,l){return s.top!=null&&t.top!=null&&(this.top=n.number(t.top,s.top,l)),s.bottom!=null&&t.bottom!=null&&(this.bottom=n.number(t.bottom,s.bottom,l)),s.left!=null&&t.left!=null&&(this.left=n.number(t.left,s.left,l)),s.right!=null&&t.right!=null&&(this.right=n.number(t.right,s.right,l)),this}getCenter(t,s){const l=n.clamp((this.left+t-this.right)/2,0,t),m=n.clamp((this.top+s-this.bottom)/2,0,s);return new n.pointGeometry(l,m)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Nr(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}class _r{constructor(t,s,l,m,b){this.tileSize=512,this.maxValidLatitude=85.051129,this.freezeElevation=!1,this._renderWorldCopies=b===void 0||!!b,this._minZoom=t||0,this._maxZoom=s||22,this._minPitch=l==null?0:l,this._maxPitch=m==null?60:m,this.setMaxBounds(),this.width=0,this.height=0,this._center=new n.LngLat(0,0),this._elevation=0,this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._unmodified=!0,this._edgeInsets=new Nr,this._posMatrixCache={},this._alignedPosMatrixCache={}}clone(){const t=new _r(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return t.tileSize=this.tileSize,t.latRange=this.latRange,t.width=this.width,t.height=this.height,t._center=this._center,t._elevation=this._elevation,t.zoom=this.zoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._calcMatrices(),t}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new n.pointGeometry(this.width,this.height)}get bearing(){return-this.angle/Math.PI*180}set bearing(t){const s=-n.wrap(t,-180,180)*Math.PI/180;var l;this.angle!==s&&(this._unmodified=!1,this.angle=s,this._calcMatrices(),this.rotationMatrix=(l=new n.ARRAY_TYPE(4),n.ARRAY_TYPE!=Float32Array&&(l[1]=0,l[2]=0),l[0]=1,l[3]=1,l),function(m,b,E){var D=b[0],L=b[1],R=b[2],V=b[3],X=Math.sin(E),H=Math.cos(E);m[0]=D*H+R*X,m[1]=L*H+V*X,m[2]=D*-X+R*H,m[3]=L*-X+V*H}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const s=n.clamp(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==s&&(this._unmodified=!1,this._pitch=s,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=t/180*Math.PI,this._calcMatrices())}get zoom(){return this._zoom}set zoom(t){const s=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==s&&(this._unmodified=!1,this._zoom=s,this.scale=this.zoomScale(s),this.tileZoom=Math.floor(s),this.zoomFraction=s-this.tileZoom,this._constrain(),this._calcMatrices())}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}set elevation(t){t!==this._elevation&&(this._elevation=t,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,s,l){this._unmodified=!1,this._edgeInsets.interpolate(t,s,l),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const s=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,s)}getVisibleUnwrappedCoordinates(t){const s=[new n.UnwrappedTileID(0,t)];if(this._renderWorldCopies){const l=this.pointCoordinate(new n.pointGeometry(0,0)),m=this.pointCoordinate(new n.pointGeometry(this.width,0)),b=this.pointCoordinate(new n.pointGeometry(this.width,this.height)),E=this.pointCoordinate(new n.pointGeometry(0,this.height)),D=Math.floor(Math.min(l.x,m.x,b.x,E.x)),L=Math.floor(Math.max(l.x,m.x,b.x,E.x)),R=1;for(let V=D-R;V<=L+R;V++)V!==0&&s.push(new n.UnwrappedTileID(V,t))}return s}coveringTiles(t){var s,l;let m=this.coveringZoomLevel(t);const b=m;if(t.minzoom!==void 0&&m<t.minzoom)return[];t.maxzoom!==void 0&&m>t.maxzoom&&(m=t.maxzoom);const E=this.pointCoordinate(this.getCameraPoint()),D=n.MercatorCoordinate.fromLngLat(this.center),L=Math.pow(2,m),R=[L*E.x,L*E.y,0],V=[L*D.x,L*D.y,0],X=ur.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,m);let H=t.minzoom||0;!t.terrain&&this.pitch<=60&&this._edgeInsets.top<.1&&(H=m);const le=t.terrain?2/Math.min(this.tileSize,t.tileSize)*this.tileSize:3,ne=he=>({aabb:new pr([he*L,0,0],[(he+1)*L,L,0]),zoom:0,x:0,y:0,wrap:he,fullyVisible:!1}),ae=[],xe=[],Ee=m,Oe=t.reparseOverscaled?b:m;if(this._renderWorldCopies)for(let he=1;he<=3;he++)ae.push(ne(-he)),ae.push(ne(he));for(ae.push(ne(0));ae.length>0;){const he=ae.pop(),Ge=he.x,Fe=he.y;let et=he.fullyVisible;if(!et){const Wt=he.aabb.intersects(X);if(Wt===0)continue;et=Wt===2}const it=t.terrain?R:V,bt=he.aabb.distanceX(it),Ze=he.aabb.distanceY(it),Vt=Math.max(Math.abs(bt),Math.abs(Ze)),Dt=le+(1<<Ee-he.zoom)-2;if(he.zoom===Ee||Vt>Dt&&he.zoom>=H){const Wt=Ee-he.zoom,Si=R[0]-.5-(Ge<<Wt),Pi=R[1]-.5-(Fe<<Wt);xe.push({tileID:new n.OverscaledTileID(he.zoom===Ee?Oe:he.zoom,he.wrap,he.zoom,Ge,Fe),distanceSq:n.sqrLen([V[0]-.5-Ge,V[1]-.5-Fe]),tileDistanceToCamera:Math.sqrt(Si*Si+Pi*Pi)})}else for(let Wt=0;Wt<4;Wt++){const Si=(Ge<<1)+Wt%2,Pi=(Fe<<1)+(Wt>>1),hi=he.zoom+1;let er=he.aabb.quadrant(Wt);if(t.terrain){const tr=new n.OverscaledTileID(hi,he.wrap,hi,Si,Pi),Ni=t.terrain.getMinMaxElevation(tr),Gi=(s=Ni.minElevation)!==null&&s!==void 0?s:this.elevation,ir=(l=Ni.maxElevation)!==null&&l!==void 0?l:this.elevation;er=new pr([er.min[0],er.min[1],Gi],[er.max[0],er.max[1],ir])}ae.push({aabb:er,zoom:hi,x:Si,y:Pi,wrap:he.wrap,fullyVisible:et})}}return xe.sort((he,Ge)=>he.distanceSq-Ge.distanceSq).map(he=>he.tileID)}resize(t,s){this.width=t,this.height=s,this.pixelsToGLUnits=[2/t,-2/s],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const s=n.clamp(t.lat,-this.maxValidLatitude,this.maxValidLatitude);return new n.pointGeometry(n.mercatorXfromLng(t.lng)*this.worldSize,n.mercatorYfromLat(s)*this.worldSize)}unproject(t){return new n.MercatorCoordinate(t.x/this.worldSize,t.y/this.worldSize).toLngLat()}get point(){return this.project(this.center)}updateElevation(t){this.freezeElevation||(this.elevation=t?this.getElevation(this._center,t):0)}getElevation(t,s){const l=n.MercatorCoordinate.fromLngLat(t),m=(1<<this.tileZoom)*n.EXTENT,b=l.x*m,E=l.y*m,D=Math.floor(b/n.EXTENT),L=Math.floor(E/n.EXTENT),R=new n.OverscaledTileID(this.tileZoom,0,this.tileZoom,D,L);return s.getElevation(R,b%n.EXTENT,E%n.EXTENT,n.EXTENT)}getCameraPosition(){return{lngLat:this.pointLocation(this.getCameraPoint()),altitude:Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter+this.elevation}}recalculateZoom(t){const s=this.pointLocation(this.centerPoint,t),l=this.getElevation(s,t);if(!(this.elevation-l))return;const m=this.getCameraPosition(),b=n.MercatorCoordinate.fromLngLat(m.lngLat,m.altitude),E=n.MercatorCoordinate.fromLngLat(s,l),D=b.x-E.x,L=b.y-E.y,R=b.z-E.z,V=Math.sqrt(D*D+L*L+R*R),X=this.scaleZoom(this.cameraToCenterDistance/V/this.tileSize);this._elevation=l,this._center=s,this.zoom=X}setLocationAtPoint(t,s){const l=this.pointCoordinate(s),m=this.pointCoordinate(this.centerPoint),b=this.locationCoordinate(t),E=new n.MercatorCoordinate(b.x-(l.x-m.x),b.y-(l.y-m.y));this.center=this.coordinateLocation(E),this._renderWorldCopies&&(this.center=this.center.wrap())}locationPoint(t,s){return s?this.coordinatePoint(this.locationCoordinate(t),this.getElevation(t,s),this.pixelMatrix3D):this.coordinatePoint(this.locationCoordinate(t))}pointLocation(t,s){return this.coordinateLocation(this.pointCoordinate(t,s))}locationCoordinate(t){return n.MercatorCoordinate.fromLngLat(t)}coordinateLocation(t){return t&&t.toLngLat()}pointCoordinate(t,s){if(s){const H=s.pointCoordinate(t);if(H!=null)return H}const l=[t.x,t.y,0,1],m=[t.x,t.y,1,1];n.transformMat4(l,l,this.pixelMatrixInverse),n.transformMat4(m,m,this.pixelMatrixInverse);const b=l[3],E=m[3],D=l[1]/b,L=m[1]/E,R=l[2]/b,V=m[2]/E,X=R===V?0:(0-R)/(V-R);return new n.MercatorCoordinate(n.number(l[0]/b,m[0]/E,X)/this.worldSize,n.number(D,L,X)/this.worldSize)}coordinatePoint(t,s=0,l=this.pixelMatrix){const m=[t.x*this.worldSize,t.y*this.worldSize,s,1];return n.transformMat4(m,m,l),new n.pointGeometry(m[0]/m[3],m[1]/m[3])}getBounds(){const t=Math.max(0,this.height/2-this.getHorizon());return new n.LngLatBounds().extend(this.pointLocation(new n.pointGeometry(0,t))).extend(this.pointLocation(new n.pointGeometry(this.width,t))).extend(this.pointLocation(new n.pointGeometry(this.width,this.height))).extend(this.pointLocation(new n.pointGeometry(0,this.height)))}getMaxBounds(){return this.latRange&&this.latRange.length===2&&this.lngRange&&this.lngRange.length===2?new n.LngLatBounds([this.lngRange[0],this.latRange[0]],[this.lngRange[1],this.latRange[1]]):null}getHorizon(){return Math.tan(Math.PI/2-this._pitch)*this.cameraToCenterDistance*.85}setMaxBounds(t){t?(this.lngRange=[t.getWest(),t.getEast()],this.latRange=[t.getSouth(),t.getNorth()],this._constrain()):(this.lngRange=null,this.latRange=[-this.maxValidLatitude,this.maxValidLatitude])}calculatePosMatrix(t,s=!1){const l=t.key,m=s?this._alignedPosMatrixCache:this._posMatrixCache;if(m[l])return m[l];const b=t.canonical,E=this.worldSize/this.zoomScale(b.z),D=b.x+Math.pow(2,b.z)*t.wrap,L=n.identity(new Float64Array(16));return n.translate(L,L,[D*E,b.y*E,0]),n.scale(L,L,[E/n.EXTENT,E/n.EXTENT,1]),n.multiply(L,s?this.alignedProjMatrix:this.projMatrix,L),m[l]=new Float32Array(L),m[l]}customLayerMatrix(){return this.mercatorMatrix.slice()}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let t,s,l,m,b=-90,E=90,D=-180,L=180;const R=this.size,V=this._unmodified;if(this.latRange){const le=this.latRange;b=n.mercatorYfromLat(le[1])*this.worldSize,E=n.mercatorYfromLat(le[0])*this.worldSize,t=E-b<R.y?R.y/(E-b):0}if(this.lngRange){const le=this.lngRange;D=n.wrap(n.mercatorXfromLng(le[0])*this.worldSize,0,this.worldSize),L=n.wrap(n.mercatorXfromLng(le[1])*this.worldSize,0,this.worldSize),L<D&&(L+=this.worldSize),s=L-D<R.x?R.x/(L-D):0}const X=this.point,H=Math.max(s||0,t||0);if(H)return this.center=this.unproject(new n.pointGeometry(s?(L+D)/2:X.x,t?(E+b)/2:X.y)),this.zoom+=this.scaleZoom(H),this._unmodified=V,void(this._constraining=!1);if(this.latRange){const le=X.y,ne=R.y/2;le-ne<b&&(m=b+ne),le+ne>E&&(m=E-ne)}if(this.lngRange){const le=(D+L)/2,ne=n.wrap(X.x,le-this.worldSize/2,le+this.worldSize/2),ae=R.x/2;ne-ae<D&&(l=D+ae),ne+ae>L&&(l=L-ae)}l===void 0&&m===void 0||(this.center=this.unproject(new n.pointGeometry(l!==void 0?l:X.x,m!==void 0?m:X.y)).wrap()),this._unmodified=V,this._constraining=!1}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,s=this.point.x,l=this.point.y;this.cameraToCenterDistance=.5/Math.tan(this._fov/2)*this.height,this._pixelPerMeter=n.mercatorZfromAltitude(1,this.center.lat)*this.worldSize;let m=n.identity(new Float64Array(16));n.scale(m,m,[this.width/2,-this.height/2,1]),n.translate(m,m,[1,-1,0]),this.labelPlaneMatrix=m,m=n.identity(new Float64Array(16)),n.scale(m,m,[1,-1,1]),n.translate(m,m,[-1,-1,0]),n.scale(m,m,[2/this.width,2/this.height,1]),this.glCoordMatrix=m,this.cameraToSeaLevelDistance=this.cameraToCenterDistance+this._elevation*this._pixelPerMeter/Math.cos(this._pitch);const b=Math.PI/2+this._pitch,E=this._fov*(.5+t.y/this.height),D=Math.sin(E)*this.cameraToSeaLevelDistance/Math.sin(n.clamp(Math.PI-b-E,.01,Math.PI-.01)),L=this.getHorizon(),R=2*Math.atan(L/this.cameraToCenterDistance)*(.5+t.y/(2*L)),V=Math.sin(R)*this.cameraToSeaLevelDistance/Math.sin(n.clamp(Math.PI-b-R,.01,Math.PI-.01)),X=Math.cos(Math.PI/2-this._pitch)*D+this.cameraToSeaLevelDistance,H=Math.cos(Math.PI/2-this._pitch)*V+this.cameraToSeaLevelDistance,le=1.01*Math.min(X,H),ne=this.height/50;m=new Float64Array(16),n.perspective(m,this._fov,this.width/this.height,ne,le),m[8]=2*-t.x/this.width,m[9]=2*t.y/this.height,n.scale(m,m,[1,-1,1]),n.translate(m,m,[0,0,-this.cameraToCenterDistance]),n.rotateX(m,m,this._pitch),n.rotateZ(m,m,this.angle),n.translate(m,m,[-s,-l,0]),this.mercatorMatrix=n.scale([],m,[this.worldSize,this.worldSize,this.worldSize]),n.scale(m,m,[1,1,this._pixelPerMeter]),this.pixelMatrix=n.multiply(new Float64Array(16),this.labelPlaneMatrix,m),n.translate(m,m,[0,0,-this.elevation]),this.projMatrix=m,this.invProjMatrix=n.invert([],m),this.pixelMatrix3D=n.multiply(new Float64Array(16),this.labelPlaneMatrix,m);const ae=this.width%2/2,xe=this.height%2/2,Ee=Math.cos(this.angle),Oe=Math.sin(this.angle),he=s-Math.round(s)+Ee*ae+Oe*xe,Ge=l-Math.round(l)+Ee*xe+Oe*ae,Fe=new Float64Array(m);if(n.translate(Fe,Fe,[he>.5?he-1:he,Ge>.5?Ge-1:Ge,0]),this.alignedProjMatrix=Fe,m=n.invert(new Float64Array(16),this.pixelMatrix),!m)throw new Error("failed to invert matrix");this.pixelMatrixInverse=m,this._posMatrixCache={},this._alignedPosMatrixCache={}}maxPitchScaleFactor(){if(!this.pixelMatrixInverse)return 1;const t=this.pointCoordinate(new n.pointGeometry(0,0)),s=[t.x*this.worldSize,t.y*this.worldSize,0,1];return n.transformMat4(s,s,this.pixelMatrix)[3]/this.cameraToCenterDistance}getCameraPoint(){const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new n.pointGeometry(0,t))}getCameraQueryGeometry(t){const s=this.getCameraPoint();if(t.length===1)return[t[0],s];{let l=s.x,m=s.y,b=s.x,E=s.y;for(const D of t)l=Math.min(l,D.x),m=Math.min(m,D.y),b=Math.max(b,D.x),E=Math.max(E,D.y);return[new n.pointGeometry(l,m),new n.pointGeometry(b,m),new n.pointGeometry(b,E),new n.pointGeometry(l,E),new n.pointGeometry(l,m)]}}}class Tr{constructor(t){this._hashName=t&&encodeURIComponent(t),n.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=function(s,l){let m=!1,b=null;const E=()=>{b=null,m&&(s(),b=setTimeout(E,300),m=!1)};return()=>(m=!0,b||E(),b)}(this._updateHashUnthrottled.bind(this))}addTo(t){return this._map=t,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),delete this._map,this}getHashString(t){const s=this._map.getCenter(),l=Math.round(100*this._map.getZoom())/100,m=Math.ceil((l*Math.LN2+Math.log(512/360/.5))/Math.LN10),b=Math.pow(10,m),E=Math.round(s.lng*b)/b,D=Math.round(s.lat*b)/b,L=this._map.getBearing(),R=this._map.getPitch();let V="";if(V+=t?`/${E}/${D}/${l}`:`${l}/${D}/${E}`,(L||R)&&(V+="/"+Math.round(10*L)/10),R&&(V+=`/${Math.round(R)}`),this._hashName){const X=this._hashName;let H=!1;const le=window.location.hash.slice(1).split("&").map(ne=>{const ae=ne.split("=")[0];return ae===X?(H=!0,`${ae}=${V}`):ne}).filter(ne=>ne);return H||le.push(`${X}=${V}`),`#${le.join("&")}`}return`#${V}`}_getCurrentHash(){const t=window.location.hash.replace("#","");if(this._hashName){let s;return t.split("&").map(l=>l.split("=")).forEach(l=>{l[0]===this._hashName&&(s=l)}),(s&&s[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._getCurrentHash();if(t.length>=3&&!t.some(s=>isNaN(s))){const s=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(t[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+t[2],+t[1]],zoom:+t[0],bearing:s,pitch:+(t[4]||0)}),!0}return!1}_updateHashUnthrottled(){const t=window.location.href.replace(/(#.+)?$/,this.getHashString());try{window.history.replaceState(window.history.state,null,t)}catch{}}}const nn={linearity:.3,easing:n.bezier(0,0,.3,1)},Fn=n.extend({deceleration:2500,maxSpeed:1400},nn),Gr=n.extend({deceleration:20,maxSpeed:1400},nn),Rn=n.extend({deceleration:1e3,maxSpeed:360},nn),In=n.extend({deceleration:1e3,maxSpeed:90},nn);class Ks{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:n.exported.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,s=n.exported.now();for(;t.length>0&&s-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const s={zoom:0,bearing:0,pitch:0,pan:new n.pointGeometry(0,0),pinchAround:void 0,around:void 0};for(const{settings:b}of this._inertiaBuffer)s.zoom+=b.zoomDelta||0,s.bearing+=b.bearingDelta||0,s.pitch+=b.pitchDelta||0,b.panDelta&&s.pan._add(b.panDelta),b.around&&(s.around=b.around),b.pinchAround&&(s.pinchAround=b.pinchAround);const l=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,m={};if(s.pan.mag()){const b=Qn(s.pan.mag(),l,n.extend({},Fn,t||{}));m.offset=s.pan.mult(b.amount/s.pan.mag()),m.center=this._map.transform.center,Bn(m,b)}if(s.zoom){const b=Qn(s.zoom,l,Gr);m.zoom=this._map.transform.zoom+b.amount,Bn(m,b)}if(s.bearing){const b=Qn(s.bearing,l,Rn);m.bearing=this._map.transform.bearing+n.clamp(b.amount,-179,179),Bn(m,b)}if(s.pitch){const b=Qn(s.pitch,l,In);m.pitch=this._map.transform.pitch+b.amount,Bn(m,b)}if(m.zoom||m.bearing){const b=s.pinchAround===void 0?s.around:s.pinchAround;m.around=b?this._map.unproject(b):this._map.getCenter()}return this.clear(),n.extend(m,{noMoveStart:!0})}}function Bn(f,t){(!f.duration||f.duration<t.duration)&&(f.duration=t.duration,f.easing=t.easing)}function Qn(f,t,s){const{maxSpeed:l,linearity:m,deceleration:b}=s,E=n.clamp(f*m/(t/1e3),-l,l),D=Math.abs(E)/(b*m);return{easing:s.easing,duration:1e3*D,amount:E*(D/2)}}class sn extends n.Event{constructor(t,s,l,m={}){const b=a.mousePos(s.getCanvasContainer(),l),E=s.unproject(b);super(t,n.extend({point:b,lngLat:E,originalEvent:l},m)),this._defaultPrevented=!1,this.target=s}preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}}class Js extends n.Event{constructor(t,s,l){const m=t==="touchend"?l.changedTouches:l.touches,b=a.touchPos(s.getCanvasContainer(),m),E=b.map(L=>s.unproject(L)),D=b.reduce((L,R,V,X)=>L.add(R.div(X.length)),new n.pointGeometry(0,0));super(t,{points:b,point:D,lngLats:E,lngLat:s.unproject(D),originalEvent:l}),this._defaultPrevented=!1}preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}}class pn extends n.Event{constructor(t,s,l){super(t,{originalEvent:l}),this._defaultPrevented=!1}preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}}class rr{constructor(t,s){this._map=t,this._clickTolerance=s.clickTolerance}reset(){delete this._mousedownPos}wheel(t){return this._firePreventable(new pn(t.type,this._map,t))}mousedown(t,s){return this._mousedownPos=s,this._firePreventable(new sn(t.type,this._map,t))}mouseup(t){this._map.fire(new sn(t.type,this._map,t))}click(t,s){this._mousedownPos&&this._mousedownPos.dist(s)>=this._clickTolerance||this._map.fire(new sn(t.type,this._map,t))}dblclick(t){return this._firePreventable(new sn(t.type,this._map,t))}mouseover(t){this._map.fire(new sn(t.type,this._map,t))}mouseout(t){this._map.fire(new sn(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Js(t.type,this._map,t))}touchmove(t){this._map.fire(new Js(t.type,this._map,t))}touchend(t){this._map.fire(new Js(t.type,this._map,t))}touchcancel(t){this._map.fire(new Js(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ji{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(t){this._map.fire(new sn(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new sn("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._ignoreContextMenu||this._map.fire(new sn(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Qs{constructor(t,s){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=s.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,s){this.isEnabled()&&t.shiftKey&&t.button===0&&(a.disableDrag(),this._startPos=this._lastPos=s,this._active=!0)}mousemoveWindow(t,s){if(!this._active)return;const l=s;if(this._lastPos.equals(l)||!this._box&&l.dist(this._startPos)<this._clickTolerance)return;const m=this._startPos;this._lastPos=l,this._box||(this._box=a.create("div","maplibregl-boxzoom mapboxgl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair","mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const b=Math.min(m.x,l.x),E=Math.max(m.x,l.x),D=Math.min(m.y,l.y),L=Math.max(m.y,l.y);a.setTransform(this._box,`translate(${b}px,${D}px)`),this._box.style.width=E-b+"px",this._box.style.height=L-D+"px"}mouseupWindow(t,s){if(!this._active||t.button!==0)return;const l=this._startPos,m=s;if(this.reset(),a.suppressClick(),l.x!==m.x||l.y!==m.y)return this._map.fire(new n.Event("boxzoomend",{originalEvent:t})),{cameraAnimation:b=>b.fitScreenCoordinates(l,m,this._map.getBearing(),{linear:!0})};this._fireEvent("boxzoomcancel",t)}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair","mapboxgl-crosshair"),this._box&&(a.remove(this._box),this._box=null),a.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(t,s){return this._map.fire(new n.Event(t,{originalEvent:s}))}}function Xr(f,t){if(f.length!==t.length)throw new Error(`The number of touches and points are not equal - touches ${f.length}, points ${t.length}`);const s={};for(let l=0;l<f.length;l++)s[f[l].identifier]=t[l];return s}class Cs{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(t,s,l){(this.centroid||l.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=t.timeStamp),l.length===this.numTouches&&(this.centroid=function(m){const b=new n.pointGeometry(0,0);for(const E of m)b._add(E);return b.div(m.length)}(s),this.touches=Xr(l,s)))}touchmove(t,s,l){if(this.aborted||!this.centroid)return;const m=Xr(l,s);for(const b in this.touches){const E=this.touches[b],D=m[b];(!D||D.dist(E)>30)&&(this.aborted=!0)}}touchend(t,s,l){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),l.length===0){const m=!this.aborted&&this.centroid;if(this.reset(),m)return m}}}class on{constructor(t){this.singleTap=new Cs(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(t,s,l){this.singleTap.touchstart(t,s,l)}touchmove(t,s,l){this.singleTap.touchmove(t,s,l)}touchend(t,s,l){const m=this.singleTap.touchend(t,s,l);if(m){const b=t.timeStamp-this.lastTime<500,E=!this.lastTap||this.lastTap.dist(m)<30;if(b&&E||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=m,this.count===this.numTaps)return this.reset(),m}}}class es{constructor(){this._zoomIn=new on({numTouches:1,numTaps:2}),this._zoomOut=new on({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,s,l){this._zoomIn.touchstart(t,s,l),this._zoomOut.touchstart(t,s,l)}touchmove(t,s,l){this._zoomIn.touchmove(t,s,l),this._zoomOut.touchmove(t,s,l)}touchend(t,s,l){const m=this._zoomIn.touchend(t,s,l),b=this._zoomOut.touchend(t,s,l);return m?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:E=>E.easeTo({duration:300,zoom:E.getZoom()+1,around:E.unproject(m)},{originalEvent:t})}):b?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:E=>E.easeTo({duration:300,zoom:E.getZoom()-1,around:E.unproject(b)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const hs={0:1,2:2};class us{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}reset(){this._active=!1,this._moved=!1,delete this._lastPoint,delete this._eventButton}_correctButton(t,s){return!1}_move(t,s){return{}}mousedown(t,s){if(this._lastPoint)return;const l=a.mouseButton(t);this._correctButton(t,l)&&(this._lastPoint=s,this._eventButton=l)}mousemoveWindow(t,s){const l=this._lastPoint;if(l){if(t.preventDefault(),function(m,b){const E=hs[b];return m.buttons===void 0||(m.buttons&E)!==E}(t,this._eventButton))this.reset();else if(this._moved||!(s.dist(l)<this._clickTolerance))return this._moved=!0,this._lastPoint=s,this._move(l,s)}}mouseupWindow(t){this._lastPoint&&a.mouseButton(t)===this._eventButton&&(this._moved&&a.suppressClick(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ds extends us{mousedown(t,s){super.mousedown(t,s),this._lastPoint&&(this._active=!0)}_correctButton(t,s){return s===0&&!t.ctrlKey}_move(t,s){return{around:s,panDelta:s.sub(t)}}}class an extends us{_correctButton(t,s){return s===0&&t.ctrlKey||s===2}_move(t,s){const l=.8*(s.x-t.x);if(l)return this._active=!0,{bearingDelta:l}}contextmenu(t){t.preventDefault()}}class Rt extends us{_correctButton(t,s){return s===0&&t.ctrlKey||s===2}_move(t,s){const l=-.5*(s.y-t.y);if(l)return this._active=!0,{pitchDelta:l}}contextmenu(t){t.preventDefault()}}class Zo{constructor(t,s){this._minTouches=t.cooperativeGestures?2:1,this._clickTolerance=t.clickTolerance||1,this._map=s,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new n.pointGeometry(0,0),setTimeout(()=>{this._cancelCooperativeMessage=!1},200)}touchstart(t,s,l){return this._calculateTransform(t,s,l)}touchmove(t,s,l){if(this._map._cooperativeGestures&&(this._minTouches===2&&l.length<2&&!this._cancelCooperativeMessage?this._map._onCooperativeGesture(t,!1,l.length):this._cancelCooperativeMessage||(this._cancelCooperativeMessage=!0)),this._active&&!(l.length<this._minTouches))return t.preventDefault(),this._calculateTransform(t,s,l)}touchend(t,s,l){this._calculateTransform(t,s,l),this._active&&l.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,s,l){l.length>0&&(this._active=!0);const m=Xr(l,s),b=new n.pointGeometry(0,0),E=new n.pointGeometry(0,0);let D=0;for(const R in m){const V=m[R],X=this._touches[R];X&&(b._add(V),E._add(V.sub(X)),D++,m[R]=V)}if(this._touches=m,D<this._minTouches||!E.mag())return;const L=E.div(D);return this._sum._add(L),this._sum.mag()<this._clickTolerance?void 0:{around:b.div(D),panDelta:L}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Un{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}_start(t){}_move(t,s,l){return{}}touchstart(t,s,l){this._firstTwoTouches||l.length<2||(this._firstTwoTouches=[l[0].identifier,l[1].identifier],this._start([s[0],s[1]]))}touchmove(t,s,l){if(!this._firstTwoTouches)return;t.preventDefault();const[m,b]=this._firstTwoTouches,E=jn(l,s,m),D=jn(l,s,b);if(!E||!D)return;const L=this._aroundCenter?null:E.add(D).div(2);return this._move([E,D],L,t)}touchend(t,s,l){if(!this._firstTwoTouches)return;const[m,b]=this._firstTwoTouches,E=jn(l,s,m),D=jn(l,s,b);E&&D||(this._active&&a.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function jn(f,t,s){for(let l=0;l<f.length;l++)if(f[l].identifier===s)return t[l]}function Fs(f,t){return Math.log(f/t)/Math.LN2}class kt extends Un{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,s){const l=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(Fs(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Fs(this._distance,l),pinchAround:s}}}function eo(f,t){return 180*f.angleWith(t)/Math.PI}class So extends Un{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,s){const l=this._vector;if(this._vector=t[0].sub(t[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:eo(this._vector,l),pinchAround:s}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const s=25/(Math.PI*this._minDiameter)*360,l=eo(t,this._startVector);return Math.abs(l)<s}}function Rs(f){return Math.abs(f.y)>Math.abs(f.x)}class Da extends Un{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(t,s,l){super.touchstart(t,s,l),this._currentTouchCount=l.length}_start(t){this._lastPoints=t,Rs(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,s,l){if(this._map._cooperativeGestures&&this._currentTouchCount<3)return;const m=t[0].sub(this._lastPoints[0]),b=t[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(m,b,l.timeStamp),this._valid?(this._lastPoints=t,this._active=!0,{pitchDelta:(m.y+b.y)/2*-.5}):void 0}gestureBeginsVertically(t,s,l){if(this._valid!==void 0)return this._valid;const m=t.mag()>=2,b=s.mag()>=2;if(!m&&!b)return;if(!m||!b)return this._firstMove===void 0&&(this._firstMove=l),l-this._firstMove<100&&void 0;const E=t.y>0==s.y>0;return Rs(t)&&Rs(s)&&E}}const ll={panStep:100,bearingStep:15,pitchStep:10};class cl{constructor(){const t=ll;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let s=0,l=0,m=0,b=0,E=0;switch(t.keyCode){case 61:case 107:case 171:case 187:s=1;break;case 189:case 109:case 173:s=-1;break;case 37:t.shiftKey?l=-1:(t.preventDefault(),b=-1);break;case 39:t.shiftKey?l=1:(t.preventDefault(),b=1);break;case 38:t.shiftKey?m=1:(t.preventDefault(),E=-1);break;case 40:t.shiftKey?m=-1:(t.preventDefault(),E=1);break;default:return}return this._rotationDisabled&&(l=0,m=0),{cameraAnimation:D=>{const L=D.getZoom();D.easeTo({duration:300,easeId:"keyboardHandler",easing:Wl,zoom:s?Math.round(L)+s*(t.shiftKey?2:1):L,bearing:D.getBearing()+l*this._bearingStep,pitch:D.getPitch()+m*this._pitchStep,offset:[-b*this._panStep,-E*this._panStep],center:D.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Wl(f){return f*(2-f)}const hl=4.000244140625;class Oa{constructor(t,s){this._map=t,this._el=t.getCanvasContainer(),this._handler=s,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,n.bindAll(["_onTimeout"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=t&&t.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!this._map._metaPress)return;t.preventDefault()}let s=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const l=n.exported.now(),m=l-(this._lastWheelEventTime||0);this._lastWheelEventTime=l,s!==0&&s%hl==0?this._type="wheel":s!==0&&Math.abs(s)<4?this._type="trackpad":m>400?(this._type=null,this._lastValue=s,this._timeout=setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(m*s)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,s+=this._lastValue)),t.shiftKey&&s&&(s/=4),this._type&&(this._lastWheelEvent=t,this._delta-=s,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const s=a.mousePos(this._el,t);this._around=n.LngLat.convert(this._aroundCenter?this._map.getCenter():this._map.unproject(s)),this._aroundPoint=this._map.transform.locationPoint(this._around),this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;if(this._delta!==0){const D=this._type==="wheel"&&Math.abs(this._delta)>hl?this._wheelZoomRate:this._defaultZoomRate;let L=2/(1+Math.exp(-Math.abs(this._delta*D)));this._delta<0&&L!==0&&(L=1/L);const R=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):t.scale;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(R*L))),this._type==="wheel"&&(this._startZoom=t.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const s=typeof this._targetZoom=="number"?this._targetZoom:t.zoom,l=this._startZoom,m=this._easing;let b,E=!1;if(this._type==="wheel"&&l&&m){const D=Math.min((n.exported.now()-this._lastWheelEventTime)/200,1),L=m(D);b=n.number(l,s,L),D<1?this._frameId||(this._frameId=!0):E=!0}else b=s,E=!0;return this._active=!0,E&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!E,zoomDelta:b-t.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let s=n.ease;if(this._prevEase){const l=this._prevEase,m=(n.exported.now()-l.start)/l.duration,b=l.easing(m+.01)-l.easing(m),E=.27/Math.sqrt(b*b+1e-4)*.01,D=Math.sqrt(.0729-E*E);s=n.bezier(E,D,.25,1)}return this._prevEase={start:n.exported.now(),duration:t,easing:s},s}reset(){this._active=!1}}class La{constructor(t,s){this._clickZoom=t,this._tapZoom=s}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class za{constructor(){this.reset()}reset(){this._active=!1}dblclick(t,s){return t.preventDefault(),{cameraAnimation:l=>{l.easeTo({duration:300,zoom:l.getZoom()+(t.shiftKey?-1:1),around:l.unproject(s)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Fa{constructor(){this._tap=new on({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,this._tap.reset()}touchstart(t,s,l){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?l.length>0&&(this._swipePoint=s[0],this._swipeTouch=l[0].identifier):this._tap.touchstart(t,s,l))}touchmove(t,s,l){if(this._tapTime){if(this._swipePoint){if(l[0].identifier!==this._swipeTouch)return;const m=s[0],b=m.y-this._swipePoint.y;return this._swipePoint=m,t.preventDefault(),this._active=!0,{zoomDelta:b/128}}}else this._tap.touchmove(t,s,l)}touchend(t,s,l){this._tapTime?this._swipePoint&&l.length===0&&this.reset():this._tap.touchend(t,s,l)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class bn{constructor(t,s,l){this._el=t,this._mousePan=s,this._touchPan=l}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan","mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan","mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Bs{constructor(t,s,l){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=s,this._mousePitch=l}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class ul{constructor(t,s,l,m){this._el=t,this._touchZoom=s,this._touchRotate=l,this._tapDragZoom=m,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate","mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate","mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const To=f=>f.zoom||f.drag||f.pitch||f.rotate;class Ra extends n.Event{}function Ko(f){return f.panDelta&&f.panDelta.mag()||f.zoomDelta||f.bearingDelta||f.pitchDelta}class dl{constructor(t,s){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Ks(t),this._bearingSnap=s.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(s),n.bindAll(["handleEvent","handleWindowEvent"],this);const l=this._el;this._listeners=[[l,"touchstart",{passive:!0}],[l,"touchmove",{passive:!1}],[l,"touchend",void 0],[l,"touchcancel",void 0],[l,"mousedown",void 0],[l,"mousemove",void 0],[l,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[l,"mouseover",void 0],[l,"mouseout",void 0],[l,"dblclick",void 0],[l,"click",void 0],[l,"keydown",{capture:!1}],[l,"keyup",void 0],[l,"wheel",{passive:!1}],[l,"contextmenu",void 0],[window,"blur",void 0]];for(const[m,b,E]of this._listeners)a.addEventListener(m,b,m===document?this.handleWindowEvent:this.handleEvent,E)}destroy(){for(const[t,s,l]of this._listeners)a.removeEventListener(t,s,t===document?this.handleWindowEvent:this.handleEvent,l)}_addDefaultHandlers(t){const s=this._map,l=s.getCanvasContainer();this._add("mapEvent",new rr(s,t));const m=s.boxZoom=new Qs(s,t);this._add("boxZoom",m);const b=new es,E=new za;s.doubleClickZoom=new La(E,b),this._add("tapZoom",b),this._add("clickZoom",E);const D=new Fa;this._add("tapDragZoom",D);const L=s.touchPitch=new Da(s);this._add("touchPitch",L);const R=new an(t),V=new Rt(t);s.dragRotate=new Bs(t,R,V),this._add("mouseRotate",R,["mousePitch"]),this._add("mousePitch",V,["mouseRotate"]);const X=new ds(t),H=new Zo(t,s);s.dragPan=new bn(l,X,H),this._add("mousePan",X),this._add("touchPan",H,["touchZoom","touchRotate"]);const le=new So,ne=new kt;s.touchZoomRotate=new ul(l,ne,le,D),this._add("touchRotate",le,["touchPan","touchZoom"]),this._add("touchZoom",ne,["touchPan","touchRotate"]);const ae=s.scrollZoom=new Oa(s,this);this._add("scrollZoom",ae,["mousePan"]);const xe=s.keyboard=new cl;this._add("keyboard",xe),this._add("blockableMapEvent",new ji(s));for(const Ee of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[Ee]&&s[Ee].enable(t[Ee])}_add(t,s,l){this._handlers.push({handlerName:t,handler:s,allowed:l}),this._handlersById[t]=s}stop(t){if(!this._updatingCamera){for(const{handler:s}of this._handlers)s.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[]}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return Boolean(To(this._eventsInProgress))||this.isZooming()}_blockedByActive(t,s,l){for(const m in t)if(m!==l&&(!s||s.indexOf(m)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const s=[];for(const l of t)this._el.contains(l.target)&&s.push(l);return s}handleEvent(t,s){if(t.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const l=t.type==="renderFrame"?void 0:t,m={needsRenderFrame:!1},b={},E={},D=t.touches,L=D?this._getMapTouches(D):void 0,R=L?a.touchPos(this._el,L):a.mousePos(this._el,t);for(const{handlerName:H,handler:le,allowed:ne}of this._handlers){if(!le.isEnabled())continue;let ae;this._blockedByActive(E,ne,H)?le.reset():le[s||t.type]&&(ae=le[s||t.type](t,R,L),this.mergeHandlerResult(m,b,ae,H,l),ae&&ae.needsRenderFrame&&this._triggerRenderFrame()),(ae||le.isActive())&&(E[H]=le)}const V={};for(const H in this._previousActiveHandlers)E[H]||(V[H]=l);this._previousActiveHandlers=E,(Object.keys(V).length||Ko(m))&&(this._changes.push([m,b,V]),this._triggerRenderFrame()),(Object.keys(E).length||Ko(m))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:X}=m;X&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],X(this._map))}mergeHandlerResult(t,s,l,m,b){if(!l)return;n.extend(t,l);const E={handlerName:m,originalEvent:l.originalEvent||b};l.zoomDelta!==void 0&&(s.zoom=E),l.panDelta!==void 0&&(s.drag=E),l.pitchDelta!==void 0&&(s.pitch=E),l.bearingDelta!==void 0&&(s.rotate=E)}_applyChanges(){const t={},s={},l={};for(const[m,b,E]of this._changes)m.panDelta&&(t.panDelta=(t.panDelta||new n.pointGeometry(0,0))._add(m.panDelta)),m.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+m.zoomDelta),m.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+m.bearingDelta),m.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+m.pitchDelta),m.around!==void 0&&(t.around=m.around),m.pinchAround!==void 0&&(t.pinchAround=m.pinchAround),m.noInertia&&(t.noInertia=m.noInertia),n.extend(s,b),n.extend(l,E);this._updateMapTransform(t,s,l),this._changes=[]}_updateMapTransform(t,s,l){const m=this._map,b=m.transform,E=m.style&&m.style.terrain;if(!(Ko(t)||E&&this._drag))return this._fireEvents(s,l,!0);let{panDelta:D,zoomDelta:L,bearingDelta:R,pitchDelta:V,around:X,pinchAround:H}=t;H!==void 0&&(X=H),m._stop(!0),X=X||m.transform.centerPoint;const le=b.pointLocation(D?X.sub(D):X);R&&(b.bearing+=R),V&&(b.pitch+=V),L&&(b.zoom+=L),E?s.drag&&!this._drag?(this._drag={center:b.centerPoint,lngLat:b.pointLocation(X),point:X,handlerName:s.drag.handlerName},m.fire(new n.Event("freezeElevation",{freeze:!0}))):this._drag&&l[this._drag.handlerName]?(m.fire(new n.Event("freezeElevation",{freeze:!1})),this._drag=null):s.drag&&this._drag&&(b.center=b.pointLocation(b.centerPoint.sub(D))):b.setLocationAtPoint(le,X),this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(s,l,!0)}_fireEvents(t,s,l){const m=To(this._eventsInProgress),b=To(t),E={};for(const V in t){const{originalEvent:X}=t[V];this._eventsInProgress[V]||(E[`${V}start`]=X),this._eventsInProgress[V]=t[V]}!m&&b&&this._fireEvent("movestart",b.originalEvent);for(const V in E)this._fireEvent(V,E[V]);b&&this._fireEvent("move",b.originalEvent);for(const V in t){const{originalEvent:X}=t[V];this._fireEvent(V,X)}const D={};let L;for(const V in this._eventsInProgress){const{handlerName:X,originalEvent:H}=this._eventsInProgress[V];this._handlersById[X].isActive()||(delete this._eventsInProgress[V],L=s[X]||H,D[`${V}end`]=L)}for(const V in D)this._fireEvent(V,D[V]);const R=To(this._eventsInProgress);if(l&&(m||b)&&!R){this._updatingCamera=!0;const V=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),X=H=>H!==0&&-this._bearingSnap<H&&H<this._bearingSnap;V?(X(V.bearing||this._map.getBearing())&&(V.bearing=0),this._map.easeTo(V,{originalEvent:L})):(this._map.fire(new n.Event("moveend",{originalEvent:L})),X(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,s){this._map.fire(new n.Event(t,s?{originalEvent:s}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{delete this._frameId,this.handleEvent(new Ra("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const Vn={extend:(f,...t)=>n.extend(f,...t),run(f){f()},logToElement(f,t=!1,s="log"){const l=window.document.getElementById(s);l&&(t&&(l.innerHTML=""),l.innerHTML+=`<br>${f}`)}};class yr extends n.Evented{constructor(t,s){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=s.bearingSnap,n.bindAll(["_renderFrameCallback"],this)}getCenter(){return new n.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(t,s){return this.jumpTo({center:t},s)}panBy(t,s,l){return t=n.pointGeometry.convert(t).mult(-1),this.panTo(this.transform.center,n.extend({offset:t},s),l)}panTo(t,s,l){return this.easeTo(n.extend({center:t},s),l)}getZoom(){return this.transform.zoom}setZoom(t,s){return this.jumpTo({zoom:t},s),this}zoomTo(t,s,l){return this.easeTo(n.extend({zoom:t},s),l)}zoomIn(t,s){return this.zoomTo(this.getZoom()+1,t,s),this}zoomOut(t,s){return this.zoomTo(this.getZoom()-1,t,s),this}getBearing(){return this.transform.bearing}setBearing(t,s){return this.jumpTo({bearing:t},s),this}getPadding(){return this.transform.padding}setPadding(t,s){return this.jumpTo({padding:t},s),this}rotateTo(t,s,l){return this.easeTo(n.extend({bearing:t},s),l)}resetNorth(t,s){return this.rotateTo(0,n.extend({duration:1e3},t),s),this}resetNorthPitch(t,s){return this.easeTo(n.extend({bearing:0,pitch:0,duration:1e3},t),s),this}snapToNorth(t,s){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,s):this}getPitch(){return this.transform.pitch}setPitch(t,s){return this.jumpTo({pitch:t},s),this}cameraForBounds(t,s){t=n.LngLatBounds.convert(t);const l=s&&s.bearing||0;return this._cameraForBoxAndBearing(t.getNorthWest(),t.getSouthEast(),l,s)}_cameraForBoxAndBearing(t,s,l,m){const b={top:0,bottom:0,right:0,left:0};if(typeof(m=n.extend({padding:b,offset:[0,0],maxZoom:this.transform.maxZoom},m)).padding=="number"){const Fe=m.padding;m.padding={top:Fe,bottom:Fe,right:Fe,left:Fe}}m.padding=n.extend(b,m.padding);const E=this.transform,D=E.padding,L=E.project(n.LngLat.convert(t)),R=E.project(n.LngLat.convert(s)),V=L.rotate(-l*Math.PI/180),X=R.rotate(-l*Math.PI/180),H=new n.pointGeometry(Math.max(V.x,X.x),Math.max(V.y,X.y)),le=new n.pointGeometry(Math.min(V.x,X.x),Math.min(V.y,X.y)),ne=H.sub(le),ae=(E.width-(D.left+D.right+m.padding.left+m.padding.right))/ne.x,xe=(E.height-(D.top+D.bottom+m.padding.top+m.padding.bottom))/ne.y;if(xe<0||ae<0)return void n.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const Ee=Math.min(E.scaleZoom(E.scale*Math.min(ae,xe)),m.maxZoom),Oe=n.pointGeometry.convert(m.offset),he=new n.pointGeometry((m.padding.left-m.padding.right)/2,(m.padding.top-m.padding.bottom)/2).rotate(l*Math.PI/180),Ge=Oe.add(he).mult(E.scale/E.zoomScale(Ee));return{center:E.unproject(L.add(R).div(2).sub(Ge)),zoom:Ee,bearing:l}}fitBounds(t,s,l){return this._fitInternal(this.cameraForBounds(t,s),s,l)}fitScreenCoordinates(t,s,l,m,b){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.pointLocation(n.pointGeometry.convert(t)),this.transform.pointLocation(n.pointGeometry.convert(s)),l,m),m,b)}_fitInternal(t,s,l){return t?(delete(s=n.extend(t,s)).padding,s.linear?this.easeTo(s,l):this.flyTo(s,l)):this}jumpTo(t,s){this.stop();const l=this.transform;let m=!1,b=!1,E=!1;return"zoom"in t&&l.zoom!==+t.zoom&&(m=!0,l.zoom=+t.zoom),t.center!==void 0&&(l.center=n.LngLat.convert(t.center)),"bearing"in t&&l.bearing!==+t.bearing&&(b=!0,l.bearing=+t.bearing),"pitch"in t&&l.pitch!==+t.pitch&&(E=!0,l.pitch=+t.pitch),t.padding==null||l.isPaddingEqual(t.padding)||(l.padding=t.padding),this.fire(new n.Event("movestart",s)).fire(new n.Event("move",s)),m&&this.fire(new n.Event("zoomstart",s)).fire(new n.Event("zoom",s)).fire(new n.Event("zoomend",s)),b&&this.fire(new n.Event("rotatestart",s)).fire(new n.Event("rotate",s)).fire(new n.Event("rotateend",s)),E&&this.fire(new n.Event("pitchstart",s)).fire(new n.Event("pitch",s)).fire(new n.Event("pitchend",s)),this.fire(new n.Event("moveend",s))}calculateCameraOptionsFromTo(t,s,l,m=0){const b=n.MercatorCoordinate.fromLngLat(t,s),E=n.MercatorCoordinate.fromLngLat(l,m),D=E.x-b.x,L=E.y-b.y,R=E.z-b.z,V=Math.hypot(D,L,R);if(V===0)throw new Error("Can't calculate camera options with same From and To");const X=Math.hypot(D,L),H=this.transform.scaleZoom(this.transform.cameraToCenterDistance/V/this.transform.tileSize),le=180*Math.atan2(D,-L)/Math.PI;let ne=180*Math.acos(X/V)/Math.PI;return ne=R<0?90-ne:90+ne,{center:E.toLngLat(),zoom:H,pitch:ne,bearing:le}}easeTo(t,s){this._stop(!1,t.easeId),((t=n.extend({offset:[0,0],duration:500,easing:n.ease},t)).animate===!1||!t.essential&&n.exported.prefersReducedMotion)&&(t.duration=0);const l=this.transform,m=this.getZoom(),b=this.getBearing(),E=this.getPitch(),D=this.getPadding(),L="zoom"in t?+t.zoom:m,R="bearing"in t?this._normalizeBearing(t.bearing,b):b,V="pitch"in t?+t.pitch:E,X="padding"in t?t.padding:l.padding,H=n.pointGeometry.convert(t.offset);let le=l.centerPoint.add(H);const ne=l.pointLocation(le),ae=n.LngLat.convert(t.center||ne);this._normalizeCenter(ae);const xe=l.project(ne),Ee=l.project(ae).sub(xe),Oe=l.zoomScale(L-m);let he,Ge;t.around&&(he=n.LngLat.convert(t.around),Ge=l.locationPoint(he));const Fe={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=this._zooming||L!==m,this._rotating=this._rotating||b!==R,this._pitching=this._pitching||V!==E,this._padding=!l.isPaddingEqual(X),this._easeId=t.easeId,this._prepareEase(s,t.noMoveStart,Fe),this._ease(et=>{if(this._zooming&&(l.zoom=n.number(m,L,et)),this._rotating&&(l.bearing=n.number(b,R,et)),this._pitching&&(l.pitch=n.number(E,V,et)),this._padding&&(l.interpolatePadding(D,X,et),le=l.centerPoint.add(H)),he)l.setLocationAtPoint(he,Ge);else{const it=l.zoomScale(l.zoom-m),bt=L>m?Math.min(2,Oe):Math.max(.5,Oe),Ze=Math.pow(bt,1-et),Vt=l.unproject(xe.add(Ee.mult(et*Ze)).mult(it));l.setLocationAtPoint(l.renderWorldCopies?Vt.wrap():Vt,le)}this._fireMoveEvents(s)},et=>{this._afterEase(s,et)},t),this}_prepareEase(t,s,l={}){this._moving=!0,this.fire(new n.Event("freezeElevation",{freeze:!0})),s||l.moving||this.fire(new n.Event("movestart",t)),this._zooming&&!l.zooming&&this.fire(new n.Event("zoomstart",t)),this._rotating&&!l.rotating&&this.fire(new n.Event("rotatestart",t)),this._pitching&&!l.pitching&&this.fire(new n.Event("pitchstart",t))}_fireMoveEvents(t){this.fire(new n.Event("move",t)),this._zooming&&this.fire(new n.Event("zoom",t)),this._rotating&&this.fire(new n.Event("rotate",t)),this._pitching&&this.fire(new n.Event("pitch",t))}_afterEase(t,s){if(this._easeId&&s&&this._easeId===s)return;delete this._easeId,this.fire(new n.Event("freezeElevation",{freeze:!1}));const l=this._zooming,m=this._rotating,b=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,l&&this.fire(new n.Event("zoomend",t)),m&&this.fire(new n.Event("rotateend",t)),b&&this.fire(new n.Event("pitchend",t)),this.fire(new n.Event("moveend",t))}flyTo(t,s){if(!t.essential&&n.exported.prefersReducedMotion){const hi=n.pick(t,["center","zoom","bearing","pitch","around"]);return this.jumpTo(hi,s)}this.stop(),t=n.extend({offset:[0,0],speed:1.2,curve:1.42,easing:n.ease},t);const l=this.transform,m=this.getZoom(),b=this.getBearing(),E=this.getPitch(),D=this.getPadding(),L="zoom"in t?n.clamp(+t.zoom,l.minZoom,l.maxZoom):m,R="bearing"in t?this._normalizeBearing(t.bearing,b):b,V="pitch"in t?+t.pitch:E,X="padding"in t?t.padding:l.padding,H=l.zoomScale(L-m),le=n.pointGeometry.convert(t.offset);let ne=l.centerPoint.add(le);const ae=l.pointLocation(ne),xe=n.LngLat.convert(t.center||ae);this._normalizeCenter(xe);const Ee=l.project(ae),Oe=l.project(xe).sub(Ee);let he=t.curve;const Ge=Math.max(l.width,l.height),Fe=Ge/H,et=Oe.mag();if("minZoom"in t){const hi=n.clamp(Math.min(t.minZoom,m,L),l.minZoom,l.maxZoom),er=Ge/l.zoomScale(hi-m);he=Math.sqrt(er/et*2)}const it=he*he;function bt(hi){const er=(Fe*Fe-Ge*Ge+(hi?-1:1)*it*it*et*et)/(2*(hi?Fe:Ge)*it*et);return Math.log(Math.sqrt(er*er+1)-er)}function Ze(hi){return(Math.exp(hi)-Math.exp(-hi))/2}function Vt(hi){return(Math.exp(hi)+Math.exp(-hi))/2}const Dt=bt(0);let Wt=function(hi){return Vt(Dt)/Vt(Dt+he*hi)},Si=function(hi){return Ge*((Vt(Dt)*(Ze(er=Dt+he*hi)/Vt(er))-Ze(Dt))/it)/et;var er},Pi=(bt(1)-Dt)/he;if(Math.abs(et)<1e-6||!isFinite(Pi)){if(Math.abs(Ge-Fe)<1e-6)return this.easeTo(t,s);const hi=Fe<Ge?-1:1;Pi=Math.abs(Math.log(Fe/Ge))/he,Si=function(){return 0},Wt=function(er){return Math.exp(hi*he*er)}}return t.duration="duration"in t?+t.duration:1e3*Pi/("screenSpeed"in t?+t.screenSpeed/he:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0),this._zooming=!0,this._rotating=b!==R,this._pitching=V!==E,this._padding=!l.isPaddingEqual(X),this._prepareEase(s,!1),this._ease(hi=>{const er=hi*Pi,tr=1/Wt(er);l.zoom=hi===1?L:m+l.scaleZoom(tr),this._rotating&&(l.bearing=n.number(b,R,hi)),this._pitching&&(l.pitch=n.number(E,V,hi)),this._padding&&(l.interpolatePadding(D,X,hi),ne=l.centerPoint.add(le));const Ni=hi===1?xe:l.unproject(Ee.add(Oe.mult(Si(er))).mult(tr));l.setLocationAtPoint(l.renderWorldCopies?Ni.wrap():Ni,ne),this._fireMoveEvents(s)},()=>this._afterEase(s),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(t,s){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const l=this._onEaseEnd;delete this._onEaseEnd,l.call(this,s)}if(!t){const l=this.handlers;l&&l.stop(!1)}return this}_ease(t,s,l){l.animate===!1||l.duration===0?(t(1),s()):(this._easeStart=n.exported.now(),this._easeOptions=l,this._onEaseFrame=t,this._onEaseEnd=s,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((n.exported.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,s){t=n.wrap(t,-180,180);const l=Math.abs(t-s);return Math.abs(t-360-s)<l&&(t-=360),Math.abs(t+360-s)<l&&(t+=360),t}_normalizeCenter(t){const s=this.transform;if(!s.renderWorldCopies||s.lngRange)return;const l=t.lng-s.center.lng;t.lng+=l>180?-360:l<-180?360:0}}class Jo{constructor(t={}){this.options=t,n.bindAll(["_toggleAttribution","_updateData","_updateCompact","_updateCompactMinimize"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){return this._map=t,this._compact=this.options&&this.options.compact,this._container=a.create("details","maplibregl-ctrl maplibregl-ctrl-attrib mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=a.create("summary","maplibregl-ctrl-attrib-button mapboxgl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=a.create("div","maplibregl-ctrl-attrib-inner mapboxgl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){a.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(t,s){const l=this._map._getUIString(`AttributionControl.${s}`);t.title=l,t.setAttribute("aria-label",l)}_toggleAttribution(){this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show","mapboxgl-compact-show")):(this._container.classList.add("maplibregl-compact-show","mapboxgl-compact-show"),this._container.removeAttribute("open")))}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"&&t.type!=="terrain"||this._updateAttributions()}_updateAttributions(){if(!this._map.style)return;let t=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=t.concat(this.options.customAttribution.map(m=>typeof m!="string"?"":m)):typeof this.options.customAttribution=="string"&&t.push(this.options.customAttribution)),this._map.style.stylesheet){const m=this._map.style.stylesheet;this.styleOwner=m.owner,this.styleId=m.id}const s=this._map.style.sourceCaches;for(const m in s){const b=s[m];if(b.used||b.usedForTerrain){const E=b.getSource();E.attribution&&t.indexOf(E.attribution)<0&&t.push(E.attribution)}}t=t.filter(m=>String(m).trim()),t.sort((m,b)=>m.length-b.length),t=t.filter((m,b)=>{for(let E=b+1;E<t.length;E++)if(t[E].indexOf(m)>=0)return!1;return!0});const l=t.join(" | ");l!==this._attribHTML&&(this._attribHTML=l,t.length?(this._innerContainer.innerHTML=l,this._container.classList.remove("maplibregl-attrib-empty","mapboxgl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty","mapboxgl-attrib-empty"),this._updateCompact(),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","mapboxgl-compact","maplibregl-compact-show","mapboxgl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show","mapboxgl-compact","mapboxgl-compact-show"))}_updateCompactMinimize(){this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show","mapboxgl-compact-show")}}class ma{constructor(t={}){this.options=t,n.bindAll(["_updateCompact"],this)}getDefaultPosition(){return"bottom-left"}onAdd(t){this._map=t,this._compact=this.options&&this.options.compact,this._container=a.create("div","maplibregl-ctrl mapboxgl-ctrl");const s=a.create("a","maplibregl-ctrl-logo mapboxgl-ctrl-logo");return s.target="_blank",s.rel="noopener nofollow",s.href="https://maplibre.org/",s.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),s.setAttribute("rel","noopener nofollow"),this._container.appendChild(s),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){a.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}_updateCompact(){const t=this._container.children;if(t.length){const s=t[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&s.classList.add("maplibregl-compact","mapboxgl-compact"):s.classList.remove("maplibregl-compact","mapboxgl-compact")}}}class fl{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const s=++this._id;return this._queue.push({callback:t,id:s,cancelled:!1}),s}remove(t){const s=this._currentlyRunning,l=s?this._queue.concat(s):this._queue;for(const m of l)if(m.id===t)return void(m.cancelled=!0)}run(t=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const s=this._currentlyRunning=this._queue;this._queue=[];for(const l of s)if(!l.cancelled&&(l.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}const pl={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","TerrainControl.enableTerrain":"Enable terrain","TerrainControl.disableTerrain":"Disable terrain"},ml={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:void 0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,maplibreLogo:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",transformRequest:null,fadeDuration:300,crossSourceCollisions:!0},$l={showCompass:!0,showZoom:!0,visualizePitch:!1};class fs{constructor(t,s,l=!1){this._clickTolerance=10,this.element=s,this.mouseRotate=new an({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,l&&(this.mousePitch=new Rt({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),n.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),a.addEventListener(s,"mousedown",this.mousedown),a.addEventListener(s,"touchstart",this.touchstart,{passive:!1}),a.addEventListener(s,"touchmove",this.touchmove),a.addEventListener(s,"touchend",this.touchend),a.addEventListener(s,"touchcancel",this.reset)}down(t,s){this.mouseRotate.mousedown(t,s),this.mousePitch&&this.mousePitch.mousedown(t,s),a.disableDrag()}move(t,s){const l=this.map,m=this.mouseRotate.mousemoveWindow(t,s);if(m&&m.bearingDelta&&l.setBearing(l.getBearing()+m.bearingDelta),this.mousePitch){const b=this.mousePitch.mousemoveWindow(t,s);b&&b.pitchDelta&&l.setPitch(l.getPitch()+b.pitchDelta)}}off(){const t=this.element;a.removeEventListener(t,"mousedown",this.mousedown),a.removeEventListener(t,"touchstart",this.touchstart,{passive:!1}),a.removeEventListener(t,"touchmove",this.touchmove),a.removeEventListener(t,"touchend",this.touchend),a.removeEventListener(t,"touchcancel",this.reset),this.offTemp()}offTemp(){a.enableDrag(),a.removeEventListener(window,"mousemove",this.mousemove),a.removeEventListener(window,"mouseup",this.mouseup)}mousedown(t){this.down(n.extend({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),a.mousePos(this.element,t)),a.addEventListener(window,"mousemove",this.mousemove),a.addEventListener(window,"mouseup",this.mouseup)}mousemove(t){this.move(t,a.mousePos(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=a.touchPos(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=a.touchPos(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Qo(f,t,s){if(f=new n.LngLat(f.lng,f.lat),t){const l=new n.LngLat(f.lng-360,f.lat),m=new n.LngLat(f.lng+360,f.lat),b=s.locationPoint(f).distSqr(t);s.locationPoint(l).distSqr(t)<b?f=l:s.locationPoint(m).distSqr(t)<b&&(f=m)}for(;Math.abs(f.lng-s.center.lng)>180;){const l=s.locationPoint(f);if(l.x>=0&&l.y>=0&&l.x<=s.width&&l.y<=s.height)break;f.lng>s.center.lng?f.lng-=360:f.lng+=360}return f}const ni={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function pi(f,t,s){const l=f.classList;for(const m in ni)l.remove(`maplibregl-${s}-anchor-${m}`,`mapboxgl-${s}-anchor-${m}`);l.add(`maplibregl-${s}-anchor-${t}`,`mapboxgl-${s}-anchor-${t}`)}class Eo extends n.Evented{constructor(t,s){if(super(),(t instanceof HTMLElement||s)&&(t=n.extend({element:t},s)),n.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress"],this),this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&t.pitchAlignment!=="auto"?t.pitchAlignment:this._rotationAlignment,t&&t.element)this._element=t.element,this._offset=n.pointGeometry.convert(t&&t.offset||[0,0]);else{this._defaultMarker=!0,this._element=a.create("div"),this._element.setAttribute("aria-label","Map marker");const l=a.createNS("http://www.w3.org/2000/svg","svg"),m=41,b=27;l.setAttributeNS(null,"display","block"),l.setAttributeNS(null,"height",`${m}px`),l.setAttributeNS(null,"width",`${b}px`),l.setAttributeNS(null,"viewBox",`0 0 ${b} ${m}`);const E=a.createNS("http://www.w3.org/2000/svg","g");E.setAttributeNS(null,"stroke","none"),E.setAttributeNS(null,"stroke-width","1"),E.setAttributeNS(null,"fill","none"),E.setAttributeNS(null,"fill-rule","evenodd");const D=a.createNS("http://www.w3.org/2000/svg","g");D.setAttributeNS(null,"fill-rule","nonzero");const L=a.createNS("http://www.w3.org/2000/svg","g");L.setAttributeNS(null,"transform","translate(3.0, 29.0)"),L.setAttributeNS(null,"fill","#000000");const R=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const Oe of R){const he=a.createNS("http://www.w3.org/2000/svg","ellipse");he.setAttributeNS(null,"opacity","0.04"),he.setAttributeNS(null,"cx","10.5"),he.setAttributeNS(null,"cy","5.80029008"),he.setAttributeNS(null,"rx",Oe.rx),he.setAttributeNS(null,"ry",Oe.ry),L.appendChild(he)}const V=a.createNS("http://www.w3.org/2000/svg","g");V.setAttributeNS(null,"fill",this._color);const X=a.createNS("http://www.w3.org/2000/svg","path");X.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),V.appendChild(X);const H=a.createNS("http://www.w3.org/2000/svg","g");H.setAttributeNS(null,"opacity","0.25"),H.setAttributeNS(null,"fill","#000000");const le=a.createNS("http://www.w3.org/2000/svg","path");le.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),H.appendChild(le);const ne=a.createNS("http://www.w3.org/2000/svg","g");ne.setAttributeNS(null,"transform","translate(6.0, 7.0)"),ne.setAttributeNS(null,"fill","#FFFFFF");const ae=a.createNS("http://www.w3.org/2000/svg","g");ae.setAttributeNS(null,"transform","translate(8.0, 8.0)");const xe=a.createNS("http://www.w3.org/2000/svg","circle");xe.setAttributeNS(null,"fill","#000000"),xe.setAttributeNS(null,"opacity","0.25"),xe.setAttributeNS(null,"cx","5.5"),xe.setAttributeNS(null,"cy","5.5"),xe.setAttributeNS(null,"r","5.4999962");const Ee=a.createNS("http://www.w3.org/2000/svg","circle");Ee.setAttributeNS(null,"fill","#FFFFFF"),Ee.setAttributeNS(null,"cx","5.5"),Ee.setAttributeNS(null,"cy","5.5"),Ee.setAttributeNS(null,"r","5.4999962"),ae.appendChild(xe),ae.appendChild(Ee),D.appendChild(L),D.appendChild(V),D.appendChild(H),D.appendChild(ne),D.appendChild(ae),l.appendChild(D),l.setAttributeNS(null,"height",m*this._scale+"px"),l.setAttributeNS(null,"width",b*this._scale+"px"),this._element.appendChild(l),this._offset=n.pointGeometry.convert(t&&t.offset||[0,-14])}this._element.classList.add("maplibregl-marker","mapboxgl-marker"),this._element.addEventListener("dragstart",l=>{l.preventDefault()}),this._element.addEventListener("mousedown",l=>{l.preventDefault()}),pi(this._element,this._anchor,"marker"),this._popup=null}addTo(t){return this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._update),t.on("moveend",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),a.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=n.LngLat.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const m=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[m,-1*(38.1-13.5+m)],"bottom-right":[-m,-1*(38.1-13.5+m)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,this._lngLat&&this._popup.setLngLat(this._lngLat),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}_onKeyPress(t){const s=t.code,l=t.charCode||t.keyCode;s!=="Space"&&s!=="Enter"&&l!==32&&l!==13||this.togglePopup()}_onMapClick(t){const s=t.originalEvent.target,l=this._element;this._popup&&(s===l||l.contains(s))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?t.remove():t.addTo(this._map),this):this}_update(t){if(!this._map)return;this._map.transform.renderWorldCopies&&(this._lngLat=Qo(this._lngLat,this._pos,this._map.transform)),this._pos=this._map.project(this._lngLat)._add(this._offset);let s="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?s=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(s=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let l="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?l="rotateX(0deg)":this._pitchAlignment==="map"&&(l=`rotateX(${this._map.getPitch()}deg)`),t&&t.type!=="moveend"||(this._pos=this._pos.round()),a.setTransform(this._element,`${ni[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${l} ${s}`),this._map.style&&this._map.style.terrain&&!this._opacityTimeout&&(this._opacityTimeout=setTimeout(()=>{const m=this._map.unproject(this._pos),b=40075016686e-3*Math.abs(Math.cos(this._lngLat.lat*Math.PI/180))/Math.pow(2,this._map.transform.tileZoom+8);this._element.style.opacity=m.distanceTo(this._lngLat)>20*b?"0.2":"1.0",this._opacityTimeout=null},100))}getOffset(){return this._offset}setOffset(t){return this._offset=n.pointGeometry.convert(t),this._update(),this}_onMove(t){if(!this._isDragging){const s=this._clickTolerance||this._map._clickTolerance;this._isDragging=t.point.dist(this._pointerdownPos)>=s}this._isDragging&&(this._pos=t.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new n.Event("dragstart"))),this.fire(new n.Event("drag")))}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new n.Event("dragend")),this._state="inactive"}_addDragHandler(t){this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(this._pos).add(this._offset),this._pointerdownPos=t.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))}setDraggable(t){return this._draggable=!!t,this._map&&(t?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t&&t!=="auto"?t:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}}const Ba={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let Us,Qr=0,js=!1;const ps={maxWidth:100,unit:"metric"};function gl(f,t,s){const l=s&&s.maxWidth||100,m=f._container.clientHeight/2,b=f.unproject([0,m]),E=f.unproject([l,m]),D=b.distanceTo(E);if(s&&s.unit==="imperial"){const L=3.2808*D;L>5280?Vs(t,l,L/5280,f._getUIString("ScaleControl.Miles")):Vs(t,l,L,f._getUIString("ScaleControl.Feet"))}else s&&s.unit==="nautical"?Vs(t,l,D/1852,f._getUIString("ScaleControl.NauticalMiles")):D>=1e3?Vs(t,l,D/1e3,f._getUIString("ScaleControl.Kilometers")):Vs(t,l,D,f._getUIString("ScaleControl.Meters"))}function Vs(f,t,s,l){const m=function(b){const E=Math.pow(10,`${Math.floor(b)}`.length-1);let D=b/E;return D=D>=10?10:D>=5?5:D>=3?3:D>=2?2:D>=1?1:function(L){const R=Math.pow(10,Math.ceil(-Math.log(L)/Math.LN10));return Math.round(L*R)/R}(D),E*D}(s);f.style.width=t*(m/s)+"px",f.innerHTML=`${m}&nbsp;${l}`}const Er={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},Lr=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Ua(f){if(f){if(typeof f=="number"){const t=Math.round(Math.sqrt(.5*Math.pow(f,2)));return{center:new n.pointGeometry(0,0),top:new n.pointGeometry(0,f),"top-left":new n.pointGeometry(t,t),"top-right":new n.pointGeometry(-t,t),bottom:new n.pointGeometry(0,-f),"bottom-left":new n.pointGeometry(t,-t),"bottom-right":new n.pointGeometry(-t,-t),left:new n.pointGeometry(f,0),right:new n.pointGeometry(-f,0)}}if(f instanceof n.pointGeometry||Array.isArray(f)){const t=n.pointGeometry.convert(f);return{center:t,top:t,"top-left":t,"top-right":t,bottom:t,"bottom-left":t,"bottom-right":t,left:t,right:t}}return{center:n.pointGeometry.convert(f.center||[0,0]),top:n.pointGeometry.convert(f.top||[0,0]),"top-left":n.pointGeometry.convert(f["top-left"]||[0,0]),"top-right":n.pointGeometry.convert(f["top-right"]||[0,0]),bottom:n.pointGeometry.convert(f.bottom||[0,0]),"bottom-left":n.pointGeometry.convert(f["bottom-left"]||[0,0]),"bottom-right":n.pointGeometry.convert(f["bottom-right"]||[0,0]),left:n.pointGeometry.convert(f.left||[0,0]),right:n.pointGeometry.convert(f.right||[0,0])}}return Ua(new n.pointGeometry(0,0))}const to={supported:g,setRTLTextPlugin:n.setRTLTextPlugin,getRTLTextPluginStatus:n.getRTLTextPluginStatus,Map:class extends yr{constructor(f){var t;if(n.PerformanceUtils.mark(n.PerformanceMarkers.create),(f=n.extend({},ml,f)).minZoom!=null&&f.maxZoom!=null&&f.minZoom>f.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(f.minPitch!=null&&f.maxPitch!=null&&f.minPitch>f.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(f.minPitch!=null&&f.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(f.maxPitch!=null&&f.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(super(new _r(f.minZoom,f.maxZoom,f.minPitch,f.maxPitch,f.renderWorldCopies),{bearingSnap:f.bearingSnap}),this._interactive=f.interactive,this._cooperativeGestures=f.cooperativeGestures,this._maxTileCacheSize=f.maxTileCacheSize,this._failIfMajorPerformanceCaveat=f.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=f.preserveDrawingBuffer,this._antialias=f.antialias,this._trackResize=f.trackResize,this._bearingSnap=f.bearingSnap,this._refreshExpiredTiles=f.refreshExpiredTiles,this._fadeDuration=f.fadeDuration,this._crossSourceCollisions=f.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=f.collectResourceTiming,this._renderTaskQueue=new fl,this._controls=[],this._mapId=n.uniqueId(),this._locale=n.extend({},pl,f.locale),this._clickTolerance=f.clickTolerance,this._pixelRatio=(t=f.pixelRatio)!==null&&t!==void 0?t:devicePixelRatio,this._requestManager=new c(f.transformRequest),typeof f.container=="string"){if(this._container=document.getElementById(f.container),!this._container)throw new Error(`Container '${f.container}' not found.`)}else{if(!(f.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=f.container}if(f.maxBounds&&this.setMaxBounds(f.maxBounds),n.bindAll(["_onWindowOnline","_onWindowResize","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this.on("terrain",()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)}),typeof window<"u"&&(addEventListener("online",this._onWindowOnline,!1),addEventListener("resize",this._onWindowResize,!1),addEventListener("orientationchange",this._onWindowResize,!1)),this.handlers=new dl(this,f),this._cooperativeGestures&&this._setupCooperativeGestures(),this._hash=f.hash&&new Tr(typeof f.hash=="string"&&f.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:f.center,zoom:f.zoom,bearing:f.bearing,pitch:f.pitch}),f.bounds&&(this.resize(),this.fitBounds(f.bounds,n.extend({},f.fitBoundsOptions,{duration:0})))),this.resize(),this._localIdeographFontFamily=f.localIdeographFontFamily,f.style&&this.setStyle(f.style,{localIdeographFontFamily:f.localIdeographFontFamily}),f.attributionControl&&this.addControl(new Jo({customAttribution:f.customAttribution})),f.maplibreLogo&&this.addControl(new ma,f.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",s=>{this._update(s.dataType==="style"),this.fire(new n.Event(`${s.dataType}data`,s))}),this.on("dataloading",s=>{this.fire(new n.Event(`${s.dataType}dataloading`,s))}),this.on("dataabort",s=>{this.fire(new n.Event("sourcedataabort",s))})}_getMapId(){return this._mapId}addControl(f,t){if(t===void 0&&(t=f.getDefaultPosition?f.getDefaultPosition():"top-right"),!f||!f.onAdd)return this.fire(new n.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const s=f.onAdd(this);this._controls.push(f);const l=this._controlPositions[t];return t.indexOf("bottom")!==-1?l.insertBefore(s,l.firstChild):l.appendChild(s),this}removeControl(f){if(!f||!f.onRemove)return this.fire(new n.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(f);return t>-1&&this._controls.splice(t,1),f.onRemove(this),this}hasControl(f){return this._controls.indexOf(f)>-1}calculateCameraOptionsFromTo(f,t,s,l){return l==null&&this.style.terrain&&(l=this.transform.getElevation(s,this.style.terrain)),super.calculateCameraOptionsFromTo(f,t,s,l)}resize(f){const t=this._containerDimensions(),s=t[0],l=t[1];this._resizeCanvas(s,l,this.getPixelRatio()),this.transform.resize(s,l),this.painter.resize(s,l,this.getPixelRatio());const m=!this._moving;return m&&(this.stop(),this.fire(new n.Event("movestart",f)).fire(new n.Event("move",f))),this.fire(new n.Event("resize",f)),m&&this.fire(new n.Event("moveend",f)),this}getPixelRatio(){return this._pixelRatio}setPixelRatio(f){const[t,s]=this._containerDimensions();this._pixelRatio=f,this._resizeCanvas(t,s,f),this.painter.resize(t,s,f)}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(f){return this.transform.setMaxBounds(n.LngLatBounds.convert(f)),this._update()}setMinZoom(f){if((f=f==null?-2:f)>=-2&&f<=this.transform.maxZoom)return this.transform.minZoom=f,this._update(),this.getZoom()<f&&this.setZoom(f),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(f){if((f=f==null?22:f)>=this.transform.minZoom)return this.transform.maxZoom=f,this._update(),this.getZoom()>f&&this.setZoom(f),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(f){if((f=f==null?0:f)<0)throw new Error("minPitch must be greater than or equal to 0");if(f>=0&&f<=this.transform.maxPitch)return this.transform.minPitch=f,this._update(),this.getPitch()<f&&this.setPitch(f),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(f){if((f=f==null?60:f)>85)throw new Error("maxPitch must be less than or equal to 85");if(f>=this.transform.minPitch)return this.transform.maxPitch=f,this._update(),this.getPitch()>f&&this.setPitch(f),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(f){return this.transform.renderWorldCopies=f,this._update()}project(f){return this.transform.locationPoint(n.LngLat.convert(f),this.style&&this.style.terrain)}unproject(f){return this.transform.pointLocation(n.pointGeometry.convert(f),this.style&&this.style.terrain)}isMoving(){return this._moving||this.handlers.isMoving()}isZooming(){return this._zooming||this.handlers.isZooming()}isRotating(){return this._rotating||this.handlers.isRotating()}_createDelegatedListener(f,t,s){if(f==="mouseenter"||f==="mouseover"){let l=!1;return{layer:t,listener:s,delegates:{mousemove:b=>{const E=this.getLayer(t)?this.queryRenderedFeatures(b.point,{layers:[t]}):[];E.length?l||(l=!0,s.call(this,new sn(f,this,b.originalEvent,{features:E}))):l=!1},mouseout:()=>{l=!1}}}}if(f==="mouseleave"||f==="mouseout"){let l=!1;return{layer:t,listener:s,delegates:{mousemove:E=>{(this.getLayer(t)?this.queryRenderedFeatures(E.point,{layers:[t]}):[]).length?l=!0:l&&(l=!1,s.call(this,new sn(f,this,E.originalEvent)))},mouseout:E=>{l&&(l=!1,s.call(this,new sn(f,this,E.originalEvent)))}}}}{const l=m=>{const b=this.getLayer(t)?this.queryRenderedFeatures(m.point,{layers:[t]}):[];b.length&&(m.features=b,s.call(this,m),delete m.features)};return{layer:t,listener:s,delegates:{[f]:l}}}}on(f,t,s){if(s===void 0)return super.on(f,t);const l=this._createDelegatedListener(f,t,s);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[f]=this._delegatedListeners[f]||[],this._delegatedListeners[f].push(l);for(const m in l.delegates)this.on(m,l.delegates[m]);return this}once(f,t,s){if(s===void 0)return super.once(f,t);const l=this._createDelegatedListener(f,t,s);for(const m in l.delegates)this.once(m,l.delegates[m]);return this}off(f,t,s){return s===void 0?super.off(f,t):(this._delegatedListeners&&this._delegatedListeners[f]&&(l=>{const m=this._delegatedListeners[f];for(let b=0;b<m.length;b++){const E=m[b];if(E.layer===t&&E.listener===s){for(const D in E.delegates)this.off(D,E.delegates[D]);return m.splice(b,1),this}}})(),this)}queryRenderedFeatures(f,t){if(!this.style)return[];let s;if(t!==void 0||f===void 0||f instanceof n.pointGeometry||Array.isArray(f)||(t=f,f=void 0),t=t||{},(f=f||[[0,0],[this.transform.width,this.transform.height]])instanceof n.pointGeometry||typeof f[0]=="number")s=[n.pointGeometry.convert(f)];else{const l=n.pointGeometry.convert(f[0]),m=n.pointGeometry.convert(f[1]);s=[l,new n.pointGeometry(m.x,l.y),m,new n.pointGeometry(l.x,m.y),l]}return this.style.queryRenderedFeatures(s,t,this.transform)}querySourceFeatures(f,t){return this.style.querySourceFeatures(f,t)}setStyle(f,t){return(t=n.extend({},{localIdeographFontFamily:this._localIdeographFontFamily},t)).diff!==!1&&t.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&f?(this._diffStyle(f,t),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._updateStyle(f,t))}setTransformRequest(f){return this._requestManager.setTransformRequest(f),this}_getUIString(f){const t=this._locale[f];if(t==null)throw new Error(`Missing UI string '${f}'`);return t}_updateStyle(f,t){return this.style&&(this.style.setEventedParent(null),this.style._remove()),f?(this.style=new gr(this,t||{}),this.style.setEventedParent(this,{style:this.style}),typeof f=="string"?this.style.loadURL(f):this.style.loadJSON(f),this):(delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new gr(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(f,t){if(typeof f=="string"){const s=this._requestManager.transformRequest(f,n.ResourceType.Style);n.getJSON(s,(l,m)=>{l?this.fire(new n.ErrorEvent(l)):m&&this._updateDiff(m,t)})}else typeof f=="object"&&this._updateDiff(f,t)}_updateDiff(f,t){try{this.style.setState(f)&&this._update(!0)}catch(s){n.warnOnce(`Unable to perform style diff: ${s.message||s.error||s}.  Rebuilding the style from scratch.`),this._updateStyle(f,t)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():n.warnOnce("There is no style added to the map.")}addSource(f,t){return this._lazyInitEmptyStyle(),this.style.addSource(f,t),this._update(!0)}isSourceLoaded(f){const t=this.style&&this.style.sourceCaches[f];if(t!==void 0)return t.loaded();this.fire(new n.ErrorEvent(new Error(`There is no source with ID '${f}'`)))}setTerrain(f){return this.style.setTerrain(f),this}getTerrain(){return this.style.terrain&&this.style.terrain.options}areTilesLoaded(){const f=this.style&&this.style.sourceCaches;for(const t in f){const s=f[t]._tiles;for(const l in s){const m=s[l];if(m.state!=="loaded"&&m.state!=="errored")return!1}}return!0}addSourceType(f,t,s){return this._lazyInitEmptyStyle(),this.style.addSourceType(f,t,s)}removeSource(f){return this.style.removeSource(f),this._update(!0)}getSource(f){return this.style.getSource(f)}addImage(f,t,{pixelRatio:s=1,sdf:l=!1,stretchX:m,stretchY:b,content:E}={}){if(this._lazyInitEmptyStyle(),t instanceof HTMLImageElement||n.isImageBitmap(t)){const{width:D,height:L,data:R}=n.exported.getImageData(t);this.style.addImage(f,{data:new n.RGBAImage({width:D,height:L},R),pixelRatio:s,stretchX:m,stretchY:b,content:E,sdf:l,version:0})}else{if(t.width===void 0||t.height===void 0)return this.fire(new n.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:D,height:L,data:R}=t,V=t;this.style.addImage(f,{data:new n.RGBAImage({width:D,height:L},new Uint8Array(R)),pixelRatio:s,stretchX:m,stretchY:b,content:E,sdf:l,version:0,userImage:V}),V.onAdd&&V.onAdd(this,f)}}}updateImage(f,t){const s=this.style.getImage(f);if(!s)return this.fire(new n.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const l=t instanceof HTMLImageElement||n.isImageBitmap(t)?n.exported.getImageData(t):t,{width:m,height:b,data:E}=l;if(m===void 0||b===void 0)return this.fire(new n.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(m!==s.data.width||b!==s.data.height)return this.fire(new n.ErrorEvent(new Error("The width and height of the updated image must be that same as the previous version of the image")));const D=!(t instanceof HTMLImageElement||n.isImageBitmap(t));s.data.replace(E,D),this.style.updateImage(f,s)}hasImage(f){return f?!!this.style.getImage(f):(this.fire(new n.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(f){this.style.removeImage(f)}loadImage(f,t){n.getImage(this._requestManager.transformRequest(f,n.ResourceType.Image),t)}listImages(){return this.style.listImages()}addLayer(f,t){return this._lazyInitEmptyStyle(),this.style.addLayer(f,t),this._update(!0)}moveLayer(f,t){return this.style.moveLayer(f,t),this._update(!0)}removeLayer(f){return this.style.removeLayer(f),this._update(!0)}getLayer(f){return this.style.getLayer(f)}setLayerZoomRange(f,t,s){return this.style.setLayerZoomRange(f,t,s),this._update(!0)}setFilter(f,t,s={}){return this.style.setFilter(f,t,s),this._update(!0)}getFilter(f){return this.style.getFilter(f)}setPaintProperty(f,t,s,l={}){return this.style.setPaintProperty(f,t,s,l),this._update(!0)}getPaintProperty(f,t){return this.style.getPaintProperty(f,t)}setLayoutProperty(f,t,s,l={}){return this.style.setLayoutProperty(f,t,s,l),this._update(!0)}getLayoutProperty(f,t){return this.style.getLayoutProperty(f,t)}setLight(f,t={}){return this._lazyInitEmptyStyle(),this.style.setLight(f,t),this._update(!0)}getLight(){return this.style.getLight()}setFeatureState(f,t){return this.style.setFeatureState(f,t),this._update()}removeFeatureState(f,t){return this.style.removeFeatureState(f,t),this._update()}getFeatureState(f){return this.style.getFeatureState(f)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let f=0,t=0;return this._container&&(f=this._container.clientWidth||400,t=this._container.clientHeight||300),[f,t]}_setupContainer(){const f=this._container;f.classList.add("maplibregl-map","mapboxgl-map");const t=this._canvasContainer=a.create("div","maplibregl-canvas-container mapboxgl-canvas-container",f);this._interactive&&t.classList.add("maplibregl-interactive","mapboxgl-interactive"),this._canvas=a.create("canvas","maplibregl-canvas mapboxgl-canvas",t),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map"),this._canvas.setAttribute("role","region");const s=this._containerDimensions();this._resizeCanvas(s[0],s[1],this.getPixelRatio());const l=this._controlContainer=a.create("div","maplibregl-control-container mapboxgl-control-container",f),m=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(b=>{m[b]=a.create("div",`maplibregl-ctrl-${b} mapboxgl-ctrl-${b}`,l)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_setupCooperativeGestures(){const f=this._container;this._metaPress=!1,this._cooperativeGesturesScreen=a.create("div","maplibregl-cooperative-gesture-screen",f);let t="Control",s=typeof this._cooperativeGestures!="boolean"&&this._cooperativeGestures.windowsHelpText?this._cooperativeGestures.windowsHelpText:"Use Ctrl + scroll to zoom the map";navigator.platform.indexOf("Mac")===0&&(s=typeof this._cooperativeGestures!="boolean"&&this._cooperativeGestures.macHelpText?this._cooperativeGestures.macHelpText:"Use \u2318 + scroll to zoom the map",t="Meta"),this._cooperativeGesturesScreen.innerHTML=`
            <div class="maplibregl-desktop-message">${s}</div>
            <div class="maplibregl-mobile-message">${typeof this._cooperativeGestures!="boolean"&&this._cooperativeGestures.mobileHelpText?this._cooperativeGestures.mobileHelpText:"Use two fingers to move the map"}</div>
        `,document.addEventListener("keydown",l=>{l.key===t&&(this._metaPress=!0)}),document.addEventListener("keyup",l=>{l.key===t&&(this._metaPress=!1)}),this._canvasContainer.addEventListener("wheel",l=>{this._onCooperativeGesture(l,this._metaPress,1)},!1),this._canvasContainer.classList.remove("mapboxgl-touch-drag-pan","maplibregl-touch-drag-pan")}_resizeCanvas(f,t,s){this._canvas.width=s*f,this._canvas.height=s*t,this._canvas.style.width=`${f}px`,this._canvas.style.height=`${t}px`}_setupPainter(){const f=n.extend({},g.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl",f)||this._canvas.getContext("experimental-webgl",f);t?(this.painter=new zi(t,this.transform),n.exported$1.testSupport(t)):this.fire(new n.ErrorEvent(new Error("Failed to initialize WebGL")))}_contextLost(f){f.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new n.Event("webglcontextlost",{originalEvent:f}))}_contextRestored(f){this._setupPainter(),this.resize(),this._update(),this.fire(new n.Event("webglcontextrestored",{originalEvent:f}))}_onMapScroll(f){if(f.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}_onCooperativeGesture(f,t,s){return!t&&s<2&&(this._cooperativeGesturesScreen.classList.add("maplibregl-show"),setTimeout(()=>{this._cooperativeGesturesScreen.classList.remove("maplibregl-show")},100)),!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(f){return this.style?(this._styleDirty=this._styleDirty||f,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(f){return this._update(),this._renderTaskQueue.add(f)}_cancelRenderFrame(f){this._renderTaskQueue.remove(f)}_render(f){let t,s=0;const l=this.painter.context.extTimerQuery;if(this.listens("gpu-timing-frame")&&(t=l.createQueryEXT(),l.beginQueryEXT(l.TIME_ELAPSED_EXT,t),s=n.exported.now()),this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(f),this._removed)return;let m=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const E=this.transform.zoom,D=n.exported.now();this.style.zoomHistory.update(E,D);const L=new n.EvaluationParameters(E,{now:D,fadeDuration:this._fadeDuration,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),R=L.crossFadingFactor();R===1&&R===this._crossFadingFactor||(m=!0,this._crossFadingFactor=R),this.style.update(L)}if(this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.style.terrain&&this.style.terrain.sourceCache.update(this.transform,this.style.terrain),this.transform.updateElevation(this.style.terrain),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,this._fadeDuration,this._crossSourceCollisions),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:this._fadeDuration,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer")}),this.fire(new n.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,n.PerformanceUtils.mark(n.PerformanceMarkers.load),this.fire(new n.Event("load"))),this.style&&(this.style.hasTransitions()||m)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),this.listens("gpu-timing-frame")){const E=n.exported.now()-s;l.endQueryEXT(l.TIME_ELAPSED_EXT,t),setTimeout(()=>{const D=l.getQueryObjectEXT(t,l.QUERY_RESULT_EXT)/1e6;l.deleteQueryEXT(t),this.fire(new n.Event("gpu-timing-frame",{cpuTime:E,gpuTime:D}))},50)}if(this.listens("gpu-timing-layer")){const E=this.painter.collectGpuTimers();setTimeout(()=>{const D=this.painter.queryGpuTimers(E);this.fire(new n.Event("gpu-timing-layer",{layerTimes:D}))},50)}const b=this._sourcesDirty||this._styleDirty||this._placementDirty;return b||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new n.Event("idle")),!this._loaded||this._fullyLoaded||b||(this._fullyLoaded=!0,n.PerformanceUtils.mark(n.PerformanceMarkers.fullLoad)),this}redraw(){return this.style&&(this._frame&&(this._frame.cancel(),this._frame=null),this._render(0)),this}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&(removeEventListener("resize",this._onWindowResize,!1),removeEventListener("orientationchange",this._onWindowResize,!1),removeEventListener("online",this._onWindowOnline,!1));const f=this.painter.context.gl.getExtension("WEBGL_lose_context");f&&f.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),a.remove(this._canvasContainer),a.remove(this._controlContainer),this._cooperativeGestures&&a.remove(this._cooperativeGesturesScreen),this._container.classList.remove("maplibregl-map","mapboxgl-map"),n.PerformanceUtils.clearMetrics(),this._removed=!0,this.fire(new n.Event("remove"))}triggerRepaint(){this.style&&!this._frame&&(this._frame=n.exported.frame(f=>{n.PerformanceUtils.frame(f),this._frame=null,this._render(f)}))}_onWindowOnline(){this._update()}_onWindowResize(f){this._trackResize&&this.resize({originalEvent:f})._update()}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(f){this._showTileBoundaries!==f&&(this._showTileBoundaries=f,this._update())}get showPadding(){return!!this._showPadding}set showPadding(f){this._showPadding!==f&&(this._showPadding=f,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(f){this._showCollisionBoxes!==f&&(this._showCollisionBoxes=f,f?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(f){this._showOverdrawInspector!==f&&(this._showOverdrawInspector=f,this._update())}get repaint(){return!!this._repaint}set repaint(f){this._repaint!==f&&(this._repaint=f,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(f){this._vertices=f,this._update()}_setCacheLimits(f,t){n.setCacheLimits(f,t)}get version(){return"2.4.0"}},NavigationControl:class{constructor(f){this.options=n.extend({},$l,f),this._container=a.create("div","maplibregl-ctrl maplibregl-ctrl-group mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(n.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in mapboxgl-ctrl-zoom-in",t=>this._map.zoomIn({},{originalEvent:t})),a.create("span","maplibregl-ctrl-icon mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out mapboxgl-ctrl-zoom-out",t=>this._map.zoomOut({},{originalEvent:t})),a.create("span","maplibregl-ctrl-icon mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(n.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("maplibregl-ctrl-compass mapboxgl-ctrl-compass",t=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:t}):this._map.resetNorth({},{originalEvent:t})}),this._compassIcon=a.create("span","maplibregl-ctrl-icon mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const f=this._map.getZoom(),t=f===this._map.getMaxZoom(),s=f===this._map.getMinZoom();this._zoomInButton.disabled=t,this._zoomOutButton.disabled=s,this._zoomInButton.setAttribute("aria-disabled",t.toString()),this._zoomOutButton.setAttribute("aria-disabled",s.toString())}_rotateCompassArrow(){const f=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._compassIcon.style.transform=f}onAdd(f){return this._map=f,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new fs(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){a.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(f,t){const s=a.create("button",f,this._container);return s.type="button",s.addEventListener("click",t),s}_setButtonTitle(f,t){const s=this._map._getUIString(`NavigationControl.${t}`);f.title=s,f.setAttribute("aria-label",s)}},GeolocateControl:class extends n.Evented{constructor(f){super(),this.options=n.extend({},Ba,f),n.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker"],this)}onAdd(f){var t;return this._map=f,this._container=a.create("div","maplibregl-ctrl maplibregl-ctrl-group mapboxgl-ctrl mapboxgl-ctrl-group"),t=this._setupUI,Us!==void 0?t(Us):window.navigator.permissions!==void 0?window.navigator.permissions.query({name:"geolocation"}).then(s=>{Us=s.state!=="denied",t(Us)}):(Us=!!window.navigator.geolocation,t(Us)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),a.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,Qr=0,js=!1}_isOutOfMapMaxBounds(f){const t=this._map.getMaxBounds(),s=f.coords;return t&&(s.longitude<t.getWest()||s.longitude>t.getEast()||s.latitude<t.getSouth()||s.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error","mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error","mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background","mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error","mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_onSuccess(f){if(this._map){if(this._isOutOfMapMaxBounds(f))return this._setErrorState(),this.fire(new n.Event("outofmaxbounds",f)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=f,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error","mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error","mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background","mapboxgl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(f),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(f),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale","mapboxgl-user-location-dot-stale"),this.fire(new n.Event("geolocate",f)),this._finish()}}_updateCamera(f){const t=new n.LngLat(f.coords.longitude,f.coords.latitude),s=f.coords.accuracy,l=this._map.getBearing(),m=n.extend({bearing:l},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(s),m,{geolocateSource:!0})}_updateMarker(f){if(f){const t=new n.LngLat(f.coords.longitude,f.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=f.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const f=this._map._container.clientHeight/2,t=this._map.unproject([0,f]),s=this._map.unproject([1,f]),l=t.distanceTo(s),m=Math.ceil(2*this._accuracy/l);this._circleElement.style.width=`${m}px`,this._circleElement.style.height=`${m}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_onError(f){if(this._map){if(this.options.trackUserLocation)if(f.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error","mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background","mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error","mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=t,this._geolocateButton.setAttribute("aria-label",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(f.code===3&&js)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale","mapboxgl-user-location-dot-stale"),this.fire(new n.Event("error",f)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(f){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=a.create("button","maplibregl-ctrl-geolocate mapboxgl-ctrl-geolocate",this._container),a.create("span","maplibregl-ctrl-icon mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",f===!1){n.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=t,this._geolocateButton.setAttribute("aria-label",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.title=t,this._geolocateButton.setAttribute("aria-label",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=a.create("div","maplibregl-user-location-dot mapboxgl-user-location-dot"),this._userLocationDotMarker=new Eo(this._dotElement),this._circleElement=a.create("div","maplibregl-user-location-accuracy-circle mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Eo({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background","mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active"),this.fire(new n.Event("trackuserlocationend")))})}trigger(){if(!this._setup)return n.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new n.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Qr--,js=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error","mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background","mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error","mapboxgl-ctrl-geolocate-background-error"),this.fire(new n.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background","mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new n.Event("trackuserlocationstart"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active","mapboxgl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let f;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Qr++,Qr>1?(f={maximumAge:6e5,timeout:0},js=!0):(f=this.options.positionOptions,js=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,f)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting","mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Jo,LogoControl:ma,ScaleControl:class{constructor(f){this.options=n.extend({},ps,f),n.bindAll(["_onMove","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_onMove(){gl(this._map,this._container,this.options)}onAdd(f){return this._map=f,this._container=a.create("div","maplibregl-ctrl maplibregl-ctrl-scale mapboxgl-ctrl mapboxgl-ctrl-scale",f.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){a.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}setUnit(f){this.options.unit=f,gl(this._map,this._container,this.options)}},FullscreenControl:class{constructor(f){this._fullscreen=!1,f&&f.container&&(f.container instanceof HTMLElement?this._container=f.container:n.warnOnce("Full screen control 'container' must be a DOM element.")),n.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(f){return this._map=f,this._container||(this._container=this._map.getContainer()),this._controlContainer=a.create("div","maplibregl-ctrl maplibregl-ctrl-group mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",n.warnOnce("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){a.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!!(document.fullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled||document.webkitFullscreenEnabled)}_setupUI(){const f=this._fullscreenButton=a.create("button","maplibregl-ctrl-fullscreen mapboxgl-ctrl-fullscreen",this._controlContainer);a.create("span","maplibregl-ctrl-icon mapboxgl-ctrl-icon",f).setAttribute("aria-hidden","true"),f.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const f=this._getTitle();this._fullscreenButton.setAttribute("aria-label",f),this._fullscreenButton.title=f}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen&&window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},TerrainControl:class{constructor(f){this.options=f,n.bindAll(["_toggleTerrain","_updateTerrainIcon"],this)}onAdd(f){return this._map=f,this._container=a.create("div","maplibregl-ctrl maplibregl-ctrl-group mapboxgl-ctrl mapboxgl-ctrl-group"),this._terrainButton=a.create("button","maplibregl-ctrl-terrain mapboxgl-ctrl-terrain",this._container),a.create("span","maplibregl-ctrl-icon mapboxgl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){a.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}_toggleTerrain(){this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()}_updateTerrainIcon(){this._terrainButton.classList.remove("maplibregl-ctrl-terrain","mapboxgl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled","mapboxgl-ctrl-terrain-enabled"),this._map.style.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled","mapboxgl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.disableTerrain")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain","mapboxgl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.enableTerrain"))}},Popup:class extends n.Evented{constructor(f){super(),this.options=n.extend(Object.create(Er),f),n.bindAll(["_update","_onClose","remove","_onMouseMove","_onMouseUp","_onDrag"],this)}addTo(f){return this._map&&this.remove(),this._map=f,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer","mapboxgl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer","mapboxgl-track-pointer")):this._map.on("move",this._update),this.fire(new n.Event("open")),this}isOpen(){return!!this._map}remove(){return this._content&&a.remove(this._content),this._container&&(a.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),delete this._map),this.fire(new n.Event("close")),this}getLngLat(){return this._lngLat}setLngLat(f){return this._lngLat=n.LngLat.convert(f),this._pos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer","mapboxgl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer","mapboxgl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer","mapboxgl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer","mapboxgl-track-pointer")),this}getElement(){return this._container}setText(f){return this.setDOMContent(document.createTextNode(f))}setHTML(f){const t=document.createDocumentFragment(),s=document.createElement("body");let l;for(s.innerHTML=f;l=s.firstChild,l;)t.appendChild(l);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(f){return this.options.maxWidth=f,this._update(),this}setDOMContent(f){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=a.create("div","maplibregl-popup-content mapboxgl-popup-content",this._container);return this._content.appendChild(f),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(f){this._container&&this._container.classList.add(f)}removeClassName(f){this._container&&this._container.classList.remove(f)}setOffset(f){return this.options.offset=f,this._update(),this}toggleClassName(f){if(this._container)return this._container.classList.toggle(f)}_createCloseButton(){this.options.closeButton&&(this._closeButton=a.create("button","maplibregl-popup-close-button mapboxgl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.setAttribute("aria-label","Close popup"),this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_onMouseUp(f){this._update(f.point)}_onMouseMove(f){this._update(f.point)}_onDrag(f){this._update(f.point)}_update(f){if(!this._map||!this._lngLat&&!this._trackPointer||!this._content||(this._container||(this._container=a.create("div","maplibregl-popup mapboxgl-popup",this._map.getContainer()),this._tip=a.create("div","maplibregl-popup-tip mapboxgl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className&&this.options.className.split(" ").forEach(b=>this._container.classList.add(b)),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer","mapboxgl-popup-track-pointer")),this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._map.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Qo(this._lngLat,this._pos,this._map.transform)),this._trackPointer&&!f))return;const t=this._pos=this._trackPointer&&f?f:this._map.project(this._lngLat);let s=this.options.anchor;const l=Ua(this.options.offset);if(!s){const b=this._container.offsetWidth,E=this._container.offsetHeight;let D;D=t.y+l.bottom.y<E?["top"]:t.y>this._map.transform.height-E?["bottom"]:[],t.x<b/2?D.push("left"):t.x>this._map.transform.width-b/2&&D.push("right"),s=D.length===0?"bottom":D.join("-")}const m=t.add(l[s]).round();a.setTransform(this._container,`${ni[s]} translate(${m.x}px,${m.y}px)`),pi(this._container,s,"popup")}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const f=this._container.querySelector(Lr);f&&f.focus()}_onClose(){this.remove()}},Marker:Eo,Style:gr,LngLat:n.LngLat,LngLatBounds:n.LngLatBounds,Point:n.pointGeometry,MercatorCoordinate:n.MercatorCoordinate,Evented:n.Evented,AJAXError:n.AJAXError,config:n.config,CanvasSource:de,GeoJSONSource:zt,ImageSource:Q,RasterDEMTileSource:Qe,RasterTileSource:rt,VectorTileSource:vt,VideoSource:se,prewarm:function(){Je().acquire(nt)},clearPrewarmedResources:function(){const f=Ve;f&&(f.isPreloaded()&&f.numActive()===1?(f.release(nt),Ve=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get version(){return"2.4.0"},get workerCount(){return je.workerCount},set workerCount(f){je.workerCount=f},get maxParallelImageRequests(){return n.config.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(f){n.config.MAX_PARALLEL_IMAGE_REQUESTS=f},clearStorage(f){n.clearTileCache(f)},workerUrl:"",addProtocol(f,t){n.config.REGISTERED_PROTOCOLS[f]=t},removeProtocol(f){delete n.config.REGISTERED_PROTOCOLS[f]}};return Vn.extend(to,{isSafari:n.isSafari,getPerformanceMetrics:n.PerformanceUtils.getPerformanceMetrics}),to});var ei=At;return ei})})(Gc);const gu=Gc.exports;const Uc=Ws(),jc=Ws(),Pu=Ws(new Map),al="rgb(127, 127, 127)",Cf=[{id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","true"]],paint:{"fill-color":["case",["==",["get","user_color_rgb_str"],null],al,["get","user_color_rgb_str"]],"fill-outline-color":"rgb(0, 0, 0)","fill-opacity":.5}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","$type","Polygon"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(178, 204, 255)","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-halo-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-polygon-and-line-vertex-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"]],paint:{"circle-radius":3,"circle-color":"rgb(0, 0, 255)"}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","$type","LineString"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-width":3}},{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","false"]],paint:{"fill-color":["case",["==",["get","user_color_rgb_str"],null],al,["get","user_color_rgb_str"]],"fill-outline-color":"rgb(0, 0, 0)","fill-opacity":.25}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","$type","Polygon"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"rgb(0, 0, 0)","line-width":3}}];function Sf(Ne){let I,Tt;return{c(){I=ti("div"),Tt=ti("div"),this.h()},l(ft){I=ii(ft,"DIV",{class:!0});var At=ai(I);Tt=ii(At,"DIV",{class:!0,id:!0}),ai(Tt).forEach(Kt),At.forEach(Kt),this.h()},h(){oi(Tt,"class","map"),oi(Tt,"id","map"),oi(I,"class","map-wrap")},m(ft,At){Oo(ft,I,At),gt(I,Tt),Ne[3](Tt)},p:aa,i:aa,o:aa,d(ft){ft&&Kt(I),Ne[3](null)}}}function Tf(Ne,I,Tt){let ft,At,Yt;Ln(Ne,Pu,h=>Tt(4,ft=h)),Ln(Ne,jc,h=>Tt(5,At=h)),Ln(Ne,Uc,h=>Tt(6,Yt=h));let ei;Xl(()=>{const h={lng:38.447050424171266,lat:56.35162245676929,zoom:5.16};Uc.set(new Gc.exports.Map({container:ei,style:"https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL",center:[h.lng,h.lat],zoom:h.zoom})),Yt.resize(),Yt.on("click","gl-draw-polygon-fill-inactive.cold",function(a){var A,O;const c=Array.from(ft.values()).map((U,Y)=>`<option value="${U.id}">${U.id}</option>`),d=At.get(a.features[0].properties.id),_=`
                <div id="custom-popup">
                    <div class="row">
                        <div class="input-field col s12">
                            <select id="select-canvas">
                                <option value="" disabled selected>Pick up polygon</option>
                                ${c.join(`
`)}
                            </select>
                            <label>Attach canvas polygons</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input value="${(A=d==null?void 0:d.properties)==null?void 0:A.road_lane_direction}" id="lane-direction" type="number" class="validate">
                            <label class="active" for="lane-direction">Direction value</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input value="${(O=d==null?void 0:d.properties)==null?void 0:O.road_lane_num}" id="lane-number" type="number" class="validate">
                            <label class="active" for="lane-number">Lane</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12">
                            <button id="attach-canvas-btn" class="btn-small waves-effect waves-light" type="submit" name="action" onclick>Save
                                <i class="material-icons right">save</i>
                            </button>
                        </div>
                    </div>
                </div>
            `;new gu.Popup({className:"custom-popup"}).setLngLat(a.lngLat).setHTML(_).addTo(Yt);const u=a.features[0],C=document.getElementById("select-canvas");Array.from(ft.values()).some(U=>{if(U.properties.spatial_object_id===d.id)return C.value=U.id,!0}),M.FormSelect.init(C,{}),document.getElementById("attach-canvas-btn").addEventListener("click",U=>{const Y=document.getElementById("lane-direction"),oe=document.getElementById("lane-number");x(u.properties.id,C.value,{road_lane_direction:Y.value,road_lane_num:oe.value,coordinates:At.get(u.properties.id).geometry.coordinates})})})}),Nc(()=>{Yt.remove()});function n(h){Yt.addControl(h)}const g=(h,a)=>{if(a.forEach(_=>{h.add(_)}),a.size===0)return;const c=Array.from(a.values())[0].geometry.coordinates;let d=new gu.LngLatBounds(c[0]);for(const _ of c)d.extend(_);Yt.fitBounds(d,{maxZoom:18,padding:100})},x=(h,a,c={road_lane_direction:-1,road_lane_num:-1,coordinates:[]})=>{if(h===""||a===""||h===null||a===null||h===void 0||a===void 0)return;let d=ft.get(a),_=At.get(h);if(!(_===void 0||(_==null?void 0:_.properties)===null)){if(_.properties.canvas_object_id!==null&&_.properties.canvas_object_id!==void 0){let u=ft.get(_.properties.canvas_object_id);u.properties.spatial_object_id=null,u.properties.road_lane_direction=-1,u.properties.road_lane_num=-1,u.geometry.coordinates=[[],[],[],[],[]],ft.set(_.properties.canvas_object_id,u)}At.getAll().features.forEach(u=>{u.properties===null||u.id===h||u.properties.canvas_object_id===a&&(u.properties.canvas_object_id=null,u.properties.color_rgb=[127,127,127],u.properties.color_rgb_str=al,At.add(u),At.setFeatureProperty(u.id,"color_rgb_str",al))}),_.properties.canvas_object_id=a,_.properties.color_rgb=d.properties.color_rgb,_.properties.color_rgb_str=d.properties.color_rgb_str,_.properties.road_lane_direction=Number(c.road_lane_direction),_.properties.road_lane_num=Number(c.road_lane_num),At.add(_),At.setFeatureProperty(h,"color_rgb_str",d.properties.color_rgb_str),d.properties.spatial_object_id=h,d.properties.road_lane_direction=Number(c.road_lane_direction),d.properties.road_lane_num=Number(c.road_lane_num),d.geometry.coordinates=c.coordinates,ft.set(a,d)}};function v(h){Cu[h?"unshift":"push"](()=>{ei=h,Tt(0,ei)})}return[ei,n,g,v]}class Ef extends Vl{constructor(I){super(),Nl(this,I,Tf,Sf,Gl,{attachDraw:1,drawGeoPolygons:2})}get attachDraw(){return this.$$.ctx[1]}get drawGeoPolygons(){return this.$$.ctx[2]}}var jr=(Ne=>(Ne[Ne.AddingPolygon=1]="AddingPolygon",Ne[Ne.Waiting=2]="Waiting",Ne[Ne.EditingPolygon=3]="EditingPolygon",Ne[Ne.DeletingPolygon=4]="DeletingPolygon",Ne[Ne.PickPolygon=5]="PickPolygon",Ne))(jr||{});const os=Ws(2),Aa=Ws(!1),oa=Ws(!1),Xc=Ws("http://localhost:42001");class Pf{constructor(I=Ws("http"),Tt=Ws("localhost"),ft=Ws(42001)){this.schema=I,this.host=Tt,this.port=ft}get apiURL(){return vf([this.schema,this.host,this.port],([I,Tt,ft])=>`${I}://${Tt}:${ft}`)}}const jl=new Pf;function If(Ne){let I,Tt,ft,At,Yt,ei,n;return{c(){I=ti("div"),Tt=ti("img"),At=sr(),Yt=ti("canvas"),this.h()},l(g){I=ii(g,"DIV",{id:!0});var x=ai(I);Tt=ii(x,"IMG",{id:!0,src:!0,width:!0,height:!0}),At=or(x),Yt=ii(x,"CANVAS",{id:!0}),ai(Yt).forEach(Kt),x.forEach(Kt),this.h()},h(){oi(Tt,"id","fit_img"),Bc(Tt.src,ft=Ne[0]+"/live_streaming")||oi(Tt,"src",ft),oi(Tt,"width","500"),oi(Tt,"height","500"),oi(Yt,"id","fit_canvas"),oi(I,"id","mjpeg")},m(g,x){Oo(g,I,x),gt(I,Tt),gt(I,At),gt(I,Yt),ei||(n=uo(Tt,"load",Ne[2]),ei=!0)},p(g,[x]){x&1&&!Bc(Tt.src,ft=g[0]+"/live_streaming")&&oi(Tt,"src",ft)},i:aa,o:aa,d(g){g&&Kt(I),ei=!1,n()}}}function Af(Ne,I,Tt){let ft;const{apiURL:At}=jl;Ln(Ne,At,g=>Tt(3,ft=g));let Yt=`${ft}`;const ei=()=>{Aa.set(!0)},n=Xc.subscribe(g=>{Yt!==g&&(console.log(`Need to change API URL for MJPEG: '${ft}'`),Tt(0,Yt=g))});return Xl(()=>{}),Nc(()=>{n()}),[Yt,At,ei]}class Mf extends Vl{constructor(I){super(),Nl(this,I,Af,If,Gl,{})}}function kf(Ne){let I,Tt,ft,At,Yt,ei,n,g,x,v,h,a,c,d,_,u,C,S,A,O,U,Y,oe,ge,ze,We,at,_t;return{c(){I=ti("div"),Tt=ti("form"),ft=ti("div"),At=ti("div"),Yt=ti("div"),ei=ti("input"),n=sr(),g=ti("label"),x=Mr("Protocol schema type"),v=sr(),h=ti("div"),a=ti("div"),c=ti("input"),d=sr(),_=ti("label"),u=Mr("Address or explicit IP"),C=sr(),S=ti("div"),A=ti("div"),O=ti("input"),U=sr(),Y=ti("label"),oe=Mr("Port"),ge=sr(),ze=ti("button"),We=Mr("Switch"),this.h()},l(vt){I=ii(vt,"DIV",{class:!0});var rt=ai(I);Tt=ii(rt,"FORM",{autocomplete:!0});var mt=ai(Tt);ft=ii(mt,"DIV",{class:!0});var Qe=ai(ft);At=ii(Qe,"DIV",{class:!0});var zt=ai(At);Yt=ii(zt,"DIV",{class:!0});var Et=ai(Yt);ei=ii(Et,"INPUT",{id:!0,type:!0,class:!0}),n=or(Et),g=ii(Et,"LABEL",{class:!0,for:!0});var Q=ai(g);x=kr(Q,"Protocol schema type"),Q.forEach(Kt),Et.forEach(Kt),zt.forEach(Kt),v=or(Qe),h=ii(Qe,"DIV",{class:!0});var se=ai(h);a=ii(se,"DIV",{class:!0});var de=ai(a);c=ii(de,"INPUT",{id:!0,type:!0,class:!0}),d=or(de),_=ii(de,"LABEL",{class:!0,for:!0});var ie=ai(_);u=kr(ie,"Address or explicit IP"),ie.forEach(Kt),de.forEach(Kt),se.forEach(Kt),C=or(Qe),S=ii(Qe,"DIV",{class:!0});var ve=ai(S);A=ii(ve,"DIV",{class:!0});var J=ai(A);O=ii(J,"INPUT",{id:!0,type:!0,class:!0}),U=or(J),Y=ii(J,"LABEL",{class:!0,for:!0});var q=ai(Y);oe=kr(q,"Port"),q.forEach(Kt),J.forEach(Kt),ve.forEach(Kt),Qe.forEach(Kt),mt.forEach(Kt),ge=or(rt),ze=ii(rt,"BUTTON",{class:!0,type:!0,name:!0});var ce=ai(ze);We=kr(ce,"Switch"),ce.forEach(Kt),rt.forEach(Kt),this.h()},h(){oi(ei,"id","input_protocol"),oi(ei,"type","text"),oi(ei,"class","validate"),oi(g,"class","active"),oi(g,"for","input_protocol"),oi(Yt,"class","input-field"),oi(At,"class","addr-part row svelte-o3lud4"),oi(c,"id","input_protocol"),oi(c,"type","text"),oi(c,"class","validate"),oi(_,"class","active"),oi(_,"for","input_protocol"),oi(a,"class","input-field"),oi(h,"class","addr-part row svelte-o3lud4"),oi(O,"id","input_protocol"),oi(O,"type","number"),oi(O,"class","validate"),oi(Y,"class","active"),oi(Y,"for","input_protocol"),oi(A,"class","input-field"),oi(S,"class","addr-part row svelte-o3lud4"),oi(ft,"class","addr-form svelte-o3lud4"),oi(Tt,"autocomplete","off"),oi(ze,"class","btn waves-effect waves-light btn-small red"),oi(ze,"type","submit"),oi(ze,"name","action"),oi(I,"class","addr-container svelte-o3lud4")},m(vt,rt){Oo(vt,I,rt),gt(I,Tt),gt(Tt,ft),gt(ft,At),gt(At,Yt),gt(Yt,ei),Pa(ei,Ne[0]),gt(Yt,n),gt(Yt,g),gt(g,x),gt(ft,v),gt(ft,h),gt(h,a),gt(a,c),Pa(c,Ne[1]),gt(a,d),gt(a,_),gt(_,u),gt(ft,C),gt(ft,S),gt(S,A),gt(A,O),Pa(O,Ne[2]),gt(A,U),gt(A,Y),gt(Y,oe),gt(I,ge),gt(I,ze),gt(ze,We),at||(_t=[uo(ei,"input",Ne[8]),uo(c,"input",Ne[9]),uo(O,"input",Ne[10]),uo(ze,"click",Ne[7])],at=!0)},p(vt,[rt]){rt&1&&ei.value!==vt[0]&&Pa(ei,vt[0]),rt&2&&c.value!==vt[1]&&Pa(c,vt[1]),rt&4&&Su(O.value)!==vt[2]&&Pa(O,vt[2])},i:aa,o:aa,d(vt){vt&&Kt(I),at=!1,Tu(_t)}}}function Df(Ne,I,Tt){let ft,At,Yt,ei;const{schema:n,host:g,port:x}=jl;Ln(Ne,n,u=>Tt(0,At=u)),Ln(Ne,g,u=>Tt(1,Yt=u)),Ln(Ne,x,u=>Tt(2,ei=u));const{apiURL:v}=jl;Ln(Ne,v,u=>Tt(12,ft=u));let h=ft;const a=()=>{h!==ft&&(Xc.set(ft),h=ft)};Xl(()=>{console.log(`Initial address: '${ft}'`)});function c(){At=this.value,n.set(At)}function d(){Yt=this.value,g.set(Yt)}function _(){ei=Su(this.value),x.set(ei)}return[At,Yt,ei,n,g,x,v,a,c,d,_]}class Of extends Vl{constructor(I){super(),Nl(this,I,Df,kf,Gl,{})}}var Iu={exports:{}};(function(Ne,I){(function(Tt,ft){Ne.exports=ft()})(Ia,function(){var Tt=function(T,z){var $={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},ye={on:function(Te,ke,wt){if($[Te]===void 0)throw new Error("Invalid event type: "+Te);$[Te].push({selector:ke,fn:wt})},render:function(Te){z.store.featureChanged(Te)}},Le=function(Te,ke){for(var wt=$[Te],xt=wt.length;xt--;){var Ct=wt[xt];if(Ct.selector(ke)){Ct.fn.call(ye,ke)||z.store.render(),z.ui.updateMapClasses();break}}};return T.start.call(ye),{render:T.render,stop:function(){T.stop&&T.stop()},trash:function(){T.trash&&(T.trash(),z.store.render())},combineFeatures:function(){T.combineFeatures&&T.combineFeatures()},uncombineFeatures:function(){T.uncombineFeatures&&T.uncombineFeatures()},drag:function(Te){Le("drag",Te)},click:function(Te){Le("click",Te)},mousemove:function(Te){Le("mousemove",Te)},mousedown:function(Te){Le("mousedown",Te)},mouseup:function(Te){Le("mouseup",Te)},mouseout:function(Te){Le("mouseout",Te)},keydown:function(Te){Le("keydown",Te)},keyup:function(Te){Le("keyup",Te)},touchstart:function(Te){Le("touchstart",Te)},touchmove:function(Te){Le("touchmove",Te)},touchend:function(Te){Le("touchend",Te)},tap:function(Te){Le("tap",Te)}}},ft=6378137;function At(T){var z=0;if(T&&T.length>0){z+=Math.abs(Yt(T[0]));for(var $=1;$<T.length;$++)z-=Math.abs(Yt(T[$]))}return z}function Yt(T){var z,$,ye,Le,Te,ke,wt=0,xt=T.length;if(xt>2){for(ke=0;ke<xt;ke++)ke===xt-2?(ye=xt-2,Le=xt-1,Te=0):ke===xt-1?(ye=xt-1,Le=0,Te=1):(ye=ke,Le=ke+1,Te=ke+2),z=T[ye],$=T[Le],wt+=(ei(T[Te][0])-ei(z[0]))*Math.sin(ei($[1]));wt=wt*ft*ft/2}return wt}function ei(T){return T*Math.PI/180}var n={geometry:function T(z){var $,ye=0;switch(z.type){case"Polygon":return At(z.coordinates);case"MultiPolygon":for($=0;$<z.coordinates.length;$++)ye+=At(z.coordinates[$]);return ye;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for($=0;$<z.geometries.length;$++)ye+=T(z.geometries[$]);return ye}},ring:Yt},g="mapboxgl-ctrl",x="mapbox-gl-draw_ctrl-draw-btn",v="mapbox-gl-draw_line",h="mapbox-gl-draw_polygon",a="mapbox-gl-draw_point",c="mapbox-gl-draw_trash",d="mapbox-gl-draw_combine",_="mapbox-gl-draw_uncombine",u="mapboxgl-ctrl-group",C="active",S="mapbox-gl-draw_boxselect",A="mapbox-gl-draw-hot",O="mapbox-gl-draw-cold",U="add",Y="move",oe="drag",ge="pointer",ze="none",We={POLYGON:"polygon",LINE:"line_string",POINT:"point"},at="Feature",_t="Polygon",vt="LineString",rt="Point",mt="FeatureCollection",Qe="Multi",zt="MultiPoint",Et="MultiLineString",Q="MultiPolygon",se={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select",STATIC:"static"},de="draw.create",ie="draw.delete",ve="draw.update",J="draw.selectionchange",q="draw.modechange",ce="draw.actionable",be="draw.render",De="draw.combine",Ie="draw.uncombine",tt="move",ut="change_coordinates",nt="feature",je="midpoint",Ce="vertex",Ve="true",Je="false",$e=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],lt={Point:0,LineString:1,Polygon:2};function ot(T,z){var $=lt[T.geometry.type]-lt[z.geometry.type];return $===0&&T.geometry.type===_t?T.area-z.area:$}function Gt(T){if(this._items={},this._nums={},this._length=T?T.length:0,T)for(var z=0,$=T.length;z<$;z++)this.add(T[z]),T[z]!==void 0&&(typeof T[z]=="string"?this._items[T[z]]=z:this._nums[T[z]]=z)}Gt.prototype.add=function(T){return this.has(T)||(this._length++,typeof T=="string"?this._items[T]=this._length:this._nums[T]=this._length),this},Gt.prototype.delete=function(T){return this.has(T)===!1||(this._length--,delete this._items[T],delete this._nums[T]),this},Gt.prototype.has=function(T){return(typeof T=="string"||typeof T=="number")&&(this._items[T]!==void 0||this._nums[T]!==void 0)},Gt.prototype.values=function(){var T=this,z=[];return Object.keys(this._items).forEach(function($){z.push({k:$,v:T._items[$]})}),Object.keys(this._nums).forEach(function($){z.push({k:JSON.parse($),v:T._nums[$]})}),z.sort(function($,ye){return $.v-ye.v}).map(function($){return $.k})},Gt.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};var Xt=[nt,je,Ce],He={click:function(T,z,$){return jt(T,z,$,$.options.clickBuffer)},touch:function(T,z,$){return jt(T,z,$,$.options.touchBuffer)}};function jt(T,z,$,ye){if($.map===null)return[];var Le=T?function(Ct,Re){return Re===void 0&&(Re=0),[[Ct.point.x-Re,Ct.point.y-Re],[Ct.point.x+Re,Ct.point.y+Re]]}(T,ye):z,Te={};$.options.styles&&(Te.layers=$.options.styles.map(function(Ct){return Ct.id}));var ke=$.map.queryRenderedFeatures(Le,Te).filter(function(Ct){return Xt.indexOf(Ct.properties.meta)!==-1}),wt=new Gt,xt=[];return ke.forEach(function(Ct){var Re=Ct.properties.id;wt.has(Re)||(wt.add(Re),xt.push(Ct))}),function(Ct){return Ct.map(function(Re){return Re.geometry.type===_t&&(Re.area=n.geometry({type:at,property:{},geometry:Re.geometry})),Re}).sort(ot).map(function(Re){return delete Re.area,Re})}(xt)}function qt(T,z){var $=He.click(T,null,z),ye={mouse:ze};return $[0]&&(ye.mouse=$[0].properties.active===Ve?Y:ge,ye.feature=$[0].properties.meta),z.events.currentModeName().indexOf("draw")!==-1&&(ye.mouse=U),z.ui.queueMapClasses(ye),z.ui.updateMapClasses(),$[0]}function mi(T,z){var $=T.x-z.x,ye=T.y-z.y;return Math.sqrt($*$+ye*ye)}function Di(T,z,$){$===void 0&&($={});var ye=$.fineTolerance!=null?$.fineTolerance:4,Le=$.grossTolerance!=null?$.grossTolerance:12,Te=$.interval!=null?$.interval:500;T.point=T.point||z.point,T.time=T.time||z.time;var ke=mi(T.point,z.point);return ke<ye||ke<Le&&z.time-T.time<Te}function wi(T,z,$){$===void 0&&($={});var ye=$.tolerance!=null?$.tolerance:25,Le=$.interval!=null?$.interval:250;return T.point=T.point||z.point,T.time=T.time||z.time,mi(T.point,z.point)<ye&&z.time-T.time<Le}function Ue(T,z){return T(z={exports:{}},z.exports),z.exports}var yt=Ue(function(T){var z=T.exports=function($,ye){if(ye||(ye=16),$===void 0&&($=128),$<=0)return"0";for(var Le=Math.log(Math.pow(2,$))/Math.log(ye),Te=2;Le===1/0;Te*=2)Le=Math.log(Math.pow(2,$/Te))/Math.log(ye)*Te;var ke=Le-Math.floor(Le),wt="";for(Te=0;Te<Math.floor(Le);Te++)wt=Math.floor(Math.random()*ye).toString(ye)+wt;if(ke){var xt=Math.pow(ye,ke);wt=Math.floor(Math.random()*xt).toString(ye)+wt}var Ct=parseInt(wt,ye);return Ct!==1/0&&Ct>=Math.pow(2,$)?z($,ye):wt};z.rack=function($,ye,Le){var Te=function(wt){var xt=0;do{if(xt++>10){if(!Le)throw new Error("too many ID collisions, use more bits");$+=Le}var Ct=z($,ye)}while(Object.hasOwnProperty.call(ke,Ct));return ke[Ct]=wt,Ct},ke=Te.hats={};return Te.get=function(wt){return Te.hats[wt]},Te.set=function(wt,xt){return Te.hats[wt]=xt,Te},Te.bits=$||128,Te.base=ye||16,Te}}),Ri=function(T,z){this.ctx=T,this.properties=z.properties||{},this.coordinates=z.geometry.coordinates,this.id=z.id||yt(),this.type=z.geometry.type};Ri.prototype.changed=function(){this.ctx.store.featureChanged(this.id)},Ri.prototype.incomingCoords=function(T){this.setCoordinates(T)},Ri.prototype.setCoordinates=function(T){this.coordinates=T,this.changed()},Ri.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))},Ri.prototype.setProperty=function(T,z){this.properties[T]=z},Ri.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:at,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))},Ri.prototype.internal=function(T){var z={id:this.id,meta:nt,"meta:type":this.type,active:Je,mode:T};if(this.ctx.options.userProperties)for(var $ in this.properties)z["user_"+$]=this.properties[$];return{type:at,properties:z,geometry:{coordinates:this.getCoordinates(),type:this.type}}};var Zi=function(T,z){Ri.call(this,T,z)};(Zi.prototype=Object.create(Ri.prototype)).isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"},Zi.prototype.updateCoordinate=function(T,z,$){this.coordinates=arguments.length===3?[z,$]:[T,z],this.changed()},Zi.prototype.getCoordinate=function(){return this.getCoordinates()};var ri=function(T,z){Ri.call(this,T,z)};(ri.prototype=Object.create(Ri.prototype)).isValid=function(){return this.coordinates.length>1},ri.prototype.addCoordinate=function(T,z,$){this.changed();var ye=parseInt(T,10);this.coordinates.splice(ye,0,[z,$])},ri.prototype.getCoordinate=function(T){var z=parseInt(T,10);return JSON.parse(JSON.stringify(this.coordinates[z]))},ri.prototype.removeCoordinate=function(T){this.changed(),this.coordinates.splice(parseInt(T,10),1)},ri.prototype.updateCoordinate=function(T,z,$){var ye=parseInt(T,10);this.coordinates[ye]=[z,$],this.changed()};var Ei=function(T,z){Ri.call(this,T,z),this.coordinates=this.coordinates.map(function($){return $.slice(0,-1)})};(Ei.prototype=Object.create(Ri.prototype)).isValid=function(){return this.coordinates.length!==0&&this.coordinates.every(function(T){return T.length>2})},Ei.prototype.incomingCoords=function(T){this.coordinates=T.map(function(z){return z.slice(0,-1)}),this.changed()},Ei.prototype.setCoordinates=function(T){this.coordinates=T,this.changed()},Ei.prototype.addCoordinate=function(T,z,$){this.changed();var ye=T.split(".").map(function(Le){return parseInt(Le,10)});this.coordinates[ye[0]].splice(ye[1],0,[z,$])},Ei.prototype.removeCoordinate=function(T){this.changed();var z=T.split(".").map(function(ye){return parseInt(ye,10)}),$=this.coordinates[z[0]];$&&($.splice(z[1],1),$.length<3&&this.coordinates.splice(z[0],1))},Ei.prototype.getCoordinate=function(T){var z=T.split(".").map(function(ye){return parseInt(ye,10)}),$=this.coordinates[z[0]];return JSON.parse(JSON.stringify($[z[1]]))},Ei.prototype.getCoordinates=function(){return this.coordinates.map(function(T){return T.concat([T[0]])})},Ei.prototype.updateCoordinate=function(T,z,$){this.changed();var ye=T.split("."),Le=parseInt(ye[0],10),Te=parseInt(ye[1],10);this.coordinates[Le]===void 0&&(this.coordinates[Le]=[]),this.coordinates[Le][Te]=[z,$]};var dr={MultiPoint:Zi,MultiLineString:ri,MultiPolygon:Ei},fr=function(T,z,$,ye,Le){var Te=$.split("."),ke=parseInt(Te[0],10),wt=Te[1]?Te.slice(1).join("."):null;return T[ke][z](wt,ye,Le)},Ki=function(T,z){if(Ri.call(this,T,z),delete this.coordinates,this.model=dr[z.geometry.type],this.model===void 0)throw new TypeError(z.geometry.type+" is not a valid type");this.features=this._coordinatesToFeatures(z.geometry.coordinates)};function st(T){this.map=T.map,this.drawConfig=JSON.parse(JSON.stringify(T.options||{})),this._ctx=T}(Ki.prototype=Object.create(Ri.prototype))._coordinatesToFeatures=function(T){var z=this,$=this.model.bind(this);return T.map(function(ye){return new $(z.ctx,{id:yt(),type:at,properties:{},geometry:{coordinates:ye,type:z.type.replace("Multi","")}})})},Ki.prototype.isValid=function(){return this.features.every(function(T){return T.isValid()})},Ki.prototype.setCoordinates=function(T){this.features=this._coordinatesToFeatures(T),this.changed()},Ki.prototype.getCoordinate=function(T){return fr(this.features,"getCoordinate",T)},Ki.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(function(T){return T.type===_t?T.getCoordinates():T.coordinates})))},Ki.prototype.updateCoordinate=function(T,z,$){fr(this.features,"updateCoordinate",T,z,$),this.changed()},Ki.prototype.addCoordinate=function(T,z,$){fr(this.features,"addCoordinate",T,z,$),this.changed()},Ki.prototype.removeCoordinate=function(T){fr(this.features,"removeCoordinate",T),this.changed()},Ki.prototype.getFeatures=function(){return this.features},st.prototype.setSelected=function(T){return this._ctx.store.setSelected(T)},st.prototype.setSelectedCoordinates=function(T){var z=this;this._ctx.store.setSelectedCoordinates(T),T.reduce(function($,ye){return $[ye.feature_id]===void 0&&($[ye.feature_id]=!0,z._ctx.store.get(ye.feature_id).changed()),$},{})},st.prototype.getSelected=function(){return this._ctx.store.getSelected()},st.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()},st.prototype.isSelected=function(T){return this._ctx.store.isSelected(T)},st.prototype.getFeature=function(T){return this._ctx.store.get(T)},st.prototype.select=function(T){return this._ctx.store.select(T)},st.prototype.deselect=function(T){return this._ctx.store.deselect(T)},st.prototype.deleteFeature=function(T,z){return z===void 0&&(z={}),this._ctx.store.delete(T,z)},st.prototype.addFeature=function(T){return this._ctx.store.add(T)},st.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()},st.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()},st.prototype.setActionableState=function(T){T===void 0&&(T={});var z={trash:T.trash||!1,combineFeatures:T.combineFeatures||!1,uncombineFeatures:T.uncombineFeatures||!1};return this._ctx.events.actionable(z)},st.prototype.changeMode=function(T,z,$){return z===void 0&&(z={}),$===void 0&&($={}),this._ctx.events.changeMode(T,z,$)},st.prototype.updateUIClasses=function(T){return this._ctx.ui.queueMapClasses(T)},st.prototype.activateUIButton=function(T){return this._ctx.ui.setActiveButton(T)},st.prototype.featuresAt=function(T,z,$){if($===void 0&&($="click"),$!=="click"&&$!=="touch")throw new Error("invalid buffer type");return He[$](T,z,this._ctx)},st.prototype.newFeature=function(T){var z=T.geometry.type;return z===rt?new Zi(this._ctx,T):z===vt?new ri(this._ctx,T):z===_t?new Ei(this._ctx,T):new Ki(this._ctx,T)},st.prototype.isInstanceOf=function(T,z){if(T===rt)return z instanceof Zi;if(T===vt)return z instanceof ri;if(T===_t)return z instanceof Ei;if(T==="MultiFeature")return z instanceof Ki;throw new Error("Unknown feature class: "+T)},st.prototype.doRender=function(T){return this._ctx.store.featureChanged(T)},st.prototype.onSetup=function(){},st.prototype.onDrag=function(){},st.prototype.onClick=function(){},st.prototype.onMouseMove=function(){},st.prototype.onMouseDown=function(){},st.prototype.onMouseUp=function(){},st.prototype.onMouseOut=function(){},st.prototype.onKeyUp=function(){},st.prototype.onKeyDown=function(){},st.prototype.onTouchStart=function(){},st.prototype.onTouchMove=function(){},st.prototype.onTouchEnd=function(){},st.prototype.onTap=function(){},st.prototype.onStop=function(){},st.prototype.onTrash=function(){},st.prototype.onCombineFeature=function(){},st.prototype.onUncombineFeature=function(){},st.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};var bi={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},xi=Object.keys(bi);function br(T){var z=Object.keys(T);return function($,ye){ye===void 0&&(ye={});var Le={},Te=z.reduce(function(ke,wt){return ke[wt]=T[wt],ke},new st($));return{start:function(){var ke=this;Le=Te.onSetup(ye),xi.forEach(function(wt){var xt,Ct=bi[wt],Re=function(){return!1};T[Ct]&&(Re=function(){return!0}),ke.on(wt,Re,(xt=Ct,function(Mt){return Te[xt](Le,Mt)}))})},stop:function(){Te.onStop(Le)},trash:function(){Te.onTrash(Le)},combineFeatures:function(){Te.onCombineFeatures(Le)},uncombineFeatures:function(){Te.onUncombineFeatures(Le)},render:function(ke,wt){Te.toDisplayFeatures(Le,ke,wt)}}}}function tn(T){return[].concat(T).filter(function(z){return z!==void 0})}function yi(){var T=this;if(!(T.ctx.map&&T.ctx.map.getSource(A)!==void 0))return xt();var z=T.ctx.events.currentModeName();T.ctx.ui.queueMapClasses({mode:z});var $=[],ye=[];T.isDirty?ye=T.getAllIds():($=T.getChangedIds().filter(function(Ct){return T.get(Ct)!==void 0}),ye=T.sources.hot.filter(function(Ct){return Ct.properties.id&&$.indexOf(Ct.properties.id)===-1&&T.get(Ct.properties.id)!==void 0}).map(function(Ct){return Ct.properties.id})),T.sources.hot=[];var Le=T.sources.cold.length;T.sources.cold=T.isDirty?[]:T.sources.cold.filter(function(Ct){var Re=Ct.properties.id||Ct.properties.parent;return $.indexOf(Re)===-1});var Te=Le!==T.sources.cold.length||ye.length>0;function ke(Ct,Re){var Mt=T.get(Ct).internal(z);T.ctx.events.currentModeRender(Mt,function(Nt){T.sources[Re].push(Nt)})}if($.forEach(function(Ct){return ke(Ct,"hot")}),ye.forEach(function(Ct){return ke(Ct,"cold")}),Te&&T.ctx.map.getSource(O).setData({type:mt,features:T.sources.cold}),T.ctx.map.getSource(A).setData({type:mt,features:T.sources.hot}),T._emitSelectionChange&&(T.ctx.map.fire(J,{features:T.getSelected().map(function(Ct){return Ct.toGeoJSON()}),points:T.getSelectedCoordinates().map(function(Ct){return{type:at,properties:{},geometry:{type:rt,coordinates:Ct.coordinates}}})}),T._emitSelectionChange=!1),T._deletedFeaturesToEmit.length){var wt=T._deletedFeaturesToEmit.map(function(Ct){return Ct.toGeoJSON()});T._deletedFeaturesToEmit=[],T.ctx.map.fire(ie,{features:wt})}function xt(){T.isDirty=!1,T.clearChangedIds()}xt(),T.ctx.map.fire(be,{})}function Oi(T){var z,$=this;this._features={},this._featureIds=new Gt,this._selectedFeatureIds=new Gt,this._selectedCoordinates=[],this._changedFeatureIds=new Gt,this._deletedFeaturesToEmit=[],this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=T,this.sources={hot:[],cold:[]},this.render=function(){z||(z=requestAnimationFrame(function(){z=null,yi.call($)}))},this.isDirty=!1}function wr(T,z){var $=T._selectedCoordinates.filter(function(ye){return T._selectedFeatureIds.has(ye.feature_id)});T._selectedCoordinates.length===$.length||z.silent||(T._emitSelectionChange=!0),T._selectedCoordinates=$}Oi.prototype.createRenderBatch=function(){var T=this,z=this.render,$=0;return this.render=function(){$++},function(){T.render=z,$>0&&T.render()}},Oi.prototype.setDirty=function(){return this.isDirty=!0,this},Oi.prototype.featureChanged=function(T){return this._changedFeatureIds.add(T),this},Oi.prototype.getChangedIds=function(){return this._changedFeatureIds.values()},Oi.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this},Oi.prototype.getAllIds=function(){return this._featureIds.values()},Oi.prototype.add=function(T){return this.featureChanged(T.id),this._features[T.id]=T,this._featureIds.add(T.id),this},Oi.prototype.delete=function(T,z){var $=this;return z===void 0&&(z={}),tn(T).forEach(function(ye){$._featureIds.has(ye)&&($._featureIds.delete(ye),$._selectedFeatureIds.delete(ye),z.silent||$._deletedFeaturesToEmit.indexOf($._features[ye])===-1&&$._deletedFeaturesToEmit.push($._features[ye]),delete $._features[ye],$.isDirty=!0)}),wr(this,z),this},Oi.prototype.get=function(T){return this._features[T]},Oi.prototype.getAll=function(){var T=this;return Object.keys(this._features).map(function(z){return T._features[z]})},Oi.prototype.select=function(T,z){var $=this;return z===void 0&&(z={}),tn(T).forEach(function(ye){$._selectedFeatureIds.has(ye)||($._selectedFeatureIds.add(ye),$._changedFeatureIds.add(ye),z.silent||($._emitSelectionChange=!0))}),this},Oi.prototype.deselect=function(T,z){var $=this;return z===void 0&&(z={}),tn(T).forEach(function(ye){$._selectedFeatureIds.has(ye)&&($._selectedFeatureIds.delete(ye),$._changedFeatureIds.add(ye),z.silent||($._emitSelectionChange=!0))}),wr(this,z),this},Oi.prototype.clearSelected=function(T){return T===void 0&&(T={}),this.deselect(this._selectedFeatureIds.values(),{silent:T.silent}),this},Oi.prototype.setSelected=function(T,z){var $=this;return z===void 0&&(z={}),T=tn(T),this.deselect(this._selectedFeatureIds.values().filter(function(ye){return T.indexOf(ye)===-1}),{silent:z.silent}),this.select(T.filter(function(ye){return!$._selectedFeatureIds.has(ye)}),{silent:z.silent}),this},Oi.prototype.setSelectedCoordinates=function(T){return this._selectedCoordinates=T,this._emitSelectionChange=!0,this},Oi.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this},Oi.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()},Oi.prototype.getSelected=function(){var T=this;return this._selectedFeatureIds.values().map(function(z){return T.get(z)})},Oi.prototype.getSelectedCoordinates=function(){var T=this;return this._selectedCoordinates.map(function(z){return{coordinates:T.get(z.feature_id).getCoordinate(z.coord_path)}})},Oi.prototype.isSelected=function(T){return this._selectedFeatureIds.has(T)},Oi.prototype.setFeatureProperty=function(T,z,$){this.get(T).setProperty(z,$),this.featureChanged(T)},Oi.prototype.storeMapConfig=function(){var T=this;$e.forEach(function(z){T.ctx.map[z]&&(T._mapInitialConfig[z]=T.ctx.map[z].isEnabled())})},Oi.prototype.restoreMapConfig=function(){var T=this;Object.keys(this._mapInitialConfig).forEach(function(z){T._mapInitialConfig[z]?T.ctx.map[z].enable():T.ctx.map[z].disable()})},Oi.prototype.getInitialConfigValue=function(T){return this._mapInitialConfig[T]===void 0||this._mapInitialConfig[T]};var Vr=function(){for(var T=arguments,z={},$=0;$<arguments.length;$++){var ye=T[$];for(var Le in ye)lr.call(ye,Le)&&(z[Le]=ye[Le])}return z},lr=Object.prototype.hasOwnProperty,Dr=["mode","feature","mouse"];function Xi(T){var z=null,$=null,ye={onRemove:function(){return T.map.off("load",ye.connect),clearInterval($),ye.removeLayers(),T.store.restoreMapConfig(),T.ui.removeButtons(),T.events.removeEventListeners(),T.ui.clearMapClasses(),T.map=null,T.container=null,T.store=null,z&&z.parentNode&&z.parentNode.removeChild(z),z=null,this},connect:function(){T.map.off("load",ye.connect),clearInterval($),ye.addLayers(),T.store.storeMapConfig(),T.events.addEventListeners()},onAdd:function(Le){var Te=Le.fire;return Le.fire=function(ke,wt){var xt=arguments;return Te.length===1&&arguments.length!==1&&(xt=[Vr({},{type:ke},wt)]),Te.apply(Le,xt)},T.map=Le,T.events=function(ke){var wt=Object.keys(ke.options.modes).reduce(function(dt,Zt){return dt[Zt]=br(ke.options.modes[Zt]),dt},{}),xt={},Ct={},Re={},Mt=null,Nt=null;Re.drag=function(dt,Zt){Zt({point:dt.point,time:new Date().getTime()})?(ke.ui.queueMapClasses({mouse:oe}),Nt.drag(dt)):dt.originalEvent.stopPropagation()},Re.mousedrag=function(dt){Re.drag(dt,function(Zt){return!Di(xt,Zt)})},Re.touchdrag=function(dt){Re.drag(dt,function(Zt){return!wi(Ct,Zt)})},Re.mousemove=function(dt){if((dt.originalEvent.buttons!==void 0?dt.originalEvent.buttons:dt.originalEvent.which)===1)return Re.mousedrag(dt);var Zt=qt(dt,ke);dt.featureTarget=Zt,Nt.mousemove(dt)},Re.mousedown=function(dt){xt={time:new Date().getTime(),point:dt.point};var Zt=qt(dt,ke);dt.featureTarget=Zt,Nt.mousedown(dt)},Re.mouseup=function(dt){var Zt=qt(dt,ke);dt.featureTarget=Zt,Di(xt,{point:dt.point,time:new Date().getTime()})?Nt.click(dt):Nt.mouseup(dt)},Re.mouseout=function(dt){Nt.mouseout(dt)},Re.touchstart=function(dt){if(dt.originalEvent.preventDefault(),ke.options.touchEnabled){Ct={time:new Date().getTime(),point:dt.point};var Zt=He.touch(dt,null,ke)[0];dt.featureTarget=Zt,Nt.touchstart(dt)}},Re.touchmove=function(dt){if(dt.originalEvent.preventDefault(),ke.options.touchEnabled)return Nt.touchmove(dt),Re.touchdrag(dt)},Re.touchend=function(dt){if(dt.originalEvent.preventDefault(),ke.options.touchEnabled){var Zt=He.touch(dt,null,ke)[0];dt.featureTarget=Zt,wi(Ct,{time:new Date().getTime(),point:dt.point})?Nt.tap(dt):Nt.touchend(dt)}};var li=function(dt){return!(dt===8||dt===46||dt>=48&&dt<=57)};function _i(dt,Zt,qi){qi===void 0&&(qi={}),Nt.stop();var $i=wt[dt];if($i===void 0)throw new Error(dt+" is not valid");Mt=dt;var hr=$i(ke,Zt);Nt=Tt(hr,ke),qi.silent||ke.map.fire(q,{mode:dt}),ke.store.setDirty(),ke.store.render()}Re.keydown=function(dt){(dt.srcElement||dt.target).classList[0]==="mapboxgl-canvas"&&(dt.keyCode!==8&&dt.keyCode!==46||!ke.options.controls.trash?li(dt.keyCode)?Nt.keydown(dt):dt.keyCode===49&&ke.options.controls.point?_i(se.DRAW_POINT):dt.keyCode===50&&ke.options.controls.line_string?_i(se.DRAW_LINE_STRING):dt.keyCode===51&&ke.options.controls.polygon&&_i(se.DRAW_POLYGON):(dt.preventDefault(),Nt.trash()))},Re.keyup=function(dt){li(dt.keyCode)&&Nt.keyup(dt)},Re.zoomend=function(){ke.store.changeZoom()},Re.data=function(dt){if(dt.dataType==="style"){var Zt=ke.setup,qi=ke.map,$i=ke.options,hr=ke.store;$i.styles.some(function(ci){return qi.getLayer(ci.id)})||(Zt.addLayers(),hr.setDirty(),hr.render())}};var Cr={trash:!1,combineFeatures:!1,uncombineFeatures:!1};return{start:function(){Mt=ke.options.defaultMode,Nt=Tt(wt[Mt](ke),ke)},changeMode:_i,actionable:function(dt){var Zt=!1;Object.keys(dt).forEach(function(qi){if(Cr[qi]===void 0)throw new Error("Invalid action type");Cr[qi]!==dt[qi]&&(Zt=!0),Cr[qi]=dt[qi]}),Zt&&ke.map.fire(ce,{actions:Cr})},currentModeName:function(){return Mt},currentModeRender:function(dt,Zt){return Nt.render(dt,Zt)},fire:function(dt,Zt){Re[dt]&&Re[dt](Zt)},addEventListeners:function(){ke.map.on("mousemove",Re.mousemove),ke.map.on("mousedown",Re.mousedown),ke.map.on("mouseup",Re.mouseup),ke.map.on("data",Re.data),ke.map.on("touchmove",Re.touchmove),ke.map.on("touchstart",Re.touchstart),ke.map.on("touchend",Re.touchend),ke.container.addEventListener("mouseout",Re.mouseout),ke.options.keybindings&&(ke.container.addEventListener("keydown",Re.keydown),ke.container.addEventListener("keyup",Re.keyup))},removeEventListeners:function(){ke.map.off("mousemove",Re.mousemove),ke.map.off("mousedown",Re.mousedown),ke.map.off("mouseup",Re.mouseup),ke.map.off("data",Re.data),ke.map.off("touchmove",Re.touchmove),ke.map.off("touchstart",Re.touchstart),ke.map.off("touchend",Re.touchend),ke.container.removeEventListener("mouseout",Re.mouseout),ke.options.keybindings&&(ke.container.removeEventListener("keydown",Re.keydown),ke.container.removeEventListener("keyup",Re.keyup))},trash:function(dt){Nt.trash(dt)},combineFeatures:function(){Nt.combineFeatures()},uncombineFeatures:function(){Nt.uncombineFeatures()},getMode:function(){return Mt}}}(T),T.ui=function(ke){var wt={},xt=null,Ct={mode:null,feature:null,mouse:null},Re={mode:null,feature:null,mouse:null};function Mt(dt){Re=Vr(Re,dt)}function Nt(){var dt,Zt;if(ke.container){var qi=[],$i=[];Dr.forEach(function(hr){Re[hr]!==Ct[hr]&&(qi.push(hr+"-"+Ct[hr]),Re[hr]!==null&&$i.push(hr+"-"+Re[hr]))}),qi.length>0&&(dt=ke.container.classList).remove.apply(dt,qi),$i.length>0&&(Zt=ke.container.classList).add.apply(Zt,$i),Ct=Vr(Ct,Re)}}function li(dt,Zt){Zt===void 0&&(Zt={});var qi=document.createElement("button");return qi.className=x+" "+Zt.className,qi.setAttribute("title",Zt.title),Zt.container.appendChild(qi),qi.addEventListener("click",function($i){if($i.preventDefault(),$i.stopPropagation(),$i.target===xt)return _i(),void Zt.onDeactivate();Cr(dt),Zt.onActivate()},!0),qi}function _i(){xt&&(xt.classList.remove(C),xt=null)}function Cr(dt){_i();var Zt=wt[dt];Zt&&Zt&&dt!=="trash"&&(Zt.classList.add(C),xt=Zt)}return{setActiveButton:Cr,queueMapClasses:Mt,updateMapClasses:Nt,clearMapClasses:function(){Mt({mode:null,feature:null,mouse:null}),Nt()},addButtons:function(){var dt=ke.options.controls,Zt=document.createElement("div");return Zt.className=u+" "+g,dt&&(dt[We.LINE]&&(wt[We.LINE]=li(We.LINE,{container:Zt,className:v,title:"LineString tool "+(ke.options.keybindings?"(l)":""),onActivate:function(){return ke.events.changeMode(se.DRAW_LINE_STRING)},onDeactivate:function(){return ke.events.trash()}})),dt[We.POLYGON]&&(wt[We.POLYGON]=li(We.POLYGON,{container:Zt,className:h,title:"Polygon tool "+(ke.options.keybindings?"(p)":""),onActivate:function(){return ke.events.changeMode(se.DRAW_POLYGON)},onDeactivate:function(){return ke.events.trash()}})),dt[We.POINT]&&(wt[We.POINT]=li(We.POINT,{container:Zt,className:a,title:"Marker tool "+(ke.options.keybindings?"(m)":""),onActivate:function(){return ke.events.changeMode(se.DRAW_POINT)},onDeactivate:function(){return ke.events.trash()}})),dt.trash&&(wt.trash=li("trash",{container:Zt,className:c,title:"Delete",onActivate:function(){ke.events.trash()}})),dt.combine_features&&(wt.combine_features=li("combineFeatures",{container:Zt,className:d,title:"Combine",onActivate:function(){ke.events.combineFeatures()}})),dt.uncombine_features&&(wt.uncombine_features=li("uncombineFeatures",{container:Zt,className:_,title:"Uncombine",onActivate:function(){ke.events.uncombineFeatures()}}))),Zt},removeButtons:function(){Object.keys(wt).forEach(function(dt){var Zt=wt[dt];Zt.parentNode&&Zt.parentNode.removeChild(Zt),delete wt[dt]})}}}(T),T.container=Le.getContainer(),T.store=new Oi(T),z=T.ui.addButtons(),T.options.boxSelect&&(Le.boxZoom.disable(),Le.dragPan.disable(),Le.dragPan.enable()),Le.loaded()?ye.connect():(Le.on("load",ye.connect),$=setInterval(function(){Le.loaded()&&ye.connect()},16)),T.events.start(),z},addLayers:function(){T.map.addSource(O,{data:{type:mt,features:[]},type:"geojson"}),T.map.addSource(A,{data:{type:mt,features:[]},type:"geojson"}),T.options.styles.forEach(function(Le){T.map.addLayer(Le)}),T.store.setDirty(!0),T.store.render()},removeLayers:function(){T.options.styles.forEach(function(Le){T.map.getLayer(Le.id)&&T.map.removeLayer(Le.id)}),T.map.getSource(O)&&T.map.removeSource(O),T.map.getSource(A)&&T.map.removeSource(A)}};return T.setup=ye,ye}function as(T){return function(z){var $=z.featureTarget;return!!$&&!!$.properties&&$.properties.meta===T}}function Zr(T){return!!T.featureTarget&&!!T.featureTarget.properties&&T.featureTarget.properties.active===Ve&&T.featureTarget.properties.meta===nt}function ls(T){return!!T.featureTarget&&!!T.featureTarget.properties&&T.featureTarget.properties.active===Je&&T.featureTarget.properties.meta===nt}function Wn(T){return T.featureTarget===void 0}function $n(T){var z=T.featureTarget;return!!z&&!!z.properties&&z.properties.meta===Ce}function qn(T){return!!T.originalEvent&&T.originalEvent.shiftKey===!0}function re(T){return T.keyCode===27}function B(T){return T.keyCode===13}var G=ee;function ee(T,z){this.x=T,this.y=z}function te(T,z){var $=z.getBoundingClientRect();return new G(T.clientX-$.left-(z.clientLeft||0),T.clientY-$.top-(z.clientTop||0))}function fe(T,z,$,ye){return{type:at,properties:{meta:Ce,parent:T,coord_path:$,active:ye?Ve:Je},geometry:{type:rt,coordinates:z}}}function we(T,z,$){z===void 0&&(z={}),$===void 0&&($=null);var ye,Le=T.geometry,Te=Le.type,ke=Le.coordinates,wt=T.properties&&T.properties.id,xt=[];function Ct(Mt,Nt){var li="",_i=null;Mt.forEach(function(Cr,dt){var Zt=Nt!=null?Nt+"."+dt:String(dt),qi=fe(wt,Cr,Zt,Re(Zt));if(z.midpoints&&_i){var $i=function(ci,Ai,Hn){var Wi=Ai.geometry.coordinates,Jr=Hn.geometry.coordinates;if(Wi[1]>85||Wi[1]<-85||Jr[1]>85||Jr[1]<-85)return null;var Or={lng:(Wi[0]+Jr[0])/2,lat:(Wi[1]+Jr[1])/2};return{type:at,properties:{meta:je,parent:ci,lng:Or.lng,lat:Or.lat,coord_path:Hn.properties.coord_path},geometry:{type:rt,coordinates:[Or.lng,Or.lat]}}}(wt,_i,qi);$i&&xt.push($i)}_i=qi;var hr=JSON.stringify(Cr);li!==hr&&xt.push(qi),dt===0&&(li=hr)})}function Re(Mt){return!!z.selectedPaths&&z.selectedPaths.indexOf(Mt)!==-1}return Te===rt?xt.push(fe(wt,ke,$,Re($))):Te===_t?ke.forEach(function(Mt,Nt){Ct(Mt,$!==null?$+"."+Nt:String(Nt))}):Te===vt?Ct(ke,$):Te.indexOf(Qe)===0&&(ye=Te.replace(Qe,""),ke.forEach(function(Mt,Nt){var li={type:at,properties:T.properties,geometry:{type:ye,coordinates:Mt}};xt=xt.concat(we(li,z,Nt))})),xt}ee.prototype={clone:function(){return new ee(this.x,this.y)},add:function(T){return this.clone()._add(T)},sub:function(T){return this.clone()._sub(T)},multByPoint:function(T){return this.clone()._multByPoint(T)},divByPoint:function(T){return this.clone()._divByPoint(T)},mult:function(T){return this.clone()._mult(T)},div:function(T){return this.clone()._div(T)},rotate:function(T){return this.clone()._rotate(T)},rotateAround:function(T,z){return this.clone()._rotateAround(T,z)},matMult:function(T){return this.clone()._matMult(T)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(T){return this.x===T.x&&this.y===T.y},dist:function(T){return Math.sqrt(this.distSqr(T))},distSqr:function(T){var z=T.x-this.x,$=T.y-this.y;return z*z+$*$},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(T){return Math.atan2(this.y-T.y,this.x-T.x)},angleWith:function(T){return this.angleWithSep(T.x,T.y)},angleWithSep:function(T,z){return Math.atan2(this.x*z-this.y*T,this.x*T+this.y*z)},_matMult:function(T){var z=T[0]*this.x+T[1]*this.y,$=T[2]*this.x+T[3]*this.y;return this.x=z,this.y=$,this},_add:function(T){return this.x+=T.x,this.y+=T.y,this},_sub:function(T){return this.x-=T.x,this.y-=T.y,this},_mult:function(T){return this.x*=T,this.y*=T,this},_div:function(T){return this.x/=T,this.y/=T,this},_multByPoint:function(T){return this.x*=T.x,this.y*=T.y,this},_divByPoint:function(T){return this.x/=T.x,this.y/=T.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var T=this.y;return this.y=this.x,this.x=-T,this},_rotate:function(T){var z=Math.cos(T),$=Math.sin(T),ye=z*this.x-$*this.y,Le=$*this.x+z*this.y;return this.x=ye,this.y=Le,this},_rotateAround:function(T,z){var $=Math.cos(T),ye=Math.sin(T),Le=z.x+$*(this.x-z.x)-ye*(this.y-z.y),Te=z.y+ye*(this.x-z.x)+$*(this.y-z.y);return this.x=Le,this.y=Te,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},ee.convert=function(T){return T instanceof ee?T:Array.isArray(T)?new ee(T[0],T[1]):T};var _e=function(T){setTimeout(function(){T.map&&T.map.doubleClickZoom&&T._ctx&&T._ctx.store&&T._ctx.store.getInitialConfigValue&&T._ctx.store.getInitialConfigValue("doubleClickZoom")&&T.map.doubleClickZoom.enable()},0)},pe=function(T){setTimeout(function(){T.map&&T.map.doubleClickZoom&&T.map.doubleClickZoom.disable()},0)},Se=function(T){if(!T||!T.type)return null;var z=Ye[T.type];if(!z)return null;if(z==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:T}]};if(z==="feature")return{type:"FeatureCollection",features:[T]};if(z==="featurecollection")return T},Ye={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"};function pt(T){switch(T&&T.type||null){case"FeatureCollection":return T.features=T.features.reduce(function(z,$){return z.concat(pt($))},[]),T;case"Feature":return T.geometry?pt(T.geometry).map(function(z){var $={type:"Feature",properties:JSON.parse(JSON.stringify(T.properties)),geometry:z};return T.id!==void 0&&($.id=T.id),$}):[T];case"MultiPoint":return T.coordinates.map(function(z){return{type:"Point",coordinates:z}});case"MultiPolygon":return T.coordinates.map(function(z){return{type:"Polygon",coordinates:z}});case"MultiLineString":return T.coordinates.map(function(z){return{type:"LineString",coordinates:z}});case"GeometryCollection":return T.geometries.map(pt).reduce(function(z,$){return z.concat($)},[]);case"Point":case"Polygon":case"LineString":return[T]}}var qe=function(T){if(!T)return[];var z=pt(Se(T)),$=[];return z.features.forEach(function(ye){ye.geometry&&($=$.concat(function Le(Te){return Array.isArray(Te)&&Te.length&&typeof Te[0]=="number"?[Te]:Te.reduce(function(ke,wt){return Array.isArray(wt)&&Array.isArray(wt[0])?ke.concat(Le(wt)):(ke.push(wt),ke)},[])}(ye.geometry.coordinates)))}),$},Ht=Ue(function(T){var z=T.exports=function(Re){return new $(Re)};function $(Re){this.value=Re}function ye(Re,Mt,Nt){var li=[],_i=[],Cr=!0;return function dt(Zt){var qi=Nt?Le(Zt):Zt,$i={},hr=!0,ci={node:qi,node_:Zt,path:[].concat(li),parent:_i[_i.length-1],parents:_i,key:li.slice(-1)[0],isRoot:li.length===0,level:li.length,circular:null,update:function(Wi,Jr){ci.isRoot||(ci.parent.node[ci.key]=Wi),ci.node=Wi,Jr&&(hr=!1)},delete:function(Wi){delete ci.parent.node[ci.key],Wi&&(hr=!1)},remove:function(Wi){wt(ci.parent.node)?ci.parent.node.splice(ci.key,1):delete ci.parent.node[ci.key],Wi&&(hr=!1)},keys:null,before:function(Wi){$i.before=Wi},after:function(Wi){$i.after=Wi},pre:function(Wi){$i.pre=Wi},post:function(Wi){$i.post=Wi},stop:function(){Cr=!1},block:function(){hr=!1}};if(!Cr)return ci;function Ai(){if(typeof ci.node=="object"&&ci.node!==null){ci.keys&&ci.node_===ci.node||(ci.keys=Te(ci.node)),ci.isLeaf=ci.keys.length==0;for(var Wi=0;Wi<_i.length;Wi++)if(_i[Wi].node_===Zt){ci.circular=_i[Wi];break}}else ci.isLeaf=!0,ci.keys=null;ci.notLeaf=!ci.isLeaf,ci.notRoot=!ci.isRoot}Ai();var Hn=Mt.call(ci,ci.node);return Hn!==void 0&&ci.update&&ci.update(Hn),$i.before&&$i.before.call(ci,ci.node),hr&&(typeof ci.node!="object"||ci.node===null||ci.circular||(_i.push(ci),Ai(),xt(ci.keys,function(Wi,Jr){li.push(Wi),$i.pre&&$i.pre.call(ci,ci.node[Wi],Wi);var Or=dt(ci.node[Wi]);Nt&&Ct.call(ci.node,Wi)&&(ci.node[Wi]=Or.node),Or.isLast=Jr==ci.keys.length-1,Or.isFirst=Jr==0,$i.post&&$i.post.call(ci,Or),li.pop()}),_i.pop()),$i.after&&$i.after.call(ci,ci.node)),ci}(Re).node}function Le(Re){if(typeof Re=="object"&&Re!==null){var Mt;if(wt(Re))Mt=[];else if(ke(Re)==="[object Date]")Mt=new Date(Re.getTime?Re.getTime():Re);else if(function(_i){return ke(_i)==="[object RegExp]"}(Re))Mt=new RegExp(Re);else if(function(_i){return ke(_i)==="[object Error]"}(Re))Mt={message:Re.message};else if(function(_i){return ke(_i)==="[object Boolean]"}(Re))Mt=new Boolean(Re);else if(function(_i){return ke(_i)==="[object Number]"}(Re))Mt=new Number(Re);else if(function(_i){return ke(_i)==="[object String]"}(Re))Mt=new String(Re);else if(Object.create&&Object.getPrototypeOf)Mt=Object.create(Object.getPrototypeOf(Re));else if(Re.constructor===Object)Mt={};else{var Nt=Re.constructor&&Re.constructor.prototype||Re.__proto__||{},li=function(){};li.prototype=Nt,Mt=new li}return xt(Te(Re),function(_i){Mt[_i]=Re[_i]}),Mt}return Re}$.prototype.get=function(Re){for(var Mt=this.value,Nt=0;Nt<Re.length;Nt++){var li=Re[Nt];if(!Mt||!Ct.call(Mt,li)){Mt=void 0;break}Mt=Mt[li]}return Mt},$.prototype.has=function(Re){for(var Mt=this.value,Nt=0;Nt<Re.length;Nt++){var li=Re[Nt];if(!Mt||!Ct.call(Mt,li))return!1;Mt=Mt[li]}return!0},$.prototype.set=function(Re,Mt){for(var Nt=this.value,li=0;li<Re.length-1;li++){var _i=Re[li];Ct.call(Nt,_i)||(Nt[_i]={}),Nt=Nt[_i]}return Nt[Re[li]]=Mt,Mt},$.prototype.map=function(Re){return ye(this.value,Re,!0)},$.prototype.forEach=function(Re){return this.value=ye(this.value,Re,!1),this.value},$.prototype.reduce=function(Re,Mt){var Nt=arguments.length===1,li=Nt?this.value:Mt;return this.forEach(function(_i){this.isRoot&&Nt||(li=Re.call(this,li,_i))}),li},$.prototype.paths=function(){var Re=[];return this.forEach(function(Mt){Re.push(this.path)}),Re},$.prototype.nodes=function(){var Re=[];return this.forEach(function(Mt){Re.push(this.node)}),Re},$.prototype.clone=function(){var Re=[],Mt=[];return function Nt(li){for(var _i=0;_i<Re.length;_i++)if(Re[_i]===li)return Mt[_i];if(typeof li=="object"&&li!==null){var Cr=Le(li);return Re.push(li),Mt.push(Cr),xt(Te(li),function(dt){Cr[dt]=Nt(li[dt])}),Re.pop(),Mt.pop(),Cr}return li}(this.value)};var Te=Object.keys||function(Re){var Mt=[];for(var Nt in Re)Mt.push(Nt);return Mt};function ke(Re){return Object.prototype.toString.call(Re)}var wt=Array.isArray||function(Re){return Object.prototype.toString.call(Re)==="[object Array]"},xt=function(Re,Mt){if(Re.forEach)return Re.forEach(Mt);for(var Nt=0;Nt<Re.length;Nt++)Mt(Re[Nt],Nt,Re)};xt(Te($.prototype),function(Re){z[Re]=function(Mt){var Nt=[].slice.call(arguments,1),li=new $(Mt);return li[Re].apply(li,Nt)}});var Ct=Object.hasOwnProperty||function(Re,Mt){return Mt in Re}}),Jt=Pt;function Pt(T){if(!(this instanceof Pt))return new Pt(T);this._bbox=T||[1/0,1/0,-1/0,-1/0],this._valid=!!T}Pt.prototype.include=function(T){return this._valid=!0,this._bbox[0]=Math.min(this._bbox[0],T[0]),this._bbox[1]=Math.min(this._bbox[1],T[1]),this._bbox[2]=Math.max(this._bbox[2],T[0]),this._bbox[3]=Math.max(this._bbox[3],T[1]),this},Pt.prototype.equals=function(T){var z;return z=T instanceof Pt?T.bbox():T,this._bbox[0]==z[0]&&this._bbox[1]==z[1]&&this._bbox[2]==z[2]&&this._bbox[3]==z[3]},Pt.prototype.center=function(T){return this._valid?[(this._bbox[0]+this._bbox[2])/2,(this._bbox[1]+this._bbox[3])/2]:null},Pt.prototype.union=function(T){var z;return this._valid=!0,z=T instanceof Pt?T.bbox():T,this._bbox[0]=Math.min(this._bbox[0],z[0]),this._bbox[1]=Math.min(this._bbox[1],z[1]),this._bbox[2]=Math.max(this._bbox[2],z[2]),this._bbox[3]=Math.max(this._bbox[3],z[3]),this},Pt.prototype.bbox=function(){return this._valid?this._bbox:null},Pt.prototype.contains=function(T){if(!T)return this._fastContains();if(!this._valid)return null;var z=T[0],$=T[1];return this._bbox[0]<=z&&this._bbox[1]<=$&&this._bbox[2]>=z&&this._bbox[3]>=$},Pt.prototype.intersect=function(T){return this._valid?(z=T instanceof Pt?T.bbox():T,!(this._bbox[0]>z[2]||this._bbox[2]<z[0]||this._bbox[3]<z[1]||this._bbox[1]>z[3])):null;var z},Pt.prototype._fastContains=function(){if(!this._valid)return new Function("return null;");var T="return "+this._bbox[0]+"<= ll[0] &&"+this._bbox[1]+"<= ll[1] &&"+this._bbox[2]+">= ll[0] &&"+this._bbox[3]+">= ll[1]";return new Function("ll",T)},Pt.prototype.polygon=function(){return this._valid?{type:"Polygon",coordinates:[[[this._bbox[0],this._bbox[1]],[this._bbox[2],this._bbox[1]],[this._bbox[2],this._bbox[3]],[this._bbox[0],this._bbox[3]],[this._bbox[0],this._bbox[1]]]]}:null};var di={features:["FeatureCollection"],coordinates:["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],geometry:["Feature"],geometries:["GeometryCollection"]},gi=Object.keys(di),Li=function(T){return vi(T).bbox()};function vi(T){for(var z=Jt(),$=qe(T),ye=0;ye<$.length;ye++)z.include($[ye]);return z}Li.polygon=function(T){return vi(T).polygon()},Li.bboxify=function(T){return Ht(T).map(function(z){z&&gi.some(function($){return!!z[$]&&di[$].indexOf(z.type)!==-1})&&(z.bbox=vi(z).bbox(),this.update(z))})};function Ti(T,z){var $=-90,ye=90,Le=-90,Te=90,ke=270,wt=-270;T.forEach(function(Ct){var Re=Li(Ct),Mt=Re[1],Nt=Re[3],li=Re[0],_i=Re[2];Mt>$&&($=Mt),Nt<ye&&(ye=Nt),Nt>Le&&(Le=Nt),Mt<Te&&(Te=Mt),li<ke&&(ke=li),_i>wt&&(wt=_i)});var xt=z;return $+xt.lat>85&&(xt.lat=85-$),Le+xt.lat>90&&(xt.lat=90-Le),ye+xt.lat<-85&&(xt.lat=-85-ye),Te+xt.lat<-90&&(xt.lat=-90-Te),ke+xt.lng<=-270&&(xt.lng+=360*Math.ceil(Math.abs(xt.lng)/360)),wt+xt.lng>=270&&(xt.lng-=360*Math.ceil(Math.abs(xt.lng)/360)),xt}function Bi(T,z){var $=Ti(T.map(function(ye){return ye.toGeoJSON()}),z);T.forEach(function(ye){var Le,Te=ye.getCoordinates(),ke=function(xt){var Ct={lng:xt[0]+$.lng,lat:xt[1]+$.lat};return[Ct.lng,Ct.lat]},wt=function(xt){return xt.map(function(Ct){return ke(Ct)})};ye.type===rt?Le=ke(Te):ye.type===vt||ye.type===zt?Le=Te.map(ke):ye.type===_t||ye.type===Et?Le=Te.map(wt):ye.type===Q&&(Le=Te.map(function(xt){return xt.map(function(Ct){return wt(Ct)})})),ye.incomingCoords(Le)})}var Ci={onSetup:function(T){var z=this,$={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initiallySelectedFeatureIds:T.featureIds||[]};return this.setSelected($.initiallySelectedFeatureIds.filter(function(ye){return z.getFeature(ye)!==void 0})),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),$},fireUpdate:function(){this.map.fire(ve,{action:tt,features:this.getSelected().map(function(T){return T.toGeoJSON()})})},fireActionable:function(){var T=this,z=this.getSelected(),$=z.filter(function(wt){return T.isInstanceOf("MultiFeature",wt)}),ye=!1;if(z.length>1){ye=!0;var Le=z[0].type.replace("Multi","");z.forEach(function(wt){wt.type.replace("Multi","")!==Le&&(ye=!1)})}var Te=$.length>0,ke=z.length>0;this.setActionableState({combineFeatures:ye,uncombineFeatures:Te,trash:ke})},getUniqueIds:function(T){return T.length?T.map(function(z){return z.properties.id}).filter(function(z){return z!==void 0}).reduce(function(z,$){return z.add($),z},new Gt).values():[]},stopExtendedInteractions:function(T){T.boxSelectElement&&(T.boxSelectElement.parentNode&&T.boxSelectElement.parentNode.removeChild(T.boxSelectElement),T.boxSelectElement=null),this.map.dragPan.enable(),T.boxSelecting=!1,T.canBoxSelect=!1,T.dragMoving=!1,T.canDragMove=!1},onStop:function(){_e(this)},onMouseMove:function(T){return this.stopExtendedInteractions(T),!0},onMouseOut:function(T){return!T.dragMoving||this.fireUpdate()}};Ci.onTap=Ci.onClick=function(T,z){return Wn(z)?this.clickAnywhere(T,z):as(Ce)(z)?this.clickOnVertex(T,z):function($){return!!$.featureTarget&&!!$.featureTarget.properties&&$.featureTarget.properties.meta===nt}(z)?this.clickOnFeature(T,z):void 0},Ci.clickAnywhere=function(T){var z=this,$=this.getSelectedIds();$.length&&(this.clearSelectedFeatures(),$.forEach(function(ye){return z.doRender(ye)})),_e(this),this.stopExtendedInteractions(T)},Ci.clickOnVertex=function(T,z){this.changeMode(se.DIRECT_SELECT,{featureId:z.featureTarget.properties.parent,coordPath:z.featureTarget.properties.coord_path,startPos:z.lngLat}),this.updateUIClasses({mouse:Y})},Ci.startOnActiveFeature=function(T,z){this.stopExtendedInteractions(T),this.map.dragPan.disable(),this.doRender(z.featureTarget.properties.id),T.canDragMove=!0,T.dragMoveLocation=z.lngLat},Ci.clickOnFeature=function(T,z){var $=this;pe(this),this.stopExtendedInteractions(T);var ye=qn(z),Le=this.getSelectedIds(),Te=z.featureTarget.properties.id,ke=this.isSelected(Te);if(!ye&&ke&&this.getFeature(Te).type!==rt)return this.changeMode(se.DIRECT_SELECT,{featureId:Te});ke&&ye?(this.deselect(Te),this.updateUIClasses({mouse:ge}),Le.length===1&&_e(this)):!ke&&ye?(this.select(Te),this.updateUIClasses({mouse:Y})):ke||ye||(Le.forEach(function(wt){return $.doRender(wt)}),this.setSelected(Te),this.updateUIClasses({mouse:Y})),this.doRender(Te)},Ci.onMouseDown=function(T,z){return Zr(z)?this.startOnActiveFeature(T,z):this.drawConfig.boxSelect&&function($){return!!$.originalEvent&&!!$.originalEvent.shiftKey&&$.originalEvent.button===0}(z)?this.startBoxSelect(T,z):void 0},Ci.startBoxSelect=function(T,z){this.stopExtendedInteractions(T),this.map.dragPan.disable(),T.boxSelectStartLocation=te(z.originalEvent,this.map.getContainer()),T.canBoxSelect=!0},Ci.onTouchStart=function(T,z){if(Zr(z))return this.startOnActiveFeature(T,z)},Ci.onDrag=function(T,z){return T.canDragMove?this.dragMove(T,z):this.drawConfig.boxSelect&&T.canBoxSelect?this.whileBoxSelect(T,z):void 0},Ci.whileBoxSelect=function(T,z){T.boxSelecting=!0,this.updateUIClasses({mouse:U}),T.boxSelectElement||(T.boxSelectElement=document.createElement("div"),T.boxSelectElement.classList.add(S),this.map.getContainer().appendChild(T.boxSelectElement));var $=te(z.originalEvent,this.map.getContainer()),ye=Math.min(T.boxSelectStartLocation.x,$.x),Le=Math.max(T.boxSelectStartLocation.x,$.x),Te=Math.min(T.boxSelectStartLocation.y,$.y),ke=Math.max(T.boxSelectStartLocation.y,$.y),wt="translate("+ye+"px, "+Te+"px)";T.boxSelectElement.style.transform=wt,T.boxSelectElement.style.WebkitTransform=wt,T.boxSelectElement.style.width=Le-ye+"px",T.boxSelectElement.style.height=ke-Te+"px"},Ci.dragMove=function(T,z){T.dragMoving=!0,z.originalEvent.stopPropagation();var $={lng:z.lngLat.lng-T.dragMoveLocation.lng,lat:z.lngLat.lat-T.dragMoveLocation.lat};Bi(this.getSelected(),$),T.dragMoveLocation=z.lngLat},Ci.onMouseUp=function(T,z){var $=this;if(T.dragMoving)this.fireUpdate();else if(T.boxSelecting){var ye=[T.boxSelectStartLocation,te(z.originalEvent,this.map.getContainer())],Le=this.featuresAt(null,ye,"click"),Te=this.getUniqueIds(Le).filter(function(ke){return!$.isSelected(ke)});Te.length&&(this.select(Te),Te.forEach(function(ke){return $.doRender(ke)}),this.updateUIClasses({mouse:Y}))}this.stopExtendedInteractions(T)},Ci.toDisplayFeatures=function(T,z,$){z.properties.active=this.isSelected(z.properties.id)?Ve:Je,$(z),this.fireActionable(),z.properties.active===Ve&&z.geometry.type!==rt&&we(z).forEach($)},Ci.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()},Ci.onCombineFeatures=function(){var T=this.getSelected();if(!(T.length===0||T.length<2)){for(var z=[],$=[],ye=T[0].type.replace("Multi",""),Le=0;Le<T.length;Le++){var Te=T[Le];if(Te.type.replace("Multi","")!==ye)return;Te.type.includes("Multi")?Te.getCoordinates().forEach(function(wt){z.push(wt)}):z.push(Te.getCoordinates()),$.push(Te.toGeoJSON())}if($.length>1){var ke=this.newFeature({type:at,properties:$[0].properties,geometry:{type:"Multi"+ye,coordinates:z}});this.addFeature(ke),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([ke.id]),this.map.fire(De,{createdFeatures:[ke.toGeoJSON()],deletedFeatures:$})}this.fireActionable()}},Ci.onUncombineFeatures=function(){var T=this,z=this.getSelected();if(z.length!==0){for(var $=[],ye=[],Le=function(ke){var wt=z[ke];T.isInstanceOf("MultiFeature",wt)&&(wt.getFeatures().forEach(function(xt){T.addFeature(xt),xt.properties=wt.properties,$.push(xt.toGeoJSON()),T.select([xt.id])}),T.deleteFeature(wt.id,{silent:!0}),ye.push(wt.toGeoJSON()))},Te=0;Te<z.length;Te++)Le(Te);$.length>1&&this.map.fire(Ie,{createdFeatures:$,deletedFeatures:ye}),this.fireActionable()}};var Ir=as(Ce),cr=as(je),gr={fireUpdate:function(){this.map.fire(ve,{action:ut,features:this.getSelected().map(function(T){return T.toGeoJSON()})})},fireActionable:function(T){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:T.selectedCoordPaths.length>0})},startDragging:function(T,z){this.map.dragPan.disable(),T.canDragMove=!0,T.dragMoveLocation=z.lngLat},stopDragging:function(T){this.map.dragPan.enable(),T.dragMoving=!1,T.canDragMove=!1,T.dragMoveLocation=null},onVertex:function(T,z){this.startDragging(T,z);var $=z.featureTarget.properties,ye=T.selectedCoordPaths.indexOf($.coord_path);qn(z)||ye!==-1?qn(z)&&ye===-1&&T.selectedCoordPaths.push($.coord_path):T.selectedCoordPaths=[$.coord_path];var Le=this.pathsToCoordinates(T.featureId,T.selectedCoordPaths);this.setSelectedCoordinates(Le)},onMidpoint:function(T,z){this.startDragging(T,z);var $=z.featureTarget.properties;T.feature.addCoordinate($.coord_path,$.lng,$.lat),this.fireUpdate(),T.selectedCoordPaths=[$.coord_path]},pathsToCoordinates:function(T,z){return z.map(function($){return{feature_id:T,coord_path:$}})},onFeature:function(T,z){T.selectedCoordPaths.length===0?this.startDragging(T,z):this.stopDragging(T)},dragFeature:function(T,z,$){Bi(this.getSelected(),$),T.dragMoveLocation=z.lngLat},dragVertex:function(T,z,$){for(var ye=T.selectedCoordPaths.map(function(wt){return T.feature.getCoordinate(wt)}),Le=Ti(ye.map(function(wt){return{type:at,properties:{},geometry:{type:rt,coordinates:wt}}}),$),Te=0;Te<ye.length;Te++){var ke=ye[Te];T.feature.updateCoordinate(T.selectedCoordPaths[Te],ke[0]+Le.lng,ke[1]+Le.lat)}},clickNoTarget:function(){this.changeMode(se.SIMPLE_SELECT)},clickInactive:function(){this.changeMode(se.SIMPLE_SELECT)},clickActiveFeature:function(T){T.selectedCoordPaths=[],this.clearSelectedCoordinates(),T.feature.changed()},onSetup:function(T){var z=T.featureId,$=this.getFeature(z);if(!$)throw new Error("You must provide a featureId to enter direct_select mode");if($.type===rt)throw new TypeError("direct_select mode doesn't handle point features");var ye={featureId:z,feature:$,dragMoveLocation:T.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:T.coordPath?[T.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(z,ye.selectedCoordPaths)),this.setSelected(z),pe(this),this.setActionableState({trash:!0}),ye},onStop:function(){_e(this),this.clearSelectedCoordinates()},toDisplayFeatures:function(T,z,$){T.featureId===z.properties.id?(z.properties.active=Ve,$(z),we(z,{map:this.map,midpoints:!0,selectedPaths:T.selectedCoordPaths}).forEach($)):(z.properties.active=Je,$(z)),this.fireActionable(T)},onTrash:function(T){T.selectedCoordPaths.sort(function(z,$){return $.localeCompare(z,"en",{numeric:!0})}).forEach(function(z){return T.feature.removeCoordinate(z)}),this.fireUpdate(),T.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(T),T.feature.isValid()===!1&&(this.deleteFeature([T.featureId]),this.changeMode(se.SIMPLE_SELECT,{}))},onMouseMove:function(T,z){var $=Zr(z),ye=Ir(z),Le=T.selectedCoordPaths.length===0;return $&&Le||ye&&!Le?this.updateUIClasses({mouse:Y}):this.updateUIClasses({mouse:ze}),this.stopDragging(T),!0},onMouseOut:function(T){return T.dragMoving&&this.fireUpdate(),!0}};gr.onTouchStart=gr.onMouseDown=function(T,z){return Ir(z)?this.onVertex(T,z):Zr(z)?this.onFeature(T,z):cr(z)?this.onMidpoint(T,z):void 0},gr.onDrag=function(T,z){if(T.canDragMove===!0){T.dragMoving=!0,z.originalEvent.stopPropagation();var $={lng:z.lngLat.lng-T.dragMoveLocation.lng,lat:z.lngLat.lat-T.dragMoveLocation.lat};T.selectedCoordPaths.length>0?this.dragVertex(T,z,$):this.dragFeature(T,z,$),T.dragMoveLocation=z.lngLat}},gr.onClick=function(T,z){return Wn(z)?this.clickNoTarget(T,z):Zr(z)?this.clickActiveFeature(T,z):ls(z)?this.clickInactive(T,z):void this.stopDragging(T)},gr.onTap=function(T,z){return Wn(z)?this.clickNoTarget(T,z):Zr(z)?this.clickActiveFeature(T,z):ls(z)?this.clickInactive(T,z):void 0},gr.onTouchEnd=gr.onMouseUp=function(T){T.dragMoving&&this.fireUpdate(),this.stopDragging(T)};var Kr={};function vs(T,z){return!!T.lngLat&&T.lngLat.lng===z[0]&&T.lngLat.lat===z[1]}Kr.onSetup=function(){var T=this.newFeature({type:at,properties:{},geometry:{type:rt,coordinates:[]}});return this.addFeature(T),this.clearSelectedFeatures(),this.updateUIClasses({mouse:U}),this.activateUIButton(We.POINT),this.setActionableState({trash:!0}),{point:T}},Kr.stopDrawingAndRemove=function(T){this.deleteFeature([T.point.id],{silent:!0}),this.changeMode(se.SIMPLE_SELECT)},Kr.onTap=Kr.onClick=function(T,z){this.updateUIClasses({mouse:Y}),T.point.updateCoordinate("",z.lngLat.lng,z.lngLat.lat),this.map.fire(de,{features:[T.point.toGeoJSON()]}),this.changeMode(se.SIMPLE_SELECT,{featureIds:[T.point.id]})},Kr.onStop=function(T){this.activateUIButton(),T.point.getCoordinate().length||this.deleteFeature([T.point.id],{silent:!0})},Kr.toDisplayFeatures=function(T,z,$){var ye=z.properties.id===T.point.id;if(z.properties.active=ye?Ve:Je,!ye)return $(z)},Kr.onTrash=Kr.stopDrawingAndRemove,Kr.onKeyUp=function(T,z){if(re(z)||B(z))return this.stopDrawingAndRemove(T,z)};var Vi={onSetup:function(){var T=this.newFeature({type:at,properties:{},geometry:{type:_t,coordinates:[[]]}});return this.addFeature(T),this.clearSelectedFeatures(),pe(this),this.updateUIClasses({mouse:U}),this.activateUIButton(We.POLYGON),this.setActionableState({trash:!0}),{polygon:T,currentVertexPosition:0}},clickAnywhere:function(T,z){if(T.currentVertexPosition>0&&vs(z,T.polygon.coordinates[0][T.currentVertexPosition-1]))return this.changeMode(se.SIMPLE_SELECT,{featureIds:[T.polygon.id]});this.updateUIClasses({mouse:U}),T.polygon.updateCoordinate("0."+T.currentVertexPosition,z.lngLat.lng,z.lngLat.lat),T.currentVertexPosition++,T.polygon.updateCoordinate("0."+T.currentVertexPosition,z.lngLat.lng,z.lngLat.lat)},clickOnVertex:function(T){return this.changeMode(se.SIMPLE_SELECT,{featureIds:[T.polygon.id]})},onMouseMove:function(T,z){T.polygon.updateCoordinate("0."+T.currentVertexPosition,z.lngLat.lng,z.lngLat.lat),$n(z)&&this.updateUIClasses({mouse:ge})}};Vi.onTap=Vi.onClick=function(T,z){return $n(z)?this.clickOnVertex(T,z):this.clickAnywhere(T,z)},Vi.onKeyUp=function(T,z){re(z)?(this.deleteFeature([T.polygon.id],{silent:!0}),this.changeMode(se.SIMPLE_SELECT)):B(z)&&this.changeMode(se.SIMPLE_SELECT,{featureIds:[T.polygon.id]})},Vi.onStop=function(T){this.updateUIClasses({mouse:ze}),_e(this),this.activateUIButton(),this.getFeature(T.polygon.id)!==void 0&&(T.polygon.removeCoordinate("0."+T.currentVertexPosition),T.polygon.isValid()?this.map.fire(de,{features:[T.polygon.toGeoJSON()]}):(this.deleteFeature([T.polygon.id],{silent:!0}),this.changeMode(se.SIMPLE_SELECT,{},{silent:!0})))},Vi.toDisplayFeatures=function(T,z,$){var ye=z.properties.id===T.polygon.id;if(z.properties.active=ye?Ve:Je,!ye)return $(z);if(z.geometry.coordinates.length!==0){var Le=z.geometry.coordinates[0].length;if(!(Le<3)){if(z.properties.meta=nt,$(fe(T.polygon.id,z.geometry.coordinates[0][0],"0.0",!1)),Le>3){var Te=z.geometry.coordinates[0].length-3;$(fe(T.polygon.id,z.geometry.coordinates[0][Te],"0."+Te,!1))}if(Le<=4){var ke=[[z.geometry.coordinates[0][0][0],z.geometry.coordinates[0][0][1]],[z.geometry.coordinates[0][1][0],z.geometry.coordinates[0][1][1]]];if($({type:at,properties:z.properties,geometry:{coordinates:ke,type:vt}}),Le===3)return}return $(z)}}},Vi.onTrash=function(T){this.deleteFeature([T.polygon.id],{silent:!0}),this.changeMode(se.SIMPLE_SELECT)};var Yn={onSetup:function(T){var z,$,ye=(T=T||{}).featureId,Le="forward";if(ye){if(!(z=this.getFeature(ye)))throw new Error("Could not find a feature with the provided featureId");var Te=T.from;if(Te&&Te.type==="Feature"&&Te.geometry&&Te.geometry.type==="Point"&&(Te=Te.geometry),Te&&Te.type==="Point"&&Te.coordinates&&Te.coordinates.length===2&&(Te=Te.coordinates),!Te||!Array.isArray(Te))throw new Error("Please use the `from` property to indicate which point to continue the line from");var ke=z.coordinates.length-1;if(z.coordinates[ke][0]===Te[0]&&z.coordinates[ke][1]===Te[1])$=ke+1,z.addCoordinate.apply(z,[$].concat(z.coordinates[ke]));else{if(z.coordinates[0][0]!==Te[0]||z.coordinates[0][1]!==Te[1])throw new Error("`from` should match the point at either the start or the end of the provided LineString");Le="backwards",$=0,z.addCoordinate.apply(z,[$].concat(z.coordinates[0]))}}else z=this.newFeature({type:at,properties:{},geometry:{type:vt,coordinates:[]}}),$=0,this.addFeature(z);return this.clearSelectedFeatures(),pe(this),this.updateUIClasses({mouse:U}),this.activateUIButton(We.LINE),this.setActionableState({trash:!0}),{line:z,currentVertexPosition:$,direction:Le}},clickAnywhere:function(T,z){if(T.currentVertexPosition>0&&vs(z,T.line.coordinates[T.currentVertexPosition-1])||T.direction==="backwards"&&vs(z,T.line.coordinates[T.currentVertexPosition+1]))return this.changeMode(se.SIMPLE_SELECT,{featureIds:[T.line.id]});this.updateUIClasses({mouse:U}),T.line.updateCoordinate(T.currentVertexPosition,z.lngLat.lng,z.lngLat.lat),T.direction==="forward"?(T.currentVertexPosition++,T.line.updateCoordinate(T.currentVertexPosition,z.lngLat.lng,z.lngLat.lat)):T.line.addCoordinate(0,z.lngLat.lng,z.lngLat.lat)},clickOnVertex:function(T){return this.changeMode(se.SIMPLE_SELECT,{featureIds:[T.line.id]})},onMouseMove:function(T,z){T.line.updateCoordinate(T.currentVertexPosition,z.lngLat.lng,z.lngLat.lat),$n(z)&&this.updateUIClasses({mouse:ge})}};Yn.onTap=Yn.onClick=function(T,z){if($n(z))return this.clickOnVertex(T,z);this.clickAnywhere(T,z)},Yn.onKeyUp=function(T,z){B(z)?this.changeMode(se.SIMPLE_SELECT,{featureIds:[T.line.id]}):re(z)&&(this.deleteFeature([T.line.id],{silent:!0}),this.changeMode(se.SIMPLE_SELECT))},Yn.onStop=function(T){_e(this),this.activateUIButton(),this.getFeature(T.line.id)!==void 0&&(T.line.removeCoordinate(""+T.currentVertexPosition),T.line.isValid()?this.map.fire(de,{features:[T.line.toGeoJSON()]}):(this.deleteFeature([T.line.id],{silent:!0}),this.changeMode(se.SIMPLE_SELECT,{},{silent:!0})))},Yn.onTrash=function(T){this.deleteFeature([T.line.id],{silent:!0}),this.changeMode(se.SIMPLE_SELECT)},Yn.toDisplayFeatures=function(T,z,$){var ye=z.properties.id===T.line.id;if(z.properties.active=ye?Ve:Je,!ye)return $(z);z.geometry.coordinates.length<2||(z.properties.meta=nt,$(fe(T.line.id,z.geometry.coordinates[T.direction==="forward"?z.geometry.coordinates.length-2:1],""+(T.direction==="forward"?z.geometry.coordinates.length-2:1),!1)),$(z))};var fo={simple_select:Ci,direct_select:gr,draw_point:Kr,draw_polygon:Vi,draw_line_string:Yn},la={defaultMode:se.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:[{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":"#3bb2d0","fill-outline-color":"#3bb2d0","fill-opacity":.1}},{id:"gl-draw-polygon-fill-active",type:"fill",filter:["all",["==","active","true"],["==","$type","Polygon"]],paint:{"fill-color":"#fbb03b","fill-outline-color":"#fbb03b","fill-opacity":.1}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","active","true"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-line-active",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-stroke-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-color":"#fff"}},{id:"gl-draw-polygon-and-line-vertex-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-point-point-stroke-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-opacity":1,"circle-color":"#fff"}},{id:"gl-draw-point-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#3bb2d0"}},{id:"gl-draw-point-stroke-active",type:"circle",filter:["all",["==","$type","Point"],["==","active","true"],["!=","meta","midpoint"]],paint:{"circle-radius":7,"circle-color":"#fff"}},{id:"gl-draw-point-active",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","true"]],paint:{"circle-radius":5,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-fill-static",type:"fill",filter:["all",["==","mode","static"],["==","$type","Polygon"]],paint:{"fill-color":"#404040","fill-outline-color":"#404040","fill-opacity":.1}},{id:"gl-draw-polygon-stroke-static",type:"line",filter:["all",["==","mode","static"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-line-static",type:"line",filter:["all",["==","mode","static"],["==","$type","LineString"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-point-static",type:"circle",filter:["all",["==","mode","static"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"#404040"}}],modes:fo,controls:{},userProperties:!1},ca={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},Lo={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function ha(T,z){return T.map(function($){return $.source?$:Vr($,{id:$.id+"."+z,source:z==="hot"?A:O})})}var po=Ue(function(T,z){var $="[object Arguments]",ye="[object Map]",Le="[object Object]",Te="[object Set]",ke=/^\[object .+?Constructor\]$/,wt=/^(?:0|[1-9]\d*)$/,xt={};xt["[object Float32Array]"]=xt["[object Float64Array]"]=xt["[object Int8Array]"]=xt["[object Int16Array]"]=xt["[object Int32Array]"]=xt["[object Uint8Array]"]=xt["[object Uint8ClampedArray]"]=xt["[object Uint16Array]"]=xt["[object Uint32Array]"]=!0,xt[$]=xt["[object Array]"]=xt["[object ArrayBuffer]"]=xt["[object Boolean]"]=xt["[object DataView]"]=xt["[object Date]"]=xt["[object Error]"]=xt["[object Function]"]=xt[ye]=xt["[object Number]"]=xt[Le]=xt["[object RegExp]"]=xt[Te]=xt["[object String]"]=xt["[object WeakMap]"]=!1;var Ct=typeof Ia=="object"&&Ia&&Ia.Object===Object&&Ia,Re=typeof self=="object"&&self&&self.Object===Object&&self,Mt=Ct||Re||Function("return this")(),Nt=z&&!z.nodeType&&z,li=Nt&&T&&!T.nodeType&&T,_i=li&&li.exports===Nt,Cr=_i&&Ct.process,dt=function(){try{return Cr&&Cr.binding&&Cr.binding("util")}catch{}}(),Zt=dt&&dt.isTypedArray;function qi(Ae,Ke){for(var Lt=-1,fi=Ae==null?0:Ae.length;++Lt<fi;)if(Ke(Ae[Lt],Lt,Ae))return!0;return!1}function $i(Ae){var Ke=-1,Lt=Array(Ae.size);return Ae.forEach(function(fi,Qi){Lt[++Ke]=[Qi,fi]}),Lt}function hr(Ae){var Ke=-1,Lt=Array(Ae.size);return Ae.forEach(function(fi){Lt[++Ke]=fi}),Lt}var ci,Ai,Hn,Wi=Array.prototype,Jr=Function.prototype,Or=Object.prototype,mo=Mt["__core-js_shared__"],rn=Jr.toString,yn=Or.hasOwnProperty,$s=(ci=/[^.]+$/.exec(mo&&mo.keys&&mo.keys.IE_PROTO||""))?"Symbol(src)_1."+ci:"",qs=Or.toString,Ro=RegExp("^"+rn.call(yn).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),go=_i?Mt.Buffer:void 0,xs=Mt.Symbol,_o=Mt.Uint8Array,yo=Or.propertyIsEnumerable,vo=Wi.splice,cs=xs?xs.toStringTag:void 0,Bo=Object.getOwnPropertySymbols,As=go?go.isBuffer:void 0,Ma=(Ai=Object.keys,Hn=Object,function(Ae){return Ai(Hn(Ae))}),Uo=Kn(Mt,"DataView"),Ys=Kn(Mt,"Map"),jo=Kn(Mt,"Promise"),Vo=Kn(Mt,"Set"),No=Kn(Mt,"WeakMap"),bs=Kn(Object,"create"),xo=Jn(Uo),Go=Jn(Ys),Xo=Jn(jo),Ms=Jn(Vo),fa=Jn(No),Wo=xs?xs.prototype:void 0,ks=Wo?Wo.valueOf:void 0;function dn(Ae){var Ke=-1,Lt=Ae==null?0:Ae.length;for(this.clear();++Ke<Lt;){var fi=Ae[Ke];this.set(fi[0],fi[1])}}function zn(Ae){var Ke=-1,Lt=Ae==null?0:Ae.length;for(this.clear();++Ke<Lt;){var fi=Ae[Ke];this.set(fi[0],fi[1])}}function vn(Ae){var Ke=-1,Lt=Ae==null?0:Ae.length;for(this.clear();++Ke<Lt;){var fi=Ae[Ke];this.set(fi[0],fi[1])}}function Ji(Ae){var Ke=-1,Lt=Ae==null?0:Ae.length;for(this.__data__=new vn;++Ke<Lt;)this.add(Ae[Ke])}function Zn(Ae){var Ke=this.__data__=new zn(Ae);this.size=Ke.size}function Mi(Ae,Ke){var Lt=ws(Ae),fi=!Lt&&wo(Ae),Qi=!Lt&&!fi&&fn(Ae),zi=!Lt&&!fi&&!Qi&&Ls(Ae),ur=Lt||fi||Qi||zi,pr=ur?function(Tr,nn){for(var Fn=-1,Gr=Array(Tr);++Fn<Tr;)Gr[Fn]=nn(Fn);return Gr}(Ae.length,String):[],Nr=pr.length;for(var _r in Ae)!Ke&&!yn.call(Ae,_r)||ur&&(_r=="length"||Qi&&(_r=="offset"||_r=="parent")||zi&&(_r=="buffer"||_r=="byteLength"||_r=="byteOffset")||Zs(_r,Nr))||pr.push(_r);return pr}function Ui(Ae,Ke){for(var Lt=Ae.length;Lt--;)if(qo(Ae[Lt][0],Ke))return Lt;return-1}function Yi(Ae){return Ae==null?Ae===void 0?"[object Undefined]":"[object Null]":cs&&cs in Object(Ae)?function(Ke){var Lt=yn.call(Ke,cs),fi=Ke[cs];try{Ke[cs]=void 0;var Qi=!0}catch{}var zi=qs.call(Ke);return Qi&&(Lt?Ke[cs]=fi:delete Ke[cs]),zi}(Ae):function(Ke){return qs.call(Ke)}(Ae)}function ar(Ae){return Pn(Ae)&&Yi(Ae)==$}function Ds(Ae,Ke,Lt,fi,Qi){return Ae===Ke||(Ae==null||Ke==null||!Pn(Ae)&&!Pn(Ke)?Ae!=Ae&&Ke!=Ke:function(zi,ur,pr,Nr,_r,Tr){var nn=ws(zi),Fn=ws(ur),Gr=nn?"[object Array]":xn(zi),Rn=Fn?"[object Array]":xn(ur),In=(Gr=Gr==$?Le:Gr)==Le,Ks=(Rn=Rn==$?Le:Rn)==Le,Bn=Gr==Rn;if(Bn&&fn(zi)){if(!fn(ur))return!1;nn=!0,In=!1}if(Bn&&!In)return Tr||(Tr=new Zn),nn||Ls(zi)?pa(zi,ur,pr,Nr,_r,Tr):function(rr,ji,Qs,Xr,Cs,on,es){switch(Qs){case"[object DataView]":if(rr.byteLength!=ji.byteLength||rr.byteOffset!=ji.byteOffset)return!1;rr=rr.buffer,ji=ji.buffer;case"[object ArrayBuffer]":return!(rr.byteLength!=ji.byteLength||!on(new _o(rr),new _o(ji)));case"[object Boolean]":case"[object Date]":case"[object Number]":return qo(+rr,+ji);case"[object Error]":return rr.name==ji.name&&rr.message==ji.message;case"[object RegExp]":case"[object String]":return rr==ji+"";case ye:var hs=$i;case Te:var us=1&Xr;if(hs||(hs=hr),rr.size!=ji.size&&!us)return!1;var ds=es.get(rr);if(ds)return ds==ji;Xr|=2,es.set(rr,ji);var an=pa(hs(rr),hs(ji),Xr,Cs,on,es);return es.delete(rr),an;case"[object Symbol]":if(ks)return ks.call(rr)==ks.call(ji)}return!1}(zi,ur,Gr,pr,Nr,_r,Tr);if(!(1&pr)){var Qn=In&&yn.call(zi,"__wrapped__"),sn=Ks&&yn.call(ur,"__wrapped__");if(Qn||sn){var Js=Qn?zi.value():zi,pn=sn?ur.value():ur;return Tr||(Tr=new Zn),_r(Js,pn,pr,Nr,Tr)}}return Bn?(Tr||(Tr=new Zn),function(rr,ji,Qs,Xr,Cs,on){var es=1&Qs,hs=$o(rr),us=hs.length,ds=$o(ji).length;if(us!=ds&&!es)return!1;for(var an=us;an--;){var Rt=hs[an];if(!(es?Rt in ji:yn.call(ji,Rt)))return!1}var Zo=on.get(rr);if(Zo&&on.get(ji))return Zo==ji;var Un=!0;on.set(rr,ji),on.set(ji,rr);for(var jn=es;++an<us;){Rt=hs[an];var Fs=rr[Rt],kt=ji[Rt];if(Xr)var eo=es?Xr(kt,Fs,Rt,ji,rr,on):Xr(Fs,kt,Rt,rr,ji,on);if(!(eo===void 0?Fs===kt||Cs(Fs,kt,Qs,Xr,on):eo)){Un=!1;break}jn||(jn=Rt=="constructor")}if(Un&&!jn){var So=rr.constructor,Rs=ji.constructor;So==Rs||!("constructor"in rr)||!("constructor"in ji)||typeof So=="function"&&So instanceof So&&typeof Rs=="function"&&Rs instanceof Rs||(Un=!1)}return on.delete(rr),on.delete(ji),Un}(zi,ur,pr,Nr,_r,Tr)):!1}(Ae,Ke,Lt,fi,Ds,Qi))}function Os(Ae){return!(!Ho(Ae)||function(Ke){return!!$s&&$s in Ke}(Ae))&&(Yo(Ae)?Ro:ke).test(Jn(Ae))}function ka(Ae){if(Lt=(Ke=Ae)&&Ke.constructor,fi=typeof Lt=="function"&&Lt.prototype||Or,Ke!==fi)return Ma(Ae);var Ke,Lt,fi,Qi=[];for(var zi in Object(Ae))yn.call(Ae,zi)&&zi!="constructor"&&Qi.push(zi);return Qi}function pa(Ae,Ke,Lt,fi,Qi,zi){var ur=1&Lt,pr=Ae.length,Nr=Ke.length;if(pr!=Nr&&!(ur&&Nr>pr))return!1;var _r=zi.get(Ae);if(_r&&zi.get(Ke))return _r==Ke;var Tr=-1,nn=!0,Fn=2&Lt?new Ji:void 0;for(zi.set(Ae,Ke),zi.set(Ke,Ae);++Tr<pr;){var Gr=Ae[Tr],Rn=Ke[Tr];if(fi)var In=ur?fi(Rn,Gr,Tr,Ke,Ae,zi):fi(Gr,Rn,Tr,Ae,Ke,zi);if(In!==void 0){if(In)continue;nn=!1;break}if(Fn){if(!qi(Ke,function(Ks,Bn){if(Qn=Bn,!Fn.has(Qn)&&(Gr===Ks||Qi(Gr,Ks,Lt,fi,zi)))return Fn.push(Bn);var Qn})){nn=!1;break}}else if(Gr!==Rn&&!Qi(Gr,Rn,Lt,fi,zi)){nn=!1;break}}return zi.delete(Ae),zi.delete(Ke),nn}function $o(Ae){return function(Ke,Lt,fi){var Qi=Lt(Ke);return ws(Ke)?Qi:function(zi,ur){for(var pr=-1,Nr=ur.length,_r=zi.length;++pr<Nr;)zi[_r+pr]=ur[pr];return zi}(Qi,fi(Ke))}(Ae,zs,Hs)}function bo(Ae,Ke){var Lt,fi,Qi=Ae.__data__;return((fi=typeof(Lt=Ke))=="string"||fi=="number"||fi=="symbol"||fi=="boolean"?Lt!=="__proto__":Lt===null)?Qi[typeof Ke=="string"?"string":"hash"]:Qi.map}function Kn(Ae,Ke){var Lt=function(fi,Qi){return fi==null?void 0:fi[Qi]}(Ae,Ke);return Os(Lt)?Lt:void 0}dn.prototype.clear=function(){this.__data__=bs?bs(null):{},this.size=0},dn.prototype.delete=function(Ae){var Ke=this.has(Ae)&&delete this.__data__[Ae];return this.size-=Ke?1:0,Ke},dn.prototype.get=function(Ae){var Ke=this.__data__;if(bs){var Lt=Ke[Ae];return Lt==="__lodash_hash_undefined__"?void 0:Lt}return yn.call(Ke,Ae)?Ke[Ae]:void 0},dn.prototype.has=function(Ae){var Ke=this.__data__;return bs?Ke[Ae]!==void 0:yn.call(Ke,Ae)},dn.prototype.set=function(Ae,Ke){var Lt=this.__data__;return this.size+=this.has(Ae)?0:1,Lt[Ae]=bs&&Ke===void 0?"__lodash_hash_undefined__":Ke,this},zn.prototype.clear=function(){this.__data__=[],this.size=0},zn.prototype.delete=function(Ae){var Ke=this.__data__,Lt=Ui(Ke,Ae);return!(Lt<0)&&(Lt==Ke.length-1?Ke.pop():vo.call(Ke,Lt,1),--this.size,!0)},zn.prototype.get=function(Ae){var Ke=this.__data__,Lt=Ui(Ke,Ae);return Lt<0?void 0:Ke[Lt][1]},zn.prototype.has=function(Ae){return Ui(this.__data__,Ae)>-1},zn.prototype.set=function(Ae,Ke){var Lt=this.__data__,fi=Ui(Lt,Ae);return fi<0?(++this.size,Lt.push([Ae,Ke])):Lt[fi][1]=Ke,this},vn.prototype.clear=function(){this.size=0,this.__data__={hash:new dn,map:new(Ys||zn),string:new dn}},vn.prototype.delete=function(Ae){var Ke=bo(this,Ae).delete(Ae);return this.size-=Ke?1:0,Ke},vn.prototype.get=function(Ae){return bo(this,Ae).get(Ae)},vn.prototype.has=function(Ae){return bo(this,Ae).has(Ae)},vn.prototype.set=function(Ae,Ke){var Lt=bo(this,Ae),fi=Lt.size;return Lt.set(Ae,Ke),this.size+=Lt.size==fi?0:1,this},Ji.prototype.add=Ji.prototype.push=function(Ae){return this.__data__.set(Ae,"__lodash_hash_undefined__"),this},Ji.prototype.has=function(Ae){return this.__data__.has(Ae)},Zn.prototype.clear=function(){this.__data__=new zn,this.size=0},Zn.prototype.delete=function(Ae){var Ke=this.__data__,Lt=Ke.delete(Ae);return this.size=Ke.size,Lt},Zn.prototype.get=function(Ae){return this.__data__.get(Ae)},Zn.prototype.has=function(Ae){return this.__data__.has(Ae)},Zn.prototype.set=function(Ae,Ke){var Lt=this.__data__;if(Lt instanceof zn){var fi=Lt.__data__;if(!Ys||fi.length<199)return fi.push([Ae,Ke]),this.size=++Lt.size,this;Lt=this.__data__=new vn(fi)}return Lt.set(Ae,Ke),this.size=Lt.size,this};var Hs=Bo?function(Ae){return Ae==null?[]:(Ae=Object(Ae),function(Ke,Lt){for(var fi=-1,Qi=Ke==null?0:Ke.length,zi=0,ur=[];++fi<Qi;){var pr=Ke[fi];Lt(pr,fi,Ke)&&(ur[zi++]=pr)}return ur}(Bo(Ae),function(Ke){return yo.call(Ae,Ke)}))}:function(){return[]},xn=Yi;function Zs(Ae,Ke){return!!(Ke=Ke==null?9007199254740991:Ke)&&(typeof Ae=="number"||wt.test(Ae))&&Ae>-1&&Ae%1==0&&Ae<Ke}function Jn(Ae){if(Ae!=null){try{return rn.call(Ae)}catch{}try{return Ae+""}catch{}}return""}function qo(Ae,Ke){return Ae===Ke||Ae!=Ae&&Ke!=Ke}(Uo&&xn(new Uo(new ArrayBuffer(1)))!="[object DataView]"||Ys&&xn(new Ys)!=ye||jo&&xn(jo.resolve())!="[object Promise]"||Vo&&xn(new Vo)!=Te||No&&xn(new No)!="[object WeakMap]")&&(xn=function(Ae){var Ke=Yi(Ae),Lt=Ke==Le?Ae.constructor:void 0,fi=Lt?Jn(Lt):"";if(fi)switch(fi){case xo:return"[object DataView]";case Go:return ye;case Xo:return"[object Promise]";case Ms:return Te;case fa:return"[object WeakMap]"}return Ke});var wo=ar(function(){return arguments}())?ar:function(Ae){return Pn(Ae)&&yn.call(Ae,"callee")&&!yo.call(Ae,"callee")},ws=Array.isArray,fn=As||function(){return!1};function Yo(Ae){if(!Ho(Ae))return!1;var Ke=Yi(Ae);return Ke=="[object Function]"||Ke=="[object GeneratorFunction]"||Ke=="[object AsyncFunction]"||Ke=="[object Proxy]"}function Co(Ae){return typeof Ae=="number"&&Ae>-1&&Ae%1==0&&Ae<=9007199254740991}function Ho(Ae){var Ke=typeof Ae;return Ae!=null&&(Ke=="object"||Ke=="function")}function Pn(Ae){return Ae!=null&&typeof Ae=="object"}var Ls=Zt?function(Ae){return function(Ke){return Ae(Ke)}}(Zt):function(Ae){return Pn(Ae)&&Co(Ae.length)&&!!xt[Yi(Ae)]};function zs(Ae){return(Ke=Ae)!=null&&Co(Ke.length)&&!Yo(Ke)?Mi(Ae):ka(Ae);var Ke}T.exports=function(Ae,Ke){return Ds(Ae,Ke)}}),zo={Polygon:Ei,LineString:ri,Point:Zi,MultiPolygon:Ki,MultiLineString:Ki,MultiPoint:Ki};function ua(T,z){return z.modes=se,z.getFeatureIdsAt=function($){return He.click({point:$},null,T).map(function(ye){return ye.properties.id})},z.getSelectedIds=function(){return T.store.getSelectedIds()},z.getSelected=function(){return{type:mt,features:T.store.getSelectedIds().map(function($){return T.store.get($)}).map(function($){return $.toGeoJSON()})}},z.getSelectedPoints=function(){return{type:mt,features:T.store.getSelectedCoordinates().map(function($){return{type:at,properties:{},geometry:{type:rt,coordinates:$.coordinates}}})}},z.set=function($){if($.type===void 0||$.type!==mt||!Array.isArray($.features))throw new Error("Invalid FeatureCollection");var ye=T.store.createRenderBatch(),Le=T.store.getAllIds().slice(),Te=z.add($),ke=new Gt(Te);return(Le=Le.filter(function(wt){return!ke.has(wt)})).length&&z.delete(Le),ye(),Te},z.add=function($){var ye=JSON.parse(JSON.stringify(Se($))).features.map(function(Le){if(Le.id=Le.id||yt(),Le.geometry===null)throw new Error("Invalid geometry: null");if(T.store.get(Le.id)===void 0||T.store.get(Le.id).type!==Le.geometry.type){var Te=zo[Le.geometry.type];if(Te===void 0)throw new Error("Invalid geometry type: "+Le.geometry.type+".");var ke=new Te(T,Le);T.store.add(ke)}else{var wt=T.store.get(Le.id);wt.properties=Le.properties,po(wt.getCoordinates(),Le.geometry.coordinates)||wt.incomingCoords(Le.geometry.coordinates)}return Le.id});return T.store.render(),ye},z.get=function($){var ye=T.store.get($);if(ye)return ye.toGeoJSON()},z.getAll=function(){return{type:mt,features:T.store.getAll().map(function($){return $.toGeoJSON()})}},z.delete=function($){return T.store.delete($,{silent:!0}),z.getMode()!==se.DIRECT_SELECT||T.store.getSelectedIds().length?T.store.render():T.events.changeMode(se.SIMPLE_SELECT,void 0,{silent:!0}),z},z.deleteAll=function(){return T.store.delete(T.store.getAllIds(),{silent:!0}),z.getMode()===se.DIRECT_SELECT?T.events.changeMode(se.SIMPLE_SELECT,void 0,{silent:!0}):T.store.render(),z},z.changeMode=function($,ye){return ye===void 0&&(ye={}),$===se.SIMPLE_SELECT&&z.getMode()===se.SIMPLE_SELECT?(Le=ye.featureIds||[],Te=T.store.getSelectedIds(),Le.length===Te.length&&JSON.stringify(Le.map(function(ke){return ke}).sort())===JSON.stringify(Te.map(function(ke){return ke}).sort())||(T.store.setSelected(ye.featureIds,{silent:!0}),T.store.render()),z):($===se.DIRECT_SELECT&&z.getMode()===se.DIRECT_SELECT&&ye.featureId===T.store.getSelectedIds()[0]||T.events.changeMode($,ye,{silent:!0}),z);var Le,Te},z.getMode=function(){return T.events.getMode()},z.trash=function(){return T.events.trash({silent:!0}),z},z.combineFeatures=function(){return T.events.combineFeatures({silent:!0}),z},z.uncombineFeatures=function(){return T.events.uncombineFeatures({silent:!0}),z},z.setFeatureProperty=function($,ye,Le){return T.store.setFeatureProperty($,ye,Le),z},z}var da=function(T,z){var $={options:T=function(Le){Le===void 0&&(Le={});var Te=Vr(Le);return Le.controls||(Te.controls={}),Le.displayControlsDefault===!1?Te.controls=Vr(Lo,Le.controls):Te.controls=Vr(ca,Le.controls),(Te=Vr(la,Te)).styles=ha(Te.styles,"cold").concat(ha(Te.styles,"hot")),Te}(T)};z=ua($,z),$.api=z;var ye=Xi($);return z.onAdd=ye.onAdd,z.onRemove=ye.onRemove,z.types=We,z.options=T,z};function Fo(T){da(T,this)}return Fo.modes=fo,Fo})})(Iu);const Vc=Iu.exports;function Lf(Ne,I){return Ne.lngLat?Ne.lngLat.lng===I[0]&&Ne.lngLat.lat===I[1]:!1}const Wc=Vc.modes.draw_polygon;Wc.maxVertices=4;Wc.clickAnywhere=function(Ne,I){if(Ne.currentVertexPosition>0&&Lf(I,Ne.polygon.coordinates[0][Ne.currentVertexPosition-1]))return this.changeMode("simple_select",{featureIds:[Ne.polygon.id]});if(this.updateUIClasses({mouse:"add"}),Ne.polygon.updateCoordinate(`0.${Ne.currentVertexPosition}`,I.lngLat.lng,I.lngLat.lat),Ne.currentVertexPosition++,Ne.polygon.updateCoordinate(`0.${Ne.currentVertexPosition}`,I.lngLat.lng,I.lngLat.lat),Ne.currentVertexPosition>this.maxVertices-1)return this.updateUIClasses({mouse:"none"}),this.changeMode("simple_select",{featuresId:Ne.polygon.id})};const _u=(Ne,I)=>{const Tt=Ne._offset.left,ft=Ne._offset.top,At=I.e.pageX-Tt,Yt=I.e.pageY-ft;return{x:At,y:Yt}},zf=Ne=>Math.abs(Math.min.apply(Math,Ne.map(function(I){return I.y}))),Ff=Ne=>Math.abs(Math.min.apply(Math,Ne.map(function(I){return I.x}))),yu=Ne=>{let I=new fabric.Point(Ne.strokeUniform?1/Ne.scaleX:1,Ne.strokeUniform?1/Ne.scaleY:1).multiply(Ne.strokeWidth);return new fabric.Point(Ne.width+I.x,Ne.height+I.y)};class Rf{generateNumber(I){return I*Math.random()|0}generateX(){return this.generateNumber(16).toString(16)}generateXes(I){let Tt="";for(let ft=0;ft<I;++ft)Tt+=this.generateX();return Tt}generateVariant(){return(this.generateNumber(16)&3|8).toString(16)}generate(){return this.generateXes(8)+"-"+this.generateXes(4)+"-4"+this.generateXes(3)+"-"+this.generateVariant()+this.generateXes(3)+"-"+this.generateXes(12)}}function vu(Ne,I,Tt){const ft=Ne.slice();return ft[35]=I[Tt][0],ft[36]=I[Tt][1],ft}function xu(Ne){let I,Tt=[...Ne[1]],ft=[];for(let At=0;At<Tt.length;At+=1)ft[At]=bu(vu(Ne,Tt,At));return{c(){for(let At=0;At<ft.length;At+=1)ft[At].c();I=mu()},l(At){for(let Yt=0;Yt<ft.length;Yt+=1)ft[Yt].l(At);I=mu()},m(At,Yt){for(let ei=0;ei<ft.length;ei+=1)ft[ei].m(At,Yt);Oo(At,I,Yt)},p(At,Yt){if(Yt[0]&2){Tt=[...At[1]];let ei;for(ei=0;ei<Tt.length;ei+=1){const n=vu(At,Tt,ei);ft[ei]?ft[ei].p(n,Yt):(ft[ei]=bu(n),ft[ei].c(),ft[ei].m(I.parentNode,I))}for(;ei<ft.length;ei+=1)ft[ei].d(1);ft.length=Tt.length}},d(At){yf(ft,At),At&&Kt(I)}}}function bu(Ne){let I,Tt,ft,At,Yt,ei=Ne[36].id+"",n,g,x,v,h,a,c,d,_,u,C,S,A,O,U,Y,oe,ge,ze=Ne[36].properties.road_lane_direction+"",We,at,_t,vt,rt,mt,Qe,zt=Ne[36].properties.road_lane_num+"",Et,Q,se,de,ie,ve,J,q,ce,be,De,Ie,tt,ut,nt=JSON.stringify(Ne[36].properties.coordinates)+"",je,Ce,Ve,Je,$e,lt,ot,Gt=JSON.stringify(Ne[36].geometry.coordinates)+"",Xt,He;return{c(){I=ti("li"),Tt=ti("div"),ft=ti("i"),At=Mr("place"),Yt=Mr("Polygon identifier: "),n=Mr(ei),g=sr(),x=ti("div"),v=ti("table"),h=ti("thead"),a=ti("tr"),c=ti("th"),d=Mr("Attirubute"),_=sr(),u=ti("th"),C=Mr("Value"),S=sr(),A=ti("tbody"),O=ti("tr"),U=ti("td"),Y=Mr("Road lane direction"),oe=sr(),ge=ti("td"),We=Mr(ze),at=sr(),_t=ti("tr"),vt=ti("td"),rt=Mr("Road lane number"),mt=sr(),Qe=ti("td"),Et=Mr(zt),Q=sr(),se=ti("tr"),de=ti("td"),ie=Mr("Color"),ve=sr(),J=ti("td"),q=ti("div"),ce=sr(),be=ti("tr"),De=ti("td"),Ie=Mr("Canvas coordinates"),tt=sr(),ut=ti("td"),je=Mr(nt),Ce=sr(),Ve=ti("tr"),Je=ti("td"),$e=Mr("Spatial coordinates"),lt=sr(),ot=ti("td"),Xt=Mr(Gt),He=sr(),this.h()},l(jt){I=ii(jt,"LI",{});var qt=ai(I);Tt=ii(qt,"DIV",{class:!0});var mi=ai(Tt);ft=ii(mi,"I",{class:!0});var Di=ai(ft);At=kr(Di,"place"),Di.forEach(Kt),Yt=kr(mi,"Polygon identifier: "),n=kr(mi,ei),mi.forEach(Kt),g=or(qt),x=ii(qt,"DIV",{class:!0});var wi=ai(x);v=ii(wi,"TABLE",{class:!0});var Ue=ai(v);h=ii(Ue,"THEAD",{});var yt=ai(h);a=ii(yt,"TR",{});var Ri=ai(a);c=ii(Ri,"TH",{});var Zi=ai(c);d=kr(Zi,"Attirubute"),Zi.forEach(Kt),_=or(Ri),u=ii(Ri,"TH",{});var ri=ai(u);C=kr(ri,"Value"),ri.forEach(Kt),Ri.forEach(Kt),yt.forEach(Kt),S=or(Ue),A=ii(Ue,"TBODY",{});var Ei=ai(A);O=ii(Ei,"TR",{});var dr=ai(O);U=ii(dr,"TD",{});var fr=ai(U);Y=kr(fr,"Road lane direction"),fr.forEach(Kt),oe=or(dr),ge=ii(dr,"TD",{});var Ki=ai(ge);We=kr(Ki,ze),Ki.forEach(Kt),dr.forEach(Kt),at=or(Ei),_t=ii(Ei,"TR",{});var st=ai(_t);vt=ii(st,"TD",{});var bi=ai(vt);rt=kr(bi,"Road lane number"),bi.forEach(Kt),mt=or(st),Qe=ii(st,"TD",{});var xi=ai(Qe);Et=kr(xi,zt),xi.forEach(Kt),st.forEach(Kt),Q=or(Ei),se=ii(Ei,"TR",{});var br=ai(se);de=ii(br,"TD",{});var tn=ai(de);ie=kr(tn,"Color"),tn.forEach(Kt),ve=or(br),J=ii(br,"TD",{});var yi=ai(J);q=ii(yi,"DIV",{style:!0}),ai(q).forEach(Kt),yi.forEach(Kt),br.forEach(Kt),ce=or(Ei),be=ii(Ei,"TR",{});var Oi=ai(be);De=ii(Oi,"TD",{});var wr=ai(De);Ie=kr(wr,"Canvas coordinates"),wr.forEach(Kt),tt=or(Oi),ut=ii(Oi,"TD",{});var Vr=ai(ut);je=kr(Vr,nt),Vr.forEach(Kt),Oi.forEach(Kt),Ce=or(Ei),Ve=ii(Ei,"TR",{});var lr=ai(Ve);Je=ii(lr,"TD",{});var Dr=ai(Je);$e=kr(Dr,"Spatial coordinates"),Dr.forEach(Kt),lt=or(lr),ot=ii(lr,"TD",{});var Xi=ai(ot);Xt=kr(Xi,Gt),Xi.forEach(Kt),lr.forEach(Kt),Ei.forEach(Kt),Ue.forEach(Kt),wi.forEach(Kt),He=or(qt),qt.forEach(Kt),this.h()},h(){oi(ft,"class","material-icons"),oi(Tt,"class","collapsible-header"),sl(q,"background-color",Ne[36].properties.color_rgb_str),sl(q,"width","32px"),sl(q,"height","16px"),sl(q,"border","1px solid #000000"),oi(v,"class","collapsible-table"),oi(x,"class","collapsible-body")},m(jt,qt){Oo(jt,I,qt),gt(I,Tt),gt(Tt,ft),gt(ft,At),gt(Tt,Yt),gt(Tt,n),gt(I,g),gt(I,x),gt(x,v),gt(v,h),gt(h,a),gt(a,c),gt(c,d),gt(a,_),gt(a,u),gt(u,C),gt(v,S),gt(v,A),gt(A,O),gt(O,U),gt(U,Y),gt(O,oe),gt(O,ge),gt(ge,We),gt(A,at),gt(A,_t),gt(_t,vt),gt(vt,rt),gt(_t,mt),gt(_t,Qe),gt(Qe,Et),gt(A,Q),gt(A,se),gt(se,de),gt(de,ie),gt(se,ve),gt(se,J),gt(J,q),gt(A,ce),gt(A,be),gt(be,De),gt(De,Ie),gt(be,tt),gt(be,ut),gt(ut,je),gt(A,Ce),gt(A,Ve),gt(Ve,Je),gt(Je,$e),gt(Ve,lt),gt(Ve,ot),gt(ot,Xt),gt(I,He)},p(jt,qt){qt[0]&2&&ei!==(ei=jt[36].id+"")&&ol(n,ei),qt[0]&2&&ze!==(ze=jt[36].properties.road_lane_direction+"")&&ol(We,ze),qt[0]&2&&zt!==(zt=jt[36].properties.road_lane_num+"")&&ol(Et,zt),qt[0]&2&&sl(q,"background-color",jt[36].properties.color_rgb_str),qt[0]&2&&nt!==(nt=JSON.stringify(jt[36].properties.coordinates)+"")&&ol(je,nt),qt[0]&2&&Gt!==(Gt=JSON.stringify(jt[36].geometry.coordinates)+"")&&ol(Xt,Gt)},d(jt){jt&&Kt(I)}}}function Bf(Ne){let I,Tt,ft,At,Yt,ei,n,g,x,v,h,a,c,d,_,u,C,S,A,O,U,Y,oe,ge,ze,We,at,_t,vt,rt,mt,Qe,zt,Et,Q,se,de,ie,ve,J,q,ce,be,De,Ie,tt,ut;se=new Mf({});let nt=Ne[2]===!0&&xu(Ne),je={};return ce=new Ef({props:je}),Ne[8](ce),De=new Of({}),{c(){I=ti("sveltekit:head"),Tt=ti("link"),ft=sr(),At=ti("link"),Yt=sr(),ei=ti("script"),g=sr(),x=ti("title"),v=Mr(wu),h=sr(),a=ti("div"),c=ti("div"),d=ti("a"),_=ti("i"),u=Mr("edit"),C=sr(),S=ti("ul"),A=ti("li"),O=ti("a"),U=ti("i"),Y=Mr("add"),oe=sr(),ge=ti("li"),ze=ti("a"),We=ti("i"),at=Mr("delete"),_t=sr(),vt=ti("li"),rt=ti("a"),mt=ti("i"),Qe=Mr("save"),zt=sr(),Et=ti("div"),Q=ti("div"),kc(se.$$.fragment),de=sr(),ie=ti("div"),ve=ti("div"),J=ti("ul"),nt&&nt.c(),q=sr(),kc(ce.$$.fragment),be=sr(),kc(De.$$.fragment),this.h()},l(Ce){I=ii(Ce,"SVELTEKIT:HEAD",{});var Ve=ai(I);Tt=ii(Ve,"LINK",{rel:!0,href:!0}),ft=or(Ve),At=ii(Ve,"LINK",{href:!0,rel:!0}),Yt=or(Ve),ei=ii(Ve,"SCRIPT",{src:!0});var Je=ai(ei);Je.forEach(Kt),g=or(Ve),x=ii(Ve,"TITLE",{});var $e=ai(x);v=kr($e,wu),$e.forEach(Kt),Ve.forEach(Kt),h=or(Ce),a=ii(Ce,"DIV",{id:!0});var lt=ai(a);c=ii(lt,"DIV",{class:!0});var ot=ai(c);d=ii(ot,"A",{class:!0});var Gt=ai(d);_=ii(Gt,"I",{class:!0});var Xt=ai(_);u=kr(Xt,"edit"),Xt.forEach(Kt),Gt.forEach(Kt),C=or(ot),S=ii(ot,"UL",{});var He=ai(S);A=ii(He,"LI",{});var jt=ai(A);O=ii(jt,"A",{id:!0,class:!0});var qt=ai(O);U=ii(qt,"I",{class:!0});var mi=ai(U);Y=kr(mi,"add"),mi.forEach(Kt),qt.forEach(Kt),jt.forEach(Kt),oe=or(He),ge=ii(He,"LI",{});var Di=ai(ge);ze=ii(Di,"A",{id:!0,class:!0});var wi=ai(ze);We=ii(wi,"I",{class:!0});var Ue=ai(We);at=kr(Ue,"delete"),Ue.forEach(Kt),wi.forEach(Kt),Di.forEach(Kt),_t=or(He),vt=ii(He,"LI",{});var yt=ai(vt);rt=ii(yt,"A",{id:!0,class:!0});var Ri=ai(rt);mt=ii(Ri,"I",{class:!0});var Zi=ai(mt);Qe=kr(Zi,"save"),Zi.forEach(Kt),Ri.forEach(Kt),yt.forEach(Kt),He.forEach(Kt),ot.forEach(Kt),zt=or(lt),Et=ii(lt,"DIV",{id:!0});var ri=ai(Et);Q=ii(ri,"DIV",{id:!0});var Ei=ai(Q);Dc(se.$$.fragment,Ei),de=or(Ei),ie=ii(Ei,"DIV",{id:!0});var dr=ai(ie);ve=ii(dr,"DIV",{id:!0});var fr=ai(ve);J=ii(fr,"UL",{id:!0,class:!0});var Ki=ai(J);nt&&nt.l(Ki),Ki.forEach(Kt),fr.forEach(Kt),dr.forEach(Kt),Ei.forEach(Kt),q=or(ri),Dc(ce.$$.fragment,ri),be=or(ri),Dc(De.$$.fragment,ri),ri.forEach(Kt),lt.forEach(Kt),this.h()},h(){oi(Tt,"rel","stylesheet"),oi(Tt,"href","https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"),oi(At,"href","https://fonts.googleapis.com/icon?family=Material+Icons"),oi(At,"rel","stylesheet"),Bc(ei.src,n="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js")||oi(ei,"src",n),oi(_,"class","material-icons"),oi(d,"class","btn-floating btn-large red"),oi(U,"class","material-icons"),oi(O,"id","add-btn"),oi(O,"class","btn-floating green"),oi(We,"class","material-icons"),oi(ze,"id","del-btn"),oi(ze,"class","btn-floating blue"),oi(mt,"class","material-icons"),oi(rt,"id","save-btn"),oi(rt,"class","btn-floating grey"),oi(c,"class","fixed-action-btn horizontal click-to-toggle spin-close"),oi(J,"id","collapsible-data"),oi(J,"class","collapsible"),oi(ve,"id","configuration-content"),oi(ie,"id","configuration"),oi(Q,"id","grid_component"),oi(Et,"id","flex_component"),oi(a,"id","main-app")},m(Ce,Ve){Oo(Ce,I,Ve),gt(I,Tt),gt(I,ft),gt(I,At),gt(I,Yt),gt(I,ei),gt(I,g),gt(I,x),gt(x,v),Oo(Ce,h,Ve),Oo(Ce,a,Ve),gt(a,c),gt(c,d),gt(d,_),gt(_,u),gt(c,C),gt(c,S),gt(S,A),gt(A,O),gt(O,U),gt(U,Y),gt(S,oe),gt(S,ge),gt(ge,ze),gt(ze,We),gt(We,at),gt(S,_t),gt(S,vt),gt(vt,rt),gt(rt,mt),gt(mt,Qe),gt(a,zt),gt(a,Et),gt(Et,Q),Oc(se,Q,null),gt(Q,de),gt(Q,ie),gt(ie,ve),gt(ve,J),nt&&nt.m(J,null),gt(Et,q),Oc(ce,Et,null),gt(Et,be),Oc(De,Et,null),Ie=!0,tt||(ut=[uo(ei,"load",Ne[4]),uo(O,"click",Ne[5]),uo(ze,"click",Ne[6]),uo(rt,"click",Ne[7])],tt=!0)},p(Ce,Ve){Ce[2]===!0?nt?nt.p(Ce,Ve):(nt=xu(Ce),nt.c(),nt.m(J,null)):nt&&(nt.d(1),nt=null);const Je={};ce.$set(Je)},i(Ce){Ie||(Lc(se.$$.fragment,Ce),Lc(ce.$$.fragment,Ce),Lc(De.$$.fragment,Ce),Ie=!0)},o(Ce){zc(se.$$.fragment,Ce),zc(ce.$$.fragment,Ce),zc(De.$$.fragment,Ce),Ie=!1},d(Ce){Ce&&Kt(I),Ce&&Kt(h),Ce&&Kt(a),Fc(se),nt&&nt.d(),Ne[8](null),Fc(ce),Fc(De),tt=!1,Tu(ut)}}}const wu="Rust Road Traffic UI";function Uf(){const Ne=Math.round(16777215*Math.random()),I=Ne>>16,Tt=Ne>>8&255,ft=Ne&255;return"rgb("+I+", "+Tt+", "+ft+")"}function jf(Ne,I,Tt){let ft,At,Yt,ei,n,g,x;Ln(Ne,Pu,ie=>Tt(1,ft=ie)),Ln(Ne,os,ie=>Tt(20,At=ie)),Ln(Ne,jc,ie=>Tt(21,Yt=ie)),Ln(Ne,Uc,ie=>Tt(22,ei=ie)),Ln(Ne,Aa,ie=>Tt(23,n=ie)),Ln(Ne,oa,ie=>Tt(2,g=ie));const{apiURL:v}=jl;Ln(Ne,v,ie=>Tt(24,x=ie));let h=x,a,c,d,_,u,C,S=new Array,A=new Array,O,U,Y;const oe=Xc.subscribe(ie=>{if(h!==ie){console.log(`Need to change API URL for Data: '${x}'`),h=ie,Aa.set(!1),oa.set(!1),U(),Y(),ft.clear(),u!==void 0&&u!=null&&u.getObjects().forEach(J=>{console.log("here1",J),u.remove(J),Yt!==null&&Yt.delete(J.unid)}),U=Aa.subscribe(J=>{J===!0&&(u===void 0||u==null)&&ze(),J===!0&&g==!0&&We()}),Y=oa.subscribe(J=>{J===!0&&n==!0&&We()});const ve=`${h}/api/polygons/geojson`;fetch(`${ve}`).then(J=>J.json()).then(J=>{J.features.forEach(q=>{q.properties.spatial_object_id=q.id,q.properties.canvas_object_id=q.id,q.properties.color_rgb_str=`rgb(${q.properties.color_rgb[0]},${q.properties.color_rgb[1]},${q.properties.color_rgb[2]})`,ft.set(q.id,q)}),O.drawGeoPolygons(Yt,ft),oa.set(!0)}).catch(J=>{console.log("Error on loading polygons",J)})}});Xl(()=>{console.log("Mounted"),U=Aa.subscribe(ve=>{ve===!0&&ze(),ve===!0&&g==!0&&(console.log("MJPEG is loaded before geo data"),We())}),Y=oa.subscribe(ve=>{ve===!0&&n==!0&&(console.log("Geo data is loaded before MJPEG"),We())}),jc.set(new Vc({userProperties:!0,displayControlsDefault:!1,controls:{polygon:!1,trash:!1},modes:Object.assign({draw_restricted_polygon:Wc},Vc.modes),styles:Cf})),O.attachDraw(Yt),ei.on("draw.create",function(ve){ve.features[0].properties={color_rgb:[127,127,127],color_rgb_str:al,coordinates:ve.features[0].geometry.coordinates,road_lane_direction:-1,road_lane_num:-1,spatial_object_id:ve.features[0].id,canvas_object_id:null},Yt.add(ve.features[0]),os.set(jr.Waiting)});const ie=`${h}/api/polygons/geojson`;fetch(`${ie}`).then(ve=>ve.json()).then(ve=>{ve.features.forEach(J=>{J.properties.spatial_object_id=J.id,J.properties.canvas_object_id=J.id,J.properties.color_rgb_str=`rgb(${J.properties.color_rgb[0]},${J.properties.color_rgb[1]},${J.properties.color_rgb[2]})`,ft.set(J.id,J)}),ei.on("load",()=>{O.drawGeoPolygons(Yt,ft)}),oa.set(!0)}).catch(ve=>{console.log("Error on loading polygons [initial]",ve)})}),Nc(()=>{console.log("Destroyed"),Aa.set(!1),oa.set(!1),U(),Y(),oe()});const ge=()=>{const ie=document.querySelectorAll(".fixed-action-btn");M.FloatingActionButton.init(ie,{direction:"left",hoverEnabled:!1});const ve=document.getElementById("collapsible-data");M.Collapsible.init(ve,{})},ze=()=>{d=document.getElementById("fit_canvas"),_=document.getElementById("fit_img"),d.width=_.clientWidth,d.height=_.clientHeight,a=_.clientWidth/_.naturalWidth,c=_.clientHeight/_.naturalHeight,u=new En.fabric.Canvas("fit_canvas",{containerClass:"custom-container-canvas",fireRightClick:!0,fireMiddleClick:!0,stopContextMenu:!0}),C=document.getElementsByClassName("custom-container-canvas")[0],C.id="fbcanvas",u.on("selection:created",ie=>{At===jr.DeletingPolygon&&(vt(u,ie.selected[0].unid),os.set(jr.Waiting))}),u.on("selection:updated",ie=>{At===jr.DeletingPolygon&&(vt(u,ie.selected[0].unid),os.set(jr.Waiting))}),u.on("mouse:move",ie=>{if(S[0]!==null&&S[0]!==void 0&&At===jr.AddingPolygon){const ve=_u(u,ie);S[S.length-1].set({x2:ve.x,y2:ve.y}),u.renderAll()}}),u.on("mouse:down",ie=>{if(At!==jr.AddingPolygon)return;u.selection=!1;const ve=_u(u,ie);A.push({x:ve.x,y:ve.y});const J=[ve.x,ve.y,ve.x,ve.y],q=new En.fabric.Line(J,{strokeWidth:3,selectable:!1,stroke:"purple"});if(S.push(q),u.add(q),u.on("mouse:up",function(be){u.selection=!0}),A.length<=3)return;S.forEach(be=>{u.remove(be)});const ce=at(A);ce.on("mousedown",be=>{if(be.e.preventDefault(),be.e.stopPropagation(),be.button===3){if(At!==jr.EditingPolygon)pu(os,At=jr.EditingPolygon,At);else{pu(os,At=jr.Waiting,At);let De=ft.get(ce.unid);De.properties.coordinates=ce.current_points.map(Ie=>[Math.floor(Ie.x/a),Math.floor(Ie.y/c)]),ft.set(ce.unid,De)}_t(ce,u)}}),ce.on("modified",be=>{var ut;const De=ce.calcTransformMatrix(),Ie=(ut=ce.points)==null?void 0:ut.map(function(nt){return new En.fabric.Point(nt.x-ce.pathOffset.x,nt.y-ce.pathOffset.y)}).map(function(nt){return En.fabric.util.transformPoint(nt,De)});ce.current_points=Ie;let tt=ft.get(ce.unid);tt.properties.coordinates=ce.current_points.map(nt=>[Math.floor(nt.x/a),Math.floor(nt.y/c)]),ft.set(ce.unid,tt)}),ce.unid=new Rf().generate(),ft.set(ce.unid,{type:"Feature",id:ce.unid,properties:{color_rgb:zt(ce.stroke),color_rgb_str:ce.stroke,coordinates:ce.current_points.map(be=>[Math.floor(be.x/a),Math.floor(be.y/c)]),road_lane_direction:-1,road_lane_num:-1,spatial_object_id:null,canvas_object_id:null},geometry:{type:"Polygon",coordinates:[[[],[],[],[],[]]]}}),u.add(ce),u.renderAll(),S=[],A=[],os.set(jr.Waiting),Yt.changeMode("simple_select")})},We=()=>{ft.forEach(ie=>{const ve=ie.properties.coordinates.map(q=>({x:q[0]*a,y:q[1]*c}));let J=at(ve,`rgb(${ie.properties.color_rgb[0]},${ie.properties.color_rgb[1]},${ie.properties.color_rgb[2]})`);J.on("mousedown",q=>{if(q.e.preventDefault(),q.e.stopPropagation(),q.button===3){if(At!=jr.EditingPolygon)os.set(jr.EditingPolygon);else{os.set(jr.Waiting);let ce=ft.get(J.unid);ce.properties.coordinates=J.current_points.map(be=>[Math.floor(be.x/a),Math.floor(be.y/c)]),ft.set(J.unid,ce)}_t(J,u)}}),J.on("modified",q=>{const ce=J.calcTransformMatrix(),be=J.points.map(function(Ie){return new En.fabric.Point(Ie.x-J.pathOffset.x,Ie.y-J.pathOffset.y)}).map(function(Ie){return En.fabric.util.transformPoint(Ie,ce)});J.current_points=be;let De=ft.get(J.unid);De.properties.coordinates=J.current_points.map(Ie=>[Math.floor(Ie.x/a),Math.floor(Ie.y/c)]),ft.set(J.unid,De)}),J.unid=ie.id,u.add(J),u.renderAll()})},at=(ie,ve=Uf())=>{let J=Ff(ie),q=zf(ie),ce=new En.fabric.Polygon(ie,{fill:"rgba(0,0,0,0)",stroke:ve,strokeWidth:3,objectCaching:!1});return ce.set({left:J,top:q}),ce.current_points=ce.points,ce};function _t(ie,ve){var J,q;if(ve.setActiveObject(ie),ie.edit=!ie.edit,ie.edit){let ce=((J=ie==null?void 0:ie.points)==null?void 0:J.length)-1;ie.cornerStyle="circle",ie.cornerSize=15,ie.cornerColor="rgba(0, 0, 255, 1.0)",ie.controls=(q=ie==null?void 0:ie.points)==null?void 0:q.reduce(function(be,De,Ie){return be["p"+Ie]=new En.fabric.Control({positionHandler:Et,actionHandler:Q(Ie>0?Ie-1:ce,se),actionName:"modifyPolygon",pointIndex:Ie}),be},{})}else ie.cornerColor="rgb(178, 204, 255)",ie.cornerStyle="rect",ie.controls=En.fabric.Object.prototype.controls;ie.hasBorders=!ie.edit,ve.requestRenderAll()}const vt=(ie,ve)=>{ie.getObjects().forEach(J=>{if(J.unid===ve){ie.remove(J);return}}),ft.delete(ve),Yt.delete(ve)},rt=()=>{At!==jr.AddingPolygon?(os.set(jr.AddingPolygon),Yt.changeMode("draw_restricted_polygon")):(os.set(jr.Waiting),Yt.changeMode("simple_select"))},mt=()=>{At!==jr.DeletingPolygon?os.set(jr.DeletingPolygon):os.set(jr.Waiting)},Qe=()=>{const ie={data:Array.from(ft.values()).map(J=>({lane_number:J.properties.road_lane_num,lane_direction:J.properties.road_lane_direction,color_rgb:J.properties.color_rgb,pixel_points:J.properties.coordinates,spatial_points:[...J.geometry.coordinates[0].slice(0,-1)]}))};console.log("Replacing data");const ve=`${h}/api/mutations/replace_all`;fetch(`${ve}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ie)}).then(J=>J.json()).then(J=>{const q=`${h}/api/mutations/save_toml`;console.log("Replacing configuration with polygons:",J),fetch(`${q}`,{method:"GET"}).then(ce=>ce.json()).then(ce=>{console.log("Configuration has been updated. Reply from server:",ce)}).catch(ce=>{console.log("Error on updating configuration:",ce)})}).catch(J=>{console.log("Error on replacing data",J)})},zt=ie=>{const ve=ie.match(/rgba?\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)?(?:, ?(\d(?:\.\d?))\))?/);return ve?[ve[1],ve[2],ve[3]].map(Number):[]},Et=function(ie,ve,J){let q=J.points[this.pointIndex].x-J.pathOffset.x,ce=J.points[this.pointIndex].y-J.pathOffset.y;const be=new En.fabric.Point(q,ce);return En.fabric.util.transformPoint(be,En.fabric.util.multiplyTransformMatrices(J.canvas.viewportTransform,J.calcTransformMatrix()))},Q=function(ie,ve){return function(J,q,ce,be){let De=q.target;const Ie=new En.fabric.Point(De.points[ie].x-De.pathOffset.x,De.points[ie].y-De.pathOffset.y);let tt=En.fabric.util.transformPoint(Ie,De.calcTransformMatrix()),ut=ve(J,q,ce,be);De._setPositionDimensions({});let nt=yu(De),je=(De.points[ie].x-De.pathOffset.x)/nt.x,Ce=(De.points[ie].y-De.pathOffset.y)/nt.y;return De.setPositionByOrigin(tt,je+.5,Ce+.5),ut}},se=function(ie,ve,J,q){let ce=ve.target,be=ce.controls[ce.__corner],De=ce.toLocalPoint(new En.fabric.Point(J,q),"center","center"),Ie=yu(ce),tt=ce._getTransformedDimensions(0,0),ut={x:De.x*Ie.x/tt.x+ce.pathOffset.x,y:De.y*Ie.y/tt.y+ce.pathOffset.y};return ce.points[be.pointIndex]=ut,!0};function de(ie){Cu[ie?"unshift":"push"](()=>{O=ie,Tt(0,O)})}return[O,ft,g,v,ge,rt,mt,Qe,de]}class Gf extends Vl{constructor(I){super(),Nl(this,I,jf,Bf,Gl,{},null,[-1,-1])}}export{Gf as default};
