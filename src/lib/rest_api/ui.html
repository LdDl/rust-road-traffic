<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <title>Rust Road Traffic</title>
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
        <script src="https://unpkg.com/maplibre-gl@2.3.0/dist/maplibre-gl.js"></script>
        <link href="https://unpkg.com/maplibre-gl@2.3.0/dist/maplibre-gl.css" rel="stylesheet" />
        <style>
            @import url("https://fonts.googleapis.com/css?family=Roboto");
            body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif;}
            #flex_component {
                display: flex;
                font-family: arial, sans-serif;
                height: 100%
            }
            #grid_component {
                width: 50%;
                color: #ff00ff;
                background: #eeeeee;
                display: grid;
                grid-auto-flow: rows;
                grid-template-areas: 
                    "A"
                    "B";
                grid-template-rows: 80% 20%;
            }
            #map {
                width: 50%;
                color: #ff00ff;
                background: #eeeeee;
                color: #222;
                background: #ccc;
            }
            #mjpeg {
                grid-area: A;
                background: green;
            }
            #fit_img {
                height: 100%;
                width: 100%;
            }
            #fit_canvas {
                height: 80%;
                width: 50%;
                background-color: transparent;
                position: absolute;
                left: 0;
                top: 0;
            }
            #configuration {
                grid-area: B;
                background: blue;
            }
            .custom-container-canvas {
                position: absolute !important; 
                left: 0;
                top: 0;
            }
            .floating-container {
                position: fixed;
                width: 100px;
                height: 100px;
                bottom: 0;
                right: 0;
                margin: 35px 25px;
                z-index: 999;
            }
            .floating-container .floating-button {
                position: absolute;
                width: 65px;
                height: 65px;
                background: #2cb3f0;
                bottom: 0;
                border-radius: 50%;
                left: 0;
                right: 0;
                margin: auto;
                color: white;
                line-height: 65px;
                text-align: center;
                font-size: 23px;
                z-index: 100;
                box-shadow: 0 10px 25px -5px rgba(44, 179, 240, 0.6);
                cursor: pointer;
                -webkit-transition: all 0.3s;
                transition: all 0.3s;
            }
            .floating-container:hover .floating-button {
                box-shadow: 0 10px 25px rgba(44, 179, 240, 0.6);
                -webkit-transform: translatey(5px);
                transform: translatey(5px);
                -webkit-transition: all 0.3s;
                transition: all 0.3s;
                -webkit-touch-callout: none; 
                -webkit-user-select: none;
                -khtml-user-select: none; 
                -moz-user-select: none; 
                -ms-user-select: none; 
                user-select: none;
            }
        </style>
    </head>
    <body>
        <div class="floating-container">
            <div id="add-btn" class="floating-button">+</div>
        </div>
        <div id="flex_component">
            <div id="grid_component">
                <div id="mjpeg">
                    <!-- <img id="fit_img" src="http://localhost:42002/live_streaming" width="500" height="500"> -->
                    <img id="fit_img" src="https://pngimg.com/uploads/google/google_PNG19632.png">
                    <canvas id="fit_canvas"></canvas>
                </div>
                <div id="configuration">@todo</div>
            </div>
            
            <div id="map"></div>
        </div>

        <script type="text/javascript">
            window.onload = function() {
                var map = new maplibregl.Map({
                    container: 'map', // container id
                    style: 'https://demotiles.maplibre.org/style.json', // style URL
                    center: [0, 0], // starting position [lng, lat]
                    zoom: 1 // starting zoom
                });

                let polygon = [];
                let isDone = false;
                function drawCountour(canvas, coordinates){
                    const clientW = canvas.clientWidth;
                    const clientH = canvas.clientHeight;
                    canvas.width = clientW;
                    canvas.height = clientH;
                    let ctx = canvas.getContext('2d');
                    ctx.lineWidth = 4;
                    ctx.strokeStyle = 'blue';

                    console.log('draw countour', clientW, clientH)
                    ctx.clearRect(0, 0, clientW, clientH);
                    ctx.beginPath();
                    ctx.moveTo(coordinates[0].x, coordinates[0].y);
                    for(index=1; index<coordinates.length;index++) {
                        ctx.lineTo(coordinates[index].x, coordinates[index].y);
                    }
                    ctx.closePath();
                    ctx.stroke();
                    console.log(coordinates)
                    console.log(ctx.lineWidth)
                }

                let canvas = document.getElementById('fit_canvas');
                let image = document.getElementById('fit_img');
                image.addEventListener('click', (e) => {
                    // need to find true pixel coordinate
                    const imgW = this.naturalWidth;
                    const imgH = this.naturalHeight;
                    const clientW = this.clientWidth;
                    const clientH = this.clientHeight;
                    const bbox = this.getBoundingClientRect();
                    const left = bbox.left;
                    const top = bbox.top;
                    const clickX = e.pageX - left;
                    const clickY = e.pageY - top;
                    const trueX = (clickX / clientW)*imgW;
                    const trueY = (clickY / clientH)*imgH;
                    console.log(trueX, trueY);
                });
                canvas.addEventListener('click', (e) => {
                    // need to find true pixel coordinate
                    if(isDone || polygon.length > 3){
                        isDone = true;
                        return;
                    }
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('canvas click', image.naturalHeight/canvas.clientHeight, canvas.clientWidth/image.naturalWidth)
                    const imgW = image.naturalWidth;
                    const imgH = image.naturalHeight;
                    const clientW = this.clientWidth;
                    const clientH = this.clientHeight;
                    const bbox = this.getBoundingClientRect();
                    const left = bbox.left;
                    const top = bbox.top;
                    const clickX = e.pageX - left;
                    const clickY = e.pageY - top;
                    const trueX = (clickX / clientW)*imgW;
                    const trueY = (clickY / clientH)*imgH;
                    polygon.push({ x:clickX, y:clickY });
                    console.log('drawing', trueX, trueY, clickX, clickY);
                    drawCountour(canvas, polygon);
                });


                // FabricJS stuff
                let drawX = 0;
                let drawY = 0;

                function setStartingPoint(options) {
                    const bbox = canvas.getBoundingClientRect();
                    const left = bbox.left;
                    const top = bbox.top;
                    drawX = options.e.pageX - left;
                    drawY = options.e.pageY - top;
                }
                function findTopPaddingForRoof(coordinates) {
                    var result = 999999;
                    for (var f = 0; f < lineCounter; f++) {
                        if (coordinates[f].y < result) {
                            result = coordinates[f].y;
                        }
                    }
                    return Math.abs(result);
                }
                function findLeftPaddingForRoof(coordinates) {
                    var result = 999999;
                    for (var i = 0; i < lineCounter; i++) {
                        if (coordinates[i].x < result) {
                            result = coordinates[i].x;
                        }
                    }
                    return Math.abs(result);
                }
                function makeContour(coordinates) {
                    let left = findLeftPaddingForRoof(coordinates);
                    let top = findTopPaddingForRoof(coordinates);
                    coordinates[coordinates.length-1] = coordinates[0];                  
                    let contour = new fabric.Polyline(coordinates, {
                        fill: 'rgba(0,0,0,0)',
                        stroke:'#58c',
                        strokeWidth: 3
                    });
                    contour.set({
                        left: left,
                        top: top,
                    });
                    return contour;
                }

                let isAddingPolygon = false;
                const clientW = image.clientWidth;
                const clientH = image.clientHeight;
                canvas.width = clientW;
                canvas.height = clientH;
                let fbCanvas = new fabric.Canvas('fit_canvas', {containerClass: 'custom-container-canvas'});
                var points = [{x: 0, y: 0}, {x: 100, y: 0}, {x: 100, y: 100}, {x: 0, y: 100}];
                var newPoly = new fabric.Polygon(points, {
                    left: 0,
                    top: 0,
                    position: 'absolute',
                    fill: 'transparent',
                    strokeWidth: 4,
                    stroke: 'red',
                    scaleX: 1,
                    scaleY: 1,
                    objectCaching: false,
                    transparentCorners: false,
                    cornerColor: 'blue',
                });
                // fbCanvas.add(newPoly);

                let lines = [];
                let lineCounter = 0;
                fbCanvas.on('mouse:down', (options) => {
                    // console.log('mouse down');
                    if (isAddingPolygon === true) {
                        fbCanvas.selection = false;
                        setStartingPoint(options)
                        console.log(drawX, drawY)
                        polygon.push({ x: drawX, y: drawY });
                        let points = [drawX, drawY, drawX, drawY]
                        let newLine = new fabric.Line(points, {
                            strokeWidth: 3,
                            selectable: false,
                            stroke: 'purple',
                        })
                        // lines.push(n.setOriginX(clickX).setOriginY(clickY));
                        lines.push(newLine);
                        fbCanvas.add(lines[lineCounter]);
                        lineCounter += 1;
                        fbCanvas.on('mouse:up', function (options) {
                            fbCanvas.selection = true;
                        });
                    }
                    // @todo
                });

                fbCanvas.on('mouse:move', (options) => {
                    if (lines[0] !== null && lines[0] !== undefined && isAddingPolygon === true) {
                        setStartingPoint(options);
                        lines[lineCounter - 1].set({
                            x2: drawX,
                            y2: drawY
                        });
                        fbCanvas.renderAll();
                    }
                });

                fbCanvas.on('mouse:dblclick', (options) => {
                    console.log('mouse dblclick');
                    polygon.forEach((value, index, ar) => {
                        fbCanvas.remove(value);
                    });
                    let roof = makeContour(polygon);
                    fbCanvas.add(roof);
                    fbCanvas.renderAll();
                    lines = [];
                    lineCounter = 0;
                    coordinates = [];
                    isAddingPolygon = false;
                });

                let addBtn = document.getElementById('add-btn');
                addBtn.addEventListener('click', (e) => {
                    if (!isAddingPolygon) {
                        console.log('Add polygon');
                        isAddingPolygon = true;
                    }
                });
            }
        </script>
    </body>
</html>
